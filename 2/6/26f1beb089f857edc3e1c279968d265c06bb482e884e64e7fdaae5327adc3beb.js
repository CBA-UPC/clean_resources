 __defProp=Object.defineProperty,__defNormalProp=__publicField=!function(){var e;function t(e){var t;if(!globalThis.document)return void console.info("skipping autoTrackClicks in SSR");JSON.parse((null==(t=document.currentScript)?void 0:t.dataset.autoTrackClicks)||"true")&&document.addEventListener("click",(function(t){const r=t.target;r instanceof HTMLAnchorElement&&"a"===r.localName&&r.host&&r.host!==location.host&&!r.host.endsWith("bandcamp.com")&&e.record({eventType:"click",tag:"external_link",link_url:r.href})}),{capture:!0,passive:!0})}function r(e){if(!globalThis.document)return void console.info("skipping autoTrackErrors in SSR");const t=/\.?bandcamp\.com$|\.bcbits.com$|\.bcdevs.com$|\.?bc.localhost$/i;let r=!1;document.addEventListener("DOMContentLoaded",(),window.addEventListener("error",(n=>{try{const i=n.filename?new URL(n.filename):null;if((null==i?void 0:i.hostname)&&!t.test(i.hostname))return;e.record({eventType:"performance",subtype:"js_error",message:n.message,filename:n.filename,lineno:n.lineno,colno:n.colno,dom_ready:r})}catch(e){console.error(e)}}))}const n=null==(e=globalThis.location)?void 0:e.href;let i;class o{constructor(e,t=5e3,r=!0){var n,i;__publicField(this,"recordURL"),__publicField(this,"sendDelay"),__publicField(this,"enabled"),__publicField(this,"queue",[]),__publicField(this,"didRecordPageView",!1),__publicField(this,"timeout",null),this.recordURL=e,this.sendDelay=t,this.enabled=r,null==(n=globalThis.document)||n.addEventListener("visibilitychange",(()=>{"visible"!==document.visibilityState&&this.send()})),null==(i=globalThis.window)||i.addEventListener("pagehide",(),this.recordPageViewWhenTheTimeComes()}static get defaultInstance(){return i||(globalThis.BCTracker?i=globalThis.BCTracker:(i=new o(new URL("/api/tracker/1/record",function(){var e;let t="https://bandcamp.com";const r=(null==(e=globalThis.location)?void 0:e.hostname)||"";"localhost"===r||r.endsWith(".localhost")?t="http://bc.localhost:7099":("staging.bcdevs.com"===r||r.endsWith(".staging.bcdevs.com"))&&(t="https://staging.bcdevs.com");return new URL(t)}())),t(i),r(i))),i}recordPageViewWhenTheTimeComes(){if(!n)return void console.info("skipping Tracker page_view recording in SSR");const e=()=>{if(this.didRecordPageView)return;const e={eventType:"page_view",referrer_url:document.referrer,screen:{width:window.screen.width,height:window.screen.height,density:window.devicePixelRatio},page_url:n};globalThis.MediaView&&(e.media_mode=globalThis.MediaView.mode);const t=document.head.querySelectorAll('meta[name="bc-page-properties"]');for(const r of t)Object.assign(e,JSON.parse(r.content));this.didRecordPageView=!0,this.record(e)};document.addEventListener("visibilitychange",(),"visible"===document.visibilityState&&e()}record(e){this.queue.push({timestamp:Date.now()/1e3,event:Object.assign({page_url:n},e)}),this.timeout||(this.timeout=setTimeout((,this.sendDelay))}send(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null);const e=this.queue;if(0===e.length)return void console.info("no events to send");if(!this.enabled)return console.info("Tracker disabled; not sending events:",e),void(e.length=0);console.info("sending "+e.length+" tracking events");const t=e.map((({timestamp:e,event:t})=>{const r=t.eventType,n=t;return delete n.eventType,{type:r,timestamp:e,properties:n}})),r=JSON.stringify({send_time:Date.now()/1e3,events:t});navigator.sendBeacon(this.recordURL,r)?e.length=0:console.warn("failed to queue sendBeacon for events",e)}}let s;class c{constructor(e,t){__publicField(this,"tracker"),__publicField(this,"intersectionObserver"),__publicField(this,"elemProps",new Map),this.tracker=e,"IntersectionObserver"in window?this.intersectionObserver=new IntersectionObserver(this.observeIntersections.bind(this),t):console.warn("IntersectionObserver not available")}tatic get defaultInstance(){return s||(s=new c(o.defaultInstance,{threshold:.25})),s}observeIntersections(e){var t;for(const r of e){if(!r.isIntersecting)return;const e=r.target,n=this.elemProps.get(e);n?(this.tracker.record(_objectSpread({eventType:"scroll"},n)),this.elemProps.delete(e),null==(t=this.intersectionObserver)||t.unobserve(e)):console.warn("no scroll props specified for target",e)}}trackclass a extends o{record(e,t={}){"object"==typeof e?super.record(e):super.record(Object.assign({eventType:e},t))}}globalThis.BCTracker=function(){if(!document.currentScript)throw new Error("This script cannot be loaded as an ESM module");return function(){var e,n;if(null==(e=globalThis.BCTracker)?void 0:e.recordURL)return globalThis.BCTracker;if(!(null==(n=document.currentScript)?void 0:n.dataset.recordUrl))throw new Error("Legacy BCTracker must specify recordUrl in a script tag data attribute");const i=JSON.parse(document.currentScript.dataset.recordUrl),o=1e3*JSON.parse(document.currentScript.dataset.sendDelay||"5"),s=JSON.parse(document.currentScript.dataset.enabled||"false"),c=new a(i,o,s),l=globalThis.BCTracker,d=(null==l?void 0:l.preloadQueue)||[],u=(null==l?void 0:l.prePageViewCallbacks)||[];t(c),r(c);for(const e of d)Array.isArray(e)?c.record(e[0],e[1]):c.record(e);for(const e of u)e();return c}()}(),globalThis.ScrollDepthTracker=c}();
