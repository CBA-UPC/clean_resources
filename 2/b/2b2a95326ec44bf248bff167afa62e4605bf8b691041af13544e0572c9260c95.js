/*! Copyright Â© 2013 - 2023 Tencent Cloud. All Rights Reserved. è…¾è®¯äº‘ ç‰:e.HLSP2P=t()}(self,(()=>(()=>{var e={114:function(e){e.exports=function(){"use sdd,this),e+=1}Array.prototype.find||Object.defineProperty(Array.prototype,"find",{configurable:!0,wrieturn i;s+=1}}}),window.WeakSet||(e=Date.now()%1e9,rble:!0}),this},r.prname]=void 0)},r!e[this.name]},t=r,Object.defineProperty(window,"WeakSet",{value:function(e){return new t(e)}})),Object.assign||Object.defineProperty(Object,"assign",{enumerable:!1,configurable:!0,wri[o])}rett[i[a];return n}var a,o=/_?t(\d)?(imestamp)?=\d+&?/g,l=["aegis.qq.com","tamaegis.com","/aegis-sdk","rumt-","/flog.core.min.js","pingfore.qq.com","pingfore.tencent.com","zhiyan.tencent-cloud.net","h.trace.qq.com","btrace.qq.com","beacon.qq.com","dmplog.qq.com","qq.com/report","svibeacon.onezapp.com","cube.weixinbridge.com","doubleclick.net","pcmgrmonitor.3g.qq.com","tdm.qq.com","report.qqweb.qq.com","tpstelemetry.tencent.com","insight.cloud.tencent.com","facebook.com","facebook.net","google","yahoo.com","twitter.com","ga-audiences","report.idqqimg.com","arms-retcode.aliyuncs.com","px.effirst.com","sentry","baidu.com","hot-update.json","u.c.b.r.o.w.s.e.r","report.url.cn","sockjs-node","m3u8"],h=["ResizeObserver loop limit exceeded","ResizeObserver loop completed","Failed to execute 'transaction'","window.indexedDB.deleteDatabase is not a function"],c=["ext1","ext2","ext3","level","trace","tag","seq","code"],u=["static","fetch"],d=(f.prorn r;return-1},back:t}),this},fhis.on(e,t,1)},f.pr}return null}},f.prototype.clear=function(){this.event/.test(e)}function y(e,t,r){var n,s;try{if("function"==typeof(null==t?void 0:t.retCodeHandler))return{code:void 0===(i=(s=t.retCodeHandler(e,null==r?void 0:r.url,null==r?void 0:r.ctx,null==r?void 0:r.payload)||{}).code)?"unknown":i,isErr:s.isErr};if(!(e="string"==typeof e?JSON.parse(e):e))return{code:"unknown",isErr:!1};"function"==typeof(null==(n=null==t?void 0:t.ret)?void 0:n.join)&&(B=[].concat(t.ret.map((function(e){return e.toLowerCase()}))));var i,a=Object.getOwnPropertyNames(e).filter((function(e){return-1!==B.indexOf(e.toLowerCase())}));return a.length?{code:""+(i="æœªçŸ¥"!==(i=e[a[0]])&&""!==i?i:"unknown"),isErr:0!==i&&"0"!==i&&"unknown"!==i}:{code:"unknown",isErr:!1}}catch(e){return{code:"u(l?h:h[0]))}}function I(e){return function(t,r){e.lifeCycle.emit("modifyRequest",t);var n=e.config.modifyRequest;if("function"==typeof n)try{var s=n(t);"object"==typeof s&&"url"in s&&(t=e.indexOf(e)}(ee=a=a||{})[ee.number=-1]="number",ee.string="";var D,M,O,q=["application/xhtml+xml","application/xml","application/pdf","application/pkcs12","application/javascript","application/x-javascript","application/ecmascript","application/vnd.mspowerpoint","application/vnd.apple.mpegurl","application/ogg","text/css","text/javascript","image","audio","video","video/mp2t"],U=/\.(json|js|css|jpg|jpeg|png|svg|apng|webp|gif|bmp|mp4|mp3|ts|mpeg|wav|webm|ogg|flv|m3u8|ttf|woff2|otf|eot|woff|html|htm|shtml|shtm|)$/gi,B=["ret","retcode",".ae+e+))='"==t?'"'+e+'"':e)},V=/data:(image|text|application|font)\/.*;base64/,z=((ee=D=D||{}).INFO_ALL="-1",ee.API_RESPONSE="1",ee.INFO="2",ee.ERROR="4",ee.PROMISE_ERROR="8",ee.AJAX_ERROR="16",ee.SCRIPT_ERROR="32",ee.IMAGE_ERROR="64",ee.CSS_ERROR="128",ee.CONSOLE_ERROR="256",ee.MEDIA_ERROR="512",ee.RET_ERROR="1024",ee.REPORT="2048",ee.PV="4096",ee.EVENT="8192",ee.PAGE_NOT_FOUND_ERROR="16384",ee.WEBSOCKET_ERROR="32768",ee.BRIDGE_ERROR="65536",ee.LAZY_LOAD_ERROR="131072",(ee=M=M||{}).LOG="log",ee.SPEED="speed",ee.PERFORMANCE="performance",ee.OFFLINE="offline",ee.WHITE_LIST="whiteList",ee.VITALS="vitals",ee.PV="pv",ee.CUSTOM_PV="customPV",ee.EVENT="event",ee.CUSTOM="custom",ee.SDK_ERROR="sdkError",ee.SET_DATA="setData",ee.LOAD_PACKAGE="loadPackage",(ee=O=O||{}).production="production",ee.development="development",ee.gray="gray",ee.pre="pre",ee.daily="daily",ee.local="local",ee.test="test",sta&(e.level=D.nu.I)}})}],M.LOG)(t)}},Z=function(){},ee=(Object.defineProperty(he.prototype,"__version__",{get:function(){return"1.41.9"},enumerable:!1,configurable:!0}),Object.defineProperty(he.prototype,"LogType",{get:function(){return D},enumerable:!1,configurable:!0}).emit("onInited")},he.pnfig),tedPluginsugins.splice(e,1)},he.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r={level:D.INFO,msg:e};1===e.length&&e[0].msg&&Object.assign(r,s({},e[0]),{level:D.INFO}),this.normalLogPipeline(r)},he.prototype.infoAll=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r={level:D.INFO_ALL,msg:e};1===e.length&&e[0].msg&&Object.assign(r,s({},e[0]),{level:D.INFO_ALL}),this.normalLogPipeline(r)},hmalLogPipeline(r)},malLogPipeline(r)},he.prototypipeline" method')},he.prototype.reportPv=function(e){var t,r=this;e&&(t=""+Object.getOwnPropertyNames(e){retun e+"="+r.bean[e]})).join("&"),ype:M.CUSTOM_PV})}],M.CUSTOM_PV)(null))},he.prototype.reportEvent=function(e){e&&(e="string"==typeof e?{name:e,ext1:this.config.ext1||"",ext2:this.config.ext2||"",ext3:this.config.ext3||""}:e).name&&("string"!=typeof e.name&&(e.name=String(e.name)),this.eventPipeline(e))},he.prototype.reportTime=function(e,t){if("object"==typeof e)return this.reportT(e);"string"==typeof e&&"number"==typeof t&&(t<0||6e4<t||this.submitCustomTime(e,t))},he.prototype.reportT=function(e){var t=e.name,r=e.duration,n=void 0===(n=e.ext1)?"":n,s=void 0===(s=e.ext2)?"":s,i=void 0===(i=e.ext3)?"":i;if(e=e.from,"string"==typeof t&&"number"==typeof r&&"string"==typeof n&&"string"==typeof s&&"string"==typeof i&&!(r<0||6e4<r))return this.submitCustomTime(t,r,n,s,i,void 0===e?"":e)},he.prototype.time=function(e){"string"==typeof e&&(this.timeMap[e]||(this.timeMap[e]=Date.now()))},he.prototype.timeEnd=function(e){"string"==typeof e&&this.timeMap[e]&&(this.submitCustomTime(e,Date.now()-this.timeMap[e]),delete this.timeMap[e])},he.prototyp,from:i||void 0})},he.prt){this.bean[e]=t},he.prototype.sendPipeline=function(e,t){var r,n=this;return E(i([function(e,t){if("number"!=typeof r.config.random&&(r.config.random=1),!r.isHidden||!r.isGetSample)if(r.isGetSample)r.isHidden||t(e);else{if(r.isGetSample=!0,Math.random()<r.config.random)return r.isHidden=!1,t(e);r.isHidden=!0}},S(r=tly(r,i([e],s))}))},k(this)]))}}))},k(this)])(e)},he.prototype.ready=function(e,t,r){throw new Error('You need to override "ready" method')},herequest" method')},he.prot],M.SDK_ERROR)(e)},hestructor),P(he))}},he.version="1.41.9",he.instances=[],he.logType=D,he.environment=O,he.installedPlugins=[],he),te=(gerOnNewAegis(e))},lethis.uninstall(e)},le.prototype.countInstance=function(){return this.instances.length},le.pt.apply(this,[e])}e(r);n&&e(r,n)}))},l"!=typeof e)||!!e},le.pid 0:e[this.name]},tances.indexOf(e)},le.prohis.getConfig(e))},le.prototypehis.getConfig(e))},le),re=new te({name.aid=t}catcnfig.[r]=e[r])})),t):e},se=new te({name:"reportAssetSpeed"}),ie=se=new te({name:"reportAssetSpeed",collectCur:0,collectEntryType:"resource",ASSETS_INITIATOR_TYPE:["img","css","script","link","audio","ourceTimings())})},publish:function(e,t){this.$walk((function(r){r===t&&r.speedLogPipeline(erateLog(i,r),t)}}arInterval(r)})("error",t,!0)}))},generateLog:function(e,t){t="function"==typeof(null==(r=t.api)?void 0:r.resourceTypeHandler)?null==(r=t.api)?void 0:r.resourceTypeHandler(e.name):"";var r=e.transferSize;return{url:m(e.name),method:"get",duration:Number(e.duration.toFixed(2)),status:200,type:t||"static",isHttps:_(e.name),nextHopProtocol:e.nextHopProtocol||"",urlQuery:v(e.name,!0),domainLookup:g(e.domainLookupEnd-e.domainLookupStart),connectTime:g(e.connectEnd-e.connectStart),transferSize:0<r?r:-1}},collishMany(r,e,!0))},destroy:function(){this.option.publish=function(){}}}),ae=window.navigator.userAgent.t,this.name=e.name}function he(e){var t,r,n,s,i,a,o,l,h,c,u,p,f,g,v=this;this.isGetSample=!1,this.isHidden=!1,this.config={version:0,delay:1e3,onError:!0,repeat:60,random:1,aid:!0,device:!0,pagePerformance:!0,webVitals:!0,speedSample:!0,onClose:!0,reportLoadPackageSpeed:!0,hostUrl:"https://aegis.qq.com",env:"production",url:"",offlineUrl:"",whiteListUrl:"",pvUrl:"",speedUrl:"",customTimeUrl:"",performanceUrl:"",webVitalsUrl:"",eventUrl:"",setDataReportUrl:"",reportImmediately:!0},this.isWhiteList=!1,this.lifeCycle=new d,this.bean={},this.normalLogPipelgth)}return e})))},(g=(t=this).config,function(e,t){var r="number"==typeof g.repeat?g.repeat:60;if(r<=0)return t(e);var n=(null==g?void 0:g.id)+"_error",s=K[n]||{};t(e.filter((function(e){if(e.level===D.ERROR||e.level===D.PROMISE_ERROR||e.level===D.AJAX_ERROR||e.level===D.SCRIPT_ERROR||e.level===D.IMAGE_ERROR||e.level===D.CSS_ERROR||e.level===D.MEDIA_ERROR||e.level===D.RET_ERROR||e.level===D.BRIDGE_ERROR||e.level===D.PAGE_NOT_FOUND_ERROR||e.level===D.WEBSOCKET_ERROR||e.level===D.LAZY_LOAD_ERROR){if(e=e.msg.slice(0,200),s[e]>r)return X[n]||Y(n),!1;s[e]=1+~~s[e],K[n]=s}return!0})))}),(p=this.lifeCycle.reWrite",e),t(e))}),(u=this,setTimeout((function(){var e=void 0===(t=(r=u.config).pvUrl)?"":t,t=r.spa,r=-1<["web-sdk","mp-sdk"].indexOf("web-sdk");e&&(r&&!t||!rurl:e,type:M.PV})}],unction(e,t){t(e)}),(h=l=o=!1,c=[],(i=this).lifeCycle.ononfig.uin?50:500)})),i.lifeCycle.on("destroy",(functi}&&t(e)}catch(e){}},Q(this)]),this.eventPipeline=E([e})}],M.EVENT)(e)})]),this.timeMap={},this.failRequestCount=0,this.customTimePipeline=E([})}],M.CUSTOM)(e)})]),this.config=(r=this.config,void 0===(e=e.hostUrl)&&(e="https://aegis.qq.com"),r.url=r.url||e+"/collect",r.offlineUrl=r.offlineUrl||e+"/offline",r.whiteListUrl=r.whiteListUrl||e+"/collect/whitelist",r.pvUrl=r.pvUrl||e+"/collect/pv",r.eventUrl=r.eventUrl||e+"/collect/events",r.speedUrl=r.speedUrl||e+"/speed",r.customTimeUrl=r.customTimeUrl||e+"/speed/custom",r.performanceUrl=r.performanceUrl||e+"/speed/performance",r.webVitalsUrl=r.webVitalsUrl||e+"/speed/webvitals",r.setDataReportUrl=r.SetDataReportUrl||e+"/speed/miniProgramData",r),he.in).toString(16)}))}oe.macos=function(){returipod()||oe.ipad()},oe.iphone=function(){return!oe.windows()&&A("iphone")},oe.ipod=function(){return turn A("ipas()&&A("android")},oe.androidPhone=function(){return oe.android()&&A("mobile")},oe.androidTablet=function(){return oe.android()&&!A("mobilerry")||A("bb10")},y()&&!A("tablet")},oe.blackberryTablet=function(){return oe.blackberry()&&A("tablet")},oe.windows=function(){return A("windows")},oe.windowsPhone=function(){return oe.windows()&&A("phone")oe.windolet"))&&A(" rv:")},oe.fxosPhone=function(){return oe.fxos()&&A("mobilos()&&A("return A("mlocation.protoof window.one()||oe.||oe.fxosTat()&&!oeXObject"in window};var ue={generateTraceId:pe(16),generateSpanId:pe)?t+": "+e:""}var me,_e,ye,b")[1])?atob(e):""},traceparent:function(e){return e.split("-")[1]},b3:function(e){return e.split("-")[n e.split("-")[0]}},Se=(Me.prototype.generate=function(e,t){if(void 0===t&&(t={}),this.url=e,!this.isUrlIgnored()&&this.isUrlInTraceUrls()&&this.traceType){switch(this.traceType){case"traceparent":this.traceId=this.createTraceparent();break;case"b3":this.traceId=this.createB3();break;case"sw8":this.traceId=this.createSw8();break;case"sentry-trace":this.traceId=this.createSentryTrace();break;default:return void(this.traceId="")}return t[this.traceType]&&(this.traceId=t[this.traceType]),{name:this.traceType,value:this.traceId}}},Me.prototyper(1).toString(16)},Me.ceId()+"-"+e+"-1"},Me.prototype.createSw8=function(){var e=new URL(location.href),t=w(),r=w();return"1-"+String(btoa(r))+"-"+String(btoa(t))+"-1-"+String(btoa("aegis"))+"-"+String(btoa("1.41.9"))+"-"+String(btoa(encodeURI(location.pathname)))+"-"+String(btoa(e.host))},Me.prototypen ce()+"-"+e+"-1"},Me.protreturn!0}return!1},Me.prototypeturn!0}}return!1},Me.pr===t:!!e.match(t)},Me),Ie=!1,ke=[],Ee=/^\/[^/]/,Pe=!1,xe=[],Le=(new te({name:"reportApiSpeed"}),new te({name:"reportApiSpeed",override:!1,onNewAegis:function(e){var t,r;this.override||(null!=(r=e.config.api)&&r.injectTraceHeader&&(this.traceRequestHeader=new Se(r.injectTraceHeader,null!=(t=null==r?void 0:r.injectTraceIgnoreUrls)?t:[],null==r?void 0:r.injectTraceUrls)),this.override=!0,this.overrideFetch(e.config,e),this.overrideXhr(e.config,e))},getRequestType:function(e,t,r){var n,s;return void 0===t&&(t=""),e="function"==typeof(null==(s=e.api)?void 0:s.resourceTypeHandler)?null==(s=e.api)?void 0:s.resourceTypeHandler(r):"",-1===u.indexOf(e)&&(n=void 0===t?"":t,s=(void 0===r?"":r).split("?")[0],e=ing(n).indexOf(e)}))?"static":"fetch"),e},overrideFetch:function(e,t){var r=this,n=e.api,s=(n={name:this.name,traceRequestHeader:null!=n&&n.injectTraceHeader?this.traceRequestHeader:null,then:function(n,s,i,a){var o,l;R(i,e.hostUrl)||(o=n.headers?n.headers.get("content-type"):"","fetch"===(l=r.getRequestType(e,o,i))?n.clone().text().then((function(o){var h,c=n.status<=0||400<=n.status,u=(null==(u=e.api)?void 0:u.reqHeaders)||[],d=ge(null==a?void 0:a.headers,u,"req"),p=(u=(null==(u=e.api)?void 0:u.resHeaders)||[],ge(n.headers,u,"res")),f=fe(null==a?void 0:a.headers),g=(u=y(o,e.api,{url:i,ctx:n,payload:null==a?void 0:a.body})).code,v=u.isErr,m=(u=null==(u=e.api)?void 0:u.apiDetail)?b(null==a?void 0:a.body,null==(h=e.api)?void 0:h.reqParamHandler,{url:i}):"",_=u?b(o,null==(h=e.api)?void 0:h.resBodyHandler,{url:i,ctx:n}):"";setTimeout((function(){var h=r.getPerformanceEntryByUrl(e,{url:i,duration:s,type:l,status:n.status||0,method:(null==a?void 0:a.method)||"get"}),u=[c?"FETCH_ERROR: "+o:"","fetch req url: "+i,"res status: "+(h.status||0),"res duration: "+h.duration+"ms",d,p,"req method: "+(h.method||"GET"),"res retcode: "+g,ve(m,"req param"),ve(_,"res data")].filter((function(e){return e})).join("\n\n");h.payload=null==a?void 0:a.body,h.ret=g,h.isErr=+v,r.publishNormalLog({msg:u,level:c?D.AJAX_ERROR:v?D.RET_ERROR:D.API_RESPONSE,code:g,trace:f},t),r.publishSpeed(h,t)}),0)})):setTimeout((function(){var o=r.getPerformanceEntryByUrl(e,{url:i,duration:s,type:l,status:n.status||0,method:(null==a?void 0:a.method)||"get"});o.type="static",o.urlQuery=v(i,!0),r.publishSpeed(o,t)}),0))},catch:function(n,s,i,a){var o,l,h,c,u;throw R(i,e.hostUrl)||(o=r.getRequestType(e,"",i),l=(null==(l=e.api)?void 0:l.reqHeaders)||[],h=ge(null==a?void 0:a.headers,l,"req"),c=fe(null==a?void 0:a.headers),u=null!=(l=e.api)&&l.apiDetail?b(null==a?void 0:a.body,null==(l=e.api)?void 0:l.reqParamHandler,{url:i}):"",setTimeout((function(){var l=r.getPerformanceEntryByUrl(e,{url:i,duration:s,type:o,status:0,method:(null==a?void 0:a.method)||"get"});r.publishSpeed(l,t),l="AJAX_ERROR: "+n+"\n                          \nreq url: "+i+"\n                          \nres status: 0\n                          \nres duration: "+l.duration+"ms\n                          \nreq method: "+((null==a?void 0:a.method)||"get")+"\n                          \nreq param: "+u+"\n                          \n"+h,r.publishNormalLog({msg:l,level:D.AJAX_ERROR,code:-400,trace:c},t)}),0)),n}},this.hackFetchOptions=n,this.hackFetchOptions),i=null==(n=e.api)?void 0:n.ignoreHackReg;if(void 0===i&&(i=/\.flv(\?|$)/gi),xe.find((function(e){return e.name===s.name})))throw new Error("name '"+s.name+"' is already in hackFetch option list");xe.push(s),!Pe&&window.fetch&&(Pe=!0,be=window.fetch,window.fetch=function(e,t){void 0===t&&(t={});var r="string"==typeof e?e:null==e?void 0:e.url;if(null!=(o=null==i?void 0:i.test)&&o.call(i,r))return be(r,t);Ee.test(r)&&(r=""+location.origin+r);var n,a,o=(s||{}).traceRequestHeader;o&&(a=(t||{}).headers,n=(a=o.generate(r,o=void 0===a?{}:a)||{}).name,a=a.value)&&n&&(t.headers=Object.assign(o,((o={})[n]=a,o)));for(var l=0;l<xe.length;l++){var h=xe[l];try{"function"==typeof h.beforeFetch&&h.beforeFetch(r,t)}catch(e){}}var c=Date.now();retch(e){}}atch(e){}}throw e}))})},overrideXhr:function(e,t){var r,n=this,s={name:this.name,send:function(r,s){var i,a,o=Date.now(),l=(((null==e?void 0:e.api)||{}).injectTraceHeader&&(i=(a=n.traceRequestHeader.generate(r.aegisUrl)||{}).name,a=a.value,i)&&a&&r.setRequestHeader(i,a),r.addEventListener("loadend",(function(){var i,a,u,d,p=r.aegisUrl||"";R(p,e.hostUrl)||"abort"===r.failType||(i="",(r.failType||!r.status||400<=r.status)&&(i=r.failType||"failed"),a=Date.now()-o,u=r.getResponseHeader("content-type"),d=n.getRequestType(e,u,p),setTimeout((function(){var o=n.getPerformanceEntryByUrl(e,{url:p,duration:a,type:d,status:r.status,method:r.aegisMethod||"get"});if("fetch"===d){var u=(null==(u=e.api)?void 0:u.reqHeaders)||[],f=ge(r.aegisXhrReqHeader,u,"req"),g=(u=(null==(u=e.api)?void 0:u.resHeaders)||[],r.getAllResponseHeaders().spl&(e[t[0]]=t[1]),e}),{})),m=ge(g,u,"res"),_=fe(r.aegisXhrReqHeader),y=(u=null==(g=e.api)?void 0:g.apiDetail)?b(s,null==(g=e.api)?void 0:g.reqParamHandler,{url:p}):"",w=u?b(r.response,null==(g=e.api)?void 0:g.resBodyHandler,{url:p}):"";try{!function(e,t,r,n){var s,i,a,o;try{if("function"==typeof(null==t?void 0:t.retCodeHandlerAsync))return t.retCodeHandlerAsync(e,null==r?void 0:r.url,nulnown":t,isErr:e})}));if("function"==typeof(null==t?void 0:t.retCodeHandler))return a=(i=t.retCodeHandler(e,null==r?void 0:r.url,null==r?void 0:r.ctx,null==r?void 0:r.payload)||{}).code,o=i.isErr,null!=n&&n({code:void 0===a?"unknown":a,isErr:o});if(!(e="string"==typeof e?JSON.parse(e):e))return null!=n&&n({code:"unknown",isErr:!1});"function"==typeof(null==(s=null==t?void 0:t.ret)?void 0:s.join)&&(B=[].concat(t.ret.map((function(e){return e.toLowerCase()}))));var l=Object.getOwnProper(e.toLowerCase())}));if(l.length)return"æœªçŸ¥"!==(a=e[l[0]])&&""!==a||(a="unknown"),null!=n&&n({code:""+a,isErr:0!==a&&"0"!==a&&"unknown"!==a});null!=n&&n({code:"unknown",isErr:!1})}catch(e){null!=n&&n({code:"unknown",isErr:!1})}}(r.response,e.api,{url:p,ctx:r,payload:s},(function(e){var r=e.code,a=(e=e.isErr,[i?"AJAX_ERROR: request "+i:"","fetch req url: "+p,"res status: "+(o.status||0),"res duration: "+o.duration+"ms",f,m,"req method: "+(o.method||"GET"),"res retcode: "+r,ve(y,"req param"),ve(w,"res data")].filter((function(e){return e})).join("\n\n"));o.ret=r,o.isErr=+e,o.payload=s,n.publishNormalLog({msg:a,level:i?D.AJAX_ERROR:e?D.RET_ERROR:D.API_RESPONSE,code:r,trace:_},t),n.publishSpeed(o,t)}))}catch(u){o.ret="unknown",n.publishSpeed(o,t)}}else o.type="static",o.urlQuery=v(p,!0),n.publishSpeed(o,t);r.removeEventListener("abort",l),r.removeEventListener("error",h),r.removeEventListener("timeout",c)}),0))})),function(){r.failType="abort"}),h=function(){r.failType="timeout"};r.addEventListener("abort",l),r.addEventListener("error",h),r.addEventListener("timeout",c)}};this.hackXHROptions=s,r=this.hackXHROptions,ke.find((function(e){return e.name===r.name}))||(ke.push(r),!Ie&&window.XMLHttpRequest&&(me=window.XMLHttpRequest.prototype.send,_e=window.XMLHttpRequest.prototype.open,ye=window.XMLHttpRequest.prototype.setRequestHeader,Ie=!0,window.XMLHttpapply(this,arguments)},window.XMLHttpRequest.prototype.setRequestHeader=function(){var e,t=arguments[0],r=arguments[1];if(this.aegisXhrReqHeader=null!=(e=this.aegisXhrReqHeader)?e:{},!(-1<["traceparent","b3","sw8","sentry-trace"].indexOf(t)&&(this.aegisXhrReqHeader[t]||(arguments[1]=r),this.aegisXhrReqHeader[t])))return this.aegisXhrReqHeader[t]=arguments[1],ye.apply(this,arguments)},window.XMLHttpapply(this,arguments)}))},getPerformanceEntryByUrl:function(e,t){return null!=(e=e.api)&&e.usePerformanceTiming&&"string"==typeof t.url&&(e=null==(e=performance.getEntriesByName(t.url))?void 0:e.pop())?{url:t.url,isHttps:_(t.url),method:t.method,type:t.type,status:t.status,duration:Number(e.duration.toFixed(2)),nextHopProtocol:e.nextHopProtocol||"",domainLookup:g(e.domainLookupEnd-e.domainLookupStart),connectTime:g(e.connectEnd-e.connectStart)}:{url:t.url,isHttps:_(t.url),method:t.method,type:t.type,status:t.status,duration:Number(t.duration.toFixed(2)),nextHopProtocol:"",domainLookup:a.number,connectTime:aeedLogPipeline(e)rmalLogPis.option.override=!1}})),Ae={},De=new te({name:"reportBridgeSpeed",is.overrideBridge(e))},publishSpeed:function(e,t){this.$walk((function(r){r===t&&r.speedLogPipeline(e)}))},overrideBridge:function(e){var t=this,r=e.config;r.reportBridgeSpeed&&r.h5Bridge&&r.h5BridgeFunc.length&&r.h5BridgeFunc.forEach((function(n){var s=r.h5Bridge[n];Ae[n]=s,r.h5Bridge[n]=function(){for(var n=[],i=0;i<arguments.length;i++)n[i]=arguments[i];var a=n[0],o=n[1],l=n[2],h=n[3],c=Date.now();s(a,o,l,(function(n){var s=(i=y(n,r.api)).code,i=i.isErr;s={url:a+"-"+o,name:a+"-"+o,duration:Date.now()-c,type:"bridge",ret:s,isErr:+i},t.publishSpeed(s,e),h(nge[t]=Aeis=t?0:t)<=e&&e<=r?e:n}(Ve=we=we||{})[Ve.unknown=100]="unknown",Ve[Ve.wifi=1]="wifi",Ve[Ve.net2g=2]="net2g",Ve[Ve.net3g=3]="net3g",Ve[Ve.net4g=4]="net4g",Ve[Ve.net5g=5]="net5g",Ve[Ve.net6g=6]="net6g",(Ve=Re=Re||{})[Ve.android=1]="android",Ve[Ve.ios=2]="ios",Ve[Ve.windows=3]="windows",Ve[Ve.macos=4]="macos",Ve[Ve.linux=5]="linux",Ve[Ve.other=100]="other",(Ve=Te=Te||{})[Ve.unknown=100]="unknown",Ve[Ve.normal=0]="normal",Ve[Ve.weak=1]="weak",Ve[Ve.disconnected=2]="disconnected";var qe,Ue,Be,Ne,Fe,$e,je,He,Ge,Ve=new te({naetworkSindow.screenturn t?Re[t]:Re.other},refreshTimer)}),1e4)}))},refrfreshwe.net2g:we.unknown))},We=window.WebSock­£åœ¨è¿žæŽ¥ä¸­ï¼"},o))}));break;case a:Xe.forEach((function(e){(0,e.sendErr)(s({msg:"æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œè¿žæŽ¥æ­£åœ¨å…³é—­ï¼"},o))}))}}}}}),r}},Ye=new te({name:"onError"}),Je=Ye=new te({name:"onError",onNewAegis:function(e){this.startListen(e)},startListen:function(e){function t(t){(t=t&&F(t.reason))&&c.publishErrorLog({msg:"PROMISE_ERROR: "+t,level:D.PROMISE_ERROR},e)}function r(t){var r;if(t=(null==t?void 0:t.target)||(null==t?void 0:t.srcElement)){var n=t.src||t.href||"";if(t=void 0===(t=t.tagName)?"script":t,!(R(r=n,e.config.hostUrl)||-1<window.location.href.indexOf(r))){var s={msg:t+" load fail: "+n,level:D.INFO};if(/\.js$/.test(n))s.level=D.SCRIPT_ERROR;else if(/\.css$/.test(n))s.level=D.CSS_ERROR;else switch(t.toLowerCase()){case"script":s.level=D.SCRIPT_ERROR;break;case"link":s.level=D.CSS_ERROR;break;case"img":s.level=D.IMAGE_ERROR;brg:(s||"")+" @ ("+(F(t[1])||"")+":"+(t[2]||0)+":"+(t[3]||0)+")\n          \n"+F(t[4]||""),level:D.ERROR},e),null!=u&&u.calunction(){0===Ye.countInstance()&&(window.document.removeEventListener("unhandledrejection",t),window.document.removeEventListener("error"name,onErr:function(t){var r;null!=(r=c.publishWsErrorLog)&&r.call(c,t,e)},sendErr:function(t){var r;null!=(r=c.publishWsErrorLog)&&r.call(c,t,e)}},this.hackWebsocketConfig=n,n=this.hackWebsocketConfig,window.Proxy)&&window.WebSocket&&(s=window.WebSocket,window&&!s.isfind((function(e){return e.key===o.key}))||o&&Xe.push(o))},publishErrorLog:function(e,t){this.$walk((function(r){r===t&&r.normalLogPipeline(e)}))},publishWsErrorLog:function(e,t){var r=e.connectUrl,n=e.msg;e=e.readyState,this.publishErrorLog({bsocketConfig&&(e=this.option.hackWebsocketConfig,window.WebSocket=We,-1!==(t=Xe.findIndex((function(t){rrmance"}anFilter:["from"],typ=n.extraPerformanceData).engineInit,r=r.bundleLoad,qe=s(s({},qe),{enginer,0,1e4)})),t.publish(qe,e))}))}catch(e){}},getFirstScreenTiming:function(e,t){var r=this;e.lifeCycle.on("destroy",(function(){u&&clearTimeout(u)}));var n,s=this,i=["script","style","link","br"],a=All("[AEGIS-FIRST-SCREEN-TIMING]")).length&&(r.setFirstScName.toLocaleLowerCase())||s.isEleInArray(e,t.roots)||(t.roots.push(e),t.rootsDomNum.push(s.walkAndCount(e)||0)))}))})),t.roots.length&&a.push(t)})));l.observe(document,{childList:!0,subtree:!0});var h,c=function(ar n=0;n<t.roots.length;n++)t.rootsDot={tagName:e.tagName},r=e.attributes;if(!r)return e;for(var n=0;n<r.length;n++){var s=r[n];s.name&&(t[s.name]=e.getAttribute(s.name))}return t}))})));var h,d=(p=performance.timinoading,p=p.loadEventStart-p.domInteractive,f=i;u=null;for(var g=0,v=[d,p,f];g<v.length;g++)if(v[g]<=0&&0<Qe){u=setTimeout((function(){retue.config)?voi:t,markDoms:n}))ClientRect)&&length)for(var n=0;n<r.length;netent}return!1}});function et(){Fe=[],Be=-1,Ue=null,nt(addEventListener)}function tt(e,t){Ue||(Ue=t,Be=e,Ne=new Date,nt(removeEventListener),rt())}function rt(){var e;0<=Be&&Be<Ne-je&&(e={entryType:"first-input",name:Ue.type,target:Ue.target,cancelable:Ue.cancelable,startTime:Ue.timeStamp,processingStart:Ue.timeStamp+Be},,"keydown","touchstart","poin("pointerup",i,$e),removeEventListener("pointercancel",a,$e)},addEventListener("poventListener("visibilitychange",(function e(tityState&&(Ge=t.timeStamp,removeEventListener("visibilitychange",e,!0))}),!0),et(),self.webVenT(Ttperforman=fu<ktEventListener("prerenderingchange",Pt,!0))},xt=function(){addEventLit,!0)},Lt=[1800,3e3],At=[.1,.25],Dt={passive:!0,capture:!0},Mt=new Date,Ot=function(e,t){mt||(mt=t,_t=e,yt=new Date,gt(removeEventListener),pt())},qt=[100,300],Ut=[2500,4e3],Bt={},Nt=(new te({name:"webVitals"}),{FCP:-1,LCP:-1,FID:-1,CLS:-1}),Ft=new te({name:"webVitals",onNe),lt(r),Ct((funcs()),a.disconnect()ion(){e(o.takeRecords()),n(!0)})),Ct((function(){s=st("CLS",i=0),n=at(t,s,At,r.reportAllChanges),ot((funcrmanceUrl)?void 0:i.indexOf("?"))?"?":"&";r({url:t.config.webVitalsUrl+i+s.join("&"),type:M.VITALS,log:e,sendBeacon:!0})}],M.VITALS)(s({},Nt))}))},destroy:function(){this.option.publisndPments),n=null;return"function"==typeof Event?n=new Event(e):(n=document.createEvent("HTMLEvents")).initEvent(e,!1,!0),window.dispatchEvent(n),r})},sendPv:function(e){var t=this;setTimeout((function(){var r=locationi=s.config.pvUrl)&&n&&n!==t.originFireUrl&&(s.senncodeURIComponent(r),beanFilter:["from"],type:M.PV})}],M.PV)(null),t.originFireUrl=n)}))}),0)},destroy:function(){this.option.sendPv=function(){}}})rl]<a;trEach((function(e){var t=ne(e);i[e.type].push(t)})):(n=ne(t),i[t.type].push(n)),o.append("payload",$(s({duration:i},r))),o),log:e})}],M.SPEED)(e)}]),e.asyncPlugin=!0;try{"undefined"!=typeof document&&(e.uin=e.uin||(null!=(t=document.cookie.match(/\buin=\D+(\d*)/))?t:[])[1]||(null!=(r=document.cookie.match(/\bilive_uin=\D*(\d+)/))?r:[])[1]||""),a.init(e),a.extendBean("sessionId",Ht.sessionID),a.extendBean("from",a.getCurrentPageUrl()),"undefined"!=typeof document&&a.extendBean("referer",encodeURIComponent(document.referrer||"")),e.ext1&&a.extendBean("ext1",encodeURIComponent(e.ext1)),eIComponent(e.ext2)),e.ext3&&a.extendBean("ext3",encodeURIComponent(e.ext3))}catch(e){a.sendSDKError(e)}return a}fubean).filter((function(t){returnfig.pageUrl||locatar t=[],r=0;r<argumenfunction(e,t,r){this.config.reportImmediately||this.isReportReady?this.$request(e,t,r):this.reportRequestQueue.push({options:e,success:t,fail:r})},Ht.prototype.$request=function(e,t,r){var n,s,i,a;if(e&&"string"==typeof e.url&&""!==e.url&&this.bean.id)return a=e.url,!1!==e.addBean&&(a=a+(-1===a.indexOf("?")?"?":"&")+this.getBean(e.beanFilter)),e.url=a,a=e.method||"get",(e=(s=this.config.onBeforeRequest)?s(e,this):e)&&e.url?void((null!=e&&e.sendBeacon||this.sendNow)&&"function"==typeof(null===navigator||void 0===navig0,n.addEventListener("readystatechange",(function(){4===n.readyState&&(400<=n.status||0===n.status?null!=r&&r(n.response):null!=t&&t(n.response))}.getOwnPropertyNames(i).map((function(e){var t=i[e];return e+"="+("string"==typeof t?encodeURIComponent(t):encodeURIComponent(JSON.stringify(t)))})).join("&").replace(/eval/gi,"evaI"),s+(-1===s.indexOf("?")?"?":"&")+a):s)),n.send()):(n.open("post",e.url),e.contentType&&n.setRequestHeader("ConteninsLogs=function(){var eedLog(this)},Ht.prototype.uploadLogs=function(e,t){var r;void 0===e&&(e={}),void 0===t&&(t={}),null!=(r=this.lifeCycle)&&r.emitth;s++)n[s]=arguments[publishNotReportedLog:fueLogs:function(e){null!=e&&e.speedLogPipeline([]),null!=e&&e.eventPipeline([]),null!=e&&e.customTimePipeline([]),null!=e&&e.normalLogPipeline([])}});renit(f(aNOPQis._{var_eveEventEmitter=o,e.exports=o},908:(e,t,r)=>{var n;n="undefined"!=typeof window?window:void 0!==r.g?r.g:"undefined"!=typeof self?self:{},e.exports=n},43:function(e,t,r){var n,s;!function(i,a){"use strict";n=function(){var e=function(){},t="undefinfunction(e){a.setLevel"===e)throw new TypeError("You must supply a name when creatindFactory)),t};var p=typeof window!==t?window.log:void 0;return u.noConflict=function(){return typeof window!==t&&window.log=on(););return e.spe={iotypxports")(n)}}},t={}expole?(f("objurn this||new Function("return this")()}catch(e){ect"==typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var n={};return(()=>{"use strict";r.d(n,{default:()=>Zl});var e=r(729),t=r.n(e);const s=class{constructor(){this.){this.observer.once(e,t)}trigger(e){for([n-1]=arguments[n];this.observer.emit(e,...r)}off(e,t){this.observer.off(e,t)}eventNames(){var e=this.observer._events;return e?Object.keys(e):[]}};function i(){return{publicIP:"",randomPlayId:`${Date.now()}-${Math.floor(Math.random()*(Math.floor(999999999)-Math.ceil(1)))+Math.ceil(1)}`,loadTime:Date.now(),channelId:"",originalUrl:"",cdnDomain:"",startTime:Date.now(),videoId:"video",isLive:!1,signalServer:"signal.qvb.qcloud.com",vodTrackerServer:"https://tracker-00.qvb.qcloud.com/api/tracker-flash/v1",liveTrackerServer:"https://tracker-00.qvb.qcloud.com/api/tracker/v2",reportServer:"https://log.qvb.qcloud.com/reporter/vlive",stunServer:"",PCHeartInterval:6e3,maxPeerCache:20,maxPCConnecting:10,maxPCConnected:12,minPCConnected:10,maxConnectRequestEachPeriod:2,checkPeerInterval:8e3,bufferCount:10,sliceCount:1,DCChunkSize:64512,videoType:"VOD",peerConnWaWeight:.75,bitmapInterval:12e3,channelIdIncludeHost:!0,channelIdIncludeSearch:!1,enableServiceWorker:!1,confInterval:0,enableRTLog:!1,rtLogLevel:3,enableAutoConfig:!0,targetDurationTemplate:[1,2,3,4,5,6,7,8,9,10],enableLLS:!1,p2pReqTimeout:3e3,maxP2PDepth:6,streamP2PChunkLength:61440,maxSubscribeSize:5,syncNodeInterval:1e3,levelForTracker:"default",lowBufferThreshold:0,maxP2PRetryTimes:20,llsAutoConfig:{p2pReqTimeout:[500,1e3,2e3,3e3,4e3,5e3,6e3,7e3,8e3,9e3,1e4]},enableP2pAutoTimeout:!0,cdnEstimateRatio:1.5,enableRange:!0,enableLLSMinCircle:!0,enableLocalNetworkShare:!1,enableMultiArea:!0,LNSRttThreshold:40,bucketCount:6,clearBucketInterval:6e4,enableExtraPCCnt:0,bbsP2PReqTimeout:1e4,bbsP2PMaxRetry:3,enableLRS:!1,lrsMaxPCConnected:4,lrsMaxPCConnecting:1,lrsServeResCnt:4,enableStoreRes:!1,maxStoreResCnt:3,enableStoreTinyRes:!1,enableStoreAllTinyRes:!0,tinyResMaxDuration:120,resModBase:1,newResEvictProWindow:864e5,coldResEvictThreshold:1728e5,maxIndexeddbStoreSize:524288e3,maxStorageAvailableRatio:.9,enableValidateTS:!1,metaServerUrl:"https://meta.qvb.qcloud.com/api/v3/info",metaRetryDelay:9e4,p2pStartDelay:15e3,enableCDNDetailReport:!1,p2pLimit:20,cdnBWRatio:.9,cdnCostRatio:.5,liveMaxBuffer:16,vodMaxBuffer:30,p2pEstimateExtra:1e3,checkBufferInterval:1e3,p2pSliceRequestCount:2,peerConnWaInitSendBytes:0,peerConnWaInitReceiveBytes:0,PCCheckAliveInterval:1e3,PCHeartTimeout:1e4,initConnTimeout:1e4,fixPCConflict:!1,trackerInterval:16e3,liveTrackerVersion:"v4",liveModel:"",vodTrackerVersion:"v2",bufferedAmountLimit:209715200,preloadProbability:.2,cdnNodeRatio:.02,confBaseUrl:"https://conf.qvb.qcloud.com/api/v1/vod/h5/",sourceUrl:"",liveDelayPreset:0,enableAegis:!1,service:1,platform:39,moduleId:1080,command:81e4,reportInterval:6e4,domain:"",cloudAppId:0,xp2pAppId:"",aegisId:""}}var a=i();function o(){Object.keys(a).forEach((e=>{delete a[e]})),Object.assign(a,i())}o();const l=a;var h=r(43),c=r.n(h);function u(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return d(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return d(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,s=function(){};return{s,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,o=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){o=!0,i=e},f:function(){try{a||null==r.return||r.return()}finally{if(o)throw i}}}}function d(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}class p extends Error{constructor(e){super(`[HLSP2P] [å­—æ®µæ£€æŸ¥é”™è¯¯] ${e}`),c().error(this.message)}}var f=(e,t)=>{var r,n=u(t);try{for(n.s();!(r=n.n()).done;){var s=r.value;if(!(s in e))throw new p(`${s} æœªä¼ å…¥`)}}catch(e){n.e(e)}finally{n.f()}},g=(e,t)=>{var r,n=u(t);try{for(n.s();!(r=n.n()).done;){var s=r.value;if(s in e&&!e[s])throw new p(`å­—æ®µä¸ºç©º ${s}`)}}catch(e){n.e(e)}finally{n.f()}},v=[{name:"checkVideoType",matchRule:()=>!0,check(e){var t=["videoType"];if(f(e,t),g(e,t),-1===["LIVE","VOD"].indexOf(e.videoType))throw new p("å­—æ®µå–å€¼ä¸å¯¹ videoTypeå–å€¼ä¸ºLIVE / VOD")}},{name:"checkChannelId",matchRule:()=>!0,check(e){var t=["channelId"];f(e,t),g(e,t)}},{name:"checkPlayConfig",matchRule:()=>!0,check(e,t){va(t,r),g(t,r)}},{name:"checkLiveServiceId",matchRule:e=>"LIVE"===e.videoType,check(e,t){varmain","xp2pAppId"];g(t,r),f(t,r)}}toString(16).match(/(.*?)(.{0,8})$/);if(null===e)return;const t=parseInt(e[2],16),r=parseInt(e[1],16)||0;n[14]=t,n[15]=r}return m._md5cycle(this._state,n),e?this._state:m._hex(this._state)}}if(m.stateIdentity=new Int32Array([1732584193,-271733879,-1732584194,271733878]),m.buffer32Identity=new Int32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),m.hexChars="0123456789abcdef",m.hexOut=[],m.onePassHasher=new m,"5d41402abc4b2a76b9719d911017c592"!==m.hashStr("hello"))throw new Error("Md5 self test failed.");function _(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{channelIdIncludeHost:!1,channelIdIncludeSearch:!1},r=t.channelIdIncludeHost,n=t.channelIdIncludeSearch;if(!e)return null;var s=new URL(e),i="";return r&&(i+=s.host),i+=s.pathname,n&&(i+=s.search),m.hashStr(i)}class y{constructor(e){this.TAG="ConfigParser",this.userConfig=e;var t=e.url,r=e.videoType;l.originalUrl=t,l.videoTypehannelIdIncludeSearch,i=e.channelId||_(t,{channelIdIncludeHost:n,channelIdIncludeSearch:s});e.channelId=i,e){((e,t)=>{for(var r=0,n=v;r<n.length;r++){var s=n[r];s.matchRule(e,t)&&s.check(e,t)}})(l,e)}static merge(e){Object.assign(l,e)}process(){y.check(this.userConfig),y.merge(this.userConfig)}}const b=y;var w={ERROR:"error",LEVEL_LOADED:"hlsLevelLoaded",SIGNAL_SENDING:"signalSending",SIGNAL_RECEIVING:"signalReceiving",SIGNAL_DISPATCHING:"signalDispatching",SIGNAL_READY:"signalReady",HlsManifestParsed:"hlsManifestParsed",TRACKER_LOADED:"trackerLoader",TRACKER_STARTING:"trackerStarting",TRACKER_LOADING:"trackerLoading",PEER_REMOVED:"peerRemoved",PEER_CONNECTED:"peerConnected",FRAG_LOADED:"10001",FRAG_LOADED_P2P:"10002",REPORT_START:"reportStart",REPORT_LOADED:"reportLoaded",REPORT_LOADING:"reportLoading",CONF_STARTING:"confStaring",CONF_LOADING:"confLoading",CONF_LOADED:"confLoaded",CONF_PARSED:"confParsed",ABNORMAL_REPORT:"abnormalRequest",NOR_REPORT_START:"norReportStart",FRAGMENT_UPDATED:"fragmentUpdated",LOCK_RESP:"lockRes",LOCK_TO_PEER:"lockToPeer",P2P_FRAG_REQ:"p2pFragReq",RTT_GOT:"rtt_got",PEER_FILTER_PASSED:"peerFilterPassed",REQUEST:"beforeCdnRequest",BEFORE_M3U8_REQUEST:"beforeM3u8Request"};const R=w;var T=w,C=r(945);const S=class{constructor(){this.sn=0,this.level=0,this.uri="",this.baseUrl="",this.duration=0}get url(){return this._url||(this._url=(0,C.buildAbsoluteURL)(this.baseUrl,this.uri,{alwaysNormalize:!0})),this._url}get originalUrl(){return this.uri}};class I{static GetResTemplate(){return{url:"",data:"",statusText:"",dataLen:0,timeRequestPerformance:0,timeRequest:0,TTFBPerformance:0,TTFB:0,timeLoadedPerformance:0,timeLoaded:0,retry:0,httpCode:0,responseURL:"",responseType:"",aborted:!1,__type:"CDN",config:{}}}static GetRequestConfig(){return{timeout:0,maxRetry:0,retryDelay:0,maxRetryDelay:0,url:"",responseType:"",headers:{},useFetch:!1,useRange:!1,range:{start:0,end:0}}}}var k={SUCCESS:1,ERROR:2,TIMEOUT:3,PROGRESS:4,STATUS_CODE:5};const E=class{constructor(e,t,r){this.id="",this.url="",this.sequenceNumber=0,this.level=0,this.loaderConfig=I.GetRequestConfig(),this.parseConfig(e,t,r)}parseConfig(e,t,r){this.url=e.url;var n=e.frag;this.sequenceNumber=n.sn,this.level=n.level,this.id=e.id||`${this.sequenceNumber}-${tnseType,Object.assign(this.loaderConfig,t)}genRequestLoaderConfig(){return this.loaderConfig}};consreqMap=new Map,this._respMap=new Map}init(){this.reset()}destroy(){this.reset()}reset(){this._reqMap.clear(),this._respMap.clear()}addReq(e,t,return this._reqMap.get(e)}getResp(e){return this._respMap.get(e)}has(e){return this._reqMap.has(e)}getRespMap(){return this._respMap}delete(e){this._reqMap.delete(e),this._respMap.delete(e)}size(){return this._reqMap.size}};var x={curReqSn:void 0,curReqLeveld 0,exitReason:void 0,hlsp2p:void 0,cdnEstimate:void 0,p2pEstimate:void 0,curPlayerAdapter:void 0,targetDuration:0,totalDuration:0},L={};function A(){Object.keys(L).forEach((e=>{delete L[e]})),Object.assign(L,x)}A();const D=L;const M=new clasthis.map=new Map,this.curTaskId=null,this.p2pReqRef=0,this.p2pTimers=new Set}init(){this.reset()}destroy(){this.reset()}has(e){return this.map.has(e)}abort(e){var t=this.get(e);t&&t.abort()}add(e,t){this.map.set(e,t);var r=D.p2pEstimate.estimateTimeNeeded(`${e}-0`);if(r>1e4&&(r=0),r){this.p2pReqRef+=1;var n=setTimeout((()=>{this.p2pReqRef-=1,this.p2pTimers.delete(n),this.tick()}),r+l.p2pEstimateExtra)}this.tick()}tick(){this.curTaskId||(this.curTaskId=this.pickNextTask(),this.curTaskId&&this.map.get(this.curTaskId).load())}pickNextTask(){var e=null;if(0!==thisar t=[...this.map.keys()];return t.length&&(e=t[0]),e}get(e){return this.map.get(e)}reset(){this.map.forEach((e=>{e.destroy()})),this.map.clear(),this.p2pTimers.forEach((e=>{clearTimeout(e)})),this.p2pTimers.clear(),this.p2pReqRef=0,this.curTaskId=null}delete(e){var t=this.map.get(e);t&&(t.destroy(),this.map.delete(e)),e===this.curTaskId&&(this.curTaskId=null),D.p2pEstimate&&D.p2pEstimate.delete(`${e}-0`),this.tick()}size(){return this.map.size}};const O=class{constructor(e,t,r){this.TAG="XHRLoader",this.context={url:e.url,method:e.method||"GET",async:e.async||!0,responseType:e.responseType||"text",postData:e.postData||"",headers:e.headers||[]},r.timeRequestPerformance=perfcontext,s=n.url,i=n.method,a=n.async,o=n.responseType,l=n.postData,h=n.headers,c=new XMLHttpRequest;this.loader=c,c.open(i,s,a),h.length&&h.forEach((e=>{c.setRequestHeader(e.header,e.value)})),c.responseType=o,c.onreadystatechange=this.readyStateChange.bind(this),"POST"===i&&l?c.send(l):c.send(),this.response=r,this.response.responseType=o}readyStateChange(e){var t=e.currentTarget,r=this.response,n=t.readyState;if(!r.aborted&&n>=2&&(0===r.TTFBPerformance&&(r.TTFBPerformance=performance.now()),4===n)){var s=t.status;r.httpCode=s,s>=200&&s<300?(r.responseURL=t.responseURL,r.timeLoadedPerformance=performance.now(),"arraybuffer"===this.context.responseType?(r.data=t.response,r.dataLen=r.data.byteLength):(r.data=t.responseText,r.dataLen=r.data.length),this.callbacks.onSuccess(r)):(r.statusText=t.statusText,this.callbacks.onError(r))}}abort(){var e=this.loader;e&&4!==e.readyState&&(this.response.aborted=!0,e.abort(),this.loader=null)}};class q{constructor(e,t,r){this.TAG="FetchStreamLoader",this.config=e,this.callbacks=t,this.response=r,this._abort=!1,this._abortController=null,this._loadedBytelength=0,this._buffers=[],this._done=!1,this._counter=0,this._open(e.urlt(){this._abort||(this._done||(this.response.aborted=!0),this._abort=!0,this._abortController&&this._abortController.abort(),this._readerInstance&&(this._readerInstance.cancel().catch((e=>{})),this._readerInstance=null),this.callbacks={onStatus:()=>{},onError:()=>{},onSuccess:()=>{},onProgress:()=>{}},this._buffers=[])}_open(e){if(!this._readerInstance){var t=this.response;t.timeRequestPerformance=performance.now(),t.responseType=this.config.responseType;var r={method:"GET",mode:"cors",referrerPolicy:"no-referrer-when-downgrade",headers:this.config.headers};self.AbortController&&(this._abortController=new self.AbortController,r.signal=this._abortController.signal),self.fetch(e,r).then((e=>{this._abort||(this.response.httpCode=e.status,this.response.statusText=e.statusText,this.callbacks.onStatus({statusCode:e.status,config:this.config}),e.ok&&e.status>=200&&e.status<=209?(this._readerInstance=e.body.getReader(),this._pump(this._readerInstance),this.response.responseURL=e.url,this.response.TTFBPerformance=performance.now()):404===e.status&&this.callbacks.onError(this.response))})).catch((e=>{this._abort||(this.response.statusText=e.message,this.callbacks.onError(this.response))}))}}_pump(e){this._abort||e.read().then((t=>{var r=t.done,n=t.value;this._abort||(r?this._done||(this._done=!0,this.response.timeLoadedPerformance=performance.now(),this.response.dataLen=this._loadedBytelength,this.response.data=q.combine(this._buffers,this._loadedBytelength),this.callbacks.onSuccess(this.response)):(this._loadedBytelength+=n.byteLength,this._buffers.push(n.slice()),this.callbacks.onProgress({value:n,cnt:this._counter}),this._counter>{this._abort||(this.response.statusText=e.message,this.callbacks.onError(this.response))}))}static combine(e,t){var r=new Uint8Array(t),n=0;return e.forEach((e=>{r.set(e,n),n+=e.byteLength})),r.buffer}}var U=(e,t)=>{return`[${r=new Date,n=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return`${e}`.padStart(t,"0")},`${r.getFullYear()}-${n(r.getMonth()+1)}-${n(r.getDate())} ${n(r.getHours())}:${n(r.getMinutes())}:${n(r.getSeconds())}.${n(r.getMilliseconds(),3)}`}] [${e}] [${t}]`;var r,n},B="trace",N="log",F="info",]:4};class G{constructor(){this._enable=!1,this._config=null,this._nextLoj]}configure(e){return this._config=e,this}destroy(){this.disable(),this._nextLogger=null}setLevel(e){return e&&(this._logLevel=H[e]),this}enable(){this._enable=!0}disable(){this._enable=!1}setNext(e){this._nextLogger=e}trace(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];if(this._enable&&H[B]>=this._logLevel){var n=`${U(this._config.logPrefix,"TRC")}${[...t].join(" ")}`;this.traceCb(n)}this._nextLogger&&this._nextLogger.trace(...t)}log(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];if(this._enable&&H[N]>=this._logLevel){var n=`${U(this._config.logPrefix,"LOG")}${[...t].join(" ")}`;this.logCb(n)}this._nextLogger&&this._nextLogger.log(...t)}info(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];if(this._enable&&H[F]>=this._logLevel){var n=`${U(this._config.logPrefix,"INF")}${[...t].join(" ")}`;this.infoCb(n)}this._nextLogger&&this._nextLogger.info(...t)}warn(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];if(this._enable&&H[$]>=this._logLevel){var n=`${U(this._config.logPrefix,"WRN")}${[...t].join(" ")}`;this.warnCb(n)}this._nextLogger&&this._nextLogger.warn(...t)}error(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];if(this._enable&&H[j]>=this._logLevel){var n=`${U(this._config.logPrefix,"ERR")}${[...t].join(" "er&&this._neogCb(e){self.console.log(e)}infoCb(e){self.console.info(e)}warnCb(e){self.console.warn(e)}errorCs z{constructor(e,t){this.level=e,this.message=t}}var W=new class extends G{init(e){return this.hlsp2p=e,this.configure({logPrefix:"HLSP2P"}),this}destroy(){super.destroy(),this.hlsp2p=null}logCb(e){this.hlsp2p.trigger(V,new z(N,e))}infoCb(e){this.hlsp2p.trigger(V,new z(N,e))}warnCb(e){this.hlsp2p.trigger(V,new z(N,e))}errorCb(e){this.hlsp2p.trigger(V,new z(N,e))}};const X=W;const K=class{constructor(e,t,r){this.TAG="RequestLoader",this.id=e,thithis.timeout=t.ti16e3,this.retryTim.response.config=t,this.response.url=this.config.url}load(){this._load()}destroy(){this.cb=()=>{},this.abort()}abort(){clearTimeout(this.timeoutTimer),this.xhrLoader&&this.xhrLoader.abort()}_load(){var e=`[http] å¼€å§‹è¯·æ±‚ ${this.id} ${this.config.url}`;this.config.useRange&&(e+=` useRange, rangeHeader: ${this.config.headers.Range}`),X.info(e);var t=O;this.config.useFetch&&(t=q),this.xhrLoader=new t(this.config,{onStatus:this._status.bind(this),onSuccess:this._success.bind(this),onError:this._error.bind(this),onProgress:this._progress.bind(this)},this.response),this.timeoutTimer=setTimeout(this._timeout.bind(this),this.timeout)}_retry(){return this._retryCounter<this.retryTimes&&(this._retryCounter+=1,X.info(`[http] è¯·æ±‚é‡è¯• ${this.id} ${this.config.url}, é‡è¯•æ¬¡æ•° ${this._retryCounter}`),this.xhrLoader.abort(),this._load(),!0)}_status(e){this.cb(this.id,k.STATUS_CODE,e)}_timeout(){var e=(this.response.timeLoadedPerformance-this.response.timeRequestPerformance).toFixed(3),t=(this.response.TTFBPerformance-this.response.timeRequestPerformance).toFixed(3);X.error(`[http] è¯·æ±‚è¶…æ—¶ ${this.id} ${this.config.url} æ€»è€—æ—¶: ${e} ms, é¦–å­—èŠ‚è€—æ—¶: ${t} ms,`),this.xhrLoader.abort(),this._retry()||(this.response.retry=this._retryCounter,this.cb(this.id,k.TIMEOUT,this.response))}_error(){X.error(`[http] è¯·æ±‚å¤±è´¥ ${this.id} ${this.config.url}. statusCode: ${this.response.httpCode}, statusText: ${this.response.statusText}`),this._retry()||(clearTimeout(this.timeoutTimer),this.response.retry=this._retryCounter,this.cb(this.id,k.ERROR,this.response))}_success(){var e=(this.response.timeLoadedPerformance-this.response.timeRequestPerformance).toFixed(3),t=(this.response.TTFBPerformance-this.response.timeRequestPerformance).toF .value}catch(e){return void r(e)}o.done?t(l):Promise.resolve(l).then(n,s)}function J(e){return function(){var t=this,r=arguments;return new Promise((function(n,s){var i=e.apply(t,r);function a(e){Y(i,n,s,a,o,"next",e)}function o(e){Y(i,n,s,a,o,"throw",e)}a(void 0)}))}}var Q=r(687),Z=r.n(Q);const ee={BITMAP:1,SLICE:2,PACKET:3,PING:4,PONG:41,BUFFER_INFO:5,SLICE_REQUEST:6,LOCK_REQ:7,LOCK_RES:8,RTT_REQ:9,RTT_RES:10,P2P_REQ_CHUNK:11,P2P_RES_ERR:12,P2P_RES_CHUNK:13,P2P_REQ_CANCEL:14,P2P_RES_PARENT:15,P2P_REQ_ACCEPT:16,NODE_SYNC:17,P2P_UPWARD:18,SYNC_INFO:19};const te=class{constructor(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.hasHeader=e,this.segments=[],this.data=null,this.totalLen=0,this.uri=0,this.hasHeader&&(this.pushUInt32(10),this.pushUInt32(this.uri),this.pushUInt(0===this.segments.length)return null;this.data=new Uint8Array(thisents.forEach((t=>{this.data.set(t,e),e+=t.length})),this.hasHeader&&(this.replaceUInt32(0,this.totalLen),this.replaceUInt32(4,this.uri)),this.data}setUri(e){this.uri=e}replaceUInt32(e,t){new DataView(this.data.buffer).setUint32(e,t,!0)}pushBool(e){this.pushUInt8(e?1:0)}pushUInt8(e){var t=new Uint8Array(1);new DataView(t.buffer).setUint8(0,e),this.segments.push(t),this.totalLen+=1}pushUInt16(e){var t=new Uint8Array(2);new DataView(t.buffer).setUint16(0,e,!0),this.segments.push(t),this.totalLen+=2}pushUInt32(e){var t=new Uint8Array(4);new DataView(t.buffer).setUint32(0,e,!0),this.segments.push(t),this.totalL94967296,s=e/4294967296>>0;r.setUint32(0,n,!0),r.setUint32(4,s,!0),this.segments.push(t),this.totalLen+=8}pushUint8Array(e){this.pushUInt16(e.length),this.segments.push(e),this.totalLen+=e.length}pushUint8ArrayWithoutLen(e){this.selLen+=e.length}pushUint8Array32(e){this.pushUInt32(e.length),this.segments.push(e),this.totalLen+=e.length}pushUInt32Vector(e){this.pushUInt32(e.length),e.forEach((e=>{this.pushUInt32(e)}))}pushUInt16Vector(e){this.pushUInt32(e.length),e.forEach((e=>{this.pushUInt16(e)}))}pushString(e){var t=e.length;this.pushUInt16(t);for(var r=new Uint8Array(t),n=new DataView(r.buffer),s=0;s<t;s++)n.setUint8(s,e.charCodeAt(s));this.segments.push(r),this.totalLen+=t}pushString32(e){var t=e.length;this.pushUInt32(t);for(var r=new Uint8Array(t),n=new DataView(r.buffer),s=0;s<t;s++)n.setUint8(s,e.charCodeAt(s));this.segments.push(r),this.totalLen+=t}};var re=1,ne=2;const se=class{constructor(){this.uri=ee.PACKET,this.sn=0,this.level=0,this.sliceIndex=0,this.packetIndex=0,this.p2pStorageType=re,this.totalPacket=0,this.payloadLength=0,this.uint8ArrayPayload=0}marshall(){var e=new te;return e.setUri(this,e.marshall()}unmarshall(e){this.sn=e.popUInt32(),this.level=e.popUInt8(),this.sliceIndex=e.popUInt8(),this.packetIndex=e.popUInt8(),this.p2pStorageType=e.popUInt8(),this.totalPacket=e.popUInt8(),this.payloadLength=e.popUInt32(),this.uint8ArrayPayload=e.popUint8Array()}};const ie=class{constructor(e,t,r,n){this.sn=e,this.level=t,this.id="",this.index=r,this.arrayBufferData=n,this.dataByteLength=n?n.byteLength:0,this.uri=ee.SLICE,this.packetAmount=-1,this.packetArray=[],this.receivedPacketCount=0,this.reveivedPacketBytes=0,this.combineCallback=void 0,this.calledCallback=!1,this.createTime=Date.now(),this.p2pStoragTypeFlag=re}addPacket(e){if(!this.calledCallback){var t=e.uint8ArrayPayload.length,r=e.packetIndex;this.packetArray[r]||t!==e.payloadLength||(this.packetArray[r]=e,this.receivedPacketCount+=1,this.reveivedPacketBytes+=t),e.p2pStorageType&&(this.p2pStoragTypeFlag=e.p2pStorageType),this._ensureReceiveAllPacket()&&this._combinePacketToSlice()}}_ensureReceiveAllPacket(){if(this.packetAmount>this.receivedPacketCount)return!1;for(var e=0;e<this.packetAmount;e++)if(!this.packetArray[e])return!1;return!0}_combinePacketToSlice(){var e=new Uint8Array(this.reveivedPacketBytes),t=0;this.packetArray.forEach((r=>{e.set(r.uint8ArrayPayload,t),t+=r.payloadLength})),this.packetArray=[],this.arrayBufferData=e.buffer,this.dataByteLength=this.reveivedPacketBytes,this.calledCallback=!0,this.combineCallback(this.id)}segmentSliceToPacket(){for(var e=[],t=l.DCChunkSize,r=Math.ceil(this.dataByteLength/t),n=this.dataByteLength,s=this.arrayBufferData,i=0;i<r;i+=1){var a=i*t,o=n-i*t>t?(iis.p2pStoragTypeFlag,c.sn=this.sn,c.level=this.level,c.sliceIndex=this.index,c.packetIndex=i,c.totalPacket=r,c.uint8ArrayPayload=new Uint8Array(h),c.payloadLength=c.uint8ArrayPayload.length,e.push(c.marshall())}retupe(){return this.p2pStoragTypeFlag}};const ae=class{constructor(){this.sn=0,this.level=0,this.uri=ee.BUFFER_INFO,this.subIndexes=[]}marshall(e){e.pushUInt32(this.sn),e.pushUInt8(this.level),e.pushUInt8(this.subIndexes.length),this.subIndexes.forEach((t=>{e.pushUInt8(t)}))}unmarshall(e){this.sn=e.popUInt32(),this.level=e.popUInt8();for(var t=e.popUInt8(),r=0;r<t;r+=1){var n=e.popUInt8();this.subIndexes.push(n)}}};const oe=class{constructor(e,t){this.TAG="ProtoBuffer",this.id=e,this.sn=parseInt(e.split("-")[0],10),this.level=parseInt(e.split("-")[1],10),this.dataLen=0,this.avgLen=0,this.sliceCount=t,this.slicesMap=new Map,this.downloadFrom="cdn"}destroy(){this.slicesMap=null}setArrayBufferData(e){this.dataLen=e.byteLength,this.avgLen=Math.floor(this.dataLen/this.sliceCount);for(var t=this.sliceCount-1,r=0;r<t;r+=1){var n=e.slice(r*this.avgLen,(r+1)*this.avgLen),s=new ie(this.sn,this.level,r,ns.avgLen,o=e.slice(a),l=new ie(this.sn,this.level,i,o);this.slicesMap.set(i,l)}setSlice(e,t){this.slicesMap.get(e)||(this.dataLen+=t.dataByteLength,this.slicesMap.set(e,t))}getSlice(e){return this.slicesMap.get(e)}complete(){return this.slicesMap.size===this.sliceCount}arrayBuffer(){if(this.complete()){this.avgLen=Math.floor(r e=new Uint8Array(this.dataLen);return this.slicesMap.forEach((t=>{e.set(new Uint8Array(t.arrayBufferData),t.index*this.avgLen)})),e.buffer}return!1}bufferInfo(){var e=new ae;return e.sn=this.sn,e.level=this.level,this.slicesMap.forEach((t=>{e.subIndexes.push(t.index)})),e}getP2PStorageType(){if(this.slicesMap.size){var e=this.slicesMap.get(0);if(e)return e.getP2PStorageType()}}};const le=class{constructor(){this.TAG="BaseModule",this.registerEvents=""}destroy(){throw Error("éœ€è¦å®žçŽ°")}init(){throw Error("éœ€è¦å®žçŽ°")}};var he="connected",ce="conn_try",ue="conn_try_total",de="conn_suc",pe="conn_suc_total",fe="conn_reject",ge="conn_reject_total",ve="conn_kick",me="conn_dc_err",_e="conn_dc_open_cnt",ye="conn_dc_closed",be="conn_init_timeout",we="conn_htbt_timeout",Re="conn_conflict_ignore",Te="conn_conflict_reset",Ce="peer_rtt",Se="request",Ie="loadok_t",ke="confok_t",Ee="stuck_count",Pe="cdn_bytes",xe="p2p_bytes",Le="lrs_p2p_bytes",Ae="p2p_recv_bytes",De="exit_reason",Me="play_started",Oe="play_time",qe="session_time",Ue="ts_cdn_info",Be="played_bytes",Ne="p2p_upload_bytes",Fe="p2p_download_bytes",$e="bitrate_change",je="bitrate",He="buffer_length",Ge="range_ok",Ve="paused",ze="cdn_domain",We="req_level_0",Xe="req_level_1",Ke="req_level_2",Ye="req_level_3",Je="req_level_4",Qe="cdn_cost_ms",Ze="p2p_first_ms",et="p2p_costs",tt="p2p_req_costs",rt="p2p_first_recv_depth",nt="p2p_timeout_depth",st="p2p_first_timeout_cnt",it="p2p_dwn_timeout_cnt",at="cdn_cost_avg",ot="player_req_cnt",lt="p2p_pre_cnt",ht="pre_req_cnt",ct="abort_pre_cnt",ut="cancel_pre_cnt",dt="cdn_req_cnt",pt="hit_p2p_cnt",ft="hit_cdn_cnt",gt="cdn_succ_cnt",vt="cdn_timeout_cnt",mt="cdn_err_cnt",_t="cdn_range_cnt",yt="cdn_range_bytes",bt="parent_c",wt="children_c",Rt="subscribe_request_c",Tt="subscribe_timeout_c",Ct="subscribe_success_c",St="subscribe_failure_c",It="nop2p_peer",kt="p2p_sub_cnt",Et="drop_peer_by_cycle",Pt="drop_peer_by_blacklist",xt="drop_peer_by_bitrate",Lt="subscribe_range_c",At="p2p_retry_cnt",Dt="p2p_retry_miss_cnt",Mt="p2p_retry_by_disconnect",Ot="p2p_retry_by_circle",qt="p2p_retry_by_refuse",Ut="refused_by_cycle",Bt="refused_by_diff_bitrate",Nt="refused_by_full_load",Ft="refused_by_too_depth",$t="refused_by_sn_range",jt="back_cdn_peer_disconn",Ht="back_cdn_res_circle",Gt="back_cdn_depth_limit",Vt="back_cdn_req_refused",zt="back_cdn_upward",Wt="back_cdn_req_total",Xt="back_cdn_low_buffer",Kt="lls_trigger_upward",Yt="ignore_cdn_has_buffer",Jt="ignore_cdn_small_sn",Qt="ignore_cdn_miss_level",Zt="back_cdn_req_exist",er="back_cdn_make_req",tr="send_parent_total",rr="send_parent_new_child",nr="send_parent_accept",sr="send_parent_pass",ir="send_parent_reset",ar="player_req_delay",or="player_req_low_buffer",lr="ws_state",hr="duplicate_bytes",cr="lr_upload_bytes",ur="total_play_cnt",dr="total_duration",pr="frag_cnt",fr="meta_req",gr="meta_404",vr="meta_403",mr="meta_succ",_r="meta_err",yr="meta_cost",br="verify_total",wr="verify_p2p_fail",Rr="verify_p2p_not_ready",Tr="verify_cdn_fail",Cr="validate_enable",Sr="sw_reg",Ir="sw_reg_succ",kr="sw_reg_fail",Er="sw_recv_req",Pr="sw_resp_ok",xr="sw_resp_err",Lr="sw_resp_timeout",Ar="sw_resp_403",Dr="sw_recv_m3u8",Mr="sw_recv_m3u8_403",Or="sw_recv_m3u8_total",qr="sw_enable",Ur="sw_version",Br="sw_buildtime",Nr="sw_commit";const Fr=class{static encrypt(e){for(var t=new ArrayBuffer(e.length),r=new Uint8Array(t),n=[99,117,105],s=0;s<e.length;s+=1)r[s]=e.codePointAt(s)^n[s%n.length];ret05],n=0;n<e.length;n+=1){var s=e[n].codePointAt(0)^r[n%r.length];t+=String.fromCodePoint(s)}return JSON.parse(t)}};const $r=class{constructor(){this._list=new Map}init(){th{e.destroy()})),this._list.clear()}};var jr=new class{constructor(){this.TAG="ReportLoader",this.reportCount=null,this._loaderManager=new $r}init(e){this.hlsp2p=e,this.reportCount=0,this._loaderManager.init()}destroy(){this.hlsp2p=null,this.reportCount=0,this._loaderManager.destroy()}onReportLoading(e){var t=e.data,r=e.lastReport,n=Fr.encrypt(JSON.stringify(t));if(r)navigator&&navigator.sendBeacon&&navigator.sendBeacon(l.reportServer,n);else{var s=`report-${this.reportCount}`,i=I.GetRequestConfig();i.method="POST",i.url=l.reportServer,i.postData=n;var a=new K(s,i,this.receiveResp.bind(this));this._loaderManager.add(s,a),a.load()}}receiveResp(e,t,r){t===k.SUCCESS&&this.hlsp2p.trigger(R.REPORT_LOADED,{Data:r.data}),this._loaderManager.delete(e)}};const Hr=jr;var Gr=r(238);const Vr=class{static getLogTime(){var e=new Date;return`${e.getHours()}:${e.getMinutes()}:${e.getSeconds()}.${e.getMilliseconds()}`}static timestamp(){return Date.now()}};var zr="1.6.37",Wr={};class Xr{static supportLocalStorage(){try{return self.localStorage&&(self.localStorage.seupportLocalStorage()?self.localStorage.getItem(e):Wr[e]}static setItem(e,t){if(Xr.supportLocalStorage())return self.localStorage.setItem(e,t);Wr[e]=t}}var Kr=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),Yr=()=>{var e=Xr.getItem("myUUID");return e&&36===e.length||(e=Kr(),Xr.setItem("myUUID",e)),e},Jr=()=>{var e;try{e=new Gr.UAParser(navigator.userAgent).getResult()}catch(e){}return{service:l.service,platform:l.platform,appid:l.cloudAppId,stream_id:"",module_id:l.moduleId,command:l.command,data_time:Math.round(Vr.timestamp()/1e3),version:zr,build_time:"2023-10-19T03:35:03.746Z",commit_id:"7696c4e",video_type:"",data_type:2,channel:"",partner:"",code:"000",str_video_type:"",src_type:"auto",host:self.location.host,life:Math.round(Vr.timestamp()-l.startTime),url:"",referer:self.location.href,user_agent:self.navigator.userAgent,str_user_id:Yr(),str_play_id:l.randomPlayId,r_name:e&&e.browser.name||"",browser_version:e&&e.browser.version||"",browser_major:e&&e.browser.major||"",device_vendor:e&&e.device.vendor||"",device_type:e&&e.device.type||"",i:{}}},Qr="destroy",Zr="close";var en=new class{constructor(){this.TAG="ReportController",this._callbacks=[]}init(e){this.hlsp2p=e,Hr.init(e),this.hlsp2p.on(R.NOR_REPORT_START,this._norReportStart.bind(this)),this.onCollectReport=this._collectReport.bind(this),self.addEventListener("beforeunload",this.beforeUnload.bind(this))}registerModule(e,t){this._callbacks.push(t)}destroy(){this._timer&&(clearInterval(this._timer),this._timer=null);var e=D.exitReason||Qr;this._collectReport({[De]:e},!0),Hr.destroy(),this._callbacks=[],this.hlsp2p=null}beforeUnload(){this._collectReport({[De]:Zr},!0)}_collectReport(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this.template;this._callbacks.forEach((e=>{var n=e({lastReport:t});n&&Object.assign(r.i,n)})),e&&Object.assign(r.i,e),t&&(r.i[Oe]=Date.now()-l.loadTime),Hr.onReportLoading({data:r,lastReport:t})}_norReportStart(){this._timer=setInterval(this._collectReport.bind(this),l.reportInterval)}get template(){var e=Jr();return e.stream_id=l.channelId,e.channel=l.channe"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?rn(e,t):void 0}}(e,t)||function(){throw new Ty a [Symbol.iterator]() method.")}()}class sn{static fromId(e){var t=nn(e.split("-"),2),r=t[0],n=t[1];return new sn({sn:parseInt(r,10),level:parseIctor(e){var t=e.sn,r=e.level;this.sn=t,this.level=r}toStringId(){return`${this.sn}-${this.level}`}}class an{constructor(){this._cdnBytesTotal=0,this._p2pBytesTotal=0,this._cdnBytes=0,this._p2pBytes=0}reset(){this._cdnBytesTotal=0,this._p2pBytesTotal=0,this._cdnBytes=0,this._p2pBytes=0}addCdnBytes(e){this._cdnBytes+=e,this._cdnBytesTotal+=e}addP2PBytes(e){this._p2pBytes+=e,this._p2pBytesTotal+=e}getStats(){var e={cdnBytesTotal:this._cdnBytesTotal,p2pBytesTotal:this._p2pBytesTotal,cdnBytes:this._cdnBytes,p2pBytes:this._p2pBytes};return this._cdnBytes=0,this._p2pBytes=0,e}}var on=new class extends le{constructor(){super(),this.TAG="BufferController",this.map=new Map,this.stat=new an,this.TSInfoFromCDN=[],this._downloadBytes={},this._loadOkTime=0,this._llsDuplicateBytes=0,this._lrUploadBytes=0}setResStoreProxy(e){this._resStoreProxy=e}init(e){this.hlsp2p=e,this.receiveBufferHandler=this.onReceiveBuffer.bind(this),e.on(R.FRAG_LOADED,this.receiveBufferHandler),this.receiveChunkHandler=this.onReceiveChunk.bind(this),e.on("chunk_buffer_complete",this.receiveChunkHandler),this._downloadBytes.cdnBytes=0,this._downloadBytes.p2pBytes=0,this._downloadBytes.lrsP2PBytes=0,this._downloadBytes.p2pRecvBytes=0,this.stat.reset(),tn.registerModule(this.TAG,this.reportCallback.bind(this)),e.once(R.FRAG_LOADED,(()=>{this._loadOkTime=Date.now()-l.loadTime})),this.onKeepSize=this.keepSize.bind(this),this.keepSizeTimer=setInterval(this.onKeepSize,l.checkBufferInterval)}destroy(){this.reset(),this._clearTimer(),this.hlsp2p.off(R.FRAG_LOADED,this.receiveBufferHandler),this.hlsp2p=null}_clearTimer(){this.keepSizeTimer||(clearInterval(this.keepSizeTimer),this.keepSizeTimer=null)}has(e){var t=this.map.get(e);return!!t&&t.complete()}add(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"cdn";if(!this.has(e)){var n=new oe(e,l.sliceCount);if(n.downloadFrom=r,n.setArrayBufferData(t),this.map.set(e,n),this._resStoreProxy&&l.enableStochannelId,sn:s.sn,level:s.level,data:new Uint8Array(t)})}}}get(e){return this.map.get(e)}reset(){this.TSInfoFromCDN=[],this._downloadBytes={},this.map.forEach((e=>e.destroy())),this.map.clear()}size(){return this.map.size}delete(e){var t=this.get(e);t&&(t.destroy(),this.map.delete(e))}keepSize(){var e=this.size()-l.bufferCount;if(e>0)for(var t=[...this.map.keys()],r=0;r<e;r+=1){var n=t.shift();this.delete(n),this.hlsp2p.trigger("delete_buffer",{id:n})}}getBufferInfo(e){if(!Array.isArray(e))throw Error("bufferController.getSpecifiedBitmap å‚æ•°éœ€ä¸ºæ•°ç»„");var t=new Map;if(e.length)return e.forEach((e=>{var r=this.get(`${e.sn}-${e.level}`);r&&t.set(r.id,r.bufferInfo())})),[...t.values()];if(this.map.forEach((e=>{t.set(e.id,e.bufferInfo())})),this._resStoreProxy&&l.enableStoreRes){var r=this._resStoreProxy.getResMeta(l.channelId);r&&r.getAllMeta().forEach((e=>{var r=`${e.sn}-${e.level}`;if(!t.has(r)){var n=new ae;n.sn=e.sn,n.level=e.level,n.subIndexes=[0],t.set(r,n)}}))}return[...t.values()]}onReceiveSlice(e){var t=e.id.slice(0,e.id.lastIndexOf("-")),r=this.map.get(t);r&&r.complete()||(r||((r=new oe(t,l.sliceCount)).downloadFrom="p2p",this.map.set(t,r)),r.setSlice(e.index,e.slice),r.complete()&&(X.log(`${t} p2pä¸‹è½½å®Œæˆ, byteLength: ${r.dataLen}`),this._downloadBytes.p2pRecvBytes+=r.dataLen,this.hlsp2p.trigger(R.FRAG_LOADED_P2P,{id:t})))}getSlices(e,t,r){var n=this.map.get(`${e}-${t}`);return!!n&&n.getSlice(r)}getSlicesFromAllPlace(e,t){var r=this;return J(Z().mark((function n(){var s,i,a;return Z().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!(s=r.getSlices(e,t,0))){n.next=3;break}return n.abrupt("return",s);case 3:if(!r._resStoreProxy||!l.enableStoreRes){n.next=13;break}return n.next=6,r._resStoreProxy.get({resId:l.channelId,sn:e,level:t});case 6:if(!(i=n.sent)){n.next=13;break}return r._lrUploadBytes+=i.data.byteLength,(a=new ie(e,t,0,i.data.buffer)).p2pStoragTypeFlag=ne,n.abrupt("return",a);case 13:return n.abrupt("return",!1);case 14:case"end":return n.stop()}}),n)})))()}onReceiveBuffer(e){var t=e.id,r=e.binaryData,n=e.resp;this.recordResp(t,r,n),this._downloadBytes.cdnBytes+=r.byteLength,this.stat.addCdnBytes(r.byteLength),X.log(`${t} CDNä¸‹è½½tså®Œæˆ, byteLength: ${r.byteLength}`),this.add(t,r)}onReceiveChunk(e){var t=e.id,r=e.payload,n=e.stats,s=(n.p2pBytes,n.cdnBytes),i=n.duplicateBytes;if(this._downloadBytes.cdnBytes+=s,this.stat.addCdnBytes(s),!this.map.has(t)){var a=Math.max(r.byteLength-s,0);this._downloadBytes.p2pBytes+=a,this.stat.addP2PBytes(a);var o="mix";0===a?o="cdn":0===s&&(o="p2p"),this._llsDuplicateBytes+=i,this.add(t,r.buffer,o),this.hlsp2p.trigger("new_buffer",{id:t})}}genRespFromBuffer(e,t){var r=I.GetResTemplate(),n=this.get(e);if(!n)return!1;r.data=n.arrayBuffer(),r.responseType=t.responseType,r.httpCode=200,r.dataLen=r.data.byteLength,r.timeRequestPerformance=performance.now();var s=D.cdnEstimate.estimateTTFB()||100;r.TTFBPerformance=s+r.timeRequestPerformance;var i=D.cdnEstimate.estimateBandwidth(),a=i?r.dataLen/i:100;return r.timeLoadedPerformance=r.TTFBPerformance+a,r.responseURL=t.url,r.__type="INNER","p2p"!==n.downloadFrom||l.enableLLS||(this._downloadBytes.p2pBytes+=r.dataLen,n.getP2PStorageType()===ne&&(this._downloadBytes.lrsP2PBytes+=r.dataLen),this.stat.addP2PBytes(r.dataLen)),r}recordResp(e,t,r){if(!(this.TSInfoFromCDN.length>100)){var n,s;this.TSInfoFromCDN.push(`v1|${n=r.url,s=new URL(n).pathname.split("/"),s[s.length-1]}|${e}|${t.byteLength}`)}}reportCallback(){var e={};return this._downloadBytes&&(0!==this._downloadBytes.p2pBytes&&(e[xe]=this._downloadBytes.p2pBytes,this._downloadBytes.p2pBytes=0),0!==this._downloadBytes.cdnBytes&&(e[Pe]=this._downloadBytes.cdnBytes,this._downloadBytes.cdnBytes=0),0!==this._downloadBytes.lrsP2PBytes&&(e[Le]=this._downloadBytes.lrsP2PBytes,this._downloadBytes.lrsP2PBytes=0),this._downloadBytes.p2pRecvBytes&&(e[Ae]=this._downloadBytes.p2pRecvBytes,this._downloadBytes.p2pRecvBytes=0),this._llsDuplicateBytes&&(e[hr]=this._llsDuplicateBytes,this._llsDuplicateBytes=0)),this.TSInfoFromCDN.length>0&&(l.enableCDNDetailReport?e[Ue]=this.TSInfoFromCDN:delete e[Ue],this.TSInfoFromCDN=[]),this._loadOkTime&&(e[Ie]=this._loadOkTime,this._loadOkTime=0),this._lrUploadBytes&&(e[cr]=this._lrUploadBytes,this._lrUploadBytes=0),e}get downloadBytes(){return this._downloadBytes}};const ln=on;class hn extends(t()){constructor(){super(),this.TAG="VideoProxy",this._videoElement=null,this._listenEvent=["waiting","canplay","loadedmetadata","loadeddata","stalled","canplaythrouetVideoById(t)}destroy(){this._videoElement&&(this.releaseVideoElement(),this._videoElement=null),this.removeAllListeners()}setVideoByElemenhis._videoElement=e,this.attachVideoElement()}setVideoById(e){var t=document.getElementById(e);this.setVideoByElement(t)}attachVideoElement(){this._handler.forEach(((e,t)=>{this._videoElement.addEventListener(ach(((e,t)=>{this._videoElement.removeEventListener(t,e)})),this._handler.clear()}onWaiting(){this.emit("waiting")}onCanplay(){this.emit("canplay")}onLoadedmetadata(){this.emit("loadedmetadata")}onLoadeddata(){this.emit("loadeddata")}onStalled(){this.emit("stalled")}onCanplaythrough(){this.emit("canplaythrough")}get currentTime(){return this._videoElement.currentTime}set currentTime(e){this._videoElement.currentTime=e}get seeking(){ret_videoElement.ended}get video(){return this._videoElement}get buffered(){return this._videoElement.buffered}get bufferLength(){var e=this.buffered,t=0;if(e){var r=e.length;r&&(t=e.end(r-1)-cn.currentTime)}return t}get paused(){return this._videoElement.paused}set playbackRate(e){this._videoElement.playbackRate=e}get playbackRate(){return this._videoElement.playbackRate}get readyState(){return this._videoElement.readyState}static transEventToFunc(e){if(!e)throw new TypeError("Video-Proxy: param event must be a non-empty string");if(e.length<4)throw new Error("Video-Proxy:pperCase()}${e.slice(1)}`}_genHandler(){this._listenEvent.forEach((e=>{var t=hn.transEventToFunc(e);if(!this[t])throw new Error("Video-Proxy: no such function");this._handler.set(e,this[t].bind(tpn extends G{constructor(){super(),this.logs=[]}destroy(){super.destroy(),this.stop(),this.logs=[]}init(e){this._config=e,this.configure(e),this.stop(),this.logs=[]}setLevel(e}start(e){var t=e.reportInterval;this._reportInterval=t,this._startUpload()}stop(){this._clearTimer()}traceCb(e){this._cacheLog(e)}logCb(e){this._cacheLog(e)}infoCb(e){this._cacheLog(e)}warnCb(e){this._cacheLog(e)}errorCb(e){this._cacheLog(e)}_cacheLog(e){this.logs.push(e),this.logs.length>5e3&&this.logs.shift()}_startUpload(){this._reportInterval&&this._config&&(this._clearTimer(),this._uploadTimer=setInterval((()=>{if(this._enable&&this.logs.length){var e=`https://rtlog.qvb.qcloud.com/upload/p2p.log?uuid=${this._config.uuid}&version=${this._config.version}&platform=${this._config.platform}&type=data`;fetch(e,{method:"POST",body:this.logs.join("\r\n")}).catch((e=>{})),this.logs=[]}}),this._reportInterval))}_clearTimer(){this._uploadTimer&&(clearInterval(this._uploadTimer),this._uploadTimer=null)}}const fn=new pn;class gn{constructor(e,t){this.TAG="P2PRequestLoader",this.id=e,this.config=t,this.p2pReqTimeout=t.p2pReqTimeout||3e3,this.enableP2pAutoTimeout=t.enableP2pAutoTimeout||!1,this._aborted=!1,this._succed=!1}init(e,t){this.hlsp2p=e,this._reportData=t}setCDNRequestCallback(e){this.cdnReqCb=e}load(){this._load()}backToCDN(){clearTimeout(this.timeoutTimer),M.delete(this.id),this.cdnReqCb&&this.cdnReqCb()}destroy(){this._aborted||(this.cb=()=>{},this.abort(),this.hlsp2p=null,this._reportData=null)}abort(){this._aborted=!0,clearTimeout(this.timeoutTimer),this._succed||this.hlsp2p.subscriber.cancelChunkRequest(this.id)}_load(){var e=sn.fromId(this.id);this._reportData&&(this._reportData[kt]+=1);var t=this.p2pReqTimeout,r=this.p2pReqTimeout;if(this.enableP2pAutoTimeout&&D.targetDuration){var n=.1*D.targetDuration;if((r=1e3*Math.max(n,un.bufferLength-n))===1e3*n)return this._reportData&&(this._reportData[Xt]+=1),void this.backToCDN()}this.hlsp2p.subscriber.tryToMakeRequest({sn:e.sn,level:e.level,hop:0,url:this.config.url})&&(t=Math.min(r,t),this.actualP2PTimeout=t,this.timeoutTimer=setTimeout(this._timeout.bind(this),t))}_timeout(){this.hlsp2p.subscriber.cancelChunkRequest(this.id,{reason:"cdn_timeout"}),this._reportData&&(this._reportData[Tt]+=1),this.backToCDN()}}class vn{constructor(){this.trequest=performance.now(),this.retry=0,this.tfirst=0,this.loaded=0,this.tload=0,this.total=0,this.aborted=!1,this.retry=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:performance.now(),first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}const mn=class{constructor(e,t,r){this.TAG="ProtoTSResp",this.id="",this.inner=!1,this._context=e,this._callbacks=r,this._response={url:"",data:""},this._httpStatus={code:0,text:""},this._stats=new vn,this._delayHlsjsAbandonTimer=null}enableDelayHLSJSAbandonCheck(){this._delayHlsjsAbandonTimer||(this._delayHlsjsAbandonTimer=setInterval((()=>{this._st._stats.loading.start=performandonTimer&&(clearInterval(this._delayHlsjsAbandonTimer),this._delayHlsjsAbandonTimer=null)}update(e,t,r){this._context=e,this._callbacks=r,this.id=e.id||`${e.frag.sn}-${e.frag.level}`}set stats(e){return this._stats=e}get stats(){return this._stats}abort(){this._stats.aborted=!0,this.stopDelayHLSJSAbandonCheck()}setResponse(e){this._response.url=e.url,this._response.data=e.data}setStats(e){this._stats.trequest=e.timeRequestPerformance,this._stats.retry=e.retry,this._stats.aborted=e.aborted,this._stats.tfirst=Math.max(e.TTFBPerformance,this._stats.trequest),this._stats.loaded=e.dataLen,this._stats.tload=Math.max(e.timeLoadedPerformance,this._stats.tfirst),this._stats.total=e.dataLen,this._stats.__type=e.__type,this.type=e.__type;var timate.estimateBandwidth(),this._stats.trequest=this._stats.tfirst-D.cdnEstimate.estimateTTFB(),this._stats.loading.start=this._stats.trequest,this._stats.loading.first=this._stats.tfirst,this._stats.loading.end=this._stats.tload}setHttpStatus(e){this._httpStatus.code=e.httpCk.SUCCESS:this.setResponse(t),this.setStats(t),this.progress(),this.success();break;case k.ERROR:this.setHttpStatus(t),t()}this.stopDelayHLSJSAbandonCheck()}success(){setTimeout((()=>{this._callbacks.onSuccess(this._response,this._stats,this._context)}),0)}error(){thtpStatus.statusText},this._context)}timeout(){this._callbacks.onTimeout(this._stats,this._context,null)}progress(){this._callbacks.onProgress&&this._callbacks.onProgress(this._stats,this._context,this._response.data,null)}};var _n=new class extends le{constructor(){super(),this.TAG="ProcessTSReq",this.preLevel=0}destroy(){P.getRespMap().forEach(((e,t)=>{e.setRespAndSend(k.ERROR,{httpCode:0,statusText:""})})),M.destroy(),P.destroy(),this._totalLoadCnt=0,this.hlsp2p=null}init(e){this._totalLoadCnt=0,this.hlsp2p=e,e.on("chunk_stat",((e,t)=>{var r=P.getResp(e);r&&(r.stats.loaded=t.totalLength)})),e.on("new_buffer",(e=>{var t=e.id,r=P.getResp(t);if(!r||r.inner)return P.delete(t),void M.delete(t);var n=P.getReq(t);this.setRespFromBuffer(t,n.genRequestLoaderConfig())})),e.on("imt_load_cdn",(e=>{var t=e.sn,r=e.level,n=e.url;if(this.hlsp2p){var s=sn.fromObj({sn:t,level:r}).toStringId();if(ln.has(s))this._reportData[Yt]+=1;else if(r===D.curReqLevel&&t<D.curReqSn)this._reportData[Jt]+=1;else if(r===D.curReqLevel)if(M.curTaskId!==s)this._reportData[er]+=1,this._makeLLSCDNRequest(s,{url:n});else{var i=M.get(s);i.backToCDN&&(this._reportData[Zt]+=1,i.backToCDN())}else this._reportData[Qt]+=1}})),tn.registerModule(this.TAG,this.reportCallback.bind(this)),this.initReport(),M.init(),P.init()}load(e,t,r){if(this._totalLoadCnt+=1,this.hlsp2p.trigger("player_level",{level:t.level}),X.log(`æ’­æ”¾å™¨è¯·æ±‚ts id: ${e} pid_${this.hlsp2p.pid} uuid_${Yr()} url: ${t.url} bufferLen: ${un.bufferLength.toFixed(3)}`),void 0!==this._reportData[`req_level_${t.level}`]&&(this._reportData[`req_level_${t.level}`]+=1),t.level!==this.preLevel&&(this.preLevel=t.level,this._reportData[$e]+=1),this._reportData[ot]+=1,l.enableLLS)this.llsLoad(e,t,r);else{var n=P.getResp(e);n&&n.inner&&(this._reportData[ct]+=1,this.abort(e)),P.addReq(e,t,r),this.receiveReq(e)}}llsLoad(e,t,r){var n=P.getResp(e);n&&n.abort(),P.addReq(e,t,r),M.has(e)||this.receiveReq(e)}loadInnerReq(e,t,r){P.has(e)?this._reportData[ut]+=1:(this._reportData[ht]+=1,X.log(`${e} å†…éƒ¨é¢„è¯·æ±‚ts`),r.inner=!0,P.addReq(e,t,r),this.receiveReq(e))}receiveReq(e){var t=P.getReq(e).genRequestLoaderConfig();ln.has(e)?this.setRespFromBuffer(e,t):M.has(e)||(l.enableLLS?this._requestLLS(e,t):this._requestNormalCDN(e,t))}_requestNormalCDN(e,t){var r=new K(e,t,this.onNormalRecvCDNResp.bind(this));this._reportData[dt]+=1,this.hlsp2p.trigger(R.BEFORE_CDN_REQUEST,{loader:r}),M.add(e,r)}_requestLLS(e,t){if(l.lowBufferThreshold&&un.bufferLength<l.lowBufferThreshold)return this._reportData[or]+=1,void this._makeLLSCDNRequest(e,{url:t.url});t.p2pReqTimeout=l.p2pReqTimeout,t.useFetch=!0,t.enableP2pAutoTimeout=l.enableP2pAutoTimeout;var r=new gn(e,t);r.init(this.hlsp2p,this._reportData),r.setCDNRequestCallback(this._makeLLSCDNRequest.bind(this,e,{url:t.url})),M.curTaskId!==e&&(this._reportData[ar]+=1),P.getResp(e).enableDelayHLSJSAbandonCheck(),M.add(e,r)}_makeLLSCDNRequest(e,t){var r=t.url,n=sn.fromId(e),s={onSuccess:()=>{},onError:()=>{},onTimeout:()=>{},onProgress:()=>{}},i={maxRetry:0,maxRetryDelay:64e3,retryDelay:0,timeout:2e4},a={url:r,responseType:"arraybuffer",frag:{sn:n.sn,level:n.level}};if(P.has(e)){P.getResp(e).stopDelayHLSJSAbandonCheck()}else{var o=new E(a,i,s),h=new mn(a,i,s);h.inner=!0,P.addReq(o.id,o,h)}var c=P.getReq(e).genRequestLoaderConfig();if(c.useFetch=!0,this.hlsp2p.chunkMgr){var u=this.hlsp2p.chunkMgr.getRange(e);this.hlsp2p.chunkMgr.getChunks(e)||new Map,this.hlsp2p.chunkMgr.getRangeSeq(e);u&&0!==u.end&&l.enableRange&&(c.useRange=!0,c.range=u,c.headers.Range=`bytes=${u.end}-`,this._reportData[_t]+=1)}this.hlsp2p.trigger("subscribe_report",{seq:e,target:"CDN"});var d=new K(e,c,this.onLLSRecvCDNResp.bind(this));this.hlsp2p.trigger(R.BEFORE_CDN_REQUEST,{loader:d}),M.add(e,d)}onLLSRecvCDNResp(e,t,r){this.onRecvLLSTSRespData(e,t,r),this.statResp(e,t,r),[k.ERROR,k.TIMEOUT].includes(t)&&this.sendRespToPlayer(e,t,r)}onNormalRecvCDNResp(e,t,r){this.statResp(e,t,r);P.getReq(e),r.data&&r.data.byteLength;t===k.SUCCESS&&this.hlsp2p&&this.hlsp2p.trigger(R.FRAG_LOADED,{id:e,binaryData:r.data,resp:r}),this.sendRespToPlayer(e,t,r)}statResp(e,t,r){t!==k.PROGRESS&&(t===k.SUCCESS&&(D.cdnEstimate.recordTTFB(r.TTFBPerformance-r.timeRequestPerformance),D.cdnEstimate.recordBandwidth(r.dataLen,r.timeLoadedPerformance-r.TTFBPerformance),this.recordDownloadCost(r.timeLoadedPerformance-r.timeRequestPerformance),this._reportData[gt]+=1,r.config.useRange&&(this._reportData[yt]+=r.dataLen)),t===k.ERROR&&(this._reportData[mt]+=1),t===k.TIMEOUT&&(this._reportData[vt]+=1))}onRecvLLSTSRespData(e,t,r){if(l.enableLLS&&this.hlsp2p.chunkMgr){if(t===k.STATUS_CODE){var n=r;if(n.config.useRange){if(200===n.statusCode)this._reportData[Ge]=0,this.hlsp2p.chunkMgr.deleteBufFrag(e),this.hlsp2p.chunkMgr.createBufFrag(e,{startByteOffset:0});else if(206===n.statusCode){var s=n.config.range.end;this.hlsp2p.chunkMgr.deleteBufFrag(e),this.hlsp2p.chunkMgr.createBufFrag(e,{startByteOffset:s})}}else 200===n.statusCode&&n.statusCode<=299&&(this.hlsp2p.chunkMgr.deleteBufFrag(e),this.hlsp2p.chunkMgr.createBufFrag(e,{startByteOffset:0}))}var i=r;if(t===k.PROGRESS)return void this.hlsp2p.chunkMgr.addBuf(e,new Uint8Array(i.value));t===k.SUCCESS&&(this.hlsp2p.chunkMgr.completeBufFrag(e),ln.recordResp(e,r.data,r))}}setRespFromBuffer(e,t){if(ln.has(e)){var r=ln.get(e);"cdn"===r.downloadFrom?this._reportData[ft]+=1:"p2p"===r.downloadFrom&&(this._reportData[pt]+=1);var n=ln.genRespFromBuffer(e,t);if(!n)return;X.log(`${e} å‘½ä¸­ç¼“å­˜, download from ${ln.get(e).downloadFrom} len: ${n.data.byteLength}`),this.sendRespToPlayer(e,k.SUCCESS,n)}}sendRespToPlayer(e,t,r){var n=P.getResp(e);n&&(n.inner,n.inner||(this._reportData[Be]+=r.dataLen),n.setRespAndSend(t,r)),P.delete(e),M.delete(e),M.tick()}abort(e){(X.log(`${this.TAG} æ’­æ”¾å™¨è§¦å‘ abort ${e}`),M.delete(e),P.has(e))&&P.getResp(e).abort();P.delete(e)}recordDownloadCost(e){this._reportData[Qe].length>100||this._reportData[Qe].push(Math.floor(e))}initReport(){this._reportData={[W,[Ke]:0,[Ye]:0,[Je]:0,[Qe]:[],[ot]:0,[ht]:0,[ct]:0,[ut]:0,[dt]:0,[ft]:0,[pt]:0,[gt]:0,[yt]:0,[mt]:0,[vt]:0,[Be]:0,[Ge]:1,[$e]:0,[je]:"0",[Yt]:0,[Jt]:0,[Qt]:0,[Zt]:0,[er]:0,[ar]:0,[or]:0,[Tt]:0,[Xt]:0,[kt]:0,[_t]:0}}reportCallback(e){veportData,n=this._reportData[Qe];return n&&n.length&&(r[at]=Math.floor(n.reduce(((e,t)=>e+t))/n.length)),r[je]=`${D.curReqLevel}`,t&&(r[ur]=this._totalLoadCnt),this.initReport(),r}};const yn=_n;const bn=class{constructod="",this.resp=new mn,this.stats=this.resp._stats}destroy(){this.abort()}abort(){yn.abort(this.id)}load(e,t,r){var n=new E(e,t,r);this.resp.update(e,t,r),this.id=n.id,this.resp.id=n.id,this.resp.from="player";var s=e.frag,i=s.sn,a=s.level;D.curReqSn=i,D.curReqLevel=a,setTimeout((()=>{yn.load(this.id,n,this.resp)}))}};class wn{setMaxBufferLength(e){}}var Rn=new class extends wn{constructor(){super(),this.TAG="HlsjsAdapter",this.hlsp2p=null,this.hlsjs=null,this.playerOriginalConfig={maxBufferLength:30,maxMaxBufferLength:600}}destroy(){this._detach(),this.hlsp2p=null,this.hlsjs=null}init(e,t){this.hlsp2p=e,this.hlsjs=t,this.onHlsManifestParsed=this.hlsManifestParsed.bind(this),this.onHlsLevelLoaded=this.hlsLevelLoaded.bind(this),this._attach()}rehis.playerOriginalConfig.maxBufferLength=this.hlsjs.maxBufferLength,this.playerOriginalConfig.maxMaxBufferLength=this.hlsjs.maxMaxBufferLength,this.hlsjs.config.fLoader=bn,this.hlsjs.on("hlsManifestParsed",this.onHlsManifestParsed),this.hlsjs.on("hlsLevelLoaded",this.onHlsLevelLoaded)}hlsManifestParsed(e,t){this.hlsp2p.trigger(R.HlsManifestParsed,t)}hlsLevelLoaded(e,t){var r=t.details.fragments,n=t.details,s=[];r.forEach((e=>{X.log(`[Hlsjs LevelLoaded] ${e.sn}-${e.level} duration: ${e.duration}`)t.duration=Math.round(e.duration),s.push(t)})),this.hlsp2p.trigger(R.LEVEL_LOADED,{level:t.level,playlistType:!0===n.live?"LIVE":"VOD",mediaSequence:n.startSN,targetDuration:n.targetduration,endList:n.endSN,fragments:s,totalDuration:n.totalduration,url:n.url})}setMaxBufferLength(e){D.hlsjs.config.maxBufferLength=e,D.hlsjs.config.maxMaxBufferLength=e}_detach(){this._clearVODTimer(),this.hlsjs.config.maxBufferLength=this.playerOriginalConfig.maxBufferLength,this.hlsjs.config.maxMaxBufferLength=this.playerOriginalConfig.maxMaxBufferLength,this.hlsjs.config.fLoader=void 0,this.hlsjs.off("hlsManifestParsed",this.onHlsManifestParsed),this.hlsjs.off("hlsLevelLoaded",this.onHlsLevelLoaded)}_setVODTimer(){"VOD"===l.videoType&&(this._clearVODTimer(),this._vodTimer=setTimeout((()=>{thich((eliapply(this,s)},t.disposet=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Objecme m3u8-parser @version 4.8.0 @lie){th=e.expreataarn",{message:s+" clamping HOLD-BACK ("+t[i]+") to targetDuration * 3 ("+o+")"}),t[i]=o),n&&!t.hasOwnProperty(a)&&(t[a]=3*n,this.trigger("isage:s+" clamping PART-HOLD-BACK ("+t[a]+") to partTargetDuration * 2 ("+l+")."}),t[a]=l)}},Bn=function(e){function t(){var t;(t=e.call(this)||this).lineStream=new Ln,t.parseStream=new O}(t),i=[],a={},o=!1,l=functulting segment duration to the target duration"}),a.duration=thi.data):(this.manifest.custom=this.manifest.custom|all(s)})),t}Sn(t,e);var r=t.prototype;return r.warnOnMissingAttributes_=function(e,t,r){var n=[];r.forEach((function(e){t.hasOwnProperty(e)||n.push(e)})),n.length&&this.trigger("warn",{message:e+" lacks required attribute(s): "+n.join(", ")})},r.push=function(e){this.lineStream.push(e)},r.end=function(){this.lineStream.push("\n"),this.trigger("end")},r.addParser=function(e){this.parseStream.addParser(e)},r.addTagMapper=function(e){this.parseStream.addTagMapper(e)},t}(In);class Nn{constructor(){this.manifest=null}parse(e){var t=new Bn;return t.push(e),t.end(),this.manifest=t.manifest,this}getPlaylist(e,t){var r=this.manifest,n=r.playlistType,s=r.mediaSequence,i=r.targetDuration,a=Nn.getFragments(r,e,t);return{playlistType:n?n.toUpperCase():"LIVE",mediaSequence:s,targetDuration:i,endList:s+a.length,fragments:a,level:t,totalDuration:Nn.getVodTotalDuration(r),url:e}}getPlaylists(e){var t=this.manifest.play];var r=[];return t.forEach(((t,n)=>{r.push({url:(0,C.buildAbsoluteURL)(e,t.uri),curLevel:n})})),r}static getFragments(e,t,r){var n=e.segments,s=e.mediaSequence,i=[],a=s;return n.forEach((e=>{var n=new S;n.baseUrl=t,n.uri=e.uri,n.level=r,n.sn=a,a+=1,i.push(n)})),i}static getVodTotalDuration(e){var t=e.segments,r=0;return t.forEach((e=>{r+=e.duration})),r}}const Fn=Nn;var $n=new class{constructor(){this.hlsp2p=null}init(e){this.hlsp2p=e}destroy(){this.hlsp2p=null}load(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return J(Z().mark((function n(){var s;return Z().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=3,t.download(e);case 3:if(s=n.sent){n.next=6;break}return n.abrupt("return",Promise.reject(null));case 6:t.parseManifestText(e,r,s,t.load.bind(t));case 7:case"end":return n.stop()}}),n)})))()}download(e){var t=this;return J(Z().mark((function r(){var n,s;return Z().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,n={requestInfo:new Request(e)},t.hlsp2p.trigger(T.BEFORE_M3U8_REQUEST,n),r.next=5,fetch(n.requestInfo);case 5:if(!(s=r.sent).ok){r.next=8;break}return r.abrupt("return",s.text());case 8:r.next=14;break;case 11:r.prev=11,r.t0=r.catch(0);case 14:return r.abrupt("return","");case 15:case"end":return r.stop()}}),r,null,[[0,11]])})))()}parseManifestText}));else{var a=s.parse(r).getPlaylist(e,t);this.hlsp2p.trigger(R.LEVEL_LOADED,a)}}};const jn=$n;class Hn{){this._fullUrlToLevel.clear(),this._levelToUrl.clear()}ready(){return 0!==this._fullUrlToLevel.size}setM3U8(e,t){this._fullUrlToLevel.set(e,t),this._levelToUrl.set(t,e)}getLevel(e){return this._fullUrlToLevel.get(e)}getM3U8(e){return this._levelTlass{constructor(){this.TAG="PlayList",this.hlsp2p=null,this.m3u8UrlList=new Hn}init(e){this.hlsp2p=e,this._reset(),this.LevelLoaded=this.onLevelLoaded.bind(this)ed)}destroy(){this._reset(),this.m3u8UrlList.destroy(),this.hlsp2p.off(R.LEVEL_LOADED,this.LevelLoaded),this.hlsp2p=null}_resetls=[]}findTSInfo(e){for(var t=0;t<this.levels.length;t+=1){var r=this.levels[t];if(!r)return;if(r.fragments){var n=this.findInfo(r.fragments,e);if(void 0!==n)return n}}}findInfo(e,t){return e.find((e=>e.url===t))}hasTS(e,t){var r=this.levels[e];return r&&r.endList>=t&&r.mediaSequence<=t}getTSInfo(e,t){return this.levels[e].fragments.find((e=>e.sn===t))}onLevelLoaded(e){var t=e.playlistType,r=e.mediaSequence,n=e.targetDuration,s=e.endList,i=e.fragments,a=e.level,o=e.totalDuration,l=e.url,h={};h.playlistType=t,h.mediaSequence=r,h.targetDuration=n,h.endList=s,h.fragments=i,D.targetDuration=n,D.totalDuration=o,this.levels[a]=h,this.m3u8UrlList.setM3U8(l,a),this.hlsp2p.trigger(R.FRAGMENT_UPDATED)}};const Vn=Gn;const zn=class{constructor(e,t){this.id=null,this.events={},this.uri=(docs.reconnect=0,this.timer=null,this.initWebSocket()}initWebSocket(){WebSocket&&(this.reconnect+=1,this._ws=new WebSocket(this.uri),this._ws.onopen=this.onopen.bind(this),this._ws.onmessage=this.onmessage.bind(this),this._ws.onclose=this.onclose.bind(this),this._ws.onerror=this.onerror.bind(this))}get readySta4}on(e,t){"connect"!==e&&"message"!==e&&"open"!==e&&"error"!==e||(this.events[e]=t)}emit(e,t){"message"===e&&this._ws&&1===this._ws.readyState&&this._ws.send(`S ${t.to} ${JSON.strinmeout(this.timer),this.timer=null),this.options.reconnection=!1,this._ws.close()}onopen(e){this.reconnect=0,this.events.open()}onmessage(e){var t=e.data.substring(0,1);if("C"===t)this.id=e.data.substring(2),this.events.connect();else if("S"===t){var r=JSON.parse(e.data.substring(29));this.events.message(r)}}onerror(e){this.events.error(e.toString())}onclose(e){this.options.reconnection&&this.options.reconnectibSocket()}),this.options.reconnectionDelay+1e3*this.reconnect))}};const Wn=class{constructor(e,t){this._socket=new zn(e.signalServer,{reconnection:!0,reconnectionAttempts:10,reconnectionDelay:2e3,randomizationFactor:.5,timeout:2e4,autoConnect:!0}),this.callback=t,this._initListening()}destroy(){this._disconnect(),this._socket=null,this.callback=null}on(e,t){this._socket.on(e,t)}emit(e,t){this._socket.emit(e,t)}_disconnect(){return this._socket.det connection(){ime(){var e=new Date;return`${e.getHours()}:${e.getMinutes()}:${e.getSeconds()}.${e.getMilliseconds()}`}_initListening(){var e=this._socket;e.on("connect",(()=>{this.callback&&this.callback({event:"connect"})})),e.on("open",(()=>{this.callback&&this.callback({event:"open"})})),e.on("error",(e=>{this.callback&&this.callback({event:"error",message:e})})),e.on("connect_timeout",(e=>{})),e.on("disconnect",(e=>{})),e.on("reconnect",(e=>{})),e.on("reconnect_attempt",(e=>{})),e.on("reconnecting",(e=>{})),e.on("reconnect_error",(e=>{})),e.on("reconnect_failed",(()=>{})),e.on("ping",(()=>{})),e.on("pong",(e=>{}))}};const Xn=class{constructor(esterModule(this.TAG,this.reportCallback.bind(this)),this.signalSending=this.onSignalSending.bind(this),this.hlsp2p.on(R.SIGNAL_SENDING,this.signalSending),this.config=l,this._socketIOConnection=new Wn({signalServer:this.config.signalServer},this.onEvents.bind(this)),this._socketIOConnection.on("message",(e=>{this.hlsp2p.trigger(R.SIGNAL_RECEIVING,e)}))}reportCallback(){var e={};return e[lr]=this._socketIOConnection.connection.readyState,e}onSignalSending(e){this.send(e)}destroy(){this._socketIOConnection.destroy(),this.hlsp2p.off(R.SIGNALts(e){var t=e.event,r=e.message;switch(t){case"connect":X.info("[signal] connect"),this.hlsp2p.pid=this._socketIOConnection.socketId,this.hlsp2p.trigger(R.SIGNAL_READY,{pid:this._socketIOConnection.socketId});break;case"open":X.info("[signal] open");break;case"error":X.error(`[signal] error: ${r}`)}}send(e){this._socketIOConnection.emit("message",e)}};class Kn{constructor(){this.cache=new Set}destroy(){this.clear()}next(){i:(this.cache.delete(e),e)}clear(){this.cache.clear()}has(e){return this.cache.has(e)}add(e){return this.cache.add(e)}delete(e){return this.cache.delete(e)}get size(){return this.cache.size}}var Yn=new class{constructor(){this.TAG="TrackerController",this.hlsp2p=null,this.peerCache=null,this._timer=null,this._trackerConnected=!1,this._preTrackerId=""}init(e){this.hlsp2p=e,this.onTrackerLoaded=this._onTrackerLoaded.bind(this),this.onTrackerStarting=this._onTrackerStarting.bind(this),this.onRequestTracker=this._onRequestTracker.bind(this),this.hlsp2p.on(R.TRACKER_LOADED,this.onG,this.onTrackerStarting),this.peerCache=new Kn}destroy(){this.peerCache.destroy(),this.hlsp2p.off(R.TRACKER_STARTING,this.onTrackerStarting),this.hlsp2p.off(R.TRACKER_LOADED,this.onTrackerLoaded),this.hlsp2p=null,this._clearTimer()}_clearTimer(){this._timer&&(clearInterval(this._timer),this._timer=null)}nextPeer(){return this.peerCache.removeNext()}_onTrackerLoaded(e){for(var t=e.Data,r=e.trackerChannelId;this.peerCache.size>l.maxPeerCache;)this.peerCache.removeNext();this._preTrackerId&&this._preTrackerId!==r&&(this._preTrackerId=r,this.peerCache.clear());try{var n=JSON.parse(t);if(0===n.ret||"0"===n.ret)this._trackerConnected=!0,n.peers.forEach((e=>{var t=e.pid||e;this.hlsp2p.trigger("find_peer",{pid:t}),this.peerCache.has(t)||this.peerCache.add(t)}))}catch(e){}}_onTrackerStarting(){this._timer=setInterval(this.onRequestTracker,l.trackerInterval),this._onRequestTracker()}_onRequestTracker(){this.hlsp2p.trigger(R.TRACKER_LOADING)}get trackerConnected(){return this._trackerConnected}};const Jn=Yn;var Qn=new class{constructor(){this.TAG="TrackerLoader",this.trackerCount=null,this._loaderManager=new $r,this._trackerChannelId=""}init(e){this._loaderManager.init(),this.hlsp2p=e,this.onTrackerLoading=this._onTrackerLoading.bind(this),this.hlsp2p.on(R.TRACKER_LOADING,this.onTrackerLoading),this.trackerCount=0}destroy(){this._loaderManager.destroy(),this.hlsp2p.off(R.TRACKER_LOADING,this.onTrackerLoading),this.hlsp2p=null,this.trackerCount=null}_onTrackerLoading(){var e=`tracker-${this.trackerCount}`,t=I.GetRequestConfig(),r=Math.floor(un.currentTime||0);if(l.channelId&&this.hlsp2p.localPeerId&&("LIVE"!==l.videoType||!un.paused)){if("LIVE"===l.videoType)this._trackerChannelId=`h5_live_hls_${l.cloudAppId}_${l.levelForTracker}_${l.liveTrackerVersion}_${l.liveModel}_${l.channelId}`,t.url=`${l.liveTrackerServer}/htbt?channel=${this._trackerChannelId}&pid=${this.hlsp2p.localPeerId}&mode=bat`;else{var n=es(l,{currentTime:r,localPeerId:this.hlsp2p.localPeerId,channelId:l.channelId});this._trackerChannelId=n.trackerChannelId,t.url=n.url}var s=new K(e,t,this.receiveResp.bind(this));this._loaderManager.add(e,s),s.load()}}receiveResp(e,t,r){t===k.SUCCESS&&this.hlsp2p.trigger(R.TRACKZn=Qn;var es=(e,t)=>{var r=e.cloudAppId,n=e.vodTrackerVersion,s=e.vodTrackerServer,i=t.currentTime,a=t.localPeerId,o=`h5_vod_hls_${r}_${n}_${t.channelId}`;return{trackerChannelId:o,url:`${s}/htbt?channel=${o}&pid=${a}&maxpos=${i}`}};var ts=new class{constructor(){this.TAG="ConfLoader",this.confCount=null,this._confOkTime=0,this._loaderManager=new $r}init(e){this.hlsp2p=e,tn.registerModule(this.TAG,this.reportCallback.bind(this)),this.onConfLoading=this._onConfLoading.bind(this),this.hlsp2p.on(R.CONF_LOADING,this.onConfLoading),this.confCount=0,this._loaderManager.init()}destroy(){this.hlsp2p.off(R.CONF_LOADING,this.onConfLoading),this._loaderManager.destroy(),this.hlsp2p=null,this.confCount=null}reportCallback(){var e={};return this._confOkTime&&(e[ke]=this._confOkTime,this._confOkTime=0),e}_onConfLoading(){var e=`conf-${this.confCount}`,t=I.GetRequestConfig();t.url=`${l.confBaseUrl}${l.channelId}?domain=${l.domain}&timestamp=${parseInt(Date.now(),10)}`;var r=new K(e,t,this.receiveResp.bind(this));this._loaderManager.add(e,r),r.load()}hlsp2p.trigger(R.CONF_LOADED,{Data:r.data}tTargetDuration(e,t){for(var r=0,n=0;n<e.length;n++){if(t<=e[n])return r;r+=1}return r}static selectPropValue(e,t){return e.length<t?0:e[t]}}class ss{destroy(){this.hlsp2p&&this.hlsp2p.off(R.LEVEL_LOADED,this.handler),this.hlsp2p=null}init(e){return this.handler||(this.handler=e=>{this._updateConfigByTargetDuration({targetDuration:e.targetDuration})},e.on(R.LEVEL_LOADED,this.handler),this.hlsp2p=autoConfiuration;if(l.enableAutoConfig){var r=ns.selectNearestTargetDuration(l.targetDurationTemplate,t);r&&this._autoCoalue(this._autoConfigObj[e],r);t&&(l[e]=t)}))}}}class is{static config(){l.preloadProbability=0,l.liveMaxBuffer=30,l.liveModelkerVersionWithPublicIP()}static updateTrackerVersionWithPublicIP(){l.publicIP&&l.enableMultiArea&&X.log(`[detect]å¤–return!!e.configured}}class os{static assignDomainConfig(e,t,r,n){var s=os.getConfigByDomain(e,t);s&&os.assignConfig(s,r,n)}static getC r=t.ignConfig(e,t,r){r.forEach((r=>{var n=r[0],s=r[1];new Set(Object.keys(e)).has(s)&&(t[n]=e[s])}))}}class ls{constructor(e){this.hlsp2p=e,this._timer=null}destroy(){this._clearTimer(),this.hlsp2p=null}tryToStartOnce(e){if(0!==e&&!this.started){var t=Math.max(e,3e4);this._timer=setInterval((()=>{this._reqConf()}),t)}}get started(){return null!==this._timer}_reqConf(){this.hlsp2p.trigger(R.CONF_LOADING)}_clearTimer(){this._timer&&(clearInterval(this._timer),this._timer=null)}}const hs=new class{constructor(){this.TAG="ConfController"}init(e){this.hlsp2p=e,this.autoConfig=new ss,this.periodicConf=new ls(e),this.onConfLoaded=this._onConfLoaded.bind(this),this.onConfStarting=this._onConfStarting.bind(this),this.onRequestConf=this._onRequestConf.bind(this),this.hlsp2p.on(R.CONF_LOADED,this.onConfLoaded),this.hlsp2p.on(R.CONF_STARTING,this.onConfStarting)}destroy(){this.periodicConf.destroy(),this.periodicConf=null,this.autoConfig.destroy(),this.autoConfig=null,this.hlsp2p.off(R.CONF_LOADED,this.onConfLoaded),this.hlsp2p.off(R.CONF_STARTING,this.onConfStarting),this.hlsp2p=null}_onConfLoaded(e){var t=[["peerCacheSize","peer_cache_size"],["trackerInterval","tracker_interval"],["signalServer","signal_server"],["liveTrackerServer","live_tracker_server"],["vodTrackerServer","vod_tracker_server"],["liveTrackerVersion","live_tracker_ver"],["vodTrackerVersion","vod_tracker_ver"],["reportServer","report_server"],["stunServer","h5_stun_server"],["PCHeartInterval","pc_heart_interval"],["maxPCConnecting","max_pc_connecting"],["maxPCConnected","max_pc_connected"],["p2pSliceRequestCount","p2p_slice_req_cnt"],["checkBufferInterval","check_buffer_interval"],["minPCConnected","min_pc_connected"],["maxConnectRequestEachPeriod","max_connect_request_each_period"],["checkPeerInterval","check_peer_interval"],["peerConnWaWeight","peer_conn_wa_weight"],["bitmapInterval","bitmap_interval"],["p2pLimit","p2p_limit"],["preloadProbability","preload_probability"],["enableAegis","enable_aegis"],["aegisId","aegis_id"],["bufferCount","buffer_cnt"],["cdnBWRatio","cdn_bw_ratio"],["cdnCostRatio","cdn_cost_ratio"],["liveMaxBuffer","live_max_buffer"],["vodMaxBuffer","vod_max_buffer"],["p2pEstimateExtra","p2p_estimate_extra"],["cloudAppId","app_id"],["configured","configured"],["enableCDNDetailReport","en_cdn_detail_report"],["enableLLS","enable_lls"],["p2pReqTimeout","p2p_req_timeout"],["enableP2pAutoTimeout","enable_p2p_auto_timeout"],["cdnEstimateRatio","cdn_estimate_ratio"],["maxP2PDepth","max_p2p_depth"],["streamP2PChunkLength","stream_p2p_chunk_len"],["maxSubscribeSize","max_subscribe_size"],["syncNodeInterval","sync_node_interval"],["lowBufferThreshold","low_buf_threshold"],["maxP2PRetryTimes","max_p2p_retry_times"],["enableAutoConfig","enable_auto_config"],["llsAutoConfig","lls_auto_config"],["enableRange","enable_range"],["fixPCConflict","fix_pc_conflict"],["enableExtraPCCnt","enable_extra_pc_cnt"],["enableRTLog","enable_rtlog"],["rtLogLevel","rtlog_level"],["publicIP","ip"],["confInterval","conf_interval"],["enableLRS","enable_lrs"],["lrsMaxPCConnected","lrs_max_pc_connected"],["lrsMaxPCConnecting","lrs_max_pc_connecting"],["lrsServeResCnt","lrs_serve_res_cnt"],["enableStoreRes","enable_store_res"],["maxStoreResCnt","max_store_res_cnt"],["enableStoreTinyRes","enable_store_tiny_res"],["enableStoreAllTinyRes","enable_store_all_tiny_res"],["tinyResMaxDuration","tiny_res_max_duration"],["resModBase","res_mod_base"],["newResEvictProWindow","new_res_evict_prow"],["coldResEvictThreshold","cold_res_evict_threshold"],["maxIndexeddbStoreSize","max_indexeddb_store_size"],["maxStorageAvailableRatio","max_storage_available_ratio"],["enableLLSMinCircle","enable_lls_min_circle"],["enableValidateTS","enable_validate_ts"],["metaServerUrl","meta_srv_url"],["maxMetaReqTimes","max_meta_req_times"],["metaRetryDelay","meta_retry_delay"],["enableServiceWorker","enable_service_worker"],["bbsP2PReqTimeout","bbs_p2p_req_timeout"],["bbsP2PMaxRetry","bbs_p2p_max_retry"]];try{var r=Fr.decrypt(e.Data).pconf;if(t.forEach((e=>{var t=e[1],n=e[0];t in r&&(l[n]=r[t])})),r.p2p||r.emit_rollback)return X.warn("[hlsp2p] é…ç½®ä¸‹å‘å›žé€€å‘½ä»¤, è§¦å‘ HLSP2P.Events.Rollback äº‹ä»¶"),window.console.warn("[hlsp2p] é…ç½®ä¸‹å‘å›žé€€å‘½ä»¤, è§¦å‘ HLSP2P.Events.Rollback äº‹ä»¶"),D.exitReason="config_rollback",void this.hlsp2p.trigger(Zl.Events.Rollback,{reason:D.exitReason});if(l.confInterval&&this.periodicConf.tryToStartOnce(l.confInterval),os.assignDomainConfig(l.cdnDomain,r,l,t),l.enableLocalNetworkShare){if(!as.checkDomain(r))return X.warn("[hlsp2p] æœªé…ç½®çš„çš„åŸŸå, å›žé€€"),D.exitReason="unknown_domain",void this.hlsp2p.trigger(Zl.Events.Rollback,{reason:D.exitReason});l.enableLLS=!0,as.config()}l.enableLLS&&is.config(),lthis.autoConfig.setAutoConfigFields(["p2pReqTimeout"],l.llsAutoConfig));var n="LIVE"===l.videoType?l.liveMaxBuffer:l.vodMaxBuffer;D.curPlayerAdapter&&D.curPlayerAdapter.setMaxBufferLength(n),this.hlsp2p.trigger(R.CONF_PARSED)}cahlsp2p.trigger(Zl.Events.Rollback,{reason:D.exitReason})}}_onConfStarting(){this.onRequestConf()}_onRequestConf(){this.hlsp2p.trigger(R.CONF_LOADING)}};var cs=new class{constructor(){this.TAG="P2PPreload"}init(e){this.hlsp2p=e,this.endList=-1,this.hlsp2p.on(R.FRAGMENT_UPDATED,this.preload.bind(this)),tn.registerModule(this.TAG,this.reportCallback.bind(this)),this.initReport()}destroy(){this.hlsp2p=null,this.endList=-1}preload(){if("VOD"!==l.videoType&&!(Math.random()>l.preloadProbability)){var e=D.curReqLevel,t=Vs.endList!==r},onError:()=>{},onTim{url:"",responseType:"arraybuffer",frag:{sn:void 0,leurl=n.url;var o=new E(a,i,s),h=new mn(a,i,s),c=o.id;h.id=c,yn.loadInnerReq(c,o,h),this._reportData[lt]+=1,this.endList=r}}}}}initReport(){this._reportData={[lt]:0}}reportCallback(){var e=this._reportData;return this.initReport(),e}};const us=cs;class ds{constructor(){this._callbacks=new Map}destroy(){this._callbacks.clear()}onRecv(e,t){var r=this._callbacks.get(t.uri);r&&r(e,t)}registerCb(e,t){this._callbacks.set(e,t)}}class ps{destroy(){this.peerManager=null}setPeerManager(e){this.peerManager=e}sendBinary(e,t){var r=this.peerManager.getComPeer(e);r&&r.send(t)}}class fs{constructor(e){this.length=e||0,this.array=[],this.offset=0}push(e){this.array.push(e),this.length+=e.length}shift(e){var t=e;if(this.array.length<1)return new Uint8Array(0);if(this.offset+t===this.array[0].length){var r=this.array[0].slice(this.offset,this.offset+t);return this.offset=0,this.array.shift(),this.length-=t,r}if(this.offset+t<this.array[0].length){var n=this.array[0].slice(this.offset,th}for(var s=new Uint8Array(t),i=0;this.array.length>0&&t>0;){if(this.offset+t<this.array[0].length){var a=this.array[0].slice(this.offset,this.offset+t);s.set(a,i),this.offset+=t,this.length-=t,t=0;break}var o=this.array[0].length-this.offset;s.set(this.array[0].slice(this.offset,this.array[0].length),i),this.array.shift(),this.offset=0,i+=o,this.length-=o,t-=o}return s}clear(){this.array=[],this.length=0,this.offset=0}shiftBuffer(){this.array.length>0&&(this.length-=this.array[0].length,this.array.shift(),this.offset=0)}toInt(e,t){for(var r=0,n=this.offset+e;n<this.offset+t+e;)n<this.array[0].length?r=256*r+this.array[0][n]:this.array[1]&&(r=256*r+this.array[1][n-this.array[0].length]),n+=1;return r}}class gs{constructor(){this.uri=ee.P2P_RES_CHUNK,this.sn=0,this.level=0,this.seq=0,this.flag=0,this.payload=new Uint8Array(0)}set id(e){var t=sn.fromId(e);this.sn=t.sn,this.level=t.level}get id(){return sn.fromObj({sn:this.sn,level:this.level}).toStringId()}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt32(this.sn),e.pushUInt8(this.level),e.pushUInt16(this.seq),e.pushUInt8(this.flag),e.pushUint8Array(this.payload),e.marshall()}unmarshall(e){this.sn=e.popUInt32(),this.level=e.popUInt8(),this.seq=e.popUInt16(),this.flag=e.popUInt8(),this.payload=e.popUint8Array()}}var vs=1,ms=4;class _s extends(t()){constructor(e){var t=e.id,r=e.chunkLength,n=e.startByteOffset;super(),this.id=t,this._buffer=new fs,this._currentSeq=0,this._targetChunkLength=r,this._startByteOffset=n,this.lastUpdateTime=Date.now(),this._updateSeqByStartByteOffset()}destroy(){super.removeAllListeners(),this._buffer.clear(),this._currentSeq=0,this.lastUpdateTime=0}_updateSeqByStartByteOffset(){this._currentSeq=this._startByteOffset/this._targetChunkLength}write(e){if(0!==e.byteLength)for(this._buffer.push(e),this.lastUpdateTime=Date.now();this._buffer.length>this._targetChunkLength;)this._createNewChunk()}flush(e){e&&this.write(e);for(var t=Math.ceil(this._buffer.length/this._targetChunkLength),r=0;r<t-1;r++)this._createNewChunk();this._createNewChunk(!0),this.emit("complete",{id:this.id})}_createNewChunk(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._buffer.length<this._targetChunkLength&&!e)return null;var t=new gs,r=sn.fromId(this.id);t.sn=r.sn,t.level=r.level,t.seq=this._currenshift(n),e&&(t.flag|=ms),0===this._currentSeq&&(t.flag|=vs),this._currentSeq+=1,this.emit("new_chunk",t)}}var ys=1,bs=2;class ws extends(t()){constructor(e){var t=e.id;super(),this.id=t,this.chunks=new Map,this.endFlag=!1,this.endChunkSeq=0,this.totalLength=0,this.lastUpdateTime=Date.now(),this.stats={p2pBytes:0,cdnBytes:0,duplicateBytes:0}}destroy(){this.chunks.clear(),this.lastUpdateTime=0,super.removeAllListeners()}getChunks(){return this.chunks}getRanges(){for(var e={start:0,end:0},t=0;t<this.chunks.size&&this.chunks.has(t);t++)e.end+=this.chunks.get(t).payload.byteLength;return e}getRangeSeq(){for(var e={start:0,end:-1},t=0;t<this.chunks.size&&this.chunks.has(t);t++)e.end=t;return e}addChunk(e,t){this._statChunk(e,t),this.chunks.has(e.seq)||(this.lastUpdateTime=Date.now(),this.chunks.set(e.seq,e),this.totalLength+=e.payload.byteLength,e.flag&ms&&(this.endFlag=!0,this.endChunkSeq=e.seq),this.emit("new_chunk",e,{totalLength:this.totalLength}),this.ifComplete()&&this.emit("complete",{id:this.id}))}_statChunk(e,t){var r=e.payload.byteLength;t===bs&&(this.stats.cdnBytes+=r),this.chunks.has(e.seq)&&(this.stats.duplicateBytes+=r),this.chunks.has(e.seq)||t!==ys||(this.stats.p2pBytes+=r)}ifComplete(){return this.endFlag&&this.chunks.size===this.endChunkSeq+1}almostComplete(e){return e.flag&ms?this.chunks.size===e.seq:this.endFlag?this.chunks.size===this.endChunkSeq:void 0}binary(){if(!this.ifComplete())return null;for(var e=new Uint8Array(this.totalLength.chunks.get(r);if(!n)return null;e.set(n.payload,t),t+=n.payload.byteLength}rap=new M((e=>{e.destroy()})),this.chunkMap.clear(),this.bufMap.forEach((e=>{e.destroy()})),this.bufMap.clear(),this._clearTimer(),super.removeAllListeners()}getChunkFrag(e){return this.chunkMap.get(e)}getRange(e){return this.chunkMap.has(e)?this.chunkMap.get(e).getRanges():null}getRangeSeq(e){return this.chunkMap.has(e)?this.chunkMap.get(e).getRangeSeq():null}getChunks(e){var t=this.chunkMap.get(e);return t?t.getChunks():null}createNewChunkFrag(e){if({id:e});t.on("new_chunk",this._onNewChunk.bind(this)),t.on("complete",this._onChunkComplete.bind(this)),this.chunkMap.set(e,t)}}addChunk(e,t){var r=`${e.sn}-${e.level}`;this.chunkMap.has(r)||this.createNewChunkFrag(r);var n=this.chunkMap.get(r);n&&n.addChunk(e,t)}deleteChunkFrag(e){var t=this.chunkMap.get(e);t&&(t.destroy(),this.chnkLength,startBte",this._onStreamChunkComplete.bind(this)),this.bufMap.set(e,n),n}}addBuf(e,t){var r=this.bufMap.get(e);r&&r.write(t)}completeBufFrag(e,t){var r=this.bufMap.get(e);r&&r.flush(t)}deleteBufFrag(e){var t=this.bufMap.get(e);t&&(t.destroy(),this.bufMap.delete(e))}delete(e){this.deleteBufFraeTimer(){this._clearTimer(),this._deleteTimer=setInterval(this._deleteOutDate.bind(this),2e3)}_clearTimer(){this._deleteTimer&&(clearInterval(this._delete>12e4&&this.deleteChunkFrag(t)})),this.bufMap.forEach(((e,t)=>{Date.now()-e.lastUpdateTime>12e4&&this.deleteBufFrag(t)}))}_onNewChunk(e,t){thkMap.get(t);if(r){var n=r.binary();this.emit("complete",{id:t,payload:n,stats:r.stats}),this.deleteChunkFrag(t)}}_onNewChunkFromStream(e){thi)}}var Ts={circle:1,isconnect:8};class Cs{constructor(){this.uri=ee.P2P_RES_ERR,this.sn=0,this.level=0,this.code=0}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt32(this.sn),e.pushUInt8(this.level),e.pushUInt8(this.code),e.marshall()}unmarshall(e){this.sn=e.popUInt32(),this.level=e.popUInt8(),this.code=e.popUInt8()}}class Ss{consop=0,this.url="",this.startSeq=0}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt32(this.sn),e.purl),e.pushUInt32(this.startSeq),e.marshall()}unmarshall(e){this.sn=e.popUInt32(),this.level=e.popUInt8(),this.hop=e.popUInt8(),this.url=e.popString(),this.startSeq=e.popUInt32()}}class Is{constructor(){this.uri=ee.P2P_REQ_CANCEL,this.sn=0,this.level=0}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt32(this.sn),e.pushUInt8(this.level),e.marshall()}unmarshall(e){this.sn=e.popUInt32(),this.level=e.popUInt8()}}class ks{constructor(){this.uri=ee.P2P_REQ_ACCEPT,this.sn=0,this.level=rn e.setUri(this.uri),e.pushUInt32(this.sn),e.pushUInt8(this.level),e.pushUInt8(this.parents.length),this.parents.forEach((t=>{e.pushString(t)})),e.marshall()}unmarshall(e){this.sn=e.popUInt32(),this.level=e.popUInt8();for(var t=e.popUInt8(),r=0;r<t;r++)this.parents.push(e.popString())}}class Es{constructor(){this.uri=ee.P2P_RES_PARENT,this.sn=0,this.level=0,this.parents=[]}include(e){return this.parents.indexOf(e)>=0}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt32(this.sn),e.pushUInt8(this.level),e.pushUInt8(this.parents.length),this.parents.forEach((t=>{e.pushString(t)})),e.marshall()}unmarshall(e){this.sn=e.popUInt32(),this.level=e.popUInt8();for(var t=e.popUInt8(),rthis.load=0,this.rtt=100,this.currentDepth=100,this.progress=0}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt32(this.currentSn),e.pushUInt8(this.currentLevel),e.pushUInt8(this.load),e.pushUInt8(this.currentDepth),e.pushUInt8(this.progress),e.marshall()}unmarshall(e){this.currentSn=t8(),this.progress=e.popUInt8()}score(){return D.curReqLevel!==this.currentLevel||this.currentSn<D.curReqSn-50?0:l.enableLocalNetworkShare?100/(this.rtt||100)+5/thise.P2P_UPWARD,this.sn=0,this.level=0,this.action=0,this.ttl=0}clone(){var e=new Ms;return e.sn=this.sn,e.level=this.level,e.action=this.action,e.ttl=this.ttl,e}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt32(this.sn),e.pushUInt8(this.level),e.pushUInt8(this.action),e.pushUInt8(this.ttl),e.marshall()}unmarshall(e){this.sn=e.popUInt32(),this.level=e.popUInt8(),this.action=e.popUInt8(),this.ttl=e.popUInt8()}}class Os{constructor(){this.router=null}destroy(){this.router=null}setRouter(e){return this.router=e,this}setSubscriber(e){return this.subscriber=e,this}setPeerManager(e){return this.peerManager=e,this}setSyncWorker(e){return this.syncWorker=e,this}init(){this.router.registerCb(ee.P2P_REQ_CHUNK,this._onChunkRequest.bind(this)),this.router.registerCb(ee.P2P_REQ_CANCEL,this._onCancelRequestChunk.bind(this)),this.router.registerCb(ee.P2P_REQ_ACCEPT,this._onRequestAccept.bind(this)),this.router.registerCb(ee.P2P_RES_CHUNK,this._onResChunk.bind(this)),this.router.registerCb(ee.P2P_RES_ERR,this._onResErr.bind(this)),this.router.registerCb(ee.P2P_RES_PARENT,this._onResParent.bind(this)),this.router.registerCb(ee.NODE_SYNC,this._onNodeSync.bind(this)),this.router.registerCb(ee.P2P_UPWARD,this._onUpward.bind(this))}_onChunkRequest(e,t){var r=new Ss;r.unmarshall(t),this.subscriber.onChunkRequest(e,r)}_onCancelRequestChunk(e,t){var r=new Is;r.unmarshall(t),this.subscriber.onReqCancel(e,r)}_onRequestAccept(e,t){var r=new ks;r.unmarshall(t),this.subsct){var r=new gs;r.unmarshall(t),this.subscriber.onResponseChunk(e,r)}_onResErr(e,t){var r=new Cs;r.unmarshall(t),this.subscriber.onRefused(e,r)}_onResParent(e,t){var r=new Es;r.unmarshall(t),this.subscriber.onResponseParent(e,r)}_onNodeSync(e,t){var r=new As;r.unmarshall(t),this.syncWorker.onRecvNo r=new Ms;r.unmarshall(t),this.subscriber.onUpward(e,=>e?[...e.keys()]:[];class Bs extends Map{constructor(e){var t=e.timeout;super(),this.timeout=t,this.deleteTimer=new Map}set(e,t){return this._deleteTimer(e),this._setDeleteTimer(e),super.set(e,t)}delete(e){return this._deleteTimer(e),super.delete(e)}clear(){return this.deleteTimer.forEach(((e,t)=>{this._deleteTimer(t)})),super.clear()}_setDeleteTimer(e){var t=setTimeout((()=>{this.delete(e),this.deleteTimer.delete(e)}),this.timeout);this.deleteTimer.set(e,t)}_deleteTimer(e){var t=this.deleteTimer.get(e);t&&clearTimeout(t),this.deleteTimer.delete(e)}}class Ns{constructor(){this.TAG="LLSSubscriber",this.child=new Bs({timeout:12e4}),this.parent=new Bs({timeout:12e4}),this.myRequest=new Bs({timeout:12e4}),,this.requsetUrl=new Bs({timeout:12e4}),this.subscribeBlackList=new Bs({timeout:12e4}),this.requestStartSeq=new Bs({timeout:12e4}),this.retryTimes=new Bs({timeout:12e4}),this._peerRecvRecord=new Bs({timeout:12e4}),this._peerReqRecord=new Bs({timeout:12e4}),this._firstRecvRecord=new Bs({timeout:12e4}),tn.registerModule(this.TAG,this.reportCallback.bind(this)),this.initReport()}setChunkMgr(e){return this.chunkMgr=e,this}init(e){this.hlsp2p=e,e.on("delete_buffer",(e=>{var t=e.id;this.child.delete(t),this.parent.delete(t),this.myRequest.delete(t),this.backToCDNRequest.delete(t),this.requsetUrl.delete(t),this.subscribeBlackList.delete(t),this.chunkMgr&&this.chunkMgr.delete(t),this.requestStartSeq.delete(t),this.retryTimes.delete(t),this._peerReqRecord.delete(t),this._peerRecvRecord.delete(t),this._firstRecvRecord.delete(t)})),e.on(R.PEER_REMOVED,(e=>{var t=e.pid;this.child.forEach((e=>{e.delete(t)})),this.myRequest.forEach(((e,r)=>{if(e===t){this.myRequest.delete(r);var n=sn.fromId(r),s=this.requsetUrl.get(r);if(s){if(this._reportData[Mt]+=1,this.cancelChunkRequest(r),this._tryToRetryP2PRequest({sn:n.sn,level:n.level},{errCode:Ts.disconnect,pid:e}))return;this._reportData[jt]+=1,this._clearAndRequestCDN({sn:n.sn,level:n.level,url:s})}}}))})),this.chunkMgr.on("chunk",this._sendChunkToChild.bind(this)),this.chunkMgr.on("complete",(e=>{var t=e.id,r=e.payload,n=e.stats;this.child.delete(t),this.parent.delete(t),this.hlsp2p.trigger("chunk_buffer_complete",{id:t,payload:r,stats:n}),this.myRequest.delete(t),this.backToCDNRequest.has(t)||this._resetParent(t)}))}destroy(){this.hlsp2p&&(this.child.clear(),this.parent.clear(),this.myRequest.clear(),this.backToCDNRequest.clear(),this.requsetUrl.clear(),this.subscribeBlackList.clear(),this._firstRecvRecord.clear(),this._peerRecvRecord.clear(),this._peerReqRecord.clear(),this.chunkMgr=null,this.hlsp2p=null)}setTransport(e){return this.transport=e,this}setPeerManager(e){return this.peerManager=e,this}setSyncWorker(e){return this.syncWorker=e,this.syncWorker.collectInfoCb=()=>{var e=new As;return e.currentSn=D.curReqSn,e.currentLevel=D.curReqLevel,e.load=this._childSize(),ln.getSlices(D.curReqSn,D.curReqLevel,0)?e.progress=Ps:this.chunkMgr.getChunks(`${D.curReqSn}-${D.curReqLevel}`)?e.progress=xs:e.progress=Ls,e},this}requestChunk(e){var t=e.sn,r=e.level,n=e.hop,s=e.url,i=((arguments.length>1&&void 0!==arguments[1]?arguments[1]:{retry:!1}).retry,`${t}-${r}`);if(this.requsetUrl.set(i,s),this.myRequest.has(i))return this.myRequest.get(i);var a=this.findParentToRequest(i);if(a){var o=new Ss;o.sn=t,o.level=r,o.hop=n,o.url=s;var l=this.chunkMgr.getRangeSeq(i);l&&(o.startSeq=l.end+1,l.end>0&&(this._reportData[Lt]+=1)),this._send(a,o),this._peerReqRecord.set(`${i}`,performance.now()),this.myRequest.set(i,a),this._reportData[Rt]+=1}return a}addParent(e,t){var r=this.parent.get(e);r||(r=new Set,this.parent.set(e,r)),r.add(t)}updateParents(e,t){this.backToCDNRequest.has(e)||(fn.trace(`[updateParents] ${e} ${t}`),this.parent.set(e,new Set(t)))}findParentToRequest(e){var t=this.child.get(e),r=0,n="";return this.peerManager.getCandidatesPid({id:e}).forEach((s=>{var i=this.peerManager.getConnectedPeer(s);if(t&&t.has(s))this._reportData[Et]+=1;else if(this.subscribeBlackList.has(e)&&this.subscribeBlackList.get(e).has(s))this._reportData[Pt]+=1;else{var a=sn.fromId(e);i.nodeInfo&&i.nodeInfo.currentLevel!==a.level?this._reportData[xt]+=1:(r||(n=s,r=i.score),i.score>r&&(n=s,r=i.score))}})),n}cancelChunkRequest(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=this.myRequest.get(e);if(t&&"cdn_timeout"===t.reason&&this._statP2PWhenTimeout(e),r){var n=new Is,s=sn.fromId(e);n.sn=s.sn,n.level=s.level,this._send(r,n),this.myRequest.delete(e),this.parent.has(e)&&this.parent.get(e).delete(r)}}onChunkRequest(e,t){var r=`${t.sn}-${t.level}`;if(this.requsetUrl.set(r,t.url),this._childSize()>l.maxSubscribeSize)return this.sendRefuse(e,t,Ts.overLoad),void(this._reportData[Nt]+=1);if(this._alreadyPartialData({sn:t.sn,level:t.level}))this._createChunkProvider(e,t);else{if(!this.levelCheck(t))return this.sendRefuse(e,t,Ts.levelMismatching),void(this._reportData[Bt]+=1);if(t.sn<D.curReqSn-l.bufferCount-1||t.sn>D.curReqSn+5)return this.sendRefuse(e,t,Ts.tooMuchDiffSn),void(this._reportData[$t]+=1);if(this.circleCheck(e,t))return this.sendRefuse(e,t,Ts.circle),void(this._reportData[Ut]+=1);if(parent&&parent.size>=l.maxP2PDepth-1&&!this.backToCDNRequest.has(r)){var n=new Ms;n.sn=t.sn,n.level=t.level,n.ttl=l.maxP2PDepth-1,n.action|=Ds,this._reportData[Kt]+=1,this.sendUpward(n)}this._createChunkProvider(e,t)||(this.acceptChunkRequest(e,t),this.tryToMakeRequest(t))}}acceptChunkRequest(e,t){this.addChild(e,t),this.sendReqAccept(e,{sn:t.sn,level:t.level})}tryToMakeRequest(e){var t=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{retry:!1}).retry,r=`${e.sn}-${e.level}`;if(this.backT(r))return this.myRequest.get(r);var n=this.requestChunk({sn:e.sn,level:e.level,hop:e.hop+1,url:e.url},{retry:t});return n||(this._reportData[It]+=1,this._clearAndRequestCDN({sn:e.sn,level:e.level,url:e.url})),n}addChild(e,t){var r=t.sn,n=t.level,s=t.hop,i=`${r}-${n}`,a=this.child.get(i);a||(a=new Map,this.child.set(i,a));var o=new qs;o.hop=s,o.pid=e,a.set(e,o)}sendUpward(e){var t=this._getParent(e);t&&this._send(t,e)}_getParent(e){var t=e.sn,r=e.level;return this.myReques=t.sn,s=tl=s,i.code=r,this._send(e,i)}sendReqAccept(e,t){var r=t.sn,n=t.level,s=new ks;s.sn=r,s.level=n;var i=Us(this.parent.get(sn.fromObj({sn:r,level:n}).toStringId()));i.push(this.peerManager.localPid()),this._reportData[tr]+=1,s.parents=i,this._send(e,s)}circleCheck(e,t){var r=t.sn,n=t.level,s=this.parent.get(`${r}-${n}`);return!!s&&s.has(e)}levelCheck(e){return e.level===D.curReqLevel}depthCheck(e){return e<=l.maxP2PDepth}onUpward(e,t){var r=`${t.sn}-${t.level}`;if(t.action&Ds){if(0===t.ttl){var n=this.requsetUrl.get(r);return this._reportData[zt]+=1,void this._clearAndRequestCDN({sn:t.sn,level:t.level,url:n})}var s=t.clone();s.ttl=t.ttl-1,this.sendUpward(s)}}onReqCancel(e,t){var r=this.child.get(`${t.sn}-${t.level}`);r&&r.delete(e)}onReqAccept(e,t){var r=`${t.sn}-${t.level}`;this.hlsp2p.trigger("subscribe_report",{seq:r,target:e}),this._reportData[Ct]+=1,this.updateParents(r,t.parents);var n=Us(this.child.get(r));thiyRequest.get(r)===e&&this.myRequest.delete(r),this._reportData[St]+=1,this._reportData[qt]+=1,this.cancelChunkRequest(r),this._tryToRetryP2PRequest({sn:t.sn,level:t.level},{errCode:t.code,pid:e})||(this._reportData[Vt]+=1,this._clearAndRequestCDN({sn:t.sn,level:t.level,url:this.requsetUrl.get(r)}))}_addSubscribeBlackList(e,t){var r=this.subscribeBlackList.get(e);r||(r=new Set,this.subscribeBlackList.set(e,r)),r.add(t)}_tryToRetryP2PRequest(e,t){var r=e.sn,n=e.level,s=t.errCode,i=t.pid,a=`${r}-${n}`;if(this.myRequest.delete(a),this._addSubscribeBlackList(a,i),this._allowRetry(a,s)){var o=this.retryTimes.get(a)||0;this.retryTimes.set(a,o+1);var l=this.tryToMakeRequest({sn:r,level:n,hop:0,url:this.requsetUrl.get(a)},{retry:!0});return l?this._reportData[At]+=1:this._reportData[Dt]+=1,l}return""}_allowRetry(e,t){var r=this.retryTimes.get(e)||0,n=-1!==[Ts.circle,Ts.levelMismatching,Ts.overLoad,Ts.reachMaxDepth,Ts.disconnect,Ts.tooMuchDiffSn].indexOf(t);return r<l.maxP2PRetryTimes&&n}onResponseParent(e,t){var r=`${t.sn}-${t.level}`,n=this.myRequest.get(r);if(e===n&&!this.backToCDNRequest.has(r)){fn.trace(`[onResponseParent] id:${r} parentå±‚æ•°: ${t.parents.length} parent: ${t.parents}  currentParent: ${n}, from: ${e}`);var s=Us(this.child.get(r)),i=Us(this.parent.get(r)),a=!1;if(t.include(this.peerManager.localPid()))if(l.enableLLSMinCircle)Array.from(t.parents).sort()[0]===this.peerManager.localPid()&&(a=!0);else a=!0;if(a){if(!this.depthCheck(t.parents.length))return this._reportData[Ht]+=1,void this._clearAndRequestCDN({sn:t.sn,level:t.level,url:this.requsetUrl.get(r)});if(this._reportData[Ot]+=1,this.cancelChunkRequest(r),this._tryToRetryP2PRequest({sn:eturn this._reportData[Ht]+=1,void this._clearAndRequestCDN({sn:t.sn,level:t.level,url:this.requsetUrl.get(r)})}i.toString()!==t.parents.toString()&&(this.updateParents(r,t.parents),this._reportData[sr]+=1,this._sendAllParentToChild(s,t))}}_resetParent(e){this._clearParent(e);var t=Us(this.child.get(e));this._reportData[ir]+=1,this._sendAllParentToChild(t,sn.fromId(e))}_clearParent(e){var t=this.parent.get(e);t&&t.clear()}_deleteChild(e,t){var r=t.sn,n=t.level,s=this.child.get(`${r}-${n}`);s&&s.delete(e)}onResponseChunk(e,t){var r=`${t.sn}-${t.level}`;if(this._reportData[Fe]+=t.payload.byteLength,!this._firstRecvRecord.has(r)&&this._peerReqRecord.has(r)){this._firstRecvRecord.set(r,performance.now());var n=performance.now()-this._peerReqRecord.get(r);this._recordP2PFirstDepth(r),this._recordP2PFirstCost(n)}var s=this.chunkMgr.getChunkFrag(r);if(s&&s.almostComplete(t)){var i=Math.floor(performance.now()-this._firstRecvRecord.get(r)),a=Math.floor(performance.now()-this._peerReqRecord.get(r));this._recordP2PCost(i,a)}this._peerRecvRecord.set(r,!0),this.chunkMgr.addP2PChunk(t)}_alreadyPartialData(e){var t=e.sn,r=e.level,n=`${t}-${r}`;return ln.getSlices(t,r,0)?1:this.chunkMgr.getChunks(n)?2:0}_createChunkProvider(e,t){var r=t.sn,n=t.level,s=t.startSeq,i=`${r}-${n}`,a=this.requestStartSeq.get(i);a||(a=new Map,this.requestStartSeq.set(i,a)),a.set(e,s);var o=ln.getSlices(r,n,0);if(o){this.addChild(e,{sn:r,level:n,hop:0}),this._clearParent(i),this.sendReqAccept(e,{sn:r,level:n});var h=o.arrayBufferData,c=new _s({id:`${r}-${n}`,chunkLength:l.streamP2PChunkLength,startByteOffset:0});return c.on("new_chunk",(t=>{this._necessaryChunk(e,t)&&(t.flag&vs||t.flag,this._send(e,t))})),c.flush(new Uint8Array(h)),this.child.has(i)&&this.child.get(i).delete(e),1}var u=this.chunkMgr.getChunks(i);return u?(this.addChild(e,{sn:r,level:n,hop:0}),{sn:r,level:n}),u.forEach((t=>{this._necessaryChunk(e,t)&&this._send(e,t)})),2):0}_necessaryChunk(e,t){var r=`${t.sn}-${t.level}`,n=this.requestStartSeq.get(r),s=0;return n&&n.has(e)&&(s=n.get(e)),t.seq>=s}_sendAllParentToChild(e,t){var r=t.sn,n=t.level,s=`${r}-${n}`,i=new Es;i.sn=r,i.level=n,i.parents=Us(this.parent.get(s)),i.parents.push(this.peerManager.localPid()),this._reportData[tr]+=1,e.forEach((e=>{this._send(e,i)}))}_sendChunkToChild(e,t){var r=`${e.sn}-${e.level}`;this.hlsp2p.trigger("chunk_stat",r,t);var n=this.child.get(r);if(n){var s=e.marshall();n.forEach(((t,r)=>{this._necessaryChunk(r,e)&&(this._sendBinary(r,s),e.flag&vs||e.flag)}))}}_clearAndRequestCDN(e){var t=e.sn,r=e.level,n=e.url,s=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{resetParent:!0}).resetParent,i=`${t}-${r}`;this.cancelChunkRequest(i),s&&this._resetParent(i),this.backToCDNRequest.has(i)||(this.backToCDNRequest.set(i,i),this._reportData[Wt]+=1,this.hlsp2p.trigger("imt_load_cdn",{sn:t,level:r,url:n}))}_send(e,t){this.transport&&(t.uri===ee.P2P_RES_CHUNK&&(this._reportData[Ne]+=t.payload.byteLength),this.transport.sendBinary(e,t.marshall()))}_sendBinary(e,t){this.transport&&(this._reportData[Ne]+=t.byteLength,this.transport.sendBinary(e,t))}_childSize(){var e=0;return this.child.forEach((t=>{e+=t.size})),e}_recordP2PFirstCost(e){this._reportData[Ze].length>10||this._reportData[Ze].push(Math.floor(e))}_recordP2PFirstDepth(e){var t=this.parent.get(e);t&&this._reportData[rt].length<20&&this._reportData[rt].push(t.size)}_recordP2PCost(e,t){this._reportData[et].length>10||(this._reportData[et].push(e),this._reportData[tt].push(t))}_statP2PWhenTimeout(e){var t=this.parent.get(e);t&&this._reportData[nt].length<20&&this._reportData[nt].push(t.size),this._firstRecvRecord.has(e)||(this._reportData[st]+=1),this._reportData[it]+=1}initReportData={[wt]:0,[bt]:0,[Ct]:0,[St]:0,[Ut]:0,[Bt]:0,[Nt]:0,[Ft]:0,[$t]:0,[Et]:0,[Pt]:0,[xt]:0,[Fe]:0,[Ne]:0,[jt]:0,[Ht]:0,[Gt]:0,[Vt]:0,[It]:0,[Wt]:0,0,[ortData;return this.initReport(),e[wt]=this._childSize(),this.myRequest.forEach((()=>{e[bt]+=1})),e}}class Fs{constructor(){this.collectInfoCb=null}setPeerManager(e){return this.peerManager=e,this}setTransport(e){return this.transport=e,this}destroy(){this._clearTimer(),this.peerManager=null,this.transport=null,this.collectInfoCb=null}init(){this._syncNodeTimer=sgetConnectedPeer(e);r&&(t.rtt=r.rtt,r.nodeInfo=t)}_syncNodeInfo(){if(this.collectInfoCb){var e=this.collectInfoCb().marshall();this.peerManager.getConnectedPeers().forEach(((t,r)=>{this.transport.sendBinary(r,e)}))}}_clearTimer(){this._syncNodeTimer&&(clearInterval(this._syncNodeTimer),this._syncNodeTimer=null)}}class $s{constructor(){this.chunkMgr=new Rs,this.llsServer=new Os,this.subscriber=new Ns,this.syncWorker=new Fs}setRouter(e){return this.router=e,this}setTransport(e){return this.transport=e,this}setPeerManager(e){return this.peerManager=e,this}init(e){this.hlsp2p=e,this.syncWorker.setTransport(this.transport).setPeerManager(this.peerManager).init(),this.subscriber.setChunkMgr(this.chunkMgr).setTransport(this.transport).setPeerManager(this.peerManager).setSyncWorker(this.syncWorker).init(e),this.llsServer.setSubscriber(this.subscriber).setRouter(this.router).setPeerManager(this.peerManager).setSyncWorker(this.syncWorker).init()}destroy(){this.chunkMgr.destroy(),this.subscriber.destroy(),this.llsServer.destroy(),this.syncWorker.destroy(),this.router=null,this.peerManager=null,this.transport=nect",Ws="open",Xs="close",Ks="error",Ys="bufferAmountLow",Js="report";const Qs=class{constructor(e,t,r){this.TAG=`DataChannel_${t.label}`,this.callbacks=r,this.config=t,this.dataChannel=e.createDataChannel(t.label,t),this.dataChannel.binaryType="arraybuffer",this._bindHandler(),this._bufferedAmountLimit=t.bufferedAmountLimit}destroy(){this._removeHandler(),this.dataChannel.close(),this.dataChannel=null,this.callbacks=null}_bindHandler(){var e=this.dataChannel;e.onopen=this.onOpen.bind(this),e.age=this.onMessage.bind(this),e.onbufferedamountlow&&(e.onbufferedamountlow=this.onBufferedAmountLow.bind(this))}_removeHandler(){var e=this.dataChannel;e.onopen=null,e.onerror=null,e.onclose=null,e.onmessage=null,e.onbufferedamountlow=null}send(e){var t=this.dataChannel;t&&"open"===t.readyState&&t.bufferedAmount<=thiks.onDataChannelMessage(e.data)}onOpen(){this.callbacks&&this.callbacks.onDataChannelStateChange({state:Ws})}onClose(){this.callbacks&&this.callbacks.onDataChannelStateChange({state:Xs})}onError(e){var t=e.error;fn.error(`${this.TAG}, Data channel error, id:${this.id} ${t.message}`),this.callbacks&&this.callbacks.onDataChannelStateChange({state:Ks})}onBufferedAmountLow(){this.callbacks.onDataChannelStateChange({state:Ys})}get readyState(){return this.dataChannel.readyState}get bufferedAmount(){return this.dataChannel.bufferedAmount}get label(){return this.dataChannel.label}get id(){return this.dataChannel.id}get bufferedAmountLowThreshold(){return this.dataChannel.bufferedAmountLowThreshold}};const Zs=class{constructor(e,t,r){var n=e.id;this.TAG=`WebRTCPeerConnection_${n}`,this.localId=t.localId,this.remoteId=t.remoteId,this.id=n,this.callbacks=r,this._rtcPeerConnection=new RTCPeerConnection(t.ice),this._bindHandler();var s={label:`${this.remoteId}_${this.id}`,id:0,negotiated:!0,bufferedAmountLimit:t.bufferedAmountLimit},i={onDataChannelMessage:this.onDataChannelMessage.bind(this),onDataChannelStateChange:this.onDataChannelStateChange.bind(this)};this._dataChannel=new Qs(this._rtcPeerConnection,s,i)}destroy(){this._dataChannel.destroy(),this._dataChannel=null,this._rtcPeerConnection.close(),this._rtcPeerConnection=null,this.callbacks=null}send(e){this._dataChannel.send(e)}_bindHandler(){this._rtcPeerConnection.onicecandidate=this.onIceCandidate.bind(this),this._rtcPeerConnection.oniceconnectionstatechange=this.onIceConnectionStateChange.bind(this),this._rtcPeerConnection.onsignalingstatechange=this.onSignalingStateChange.bind(this)}receiveSignal(e){switch(e.type){case Vs:this._createOffer();break;case js:this._receiveOffer(e.msg);break;case Hs:this._receiveAnswer(e.msg);break;case Gs:this._receiveCandidate(e.msg)}}onIceCandidate(e){if(this.callbacks){if(!msg:e.candidate,id:this.id})}}onIceConnectionStateChange(e){this.callbacks&&this.callbacks.onStateChange({context:"peerConnection",type:"IceConnectionState",state:e.target.iceConnectionState})}onSignalingStateChange(){this.callbacks&&this.callbacks.onStateChange({context:"peerConnection",type:"SignalingState",state:this._rtcPeerConnection.signalingState})}onDataChannelMessage(e){this.callbacks&&this.callbacks.onMessage(e)}onDataChannelStateChange(e){this.callbacks&&this.callbacks.onStateChange({context:"dataChannel",type:"State",state:e.state,originData:e})}_receiveOffer(e){this._receiveDescription(e,(()=>{this._createAnswer()}))}_receiveAnswer(e){this._receiveDescription(e)}_receiveCandidate(e){var t;try{t=new RTCIceCandidate(e)}catch(e){return}this._rtcPeerConnection.addIceCandi((()=>{})).catch((e=>{}))}_createAnswer(){this._rtcPeerConnecon.setLocalDescription(e))).then((()=>{this.callbacks&&this.callbacks.onSendBySignalChannel({type:Hs,msg:this._rtcPeerConnection.localDescription,id:this.id})})).catch((e=>{}))}_receiveDescription(e,t){this._rtcPeerConnection.setRemoteDescription(new RTC&t()}))}_createOffer(){this._rtcPeerConnection.createOffer().then((e=>this._rtcPeerConnection.setLocalDescription(e))).then((()=>{this.callbacks&&this.callbacks.onSendBySignalChannel({type:js,msg:this._rtcPe{}))}get iceGatheringState(){return this._rtcPeerConnection.iceGatheringState}get open(){return"open"===this._dataChannel.readyState}};var ei="fail",ti="open",ri="ice",ni="report",si="INIT_TIMEOUT",ii="HEART_TIMEOUT",ai="DC_CLOSED",oi="DC_ERROR";const li=class{coinit(e){this.time=e.time,this.sendBytes=e.sendBytes,this.receiveBytes=e.receiveBytes}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt32(this.time),e.pushUInt32(this.sendBytes),e.pushUInt32(this.receiveBytes),e.marshall()}unmarshall(e){this.time=e.popUInt};const hi=class{constructor(e,t,r){this.alpha=e,this._sendBytesAvg=t,this._receiveBytesAvg=r}sendBytesAvg(e){this._sendBytesAvg=e*(1-this.alpha)+this.alpha*this._sendBytesAvg}receiveBytesAvg(e){this._receiveBytesAvg=e*(1-this.alpha)+this.alpha*thiis._receiveBytesAvg}getBytesAvg(){return(this._receiveBytesAvg+this._sendBytesAvg)/2}};const ci=class{constructor(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.view=e,this.pos=0,this.len=0,this.uri=0,this.resCode=0,!0===t&&(this.len=this.popUInt32(),this.uri=this.popUInt32(),this.resCode=this.popUInt16())}bytesAvailable(){return this.view.byteLength-this.pos}popBool(){return 1===this.popUInt8()}popUInt8(){if(this.pos+1>this.view.byteLength)return 0;var e=this.view.getUint8(this.pos);return this.pos+=1,e}popUInt16(){if(this.pos+2>this.view.byteLength)return 0;var e=this.view.getUint16(this.pos,!0);return this.pos+=2,e}popUInt32(){if(this.pos+4>this.view.byteLength)return 0;var e=this.view.getUint32(this.pos,!0);return this.pos+=4,e}popUInt64(){if(this.pos+8>this.view.byteLength)return 0;var e=this.view.getUint32(this.pos,!0);this.pos+=4;var t=this.view.getUint32(this.pos,!0);return this.pos+=4,4294967296*t+e}popUint8Array(){var e=this.popUInt16();if(this.pos+e>this.view.byteLength)return null;var t=new Uint8Array(this.view.buffer,this.pos,e);return this.pos+=e,t.slice()}popUint8Array32(){var e=this.popUInt32();if(this.pos+e>this.view.byteLength)return null;var t=new Uint8Array(this.view.buffer,this.pos,e);return this.pos+=e,t.slice()}popUInt32Vector(){var e=this.popUInt32();if(this.pos+4*e>this.view.byteLength)return null;for(var t=[.popUInt32());return t}popUInt16Vector(){var e=this.popUInt32();if(this.pos+2*e>this.view.byteLength)return null;for(var t=[],r=0;r<e;r+=1)t.push(this.popUInt16());return t}popString(){var e=this.popUInt16();if(this.pos+e>this.view.byteLength)return null;for(var t=[],r=0;r<e;r+=1)t[r]=String.fromCharCode(this.popUInt8());return t.join("")}};const ui=class{constructor(){this.uri=ee.PONG,this.time=0}init(e){this.time=e.time}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt32(this.time),e.marshall()}unmarshall(e){this.time=e.popUInt32()}};const di=class{constructor(e,t){this.TAG="PeerConnection",this.passtive=null,this.localId=e.localId,this.remoteId=e.remoteId,this.callbacks=t,this._receiveBytes=0,this._sendBytes=0,this.nodeInfo=null,this.rtt=100,this._wa=new hi(l.peerConnWaWeight,l.peerConnWaInitSendBytes,l.peerConnWaInitReceiveBytes),this._initConnTimer=setTimeout(this._checkInitConnected.bind(this),l.initConnTimeout),this.pcGroup=this.createPC(),this.sendIndex=0,this.totalPCNum=this.pcGroup.length}createPC(){var e=[],t={localId:this.localId,remoteId:this.remoteId,ice:{iceServers:[]},bufferedAmountLimit:l.bufferedAmountLimit};l.stunServer&&t.ice.iceServers.push({urls:`stun:${l.stunServer}`});var r=new Zs({id:0},t,{onMessage:this.onMessage.bind(this),onStateChange:this.onStateChange.bind(this),onSendBySignalChannel:this.onSendBySignalChannel.b=>{},onSendBySignalChannel:this.onSendBySignalChannel.bind(this)});e.push(s)}return e}destroy(){this._clearTimer(),this._clearInitConnTimer(),this.pcGroup.forEach((e=>{e.destroy()})),this.pcGroup=[],this.passtive=null,this._wa=null,this.router=null,this.nodeInfo=null}get score(){return this.nodeInfo?this.nodeInfo.score():this._wa?this._wa.getBytesAvg():0}get numOfOpeningPC(){return this.pcGroup.filter((e=>e.open)).length}setStats(e){this.p2pStats=e}setRouter(e){this.router=e}onStateChange(e){var t=e.context;if("peerConnection"===t){var r=e.type;"IceConnectionState"===r&&this.callbacks.onPeerConnectionState({type:ri,state:e.state})}else if("dataChannel"===t){switch(e.state){case Js:this.callbacks.onPeerConnectionState({remoteId:this.remoteId,type:ni,reason:"report",originData:e.originData});break;case Xs:this.callbacks.onPeerConnectionState({remoteId:this.remoteId,type:ei,reason:ai});break;case Ks:this.callbacks.onPeerConnectionState({remoteId:this.remoteId,type:ei,reason:oi});break;case Ws:this.callbacks.onPeerConnectionpe:ti,reason:"dataChannelOpen"}),this._clearInitConnTimer(),this._sendHeart(),this._startHeart()}}}receiveSignal(e){var t=e.type,r=e.pcId,n=this.pcGroup[r];switch(t){case Hs:n.receiveSignal({type:Hs,msg:e.payload});break;case js:this.passtive=!0,n.receiveSignal({type:js,msg:e.payload});break;case Gs:n.receiveSignal({type:Gs,msg:e.payload});break;default:this.passtive=!1,this.pcGroup.forEach((e=>{e.receiveSignal({type:Vs})}))}}onSendBySignalChannel(e){var t;switch(e.type){case js:t={from:this.localId,to:this.remoteId,type:js,payload:e.msg,pcId:e.id},this._sendBySignaling(t);break;case Gs:t={from:this.localId,to:this.remoteId,type:Gs,payload:e.msg,pcId:e.id},this._sendBySignaling(t);break;case Hs:t={from:this.localId,to:this.remoteId,type:Hs,payload:e.msg,pcId:e.id},this._sendBySignaling(t)}}_sendBySignaling(e){this.callbacks.onSignaling(e)}_sendHeart(){var e=new li;this._lastPingTime=Math.floor(performance.now()),e.,this._heartTimer=null),this._lastSyncTime=Vr.timestamp(),this.sendHeart=this._sendHeart.bind(this),this._heartTimer=setInterval(this.sendHeart,l.PCHeartInterval),this._checkAliveTimer=setInterval(this._checkAlive.bind(this),l.PCCheckAliveInterval)}_clearTimer(){this._heartTimer&&(clearInterval(this._heartTimer),this._heartTimer=null),this._checkAliveTimer&&(clearInterval(this._checkAliveTimer),this._checkAliveTimer=null)}onMessage(e){var t=new DataView(e),r=new ci(t);switch(r.uri){case ee.PING:this._onPing(r);break;case ee.PONG:this._onPong(r);break;case ee.SLICE:this._receiveBytes+=r.len;break;default:this.router.onRecv(this.remoteId,r)}}_onPing(e){var t=new li;t.unmarshall(e),this._lastSyncTime=Vr.timestamp(),this._wa.sendBytesAvg(t.receiveBytes),this._wa.receiveBytesAvg(this._receiveBytes),this._receiveBytes=0,this._sendPong(t.time)}_sendPong(e){var t=new ui;t.time=e,this.send(t.marshall())}_onPong(e){var t=new ui;t.unmarshall(e),this._lastPingTime===t.time&&(this.rtt=Math.floor(performance.now()-t.time))}send(e){if(this.p2pStats&&this.p2pStats.addUploadBytes(e.byteLength),e[4]===ee.P2P_RES_CHUNK){var t=this.sendIndex%this.totalPCNum;this.sendIndex+=1;var r=this.pcGroup[t];r.open||(r=this.pcGroup[0]),r.send(e),this.sendIndex>1e7&&(this.senlastSyncTime>l.PCHeartTimeout&&this.callbacks.onPeerConnectionState({remoteId:this.remoteId,type:ei,reason:ii})}_checkInitConnected(){this.callbacks.onPeerConnectionState({remoteId:this.remoteId,type:ei,reason:si})}_clearInitConnTimer(){this._initConnTimer&&(clearTimeout(this._initConnTimer),this._initConnTimer=null)}};class pi extends e.EventEmitter{static createPeerManagerSignalId(e){return`${R.SIGNAL_DISPATCHING}_${e}`}constructor(e){super(),this.TAG="PeerManager",this.hlsp2p=e,this.resId="default"}localPid(){return this.hlsp2p.localPeerId}init(){return tn.registerModule(this.TAG,this.reportCallback.bind(this)),this._connecting=new Map,this._connected=new Map,this.checkPeers=this._checkPeers.bind(this),this._checkPeerTimer=setInterval(this.checkPeers,l.checkPeerInterval),this._initConnect=!0,this.hlsp2p.on(pi.createPeerManagerSignalId(this.resId),this.receiveSignal.bind(this)),this.initReportData(),this}destroy(){super.removeAllListeners(),this._connecting.forEach((e=>{e.destroy()})),this._connecting.clear(),this._connecting=null,this._connected.forEach((e=>{e.destroy()})),this._connected.clear(),this._connected=null,this._clearTimer(),this.hlsp2p=null,this.router=null,this.transport=null}setResId(e){return this.resId=e,this}getResId(){return this.resId}setRouter(e){return this.router=e,this}setTransport(e){res}get peerConnected(){return this._connected.size}getConnectedPeers(){return this._connected}getConnectedPeer(e){return this._connected.get(e)}getCandidatesPid(e){e.id;return[...this._connected.keys()]}getComPeer(e){return this._connected.get(e)}_clearTimer(){this._checkPeerTimer&&(clearInterval(this._checkPeerTimer),this._checkPeerTimer=null)}sendSignaling(e){this._beforeSendingSignal(e),this._trigger(R.SIGNAL_SENDING,e)}_beforeSendingSignal(e){e.resId=this.getResId()}receiveSignal(e){var t=e.type,r=e.from,n=e.to;if(t===zs)return this._reportData[fe]+=1,void(this._reportData[ge]+=1);if(t===js&&this._connecting.has(r)&&l.fixPCConflict){if(n>r)return void(this._reportData[Re]+=1);var s=this._connecting.get(r);this._connecting.delete(r),s.destroy(),this._reportData[Te]+=1,this.createPeerConnection({localId:n,remoteId:r})}if(t===js&&!this._checkPCExist(r)){if(!this.canConnect(e))return X.log(`[p2p] [receiveSignal] [reject] ${r}`),void this.sendSignaling({from:e.to,to:e.from,pcId:e.pcId,type:zs,payload:""});this.createPeerConnection({localId:n,remoteId:r})}var i=this._connecting.get(r);i&&(this._signalReceived(e),i.receiveSignal(e))}_signalReceived(e){}createPeerConnection(e){this._reportData[ce]+=1,this._reportData[ue]+=1;var t,r={onPeerConnectionMessage:this.onReceiveData.bind(this),onPeerConnectionState:this.onPeerConnectionState.bind(this),onSignaling:this.sendSignaling.bind(this)},n=e.localId,s=e.remoteId;try{t=new di({localId:n,remoteId:s},r),X.log(`[detect][createPeerConnection]?pid=${s}`),this._preparePC(t)}catch(e){X.error(` create PeerConnection Error for the reason ${e.reason}`)}reRouter(this.router)}canConnect(e){return this._connected.size<l.maxPCConnected&&this._connecting.size<l.maxPCConnecting}_PCConnected(e){this._reportData[de]+=1,this._reportData[pe]+=1;var t=this._getReadyPCFromCache(e);X.log(`[detect][p2p][peerConnected]?pid=${e}`),t&&(this._connected.set(e,t),this._trigger(R.PEER_CONNECTED,{pid:e}))}_getReadyPCFromCache(e){var t=this._connecting.get(e);return this._connecting.delete(e),t}_handlePCFail(e){switch(thie si:this._reportData[be]+=1,X.log(`[detect][connInitTimeout]?pid=${e.remoteId}`);break;case ai:this._reportData[ye]+=1;break;case oi:this._reportData[me]+=1;break;case ii:this._reportData[we]+=1}}_deletePC(e){var t=this._connected.get(e);t&&(t.destroy(),this._connected.delete(e)),(t=this._connecting.get(e))&&(t.destroy(),this._connecting.delete(e)),this._trigger(R.PEER_REMOVED,{pid:e})}onReceiveData(){throw Error("éœ€è¦å¯¦ç¾")}onPeerConnectionState(e){switch(e.type){case ei:this._handlePCFail(e);break;case ti:this._PCConnected(e.remoteId)}}_checkPCExist(e){return this._connecting.has(e)||this._connected.has(e)}keepEnoughPeers(){var e=0,t=this.hlsp2p.localPeerId;if(!this.canConnect())return!0;this._initConnect&&(this._initConnect=!1);for(var r=this._initConnect?l.maxPCConnected:l.maxConnectRequestEachPeriod;e<r;){var n=this._getNextPeerForConnecting();if(!n)ection({localId:t,remoteId:n});s&&s.receiveSignal({type:"init"})}e+=1}return!1}_getNextPeerForConnecting(){return Jn.nextPeer()}kickUselessPeer(){var e;this._connected.size>l.minPCConnected&&this._connected.forEach(((t,r)=>{this._connected.get(e)?this._connected.get(e).score>t.score&&(e=r):e=r})),e&&this._kickPeer(e)}_kickPeer(e){this._reportData[ve]+=1,this._deletePC(e)}_checkPeers(){this.keepEnoughPeers(),this.kickUselessPeer()}_trigger(e,t){this.hlsp2p.trigger(e,t)}_allPcRtt(){var e=this._connected,t=[];return e.forEach((e=>{e&&e.rtt&&(X.log(`[p2p] [rtt] local: ${this.localPid())})),t.slice(0,10)}initReportData(){this._reportData={[he]:0,[ce]:0,[de]:0,[ue]:0]:0,[_e]:[],[we]:0,[be]:0,[Re]:0,[Te]:0,[Ce]:this._allPcRtt()}}reportCallback(){var e=this._reportData;return e[he]=this._connected.size,this.initReportData(),this._reportData[ue]=e[ue],this._reportData[pe]=e[pe],this._reportData[ge]=e[ge],this._connected.forEach((e=>{this._reportData[_e].push(e.numOfOpeningPC)})),e}}const fi=pi;class gi extenlayer_level",(e=>{var t=e.level;l.levelForTracker=t}))}}var vi=1;const mi=class{conste.SYNC_INFO,this.peerType=0}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt8(this.peerType),e.marshall()}unmarshall(e){this.peerType=e.popUInt8()}};class _i{setBitmapMgr(e){return this.bitmapMgr=e,this}init(){}destroy(){this.bitmapMgr=null}kickFilter(e){var t=[];return e.forEach((e=>{this._checkBitmap(e)||t.push(e)})),t}_checkBitmap(e){var t=this.bitmapMgr.getBitmap(e);return!t||t.bufferInfo.filter((e=>e.sn>D.curReqSn)).length>0}}var yi="p2p_recv_req",bi="p2p_class extends fi{constructor(e){super(e),this.TAG="VodPeerManager",this._lrsPeer=new Set,this._ignoreLRSPeer=new Set,this._lrsFilter=new _i}setBitmapMgr(e){return this.bitmapMgr=e,this}init(){return this._lrsFilter.setBitmapMgr(this.bitmapMgr).init(),this._lrsPeer.clear(),this.hlsp2p.elete(t)})),super.init()}destroy(){this._lrsPeer.clear(),this._lrsFilter.destroy(),super.destroy()}recvSyncInfo(e,t){var r=new mi;r.unmarshall(t),r.peerType===vi&&this._lrsPeer.add(e)}getAllConnectedPid(){return[...this._connected.keys()]}ignorePeer(e){return this._lrsPeer.has(e)}kickUselessPeer(){if(this._lrsFilter){var e=this._getAllLRSPid();this._lrsFilter.kickFilter(e).forEach((e=>{this._kickPeer(e),this._ignoreLRSPeer.add(e)}))}return super.kickUselessPeer()}_getAllLRSPid(){var e=[];return this._lrsPeer.forEach((t=>{this._connected.has(t)&&e.push(t)})),e}_getNextPeerForConnecting(){for(var e=super._getNextPeerForConnecting();this._ignoreLRSPeer.has(e);)e=super._getNextPeerForConnecting();return e}reportCallback(){return this._reportData[Ti]=this._getAllLRSPid().length,super.reportCallback()}};class Si{constructor(){this.router=null}destroy(){this.router=null,this.packetMgr=null,this.bitmapMgr=null,this.peerMgr=null}setRouter(e){return this.router=e,this}setVodPeerManager(e){return this.peerMgr=e,this}setPacketMgr(e){return this.packetMgr=e,this}setBitmapMgr(e){return this.bitmapMgr=e,this}s=e,this}init(){return this.router.registerCb(ee.BITMAP,this._onBitmap.bind(this)),this.router.registerCb(ee.SLICE_REQUEST,this._onSliceRequest.bind(this)),this.router.registerCb(ee.PACKET,this._onPacket.bind(this)),this.router.registerCb(ee.SYNC_INFO,this._onSyncInfo.bind(this)),this}_onBitmap(e,t){this.bitmapMgr.recvBitmap(e,t)}_onSliceRequest(e,t){this.bbsSubscriber.onSliceRequest(e,t)}_onPacket(e,t){this.packetMgr.addPacket(t)}_onSyncInfo(e,t){this.peerMgr.recvSyncInfo(e,t)}}const Ii=class{constructor(){this.uri=ee.BITMAP,this.curLevel=255,this.bufferInfo=[]}add(e){this.bufferInfo.push(e)}hasSlice(e){for(var t=0;t<this.bufferInfo.length;t+=1)if(this.bufferInfo[t].sn===e.ReqSn&&this.bufferInfo[t].level===e.R.subIndexes.indexOf(e.idx))return!0;return!1}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt8(this.curLevel),e.pushUInt16(this.bufferInfo.length),this.bufferInfo.forEach((t=>{t.mor(var t=e.popUInt16(),r=0;r<t;r+=1){var n=new ae;n.unmarshall(e),this.bufferInfo.push(n)}}toString(){var e="";return this.bufferInfo.forEach((t=>{e+=`${t.sn}-${t.level} | `})),e}};class ki{constructor(){this._timers=new Map}clear(){this._timers.forEach((e=>{clearInterval(e)})),this._timers.clear()}add(e,t){clearInterval(this._timers.get(e)),this._timers.set(e,t)}delete(e){clearInterval(this._timers.get(e)),this._timers.delete(e)}}const Ei=class{constructor(e){this.TAG="BitmapMgr",this.hlsp2p=e,this._bitmap=new Map,t this.peerManager=e,this}init(){this._bitmap.clear(),this._syncTimer.clear(),this.hlsp2p.on(R.PEER_REMOVED,(e=>{var t=e.pid;this._bitmap.delete(t),this._syncTimer.delete(t)})),this.hlsp2p.on(R.PEER_CONNECTED,(e=>{var t=e.pid,r=setInterval((()=>{this._syncBitmapTo(t)}),l.bitmapInterval);this._syncTimer.add(t,r),this._syncBitmapTo(t)}))}destroy(){this._bitmap.clear(),this._syncTimer.clear(),this.peerManager=null,this.transport=null}recvBitmap(e,t){var r=new Ii;r.unmarshall(t),this._bitmap.set(e,r)}getBitmap(e){return this._bitmap.get(e)}_syncBitmapTo(e){this.peerManager.ignorePeer(e)||this.transport.sendBinary(e,this.createBitmap([]))}createBitmap(e){if(!Array.isArray(e))throw Error(`${this.TAG}.getSpecifiedBitmap å‚æ•°éœ€ä¸ºæ•°ç»„`);var t=new Ii;return ln.getBufferInfo(e).f{constructor(){this.uri.idx=0}init(e){this.ReqSn=e.ReqSn,this.ReqLevel=e.ReqLevel,this.idx=e.idx}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt32(this.ReqSn),e.pushUInt32(this.ReqLevel),e.pushUInt32(this.idx),e.marshall()}unmarshall(e){this.ReqSn=e.popUInt32(),this.ReqLevel=e.popUInt32(),this.idx=e.popUInt32()}};const xi=class{constructor(){this.fragMap=new Map,this._timer=null}init(){this._setTimer()}destroy(){this._clearTimer(),this.fragMap.clear()}addPacket(e){var t=new se;t.unmarshall(e);var r=`${t.sn}-${t.level}-${t.sliceIndex}`;if(ln.getSlices(t.sn,t.level,t.sliceIndex))this.fragMap.delete(r);else{var n=this.fragMap.get(r);n||((n=new ie(t.sn,t.level,t.sliceIndex)).id=r,n.packetAmount=t.totalPacket,n.combineCallback=this.combineFinish.bind(this),this.fragMap.set(r,n)),n.addPacket(t),D.p2pEstimate&&D.p2pEstimate.addPacket(r,{totalPacket:t.totalPacket})}}static genPacketsFromSlice(e,t,r){return J(Z().mark((function r(){var n,s;return Z().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,ln.getSlicesFromAllPlace(e,t);case 2:if(!(n=r.sent)){r.next=7;break}return s=n.segmentSliceToPacket(),r.abrupt("return",s);case 7:return r.abrupt("return",!1);case 8:case"end":return r.stop()}}),r)})))()}combineFinish(e){var t=this.fragMap.get(e);ln.onReceiveSlice({id:e,index:t.index,slice:t}),this.fragMap.delete(e),M.delete(e),M.tick(),D.p2pEstimate&&D.p2pEstimate.delete(e)}_clearOutDateFrag(){this.fragMap.forEach(((e,t)=>{Date.now()-e.createTime>12e4&&this.fragMap.delete(t)}))}_setTimer(){this._clearTimer(),this._timer=setInterval(this._clearOutDateFrag.bind(this),_timer),this._timer=null)}};class Li{constructor(){this._retryTimes=new Map,this._updateTime=new Map,this._timer=setInterval((()=>{this._crval(this._timer),this._timer=null),this._retryTimes.clear(),this._updateTime.clear()}record(e){var t=this._retryTimes.get(e)||0;return this._retryTimes.set(e,t+1),this._updateTime.set(e,Date.now()),!0}queryReqTimes(e){return this._retryTimes.get(e)||0}_clearOutdated(){this._updateTime.forEach(((e,t)=>{Date.now()-e>12e4&&(this._retryTimes.delete(t),this._updateTime.delete(t))}))}}class Ai{constructor(e){this.TAG="BBSSubscriber",this.hlsp2p=e}setTransport(e){return this.transport=e,this}setBitmapMgr(e){return this.bitmapMgr=e,this}setPeerManager(e){return this.peerManager=e,this}setStats(e){return this._stats=e,this}init(){return this._clearTimer(),this.checkBuffer=this._checkBuffer.bind(this),this._checkBufferTimer=setInterval(this.checkBuffer,l.checkBufferInterval),this._p2pRequestId=new Map,this._reqRecorder=new Li,this}destroy(){this._clearTimer(),this._reqRecorder.destroy(),this._p2pRequestId.clear(),this.bitmapMgr=null,this.transport=null,this.peerManager=null,this.hlsp2p=null}_clearTimer(){this._checkBufferTimer&&(clearInterval(thirTimer=null)}onSliceRequest(e,t){var r=new Pi;r.unmarshall(t),this._stats[yi]+=1,this._sendPacket(e,r)}_sendPacket(e,t){var r=this;return J(Z().mark((function n(){var s;return Z().wrap((functirev=n.next){case 0:return n.next=2,xi.genPacketsFromSlice(t.ReqSn,t.ReqLevel,t.idx);case 2:if(s=n.sent){n.next=7;break}return r._stats[wi]+=1,n.abrupt("return");case 7:r._stats[bi]+=1,s.forEach(((t,n)=>{r.transport.sendBinary(e,t)}));case 9:case"end":return n.stop()}}),n)})))()}_checkBuffer(){if(!M.size()){if(0===this.peerManager.getAllConnectedPid().length)return!1;var e=this._findUnfilledSlice();if(e&&e.length){e.map((e=>`[${e.toString()}]`)).join(",");var t=this._filterExistP2PReq(e);this._sendSliceRequest(t)}}}_filterExistP2PReq(e){var t=[];return this._clearOutdatedP2PRequest(),e.forEach((e=>{this._p2pRequestId.has(e.toString())||this._reqRecorder.queryReqTimes(e.toString())>=l.bbsP2PMaxRetry||t.push(e)})),t}_clearOutdatedP2PRequest(){var e=Date.now();this._p2pRequestId.forEach(((t,r)=>{e-t>l.bbsP2PReqTimeout&&this._p2pRequestId.delete(r)}))}_sendSliceRequest(e){var t=[...this.peerManager.getConnectedPeers().keys()];if(t.length)for(;e.length;){var r=e.shift(),n=this._findPeerForRequestingSlice(t,r);==s&&(this._stats[At]+=1),this._reqRecorder.record(r.toString()),this._p2pRequestId.set(r.toString(),Date.now());var i=new Pi;i.init(r),this.transport.sendBinary(n,i.marshall())}}}_findPeerForRequestingSlice(e,t){for(var r=0;r<e.length;r++){var n=e[r];if(this._ensurePeerHasSlice(n,t))return e.push(e.splice(r,1)[0]),n;e.length&&(this._stats[Ri]+=1)}return null}_ensurePeerHasSlice(e,t){var r=this.bitmapMgr.getBitmap(e);return!!r&&r.hasSlice(t)}_findUnfilledSlice(){var e=D.curReqSn,t=D.curReqLevel;if(vt(new sn)for(var a=0;a<l.sliceCount;a+=1)!i.getSlice(a)&&s.length<l.p2pSliceRequestCount&&s.push(new Di({ReqSnthisurn`ostanceof IDBRequesteeded",(e=>{n(Vi(a.result),e.oldVersion,e.newVersion,Vi(a.transaction),e)})),r&&a.addEventListener(ctiJi.get(t))return Ji.get(t);const r=t.replace(/FromIndex$/,""),n=t!==r,s=Yi.includes(r);if(!(r in(n?IDBIndex:IDBObjectStore).prototype)||!s&&!Ki.includes(r))return;const i=async function(e,...t){const i=this.transaction(e,s?"readwrite":"readonly");let a=i.store;return n&&(a=a.index(t.shift())),(await Promise.all([a[r](...t),s&&i.done]))[0]};return Ji.set(t,i),i}ji=(e=>({...e,get:(t,r,n)=>Qi(t,r)||e.get(t,r,n),has:(t,r)=>!!Qi(t,r)||e.has(t,r)}))(ji);class Zi extends(t()){constructor(){super(),this._db=null,this._config=null}get db(){return this._db}getTransaction(e,t,r){if(!this._db)return null;try{returnrn this.getTransaction(e,"readonly",{durability:"relaxed"})}getWriteTransaction(e){return this.getTransaction(e,"readwrite",{durability:"relaxed"})}getReadStore(e){try{var t=this.getReadonlyTransaction(e);return t?t.objectStore(e):null}catch(e){return null}}getWriteStore(e){try{var t=this.getWriteTransaction(e);return t?t.objectStore(e):null}catch(e){return null}}destroy(){this._db&&(this._db.close(),this._db=null),super.removeAllListeners()}delete(){var e=this;return J(Z().mark((function t(){return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e._config){t.next=2;break}throw Error("missing idb config, call configure function first");case 2:return t.prev=2,e.destroy(),t.next=6,Xi(e._config.dbName,{blocked:(e,t)=>{}});case 6:t.next=11;break;case 8:t.prev=8,t.t0=t.catch(2);case 11:case"end":return t.stop()}}),t,null,[[2,8]])})))re(e){this._config=e}init(){var e=this;return J(Z().manction(t){for(t){case 0:if(e._config){t.next=2;break}throw Error("missing idb config, call configure function first");case 2:return t.prev=2,t.next=5,Wi(e._config.dbName,e._config.version,{upgrade:(t,r,n)=>{if(0===r)e._config.allStoreConfig.forEach((e=>{var r=ra(t,e);r&&ta(r,e.allIndexConfig)}))},blocked:(e,t)=>{},blocking:(e,t)=emit("error",t.target.error)},e._db.onclose=()=>{e.emit("close")},t.next=14;break;case 11:t.prev=11,t.t0=t.catch(2);case 14:case"end":return t.stop()}}),t,null,[[2,11]])})))()}}var ea,ta=(e,t)=>{t.forEach((t=>{try{e.createIndex(t.indexName,t.indexKeyPath,t.options)}catch(e){}}))},ra=(e,t)=>{try{return e.createObjectStore(t.storeName,t.storeOptions)}catch(e){return null}};class na{constructor(e){this.resId=e,this._chunks=new Map,this._maxSn=0}destroy(){this._chunks.clear()}getMaxSn(){return this._maxSn}getAllMeta(){return th(e.resChunkId,e)}getResChunkMeta(e){return this._chunks.get(`${e.resId}-${e.sn}-${e.level}`)}get hitCnt(){var e=0;return this._chunks.forEach((t=>{e+=t.hitCnt})),e}get latestUpdateTime(){var e=0;return this._chunks.forEach((t=>{t.updateTime>e&&(e=t.updateTime)})),e}get totalSize(){var e=0;return this._chunks.forEach((t=>{e+=t.dataLength})),e}get latestAccessTime(){var e=0;return this._chunks.forEach((t=>{t.accessTime>e&&(e=tnfig=null,this._resOperator=null,this._props={totalSizern this._resOperator=e,this}configure(e){return this._config=e,this}init(){return this}destroy(){this._localResourceIndexes.forEach((e=>{e.destroy()})ource(e){this._localResourceIndexes.delete(e),this._reCalculateTotalSize()}getResource(e){return this._localResourceIndexes.get(e)}getAllResourcesMeta(){return[...this._localResourceIndexes.values()]}getResourceChunkMeta(e){var t;return null===(t=this._localResourceIndexes.get(e.resId))||void 0===t?void 0:t.getResChunkMeta(e)}updateResourceChunkMeta(e){var t;null===(t=this._localResourceIndexes.get(e.resId))||void 0===t||t.setResChunkMeta(e)}addResourceChunkMeta(e){var t=this._localResourceIndexes.get(e.resId);t||(t=new na(e.resId),this._localResourceIndexes.set(e.resId,t)),t.getResChunkMeta(e)||(this._props.totalSize+=e.dataLength),t.setResChunkMeta(e)}existsChunk(e){var t;return!(null===(t=this._localResourceIndexes.get(e.resId))||void 0===t||!t.getResChunkMeta(e))}totalSize(){return this._props.totalSize}refresh(){var e=this;return J(Z().mark((function t(){var r;return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(Date.now()-e._lastRefreshTime>3e4)){t.next=4;break}e._lastRefreshTime=Date.now(),t.next=5;break;case 4:return t.abrupt("return",!1);case 5:return t.prev=5,t.next=8,e._resOperator.getAllResourceMeta()return e._update(r),e._ready=!0,t.abrupt("return",!0);case 13:t.next=19;break;case 15:return t.prev=15,t.t0=t.catch(5),t.abrupt("return",!1);case 19:case"end":return t.stop()}}),t,null,[[5,15]])})))()}_update(e){this._localResourceIndexes.clear(),e.forEach((e=>{this.addResourceChunkMeta(e)})),this._reCalculateTotalSize()}_reCalculateTotalSize(){this._props.totalSize=0,this._localResourceIndexes.forEach((e=>{this._props.totalSize+=e.totalSize}))}}class ia{static LoadFromDB(e,t){return J(Z().mark((function r(){var n,s;return Z().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(e){r.next=2;break}return r.abrupt("return",null);case 2:return n=[],r.next=5,e.openCursor(t);case 5:s=r.sent;case 6:if(!s){r.next=13;break}return n.push(s.value),r.next=10,s.continue();case 10:s=r.sent,r.next=6;break;case 13:return r.abrupt("return",n);case 14:case"end":return r.stop()}}),r)})))()}}class aa{constructor(){this._idbProxy=null,this._config=null}setIDB(e){return this._idbProxy=e,this}configure(e){return this._config=e,this}init(){return this}destroy(){this._idbProxy=null}add(e){var t=this;return J(Z().mark((function r(){var n,s,i;return Z().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(e.createChunkId(),n=t.getStoresInSameTransaction()){r.next=4;break}return r.abrupt("return",null);case 4:return s=n.metaStore,i=n.dataStore,r.prev=5,r.next=8,s.add(e.getPlainMetaObj());case 8:return r.next=10,i.add(e.getPlainDataObj());case 10:return r.abrupt("return",e);case 13:return r.prev=13,r.t0=r.catch(5),r.abrupt("return",null);case 17:case"end":return r.stop()}}),r,null,[[5,13]])})))()}updateResourceMeta(e,t){var r=this;return J(Z().mark((function n(){var s,i,a;return Z().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(n.prev=0,i=t||(null===(s=r._idbProxy)||void 0===s?void 0:s.getWriteStore(r._config.metaStoreName))){n.next=5;break}return n.abrupt("return",null);case 5:return n.next=7,i.put(e);case 7:return a=n.sent,n.abrupt("return",a);case 12:return n.prev=12,n.t0=n.catch(0),n.abrupt("return",null);case 16:case"end":return n.stop()}}),n,null,[[0,12]])})))()}getAllResourceMeta(){var e=this;return J(Z().mark((function t(){var r,n;return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=null===(r=e._idbProxy)||void 0===r?void 0:r.getReadStore(e._config.metaStoreName),t.next=3,ia.LoadFromDB(n,null);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),t)})))()}getResourceMeta(e,t){var r=this;return J(Z().mark((function n(){var s,i,a;return Z().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(s=`${e.resId}-${e.sn}-${e.level}`,n.prev=1,a=t||(null===(i=r._idbProxy)||void 0===i?void 0:i.getReadStore(r._config.metaStoreName))){n.next=5;break}return n.abrupt("return",null);case 5:return n.next=7,a.index("resChunkId").get(s);case 7:if(n.t0=n.sent,n.t0){n.next=10;break}n.t0=null;case 10:return n.abrupt("return",n.t0);case 13:return n.prev=13,n.t1=n.catch(1),n.abrupt("return",null);case 17:case"end":return n.stop()}}),n,null,[[1,13]])})))()}getData(e,t){var r=this;return J(Z().mark((function n(){var s,i,a;return Z().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(s=`${e.resId}-${e.sn}-${e.level}`,n.prev=1,a=t||(null===(i=r._idbProxy)||void 0===i?void 0:i.getReadStore(r._config.dataStoreName))){n.next=5;break}return n.abrupt("return",null);case 5:return n.next=7,a.index("resChunkId").get(s);case 7:if(n.t0=n.sent,n.t0){n.next=10;break}n.t0=null;case 10:return n.abrupt("return",n.t0);case 13:return n.prev=13,n.t1=n.catch(1),n.abrupt("return",null);case 17:case"end":return n.stop()}}),n,null,[[1,13]])})))()}delete(e){var t=this;return J(Z().mark((function r(){var n,s,i;return Z().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(n=t.getStoresInSameTransaction()){r.next=3;break}return r.abrupt("return",null);case 3:return s=n.metaStore,i=n.dataStore,r.prev=4,r.next=7,t._deleteResourceFromStore("resId",e,s);case 7:return r.next=9,t._deleteResourceFromStore("resId",e,i);case 9:r.next=14;break;case 11:r.prev=11,r.t0=r.catch(4);case 14:case"end":return r.stop()}}),r,null,[[4,11]])})))()}_deleteResourceFromStore(e,t,r){return J(Z().mark((function n(){var s,i;return Z().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return s=r.index(e),n.next=4,s.openCursor(IDBKeyRange.only(t));case 4:i=n.sent;case 5:if(!i){n.next=13;break}return n.next=8,i.delete();case 8:return n.next=10,i.continue();case 10:i=n.sent,n.next=5;break;case 13:case"end":return n.stop()}}),n)})))()}getStoresInSameTransaction(){var e,t=this._config,r=t.metaStoreName,n=t.dataStoreName,s=null===(e=this._idbProxy)||void 0===e?void 0:e.getWriteTransaction([r,n]);if(!s)return null;var i=s.objectStore(r),a=s.objectStore(n);return i&&a?{metaStore:i,dataStore:a}:null}}function oa(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return la(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return la(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,s=function(){};return{s,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,o=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){o=!0,i=e},f:function(){try{a||null==r.return||r.return()}finally{if(o)throw i}}}}function la(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var ha=function(){return(ea=ea||J(Z().mark((function e(){return navigator.storage||!navigator.storage.estimate){e.next=2;break}return e.abrupt("return",self.navigator.stoesourceIndexes=null,this._manager=null,this._config=null,this._storageEstimate={result:null,support:!1},this._evicting=!1}setParam(e,t){return this._resourceIndexes=e,this._manager=t,this}configure(e){return this._config=e,this}init(){var e=this;return J(Z().mark((function t(){return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.estimateQuota();case 2:return t.abrupt("return",e);case 3:case"end":return t.stop()}}),t)})))()}destroy(){}evictResource(){var e=this;return J(Z().mark((function t(){var r;return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e._evicting){t.next=2;break}return t.abrupt("return","doing");case 2:if(e._evicting=!0,t.prev=3,r=e._selectResourceForEvicting()){t.next=9;break}return e._evicting=!1,t.abrupt("return","nothing");case 9:return t.next=11,e._manager.deleteRes(r);case 11:return t.next=13,e._manager.refreshMemoryIndex();case 13:return t.next=15,e.estimateQuota();case 15:return e._evicting=!1,t.abrupt("return","success");case 20:return t.prev=20,t.t0=t.catch(3),e._evicting=!1,t.abrupt("return","error");case 25:case"end":return t.stop()}}),t,null,[[3,20]])})))()}quotasAvailable(){if(this._evicting)return null;if(this._storageEstimate.support&&!this._storageEstimate.result)return null;if(!this._resourceIndexes.ready())return null;var e=this._config,t=e.maxStorageAvailableRatio,r=e.maxIndexeddbStoreSize;if(this._resourceIndexes.totalSize()>r*t)return"out_of_config";if(this._storageEstimate.support){var n=this._storageEstimate.result,s=n.quota;if(n.usage>s*t)return"out_of_quota"}return"ok"}estimateQuota(){var e=this;return J(Z().mark((function t(){var r;return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,ha();case 2:if(r=t.sent){t.next=6;break}return e._storageEstimate.support=!1,t.abrupt("return");case 6:e._storageEstimate.support=!0,e._storageEstimate.result=r;case 8:case"end":return t.stop()}}),t)})))()}getUsedPer(){var e=0,t=this._storageEstimate,r=t.support,n=t.result;r&&n&&n.quota&&(e=n.usage/n.quota);var s=0;return this._config.maxIndexeddbStoreSize&&(s=this._resourceIndexes.totalSize()/this._config.maxIndexeddbStoreSize),Math.round(100*Math.max(e,s))}_selear e=this._resourceIndexes.getAllResourcesMeta();if(0===e.length)return"";e.sort(((e,t)=>e.latestAccessTime-t.latestAccessTime));var t,r=;){var n=t.value;if(0===n.latestAccessTime&&Date.now()-n.latestUpdateTime>this._config.newResEvictProWindow||n.latestAccessTime>0&&Date.now()-n.latestAccessTime>this._config.coldResEvictThreshold)return n.resId}}catch(e){r.e(e)}finally{r.f()}e.sort(((e,t)=>e.hitCnt-t.hitCnt));for(var s=e[0],i=0;i<e.length;i++)if(Date.now()-s.latestUpdateTime>this._config.newResEvictProWindow)return s.resId;return""}}class ua{static create(e){return new ua(e)}constructor(e){this.props={resId:e.resId||"",sn:e.sn||0,level:e.level||0,resChunkId:e.resChunkId||"",data:e.dataObj(){return{resId:this.:this.props.updateTime,accessTime:this.props.accessTime,checksum:this.props.checksum,plainChecksum:this.props.plainChecksum}}getPlainDataObj(){return{resId:this.props.resId,sn:this.props.sn,level:this.props.level,resChunkId:this.props.resChunkId,data:this.props.data}}createChecksum(){return""}createPlainChecksum(){return""}createChunkId(){return`${this.props.resId}-${this.props.sn}-${this.props.level}`}createCurrentTime(){return Date.now()}}var da="store_size",pa="store_res_cnt",fa="quota_used_per",ga="idb_quota_exceeded",va="idb_close",ma="res_del_estimate",_a="res_del_config",ya="res_del_max_cnt",ba="res_del_tnt",wa="res_useless_cnt",Ra="res_hit_cnt",Ta="res_add_cnt";class Ca extends(t()){constructor(){super(),this._idb=new Zi,this._resourceIndexes=new sa,this._operator=new aa,this._quotasManager=new ca,this._ready=!1,this._destroyed=!1}configure(e){return this._config=e,this._idb.configure(e),this._resourceIndexes.configure(e),this._operator.configure(e),this._quotasManager.configure(e),this}init(){var e=this;return J(Z().mark((fuwrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e._initStats(),t.next=3,e._idb.init();case 3:return e._operator.setIDB(e._idb).init(),e._resourceIndexes.setResourceOperator(e._operator).init(),t.next=7,e._quotasManager.setParam(e._resourceIndexes,e).init();case 7:return e._idb.on("error",(t=>{"QuotaExceededError"===t.name&&(e._stats[ga]+=1,e._quotasManager.evictResource().then((e=>{})))})),e._idb.on("close",(()=>{e._stats[va]+=1})),t.next=11,e._resourceIndexes.refresh();case 11:t.sent&&(e._ready=!0,e.emit("ready"));case 13:case"end":return t.stop()}}),t)})))()}destroy(){this._destroyed=!0,super.removeAllListeners(),this._idb.destroy(),this._resourceIndexes.destroy(),this._quotasManager.destroy(),this._operator.destroy()}add(e){var t=this;return J(Z().mark((function r(){var n,s,i;return Z().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(t._ready){r.next=3;break}return r.abrupt("return",!1);case 3:if(!t._resourceIndexes.existsChunk(e)){r.next=6;break}return r.abrupt("return",!1);case 6:if(null!==(n=t._quotasManager.quotasAvailable())){r.next=10;break}return r.abrupt("return",!1);case 10:if("ok"===n){r.next=14;break}return t._quotasManager.evictResource().then((e=>{"success"===e&&("out_of_quota"===n&&(t._stats[ma]+=1),"out_of_config"===n&&(t._stats[_a]+=1))})),r.abrupt("return",!1);case 14:if(t._resourceIndexes.getAllResourcesMeta().length>=t._config.maxStoreResCnt&&!t._resourceIndexes.getResource(e.resId)&&t._quotasManager.evictResource().then((e=>{"success"===e&&(t._stats[ya]+=1)})),t._resourceIndexes.getResource(e.resId)||!(t._resourceIndexes.getAllResourcesMeta().length>=t._config.maxStoreResCnt)){r.next=18;break}return r.abrupt("return",!1);case 18:return t._resourceIndexes.getResource(e.resId)||(t._stats[Ta]+=1),s=ua.create(e).setup(),r.next=22,t._operator.add(s);case 22:if(i=r.sent,!t._destroyed){r.next=25;break}return r.abrupt("return",!1);case 25:if(!i){r.next=29;break}return t._resourceIndexes.addResourceChunkMeta(i.getPlainMetaObj()),t._quotasManager.estimateQuota().then((()=>{})),r.abrupt("return",!0);case 29:return r.abrupt("return",!1);case 30:case"end":return r.stop()}}),r)})))()}get(e){var t=this;return J(Z().mark((function r(){var n,s,i,a,o;return Z().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(t._ready){r.next=3;break}return r.abrupt("return",null);case 3:if(n=t._operator.getStoresInSameTransaction()){r.next=7;break}return r.abrupt("return",null);case 7:return s=n.dataStore,i=n.metaStore,r.prev=8,r.next=11,t._operator.getData(e,s);case 11:a=r.sent,r.next=18;break;case 14:return r.prev=14,r.t0=r.catch(8),r.abrupt("return",null);case 18:if(a){r.next=24;break}if(!t._resourceIndexes.getResourceChunkMeta(e)){r.next=22;break}return r.next=22,t._resourceIndexes.refresh();case 22:case 45:return r.abrupt("return",null);case 24:r.prev=24,o=t._resourceIndexes.getResourceChunkMeta(e),r.next=32;break;case 28:return r.prev=28,r.t1=r.catch(24),r.abrupt("return",null);case 32:if(o){r.next=35;break}return r.abrupt("return",null);case 35:if(!t._destroyed){r.next=37;break}return r.abrupt("return",null);case 37:return o.hitCnt+=1,o.accessTime=Date.now(),r.next=41,t._operator.updateResourceMeta(o,i);case 41:if(!r.sent){r.next=45;break}return t._resourceIndexes.updateResourceChunkMeta(o),r.abrupt("return",Object.assign(a,o));case 47:case"end":return r.stop()}}),r,null,[[8,14],[24,28]])})))()}deleteRes(e){var t=this;return J(Z().mark((function r(){var n,s,i;return Z().wrap((funct_stat.delete(e);case 8:null===(s=t._resourceIndexes)||void 0===s||s.deleteResource(e);case 9:case"end":return r.stop()}}),r)})))()}refreshMemoryIndex(){var e=this;return J(Z().mark((function t(){return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e._resourceIndexes.refresh();case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t)})))()}has(e){return!!th_operator.getStoresInSameTransaction(),s=t._operator.getResourceMeta(e,n.metaStore),i=t._operator.getResourceMeta(e,n.dataStore),r.next=5,Promise.all([s,i]);case 5:return a=r.sent,r.abrupt("return",a[0]&&a[1]);case 7:case"end":return r.stop()}}),r)})))()}getResIndex(e){var t;return null===(t=this._resourceIndexes)||void 0===t?void 0:t.getResource(e)}getAllResIndex(){return this._resourceIndeady}getStats(){var e,t=this._stats;return t[da]=null===(e=this._resourceIndexes)||void 0===e?void 0:e.totalSiya]:0,[ba]:0,[wa]:0,[Ra]:0,[Ta]:0}}}class Sa{setLocalResourceManager(e){return this.lrMgr=e,this}configure(){}init(){tn.registerModule("ResStoreProxy",this.reportCallback.bind(this))}destroy(){}has(e){return this.lrMgr.has(e)}get(e){var t=this;return J(Z().mark((function r(){return Z().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,t.lrMgr.get(e);case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}}),r)})))()}set(e){var t=this;return J(Z().mark((function r(){return Z().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(t._allowStore()){r.next=3;break}return r.abrupt("return");case 3:if(t._decideIfStoreRes(e)){r.next=6;break}return r.abrupt("return");case 6:return e.data=e.data.p()}}),r)})))()}getResMeta(e){return this.lrMgr.getResIndex(e)}_decideIfStoreRes(e){var t;return this.gid||(this.gid=(t=l.resModBase,Math.floor(Math.random()*t))),!(!Sa.isTinyRes()||!l.enableStoreAllTinyRes)||e.sn%l.resModBase===this.gid}_allowStore(){return"VOD"===l.videoType&&(!!l.enableStoreRes&&(!!D.totalDuration&&(!(!Sa.isTinyRes()||!l.enableStoreTinyRes)||!Sa.isTinyRes())))}static isTinyRes(){return D.totalDuration<l.tinyResMaxDuration}reportCallback(){return this.lrMgr.getStats()}}var Ia={metaStoreName:"meta_store",dataStoreName:"data_store"},ka={dbName:"xp2p_hls_vod_db",version:1,allStoreConfig:[{storeName:Ia.dataStoreName,storeOptions:{keyPath:"resChunkId"},allIndexConfig:[{indexName:"resId",indexKeyPath:"resId",options:{multiEntry:!1,unique:!1}},{indexName:"sn",indexKeyPath:"sn",options:{multiEntry:!1,unique:!1}},{indexName:"level",indexKeyPath:"level",options:{multiEntry:!1,unique:!1}},{indexName:"resChunkId",indexKeyPath:"resChunkId",options:{multiEntry:!1,unique:!0}}]},{storeName:Ia.metaStoreName,storeOptions:{keyPath:"resChunkId"},allIndexConfig:[{indexName:"resId",indexKeyPath:"resId",options:{multiEntry:!1,unique:!1}},{indexName:"sn",indexKeyPath:"sn",options:{multiEntry:!1,unique:!1}},{indexName:"level",indexKeyPath:"level",options:{multiEntry:!1,unique:!1}},{indexName:"resChunkId",indexKeyPath:"resChunkId",options:{multiEntry:!1,unique:!0}},{indexName:"updateTime",indexKeyPath:"updateTime",options:{multiEn"accessTime",options:{multiEntry:!1,ut",indexKeyPath:"hitCnt",options:{multiEntry:!1,unique:!1}}]}]},Ea="lrs_p2p_recv_req",Pa="lrs_p2p_resp_ok",xa="lrs_p2p_resp_miss",La="lrs_upload_bytes",Aa="lrs_serv_res",Da="lrs_connected",Ma="lrs_conn_suc",Oa="lrsconn_init_timeout",Ba="lrs_conn_dc_closed";class Na extends fi{constructor(e){super(e),this.TAG="LRSServePeerManager"}setStats(e){return this._stats=e,this}init(){return super.init()}_checkPeers(){}canConnect(){return this._connected.size<l.lrsMaxPCConnected&&this._connecting.size<l.lr?this.emit(e,t):super._trigger(e,t)}_beforeSendingSignal(e){e.resId=this.getResId()}reportCallback(){var e=super.reportCallback(),t=this._stats;return t[Da]+=e[he],t[Ma]+=e[de],t[Oa]+=e[fe],t[qa]+=e[we],t[Ua]+=e[be],t[Ba]+=e[ye],null}}class Fa{constructor(){this.router=null}setRouter(e){return this.router=e,this}setLRSSubscriber(e){return is.router.registerCb(ee.SLICE_REQUEST,this.onSliceRequest.bind(this))}destroy(){this.router=null}onSliceRequest(e,t){this.lrsSubscriber.onSliceRequest(e,t)}}var $a="user_abort",ja="reach_max_retry",Ha="timeout";class Ga{constructor(){this._input=null,this._init={},this._config=nul=null,this._props={retryTimes:0}}configure(e,t,r){return this._config=t,this._input=e,this._init=r||{},this}send(){return this._createFetch()}_createFetch(){var e=this;return J(Z().mark((function t(){var r,n;return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return self.AbortController&&(e._abortController=new self.AbortController,e._init.signal=e._abortController.signal),r=new Promise(((t,r)=>{setTimeout((()=>{r(new Error(Ha))}),e._config.msTimeout)})),n=self.fetch(e._input,e._init),t.prev=3,t.next=6,Promise.race([r,n]);case 6:case 15:return t.abrupt("return",t.sent);case 9:if(t.prev=9,t.t0=t.catch(3),"AbortError"!==t.t0.name){t.next=13;break}return t.abrupt("return",Promise.reject(t.t0));case 13:return t.next=15,e._retry();case 16:case"end":return t.stop()}}),t,null,[[3,9]])})))()}_retry(){var e=this;return J(Z().mark((function t(){return Z().wrap((function(t){for(;;)switch(t.prev=t.next){cak}return t.abrupt("return",1,t.next=5,e._createFetch();case 5:return t.abrupt("return",t.sent);case 6:case"end":return t.stop()}}),t)})))()}abort(){var e;null===(e=this._abortController)||void 0===e||e.abort(new Error($a)),this._config=null,this._init=null,this.r=null,this._fetchIns=null}configure(e){this._config=e}init(){return this}destroy(){this._fetchIns.abort(),this.stop()}start(){this._clearTimer(),this.request(),this._config.requestInterval&&(this._timer=setInterval((()=>{this.request()}),this._config.reqclearTimer()}createRequestInput(){return this._config.createFetchInput()}createRequestInit(qu._config.timeout,maxRetryTimes:this._config.maxRetryTimes},r=this.createRequestInit(),n=new Ga;this._fetchIns=n;var s=n.configure(e,t,r).send();this.processFetchResp(s)}processFetchResp(e){e.then((e=>e.ok?e:Promise.reject(e))).then((e=>{var t;null===(t=this._config.responseParser)||void 0===t||t.parse(e)})).catch((e=>{var t;null===(t=this._config.responseParser)||void 0===t||t.error(e)}))}_clearTimer(){this._timer&&clearInterval(this._timer)}}class za{constructor(){this._senew Va}c.resId,s=t.currentTime;return this._serviceequestInterval,createFetchInput:()=>es(e,{currentTime:s(),localPeerId:r,channelId:n}).url,responseParser:{parse:e=>J(Z().mark((function t(){return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.json();case 2:t.sent;case 4:case"end":return t.stop()}}),t)})))(),error(e){}}}),this}init(){this{constructor(){this.TAG="LRSSubscriber",this._destroyed=!1}setLRSServePeerManager(e){return this.peerMgr=e,this}setTransport(e){return this.transport=e,this}setLocalResourceManager(e){return this.localResMgr=e,this}setStats(e){return this._stats=e,this}init(){this.peerMgr.on(R.PEER_CONNECTED,(e=>{var t=e.pid;this._sendBaseInfo(t),this._sendBitmap(t,this.peerMgr.getResId())}))}destroy(){this._destroyed=!0,this.transport=null,this.peerMgr=null}onSliceRequest(e,t){var r=this;return J(Z().mark((function n(){var s;return Z().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return(s=new Pi).unmarshall(t),r._stats[Ea]+=1,n.next=6,r._createPacketResponse(e,s);case 6:if(n.sent){n.next=11;break}return r._stats[xa]+=1,n.abr1;case 13:case"urn n.stop()}}),n)})))()}_createPacketResponse(e,t){return this.localResMgr?this.localResMgr.get({resId:this.peerMgr.getResId(),sn:t.ReqSn,level:t.ReqLevel}).then((r=>{if(this._destroyed)return null;if(!r)return null;if(!r.data)return null;this._stats[La]+=r.data.byteLg=ne,n.segmentSliceToPacket().forEach((t=>{this.transport.sendBinary(e,t)})),!0})).catch((e=>null)):Promise.reject(null)}_createBitmap(e){if(!this.localResMgr)return null;var t=new Ii,r=this.localResMgr.getResIndex(e);return r?(r.getAllMeta().forEach((e=>{var r=new ae;r.sn=e.sn,r.level=e.level,r.subIndexes.push(0),t.bufferInfo.push(r)})),t.marshall()):t.marshall()}_sendBitmap(e,t){var r=this._createBitmap(t);r&&this.transport.sendBinary(e,r)}_sendBaseInfo(e){var t=new mi;t.peerType=vi,this.transport.sendBinary(e,t.marshall())}}class Xa{constructor(e){this.hlsp2p=e,this.router=new ds,this.transport=new ps,this.peerMgr=new Na(e),this.server=new Fa,this.tracker=new za,this.subscriber=new Wa}setStats(e){return this._stats=e,this}setResId(e){return this.resId=e,this}setLocalResourceManager(e){return this.localResourceMgr=e,this}init(){this.transport.setPeerManager(this.peerMgr),tTs.subscriber).init(),this.subscriber.setTransport(this.transport).setLRSServePeerManager(this.peerMgr).setStats(this._stats).setLocalResourceManager(this.localResourceMgr).init(),this.hlsp2p.localPeerId?this._initTracker(this.hlsp2p.localPeerId):this.hlsp2p.on(T.SIGNAL_READY,(e=>{var t=e.pid;this._initTracker(t)}))}destroy(){this.transport.destroy(),this.peerMgr.destroy(),this.server.destroy(),this.subscriber.destroy(),this.tracker.destroy()}_initTracker(e){this.tracker.configure({vodTrackerServer:l.vodTrackerServer,vodTrackerVersion:l.vodTrackerVersion,cloudAppId:l.cloudAppId,requestInterval:l.trackerInterval},{localPeerId:e,resId:this.resId,currentTime:()=>{if(!this.localResourceMgr)return 0;var e=this.localResourceMgr.getResIndex(this.resId);return e?10*e.getMaxSn():0}}).init()}}class Ka{constructor(e){this.hlsp2p=e,this.lrsModules=new Map,this._reportData={}}init(){if(l.enableStoreRes){tn.registerModule("LRSInitiator",this.reportCallback.bind(this)),this.initReport(),this.localResourceManager=new Ca,this.lrProxy=new Sa,this.lrProxy.setLocalResourceManager(this.localResourceManager).init(),ln.setResStoreProxy(this.lrProxy);var e=Object.assign(ka,Ia,{maxStoreResCnt:l.maxStoreResCnt,maxIndexeddbStoreSize:l.maxIndexeddbStoreSize,maxStorageAvailableRatio:l.maxStorageAvailableRatio,newResEvictProWindow:l.newResEvictProWindow,coldResEvictThreshold:l.coldResEvictThreshold});this.localResourceManager.configure(e).on("ready",(()=>{this.initLRSModule()})).init().catch((e=>{}))}}initLRSModule(){if(l.enableLRS)for(var e=this.localResourceManager.getAllResIndex(),t=0;t<Math.min(e.length,l.maxStoreResCnt);t++){var r=e[t];if(r.resId!==l.channelId){var n=new Xa(this.hlsp2p);n.setLocalResourceManager(this.localResourceManager).setStats(this._reportData).setResId(r.resId).init(),this.lrsModules.set(r.resId,n)}}}destroy(){this.localResourceManager&&(this.localResourceManager.destroy(),this.localResourceManager=null),this.lrsModules&&(this.lrsModules.forEach((e=>{e.destroy()})),this.lrsModules.clear()),this.lrProxy&&(this.lrProxy.destroy(),this.lrProxy=null),this.hlsp2p=null}initReport(){var e=this._reportData;e[Ea]=0,e[Pa]=0,e[xa]=0,e[La]=0,e[Da]=0,e[Ma]=0,e[Oa]=0,e[qa]=0,e[Ua]=0,e[Ba]=0}reportCallback(){var e=JSON.parse(JSON.stringify(this._reportData));return this.lrsModules&&(e[Aa]=this.lrsModules.size),this.initReport(),e}}class Ya{constructor(e){this.hlsp2p=e,this.router=new ds,this.transport=new ps,this.peerManager=new Ci(e),this.bitmapMgr=new Ei(e),this.packetMgr=new xi,this.bbsSubscriber=new Ai(e),this.bbsServer=new Si,this._reportData={}}init(){tn.registerModule("BBSModule",this.reportCallback.bind(this)),this.initReport(),this.transport.setPeerManager(this.peerManager),this.bitmapMgr.setTransport(this.transport).setPeerManager(this.peerManager).init(),this.packetMgr.init(),this.peerManager.setRouter(this.router).setTransport(this.transport).setBitmapMgr(this.bitmapMgr).setP2PStats(this.hlsp2p.p2pStats).setResId(l.channelId).init(),this.bbsSubscriber.setTransport(this.transport).setBitmapMgr(this.bitmapMgr).setPeerManager(this.peerManager).setStats(this._reportData).init(),this.bbsServer.setRouter(this.router).setVodPeerManager(this.peerManager).setPacketMgr(this.packetMgr).setBitmapMgr(this.bitmapMgr).setBBSSubscriber(this.bbsSubscriber).init(),l.enableStoreRes&&(this.lrsInitiator=new Ka(this.hlsp2p),this.lrsInitiator.init())}destroy(){this.router.destroy(),this.router=null,this.transport.destroy(),this.transport=null,this.bitmapMgr.destroy(),this.bitmapMgr=null,this.packetMgr.destroy(),this.packetMgr=null,this.bbsServer.destroy(),this.bbsServer=null,this.bbsSubscriber.destroy(),this.bbsSubscriber=null,this.peerManager.destroy(),this.peerManager=null,this.lrsInitiator&&(this.lrsInitiator.destroy(),this.lrsInitiator=null),this.hlsp2p=null}initReport(){var e=this._reportData;e[yi]=0,e[bi]=0,e[wi]=0,e[Ri]=0,e[kortCallback(){var e=JSON.parse(JSON.stringify(this._reportData));return this.initReport(),e}}class Ja{constructor(){this.uri=ee.RTT_REQ,this.roundId=0}marshall(){var e=new te;return e.setUri(this.uri),e.pushUInt8(this.roundId),e.marshall()}unmarshall(e){this.roundId=e.popUInt8()}}class Qa{constructor(){this.tasks=new Set}destroy(){this.flushAllTask()}addTask(e){e.setExecCb((e=>{this.tasks.delete(e)})),tTask(){this.tasks.forEach((e=>{e.destroy()})),this.tasks.cl_done=!1,this._action=t,this._execCb=null}destroy(){this.done(),this._action=null}setExechis._action&&this._action(),this._execCb&&this._execCb(this)}}class eo extends Za{constr:t}),this._setTimeout(r)}destroy(){super.destroy(),this._clearTimeout()}_setTimeout(e){"number"==typeof e&&(this._timer=setTimeout((()=>{this._timer=null,this._done||this.exec()}),e))}_clearTimeout(){this._timer&&(clearTimeout(this._timer),this._timer=null)}}class to{constructor(){this.uri=ee.RTT_RESe.setUri(this.uri),e.pushUInt8(this.roundId),e.marshall()}unmarshall(e){this.roundId=e.popUInt8()}}class ro{constructor(e){var t=e.id,r=e.sampleCount,n=e.finishedCb;this._id=t,this._sampleCount=r,this._cnt=0,this._minRTT=1/0,this._finishedCb=n,this._round=new Map}setMin(e){e<this._minRTT&&(this._minRTT=e),this._cnt+=1,this._cnt===this._sampleCount&&this._finishedCb({id:this._id,rtt:this._minRTT})}start(e){this._round.set(e,performance.now())}end(e,t){if(this._round.has(e)){var r=performance.now()-this._round.get(e)-t;this.setMin(r)}}}class no{constructor(e){this.TAG="RTTDetector",w Qa,this.rttRecords=new Map}destroy(){this.taskScheduler.destroy(),this.hlsp2p=null,this._transport=null,this._router=null}setTransport(e){return this._transport=e,this}setRouter(e){return this._router=e,this}init(){this._router.registerCb(ee.RTT_REQ,this._recvPingReq.bind(this)),this._router.registerCb(ee.RTT_RES,this._recvPingRes.bind(this))}ping(e){this.rttRecords.has(e)||this._createPingTask(e).forEach((e=>{this.taskScheduler.addTask(e)}))}_createPingTask(e){for(var t=this,r=[],n=function(n){var s=new eo({timeout:1e3*n,cb:()=>{t._sendPingReq(e,{pingIndex:n+1})}});r.push(s)},s=0;s<4;s++)n(s);return r}_sendPingReq(e,t){var r=t.pingIndex,n=new Ja;this._getRecordByPid(e).start(r),n.roundId=r,this._transport&&this._transport.sendBinary(e,n.marshall())}_recvPingReq(e,t){var r=new Ja;r.unmarshall(t),this._sendPingRes(e,{roundId:r.RecordByPid(e).end(r.roundId,0)}_getRecordByPid(e){var t=this.rttRecords.get(e);return t||(t=new ro({id:e,sampleCount:4,finishedCb:t=>{var r=t.id,n=t.rtt;this.hlsp2p.trigger(R.RTT_GOT,{pid:r,rtt:n}),this.rttRecords.delete(e)}}),this.rttRecords.set(e,t)),t}}class so{constructor(e){this.hlsp2p=e,this.minRTT=new Map,this.rttDetector=new no(this.hlsp2p)}destroy(){this.rttDetector.destroy(),this._transport=null,this._router=null,this.hlsp2p=null}setTransport(e){return this._transport=e,this}setRouter(e){return this._router=e,this}init(){this.rttDetector.setRouter(this._router).setTransport(this._transport).init(),this.hlsp2p.on(R.RTT_GOT,(e=>{var t=e.pid,r=e.rtt;this.minRTT.set(t,r),this._filterByRTT({pid:t,rtt:r})}))}addPeer(e){this.rttDetector.ping(e)}_filterByRTT(e){var t=e.pid,r=e.rtt;this.hlsp2p&&(r<=l.LNSRttThreshold?(X.log(`[p2p] [rtt filter] èŠ‚ç‚¹: ${t} rtt: ${r} æ»¡è¶³å±€åŸŸç½‘rttç­›é€‰`),this.hlsp2p.trigger(R.PEER_FILTER_PASSED,{pid:t})):(X.log(`[p2p] [rtt filter] èŠ‚ç‚¹: ${t} rtt: ${r} æœªæ»¡è¶³å±€åŸŸç½‘rttç­›é€‰`),this.hlsp2p.trigger(R.PEER_FILTER_BLOCKED,{pid:t})))}}function io(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return ao(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return ao(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,s=function(){};return{s,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:functInvalid attempt to iterate non-iterable instance.\nIn order to be iterable, nont n()}finally{if(o)throw i}}}}function ao(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}class oo{static create(e){return e?new oo(e):null}constructor(e){this._strAddr=e}addrArray(){return this._strAddr.split(".").map((e=>parseInt(e,10)))}isValid(){return/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(this._strAddr)}isPrivate(){this._privateAddrs=[[new oo("10.0.0.0"),new oo("10.255.255.255")],[new oo("100.64.0.0"),new oo("100.127.255.255")],[new oo("172.16.0.0"),new oo("172.31.255.255")],[new oo("192.0.0.0"),new oo("192.0.0.255")],[new oo("192.168.0.0"),new oo("192.168.255.255")],[new oo("198.18.0.0"),new oo("19n()).done;){var r=e.value,n=r[0],s=r[1];if(this.gte(n)&&this.lte(s))return!0}}catch(e){t.e(e)}finally{t.f()}return!1}sameNetworkSegment(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this._categoryDefaultCIDR={A:8,B:16,C:24};var r=this.category();if(r!==e.category())return!1;for(var n=this.addrArray(),s=e.addrArray(),i=0;i<(t||this._categoryDefaultCIDR[r])/8;i++)if(n[i]!==s[i])return!1;return!0}gte(e){return this.compare(e)>=0}lte(e){return this.compare(e)<=0}category(){this._category=[{type:"A",range:[new oo("1.0.0.1"),new oo("127.255.255.254")]},{type:"B",range:[new oo("128.0.0.1"),new oo("191.255.255.254")]},{type:"C",range:[new oo("192.0.0.1"),new oo("223.255.255.254")]}];var e,t=io(this._category);try{fo=r.range[0],s=r.range[1];if(this.gte(n)&&this.lte(s))return r.type}}catch(e){t.e(e)}finally{t.f()}return""}compare(e){for(var t=this.addrArray(),r=e.addrArray(),n=0;n<4;n++){if(t[n]>r[n])return 1;if(t[n]<r[n])return-1}return 0}}class lo{constructor(e){this.candidate=new RTCIceCandidate({candidate:e,sdpMLineIndex:0,sdpMid:"0"})}type(){var e=this.candidate.address;return e?-1!==e.indexOf("local")?"mdns":-1!==e.indexOf(":")?"IPv6":"IPv4":null}address(){return this.candidate.address}}function ho(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return co(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return co(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,s=function(){};return{s,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:funct be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,o=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e==r.return||r.return()}finally{if(o)throw i}}}}function co(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}class uo{constructor(){this.local=new Map,this.remote=new Map}destroy(){this.local.clear(),this.remote.clear()}addLocal(e){this.hasLocal(e)||this.local.set(e.address(),e)}addRemote(e){this.hasRemote(e)||this.remote.set(e.address(),e)}is.remote.has(e.address())}localAddrType(){var e,t=ho(this.local);try{for(t.s();!(e=t.n()).done;){var r=nn(e.value,2)[1];if(r.type())return r.type()}}catch(e){t.e(e)}finally{t.f()}}remoteAddrType(){var e,t=ho(this.remote);try{for(t.s();!(e=t.n()).done;){var r=nn((e)}finally{t.f()}}}var po="OK",fo="REJECT",go="NEED_MORE_CHECK",vo="MORE_CHECK_UNKNOWN";class mo{constructor(){this.tag="AddressFilter",this._candidatePairs=new Map}destroy(){this._candidatePairs.forEach((e=>{e.destroy()})),this._candidas()){var s=this._candidatePairs.get(e);s||(s=new uo,this._candidatePairs.set(e,s)),"local"===t?s.addLocal(n):s.addRemote(n)}}deletePeerCandidate(e){this._candidatePairs.delete(e)}check(e){var t=this._candidatePairs.get(e);return t?this.bothMdns(t)?po:this.bothIP(t)?this._checkPairInSameNetworkSegment(t)?po:fo:this.mixedAddr(t)?go:vo:poe:function(e){throw e},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,o=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){o=!0,i=e},f:function(){try{a||null==r.return||r.return()}finally{if(o)tinew Array(t);r<t;r++)n[r]=e[r];bucketCount=e.bucketCount||6,this._clearBucketInterval=e.clearBucketInterval||6e4,this._buckets=[];for(var t=0;t<this._bucketCount;t++)this._buckets.push(new Set);this._curBucketIndex=0,this._switchTimer=setInterval(this._switch.bind(ts.reduce(((e,t)=>e+t.size),0)}add(e){this._curBucket().add(e)}delete(e){this._curBucket().delete(e)}has(e){var t,r=_o(this._buckets);try{for(r.s();!(t=r.n()).done;){if(t.value.hasrBucketIndex=(this._curBucketIndex+1)%this._buckets.length,this._curBucket().clear()}_curBucket(){return this._buckets[this._curBucketIndex]}_clearTimer(){this._switchTimer&&(clearInterval(this._switchTimer),this._switchTimer=null)}}var wo="filter_addr_reject",Ro="filter_addr_ok",To="filter_addr_more",Co="filter_rtt_ok",So="filter_rtt_reject",Io="inner_ip",ko="public_ip",Eo="black_list_cnt";class Po extends fi{constructor(e){super(e),this.TAG="LocalLivePeerManager",this.hlsp2p=e}init(){super.init(),this._candidates=new Map,this._blackList=new bo({bucketCount:l.bucketCount,clearBucketInterval:l.clearBucketInterval}),this.initLocalReportData()}_initAddressFilter(){this._addressFilter=new mo,this.hlsp2p.on(R.PEER_REMOVED,(e=>{var t=e.pid;this._addressFilter.deletePeerCandidate(t)}))}_beforeSendingSignal(e){if(super._beforeSendingSignal(e),e.type===Gs){var t=new lo(e.payload.candidate);t.address()&&(this._reportData[Io]=t.address()),this.this._addressFilter&&this._addressFilter.addPeerCandidate(e.to,"local",e.payload.candidate)}}_signalReceived(e){this._addressFilter&&e.type===Gs&&thisom,"remote",e.payload.candidate)}_initPeerFilter(){this._peerFilter=new so(this.hlsp2p),this._peerFilter.setRouter(this.router).setTransport(this.transport).init(),this.hlsp2p.on(R.PEER_FILTER_PASSED,(e=>{var t=e.pid;super._PCConnectCKED,(e=>{var t=e.pid;this._localReportData[So]+=1,X.info(`[p2p] [peer] [_blackList] rtt reject, åŠ å…¥é»‘åå• ${t}`),this._blackList.add(t),setTimeout((()=>{this.hlsp2p&&this._kickPeer(t)}),1e3)}))}destroy(){super.destroy(),this._blackList.destroy(),this._candidates.clear(),this._addressFilter&&(this._addressFilter.destroy(),this._addressFilter=null),this._peerFilter&&(this._peerFilter.destroy(),this._peerFilter=null)}getComPeer(e){return this._connected.get(e)||this._candidates.get(e)}receiveSignal(e){return e.type===zs&&this._blackList.delete(e.from),super.receiveSignal(e)}canConnect(e){return e&&this._tryToKickForNewPeer(e),this._connected.size<l.maxPCConnected&&this._connecting.size<l.maxPCConnecting&&this._candidates.size<30}sendSignaling(e){e.type===js&&(e.peer={},e.peer.connected=this._connected.size),X.log(`[p2p] [å‘é€ä¿¡ä»¤] ${JSON.stringify(e)}`),super.sendSignaling(e)}_tryToKickForNewPeer(e){if(!(this._connected.size<l.maxPCConnected)&&e.type===js&&0===e.peer.connected){var t=this._pickPidToKick();t&&(X.warn(`[p2p] [peer] [kick] æ»¡è¿žæŽ¥æŽ¥æ”¶offer from: ${e.from}, è¸¢æŽ‰: ${t}`),this._kickPeer(t))}}_pickPidToKick(){var e=[...this._connected.keys()],t=e[Math.floor(e.length/2)];return t||""}_PCConnected(e){if(!l.enableMultiArea)return super._PCConnected(e);var t=this._connecting.get(e);if(this._connecting.delete(e),this._candidates.set(e,t),this._addressFilter){var r=this._addressFilter.check(e);if(X.info(`[p2p] [address filter] pid: ${e} ret: ${r}`),r===po)return this._localReportData[Ro]+=1,super._PCConnected(e);if(r===fo)return this._localReportData[wo]+=1,X.info(`[p2p] [peer] [_blackList] [address filter] åŠ å…¥é»‘åå• pid: ${e} ret: ${r}`),void this._blackList.add(e);this._localReportData[To]+=1}return this._peerFilter?(X.info(`[p2p] [rtt filter] add pid: ${e}`),this._peerFilter.addPeer(e)):super._PCConnected(e)}_handlePCFail(e){super._handlePCFail(e),e.reason===si&&(X.info(`[p2p] [peer] [_blackList]  è¿žæŽ¥è¶…æ—¶, åŠ å…¥é»‘åå• pid: ${e.remoteId}`),this._blackList.add(e.remoteId))}_getReadyPCFromCache(e){if(this._candidates.dates.get(e);return this._candidates.delete(e),t}return super._getReadyPCFromCache(e)}_getNextPeerForConnecting(){for(var e=Jn.nextPeer();e&&this._blackList.has(e);)X.log(`[p2p] [peer] [_blackList] ${e} åœ¨é»‘åå•ä¸­, ä¸ä¸»åŠ¨è¿žæŽ¥`),e=Jn.nextPeer();return e}initLocalRepor0,[So]:0,[Io]:"",[ko]:l.publicIP||"",[Eo]:this._blackList.size}}reportCallback(){var e=super.reportCallback();return Object.assign(e,this._localReportData),this.initLocalReportData(),e}}class xo extends Po{constructor(e){super(e)}getCandidatesPid(e){vaurrentLevel&&(r.sn<t.currentSn||r.sn===t.currentSn&&0!==t.progress)&&n.push(e.remoteId)})),n.length?n:super.getCandidatesPid({id:t})}}var Lo=new class{constructor(){this.TAG="P2pController",this.hlsp2p=null}init(e){this.hlsp2p=e,this.initGlobalModule(),this._initedInnterModule=!1,this.hlsp2p.trigger(R.CONF_STARTING),this.initModuleRelyOnConfHandler=this.initModuleRelyOnConf.bind(this),this.hlsp2p.once(R.CONF_PARSED,this.initModuleRelyOnConfHandler)}destroy(){this.destroyGlobalModule(),this.destroyInnerModule(),this.destroyModuleRelyOnConf(),this.hlsp2p=null}initModuleRelyOnConf(){this.signalClient||(this.initInnerModule(),this.hlsp2p.trigger(R.TRACKER_STARTING),this.signalClient=new Xn(t pid: ${t} uuid: ${Yr()} playId: ${l.randomPlayId}`),this.hlsp2p.localPeerId=t,this.hlsp2p.trigger(R.TRACKER_LOADING)})),this.hlsp2p.on(R.SIGNAL_RECEIVING,this.onSignalReceiving.bind(this)))}destroyModuleRelyOnConf(){this.hlsp2p.off(R.CONF_PARSED,this.initModuleRelyOnConfHandler),this.signalClient&&(this.signalClient.destroy(),this.signalClient=null)}initGlobalModule(){Zn.init(this.hlsp2p),Jn.init(this.hlsp2p),rs.init(this.hlsp2p),hs.init(this.hlsp2p),us.init(this.hlsp2p)}destroyGlobalModule(){Zn.destroy(),Jn.destroy(),rs.destroy(),hs.destroy(),us.destroy()}initInnerModule(){this._initedInnterModule||(this._initedInnterModule=!0,l.enableLocalNetworkShare||l.enableLLS?(this.router=new ds,this.peerManager=l.enableLocalNetworkShare?new xo(this.hlsp2p):new gi(this.hlsp2p),this.transport=new ps,this.peerManager.setRouter(this.router).setTransport(this.transport).setResId(l.channelId).init(),this.transport.setPeerManager(this.peerManager),this.llsController=new $s,this.llsController.setRouter(this.router).setTransport(this.transport).setPeerManager(this.peerManager).init(this.hlsp2p),this.hlsp2p.chunkMgr=this.llsController.chunkMgr,this.hlsp2p.subscriber=this.llsController.subscriber,this.peerManager.setP2PStats(this.hlsp2p.p2pStats)):(this.bbsModule=new Ya(this.hlsp2p),this.bbsModule.init()))}destroyInnerModule(){this._initedInnterModule&&(this._initedInnterModule=!1,l.enableLocalNetworkShare||l.enableLLS?(this.router.destroy(),this.router=null,this.transport.destroy(),this.transport=null,this.llsController.destroy(),this.llsController=null,this.hlsp2p.chunkMgr=null,this.hlsp2p.subscriber=null,this.peerManager.destroy(),this.peerManager=null):(this.bbsModule.destroy(),this.bbsModule=null))}onSignalReceiving(e){this.hlsp2p.trigger(fi.createPeerManagerSignalId(e.resId),e)}get peerConnected(){return this.peerManager?this.peerManager.peerConnected:this.bbsModule?this.bbsModule.peerManager.peerConnected:0}get trackerConnected(){return Jn.trackerConnected}};const Ao=Lo;class Do{constructor(){this._lastReport=Date.now(),this._info={fragCnt:0,totalDuration:0}}init(e){this.resetReportData(),this._lastReport=Date.now(),e.once(T.LEVEL_LOADED,(e=>{"VOD"===l.videoType&&(this._info.totalDuration=Math.floor(e.totalDuration),this._info.fragCnt=e.fragments.length)})),this._reportData[Se]=1}destroy(){this.resetReportData()}resetReportData(){this._reportData={[Me]:Math.floor((Date.now()-l.loadTime)/1e3)}}get reportData(){var e=this._reportData;return e[qe]=MaLength.toFixed(2)),e[Ve]=un.paused,"VOD"===l.videoType&&(this._reportData[dr]=this._info.totalDuration,this._reportData[pr]=this._info.fragCnt),this._lastReport=Date.now(),this.resetReportData(),e}}class Mo{constructor(){this.TAG="StallDetector"}init(e){this._resetReportData(),this._started=!1,this._stalling=!1,e.on(R.FRAG_LOADED,(()=>{this._started||un.readyState>=4&&(un.on("waiting",this._onWaiting.bind(this)),this._started=!0)})),un.on("canplaythrough",this._onCanplaythrough.bind(this))}destroy(){this._resetReportData(),this._started=!1,this._stalling=!1}_onWaiting(){this._started?this._stalling?X.warn(`å¡é¡¿ä¸­, å¿½ç•¥å†æ¬¡å¡é¡¿, å¿½ç•¥ stuck occur buffer:${un.bufferLength} ${D.curReqSn}-${D.curReqLevel}`):un.seeking||un.ended?X.warn(`seek or ended, stuck occur buffer:${un.bufferLength} ${D.curReqSn}-${D.curReqLevel}`):(this._stalling=!0,X.warn(`stuck occur buffer:${un.bufferLength} ${D.curReqSn}-${D.curReqLevel}`),this._reportData.stuckCount+=1):X.warn(`æ’­æ”¾æœªå¼€å§‹, å¿½ç•¥ stuck occur buffer:${un.bufferLength} ${D.curReqSn}-${D.curReqLevel}`)}_onCanplaythrough(){this._stalling=!1,X.warn(`Canplaythrough buffer:${un.bufferLength} ${D.curReqSn}-${D.curReqLevel}`)}_resetReportData(){this._reportData={stuckCount:0}}get reportData(){var e={[Ee]:this._reportData.stuckCount};return this._resetReporller"}init(e){tn.registerModule(this.TAG,this.reportCallback.bind(this)),un.init({videoId:l.videoId}),this.mediaInfoCollector=new Do,this.mediaInfoCollectorallDetector=new Mo,this.stallediaInfoCollector.destroy(),his.stallDetectoES(){return!(!Uo.supportRestParam()||!Uo.supportArrayFeature())}static supportArrayFeature(){return!(!self.Array.prototype.find||!self.Array.prototype.includes)}static supportRestParam(){try{var e=[1,2,3];[...e].forEach(((t,r)=>t===e[r]))}catch(e){return!1}return!0}static supportMSE(){return!!self.MediaSource}static supportMSEH264Playback(){return!(!self.MediaSource||!self.MediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"'))}static supportP2P(){return Uo.supportWebSocket()&&Uo.supportDataType()&&Uo.supportObjectURL()&&Uo.supportRTCPeerConnection()&&Uo.supportDataChannel()}static supportDataType(){return!("undefined"==typeof ArrayBuffer||"undefined"==typeof Uint8Array||"undefineypeof DataView)}static supportWebSocket(){return!(!("WebSocket"ction(){return!!self.RTCPeerConnection||!!(self.webkitRTCPeerConnection||self.mozRTCPeerConnection||self.msRTCPeerConnection||self.oRTCPeerConnection)}static supportDataChannel(){var e=self.RTCPeerConnection||self.msRTCPeerConnection||self.mozRTCPeerConnection||self.webkitRTCPeerConnection;return function(){var t=!1;try{var r=new e(null);t="createDataChannel"in r,r.close(),r=null}catch(e){}return t}()}static supportObjectURL(){return"URL"in self&&"createObjectURL"in URL}static supportServiceWorker(){return"serviceWorker"in navigator}static supportReadableStream(){return"ReadableStream"in self}static pageVisibility(){var e={hidden:"",visibvisibilitychange"):void 0!==document.msHidden?(e.hidden="msHidden",e.visibilityChange="msvisibilitychange"):void 0!==document.webkitHidden?(e.hidden="webkitHidden",e.visibilityChange="webkitvisibilitychange"):e.support=!1;return e.pageVisible=e.support?self.document[e.hidden]?"hidden":"visible":"notSupport",e}static memory(){var e="";if(performance&&performance.memory){var t=performance.memory;e=`${t.jsHeapSizeLimit} | ${t.totalJSHeapSirn e}static isFullScreen(){return!!(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement)}}var Bo={ES:{arrayFeature:1,restParam:2},p2p:{websocket:256,typeArray:512,objectUrl:1024,peerConnection:2048,datachannel:4096},playback:{mse:65536,h264codec:2<<16}};const No=Uo;var Fo=new class extends wn{abort(e){var t=Vn.findTSInfo(e.url);t&&yn.abort(sn.fromObj(t).toStringId())}loadTs(e,t){if(this._checkParam({requestContext:e,requestCallbacks:t})){var r={url:e.url,responseType:"arraybuffer",frag:{sn:void 0,level:void 0}},n={onSuccess:(e,r)=>{t.onSuccess(e.data,r)},onError:e=>{t.onError(e)},onTimeout:e=>{t.onTimeout(e)}},s=Vn.findTSInfo(r.url);s?(r.frag.sn=s.sn,r.frag.level=s.level):r.id=`ts_id_${Date.now()}`,this._load(r,{maxRetry:0,maxRetryDelay:64e3,retryDelay:0,timeout:2e4},n)}}_load(e,t,r){var n=e.frag,s=n.sn,i=n.level;D.curReqSn=s,D.curReqLevel=i;var a=new E(e,t,r),o=new mn(e,t,r),l=a.id;o.id=l,yn.load(l,a,o)}_checkParam(e){var t=e.requestContext,r=e.requestCallbacks,n=!0;if(t&&t.url||(n=!1,window.console.error("[hlsp2p] tsè¯·æ±‚ç¼ºå°‘url")),!r)return window.console.error("[hr","onSuccess","onTimeout"].forEach((e=>{r[e]&&"function"==typeof r[e]||(n=!1,window.console.error(`[hlsp2p] tsè¯·æ±‚çš„callbackså‚æ•°ç¼ºå°‘${e}å›žè°ƒæ–¹æ³•`))})),n}};const $o=Fo;var jo=r(114),Ho=r.n(jo);class Go{constructor(){this.ttfbCost=0,this.bandwidth=0,this.costMs=0}recordTTFB(e){this.ttfbCost=this.ttfbCost*(1-l.cdnBWRatio)+e*l.cdnBWRatio}estimateTTFB(){return this.ttfbCost}recordBandwidth(e,t){if(t){var r=e/t;this.bandwidth=this.bandwidth*(1-l.cdnBWRatio)+r*l.cdnBWRatio,this.costMs=this.costMs*(1-l.cdnCostRatio)+t*l.cdnCostRatio}}estimateBandwidth(){return this.bandwidth}estimateCostMs(){return this.costMs*l.cdnEstimateRatio}}clal&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Wo(e)}function Xo(e){var t=function(e,t){if("object"!==Wo(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!==Wo(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===Wo(t)?t:String(t)}function Ko(e,t,r){return(t=Xo(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class Yo extends EventTarget{constructor(){super(),this.readyState=Yo.UNSENT,this.response="",this.responseText="",this.responseType="",this.responseURL="",this.responseXML=null,this.status=0,this.statusText="",this.timeout=0,this.method="",this.url=""}setLoader(e){this.loader=e}abort(){var e={url:this.url};this._changeReadyState(Yo.UNSENT),this.loader.abort(e),this.dispatchEvent(new ProgressEvent("abort",{loaded:0,total:0})),this.dispatchEvent(new ProgressEvent("loadend",{loaded:0,total:0}))}getAllResponseHeaders(){}getResponseHeader(){}open(e,t){this._changeReadyState(Yo.OPENED),this.method=e,this.url=t,this.responseURL=t}send(){var e={url:this.url},t={onSuccess:(e,t)=>{this.response=e.slice(0),this.status=200,this._changeReadyState(Yo.DONE),this.responseType="arraybuffer";var r=this.response.byteLength,n=r;this.requestTime=Date.now()-(t.loading.end-t.loading.start),this.dispatchEvent(new ProgressEvent("progress",{loaded:r,total:n,lengthComputable:!0})),this.dispatchEvent(new ProgressEvent("load",{loaded:r,total:n,lengthComputable:!0})),this.dispatchEvent(new ProgressEvent("loadend",{loaded:r,total:n,lengthComputable:!0}))},onError:e=>{this.response=null,this.status=e.code||502,this.dispatchEvent(new ProgressEvent("error",{loaded:0,total:0})),this.dispatchEvent(new ProgressEvent("loadend",{loaded:0,total:0}))},onTimeout:()=>{this.status=0,this.dispatchEvent(new ProgressEvent("timeout",{loaded:0,total:0})),this.dispatchEvent(new ProgressEvent("loadend",{loaded:0,total:0}))}};this.loader.loadTs(e,t),this.dispatchEvent(new ProgressEvent("loadstart",{loaded:0,total:0}))}setRequestHeader(){}_changeReadyState(e){this.readyState=e,this.dispatchEvent(new Event("readystatechange"))}}Ko(Yo,"DONE",4),Ko(Yo,"LOADING",3),Ko(Yo,"HEADERS_RECEIVED",2),Ko(Yo,"OPENED",1),Ko(Yo,"UNSENT",0);var Jo=function(e,t,r,n){var s,i="arraybuffer"===e.responseType?e.response:e.responseText;!t&&i&&(e.responseTime=Date.now(),e.roundTripTime=e.responseTime-e.requestTime,e.bytesReceived=i.byteLength||i.length,e.bandwidth||(e.bandwidth=Math.floor(e.bytesReceived/e.roundTripTime*8*1e3))),r.headers&&(e.responseHeaders=r.headers),t&&"ETIMEDOUT"===t.code&&(e.timedout=!0),t||e.aborted||200===r.statusCode||206===r.statusCode||0===r.statusCode||(s=new Error(`XHR Failed with a response of: ${e&&(i||e.responseText)}`)),n(s,e)};var Qo=new class extends wn{construcamingAdapter",this._vhsIns=null,this._vhsOriginalXHR=null,this._p2pVhsXhr=null,this._delayAttachTimer=null}destroy(){this._vhsIns&&(this._delayAttachTimer&&(clearTimeout(this._delayAttachTimer),this._delayAttachTimer=null),this._vhsIns.xhr=this._vhsOriginalXHR,this._vhsIns=null,this._vhsOriginalXHR=null,this._p2pVhsXhr=null)}attachVhs(e){return!!e.xhr&&(!this._vhsIns&&(this._vhsIns=e,this._vhsOriginalXHR=e.xhr,this._p2pVhsXhr=(e,t)=>{var r,n;return r=e.uri,n=new URL(r),/\.ts$/.test(n.pathname)&&this._p2pVhsXhr?this._p2pXhrFunction(e,t):this._vhsOriginalXHR(e,t)},this._delayAttachTimer=setTimeout((()=>{this._vhsIns.xhr=this.)}_p2pXhrFunction(e,t){var r=this._vhsOriginalXHR.beforeRequest;if(r&&"function"==typeof r){vart=function(){s.aborted=!0;for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return i.apply(s,t)},s.uri=e.uri,s.requestTime=Date.now(),s.open("GET",e.uri);var a={body:"",headers:{},method:"GET",statusCode:0,url:e.uri,rawRequest:s};return s.addEventListener("timeout",(()=>{a.body=s.response,a.statusCode=200,Jo(s,{code:"ETIMEDOUT"},a,t)})),s.addEventListener,a,t)})),s.addEventListener("load",(()=>{Jo(s,null,a,t)})),s.send(),s}};const Zo=Qo;class el{constructor(){this._uploadBytesTotal=0,this.uploadBytes=0}addUploadBytes(e){this._uploadBytesTotal+=e,this._uploadBytes+=e}getStats(){var e={uploadBytesTotal:this._uploadBytesTotal,uploadBytes:this._uploadByttl{constructor(){this.customClientId="",this.client=null,this._recvCb=null}setCustomClientId=e,this}setCe){return this._recvCb=e,this}init(){return this}destroy(){this._recvCb=null}recvMessage(e){this._recvCb&&this._recvCb(e)}send(e){return e.customClientId!==this.customClientId?new Error("mismatch customClientId"):this.client?void this.client.postMessage(e):new Error("can not found client")}}const rl=2,nl=1,sl=2,il=3){this.streamId=e,this.customClientId=t,this._senderCtx={getNextSeq(){return this.lastSeq+=1,this.lastSeq},lastSeq:0,reset(){this.lastSeq=0}},this._receiverCtx={lastEmitSeq:0,getNextEmitSeq(){return this.lastEmitSeq+1},msgCache:new Map,reset(){this.msgCache.clear(),this.lastEmitSeq=0}},this._sendCb=null,this._recvCb=null,this._closeCb=null}destroy(){this._closeCb&&this._closeCb(this),this._receiverCtx.reset(),this._senderCtx.reset(),this._sendCb=null,this._recvCb=null}setRecvCb(e){return this._recvCb=e,this}setCloseCb(e){return this._closeCb=e,this}setSendCb(e){return thipe:nl,seq:0})}send(e){e.xp2pType=rl,e.streamId=this.streamId,e.customClientId=this.customClientId,0!==e.seq&&(e.seq=this._senderCtx.getNextSeq()),this._sendCb(e,this)}close(){const e={streamMsgType:al,seq:0};this.send(e)}recv(e){const t=this._receiverCtx.msgCache;for(t.set(e.seq,e);t.has(this._receiverCtx.getNextEmitSeq());){const e=t.get(this._receiverCtx.getNexte)})),t.delete(e.seq),this._receiverCtx.lastEmitSeq+=1}}}const cl={[ol]:1,[ll]:2};class ul{constructor(){this._startStreamId=null,this._msgChannel=null,this._streams=new Map}setRole(e){return this._startStreamId=cl[e],this}setOnRecvNewStreamCb(e){return this._recvNewStreamCb=e,this}setMessageChannel(e){return this._msgChannel=e,this}init(){this._msgChannel.setRecvCb((e=>{if(e.streamMsgType===nl)return void this._createRemoteStream(e);if(e.streamMsgType===al)return void Promise.resolve().then((()=>{this.destroySteam(.get(e.streamId);t&&t.recv(e)}))}destroy(){this._streams.forEach((e=>{e.destroy()}))}createLocalStream(){const e=this._createStreamreamId:e,customClientId:t});return r.sendInit(),r}_createRemoteStream(e){const t=this._createSteam({streamId:e.streamId,customClientId:e.customClientId});return this._recvNewStreamCb&&this._recvNewStreamCb(t),t}_createSteam({streamId:e,customClientId:t}){if(this._streams.has(e))returis._msgChannel.send(e);Error,e.streamMsgType===al&&Promise.resolve().then((()=>{this.destroySteam(r.streamId)}))})),this._streams.set(e,r),r}destroySteam(e){const t=this._streams.get(e);t&&(t.destroy(),this._streams.delete(e))}_createStreamId(){const e=this._startStreamId;return this._startStreamId+=2,e}}class dl{constructor(){this.customClientId=null,this._channel=new tl,this._role=null,this._streamMgr=new ul,this._recvNewStreamCb=null}setCentId=e,this}setRole(e){return this._role=e,this}setRecvNewStreamCb(e){return this._recvNewStreamCb=e,this}setClient(e){return this._channel.setClient(e),this}init(){this._channel.setCustomClientId(this.customClientId).init(),this._streamMgr.setRole(this._role).setOnRecvNewStreamCb(this._recvNewStreamCb).setMessageChannel(this._channel).init()}destroy(){this._channel.destroy(),this._streamMgr.destroy()}recvMessage(e){this._channel.recvMessage(e)}createStream(){return this._streamMgr.createLocalStream()}get channel(){return this._channel}}new pn,new G;Kr();var pl="1.0.0";var fl=new class extends wn{constructor(){super(),this._ready=!1}init(e){tn.registerModAG,this.repol({customClientId:l.randomPlayId,role:ol});var t=()=>{this._xp2pSWTransport.setRole(ol).setCustomClientId(l.randomPlayId).setClient(self.navigator.serviceWorker.controller).setRecvNewStreamCb(this.newStream.bind(this)).init(),this._serviceMessageHandler=e=>{var t=e.data;Object.prototype.hasOwnProperty.call(t,"xp2pType")&&this._xp2pSWTransport.recvMessage(t)},self.navigator.serviceWorker.addEventListener("message",this._serviceMessageHandler),this.registerToSW()};self.navigator.serviceWorker.controller?t():this._waitControllerTimer=setTimeout((()=>{t()}),1e4);var r=e=>{var t=new URL(e);return t.searchParams,"1"),t.toJSON()};e.on(T.BEFORE_CDN_REQUEST,(e=>{var t=e.loader;if(this._ready){var n=t.config.url;n&&(t.config.url=r(n))}})),e.on(T.BEFORE_M3U8_REQUEST,(e=>{var t=e.requestInfo;e.requestInfo=new Request(r(t.url),t)}))}destroy(){this.unregisterFromSW(),this._serviceMessageHandler&&self.navigator.serviceWorker.removeEventListener("message",this._serviceMessageHandler),this._xp2pSWTransport&&this._xp2pSWTransport.de(),clearTimeout(this._waitControllerTimer)}registerToSW(){this._reportData[Sr]+=1,self.fetch(`https://sw.xp2p/hello?videoType=${l.videoType}&customClientId=${l.randomPlayId}&protocol=HLS&version=${pl}`).then((e=>e.json())).then((e=>{0===e.code?(this._reportData[Ir]+=1,this._ready=!0):this._reportData[kr]+=1;var t=e.version,r=e.buildTime,n=e.commit;this._reportData[Ur]=t||"unknown",this._reportData[Br]=r||"unknown",this._reportData[Nr]=n||"unknown"})).catch((e=>{this._reportData[kr]+=1}))}unregisterFromSW(){self.fetch(`https://sw.xp2p/bye?videoType=${l.videoType}&customClientId=${l.randomPlayId}&protocol=HLS&version=${pl}`).catch((e=>e))}newStream(e){e.setRecvCb((t=>{if(t.streamMsgType===sl){var r=t.data,n=r.url,s=r.body;if("http://sw.xp2p/hls/request/ts"===n)return void this.recvTSReq(s,e);"http://sw.xp2p/hls/sync/m3u8"===n&&this.recvM3U8Manifest(s)}})),e.setCloseCb((()=>{}))}recvTSReq(e,t){var r=e.url;if(this._reportData[Er]+=1,Vn.findTSInfo(r))$o.loadTs({url:r},{onSuccess:e=>{var n={streamMsgType:il,data:{url:r,status:200,headers:{"Access-Control-Allow-Origin":self.origin},contentType:"video/MP2T",body:e}};this._reportData[Pr]+=1,t.send(n),t.close()},onError:()=>{var e={streamMsgType:il,data:{url:r,status:404}};this._reportData[xr]+=1,t.send(e),t.close()},onTimeout:()=>{var e={streamMsgType:il,data:{url:r,status:404}};this._reportData[Lr]+=1,t.send(e),t.close()}});else{var n={streamMsgType:il,data:{url:"http://sw.xp2p/hls/request/ts",status:403,headers:{},contentType:"json"}};this._reportData[Ar]+=1,t.send(n),t.close()}}recvM3U8Manifest(e){var t=e.url,r=e.text;this._reportData[Or]+=1;var n=Vn.m3u8UrlList;if("VOD"!==l.videoType&&n.ready()){var s=n.getLevel(t);void 0!==s?(this._reportData[Dr]+=1,jn.parseManifestText(t,s,r,(()=>{}))):this._reportData[Mr]+=1}}initReportData(){this._reportData={[Sr]:0,[Ir]:0,[kr]:0,[Er]:0,[Pr]:0,[xr]:0,[Lr]:0,[Ar]:0,[Dr]:0,[Mr]:0,[Or]:0,[qr]:1}}reportCallback(){var e=this._reportData;return this.initReportData(),e}};function gl(e){if(!Number.isSafeInteger(e)||e<0)throw new Error(`Wrong positive integer: ${e}`)}function vl(ent8Array))throw new Error("Expected Uint8Array");if(t.length>0&&!t.includesError(`Expected Uint8Array of length ${t}, not of length=${e.length}`)}function ml(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function _l(e,t){vl(e);const r=t.outputLen;if(e.length<r)throw new Error(`digestInto() expects output buffer of length at least ${r}`)}const yl=BigInt(2**32-1),h:Number(e&yl),l:Number(e>>bl&yl)}:{h:0|Number(e>>bl&yl),l:0|Number(e&yl)}}const Rl=e=>e instanceof Uint8Array,Tl=e=>new Uint32buffer,e.byteOffset,Math.floor(e.byteLength/4)),Cl=(e,t)=>e<<32-t|e>>>t;if(!(68===new Uint8Array(new Uint32Array([287454020]).buffer)[0]))throw new Error("Non little-endian hardware is not supported");function Sl(e){if("string"==typeof e&&(e=function(e){if("string"!=typeof e)throw new Error("utf8ToBytes expected string, got "+typeof e);return new Uint8Array((new TextEncoder).encode(e))}(e)),!Rl(e))throw new Error("expected Uint8Array, got "+typeof e);return e}class Il{clone(){return this._cloneInto()}}function kl(e){const t=(t,r)=>e(r).update(Sl(t)).digest(),r=e({});return t.outputLen=r.outputLen,t.blockLen=r.blockLen,t.create=t=>e(t),t}class El extends Il{constructor(e,t,r={},n,s,i){if(super(),this.blockLen=e,this.outputLen=t,this.length=0,this.pos=0,this.finished=!1,this.destroyed=!1,gl(e),gl(t),gl(n),t<0||t>n)throw new Error("outputLen bigger than keyLen");if(void 0!==r.key&&(r.key.length<1||r.key.length>n))throw new Error(`key must be up 1..${n} byte long or undefined`);if(void 0!==r.salt&&r.salt.length!==s)throw new Error(`salt must be ${s} byte long or undefined`);if(void 0!==r.personalization&&r.personalization.length!==i)throw new Error(`personalization must be ${i} byte long or undefined`);this.buffer32=Tnew Uint8Array(e))}update(e){ml(this);const{blockLen:t,buffer:r,buffer32:n}=this,s=(e=Sl(e)).length,i=e.byteOffset,a=e.buffer;for(let o=0;o<s;){this.pos===t&&(this.compress(n,0,!1),this.pos=0);const l=Math.min(t-this.pos,s-o),h=i+o;if(l!==t||h%4||!(o+l<s))r.set(e.subarray(o,o+l),this.pos),this.pos+=l,this.length+=l,o+=l;else{const e=new Uint32Array(a,h,Math.floor((s-o)/4));for(let r=0;o+t<s;r+=n.length,o+=t)this.length+=t,this.compress(e,r,!1)}}return this}digestInto(e){ml(this),_l(e,this);const{pos:t,buffer32:r}=this;this.finished=!0,thi)=>n[t]=e))}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const r=e.slice(0,t);return this.destroy(),r}_cloneInto(e){const{buffer:t,length:r,finished:n,destroyed:s,outputLen:i,pos:a}=this;return e||(e=new this.constructor({dkLen:i})),e.set(...this.get()),e.length=r,e.finished=n,e.destroyed=s,e.outputLen=i,e.buffer.set(t),e.pos=a,e}}const Pl=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]);function xl(e,t,r,n,s){return n=Cl(n^(e=e+t+s|0),16),{a:e,b:t=Cl(t^(r=r+n|0),12),c:r,d:n}}function Ll(e,t,r,n,s){return n=Cl(n^(e=e+t+s|0),8),{a:e,b:t=Cl(t^(r=r+n|0),7),c:r,d:n}}function Al(e,t,r,n,s,i,a,o,l,h,c,u,d,p,f,g,v,m,_,y){let b=0;for(let w=0;w<n;w++)({a:s,b:l,c:d,d:v}=xl(s,l,d,v,r[t+e[b++]])),({a:s,b:l,c:d,d:v}=Ll(s,l,d,v,r[t+e[b++]])),({a:i,b:h,c:p,d:m}=xl(i,h,p,m,r[t+e[b++]])),({a:i,b:h,c:p,d:m}=Ll(i,h,p,m,r[t+e[b++]])),({a,b:c,c:f,d:_}=x,r[t+e[b++]])),({a,b:c,c:f,d:_}=Ll(a,c,f,_,r[t+e[b++:o,b:u,c:g,d:y}=xl(o,u,g,y,r[t+e[b++]])),({a:o,b:u,c:g,d:y}=Ll(o,u,g,y,r[t+e[b++]])),({a:s,b:h,c:f,d:y}=xl(s,h,f,y,r[t+e[b++]])),({a:s,b:h,c:f,d:y}=Ll(s,h,f,y,r[t+e[b++]])),({a:i,b:c,c:g,d:v}=xl(i,c,g,v,r[t+e[b++]])),({a:i,b:c,c:g,d:v}=Ll(i,c,g,v,r[t+e[b++]])),({a,b:u,c:d,d:m}=xl(a,u,d,m,r[t+e[b++]])),({a,b:u,c:d,d:m}=Ll(a,u,d,m,r[t+e[b++]])),({a:o,b:l,c:p,d:_}=xl(o,l,p,_,r[t+e[b++]])),({a:o,b:l,c:p,d:_}=Ll(o,l,p,_,r[t+e[b++]]));return{v0:s,v1:i,v2:a,v3:o,v4:l,v5:h,v6:c,v7:u,v8:d,v9:p,v10:f,v11:g,v12:v,v13:m,v14:_,v15:y}}const Dl=(()=>{const e=Array.from({length:16},((e,t)=>t)),t=e=>[2,6,3,10,7,0,4,13,1,11,12,5,9,14,15,8].map((t=>e[t])),r=[];for(let n=0,s=e;n<7;n++,s=t(s))r.push(...s);return Uint8Array.from(r)})();class Ml extends El{constructor(e={},t=0){if(super(64,void 0===e.dkLen?32:e.dkLen,{},Number.MAX_SAFE_INTEGER,0,0),this.flags=0,this.chunkPos=0,this.chunksDone=0,this.stack=[],this.posOut=0,this.bufferOut3y(16),this.chunkOut=0,this.enableXOF=!0,this.outputLen=void 0===e.dkLen?32:e.dkLen,gl(this.outputLen),void 0!==e.key&&void 0!==e.context)throw new Error("Blake3: only key or context can be specified at same time");if(void 0!==e.key){const r=Sl(e.key).slice();if(32!==r.length)throw new Error("Blake3: key should be 32 byte");this.IV=Tl(r),this.flags=16|t}else if(void 0!==e.context){const r=new Ml({dkLen:32},32).update(e.context).digest();this.IV=Tl(r),this.flags=64|t}else this.IV=Pl.slice(),this.flags=t;var r;this.state=this.IV.slice(),this.bufferOut=(r=this.bufferOut32,new Uint8Array(r.buffer,r.byteOffset,r.byteLength))}get(){return[]}set(){}b2Compress(e,t,r,n=0){const{state:s,pos:i}=this,{h:a,l:o}=wl(BigInt(e),!0),{v0:l,v1:h,v2:c,v3:u,v4:d,v5:p,v6:f,v7:g,v8:v,v9:m,v10:_,v11:y,v12:b,v13:w,v14:R,v15:T}=Al(Dl,n,r,7,s[0],s[1],s[2],s[3],s[4],s[5],s[6],s[7],Pl[0],Pl[1],Pl[2],Pl[3],a,o,i,t);s[0]=l^v,s[1]=h^m,s[2]=c^_,s[3]=u^y,s[4]=d^b,s[5]=p^w,s[6]=f^R,s[7]=g^T}compress(e,t=0,r=!1){let n=this.flags;if(this.chunkPos||(n|=|r)&&(n|=2),r||(this.pos=this.blockLen),this.b2Compress(this.chunksDone,n,e,t),this.chunkPos+=1,16===this.chunkPos||r){let e=this.state;this.state=this.IV.slice();for(let t,n=this.chunksDone+1;(r||!(1&n))&&(t=this.stack.pop());n>>=1)this.buffer32.set(t,0),this.buffer32.set(e,8),this.pos=this.blockLen,this.b2Compress(0,4|this.flags,this.buffer32,0),e=this.state,this.state=this.IV.slice();this.chunksDone++,this.chunkPos=0,this.stack.push(e)}this.pos=0}_cloneInto(e){e=super._cloneInto(e);const{IV:t,flags:r,state:n,chunkPos:s,posOut:i,chunkOut:a,stack:o,chunksDone:l}=this;return e.state.set(n.slice()),e.stack=o.map((e=>Uint32Array.from(e))),e.IV.set(t),e.flags=r,e.chunkPos=s,e.chunksDone=l,e.posOut=i,e.chunkOut=a,e.enableXOF=this.enableXOF,e.bufferOut32.set(this.bufferOut32),e}destroy(){this.destroyed=!0,this.state.fill(0),this.buffer32.fill(0),this.IV.fill(0),this.bufferOut32.fill(0);for(let e of this.stack)e.fill(0)}b2CompressOut(){const{state:e,pos:t,flags:r,buffer32:n,bufferOut32:s}=this,{h:i,l:a}=wl(BigInt(this.chunkOut++)),{v0:o,v1:l,v2:h,v3:c,v4:u,v5:d,v6:p,v7:f,v8:g,v9:v,v10:m,v11:_,v12:y,v13:b,v14:w,v15:R}=Al(Dl,0,n,7,e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],Pl[0],Pl[1],Pl[2],Pl[3],a,i,t,r);s[0]=o^g,s[1]=l^v,s[2]=h^m,s[3]=c^_,s[4]=u^y,s[5]=d^b,s[6]=p,this.posOut=0}finish(){if(this.finished)return;this.finished=!0,this.buffer.fill(0,this.pos);let e=8|this.flags;this.stack.length?(e|=4,this.compress(this.buffer32,0,!0),this.chunksDone=0,this.pos=thsOut()}writeIs,!1),vl(e),this.finish();const{blocks=e.length;n<s;){this.posOut>=t&&this.b2CompressOut();const i=Math.min(t-this.posOut,s-n);e.set(r.subarray(this.posOut,this.posOut+i),n),this.posOut+=i,n+=i}return e}xofInto(e){if(!this.enableXOF)throw new Error("XOF is not possible after digest call");return this.writeInto(e)}xof(e){return gl(e),this.xofInto(new Uint8Array(e))}digestInto(e){if(_l(e,this),this.finished)throw new Error("digest() was already called");return this.enableXOF=!1,this.writeInto(e),this.destroy(),e}digest(){return this.digestInto(new Uint8Array(this.outputLen))}}const Ol=kl((e=>new Ml(e)));var ql=e=>(e=>{var t=[];e.forEach((e=>{t.push(String.fromCharCode(e))}));var r=t.join("");return self.btoa(r)})(Ol(e)),Ul=r(269),Bl=r.n(Ul),Nl=r(10),Fl=r.n(Nl);var $l=(e,t)=>{var r=function(e,t,r,n,s,i){var a=new URL(n),o=s||Date.now(),l=void 0===i?Math.floor(1e9*Math.random()):i,h=`GET ${a.pathname}${a.search} HTTP/1.1\n${o}\n${a.host}\n${r}\n`,c=Fl()(h,t);return{Authorization:`MAC kid=${e} ts=${o} seq-nr=${l} mac=${Bl().stringify(c)} h=host:x-package`,"x-package":r}}(t.xp2pAppId,t.xp2pAppKey,t.xp2pPackage,e),n=new Ga;return n.configure(e,{msTimeout:3e3,maxRetryTimes:1},{headers:r}),n.send()},jl="ok",Hl="not_found",Gl="auth_fail",Vl="other_code",zl="timeout",Wl="error";class Xl{constructor(){this._hashInfo=new Map,this._succReq=new Map}configure(e){this._config=e}destroy(){this._hashInfo.clear(),this._succReq.clear()}validateTs(e,t){var r=this._getTSHashFromMeta(e);if(r){var n=(e=>{for(var t=[],r=131072,n=Math.ceil(e.byteLength/r),s=0;s<n;s++){var i=ql(e.slice(s*r,(s+1)*r));t.push(i)}return ql(t.join(""))})(t);return r===n}}hasMeta(e){return this._succReq.has(e)}requestMeta(e){var t=this,r=e.m3u8Url,n=e.level;return J(Z().mark((function e(){var s,i,a;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t._config){e.next=2;break}return e.abrupt("return","");case 2:if(!t._succReq.has(n)){e.next=4;break}return e.abrupt("return","");case 4:return s=t._createMetaUrl(r),e.prev=5,e.next=8,$l(s,{xp2pAppId:t._config.xp2pAppId,xp2pAppKey:t._config.xp2pAppKey,xp2pPackage:t._config.xp2pPackage});case 8:if(404!==(i=e.sent).status){e.next=11;break}return e.abrupt("return",Hl);case 11:if(403!==i.status){e.next=13;break}return e.abrupt("return",Gl);case 13:if(i.ok){e.next=15;break}return e.abrupt("return",Vl);case 15:return e.next=17,i.json();case 17:if(!(a=e.sent)){e.next=22;break}return t._parseMetaInfo(a),t._succReq.set(n,r),e.abrupt("return",jl);case 22:e.next=28;break;case 24:return e.prev=24,e.t0=e.catch(5),e.abrupt("return",Wl);case 28:case"end":return e.stop()}}),e,null,[[5,24]])})))()}_getTSHashFromMeta(e){var t,r=this._createResId(e);return null===(t=this._hashInfo.get(r))||void 0===t?void 0:t.digest}_parseMetaInfo(e){var t=e.blocks;t&&t.length&&t.forEach((t=>{var r=(0,C.buildAbsoluteURL)(e.path,t.path),n=this._createResId(r);this._hashInfo.set(n,t)}))}_createMetaUrl(e){var t=this._createResId(e);return`${this._config.metaServerUrl}?xresid=${t}&appid=${this._config.xp2pAppId}&path=${self.btoa(e)}`}_createResId(e){var t=this._config,r=t.channelIdIncludeHost;return _(e,{channelIdIncludeSearch:t.channelIdIncludeSearch,channelIdIncludeHost:r})}}var Kl=new class{constructor(){this._validator=new Xl,this._retryTimer=new Map,this._confReady=!1,this._metaReqCtx=new Map}init(e){e.on("player_level",(e=>{var t=e.level;this._isValidateEnable()&&this._confReady&&(this._retryTimer.has(t)||this._requestSingleLevelMeta(t))})),e.on(T.FRAG_LOADED,(e=>{var t=e.id,r=e.binaryData,n=sn.fromId(t);this._isValidateEnable()&&this._validator.hasMeta(n.level)&&this._verifyCDNData(t,new Uint8Array(r))})),e.on(T.FRAG_LOADED_P2P,(e=>{var t=e.id;this._confReady&&this._isValidateEnable()&&this._verifyP2PData(t)})),e.once(T.CONF_PARSED,(()=>{this._confReady=!0,this._isValidateEnable()&&(tn.registerModule("ValidateController",this.reportCallback.bind(this)),this.initReport(),this._validator.configure({xp2pPackage:l.domain,xp2pAppId:l.xp2pAppId,xp2pAppKey:l.xp2pAppKey,channelIdIncludeHost:l.channelIdIncludeHost,channelIdIncludeSearch:l.channelIdIncludeSearch,metaServerUrl:l.metaServerUrl}),this._requestSingleLevelMeta(D.curReqLevel))}))}destroy(){this._retryTimer.fetryTimer.clear(),this._metaReqCtx.clear(),this._validator.destist.getM3U8(e);t&&(this._validator.hasMeta(e)||(this._metaReqCtx.set(t,{startTime:Date.now()}),this._reportData[fr]+=1,this._validator.requestMeta({m3u8Url:t,level:e}).then((e=>{e===jl&&this._metaReqCtx.has(t)&&(this._reportData[yr]=Date.now()-this._metaReqCtx.get(t).startTime,this._metaReqCtx.delete(t));var r={[jl]:mr,[Gl]:vr,[Hl]:gr,[Wl]:_r,[zl]:_r,[Vl]:_r}[e];r&&(this._reportData[r]+=1)})),this._createRetryTimer(e)))}_createRetryTimer(e){if(!this._retryTimer.has(e)){var t=setTimeout((()=>{this._requestSingleLevelMeta(e)}),l.metaRetryDelay);this._retryTimer.set(e,t)}}_isValidateEnable(){return"VOD"===l.videoType&&l.enableValidateTS}_verifyP2PData(e){this._reportData[br]+=1;var t=ln.get(e),r=sn.fromId(e),n=Vn.getTSInfo(r.level,r.sn);if(t&&n){var s=t.arrayBuffer(),i=(0,C.buildAbsoluteURL)(n.baseUrl,n.originalUrl);if(!this._validator.validateTs(i,new Uint8Array(s))){var a=this._validator.hasMeta(r.level)?wr:Rr;this._reportData[a]+=1,ln.delete(e)}}}_verifyCDNData(e,t){this._reportData[br]+=1;var r=sn.fromId(e),n=Vn.getTSInfo(r.level,r.sn),s=(0,C.buildAbsoluteURL)(n.baseUrl,n.originalUrl);this._validator.validateTs(s,t)||(this._reportData[Tr]+=1)}initReport(){this._reportData={[fr]:0,[vr]:0,[gr]:0,[mr]:0,[_r]:0,[br]:0,[Tr]:0,[wr]:0,[Rr]:0,[Cr]:this._isValidateEnable()?1:0}}reportCallback(){var e=this._reportData;return this.initReport(),"VOD"===l.videoType?e:{}}};const Yl=Kl;var Jl=e=>{var t=Fr.encrypt(JSON.stringify(e)),r=new XMLHttpRequest;r.open("POST",l.reportServer),r.send(t)};class Ql{static get version(){return zr}static isSupported(e){var t=No.supportMSEH264Playback()&&No.supportP2P()&&No.supportES();if(!t)try{((e,t,r,n)=>{if(e){var s=e.enableReportUnsupportedFeature,i=e.videoType,a=e.xp2pAppId,o=e.url;if(s&&i&&a&&o&&-1!==["LIVE","VOD"].indexOf(i)){var l=function(e,t){var r=0;return e.supportArrayFeature()||(r|),e.supportRTCPeerConnection()||(r|=t.p2p.peerConnection),e.supportDataChannel()||(r|=t.p2p.datachannel),e.supportMSE()||(r|=t.playback.mse),e.supportMSEH264Playback()||(r|=t.playback.h264codec),r}(t,r),h=Jr();h.video_type=i.toLowerCase(),h.str_video_type=i.toLowerCase(),h.url=o,h.partner=a,h.i.unsupported_feature=l,n(h)}}})(e,No,Bo,Jl)}catch(e){window.console.warn("[HLSP2P] unsupported feature report error")}return t}static isSupportedInServiceWorker(){return No.supportP2P()&&No.supportES()&&No.supportReadableStream()&&No.supportServiceWorker()}static get Events(){return{Rollback:"rollback",Log:"log"}}static get uuid(){return Yr()}static create(e,t){var n=Object.assign({},t||{});n.url=e.url,r.g.hlsp2p&&r.g.hlsp2p.destroy();{class e{constructor(){this.liveInfo={domain:"h5hls.live.cntv.com",xp2pAppId:"5fa933e724f48fed55245e05",cloudAppId:1252894780},this.vodInfo={domain:"h5hls.cntv.com",xp2pAppId:"5c8a0fa57a9b23480f6ea0ed",xp2pAppKey:"P9v3R0M4JeMsCtmb",cloudAppId:1252894780,channelIdIncludeHost:!1,channelIdIncludeSearch:!1}}createConfig(e){if("LIVE"===e.videoType)return this.liveInfo.channelId=this.extractLiveChannelId(e.url),this.liveInfo;var t=this.vodInfo,r=t.channelIdIncludeHost,n=t.channelIdIncludeSearch;return this.vodInfo.channelId=_(e.url,{channelIdIncludeHost:r,channelIdIncludeSearch:n}),this.vodInfo}extractLiveChannelId(e){var t=`${e.split("/")[e.split("/").length-2]}_${e.split("/")[e.split("/").length-1].split(".")[0]}`;return`${new URL(e).host.replace(/\./g,"")}_${t}`}}var s=(new e).createConfig(n);Object.assign(n,s)}var i=new Ql(e,n);return r.g.hlsp2p=i,i}static createCommon(e){var t=Object.assign({},e);r.g.hlsp2p&&r.g.hlsp2p.destroy();{class e{constructor(){this.liveInfo={domain:"h5hls.live.cntv.com",xp2pAppId:"5fa933e724f48fed55245e05",cloudAppId:1252894780},this.vodInfo={domain:"h5hls.cntv.com",xp2pAppId:"5c8a0fa57a9b23480f6ea0ed",xp2pAppKey:"P9v3R0M4JeMsCtmb",cloudAppId:1252894780,channelIdIncludeHost:!1,channelIdIncludeSearch:!1}}createConfig(e){if("LIVE"===e.videoType)return this.liveInfo.channelId=this.extractLiveChannelId(e.url),this.liveInfo;var t=this.vodInfo,r=t.channelIdIncludeHost,n=t.channelIdIncdeHost:r,channelIdIncludeSearch:n}),this.vodInfo}extractLiveChannelId(e){var t=`${e.split("/")[e.split("/").length-2]}_${e.split("/")[e.split("/").length-1].split(".")[0]}`;return`${new URL(e).host.replace(/\./g,"")}_${t}`}}var n=(new e).createConfig(t);Object.assign(t,n)}var s=new Ql(null,t);return r.g.hlsp2p=s,s}constructor(e,t){this.TAG="HLSP2P",this.initLogger(t.logLevel),c().setLevel(t.loglevel||"warn"),c().info(`[${this.TAG}] init`),o(),A(),D.hlsjs=e,Ql.initConfig(t),this.initCore(),this.iniger(R.NOR_REPORT_START),setTimeout((()=>{X.info(`[åˆå§‹åŒ–], uuid: ${Ql.uuid}, version: ${Ql.version}`)})),this._startP2PModuleTimer=null}destroy(){c().info(`${this.TAG} ### destroy`),X.info(`[destroy], uuid: ${Ql.uuid}`),this._destroyed?c().warn(`${this.TAG} Repeated  destroy`):(X.destroy(),fn.destroy(),this._destroyed=!0,Zo&&Zo.destroy(),this.modules.forEach((e=>{e.destroy()})),this.modules=[],this.core.forEach((e=>{e.destroy()})),this.core=[],l.enableServiceWorker&&fl.destroy(),Ql.aegis&&(Ql.aegis.destroy(),Ql.aegis=null),this._startP2PModuleTimer&&clearTimeout(this._startP2PModuleTimer),o(),A())}static initConfig(e){new b(e).process()}initLogger(e){X.init(this).setLevel(e||""),fn.init({uuid:Ql.uuid,version:Ql.version,logPrefix:"HLSP2P",platform:"H5-HLS"}),fn.enable(),X.setNext(fn)}initCore(){this.core=[];var e=new s;this.on=e.on.bind(e),this.off=e.off.bind(e),this.once=e.once.bind(e),this.trigger=e.trigger.bind(e),this.core.push(e)}initModules(){if(this.modules=[],tn.init(this),this.modules.push(tn),this.modules.push(X),Vn.init(this),D.hlsjs){var e=this.hlsjsAdapter;e.init(this,D.hlsjs),this.modules.push(e)}else jn.init(this),jn.load(l.url).catch((e=>{this._destroyed||jn.load(l.url)})),this.modules.push(jn);this.once(R.CONF_PARSED,(()=>{l.enableServiceWorker&&fl.init(this)})),ln.init(this),yn.init(this),qo.init(this),Yl.init(this),this.modules.push(ln,yn,Vn,qo,Yl),this._startP2PModuleTimer=setTimeout((()=>{this.modules.length&&(Ao.init(this),this.initRTLogger(),this.modules.push(Ao))}),l.p2pStartDelay),D.cdnEstimate=new Go,D.p2pEstimate=new zo}initRTLogger(){this.on(R.CONF_PARSED,(()=>{l.enableRTLog?(fn.setLevel(l.rtLogLevel),fn.start({reportInterval:5e3})):fn.disable()})),this.on(R.CONF_PARSED,(()=>{l.enableAegis&&(Ql.aegis||l.aegisId&&(Ql.aegis=new(Ho())({id:l.aegisId,uin:Yr(),version:Ql.vers:!1,speedSample:!1,reportApiSpeed:!1,reportAssetSpeed:!1,pagePerformance:!1})))}))}get hlsjsAdapter(){return this._destroyed?(window.console.error("[hlsp2p] sdkå·²Adapter=Tn,Tn)}get commonLoader(){return D.hlsjs?(window.console.error("[hlsp2p] åˆå§‹åŒ–å·²ç»ç»‘å®šäº†hls.js, ä¸å¯ä½¿ç”¨é€šç”¨loader"),null):this._destroyed?(window.console.error("[hlsp2p] sdkå·²è°ƒç”¨destroy, ä¸å¯å†ä½¿ç”¨"),null):(D.curPlayerAdapter=$o,$o)}attachVhsPlayer(e){return this._destroyed?(window.console.error("[hlsp2p] [attachVhsPlayer] sdkå·²è°ƒç”¨destroy, ä¸å¯å†ä½¿ç”¨"),!1):e?Zo.attachVhs(e):(window.console.error("[hlsp2p] [attachVhsPlayer] ä¼ å…¥çš„vhså®žä¾‹ä¸ºç©º"),!1)}get hconfig(){return l}get peerConnected(){return Ao.peerConnected}get downloadBytes(){return ln.downloadBytes}getStats(){return Object.assign(this.p2pStats.getStats(),ln.stat.getStats())}get trackerConnected(){return Ao.trackerConnected}}const Zl=Ql})(),n=n.default})()));
//# sourceMappingURL=hlsp2p_cntv@1.6.37.js.map