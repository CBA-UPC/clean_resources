/*! For license information please see summarymodule.be4df12a487cbafd3aa8.chunk.v7.js.LICENSE.txt */
(window.officehome_webpackJsonp=window.officehome_webpackJsonp||[]).push([[609],{WG0T:function(e,t,a){"use strict";a.r(t),a.d(t,"OdspSummaryUploadManager",();var n=a("Xou4"),r=a("7/yF"),s=a("he5V"),o=a("Ls0c"),i=a("HJ7Z"),c=a("2IM6"),d=a("Unhj"),l=a("DLbW"),h=a("Tvsg"),m=a("hpQ0");class p{constructor(e,t,a,n,r,s){this.snapshotUrl=e,this.getStorageToken=t,this.epochTracker=n,this.forceAccessTokenViaAuthorizationHeader=r,this.relayServiceTenantAndSessionId=s,this.mc=Object(c.c)(a)}async writeSummaryTree(e,t){void 0!==this.lastSummaryProposalHandle&&this.lastSummaryProposalHandle!==t.proposalHandle&&this.mc.logger.sendTelemetryEvent({eventName:"LastSummaryProposedHandleMismatch",ackedSummaryProposedHandle:t.proposalHandle,lastSummaryProposalHandle:this.lastSummaryProposalHandle});const a=await this.writeSummaryTreeCore(t.ackHandle,t.referenceSequenceNumber,e),n=a?a.id:void 0;if(!a||!n)throw new Error("Failed to write summary tree");return this.lastSummaryProposalHandle=n,n}async writeSummaryTreeCore(e,t,a){const n=Object(l.d)(a),{snapshotTree:r,blobs:s}=await this.convertSummaryToSnapshotTree(e,a,".app"),o={entries:r.entries,message:"app",sequenceNumber:t,type:n||void 0===e?"container":"channel"};return Object(m.i)((async a=>{const n=await this.getStorageToken(a,"WriteSummaryTree"),{url:r,headers:i}=Object(h.a)(`${this.snapshotUrl}/snapshot`,n,this.forceAccessTokenViaAuthorizationHeader);i["Content-Type"]="application/json";const c=this.relayServiceTenantAndSessionId();void 0!==c&&(i["If-Match"]=`fluid:sessionid=${c}${e?`;containerid=${e}`:""}`);const l=JSON.stringify(o);return d.b.timedExecAsync(this.mc.logger,{eventName:"uploadSummary",attempt:a.refresh?2:1,hasClaims:!!a.claims,hasTenantId:!!a.tenantId,headers:0!==Object.keys(i).length||void 0,blobs:s,size:l.length,referenceSequenceNumber:t,type:o.type},(async()=>(await this.epochTracker.fetchAndParseAsJSON(r,{body:l,headers:i,method:"POST"},"uploadSummary")).content))}))}async convertSummaryToSnapshotTree(e,t,a,c){var d;void 0===c&&(c=null===(d=this.mc.config.getBoolean("Fluid.Driver.Odsp.MarkUnreferencedNodes"))||void 0===d||d);const l={type:"tree",entries:[]};let h=0;const m=Object.keys(t.tree);for(const d of m){const m=t.tree[d];let p,u,y;switch(m.type){case i.a.Tree:{const t=await this.convertSummaryToSnapshotTree(e,m,a);u=t.snapshotTree,y=c?m.unreferenced:void 0,h+=t.blobs;break}case i.a.Blob:u="string"==typeof m.content?{type:"blob",content:m.content,encoding:"utf-8"}:{type:"blob",content:Object(n.b)(m.content,"base64"),encoding:"base64"},h++;break;case i.a.Handle:{if(!e)throw Error("Parent summary does not exist to reference by handle.");let t=m.handle;t.length>0&&!t.startsWith("/")&&(t=`/${t}`),p=`${e}/${a}${t}`;break}case i.a.Attachment:p=m.id;break;default:Object(r.a)(m,`Unknown type: ${m.type}`)}const b={path:encodeURIComponent(d),type:Object(o.g)(m)};let S;if(u)Object(s.a)(void 0===p,173),S=Object.assign(Object.assign({value:u},b),{unreferenced:y});else{if(!p)throw new Error(`Invalid tree entry for ${m.type}`);S=Object.assign(Object.assign({},b),{id:p})}l.entries.push(S)}return{snapshotTree:l,blobs:h}}}}}]);
//# sourceMappingURL=summarymodule.be4df12a487cbafd3aa8.chunk.v7.js.map