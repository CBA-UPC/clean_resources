!function(e){"use strict";const t=/pbstck:debug/.test(window.location.href),n=!!window.localStorage.getItem("pbstck"),o=(e,o,...r)=>{(t||n)&&console[e](`[pbstckUserSessions-0a43cc9] [${performance.now().toFixed(2)}] ${o}`,...r.length?r:"")},r=(e,...t)=>{o("warn",e,...t)},i=(e,...t)=>{o("log",e,...t)},a=(e,...t)=>{o("error",e,...t)},s=["pbstck:","pbstck_context:"],c=()=>{const e=document.getElementsByTagName("meta"),t=Array.from(e).filter((e=>d(s,e.name))),n=new Map;t.forEach((e=>{const t=u(e.name);n.has(t)&&r(`Custom dim ${t} is present many times`),n.size<20?n.set(t,e.content):r(`Skipping custom dim ${t} with ${e.content}: limit of 20 keys exceeded`)}));const o=Object.assign({},...Array.from(n.entries()).map((([e,t])=>({[e]:t}))));return n.size>0&&i("Custom dim found :",o),o},u=e=>e.replace(/^\w+:/,""),d=(e,t)=>e.some((e=>t.startsWith(e)));var p,m;!function(e){e.HISTORY_MUTATION="_pbstck_historyMutation",e.NEW_PAGE="_pbstck_pageView",e.SESSION_TRACKING_AUTHORIZED="_pbstck_sessionTrackingAuthorized",e.SESSION_TRACKING_DECLINED="_pbstck_sessionTrackingDeclined"}(p||(p={})),function(e){e.REPLACE_STATE="replaceState",e.PUSH_STATE="pushState"}(m||(m={}));const f=e=>{window.history[e]=new Proxy(window.history[e],{apply(t,n,o){const r=window.location.href,i=t.apply(n,o),a=new CustomEvent(p.HISTORY_MUTATION,{detail:{referrer:r,stateObj:o[0],title:o[1],url:o[2],type:e}});return dispatchEvent(a),i}})};let l;const g=new Uint8Array(16);function v(){if(!l&&(l="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!l))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return l(g)}const h=[];for(let e=0;e<256;++e)h.push((e+256).toString(16).slice(1));var w={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function y(e,t,n){if(w.randomUUID&&!t&&!e)return w.randomUUID();const o=(e=e||{}).random||(e.rng||v)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){n=n||0;for(let e=0;e<16;++e)t[n+e]=o[e];return t}return function(e,t=0){return h[e[t+0]]+h[e[t+1]]+h[e[t+2]]+h[e[t+3]]+"-"+h[e[t+4]]+h[e[t+5]]+"-"+h[e[t+6]]+h[e[t+7]]+"-"+h[e[t+8]]+h[e[t+9]]+"-"+h[e[t+10]]+h[e[t+11]]+h[e[t+12]]+h[e[t+13]]+h[e[t+14]]+h[e[t+15]]}(o)}const T=e=>{window.__pbstck_consent=e},E=e=>{window.__pbstck_session_tracking=e},S=()=>window.__pbstck_consent,b=()=>window.__pbstck_session_tracking,I=e=>{if("string"==typeof e){const t=e.split(/:\/\/(www.)?/g);return t.length<=1?null:t[t.length-1].split("/")[0]}const t=e.hostname;return t.startsWith("www.")?t.substring(4):t};var _;!function(e){e.DEV="dev",e.BETA="beta",e.PROD="prod"}(_||(_={}));class k extends Error{message="unknown session error"}class A extends k{message="session init error"}class C extends k{message="session parse error"}class N extends k{message="session not found error"}class D extends k{message="session obsolete error"}const L=Array(),O=(e,t)=>{const n=e.env===_.PROD?"":`_${e.env}`;return`_pbstck_session_${t.tagId.substring(0,8)}${n}`},P=e=>Date.now()-e>18e5,R=(e,t)=>{try{const o=localStorage.getItem(O(e,t));if(o){const e=JSON.parse(atob(o));if(n=e,L.every((e=>e in n)))return e;throw new C}throw new N}catch(e){if(e instanceof k)throw e;throw new C}var n},$=(e,t)=>{try{const n=R(e,t);return n.pageCount++,localStorage.setItem(O(e,t),btoa(JSON.stringify(n))),n.pageCount}catch(e){if(e instanceof k)throw e;throw new k}},U=(e,t)=>{const n=new URL(window.location.href),o={id:y(),lastUpdateTimeMs:Date.now(),pageCount:0,lastUrlVisited:window.location.href,utmSource:n.searchParams.get("utm_source")||null,utmCampaign:n.searchParams.get("utm_campaign")||null,utmContent:n.searchParams.get("utm_content")||null,utmTerm:n.searchParams.get("utm_term")||null,utmMedium:n.searchParams.get("utm_medium")||null};try{localStorage.setItem(O(e,t),btoa(JSON.stringify(o)))}catch(e){throw new A}},M=[],V=(e,t)=>{const n=M.map((n=>H(n,e,t)));if(n.length){const o=JSON.stringify(n),r=`${e.gateway}/page?${(()=>{const e=document.querySelector('meta[name="pbstck:kleanads-version"]')?.getAttribute("content")??"none",n=document.querySelector('meta[name="pbstck:config-version"]')?.getAttribute("content")??"none";return`tId=${t.tagId}&v=${e}&s=${n}&c=1`})()}`;navigator.sendBeacon&&navigator.sendBeacon(r,o)||fetch(r,{body:o,method:"POST",keepalive:!0}),i("[page] event queue dispatched",JSON.stringify(n)),M.length=0}},x=(e,t,n)=>{try{const r=F(t,n);try{const n=R(e,t);P(n.lastUpdateTimeMs)&&V(e,t)}catch(e){i("[page] session was not found or invalid, adding the new page to the queue anyway")}(o=r,M.push(o),i("[page] event queued",o),M.length)>=20&&V(e,t)}catch(e){e instanceof k?a(`[page] new page : ${e.message}`):a("[page] unknown error",e)}var o},B=(e,t)=>{x(e,t),window.addEventListener(p.SESSION_TRACKING_AUTHORIZED,(n=>{i(`[page] ${p.SESSION_TRACKING_AUTHORIZED}`,n);try{((e,t)=>{try{const n=R(e,t);if(P(n.lastUpdateTimeMs))throw new D;n.lastUpdateTimeMs=Date.now(),n.lastUrlVisited=window.location.href,localStorage.setItem(O(e,t),btoa(JSON.stringify(n)))}catch(n){if(n instanceof N||n instanceof C)return void U(e,t);if(n instanceof k)throw n;throw new k}})(e,t),V(e,t)}catch(n){n instanceof D&&(U(e,t),V(e,t))}})),window.addEventListener(p.SESSION_TRACKING_DECLINED,(n=>{i(`[page] ${p.SESSION_TRACKING_DECLINED}`,n),((e,t)=>{try{localStorage.removeItem(O(e,t))}catch(e){}})(e,t),V(e,t)})),window.addEventListener(p.HISTORY_MUTATION,(n=>{i(`[page] ${p.HISTORY_MUTATION}`,n),n.detail?.referrer.href!==window.location.href&&x(e,t,n.detail?.referrer)})),window.addEventListener("popstate",(n=>{x(e,t)})),window.document.addEventListener("visibilitychange",(()=>{i(`[page] visibility changed to ${document.visibilityState}`),"visible"!==document.visibilityState&&V(e,t)})),window.addEventListener("pagehide",(()=>{V(e,t)})),window.addEventListener("beforeunload",(()=>{V(e,t)}))},F=(e,t)=>{const n=new URL(window.location.href);return{...e,pageId:G(),pageCount:1,domain:I(window.location)??"",href:(o=window.location,o&&o.protocol&&o.host&&o.pathname?`${o.protocol}//${o.host}${o.pathname}`:"unknown"),referrer:I(t??document.referrer),consent:S(),userSessionId:null,sessionTracking:b(),utmSource:n.searchParams.get("utm_source"),utmCampaign:n.searchParams.get("utm_campaign"),utmContent:n.searchParams.get("utm_content"),utmTerm:n.searchParams.get("utm_term"),utmMedium:n.searchParams.get("utm_medium")};var o},H=(e,t,n)=>{try{const o=b();return{...e,pageCount:o?$(t,n):e.pageCount,userSessionId:o?R(t,n).id:null,consent:S(),sessionTracking:o,utmSource:o?R(t,n).utmSource:e.utmSource,utmCampaign:o?R(t,n).utmCampaign:e.utmCampaign,utmContent:o?R(t,n).utmContent:e.utmContent,utmTerm:o?R(t,n).utmTerm:e.utmTerm,utmMedium:o?R(t,n).utmMedium:e.utmMedium}}catch(t){if(t instanceof N)return e;t instanceof k?a(`[session] ${t.message}`):a("[session] unknown error",t)}return e},G=()=>{const e=y();return window.__pbstck_page_id=e,e};var q;!function(e){e[e.DENIED=0]="DENIED",e[e.GRANTED=1]="GRANTED",e[e.UNAVAILABLE=2]="UNAVAILABLE"}(q||(q={}));const K=async(e,t)=>{T(q.UNAVAILABLE),E(!1);let n=0;try{(await j(e))("addEventListener",2,(o=>{if(o){if("tcloaded"===o.eventStatus||"useractioncomplete"===o.eventStatus){T(Y(o));const e=Z(o)&&!t.sessionTrackingDisabled;E(e),e?dispatchEvent(new CustomEvent(p.SESSION_TRACKING_AUTHORIZED)):dispatchEvent(new CustomEvent(p.SESSION_TRACKING_DECLINED))}}else i(`[consent] wrong tcdata ${o}, waiting 200ms`),setTimeout((()=>{n++,100===n&&r("[consent] unable to retrieve cmp after 100 tries"),K(e,t)}),200)}))}catch(e){a("[consent] Error while loading tcf api")}},J=(e,t,n)=>{if(e.__tcfapi){const o=e.__tcfapi;(e=>"function"==typeof e)(e.__tcfapi)?t(o):n("__tcfapi is not a function")}else setTimeout((()=>J(e,t,n)),100)},j=e=>new Promise(((t,n)=>J(e,t,n))),Y=e=>e.purpose.consents&&e.purpose.consents[1]&&e.purpose.consents[2]&&e.purpose.consents[3]&&e.purpose.consents[4]&&e.purpose.consents[7]?q.GRANTED:q.DENIED,Z=e=>e.purpose.consents[1]&&e.purpose.consents[7]&&e.purpose.consents[8]?(i("[consent] SessionTracking obtained"),!0):(i("[consent] SessionTracking declined"),!1);var z,W,Q,X,ee,te=-1,ne=function(e){addEventListener("pageshow",(function(t){t.persisted&&(te=t.timeStamp,e(t))}),!0)},oe=function(){return window.performance&&performance.getEntriesByType&&performance.getEntriesByType("navigation")[0]},re=function(){var e=oe();return e&&e.activationStart||0},ie=function(e,t){var n=oe(),o="navigate";return te>=0?o="back-forward-cache":n&&(document.prerendering||re()>0?o="prerender":document.wasDiscarded?o="restore":n.type&&(o=n.type.replace(/_/g,"-"))),{name:e,value:void 0===t?-1:t,rating:"good",delta:0,entries:[],id:"v3-".concat(Date.now(),"-").concat(Math.floor(8999999999999*Math.random())+1e12),navigationType:o}},ae=function(e,t,n){try{if(PerformanceObserver.supportedEntryTypes.includes(e)){var o=new PerformanceObserver((function(e){Promise.resolve().then((function(){t(e.getEntries())}))}));return o.observe(Object.assign({type:e,buffered:!0},n||{})),o}}catch(e){}},se=function(e,t,n,o){var r,i;return function(a){t.value>=0&&(a||o)&&((i=t.value-(r||0))||void 0===r)&&(r=t.value,t.delta=i,t.rating=function(e,t){return e>t[1]?"poor":e>t[0]?"needs-improvement":"good"}(t.value,n),e(t))}},ce=function(e){requestAnimationFrame((function(){return requestAnimationFrame((function(){return e()}))}))},ue=function(e){var t=function(t){"pagehide"!==t.type&&"hidden"!==document.visibilityState||e(t)};addEventListener("visibilitychange",t,!0),addEventListener("pagehide",t,!0)},de=function(e){var t=!1;return function(n){t||(e(n),t=!0)}},pe=-1,me=function(){return"hidden"!==document.visibilityState||document.prerendering?1/0:0},fe=function(e){"hidden"===document.visibilityState&&pe>-1&&(pe="visibilitychange"===e.type?e.timeStamp:0,ge())},le=function(){addEventListener("visibilitychange",fe,!0),addEventListener("prerenderingchange",fe,!0)},ge=function(){removeEventListener("visibilitychange",fe,!0),removeEventListener("prerenderingchange",fe,!0)},ve=function(){return pe<0&&(pe=me(),le(),ne((function(){setTimeout((function(){pe=me(),le()}),0)}))),{get firstHiddenTime(){return pe}}},he=function(e){document.prerendering?addEventListener("prerenderingchange",(function(){return e()}),!0):e()},we=[1800,3e3],ye=function(e,t){t=t||{},he((function(){var n,o=ve(),r=ie("FCP"),i=ae("paint",(function(e){e.forEach((function(e){"first-contentful-paint"===e.name&&(i.disconnect(),e.startTime<o.firstHiddenTime&&(r.value=Math.max(e.startTime-re(),0),r.entries.push(e),n(!0)))}))}));i&&(n=se(e,r,we,t.reportAllChanges),ne((function(o){r=ie("FCP"),n=se(e,r,we,t.reportAllChanges),ce((function(){r.value=performance.now()-o.timeStamp,n(!0)}))})))}))},Te=[.1,.25],Ee={passive:!0,capture:!0},Se=new Date,be=function(e,t){z||(z=t,W=e,Q=new Date,ke(removeEventListener),Ie())},Ie=function(){if(W>=0&&W<Q-Se){var e={entryType:"first-input",name:z.type,target:z.target,cancelable:z.cancelable,startTime:z.timeStamp,processingStart:z.timeStamp+W};X.forEach((function(t){t(e)})),X=[]}},_e=function(e){if(e.cancelable){var t=(e.timeStamp>1e12?new Date:performance.now())-e.timeStamp;"pointerdown"==e.type?function(e,t){var n=function(){be(e,t),r()},o=function(){r()},r=function(){removeEventListener("pointerup",n,Ee),removeEventListener("pointercancel",o,Ee)};addEventListener("pointerup",n,Ee),addEventListener("pointercancel",o,Ee)}(t,e):be(t,e)}},ke=function(e){["mousedown","keydown","touchstart","pointerdown"].forEach((function(t){return e(t,_e,Ee)}))},Ae=[100,300],Ce=0,Ne=1/0,De=0,Le=function(e){e.forEach((function(e){e.interactionId&&(Ne=Math.min(Ne,e.interactionId),De=Math.max(De,e.interactionId),Ce=De?(De-Ne)/7+1:0)}))},Oe=function(){return ee?Ce:performance.interactionCount||0},Pe=function(){"interactionCount"in performance||ee||(ee=ae("event",Le,{type:"event",buffered:!0,durationThreshold:0}))},Re=[200,500],$e=0,Ue=function(){return Oe()-$e},Me=[],Ve={},xe=function(e){var t=Me[Me.length-1],n=Ve[e.interactionId];if(n||Me.length<10||e.duration>t.latency){if(n)n.entries.push(e),n.latency=Math.max(n.latency,e.duration);else{var o={id:e.interactionId,latency:e.duration,entries:[e]};Ve[o.id]=o,Me.push(o)}Me.sort((function(e,t){return t.latency-e.latency})),Me.splice(10).forEach((function(e){delete Ve[e.id]}))}},Be=[2500,4e3],Fe={},He=[800,1800],Ge=function e(t){document.prerendering?he((function(){return e(t)})):"complete"!==document.readyState?addEventListener("load",(function(){return e(t)}),!0):setTimeout(t,0)},qe=function(e,t){t=t||{};var n=ie("TTFB"),o=se(e,n,He,t.reportAllChanges);Ge((function(){var r=oe();if(r){var i=r.responseStart;if(i<=0||i>performance.now())return;n.value=Math.max(i-re(),0),n.entries=[r],o(!0),ne((function(){n=ie("TTFB",0),(o=se(e,n,He,t.reportAllChanges))(!0)}))}}))};function Ke(e,t,n,o){const r=()=>{const o=document.querySelector('meta[name="pbstck:kleanads-version"]')?.getAttribute("content")??"none",r=document.querySelector('meta[name="pbstck:config-version"]')?.getAttribute("content")??"none";return`${e.toLocaleLowerCase()}=${t.toFixed(3)}&tId=${n.tagId}&v=${o}&s=${r}&c=1`},i=b(),a=JSON.stringify([{...n,href:window.location.href,name:e,value:t,customFields:{...n.customFields,pageId:window.__pbstck_page_id,pageCount:String(i?R(o,n).pageCount:1),userSessionId:i?R(o,n).id:null,sessionTracking:String(i)}}]);navigator.sendBeacon&&navigator.sendBeacon(`${o.gateway}/web-vitals?${r()}`,a)||fetch(`${o.gateway}/web-vitals?${r()}`,{body:a,method:"POST",keepalive:!0})}const Je=(e,t)=>{!function(e,t){t=t||{},ye(de((function(){var n,o=ie("CLS",0),r=0,i=[],a=function(e){e.forEach((function(e){if(!e.hadRecentInput){var t=i[0],n=i[i.length-1];r&&e.startTime-n.startTime<1e3&&e.startTime-t.startTime<5e3?(r+=e.value,i.push(e)):(r=e.value,i=[e])}})),r>o.value&&(o.value=r,o.entries=i,n())},s=ae("layout-shift",a);s&&(n=se(e,o,Te,t.reportAllChanges),ue((function(){a(s.takeRecords()),n(!0)})),ne((function(){r=0,o=ie("CLS",0),n=se(e,o,Te,t.reportAllChanges),ce((function(){return n()}))})),setTimeout(n,0))})))}((n=>Ke("CLS",n.value,t,e))),ye((n=>Ke("FCP",n.value,t,e))),function(e,t){t=t||{},he((function(){var n,o=ve(),r=ie("LCP"),i=function(e){var t=e[e.length-1];t&&t.startTime<o.firstHiddenTime&&(r.value=Math.max(t.startTime-re(),0),r.entries=[t],n())},a=ae("largest-contentful-paint",i);if(a){n=se(e,r,Be,t.reportAllChanges);var s=de((function(){Fe[r.id]||(i(a.takeRecords()),a.disconnect(),Fe[r.id]=!0,n(!0))}));["keydown","click"].forEach((function(e){addEventListener(e,(function(){return setTimeout(s,0)}),!0)})),ue(s),ne((function(o){r=ie("LCP"),n=se(e,r,Be,t.reportAllChanges),ce((function(){r.value=performance.now()-o.timeStamp,Fe[r.id]=!0,n(!0)}))}))}}))}((n=>Ke("LCP",n.value,t,e))),function(e,t){t=t||{},he((function(){var n,o=ve(),r=ie("FID"),i=function(e){e.startTime<o.firstHiddenTime&&(r.value=e.processingStart-e.startTime,r.entries.push(e),n(!0))},a=function(e){e.forEach(i)},s=ae("first-input",a);n=se(e,r,Ae,t.reportAllChanges),s&&ue(de((function(){a(s.takeRecords()),s.disconnect()}))),s&&ne((function(){var o;r=ie("FID"),n=se(e,r,Ae,t.reportAllChanges),X=[],W=-1,z=null,ke(addEventListener),o=i,X.push(o),Ie()}))}))}((n=>Ke("FID",n.value,t,e))),function(e,t){t=t||{},he((function(){var n;Pe();var o,r=ie("INP"),i=function(e){e.forEach((function(e){e.interactionId&&xe(e),"first-input"===e.entryType&&!Me.some((function(t){return t.entries.some((function(t){return e.duration===t.duration&&e.startTime===t.startTime}))}))&&xe(e)}));var t,n=(t=Math.min(Me.length-1,Math.floor(Ue()/50)),Me[t]);n&&n.latency!==r.value&&(r.value=n.latency,r.entries=n.entries,o())},a=ae("event",i,{durationThreshold:null!==(n=t.durationThreshold)&&void 0!==n?n:40});o=se(e,r,Re,t.reportAllChanges),a&&("interactionId"in PerformanceEventTiming.prototype&&a.observe({type:"first-input",buffered:!0}),ue((function(){i(a.takeRecords()),r.value<0&&Ue()>0&&(r.value=0,r.entries=[]),o(!0)})),ne((function(){Me=[],$e=Oe(),r=ie("INP"),o=se(e,r,Re,t.reportAllChanges)})))}))}((n=>Ke("INP",n.value,t,e))),qe((n=>Ke("TTFB",n.value,t,e)))};e.pubstackAutoconfig=function(e){if(void 0===e.endpoint.gateway)return void a("[pbstckAutoconfig] no gateway url found in config");const t={gateway:e.endpoint.gateway,env:(n=e.endpoint.gateway,n.includes(_.DEV)?_.DEV:n.includes(_.BETA)?_.BETA:_.PROD),sessionTrackingDisabled:e.sessionTrackingDisabled??!1};var n;const o=window.top||window;o.pbstck=o.pbstck||{lock:{}},o.pbstck.lock=o.pbstck.lock||{};const r=`${e.tagId}@${t.env}@user-sessions`;if(o.pbstck.lock[r])return;o.pbstck.lock[r]=!0;const i={tagId:e.tagId,scopeId:e.scopeId,country:e.country,device:e.device,browserName:e.browserName,browserVersion:e.browserVersion,osName:e.osName,osVersion:e.osVersion,pbstckVersion:"0a43cc9",customFields:c()};i.tagId&&i.scopeId?(f(m.REPLACE_STATE),f(m.PUSH_STATE),(e=>{K(window,e)})(t),Je(t,i),B(t,i)):a("[pbstckAutoconfig] no tagId or scopeId found in context")}}(this.userSessions=this.userSessions||{});
