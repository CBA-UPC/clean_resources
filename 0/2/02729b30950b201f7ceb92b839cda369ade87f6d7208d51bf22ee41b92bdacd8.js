define("Emagister/Widget/Transaccional",["Emagister/Widget","Emagister/Element/Tooltip","Emagister/Element/Loader","Emagister/Service/Transactional/ResponseAnalyzer","Phoenix/Model/CrossSelling/LeadsCounter","Phoenix/Element/Login/AutologinGoogle","Phoenix/Element/Input/EmailChecker","Phoenix/Element/AjaxForm","Emagister/Model/User/UserInventoryField","Murdock/Element/Transaccional/MultiLeadForm"],function(e,m,r,t,i,d,o,a,l,s){var n=0,c=1,p=2,u=1,f=1,g="/web/transaccional/validate-telephone",h="/web/transaccional/track-link-out-lead",_="transaccional:sendFicha:success",v="transaccional:leadForm:closed",y="42",F="99",C="100",L="101",b="184",w="220",T="224",P="6",I="purchase",D="-1",E=".app_centerLeadFormOpener",S="/nc/web/transaccional/center-lead-form",k="#app_centerLeadForm",O="eboxy--loader",x="recommenderData",R="api/1.0/countries/6/city-from-postal-code/",A="/web/transaccional/track-direct-lead";"use strict";var V=V.prototype=new e;V.prototype.name="transaccional";V.prototype.loadOrder=1;V.prototype._showTooltip=true;V.courseCombo=null;V.prototype.crossSellingLeadsCounter=new i;V.prototype.loader=function(e,t){t||(t=function(){});if(e){var i=this._contentLayer.height();if(i){this._loaderLayer.height(i).css({display:"block",top:"0","margin-top":"0"})}$(".error").each(function(){$(this).removeClass("error");var e=m.create(this);e.destroy()});this._loaderLayer.css("display","block");U(this._transaccionalBox);t()}else{this._loaderLayer.css("display","none");U(this._transaccionalBox);t()}};V.prototype._validatePreSend=function(){return true};V.prototype.manageResponse=function(e){switch(e.errCode){case n:this.updateUserInventoryData(e);app.trigger("transaccional:sendFicha:ok",[e,this._ficha]);this._responseOK(e);break;case c:app.trigger("transaccional:sendFicha:error",[e,this._ficha,this.placeholder]);this._responseError(e);break;case p:this.updateUserInventoryData(e);app.trigger("transaccional:sendFicha:restriction",[e,this._ficha,this.placeholder]);this._responseRestriction(e);break}};V.prototype._sendFichaErrorFlag=false;V.prototype.setCommentFieldValue=function(){var e=$(".app_Comment",this._settings.form);if(e.length){if(e.val().length==0){e.val(e.attr("placeholder"))}}};V.prototype._getFormData=function(){this.setCommentFieldValue();return this._settings.form.serialize()};V.prototype.closeTelfInstantValidation=function(){if(this.campoTelefono&&this.campoTelefono.tooltipValidationTelf){this.campoTelefono.tooltipValidationTelf.hide();this.campoTelefono.tooltipValidationTelf.disable()}if(this.askPhoneField&&this.askPhoneField.validationTooltip){this.askPhoneField.validationTooltip.hide();this.askPhoneField.validationTooltip.disable()}};V.prototype.snapshotData=function(){var e=new FormData,t=$(this._settings.form),i=t.find('[data-idinv][type!="hidden"]'),a={};$.each(i,function(e,t){var i=$(t);if(i.data("idinv")==l.prototype.INVENTORY_PHONE_ID&&i.val()==""){throw"Empty user phone"}if(i.val()==""){return}if(i.val()==-1){return}a[i.data("idinv")]=i.val()});e.append("inventoryFieldsData",JSON.stringify(a));e.append("centerId",t.find("#idCentro").val());e.append("courseId",t.find("#idCurso").val());e.append("leadFormId",t.find("#idFicha").val());return e};V.prototype.getDataToPost=function(){var e=this._getFormData(),t=app.functions.getURLParameter("idSolicEmag"),i=this.recommenderDataFromStorage();e+=this.crossSellingLeadsCounter.queryString();if(typeof window.trackerVal!="undefined"){e+="&urlVirtual="+encodeURIComponent(window.trackerVal)}if(app.functions.recommenderOperatorCode()!==null){e+="&operatorCode="+app.functions.recommenderOperatorCode()}if(this._ficha.position>0){e+="&position="+this._ficha.position}if(t!==null){e+="&leadOrigin="+t}if(typeof i["eduOperador"]!=="undefined"){e+="&eduOperador="+i["eduOperador"]}if(typeof i["eduIdCentralCallCenter"]!=="undefined"){e+="&eduIdCentralCallCenter="+i["eduIdCentralCallCenter"]}if(typeof i["eduIdAux"]!=="undefined"){e+="&eduIdAux="+i["eduIdAux"]}e+="&projectOrigin="+window._egc.idProject;return e};V.prototype.recommenderDataFromStorage=function(){return $.jStorage.get(x,{})};V.prototype._sendFicha=function(){var e=this;this.loader(true);if(this._validatePreSend()){var t=this._settings.form.attr("action"),i=this.getDataToPost(),a=e._settings.form.find('input[name="idCurso"]').val(),o=e._settings.form.find('input[name="idFicha"]').val(),n=a+"|"+o;app.functions.addEvent("Form","showFormLead",n,1,true);$.ajax($.extend({},this._sendFichaAjaxSettings(),{url:t,type:"POST",data:i,xhrFields:{withCredentials:true}})).done(this.sendFichaSuccessCallback.bind(this)).fail(this.sendFichaErrorCallback.bind(this,n))}else{}};V.prototype.sendFichaSuccessCallback=function(e){this.manageResponse(e);app.functions.addEvent("Form","submitFormLead",e.courseId+"|"+e.leadFormId,1,true);app.trigger(_,[e])};V.prototype.sendFichaErrorCallback=function(e,t){var i=this,a=t+"|"+e.status;if(this._sendFichaErrorFlag){app.functions.addEvent("Form","sendError2ndTryFormLead",a,0,true);var o={idPuente:this._ficha.idPuente,idCentro:this._ficha.idCentro,idCurso:this._ficha.idCurso,tipoSolicitud:0,idEstado:0,valid:0};var n=this._settings.form.find('input[name="urlVentaCruzada"]').val();try{this._timeToSendLead()}catch(e){}window.setTimeout(function(){i.redirect(n+"?"+$.param(o))},200)}else{app.functions.addEvent("Form","sendErrorFormLead",a,0,true);this._sendFichaErrorFlag=true;this.sendFicha()}};V.prototype._doTrackingsAfterLead=function(e){e.callback=e.callback||(e.callback=function(){});e.eCommerce=e.eCommerce||{};this.sendPurchaseData(e.eCommerce);e.callback()};V.prototype.sendPurchaseData=function(e){var i=this;$.each(e,};V.prototype.createPurchaseEvent=function(e){if($.isEmptyObject(e)){return}try{if(typeof dataLayer==="undefined"){return}dataLayer.push({event:I,ecommerce:{transaction_id:e.transactionId,value:e.leadPrice,tax:e.tax,shipping:e.shipping,currency:e.divisa,coupon:e.coupon,items:[{item_name:e.name,item_id:e.internationalSearchId,search_id:e.searchId,price:e.leadPrice,item_brand:e.brand,item_category:e.category,item_category2:e.category2,item_category3:e.category3,item_category4:e.category4,item_category5:e.category5,item_variant:e.variant,course_price:e.coursePrice,affiliation:e.affiliation,quantity:1}]}})}catch(e){}};V.prototype.processCrossSellingUrl=function(e){return e.redirect};V.prototype._responseOK=function(e){var t=this,i={callback:function(){try{t._timeToSendLead()}catch(e){}t.trackDirectLead(e.idSolicEmag,t._ficha.idBusqueda,e.courseCountryOrigin);if(t.responseAnalyzer.isTwoStepLead(e)){return}if(t.hasToShowMultilead()){t.renderMultileadForm(e);return}window.setTimeout(function(){t.redirect(t.processCrossSellingUrl(e))},200)},...e};this._doTrackingsAfterLead(i)};V.prototype.updateUserInventoryData=function(e){if(!e.inventoryData){return}app.userInventory.update(e.inventoryData)};V.prototype.redirect=function(e){if(!this._ficha.redirectionDisabled){window.location=e;return}N(this._transaccionalBox)};V.prototype._responseError=function(e){var i=this,t=e.errors,a=e.urlVirtual,o="FICHA_Debes completar todos los campos.",n=if(i.campoTelefono&&i.campoTelefono.tooltip){i.campoTelefono.tooltip.destroy()}$.each(t,function(){if(n(this)){return}var t=i._sendLayersScope.find("#campo_"+this.idCampoFicha),e=this.mensaje;if(i._showTooltip){t.tooltip=m.create(t);t.tooltip.enable();t.tooltip.init(e,{showOn:"focus",alignX:!t.is(":checkbox")?"right":"left",alignY:"center",offsetX:5});t.addClass("error").on("change",;t.parents(".app_fichaField").removeClass("coa--hidden");t.removeAttr("readonly");t.on("keypress",}});this.loader(false);this._sendLayersScope.find(".mrojo").empty().append(app.dict._(o)).slideDown(400,function(){window.setTimeout(400)})};V.prototype._timeTrackingCalc=function(e,t,i){var a=this,o=i-t,n={};if(o){if(typeof a._ficha!="undefined"){n={time:o,event:e,idCurso:a._ficha.idCurso,idCentro:a._ficha.idCentro,idPuente:a._ficha.idPuente}}else{n={time:o,event:e}}var r=document.createElement("img");r.alt="";r.width="0";r.height="0";r.src=window._egc.baseUrl+"/web/ajax/stats/?"+$.param(n)}};V.prototype._timeToLoadLayer=function(){this._timeTracking.stopRetrieveFormTime=new Date;this._timeTrackingCalc("timeToLoadLayer",this._timeTracking.startRetrieveFormTime,this._timeTracking.stopRetrieveFormTime)};V.prototype._timeToSendLead=function(){this._timeTracking.stopSendLeadTime=new Date;this._timeTrackingCalc("timeToSendLead",this._timeTracking.startSendLeadTime,this._timeTracking.stopSendLeadTime)};V.prototype._responseRestriction=function(e){var t=this,i=e.urlVirtual;if(i.data){try{var a=_gat._getTracker(i.account);a._trackPageview(i.data)}catch(e){}}try{t._timeToSendLead()}catch(e){}t.trackDirectLead(e.idSolicEmag,t._ficha.idBusqueda,e.courseCountryOrigin);if(t.hasToShowMultilead()){t.renderMultileadForm(e);return}window.setTimeout(200)};V.prototype._createBoxy=function(){var t=this,e=window._egc.baseUrlCdn||"",i=0,a=false,o=[".web_search_search_responsive",".web_curso_index_responsive",".web_curso_international_responsive",".web_centro_index_responsive",".web_centro_international_responsive",".web_centro_index-premium_responsive",".web_centro_international-premium_responsive",".web_universidades_centro_responsive",".web_curso_venta-cruzada-panel-usuario_responsive",".web_oposiciones_home_responsive",".web_oposiciones_announcement_responsive",".web_universidades_titulacion_responsive",".web_titulaciones_index_responsive",".web_centro_reviews_responsive",".web_curso_venta-cruzada-panel-usuario_responsive",".cursos-el-pais",".landing-mobile",".infojobs_center_index_responsive",".infojobs_home_index_responsive",".infojobs_sector_index_responsive"],n=true,r="has-lead-modal-open";if($("body").is(o.join(", "))){a=true}this._transaccionalBox=new Boxy("<div id='tL' class='modal modal-large'><div class='loader-wrp'><img class='test_spinner' src='"+e+"/assets/themes/phoenix/img/loaders/loader-big.gif' width='48' height='48' /></div><div id='tL-content'></div></div>",{show:false,draggable:false,fixed:true,modal:false,unloadOnHide:true,closeOffTheBoxy:false,afterShow:function(){app.functions.ponerCapaOscura();if(a&&app.functions.isMobile()){if(n){window.location.hash="lead"}if(typeof app.widgets.mobilesectioncontrol!=="undefined"){i=app.widgets.mobilesectioncontrol.hideLayer()}if(window.pageYOffset&&!i){i=window.pageYOffset}app.functions.disableMobileModalBackgroundScrolling()}$("html").addClass(r)},afterHide:function(){t.closeTelfInstantValidation();app.functions.quitarCapaOscura();if(a&&app.functions.isMobile()){var e=$("body").hasClass("web_search_search_responsive");app.functions.enableMobileModalBackgroundScrolling();window.scrollTo(0,i);if(n&&window.location.hash==="#lead"){if(e){history.pushState("",document.title,window.location.pathname+window.location.search)}else{window.history.back()}}}$("html").removeClass(r);$(app).trigger(v)}});if(n&&app.functions.isMobile()){window.onhashchange=function(){if(t._transaccionalBox.boxy.find("#tL-content:visible").length){if(window.location.hash==="#details"){window.history.back()}else if(window.location.hash===""){if($("body").hasClass("web_curso_venta-cruzada-panel-usuario_responsive")){t._contentLayer.find(".close").trigger("click")}else{N(t._transaccionalBox)}}}else if(window.location.hash==="#details"&&!$(".mobile-layer:visible").length){window.history.back()}}}this._loaderLayer=this._transaccionalBox.boxy.find(".loader-wrp");this._contentLayer=this._transaccionalBox.boxy.find("#tL-content");this._contentLayer.on("click",".close",function(){t.createUserLeadFormSnapshot();app.exitIntent.deactivate();N(t._transaccionalBox)})};V.prototype.getFichaParamsToSend=function(){return{incluirBorde:0,idCurso:this._ficha.idCurso,idCentro:this._ficha.idCentro,idPuente:this._ficha.idPuente,isDirectLead:this.getDirectLead(),forceDirectLead:this._ficha.forceDirectLead,multileadDisabled:this._ficha.multileadDisabled,isLandingDirect:this._ficha.isLandingDirect,headerLayer:this._settings.headerLayer,idProvider:this._ficha.idProvider,sidOrigin:this._ficha.sidOrigin}};V.prototype._getFichaRequestData=function(){var e=this.getFichaParamsToSend();if(this._settings["baseParamsFormRequest"]){e=$.extend({},this._settings["baseParamsFormRequest"],e)}return e};V.prototype.getRetrieveFichaUrl=V.prototype._retrieveFicha=function(e,t,i){this.callback=e||function(){};this.placeholder=t||this._contentLayer;i=i||false;this.loader(true);app.trigger("transaccional:fichaLoad:pre",[this.placeholder]);var a=this;$.ajax($.extend({},this._retrieveFichaAjaxSettings(),{url:this.getRetrieveFichaUrl(),data:this._getFichaRequestData()})).fail(function(e){app.functions.addEvent("Form","retrieveErrorFormLead",a._ficha.idCurso+"|"+a._ficha.idPuente+"|"+e.status,0,true)}).done(};V.prototype.presetFieldsFromUserInventory=function(r){var s=this,c=false,e=$(r),t=e.find('[data-idinv][type!="hidden"]');this.leadFormIsComplete=true;this.presetCallingHours();t.each(function(e,t){var i=$(t),a=i.data("idinv"),o=app.userInventory.get(a);if(o===null&&a===l.prototype.INVENTORY_POSTAL_CODE_ID){return}if(o===null){s.leadFormIsComplete=false;return}if(i.is(":radio")){i.each(function(){var e=o.getValue();if(o.isSex()){e=o.getValue()=="H"?0:1}if($(this).val()==e){$(this).prop("checked",true);i.trigger("change")}})}else{if(i.length){i.val(o.getValue()).addClass("campo-inventariado");i.trigger("change");if(o.isCountry()&&parseInt(o.getValue())>0){M(r);c=true}if(o.isPhone()){var n=i.val().split("/");if(n.length>1){i.val(n[1])}}}}});if(e.find("#campo_centerLegalTermsAccepted").length!==0){this.leadFormIsComplete=false}$(".app_onChangeHide").trigger("change");if(!c&&!$('input[name="leadToComplete"]').value){this._doGeoLocalization(app.functions.trim($('[data-idinv="'+l.prototype.INVENTORY_PROVINCE_ID+'"]').last().val()))}};V.prototype.changeLeadFormToShowIncompleteForm=function(a){a.find('[data-idinv][type!="hidden"]').each(function(e,t){var i=$(t);if(app.userInventory.get(i.data("idinv"))!=null){i.attr("readonly",true);i.parents(".app_fichaField").addClass("coa--hidden");a.find(".app_fichaFields").addClass("one-column")}});if(H()){this.presetPrivacyPolicy(a);this.hidePrivacyPolicy(a)}a.find(".app_leadFormSubTitle").text(app.dict._("web2021:formulariosolicitud:extralead:txt")).removeClass("hidden")};V.prototype.presetPrivacyPolicy=V.prototype.hidePrivacyPolicy=V.prototype.presetCallingHours=V.prototype.presetCallingHours24h=function(){var e=l.prototype.INVENTORY_CALLING_HOURS_24H_ID,t=$('[data-idinv="'+e+'"]'),i=this.callingHours24hValue();t.each(function(){var e=$(this);if(e.val()!==null&&e.val()!=D){return}e.val(i)})};V.prototype.callingHours24hValue=function(){var e=(new Date).getHours(),t=0,i=1,a=2;if(e>=7&&e<14){return t}if(e>=14&&e<19){return i}return a};V.prototype.presetCallingHours12h=function(){var e=$('[data-idinv="'+l.prototype.INVENTORY_CALLING_HOURS_12H_ID+'"]'),t=this.callingHours12hValue();if(t==null){return}e.each(function(){var e=$(this);if(e.val()!==null&&e.val()!=D){return}e.val(t)})};V.prototype.callingHours12hValue=function(){var e=(new Date).getHours(),t=80512,i=80513,a=80514;if(e>=7&&e<12){return t}if(e>=12&&e<15){return i}if(e>=15&&e<19){return a}return null};V.prototype._showBoxy=V.prototype.createSnapshotUrl=function(){return window._egc.baseUrl+"/web/transaccional/create-user-lead-form-snapshot"};V.prototype.createUserLeadFormSnapshot=function(){if(H()){return}try{navigator.sendBeacon(this.createSnapshotUrl(),this.snapshotData())}catch(e){}};V.prototype._openFicha=function(e){this._createBoxy();this._showBoxy();this._retrieveFicha(e)};V.prototype.createInstantValidationTooltips=function(){var e={alignX:"center",alignY:"top",offsetX:5,className:"tip-grey",hideDelayed:500};this.campoTelefono.tooltipValidationTelf=m.create($(".campo-telefono"));this.campoTelefono.tooltipValidationTelf.init(app.dict._("web:form:telefono:instant-validation"),e);this.campoTelefono.tooltipValidationTelf.disable();this.askPhoneField.validationTooltip=m.create($(".app_askPhoneField"));this.askPhoneField.validationTooltip.init(app.dict._("web:form:telefono:instant-validation"),e);this.askPhoneField.validationTooltip.disable()};V.prototype._initForm=function(t){var h=this,e=t.find("#frmFicha"),i=e.find("[type=email]"),a=function(t,i){return function(e){e.preventDefault();if($(e.currentTarget).hasClass("app_directLead")){app.functions.addEvent("FormTrackings","WebDirectLead-Send");$(document).trigger("changePFOrigen","92")}t.apply(this,arguments);i.submit();app.trigger("transaccional:form-ficha:submitted")}};new o(i);t.find(".app_noLead").off("click").on("click",a(function(){$(".leadbar").fadeOut("fast");h._ficha.msgNoContacta=true},e));t.find(".app_esLead").off("click").on("click",a(function(){$(".leadbar").fadeOut("fast");h._ficha.msgNoContacta=false},e));t.find(".app_financing").off("click").on("click",function(e){if(this.checked==true){t.find(".app_esLead").text(app.dict._("web2018:formulariosolicitud:financing:button"))}else{t.find(".app_esLead").text(app.dict._("commons:btn:lead"))}app.functions.addEvent("FormTrackings","selectOption","Sequra",1,false)});this.courseCombo=$("#idCurso",h._contentLayer);this.bindCentroFicha();e.on("submit",function(e){e.preventDefault();h._timeTracking={};h._timeTracking.startSendLeadTime=new Date;if($(this).parents().is(h.formOnPage)){h._loaderLayer=h.formOnPage.find(".loader-wrp");h._contentLayer=h.formOnPage.find("#frmFicha")}else{h._loaderLayer=h._transaccionalBox.boxy.find(".loader-wrp");h._contentLayer=h._transaccionalBox.boxy.find("#tL-content")}h.closeTelfInstantValidation();h._sendLayersScope=$(this).parents(".ficha-wrapper");h._settings.form=$("#frmFicha",h._sendLayersScope);h._sendFicha();return false});t.on("change",".app_onChangeHide",function(){var e=$(this);var t=e.data("hideon");var i=$("input[data-idinv="+e.data("hideinv")+"]");if(e.val()==t){i.parent().hide()}else{i.parent().show()}});h.campoTelefono={};h.askPhoneField={};h.createInstantValidationTooltips();t.find(".campo-pais").off("change").on("change",function(e,i){var t=$(this),a=t.val(),o=t.parents("#frmFicha"),n=o.find("#"+t.data("idprovincia")),r=t.attr("idPaisCentro");i||(i=function(){});require(["Emagister/Model/PaisProvincia"],function(e){var t=new e;t.retrieveProvincias(a,function(e){var t;n.empty();n.append(new Option(app.dict._("PCURSO_-- Seleccionar --"),"-1"));$.each(e,function(){t=this.id==app.userInventory.province()||app.geoip.province&&this.id==app.geoip.province.id;n.append(new Option(this.desc,this.id,t,t))});i()})});var s=t.parents("#frmFicha").find("#codInternacional");var c=t.parents("#frmFicha").find("#codInternacional");var d=t.parents("#frmFicha").find("#explicacionLayer");var l=t.parents("#frmFicha").find('input[data-idinv="9"]');var p=t.parents("#frmFicha").find('input[data-idinv="16"]');var u=t.val();h.refreshInternationalCode(u,s,c,d,l);if(u!=r&&l.length){if(r==42&&(u==42||u==100||u==99||u==101||u==224||u==220||u==184)){s.hide();l.removeClass("prefixedPhone");s.attr("value","");c.attr("value","");d.html("");return false}if(r==15&&u==15){s.hide();l.removeClass("prefixedPhone");s.attr("value","");c.attr("value","");d.html("");return false}var f="";if(t.val()==7){f=app.dict._("FICHA_Layer info telefono")}else if(t.val()==2){f=app.dict._("FICHA_Layer info telefono_AR")}else if(t.val()==5){f=app.dict._("FICHA_Layer info telefono_CL")}else if(t.val()==4){f=app.dict._("FICHA_Layer info telefono_CO")}if(h.campoTelefono&&h.campoTelefono.tooltip){h.campoTelefono.tooltip.destroy()}if(f!=""){if($(".campo-telefono").length&&$(".campo-telefono").val().length===0){h.campoTelefono.tooltip=new m($(".campo-telefono"));h.campoTelefono.tooltip.init(f,{className:"tip-twitter",showTimeout:1,showOn:"focus",alignTo:"target",alignX:"center",alignY:"bottom",offsetX:5})}}}if(p.length){switch(u){case y:case F:case C:case L:case b:case w:case T:p.removeAttr("pattern");p.removeAttr("inputmode");break;default:p.attr("pattern","[0-9]*");p.attr("inputmode","numeric")}}});t.on("focusout",".campo-telefono",function(e){var t=$(".campo-telefono");var i=t.val();if(i!=""){var a={telephone:$(".campo-telefono").val(),idPais:app.functions.trim($('[data-idinv="17"]').last().val()),idProvincia:app.functions.trim($('[data-idinv="18"]').last().val())};$.ajax({url:h.retrieveFichaBaseDomain()+g,data:a,dataType:"json",cache:true}).done(function(e){if(e.isValid!=true){h.campoTelefono.tooltipValidationTelf.enable();h.campoTelefono.tooltipValidationTelf.show()}else{h.closeTelfInstantValidation()}})}});this.initCityInferenceFromPostalCode(t);app.gui.notifyChange()};V.prototype.initCityInferenceFromPostalCode=function(e){var t=this;if(!_egc.leadFormCityInferenceEnabled){return}if(!this.leadFormHasCityField(e)){return}e.find('[data-idinv="'+l.prototype.INVENTORY_POSTAL_CODE_ID+'"]').on("change",};V.prototype.guessCityFromPostalCode=function(t,e){if(!e){return}var i=t.find('[data-idinv="'+l.prototype.INVENTORY_COUNTRY_ID+'"]').val(),a=window._egc.emagisterApiBaseUrl||"https://www.emagister.com/";if(i!==P){return}$.get(a+R+e,function(e){t.find('[data-idinv="'+l.prototype.INVENTORY_CITY_ID+'"]').val(e.name)})};V.prototype.leadFormHasCityField=function(e){return e.find('[data-idinv="'+l.prototype.INVENTORY_CITY_ID+'"]').length!==0};V.prototype.retrieveFichaBaseDomain=function(){var e=$("#frmFicha").attr("action");if(e.indexOf("http")===-1){return""}return e.replace(/((https?:\/\/)?[^/]+\/)(.+)/,"$1")};V.prototype.refreshInternationalCode=function(e,i,a,t,o){var n={idPais:e};$.ajax({url:window._egc.baseUrl+"/root/cboload/getJSONCodInt",data:n,dataType:"json",async:false,cache:true}).done(function(e){i.show();o.addClass("prefixedPhone");i.attr("value",app.functions.trim(e.codigoTelefonico));a.attr("value",app.functions.trim(e.codigoTelefonico));if(o.val()&&o.val().length>0){var t=o.val().split("/");if(t.length>1){o.val(t[1])}}})};V.prototype.retrieveFichaDataAttributesFromLeadButton=function(e){return{idCurso:$(e).data("idcurso"),idCentro:$(e).data("idcentro"),idPuente:$(e).data("idpuente"),idBusqueda:$(e).data("idbusqueda"),sidOrigin:$(e).data("sidorigin"),position:$(e).data("position")||0,redirectionDisabled:$(e).data("redirectiondisabled")===1}};V.prototype.populateFicha=V.prototype._doBinds=V.prototype.bindOpenLeadFormClick=function(){var n=this;$(document).on("click",this._getOpenFichaStr(),function(e,t){var i=$(this);n._timeTracking={};n._timeTracking.startRetrieveFormTime=new Date;n.populateFicha(n.retrieveFichaDataAttributesFromLeadButton(this));if(n._ficha.position!=0){app.functions.addEvent("PosiciÃ³n_item","posicion_"+n._ficha.position)}if(i.data("islandingdirect")==false){n._ficha.isLandingDirect=0}else{n._ficha.isLandingDirect=1}n._ficha.isDirectLead=i.data("isdirectlead")||0;n._ficha.forceDirectLead=i.data("forcedirectlead")||0;n._ficha.multileadDisabled=i.data("multileaddisabled")||0;n._ficha.msgNoContacta=false;var a=i.attr("data-linkoutleadurl");if(a){e.preventDefault();app.functions.addEvent("ServiceLinkOut",n._ficha.idCentro,n._ficha.idCurso,1,false);$.post(window._egc.baseUrl+h,{centerId:n._ficha.idCentro,courseId:n._ficha.idCurso});window.open(a,"_blank");return false}n._ficha.clickOutUrl=i.attr("data-url");if(n._ficha.clickOutUrl){e.preventDefault();var o=n._ficha.clickOutUrl.replace("[id_curso]",n._ficha.idCurso);o=o.replace("[id_centro]",n._ficha.idCentro);o=o.replace("[id_puente]",n._ficha.idPuente);app.functions.addEvent("ClickOut","EmagisterExpress");location.href=o;return false}if(i.attr("data-idprovider")){n._ficha.idProvider=$(this).attr("data-idprovider")}n._settings.baseParamsFormRequest||(n._settings.baseParamsFormRequest={});if(i.attr("data-idprovincia")){n._settings.baseParamsFormRequest.lastProvincia=$(this).attr("data-idprovincia");n._settings.baseParamsFormRequest.useLastProvincia=1}else if(i.attr("data-isrecomendador")){n._settings.baseParamsFormRequest.useLastProvincia=1}n._openFicha(t);if($(".campo-telefono-tooltip").length){if(n.campoTelefono&&n.campoTelefono.tooltip){n.campoTelefono.tooltip.destroy()}n.campoTelefono.tooltip=new m($(".campo-telefono-tooltip"));n.campoTelefono.tooltip.init(app.dict._("web:form:telefono:tooltip"),{className:"tip-twitter",showTimeout:1,showOn:"focus",alignTo:"target",alignX:"center",alignY:"bottom",offsetX:5})}return false})};V.prototype.bindOpenCenterLeadFormClick=function(){var i=this;$(document).on("click",E,function(){var t=$(this).data("idcentro");i.showLoader();$.get(S,{centerId:t,providerId:$(this).data("idprovider")},function(e){i.showCenterLeadFormLayer(t,e);i.populateCenterLeadFormFromInventory();i.addCenterLeadFormShowEvent(t);i.hideLoader()})})};V.prototype.showLoader=function(){$("body").addClass(O)};V.prototype.hideLoader;V.prototype.showCenterLeadFormLayer=function(e,t){var i=this;this.centerLeadFormLayer=new Eboxy(t,{show:false,modal:false,draggable:false,fixed:true,customClass:"center-lead-form"});this.centerLeadFormLayer.eboxy.on("click","#app_centerLeadFormClose");new a(k,{allowButtonDisableOnError:false,onSubmitHandler:function(){i.addCenterLeadFormSubmitEvent(e)},successHandler:function(e){i.updateUserInventoryData(e);$(window).attr("location",e.redirect.url)}}).check();this.centerLeadFormLayer.show()};V.prototype.populateCenterLeadFormFromInventory=function(){var e=$("#app_centerLeadForm");e.find("#app_name").val(app.userInventory.name());e.find("#app_surname").val(app.userInventory.surname());e.find("#app_mail").val(app.userInventory.mail());e.find("#app_phoneNumber").val(app.userInventory.phone())};V.prototype.addCenterLeadFormShowEvent=function(e){app.functions.addEvent("Form","showFormCenter",e,1,true)};V.prototype.addCenterLeadFormSubmitEvent=function(e){app.functions.addEvent("Form","submitFormCenter",e,1,true)};V.prototype.bindBoxyContentChange=function(){var e=this;$(app).on("boxyContentChange")};V.prototype.bindSendFichaSuccessEvent=function(){var i=this;$(app).off(_).on(_,function(e,t){i.doDataLayerTrackings(t)})};V.prototype.bindMultileadEvents=function(e,t){var a=this,i=[e.EVENT_SUCCESS,e.EVENT_SOME_LEAD_SUCCESS];e.on(e.EVENT_EXTRA_FIELDS_FORM_IS_EMPTY,function(){a.redirect(t)});e.on(i.join(" "),function(e,t,i){$.each(t.leadsResults,function(e,t){a.addMultileadResultEvent(t);if(!t.isOk&&!t.hasUnrecoverableErrors){return}a.markAsDirectLead(e);if(i){a.markAsPartialDirectLead(e)}a.trackDirectLead(t.leadId,e,null)})});e.off(e.EVENT_ERROR).on(e.EVENT_ERROR,function(e,t){$.each(t.leadsResults,function(e,t){a.addMultileadResultEvent(t)})})};V.prototype.addMultileadResultEvent=function(i){var e,t;if(i.isOk){e=i.ecommerceData||{};t=i.conversionData||{};this.addLeadEventToDataLayer(t);this.createPurchaseEvent(e);return}$.each(i.errors,function(e,t){app.functions.addEvent("Form","errorFormLead",i.courseId+"|"+i.leadFormId+"|"+t.message,0,true)})};V.prototype.bindLeadFormPlaceholderVisibility=function(){$(app).on("transaccional:fichaLoad:pre");$(app).on("transaccional:fichaLoad:post",function(e,t,i,a){a&&a.show()});$(app).on("transaccional:sendFicha:error",function(e,t,i,a){a&&a.show()})};V.prototype.doDataLayerTrackings=function(e){if(e.errCode===n){this.addLeadEventsToDataLayer(e)}else{this.addLeadErrorEventsToDataLayer(e)}};V.prototype.addLeadErrorEventsToDataLayer=function(e){if(e.errors===null){return}$.each(e.errors,function(){app.functions.addEvent("Form","errorFormLead",e.courseId+"|"+e.leadFormId+"|"+this.mensaje,0,true)})};V.prototype.addLeadEventsToDataLayer=function(e){var i=this;if(typeof dataLayer==="undefined"){return}$.each(e.conversions)};V.prototype.addLeadEventToDataLayer=function(e){if($.isEmptyObject(e)){return}app.functions.addEventToDataLayer("Form","generateLead",e.leadStatus+"|"+e.idSolicEmag,parseInt(e.leadPrice),false)};V.prototype._doGeoLocalization=function(e){app.geoip.load(function(e){try{if(app.geoip.loaded){var t=$('[data-idinv="18"]').last();if(!t.is("select")){$('[data-idinv="17"]').last().val(app.geoip.country.id);t.val(app.geoip.province.id)}else{$('[data-idinv="17"]').last().val(app.geoip.country.id).trigger("change")}if($('[data-idinv="7"]').last()){$('[data-idinv="7"]').last().val(app.geoip.country.id).trigger("change")}}}catch(e){app.log("transactional geolocalization failed","WARNING")}})};V.prototype._doTpsTransaction=function(e){var t="";var i="";if($.cookie("TOP_SEARCHES")&&$.cookie("TOP_SEARCHES")!=""){t="spyTPS"+e.idSolicEmag;i=$.cookie("TOP_SEARCHES").split("/");if(i.length>1){window[t]=new Image(1,1);window[t].src=window._egc.baseUrl+"/web/analytics/tpstransaction?q="+i[0]+"&solic="+e.orderId+"&s="+i[1]}}if($.cookie("TOP_SEARCHES_VISITA")&&$.cookie("TOP_SEARCHES_VISITA")!=""){t="spyTPSref"+e.idSolicEmag;i=$.cookie("TOP_SEARCHES_VISITA").split("/");if(i.length>2){window[t]=new Image(1,1);window[t].src=window._egc.baseUrl+"/web/analytics/visitatpstransaction?id="+i[0]+"&q="+i[1]+"&solic="+e.orderId+"&s="+i[2]}}};V.prototype.showFicha=function(e){e||(e=function(){});$(this._settings.openFicha.get(0)).trigger("click",e)};V.prototype.sendFicha;V.prototype.getDirectLead;V.prototype.loadAsynFicha=function(e,t){var i=this,a,o=this._settings["baseParamsFormRequest"];this._contentLayer=e;this._loaderLayer=this.formOnPage;a=app.functions.parseDataScript(this._contentLayer);if(this._settings["baseParamsFormRequest"]){this._settings.baseParamsFormRequest=$.extend({},o,a)}else{this._settings.baseParamsFormRequest=a}this.populateFicha(a);this._retrieveFicha(t,e,true);o&&(this._settings.baseParamsFormRequest=o)};V.prototype._getOpenFichaStr;V.prototype._sendFichaAjaxSettings=function(){return{dataType:"json",cache:false}};V.prototype._retrieveFichaAjaxSettings;V.prototype.bindCentroFicha=function(){var i=$("#idCateg",this._contentLayer),a=$("#idCurso",this._contentLayer),o=new r(this._contentLayer,{size:"big"}),n=this;if(i.length){i.on("change",function(e){$(this).data("changed",true);var t={idCentro:i.attr("data-idcentro"),idCategSeg:this.value,segmentId:$(this).find("option:selected").data("segmentid")};$(".app_fichaFields, .app_fichaFooter").hide();$(".ficha-more-info").html(app.dict._("Web:FormularioSolicitud:Titulo:Txt"));U(this._transaccionalBox);if(this.value===D){a.prop("disabled",true);return}o.on();$.ajax({url:n.getRetrieveCoursesOfCenterByCatgoryUrl(),data:t,dataType:"json",cache:true}).done(function(e){var i='<option value="'+D+'">'+app.dict._("PCURSO_-- Seleccionar --")+"</option>";$.each(e,function(e,t){i+='<option value="'+t["id_curso"]+'" data-idpuente="'+t["id_puente"]+'" data-idbusqueda="'+t["id_busqueda"]+'">'+t["titulo"]+"</option>"});a.html(i);a.prop("disabled",false);o.off()})});a.on("change",function(){this.selectedOption=$(this).find("option:selected");this.placeholder=n._contentLayer;this.callback=function(){};this.requestData={idCentro:i.data("idcentro"),idCurso:this.selectedOption.val(),idPuente:this.selectedOption.data("idpuente"),mostrarCombo:true};n._ficha.idBusqueda=this.selectedOption.data("idbusqueda");var t=this;o.on();$.ajax({url:n.getRetrieveFichaUrl(),data:$.extend(n._getFichaRequestData(),this.requestData)}).done)})}};V.prototype.getRetrieveCoursesOfCenterByCatgoryUrl;V.prototype.retrieveFichaCallback=function(e,t,i){e=e.body||e;var a=this;$(".app_fichaFake").hide();t.placeholder.html(e);var o=t.placeholder.find("#frmFicha");this._initForm(t.placeholder);this._settings.form=o;this.presetFieldsFromUserInventory(o);if(H()){this.presetPrivacyPolicy(o)}if(this.shouldDoDirectLead(t.placeholder)){try{this._timeToLoadLayer()}catch(e){}o.trigger("submit");a.markAsDirectLead(this._ficha.idBusqueda);return}if(this.shouldShowIncompleteLeadForm(i,t.placeholder)){this.changeLeadFormToShowIncompleteForm(o);a.markAsPartialDirectLead(this._ficha.idBusqueda)}var n=[".landing-mobile"];if($("body").is(n.join(", "))||!app.functions.isMobile()){if(!a.isInlineLeadForm(o)){app.functions.putFocusOnFirstEmptyInput(o)}}var r=o.find('input[name="idCurso"]').val();var s=o.find('input[name="idFicha"]').val();app.functions.addEvent("Form","showFormLead",r+"|"+s,1,true,true);app.functions.addEventModalGtm("form","lead-form","button:lead-button:course:"+r);if($("#frmFicha2").length>0){cargarProvincias($("#frmFicha2 select#pais2")[0],$("#frmFicha2 select#provincia2")[0]);new AjaxFormManager($("#frmFicha2"),AjaxFormManager.prototype.ERR_DISPLAY_STANDAR);$("#cerrar").on("click",function(){cargarProvincias($("#frmFichaMC select#pais")[0],$("#frmFichaMC select#provincia")[0])})}this.loader(false,t.callback);app.exitIntent.activate);var c=app.widgets.getWidget("tooltip");c&&c.reInit();try{this._timeToLoadLayer();new d(true)}catch(e){}app.on("userLoggedIn");app.trigger("transaccional:fichaLoad:post",[null,e,t.placeholder]);app.gui.notifyChange();U(this._transaccionalBox)};V.prototype.validateCenterCombos=function(){var e=this;var t=this.courseCombo,i=app.dict._("FICHA_PCENTRO_Selecciona el curso que te interesa");if($("#idCateg",e._contentLayer).length){if(this.courseCombo.val()=="-1"){t.tooltip=m.create(t);t.tooltip.init(i,{showOn:"hover",alignX:"right",alignY:"center",offsetX:5});t.addClass("error").on("change",function(){t.removeClass("error");t.tooltip.destroy();app.log("destroy")});t.removeAttr("disabled");e.loader(false);return false}}return true};V.prototype.putFocusOnForm=function(){if(!app.functions.isMobile()){this.formOnPage.find("input:text").eq(0).trigger("focus")}};V.prototype.isInlineLeadForm=function(e){return $(".app_inLineLeadFormContainer").find(e).length};V.prototype.shouldDoDirectLead=function(e){if(e.find(".app_leadFormLayer").data("isdirectlead")!==1){return false}if(!this.leadFormIsComplete){return false}return q()};V.prototype.shouldShowIncompleteLeadForm=function(e,t){if(t.find(".app_leadFormLayer").data("isdirectlead")!==1){return false}if(e){return false}if(app.userInventory.isEmpty()){return false}if(t.find(".app_leadFormLayer").data("forcedirectlead")===1){return!this.leadFormIsComplete}if(!H()){return false}return!this.leadFormIsComplete};V.prototype._doInit=function(){var e=this,t;this._doBinds();this.formOnPage=$("#frmFichaContainer");var i=window._egc.baseUrlCdn||"";if(this.formOnPage.length){this.formOnPage.prepend("<div class='loader-wrp'><img class='test_spinner' src='"+i+"/assets/themes/phoenix/img/loaders/loader-big.gif' width='48' height='48' /></div>");this._formOnTemplate=true;this.presetFieldsFromUserInventory(this.formOnPage);if(H()){this.presetPrivacyPolicy(this.formOnPage)}}else if((t=$(this.asyncLeadFormSelector)).length){this.loadAsynFicha(t,function(){e.formOnPage=e._contentLayer;if(e.formOnPage.length){e.formOnPage.prepend("<div class='loader-wrp'><img class='test_spinner' src='"+i+"/assets/themes/phoenix/img/loaders/loader-big.gif' width='48' height='48' /></div>");e._formOnTemplate=true;e.presetFieldsFromUserInventory(e.formOnPage);if(H()){e.presetPrivacyPolicy(e.formOnPage)}$(".app_focusOnFormTarget").css("display","block");if(!e.isInlineLeadForm(e.formOnPage)){e.putFocusOnForm()}app.trigger("landingWebFormLoaded")}})}};var U=function(e){try{e.center()}catch(e){}};var B;var N=function(e){try{if(e!=null){e.hide()}}catch(e){}};var H=function(){var e=app.widgets.getWidget("leadcollector");return e&&e.getLast()!==null};var q=function(){if(!H()){return false}var e=app.widgets.getWidget("leadcollector"),t=(new Date).addDays(-1*f);return e.getLast().date.getTime()>=t.getTime()};var M=function(e){if(app.userInventory.province()==null){return}$(e).find('[data-idinv="'+l.prototype.INVENTORY_PROVINCE_ID+'"]').append(new Option("",app.userInventory.province(),true,true))};V.prototype.hasToShowMultilead=function(){var e,t;if(this._ficha.multileadDisabled){return false}if($("#app_multiLeadLayerContent").length===0){return false}if(this.isCustomLandingPage()){return false}e=app.widgets.getWidget("leadcollector");t=(new Date).addDays(-1);return e.numLeadsFrom(t)<=u};V.prototype.isCustomLandingPage=function(){if(!app.functions.isLanding()){return false}if($.cookie("idsite")){return true}return app.functions.getURLParameter("sid")!=null};V.prototype.renderMultileadForm=function(e){var o=this,n=this.processCrossSellingUrl(e);$.ajax({url:window._egc.baseUrl+"/web/transaccional/multi-lead-form-data",data:{leadId:e.idSolicEmag,searchId:e.searchId,userData:app.userInventory.toString(),isLanding:app.functions.isLanding()?1:0,isFromRestrictionErrorLead:e.errCode===2?1:0},type:"GET"}).done(function(e){if(!e.hasOwnProperty("data")||e.data.courses.length===0){o.redirect(n);return}n+="&excludeSearchIds="+e.data.courses.map).join();var t=o.multileadFormContent(e.data,n),i,a;i=new Eboxy(t,{show:true,draggable:false,fixed:true,modal:false,unloadOnHide:true,customClass:"multilead test_multileadLayer",zIndex:20,afterShow,afterHide:function(){}});app.functions.addEvent("Multilead","openMultilead","Capa de multilead",e.data.courses.length,true);a=new s(i.getContent().find(".app_multiLeadForm"),{removeLoaderOnSuccess:false,successHandler:function(){o.redirect(n)}});o.bindMultileadEvents(a,n);$(i.eboxy).on("click",".app_close",function(){var e=new r(i.eboxy,{size:"big"});e.on();if(o._ficha.redirectionDisabled){N(i.eboxy)}else{o.redirect(n)}})}).fail)};V.prototype.multileadFormContent=function(e,t){var i="",a="",o="";$.each(e.courses,function(e,t){o=app.templating.render($("#app_multiLeadCoursePrice"),{price:t.price.price,priceBeforeDiscountVisibility:t.price.priceBeforeDiscount===null?"hidden":"",priceBeforeDiscount:t.price.priceBeforeDiscount,taxCaptionVisibility:t.price.taxCaption===null?"hidden":"",taxCaption:t.price.taxCaption});a+=app.templating.render($("#app_multiLeadCourse"),{searchId:t.searchId,title:t.title,centerName:t.centerName,imageUrl:t.imageUrl,ratingVisibility:t.rating>0?"":"hidden",rating:t.rating,ratingStar:t.ratingStar,price:o})});i=app.templating.render($("#app_multiLeadLayerContent"),{courses:a,shortItemVisibilityClasses:e.showFullItems?"":"multilead__course-list--short",urlRedirect:t});return i};V.prototype.isDirectLead;V.prototype.markAsDirectLead=function(e){this.trackingDirectLeadsData[e]={isDirectLead:1,isPartialDirectLead:0}};V.prototype.markAsPartialDirectLead=function(e){this.trackingDirectLeadsData[e]={isDirectLead:1,isPartialDirectLead:1}};V.prototype.trackDirectLead=function(e,t,i){if(!this.isDirectLead(t)){return}$.post({url:window._egc.baseUrl+A,data:{leadId:e,courseCountryOrigin:i,isDirectLead:this.trackingDirectLeadsData[t].isDirectLead,isPartialDirectLead:this.trackingDirectLeadsData[t].isPartialDirectLead}}).done)};return V});