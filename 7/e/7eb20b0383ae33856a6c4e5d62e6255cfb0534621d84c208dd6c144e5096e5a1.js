/*!
 * Dynamsoft JavaScript Library
 * @product Dynamsoft Barcode Reader JS Edition
 * @website http://www.dynamsoft.com
 * @copyright Copyright 2023, Dynamsoft Corporation
 * @author Dynamsoft
 * @version 9.6.20 (js 20230410)
 * @fileoverview Dynamsoft JavaScript Library for Barcode Reader
 * More info on DBR JS: https://www.dynamsoft.com/barcode-reader/sdk-javascript/
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).Dynamsoft=e.Dynamsoft||{},e.Dynamsoft.DBR={}))}(this,(function(e){"use strict";const t="undefined"==typeof self;let i,r,n,s,o;if("undefined"!=typeof navigator&&(i=navigator,r=i.userAgent,n=i.platform,s=i.mediaDevices),!t){const e={Edge:{search:"Edg",verSearch:"Edg"},OPR:null,Chrome:null,Safari:{str:i.vendor,search:"Apple",verSearch:["Version","iPhone OS","CPU OS"]},Firefox:null,Explorer:{search:"MSIE",verSearch:"MSIE"}},t={HarmonyOS:null,Android:null,iPhone:null,iPad:null,Windows:{str:n,search:"Win"},Mac:{str:n},Linux:{str:n}};let s="unknownBrowser",a=0,h="unknownOS";for(let t in e){const i=e[t]||{};let n=i.str||r,o=i.search||t,h=i.verStr||r,l=i.verSearch||t;if(l instanceof Array||(l=[l]),-1!=n.indexOf(o)){s=t;for(let e of l){let t=h.indexOf(e);if(-1!=t){a=parseFloat(h.substring(t+e.length+1));break}}break}}for(let e in t){const i=t[e]||{};let n=i.str||r,s=i.search||e;if(-1!=n.indexOf(s)){h=e;break}}"Linux"==h&&-1!=r.indexOf("Windows NT")&&(h="HarmonyOS"),o={browser:s,version:a,OS:h}}t&&(o={browser:"ssr",version:0,OS:"ssr"});const a="undefined"!=typeof WebAssembly&&r&&!(/Safari/.test(r)&&!/Chrome/.test(r)&&/\(.+\s11_2_([2-6]).*\)/.test(r)),h=!("undefined"==typeof Worker),l=!(!s||!s.getUserMedia),c=async()=>{let e=!1;if(l)try{(await s.getUserMedia({video:!0})).getTracks().forEach((e=>{e.stop()})),e=!0}catch(e){}return e};"Chrome"===o.browser&&o.version>66||"Safari"===o.browser&&o.version>13||"OPR"===o.browser&&o.version>43||"Edge"===o.browser&&o.version;const u=(()=>{if(!t&&document.currentScript){let e=document.currentScript.src,t=e.indexOf("?");if(-1!=t)e=e.substring(0,t);else{let t=e.indexOf("#");-1!=t&&(e=e.substring(0,t))}return e.substring(0,e.lastIndexOf("/")+1)}return"./"})(),d=" is not allowed to change after `createInstance` or `loadWasm` is called.",f=!t&&document.currentScript&&(document.currentScript.getAttribute("data-license")||document.currentScript.getAttribute("data-productKeys")||document.currentScript.getAttribute("data-licenseKey")||document.currentScript.getAttribute("data-handshakeCode")||document.currentScript.getAttribute("data-organizationID"))||"",g=!t&&document.currentScript&&document.currentScript.getAttribute("data-sessionPassword")||"",_=e=>{if(null==e)e=[];else{e=e instanceof Array?[...e]:[e];for(let i=0;i<e.length;++i){if(!t){let t=document.createElement("a");t.href=e[i],e[i]=t.href}e[i].endsWith("/")||(e[i]+="/")}}return e};var p,m,v,y,S;e.EnumImagePixelFormat=void 0,(p=e.EnumImagePixelFormat||(e.EnumImagePixelFormat={}))[p.IPF_Binary=0]="IPF_Binary",p[p.IPF_BinaryInverted=1]="IPF_BinaryInverted",p[p.IPF_GrayScaled=2]="IPF_GrayScaled",p[p.IPF_NV21=3]="IPF_NV21",p[p.IPF_RGB_565=4]="IPF_RGB_565",p[p.IPF_RGB_555=5]="IPF_RGB_555",p[p.IPF_RGB_888=6]="IPF_RGB_888",p[p.IPF_ARGB_8888=7]="IPF_ARGB_8888",p[p.IPF_RGB_161616=8]="IPF_RGB_161616",p[p.IPF_ARGB_16161616=9]="IPF_ARGB_16161616",p[p.IPF_ABGR_8888=10]="IPF_ABGR_8888",p[p.IPF_ABGR_16161616=11]="IPF_ABGR_16161616",p[p.IPF_BGR_888=12]="IPF_BGR_888",e.EnumErrorCode=void 0,(m=e.EnumErrorCode||(e.EnumErrorCode={}))[m.DBR_SYSTEM_EXCEPTION=1]="DBR_SYSTEM_EXCEPTION",m[m.DBR_SUCCESS=0]="DBR_SUCCESS",m[m.DBR_UNKNOWN=-1e4]="DBR_UNKNOWN",m[m.DBR_NO_MEMORY=-10001]="DBR_NO_MEMORY",m[m.DBR_NULL_REFERENCE=-10002]="DBR_NULL_REFERENCE",m[m.DBR_LICENSE_INVALID=-10003]="DBR_LICENSE_INVALID",m[m.DBR_LICENSE_EXPIRED=-10004]="DBR_LICENSE_EXPIRED",m[m.DBR_FILE_NOT_FOUND=-10005]="DBR_FILE_NOT_FOUND",m[m.DBR_FILETYPE_NOT_SUPPORTED=-10006]="DBR_FILETYPE_NOT_SUPPORTED",m[m.DBR_BPP_NOT_SUPPORTED=-10007]="DBR_BPP_NOT_SUPPORTED",m[m.DBR_INDEX_INVALID=-10008]="DBR_INDEX_INVALID",m[m.DBR_BARCODE_FORMAT_INVALID=-10009]="DBR_BARCODE_FORMAT_INVALID",m[m.DBR_CUSTOM_REGION_INVALID=-10010]="DBR_CUSTOM_REGION_INVALID",m[m.DBR_MAX_BARCODE_NUMBER_INVALID=-10011]="DBR_MAX_BARCODE_NUMBER_INVALID",m[m.DBR_IMAGE_READ_FAILED=-10012]="DBR_IMAGE_READ_FAILED",m[m.DBR_TIFF_READ_FAILED=-10013]="DBR_TIFF_READ_FAILED",m[m.DBR_QR_LICENSE_INVALID=-10016]="DBR_QR_LICENSE_INVALID",m[m.DBR_1D_LICENSE_INVALID=-10017]="DBR_1D_LICENSE_INVALID",m[m.DBR_DIB_BUFFER_INVALID=-10018]="DBR_DIB_BUFFER_INVALID",m[m.DBR_PDF417_LICENSE_INVALID=-10019]="DBR_PDF417_LICENSE_INVALID",m[m.DBR_DATAMATRIX_LICENSE_INVALID=-10020]="DBR_DATAMATRIX_LICENSE_INVALID",m[m.DBR_PDF_READ_FAILED=-10021]="DBR_PDF_READ_FAILED",m[m.DBR_PDF_DLL_MISSING=-10022]="DBR_PDF_DLL_MISSING",m[m.DBR_PAGE_NUMBER_INVALID=-10023]="DBR_PAGE_NUMBER_INVALID",m[m.DBR_CUSTOM_SIZE_INVALID=-10024]="DBR_CUSTOM_SIZE_INVALID",m[m.DBR_CUSTOM_MODULESIZE_INVALID=-10025]="DBR_CUSTOM_MODULESIZE_INVALID",m[m.DBR_RECOGNITION_TIMEOUT=-10026]="DBR_RECOGNITION_TIMEOUT",m[m.DBR_JSON_PARSE_FAILED=-10030]="DBR_JSON_PARSE_FAILED",m[m.DBR_JSON_TYPE_INVALID=-10031]="DBR_JSON_TYPE_INVALID",m[m.DBR_JSON_KEY_INVALID=-10032]="DBR_JSON_KEY_INVALID",m[m.DBR_JSON_VALUE_INVALID=-10033]="DBR_JSON_VALUE_INVALID",m[m.DBR_JSON_NAME_KEY_MISSING=-10034]="DBR_JSON_NAME_KEY_MISSING",m[m.DBR_JSON_NAME_VALUE_DUPLICATED=-10035]="DBR_JSON_NAME_VALUE_DUPLICATED",m[m.DBR_TEMPLATE_NAME_INVALID=-10036]="DBR_TEMPLATE_NAME_INVALID",m[m.DBR_JSON_NAME_REFERENCE_INVALID=-10037]="DBR_JSON_NAME_REFERENCE_INVALID",m[m.DBR_PARAMETER_VALUE_INVALID=-10038]="DBR_PARAMETER_VALUE_INVALID",m[m.DBR_DOMAIN_NOT_MATCHED=-10039]="DBR_DOMAIN_NOT_MATCHED",m[m.DBR_RESERVEDINFO_NOT_MATCHED=-10040]="DBR_RESERVEDINFO_NOT_MATCHED",m[m.DBR_AZTEC_LICENSE_INVALID=-10041]="DBR_AZTEC_LICENSE_INVALID",m[m.DBR_LICENSE_DLL_MISSING=-10042]="DBR_LICENSE_DLL_MISSING",m[m.DBR_LICENSEKEY_NOT_MATCHED=-10043]="DBR_LICENSEKEY_NOT_MATCHED",m[m.DBR_REQUESTED_FAILED=-10044]="DBR_REQUESTED_FAILED",m[m.DBR_LICENSE_INIT_FAILED=-10045]="DBR_LICENSE_INIT_FAILED",m[m.DBR_PATCHCODE_LICENSE_INVALID=-10046]="DBR_PATCHCODE_LICENSE_INVALID",m[m.DBR_POSTALCODE_LICENSE_INVALID=-10047]="DBR_POSTALCODE_LICENSE_INVALID",m[m.DBR_DPM_LICENSE_INVALID=-10048]="DBR_DPM_LICENSE_INVALID",m[m.DBR_FRAME_DECODING_THREAD_EXISTS=-10049]="DBR_FRAME_DECODING_THREAD_EXISTS",m[m.DBR_STOP_DECODING_THREAD_FAILED=-10050]="DBR_STOP_DECODING_THREAD_FAILED",m[m.DBR_SET_MODE_ARGUMENT_ERROR=-10051]="DBR_SET_MODE_ARGUMENT_ERROR",m[m.DBR_LICENSE_CONTENT_INVALID=-10052]="DBR_LICENSE_CONTENT_INVALID",m[m.DBR_LICENSE_KEY_INVALID=-10053]="DBR_LICENSE_KEY_INVALID",m[m.DBR_LICENSE_DEVICE_RUNS_OUT=-10054]="DBR_LICENSE_DEVICE_RUNS_OUT",m[m.DBR_GET_MODE_ARGUMENT_ERROR=-10055]="DBR_GET_MODE_ARGUMENT_ERROR",m[m.DBR_IRT_LICENSE_INVALID=-10056]="DBR_IRT_LICENSE_INVALID",m[m.DBR_MAXICODE_LICENSE_INVALID=-10057]="DBR_MAXICODE_LICENSE_INVALID",m[m.DBR_GS1_DATABAR_LICENSE_INVALID=-10058]="DBR_GS1_DATABAR_LICENSE_INVALID",m[m.DBR_GS1_COMPOSITE_LICENSE_INVALID=-10059]="DBR_GS1_COMPOSITE_LICENSE_INVALID",m[m.DBR_PANORAMA_LICENSE_INVALID=-10060]="DBR_PANORAMA_LICENSE_INVALID",m[m.DBR_DOTCODE_LICENSE_INVALID=-10061]="DBR_DOTCODE_LICENSE_INVALID",m[m.DBR_PHARMACODE_LICENSE_INVALID=-10062]="DBR_PHARMACODE_LICENSE_INVALID",m[m.DBR_IMAGE_ORIENTATION_INVALID=-10063]="DBR_IMAGE_ORIENTATION_INVALID",m[m.DMERR_NO_LICENSE=-2e4]="DMERR_NO_LICENSE",m[m.DMERR_LICENSE_SYNC_FAILED=-20003]="DMERR_LICENSE_SYNC_FAILED",m[m.DMERR_TRIAL_LICENSE=-20010]="DMERR_TRIAL_LICENSE",m[m.DMERR_FAILED_TO_REACH_LTS=-20200]="DMERR_FAILED_TO_REACH_LTS",e.EnumIMResultDataType=void 0,(v=e.EnumIMResultDataType||(e.EnumIMResultDataType={}))[v.IMRDT_IMAGE=1]="IMRDT_IMAGE",v[v.IMRDT_CONTOUR=2]="IMRDT_CONTOUR",v[v.IMRDT_LINESEGMENT=4]="IMRDT_LINESEGMENT",v[v.IMRDT_LOCALIZATIONRESULT=8]="IMRDT_LOCALIZATIONRESULT",v[v.IMRDT_REGIONOFINTEREST=16]="IMRDT_REGIONOFINTEREST",v[v.IMRDT_QUADRILATERAL=32]="IMRDT_QUADRILATERAL",e.EnumBarcodeFormat=void 0,(y=e.EnumBarcodeFormat||(e.EnumBarcodeFormat={}))[y.BF_ALL=-29360129]="BF_ALL",y[y.BF_ONED=3147775]="BF_ONED",y[y.BF_GS1_DATABAR=260096]="BF_GS1_DATABAR",y[y.BF_CODE_39=1]="BF_CODE_39",y[y.BF_CODE_128=2]="BF_CODE_128",y[y.BF_CODE_93=4]="BF_CODE_93",y[y.BF_CODABAR=8]="BF_CODABAR",y[y.BF_ITF=16]="BF_ITF",y[y.BF_EAN_13=32]="BF_EAN_13",y[y.BF_EAN_8=64]="BF_EAN_8",y[y.BF_UPC_A=128]="BF_UPC_A",y[y.BF_UPC_E=256]="BF_UPC_E",y[y.BF_INDUSTRIAL_25=512]="BF_INDUSTRIAL_25",y[y.BF_CODE_39_EXTENDED=1024]="BF_CODE_39_EXTENDED",y[y.BF_GS1_DATABAR_OMNIDIRECTIONAL=2048]="BF_GS1_DATABAR_OMNIDIRECTIONAL",y[y.BF_GS1_DATABAR_TRUNCATED=4096]="BF_GS1_DATABAR_TRUNCATED",y[y.BF_GS1_DATABAR_STACKED=8192]="BF_GS1_DATABAR_STACKED",y[y.BF_GS1_DATABAR_STACKED_OMNIDIRECTIONAL=16384]="BF_GS1_DATABAR_STACKED_OMNIDIRECTIONAL",y[y.BF_GS1_DATABAR_EXPANDED=32768]="BF_GS1_DATABAR_EXPANDED",y[y.BF_GS1_DATABAR_EXPANDED_STACKED=65536]="BF_GS1_DATABAR_EXPANDED_STACKED",y[y.BF_GS1_DATABAR_LIMITED=131072]="BF_GS1_DATABAR_LIMITED",y[y.BF_PATCHCODE=262144]="BF_PATCHCODE",y[y.BF_PDF417=33554432]="BF_PDF417",y[y.BF_QR_CODE=67108864]="BF_QR_CODE",y[y.BF_DATAMATRIX=134217728]="BF_DATAMATRIX",y[y.BF_AZTEC=268435456]="BF_AZTEC",y[y.BF_MAXICODE=536870912]="BF_MAXICODE",y[y.BF_MICRO_QR=1073741824]="BF_MICRO_QR",y[y.BF_MICRO_PDF417=524288]="BF_MICRO_PDF417",y[y.BF_GS1_COMPOSITE=-2147483648]="BF_GS1_COMPOSITE",y[y.BF_MSI_CODE=1048576]="BF_MSI_CODE",y[y.BF_CODE_11=2097152]="BF_CODE_11",y[y.BF_NULL=0]="BF_NULL",e.EnumIntermediateResultType=void 0,(S=e.EnumIntermediateResultType||(e.EnumIntermediateResultType={}))[S.IRT_NO_RESULT=0]="IRT_NO_RESULT",S[S.IRT_ORIGINAL_IMAGE=1]="IRT_ORIGINAL_IMAGE",S[S.IRT_COLOUR_CLUSTERED_IMAGE=2]="IRT_COLOUR_CLUSTERED_IMAGE",S[S.IRT_COLOUR_CONVERTED_GRAYSCALE_IMAGE=4]="IRT_COLOUR_CONVERTED_GRAYSCALE_IMAGE",S[S.IRT_TRANSFORMED_GRAYSCALE_IMAGE=8]="IRT_TRANSFORMED_GRAYSCALE_IMAGE",S[S.IRT_PREDETECTED_REGION=16]="IRT_PREDETECTED_REGION",S[S.IRT_PREPROCESSED_IMAGE=32]="IRT_PREPROCESSED_IMAGE",S[S.IRT_BINARIZED_IMAGE=64]="IRT_BINARIZED_IMAGE",S[S.IRT_TEXT_ZONE=128]="IRT_TEXT_ZONE",S[S.IRT_CONTOUR=256]="IRT_CONTOUR",S[S.IRT_LINE_SEGMENT=512]="IRT_LINE_SEGMENT",S[S.IRT_FORM=1024]="IRT_FORM",S[S.IRT_SEGMENTATION_BLOCK=2048]="IRT_SEGMENTATION_BLOCK",S[S.IRT_TYPED_BARCODE_ZONE=4096]="IRT_TYPED_BARCODE_ZONE",S[S.IRT_PREDETECTED_QUADRILATERAL=8192]="IRT_PREDETECTED_QUADRILATERAL";const w=e=>e&&"object"==typeof e&&"function"==typeof e.then;class C extends Promise{constructor(e){let t,i;super((),this._s="pending",this.resolve=e=>{this.isPending&&(w(e)?this.task=e:(this._s="fulfilled",t(e)))},this.reject=e=>{this.isPending&&(this._s="rejected",i(e))},this.task=e}get status(){return this._s}get isPending(){return"pending"===this._s}get isFulfilled(){return"fulfilled"===this._s}et task(){return this._task}set task(e){let t;this._task=e,w(e)?t=e:"function"==typeof e&&(t=new Promise(e)),t&&(async()=>{try{const i=await t;e===this._task&&this.resolve(i)}catch(t){e===this._task&&this.reject(t)}})()}var b=function(){this.init()};b.prototype={init:volume:mute:stop:unload:codecs:_setup:_setupCodecs:_unlockAudio:_obtainHtml5Audio:_releaseHtml5Audio:_autoSuspend:_autoResume:;var x=new b,T=T.prototype={init:load:play:pause:stop:mute:volume:fade:_startFadeInterval:_stopFade:loop:rate:seek:playing:duration:state:function(){return this._state},unload:on:off:once:_emit:_loadQueue:_ended:_clearTimer:_soundById:_inactiveSound:_drain:_getSoundIds:_refreshBuffer:_cleanBuffer:_clearSound:;var E=E.prototype={init:create:reset:_errorListener:_loadListener:_endListener:;var I={},O=A=R=D=M=!function(e,t,i,r){var n;e.prototype._pos=[0,0,0],e.prototype._orientation=[0,0,-1,0,1,0],e.prototype.stereo=e.prototype.pos=e.prototype.orientation=i.prototype.init=(n=i.prototype.init,,i.prototype.stereo=i.prototype.pos=i.prototype.orientation=i.prototype.pannerAttr=function(){var e,t,i,r=this,n=arguments;if(!r._webAudio)return r;if(0===n.length)return r._pannerAttr;if(1===n.length){if("object"!=typeof n[0])return(i=r._soundById(parseInt(n[0],10)))?i._pannerAttr:r._pannerAttr;e=n[0],void 0===t&&(e.pannerAttr||(e.pannerAttr={coneInnerAngle:e.coneInnerAngle,coneOuterAngle:e.coneOuterAngle,coneOuterGain:e.coneOuterGain,distanceModel:e.distanceModel,maxDistance:e.maxDistance,refDistance:e.refDistance,rolloffFactor:e.rolloffFactor,panningModel:e.panningModel}),r._pannerAttr={coneInnerAngle:void 0!==e.pannerAttr.coneInnerAngle?e.pannerAttr.coneInnerAngle:r._coneInnerAngle,coneOuterAngle:void 0!==e.pannerAttr.coneOuterAngle?e.pannerAttr.coneOuterAngle:r._coneOuterAngle,coneOuterGain:void 0!==e.pannerAttr.coneOuterGain?e.pannerAttr.coneOuterGain:r._coneOuterGain,distanceModel:void 0!==e.pannerAttr.distanceModel?e.pannerAttr.distanceModel:r._distanceModel,maxDistance:void 0!==e.pannerAttr.maxDistance?e.pannerAttr.maxDistance:r._maxDistance,refDistance:void 0!==e.pannerAttr.refDistance?e.pannerAttr.refDistance:r._refDistance,rolloffFactor:void 0!==e.pannerAttr.rolloffFactor?e.pannerAttr.rolloffFactor:r._rolloffFactor,panningModel:void 0!==e.pannerAttr.panningModel?e.pannerAttr.panningModel:r._panningModel})}else 2===n.length&&(e=n[0],t=parseInt(n[1],10));for(var o=r._getSoundIds(t),a=0;a<o.length;a++)if(i=r._soundById(o[a])){var h=i._pannerAttr;h={coneInnerAngle:void 0!==e.coneInnerAngle?e.coneInnerAngle:h.coneInnerAngle,coneOuterAngle:void 0!==e.coneOuterAngle?e.coneOuterAngle:h.coneOuterAngle,coneOuterGain:void 0!==e.coneOuterGain?e.coneOuterGain:h.coneOuterGain,distanceModel:void 0!==e.distanceModel?e.distanceModel:h.distanceModel,maxDistance:void 0!==e.maxDistance?e.maxDistance:h.maxDistance,refDistance:void 0!==e.refDistance?e.refDistance:h.refDistance,rolloffFactor:void 0!==e.rolloffFactor?e.rolloffFactor:h.rolloffFactor,panningModel:void 0!==e.panningModel?e.panningModel:h.panningModel};var l=i._panner;l||(i._pos||(i._pos=r._pos||[0,0,-.5]),s(i,"spatial"),l=i._panner),l.coneInnerAngle=h.coneInnerAngle,l.coneOuterAngle=h.coneOuterAngle,l.coneOuterGain=h.coneOuterGain,l.distanceModel=h.distanceModel,l.maxDistance=h.maxDistance,l.refDistance=h.refDistance,l.rolloffFactor=h.rolloffFactor,l.panningModel=h.panningModel}return r},r.prototype.init=r.prototype.init),r.prototype.reset=r.prototype.reset);var s=(b,x,T,E);const F=["iPhone","iPad","Android","HarmonyOS"].includes(o.OS)?2048:4096;class L{constructor(){this._instanceID=void 0,this._ifSaveOriginalImageInACanvas=!1,this.oriCanvas=null,this.oriCanvasData=null,this.canvas=null,this.bFilterRegionInJs=!1,this._region=null,this._timeStartDecode=null,this._timeEnterInnerDBR=null,this._timeGetMessage=null,this.decodeRecords={},this.bDestroyed=!1,this._lastErrorCode=0,this._lastErrorString="",this._lastInnerDecodeDuration=0,this.intervalTime=0,this._intervalGetVideoFrame=0,this.array_getFrameTimeCost=[],this.array_decodeFrameTimeCost=[],this._indexCurrentDecodingFrame=0,this._arrPolygons=[],this._bPauseScan=!1,this._intervalDetectVideoPause=1e3,this._soundSource="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA/+M4wAAAAAAAAAAAAEluZm8AAAAPAAAABQAAAkAAgICAgICAgICAgICAgICAgICAgKCgoKCgoKCgoKCgoKCgoKCgoKCgwMDAwMDAwMDAwMDAwMDAwMDAwMDg4ODg4ODg4ODg4ODg4ODg4ODg4P//////////////////////////AAAAAExhdmM1OC41NAAAAAAAAAAAAAAAACQEUQAAAAAAAAJAk0uXRQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/+MYxAANQAbGeUEQAAHZYZ3fASqD4P5TKBgocg+Bw/8+CAYBA4XB9/4EBAEP4nB9+UOf/6gfUCAIKyjgQ/Kf//wfswAAAwQA/+MYxAYOqrbdkZGQAMA7DJLCsQxNOij///////////+tv///3RWiZGBEhsf/FO/+LoCSFs1dFVS/g8f/4Mhv0nhqAieHleLy/+MYxAYOOrbMAY2gABf/////////////////usPJ66R0wI4boY9/8jQYg//g2SPx1M0N3Z0kVJLIs///Uw4aMyvHJJYmPBYG/+MYxAgPMALBucAQAoGgaBoFQVBUFQWDv6gZBUFQVBUGgaBr5YSgqCoKhIGg7+IQVBUFQVBoGga//SsFSoKnf/iVTEFNRTMu/+MYxAYAAANIAAAAADEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV",this.bPlaySoundOnSuccessfulRead=!1,this.bVibrateOnSuccessfulRead=!1,this.vibrateDuration=300,this.captureAndDecodeInParallel=!0,this.autoSuggestTip=!1,this.suggestTipFrameArray=[],this.suggestTipFrameLimit=[5,3],this.noIntermediateResultsCount=0,this.noIntermediateResultsTipLimit=100,this.tinyBarcodeTipModuleSizeLimit=3,this.hugeBarcodeTipLimit=.9,this.autoZoomInFrameArray=[],this.autoZoomInFrameLimit=[5,3],this.autoZoomInStepRate=1/3,this.autoZoomInMaxStep=1.5,this.autoZoomInMaxTimes=5,this.autoZoomInMinStep=Math.pow(10,1/this.autoZoomInMaxTimes),this.autoZoomInIdealModuleSize=6,this.autoZoomOutFrameCount=0,this.autoZoomOutFrameLimit=3,this.autoZoomOutStepRate=1/3,this.autoZoomOutMinValue=1,this.autoZoomOutMinStep=2,this.autoZoomOutStepRate_2=.05,this.autoZoomOutMinValue_2=2,this.frameArrayInIdealZoom=[],this.frameLimitInIdealZoom=[5,3],this.enableZoomOutInIdealZoom=!1,this.nextActionInIdealZoom="focus",this.autoFocusFrameArray=[],this.autoFocusFrameLimit=[5,3],this.autoZoomIdealArea=[0,.05],this.autoZoomTargetBorder=.9,this.autoZoomDetectionArea=.5,this.autoZoom=!1,this.autoFocus=!1,this._resultHighlightingDuration=-1,this._dce=null,this._imgSource=null,this._maxCvsSideLength=F,this._promiseStartScan=null,this.beepSound=new T({src:[this._soundSource],onplayerror:(e,t)=>{console.warn(`Sound '${e}' playback failure: ${t}`)}})}static get version(){return this._version}static get license(){return this._license}static set license(e){((e,t)=>{const i=e;if(!i._pLoad.isEmpty)throw new Error("`license`"+d);i._license=t})(L,e)}static get productKeys(){return this._license}static set productKeys(e){L.license=e}static get handshakeCode(){return this._license}static set handshakeCode(e){L.license=e}static get organizationID(){return this._license}static set organizationID(e){L.license=e}static set sessionPassword(e){((e,t)=>{const i=e;if(!i._pLoad.isEmpty)throw new Error("`sessionPassword`"+d);i._sessionPassword=t})(L,e)}static get sessionPassword(){return this._sessionPassword}static async detectEnvironment(){return await(async()=>({wasm:a,worker:h,getUserMedia:l,camera:await c(),browser:o.browser,version:o.version,OS:o.OS}))()}static get engineResourcePath(){return this._engineResourcePath}static set engineResourcePath(e){if(!this._pLoad.isEmpty)throw new Error("`engineResourcePath` is not allowed to change after `createInstance` or `loadWasm` is called.");L._engineResourcePath=(e=>{if(null==e&&(e="./"),!t){let t=document.createElement("a");t.href=e,e=t.href}return e.endsWith("/")||(e+="/"),e})(e)}static get licenseServer(){return this._licenseServer}static set licenseServer(e){((e,t)=>{const i=e;if(!i._pLoad.isEmpty)throw new Error("`licenseServer`"+d);i._licenseServer=_(t)})(L,e)}static get deviceFriendlyName(){return this._deviceFriendlyName}static set deviceFriendlyName(e){((e,t)=>{const i=e;if(!i._pLoad.isEmpty)throw new Error("`deviceFriendlyName`"+d);i._deviceFriendlyName=t||""})(L,e)}static get _bUseFullFeature(){return this.__bUseFullFeature}static set _bUseFullFeature(e){if(!this._pLoad.isEmpty)throw new Error("`_bUseFullFeature` is not allowed to change after `createInstance` or `loadWasm` is called.");L.__bUseFullFeature=e}static isImageSource(e){return!(!e||"object"!=typeof e||Array.isArray(e))&&"getImage"in e}static isDSImage(e){return!(!e||"object"!=typeof e||Array.isArray(e))&&("data"in e&&("width"in e&&("height"in e&&"pixelFormat"in e)))}static isDCEFrame(e){return!(!e||"object"!=typeof e||Array.isArray(e))&&("data"in e&&("region"in e&&("sx"in e&&("sy"in e&&("width"in e&&("height"in e&&(("colorMode"in e||"pixelFormat"in e)&&("timeSpent"in e&&("timeStamp"in e&&("isCropped"in e&&("toCanvas"in e&&("_sWidth"in e&&("_sHeight"in e&&"_bUseWebGL"in e)))))))))))))}get ifSaveOriginalImageInACanvas(){return this._ifSaveOriginalImageInACanvas}set ifSaveOriginalImageInACanvas(e){this._ifSaveOriginalImageInACanvas=e}getOriginalImageInACanvaset region(e){this._region=e,this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0}get region(){return this._region}static isWasmLoaded(){return this._pLoad.isFulfilled}isContextDestroyed(){return this.bDestroyed}static get lastErrorCode(){return this._lastErrorCode}static get lastErrorString(){return this._lastErrorString}get lastErrorCode(){return this._lastErrorCode}get lastErrorString(){return this._lastErrorString}static get defaultUIElementURL(){var e;return null===(e=L._defaultUIElementURL)||void 0===e?void 0:e.replace("@engineResourcePath/",L.engineResourcePath)}static set defaultUIElementURL(e){L._defaultUIElementURL=e}static _fireHTTPSWarnning(){L.onWarning&&location&&"https:"!==location.protocol&&setTimeout((()=>{L.onWarning&&L.onWarning({id:2,message:"Not connected via SSL (HTTPS), the SDK may not work correctly."})}),0)}get soundSource(){return this._soundSource}set soundSource(e){this._soundSource=e,this.beepSound=new T({src:[this._soundSource],onplayerror:)}get whenToPlaySoundforSuccessfulRead(){return!0===this.bPlaySoundOnSuccessfulRead?"frame":this.bPlaySoundOnSuccessfulRead?this.bPlaySoundOnSuccessfulRead:"never"}set whenToPlaySoundforSuccessfulRead(e){this.bPlaySoundOnSuccessfulRead="never"!==e&&e}get whenToVibrateforSuccessfulRead(){return!0===this.bVibrateOnSuccessfulRead?"frame":this.bVibrateOnSuccessfulRead?this.bVibrateOnSuccessfulRead:"never"}set whenToVibrateforSuccessfulRead(e){this.bVibrateOnSuccessfulRead="never"!==e&&e}set dce(e){this._dce=e}get dce(){return!this._dce||this._dce.isDisposed||this._dce.disposed?null:this._dce}set maxCvsSideLength(e){this._maxCvsSideLength=e,this._dceControler&&this._dceControler.setDisiredValue(this,"maxCvsSideLength",e)}get maxCvsSideLength(){return this._maxCvsSideLength}async _registerDCEControler(){if(!this.dce)return;L._onLog&&L._onLog("_registerDCEControler()");const e=this.dce;this._dceControler=e._createControler();const t=this._dceControler;t.register(this),t.setDisiredValue(this,"refreshInterval",200),t.setDisiredValue(this,"maxCvsSideLength",this._maxCvsSideLength),this._styleIdBeforeVerification=this.dce.createDrawingStyle({fillStyle:"rgba(248,252,0,0.2)",strokeStyle:"transparent",paintMode:"strokeAndFill"});try{ResizeObserver}catch(e){"ReferenceError"===e.name&&window&&(window.ResizeObserver=void 0)}const i=e.getUIElement(),r=this.dce.constructor;if("@engineResourcePath/dce.ui.html"===r._defaultUIElementURL)try{i?i===t._innerSetUI&&(await e.setUIElement(`${r.engineResourcePath}dce.ui.html`),t._innerSetUI=e.getUIElement()):(await e.setUIElement(`${r.engineResourcePath}dbr.ui.html`),t._innerSetUI=e.getUIElement())}catch(t){await e.setUIElement(r.defaultUIElementURL)}else i||await e.setUIElement(r.defaultUIElementURL);this.callbackCameraChange=()=>{this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),this._drawResults(null),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0},this.callbackResolutionChange=()=>{this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),this._drawResults(null),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0},this.callbackCameraClose=()=>{this.stopScanning(!0),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0,this._bPauseScan=!1},this.callbackSingleFrameAcquired=async e=>{this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),this._drawResults(null);let t=await this._decode_DCEFrame(e,{bCopyData:!1}),i=null;if(t&&t.length){const{sx:r,sy:n,width:s,height:o,_sWidth:a,_sHeight:h}=e;i=t.map((e=>({localizationResult:JSON.parse(JSON.stringify(e.localizationResult))}))),L.recalculateResultLocation(i,r,n,a,h,s,o)}if(this._drawResults(i,t),await this.clearMapDecodeRecord(),this.onImageRead&&this.dce.isOpen()&&!this._bPauseScan){let e=this._cloneDecodeResults(t);this.onImageRead(e)}if(this.onUniqueRead&&this.dce.isOpen()&&!this._bPauseScan)for(let e of t)this.onUniqueRead(e.barcodeText,this._cloneDecodeResults(e))},e.on("cameraChange",this.callbackCameraChange),e.on("resolutionChange",this.callbackResolutionChange),e.on("cameraClose",this.callbackCameraClose),e.on("singleFrameAcquired",this.callbackSingleFrameAcquired)}_logoutDCEControler(){this.dce&&this._dceControler&&(L._onLog&&L._onLog("_logoutDCEControler()"),this._dceControler.logout(this),this.dce.off("cameraChange",this.callbackCameraChange),this.dce.off("resolutionChange",this.callbackResolutionChange),this.dce.off("cameraClose",this.callbackCameraClose),this.dce.off("singleFrameAcquired",this.callbackSingleFrameAcquired),this._dceControler=null,this.dce=null)}async setImageSource(e,t){if(null==e)return this._imgSource=null,this._logoutDCEControler(),void(this._drawingItemNamespace=null);if(e&&e.isCameraEnhancer)this.dce=e,await this._registerDCEControler(),this._imgSource=null;else{if(!L.isImageSource(e))throw new Error("Invalid value.");this._logoutDCEControler(),this._imgSource=e}t&&t.resultsHighlightBaseShapes&&(this._drawingItemNamespace=t.resultsHighlightBaseShapes)}static async loadWasm(){if(this._pLoad.isEmpty){let{lt:e,l:t,ls:i,sp:r,rmk:n}=(e=>{const t=e;if(t._pLoad.isEmpty){let e,i,r=t._license||"",n=JSON.parse(JSON.stringify(t._licenseServer)),s=t._sessionPassword,o=0;if(r.startsWith("t")||r.startsWith("f"))o=0;else if(0===r.length||r.startsWith("P")||r.startsWith("L")||r.startsWith("Y")||r.startsWith("A"))o=1;else{o=2;const t=r.indexOf(":");if(-1!=t&&(r=r.substring(t+1)),r.startsWith("DLS2")){let t;try{let e=r.substring(4);e=atob(e),t=JSON.parse(e)}catch(e){throw new Error("Format Error: The license string you specified is invalid, please check to make sure it is correct.")}if(r=t.handshakeCode?t.handshakeCode:t.organizationID?t.organizationID:"","number"==typeof r&&(r=JSON.stringify(r)),0===n.length){let e=[];t.mainServerURL&&(e[0]=t.mainServerURL),t.standbyServerURL&&(e[1]=t.standbyServerURL),n=_(e)}!s&&t.sessionPassword&&(s=t.sessionPassword),e=t.remark}("200001"===r||r.startsWith("200001-"))&&(n&&n.length||(r="")),r||(o=1)}if(o&&(globalThis.crypto||(i="Please upgrade your browser to support online key."),globalThis.crypto.subtle||(i="Require https to use online key in this browser.")),i){if(1!==o)throw new Error(i);o=0,console.warn(i),t._lastErrorCode=-1,t._lastErrorString=i}return 1===o&&(r="",console.warn("Applying for a public trial license ...")),{lt:o,l:r,ls:n,sp:s,rmk:e}}throw new Error("Can't preprocess license again"+d)})(L);this._pLoad.task=async(s,a)=>{let h=L.engineResourcePath+L._workerName;L.engineResourcePath.startsWith(location.origin)||(h=await fetch(h).then((e=>e.blob())).then((e=>URL.createObjectURL(e)))),L._dbrWorker=new Worker(h),L._dbrWorker.onerror=e=>{let t=new Error(e.message);a(t)},L._dbrWorker.onmessage=async t=>{let i=t.data?t.data:t;switch(i.type){case"log":L._onLog&&L._onLog(i.message);break;case"load":{i.message&&(i.message=i.message.replace("(https://www.dynamsoft.com/purchase-center/)","(https://www.dynamsoft.com/store/dynamsoft-barcode-reader/#javascript)"));let t,r=!1;1===e&&(r=!0,i.message||(i.message="Using a temporary license. [Register for a 30-day trial license >>>](https://www.dynamsoft.com/customer/license/trialLicense?product=dbr&deploymenttype=browser)")),i.success?(L._dbrWorker.onerror=null,L._version=i.version+"(JS "+L._jsVersion+"."+L._jsEditVersion+")",L._onLog&&L._onLog("load dbr worker success"),i.message&&console.warn(i.message)):(t=new Error(i.message),t.stack=i.stack+"\n"+t.stack,t.ltsErrorCode=i.ltsErrorCode,r||111==i.ltsErrorCode&&-1!=i.message.toLowerCase().indexOf("trial license")&&(r=!0)),r&&L.showDialog(i.success?"warn":"error",i.message),i.success?s():a(t);break}case"task":{let e=i.id,t=i.body;try{L._taskCallbackMap.get(e)(t),L._taskCallbackMap.delete(e)}catch(t){throw L._taskCallbackMap.delete(e),t}break}default:L._onLog&&L._onLog(t)}},L._dbrWorker.postMessage({type:"loadWasm",engineResourcePath:L.engineResourcePath,bUseFullFeature:L._bUseFullFeature,bd:L._bWasmDebug,v:L._jsVersion,brtk:!!e,bptk:1===e,l:t,dm:location.origin.startsWith("http")?location.origin:"https://localhost",os:o,cv:L.authCacheVersion,fn:L.deviceFriendlyName,ls:i,sp:r,rmk:n})}}await this._pLoad}static async showDialog(e,t){await(async(e,t,i)=>{if(!e._bNeverShowDialog)try{let r=await fetch(e.engineResourcePath+"dls.license.dialog.html");if(!r.ok)throw Error("Get license dialog fail. Network Error: "+r.statusText);let n=await r.text();if(!n.trim().startsWith("<"))throw Error("Get license dialog fail. Can't get valid HTMLElement.");let s=document.createElement("div");s.innerHTML=n;let o=[];for(let e=0;e<s.childElementCount;++e){let t=s.children[e];t instanceof HTMLStyleElement&&(o.push(t),document.head.append(t))}let a=1==s.childElementCount?s.children[0]:s;a.remove();let h,l,c,u,d,f=[a],g=a.children;for(let e of g)f.push(e);for(let e=0;e<f.length;++e)for(let t of f[e].children)f.push(t);for(let e of f)if(!h&&e.classList.contains("dls-license-mask"))h=e,e.addEventListener("click",(t=>{if(e==t.target){a.remove();for(let e of o)e.remove()}}));else if(!l&&e.classList.contains("dls-license-icon-close"))l=e,e.addEventListener("click",(()=>{a.remove();for(let e of o)e.remove()}));else if(!c&&e.classList.contains("dls-license-icon-error"))c=e,"error"!=t&&e.remove();else if(!u&&e.classList.contains("dls-license-icon-warn"))u=e,"warn"!=t&&e.remove();else if(!d&&e.classList.contains("dls-license-msg-content")){d=e;let t=i;for(;t;){let i=t.indexOf("["),r=t.indexOf("]",i),n=t.indexOf("(",r),s=t.indexOf(")",n);if(-1==i||-1==r||-1==n||-1==s){e.appendChild(new Text(t));break}i>0&&e.appendChild(new Text(t.substring(0,i)));let o=document.createElement("a"),a=t.substring(i+1,r);o.innerText=a;let h=t.substring(n+1,s);o.setAttribute("href",h),o.setAttribute("target","_blank"),e.appendChild(o),t=t.substring(s+1)}}document.body.appendChild(a)}catch(t){e._onLog&&e._onLog(t.message||t)}})(this,e,t)}static async createInstanceInWorker(e=!1){return await L.loadWasm(),await new Promise(((t,i)=>{let r=L._nextTaskID++;L._taskCallbackMap.set(r,(e=>{if(e.success)return t(e.instanceID);{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,i(t)}})),L._dbrWorker.postMessage({type:"createInstance",id:r,bScanner:e})}))}static async createInstance(){const e=new L;return e._instanceID=await L.createInstanceInWorker(),L._fireHTTPSWarnning(),e}async clearMapDecodeRecord(){return await new Promise(((e,t)=>{let i=L._nextTaskID++;L._taskCallbackMap.set(i,(i=>{if(i.success)return e();{let e=new Error(i.message);return e.stack=i.stack+"\n"+e.stack,t(e)}})),L._dbrWorker.postMessage({type:"clearMapDecodeRecord",id:i,instanceID:this._instanceID})}))}async decode(e){L._onLog&&L._onLog("decode(source: any)"),L._onLog&&(this._timeStartDecode=Date.now());{let t={};return!this.region||this.region instanceof Array||(t.region=JSON.parse(JSON.stringify(this.region))),e instanceof Blob?await this._decode_Blob(e,t):e instanceof ArrayBuffer?await this._decode_ArrayBuffer(e,t):e instanceof Uint8Array||e instanceof Uint8ClampedArray?await this._decode_Uint8Array(e,t):e instanceof HTMLImageElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap?await this._decode_Image(e,t):e instanceof HTMLCanvasElement?await this._decode_Canvas(e,t):e instanceof HTMLVideoElement?await this._decode_Video(e,t):"string"==typeof e?"data:image/"==e.substring(0,11)?await this._decode_Base64(e,t):await this._decode_Url(e,t):L.isDCEFrame(e)?(t.bCopyData=!0,await this._decode_DCEFrame(e,t)):L.isDSImage(e)?(t.bCopyData=!0,await this._decode_DSImage(e,t)):await Promise.reject(TypeError("'_decode(source, config)': Type of 'source' should be 'Blob', 'ArrayBuffer', 'Uint8Array', 'HTMLImageElement', 'HTMLCanvasElement', 'HTMLVideoElement', 'String(base64 with image mime)' or 'String(url)'."))}}async decodeBase64String(e){let t={};return!this.region||this.region instanceof Array||(t.region=JSON.parse(JSON.stringify(this.region))),this._decode_Base64(e,t)}async decodeUrl(e){let t={};return!this.region||this.region instanceof Array||(t.region=JSON.parse(JSON.stringify(this.region))),this._decode_Url(e,t)}async _decodeBuffer_Uint8Array(e,t,i,r,n,s,o){return await new Promise(((a,h)=>{let l=L._nextTaskID++;L._taskCallbackMap.set(l,(e=>{if(e.success){let t,i=L._onLog?Date.now():0;L._onLog&&L._onLog("worker return result: "+i),this._lastInnerDecodeDuration=e.duration;try{t=this._handleRetJsonString(e.decodeReturn)}catch(e){return h(e)}if(L._onLog){let e=Date.now();L._onLog("DBR getting message from worker timestamp: "+i),L._onLog("From DBR staring decoding to entering worker costs: "+(this._timeEnterInnerDBR-this._timeStartDecode)),L._onLog("From DBR entering worker to returning message from worker costs: "+(i-this._timeEnterInnerDBR)),L._onLog("Handling results from DBR worker costs: "+(e-i)),L._onLog("Total decoding image costs: "+(e-this._timeStartDecode))}return a(t)}{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,h(t)}})),this._timeEnterInnerDBR=Date.now(),L._onLog&&L._onLog("Sending buffer to worker timestamp:"+this._timeEnterInnerDBR),L._dbrWorker.postMessage({type:"decodeBuffer",id:l,instanceID:this._instanceID,body:{buffer:e,width:t,height:i,stride:r,format:n,orientation:s,config:o}},[e.buffer]),L._onLog&&o&&o.timeStamp&&L._onLog("Delay of decoding image: "+(this._timeEnterInnerDBR-o.timeStamp))}))}async _decodeBuffer_Blob(e,t,i,r,n,s,o){L._onLog&&L._onLog("_decodeBuffer_Blob(buffer,width,height,stride,format)");const a=e.arrayBuffer?await e.arrayBuffer():await new Promise(((t,i)=>{let r=new FileReader;r.readAsArrayBuffer(e),r.onload=()=>{t(r.result)},r.onerror=()=>{i(r.error)}}));return await this._decodeBuffer_Uint8Array(new Uint8Array(a),t,i,r,n,s,o)}async decodeBuffer(e,t,i,r,n,s,o){let a;return L._onLog&&L._onLog("decodeBuffer(buffer,width,height,stride,format)"),L._onLog&&(this._timeStartDecode=Date.now()),e instanceof Uint8Array||e instanceof Uint8ClampedArray?a=await this._decodeBuffer_Uint8Array(e,t,i,r,n,s,o):e instanceof ArrayBuffer?a=await this._decodeBuffer_Uint8Array(new Uint8Array(e),t,i,r,n,s,o):e instanceof Blob&&(a=await this._decodeBuffer_Blob(e,t,i,r,n,s,o)),a}async _decodeFileInMemory_Uint8Array(e){return await new Promise(((t,i)=>{let r=L._nextTaskID++;L._taskCallbackMap.set(r,(e=>{if(e.success){let r;this._lastInnerDecodeDuration=e.duration;try{r=this._handleRetJsonString(e.decodeReturn)}catch(e){return i(e)}return t(r)}{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,i(t)}})),L._dbrWorker.postMessage({type:"decodeFileInMemory",id:r,instanceID:this._instanceID,body:{bytes:e}})}))}async getRuntimeSettings(){return await new Promise(((e,t)=>{let i=L._nextTaskID++;L._taskCallbackMap.set(i,(i=>{if(i.success){let t=JSON.parse(i.results);return null!=this.userDefinedRegion&&(t.region=JSON.parse(JSON.stringify(this.userDefinedRegion))),e(t)}{let e=new Error(i.message);return e.stack=i.stack+"\n"+e.stack,t(e)}})),L._dbrWorker.postMessage({type:"getRuntimeSettings",id:i,instanceID:this._instanceID})}))}async updateRuntimeSettings(t){let i;if("string"==typeof t)if("speed"==t){let e=await this.getRuntimeSettings();await this.resetRuntimeSettings(),i=await this.getRuntimeSettings(),i.barcodeFormatIds=e.barcodeFormatIds,i.barcodeFormatIds_2=e.barcodeFormatIds_2,i.region=e.region,i.deblurLevel=3,i.expectedBarcodesCount=0,i.localizationModes=[2,0,0,0,0,0,0,0]}else if("balance"==t){let e=await this.getRuntimeSettings();await this.resetRuntimeSettings(),i=await this.getRuntimeSettings(),i.barcodeFormatIds=e.barcodeFormatIds,i.barcodeFormatIds_2=e.barcodeFormatIds_2,i.region=e.region,i.deblurLevel=5,i.expectedBarcodesCount=512,i.localizationModes=[2,16,0,0,0,0,0,0]}else if("coverage"==t){let e=await this.getRuntimeSettings();await this.resetRuntimeSettings(),i=await this.getRuntimeSettings(),i.barcodeFormatIds=e.barcodeFormatIds,i.barcodeFormatIds_2=e.barcodeFormatIds_2,i.region=e.region}else if("dense"==t){let e=await this.getRuntimeSettings();await this.resetRuntimeSettings(),this.maxCvsSideLength=4096,i=await this.getRuntimeSettings(),i.barcodeFormatIds=e.barcodeFormatIds,i.barcodeFormatIds_2=e.barcodeFormatIds_2,i.region=e.region,i.deblurLevel=9,i.expectedBarcodesCount=0,i.localizationModes=[2,8,0,0,0,0,0,0]}else if("distance"==t){let e=await this.getRuntimeSettings();await this.resetRuntimeSettings(),this.maxCvsSideLength=4096,i=await this.getRuntimeSettings(),i.barcodeFormatIds=e.barcodeFormatIds,i.barcodeFormatIds_2=e.barcodeFormatIds_2,i.region=e.region,i.deblurLevel=3,i.expectedBarcodesCount=0,i.localizationModes=[2,8,0,0,0,0,0,0]}else i=JSON.parse(t);else{if("object"!=typeof t)throw TypeError("'UpdateRuntimeSettings(settings)': Type of 'settings' should be 'string' or 'PlainObject'.");if(i=JSON.parse(JSON.stringify(t)),i.region instanceof Array){let e=i.region;[e.regionLeft,e.regionTop,e.regionLeft,e.regionBottom,e.regionMeasuredByPercentage].some((e=>void 0!==e))&&(i.region={regionLeft:e.regionLeft||0,regionTop:e.regionTop||0,regionRight:e.regionRight||0,regionBottom:e.regionBottom||0,regionMeasuredByPercentage:e.regionMeasuredByPercentage||0})}}if(!L._bUseFullFeature){if(0!=(i.barcodeFormatIds&~(e.EnumBarcodeFormat.BF_ONED|e.EnumBarcodeFormat.BF_QR_CODE|e.EnumBarcodeFormat.BF_PDF417|e.EnumBarcodeFormat.BF_DATAMATRIX))||0!=i.barcodeFormatIds_2)throw Error("Some of the specified barcode formats are not supported in the compact version. Please try the full-featured version.");if(0!=i.intermediateResultTypes)throw Error("Intermediate results is not supported in the compact version. Please try the full-featured version.")}if(this.bFilterRegionInJs){let e=i.region;if(e instanceof Array)throw Error("The `region` of type `Array` is only allowed in `BarcodeScanner`.");this.userDefinedRegion=JSON.parse(JSON.stringify(e)),(e.regionLeft||e.regionTop||e.regionRight||e.regionBottom||e.regionMeasuredByPercentage)&&(e.regionLeft||e.regionTop||100!=e.regionRight||100!=e.regionBottom||!e.regionMeasuredByPercentage)?this.region=e:this.region=null,i.region={regionLeft:0,regionTop:0,regionRight:0,regionBottom:0,regionMeasuredByPercentage:0}}else this.userDefinedRegion=null,this.region=null;return(this.autoZoom||this.autoFocus)&&(i.intermediateResultTypes|=e.EnumIntermediateResultType.IRT_TYPED_BARCODE_ZONE),await new Promise(((e,t)=>{let r=L._nextTaskID++;L._taskCallbackMap.set(r,(i=>{if(i.success){try{this._handleRetJsonString(i.updateReturn)}catch(e){t(e)}return e()}{let e=new Error(i.message);return e.stack=i.stack+"\n"+e.stack,t(e)}})),L._dbrWorker.postMessage({type:"updateRuntimeSettings",id:r,instanceID:this._instanceID,body:{settings:JSON.stringify(i)}})}))}async resetRuntimeSettings(){return this.userDefinedRegion=null,this.region=null,this.maxCvsSideLength=F,await new Promise(((e,t)=>{let i=L._nextTaskID++;L._taskCallbackMap.set(i,(i=>{if(i.success)return e();{let e=new Error(i.message);return e.stack=i.stack+"\n"+e.stack,t(e)}})),L._dbrWorker.postMessage({type:"resetRuntimeSettings",id:i,instanceID:this._instanceID})}))}async _resetRuntimeSettingsToCppDefault(){return this.userDefinedRegion=null,this.region=null,this.maxCvsSideLength=F,await new Promise(((e,t)=>{let i=L._nextTaskID++;L._taskCallbackMap.set(i,(i=>{if(i.success)return e();{let e=new Error(i.message);return e.stack=i.stack+"\n"+e.stack,t(e)}})),L._dbrWorker.postMessage({type:"resetRuntimeSettingsToCppDefault",id:i,instanceID:this._instanceID})}))}async outputRuntimeSettingsToString(){if(!L._bUseFullFeature)throw Error("outputRuntimeSettingsToString() is not supported in the compact version. Please try the full-featured version.");return await new Promise(((e,t)=>{let i=L._nextTaskID++;L._taskCallbackMap.set(i,(i=>{if(i.success)return e(i.results);{let e=new Error(i.message);return e.stack=i.stack+"\n"+e.stack,t(e)}})),L._dbrWorker.postMessage({type:"outputRuntimeSettingsToString",id:i,instanceID:this._instanceID})}))}async initRuntimeSettingsWithString(e){if(!L._bUseFullFeature)throw Error("initRuntimeSettingsWithString() is not supported in the compact version. Please try the full-featured version.");if("string"==typeof e)e=e;else{if("object"!=typeof e)throw TypeError("'initRuntimeSettingstWithString(settings)': Type of 'settings' should be 'string' or 'PlainObject'.");e=JSON.stringify(e)}return await new Promise(((t,i)=>{let r=L._nextTaskID++;L._taskCallbackMap.set(r,(e=>{if(e.success){try{this._handleRetJsonString(e.initReturn)}catch(e){i(e)}return t()}{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,i(t)}})),L._dbrWorker.postMessage({type:"initRuntimeSettingsWithString",id:r,instanceID:this._instanceID,body:{settings:e}})}))}async _decode_Blob(e,t){L._onLog&&L._onLog("_decode_Blob(blob: Blob)");let i=null,r=null;if("undefined"!=typeof createImageBitmap)try{i=await createImageBitmap(e)}catch(e){}i||(r=await function(e){return new Promise(((t,i)=>{let r=URL.createObjectURL(e),n=new Image;n.dbrObjUrl=r,n.src=r,n.onload=()=>{t(n)},n.onerror=e=>{i(new Error("Can't convert blob to image : "+(e instanceof Event?e.type:e)))}}))}(e));let n=await this._decode_Image(i||r,t);return i&&i.close(),n}async _decode_ArrayBuffer(e,t){return await this._decode_Blob(new Blob([e]),t)}async _decode_Uint8Array(e,t){return await this._decode_Blob(new Blob([e]),t)}async _decode_Image(e,t){L._onLog&&L._onLog("_decode_Image(image: HTMLImageElement|ImageBitmap)"),t=t||{};let i,r,n=e instanceof HTMLImageElement?e.naturalWidth:e.width,s=e instanceof HTMLImageElement?e.naturalHeight:e.height,o=Math.max(n,s);if(o>this._maxCvsSideLength){let e=this._maxCvsSideLength/o;i=Math.round(n*e),r=Math.round(s*e)}else i=n,r=s;this.canvas||(this.canvas=document.createElement("canvas"));const a=this.canvas;a.width===i&&a.height===r||(a.width=i,a.height=r),a.ctx2d||(a.ctx2d=a.getContext("2d",{willReadFrequently:!0}));a.ctx2d.drawImage(e,0,0,n,s,0,0,i,r),e.dbrObjUrl&&URL.revokeObjectURL(e.dbrObjUrl);let h=await this._decode_Canvas(a,t);if(this.ifSaveOriginalImageInACanvas){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;t.getContext("2d").drawImage(e,0,0),this.oriCanvas=t,this.oriCanvasData=null}return L.recalculateResultLocation(h,0,0,n,s,i,r),h}async _decode_Canvas(t,i){if(L._onLog&&L._onLog("_decode_Canvas(canvas:HTMLCanvasElement)"),t.crossOrigin&&"anonymous"!=t.crossOrigin)throw"cors";if(0===t.width||0===t.height)throw Error("The width or height of the 'canvas' is 0.");this.ifSaveOriginalImageInACanvas&&(this.oriCanvas=t,this.oriCanvasData=null);let r=(t.ctx2d||t.getContext("2d",{willReadFrequently:!0})).getImageData(0,0,t.width,t.height).data;return await this._decodeBuffer_Uint8Array(r,t.width,t.height,4*t.width,e.EnumImagePixelFormat.IPF_ABGR_8888,0,i)}async _decode_Video(e,t){if(L._onLog&&L._onLog("_decode_Video(video)"),!(e instanceof HTMLVideoElement))throw TypeError("'_decode_Video(video [, config] )': Type of 'video' should be 'HTMLVideoElement'.");if(e.crossOrigin&&"anonymous"!=e.crossOrigin)throw"cors";t=t||{};let i,r,n=e.videoWidth,s=e.videoHeight,o=Math.max(n,s);if(o>this._maxCvsSideLength){let e=this._maxCvsSideLength/o;i=Math.round(n*e),r=Math.round(s*e)}else i=n,r=s;this.canvas||(this.canvas=document.createElement("canvas"));const a=this.canvas;a.width===i&&a.height===r||(a.width=i,a.height=r),a.ctx2d||(a.ctx2d=a.getContext("2d",{willReadFrequently:!0}));a.ctx2d.drawImage(e,0,0,n,s,0,0,i,r);let h=await this._decode_Canvas(a,t);if(this.ifSaveOriginalImageInACanvas){const t=document.createElement("canvas");t.width=e.videoWidth,t.height=e.videoHeight;t.getContext("2d").drawImage(e,0,0),this.oriCanvas=t,this.oriCanvasData=null}return L.recalculateResultLocation(h,0,0,n,s,i,r),h}async _decode_DCEFrame(t,i){if(L._onLog&&L._onLog("_decode_DCEFrame(dceFrame)"),!L.isDCEFrame(t))return[];let r=[];this.ifSaveOriginalImageInACanvas&&(this.oriCanvas=null,this.oriCanvasData={width:t.width,height:t.height,colorMode:t.colorMode,pixelFormat:t.pixelFormat,data:new Uint8Array(t.data),toCanvas:t.toCanvas});const{width:n,height:s,colorMode:o,pixelFormat:a,stride:h,timeStamp:l}=t;let c;c=i&&i.bCopyData?new Uint8Array(t.data):t.data;let u=null;if(i?(u=JSON.parse(JSON.stringify(i)),u.timeStamp=l):u={timeStamp:l},a&&h)if("grey"===a)r=await this._decodeBuffer_Uint8Array(c,n,s,h,e.EnumImagePixelFormat.IPF_GrayScaled,0,u);else if("rgba"===a)r=await this._decodeBuffer_Uint8Array(c,n,s,h,e.EnumImagePixelFormat.IPF_ABGR_8888,0,u);else{if("bgra"!==a)throw new Error(`Pixel format '${a}' is not supported to decode.`);r=await this._decodeBuffer_Uint8Array(c,n,s,h,e.EnumImagePixelFormat.IPF_ARGB_8888,0,u)}else if("grey"===o)r=await this._decodeBuffer_Uint8Array(c,n,s,n,e.EnumImagePixelFormat.IPF_GrayScaled,0,u);else if("rgba"===o)r=await this._decodeBuffer_Uint8Array(c,n,s,4*n,e.EnumImagePixelFormat.IPF_ABGR_8888,0,u);else{if("bgra"!==o)throw new Error(`Color mode '${o}' is not supported to decode.`);r=await this._decodeBuffer_Uint8Array(c,n,s,4*n,e.EnumImagePixelFormat.IPF_ARGB_8888,0,u)}return r}async _decode_DSImage(t,i){if(L._onLog&&L._onLog("_decode_DSImage(dsImage)"),!L.isDSImage(t))return null;this.ifSaveOriginalImageInACanvas&&(this.oriCanvas=null,this.oriCanvasData={width:t.width,height:t.height,pixelFormat:t.pixelFormat.toLowerCase(),data:new Uint8Array(t.data),toCanvas:function(){const e=document.createElement("canvas");let t;switch(e.width=this.width,e.height=this.height,this.pixelFormat){case"grey":t=new Uint8ClampedArray(this.width*this.height*4);for(let e=0;e<t.length;e+=4)t[e]=this.data[e/4],t[e+1]=this.data[e/4],t[e+2]=this.data[e/4],t[e+3]=255;break;case"rgb":t=new Uint8ClampedArray(this.width*this.height*4);for(let e=0;e<t.length;e+=4)t[e]=this.data[e],t[e+1]=this.data[e+1],t[e+2]=this.data[e+2],t[e+3]=255;break;case"bgr":t=new Uint8ClampedArray(this.width*this.height*4);for(let e=0;e<t.length;e+=4)t[e]=this.data[e],t[e+1]=this.data[e+1],t[e+2]=this.data[e+2],t[e+3]=255;break;case"rgba":case"bgra":t=new Uint8ClampedArray(this.data);break;default:throw new Error("The content of 2D Canvas is currently limited to the sRGB color space.")}const i=new ImageData(t,this.width,this.height);return e.getContext("2d").putImageData(i,0,0),e}});const{width:r,height:n}=t;let s,o,a,h=t.pixelFormat.toLowerCase();switch(s=i&&i.bCopyData?new Uint8Array(t.data):t.data,h){case"grey":a=e.EnumImagePixelFormat.IPF_GrayScaled,o=r;break;case"rgb":a=e.EnumImagePixelFormat.IPF_BGR_888,o=3*r;break;case"bgr":a=e.EnumImagePixelFormat.IPF_RGB_888,o=3*r;break;case"rgba":a=e.EnumImagePixelFormat.IPF_ABGR_8888,o=4*r;break;case"bgra":a=e.EnumImagePixelFormat.IPF_ARGB_8888,o=4*r;break;default:throw new Error("The pixel format is not supported to decode.")}return await this._decodeBuffer_Uint8Array(s,r,n,o,a,0,i)}async _decode_Base64(e,t){if(L._onLog&&L._onLog("_decode_Base64(base64Str)"),"string"!=typeof e)return Promise.reject("'_decode_Base64(base64Str, config)': Type of 'base64Str' should be 'string'.");"data:image/"==e.substring(0,11)&&(e=e.substring(e.indexOf(",")+1));{let i=atob(e),r=i.length,n=new Uint8Array(r);for(;r--;)n[r]=i.charCodeAt(r);return await this._decode_Blob(new Blob([n]),t)}}async _decode_Url(e,t){if(L._onLog&&L._onLog("_decode_Url(url)"),"string"!=typeof e)throw TypeError("'_decode_Url(url, config)': Type of 'url' should be 'string'.");e=e;{let i=await new Promise(((t,i)=>{let r=new XMLHttpRequest;r.open("GET",e,!0),r.responseType="blob",r.send(),r.onloadend=r.onerror=()=>{i(new Error("Network Error: "+r.statusText))}}));return await this._decode_Blob(i,t)}}async _decode_FilePath(e,t){throw L._onLog&&L._onLog("_decode_FilePath(path)"),Error("'_decode_FilePath(path, config)': The method is only supported in node environment.")}static recalculateResultLocation(e,t,i,r,n,s,o){if(e.length>0)for(let a of e){let e=a.localizationResult;2==e.resultCoordinateType&&(e.x1*=.01*s,e.x2*=.01*s,e.x3*=.01*s,e.x4*=.01*s,e.y1*=.01*o,e.y2*=.01*o,e.y3*=.01*o,e.y4*=.01*o);let h=s/r,l=o/n;e.x1=e.x1/h+t,e.x2=e.x2/h+t,e.x3=e.x3/h+t,e.x4=e.x4/h+t,e.y1=e.y1/l+i,e.y2=e.y2/l+i,e.y3=e.y3/l+i,e.y4=e.y4/l+i,2==e.resultCoordinateType&&(e.x1*=100/r,e.x2*=100/r,e.x3*=100/r,e.x4*=100/r,e.y1*=100/n,e.y2*=100/n,e.y3*=100/n,e.y4*=100/n),e.x1=Math.round(e.x1),e.x2=Math.round(e.x2),e.x3=Math.round(e.x3),e.x4=Math.round(e.x4),e.y1=Math.round(e.y1),e.y2=Math.round(e.y2),e.y3=Math.round(e.y3),e.y4=Math.round(e.y4)}}static BarcodeReaderException(t,i){let r,n=e.EnumErrorCode.DBR_UNKNOWN;return"number"==typeof t?(n=t,r=new Error(i)):r=new Error(t),r.code=n,r}_handleRetJsonString(t){let i=e.EnumErrorCode;if(t.textResults){for(let e=0;e<t.textResults.length;e++){let i=t.textResults[e];try{let e=i.barcodeText,t="";for(let i=0;i<e.length;i++)t+=String.fromCharCode(e[i]);try{i.barcodeText=decodeURIComponent(escape(t))}catch(e){i.barcodeText=t}}catch(e){i.barcodeText=""}if(null!=i.exception){L._setWarnnedEx.has(i.exception)||(L._setWarnnedEx.add(i.exception),console.warn(i.exception));let e={};i.exception.split(";").forEach((t=>{let i=t.indexOf(":");e[t.substring(0,i)]=t.substring(i+1)})),i.exception=e}}return t.decodeRecords?this.decodeRecords=t.decodeRecords:this.decodeRecords={},this._lastErrorCode=t.exception,this._lastErrorString=t.description,t.exception&&!L._setWarnnedEx.has(t.description)&&(L._setWarnnedEx.add(t.description),console.warn(t.description)),t.textResults}if(t.exception==i.DBR_SUCCESS)return t.data;throw L.BarcodeReaderException(t.exception,t.description)}async setModeArgument(e,t,i,r){return await new Promise(((n,s)=>{let o=L._nextTaskID++;L._taskCallbackMap.set(o,(e=>{if(e.success){try{this._handleRetJsonString(e.setReturn)}catch(e){return s(e)}return n()}{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,s(t)}})),L._dbrWorker.postMessage({type:"setModeArgument",id:o,instanceID:this._instanceID,body:{modeName:e,index:t,argumentName:i,argumentValue:r}})}))}async getModeArgument(e,t,i){return await new Promise(((r,n)=>{let s=L._nextTaskID++;L._taskCallbackMap.set(s,(e=>{if(e.success){let t;try{t=this._handleRetJsonString(e.getReturn)}catch(e){return n(e)}return r(t)}{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,n(t)}})),L._dbrWorker.postMessage({type:"getModeArgument",id:s,instanceID:this._instanceID,body:{modeName:e,index:t,argumentName:i}})}))}async getIntermediateResults(){return await new Promise(((e,t)=>{let i=L._nextTaskID++;L._taskCallbackMap.set(i,(i=>{if(i.success)return e(i.results);{let e=new Error(i.message);return e.stack=i.stack+"\n"+e.stack,t(e)}})),L._dbrWorker.postMessage({type:"getIntermediateResults",id:i,instanceID:this._instanceID})}))}async getIntermediateCanvas(){let t=await this.getIntermediateResults(),i=[];for(let r of t)if(r.dataType==e.EnumIMResultDataType.IMRDT_IMAGE)for(let t of r.results){const r=t.bytes;let n;switch(L._onLog&&L._onLog(" "+r.length+" "+r.byteLength+" "+t.width+" "+t.height+" "+t.stride+" "+t.format),t.format){case e.EnumImagePixelFormat.IPF_ABGR_8888:n=new Uint8ClampedArray(r);break;case e.EnumImagePixelFormat.IPF_RGB_888:{const e=r.length/3;n=new Uint8ClampedArray(4*e);for(let t=0;t<e;++t)n[4*t]=r[3*t+2],n[4*t+1]=r[3*t+1],n[4*t+2]=r[3*t],n[4*t+3]=255;break}case e.EnumImagePixelFormat.IPF_GrayScaled:{const e=r.length;n=new Uint8ClampedArray(4*e);for(let t=0;t<e;t++)n[4*t]=n[4*t+1]=n[4*t+2]=r[t],n[4*t+3]=255;break}case e.EnumImagePixelFormat.IPF_Binary:case e.EnumImagePixelFormat.IPF_BinaryInverted:{const e=r.length,i=t.width,s=t.height,o=t.stride;n=new Uint8ClampedArray(i*s*4);for(let t=0;t<e;t++){let e=r[t],s=t%o*8,a=Math.floor(t/o);for(let t=0;t<8;t++){let r=s+t,o=4*(a*i+r);if(r>=i)break;n[o]=n[o+1]=n[o+2]=(128&e)/128*255,n[o+3]=255,e<<=1}}break}default:console.warn("unknow intermediate image",t)}if(!n)continue;let s=new ImageData(n,t.width,t.height),o=document.createElement("canvas");o.width=t.width,o.height=t.height,o.getContext("2d").putImageData(s,0,0),i.push(o)}return i}async getScanSettings(){return await new Promise(((e,t)=>{let i=L._nextTaskID++;L._taskCallbackMap.set(i,(i=>{if(i.success){let t=i.results;return t.intervalTime=this.intervalTime,t.whenToPlaySoundforSuccessfulRead=this.whenToPlaySoundforSuccessfulRead,t.soundOnSuccessfullRead=this.soundSource,t.whenToVibrateforSuccessfulRead=this.whenToVibrateforSuccessfulRead,t.vibrateDuration=this.vibrateDuration,t.captureAndDecodeInParallel=this.captureAndDecodeInParallel,t.autoZoom=this.autoZoom,t.autoFocus=this.autoFocus,t.autoSuggestTip=this.autoSuggestTip,e(t)}{let e=new Error(i.message);return e.stack+="\n"+i.stack,t(e)}})),L._dbrWorker.postMessage({type:"getScanSettings",id:i,instanceID:this._instanceID})}))}async updateScanSettings(t){if(!t)return;const i=JSON.parse(JSON.stringify(t));if(i.autoZoom||i.autoFocus||i.autoSuggestTip){if(!L._bUseFullFeature)throw new Error("'autoZoom', 'autoFocus' and 'autoSuggestTip' are not supported in the compact version. Please try the full-featured version.");const t=await this.getRuntimeSettings();t.intermediateResultTypes|=e.EnumIntermediateResultType.IRT_TYPED_BARCODE_ZONE,await this.updateRuntimeSettings(t)}return i.hasOwnProperty("intervalTime")&&(this.intervalTime=Math.max(i.intervalTime,0),delete i.intervalTime),i.hasOwnProperty("whenToPlaySoundforSuccessfulRead")&&(this.whenToPlaySoundforSuccessfulRead=i.whenToPlaySoundforSuccessfulRead,delete i.whenToPlaySoundforSuccessfulRead),i.hasOwnProperty("soundOnSuccessfullRead")&&(this.soundSource=i.soundOnSuccessfullRead,delete i.soundOnSuccessfullRead),i.hasOwnProperty("whenToVibrateforSuccessfulRead")&&(this.whenToVibrateforSuccessfulRead=i.whenToVibrateforSuccessfulRead,delete i.whenToVibrateforSuccessfulRead),i.hasOwnProperty("vibrateDuration")&&(this.vibrateDuration=i.vibrateDuration,delete i.vibrateDuration),i.hasOwnProperty("captureAndDecodeInParallel")&&(this.captureAndDecodeInParallel=i.captureAndDecodeInParallel,delete i.captureAndDecodeInParallel),i.hasOwnProperty("autoZoom")&&(this.autoZoom&&this.autoZoom!=i.autoZoom&&this.dce&&this.dce.setZoom({factor:1}).catch((()=>{})),this.autoZoom=i.autoZoom,delete i.autoZoom),i.hasOwnProperty("autoFocus")&&(this.autoFocus=i.autoFocus,this.dce&&this.dce.setFocus({mode:"continuous"}).catch((()=>{})),delete i.autoFocus),i.hasOwnProperty("autoSuggestTip")&&(this.autoSuggestTip=i.autoSuggestTip,delete i.autoFocus),await new Promise(((e,t)=>{let r=L._nextTaskID++;L._taskCallbackMap.set(r,(i=>{if(i.success)return e();{let e=new Error(i.message);return e.stack+="\n"+i.stack,t(e)}})),L._dbrWorker.postMessage({type:"updateScanSettings",id:r,instanceID:this._instanceID,body:{settings:i}})}))}_cloneDecodeResults(e){if(e instanceof Array){let t=[];for(let i of e)t.push(this._cloneDecodeResults(i));return t}{let t=e,i=JSON.parse(JSON.stringify(t,((e,t)=>"oriVideoCanvas"==e||"searchRegionCanvas"==e?void 0:t)));return i}}async _loopReadVideo(){if(this.bDestroyed)return this.dce&&this._dceControler&&this._dceControler.setDisiredAction(this,"stopFetchingLoop"),this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),void this._drawResults(null);if(this.dce&&!this.dce.isOpen())return this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),this._drawResults(null),void await this.clearMapDecodeRecord();if(!this.dce&&!this._imgSource||this._bPauseScan)return L._onLog&&L._onLog("Scan is paused, or imageSource is not set. Ask in 1s."),await this.clearMapDecodeRecord(),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),void(this._loopReadVideoTimeoutId=setTimeout((()=>{this._loopReadVideo()}),this._intervalDetectVideoPause));L._onLog&&L._onLog("======= once read ======="),L._onLog&&(this._timeStartDecode=Date.now());let e=null,t=null;if(this.dce)e=this._getVideoFrame();else if(this._imgSource&&(t=await this._imgSource.getImage(),!L.isDSImage(t)))throw new Error("Invalid DSImage.");if(!e&&!t)return L._onLog&&L._onLog("Get invalid frame."),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),void(this._loopReadVideoTimeoutId=setTimeout((()=>{this._loopReadVideo()}),0));(async()=>{let i=[];if(e){i=await this._decode_DCEFrame(e,{bScanner:!0,bCopyData:!1});let t=null;if(i&&i.length){const{sx:r,sy:n,width:s,height:o,_sWidth:a,_sHeight:h}=e;t=i.map((e=>({resultState:e.resultState,localizationResult:JSON.parse(JSON.stringify(e.localizationResult))}))),L.recalculateResultLocation(t,r,n,a,h,s,o)}0==this._resultHighlightingDuration?this._drawResults(null):this._drawResults(t,i),this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),this._resultHighlightingDuration>0&&(this._clearResultsCanvasTimeoutId=setTimeout((()=>{this.bDestroyed||this._drawResults(null)}),this._resultHighlightingDuration))}else t&&(i=await this._decode_DSImage(t,{bScanner:!0,bCopyData:!1}));return i})().then((e=>{if(L._onLog&&L._onLog(e),this.dce&&this.captureAndDecodeInParallel){let e=this.array_decodeFrameTimeCost,t=this.array_getFrameTimeCost;const i=()=>{let i=0;if(t&&t.length){let r=Math.min(...e),n=Math.max(...t);r&&n&&(i=r-n)}else i=0;return i>0?i:0};(()=>{for(;e.length>=5;)e.shift();e.push(this._lastInnerDecodeDuration)})(),this._intervalGetVideoFrame=i()+this.intervalTime}if((this.dce&&this.dce.isOpen()||this._imgSource)&&!this._bPauseScan){if(this.bPlaySoundOnSuccessfulRead&&e.length){let t=!1;!0===this.bPlaySoundOnSuccessfulRead||"frame"===this.bPlaySoundOnSuccessfulRead?t=e.some((e=>e.resultState>=0)):"unique"===this.bPlaySoundOnSuccessfulRead&&(t=e.some((e=>0==e.resultState))),t&&this.beepSound&&(this.beepSound.stop(),this.beepSound.play())}if(navigator.vibrate&&this.bVibrateOnSuccessfulRead&&e.length){let t=!1;if(!0===this.bVibrateOnSuccessfulRead||"frame"===this.bVibrateOnSuccessfulRead?t=e.some((e=>e.resultState>=0)):"unique"===this.bVibrateOnSuccessfulRead&&(t=e.some((e=>0==e.resultState))),t)try{navigator.vibrate(this.vibrateDuration)}catch(e){console.warn("Vibration not allowed. User interaction required: "+(e.message||e))}}if(this.onImageRead){e=e.filter((e=>e.resultState>=0));const t=this._cloneDecodeResults(e);this.onImageRead(t)}if(this.onUniqueRead){e=e.filter((e=>0==e.resultState));const t=this._cloneDecodeResults(e);for(let e of t)this.onUniqueRead(e.barcodeText,e)}}this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this.intervalTime?this._loopReadVideoTimeoutId=setTimeout((()=>{this._loopReadVideo()}),this.intervalTime):this._loopReadVideo()})).catch((e=>{this.dce&&this._dceControler&&this._dceControler.setDisiredAction(this,"stopFetchingLoop"),L._onLog&&L._onLog(e.message||e),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this._loopReadVideoTimeoutId=setTimeout((()=>{this.dce&&(this.dce.startFetchingLoop(),this._dceControler&&this._dceControler.clearUserDisiredAction({user:this,actionName:"stopFetchingLoop"})),this._loopReadVideo()}),Math.max(this.intervalTime,1e3)),"platform error"==e.message||console.warn(e.message)}))}_getVideoFrame(){if(!this.dce)return null;let e;if(this.captureAndDecodeInParallel){if(L._onLog&&L._onLog("Get frame in parallel."),this._dceControler&&this._dceControler.setDisiredValue(this,"loopInterval",this._intervalGetVideoFrame),!this.dce.numberOfFramesInBuffer)return this._dceControler&&this._dceControler.setDisiredValue(this,"loopInterval",0),null;e=this.dce.getFrameFromBuffer();const t=e=>{if(!e)return;let t=e.timeSpent,i=this.array_getFrameTimeCost;for(;i.length>=5;)i.shift();i.push(t)};t(e)}else L._onLog&&L._onLog("Get frame in serial."),this._dceControler&&this._dceControler.setDisiredAction(this,"stopFetchingLoop"),e=this.dce.getFrame();return e}_drawResults(e,t){if(!this.dce||this.dce.disposed||this._bPauseScan||!this._drawingItemNamespace||!this._drawingItemNamespace.DT_Polygon)return;if(!this._dbrDrawingLayer){if(!this.dce.isOpen())return;if(!(this.dce.singleFrameMode||this.dce.video&&this.dce._videoTrack))return;this._dbrDrawingLayer=this.dce.getDrawingLayer(3)}const i=this._dbrDrawingLayer;e||(e=[]);let r=this._arrPolygons;for(let n=0;n<e.length;n++){let s,o=e[n].localizationResult;r[n]?(s=r[n],i.hasDrawingItem(s)||i.addDrawingItem(s),s.set("vertices",[{x:o.x1,y:o.y1},{x:o.x2,y:o.y2},{x:o.x3,y:o.y3},{x:o.x4,y:o.y4}]),(s.set||s.setAttribute).call(s,"vertices",[{x:o.x1,y:o.y1},{x:o.x2,y:o.y2},{x:o.x3,y:o.y3},{x:o.x4,y:o.y4}])):(s=new this._drawingItemNamespace.DT_Polygon([{x:o.x1,y:o.y1},{x:o.x2,y:o.y2},{x:o.x3,y:o.y3},{x:o.x4,y:o.y4}]),i.addDrawingItem(s),r[n]=s),-1===e[n].resultState?(s.styleId=this._styleIdBeforeVerification,s._mapStyle.set("default",this.dce.getDrawingStyle(this._styleIdBeforeVerification)),s._mapStyle.set("selected",this.dce.getDrawingStyle(this._styleIdBeforeVerification))):(s.styleId=null,s._mapStyle.set("default",this.dce.getDrawingStyle(3)),s._mapStyle.set("selected",this.dce.getDrawingStyle(7))),t&&t[n]?s.addNote({name:"Barcode_Result",content:t[n]},!0):s.addNote({name:"Barcode_Result",content:e[n]},!0)}for(let t=e.length;t<r.length;t++)r[t].deleteNote("Barcode_Result"),i.removeDrawingItem(r[t]);i.renderAll()}async startScanning(e){if(!this.dce&&!this._imgSource)throw new Error("'imageSource' is not set. call 'setImageSource()' before 'startScanning()'.");if(this._promiseStartScan&&this._promiseStartScan.isPending)return this._promiseStartScan;this._promiseStartScan=new C;let t=null;if(this.dce){if(this.dce.isOpen())if(e&&this.dce.appendAndShowUI(),this.dce.playCallbackInfo)t=JSON.parse(JSON.stringify(this.dce.playCallbackInfo));else{const e=this.dce.getSelectedCamera();t={width:this.dce.video.videoWidth,height:this.dce.video.videoHeight,deviceId:e&&e.deviceId}}else if(t=await this.dce.open(e),!this._promiseStartScan)return null;this._dceControler&&(this._dceControler.clearUserDisiredAction({user:this,actionName:"close"}),this._dceControler.setDisiredValue(this,"ifShowScanRegionLaser",!0),this.dce.ifShowScanRegionLaser&&this.dce.showScanRegionLaser())}return this._bPauseScan=!1,this.dce&&this.dce.singleFrameMode||(this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this._loopReadVideoTimeoutId=setTimeout((()=>{this.dce&&(this.dce.startFetchingLoop(),this._dceControler&&this._dceControler.clearUserDisiredAction({user:this,actionName:"stopFetchingLoop"})),this._loopReadVideo()}),0)),this._promiseStartScan.resolve(t),t}stopScanning(e){this.dce&&(this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),this._drawResults(null),this._dceControler&&(this._dceControler.setDisiredValue(this,"ifShowScanRegionLaser",!1),this.dce.ifShowScanRegionLaser||this.dce.hideScanRegionLaser(),this._dceControler.setDisiredAction(this,"close",[e]))),this._bPauseScan=!0,this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0,this._promiseStartScan=null}pauseScanning(e){if(this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),e&&e.keepResultsHighlighted||this._drawResults(null),this._bPauseScan=!0,this.dce){if(this.dce.singleFrameMode)throw new Error("'pauseScanning()' is unavailable when property 'singleFrameMode' of the 'CameraEnhancer' instance is true.");this._dceControler&&(this._dceControler.setDisiredValue(this,"ifShowScanRegionLaser",!1),this.dce.ifShowScanRegionLaser||this.dce.hideScanRegionLaser(),this._dceControler.setDisiredAction(this,"stopFetchingLoop"))}}resumeScanning(){if(this._bPauseScan=!1,this.dce){if(this.dce.singleFrameMode)throw new Error("'resumeScanning()' is unavailable when property 'singleFrameMode' of the 'CameraEnhancer' instance is true.");this.dce.startFetchingLoop(),this._dceControler&&(this._dceControler.clearUserDisiredAction({user:this,actionName:"stopFetchingLoop"}),this._dceControler.setDisiredValue(this,"ifShowScanRegionLaser",!0),this.dce.ifShowScanRegionLaser&&this.dce.showScanRegionLaser())}}destroyContext(){if(L._onLog&&L._onLog("destroyContext()"),this.bDestroyed)return;this.bDestroyed=!0,(this.dce||this._promiseStartScan)&&this.stopScanning(),this.setImageSource(null);let e=L._nextTaskID++;L._taskCallbackMap.set(e,(e=>{if(!e.success){let t=new Error(e.message);throw t.stack=e.stack+"\n"+t.stack,t}})),L._dbrWorker.postMessage({type:"destroyContext",id:e,instanceID:this._instanceID})}}L._jsVersion="9.6.20",L._jsEditVersion="20230410",L._version=`loading...(JS ${L._jsVersion}.${L._jsEditVersion})`,L._license=f,L._sessionPassword=g,L.browserInfo=o,L._workerName=`dbr-${L._jsVersion}.browser.worker.js`,L._engineResourcePath=u,L._licenseServer=[],L._deviceFriendlyName="",L._isShowRelDecodeTimeInResults=!1,L._bWasmDebug=!1,L._bNeverShowDialog=!1,L.__bUseFullFeature=!0,L._nextTaskID=0,L._taskCallbackMap=new Map,L._pLoad=new C,L._lastErrorCode=0,L._lastErrorString="",L._setWarnnedEx=new Set,L._defaultUIElementURL="@engineResourcePath/dbr.ui.html";var P={653:(e,t,i)=>{var r,n,s,o,a,h,l,c,u,d,f,g,_,p,m,v,y,S,w,C,b,x=x||{version:"5.2.1"};if(t.fabric=x,"undefined"!=typeof document&&"undefined"!=typeof window)document instanceof("undefined"!=typeof HTMLDocument?HTMLDocument:Document)?x.document=document:x.document=document.implementation.createHTMLDocument(""),x.window=window;else{var T=new(i(192).JSDOM)(decodeURIComponent("%3C!DOCTYPE%20html%3E%3Chtml%3E%3Chead%3E%3C%2Fhead%3E%3Cbody%3E%3C%2Fbody%3E%3C%2Fhtml%3E"),{features:{FetchExternalResources:["img"]},resources:"usable"}).window;x.document=T.document,x.jsdomImplForWrapper=i(898).implForWrapper,x.nodeCanvas=i(245).Canvas,x.window=T,DOMParser=x.window.DOMParser}isTouchSupported="ontouchstart"in x.window||"ontouchstart"in x.document||x.window&&x.window.navigator&&x.window.navigator.maxTouchPoints>0,x.isLikelyNode="undefined"!=typeof Buffer&&"undefined"==typeof window,x.SHARED_ATTRIBUTES=["display","transform","fill","fill-opacity","fill-rule","opacity","stroke","stroke-dasharray","stroke-linecap","stroke-dashoffset","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","id","paint-order","vector-effect","instantiated_by_use","clip-path"],x.DPI=96,x.reNum="(?:[-+]?(?:\\d+|\\d*\\.\\d+)(?:[eE][-+]?\\d+)?)",x.commaWsp="(?:\\s+,?\\s*|,\\s*)",x.rePathCommand=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:[eE][-+]?\d+)?)/gi,x.reNonWord=/[ \n\.,;!\?\-]/,x.fontPaths={},x.iMatrix=[1,0,0,1,0,0],x.svgNS="http://www.w3.org/2000/svg",x.perfLimitSizeTotal=2097152,x.maxCacheSideLimit=4096,x.minCacheSideLimit=256,x.charWidthsCache={},x.textureSize=2048,x.disableStyleCopyPaste=!1,x.enableGLFiltering=!0,x.devicePixelRatio=x.window.devicePixelRatio||x.window.webkitDevicePixelRatio||x.window.mozDevicePixelRatio||1,x.browserShadowBlurConstant=1,x.arcToSegmentsCache={},x.boundsOfCurveCache={},x.cachesBoundsOfCurve=!0,x.forceGLPutImageData=!1,x.initFilterBackend="undefined"!=typeof document&&"undefined"!=typeof window&&(window.fabric=x),function(){Observable={fire:on:once:off:function(t,i){if(!this.__eventListeners)return this;if(0===arguments.length)for(t in this.__eventListeners)e.call(this,t);else if(1===arguments.length&&"object"==typeof arguments[0])for(var r in t)e.call(this,r,t[r]);else e.call(this,t,i);return this}}}(),x.Collection={_objects:[],add:insertAt:remove:forEachObject:getObjects:item:isEmpty:size:function(){return this._objects.length},contains:function(e,t){return this._objects.indexOf(e)>-1||!!t&&this._objects.some((function(t){return"function"==typeof t.contains&&t.contains(e,!0)}))},complexity:function(){return this._objects.reduce((function(e,t){return e+(t.complexity?t.complexity():0)}),0)}},x.CommonMethods={_setOptions:function(e){for(var t in e)this.set(t,e[t])},_initGradient:_initPattern:_setObject:set:function(e,t){return"object"==typeof e?this._setObject(e):this._set(e,t),this},_set:toggle:get:,r=t,n=Math.sqrt,s=Math.atan2,o=Math.pow,a=Math.PI/180,h=Math.PI/2,x.util={cos:sin:removeFromArray:getRandomInt:degreesToRadians:radiansToDegrees:rotatePoint:rotateVector:createVector:calcAngleBetweenVectors:getHatVector:getBisector:function(e,t,i){var r=x.util.createVector(e,t),n=x.util.createVector(e,i),s=x.util.calcAngleBetweenVectors(r,n),o=s*(0===x.util.calcAngleBetweenVectors(x.util.rotateVector(r,s),n)?1:-1)/2;return{vector:x.util.getHatVector(x.util.rotateVector(r,o)),angle:s}},projectStrokeOnPoints:transformPoint:makeBoundingBoxFromPoints:invertTransform:toFixed:parseUnit:falseFunction:function(){return!1},getKlass:getSvgAttributes:resolveNamespace:loadImage:function(e,t,i,r){if(e){var n=x.util.createImage(),s=n.onload=s,n.onerror=0!==e.indexOf("data")&&null!=r&&(n.crossOrigin=r),"data:image/svg"===e.substring(0,14)&&(n.onload=null,x.util.loadImageInDom(n,s)),n.src=e}else t&&t.call(i,e)},loadImageInDom:enlivenObjects:enlivenObjectEnlivables:enlivenPatterns:groupSVGElements:function(e,t,i){var r;return e&&1===e.length?e[0]:(t&&(t.width&&t.height?t.centerPoint={x:t.width/2,y:t.height/2}:(delete t.width,delete t.height)),r=new x.Group(e,t),void 0!==i&&(r.sourcePath=i),r)},populateWithProperties:createCanvasElement:function(){return x.document.createElement("canvas")},copyCanvasElement:toDataURL:createImage:multiplyTransformMatrices:qrDecompose:calcRotateMatrix:calcDimensionsMatrix:composeMatrix:resetObjectTransform:saveObjectTransform:isTransparent:function(e,t,i,r){r>0&&(t>r?t-=r:t=0,i>r?i-=r:i=0);var n,s=!0,o=e.getImageData(t,i,2*r||1,2*r||1),a=o.data.length;for(n=3;n<a&&0!=(s=o.data[n]<=0);n+=4);return o=null,s},parsePreserveAspectRatioAttribute:clearFabricFontCache:limitDimsByArea:capValue:findScaleToFit:function(e,t){return Math.min(t.width/e.width,t.height/e.height)},findScaleToCover:matrixToSVG:removeTransformFromObject:addTransformToObject:applyTransformToObject:sizeAfterTransform:mergeClipPaths:,function(){var e=Array.prototype.join,t={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},i={m:"l",M:"L"};function r(e,t,i,r,n,s,o,a,h,l,c){var u=x.util.cos(e),d=x.util.sin(e),f=x.util.cos(t),g=x.util.sin(t),_=i*n*f-r*s*g+o,p=r*n*f+i*s*g+a;return["C",l+h*(-i*n*d-r*s*u),c+h*(-r*n*d+i*s*u),_+h*(i*n*g+r*s*f),p+h*(r*n*g-i*s*f),_,p]}unction s(e,t,i){for(var s=i[1],o=i[2],a=i[3],h=i[4],l=i[5],c=function(e,t,i,s,o,a,h){var l=Math.PI,c=h*l/180,u=x.util.sin(c),d=x.util.cos(c),f=0,g=0,_=-d*e*.5-u*t*.5,p=-d*t*.5+u*e*.5,m=(i=Math.abs(i))*i,v=(s=Math.abs(s))*s,y=p*p,S=_*_,w=m*v-m*y-v*S,C=0;if(w<0){var b=Math.sqrt(1-w/(m*v));i*=b,s*=b}else C=(o===a?-1:1)*Math.sqrt(w/(m*y+v*S));var T=C*i*p/s,E=-C*s*_/i,I=d*T-u*E+.5*e,O=u*T+d*E+.5*t,A=n(1,0,(_-T)/i,(p-E)/s),R=n((_-T)/i,(p-E)/s,(-_-T)/i,(-p-E)/s);0===a&&R>0?R-=2*l:1===a&&R<0&&(R+=2*l);for(var D=Math.ceil(Math.abs(R/l*2)),M=[],F=R/D,L=8/3*Math.sin(F/4)*Math.sin(F/4)/Math.sin(F/2),P=A+F,k=0;k<D;k++)M[k]=r(A,P,d,u,i,s,I,O,L,f,g),f=M[k][5],g=M[k][6],A=P,P+=F;return M}(i[6]-e,i[7]-t,s,o,h,l,a),u=0,d=c.length;u<d;u++)c[u][1]+=e,c[u][2]+=t,c[u][3]+=e,c[u][4]+=t,c[u][5]+=e,c[u][6]+=t;return c}on d(e){for(var t,i,r,n,s=0,d=e.length,f=0,g=0,_=0,p=0,m=[],v=0;v<d;v++){switch(r={x:f,y:g,command:(t=e[v])[0]},t[0]){case"M":r.length=0,_=f=t[1],p=g=t[2];break;case"L":r.length=o(f,g,t[1],t[2]),f=t[1],g=t[2];break;case"C":i=a(f,g,t[1],t[2],t[3],t[4],t[5],t[6]),n=h(f,g,t[1],t[2],t[3],t[4],t[5],t[6]),r.iterator=i,r.angleFinder=n,r.length=u(i,f,g),f=t[5],g=t[6];break;case"Q":i=l(f,g,t[1],t[2],t[3],t[4]),n=c(f,g,t[1],t[2],t[3],t[4]),r.iterator=i,r.angleFinder=n,r.length=u(i,f,g),f=t[3],g=t[4];break;case"Z":case"z":r.destX=_,r.destY=p,r.length=o(f,g,_,p),f=_,g=p}s+=r.length,m.push(r)}return m.push({length:s,x:f,y:g}),m}x.util.joinPath=x.util.parsePath=function(e){var r,n,s,o,a,h=[],l=[],c=x.rePathCommand,u="[-+]?(?:\\d*\\.\\d+|\\d+\\.?)(?:[eE][-+]?\\d+)?\\s*",d="("+u+")"+x.commaWsp,f="([01])"+x.commaWsp+"?",g=new RegExp(d+"?"+d+"?"+d+f+f+d+"?("+u+")","g");if(!e||!e.match)return h;for(var _,p=0,m=(a=e.match(/[mzlhvcsqta][^mzlhvcsqta]*/gi)).length;p<m;p++){o=(r=a[p]).slice(1).trim(),l.length=0;var v=r.charAt(0);if(_=[v],"a"===v.toLowerCase())for(var y;y=g.exec(o);)for(var S=1;S<y.length;S++)l.push(y[S]);else for(;s=c.exec(o);)l.push(s[0]);S=0;for(var w=l.length;S<w;S++)n=parseFloat(l[S]),isNaN(n)||_.push(n);var C=t[v.toLowerCase()],b=i[v]||v;if(_.length-1>C)for(var T=1,E=_.length;T<E;T+=C)h.push([v].concat(_.slice(T,T+C))),v=b;else h.push(_)}return h},x.util.makePathSimpler=x.util.getSmoothPathFromPoints=function(e,t){var i,r=[],n=new x.Point(e[0].x,e[0].y),s=new x.Point(e[1].x,e[1].y),o=e.length,a=1,h=0,l=o>2;for(t=t||0,l&&(a=e[2].x<s.x?-1:e[2].x===s.x?0:1,h=e[2].y<s.y?-1:e[2].y===s.y?0:1),r.push(["M",n.x-a*t,n.y-h*t]),i=1;i<o;i++){if(!n.eq(s)){var c=n.midPointFrom(s);r.push(["Q",n.x,n.y,c.x,c.y])}n=e[i],i+1<e.length&&(s=e[i+1])}return l&&(a=n.x>e[i-2].x?1:n.x===e[i-2].x?0:-1,h=n.y>e[i-2].y?1:n.y===e[i-2].y?0:-1),r.push(["L",n.x+a*t,n.y+h*t]),r},x.util.getPathSegmentsInfo=d,x.util.getBoundsOfCurve=function(t,i,r,n,s,o,a,h){var l;if(x.cachesBoundsOfCurve&&(l=e.call(arguments),x.boundsOfCurveCache[l]))return x.boundsOfCurveCache[l];var c,u,d,f,g,_,p,m,v=Math.sqrt,y=Math.min,S=Math.max,w=Math.abs,C=[],b=[[],[]];u=6*t-12*r+6*s,c=-3*t+9*r-9*s+3*a,d=3*r-3*t;for(var T=0;T<2;++T)if(T>0&&(u=6*i-12*n+6*o,c=-3*i+9*n-9*o+3*h,d=3*n-3*i),w(c)<1e-12){if(w(u)<1e-12)continue;0<(f=-d/u)&&f<1&&C.push(f)}else(p=u*u-4*d*c)<0||(0<(g=(-u+(m=v(p)))/(2*c))&&g<1&&C.push(g),0<(_=(-u-m)/(2*c))&&_<1&&C.push(_));for(var E,I,O,A=C.length,R=A;A--;)E=(O=1-(f=C[A]))*O*O*t+3*O*O*f*r+3*O*f*f*s+f*f*f*a,b[0][A]=E,I=O*O*O*i+3*O*O*f*n+3*O*f*f*o+f*f*f*h,b[1][A]=I;b[0][R]=t,b[1][R]=i,b[0][R+1]=a,b[1][R+1]=h;var D=[{x:y.apply(null,b[0]),y:y.apply(null,b[1])},{x:S.apply(null,b[0]),y:S.apply(null,b[1])}];return x.cachesBoundsOfCurve&&(x.boundsOfCurveCache[l]=D),D},x.util.getPointOnPath=function(e,t,i){i||(i=d(e));for(var r=0;t-i[r].length>0&&r<i.length-2;)t-=i[r].length,r++;var n,s=i[r],a=t/s.length,h=s.command,l=e[r];switch(h){case"M":return{x:s.x,y:s.y,angle:0};case"Z":case"z":return(n=new x.Point(s.x,s.y).lerp(new x.Point(s.destX,s.destY),a)).angle=Math.atan2(s.destY-s.y,s.destX-s.x),n;case"L":return(n=new x.Point(s.x,s.y).lerp(new x.Point(l[1],l[2]),a)).angle=Math.atan2(l[2]-s.y,l[1]-s.x),n;case"C":case"Q":return function(e,t){for(var i,r,n,s=0,a=0,h=e.iterator,l={x:e.x,y:e.y},c=.01,u=e.angleFinder;a<t&&c>1e-4;)i=h(s),n=s,(r=o(l.x,l.y,i.x,i.y))+a>t?(s-=c,c/=2):(l=i,s+=c,a+=r);return i.angle=u(n),i}(s,t)}},x.util.transformPath=(),),function(){function e(t,i,r){if(r)if(!x.isLikelyNode&&i instanceof Element)t=i;else if(i instanceof Array){t=[];for(var n=0,s=i.length;n<s;n++)t[n]=e({},i[n],r)}else if(i&&"object"==typeof i)for(var o in i)"canvas"===o||"group"===o?t[o]=null:i.hasOwnProperty(o)&&(t[o]=e({},i[o],r));else t=i;else for(var o in i)t[o]=i[o];return t}x.util.object={extend:e,clone:,x.util.object.extend(x.util,x.Observable)}(),),),l=!!x.document.createElement("div").attachEvent,c=["touchstart","touchmove","touchend"],x.util.addListener=function(e,t,i,r){e&&e.addEventListener(t,i,!l&&r)},x.util.removeListener=x.util.getPointer=x.util.isTouchEvent=d="string"==typeof(u=x.document.createElement("div")).style.opacity,f="string"==typeof u.style.filter,g=/alpha\s*\(\s*opacity\s*=\s*([^\)]+)\)/,_=d?_=f&&(_=,x.util.setStyle=function(){var e,t,i,r,n=Array.prototype.slice,s=try{e=s(x.document.childNodes)instanceof Array}catch(e){}|(s=,t=x.document.defaultView&&x.document.defaultView.getComputedStyle?i=x.document.documentElement.style,r="userSelect"in i?"userSelect":"MozUserSelect"in i?"MozUserSelect":"WebkitUserSelect"in i?"WebkitUserSelect":"KhtmlUserSelect"in i?"KhtmlUserSelect":"",x.util.makeElementUnselectable=x.util.makeElementSelectable=x.util.setImageSmoothing=x.util.getById=x.util.toArray=s,x.util.addClass=x.util.makeElement=o,x.util.wrapElement=x.util.getScrollLeftTop=a,x.util.getElementOffset=x.util.getNodeCanvas=x.util.cleanUpJsdomNode=(),),x.log=console.log,x.warn=console.warn,function(){var e=x.util.object.extend,t=x.util.object.clone,i=[];util.object.extend(i,{cancelAll:cancelByCanvas:function(e){if(!e)return[];var t=this.filter((function(t){return"object"==typeof t.target&&t.target.canvas===e}));return t.forEach((function(e){e.cancel()})),t},cancelByTarget:findAnimationIndex:findAnimation:findAnimationsByTarget:);var s=x.window.requestAnimationFrame||x.window.webkitRequestAnimationFrame||x.window.mozRequestAnimationFrame||x.window.oRequestAnimationFrame||x.window.msRequestAnimationFrame||o=x.window.cancelAnimationFrame||x.window.clearTimeout;.util.animate=function(i){i||(i={});var s,o=!1,h=return s=e(t(i),{cancel:currentValue:"startValue"in i?i.startValue:0,completionRate:0,durationRate:0}),x.runningAnimations.push(s),a((function(e){var t,l=e||+new Date,c=i.duration||500,u=l+c,d=i.onChange||r,f=i.abort||r,g=i.onComplete||r,_=i.easing||n,p="startValue"in i&&i.startValue.length>0,m="startValue"in i?i.startValue:0,v="endValue"in i?i.endValue:100,y=i.byValue||(p?m.map((function(e,t){return v[t]-m[t]})):v-m);i.onStart&&i.onStart(),function e(i){var r=(t=i||+new Date)>u?c:t-l,n=r/c,S=p?m.map(():_(r,m,y,c),w=p?Math.abs((S[0]-m[0])/y[0]):Math.abs((S-m)/y);if(s.currentValue=p?S.slice():S,s.completionRate=w,s.durationRate=n,!o){if(!f(S,w,n))return t>u?(s.currentValue=p?v.slice():v,s.completionRate=1,s.durationRate=1,d(p?v.slice():v,1,1),g(v,1,1),void h()):(d(S,w,n),void a(e));h()}}(l)})),s.cancel},x.util.requestAnimFrame=a,x.util.cancelAnimFrame=x.runningAnimations=i}(),function(){function e(e,t,i){var r="rgba("+parseInt(e[0]+i*(t[0]-e[0]),10)+","+parseInt(e[1]+i*(t[1]-e[1]),10)+","+parseInt(e[2]+i*(t[2]-e[2]),10);return(r+=","+(e&&t?parseFloat(e[3]+i*(t[3]-e[3])):1))+")"}x.util.animateColor=(),function(){il.ease={easeInQuad:easeOutQuad:easeInOutQuad:easeInCubic:easeOutCubic:easeInOutCubic:easeInQuart:easeOutQuart:easeInOutQuart:easeInQuint:easeOutQuint:easeInOutQuint:easeInSine:easeOutSine:easeInOutSine:easeInExpo:easeOutExpo:easeInOutExpo:easeInCirc:easeOutCirc:easeInOutCirc:easeInElastic:function(i,r,n,s){var o=0;return 0===i?r:1==(i/=s)?r+n:(o||(o=.3*s),-t(e(n,n,o,1.70158),i,s)+r)},easeOutElastic:function(t,i,r,n){var s=0;if(0===t)return i;if(1==(t/=n))return i+r;s||(s=.3*n);var o=e(r,r,s,1.70158);return o.a*Math.pow(2,-10*t)*Math.sin((t*n-o.s)*(2*Math.PI)/o.p)+o.c+i},easeInOutElastic:function(i,r,n,s){var o=0;if(0===i)return r;if(2==(i/=s/2))return r+n;o||(o=s*(.3*1.5));var a=e(n,n,o,1.70158);return i<1?-.5*t(a,i,s)+r:a.a*Math.pow(2,-10*(i-=1))*Math.sin((i*s-a.s)*(2*Math.PI)/a.p)*.5+a.c+r},easeInBack:easeOutBack:easeInOutBack:easeInBounce:i,easeOutBounce:r,easeInOutBounce:}(),function(e){var t=e.fabric||(e.fabric={}),i=t.util.object.extend,r=t.util.object.clone,n=t.util.toFixed,s=t.util.parseUnit,o=t.util.multiplyTransformMatrices,a={cx:"left",x:"left",r:"radius",cy:"top",y:"top",display:"visible",visibility:"visible",transform:"transformMatrix","fill-opacity":"fillOpacity","fill-rule":"fillRule","font-family":"fontFamily","font-size":"fontSize","font-style":"fontStyle","font-weight":"fontWeight","letter-spacing":"charSpacing","paint-order":"paintFirst","stroke-dasharray":"strokeDashArray","stroke-dashoffset":"strokeDashOffset","stroke-linecap":"strokeLineCap","stroke-linejoin":"strokeLineJoin","stroke-miterlimit":"strokeMiterLimit","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","text-decoration":"textDecoration","text-anchor":"textAnchor",opacity:"opacity","clip-path":"clipPath","clip-rule":"clipRule","vector-effect":"strokeUniform","image-rendering":"imageSmoothing"},h={stroke:"strokeOpacity",fill:"fillOpacity"},l="font-size",c="clip-path";unction d(e,i,r,n){var a,h=Array.isArray(i);if("fill"!==e&&"stroke"!==e||"none"!==i){if("strokeUniform"===e)return"non-scaling-stroke"===i;if("strokeDashArray"===e)i="none"===i?null:i.replace(/,/g," ").split(/\s+/).map(parseFloat);else if("transformMatrix"===e)i=r&&r.transformMatrix?o(r.transformMatrix,t.parseTransformAttribute(i)):t.parseTransformAttribute(i);else if("visible"===e)i="none"!==i&&"hidden"!==i,r&&!1===r.visible&&(i=!1);else if("opacity"===e)i=parseFloat(i),r&&void 0!==r.opacity&&(i*=r.opacity);else if("textAnchor"===e)i="start"===i?"left":"end"===i?"right":"center";else if("charSpacing"===e)a=s(i,n)/n*1e3;else if("paintFirst"===e){var l=i.indexOf("fill"),c=i.indexOf("stroke");i="fill",(l>-1&&c>-1&&c<l||-1===l&&c>-1)&&(i="stroke")}else{if("href"===e||"xlink:href"===e||"font"===e)return i;if("imageSmoothing"===e)return"optimizeQuality"===i;a=h?i.map(s):s(i,n)}}else i="";return!h&&isNaN(a)?i:a}nction _(e,t){var i,r=!0;return(i=p(e,t.pop()))&&t.length&&(r=function(e,t){for(var i,r=!0;e.parentNode&&1===e.parentNode.nodeType&&t.length;)r&&(i=t.pop()),r=p(e=e.parentNode,i);return 0===t.length}(e,t)),i&&r&&0===t.length}svgValidTagNamesRegEx=f(["path","circle","polygon","polyline","ellipse","rect","line","image","text"]),t.svgViewBoxElementsRegEx=f(["symbol","image","marker","pattern","view","svg"]),t.svgInvalidAncestorsRegEx=f(["pattern","defs","symbol","metadata","clipPath","mask","desc"]),t.svgValidParentsRegEx=f(["symbol","g","a","svg","clipPath","defs"]),t.cssRules={},t.gradientDefs={},t.clipPaths={},t.parseTransformAttribute=function(){ar i=t.iMatrix,r=t.reNum,n=t.commaWsp,s="(?:(?:(matrix)\\s*\\(\\s*("+r+")"+n+"("+r+")"+n+"("+r+")"+n+"("+r+")"+n+"("+r+")"+n+"("+r+")\\s*\\))|(?:(translate)\\s*\\(\\s*("+r+")(?:"+n+"("+r+"))?\\s*\\))|(?:(scale)\\s*\\(\\s*("+r+")(?:"+n+"("+r+"))?\\s*\\))|(?:(rotate)\\s*\\(\\s*("+r+")(?:"+n+"("+r+")"+n+"("+r+"))?\\s*\\))|(?:(skewX)\\s*\\(\\s*("+r+")\\s*\\))|(?:(skewY)\\s*\\(\\s*("+r+")\\s*\\)))",o=new RegExp("^\\s*(?:(?:"+s+"(?:"+n+"*"+s+")*)?)\\s*$"),a=new RegExp(s,"g");return ();var v=new RegExp("^\\s*("+t.reNum+"+)\\s*,?\\s*("+t.reNum+"+)\\s*,?\\s*("+t.reNum+"+)\\s*,?\\s*("+t.reNum+"+)\\s*$");function y(e){if(!t.svgViewBoxElementsRegEx.test(e.nodeName))return{};var i,r,n,o,a,h,l=e.getAttribute("viewBox"),c=1,u=1,d=e.getAttribute("width"),f=e.getAttribute("height"),g=e.getAttribute("x")||0,_=e.getAttribute("y")||0,p=e.getAttribute("preserveAspectRatio")||"",m=!l||!(l=l.match(v)),y=!d||!f||"100%"===d||"100%"===f,S=m&&y,w={},C="",b=0,x=0;if(w.width=0,w.height=0,w.toBeParsed=S,m&&(g||_)&&e.parentNode&&"#document"!==e.parentNode.nodeName&&(C=" translate("+s(g)+" "+s(_)+") ",a=(e.getAttribute("transform")||"")+C,e.setAttribute("transform",a),e.removeAttribute("x"),e.removeAttribute("y")),S)return w;if(m)return w.width=s(d),w.height=s(f),w;if(i=-parseFloat(l[1]),r=-parseFloat(l[2]),n=parseFloat(l[3]),o=parseFloat(l[4]),w.minX=i,w.minY=r,w.viewBoxWidth=n,w.viewBoxHeight=o,y?(w.width=n,w.height=o):(w.width=s(d),w.height=s(f),c=w.width/n,u=w.height/o),"none"!==(p=t.util.parsePreserveAspectRatioAttribute(p)).alignX&&("meet"===p.meetOrSlice&&(u=c=c>u?u:c),"slice"===p.meetOrSlice&&(u=c=c>u?c:u),b=w.width-n*c,x=w.height-o*c,"Mid"===p.alignX&&(b/=2),"Mid"===p.alignY&&(x/=2),"Min"===p.alignX&&(b=0),"Min"===p.alignY&&(x=0)),1===c&&1===u&&0===i&&0===r&&0===g&&0===_)return w;if((g||_)&&"#document"!==e.parentNode.nodeName&&(C=" translate("+s(g)+" "+s(_)+") "),a=C+" matrix("+c+" 0 0 "+u+" "+(i*c+b)+" "+(r*u+x)+") ","svg"===e.nodeName){for(h=e.ownerDocument.createElementNS(t.svgNS,"g");e.firstChild;)h.appendChild(e.firstChild);e.appendChild(h)}else(h=e).removeAttribute("x"),h.removeAttribute("y"),a=h.getAttribute("transform")+a;return h.setAttribute("transform",a),w}.parseSVGDocument=function(e,i,n,s){if(e){!function(e){for(var i=g(e,["use","svg:use"]),r=0;i.length&&r<i.length;){var n=i[r],s=n.getAttribute("xlink:href")||n.getAttribute("href");if(null===s)return;var o,a,h,l,c=s.slice(1),u=n.getAttribute("x")||0,d=n.getAttribute("y")||0,f=m(e,c).cloneNode(!0),_=(f.getAttribute("transform")||"")+" translate("+u+", "+d+")",p=i.length,v=t.svgNS;if(y(f),/^svg$/i.test(f.nodeName)){var S=f.ownerDocument.createElementNS(v,"g");for(a=0,l=(h=f.attributes).length;a<l;a++)o=h.item(a),S.setAttributeNS(v,o.nodeName,o.nodeValue);for(;f.firstChild;)S.appendChild(f.firstChild);f=S}for(a=0,l=(h=n.attributes).length;a<l;a++)"x"!==(o=h.item(a)).nodeName&&"y"!==o.nodeName&&"xlink:href"!==o.nodeName&&"href"!==o.nodeName&&("transform"===o.nodeName?_=o.nodeValue+" "+_:f.setAttribute(o.nodeName,o.nodeValue));f.setAttribute("transform",_),f.setAttribute("instantiated_by_use","1"),f.removeAttribute("id"),n.parentNode.replaceChild(f,n),i.length===p&&r++}}(e);var o,a,h=t.Object.__uid++,l=y(e),c=t.util.toArray(e.getElementsByTagName("*"));if(l.crossOrigin=s&&s.crossOrigin,l.svgUid=h,0===c.length&&t.isLikelyNode){var u=[];for(o=0,a=(c=e.selectNodes('//*[name(.)!="svg"]')).length;o<a;o++)u[o]=c[o];c=u}var d=c.filter(();if(!d||d&&!d.length)i&&i([],{});else{var f={};c.filter(().forEach((),t.gradientDefs[h]=t.getGradientDefs(e),t.cssRules[h]=t.getCSSRules(e),t.clipPaths[h]=f,t.parseElements(d,(,r(l),n,s)}}};var w=new RegExp("(normal|italic)?\\s*(normal|small-caps)?\\s*(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900)?\\s*("+t.reNum+"(?:px|cm|mm|em|pt|pc|in)*)(?:\\/(normal|"+t.reNum+"))?\\s+(.*)");i(t,{parseFontDeclaration:getGradientDefs:parseAttributes:function(e,r,o){if(e){var a,f,g,p={};void 0===o&&(o=e.getAttribute("svgUid")),e.parentNode&&t.svgValidParentsRegEx.test(e.parentNode.nodeName)&&(p=t.parseAttributes(e.parentNode,r,o));var m=r.reduce((,{}),v=i(e,o),t.parseStyleAttribute(e));m=i(m,v),v[c]&&e.setAttribute(c,v[c]),f=g=p.fontSize||t.Text.DEFAULT_SVG_FONT_SIZE,m[l]&&(m[l]=f=s(m[l],g));var y,S,w={};for(var C in m)S=d(y=u(C),m[C],p,f),w[y]=S;w&&w.font&&t.parseFontDeclaration(w.font,w);var b=i(p,w);return t.svgValidParentsRegEx.test(e.nodeName)?b:b)}},parseElements:parseStyleAttribute:parsePointsAttribute:getCSSRules:function(e){var i,r,n=e.getElementsByTagName("style"),s={};for(i=0,r=n.length;i<r;i++){var o=n[i].textContent;""!==(o=o.replace(/\/\*[\s\S]*?\*\//g,"")).trim()&&o.split("}").filter((function(e){return e.trim()})).forEach((function(e){var n=e.split("{"),o={},a=n[1].trim().split(";").filter((function(e){return e.trim()}));for(i=0,r=a.length;i<r;i++){var h=a[i].split(":"),l=h[0].trim(),c=h[1].trim();o[l]=c}(e=n[0].trim()).split(",").forEach(()}))}return s},loadSVGFromURL:function(e,i,r,n){e=e.replace(/^\n\s*/,"").trim(),new t.util.request(e,{method:"get",onComplete:function(e){var s=e.responseXML;if(!s||!s.documentElement)return i&&i(null),!1;t.parseSVGDocument(s.documentElement,(,r,n)}})},loadSVGFromString:function(e,i,r,n){var s=(new t.window.DOMParser).parseFromString(e.trim(),"text/xml");t.parseSVGDocument(s.documentElement,(,r,n)}})}(t),x.ElementsParser=(p=x.ElementsParser.prototype).parse=p.createObjects=p.findTag=p.createObject=p.createCallback=p.extractPropertyDefinition=p.resolveGradient=p.createClipPathCallback=p.resolveClipPath=p.checkIfDone=function(e){var t=e.fabric||(e.fabric={});.Point?t.warn("fabric.Point is already defined"):(t.Point=i,i.prototype={type:"point",constructor:i,add:addEquals:scalarAdd:scalarAddEquals:subtract:subtractEquals:scalarSubtract:scalarSubtractEquals:multiply:multiplyEquals:divide:divideEquals:eq:lt:lte:gt:gte:lerp:distanceFrom:midPointFrom:function(e){return this.lerp(e)},min:function(e){return new i(Math.min(this.x,e.x),Math.min(this.y,e.y))},max:toString:setXY:setX:function(e){return this.x=e,this},setY:setFromPoint:swap:clone:)}(t),function(e){var t=e.fabric||(e.fabric={});.Intersection?t.warn("fabric.Intersection is already defined"):(t.Intersection=i,t.Intersection.prototype={constructor:i,appendPoint:appendPoints:,t.Intersection.intersectLineLine=t.Intersection.intersectLinePolygon=t.Intersection.intersectPolygonPolygon=t.Intersection.intersectPolygonRectangle=}(t),function(e){var t=e.fabric||(e.fabric={});Color?t.warn("fabric.Color is already defined."):(t.Color=i,t.Color.prototype={_tryParsingColor:_rgbToHsl:getSource:function(){return this._source},setSource:function(e){this._source=e},toRgb:toRgba:toHsl:toHsla:toHex:toHexa:getAlpha:setAlpha:toGrayscale:toBlackWhite:overlayWith:,t.Color.reRGBa=/^rgba?\(\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*(?:\s*,\s*((?:\d*\.?\d+)?)\s*)?\)$/i,t.Color.reHSLa=/^hsla?\(\s*(\d{1,3})\s*,\s*(\d{1,3}\%)\s*,\s*(\d{1,3}\%)\s*(?:\s*,\s*(\d+(?:\.\d+)?)\s*)?\)$/i,t.Color.reHex=/^#?([0-9a-f]{8}|[0-9a-f]{6}|[0-9a-f]{4}|[0-9a-f]{3})$/i,t.Color.colorNameMap={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"},t.Color.fromRgb=function(e){return i.fromSource(i.sourceFromRgb(e))},t.Color.sourceFromRgb=t.Color.fromRgba=i.fromRgb,t.Color.fromHsl=function(e){return i.fromSource(i.sourceFromHsl(e))},t.Color.sourceFromHsl=t.Color.fromHsla=i.fromHsl,t.Color.fromHex=t.Color.sourceFromHex=t.Color.fromSource=}(t),function(e){var t=e.fabric||(e.fabric={}),i=["e","se","s","sw","w","nw","n","ne","e"],r=["ns","nesw","ew","nwse"],n={},s="left",o="top",a="right",h="bottom",l="center",c={top:h,bottom:o,left:a,right:s,center:l},u=t.util.radiansToDegrees,d=Math.sign||nction _(e,t){var i=t.canvas,r=e[i.uniScaleKey];return i.uniformScaling&&!r||!i.uniformScaling&&r}unction m(e,t,i){var r=e.lockScalingX,n=e.lockScalingY;return!((!r||!n)&&(t||!r&&!n||!i)&&(!r||"x"!==t)&&(!n||"y"!==t))}ion b(e,t,i,r,n){if(0!==e[t]){var s=n/e._getTransformedDimensions()[r]*e[i];e.set(i,s)}}nction E(e,t,i,r,n){n=n||{};var s,o,a,h,l,u,f=t.target,g=f.lockScalingX,v=f.lockScalingY,y=n.by,S=_(e,f),C=m(f,y,S),b=t.gestureScale;if(C)return!1;if(b)o=t.scaleX*b,a=t.scaleY*b;else{if(s=w(t,t.originX,t.originY,i,r),l="y"!==y?d(s.x):1,u="x"!==y?d(s.y):1,t.signX||(t.signX=l),t.signY||(t.signY=u),f.lockScalingFlip&&(t.signX!==l||t.signY!==u))return!1;if(h=f._getTransformedDimensions(),S&&!y){var x=Math.abs(s.x)+Math.abs(s.y),T=t.original,E=x/(Math.abs(h.x*T.scaleX/f.scaleX)+Math.abs(h.y*T.scaleY/f.scaleY));o=T.scaleX*E,a=T.scaleY*E}else o=Math.abs(s.x*f.scaleX/h.x),a=Math.abs(s.y*f.scaleY/h.y);p(t)&&(o*=2,a*=2),t.signX!==l&&"y"!==y&&(t.originX=c[t.originX],o*=-1,t.signX=l),t.signY!==u&&"x"!==y&&(t.originY=c[t.originY],a*=-1,t.signY=u)}var I=f.scaleX,O=f.scaleY;return y?("x"===y&&f.set("scaleX",o),"y"===y&&f.set("scaleY",a)):(!g&&f.set("scaleX",o),!v&&f.set("scaleY",a)),I!==f.scaleX||O!==f.scaleY}n.scaleCursorStyleHandler=function(e,t,r){var n=_(e,r),s="";if(0!==t.x&&0===t.y?s="x":0===t.x&&0!==t.y&&(s="y"),m(r,s,n))return"not-allowed";var o=f(r,t);return i[o]+"-resize"},n.skewCursorStyleHandler=function(e,t,i){var n="not-allowed";if(0!==t.x&&i.lockSkewingY)return n;if(0!==t.y&&i.lockSkewingX)return n;var s=f(i,t)%4;return r[s]+"-resize"},n.scaleSkewCursorStyleHandler=n.rotationWithSnapping=S("rotating",y((function(e,t,i,r){var n=t,s=n.target,o=s.translateToOriginPoint(s.getCenterPoint(),n.originX,n.originY);if(s.lockRotation)return!1;var a,h=Math.atan2(n.ey-o.y,n.ex-o.x),l=Math.atan2(r-o.y,i-o.x),c=u(l-h+n.theta);if(s.snapAngle>0){var d=s.snapAngle,f=s.snapThreshold||d,g=Math.ceil(c/d)*d,_=Math.floor(c/d)*d;Math.abs(c-_)<f?c=_:Math.abs(c-g)<f&&(c=g)}return c<0&&(c=360+c),c%=360,a=s.angle!==c,s.angle=c,a}))),n.scalingEqually=S("scaling",y(()),n.scalingX=S("scaling",y((function(e,t,i,r){return E(e,t,i,r,{by:"x"})}))),n.scalingY=S("scaling",y(()),n.scalingYOrSkewingX=function(e,t,i,r){return e[t.target.canvas.altActionKey]?n.skewHandlerX(e,t,i,r):n.scalingY(e,t,i,r)},n.scalingXOrSkewingY=n.changeWidth=S("resizing",y(()),n.skewHandlerX=function(e,t,i,r){var n,h=t.target,c=h.skewX,u=t.originY;return!h.lockSkewingX&&(0===c?n=w(t,l,l,i,r).x>0?s:a:(c>0&&(n=u===o?s:a),c<0&&(n=u===o?a:s),C(h)&&(n=n===s?a:s)),t.originX=n,S("skewing",y(x))(e,t,i,r))},n.skewHandlerY=function(e,t,i,r){var n,a=t.target,c=a.skewY,u=t.originX;return!a.lockSkewingY&&(0===c?n=w(t,l,l,i,r).y>0?o:h:(c>0&&(n=u===s?o:h),c<0&&(n=u===s?h:o),C(a)&&(n=n===o?h:o)),t.originY=n,S("skewing",y(T))(e,t,i,r))},n.dragHandler=n.scaleOrSkewActionName=function(e,t,i){var r=e[i.canvas.altActionKey];return 0===t.x?r?"skewX":"scaleY":0===t.y?r?"skewY":"scaleX":void 0},n.rotationStyleHandler=n.fireEvent=g,n.wrapWithFixedAnchor=y,n.wrapWithFireEvent=S,n.getLocalPoint=w,t.controlsUtils=n}(t),function(e){var t=e.fabric||(e.fabric={}),i=t.util.degreesToRadians,r=t.controlsUtils;r.renderCircleControl=function(e,t,i,r,n){r=r||{};var s,o=this.sizeX||r.cornerSize||n.cornerSize,a=this.sizeY||r.cornerSize||n.cornerSize,h=void 0!==r.transparentCorners?r.transparentCorners:n.transparentCorners,l=h?"stroke":"fill",c=!h&&(r.cornerStrokeColor||n.cornerStrokeColor),u=t,d=i;e.save(),e.fillStyle=r.cornerColor||n.cornerColor,e.strokeStyle=r.cornerStrokeColor||n.cornerStrokeColor,o>a?(s=o,e.scale(1,a/o),d=i*o/a):a>o?(s=a,e.scale(o/a,1),u=t*a/o):s=o,e.lineWidth=1,e.beginPath(),e.arc(u,d,s/2,0,2*Math.PI,!1),e[l](),c&&e.stroke(),e.restore()},r.renderSquareControl=function(e,t,r,n,s){n=n||{};var o=this.sizeX||n.cornerSize||s.cornerSize,a=this.sizeY||n.cornerSize||s.cornerSize,h=void 0!==n.transparentCorners?n.transparentCorners:s.transparentCorners,l=h?"stroke":"fill",c=!h&&(n.cornerStrokeColor||s.cornerStrokeColor),u=o/2,d=a/2;e.save(),e.fillStyle=n.cornerColor||s.cornerColor,e.strokeStyle=n.cornerStrokeColor||s.cornerStrokeColor,e.lineWidth=1,e.translate(t,r),e.rotate(i(s.angle)),e[l+"Rect"](-u,-d,o,a),c&&e.strokeRect(-u,-d,o,a),e.restore()}}(t),function(e){var t=e.fabric||(e.fabric={});t.Control=function(e){for(var t in e)this[t]=e[t]},t.Control.prototype={visible:!0,actionName:"scale",angle:0,x:0,y:0,offsetX:0,offsetY:0,sizeX:null,sizeY:null,touchSizeX:null,touchSizeY:null,cursorStyle:"crosshair",withConnection:!1,actionHandler:function(){},mouseDownHandler:function(){},mouseUpHandler:function(){},getActionHandler:function(){return this.actionHandler},getMouseDownHandler:function(){return this.mouseDownHandler},getMouseUpHandler:function(){return this.mouseUpHandler},cursorStyleHandler:function(e,t){return t.cursorStyle},getActionName:getVisibility:function(e,t){var i=e._controlsVisibility;return i&&void 0!==i[t]?i[t]:this.visible},setVisibility:function(e){this.visible=e},positionHandler:calcCornerCoords:function(e,i,r,n,s){var o,a,h,l,c=s?this.touchSizeX:this.sizeX,u=s?this.touchSizeY:this.sizeY;if(c&&u&&c!==u){var d=Math.atan2(u,c),f=Math.sqrt(c*c+u*u)/2,g=d-t.util.degreesToRadians(e),_=Math.PI/2-d-t.util.degreesToRadians(e);o=f*t.util.cos(g),a=f*t.util.sin(g),h=f*t.util.cos(_),l=f*t.util.sin(_)}else f=.7071067812*(c&&u?c:i),g=t.util.degreesToRadians(45-e),o=h=f*t.util.cos(g),a=l=f*t.util.sin(g);return{tl:{x:r-l,y:n-h},tr:{x:r+o,y:n-a},bl:{x:r-o,y:n+a},br:{x:r+l,y:n+h}}},render:function(e,i,r,n,s){"circle"===((n=n||{}).cornerStyle||s.cornerStyle)?t.controlsUtils.renderCircleControl.call(this,e,i,r,n,s):t.controlsUtils.renderSquareControl.call(this,e,i,r,n,s)}}}(t),function(){ar t=x.util.object.clone;x.Gradient=x.util.createClass({offsetX:0,offsetY:0,gradientTransform:null,gradientUnits:"pixels",type:"linear",initialize:addColorStop:toObject:toSVG:function(e,i){var r,n,s,o,a=t(this.coords,!0),h=(i=i||{},t(this.colorStops,!0)),l=a.r1>a.r2,c=this.gradientTransform?this.gradientTransform.concat():x.iMatrix.concat(),u=-this.offsetX,d=-this.offsetY,f=!!i.additionalTransform,g="pixels"===this.gradientUnits?"userSpaceOnUse":"objectBoundingBox";if(h.sort((),"objectBoundingBox"===g?(u/=e.width,d/=e.height):(u+=e.width/2,d+=e.height/2),"path"===e.type&&"percentage"!==this.gradientUnits&&(u-=e.pathOffset.x,d-=e.pathOffset.y),c[4]-=u,c[5]-=d,o='id="SVGID_'+this.id+'" gradientUnits="'+g+'"',o+=' gradientTransform="'+(f?i.additionalTransform+" ":"")+x.util.matrixToSVG(c)+'" ',"linear"===this.type?s=["<linearGradient ",o,' x1="',a.x1,'" y1="',a.y1,'" x2="',a.x2,'" y2="',a.y2,'">\n']:"radial"===this.type&&(s=["<radialGradient ",o,' cx="',l?a.x1:a.x2,'" cy="',l?a.y1:a.y2,'" r="',l?a.r1:a.r2,'" fx="',l?a.x2:a.x1,'" fy="',l?a.y2:a.y1,'">\n']),"radial"===this.type){if(l)for((h=h.concat()).reverse(),r=0,n=h.length;r<n;r++)h[r].offset=1-h[r].offset;var _=Math.min(a.r1,a.r2);if(_>0){var p=_/Math.max(a.r1,a.r2);for(r=0,n=h.length;r<n;r++)h[r].offset+=p*(1-h[r].offset)}}for(r=0,n=h.length;r<n;r++){var m=h[r];s.push("<stop ",'offset="',100*m.offset+"%",'" style="stop-color:',m.color,void 0!==m.opacity?";stop-opacity: "+m.opacity:";",'"/>\n')}return s.push("linear"===this.type?"</linearGradient>\n":"</radialGradient>\n"),s.join("")},toLive:),x.util.object.extend(x.Gradient,{fromElement:function(t,i,r,n){var s=parseFloat(r)/(/%$/.test(r)?100:1);s=s<0?0:s>1?1:s,isNaN(s)&&(s=1);var o,a,h,l,c=t.getElementsByTagName("stop"),u="userSpaceOnUse"===t.getAttribute("gradientUnits")?"pixels":"percentage",d=t.getAttribute("gradientTransform")||"",f=[],g=0,_=0;for("linearGradient"===t.nodeName||"LINEARGRADIENT"===t.nodeName?(o="linear",a=t)):(o="radial",a=t)),h=c.length;h--;)f.push(e(c[h],s));return l=x.parseTransformAttribute(d),function(e,t,i,r){var n,s;Object.keys(t).forEach(()}(0,a,n,u),"pixels"===u&&(g=-i.left,_=-i.top),new x.Gradient({id:t.getAttribute("id"),type:o,coords:a,colorStops:f,gradientUnits:u,gradientTransform:l,offsetX:g,offsetY:_})}})}(),m=x.util.toFixed,x.Pattern=x.util.createClass({repeat:"repeat",offsetX:0,offsetY:0,crossOrigin:"",patternTransform:null,initialize:function(e,t){if(e||(e={}),this.id=x.Object.__uid++,this.setOptions(e),!e.source||e.source&&"string"!=typeof e.source)t&&t(this);else{var i=this;this.source=x.util.createImage(),x.util.loadImage(e.source,(,null,this.crossOrigin)}},toObject:function(e){var t,i,r=x.Object.NUM_FRACTION_DIGITS;return"string"==typeof this.source.src?t=this.source.src:"object"==typeof this.source&&this.source.toDataURL&&(t=this.source.toDataURL()),i={type:"pattern",source:t,repeat:this.repeat,crossOrigin:this.crossOrigin,offsetX:m(this.offsetX,r),offsetY:m(this.offsetY,r),patternTransform:this.patternTransform?this.patternTransform.concat():null},x.util.populateWithProperties(this,i,e),i},toSVG:setOptions:function(e){for(var t in e)this[t]=e[t]},toLive:function(e){var t=this.source;if(!t)return"";if(void 0!==t.src){if(!t.complete)return"";if(0===t.naturalWidth||0===t.naturalHeight)return""}return e.createPattern(t,this.repeat)}}),function(e){var t=e.fabric||(e.fabric={}),i=t.util.toFixed;t.Shadow?t.warn("fabric.Shadow is already defined."):(t.Shadow=t.util.createClass({color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,affectStroke:!1,includeDefaultValues:!0,nonScaling:!1,initialize:_parseShadow:toString:toSVG:toObject:),t.Shadow.reOffsetsAndBlur=/(?:\s|^)(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(\d+(?:\.\d*)?(?:px)?)?(?:\s?|$)(?:$|\s)/)}(t),function(){if(x.StaticCanvas)x.warn("fabric.StaticCanvas is already defined.");else{var e=x.util.object.extend,t=x.util.getElementOffset,i=x.util.removeFromArray,r=x.util.toFixed,n=x.util.transformPoint,s=x.util.invertTransform,o=x.util.getNodeCanvas,a=x.util.createCanvasElement,h=new Error("Could not initialize `canvas` element");x.StaticCanvas=x.util.createClass(x.CommonMethods,{initialize:backgroundColor:"",backgroundImage:null,overlayColor:"",overlayImage:null,includeDefaultValues:!0,stateful:!1,renderOnAddRemove:!0,controlsAboveOverlay:!1,allowTouchScrolling:!1,imageSmoothingEnabled:!0,viewportTransform:x.iMatrix.concat(),backgroundVpt:!0,overlayVpt:!0,enableRetinaScaling:!0,vptCoords:{},skipOffscreen:!0,clipPath:void 0,_initStatic:_isRetinaScaling:getRetinaScaling:_initRetinaScaling:__initRetinaScaling:calcOffset:setOverlayImage:function(e,t,i){return this.__setBgOverlayImage("overlayImage",e,t,i)},setBackgroundImage:setOverlayColor:function(e,t){return this.__setBgOverlayColor("overlayColor",e,t)},setBackgroundColor:__setBgOverlayImage:function(e,t,i,r){return"string"==typeof t?x.util.loadImage(t,(,this,r&&r.crossOrigin):(r&&t.setOptions(r),this[e]=t,t&&(t.canvas=this),i&&i(t,!1)),this},__setBgOverlayColor:_createCanvasElement:_initOptions:_createLowerCanvas:getWidth:function(){return this.width},getHeight:function(){return this.height},setWidth:function(e,t){return this.setDimensions({width:e},t)},setHeight:setDimensions:_setBackstoreDimension:_setCssDimension:getZoom:setViewportTransform:zoomToPoint:setZoom:absolutePan:relativePan:getElement:function(){return this.lowerCanvasEl},_onObjectAdded:_onObjectRemoved:clearContext:getContext:function(){return this.contextContainer},clear:renderAll:renderAndReset:requestRenderAll:calcViewportBoundaries:cancelRequestedRender:renderCanvas:drawClipPathOnCanvas:_renderObjects:_renderBackgroundOrOverlay:_renderBackground:function(e){this._renderBackgroundOrOverlay(e,"background")},_renderOverlay:getCenter:getCenterPoint:centerObjectH:centerObjectV:centerObject:function(e){var t=this.getCenterPoint();return this._centerObject(e,t)},viewportCenterObject:viewportCenterObjectH:viewportCenterObjectV:getVpCenter:_centerObject:toDatalessJSON:function(e){return this.toDatalessObject(e)},toObject:function(e){return this._toObjectMethod("toObject",e)},toDatalessObject:_toObjectMethod:_toObjects:_toObject:__serializeBgOverlay:svgViewportTransformation:!0,toSVG:_setSVGPreamble:_setSVGHeader:createSVGClipPathMarkup:createSVGRefElementsMarkup:createSVGFontFacesMarkup:_setSVGObjects:_setSVGObject:_setSVGBgOverlayImage:_setSVGBgOverlayColor:sendToBack:bringToFront:sendBackwards:_findNewLowerIndex:function(e,t,i){var r,n;if(i){for(r=t,n=t-1;n>=0;--n)if(e.intersectsWithObject(this._objects[n])||e.isContainedWithinObject(this._objects[n])||this._objects[n].isContainedWithinObject(e)){r=n;break}}else r=t-1;return r},bringForward:_findNewUpperIndex:function(e,t,i){var r,n,s;if(i){for(r=t,n=t+1,s=this._objects.length;n<s;++n)if(e.intersectsWithObject(this._objects[n])||e.isContainedWithinObject(this._objects[n])||this._objects[n].isContainedWithinObject(e)){r=n;break}}else r=t+1;return r},moveTo:dispose:toString:),e(x.StaticCanvas.prototype,x.Observable),e(x.StaticCanvas.prototype,x.Collection),e(x.StaticCanvas.prototype,x.DataURLExporter),e(x.StaticCanvas,{EMPTY_JSON:'{"objects": [], "background": "white"}',supports:function(e){var t=a();if(!t||!t.getContext)return null;var i=t.getContext("2d");return i&&"setLineDash"===e?void 0!==i.setLineDash:null}}),x.StaticCanvas.prototype.toJSON=x.StaticCanvas.prototype.toObject,x.isLikelyNode&&(x.StaticCanvas.prototype.createPNGStream=x.StaticCanvas.prototype.createJPEGStream=}}(),x.BaseBrush=x.util.createClass({color:"rgb(0, 0, 0)",width:1,shadow:null,strokeLineCap:"round",strokeLineJoin:"round",strokeMiterLimit:10,strokeDashArray:null,limitedToCanvasSize:!1,_setBrushStyles:_saveAndTransform:_setShadow:needsFullRender:_resetShadow:_isOutSideCanvas:),x.PencilBrush=x.util.createClass(x.BaseBrush,{decimate:.4,drawStraightLine:!1,straightLineKey:"shiftKey",initialize:function(e){this.canvas=e,this._points=[]},needsFullRender:_drawSegment:onMouseDown:onMouseMove:onMouseUp:_prepareForDrawing:_addPoint:function(e){return!(this._points.length>1&&e.eq(this._points[this._points.length-1])||(this.drawStraightLine&&this._points.length>1&&(this._hasStraightLine=!0,this._points.pop()),this._points.push(e),0))},_reset:_captureDrawingPath:_render:convertPointsToSVGPath:_isEmptySVGPath:createPath:decimatePoints:function(e,t){if(e.length<=2)return e;var i,r=this.canvas.getZoom(),n=Math.pow(t/r,2),s=e.length-1,o=e[0],a=[o];for(i=1;i<s-1;i++)Math.pow(o.x-e[i].x,2)+Math.pow(o.y-e[i].y,2)>=n&&(o=e[i],a.push(o));return a.push(e[s]),a},_finalizeAndAddPath:function(){this.canvas.contextTop.closePath(),this.decimate&&(this._points=this.decimatePoints(this._points,this.decimate));var e=this.convertPointsToSVGPath(this._points);if(this._isEmptySVGPath(e))this.canvas.requestRenderAll();else{var t=this.createPath(e);this.canvas.clearContext(this.canvas.contextTop),this.canvas.fire("before:path:created",{path:t}),this.canvas.add(t),this.canvas.requestRenderAll(),t.setCoords(),this._resetShadow(),this.canvas.fire("path:created",{path:t})}}}),x.CircleBrush=x.util.createClass(x.BaseBrush,{width:10,initialize:function(e){this.canvas=e,this.points=[]},drawDot:dot:onMouseDown:_render:onMouseMove:onMouseUp:addPoint:),x.SprayBrush=x.util.createClass(x.BaseBrush,{width:10,density:20,dotWidth:1,dotWidthVariance:1,randomOpacity:!1,optimizeOverlapping:!0,initialize:onMouseDown:onMouseMove:onMouseUp:_getOptimizedRects:render:_render:addSprayChunk:),x.PatternBrush=x.util.createClass(x.PencilBrush,{getPatternSrc:getPatternSrcFunction:getPattern:_setBrushStyles:createPath:),function(){var e=x.util.getPointer,t=x.util.degreesToRadians,i=x.util.isTouchEvent;for(var r in x.Canvas=x.util.createClass(x.StaticCanvas,{initialize:uniformScaling:!0,uniScaleKey:"shiftKey",centeredScaling:!1,centeredRotation:!1,centeredKey:"altKey",altActionKey:"shiftKey",interactive:!0,selection:!0,selectionKey:"shiftKey",altSelectionKey:null,selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,selectionFullyContained:!1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",notAllowedCursor:"not-allowed",containerClass:"canvas-container",perPixelTargetFind:!1,targetFindTolerance:0,skipTargetFind:!1,isDrawingMode:!1,preserveObjectStacking:!1,snapAngle:0,snapThreshold:null,stopContextMenu:!1,fireRightClick:!1,fireMiddleClick:!1,targets:[],enablePointerEvents:!1,_hoveredTarget:null,_hoveredTargets:[],_initInteractive:_chooseObjectsToRender:renderAll:renderTopLayer:renderTop:_normalizePointer:isTargetTransparent:function(e,t,i){if(e.shouldCache()&&e._cacheCanvas&&e!==this._activeObject){var r=this._normalizePointer(e,{x:t,y:i}),n=Math.max(e.cacheTranslationX+r.x*e.zoomX,0),s=Math.max(e.cacheTranslationY+r.y*e.zoomY,0);return x.util.isTransparent(e._cacheContext,Math.round(n),Math.round(s),this.targetFindTolerance)}var o=this.contextCache,a=e.selectionBackgroundColor,h=this.viewportTransform;return e.selectionBackgroundColor="",this.clearContext(o),o.save(),o.transform(h[0],h[1],h[2],h[3],h[4],h[5]),e.render(o),o.restore(),e.selectionBackgroundColor=a,x.util.isTransparent(o,t,i,this.targetFindTolerance)},_isSelectionKeyPressed:function(e){return Array.isArray(this.selectionKey)?!!this.selectionKey.find(():e[this.selectionKey]},_shouldClearSelection:_shouldCenterTransform:_getOriginFromCorner:_getActionFromCorner:_setupCurrentTransform:setCursor:_drawSelection:findTarget:function(e,t){if(!this.skipTargetFind){var r,n,s=this.getPointer(e,!0),o=this._activeObject,a=this.getActiveObjects(),h=i(e),l=a.length>1&&!t||1===a.length;if(this.targets=[],l&&o._findTargetCorner(s,h))return o;if(a.length>1&&!t&&o===this._searchPossibleTargets([o],s))return o;if(1===a.length&&o===this._searchPossibleTargets([o],s)){if(!this.preserveObjectStacking)return o;r=o,n=this.targets,this.targets=[]}var c=this._searchPossibleTargets(this._objects,s);return e[this.altSelectionKey]&&c&&r&&c!==r&&(c=r,this.targets=n),c}},_checkTarget:function(e,t,i){if(t&&t.visible&&t.evented&&t.containsPoint(e)){if(!this.perPixelTargetFind&&!t.perPixelTargetFind||t.isEditing)return!0;if(!this.isTargetTransparent(t,i.x,i.y))return!0}},_searchPossibleTargets:restorePointerVpt:getPointer:_createUpperCanvas:getTopContext:function(){return this.contextTop},_createCacheCanvas:_initWrapperElement:_applyCanvasStyle:_copyCanvasStyle:getSelectionContext:function(){return this.contextTop},getSelectionElement:function(){return this.upperCanvasEl},getActiveObject:function(){return this._activeObject},getActiveObjects:_onObjectRemoved:_fireSelectionEvents:setActiveObject:_setActiveObject:function(e,t){return this._activeObject!==e&&!!this._discardActiveObject(t,e)&&!e.onSelect({e:t})&&(this._activeObject=e,!0)},_discardActiveObject:discardActiveObject:dispose:clear:drawControls:_toObject:_realizeGroupTransformOnObject:_unwindGroupTransformOnObject:_setSVGObject:setViewportTransform:),x.StaticCanvas)"prototype"!==r&&(x.Canvas[r]=x.StaticCanvas[r])}(),function(){var e=x.util.addListener,t=x.util.removeListener,i={passive:!1};.util.object.extend(x.Canvas.prototype,{mainTouchId:null,_initEventListeners:_getEventPrefix:addOrRemove:removeListeners:_bindEvents:_onGesture:function(e,t){this.__onTransformGesture&&this.__onTransformGesture(e,t)},_onDrag:function(e,t){this.__onDrag&&this.__onDrag(e,t)},_onMouseWheel:_onMouseOut:_onMouseEnter:_onOrientationChange:function(e,t){this.__onOrientationChange&&this.__onOrientationChange(e,t)},_onShake:function(e,t){this.__onShake&&this.__onShake(e,t)},_onLongPress:_onDragOver:_onDrop:_onContextMenu:_onDoubleClick:getPointerId:_isMainEvent:function(e){return!0===e.isPrimary||!1!==e.isPrimary&&("touchend"===e.type&&0===e.touches.length||!e.changedTouches||e.changedTouches[0].identifier===this.mainTouchId)},_onTouchStart:_onMouseDown:_onTouchEnd:_onMouseUp:_onMouseMove:_onResize:_shouldRender:__onMouseUp:function(e){var t,i=this._currentTransform,n=this._groupSelector,s=!1,o=!n||0===n.left&&0===n.top;if(this._cacheTransformEventData(e),t=this._target,this._handleEvent(e,"up:before"),r(e,3))this.fireRightClick&&this._handleEvent(e,"up",3,o);else{if(r(e,2))return this.fireMiddleClick&&this._handleEvent(e,"up",2,o),void this._resetTransformEventData();if(this.isDrawingMode&&this._isCurrentlyDrawing)this._onMouseUpInDrawingMode(e);else if(this._isMainEvent(e)){if(i&&(this._finalizeCurrentTransform(e),s=i.actionPerformed),!o){var a=t===this._activeObject;this._maybeGroupObjects(e),s||(s=this._shouldRender(t)||!a&&t===this._activeObject)}var h,l;if(t){if(h=t._findTargetCorner(this.getPointer(e,!0),x.util.isTouchEvent(e)),t.selectable&&t!==this._activeObject&&"up"===t.activeOn)this.setActiveObject(t,e),s=!0;else{var c=t.controls[h],u=c&&c.getMouseUpHandler(e,t,c);u&&u(e,i,(l=this.getPointer(e)).x,l.y)}t.isMoving=!1}if(i&&(i.target!==t||i.corner!==h)){var d=i.target&&i.target.controls[i.corner],f=d&&d.getMouseUpHandler(e,t,c);l=l||this.getPointer(e),f&&f(e,i,l.x,l.y)}this._setCursorFromEvent(e,t),this._handleEvent(e,"up",1,o),this._groupSelector=null,this._currentTransform=null,t&&(t.__corner=0),s?this.requestRenderAll():o||this.renderTop()}}},_simpleEventHandler:_handleEvent:_finalizeCurrentTransform:_onMouseDownInDrawingMode:_onMouseMoveInDrawingMode:_onMouseUpInDrawingMode:__onMouseDown:function(e){this._cacheTransformEventData(e),this._handleEvent(e,"down:before");var t=this._target;if(r(e,3))this.fireRightClick&&this._handleEvent(e,"down",3);else if(r(e,2))this.fireMiddleClick&&this._handleEvent(e,"down",2);else if(this.isDrawingMode)this._onMouseDownInDrawingMode(e);else if(this._isMainEvent(e)&&!this._currentTransform){var i=this._pointer;this._previousPointer=i;var n=this._shouldRender(t),s=this._shouldGroup(e,t);if(this._shouldClearSelection(e,t)?this.discardActiveObject(e):s&&(this._handleGrouping(e,t),t=this._activeObject),!this.selection||t&&(t.selectable||t.isEditing||t===this._activeObject)||(this._groupSelector={ex:this._absolutePointer.x,ey:this._absolutePointer.y,top:0,left:0}),t){var o=t===this._activeObject;t.selectable&&"down"===t.activeOn&&this.setActiveObject(t,e);var a=t._findTargetCorner(this.getPointer(e,!0),x.util.isTouchEvent(e));if(t.__corner=a,t===this._activeObject&&(a||!s)){this._setupCurrentTransform(e,t,o);var h=t.controls[a],l=(i=this.getPointer(e),h&&h.getMouseDownHandler(e,t,h));l&&l(e,this._currentTransform,i.x,i.y)}}this._handleEvent(e,"down"),(n||s)&&this.requestRenderAll()}},_resetTransformEventData:_cacheTransformEventData:_beforeTransform:__onMouseMove:_fireOverOutEvents:_fireEnterLeaveEvents:fireSyntheticInOutEvents:__onMouseWheel:_transformObject:_performTransformAction:_fire:x.controlsUtils.fireEvent,_setCursorFromEvent:getCornerCursor:)}(),v=Math.min,y=Math.max,x.util.object.extend(x.Canvas.prototype,{_shouldGroup:_handleGrouping:_updateActiveSelection:_createActiveSelection:_createGroup:_groupSelectedObjects:_collectObjects:function(e){for(var t,i=[],r=this._groupSelector.ex,n=this._groupSelector.ey,s=r+this._groupSelector.left,o=n+this._groupSelector.top,a=new x.Point(v(r,s),v(n,o)),h=new x.Point(y(r,s),y(n,o)),l=!this.selectionFullyContained,c=r===s&&n===o,u=this._objects.length;u--&&!((t=this._objects[u])&&t.selectable&&t.visible&&(l&&t.intersectsWithRect(a,h,!0)||t.isContainedWithinRect(a,h,!0)||l&&t.containsPoint(a,null,!0)||l&&t.containsPoint(h,null,!0))&&(i.push(t),c)););return i.length>1&&(i=i.filter(()),i},_maybeGroupObjects:),x.util.object.extend(x.StaticCanvas.prototype,{toDataURL:toCanvasElement:),x.util.object.extend(x.StaticCanvas.prototype,{loadFromJSON:__setupCanvas:_setBgOverlay:__setBgOverlay:_enlivenObjects:_toDataURL:_toDataURLWithMultiplier:clone:cloneWithoutData:),function(e){var t=e.fabric||(e.fabric={}),i=t.util.object.extend,r=t.util.object.clone,n=t.util.toFixed,s=t.util.string.capitalize,o=t.util.degreesToRadians,a=!t.isLikelyNode;t.Object||(t.Object=t.util.createClass(t.CommonMethods,{type:"object",originX:"left",originY:"top",top:0,left:0,width:0,height:0,scaleX:1,scaleY:1,flipX:!1,flipY:!1,opacity:1,angle:0,skewX:0,skewY:0,cornerSize:13,touchCornerSize:24,transparentCorners:!0,hoverCursor:null,moveCursor:null,padding:0,borderColor:"rgb(178,204,255)",borderDashArray:null,cornerColor:"rgb(178,204,255)",cornerStrokeColor:null,cornerStyle:"rect",cornerDashArray:null,centeredScaling:!1,centeredRotation:!0,fill:"rgb(0,0,0)",fillRule:"nonzero",globalCompositeOperation:"source-over",backgroundColor:"",selectionBackgroundColor:"",stroke:null,strokeWidth:1,strokeDashArray:null,strokeDashOffset:0,strokeLineCap:"butt",strokeLineJoin:"miter",strokeMiterLimit:4,shadow:null,borderOpacityWhenMoving:.4,borderScaleFactor:1,minScaleLimit:0,selectable:!0,evented:!0,visible:!0,hasControls:!0,hasBorders:!0,perPixelTargetFind:!1,includeDefaultValues:!0,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,lockSkewingX:!1,lockSkewingY:!1,lockScalingFlip:!1,excludeFromExport:!1,objectCaching:a,statefullCache:!1,noScaleCache:!0,strokeUniform:!1,dirty:!0,__corner:0,paintFirst:"fill",activeOn:"down",stateProperties:"top left width height scaleX scaleY flipX flipY originX originY transformMatrix stroke strokeWidth strokeDashArray strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit angle opacity fill globalCompositeOperation shadow visible backgroundColor skewX skewY fillRule paintFirst clipPath strokeUniform".split(" "),cacheProperties:"fill stroke strokeWidth strokeDashArray width height paintFirst strokeUniform strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit backgroundColor clipPath".split(" "),colorProperties:"fill stroke backgroundColor".split(" "),clipPath:void 0,inverted:!1,absolutePositioned:!1,initialize:function(e){e&&this.setOptions(e)},_createCacheCanvas:_limitCacheSize:_getCacheCanvasDimensions:_updateCacheCanvas:function(){var e=this.canvas;if(this.noScaleCache&&e&&e._currentTransform){var i=e._currentTransform.target,r=e._currentTransform.action;if(this===i&&r.slice&&"scale"===r.slice(0,5))return!1}var n,s,o=this._cacheCanvas,a=this._limitCacheSize(this._getCacheCanvasDimensions()),h=t.minCacheSideLimit,l=a.width,c=a.height,u=a.zoomX,d=a.zoomY,f=l!==this.cacheWidth||c!==this.cacheHeight,g=this.zoomX!==u||this.zoomY!==d,_=f||g,p=0,m=0,v=!1;if(f){var y=this._cacheCanvas.width,S=this._cacheCanvas.height,w=l>y||c>S;v=w||(l<.9*y||c<.9*S)&&y>h&&S>h,w&&!a.capped&&(l>h||c>h)&&(p=.1*l,m=.1*c)}return this instanceof t.Text&&this.path&&(_=!0,v=!0,p+=this.getHeightOfLine(0)*this.zoomX,m+=this.getHeightOfLine(0)*this.zoomY),!!_&&(v?(o.width=Math.ceil(l+p),o.height=Math.ceil(c+m)):(this._cacheContext.setTransform(1,0,0,1,0,0),this._cacheContext.clearRect(0,0,o.width,o.height)),n=a.x/2,s=a.y/2,this.cacheTranslationX=Math.round(o.width/2-n)+n,this.cacheTranslationY=Math.round(o.height/2-s)+s,this.cacheWidth=l,this.cacheHeight=c,this._cacheContext.translate(this.cacheTranslationX,this.cacheTranslationY),this._cacheContext.scale(u,d),this.zoomX=u,this.zoomY=d,!0)},setOptions:transform:toObject:toDatalessObject:function(e){return this.toObject(e)},_removeDefaultValues:function(e){var i=t.util.getKlass(e.type).prototype;return i.stateProperties.forEach((),e},toString:getObjectScaling:getTotalObjectScaling:getObjectOpacity:_set:setOnGroup:function(){},getViewportTransform:isNotVisible:render:renderCache:_removeCacheCanvas:hasStroke:hasFill:needsItsOwnCache:function(){return!("stroke"!==this.paintFirst||!this.hasFill()||!this.hasStroke()||"object"!=typeof this.shadow)||!!this.clipPath},shouldCache:willDrawShadow:drawClipPathOnCache:drawObject:_drawClipPath:drawCacheOnCanvas:isCacheDirty:_renderBackground:_setOpacity:_setStrokeStyles:_setFillStyles:_setClippingProperties:_setLineDash:_renderControls:function(e,i){var r,n,s,a=this.getViewportTransform(),h=this.calcTransformMatrix();n=void 0!==(i=i||{}).hasBorders?i.hasBorders:this.hasBorders,s=void 0!==i.hasControls?i.hasControls:this.hasControls,h=t.util.multiplyTransformMatrices(a,h),r=t.util.qrDecompose(h),e.save(),e.translate(r.translateX,r.translateY),e.lineWidth=1*this.borderScaleFactor,this.group||(e.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1),this.flipX&&(r.angle-=180),e.rotate(o(this.group?r.angle:this.angle)),i.forActiveSelection||this.group?n&&this.drawBordersInGroup(e,r,i):n&&this.drawBorders(e,i),s&&this.drawControls(e,i),e.restore()},_setShadow:_removeShadow:_applyPatternGradientTransform:_renderPaintInOrder:function(e){"stroke"===this.paintFirst?(this._renderStroke(e),this._renderFill(e)):(this._renderFill(e),this._renderStroke(e))},_render:function(){},_renderFill:_renderStroke:_applyPatternForTransformedGradient:_findCenterFromElement:_assignTransformMatrixProps:_removeTransformMatrix:clone:cloneAsImage:toCanvasElement:toDataURL:isType:complexity:function(){return 1},toJSON:function(e){return this.toObject(e)},rotate:centerH:function(){return this.canvas&&this.canvas.centerObjectH(this),this},viewportCenterH:function(){return this.canvas&&this.canvas.viewportCenterObjectH(this),this},centerV:function(){return this.canvas&&this.canvas.centerObjectV(this),this},viewportCenterV:function(){return this.canvas&&this.canvas.viewportCenterObjectV(this),this},center:function(){return this.canvas&&this.canvas.centerObject(this),this},viewportCenter:getLocalPointer:_setupCompositeOperation:dispose:),t.util.createAccessors&&t.util.createAccessors(t.Object),i(t.Object.prototype,t.Observable),t.Object.NUM_FRACTION_DIGITS=2,t.Object.ENLIVEN_PROPS=["clipPath"],t.Object._fromObject=function(e,i,n,s){var o=t[e];i=r(i,!0),t.util.enlivenPatterns([i.fill,i.stroke],(function(e){void 0!==e[0]&&(i.fill=e[0]),void 0!==e[1]&&(i.stroke=e[1]),t.util.enlivenObjectEnlivables(i,i,()}))},t.Object.__uid=0)}(t),S=x.util.degreesToRadians,w={left:-.5,center:0,right:.5},C={top:-.5,center:0,bottom:.5},x.util.object.extend(x.Object.prototype,{translateToGivenOrigin:translateToCenterPoint:translateToOriginPoint:getCenterPoint:getPointByOrigin:toLocalPoint:setPositionByOrigin:adjustPosition:_setOriginToCenter:_resetOrigin:_getLeftTopCoords:),function(){var e=x.util,t=e.degreesToRadians,i=e.multiplyTransformMatrices,r=e.transformPoint;e.object.extend(x.Object.prototype,{oCoords:null,aCoords:null,lineCoords:null,ownMatrixCache:null,matrixCache:null,controls:{},_getCoords:getCoords:function(e,t){return i=this._getCoords(e,t),[new x.Point(i.tl.x,i.tl.y),new x.Point(i.tr.x,i.tr.y),new x.Point(i.br.x,i.br.y),new x.Point(i.bl.x,i.bl.y)];var i},intersectsWithRect:intersectsWithObject:isContainedWithinObject:isContainedWithinRect:containsPoint:function(e,t,i,r){var n=this._getCoords(i,r),s=(t=t||this._getImageLines(n),this._findCrossPoints(e,t));return 0!==s&&s%2==1},isOnScreen:function(e){if(!this.canvas)return!1;var t=this.canvas.vptCoords.tl,i=this.canvas.vptCoords.br;return!!this.getCoords(!0,e).some(()||!!this.intersectsWithRect(t,i,!0,e)||this._containsCenterOfCanvas(t,i,e)},_containsCenterOfCanvas:isPartiallyOnScreen:_getImageLines:_findCrossPoints:function(e,t){var i,r,n,s=0;for(var o in t)if(!((n=t[o]).o.y<e.y&&n.d.y<e.y||n.o.y>=e.y&&n.d.y>=e.y||(n.o.x===n.d.x&&n.o.x>=e.x?r=n.o.x:(i=(n.d.y-n.o.y)/(n.d.x-n.o.x),r=-(e.y-0*e.x-(n.o.y-i*n.o.x))/(0-i)),r>=e.x&&(s+=1),2!==s)))break;return s},getBoundingRect:getScaledWidth:function(){return this._getTransformedDimensions().x},getScaledHeight:_constrainScale:scale:scaleToWidth:function(e,t){var i=this.getBoundingRect(t).width/this.getScaledWidth();return this.scale(e/this.width/i)},scaleToHeight:calcLineCoords:calcOCoords:calcACoords:setCoords:_calcRotateMatrix:_calcTranslateMatrix:transformMatrixKey:calcTransformMatrix:calcOwnMatrix:_getNonTransformedDimensions:_getTransformedDimensions:function(t,i){void 0===t&&(t=this.skewX),void 0===i&&(i=this.skewY);var r,n,s,o=0===t&&0===i;if(this.strokeUniform?(n=this.width,s=this.height):(n=(r=this._getNonTransformedDimensions()).x,s=r.y),o)return this._finalizeDimensions(n*this.scaleX,s*this.scaleY);var a=e.sizeAfterTransform(n,s,{scaleX:this.scaleX,scaleY:this.scaleY,skewX:t,skewY:i});return this._finalizeDimensions(a.x,a.y)},_finalizeDimensions:_calculateCurrentDimensions:)}(),x.util.object.extend(x.Object.prototype,{sendToBack:function(){return this.group?x.StaticCanvas.prototype.sendToBack.call(this.group,this):this.canvas&&this.canvas.sendToBack(this),this},bringToFront:sendBackwards:function(e){return this.group?x.StaticCanvas.prototype.sendBackwards.call(this.group,this,e):this.canvas&&this.canvas.sendBackwards(this,e),this},bringForward:moveTo:),function(){ar t=x.util.toFixed;x.util.object.extend(x.Object.prototype,{getSvgStyles:getSvgSpanStyles:function(t,i){var r="; ",n=t.fontFamily?"font-family: "+(-1===t.fontFamily.indexOf("'")&&-1===t.fontFamily.indexOf('"')?"'"+t.fontFamily+"'":t.fontFamily)+r:"",s=t.strokeWidth?"stroke-width: "+t.strokeWidth+r:"",o=t.fontSize?"font-size: "+t.fontSize+"px"+r:"",a=t.fontStyle?"font-style: "+t.fontStyle+r:"",h=t.fontWeight?"font-weight: "+t.fontWeight+r:"",l=t.fill?e("fill",t.fill):"",c=t.stroke?e("stroke",t.stroke):"",u=this.getSvgTextDecoration(t);return u&&(u="text-decoration: "+u+r),[c,s,n,o,a,h,u,l,t.deltaY?"baseline-shift: "+-t.deltaY+"; ":"",i?"white-space: pre; ":""].join("")},getSvgTextDecoration:getSvgFilter:getSvgCommons:getSvgTransform:function(e,t){var i=e?this.calcTransformMatrix():this.calcOwnMatrix();return'transform="'+x.util.matrixToSVG(i)+(t||"")+'" '},_setSVGBg:toSVG:toClipPathSVG:_createBaseClipPathSVGMarkup:_createBaseSVGMarkup:addPaintOrder:)}(),function(){var e=x.util.object.extend,t="stateProperties";unction r(e,t,i){if(e===t)return!0;if(Array.isArray(e)){if(!Array.isArray(t)||e.length!==t.length)return!1;for(var n=0,s=e.length;n<s;n++)if(!r(e[n],t[n]))return!1;return!0}if(e&&"object"==typeof e){var o,a=Object.keys(e);if(!t||"object"!=typeof t||!i&&a.length!==Object.keys(t).length)return!1;for(n=0,s=a.length;n<s;n++)if("canvas"!==(o=a[n])&&"group"!==o&&!r(e[o],t[o]))return!1;return!0}}x.util.object.extend(x.Object.prototype,{hasStateChanged:saveState:setupState:)}(),function(){var e=x.util.degreesToRadians;x.util.object.extend(x.Object.prototype,{_findTargetCorner:function(e,t){if(!this.hasControls||this.group||!this.canvas||this.canvas._activeObject!==this)return!1;var i,r,n,s=e.x,o=e.y,a=Object.keys(this.oCoords),h=a.length-1;for(this.__corner=0;h>=0;h--)if(n=a[h],this.isControlVisible(n)&&(r=this._getImageLines(t?this.oCoords[n].touchCorner:this.oCoords[n].corner),0!==(i=this._findCrossPoints({x:s,y:o},r))&&i%2==1))return this.__corner=n,n;return!1},forEachControl:_setCornerCoords:drawSelectionBackground:drawBorders:function(e,t){t=t||{};var i=this._calculateCurrentDimensions(),r=this.borderScaleFactor,n=i.x+r,s=i.y+r,o=void 0!==t.hasControls?t.hasControls:this.hasControls,a=!1;return e.save(),e.strokeStyle=t.borderColor||this.borderColor,this._setLineDash(e,t.borderDashArray||this.borderDashArray),e.strokeRect(-n/2,-s/2,n,s),o&&(e.beginPath(),this.forEachControl((),a&&e.stroke()),e.restore(),this},drawBordersInGroup:drawControls:isControlVisible:setControlVisible:setControlsVisibility:onDeselect:function(){},onSelect:function(){}})}(),x.util.object.extend(x.StaticCanvas.prototype,{FX_DURATION:500,fxCenterObjectH:function(e,t){var i=function(){},r=(t=t||{}).onComplete||i,n=t.onChange||i,s=this;return x.util.animate({target:this,startValue:e.left,endValue:this.getCenterPoint().x,duration:this.FX_DURATION,onChange:function(t){e.set("left",t),s.requestRenderAll(),n()},onComplete:function(){e.setCoords(),r()}})},fxCenterObjectV:function(e,t){var i=function(){},r=(t=t||{}).onComplete||i,n=t.onChange||i,s=this;return x.util.animate({target:this,startValue:e.top,endValue:this.getCenterPoint().y,duration:this.FX_DURATION,onChange:function(t){e.set("top",t),s.requestRenderAll(),n()},onComplete:function(){e.setCoords(),r()}})},fxRemove:function(e,t){var i=function(){},r=(t=t||{}).onComplete||i,n=t.onChange||i,s=this;return x.util.animate({target:this,startValue:e.opacity,endValue:0,duration:this.FX_DURATION,onChange:onComplete:)}}),x.util.object.extend(x.Object.prototype,{animate:function(){if(arguments[0]&&"object"==typeof arguments[0]){var e,t,i=[],r=[];for(e in arguments[0])i.push(e);for(var n=0,s=i.length;n<s;n++)e=i[n],t=n!==s-1,r.push(this._animate(e,arguments[0][e],arguments[1],t));return r}return this._animate.apply(this,arguments)},_animate:),function(e){var t=e.fabric||(e.fabric={}),i=t.util.object.extend,r=t.util.object.clone,n={x1:1,x2:1,y1:1,y2:1};.Line?t.warn("fabric.Line is already defined"):(t.Line=t.util.createClass(t.Object,{type:"line",x1:0,y1:0,x2:0,y2:0,cacheProperties:t.Object.prototype.cacheProperties.concat("x1","x2","y1","y2"),initialize:_setWidthHeight:_set:_getLeftToOriginX:s({origin:"originX",axis1:"x1",axis2:"x2",dimension:"width"},{nearest:"left",center:"center",farthest:"right"}),_getTopToOriginY:s({origin:"originY",axis1:"y1",axis2:"y2",dimension:"height"},{nearest:"top",center:"center",farthest:"bottom"}),_render:_findCenterFromElement:toObject:_getNonTransformedDimensions:calcLinePoints:_toSVG:),t.Line.ATTRIBUTE_NAMES=t.SHARED_ATTRIBUTES.concat("x1 y1 x2 y2".split(" ")),t.Line.fromElement=t.Line.fromObject=}(t),function(e){var t=e.fabric||(e.fabric={}),i=t.util.degreesToRadians;t.Circle?t.warn("fabric.Circle is already defined."):(t.Circle=t.util.createClass(t.Object,{type:"circle",radius:0,startAngle:0,endAngle:360,cacheProperties:t.Object.prototype.cacheProperties.concat("radius","startAngle","endAngle"),_set:toObject:_toSVG:function(){var e,r=(this.endAngle-this.startAngle)%360;if(0===r)e=["<circle ","COMMON_PARTS",'cx="0" cy="0" ','r="',this.radius,'" />\n'];else{var n=i(this.startAngle),s=i(this.endAngle),o=this.radius;e=['<path d="M '+t.util.cos(n)*o+" "+t.util.sin(n)*o," A "+o+" "+o," 0 ",+(r>180?"1":"0")+" 1"," "+t.util.cos(s)*o+" "+t.util.sin(s)*o,'" ',"COMMON_PARTS"," />\n"]}return e},_render:getRadiusX:function(){return this.get("radius")*this.get("scaleX")},getRadiusY:function(){return this.get("radius")*this.get("scaleY")},setRadius:),t.Circle.ATTRIBUTE_NAMES=t.SHARED_ATTRIBUTES.concat("cx cy r".split(" ")),t.Circle.fromElement=t.Circle.fromObject=function(e,i){t.Object._fromObject("Circle",e,i)})}(t),function(e){var t=e.fabric||(e.fabric={});t.Triangle?t.warn("fabric.Triangle is already defined"):(t.Triangle=t.util.createClass(t.Object,{type:"triangle",width:100,height:100,_render:_toSVG:),t.Triangle.fromObject=function(e,i){return t.Object._fromObject("Triangle",e,i)})}(t),function(e){var t=e.fabric||(e.fabric={}),i=2*Math.PI;t.Ellipse?t.warn("fabric.Ellipse is already defined."):(t.Ellipse=t.util.createClass(t.Object,{type:"ellipse",rx:0,ry:0,cacheProperties:t.Object.prototype.cacheProperties.concat("rx","ry"),initialize:_set:getRx:function(){return this.get("rx")*this.get("scaleX")},getRy:toObject:function(e){return this.callSuper("toObject",["rx","ry"].concat(e))},_toSVG:_render:),t.Ellipse.ATTRIBUTE_NAMES=t.SHARED_ATTRIBUTES.concat("cx cy rx ry".split(" ")),t.Ellipse.fromElement=t.Ellipse.fromObject=}(t),function(e){var t=e.fabric||(e.fabric={}),i=t.util.object.extend;t.Rect?t.warn("fabric.Rect is already defined"):(t.Rect=t.util.createClass(t.Object,{stateProperties:t.Object.prototype.stateProperties.concat("rx","ry"),type:"rect",rx:0,ry:0,cacheProperties:t.Object.prototype.cacheProperties.concat("rx","ry"),initialize:_initRxRy:_render:toObject:function(e){return this.callSuper("toObject",["rx","ry"].concat(e))},_toSVG:),t.Rect.ATTRIBUTE_NAMES=t.SHARED_ATTRIBUTES.concat("x y rx ry width height".split(" ")),t.Rect.fromElement=t.Rect.fromObject=}(t),function(e){var t=e.fabric||(e.fabric={}),i=t.util.object.extend,r=t.util.array.min,n=t.util.array.max,s=t.util.toFixed,o=t.util.projectStrokeOnPoints;t.Polyline?t.warn("fabric.Polyline is already defined"):(t.Polyline=t.util.createClass(t.Object,{type:"polyline",points:null,exactBoundingBox:!1,cacheProperties:t.Object.prototype.cacheProperties.concat("points"),initialize:_projectStrokeOnPoints:_setPositionDimensions:function(e){var t,i=this._calcDimensions(e),r=this.exactBoundingBox?this.strokeWidth:0;this.width=i.width-r,this.height=i.height-r,e.fromSVG||(t=this.translateToGivenOrigin({x:i.left-this.strokeWidth/2+r/2,y:i.top-this.strokeWidth/2+r/2},"left","top",this.originX,this.originY)),void 0===e.left&&(this.left=e.fromSVG?i.left:t.x),void 0===e.top&&(this.top=e.fromSVG?i.top:t.y),this.pathOffset={x:i.left+this.width/2+r/2,y:i.top+this.height/2+r/2}},_calcDimensions:function(){var e=this.exactBoundingBox?this._projectStrokeOnPoints():this.points,t=r(e,"x")||0,i=r(e,"y")||0;return{left:t,top:i,width:(n(e,"x")||0)-t,height:(n(e,"y")||0)-i}},toObject:_toSVG:commonRender:_render:complexity:),t.Polyline.ATTRIBUTE_NAMES=t.SHARED_ATTRIBUTES.concat(),t.Polyline.fromElementGenerator=t.Polyline.fromElement=t.Polyline.fromElementGenerator("Polyline"),t.Polyline.fromObject=function(e,i){return t.Object._fromObject("Polyline",e,i,"points")})}(t),function(e){var t=e.fabric||(e.fabric={}),i=t.util.projectStrokeOnPoints;t.Polygon?t.warn("fabric.Polygon is already defined"):(t.Polygon=t.util.createClass(t.Polyline,{type:"polygon",_projectStrokeOnPoints:_render:),t.Polygon.ATTRIBUTE_NAMES=t.SHARED_ATTRIBUTES.concat(),t.Polygon.fromElement=t.Polyline.fromElementGenerator("Polygon"),t.Polygon.fromObject=}(t),function(e){var t=e.fabric||(e.fabric={}),i=t.util.array.min,r=t.util.array.max,n=t.util.object.extend,s=t.util.object.clone,o=t.util.toFixed;t.Path?t.warn("fabric.Path is already defined"):(t.Path=t.util.createClass(t.Object,{type:"path",path:null,cacheProperties:t.Object.prototype.cacheProperties.concat("path","fillRule"),stateProperties:t.Object.prototype.stateProperties.concat("path"),initialize:_setPath:_renderPathCommands:_render:toString:function(){return"#<fabric.Path ("+this.complexity()+'): { "top": '+this.top+', "left": '+this.left+" }>"},toObject:toDatalessObject:_toSVG:_getOffsetTransform:toClipPathSVG:toSVG:complexity:function(){return this.path.length},_calcDimensions:),t.Path.fromObject=function(e,i){if("string"==typeof e.sourcePath){var r=e.sourcePath;t.loadSVGFromURL(r,()}else t.Object._fromObject("Path",e,i,"path")},t.Path.ATTRIBUTE_NAMES=t.SHARED_ATTRIBUTES.concat(["d"]),t.Path.fromElement=}(t),function(e){var t=e.fabric||(e.fabric={}),i=t.util.array.min,r=t.util.array.max;t.Group||(t.Group=t.util.createClass(t.Object,t.Collection,{type:"group",strokeWidth:0,subTargetCheck:!1,cacheProperties:[],useSetOnGroup:!1,initialize:_updateObjectsACoords:_updateObjectsCoords:_updateObjectCoords:toString:function(){return"#<fabric.Group: ("+this.complexity()+")>"},addWithUpdate:removeWithUpdate:_onObjectAdded:_onObjectRemoved:_set:toObject:toDatalessObject:render:shouldCache:willDrawShadow:isOnACache:drawObject:isCacheDirty:_restoreObjectsState:destroy:dispose:toActiveSelection:ungroupOnCanvas:function(){return this._restoreObjectsState()},setObjectsCoords:function(){return this.forEachObject((),this},_calcBounds:function(e){for(var t,i,r,n,s=[],o=[],a=["tr","br","bl","tl"],h=0,l=this._objects.length,c=a.length;h<l;++h){for(r=(t=this._objects[h]).calcACoords(),n=0;n<c;n++)i=a[n],s.push(r[i].x),o.push(r[i].y);t.aCoords=r}this._getBounds(s,o,e)},_getBounds:_toSVG:getSvgStyles:toClipPathSVG:),t.Group.fromObject=function(e,i){var r=e.objects,n=t.util.object.clone(e,!0);delete n.objects,"string"!=typeof r?t.util.enlivenObjects(r,(function(r){var n=t.util.object.clone(e,!0);delete n.objects,t.util.enlivenObjectEnlivables(e,n,()})):t.loadSVGFromURL(r,(function(s){var o=t.util.groupSVGElements(s,e,r);o.set(n),i&&i(o)}))})}(t),function(e){var t=e.fabric||(e.fabric={});t.ActiveSelection||(t.ActiveSelection=t.util.createClass(t.Group,{type:"activeSelection",initialize:toGroup:onDeselect:toString:function(){return"#<fabric.ActiveSelection: ("+this.complexity()+")>"},shouldCache:function(){return!1},isOnACache:function(){return!1},_renderControls:function(e,t,i){e.save(),e.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1,this.callSuper("_renderControls",e,t),void 0===(i=i||{}).hasControls&&(i.hasControls=!1),i.forActiveSelection=!0;for(var r=0,n=this._objects.length;r<n;r++)this._objects[r]._renderControls(e,i);e.restore()}}),t.ActiveSelection.fromObject=}(t),function(e){var t=x.util.object.extend;e.fabric||(e.fabric={}),e.fabric.Image?x.warn("fabric.Image is already defined."):(x.Image=x.util.createClass(x.Object,{type:"image",strokeWidth:0,srcFromAttribute:!1,_lastScaleX:1,_lastScaleY:1,_filterScalingX:1,_filterScalingY:1,minimumScaleTrigger:.5,stateProperties:x.Object.prototype.stateProperties.concat("cropX","cropY"),cacheProperties:x.Object.prototype.cacheProperties.concat("cropX","cropY"),cacheKey:"",cropX:0,cropY:0,imageSmoothing:!0,initialize:getElement:setElement:removeTexture:dispose:getCrossOrigin:getOriginalSize:_stroke:toObject:hasCrop:_toSVG:function(){var e,t=[],i=[],r=this._element,n=-this.width/2,s=-this.height/2,o="",a="";if(!r)return[];if(this.hasCrop()){var h=x.Object.__uid++;t.push('<clipPath id="imageCrop_'+h+'">\n','\t<rect x="'+n+'" y="'+s+'" width="'+this.width+'" height="'+this.height+'" />\n',"</clipPath>\n"),o=' clip-path="url(#imageCrop_'+h+')" '}if(this.imageSmoothing||(a='" image-rendering="optimizeSpeed'),i.push("\t<image ","COMMON_PARTS",'xlink:href="',this.getSvgSrc(!0),'" x="',n-this.cropX,'" y="',s-this.cropY,'" width="',r.width||r.naturalWidth,'" height="',r.height||r.height,a,'"',o,"></image>\n"),this.stroke||this.strokeDashArray){var l=this.fill;this.fill=null,e=["\t<rect ",'x="',n,'" y="',s,'" width="',this.width,'" height="',this.height,'" style="',this.getSvgStyles(),'"/>\n'],this.fill=l}return"fill"!==this.paintFirst?t.concat(e,i):t.concat(i,e)},getSrc:setSrc:toString:applyResizeFilters:applyFilters:_render:drawCacheOnCanvas:shouldCache:function(){return this.needsItsOwnCache()},_renderFill:_needsResize:_resetWidthHeight:_initElement:_initConfig:_initFilters:_setWidthHeight:parsePreserveAspectRatioAttribute:),x.Image.CSS_CANVAS="canvas-img",x.Image.prototype.getSvgSrc=x.Image.prototype.getSrc,x.Image.fromObject=x.Image.fromURL=x.Image.ATTRIBUTE_NAMES=x.SHARED_ATTRIBUTES.concat("x y width height preserveAspectRatio xlink:href crossOrigin image-rendering".split(" ")),x.Image.fromElement=}(t),x.util.object.extend(x.Object.prototype,{_getAngleValueForStraighten:straighten:fxStraighten:function(e){var t=function(){},i=(e=e||{}).onComplete||t,r=e.onChange||t,n=this;return x.util.animate({target:this,startValue:this.get("angle"),endValue:this._getAngleValueForStraighten(),duration:this.FX_DURATION,onChange:onComplete:)}}),x.util.object.extend(x.StaticCanvas.prototype,{straightenObject:fxStraightenObject:),function(){isWebglSupported=x.WebglFilterBackend=t,t.prototype={tileSize:2048,resources:{},setupGLContext:chooseFastestCopyGLTo2DMethod:createWebGLCanvas:applyFilters:dispose:clearWebGLCaches:createTexture:getCachedTexture:evictCachesForKey:copyGLTo2D:E,captureGPUInfo:}(),function(){var e=function(){};.Canvas2dFilterBackend=t,t.prototype={evictCachesForKey:e,dispose:e,clearWebGLCaches:e,resources:{},applyFilters:}(),x.Image=x.Image||{},x.Image.filters=x.Image.filters||{},x.Image.filters.BaseFilter=x.util.createClass({type:"BaseFilter",vertexSource:"attribute vec2 aPosition;\nvarying vec2 vTexCoord;\nvoid main() {\nvTexCoord = aPosition;\ngl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);\n}",fragmentSource:"precision highp float;\nvarying vec2 vTexCoord;\nuniform sampler2D uTexture;\nvoid main() {\ngl_FragColor = texture2D(uTexture, vTexCoord);\n}",initialize:setOptions:createProgram:getAttributeLocations:function(e,t){return{aPosition:e.getAttribLocation(t,"aPosition")}},getUniformLocations:sendAttributeData:_setupFrameBuffer:_swapTextures:isNeutralState:applyTo:retrieveShader:applyToWebGL:bindAdditionalTexture:unbindAdditionalTexture:getMainParameter:setMainParameter:sendUniformData:createHelpLayer:toObject:toJSON:),x.Image.filters.BaseFilter.fromObject=function(e){var t=e.fabric||(e.fabric={}),i=t.Image.filters,r=t.util.createClass;i.ColorMatrix=r(i.BaseFilter,{type:"ColorMatrix",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nvarying vec2 vTexCoord;\nuniform mat4 uColorMatrix;\nuniform vec4 uConstants;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor *= uColorMatrix;\ncolor += uConstants;\ngl_FragColor = color;\n}",matrix:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],mainParameter:"matrix",colorsOnly:!0,initialize:applyTo2d:getUniformLocations:sendUniformData:),t.Image.filters.ColorMatrix.fromObject=t.Image.filters.BaseFilter.fromObject}(t),function(e){var t=e.fabric||(e.fabric={}),i=t.Image.filters,r=t.util.createClass;i.Brightness=r(i.BaseFilter,{type:"Brightness",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uBrightness;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor.rgb += uBrightness;\ngl_FragColor = color;\n}",brightness:0,mainParameter:"brightness",applyTo2d:getUniformLocations:function(e,t){return{uBrightness:e.getUniformLocation(t,"uBrightness")}},sendUniformData:function(e,t){e.uniform1f(t.uBrightness,this.brightness)}}),t.Image.filters.Brightness.fromObject=t.Image.filters.BaseFilter.fromObject}(t),function(e){var t=e.fabric||(e.fabric={}),i=t.util.object.extend,r=t.Image.filters,n=t.util.createClass;r.Convolute=n(r.BaseFilter,{type:"Convolute",opaque:!1,matrix:[0,0,0,0,1,0,0,0,0],fragmentSource:{Convolute_3_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[9];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 3.0; h+=1.0) {\nfor (float w = 0.0; w < 3.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 1), uStepH * (h - 1));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 3.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_3_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[9];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 3.0; h+=1.0) {\nfor (float w = 0.0; w < 3.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 1.0), uStepH * (h - 1.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 3.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_5_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[25];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 5.0; h+=1.0) {\nfor (float w = 0.0; w < 5.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 5.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_5_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[25];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 5.0; h+=1.0) {\nfor (float w = 0.0; w < 5.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 5.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_7_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[49];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 7.0; h+=1.0) {\nfor (float w = 0.0; w < 7.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 7.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_7_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[49];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 7.0; h+=1.0) {\nfor (float w = 0.0; w < 7.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 7.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_9_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[81];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 9.0; h+=1.0) {\nfor (float w = 0.0; w < 9.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 9.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_9_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[81];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 9.0; h+=1.0) {\nfor (float w = 0.0; w < 9.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 9.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}"},retrieveShader:applyTo2d:getUniformLocations:sendUniformData:function(e,t){e.uniform1fv(t.uMatrix,this.matrix)},toObject:),t.Image.filters.Convolute.fromObject=t.Image.filters.BaseFilter.fromObject}(t),function(e){var t=e.fabric||(e.fabric={}),i=t.Image.filters,r=t.util.createClass;i.Grayscale=r(i.BaseFilter,{type:"Grayscale",fragmentSource:{average:"precision highp float;\nuniform sampler2D uTexture;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat average = (color.r + color.b + color.g) / 3.0;\ngl_FragColor = vec4(average, average, average, color.a);\n}",lightness:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uMode;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 col = texture2D(uTexture, vTexCoord);\nfloat average = (max(max(col.r, col.g),col.b) + min(min(col.r, col.g),col.b)) / 2.0;\ngl_FragColor = vec4(average, average, average, col.a);\n}",luminosity:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uMode;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 col = texture2D(uTexture, vTexCoord);\nfloat average = 0.21 * col.r + 0.72 * col.g + 0.07 * col.b;\ngl_FragColor = vec4(average, average, average, col.a);\n}"},mode:"average",mainParameter:"mode",applyTo2d:retrieveShader:getUniformLocations:function(e,t){return{uMode:e.getUniformLocation(t,"uMode")}},sendUniformData:isNeutralState:),t.Image.filters.Grayscale.fromObject=t.Image.filters.BaseFilter.fromObject}(t),function(e){var t=e.fabric||(e.fabric={}),i=t.Image.filters,r=t.util.createClass;i.Invert=r(i.BaseFilter,{type:"Invert",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uInvert;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nif (uInvert == 1) {\ngl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,color.a);\n} else {\ngl_FragColor = color;\n}\n}",invert:!0,mainParameter:"invert",applyTo2d:isNeutralState:getUniformLocations:sendUniformData:),t.Image.filters.Invert.fromObject=t.Image.filters.BaseFilter.fromObject}(t),function(e){var t=e.fabric||(e.fabric={}),i=t.util.object.extend,r=t.Image.filters,n=t.util.createClass;r.Noise=n(r.BaseFilter,{type:"Noise",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uStepH;\nuniform float uNoise;\nuniform float uSeed;\nvarying vec2 vTexCoord;\nfloat rand(vec2 co, float seed, float vScale) {\nreturn fract(sin(dot(co.xy * vScale ,vec2(12.9898 , 78.233))) * 43758.5453 * (seed + 0.01) / 2.0);\n}\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor.rgb += (0.5 - rand(vTexCoord, uSeed, 0.1 / uStepH)) * uNoise;\ngl_FragColor = color;\n}",mainParameter:"noise",noise:0,applyTo2d:getUniformLocations:function(e,t){return{uNoise:e.getUniformLocation(t,"uNoise"),uSeed:e.getUniformLocation(t,"uSeed")}},sendUniformData:toObject:),t.Image.filters.Noise.fromObject=t.Image.filters.BaseFilter.fromObject}(t),function(e){var t=e.fabric||(e.fabric={}),i=t.Image.filters,r=t.util.createClass;i.Pixelate=r(i.BaseFilter,{type:"Pixelate",blocksize:4,mainParameter:"blocksize",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uBlocksize;\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nfloat blockW = uBlocksize * uStepW;\nfloat blockH = uBlocksize * uStepW;\nint posX = int(vTexCoord.x / blockW);\nint posY = int(vTexCoord.y / blockH);\nfloat fposX = float(posX);\nfloat fposY = float(posY);\nvec2 squareCoords = vec2(fposX * blockW, fposY * blockH);\nvec4 color = texture2D(uTexture, squareCoords);\ngl_FragColor = color;\n}",applyTo2d:isNeutralState:getUniformLocations:sendUniformData:function(e,t){e.uniform1f(t.uBlocksize,this.blocksize)}}),t.Image.filters.Pixelate.fromObject=t.Image.filters.BaseFilter.fromObject}(t),function(e){var t=e.fabric||(e.fabric={}),i=t.util.object.extend,r=t.Image.filters,n=t.util.createClass;r.RemoveColor=n(r.BaseFilter,{type:"RemoveColor",color:"#FFFFFF",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec4 uLow;\nuniform vec4 uHigh;\nvarying vec2 vTexCoord;\nvoid main() {\ngl_FragColor = texture2D(uTexture, vTexCoord);\nif(all(greaterThan(gl_FragColor.rgb,uLow.rgb)) && all(greaterThan(uHigh.rgb,gl_FragColor.rgb))) {\ngl_FragColor.a = 0.0;\n}\n}",distance:.02,useAlpha:!1,applyTo2d:getUniformLocations:function(e,t){return{uLow:e.getUniformLocation(t,"uLow"),uHigh:e.getUniformLocation(t,"uHigh")}},sendUniformData:toObject:function(){return i(this.callSuper("toObject"),{color:this.color,distance:this.distance})}}),t.Image.filters.RemoveColor.fromObject=t.Image.filters.BaseFilter.fromObject}(t),function(e){var t=e.fabric||(e.fabric={}),i=t.Image.filters,r=t.util.createClass,n={Brownie:[.5997,.34553,-.27082,0,.186,-.0377,.86095,.15059,0,-.1449,.24113,-.07441,.44972,0,-.02965,0,0,0,1,0],Vintage:[.62793,.32021,-.03965,0,.03784,.02578,.64411,.03259,0,.02926,.0466,-.08512,.52416,0,.02023,0,0,0,1,0],Kodachrome:[1.12855,-.39673,-.03992,0,.24991,-.16404,1.08352,-.05498,0,.09698,-.16786,-.56034,1.60148,0,.13972,0,0,0,1,0],Technicolor:[1.91252,-.85453,-.09155,0,.04624,-.30878,1.76589,-.10601,0,-.27589,-.2311,-.75018,1.84759,0,.12137,0,0,0,1,0],Polaroid:[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0],Sepia:[.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0],BlackWhite:[1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,0,0,0,1,0]};for(var s in n)i[s]=r(i.ColorMatrix,{type:s,matrix:n[s],mainParameter:!1,colorsOnly:!0}),t.Image.filters[s].fromObject=t.Image.filters.BaseFilter.fromObject}(t),function(e){var t=e.fabric,i=t.Image.filters,r=t.util.createClass;i.BlendColor=r(i.BaseFilter,{type:"BlendColor",color:"#F95C63",mode:"multiply",alpha:1,fragmentSource:{multiply:"gl_FragColor.rgb *= uColor.rgb;\n",screen:"gl_FragColor.rgb = 1.0 - (1.0 - gl_FragColor.rgb) * (1.0 - uColor.rgb);\n",add:"gl_FragColor.rgb += uColor.rgb;\n",diff:"gl_FragColor.rgb = abs(gl_FragColor.rgb - uColor.rgb);\n",subtract:"gl_FragColor.rgb -= uColor.rgb;\n",lighten:"gl_FragColor.rgb = max(gl_FragColor.rgb, uColor.rgb);\n",darken:"gl_FragColor.rgb = min(gl_FragColor.rgb, uColor.rgb);\n",exclusion:"gl_FragColor.rgb += uColor.rgb - 2.0 * (uColor.rgb * gl_FragColor.rgb);\n",overlay:"if (uColor.r < 0.5) {\ngl_FragColor.r *= 2.0 * uColor.r;\n} else {\ngl_FragColor.r = 1.0 - 2.0 * (1.0 - gl_FragColor.r) * (1.0 - uColor.r);\n}\nif (uColor.g < 0.5) {\ngl_FragColor.g *= 2.0 * uColor.g;\n} else {\ngl_FragColor.g = 1.0 - 2.0 * (1.0 - gl_FragColor.g) * (1.0 - uColor.g);\n}\nif (uColor.b < 0.5) {\ngl_FragColor.b *= 2.0 * uColor.b;\n} else {\ngl_FragColor.b = 1.0 - 2.0 * (1.0 - gl_FragColor.b) * (1.0 - uColor.b);\n}\n",tint:"gl_FragColor.rgb *= (1.0 - uColor.a);\ngl_FragColor.rgb += uColor.rgb;\n"},buildSource:retrieveShader:applyTo2d:getUniformLocations:function(e,t){return{uColor:e.getUniformLocation(t,"uColor")}},sendUniformData:toObject:),t.Image.filters.BlendColor.fromObject=t.Image.filters.BaseFilter.fromObject}(t),function(e){var t=e.fabric,i=t.Image.filters,r=t.util.createClass;i.BlendImage=r(i.BaseFilter,{type:"BlendImage",image:null,mode:"multiply",alpha:1,vertexSource:"attribute vec2 aPosition;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nuniform mat3 uTransformMatrix;\nvoid main() {\nvTexCoord = aPosition;\nvTexCoord2 = (uTransformMatrix * vec3(aPosition, 1.0)).xy;\ngl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);\n}",fragmentSource:{multiply:"precision highp float;\nuniform sampler2D uTexture;\nuniform sampler2D uImage;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec4 color2 = texture2D(uImage, vTexCoord2);\ncolor.rgba *= color2.rgba;\ngl_FragColor = color;\n}",mask:"precision highp float;\nuniform sampler2D uTexture;\nuniform sampler2D uImage;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec4 color2 = texture2D(uImage, vTexCoord2);\ncolor.a = color2.a;\ngl_FragColor = color;\n}"},retrieveShader:applyToWebGL:createTexture:calculateMatrix:applyTo2d:getUniformLocations:function(e,t){return{uTransformMatrix:e.getUniformLocation(t,"uTransformMatrix"),uImage:e.getUniformLocation(t,"uImage")}},sendUniformData:toObject:),t.Image.filters.BlendImage.fromObject=(t),function(e){var t=e.fabric||(e.fabric={}),i=Math.pow,r=Math.floor,n=Math.sqrt,s=Math.abs,o=Math.round,a=Math.sin,h=Math.ceil,l=t.Image.filters,c=t.util.createClass;l.Resize=c(l.BaseFilter,{type:"Resize",resizeType:"hermite",scaleX:1,scaleY:1,lanczosLobes:3,getUniformLocations:function(e,t){return{uDelta:e.getUniformLocation(t,"uDelta"),uTaps:e.getUniformLocation(t,"uTaps")}},sendUniformData:retrieveShader:getFilterWindow:getTaps:generateShader:fragmentSourceTOP:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec2 uDelta;\nvarying vec2 vTexCoord;\n",applyTo:isNeutralState:lanczosCreate:applyTo2d:sliceByTwo:lanczosResize:bilinearFiltering:hermiteFastResize:function(e,t,i,o,a){for(var l=this.rcpScaleX,c=this.rcpScaleY,u=h(l/2),d=h(c/2),f=e.imageData.data,g=e.ctx.createImageData(o,a),_=g.data,p=0;p<a;p++)for(var m=0;m<o;m++){for(var v=4*(m+p*o),y=0,S=0,w=0,C=0,b=0,x=0,T=0,E=(p+.5)*c,I=r(p*c);I<(p+1)*c;I++)for(var O=s(E-(I+.5))/d,A=(m+.5)*l,R=O*O,D=r(m*l);D<(m+1)*l;D++){var M=s(A-(D+.5))/u,F=n(R+M*M);F>1&&F<-1||(y=2*F*F*F-3*F*F+1)>0&&(T+=y*f[3+(M=4*(D+I*t))],w+=y,f[M+3]<255&&(y=y*f[M+3]/250),C+=y*f[M],b+=y*f[M+1],x+=y*f[M+2],S+=y)}_[v]=C/S,_[v+1]=b/S,_[v+2]=x/S,_[v+3]=T/w}return g},toObject:),t.Image.filters.Resize.fromObject=t.Image.filters.BaseFilter.fromObject}(t),function(e){var t=e.fabric||(e.fabric={}),i=t.Image.filters,r=t.util.createClass;i.Contrast=r(i.BaseFilter,{type:"Contrast",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uContrast;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat contrastF = 1.015 * (uContrast + 1.0) / (1.0 * (1.015 - uContrast));\ncolor.rgb = contrastF * (color.rgb - 0.5) + 0.5;\ngl_FragColor = color;\n}",contrast:0,mainParameter:"contrast",applyTo2d:getUniformLocations:function(e,t){return{uContrast:e.getUniformLocation(t,"uContrast")}},sendUniformData:function(e,t){e.uniform1f(t.uContrast,this.contrast)}}),t.Image.filters.Contrast.fromObject=t.Image.filters.BaseFilter.fromObject}(t),function(e){var t=e.fabric||(e.fabric={}),i=t.Image.filters,r=t.util.createClass;i.Saturation=r(i.BaseFilter,{type:"Saturation",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uSaturation;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat rgMax = max(color.r, color.g);\nfloat rgbMax = max(rgMax, color.b);\ncolor.r += rgbMax != color.r ? (rgbMax - color.r) * uSaturation : 0.00;\ncolor.g += rgbMax != color.g ? (rgbMax - color.g) * uSaturation : 0.00;\ncolor.b += rgbMax != color.b ? (rgbMax - color.b) * uSaturation : 0.00;\ngl_FragColor = color;\n}",saturation:0,mainParameter:"saturation",applyTo2d:getUniformLocations:function(e,t){return{uSaturation:e.getUniformLocation(t,"uSaturation")}},sendUniformData:function(e,t){e.uniform1f(t.uSaturation,-this.saturation)}}),t.Image.filters.Saturation.fromObject=t.Image.filters.BaseFilter.fromObject}(t),function(e){var t=e.fabric||(e.fabric={}),i=t.Image.filters,r=t.util.createClass;i.Vibrance=r(i.BaseFilter,{type:"Vibrance",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uVibrance;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat max = max(color.r, max(color.g, color.b));\nfloat avg = (color.r + color.g + color.b) / 3.0;\nfloat amt = (abs(max - avg) * 2.0) * uVibrance;\ncolor.r += max != color.r ? (max - color.r) * amt : 0.00;\ncolor.g += max != color.g ? (max - color.g) * amt : 0.00;\ncolor.b += max != color.b ? (max - color.b) * amt : 0.00;\ngl_FragColor = color;\n}",vibrance:0,mainParameter:"vibrance",applyTo2d:function(e){if(0!==this.vibrance){var t,i,r,n,s=e.imageData.data,o=s.length,a=-this.vibrance;for(t=0;t<o;t+=4)i=Math.max(s[t],s[t+1],s[t+2]),r=(s[t]+s[t+1]+s[t+2])/3,n=2*Math.abs(i-r)/255*a,s[t]+=i!==s[t]?(i-s[t])*n:0,s[t+1]+=i!==s[t+1]?(i-s[t+1])*n:0,s[t+2]+=i!==s[t+2]?(i-s[t+2])*n:0}},getUniformLocations:function(e,t){return{uVibrance:e.getUniformLocation(t,"uVibrance")}},sendUniformData:),t.Image.filters.Vibrance.fromObject=t.Image.filters.BaseFilter.fromObject}(t),function(e){var t=e.fabric||(e.fabric={}),i=t.Image.filters,r=t.util.createClass;i.Blur=r(i.BaseFilter,{type:"Blur",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec2 uDelta;\nvarying vec2 vTexCoord;\nconst float nSamples = 15.0;\nvec3 v3offset = vec3(12.9898, 78.233, 151.7182);\nfloat random(vec3 scale) {\nreturn fract(sin(dot(gl_FragCoord.xyz, scale)) * 43758.5453);\n}\nvoid main() {\nvec4 color = vec4(0.0);\nfloat total = 0.0;\nfloat offset = random(v3offset);\nfor (float t = -nSamples; t <= nSamples; t++) {\nfloat percent = (t + offset - 0.5) / nSamples;\nfloat weight = 1.0 - abs(percent);\ncolor += texture2D(uTexture, vTexCoord + uDelta * percent) * weight;\ntotal += weight;\n}\ngl_FragColor = color / total;\n}",blur:0,mainParameter:"blur",applyTo:applyTo2d:simpleBlur:function(e){var i,r,n=e.filterBackend.resources,s=e.imageData.width,o=e.imageData.height;n.blurLayer1||(n.blurLayer1=t.util.createCanvasElement(),n.blurLayer2=t.util.createCanvasElement()),i=n.blurLayer1,r=n.blurLayer2,i.width===s&&i.height===o||(r.width=i.width=s,r.height=i.height=o);var a,h,l,c,u=i.getContext("2d"),d=r.getContext("2d"),f=.06*this.blur*.5;for(u.putImageData(e.imageData,0,0),d.clearRect(0,0,s,o),c=-15;c<=15;c++)l=f*(h=c/15)*s+(a=(Math.random()-.5)/4),d.globalAlpha=1-Math.abs(h),d.drawImage(i,l,a),u.drawImage(r,0,0),d.globalAlpha=1,d.clearRect(0,0,r.width,r.height);for(c=-15;c<=15;c++)l=f*(h=c/15)*o+(a=(Math.random()-.5)/4),d.globalAlpha=1-Math.abs(h),d.drawImage(i,a,l),u.drawImage(r,0,0),d.globalAlpha=1,d.clearRect(0,0,r.width,r.height);e.ctx.drawImage(i,0,0);var g=e.ctx.getImageData(0,0,i.width,i.height);return u.globalAlpha=1,u.clearRect(0,0,i.width,i.height),g},getUniformLocations:function(e,t){return{delta:e.getUniformLocation(t,"uDelta")}},sendUniformData:chooseRightDelta:),i.Blur.fromObject=t.Image.filters.BaseFilter.fromObject}(t),function(e){var t=e.fabric||(e.fabric={}),i=t.Image.filters,r=t.util.createClass;i.Gamma=r(i.BaseFilter,{type:"Gamma",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec3 uGamma;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec3 correction = (1.0 / uGamma);\ncolor.r = pow(color.r, correction.r);\ncolor.g = pow(color.g, correction.g);\ncolor.b = pow(color.b, correction.b);\ngl_FragColor = color;\ngl_FragColor.rgb *= color.a;\n}",gamma:[1,1,1],mainParameter:"gamma",initialize:applyTo2d:getUniformLocations:function(e,t){return{uGamma:e.getUniformLocation(t,"uGamma")}},sendUniformData:function(e,t){e.uniform3fv(t.uGamma,this.gamma)}}),t.Image.filters.Gamma.fromObject=t.Image.filters.BaseFilter.fromObject}(t),function(e){var t=e.fabric||(e.fabric={}),i=t.Image.filters,r=t.util.createClass;i.Composed=r(i.BaseFilter,{type:"Composed",subFilters:[],initialize:function(e){this.callSuper("initialize",e),this.subFilters=this.subFilters.slice(0)},applyTo:toObject:isNeutralState:),t.Image.filters.Composed.fromObject=(t),function(e){var t=e.fabric||(e.fabric={}),i=t.Image.filters,r=t.util.createClass;i.HueRotation=r(i.ColorMatrix,{type:"HueRotation",rotation:0,mainParameter:"rotation",calculateMatrix:isNeutralState:applyTo:),t.Image.filters.HueRotation.fromObject=t.Image.filters.BaseFilter.fromObject}(t),function(e){var t=e.fabric||(e.fabric={}),i=t.util.object.clone;if(t.Text)t.warn("fabric.Text is already defined");else{var r="fontFamily fontWeight fontSize text underline overline linethrough textAlign fontStyle lineHeight textBackgroundColor charSpacing styles direction path pathStartOffset pathSide pathAlign".split(" ");t.Text=t.util.createClass(t.Object,{_dimensionAffectingProps:["fontSize","fontWeight","fontFamily","fontStyle","lineHeight","text","charSpacing","textAlign","styles","path","pathStartOffset","pathSide","pathAlign"],_reNewline:/\r?\n/,_reSpacesAndTabs:/[ \t\r]/g,_reSpaceAndTab:/[ \t\r]/,_reWords:/\S+/g,type:"text",fontSize:40,fontWeight:"normal",fontFamily:"Times New Roman",underline:!1,overline:!1,linethrough:!1,textAlign:"left",fontStyle:"normal",lineHeight:1.16,superscript:{size:.6,baseline:-.35},subscript:{size:.6,baseline:.11},textBackgroundColor:"",stateProperties:t.Object.prototype.stateProperties.concat(r),cacheProperties:t.Object.prototype.cacheProperties.concat(r),stroke:null,shadow:null,path:null,pathStartOffset:0,pathSide:"left",pathAlign:"baseline",_fontSizeFraction:.222,offsets:{underline:.1,linethrough:-.315,overline:-.88},_fontSizeMult:1.13,charSpacing:0,styles:null,_measuringContext:null,deltaY:0,direction:"ltr",_styleProperties:["stroke","strokeWidth","fill","fontFamily","fontSize","fontWeight","fontStyle","underline","overline","linethrough","deltaY","textBackgroundColor"],__charBounds:[],CACHE_FONT_SIZE:400,MIN_TEXT_WIDTH:2,initialize:setPathInfo:getMeasuringContext:_splitText:initDimensions:enlargeSpaces:isEndOfWrapping:missingNewlineOffset:toString:_getCacheCanvasDimensions:_render:_renderText:_setTextStyles:function(e,t,i){if(e.textBaseline="alphabetical",this.path)switch(this.pathAlign){case"center":e.textBaseline="middle";break;case"ascender":e.textBaseline="top";break;case"descender":e.textBaseline="bottom"}e.font=this._getFontDeclaration(t,i)},calcTextWidth:_renderTextLine:_renderTextLinesBackground:getFontCache:_measureChar:getHeightOfChar:measureLine:_measureLine:function(e){var i,r,n,s,o,a,h=0,l=this._textLines[e],c=new Array(l.length),u=0,d=this.path,f="right"===this.pathSide;for(this.__charBounds[e]=c,i=0;i<l.length;i++)r=l[i],s=this._getGraphemeBox(r,e,i,n),c[i]=s,h+=s.kernedWidth,n=r;if(c[i]={left:s?s.left+s.width:0,width:0,kernedWidth:0,height:this.fontSize},d){switch(a=d.segmentsInfo[d.segmentsInfo.length-1].length,(o=t.util.getPointOnPath(d.path,0,d.segmentsInfo)).x+=d.pathOffset.x,o.y+=d.pathOffset.y,this.textAlign){case"left":u=f?a-h:0;break;case"center":u=(a-h)/2;break;case"right":u=f?0:a-h}for(u+=this.pathStartOffset*(f?-1:1),i=f?l.length-1:0;f?i>=0:i<l.length;f?i--:i++)s=c[i],u>a?u%=a:u<0&&(u+=a),this._setGraphemeOnPath(u,s,o),u+=s.kernedWidth}return{width:h,numOfSpaces:0}},_setGraphemeOnPath:_getGraphemeBox:getHeightOfLine:calcTextHeight:_getLeftOffset:_getTopOffset:_renderTextCommon:_renderTextFill:_renderTextStroke:_renderChars:function(e,t,i,r,n,s){var o,a,h,l,c,u=this.getHeightOfLine(s),d=-1!==this.textAlign.indexOf("justify"),f="",g=0,_=this.path,p=!d&&0===this.charSpacing&&this.isEmptyStyles(s)&&!_,m="ltr"===this.direction,v="ltr"===this.direction?1:-1,y=t.canvas.getAttribute("dir");if(t.save(),y!==this.direction&&(t.canvas.setAttribute("dir",m?"ltr":"rtl"),t.direction=m?"ltr":"rtl",t.textAlign=m?"left":"right"),n-=u*this._fontSizeFraction/this.lineHeight,p)return this._renderChar(e,t,s,0,i.join(""),r,n,u),void t.restore();for(var S=0,w=i.length-1;S<=w;S++)l=S===w||this.charSpacing||_,f+=i[S],h=this.__charBounds[s][S],0===g?(r+=v*(h.kernedWidth-h.width),g+=h.width):g+=h.kernedWidth,d&&!l&&this._reSpaceAndTab.test(i[S])&&(l=!0),l||(o=o||this.getCompleteStyleDeclaration(s,S),a=this.getCompleteStyleDeclaration(s,S+1),l=this._hasStyleChanged(o,a)),l&&(_?(t.save(),t.translate(h.renderLeft,h.renderTop),t.rotate(h.angle),this._renderChar(e,t,s,S,f,-g/2,0,u),t.restore()):(c=r,this._renderChar(e,t,s,S,f,c,n,u)),f="",o=a,r+=v*g,g=0);t.restore()},_applyPatternGradientTransformText:handleFiller:_setStrokeStyles:_setFillStyles:_renderChar:setSuperscript:function(e,t){return this._setScript(e,t,this.superscript)},setSubscript:_setScript:_hasStyleChanged:_hasStyleChangedForSvg:_getLineLeftOffset:_clearCache:_shouldClearDimensionCache:getLineWidth:function(e){if(void 0!==this.__lineWidths[e])return this.__lineWidths[e];var t=this.measureLine(e).width;return this.__lineWidths[e]=t,t},_getWidthOfCharSpacing:getValueOfPropertyAt:_renderTextDecoration:function(e,t){if(this[t]||this.styleHas(t)){for(var i,r,n,s,o,a,h,l,c,u,d,f,g,_,p,m,v=this._getLeftOffset(),y=this._getTopOffset(),S=this.path,w=this._getWidthOfCharSpacing(),C=this.offsets[t],b=0,x=this._textLines.length;b<x;b++)if(i=this.getHeightOfLine(b),this[t]||this.styleHas(t,b)){h=this._textLines[b],_=i/this.lineHeight,s=this._getLineLeftOffset(b),u=0,d=0,l=this.getValueOfPropertyAt(b,0,t),m=this.getValueOfPropertyAt(b,0,"fill"),c=y+_*(1-this._fontSizeFraction),r=this.getHeightOfChar(b,0),o=this.getValueOfPropertyAt(b,0,"deltaY");for(var T=0,E=h.length;T<E;T++)if(f=this.__charBounds[b][T],g=this.getValueOfPropertyAt(b,T,t),p=this.getValueOfPropertyAt(b,T,"fill"),n=this.getHeightOfChar(b,T),a=this.getValueOfPropertyAt(b,T,"deltaY"),S&&g&&p)e.save(),e.fillStyle=m,e.translate(f.renderLeft,f.renderTop),e.rotate(f.angle),e.fillRect(-f.kernedWidth/2,C*n+a,f.kernedWidth,this.fontSize/15),e.restore();else if((g!==l||p!==m||n!==r||a!==o)&&d>0){var I=v+s+u;"rtl"===this.direction&&(I=this.width-I-d),l&&m&&(e.fillStyle=m,e.fillRect(I,c+C*r+o,d,this.fontSize/15)),u=f.left,d=f.width,l=g,m=p,r=n,o=a}else d+=f.kernedWidth;I=v+s+u,"rtl"===this.direction&&(I=this.width-I-d),e.fillStyle=p,g&&p&&e.fillRect(I,c+C*r+o,d-w,this.fontSize/15),y+=i}else y+=i;this._removeShadow(e)}},_getFontDeclaration:render:_splitTextIntoLines:toObject:function(e){var t=r.concat(e),n=this.callSuper("toObject",t);return n.styles=i(this.styles,!0),n.path&&(n.path=this.path.toObject()),n},set:function(e,t){this.callSuper("set",e,t);var i=!1,r=!1;if("object"==typeof e)for(var n in e)"path"===n&&this.setPathInfo(),i=i||-1!==this._dimensionAffectingProps.indexOf(n),r=r||"path"===n;else i=-1!==this._dimensionAffectingProps.indexOf(e),r="path"===e;return r&&this.setPathInfo(),i&&(this.initDimensions(),this.setCoords()),this},complexity:function(){return 1}}),t.Text.ATTRIBUTE_NAMES=t.SHARED_ATTRIBUTES.concat("x y dx dy font-family font-style font-weight font-size letter-spacing text-decoration text-anchor".split(" ")),t.Text.DEFAULT_SVG_FONT_SIZE=16,t.Text.fromElement=t.Text.fromObject=function(e,r){var n=i(e),s=e.path;return delete n.path,t.Object._fromObject("Text",n,(function(e){s?t.Object._fromObject("Path",s,(,"path"):r(e)}),"text")},t.Text.genericFonts=["sans-serif","serif","cursive","fantasy","monospace"],t.util.createAccessors&&t.util.createAccessors(t.Text)}}(t),x.util.object.extend(x.Text.prototype,{isEmptyStyles:styleHas:cleanStyle:removeStyle:_extendStyles:get2DCursorLocation:getSelectionStyles:getStyleAtPosition:setSelectionStyles:_getStyleDeclaration:getCompleteStyleDeclaration:_setStyleDeclaration:_deleteStyleDeclaration:_getLineStyle:_setLineStyle:_deleteLineStyle:),function(){.IText=x.util.createClass(x.Text,x.Observable,{type:"i-text",selectionStart:0,selectionEnd:0,selectionColor:"rgba(17,119,255,0.3)",isEditing:!1,editable:!0,editingBorderColor:"rgba(102,153,255,0.25)",cursorWidth:2,cursorColor:"",cursorDelay:1e3,cursorDuration:600,caching:!0,hiddenTextareaContainer:null,_reSpace:/\s|\n/,_currentCursorOpacity:0,_selectionDirection:null,_abortCursorAnimation:!1,__widthOfSpace:[],inCompositionMode:!1,initialize:setSelectionStart:setSelectionEnd:_updateAndFire:_fireSelectionChanged:initDimensions:render:_render:clearContextTop:renderCursorOrSelection:_clearTextArea:_getCursorBoundaries:_getCursorBoundariesOffsets:renderCursor:renderSelection:function(e,t){for(var i=this.inCompositionMode?this.hiddenTextarea.selectionStart:this.selectionStart,r=this.inCompositionMode?this.hiddenTextarea.selectionEnd:this.selectionEnd,n=-1!==this.textAlign.indexOf("justify"),s=this.get2DCursorLocation(i),o=this.get2DCursorLocation(r),a=s.lineIndex,h=o.lineIndex,l=s.charIndex<0?0:s.charIndex,c=o.charIndex<0?0:o.charIndex,u=a;u<=h;u++){var d,f=this._getLineLeftOffset(u)||0,g=this.getHeightOfLine(u),_=0,p=0;if(u===a&&(_=this.__charBounds[a][l].left),u>=a&&u<h)p=n&&!this.isEndOfWrapping(u)?this.width:this.getLineWidth(u)||5;else if(u===h)if(0===c)p=this.__charBounds[h][c].left;else{var m=this._getWidthOfCharSpacing();p=this.__charBounds[h][c-1].left+this.__charBounds[h][c-1].width-m}d=g,(this.lineHeight<1||u===h&&this.lineHeight>1)&&(g/=this.lineHeight);var v=e.left+f+_,y=p-_,S=g,w=0;this.inCompositionMode?(t.fillStyle=this.compositionColor||"black",S=1,w=g):t.fillStyle=this.selectionColor,"rtl"===this.direction&&(v=this.width-v-y),t.fillRect(v,e.top+e.topOffset+w,y,S),e.topOffset+=d}},getCurrentCharFontSize:function(){var e=this._getCurrentCharIndex();return this.getValueOfPropertyAt(e.l,e.c,"fontSize")},getCurrentCharColor:_getCurrentCharIndex:),x.IText.fromObject=(),b=x.util.object.clone,x.util.object.extend(x.IText.prototype,{initBehavior:onDeselect:initAddedHandler:initRemovedHandler:_initCanvasHandlers:_removeCanvasHandlers:_tick:_animateCursor:_onTickComplete:initDelayedCursor:abortCursorAnimation:selectAll:getSelectedText:findWordBoundaryLeft:findWordBoundaryRight:findLineBoundaryLeft:findLineBoundaryRight:searchWordBoundary:selectWord:selectLine:enterEditing:exitEditingOnOthers:initMouseMoveHandler:mouseMoveHandler:_setEditingProps:fromStringToGraphemeSelection:fromGraphemeToStringSelection:_updateTextarea:updateFromTextArea:updateTextareaPosition:_calcTextareaPosition:_saveEditingProps:_restoreEditingProps:exitEditing:_removeExtraneousStyles:removeStyleFromTo:shiftLineStyles:restartCursorIfNeeded:insertNewlineStyleObject:insertCharStyleObject:insertNewStyleBlock:function(e,t,i){for(var r=this.get2DCursorLocation(t,!0),n=[0],s=0,o=0;o<e.length;o++)"\n"===e[o]?n[++s]=0:n[s]++;for(n[0]>0&&(this.insertCharStyleObject(r.lineIndex,r.charIndex,n[0],i),i=i&&i.slice(n[0]+1)),s&&this.insertNewlineStyleObject(r.lineIndex,r.charIndex+n[0],s),o=1;o<s;o++)n[o]>0?this.insertCharStyleObject(r.lineIndex+o,0,n[o],i):i&&this.styles[r.lineIndex+o]&&i[0]&&(this.styles[r.lineIndex+o][0]=i[0]),i=i&&i.slice(n[o]+1);n[o]>0&&this.insertCharStyleObject(r.lineIndex+o,0,n[o],i)},setSelectionStartEndWithShift:setSelectionInBoundaries:),x.util.object.extend(x.IText.prototype,{initDoubleClickSimulation:onMouseDown:isTripleClick:_stopEvent:initCursorSelectionHandlers:doubleClickHandler:function(e){this.isEditing&&this.selectWord(this.getSelectionStartFromPointer(e.e))},tripleClickHandler:initClicks:function(){this.on("mousedblclick",this.doubleClickHandler),this.on("tripleclick",this.tripleClickHandler)},_mouseDownHandler:_mouseDownHandlerBefore:initMousedownHandler:initMouseupHandler:mouseUpHandler:setCursorByClick:getSelectionStartFromPointer:function(e){for(var t,i=this.getLocalPointer(e),r=0,n=0,s=0,o=0,a=0,h=0,l=this._textLines.length;h<l&&s<=i.y;h++)s+=this.getHeightOfLine(h)*this.scaleY,a=h,h>0&&(o+=this._textLines[h-1].length+this.missingNewlineOffset(h-1));n=this._getLineLeftOffset(a)*this.scaleX,t=this._textLines[a],"rtl"===this.direction&&(i.x=this.width*this.scaleX-i.x+n);for(var c=0,u=t.length;c<u&&(r=n,(n+=this.__charBounds[a][c].kernedWidth*this.scaleX)<=i.x);c++)o++;return this._getNewSelectionStartFromOffset(i,r,n,o,u)},_getNewSelectionStartFromOffset:),x.util.object.extend(x.IText.prototype,{initHiddenTextarea:},keysMap:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorRight",36:"moveCursorLeft",37:"moveCursorLeft",38:"moveCursorUp",39:"moveCursorRight",40:"moveCursorDown"},keysMapRtl:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorLeft",36:"moveCursorRight",37:"moveCursorRight",38:"moveCursorUp",39:"moveCursorLeft",40:"moveCursorDown"},ctrlKeysMapUp:{67:"copy",88:"cut"},ctrlKeysMapDown:{65:"selectAll"},onClic},onKeyDow},onKeyU},onInpu},onCompositionStart:function(){this.inCompositionMode=!0},onCompositionEnd:function(){this.inCompositionMode=!1},onCompositionUpdat},cop},past},_getClipboardDat},_getWidthBeforeCurso},getDownCursorOffse},_getSelectionForOffse},getUpCursorOffse},_getIndexOnLin},moveCursorDown:function(e){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorUpOrDown("Down",e)},moveCursorUp:function(e){0===this.selectionStart&&0===this.selectionEnd||this._moveCursorUpOrDown("Up",e)},_moveCursorUpOrDow},moveCursorWithShif},moveCursorWithoutShif},moveCursorLef},_mov},_moveLeft:function(e,t){return this._move(e,t,"Left")},_moveRight:function(e,t){return this._move(e,t,"Right")},moveCursorLeftWithoutShif},moveCursorLeftWithShif},moveCursorRigh},_moveCursorLeftOrRigh},moveCursorRightWithShif},moveCursorRightWithoutShif},removeChar},insertChar}}),function(){var e=x.util.toFixed,t=/  +/g;x.util.object.extend(x.Text.prototype,{_toSV},toSV},_getSVGLeftTopOffset},_wrapSVGTextAndB},_getSVGTextAndB},_createTextCharSpa},_setSVGTextLineTex},_pushTextBgRec},_setSVGTextLineB},_getFillAttribute},_getSVGLineTopOffse},getSvgStyle}})}(),function(e){var t=e.fabric||(e.fabric={});t.Textbox=t.util.createClass(t.IText,t.Observable,{type:"textbox",minWidth:20,dynamicMinWidth:2,__cachedLines:null,lockScalingFlip:!0,noScaleCache:!1,_dimensionAffectingProps:t.Text.prototype._dimensionAffectingProps.concat("width"),_wordJoiners:/[ \t\r]/,splitByGrapheme:!1,initDimension},_generateStyleMa},styleHa},isEmptyStyle},_getStyleDeclaratio},_setStyleDeclaratio},_deleteStyleDeclaratio},_getLineStyl},_setLineStyl},_wrapTex},_measureWord:function(e,t,i){var r,n=0;i=i||0;for(var s=0,o=e.length;s<o;s++)n+=this._getGraphemeBox(e[s],t,s+i,r,!0).kernedWidth,r=e[s];return n},_wrapLine:function(e,i,r,n){var s=0,o=this.splitByGrapheme,a=[],h=[],l=o?t.util.string.graphemeSplit(e):e.split(this._wordJoiners),c="",u=0,d=o?"":" ",f=0,g=0,_=0,p=!0,m=this._getWidthOfCharSpacing();n=n||0,0===l.length&&l.push([]),r-=n;for(var v=0;v<l.length;v++)c=o?l[v]:t.util.string.graphemeSplit(l[v]),f=this._measureWord(c,i,u),u+=c.length,(s+=g+f-m)>r&&!p?(a.push(h),h=[],s=f,p=!0):s+=m,p||o||h.push(d),h=h.concat(c),g=o?0:this._measureWord([d],i,u),u++,p=!1,f>_&&(_=f);return v&&a.push(h),_+n>this.dynamicMinWidth&&(this.dynamicMinWidth=_-m+n),a},isEndOfWrappin},missingNewlineOffse},_splitTextIntoLine},getMinWidt},_removeExtraneousStyle},toObjec}}),t.Textbox.fromObjec}}(t}()},192:()=>{},898:()=>{},245:()=>{}},k={}B.},B.);var N={};(()=>{let e;B.d(N,{e}),e="undefined"!=typeof document&&"undefined"!=typeof window?B(653).fabric:{version:"5.2.1"}})();var j=N.R;
/*!
     * Dynamsoft JavaScript Library
     * @product Dynamsoft Camera Enhancer JS Edition
     * @website https://www.dynamsoft.com
     * @copyright Copyright 2023, Dynamsoft Corporation
     * @author Dynamsoft
     * @version 3.3.4 (js 20230414)
     * @fileoverview Dynamsoft JavaScript Library for Camera Enhancer
     * More info on DCE JS: https://www.dynamsoft.com/camera-enhancer/docs/programming/javascript/?ver=latest
     */const V="undefined"==typeof self;let U,G,W,H,Y;if("undefined"!=typeof navigator&&(U=navigator,G=U.userAgent,W=U.platform,H=U.mediaDevices),!V){const e={Edge:{search:"Edg",verSearch:"Edg"},OPR:null,Chrome:null,Safari:{str:U.vendor,search:"Apple",verSearch:["Version","iPhone OS","CPU OS"]},Firefox:null,Explorer:{search:"MSIE",verSearch:"MSIE"}},t={HarmonyOS:null,Android:null,iPhone:null,iPad:null,Windows:{str:W,search:"Win"},Mac:{str:W},Linux:{str:W}};let i="unknownBrowser",r=0,n="unknownOS";for(let t in e){const n=e[t]||{};let s=n.str||G,o=n.search||t,a=n.verStr||G,h=n.verSearch||t;if(h instanceof Array||(h=[h]),-1!=s.indexOf(o)){i=t;for(let e of h){let t=a.indexOf(e);if(-1!=t){r=parseFloat(a.substring(t+e.length+1));break}}break}}for(let e in t){const i=t[e]||{};let r=i.str||G,s=i.search||e;if(-1!=r.indexOf(s)){n=e;break}}"Linux"==n&&-1!=G.indexOf("Windows NT")&&(n="HarmonyOS"),Y={browser:i,version:r,OS:n}}V&&(Y={browser:"ssr",version:0,OS:"ssr"});const X="undefined"!=typeof WebAssembly&&G&&!(/Safari/.test(G)&&!/Chrome/.test(G)&&/\(.+\s11_2_([2-6]).*\)/.test(G)),z=!("undefined"==typeof Worker),Z=!(!H||!H.getUserMedia),J=async()=>{let e=!1;if(Z)try{(await H.getUserMedia({video:!0})).getTracks().forEach((e=>{e.stop()})),e=!0}catch(e){}return e};"Chrome"===Y.browser&&Y.version>66||"Safari"===Y.browser&&Y.version>13||"OPR"===Y.browser&&Y.version>43||"Edge"===Y.browser&&Y.version;const K=(()=>{if(!V&&document.currentScript){let e=document.currentScript.src,t=e.indexOf("?");if(-1!=t)e=e.substring(0,t);else{let t=e.indexOf("#");-1!=t&&(e=e.substring(0,t))}return e.substring(0,e.lastIndexOf("/")+1)}return"./"})();class q{constructor(e,t){this._zIndex=null,this._drawingLayer=null,this._drawingLayerId=null,this._mapStyle=new Map,this.mapEvent_Callbacks=new Map([["selected",new Map],["deselected",new Map],["mousedown",new Map],["mouseup",new Map],["dblclick",new Map],["mouseover",new Map],["mouseout",new Map]]),this.mapNoteName_Content=new Map([]),this.isDrawingItem=!0,this._setFabricObject(e),this._mediaType=e.type,this.styleSelector="default",this.styleId=t}get mediaType(){return this._mediaType}get drawingLayerId(){return this._drawingLayerId}_setFabricObject(e){this._fabricObject=e,this._fabricObject.on("selected"})),this._fabricObject.on("deselected",(()=>{this._fabricObject.canvas&&this._fabricObject.canvas.getActiveObjects().includes(this._fabricObject)?this.styleSelector="selected":this.styleSelector="default","textbox"===this._fabricObject.type&&(this._fabricObject.isEditing&&this._fabricObject.exitEditing(),this._fabricObject.selected=!1)})),e.getDrawingItes}_getFabricObject(){return this._fabricObject}_on(e,t){if(!t)return;const i=e.toLowerCase(),r=this.mapEvent_Callbacks.get(i);if(!r)throw new Error(`Event '${e}' does not exist.`);let n=r.get(t);n||(n=e=>{const i=e.e;if(!i)return void(t&&t.apply(this,[{targetItem:this,itemClientX:null,itemClientY:null,itemPageX:null,itemPageY:null}]));const r={targetItem:this,itemClientX:null,itemClientY:null,itemPageX:null,itemPageY:null};if(this._drawingLayer){let e,t,n,s;const o=i.target.getBoundingClientRect();e=o.left,t=o.top,n=e+window.scrollX,s=t+window.scrollY;const a=this._drawingLayer.fabricCanvas.lowerCanvasEl.width,h=this._drawingLayer.fabricCanvas.lowerCanvasEl.height,l=parseFloat(window.getComputedStyle(this._drawingLayer.fabricCanvas.lowerCanvasEl).width),c=parseFloat(window.getComputedStyle(this._drawingLayer.fabricCanvas.lowerCanvasEl).height),u=l/c,d=a/h,f=this._drawingLayer._getObjectFit();let g,_,p,m,v=1;if("contain"===f)u<d?(v=l/a,g=e+this.get("x")*v,_=t+this.get("y")*v+(c-h*v)/2,p=n+this.get("x")*v,m=s+this.get("y")*v+(c-h*v)/2):(v=c/h,g=e+this.get("x")*v+(l-a*v)/2,_=t+this.get("y")*v,p=n+this.get("x")*v+(l-a*v)/2,m=s+this.get("y")*v);else if("cover"===f)if(u<d){v=c/h;let i=this.get("x")*v-(a*v-l)/2;i=Math.max(i,0),i=Math.min(i,l),g=e+i,_=t+this.get("y")*v,p=n+i,m=s+this.get("y")*v}else{v=l/a;let i=this.get("y")*v-(h*v-c)/2;i=Math.max(i,0),i=Math.min(i,c),g=e+this.get("x")*v,_=t+i,p=n+this.get("x")*v,m=s+i}r.itemClientX=Math.round(g),r.itemClientY=Math.round(_),r.itemPageX=Math.round(p),r.itemPageY=Math.round(m)}for(let e of Object.getOwnPropertyNames(r))Object.defineProperty(i,e,{value:r[e],writable:!0});t&&t.apply(this,[i])},r.set(t,n),this._fabricObject.on("dblclick"===i?"mousedblclick":i,n))}on(e,t){this._on(e,t)}_off(e,t){const i=e.toLowerCase(),r=this.mapEvent_Callbacks.get(i);if(!r)throw new Error(`Event '${e}' does not exist.`);let n=r.get(t);n&&(r.delete(t),this._fabricObject.off("dblclick"===i?"mousedblclick":i,n))}off(e,t){this._off(e,t)}_setEditable(e){const t=this._fabricObject;e?(t.selectable=!0,t.hasControls=!0,t.hoverCursor=null):(t.selectable=!1,t.hasControls=!1,t.hoverCursor="default")}hasNote(e){return this.mapNoteName_Content.has(e)}addNote(e,t){if(this.hasNote(e.name)&&!t)throw new Error("A note with the same name already exists, please use a different name.");const i=e.content?JSON.parse(JSON.stringify(e.content)):e.content;this.mapNoteName_Content.set(e.name,[i])}getNote(e){const t=this.mapNoteName_Content.get(e);return t?1===t.length?{name:e,content:t[0]?JSON.parse(JSON.stringify(t[0])):t[0]}:{name:e,content:JSON.parse(JSON.stringify(t))}:null}getNotes(){const e=[];for(let t of this.mapNoteName_Content){let i=1===t[1].length?t[1][0]:t[1];i=i?JSON.parse(JSON.stringify(i)):i,e.push({name:t[0],content:i})}return e}updateNote(e,t,i){const r=this.mapNoteName_Content.get(e);if(!r)throw new Error("The note name does not exist.");i||(r.length=0),t=t?JSON.parse(JSON.stringify(t)):t,r.push(t}clearNotes(){this.mapNoteName_Content.clear(set(e,t){if(!this._extendSet(e,t))if("x"===e){const e=this._fabricObject.group;e?(this._fabricObject.set("left",t-e.left-e.width/2),e.addWithUpdate()):this._fabricObject.set("left",t)}else if("y"===e){const e=this._fabricObject.group;e?(this._fabricObject.set("top",t-e.top-e.height/2),e.addWithUpdate()):this._fabricObject.set("top",t)}else"styleId"===e?this.styleId=t:this._fabricObject.set(e,t);["vertices","startPoint","endPoint","x","y","left","top","width","height","scaleX","scaleY","skewX","skewY","padding","angle","strokeWidth"].includes(e)&&this._fabricObject.setCoords()}get(e){let t=this._extendGet(e);if(void 0===t)if("x"===e){const e=this._fabricObject.group;t=e?this._fabricObject.get("left")+e.left+e.width/2:this._fabricObject.get("left")}else if("y"===e){const e=this._fabricObject.group;t=e?this._fabricObject.get("top")+e.top+e.height/2:this._fabricObject.get("top")}else t=["type","mediaType"].includes(e)?this.mediaType:"styleSelector"===e?this.styleSelector:"styleId"===e?this.styleId:"drawingLayerId"===e?this.drawingLayerId:this._fabricObject.get(e);return }function Q(e,t,i){let r=i.points[this.pointIndex].x-i.pathOffset.x,n=i.points[this.pointIndex].y-i.pathOffset.y;return j.util.transformPoint({x:r,y:n},i.calcTransformMatrix())}function $(e){let t=new j.Point(e.strokeUniform?1/e.scaleX:1,e.strokeUniform?1/e.scaleY:1).multiply(e.strokeWidth);return new j.Point(e.width+t.x,e.height+t.y)}function ee(e,t,i,r){let n=t.target,s=n.controls[n.__corner],o=n.toLocalPoint(new j.Point(i,r),"center","center"),a=$(n),h=n._getTransformedDimensions(0,0),l={x:o.x*a.x/h.x+n.pathOffset.x,y:o.y*a.y/h.y+n.pathOffset.y};return n.points[s.pointIndex]=l,!0}function te(e,t){return function(i,r,n,s){let o=r.target,a=j.util.transformPoint({x:o.points[e].x-o.pathOffset.x,y:o.points[e].y-o.pathOffset.y},o.calcTransformMatrix()),h=t(i,r,n,s);o._setPositionDimensions({});let l=$(o),c=(o.points[e].x-o.pathOffset.x)/l.x,u=(o.points[e].y-o.pathOffset.y)/l.y;return o.setPositionByOrigin(a,c+.5,u+.5),h}}q.arrMediaTypes=["rect","arc","polygon","image","text","line","path"],q.arrStyleSelectors=["default","selected"];class ie extends q{constructor(e,t){super(new j.Polygon(e,{objectCaching:!1}),t);const i=this._fabricObject;let r=i.points.length-1;i.controls=i.points.reduce((function(e,t,i){return e["p"+i]=new j.Control({positionHandler:Q,actionHandler:te(i>0?i-1:r,ee),actionName:"modifyPolygon",pointIndex:i}),e}),{})}_extendSet(e,t){if("vertices"===e){const e=this._fabricObject;if(e.group){const i=e.group;e.points=t.map((e=>({x:e.x-i.left-i.width/2,y:e.y-i.top-i.height/2}))),i.addWithUpdate()}else e.points=t;const i=e.points.length-1;return e.controls=e.points.reduce((function(e,t,r){return e["p"+r]=new j.Control({positionHandler:Q,actionHandler:te(r>0?r-1:i,ee),actionName:"modifyPolygon",pointIndex:r}),e}),{}),e._setPositionDimensions({}),!0}}_extendGet(e){if("vertices"===e){const e=[],t=this._fabricObject;if(t.selectable&&!t.group)for(let i in t.oCoords)e.push({x:t.oCoords[i].x,y:t.oCoords[i].y});else for(let i of t.points){let r=i.x-t.pathOffset.x,n=i.y-t.pathOffset.y;const s=j.util.transformPoint({x:r,y:n},t.calcTransformMatrix());e.push({x:s.x,y:s.y})}return e}}}const re=e=>{let t))(e);return(e=>{for(let t=0;;t++){let i=-1;for(let r=0;r<e.length;r++){let n=e[r][t];void 0!==n&&n.length>i&&(i=n.length)}if(-1===i)break;for(let r=0;r<e.length;r++){if(t>=e[r].length-1)continue;let n=" ".repeat(i+2-e[r][t].length);e[r][t]=e[r][t].concat(n)}}})(t),(e=>{let t="";for(let i=0;i<e.length;i++)t=t.concat(...e[i],i===e.length-1?"":"\n");return t})(t)};class ne extends q{constructor(e,t,i,r,n){if("number"!=typeof r||r<=0)throw new RangeError("Invalid width.");super(new j.Textbox(re(e),{left:t,top:i,width:r}),n),this._mediaType="text",this._text=e}_extendSet(e,t){if("text"===e)return this._text=t,this._fabricObject.set("text",re(t)),!}}"undefined"!=typeof document&&"undefined"!=typeof window&&(j.StaticCanvas.prototype.dispose=function(){return this.isRendering&&(j.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject})),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),j.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},j.Object.prototype.transparentCorners=!1,j.Object.prototype.cornerSize=20,j.Object.prototype.touchCornerSize=100,j.Object.prototype.cornerColor="rgb(254,142,20)",j.Object.prototype.cornerStyle="circle",j.Object.prototype.strokeUniform=!0,j.Object.prototype.hasBorders=!1,j.Canvas.prototype.containerClass="",j.Canvas.prototype.getPointer=function(e,t){if(this._absolutePointer&&!t)return this._absolutePointer;if(this._pointer&&t)return this._pointer;var i,r=this.upperCanvasEl,n=j.util.getPointer(e,r),s=r.getBoundingClientRect(),o=s.width||0,a=s.height||0;o&&a||("top"in s&&"bottom"in s&&(a=Math.abs(s.top-s.bottom)),"right"in s&&"left"in s&&(o=Math.abs(s.right-s.left))),this.calcOffset(),n.x=n.x-this._offset.left,n.y=n.y-this._offset.top,t||(n=this.restorePointerVpt(n));var h=this.getRetinaScaling();if(1!==h&&(n.x/=h,n.y/=h),0!==o&&0!==a){var l=window.getComputedStyle(r).objectFit,c=r.width,u=r.height,d=o,f=a;i={width:c/d,height:u/f};var g,_,p=c/u,m=d/f;return"contain"===l?p>m?(g=d,_=d/p,{x:n.x*i.width,y:(n.y-(f-_)/2)*i.width}):(g=f*p,_=f,{x:(n.x-(d-g)/2)*i.height,y:n.y*i.height}):"cover"===l?p>m?{x:(c-i.height*d)/2+n.x*i.height,y:n.y*i.height}:{x:n.x*i.width,y:(u-i.width*f)/2+n.y*i.width}:{x:n.x*i.width,y:n.y*i.height}}return i={width:1,height:1},{x:n.x*i.width,y:n.y*i.height}},j.Canvas.prototype._onTouchStart=function(e){var t=this.findTarget(e);!this.allowTouchScrolling&&e.cancelable&&e.preventDefault&&e.preventDefault(),t&&e.cancelable&&e.preventDefault&&e.preventDefault(),null===this.mainTouchId&&(this.mainTouchId=this.getPointerId(e)),this.__onMouseDown(e),this._resetTransformEventData();var i=this.upperCanvasEl,r=this._getEventPrefix();j.util.addListener(j.document,"touchend",this._onTouchEnd,{passive:!1}),j.util.addListener(j.document,"touchmove",this._onMouseMove,{passive:!1}),j.util.removeListener(i,r+"down",this._onMouseDown)},j.Textbox.prototype._wrapLine=function(e,t,i,r){const n=e.match(/[\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff\uff66-\uff9f]/g),s=!(!n||!n.length);var o=0,a=this.splitByGrapheme||s,h=[],l=[],c=a?j.util.string.graphemeSplit(e):e.split(this._wordJoiners),u="",d=0,f=a?"":" ",g=0,_=0,p=0,m=!0,v=this._getWidthOfCharSpacing();r=r||0,0===c.length&&c.push([]),i-=r;for(var y=0;y<c.length;y++)u=a?c[y]:j.util.string.graphemeSplit(c[y]),g=this._measureWord(u,t,d),d+=u.length,(o+=_+g-v)>i&&!m?(h.push(l),l=[],o=g,m=!0):o+=v,m||a||l.push(f),l=l.concat(u),_=a?0:this._measureWord([f],t,d),d++,m=!1,g>p&&(p=g);return y&&h.push(l),p+r>this.dynamicMinWidth&&(this.dynamicMinWidth=p-v+r),h});class se{constructor(e,t,i,r){let n,s;switch(this.mapMediaType_Style=new Map,this.mode="viewer",this.onSelectionChange=null,this._arrDrwaingItem=[],this._arrFabricObject=[],this._visible=!0,e.hasOwnProperty("getFabricCanvas")?this.fabricCanvas=e.getFabricCanvas():(this.fabricCanvas=new j.Canvas(e,Object.assign(r,{allowTouchScrolling:!0})),this.fabricCanvas.setDimensions({width:"100%",height:"100%"},{cssOnly:!0}),this.fabricCanvas.lowerCanvasEl.className="",this.fabricCanvas.upperCanvasEl.className="",this.fabricCanvas.on("selection:created",(function(e){const t=e.selected,i=[];for(let e of t){const t=e.getDrawingItem()._drawingLayer;t&&!i.includes(t)&&i.push(t)}for(let e of i){const i=[];for(let r of t){const t=r.getDrawingItem();t._drawingLayer===e&&i.push(t)}setTimeout((()=>{e.onSelectionChange&&e.onSelectionChange(i,[])}),0)}})),this.fabricCanvas.on("before:selection:cleared",(function(e){const t=this.getActiveObjects(),i=[];for(let e of t){const t=e.getDrawingItem()._drawingLayer;t&&!i.includes(t)&&i.push(t)}for(let e of i){const i=[];for(let r of t){const t=r.getDrawingItem();t._drawingLayer===e&&i.push(t)}setTimeout((()=>{const t=[];for(let r of i)e.hasDrawingItem(r)&&t.push(r);t.length>0&&e.onSelectionChange&&e.onSelectionChange([],t)}),0)}})),this.fabricCanvas.on("selection:updated",(function(e){const t=e.selected,i=e.deselected,r=[];for(let e of t){const t=e.getDrawingItem()._drawingLayer;t&&!r.includes(t)&&r.push(t)}for(let e of i){const t=e.getDrawingItem()._drawingLayer;t&&!r.includes(t)&&r.push(t)}for(let e of r){const r=[],n=[];for(let i of t){const t=i.getDrawingItem();t._drawingLayer===e&&r.push(t)}for(let t of i){const i=t.getDrawingItem();i._drawingLayer===e&&n.push(i)}setTimeout}),0)}})),this.fabricCanvas.wrapperEl.style.position="absolute",e.getFabricCanvas),this.id=t,this._mapDrawingStyles=i,t){case 1:n=i.get(1),s=i.get(5);break;case 2:n=i.get(2),s=i.get(6);break;case 3:n=i.get(3),s=i.get(7);break;default:n=i.get(4),s=i.get(8)}for(let e of q.arrMediaTypes)this.mapMediaType_Style.set(e,{default:n,selected:s})}getId(){return this.id}_getDrawingStyle(e,t){if("number"!=typeof e)throw new Error("Invalid style id.");const i=this._mapDrawingStyles.get(e);return i?t?JSON.parse(JSON.stringify(i)):i:null}setVisible(e){if(e){for(let e of this._arrFabricObject)e.visible=!0;this._visible=!0}else{for(let e of this._arrFabricObject)e.visible=!1;this._visible=!1}this.fabricCanvas.renderAll()}isVisible(){return this._visible}_getItemCurrentStyleId(e){return e.styleId?e.styleId:this.mapMediaType_Style.get(e._mediaType)[e.styleSelector].styleId}_getItemCurrentStyle(e){if(e.styleId)return this._getDrawingStyle(e.styleId);return e._mapStyle.get(e.styleSelector)||null}_changeMediaTypeCurStyleInStyleSelector(e,t,i,r){let n;switch(e){case"rect":n=this.fabricCanvas.getObjects("rect");break;case"arc":n=this.fabricCanvas.getObjects("circle");break;case"polygon":n=this.fabricCanvas.getObjects("polygon");break;case"image":n=this.fabricCanvas.getObjects("image");break;case"text":n=this.fabricCanvas.getObjects("textbox");break;case"line":n=this.fabricCanvas.getObjects("line");break;case"path":n=this.fabricCanvas.getObjects("path")}for(let e of n){if(!this._arrFabricObject.includes(e))continue;const r=e.getDrawingItem();r.styleSelector===t&&this._changeItemStyle(r,i,!0)}r||this.fabricCanvas.renderAll()}_changeItemStyle(e,t,i){if(!e||!t)return;const r=e._getFabricObject();"number"==typeof e.styleId&&(t=this._getDrawingStyle(e.styleId)),r.strokeWidth=t.lineWidth,"fill"===t.paintMode?(r.fill=t.fillStyle,r.stroke=t.fillStyle):"stroke"===t.paintMode?(r.fill="transparent",r.stroke=t.strokeStyle):"strokeAndFill"===t.paintMode&&(r.fill=t.fillStyle,r.stroke=t.strokeStyle),r.fontFamily&&(r.fontFamily=t.fontFamily),r.fontSize&&(r.fontSize=t.fontSize),r.group||(r.dirty=!0),i||this.fabricCanvas.renderAll()}_updateGroupItem(e,t,i){if(!e||!t)return;const r=e.getChildItems();if("add"===i){if(r.includes(t))return;const i=t._getFabricObject();if(this.fabricCanvas.getObjects().includes(i)){if(!this._arrFabricObject.includes(i))throw new Error("Existed in other drawing layers.");t._zIndex=null}else{let i;if(t.styleId)i=this._getDrawingStyle(t.styleId);else{i=this.mapMediaType_Style.get(t._mediaType)[e.styleSelector];const r=()=>{this._changeItemStyle(t,this.mapMediaType_Style.get(t._mediaType).selected,!0)},n=()=>{this._changeItemStyle(t,this.mapMediaType_Style.get(t._mediaType).default,!0)};t._on("selected",r),t._on("deselected",n),t._funcChangeStyleToSelected=r,t._funcChangeStyleToDefault=n}t._drawingLayer=this,t._drawingLayerId=this.id,this._changeItemStyle(t,i,!0)}e._fabricObject.addWithUpdate(t._getFabricObject())}else{if("remove"!==i)return;if(!r.includes(t))return;t._zIndex=null,t._drawingLayer=null,t._drawingLayerId=null,t._off("selected",t._funcChangeStyleToSelected),t._off("deselected",t._funcChangeStyleToDefault),t._funcChangeStyleToSelected=null,t._funcChangeStyleToDefault=null,e._fabricObject.removeWithUpdate(t._getFabricObject())}this.fabricCanvas.renderAll()}_addDrawingItem(e,t){let i=e._getFabricObject();const r=this.fabricCanvas.getObjects();let n,s;if(r.includes(i)){if(this._arrFabricObject.includes(i))return;throw new Error("Existed in other drawing layers.")}if("group"===e._mediaType){n=e.getChildItems();for(let e of n)if(e._drawingLayer&&e._drawingLayer!==this)throw new Error("The childItems of DT_Group have existed in other drawing layers.")}if(t&&"object"==typeof t&&!Array.isArray(t))for(let e in t)i.set(e,t[e]);if(n){for(let e of n){const t=this.mapMediaType_Style.get(e._mediaType);for(let i of q.arrStyleSelectors)e._mapStyle.set(i,t[i]);if(e.styleId)s=this._getDrawingStyle(e.styleId);else{s=t.default;const i=()=>{this._changeItemStyle(e,this.mapMediaType_Style.get(e._mediaType).selected,!0)},r=()=>{this._changeItemStyle(e,this.mapMediaType_Style.get(e._mediaType).default,!0)};e._on("selected",i),e._on("deselected",r),e._funcChangeStyleToSelected=i,e._funcChangeStyleToDefault=r}e._drawingLayer=this,e._drawingLayerId=this.id,this._changeItemStyle(e,s,!0)}i.dirty=!0,this.fabricCanvas.renderAll()}else{const t=this.mapMediaType_Style.get(e._mediaType);for(let i of q.arrStyleSelectors)e._mapStyle.set(i,t[i]);if(e.styleId)s=this._getDrawingStyle(e.styleId);else{s=t.default;const i=()=>{this._changeItemStyle(e,this.mapMediaType_Style.get(e._mediaType).selected)},r=()=>{this._changeItemStyle(e,this.mapMediaType_Style.get(e._mediaType).default)};e._on("selected",i),e._on("deselected",r),e._funcChangeStyleToSelected=i,e._funcChangeStyleToDefault=r}this._changeItemStyle(e,s)}e._zIndex=this.id,e._drawingLayer=this,e._drawingLayerId=this.id;const o=this._arrFabricObject.length;let a=r.length;if(o)a=r.indexOf(this._arrFabricObject[o-1])+1;else for(let t=0;t<r.length;t++)if(e._zIndex<r[t].getDrawingItem()._zIndex){a=t;break}this._arrDrwaingItem.push(e),this._arrFabricObject.push(i),this._visible?i.visible=!0:i.visible=!1,this.fabricCanvas.insertAt(i,a,!1)}addDrawingItem(e){if(!e||!e.isDrawingItem)throw TypeError("Illegal drawing item.");if("viewer"===this.mode)e._setEditable(!1);else{if("editor"!==this.mode)throw new Error("Illegal 'mode'.");e._setEditable(!0)}this._addDrawingItem(e)}addDrawingItems(e){for(let t of e)this.addDrawingItem(t)}removeDrawingItem(e){if(!e||!e.isDrawingItem)throw TypeError("Illegal drawing item.");if(!this.hasDrawingItem(e))return;if(e._zIndex=null,e._drawingLayer=null,e._drawingLayerId=null,"group"===e._mediaType){const t=e.getChildItems();for(let e of t)e._zIndex=null,e._drawingLayer=null,e._drawingLayerId=null,e._off("selected",e._funcChangeStyleToSelected),e._off("deselected",e._funcChangeStyleToDefault),e._funcChangeStyleToSelected=null,e._funcChangeStyleToDefault=null,e._mapStyle.clear()}else e._off("selected",e._funcChangeStyleToSelected),e._off("deselected",e._funcChangeStyleToDefault),e._funcChangeStyleToSelected=null,e._funcChangeStyleToDefault=null,e._mapStyle.clear();const t=e._getFabricObject();"selected"===e.styleSelector&&(t.group?t.group.removeWithUpdate(t):this.fabricCanvas._activeObject=null,e.styleSelector="default"),this.fabricCanvas.remove(t),this._arrDrwaingItem.splice(this._arrDrwaingItem.indexOf(e),1),this._arrFabricObject.splice(this._arrFabricObject.indexOf(t),1getDrawingItems(e){return e&&"function"==typeof e?this._arrDrwaingItem.filter(e):Array.from(this._arrDrwaingItem)}getSelectedDrawingItems(){const e=this.fabricCanvas.getActiveObjects(),t=[];for(let i of e)this._arrFabricObject.includes(i)&&t.push(i.getDrawingItem());return t}hasDrawingItem(e){if(!e||!e.isDrawingItem)throw TypeError("Illegal drawing item.");return this._arrDrwaingItem.includes(e}setDrawingStyle(e,t,i){t=t?t.toLocaleLowerCase():"all",i=i?i.toLocaleLowerCase():"all";let r,n=this._getDrawingStyle(e);if("all"===t){const e=this.mapMediaType_Style.keys();for(let t of e)if(r=this.mapMediaType_Style.get(t),"all"===i)for(let e of q.arrStyleSelectors){this._changeMediaTypeCurStyleInStyleSelector(t,e,n,!0),r[e]=n;for(let t of this._arrDrwaingItem)t._mapStyle.set(e,n)}else{this._changeMediaTypeCurStyleInStyleSelector(t,i,n,!0),r[i]=n;for(let e of this._arrDrwaingItem)e._mapStyle.set(i,n)}this.fabricCanvas.renderAll()}else if(r=this.mapMediaType_Style.get(t),"all"===i)for(let e of q.arrStyleSelectors){this._changeMediaTypeCurStyleInStyleSelector(t,e,n,!0),r[e]=n;for(let i of this._arrDrwaingItem)i._mediaType===t&&i._mapStyle.set(e,n)}else{this._changeMediaTypeCurStyleInStyleSelector(t,i,n,!0),r[i]=n;for(let e of this._arrDrwaingItem)e._mediaType===t&&e._mapStyle.set(i,n)}}setMode(e){if("viewer"===(e=e.toLocaleLowerCase())){for(let e of this._arrDrwaingItem)e._setEditable(!1);this.fabricCanvas.discardActiveObject(),this.fabricCanvas.renderAll(),this.mode="viewer"}else{if("editor"!==e)throw new RangeError("Invalid value.");for(let e of this._arrDrwaingItem)e._setEditable(!0);this.mode="editor"}this._manager._switchPointerEvent()}getMode(){return this.mod}_setObjectFit(e){if(e=e.toLowerCase(),!["contain","cover"].includes(e))throw new Error(`Unsupported value '${e}'.`);this.fabricCanvas.lowerCanvasEl.style.objectFit=e,this.fabricCanvas.upperCanvasEl.style.objectFit=}renderAll(){for(let e of this._arrDrwaingItem){const t=this._getItemCurrentStyle(e);this._changeItemStyle(e,t,!0)}this.fabricCanvas.renderAll()}dispose(){this.clearDrawingItems(),1===this._manager._arrDrawingLayer.length&&(this.fabricCanvas.wrapperEl.style.pointerEvents="none",this.fabricCanvas.dispose(),this._arrDrwaingItem.length=0,this._arrFabricObject.length=0)}}class oe{constructor(){this._arrDrawingLayer=[],this._mapDrawingStyles=new Map([[1,{id:1,lineWidth:4,fillStyle:"rgba(73, 173, 245, 0.3)",strokeStyle:"rgba(73, 173, 245, 1)",paintMode:"stroke",fontFamily:"consolas",fontSize:40}],[2,{id:2,lineWidth:2,fillStyle:"rgba(73, 245, 73, 0.3)",strokeStyle:"rgba(73, 245, 73, 0.9)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[3,{id:3,lineWidth:2,fillStyle:"rgba(254, 180, 32, 0.3)",strokeStyle:"rgba(254, 180, 32, 0.9)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[4,{id:4,lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"stroke",fontFamily:"consolas",fontSize:40}],[5,{id:5,lineWidth:4,fillStyle:"rgba(73, 173, 245, 0.3)",strokeStyle:"rgba(73, 173, 245, 1)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[6,{id:6,lineWidth:2,fillStyle:"rgba(73, 245, 73, 0.3)",strokeStyle:"rgba(73, 245, 73, 0.9)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[7,{id:7,lineWidth:2,fillStyle:"rgba(254, 180, 32, 0.3)",strokeStyle:"rgba(254, 180, 32, 1)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[8,{id:8,lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}]]),this._defaultStyleTemplate={lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"stroke",fontFamily:"consolas",fontSize:40}}createDrawingStyle(e){if(!e)throw new Error("Invalid style definition.");let t;if(e.hasOwnProperty("id")){if(this._mapDrawingStyles.has(e.id))throw new Error("Existing drawing style id.");t=e.id}else{let e=100;for(;this._mapDrawingStyles.has(e);)e++;t=e}const i=JSON.parse(JSON.stringify(e));i.id=t;for(let e in this._defaultStyleTemplate)i.hasOwnProperty(e)||(i[e]=this._defaultStyleTemplate[e]);return this._mapDrawingStyles.set(t,i),i.id}_getDrawingStyle(e,t){if("number"!=typeof e)throw new Error("Invalid style id.");const i=this._mapDrawingStyles.get(e);return i?t?JSON.parse(JSON.stringify(i)):i:nul}getDrawingStyles(){return JSON.parse(JSON.stringify(Array.from(this._mapDrawingStyles.values())))}_updateDrawingStyle(e,t){const i=this._mapDrawingStyles.get(e);if(i)for(let e in t)i.hasOwnProperty(e)&&(i[e]=t[e])}updateDrawingStyle(e,t){this._updateDrawingStyle(e,t);for(let e of this._arrDrawingLayer)e.renderAll()}createDrawingLayer(e,t){const i=e=>{for(let t of this._arrDrawingLayer)if(t.getId()===e)return!0;return!1};if(void 0===t){for(let e=100;;e++)if(!i(e)){t=e;break}}else if(i(t))throw new Error("Existed drawing layer id.");const r=new se(e,t,this._mapDrawingStyles,{enableRetinaScaling:!1});return r._manager=this,this._arrDrawingLayer.push(r),this._switchPointerEvent(),r}deleteDrawingLayer(e){const t=this.getDrawingLayer(e);if(!t)return;const i=this._arrDrawingLayer;t.dispose(),i.splice(i.indexOf(t),1),this._switchPointerEvent()}clearDrawingLayers(){for(let e of this._arrDrawingLayer)e.dispose();this._arrDrawingLayer.length=0}getDrawingLayer(e){for(let t of this._arrDrawingLayer)if(t.getId()===e)return t;return nul}getSelectedDrawingItems(){if(!this._arrDrawingLayer.length)return;const e=this._arrDrawingLayer[0].fabricCanvas.getActiveObjects(),t=[];for(let i of e)t.push(i.getDrawingItem());return t}setDimensions(e,t){this._arrDrawingLayer.length&&this._arrDrawingLayer[0]._setDimensions(e,t)}setObjectFit(e){for(let t of this._arrDrawingLayer)t&&t._setObjectFit(e)}getObjectFit(){return this._arrDrawingLayer.length?this._arrDrawingLayer[0]._getObjectFit():null}setVisible(e){this._arrDrawingLayer.length&&(this._arrDrawingLayer[0].fabricCanvas.wrapperEl.style.display=e?"block":"none")}_switchPointerEvent(){if(this._arrDrawingLayer.length)for(let e of this._arrDrawingLayer)e.getMode()}}class ae{constructor(e){this._controlTarget=null,this._arrUsers=[],this._mapAction_UserArgs=new Map,this._mapProperty_UserValue=new Map,this._mapAction_Callbacks=new Map,this._controlTarget=e}setControlTarget(e){this._controlTarget=e}getControlTarget(){return this._controlTarge}logout(e){const t=this._arrUsers.indexOf(e);-1!==t&&(this.clearUserDisiredAction({user:e}),this.clearUserDisiredValue({user:e}),this._arrUsers.splice(t,1))}getRegisteredUsers(){return this._arrUsers}ifUserExisted(e){return this._arrUsers.includes(e)}setDisiredValue(e,t,i,r){if(!this._arrUsers.includes(e))throw new Error("Unregistered user.");r&&(this._controlTarget[t]=i),this._mapProperty_UserValue.get(t)?this._mapProperty_UserValue.get(t).set(e,i):this._mapProperty_UserValue.set(t,new Map([[e,i]]))}clearUserDisiredValue(e){if(e&&(e.user||e.property)){if(e.property&&e.user){const t=this._mapProperty_UserValue.get(e.property);if(!t)return;t.delete(e.user)}else if(e.property)this._mapProperty_UserValue.delete(e.property);else if(e.user)for(let t of this._mapProperty_UserValue.values())t.delete(e.user)}else this._mapProperty_UserValue=new Map}getValue(e){if(!this._controlTarget)throw new Error("Control target is not set.");return this._controlTarget[e]}getPropertyDisiredValue(e){if(this._mapProperty_UserValue.get(e)){const t=[],i=this._mapProperty_UserValue.get(e);for(let e of i.values())t.push(e);return t}return null}setDisiredAction(e,t,i,r){if(!this._arrUsers.includes(e))throw new Error("Unregistered user.");return i||(i=[]),r?this._controlTarget[t](...i):(this._mapAction_UserArgs.get(t)?this._mapAction_UserArgs.get(t).set(e,i):this._mapAction_UserArgs.set(t,new Map([[e,i]])),this._render(t))}clearUserDisiredAction(e){if(e&&(e.user||e.actionName)){if(e.actionName&&e.user){const t=this._mapAction_UserArgs.get(e.actionName);if(!t)return;t.delete(e.user)}else if(e.actionName)this._mapAction_UserArgs.delete(e.actionName);else if(e.user)for(let t of this._mapAction_UserArgs.values())t.delete(e.user);this.render()}else this._mapAction_UserArgs=new Ma}removeCallback(e,t){const i=this._mapAction_Callbacks.get(e);if(!i)return;const r=i.indexOf(t);-1!==r&&i.splice(r,1}_fireCallback(e){const t=this._mapAction_Callbacks.get(e);if(t)for(let e of t){if(!e)return;setTimeout(e.bind(this._controlTarget),0)}}_render(e){const t=this._mapAction_UserArgs.get(e);if(!t)throw new Error("Unrecorded action.");if(t.size===this._arrUsers.length){let i=[];for(let e of t.values())e.length>0&&(i=e);if(this._controlTarget[e]){const t=this._controlTarget[e](...i);return this._mapAction_UserArgs.delete(e),this._fireCallback(e),t}}}render(e){if(e)return this._render(e);for(let e of this._mapAction_UserArgs.keys())this._render(e)}}class he{static multiply(e,t){const i=[];for(let r=0;r<3;r++){const n=t.slice(3*r,3*r+3);for(let t=0;t<3;t++){const r=[e[t],e[t+3],e[t+6]].reduce]),0);i.push(r)}}return }static translate(e,t,i){return he.multiply(e,[1,0,0,0,1,0,t,i,1])}static rotate(e,t){var i=Math.cos(t),r=Math.sin(t);return he.multiply(e,[i,-r,0,r,i,0,0,0,1])}static scale(e,t,i){return he.multiply(e,[t,0,0,0,i,0,0,0,1])}}var le}(le||(le={}));const ce=(e,t,i,r)=>{let n=t+Math.round((e-t)/i)*i;return r&&(n=Math.min(n,r)),n};class ue{constructor(){this._maxCvsSideLength=void 0,this._defaultMaxCvsSideLength=null,this._predefinedResolutions=[{width:160,height:120},{width:320,height:240},{width:480,height:360},{width:640,height:480},{width:800,height:600},{width:960,height:720},{width:1280,height:720},{width:1920,height:1080},{width:2560,height:1440},{width:3840,height:2160}],this._mapCameraResolutions=new Map,this._bWebGLSupported=!0,this.extraBindings=[],this._singleFrameMode=!(navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia),this._cvsSingleFrameMode=null,this._cvsOriginalImage=null,this._imgWidth=0,this._imgHeight=0,this._singleFrameModeIpt=null,this._clickIptSingleFrameMode=()=>{if(this.singleFrameMode&&!this.getDrawingLayers().some((e=>"editor"==e.getMode()))){if(!this._singleFrameModeIpt){const e=document.createElement("input");this._singleFrameModeIpt=e,e.setAttribute("type","file"),e.setAttribute("accept",".jpg,.jpeg,.icon,.gif,.svg,.webp,.png,.bmp"),e.setAttribute("capture",""),e.addEventListener("change",(async()=>{const t=e.files[0];e.value="";const i=await(async e=>{let t=null,i=null;if("undefined"!=typeof createImageBitmap)try{if(t=await createImageBitmap(e),t)return t}catch(e){}var r;return t||(i=await(r=e,new Promise(((e,t)=>{let i=URL.createObjectURL(r),n=new Image;n.dbrObjUrl=i,n.src=i,n.onloa},n.onerror=e=>{t(new Error("Can't convert blob to image : "+(e instanceof Event?e.type:e)))}})))),i})(t),r=i instanceof HTMLImageElement?i.naturalWidth:i.width,n=i instanceof HTMLImageElement?i.naturalHeight:i.height;this._imgWidth=r,this._imgHeight=n;const s=e=>{const t=Date.now();if(0===r||0===n)return null;if(e instanceof HTMLImageElement&&!e.complete)throw new Error("The source is not loaded.");const i=this._scanRegion,s=this.getFrameSize(r,n,i,this.maxCvsSideLength);if(!s)return null;let o=!0;r===s.sWidth&&n===s.sHeight&&(o=!1);const a=this.mapPixelFormatString_Enum.get(this.framePixelFormat.toLowerCase()),h={data:null,region:i?JSON.parse(JSON.stringify(i)):null,sx:s.sx,sy:s.sy,width:s.dWidth,height:s.dHeight,colorMode:null,pixelFormat:null,timeSpent:null,timeStamp:null,isCropped:o,toCanvas:this._toCanvas,_sWidth:s.sWidth,_sHeight:s.sHeight,_bUseWebGL:null},l=this._getImageData(e,r,n,s,null,{pixelFormat:a});if(!l)return null;const c=Date.now();return h.data=l.data,h.pixelFormat=h.colorMode=l.pixelFormat,h._bUseWebGL=l._bUseWebGL,h.timeSpent=c-t,h.timeStamp=c,l.pixelFormat===le.GREY?h.stride=h.width:h.stride=4*h.width,h};(e=>{let t=this._cvsSingleFrameMode;if(!t){if(t=document.createElement("canvas"),!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(t),t.style.position="absolute",t.style.width="100%",t.style.height="100%",t.style.left="0",t.style.top="0",t.style.objectFit="contain",t.style.pointerEvents="none",this._cvsSingleFrameMode=t}t.width==r&&t.height==n||(t.width=r,t.height=n);const i=t.getContext("2d");i.clearRect(0,0,t.width,t.height),i.drawImage(e,0,0)})(i),this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let e of this._arrScanRegionOverlays)e&&this._updateScanRegionOverlay(e);let o;this._updateDrawingLayersSize();try{o=s(i)}catch(e){throw e}const a=this.mapCameraEvents.get("singleframeacquired");for(let e of a)if(e)try{const t={data:new Uint8Array(o.data),region:JSON.parse(JSON.stringify(o.region)),sx:o.sx,sy:o.sy,width:o.width,height:o.height,stride:o.stride,colorMode:o.colorMode,pixelFormat:o.pixelFormat,timeSpent:o.timeSpent,timeStamp:o.timeStamp,isCropped:o.isCropped,toCanvas:o.toCanvas,_sWidth:o._sWidth,_sHeight:o._sHeight,_bUseWebGL:o._bUseWebGL};await e.apply(this,[t])}catch(e){console.error(e)}})),e.style.position="fixed",e.style.left="-1px",e.style.top="-1px",e.style.width="1px",e.style.height="1px",e.style.backgroundColor="transparent",e.style.color="transparent",document.body.appendChild(e)}this._singleFrameModeIpt.click()}},this.styleEls=[],this._framePixelFormat=void 0,this._defaultFramePixelFormat="rgba",this.mapPixelFormatString_Enum=new Map([["grey",le.GREY],["grey32",le.GREY32],["rgba",le.RGBA],["rbga",le.RBGA],["grba",le.GRBA],["gbra",le.GBRA],["brga",le.BRGA],["bgra",le.BGRA]]),this.shaderPixelFormat=le.RGBA,this.maxVideoCvsLength=3,this._reusedCvs=null,this._reusedWebGLCvs=null,this._tempDataContainer=null,this._webGLTexture=null,this._webGLProgramInfo=null,this._webGLBuffers=null,this._softwareScale=1,this._scaleCenter={x:0,y:0},this._focusParameters={maxTimeout:400,minTimeout:300,kTimeout:void 0,oldDistance:null,fds:null,isDoingFocus:0,taskBackToContinous:null,curFocusTaskId:0,focusCancelableTime:1500,defaultFocusAreaSizeRatio:6,focusBackToContinousTime:5e3,tapFocusMinDistance:null,tapFocusMaxDistance:null,_focusArea:null},this._tapFocusEnabled=!0,this._focusSupported=!0,this._tapDoFocus=async e=>{if(this._touchMoved)return void(this._touchMoved=!1);if(!this._tapFocusEnabled)return;if(!this._bOpen)return;if(this.singleFrameMode)return;if(!this._video||this._video.paused)return;if(!this._videoTrack)return;if(!this._focusSupported)return;if(this.getDrawingLayers().some))))return;if(!this._focusParameters.fds&&(this._focusParameters.fds=(await this.getCapabilities()).focusDistance,!this._focusParameters.fds))return void(this._focusSupported=!1);if(null==this._focusParameters.kTimeout&&(this._focusParameters.kTimeout=(this._focusParameters.maxTimeout-this._focusParameters.minTimeout)/(1/this._focusParameters.fds.min-1/this._focusParameters.fds.max)),1==this._focusParameters.isDoingFocus)return;let t,i,r,n;if(this._focusParameters.taskBackToContinous&&(clearTimeout(this._focusParameters.taskBackToContinous),this._focusParameters.taskBackToContinous=null),e instanceof MouseEvent)t=e.clientX,i=e.clientY;else{if(!(e instanceof TouchEvent))throw new Error("Unknown event type.");if(!e.changedTouches.length)return;t=e.changedTouches[0].clientX,i=e.changedTouches[0].clientY}const s=this.getVideoFit(),o=this._video.videoWidth,a=this._video.videoHeight,h=this._elContainer.getBoundingClientRect(),l=h.left,c=h.top,u=window.getComputedStyle(this._elContainer),d=parseFloat(u.width),f=parseFloat(u.height),g=d/f,_=o/a;let p=1;if("contain"===s)_>g?(p=d/o,r=(t-l)/p,n=(i-c-(f-d/_)/2)/p):(p=f/a,n=(i-c)/p,r=(t-l-(d-f*_)/2)/p);else{if("cover"!==s)throw new Error("Unsupported object-fit.");_>g?(p=f/a,n=(i-c)/p,r=(t-l+(f*_-d)/2)/p):(p=d/o,r=(t-l)/p,n=(i-c+(d/_-f)/2)/p)}const m={x:r+"px",y:n+"px"},v=2*Math.round(Math.min(o,a)/this._focusParameters.defaultFocusAreaSizeRatio/2)+"px",y=v;await this._setLocalFocus(m,v,y,this._focusParameters.tapFocusMinDistance,this._focusParameters.tapFocusMaxDistance),this._focusParameters.taskBackToContinous=setTimeout((()=>{this._videoTrack&&this._videoTrack.applyConstraints({advanced:[{focusMode:"continuous"}]}).catch}))}),this._focusParameters.focusBackToContinousTime)},this._touchMoved=!1,this._touchMoveEven},this._recordedStates={},this.playCallbackInfo=null,this._toCanvas=function(){const e=document.createElement("canvas");let t;if(e.width=this.width,e.height=this.height,"grey"===(this.pixelFormat||this.colorMode)){t=new Uint8ClampedArray(this.width*this.height*4);for(let e=0;e<t.length;e+=4)t[e]=this.data[e/4],t[e+1]=this.data[e/4],t[e+2]=this.data[e/4],t[e+3]=255}else t=new Uint8ClampedArray(this.data.buffer);const i=new ImageData(t,this.width,this.height);return e.getContext("2d").putImageData(i,0,0),e},this._onCameraSelChange=async()=>{await this.selectCamera(this._selCam.value),this._bOpen||this.stop()},this._onResolutionSelChange=async()=>{let e,t;if(this._selRsl&&-1!=this._selRsl.selectedIndex){let i=this._selRsl.options[this._selRsl.selectedIndex];e=i.getAttribute("data-width"),t=i.getAttribute("data-height")}await this.setResolution(e,t),this._bOpen||this.stop()},this._onCloseBtnClic},this._bOpen=!1,this.isCameraEnhancer=!0,this.isDisposed=!1,this.disposed=!1,this.videoSrc=null,this.videoSettings={video:{width:{ideal:1280},height:{ideal:720},facingMode:{ideal:"environment"}}},this.iPlayRound=0,this.promisePlay=null,this._ifSaveLastUsedCamera=!1,this.ifSkipCameraInspection=!1,this._allCameras=[],this._currentCamera=null,this._videoTrack=null,this._lastDeviceId=void 0,this._vc_bPlayingVideoBeforeHide=!1,this._ev_documentHideEvent=()=>{if(!this.singleFrameMode)if("visible"===document.visibilityState){if(ue._onLog&&ue._onLog("DCE: document visible."),this._bOpen&&this._vc_bPlayingVideoBeforeHide)if(this.videoSrc)this._video.play();else if(this._video.srcObject){const e=this._video.srcObject.getTracks()[0];this._video.srcObject.active&&e&&!e.muted?this._video.play():this.play()}}else"hidden"===document.visibilityState&&(ue._onLog&&ue._onLog("DCE: document hidden."),["iPhone","iPad"].includes(Y.OS)?(this._vc_bPlayingVideoBeforeHide=!0,this._video&&this._video.pause()):this._video&&!this._video.paused?(this._vc_bPlayingVideoBeforeHide=!0,this._video.pause()):this._vc_bPlayingVideoBeforeHide=!1)},this.containerClassName="dce-video-container",this._elContainer=null,this._videoContainer=null,this._video=null,this.videoFit="contain",this._cvsScanRegion=null,this._divScanArea=null,this._divScanLight=null,this._bgLoading=null,this._selCam=null,this._bgCamera=null,this._selRsl=null,this._optGotRsl=null,this._btnClose=null,this._selMinLtr=null,this._optGotMinLtr=null,this.regionMaskFillStyle="rgba(0,0,0,0.5)",this.regionMaskStrokeStyle="rgb(254,142,20)",this.regionMaskLineWidth=2,this._bShowScanRegionMask=!0,this._bShowScanRegionLaser=void 0,this._defaultBShowScanRegionLaser=!1,this._scanRegion=null,this._arrScanRegionOverlays=[],this._layerBaseCvs=null,this._drawingLayerOfTip=null,this._tipArgs={x:void 0,y:void 0,width:void 0,duration:void 0,autoShowSuggestedTip:void 0},this._hideTipTimeoutId=null,this.onTipSuggested=null,this._cvsViewDecorator=null,this._decoratorType=[],this._decoratorArea=null,this._viewDecoratorInfo={rectangle:{lineWidth:4,strokeStyle:"rgb(254,142,20)",fillStyle:"transparent",maskFillStyle:"transparent"},focus:{lineWidth:4,strokeStyle:"rgb(254,142,20)",fillStyle:"transparent",maskFillStyle:"transparent"},crossline:{lineWidth:2,strokeStyle:"rgb(254,142,20)"},crosshair:{lineWidth:4,strokeStyle:"rgb(254,142,20)"}},this._croppingRegions=void 0,this._defaultCroppingRegions=[null],this.bIncreaseRegionIndexAuto=!0,this._croppingRegionIndex=0,this._loopInterval=void 0,this._defaultLoopInterval=0,this._maxNumberOfFramesInBuffer=void 0,this._defaultMaxNumberOfFramesInBuffer=1,this._frameQueue=[],this._bFetchingLoopStarted=!1,this._refreshInterval=void 0,this._defaultRefreshInterval=-1,this._updateLayersTimeout=500,this._updateLayers=()=>{this._cvsScanRegion&&(this._cvsScanRegion.style.display="none"),this._divScanLight&&(this._divScanLight.style.display="none"),this._cvsViewDecorator&&(this._cvsViewDecorator.style.display="none");for(let e of this._arrScanRegionOverlays)e&&(e.style.display="none");this._resizeTimeoutId&&clearTimeout(this._resizeTimeoutId),this._resizeTimeoutId=setTimeout((()=>{if(!this.isDisposed||!this.disposed){this.ifShowScanRegionMask&&this.showScanRegionMask(),this.ifShowScanRegionLaser&&this.showScanRegionLaser(),this._cvsViewDecorator&&this.showViewDecorator(),this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let e of this._arrScanRegionOverlays)e&&(e.style.display="",this._updateScanRegionOverlay(e));this._updateDrawingLayersSize(),this._updateVideoContainerStyle()}}),this._updateLayersTimeout)},this._windowResizeListene},this.mapCameraEvents=new Map([["cameraopen",[]],["cameraclose",[]],["camerachange",[]],["resolutionchange",[]],["played",[]],["singleframeacquired",[]],["frameaddedtobuffer",[]]]),this._controler=null}static getVersion(){return this._version}static async detectEnvironment(){return await(async()=>({wasm:X,worker:z,getUserMedia:Z,camera:await J(),browser:Y.browser,version:Y.version,OS:Y.OS}))()}static set engineResourcePath(e){if(this._hasEngineResourceLoaded)throw new Error("`engineResourcePath` is not allowed to change after `createInstance` is called.");ue._engineResourcePath=(e=>{if(null==e&&(e="./"),!V){let t=document.createElement("a");t.href=e,e=t.href}return e.endsWith("/")||(e+="/"),e})(e)}static get engineResourcePath(){return this._engineResourcePat}static isDCEFrame(e){return!(!e||"object"!=typeof e||Array.isArray(e))&&"data"in e&&"region"in e&&"sx"in e&&"sy"in e&&"width"in e&&"height"in e&&("colorMode"in e||"pixelFormat"in e)&&"timeSpent"in e&&"timeStamp"in e&&"isCropped"in e&&"toCanvas"in e&&"_sWidth"in e&&"_sHeight"in e&&"_bUseWebGL"in e}static async testCameraAccess(){try{if(!navigator||!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return{ok:!1,message:"Insecure context."};(await navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach((e=>{e.stop()}))}catch(e){if("OverconstrainedError"===e.name||"NotFoundError"===e.name)return{ok:!1,message:"No camera detected."};if("NotAllowedError"===e.name)return{ok:!1,message:"No permission to access camera."};if("AbortError"===e.name)return{ok:!1,message:"Some problem occurred which prevented the device from being used."};if("NotReadableError"===e.name)return{ok:!1,message:"A hardware error occurred."};if("SecurityError"===e.name)return{ok:!1,message:"User media support is disabled."};throw e}return{ok:!0,message:"Successfully accessed the camera."}}set maxCvsSideLength(e){if(e<=0)throw new Error("Invalid value.");this._maxCvsSideLength=e}get maxCvsSideLength(){if(void 0!==this._maxCvsSideLength)return this._maxCvsSideLength;if(this._controler){const e=this._controler.getPropertyDisiredValue("maxCvsSideLength");if(e&&1===e.length)return e[0]}return this._defaultMaxCvsSideLengt}static get defaultUIElementURL(){var e;return null===(e=ue._defaultUIElementURL)||void 0===e?void 0:e.replace("@engineResourcePath/",ue.engineResourcePath)}getUIElement(){return this.UIElement}async setUIElement(e){if(this._bOpen)throw new Error("It is not allowed to change the UIElement when the camera is open.");if("string"==typeof e||e instanceof String){if(!e.trim().startsWith("<")){let t=await fetch(e);if(!t.ok)throw Error("setUIElement(elementOrUrl): Network Error: "+t.statusText);e=await t.text()}if(!e.trim().startsWith("<"))throw Error("setUIElement(elementOrUrl): Can't get valid HTMLElement.");let t=document.createElement("div");t.innerHTML=e;for(let e=0;e<t.childElementCount;++e){let i=t.children[e];i instanceof HTMLStyleElement&&(this.styleEls.push(i),document.head.append(i))}(e=1==t.childElementCount?t.children[0]:t).remove()}this.UIElement=e,this._uiOriginalState={display:e&&e.style.display,inDom:document.body.contains(e)}}appendAndShowUI(){this.UIElement&&(this.UIElement.parentNode||(this.UIElement.style.position="fixed",this.UIElement.style.left="0",this.UIElement.style.top="0",document.body.append(this.UIElement)),"none"==this.UIElement.style.display&&(this.UIElement.style.display="")}get singleFrameMode(){return this._singleFrameMod}set frameColorMode(e){this._framePixelFormat=e}get frameColorMode(){if(void 0!==this._framePixelFormat)return this._framePixelFormat;if(this._controler){const e=this._controler.getPropertyDisiredValue("framePixelFormat")||this._controler.getPropertyDisiredValue("frameColorMode");if(e&&1===e.length)return e[0]}return this._defaultFramePixelFormat}set framePixelFormat(e){this._framePixelFormat=e}get framePixelFormat(){if(void 0!==this._framePixelFormat)return this._framePixelFormat;if(this._controler){const e=this._controler.getPropertyDisiredValue("framePixelFormat")||this._controler.getPropertyDisiredValue("frameColorMode");if(e&&1===e.length)return e[0]}return this._defaultFramePixelFormat}set bOpen(e){if(this._bOpen=e,e){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let e of this._arrScanRegionOverlays)e&&this._updateScanRegionOverlay(e);this._updateDrawingLayersSize(),this.ifShowScanRegionMask?this.showScanRegionMask():this.hideScanRegionMask(),this.ifShowScanRegionLaser?this.showScanRegionLaser():this.hideScanRegionLaser(),this.showViewDecorator(),this.showScanRegionOverlays(),this._drawingLayersManager.setVisible(!0)}else this._softwareScale=1}set ifSaveLastUsedCamera(e){e?ue.isStorageAvailable("localStorage")?this._ifSaveLastUsedCamera=!0:(this._ifSaveLastUsedCamera=!1,console.warn("Local storage is unavailable")):this._ifSaveLastUsedCamera=!1}get ifSaveLastUsedCamera(){return this._ifSaveLastUsedCamera}get video(){return this._video}setVideoFit(e){if(e=e.toLowerCase(),!["contain","cover"].includes(e))throw new Error(`Unsupported value '${e}'.`);if(this.videoFit=e,this._video&&(this._video.style.objectFit=e,!this.singleFrameMode)){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let e of this._arrScanRegionOverlays)e&&this._updateScanRegionOverlay(e);this._updateVideoContainerStyle(),this._drawingLayersManager.setObjectFit(e)}}getVideoFit(){return this.videoFit}_showElClassName(){this._cvsScanRegion&&this._cvsScanRegion.classList.add("cvs-scan-region-mask"),this._cvsViewDecorator&&this._cvsViewDecorator.classList.add("cvs-view-decorator"),this._scanRegionOverlayContainer&&this._scanRegionOverlayContainer.classList.add("div-scan-region-overlay-container"),this._layerBaseCvs&&this._layerBaseCvs.classList.add("cvs-drawing-layer-base"),this._layerBaseCvs&&this._layerBaseCvs.parentElement.classList.add("div-drawing-layer-container"),this._cvsOriginalImage&&this._cvsOriginalImage.classList.add("cvs-original-image"),this._cvsSingleFrameMode&&this._cvsSingleFrameMode.classList.add("cvs-single-frame")}_hideElClassName(){this._cvsScanRegion&&this._cvsScanRegion.classList.remove("cvs-scan-region-mask"),this._cvsViewDecorator&&this._cvsViewDecorator.classList.remove("cvs-view-decorator"),this._scanRegionOverlayContainer&&this._scanRegionOverlayContainer.classList.remove("div-scan-region-overlay-container"),this._layerBaseCvs&&this._layerBaseCvs.classList.remove("cvs-drawing-layer-base"),this._layerBaseCvs&&this._layerBaseCvs.parentElement.classList.remove("div-drawing-layer-container"),this._cvsOriginalImage&&this._cvsOriginalImage.classList.remove("cvs-original-image"),this._cvsSingleFrameMode&&this._cvsSingleFrameMode.classList.remove("cvs-single-frame")}set ifShowScanRegionMask(e){this._bShowScanRegionMask=e,e?this.showScanRegionMask():this.hideScanRegionMask()}get ifShowScanRegionMask(){return this._bShowScanRegionMask}showScanRegionMask(){this._cvsScanRegion&&("none"==this._cvsScanRegion.style.display&&(this._cvsScanRegion.style.display=""),this._recordedStates.maskShow=!0)}hideScanRegionMask(){this._cvsScanRegion&&(this._cvsScanRegion.style.display="none",this._recordedStates.maskShow=!1)}set ifShowScanRegionLas}get ifShowScanRegionLaser(){if(void 0!==this._bShowScanRegionLaser)return this._bShowScanRegionLaser;if(this._controler){const e=this._controler.getPropertyDisiredValue("ifShowScanRegionLaser");if(e&&e.length){let t=0;for(let i of e)i||t++;return t!==this._controler.getRegisteredUsers().length}}return this._defaultBShowScanRegionLaser}showScanRegionLaser(){this._divScanLight&&("none"==this._divScanLight.style.display&&(this._divScanLight.style.display="block"),this._recordedStates.laserShow=!0)}hideScanRegionLaser(){this._divScanLight&&(this._divScanLight.style.display="none",this._recordedStates.laserShow=!1)}_checkValidRegion(e){return!(null!==e&&(!e||!(e.hasOwnProperty("regionLeft")&&e.hasOwnProperty("regionTop")&&e.hasOwnProperty("regionRight")&&e.hasOwnProperty("regionBottom")&&e.hasOwnProperty("regionMeasuredByPercentage"))||e.regionLeft<0||e.regionTop<0||e.regionRight<0||e.regionBottom<0||e.regionMeasuredByPercentage&&(e.regionLeft>100||e.regionTop>100||e.regionRight>100||e.regionBottom>100)))}set scanRegion(e){if(!this._checkValidRegion(e))throw new Error("Invalid region.");this._scanRegion=JSON.parse(JSON.stringify(e)),this._updateScanRegionCanvas(),this._updateScanAreaDiv();for(let e of this._arrScanRegionOverlays)e&&this._updateScanRegionOverlay(e)}setScanRegion(e){this.scanRegion=}_calculateCvsSize(){if(!this._bOpen)return null;let e,t,i;if(this.singleFrameMode)e=this._imgWidth,t=this._imgHeight,i="contain";else{if(!this._video)return null;e=this._video.videoWidth,t=this._video.videoHeight,i=this.getVideoFit()}return e<=0||t<=0?null:{width:e,height:t,objectFit:i}}addScanRegionOverlayCanvas(){this._assertOpen();const e=document.createElement("canvas");if(this._updateScanRegionOverlay(e),!this._scanRegionOverlayContainer){const e=document.createElement("div");if(this._scanRegionOverlayContainer=e,e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="100%",e.style.height="100%",e.style.overflow="hidden",e.style.pointerEvents="none",this._layerBaseCvs)this._layerBaseCvs.parentElement.after(e);else if(this._cvsScanRegion)this._cvsScanRegion.after(e);else if(this._cvsOriginalImage)this._cvsOriginalImage.after(e);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(e);else{if(!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(e)}this._recordedStates.overlayShow=!0}return this._scanRegionOverlayContainer.append(e),this._arrScanRegionOverlays.push(e),}_updateScanRegionOverlay(e){if(!e)return;const t=this._calculateCvsSize();if(!t)return;const{width:i,height:r,objectFit:n}=t;if(i<=0||r<=0)return e.width=0,void(e.height=0);const s=this._getRegionInPixels(i,r,this._scanRegion),o=this.getFrameSize(i,r,this._scanRegion,this.maxCvsSideLength),a=o.dWidth,h=o.dHeight;e.width==a&&e.height==h||(e.width=a,e.height=h);const l=window.getComputedStyle(this._elContainer),c=parseFloat(l.width),u=parseFloat(l.height),d=c/u,f=i/r;let g,_,p,m,v=1;"contain"===n?(f>d?(v=c/i,g=0,_=(u-r*v)/2):(v=u/r,g=(c-i*v)/2,_=0),g+=s.regionLeft*v,_+=s.regionTop*v,p=(s.regionRight-s.regionLeft)*v,m=(s.regionBottom-s.regionTop)*v):"cover"===n?(f>d?(v=u/r,g=s.regionLeft*v-(i*v-c)/2,_=s.regionTop*v):(v=c/i,g=s.regionLeft*v,_=s.regionTop*v-(r*v-u)/2),p=(s.regionRight-s.regionLeft)*v,m=(s.regionBottom-s.regionTop)*v):(g=0,_=0,p=0,m=0),e.style.position="absolute",e.style.left=g+"px",e.style.top=_+"px",e.style.width=p+"px",e.style.height=m+"px"}showScanRegionOverlays(){this._scanRegionOverlayContainer&&("none"==this._scanRegionOverlayContainer.style.display&&(this._scanRegionOverlayContainer.style.display=""),this._recordedStates.overlayShow=!0)}hideScanRegionOverlays(){this._scanRegionOverlayContainer&&(this._scanRegionOverlayContainer.style.display="none",this._recordedStates.overlayShow=!1)}setViewDecorator(e,t){if(!e)return void(this._cvsViewDecorator&&(this._cvsViewDecorator.remove(),this._cvsViewDecorator=null));if(!t)throw new Error("Invalid area.");this._assertOpen();let i=[];if("string"==typeof e?i.push(e):Array.isArray(e)&&(i=JSON.parse(JSON.stringify(e))),!this._cvsViewDecorator){if(this._cvsViewDecorator=document.createElement("canvas"),this._scanRegionOverlayContainer)this._scanRegionOverlayContainer.after(this._cvsViewDecorator);else if(this._layerBaseCvs)this._layerBaseCvs.parentElement.after(this._cvsViewDecorator);else if(this._cvsScanRegion)this._cvsScanRegion.after(this._cvsViewDecorator);else if(this._cvsOriginalImage)this._cvsOriginalImage.after(this._cvsViewDecorator);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(this._cvsViewDecorator);else{if(!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(this._cvsViewDecorator)}this._recordedStates.decoratorShow=!0}this._decoratorArea=JSON.parse(JSON.stringify(t)),this._decoratorType.length=0;const r=["rectangle","focus"],n=["crossline","crosshair"];let s=!1,o=!1;for(let e of i)e=e.toLowerCase(),r.includes(e)&&!s&&(s=!0,this._decoratorType.push(e)),n.includes(e)&&!o&&(o=!0,!this._decoratorType.includes(e)&&this._decoratorType.push(e));this._updateViewDecorator()}getViewDecorator(){return{type:JSON.parse(JSON.stringify(this._decoratorType)),area:JSON.parse(JSON.stringify(this._decoratorArea)),canvas:this._cvsViewDecorator}}showViewDecorator(){this._cvsViewDecorator&&("none"==this._cvsViewDecorator.style.display&&(this._cvsViewDecorator.style.display=""),this._recordedStates.decoratorShow=!0)}hideViewDecorator(){this._cvsViewDecorator&&(this._cvsViewDecorator.style.display="none",this._recordedStates.decoratorShow=!1)}setViewDecoratorLineWidth(e,t){if("string"!=typeof e)throw new Error("The 'type' should be a string.");if(e=e.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(e))throw new Error(`The type of '${e}' doesn't exist.`);if(!this._viewDecoratorInfo[e].hasOwnProperty("lineWidth"))throw new Error(`It is not allowed to change the property 'lineWidth' when the decorator type is '${e}'.`);this._viewDecoratorInfo[e].lineWidth=t,this._updateViewDecorator()}setViewDecoratorStrokeStyle(e,t){if("string"!=typeof e)throw new Error("The 'type' should be a string.");if(e=e.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(e))throw new Error(`The type of '${e}' doesn't exist.`);if(!this._viewDecoratorInfo[e].hasOwnProperty("strokeStyle"))throw new Error(`It is not allowed to change the property 'strokeStyle' when the decorator type is '${e}'.`);this._viewDecoratorInfo[e].strokeStyle=t,this._updateViewDecorator()}setViewDecoratorFillStyle(e,t){if("string"!=typeof e)throw new Error("The 'type' should be a string.");if(e=e.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(e))throw new Error(`The type of '${e}' doesn't exist.`);if(!this._viewDecoratorInfo[e].hasOwnProperty("fillStyle"))throw new Error(`It is not allowed to change the property 'fillStyle' when the decorator type is '${e}'.`);this._viewDecoratorInfo[e].fillStyle=t,this._updateViewDecorator()}setViewDecoratorMaskFillStyle(e,t){if("string"!=typeof e)throw new Error("The 'type' should be a string.");if(e=e.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(e))throw new Error(`The type of '${e}' doesn't exist.`);if(!this._viewDecoratorInfo[e].hasOwnProperty("maskFillStyle"))throw new Error(`It is not allowed to change the property 'maskFillStyle' when the decorator type is '${e}'.`);this._viewDecoratorInfo[e].maskFillStyle=t,this._updateViewDecorator()}_updateViewDecorator(){if(!this._bOpen)return;if(!this._cvsViewDecorator||!this._decoratorArea)return;let e;if(this.singleFrameMode)e="contain";else{if(!this._video)return;e=this.getVideoFit()}const t=this._cvsViewDecorator;t.style.position="absolute",t.style.width="100%",t.style.height="100%",t.style.left="0",t.style.top="0",t.style.objectFit=e,t.style.pointerEvents="none";const i=this.getVisibleRegion(!0),r=i.regionRight-i.regionLeft,n=i.regionBottom-i.regionTop;if(t.width==r&&t.height==n||(t.width=r,t.height=n),r<=0||n<=0)return;const s=t.getContext("2d");s.clearRect(0,0,t.width,t.height);const o=this._decoratorArea.x/100*r,a=this._decoratorArea.y/100*n,h=this._decoratorArea.width/100*r,l=this._decoratorArea.height/100*n;for(let e of this._decoratorType){if("rectangle"===e){s.fillStyle=this._viewDecoratorInfo.rectangle.maskFillStyle,s.fillRect(0,0,t.width,t.height),s.clearRect(Math.round(o),Math.round(a),Math.round(h),Math.round(l)),s.fillStyle=this._viewDecoratorInfo.rectangle.fillStyle,s.fillRect(Math.round(o),Math.round(a),Math.round(h),Math.round(l)),s.lineWidth=this._viewDecoratorInfo.rectangle.lineWidth,s.strokeStyle=this._viewDecoratorInfo.rectangle.strokeStyle;const e=s.lineWidth/2;s.strokeRect(Math.round(o-e),Math.round(a-e),Math.round(h+s.lineWidth),Math.round(l+s.lineWidth))}if("focus"===e){s.fillStyle=this._viewDecoratorInfo.focus.maskFillStyle,s.fillRect(0,0,t.width,t.height),s.clearRect(Math.round(o),Math.round(a),Math.round(h),Math.round(l)),s.fillStyle=this._viewDecoratorInfo.focus.fillStyle,s.fillRect(Math.round(o),Math.round(a),Math.round(h),Math.round(l)),s.lineWidth=this._viewDecoratorInfo.focus.lineWidth,s.strokeStyle=this._viewDecoratorInfo.focus.strokeStyle;const e=s.lineWidth/2,i=[0,.25,.75,1],r=[0,.25,.75,1];s.beginPath();for(let e=0;e<i.length;e++)if(0==e||3==e)for(let t=0;t<r.length;t+=2)s.moveTo(Math.round(o+i[e]*h),Math.round(a+r[t]*l)),s.lineTo(Math.round(o+i[e]*h),Math.round(a+r[t+1]*l));for(let t=0;t<r.length;t++)if(0==t||3==t)for(let n=0;n<i.length;n+=2)s.moveTo(Math.round(o+i[n]*h-e),Math.round(a+r[t]*l)),s.lineTo(Math.round(o+i[n+1]*h+e),Math.round(a+r[t]*l));s.stroke()}if("crossline"===e&&(s.beginPath(),s.lineWidth=this._viewDecoratorInfo.crossline.lineWidth,s.strokeStyle=this._viewDecoratorInfo.crossline.strokeStyle,s.moveTo(Math.round(o),Math.round(a+l/2)),s.lineTo(Math.round(o+h),Math.round(a+l/2)),s.moveTo(Math.round(o+h/2),Math.round(a)),s.lineTo(Math.round(o+h/2),Math.round(a+l)),s.stroke()),"crosshair"===e){s.beginPath();const e=.05*Math.min(h,l);s.lineWidth=this._viewDecoratorInfo.crosshair.lineWidth,s.strokeStyle=this._viewDecoratorInfo.crosshair.strokeStyle,s.moveTo(Math.round(o+(h-e)/2),Math.round(a+l/2)),s.lineTo(Math.round(o+(h+e)/2),Math.round(a+l/2)),s.moveTo(Math.round(o+h/2),Math.round(a+(l-e)/2)),s.lineTo(Math.round(o+h/2),Math.round(a+(l+e)/2)),s.stroke()}}}getVisibleRegion(e){this._assertOpen();const t=this._calculateCvsSize();if(!t)return null;const{width:i,height:r,objectFit:n}=t;let s=(()=>{const e=parseFloat(window.getComputedStyle(this._elContainer).width),t=parseFloat(window.getComputedStyle(this._elContainer).height);let s,o={regionBottom:r,regionRight:i,regionLeft:0,regionTop:0,regionMeasuredByPercentage:!1};return"cover"===n?e/t<i/r?(s=t/r,o.regionLeft=Math.floor((i-e/s)/2),o.regionRight=Math.ceil(i-o.regionLeft),o.regionTop=0,o.regionBottom=r):(s=e/i,o.regionTop=Math.floor((r-t/s)/2),o.regionBottom=Math.ceil(r-o.regionTop),o.regionLeft=0,o.regionRight=i):"none"===n&&(e<i&&t<r?(o.regionLeft=Math.floor((i-e)/2),o.regionRight=Math.ceil(i-o.regionLeft),o.regionTop=Math.floor((r-t)/2),o.regionBottom=Math.ceil(r-o.regionTop)):e<i?(o.regionLeft=Math.floor((i-e)/2),o.regionRight=Math.ceil(i-o.regionLeft),o.regionTop=0,o.regionBottom=r):t<r&&(o.regionTop=Math.floor((r-t)/2),o.regionBottom=Math.ceil(r-o.regionTop),o.regionLeft=0,o.regionRight=i)),o})();return e?s.regionMeasuredByPercentage=!1:(s.regionBottom=Math.ceil(s.regionBottom/r*100),s.regionRight=Math.ceil(s.regionRight/i*100),s.regionLeft=Math.floor(s.regionLeft/i*100),s.regionTop=Math.floor(s.regionTop/r*100),s.regionMeasuredByPercentage=!0),s}setScanRegionMaskStyle(e){e&&(e.fillStyle&&(this.regionMaskFillStyle=e.fillStyle),e.strokeStyle&&(this.regionMaskStrokeStyle=e.strokeStyle),e.lineWidth&&(this.regionMaskLineWidth=e.lineWidth),this._updateScanRegionCanvas())}_getRegionInPixels(e,t,i){if(!(e<=0||t<=0))return i?i.regionMeasuredByPercentage?{regionLeft:Math.round(i.regionLeft/100*e),regionTop:Math.round(i.regionTop/100*t),regionRight:Math.round(i.regionRight/100*e),regionBottom:Math.round(i.regionBottom/100*t),regionMeasuredByPercentage:!1}:JSON.parse(JSON.stringify(i)):{regionLeft:0,regionTop:0,regionRight:e,regionBottom:t,regionMeasuredByPercentage:!1}}_updateScanRegionCanvas(){if(!this._bOpen)return;const e=this._calculateCvsSize();if(!e)return;const{width:t,height:i,objectFit:r}=e;if(t<=0||i<=0)return void(this._cvsScanRegion&&(this._cvsScanRegion.width=0,this._cvsScanRegion.height=0));const n=this._getRegionInPixels(t,i,this._scanRegion);if(!this._cvsScanRegion){if(this._cvsScanRegion=document.createElement("canvas"),this._cvsOriginalImage)this._cvsOriginalImage.after(this._cvsScanRegion);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(this._cvsScanRegion);else{if(!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(this._cvsScanRegion)}this._recordedStates.maskShow=!0}const s=this._cvsScanRegion;s.style.position="absolute",s.style.width="100%",s.style.height="100%",s.style.left="0",s.style.top="0",s.style.objectFit=r,s.style.pointerEvents="none",s.width==t&&s.height==i||(s.width=t,s.height=i);const o=s.getContext("2d");if(o.clearRect(0,0,s.width,s.height),0!=n.regionLeft||n.regionRight!=t||0!=n.regionTop||n.regionBottom!=i){const e=n.regionLeft,t=n.regionTop,i=n.regionRight-n.regionLeft,r=n.regionBottom-n.regionTop;o.fillStyle=this.regionMaskFillStyle,o.fillRect(0,0,s.width,s.height),o.clearRect(Math.round(e),Math.round(t),Math.round(i),Math.round(r)),o.strokeStyle=this.regionMaskStrokeStyle,o.lineWidth=this.regionMaskLineWidth;const a=o.lineWidth/2;o.strokeRect(Math.round(e-a),Math.round(t-a),Math.round(i+o.lineWidth),Math.round(r+o.lineWidth))}}_updateScanAreaDiv(){if(!this._bOpen)return;const e=this._calculateCvsSize();if(!e)return;const{width:t,height:i,objectFit:r}=e;if(!this._divScanArea)return;if(t<=0||i<=0)return this._divScanArea.style.width="0",void(this._divScanArea.style.height="0");const n=this._getRegionInPixels(t,i,this._scanRegion),s=window.getComputedStyle(this._elContainer),o=parseFloat(s.width),a=parseFloat(s.height),h=o/a,l=t/i;let c,u,d,f,g=1;if("contain"===r)h<l?(g=o/t,c=0,u=(a-i*g)/2):(g=a/i,c=(o-t*g)/2,u=0),c+=n.regionLeft*g,u+=n.regionTop*g,d=(n.regionRight-n.regionLeft)*g,f=(n.regionBottom-n.regionTop)*g;else if("cover"===r)if(h<l){g=a/i,c=n.regionLeft*g-(t*g-o)/2,c=Math.max(c,0),c=Math.min(c,parseFloat(s.width)),u=n.regionTop*g;let e=n.regionRight*g-(t*g-o)/2;e=Math.max(e,0),e=Math.min(e,parseFloat(s.width)),d=e-c,f=(n.regionBottom-n.regionTop)*g}else{g=o/t,c=n.regionLeft*g,u=n.regionTop*g-(i*g-a)/2,u=Math.max(u,0),u=Math.min(u,parseFloat(s.height));let e=n.regionBottom*g-(i*g-a)/2;e=Math.max(e,0),e=Math.min(e,parseFloat(s.height)),d=(n.regionRight-n.regionLeft)*g,f=e-u}else c=0,u=0,d=0,f=0;this._divScanArea.style.left=c+"px",this._divScanArea.style.top=u+"px",this._divScanArea.style.width=d+"px",this._divScanArea.style.height=f+"px"}set croppingRegions(e){this._croppingRegions=e,this._bFetchingLoopStarted&&(this.bIncreaseRegionIndexAuto&&(this._croppingRegionIndex=0),this._fetchingLoop(!1))}get croppingRegions(){if(void 0!==this._croppingRegions)return this._croppingRegions;if(this._controler){const e=this._controler.getPropertyDisiredValue("croppingRegions");if(e&&1===e.length)return e[0]}return this._defaultCroppingRegions}set croppingRegionIndex(e){e<0?(this.bIncreaseRegionIndexAuto=!0,this._croppingRegionIndex=0):(this.bIncreaseRegionIndexAuto=!1,this._croppingRegionIndex=e)}get croppingRegionIndex(){return this._croppingRegionIndex}set loopInterval(e){if(e<0)throw new Error("'Invalid value.");this._loopInterval=e,this._bFetchingLoopStarted&&this._fetchingLoop(!1)}get loopInterval(){if(void 0!==this._loopInterval)return this._loopInterval;if(this._controler){const e=this._controler.getPropertyDisiredValue("loopInterval");if(e&&1===e.length)return e[0]}return this._defaultLoopInterval}set maxNumberOfFramesInBuffer(e){if(e<=0)throw new Error("Invalid value.");for(this._maxNumberOfFramesInBuffer=e;this._frameQueue&&this._frameQueue.length>this.maxNumberOfFramesInBuffer;)this._frameQueue.shift()}get maxNumberOfFramesInBuffer(){if(void 0!==this._maxNumberOfFramesInBuffer)return this._maxNumberOfFramesInBuffer;if(this._controler){const e=this._controler.getPropertyDisiredValue("maxNumberOfFramesInBuffer");if(e&&1===e.length)return e[0]}return this._defaultMaxNumberOfFramesInBuffer}get numberOfFramesInBuffer(){return this._frameQueue.lengt}get refreshInterval(){if(void 0!==this._refreshInterval)return this._refreshInterval;if(this._controler){const e=this._controler.getPropertyDisiredValue("refreshInterval");if(e&&1===e.length)return e[0]}return this._defaultRefreshInterval}static async createInstance(e){let t=new ue;("string"==typeof e||e instanceof String)&&(e=JSON.parse(e));for(let i in e)t[i]=e[i];return this._hasEngineResourceLoaded=!0,ue.onWarning&&(location&&"file:"===location.protocol?setTimeout((()=>{ue.onWarning&&ue.onWarning({id:1,message:"The page is opened over file:// and Dynamsoft Camera Enhancer may not work properly. Please open the page via https://."})}),0):!1!==window.isSecureContext&&navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia||setTimeout((()=>{ue.onWarning&&ue.onWarning({id:2,message:"Dynamsoft Camera Enhancer may not work properly in a non-secure context. Please open the page via https://."})}),0)),t._drawingLayersManager=new oe,t}static async playVideo(e,t,i){return new Promise(((r,n)=>{e||n(new Error("Invalid video element.")),t||n(new Error("Invalid source.")),e.onloadedmetadata=async()=>{e.onloadedmetadata=null,await e.play(),r(e)},"string"==typeof t||t instanceof String?e.src=t:e.srcObject=t,void 0!==i&&setTimeout)),i)}))}static findBestRearCamera(e){if(!e||!e.length)return null;const t=["rear","back","rück","arrière","trasera","trás","traseira","posteriore","后面","後面","背面","后置","後置","背置","задней","الخلفية","후","arka","achterzijde","หลัง","baksidan","bagside","sau","bak","tylny","takakamera","belakang","אחורית","πίσω","spate","hátsó","zadní","darrere","zadná","задня","stražnja","belak;for(let i of e){const e=i.label.toLowerCase();if(e&&t.some((t=>e.includes(t)))){if(["iPhone","iPad"].includes(Y.OS))return i.deviceId;if(/\b0(\b)?/.test(e))return i.deviceId}}return["Android","HarmonyOS"].includes(Y.OS)?e[e.length-1].deviceId:null}async play(e,t,i,r){let n;if(this._video&&this.videoSrc){ue._onLog&&(n=Date.now(),ue._onLog("DCE: start loading static video: "+n));const e=await ue.playVideo(this._video,this.videoSrc,4e3);if(ue._onLog&&ue._onLog("DCE: finish loading static video. Costs: "+(Date.now()-n)),!this._video)return e.pause(),this.playCallbackInfo={width:0,height:0,deviceId:null},{width:0,height:0,deviceId:null};const t={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId};this.playCallbackInfo=JSON.parse(JSON.stringify(t));const i=this.mapCameraEvents.get("played");for(let e of i){if(!e)continue;const i=JSON.parse(JSON.stringify(t));setTimeout((()=>{this.isDisposed&&this.disposed||e.apply(this,[i])}),0)}return this._recordedStates.videoPlaying=!0,t}if(this.singleFrameMode)return r&&r.notTriggerSingleFrameClick||this._clickIptSingleFrameMode(),this.playCallbackInfo={width:0,height:0,deviceId:null},{width:0,height:0,deviceId:null};if(!this._video)throw new Error("'video' is null or undefined.");const s=++this.iPlayRound;if(this.promisePlay&&(await this.promisePlay,s<this.iPlayRound))return this.playCallbackInfo={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId},{width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId};this.promisePlay=(async()=>{var n;try{this._video&&this._video.srcObject&&this.stop(),ue._onLog&&ue._onLog("DCE: ======before video========");const s=()=>{if(!this._video)throw h&&h.getTracks().forEach((e=>{e.stop()})),this._videoTrack=null,this._currentCamera=null,new Error("'video' is null or undefined.")},o=this.getVideoSettings();let a,h;if("boolean"==typeof o.video&&(o.video={}),e)delete o.video.facingMode,o.video.deviceId={exact:e};else if(o.video.deviceId);else if(this._lastDeviceId)delete o.video.facingMode,o.video.deviceId={exact:this._lastDeviceId};else if(this.ifSaveLastUsedCamera&&ue.isStorageAvailable&&window.localStorage.getItem("dce_last_camera_id")){delete o.video.facingMode,o.video.deviceId={ideal:window.localStorage.getItem("dce_last_camera_id")};const e=JSON.parse(window.localStorage.getItem("dce_last_apply_width")),t=JSON.parse(window.localStorage.getItem("dce_last_apply_height"));e&&t&&(o.video.width=e,o.video.height=t)}else if(this.ifSkipCameraInspection);else if(o.video.facingMode){if(await this.getAllCameras(!1),!this._video)throw new Error("'video' is null or undefined.");let e=o.video.facingMode;if(e instanceof Array&&e.length&&(e=e[0]),e=e.exact||e.ideal||e,"environment"===e){a=!0;const e=ue.findBestRearCamera(this._allCameras);e&&(delete o.video.facingMode,o.video.deviceId={exact:e})}}t&&(o.video.width={ideal:t}),i&&(o.video.height={ideal:i}),ue._onLog&&ue._onLog("DCE: ======try getUserMedia========")ll;const u=async e=>{for(let t of l){t&&await new Promise((e=>setTimeout(e,t))),s();try{ue._onLog&&ue._onLog("DCE: ask "+JSON.stringify(e)),h=await navigator.mediaDevices.getUserMedia(e);break}catch(e){if(s(),"NotFoundError"===e.name||"NotAllowedError"===e.name)throw e;c=e,ue._onLog&&ue._onLog("DCE: "+e.message||e)}}s()};let d;if(await u(o),h||(ue._onLog&&ue._onLog("DCE: ======try getUserMedia again========"),d=JSON.parse(JSON.stringify(o)),"object"==typeof d.video&&(["iPhone","iPad"].includes(Y.OS)?(t>=1280||i>=1280?d.video.width=1280:t>=640||i>=640?d.video.width=640:(t<640||i<640)&&(d.video.width=320),delete d.video.height):a&&!o.video.deviceId?(delete d.video.facingMode,this._allCameras.length&&(d.video.deviceId={ideal:this._allCameras[this._allCameras.length-1].deviceId})):d.video=!0),ue._onLog&&ue._onLog("DCE: "+d),await u(d)),h||(l=[1e3,2e3],await u(o)),h||await u(d),!h)throw c;const f=()=>{const e=h.getVideoTracks();let t,i;if(e.length&&(t=this._videoTrack=e[0]),this._video&&t){const e=t.getSettings();if(e)for(let r of this._allCameras)if(e.deviceId===r.deviceId){r._checked=!0,r.label=t.label,i=r;break}}this._currentCamera=i};if(await this.getAllCameras(!1),s(),a&&!this.ifSkipCameraInspection){f();const e=ue.findBestRearCamera(this._allCameras),t=null===(n=this._||void 0===n?void 0:n.deviceId;e&&e!=t&&(h.getTracks().forEach((e=>{e.stop()})),l=[0,500,1e3,2e3],o.video.deviceId={exact:e},await u(o))}ue._onLog&&ue._onLog("DCE: ======play video========"),s(),await ue.playVideo(this._video,h,4e3),s(),ue._onLog&&ue._onLog("DCE: ======played video========"),this._bgLoading&&(this._bgLoading.style.animationPlayState="paused");const g=this._video.videoWidth+"x"+this._video.videoHeight;this._optGotRsl&&(this._optGotRsl.setAttribute("data-width",this._video.videoWidth),this._optGotRsl.setAttribute("data-height",this._video.videoHeight),this._optGotRsl.innerText=g,this._selRsl&&this._optGotRsl.parentNode==this._selRsl&&(this._selRsl.value="got")),ue._onLog&&ue._onLog("DCE: got "+g),f(),this._renderSelCameraInfo();const _={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId};if(_.deviceId&&(this._lastDeviceId=_.deviceId,this.ifSaveLastUsedCamera&&ue.isStorageAvailable&&(window.localStorage.setItem("dce_last_camera_id",this._lastDeviceId),o.video.width&&o.video.height&&(window.localStorage.setItem("dce_last_apply_width",JSON.stringify(o.video.width)),window.localStorage.setItem("dce_last_apply_height",JSON.stringify(o.video.height))))),!r||!r.notTriggerPlayedEvent){const e=this.mapCameraEvents.get("played");for(let t of e){if(!t)continue;const e=JSON.parse(JSON.stringify(_));setTimeout((()=>{this.isDisposed&&this.disposed||t.apply(this,[e])}),0)}}return this.promisePlay=null,_}catch(e){throw this.promisePlay=null,this._bgLoading&&(this._bgLoading.style.display="none"),"NotFoundError"===e.name&&(DOMException?e=new DOMException("No camera available, please use a device with an accessible camera.",e.name):(e=new Error("No camera available, please use a device with an accessible camera.")).name="NotFoundError"),e}})(),ue._onLog&&(n=Date.now(),ue._onLog("DCE: start opening camera: "+n));const o=await this.promisePlay;return ue._onLog&&ue._onLog("DCE: finish opening camera. Costs: "+(Date.now()-n)),this.playCallbackInfo=JSON.parse(JSON.stringify(o)),this._recordedStates.videoPlaying=!0,o}async resume(){this._assertOpen(),this._video&&(await this._video.play(),this._recordedStates.videoPlaying=!0),this.ifShowScanRegionLaser&&this.showScanRegionLaser()}pause(){this._assertOpen(),this._video&&(this._video.pause(),this._recordedStates.videoPlaying=!1),this.ifShowScanRegionLaser&&this.hideScanRegionLaser()}_bindUI(){if(!this.UIElement)throw new Error("Need to define `UIElement` before opening.");const e=[this.UIElement];for(let t=0;t<e.length;++t)for(let i of e[t].children)e.push(i);for(let t of e){if(!this._video&&t.classList.contains(this.containerClassName)){this._elContainer=t;const e=document.createElement("video");e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="100%",e.style.height="100%",e.style.objectFit=this.getVideoFit(),e.setAttribute("playsinline","true"),e.setAttribute("muted","true"),this._video=e;const i=document.createElement("div");i.append(e),i.style.position="absolute",i.style.left="0",i.style.top="0",i.style.width="100%",i.style.height="100%",i.style.overflow="hidden",this._videoContainer=i,t.prepend(i)}else!this._divScanArea&&t.classList.contains("dce-scanarea")?this._divScanArea=t:!this._divScanLight&&t.classList.contains("dce-scanlight")?this._divScanLight=t:!this._bgLoading&&t.classList.contains("dce-bg-loading")?this._bgLoading=t:!this._bgCamera&&t.classList.contains("dce-bg-camera")?this._bgCamera=t:!this._selCam&&t.classList.contains("dce-sel-camera")?this._selCam=t:!this._selRsl&&t.classList.contains("dce-sel-resolution")?(this._selRsl=t,this.videoSrc||this.singleFrameMode||this._selRsl.options.length||(this._selRsl.innerHTML=[this._optGotRsl?"":'<option class="dce-opt-gotResolution" value="got"></option>','<option data-width="1920" data-height="1080">1920x1080</option>','<option data-width="1280" data-height="720">1280x720</option>','<option data-width="640" data-height="480">640x480</option>'].join(""),this._optGotRsl=this._optGotRsl||this._selRsl.options[0])):!this._optGotRsl&&t.classList.contains("dce-opt-gotResolution")?this._optGotRsl=t:!this._btnClose&&t.classList.contains("dce-btn-close")?this._btnClose=t:!this._selMinLtr&&t.classList.contains("dlr-sel-minletter")?(this._selMinLtr=t,this._selMinLtr.options.length||(this._selMinLtr.innerHTML=[this._optGotMinLtr?"":'<option class="dlr-opt-gotMinLtr" value="got"></option>','<option value="0" selected>any letter</option>','<option value="3">3+ letters</option>','<option value="5">5+ letters</option>','<option value="8">8+ letters</option>','<option value="12">12+ letters</option>','<option value="17">17+ letters</option>','<option value="30">30+ letters</option>','<option value="50">50+ letters</option>','<option value="80">80+ letters</option>','<option value="120">120+ letters</option>'].join(""),this._optGotMinLtr=this._optGotMinLtr||this._selMinLtr.options[0])):!this._optGotMinLtr&&t.classList.contains("dlr-opt-gotMinLtr")&&(this._optGotMinLtr=t);if(this.extraBindings&&this.extraBindings.length)for(let i of this.extraBindings)try{i(t)}catch(e){}}if(!this._video)throw this._unbindUI(),Error(`Can not find the video container element with class '${this.containerClassName}'`);this.singleFrameMode||this.videoSrc?(this.singleFrameMode&&(this._elContainer&&(this._elContainer.addEventListener("click",this._clickIptSingleFrameMode),this._elContainer.setAttribute("title","Take a photo")),this._bgCamera&&(this._bgCamera.style.display="block")),this._selCam&&(this._selCam.style.display="none"),this._selRsl&&(this._selRsl.style.display="none"),this._selMinLtr&&(this._selMinLtr.style.display="none")):(this._elContainer&&(["Android","HarmonyOS"].includes(Y.OS)?(this._elContainer.addEventListener("touchend",this._tapDoFocus),this._elContainer.addEventListener("touchmove",this._touchMoveEvent)):this._elContainer.addEventListener("click",this._tapDoFocus)),this._selCam&&(this._selCam.style.display="block",this._selCam.addEventListener("change",this._onCameraSelChange)),this._selRsl&&(this._selRsl.style.display="block",this._selRsl.addEventListener("change",this._onResolutionSelChange)),this._selMinLtr&&(this._selMinLtr.style.display="block"),this._bgLoading&&(this._bgLoading.style.display="block")),this._btnClose&&this._btnClose.addEventListener("click",this._onCloseBtnClick),document.addEventListener("visibilitychange",this._ev_documentHideEvent),window.ResizeObserver&&(this._resizeObserver||(this._resizeObserver=new ResizeObserver((e=>{for(let t of e)t.target===this._elContainer&&this._updateLayers()}))),this._elContainer&&this._resizeObserver.observe(this._elContainer)),this._windowWidth=document.documentElement.clientWidth,window.addEventListener("resize",this._windowResizeListener)}_unbindUI(){this.singleFrameMode?(this._elContainer&&(this._elContainer.removeEventListener("click",this._clickIptSingleFrameMode),this._elContainer.removeAttribute("title")),this._bgCamera&&(this._bgCamera.style.display="none")):this._bgLoading&&(this._bgLoading.style.display="none"),this._elContainer&&(this._elContainer.removeEventListener("click",this._tapDoFocus),this._elContainer.removeEventListener("touchend",this._tapDoFocus),this._elContainer.removeEventListener("touchmove",this._touchMoveEvent)),this._selCam&&this._selCam.removeEventListener("change",this._onCameraSelChange),this._selRsl&&this._selRsl.removeEventListener("change",this._onResolutionSelChange),this._btnClose&&this._btnClose.removeEventListener("click",this._onCloseBtnClick),this.hideScanRegionLaser(),this.hideViewDecorator(),this.hideScanRegionOverlays(),this._drawingLayersManager.setVisible(!1),this._hideOriginalImageCvs(),this._videoContainer&&this._videoContainer.remove(),this._video=null,this._videoContainer=null,this._elContainer=null,this._selCam=null,this._selRsl=null,this._optGotRsl=null,this._btnClose=null,this._selMinLtr=null,this._optGotMinLtr=null,this._divScanArea=null,this._divScanLight=null,this._cvsScanRegion&&(this._cvsScanRegion.remove(),this._cvsScanRegion=null),this._singleFrameModeIpt&&(this._singleFrameModeIpt.remove(),this._singleFrameModeIpt=null),this._cvsSingleFrameMode&&(this._cvsSingleFrameMode.remove(),this._cvsSingleFrameMode=null),document.removeEventListener("visibilitychange",this._ev_documentHideEvent),window.ResizeObserver&&this._resizeObserver&&this._resizeObserverstener)}_assertOpen(){if(!this._bOpen)throw Error("The camera is not open.")}async open(e){this.UIElement||await this.setUIElement(ue.defaultUIElementURL),this._bindUI(),e&&this.appendAndShowUI();let t=await this.play();this.bOpen=!0,this._focusParameters.fds=null,this._focusParameters.kTimeout=void 0,this._focusSupported=!0,this._tapFocusEnabled&&!this.singleFrameMode&&(this._focusParameters.fds=(await this.getCapabilities()).focusDistance,this._focusParameters.fds||(this._focusSupported=!1,this._tapFocusEnabled=!1));const i=this.mapCameraEvents.get("cameraopen");for(let e of i){if(!e)continue;const i=JSON.parse(JSON.stringify(t));setTimeout((()=>{this.isDisposed&&this.disposed||e.apply(this,[i])}),0)}return t}close(e){if(!this._video)return;this.stop(),this._hideOriginalImage(!1),this.hideTip(),this._unbindUI(),e&&this.hideUI(),this.stopFetchingLoop(),this.bOpen=!1;const t=this.mapCameraEvents.get("cameraclose");for(let e of t){if(!e)continue;const t={width:0,height:0,deviceId:null};setTimeout((()=>{this.isDisposed&&this.disposed||e.apply(this,[t])}),0)}}stop(){this._video&&this._video.srcObject&&(ue._onLog&&ue._onLog("DCE: ======stop video========"),this._video.srcObject.getTracks().forEach((e=>{e.stop()})),this._video.srcObject=null,this._videoTrack=null,this._currentCamera=null),this._video&&this.videoSrc&&(ue._onLog&&ue._onLog("DCE: ======stop existing video========"),this._video.pause(),this._video.currentTime=0),this._bgLoading&&(this._bgLoading.style.animationPlayState=""),this._frameQueue.length=0,this._reusedCvs&&this._reusedCvs.ctx2d&&this._reusedCvs.ctx2d.clearRect(0,0,this._reusedCvs.width,this._reusedCvs.height),this.forceLoseContext()}async getAllCameras(e=!0){let t=(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind));if(e&&t&&t.length&&!t[0].deviceId){let e=await navigator.mediaDevices.getUsert navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind)),e.getTracks().forEach((e=>{e.stop()}))}const i=[],r=[];if(this._allCameras)for(let e of this._allCameras)e._checked&&r.push(e);for(let e=0;e<t.length;e++){let n,s=t[e];for(let e of r)if(s.deviceId==e.deviceId){n=e;break}n||(n={deviceId:s.deviceId,label:s.label?s.label:"camera "+e,_checked:!1}),n.deviceId&&i.push(n)}return this._allCameras=i,ue._onLog&&ue._onLog("DCE: "+JSON.stringify(this._allCameras)),i}_renderSelCameraInfo(){if(!this._selCam)return;let e;this._selCam.textContent="";for(let t of this._allCameras){const i=document.createElement("option");i.value=t.deviceId,i.innerText=t.label,this._selCam.append(i),t.deviceId&&this._currentCamera&&this._currentCamera.deviceId==t.deviceId&&(e=i)}this._selCam.value=e?e.value:""}getSelectedCamera(){if(!this._bOpen){let e="";const t=this.videoSettings.video.deviceId;t&&(e=t.exact||t.ideal||t);for(let t of this._allCameras)if(t.deviceId===e)return JSON.parse(JSON.stringify(t));return{deviceId:e,label:"",_checked:!1}}return this._currentCamera}async selectCamera(e){let t="";if(e&&(t=e.deviceId||e),this.videoSettings.video.deviceId={exact:t},!this._bOpen||this._video.paused)return null;let i=null;this._currentCamera&&(i=this._currentCamera.deviceId);const r=this._video.videoWidth,n=this._video.videoHeight,s=await this.play(e.deviceId||e);if(this._focusParameters.fds=null,this._focusParameters.kTimeout=void 0,this._focusSupported=!0,this._tapFocusEnabled&&!this.singleFrameMode&&(this._focusParameters.fds=(await this.getCapabilities()).focusDistance,this._focusParameters.fds||(this._focusSupported=!1,this._tapFocusEnabled=!1)),i!==s.deviceId){const e=this.mapCameraEvents.get("camerachange");for(let t of e){if(!t)continue;const e=JSON.parse(JSON.stringify(s));setTimeout((()=>{this.isDisposed&&this.disposed||t.apply(this,[e])}),0)}}if(r!==s.width||n!==s.height){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let e of this._arrScanRegionOverlays)e&&this._updateScanRegionOverlay(e);this._updateDrawingLayersSize(),this._updateVideoContainerStyle();const e=this.mapCameraEvents.get("resolutionchange");for(let t of e){if(!t)continue;const e=JSON.parse(JSON.stringify(s));setTimeout((()=>{this.isDisposed&&this.disposed||t.apply(this,[e])}),0)}}return s}getResolution(){if(this._bOpen)return[this._video.videoWidth,this._video.videoHeight];{let e=0,t=0;const i=this.videoSettings.video.width,r=this.videoSettings.video.height;return i&&(e=i.exact||i.ideal||i),r&&(t=r.exact||r.ideal||r),[e,t]}}async setResolution(e,t){let i,r;if(e instanceof Array?(i=e[0],r=e[1]):(i=e,r=t),this.videoSettings.video.width={ideal:i},this.videoSettings.video.height={ideal:r},!this._bOpen||this._video.paused)return null;const n=this._video.videoWidth,s=this._video.videoHeight,o=await this.play(null,i,r);if(n!==o.width||s!==o.height){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let e of this._arrScanRegionOverlays)e&&this._updateScanRegionOverlay(e);this._updateDrawingLayersSize(),this._updateVideoContainerStyle();const e=this.mapCameraEvents.get("resolutionchange");for(let t of e){if(!t)continue;const e=JSON.parse(JSON.stringify(o));setTimeout((()=>{this.isDisposed&&this.disposed||t.apply(this,[e])}),0)}}return o}async getResolutions(e){let t="";const i=(e,t)=>{const i=this._mapCameraResolutions.get(e);if(!i||!i.length)return!1;for(let e of i)if(e[0]===t.width&&e[1]===t.height)return!0;return!1},r=async(e,t,i)=>{const r={video:{deviceId:{exact:e},width:{ideal:t},height:{ideal:i}}};let n=null;try{n=await navigator.mediaDevices.getUserMedia(r)}catch(e){return null}if(!n)return null;const s=n.getVideoTracks();let o=null;try{const e=s[0].getSettings();o={width:e.width,height:e.height}}catch(e){const t=document.createElement("video");t.srcObject=n,o={width:t.videoWidth,height:t.videoHeight},t.srcObject=null}return s.forEach((e=>{e.stop()})),o};if(!this._bOpen){const n=this.videoSettings.video.deviceId;if(!n)return null;if(t=n.hasOwnProperty("exact")?this.videoSettings.video.deviceId.exact:n.hasOwnProperty("ideal")?this.videoSettings.video.deviceId.ideal:this.videoSettings.video.deviceId,!t)return null;let s=this._mapCameraResolutions.get(t);if(s&&!e)return this._mapCameraResolutions.get(t);this._mapCameraResolutions.set(t,[]),s=this._mapCameraResolutions.get(t);for(let e of this._predefinedResolutions){const n=await r(t,e.width,e.height);n&&!i(t,n)&&s.push([n.width,n.height])}return s}if(this._currentCamera){t=this._currentCamera.deviceId;let r=this._mapCameraResolutions.get(t);if(r&&!e)return this._mapCameraResolutions.get(t);this._mapCameraResolutions.set(t,[]),r=this._mapCameraResolutions.get(t);let n=this._videoTrack;for(let e of this._predefinedResolutions){await n.applyConstraints({width:{ideal:e.width},height:{ideal:e.height}});const s=n.getSettings(),o={width:s.width,height:s.height};i(t,o)||r.push([o.width,o.height])}return this._video.srcObject.getTracks().forEach((e=>{e.stop()})),await this.play(t,null,null,{notTriggerPlayedEvent:!0}),r}return null}on(e,t){if(!t)return;const i=this.mapCameraEvents.get(e.toLowerCase());if(!i)throw new Error(`Event '${e}' does not exist.`);i.includes(t)||i.push(t)}off(e,t){const i=this.mapCameraEvents.get(e.toLowerCase());if(!i)throw new Error(`Event '${e}' does not exist.`);const r=i.indexOf(t);-1!==r&&i.splice(r,1)}offAll(e){if(e){if("string"==typeof e){const t=this.mapCameraEvents.get(e);t&&(t.length=0)}}else for(let e of this.mapCameraEvents.values())e&&(e.length=0)}getVideoSettings(){return JSON.parse(JSON.stringify(this.videoSettings))}updateVideoSettings(e){if(this.videoSettings=JSON.parse(JSON.stringify(e)),this._lastDeviceId=null,this._bOpen)return this.play()}isOpen(){return this._bOpen}getCapabilities(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getCapabilities()' is unavailable in singleFrameMode.");return this._videoTrack&&this._videoTrack.getCapabilities?this._videoTrack.getCapabilities():{}}getCameraSettings(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getCameraSettings()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings():null}getConstraints(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getConstraints()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getConstraints():null}async applyConstraints(e){if(this._assertOpen(),this.singleFrameMode)throw new Error("'applyConstraints()' is unavailable in singleFrameMode.");if(!this._videoTrack)throw new Error('"_videoTrack" is null.');if(!this._videoTrack.applyConstraints)throw Error("Not supported.");return await this._videoTrack.applyConstraints(e)}async turnOnTorch(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'turnOnTorch()' is unavailable in singleFrameMode.");if(this.getCapabilities().torch)return await this._videoTrack.applyConstraints({advanced:[{torch:!0}]});throw Error("Not supported.")}async turnOffTorch(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'turnOffTorch()' is unavailable in singleFrameMode.");if(this.getCapabilities().torch)return await this._videoTrack.applyConstraints({advanced:[{torch:!1}]});throw Error("Not supported.")}async setColorTemperature(e){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setColorTemperature()' is unavailable in singleFrameMode.");let t=this.getCapabilities().colorTemperature;if(!t)throw Error("Not supported.");return e<t.min?e=t.min:e>t.max&&(e=t.max),await this._videoTrack.applyConstraints({advanced:[{colorTemperature:e,whiteBalanceMode:"manual"}]})}getColorTemperature(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getColorTemperature()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings().colorTemperature||0:null}async setExposureCompensation(e){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setExposureCompensation()' is unavailable in singleFrameMode.");let t=this.getCapabilities().exposureCompensation;if(!t)throw Error("Not supported.");return e<t.min?e=t.min:e>t.max&&(e=t.max),await this._videoTrack.applyConstraints({advanced:[{exposureCompensation:e}]})}getExposureCompensation(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getExposureCompensation()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings().exposureCompensation||0:null}async _setHardwareScale(e){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_setHardwareScale()' is unavailable in singleFrameMode.");if(e<1)throw new RangeError("Invalid value.");if(!this._videoTrack)return;const t=this.getCapabilities().zoom;if(!t)throw new Error("Not supported.");return e<t.min?e=t.min:e>t.max&&(e=t.max),e=ce(e,t.min,t.step,t.max),await this._videoTrack.applyConstraints({advanced:[{zoom:e}]}),e}_getHardwareScale(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_getHardwareScale()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings().zoom||1:null}_setSoftwareScale(e,t){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_setSoftwareScale()' is unavailable in singleFrameMode.");if(e<1)throw new RangeError("Invalid value.");t&&this._setScaleCenter(t),this._softwareScale=e,this._scaleVideo(e,t)}_getSoftwareScale(){return this._softwareScale}_setScaleCenter(e){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_setScaleCenter()' is unavailable in singleFrameMode.");if(!e||"string"!=typeof e.x||"string"!=typeof e.y)throw new Error("Invalid center.");const t=this._video.videoWidth,i=this._video.videoHeight;let r=0,n=0;if(e.x.endsWith("px"))r=parseFloat(e.x);else{if(!e.x.endsWith("%"))throw new Error("Invalid scale center.");r=parseFloat(e.x)/100*t}if(e.y.endsWith("px"))n=parseFloat(e.y);else{if(!e.y.endsWith("%"))throw new Error("Invalid scale center.");n=parseFloat(e.y)/100*i}if(NaN==r||NaN==n)throw new Error("Invalid scale center.");this._scaleCenter={x:r,y:n}}_resetScaleCenter(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_resetScaleCenter()' is unavailable in singleFrameMode.");const e=this._video.videoWidth,t=this._video.videoHeight;this._scaleCenter={x:e/2,y:t/2}}_isVideoCenter(e){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_isVideoCenter()' is unavailable in singleFrameMode.");return e&&e.x==this._video.videoWidth/2&&e.y==this._video.videoHeight/2}async _setZoom(e){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setZoom()' is unavailable in singleFrameMode.");if(e<1)throw new RangeError("Invalid value.");this._resetScaleCenter();try{if(this._isVideoCenter(this._scaleCenter)){const t=await this._setHardwareScale(e);let i=this._getHardwareScale();1==i&&1!=t&&(i=t),e>i?this._setSoftwareScale(e/i):this._setSoftwareScale(1)}else await this._setHardwareScale(1),this._setSoftwareScale(e)}catch(t){if("Not supported."!==(t.message||t))throw t;this._setSoftwareScale(e)}}async setZoom(e){if("number"!=typeof e&&"object"!=typeof e)throw new TypeError("Illegal type of argument.");if("number"==typeof e)return this._setZoom(e);if(this._assertOpen(),this.singleFrameMode)throw new Error("'setZoom()' is unavailable in singleFrameMode.");if(e){if("number"!=typeof e.factor)throw new TypeError("Illegal type of 'factor'.");if(e.factor<1)throw new RangeError("Invalid value.");e.centerPoint?this._setScaleCenter(e.centerPoint):this._resetScaleCenter();try{if(this._isVideoCenter(this._scaleCenter)){const t=await this._setHardwareScale(e.factor);let i=this._getHardwareScale();1==i&&1!=t&&(i=t),e.factor>i?this._setSoftwareScale(e.factor/i):this._setSoftwareScale(1)}else await this._setHardwareScale(1),this._setSoftwareScale(e.factor)}catch(t){if("Not supported."!==(t.message||t))throw t;this._setSoftwareScale(e.factor)}}}getZoom(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getZoom()' is unavailable in singleFrameMode.");return this._videoTrack?this._getHardwareScale()*this._softwareScale:null}getZoomSettings(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getZoom()' is unavailable in singleFrameMode.");return this._videoTrack?{factor:this._getHardwareScale()*this._softwareScale}:null}async resetZoom(){await this.setZoom({factor:1})}async setFrameRate(e){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setFrameRate()' is unavailable in singleFrameMode.");let t=this.getCapabilities().frameRate;if(!t)throw Error("Not supported.");return e<t.min?e=t.min:e>t.max&&(e=t.max),await this._videoTrack.applyConstraints({width:{ideal:Math.max(this._video.videoWidth,this._video.videoHeight)},frameRate:e})}getFrameRate(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getFrameRate()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings().frameRate:null}async _setFocus(e,t){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setFocus()' is unavailable in singleFrameMode.");if("string"!=typeof e)throw Error("Invalid focus mode.");e=e.toLowerCase();const i=this.getCapabilities().focusMode,r=this.getCapabilities().focusDistance;if(!i)throw Error("Not supported.");if(!i.includes(e))throw Error("Unsupported mode.");if(t>=0){if(!r)throw Error("Manual focus unsupported.");return t<r.min?t=r.min:t>r.max&&(t=r.max),t=ce(t,r.min,r.step,r.max),await this._videoTrack.applyConstraints({advanced:[{focusMode:e,focusDistance:t}]})}return await this._videoTrack.applyConstraints({advanced:[{focusMode:e}]})}async setFocus(e,t){if("string"==typeof e)return this._setFocus(e,t);if(this._assertOpen(),this.singleFrameMode)throw new Error("'setFocus()' is unavailable in singleFrameMode.");if(!e)return;const i=this.getCapabilities(),r=i.focusMode,n=i.focusDistance;if(!r)throw Error("Not supported.");if("string"!=typeof e.mode)throw Error("Invalid focus mode.");const s=e.mode.toLowerCase();if(!r.includes(s))throw Error("Unsupported focus mode.");if("manual"!==s)return this._focusParameters._focusArea=null,await this._videoTrack.applyConstraints({advanced:[{focusMode:s}]});if(!n)throw Error("Manual focus unsupported.");if(e.hasOwnProperty("distance")){let t=e.distance;return t<n.min?t=n.min:t>n.max&&(t=n.max),t=ce(t,n.min,n.step,n.max),this._focusParameters._focusArea=null,await this._videoTrack.applyConstraints({advanced:[{focusMode:s,focusDistance:t}]})}if(!e.area)throw new Error("'distance' or 'area' should be specified in 'manual' mode.");{const t=e.area.centerPoint;let i=e.area.width,r=e.area.height;if(!i||!r){const e=this._video.videoWidth,t=this._video.videoHeight;i||(i=2*Math.round(Math.min(e,t)/this._focusParameters.defaultFocusAreaSizeRatio/2)+"px"),r||(r=2*Math.round(Math.min(e,t)/this._focusParameters.defaultFocusAreaSizeRatio/2)+"px")}this._focusParameters._focusArea={centerPoint:{x:t.x,y:t.y},width:i,height:r},await this._setLocalFocus(t,i,r)}}getFocus(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_getHardwareScale()' is unavailable in singleFrameMode.");if(!this._videoTrack)return null;const e=this._videoTrack.getSettings().focusMode;return e?"continuous"===e?{mode:e}:{mode:e,distance:this._videoTrack.getSettings().focusDistance}:null}getFocusSettings(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_getHardwareScale()' is unavailable in singleFrameMode.");if(!this._videoTrack)return null;const e=this._videoTrack.getSettings(),t=e.focusMode;return t?"manual"===t?this._focusParameters._focusArea?{mode:"manual",area:JSON.parse(JSON.stringify(this._focusParameters._focusArea))}:{mode:"manual",distance:e.focusDistance}:{mode:t}:null}async _setFocusAndGetContract(e,t){const i=e=>{if(!this._bOpen||!this._videoTrack||this.video.paused||e.focusTaskId!=this._focusParameters.curFocusTaskId){this._bOpen&&this._videoTrack&&!this.video.paused||(this._focusParameters.isDoingFocus=0);const t=new Error(`Focus task ${e.focusTaskId} canceled.`);throw t.name="DeprecatedTaskError",t}1===this._focusParameters.isDoingFocus&&Date.now()-e.timeStart>this._focusParameters.focusCancelableTime&&(this._focusParameters.isDoingFocus=-1)};let r;t=ce(t,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),await this._videoTrack.applyConstraints({advanced:[{focusMode:"manual",focusDistance:t}]}),i(e),r=null==this._focusParameters.oldDistance?this._focusParameters.kTimeout*Math.max(Math.abs(1/this._focusParameters.fds.min-1/t),Math.abs(1/this._focusParameters.fds.max-1/t))+this._focusParameters.minTimeout:this._focusParameters.kTimeout*Math.abs(1/this._focusParameters.oldDistance-1/t)+this._focut,this._focusParameters.oldDistance=t,await new Promise((e=>{setTimeout(e,r)})),i(e);let n=e.focusL-e.focusW/2,s=e.focusT-e.focusH/2,o=e.focusW,a=e.focusH;if(n>=this.video.videoWidth||s>=this.video.videoHeight)throw new Error("Invalid area.");n+o>this.video.videoWidth&&(o=this.video.videoWidth-n),s+a>this.video.videoHeight&&(a=this.video.videoHeight-s);const h=this._getImageData(this.video,this.video.videoWidth,this.video.videoHeight,{sx:n,sy:s,sWidth:o,sHeight:a,dWidth:o,dHeight:a},null,{pixelFormat:le.RGBA});if(!h)return this._setFocusAndGetContract(e,t);const l=h.data;let c=0;for(let e=0,t=l.length-8;e<t;++e){let t=l[e]-l[e+8];++e;let i=l[e]-l[e+8];++e;let r=l[e]-l[e+8];++e,c+=t*t+i*i+r*r}return-c}async _doFocusDetail(e,t,i,r,n,s,o){let a;if(t=ce(t,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),r=ce(r,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),s?s=ce(s,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max):(s=ce(Math.sqrt((t||this._focusParameters.fds.step)*(r||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),o=await this._setFocusAndGetContract(e,s)),o<=i&&o<=n?a=3:i<n&&i<o?a=1:n<i&&n<o&&(a=2),(r-t)/2<=this._focusParameters.fds.step)return 3===a||(1===a?await this._videoTrack.applyConstraints({advanced:[{focusMode:"manual",focusDistance:t}]}):2===a&&await this._videoTrack.applyConstraints({advanced:[{focusMode:"manual",focusDistance:r}]})),!0;if(1===a)return await this._doFocusDetail(e,t,i,s,o);if(2===a)return await this._doFocusDetail(e,s,o,r,n);if(3!==a)return i=await this._setFocusAndGetContract(e,t),n=await this._setFocusAndGetContract(e,r),await this._doFocusDetail(e,t,i,r,n);let h=ce(Math.sqrt((t||this._focusParameters.fds.step)*(s||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),l=ce(Math.sqrt((r||this._focusParameters.fds.step)*(s||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max);if(Math.abs(1/this._focusParameters.oldDistance-1/h)<=Math.abs(1/this._focusParameters.oldDistance-1/l)){let a=await this._setFocusAndGetContract(e,h);if(a<o)return await this._doFocusDetail(e,t,i,s,o,h,a);if(a==o)return await this._doFocusDetail(e,h,a,s,o);let c=await this._setFocusAndGetContract(e,l);if(a>o&&o<c)return await this._doFocusDetail(e,h,a,l,c,s,o);if(o==c)return await this._doFocusDetail(e,s,o,l,c);if(o>c)return await this._doFocusDetail(e,s,o,r,n,l,c)}else{let a=await this._setFocusAndGetContract(e,l);if(o>a)return await this._doFocusDetail(e,s,o,r,n,l,a);if(o==a)return await this._doFocusDetail(e,s,o,l,a);let c=await this._setFocusAndGetContract(e,h);if(c>o&&o<a)return await this._doFocusDetail(e,h,c,l,a,s,o);if(c==o)return await this._doFocusDetail(e,h,c,s,o);if(c<o)return await this._doFocusDetail(e,t,i,s,o,h,c)}return!1}async _setLocalFocus(e,t,i,r,n){if(1==this._focusParameters.isDoingFocus)return!1;if(!e||"string"!=typeof e.x||"string"!=typeof e.y)throw new Error("Invalid centerPoint.");if(!t||"string"!=typeof t)throw new Error("Invalid width.");if(!i||"string"!=typeof i)throw new Error("Invalid height.");const s=this._video.videoWidth,o=this._video.videoHeight;let a=0,h=0;if(e.x.endsWith("px"))a=parseFloat(e.x);else{if(!e.x.endsWith("%"))throw new Error("Invalid centerPoint.");a=parseFloat(e.x)/100*s}if(e.y.endsWith("px"))h=parseFloat(e.y);else{if(!e.y.endsWith("%"))throw new Error("Invalid centerPoint.");h=parseFloat(e.y)/100*o}if(NaN==a||NaN==h)throw new Error("Invalid centerPoint.");let l=0;if(t.endsWith("px"))l=parseFloat(t);else{if(!t.endsWith("%"))throw new Error("Invalid width.");l=parseFloat(t)/100*s}if(NaN==l)throw new Error("Invalid width.");let c=0;if(i.endsWith("px"))c=parseFloat(i);else{if(!i.endsWith("%"))throw new Error("Invalid height.");c=parseFloat(i)/100*o}if(NaN==c)throw new Error("Invalid height.");if(1!==this._softwareScale){const e=this._softwareScale,t=this._scaleCenter;l/=e,c/=e,a=(1-1/e)*t.x+a/e,h=(1-1/e)*t.y+h/e}if(!this._focusSupported)throw new Error("Manual focus unsupported.");if(!this._focusParameters.fds&&(this._focusParameters.fds=(await this.getCapabilities()).focusDistance,!this._focusParameters.fds))throw this._focusSupported=!1,new Error("Manual focus unsupported.");null==this._focusParameters.kTimeout&&(this._focusParameters.kTimeout=(this._focusParameters.maxTimeout-this._focusParameters.minTimeout)/(1/this._focusParameters.fds.min-1/this._focusParameters.fds.max)),this._focusParameters.isDoingFocus=1;const u={focusL:a,focusT:h,focusW:l,focusH:c,focusTaskId:++this._focusParameters.curFocusTaskId,timeStart:Date.now()},d=async(e,t,i)=>{try{(null==t||t<this._focusParameters.fds.min)&&(t=this._focusParameters.fds.min),(null==i||i>this._focusParameters.fds.max)&&(i=this._focusParameters.fds.max),this._focusParameters.oldDistance=null;let r=ce(Math.sqrt(i*(t||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),n=ce(Math.sqrt((t||this._focusParameters.fds.step)*r),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),s=ce(Math.sqrt(r*i),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),o=await this._setFocusAndGetContract(e,s),a=await this._setFocusAndGetContract(e,n),h=await this._setFocusAndGetContract(e,r);if(a>h&&h<o){const t=await this._doFocusDetail(e,n,a,s,o,r,h);return this._focusParameters.isDoingFocus=0,t}if(a<h&&a<o){let i=await this._setFocusAndGetContract(e,t);const s=await this._doFocusDetail(e,t,i,r,h,n,a);return this._focusParameters.isDoingFocus=0,s}if(h>o&&a>o){let t=await this._setFocusAndGetContract(e,i);const n=await this._doFocusDetail(e,r,h,i,t,s,o);return this._focusParameters.isDoingFocus=0,n}if(a==h&&h<o){const t=await this._doFocusDetail(e,n,a,r,h);return this._focusParameters.isDoingFocus=0,t}if(h==o&&a>h){const t=await this._doFocusDetail(e,r,h,s,o);return this._focusParameters.isDoingFocus=0,t}return d(e,t,i)}catch(e){if("DeprecatedTaskError"!==e.name)throw e}};return d(u,r,n)}async enableTapToFocus(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'enableTapToFocus()' is unavailable in singleFrameMode.");if(!this._videoTrack)throw new Error("Video is not playing.");if(!this._focusSupported)throw new Error("Tapping to focus unsupported.");if(!this._focusParameters.fds&&(this._focusParameters.fds=(await this.getCapabilities()).focusDistance,!this._focusParameters.fds))throw this._focusSupported=!1,this._tapFocusEted.");this._tapFocusEnabled=!0}disableTapToFocus(){this._tapFocusEnabled=!1}isTapToFocusEnabled(){return this._tapFocusEnabled}_updateVideoContainerStyle(){if(!this._video)return;if(this.singleFrameMode)return;const e=this._getSoftwareScale(),t=this._videoContainer;if("contain"===this.videoFit&&e>1){const e=this._video.videoWidth,i=this._video.videoHeight,r=window.getComputedStyle(this._elContainer),n=parseFloat(r.width),s=parseFloat(r.height),o=e/i;if(n/s<o){let e=n/o;t.style.left="0",t.style.top=(s-e)/2/s*100+"%",t.style.width="100%",t.style.height=e/s*100+"%"}else{let e=s*o;t.style.left=(n-e)/2/n*100+"%",t.style.top="0",t.style.width=e/n*100+"%",t.style.height="100%"}}else t.style.left="0",t.style.top="0",t.style.width="100%",t.style.height="100%"}_scaleVideo(e,t){if(this._video&&!this.singleFrameMode){if(e<1)throw new RangeError("Invalid scale value.");if(t&&this._setScaleCenter(t),1===e)this._video.style.transform="";else{const t=this.getVideoFit(),i=this._video.videoWidth,r=this._video.videoHeight,n=window.getComputedStyle(this._elContainer),s=parseFloat(n.width),o=parseFloat(n.height),a=s/o,h=i/r;let l=1;"contain"===t?l=a<h?s/(i/e):o/(r/e):"cover"===t&&(l=h>a?o/(i/e):s/(r/e));const c=l*(1-1/e)*(i/2-this._scaleCenter.x),u=l*(1-1/e)*(r/2-this._scaleCenter.y);this._video.style.transform=`translate(${c}px, ${u}px) scale(${e})`}this._updateVideoContainerStyle()}}getFrameSize(e,t,i,r){if(!e||!t)return null;let n,s,o,a,h=e,l=t;const c={regionLeft:0,regionTop:0,regionRight:h,regionBottom:l,regionMeasuredByPercentage:!1};i?(i.regionMeasuredByPercentage?(c.regionLeft=i.regionLeft*h/100,c.regionTop=i.regionTop*l/100,c.regionRight=i.regionRight*h/100,c.regionBottom=i.regionBottom*l/100):(c.regionLeft=i.regionLeft,c.regionTop=i.regionTop,c.regionRight=i.regionRight,c.regionBottom=i.regionBottom),n=Math.round(c.regionLeft),s=Math.round(c.regionTop),h=Math.round(c.regionRight-c.regionLeft),l=Math.round(c.regionBottom-c.regionTop)):(n=0,s=0,h=Math.round(h),l=Math.round(l));const u=Math.max(h,l);if(r&&r>0&&u>r){const e=r/u;h>l?(o=r,a=Math.round(l*e)):(o=Math.round(h*e),a=r)}else o=h,a=l;return o<=0||a<=0?null:{sx:n,sy:s,sWidth:h,sHeight:l,dWidth:o,dHeight:a}}getFrame(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getFrame()' is unavailable in singleFrameMode.");return this._getVideoData()}getImage(){return this.getFrame()}_drawImage(e,t,i,r,n,s,o){if(this.isDisposed&&this.disposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(!i||!r)return null;if(t instanceof HTMLVideoElement&&4!==t.readyState||t instanceof HTMLImageElement&&!t.complete)throw new Error("The source is not loaded.");let a;ue._onLog&&(a=Date.now(),ue._onLog("DCE: _drawImage(), START: "+a));let h=0,l=0,c=i,u=r,d=0,f=0,g=i,_=r;n&&(n.sx&&(h=Math.round(n.sx)),n.sy&&(l=Math.round(n.sy)),n.sWidth&&(c=Math.round(n.sWidth)),n.sHeight&&(u=Math.round(n.sHeight)),n.dx&&(d=Math.round(n.dx)),n.dy&&(f=Math.round(n.dy)),n.dWidth&&(g=Math.round(n.dWidth)),n.dHeight&&(_=Math.round(n.dHeight)));let p=le.RGBA;o&&o.pixelFormat&&(p=o.pixelFormat);const m=e;if(o&&o.bUseWebGL){ue._onLog&&ue._onLog("DCE: _drawImage() in WebGL."),(m.width<d+g||m.height<f+_)&&(m.width=d+g,m.height=f+_,m.ctxWebGL&&m.ctxWebGL.viewport(0,0,d+g,f+_));const e=m.ctxWebGL||m.getContext("webgl",{antialias:!1})||m.getContext("experimental-webgl",{antialias:!1});if(!e){ue._onLog&&ue._onLog("DCE: WebGL unavailable.");const e=new Error("WebGL error: unable to initialize WebGL. Your browser or machine may not support it.");throw e.name="WebGLError",e}if(!m.ctxWebGL||p!==this.shaderPixelFormat){m.ctxWebGL=e;const t=e=>{const t=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,t),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),e.STATIC_DRAW);const i=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,i),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),e.STATIC_DRAW),{positions:t,texCoords:i}},i=e=>{const t=e.createTexture();return e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE),t},r=(e,t)=>{const i=e.createProgram();if(t.forEach((t=>e.attachShader(i,t))),e.linkProgram(i),!e.getProgramParameter(i,e.LINK_STATUS)){const t=new Error(`An error occured linking the program: ${e.getProgramInfoLog(i)}.`);throw t.name="WebGLError",t}return e.useProgram(i),i},n=(e,t,i)=>{const r=e.createShader(t);if(e.shaderSource(r,i),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS)){const t=new Error(`An error occured compiling the shader: ${e.getShaderInfoLog(r)}.`);throw t.name="WebGLError",t}return r},s="\n                    attribute vec2 a_position;\n                    attribute vec2 a_texCoord;\n\n                    uniform mat3 u_matrix;\n                    uniform mat3 u_textureMatrix;\n\n                    varying vec2 v_texCoord;\n                    void main(void) {\n                    gl_Position = vec4((u_matrix * vec3(a_position, 1)).xy, 0, 1.0);\n                    v_texCoord = vec4((u_textureMatrix * vec3(a_texCoord, 1)).xy, 0, 1.0).xy;\n                    }\n                ";let o="rgb";["rgba","rbga","grba","gbra","brga","bgra"].includes(p)&&(o=p.slice(0,3));const a=`\n                    precision mediump float;\n                    varying vec2 v_texCoord;\n                    uniform sampler2D u_image;\n                    uniform float uColorFactor;\n\n                    void main() {\n                        vec4 sample = texture2D(u_image, v_texCoord);\n                        float grey = 0.21 * sample.r + 0.71 * sample.g + 0.07 * sample.b;\n                        gl_FragColor = vec4(sample.${o} * (1.0 - uColorFactor) + (grey * uColorFactor), sample.a);\n                    }\n                `,h=r(e,[n(e,e.VERTEX_SHADER,s),n(e,e.FRAGMENT_SHADER,a)]);this._webGLProgramInfo={program:h,attribLocations:{vertexPosition:e.getAttribLocation(h,"a_position"),texPosition:e.getAttribLocation(h,"a_texCoord")},uniformLocations:{uSampler:e.getUniformLocation(h,"u_image"),uColorFactor:e.getUniformLocation(h,"uColorFactor"),uMatrix:e.getUniformLocation(h,"u_matrix"),uTextureMatrix:e.getUniformLocation(h,"u_textureMatrix")}},this._webGLBuffers=t(e),this._webGLTexture=i(e),this.shaderPixelFormat=p}const n=(e,t,i)=>{e.bindBuffer(e.ARRAY_BUFFER,t),e.enableVertexAttribArray(i),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0)},o=(e,t,i)=>{const r=e.RGBA,n=e.RGBA,s=e.UNSIGNED_BYTE;e.bindTexture(e.TEXTURE_2D,t),e.texImage2D(e.TEXTURE_2D,0,r,n,s,i)},v=(e,t,s,o)=>{e.clearColor(0,0,0,1),e.clearDepth(1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),n(e,s.positions,t.attribLocations.vertexPosition),n(e,s.texCoords,t.attribLocations.texPosition),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,o),e.uniform1i(t.uniformLocations.uSampler,0),e.uniform1f(t.uniformLocations.uColorFactor,[le.GREY,le.GREY32].includes(p)?1:0);let a,m,v=he.translate(he.identity(),-1,-1);v=he.scale(v,2,2),v=he.scale(v,1/e.canvas.width,1/e.canvas.height),a=he.translate(v,d,f),a=he.scale(a,g,_),e.uniformMatrix3fv(t.uniformLocations.uMatrix,!1,a),m=he.translate(he.identity(),h/i,l/r),m=he.scale(m,c/i,u/r),e.uniformMatrix3fv(t.uniformLocations.uTextureMatrix,!1,m),e.drawArrays(e.TRIANGLES,0,6)};let y;if(o(e,this._webGLTexture,t),v(e,this._webGLProgramInfo,this._webGLBuffers,this._webGLTexture),s){if(s.length<g*_*4)throw new Error("Unexpected size of the 'bufferContainer'.");y=s}else y=new Uint8Array(g*_*4);if(e.readPixels(d,f,g,_,e.RGBA,e.UNSIGNED_BYTE,y),255!==y[3]){ue._onLog&&ue._onLog("DCE: WebGL drawing incorrect."),this._bWebGLSupported=!1;const e=new Error("WebGL error: incorrect WebGL drawing.");throw e.name="WebGLError",e}return ue._onLog&&ue._onLog("DCE: _drawImage() in WebGL end. Costs: "+(Date.now()-a)),{context:e,pixelFormat:p===le.GREY?le.GREY32:p,_bUseWebGL:!0}}{ue._onLog&&ue._onLog("DCE: _drawImage() in context2d."),m.ctx2d||(m.ctx2d=m.getContext("2d",{willReadFrequently:!0}));const e=m.ctx2d;if(!e)throw new Error("Unable to get 'CanvasRenderingContext2D' from canvas.");return(m.width<d+g||m.height<f+_)&&(m.width=d+g,m.height=f+_),e.drawImage(t,h,l,c,u,d,f,g,_),ue._onLog&&ue._onLog("DCE: _drawImage() in context2d end. Costs: "+(Date.now()-a)),{context:e,pixelFormat:le.RGBA,_bUseWebGL:!1}}}_readCvsData(e,t,i){let r,n=0,s=0,o=e.canvas.width,a=e.canvas.height;if(t&&(t.x&&(n=t.x),t.y&&(s=t.y),t.width&&(o=t.width),t.height&&(a=t.height)),e instanceof WebGLRenderingContext){const t=e;if(i){if(i.length<o*a*4)throw new Error("Unexpected size of the 'bufferContainer'.");t.readPixels(n,s,o,a,t.RGBA,t.UNSIGNED_BYTE,i),r=new Uint8Array(i.buffer,0,o*a*4)}else r=new Uint8Array(o*a*4),t.readPixels(n,s,o,a,t.RGBA,t.UNSIGNED_BYTE,r)}else if(e instanceof CanvasRenderingContext2D){let t;if(t=e.getImageData(n,s,o,a),r=new Uint8Array(t.data.buffer),i){if(i.length<r.length)throw new Error("Unexpected size of the 'bufferContainer'.");i.set(r)}}return r}_transformPixelFormat(e,t,i,r){let n,s;if(ue._onLog&&(n=Date.now(),ue._onLog("DCE: _transformPixelFormat(), START: "+n)),t===i)return ue._onLog&&ue._onLog("DCE: _transformPixelFormat() end. Costs: "+(Date.now()-n)),r?new Uint8Array(e):e;const o=[le.RGBA,le.RBGA,le.GRBA,le.GBRA,le.BRGA,le.BGRA];if(o.includes(t))if(i===le.GREY){s=new Uint8Array(e.length/4);for(let t=0;t<e.length;t+=4){const i=.21*e[t]+.71*e[t+1]+.07*e[t+2];s[t/4]=i}}else if(i===le.GREY32){s=r?new Uint8Array(e):e;for(let t=0;t<e.length;t+=4){const i=.21*e[t]+.71*e[t+1]+.07*e[t+2];s[t]=i,s[t+1]=i,s[t+2]=i}}else{if(!o.includes(i))throw new Error("Unable to transform.");if(r){s=new Uint8Array(e);const r=t.indexOf("r"),n=t.indexOf("g"),o=t.indexOf("b"),a=i.indexOf("r"),h=i.indexOf("g"),l=i.indexOf("b");for(let t=0;t<e.length;t+=4)s[t+a]=e[t+r],s[t+h]=e[t+n],s[t+l]=e[t+o]}else{s=e;const r=t.indexOf("r"),n=t.indexOf("g"),o=t.indexOf("b"),a=i.indexOf("r"),h=i.indexOf("g"),l=i.indexOf("b");for(let t=0;t<e.length;t+=4){let i=[e[t],e[t+1],e[t+2]];s[t+a]=i[r],s[t+h]=i[n],s[t+l]=i[o]}}}else if(t===le.GREY){if(i!==le.GREY32)throw new Error("Unable to transform.");s=new Uint8Array(4*e.length);for(let t=0;t<e.length;t++)s[4*t]=e[t],s[4*t+1]=e[t],s[4*t+2]=e[t],s[4*t+3]=255}else{if(t!==le.GREY32)throw new Error("Unable to transform.");if(i!==le.GREY)throw new Error("Unable to transform.");s=new Uint8Array(new Uint32Array(e.buffer))}return ue._onLog&&ue._onLog("DCE: _transformPixelFormat() end. Costs: "+(Date.now()-n)),s}_getImageData(e,t,i,r,n,s){if(this.isDisposed&&this.disposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(!t||!i)return null;if(r.sx>t||r.sy>i||r.sx+r.sWidth>t||r.sy+r.sHeight>i)throw new Error("Invalid position.");if(e instanceof HTMLVideoElement&&4!==e.readyState||e instanceof HTMLImageElement&&!e.complete)throw new Error("The source is not loaded.");let o;ue._onLog&&(o=Date.now(),ue._onLog("DCE: _getImageData(), START: "+o));const a=Math.round(r.sx),h=Math.round(r.sy),l=Math.round(r.sWidth),c=Math.round(r.sHeight),u=Math.round(r.dWidth),d=Math.round(r.dHeight);let f=le.RGBA;s&&s.pixelFormat&&(f=s.pixelFormat);let g,_,p,m=this._bWebGLSupported;s&&0==s.bUseWebGL&&(m=!1),m?(this._reusedWebGLCvs||(this._reusedWebGLCvs=document.createElement("canvas")),g=this._reusedWebGLCvs):(this._reusedCvs||(this._reusedCvs=document.createElement("canvas")),g=this._reusedCvs);try{if(m)if(ue._onLog&&ue._onLog("DCE: _getImageData() in WebGL."),n)if(f===le.GREY){if(p=new Uint8Array(u*d*4),_=this._drawImage(g,e,t,i,{sx:a,sy:h,sWidth:l,sHeight:c,dWidth:u,dHeight:d},p,{pixelFormat:f,bUseWebGL:m}),p=this._transformPixelFormat(p,_.pixelFormat,f),n){if(n.length<p.length)throw new Error("Unexpected size of the 'bufferContainer'.");n.set(p)}}else _=this._drawImage(g,e,t,i,{sx:a,sy:h,sWidth:l,sHeight:c,dWidth:u,dHeight:d},n,{pixelFormat:f,bUseWebGL:m}),p=new Uint8Array(n.buffer,0,u*d*4),p=this._transformPixelFormat(p,_.pixelFormat,f);else f===le.GREY?((!this._tempDataContainer||this._tempDataContainer.length<u*d*4)&&(this._tempDataContainer=new Uint8Array(u*d*4)),p=new Uint8Array(this._tempDataContainer.buffer,0,u*d*4)):p=new Uint8Array(u*d*4),_=this._drawImage(g,e,t,i,{sx:a,sy:h,sWidth:l,sHeight:c,dWidth:u,dHeight:d},p,{pixelFormat:f,bUseWebGL:m}),p=this._transformPixelFormat(p,_.pixelFormat,f);else if(ue._onLog&&ue._onLog("DCE: _getImageData() in context2d."),_=this._drawImage(g,e,t,i,{sx:a,sy:h,sWidth:l,sHeight:c,dWidth:u,dHeight:d},null,{pixelFormat:le.RGBA,bUseWebGL:m}),p=this._readCvsData(_.context,null,null),p=this._transformPixelFormat(p,_.pixelFormat,f),n){if(n.length<p.length)throw new Error("Unexpected size of the 'bufferContainer'.");n.set(p)}}catch(r){if("WebGLError"===r.name)return ue._onLog&&ue._onLog("DCE: _getImageData() in WebGL failed, try again in context2d."),this.forceLoseContext(),this._bWebGLSupported=!1,this._getImageData(e,t,i,{sx:a,sy:h,sWidth:l,sHeight:c,dWidth:u,dHeight:d},n,s);throw r}return ue._onLog&&ue._onLog("DCE: _getImageData() end. Costs: "+(Date.now()-o)),{data:p,pixelFormat:f,_bUseWebGL:_._bUseWebGL}}forceLoseContext(){if(!this._reusedWebGLCvs)return;const e=this._reusedWebGLCvs.ctxWebGL;e&&!e.isContextLost()&&e.getExtension("WEBGL_lose_context")&&e.getExtension("WEBGL_lose_context").loseContext(),this._webGLTexture=null,this._webGLProgramInfo=null,this._webGLBuffers=null,this._reusedWebGLCvs=null}_getVideoData(e,t){if(this.isDisposed&&this.disposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(this._assertOpen(),this.singleFrameMode)throw new Error("'_getVideoData()' is unavailable in singleFrameMode.");if(!this._video||4!==this._video.readyState)return null;const i=Date.now();ue._onLog&&ue._onLog("DCE: _getVideoData() START: "+i);let r=this._scanRegion;t&&t.hasOwnProperty("region")&&(r=t.region);let n=this.mapPixelFormatString_Enum.get(this.framePixelFormat.toLowerCase());t&&t.pixelFormat&&(n=this.mapPixelFormatString_Enum.get(t.pixelFormat.toLowerCase()));let s=this._softwareScale;t&&t.scale&&(s=t.scale);const o=this._video.videoWidth,a=this._video.videoHeight;let h=this._scaleCenter;if(t&&t.scaleCenter){if("string"!=typeof t.scaleCenter.x||"string"!=typeof t.scaleCenter.y)throw new Error("Invalid scale center.");let e=0,i=0;if(t.scaleCenter.x.endsWith("px"))e=parseFloat(t.scaleCenter.x);else{if(!t.scaleCenter.x.endsWith("%"))throw new Error("Invalid scale center.");e=parseFloat(t.scaleCenter.x)/100*o}if(t.scaleCenter.y.endsWith("px"))i=parseFloat(t.scaleCenter.y);else{if(!t.scaleCenter.y.endsWith("%"))throw new Error("Invalid scale center.");i=parseFloat(t.scaleCenter.y)/100*a}if(NaN==e||NaN==i)throw new Error("Invalid scale center.");h.x=Math.round(e),h.y=Math.round(i)}if(0===o||0===a)return null;const l=this.getFrameSize(o,a,r,this.maxCvsSideLength);if(!l)return null;let c=!0;o===l.sWidth&&a===l.sHeight&&(c=!1);const u={data:null,region:r?JSON.parse(JSON.stringify(r)):null,sx:l.sx,sy:l.sy,width:l.dWidth,height:l.dHeight,colorMode:null,pixelFormat:null,timeSpent:null,timeStamp:null,isCropped:c,toCanvas:this._toCanvas,_sWidth:l.sWidth,_sHeight:l.sHeight,_bUseWebGL:null};1!==s&&(l.sWidth=Math.round(l.sWidth/s),l.sHeight=Math.round(l.sHeight/s),l.sx=Math.round((1-1/s)*h.x+l.sx/s),l.sy=Math.round((1-1/s)*h.y+l.sy/s));const d=this._getImageData(this._video,o,a,l,e,{pixelFormat:n});if(!d)return null;const f=Date.now();return ue._onLog&&ue._onLog("DCE: _getVideoData() END: "+f),u.data=d.data,u.pixelFormat=u.colorMode=d.pixelFormat,u._bUseWebGL=d._bUseWebGL,u.timeSpent=f-i,u.timeStamp=f,d.pixelFormat===le.GREY?u.stride=u.width:u.stride=4*u.width,u}getCurrentRegion(){let e=null;if(this._scanRegion)e=this._scanRegion;else if(this.croppingRegions){if(this._croppingRegionIndex>=this.croppingRegions.length||this._croppingRegionIndex<0)throw new Error("The 'croppingRegionIndex' is out of bounds.");e=this.croppingRegions[this._croppingRegionIndex],this.bIncreaseRegionIndexAuto&&++this._croppingRegionIndex>=this.croppingRegions.length&&(this._croppingRegionIndex=0)}return e}_fetchingLoop(e){if(this.isDisposed&&this.disposed)return;if(!this._bOpen||!this.isFetchingLoopStarted())return void this.stopFetchingLoop();const t=()=>{ue._onLog&&ue._onLog("DCE: start fetching a frame into buffer: "+Date.now());const e=this.getCurrentRegion();let t=this._getVideoData(null,{region:e});if(!t)return void ue._onLog;for(;this._frameQueue&&this._frameQueue.length>=this.maxNumberOfFramesInBuffer;)this._frameQueue.shift();this._frameQueue.push(t);const i=this.mapCameraEvents.get("frameaddedtobuffer");for(let e of i)e&&setTimeout((()=>{this.isDisposed&&this.disposed||e.apply(this)}),0)},i=()=>{this.isDisposed&&this.disposed||(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this.refreshInterval<=0||(this._frameLoopTimeoutId2=setTimeout((()=>{this.isDisposed&&this.disposed||(this._bOpen&&this.isFetchingLoopStarted()?(t(),i()):this.stopFetchingLoop())}),this.refreshInterval)))};e&&(this._frameQueue.length<this.maxNumberOfFramesInBuffer?(t(),this.refreshInterval>0&&i()):this.refreshInterval>0?(t(),i()):0===this.refreshInterval?t():this.refreshInterval),this._frameLoopTimeoutId&&clearTimeout(this._frameLoopTimeoutId),this._frameLoopTimeoutId=setTimeout((()=>{this.isDisposed&&this.disposed||this._fetchingLoop(!0)}),this.loopInterval)}startFetchingLoop(){if(this.isDisposed&&this.disposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(this._assertOpen(),this.singleFrameMode)throw Error("'startFetchingLoop()' is unavailable in singleFrameMode.");this.isFetchingLoopStarted()||(this._bFetchingLoopStarted=!0,this._recordedStates.fetchingLoopStart=!0,ue._onLog&&ue._onLog("DCE: start fetching loop: "+Date.now()),this._fetchingLoop(!0))}isFetchingLoopStarted(){return this._bFetchingLoopStarted}stopFetchingLoop(){this._bFetchingLoopStarted&&(ue._onLog&&ue._onLog("DCE: stop fetching loop: "+Date.now()),this._frameLoopTimeoutId&&clearTimeout(this._frameLoopTimeoutId),this._frameQueue.length=0,this._bFetchingLoopStarted=!1,this._recordedStates.fetchingLoopStart=!1)}getFrameFromBuffer(e){return this._frameQueue&&this._frameQueue.length?e?e<this._frameQueue.length?(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this._frameQueue.splice(e,1)[0]):void 0:(this._frameLoopTimpop()):null}clearFrameBuffer(){this._frameQueue&&(this._frameQueue.length=0)}_createDrawingLayerBaseCvs(){this._assertOpen();const e=this._calculateCvsSize();if(!e)throw new Error("Camera is not open.");const{width:t,height:i,objectFit:r}=e;if(t<=0||i<=0)throw new Error("Invalid dimension of video or image.");const n=document.createElement("canvas");if(n.width==t&&n.height==i||(n.width=t,n.height=i),n.style.objectFit=r,this._cvsScanRegion)this._cvsScanRegion.after(n);else if(this._cvsOriginalImage)this._cvsOriginalImage.after(n);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(n);else{if(!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(n)}return n}_updateDrawingLayersSize(e){let t;if(t=e&&e.width&&e.height&&e.objectFit?{width:e.width,height:e.height,objectFit:e.objectFit}:this._calculateCvsSize(),!t)return;const{width:i,height:r,objectFit:n}=t;this._drawingLayersManager.setDimensions({width:i,height:r},{backstoreOnly:!0}),this._drawingLayersManager.setObjectFit(n)}_createDrawingLayer(e){this._layerBaseCvs||(this._layerBaseCvs=this._createDrawingLayerBaseCvs());const t=this._layerBaseCvs;return this._drawingLayersManager.createDrawingLayer(t,e)}deleteDrawingLayer(e){this._drawingLayersManager.deleteDrawingLayer(e),this._drawingLayersManager.getDrawingLayers().lengs._layerBaseCvs=null)}createDrawingLayer(){return this._createDrawingLayer()}getDrawingLayer(e){return this._drawingLayersManager.getDrawingLayer(e)||([1,2,3].includes(e)?this._createDrawingLayer(e):null)}getDrawingLayers(){return this._drawingLayersManager.getDrawingLayers().filter((e=>e.getId()>=0))}getSelectedDrawingItems(){return this._drawingLayersManager.getSelectedDrawingItems()}createDrawingStyle(e){return this._drawingLayersManager.createDrawingStyle(e)}getDrawingStyle(e){return this._drawingLayersManager.getDrawingStyeDrawingStyle(e,t){return this._drawingLayersManager.updateDrawingStyle(e,t)}clearDrawingLayers(){const e=this.getDrawingLayers();for(let t of e)this.deleteDrawingLayer(t.getId())}showTip(e,t,i,r,n=3e3,s=!0){this._assertOpen(),this._tipArgs.x=e,this._tipArgs.y=t,this._tipArgs.width=i,this._tipArgs.autoShowSuggestedTip=!!s,this._drawingLayerOfTip||(this._drawingLayerOfTip=this._createDrawingLayer(-1)),this._tipStyleId||(this._tipStyleId=this.createDrawingStyle({fillStyle:"#FFFFFF",paintMode:"fill",fontFamily:"Open Sans",fontSize:40})),this._drawingLayerOfTip.clearDrawingItems();const o=new ne(r||"",e,t,i,this._tipStyleId);o._fabricObject.paddingTop=15,o._fabricObject.calcTextHeight=function(){for(var e=0,t=0,i=this._textLines.length;t<i;t++)e+=this.getHeightOfLine(t);return e+2*this.paddingTop},o._fabricObject._getTopOffset=function(){return-this.height/2+this.getHeightOfLine(0)*(1-1/this.lineHeight)/2+this.paddingTop},o.setAttribute("backgroundColor","rgba(50, 50, 52, .8)"),o.setAttribute("lineHeight",1.3),o.setAttribute("textAlign","center"),this._drawingLayerOfTip.addDrawingItem(o),this._hideTipTimeoutId&&clearTimeout(this._hideTipTimeoutId),this._tipArgs.duration=void 0===n?3e3:n,this._tipArgs.duration>0&&(this._hideTipTimeoutId=setTimeout((()=>{this.isDisposed&&this.disposed||this._hideTip()}),this._tipArgs.duration))}_hideTip(){this._drawingLayerOfTip&&(this.deleteDrawingLayer(this._drawingLayerOfTip.getId()),this._drawingLayerOfTip=null,this._hideTipTimeoutId&&clearTimeout(this._hideTipTimeoutId))}hideTip(){this._hideTip(),this._tipArgs.x=null,this._tipArgs.y=null,this._tipArgs.width=null,this._tipArgs.autoShowSuggestedTip=null}updateTipMessage(e){if(!this._drawingLayerOfTip)throw new Error("The Tip is not showing.");this._drawingLayerOfTip.getDrawingItems()[0].setAttribute("text",e),this._drawingLayerOfTip.renderAll(),this._tipArgs.duration>0&&(this._hideTipTimeoutId&&clearTimeout(this._hideTipTimeoutId),this._hideTipTimeoutId=setTimeout((()=>{this.isDisposed&&this.disposed||this._hideTip()}),this._tipArgs.duration))}suggestTip(e,t){this._tipArgs.autoShowSuggestedTip&&(this._drawingLayerOfTip?this.updateTipMessage(t):void 0!==this._tipArgs.x&&this.showTip(this._tipArgs.x,this._tipArgs.y,this._tipArgs.width,t,this._tipArgs.duration)),this.onTipSuggested&&setTimeout((()=>{this.isDisposed&&this.disposed||this.onTipSuggested.apply(this,[e,t])}),0)}_createControler(){if(this._cons._controler)return this._controler}_destroyControler(){this._controler=null}setOriginalImage(e,t,i){if(!e||!t||!i)throw new Error("Invalid arguments");this._originalImageData={imageData:e,width:t,height:i};let r=this._cvsOriginalImage;r||(r=document.createElement("canvas"),r.style.position="absolute",r.style.width="100%",r.style.height="100%",r.style.left="0",r.style.top="0",r.style.backgroundColor="white",r.style.objectFit="contain",this._cvsOriginalImage=r),r.width===t&&r.height===i||(r.width=t,r.height=i);const n=r.getContext("2d");n.clearRect(0,0,r.width,r.height),e instanceof Uint8Array||e instanceof Uint8ClampedArray?(e instanceof Uint8Array&&(e=new Uint8ClampedArray(e.buffer)),n.putImageData(new ImageData(e,t,i),0,0)):e instanceof HTMLCanvasElement&&n.drawImage(e,0,0),document.body.contains(r)&&""===r.style.display&&this._upeturn this._originalImageData?Object.assign({},this._originalImageData):null}async deleteOriginalImage(){await this.hideOriginalImage(),this._cvsOriginalImage&&(this._cvsOriginalImage.remove(),this._cvsOriginalImage=null),this._originalImageData=null}_showOriginalImageCvs(){this._cvsOriginalImage&&"none"==this._cvsOriginalImage.style.display&&(this._cvsOriginalImage.style.display="")}_hideOriginalImageCvs(){this._cvsOriginalImage&&(this._cvsOriginalImage.style.display="none")}showOriginalImage(){if(!this._originalImageData)throw new Error("No original image is set.");const e=this._cvsOriginalImage;if(""===e.style.display&&document.body.contains(e))return;const{width:t,height:i}=this._originalImageData;if(this._updateDrawingLayersSize({width:t,height:i,objectFit:"contain"}),this._bOpen&&(this._video&&!this._video.paused&&this._video.pause(),this._bFetchingLoopStarted&&(this.stopFetchingLoop(),this._recordedStates.fetchingLoopStart=!0),this.ifShowScanRegionMask&&this._cvsScanRegion&&(this._cvsScanRegion.style.display="none"),this.ifShowScanRegionLaser&&this._divScanLight&&(this._divScanLight.style.display="none"),this._cvsViewDecorator&&(this._cvsViewDecorator.style.display="none"),this._scanRegionOverlayContainer&&(this._scanRegionOverlayContainer.style.display="none"),this._selCam&&(this._selCam.parentElement.style.display="none")),!document.body.contains(e))if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(e);else{if(!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(e)}this._showOriginalImageCvs()}async _hideOriginalImage(e){this._originalImageData&&this._cvsOriginalImage&&"none"!==this._cvsOriginalImage.style.display&&(this._updateDrawingLayersSize(),this._bOpen&&e&&(this._video&&this._recordedStates.videoPlaying&&await this.play(null,null,null,{notTriggerSingleFrameClick:!0}),this._recordedStates.fetchingLoopStart&&!this.singleFrameMode&&this.startFetchingLoop(),this.ifShowScanRegionMask&&this._cvsScanRegion&&this._recordedStates.maskShow&&this.showScanRegionMask(),this.ifShowScanRegionLaser&&this._divScanLight&&this._recordedStates.laserShow&&this.showScanRegionLaser(),this._cvsViewDecorator&&this._recordedStates.decoratorShow&&this.showViewDecorator(),this._scanRegionOverlayContainer&&this._recordedStates.overlayShow&&this.showScanRegionOverlays()),this._selCaminalImageCvs())}async hideOriginalImage(){return this._hideOriginalImage(!0)}transformCoord(e){if(!this.isOpen())throw new Error("Unavailable when the camera is not open.");if(this.singleFrameMode&&!this._cvsSingleFrameMode)throw new Error("No image is selected. ");const t=this._elContainer.getBoundingClientRect();let i,r,n,s,o,a=t.left,h=t.top,l=a+window.scrollX,c=h+window.scrollY;this.singleFrameMode?(i=this._cvsSingleFrameMode.width,r=this._cvsSingleFrameMode.height,n=parseFloat(window.getComputedStyle(this._cvsSingleFrameMode).width),s=parseFloat(window.getComputedStyle(this._cvsSingleFrameMode).height),o="contain"):(i=this.video.videoWidth,r=this.video.videoHeight,n=parseFloat(window.getComputedStyle(this._elContainer).width),s=parseFloat(window.getComputedStyle(this._elContainer).height),o=this.videoFit);const u=n/s,d=i/r;let f,g,_,p,m=1;if("contain"===o)u<d?(m=n/i,f=a+e.x*m,g=h+e.y*m+(s-r*m)/2,_=l+e.x*m,p=c+e.y*m+(s-r*m)/2):(m=s/r,f=a+e.x*m+(n-i*m)/2,g=h+e.y*m,_=l+e.x*m+(n-i*m)/2,p=c+e.y*m);else if("cover"===o)if(u<d){m=s/r;let t=e.x*m-(i*m-n)/2;t=Math.max(t,0),t=Math.min(t,n),f=a+t,g=h+e.y*m,_=l+t,p=c+e.y*m}else{m=n/i;let t=e.y*m-(r*m-s)/2;t=Math.max(t,0),t=Math.min(t,s),f=a+e.x*m,g=h+t,_=l+e.x*m,p=c+t}return{clientX:Math.round(f),clientY:Math.round(g),pageX:Math.round(_),pageY:Math.round(p)}}convertToPageCoordinates(e){const toordinates(e){const t=this.transformCoord(e);return{x:t.clientX,y:t.clientY}}dispose(e){this.UIElement&&(this._uiOriginalState&&this._uiOriginalState.inDom?this.UIElement.style.display=this._uiOriginalState.display:this.UIElement.style.display="none"),this.clearDrawingLayers(),this.close(),this.forceLoseContext(),this.setViewDecorator(null,null),this._scanRegionOverlayContainer&&this._scanRegionOverlayContainer.remove(),this._arrScanRegionOverlays.length=0,e&&this.UIElement&&this.UIElement.remove(),this.__proto__=null;for(let e in this)delete this[e];Object.defineProperty(this,"isCameraEnhancer",{value:!0}),Object.defineProperty(this,"isDisposed",{value:!0}),Object.defineProperty(this,"disposed",{value:!0})}}ue._jsVersion="3.3.4",ue._jsEditVersion="20230414",ue._version="JS "+ue._jsVersion+"."+ue._jsEditVersion,ue.browserInfo=Y,ue._hasEngineResourceLoaded=!1,ue._engineResourcePath=K,ue._defaultUIElementURL="@engineResourcePath/dce.ui.html";const de={DT_Arc:class extends q{constructor(e,t,i,r,n,s){super(new j.Circle({left:e,top:t,radius:i,startAngle:r,endAngle:n}),s),this._mediaType="arc"}},DT_Polygon:ie,DT_Rect:class extends q{constructor(e,t,i,r,n){super(new j.Rect({left:e,top:t,width:i,height:r}),n)}},DT_Image:class extends q{constructor(e,t,i,r){super(new j.Image(e,{left:t,top:i}),r),this.image=e}_extendSet(e,t){if("image"===e){if(t instanceof HTMLImageElement)return this._fabricObject.setElement(t),this.image=t,!0;if(t instanceof HTMLCanvasElement){const e=new Image;return e.src=t.toDataURL(),this._fabricObject.setElement(e),this.image=t,!0}throw new Error("Unsupported value.")}}_extendGet(e){if("image"===e)return this.image}},DT_Text:ne,DT_Line:class extends ie{constructor(e,t,i){super([e,t],i),this._mediaType="line"}_extendSet(e,t){if("startPoint"===e||"endPoint"===e){t="startPoint"===e?[t,this.get("endPoint")]:[this.get("startPoint"),t];const i=this._fabricObject;if(i.group){const e=i.group;i.points=t.map((t=>({x:t.x-e.left-e.width/2,y:t.y-e.top-e.height/2}))),e.addWithUpdate()}else i.points=t;const r=i.points.length-1;return i.controls=i.points.reduce((function(e,t,i){return e["p"+i]=new j.Control({positionHandler:Q,actionHandler:te(i>0?i-1:r,ee),actionName:"modifyPolygon",pointIndex:i}),e}),{}),i._setPositionDimensions({}),!0}}_extendGet(e){if("startPoint"===e||"endPoint"===e){const t=[],i=this._fabricObject;if(i.selectable&&!i.group)for(let e in i.oCoords)t.push({x:i.oCoords[e].x,y:i.oCoords[e].y});else for(let e of i.points){let r=e.x-i.pathOffset.x,n=e.y-i.pathOffset.y;const s=j.util.transformPoint({x:r,y:n},i.calcTransformMatrix());t.push({x:s.x,y:s.y})}return"startPoint"===e?t[0]:t[1]}}},DT_Group:class extends q{constructor(e){super(new j.Group(e.map((e=>e._getFabricObject())))),this._fabricObject.on("selected",(()=>{this.styleSelector="selected";const e=this._fabricObject._objects;for(let t of e)setTimeout((()=>{t&&t.fire("selected")}),0);setTimeout((()=>{this._fabricObject&&this._fabricObject.canvas&&(this._fabricObject.dirty=!0,this._fabricObject.canvas.renderAll())}),0)})),this._fabricObject.on("deselected",(()=>{this.styleSeleabricObject._objects;for(let t of e)setTimeout((()=>{t&&t.fire("deselected")}),0);setTimeout((()=>{this._fabricObject&&this._fabricObject.canvas&&(this._fabricObject.dirty=!0,this._fabricObject.canvasgetChildItems(){return this._fabricObject._objects.map((e=>e.getDrawingItem()))}addChildItem(e){if(!e||!e.isDrawingItem)throw TypeError("Illegal drawing item.");this._drawingLayer?this._drawingLayer._updateGroupItem(this,e,"add"):this._fabricObject.addWithUpdate(e._getFabricObject())}removeChildItem(e){e&&e.isDrawingItem&&(this._drawingLayer?this._drawingLayer._updateGroupItem(this,e,"remove"):this._fabricObject.removeWithUpdate(e._getFabricObject()))}}};function fe(e,t,i){return(i.x-e.x)*(t.y-e.y)==(t.x-e.x)*(i.y-e.y)&&Math.min(e.x,t.x)<=i.x&&i.x<=Math.max(e.x,t.x)&&Math.min(e.y,t.y)<=i.y&&i.y<=Math.max(e.y,t.y)}function ge(e){return Math.abs(e)<1e-6?0:e<0?-1:1}function _e(e,t,i,r){let n=e[0]*(i[1]-t[1])+t[0]*(e[1]-i[1])+i[0]*(t[1]-e[1]),s=e[0]*(r[1]-t[1])+t[0]*(e[1]-r[1])+r[0]*(t[1]-e[1]);return!((n^s)>=0&&0!==n&&0!==s)&&(n=i[0]*(e[1]-r[1])+r[0]*(i[1]-e[1])+e[0]*(r[1]-i[1]),s=i[0]*(t[1]-r[1])+r[0]*(i[1]-t[1])+t[0]*(r[1]-i[1]),!((n^s)>=0&&0!==n&&0!==s))}class pe extends L{constructor(){super(),this._barcodeFillStyle="rgba(254,180,32,0.3)",this._barcodeStrokeStyle="rgba(254,180,32,0.9)",this._barcodeLineWidth=1,this._barcodeFillStyleBeforeVerification="rgba(248,252,0,0.2)",this._barcodeStrokeStyleBeforeVerification="transparent",this._barcodeLineWidthBeforeVerification=2,this.bFilterRegionInJs=!0,this._onCameraSelChange=()=>{},this._onResolutionSelChange=()=>{},this._onCloseBtnClick=()=>{},this._onPlayed=null}static get version(){return this._version+`(DCE ${ue.getVersion()})`}static _fireHTTPSWarnning(){pe.onWarning&&location&&"https:"!==location.protocol&&setTimeout((()=>{pe.onWarning&&pe.onWarning({id:2,merectly."})}),0)}static async testCameraAccess(){return ue.testCameraAccess()}_fireResolutionWarning(){if(!this.singleFrameMode&&this.onWarning&&this.dce.isOpen()){const e=this.dce.getConstraints();e&&e.width<1280&&e.height<720&&setTimeout((()=>{this.onWarning&&this.onWarning({id:3,message:"Camera resolution too low, please use a higher resoluthis.dce.getUIElement()}async setUIElement(e){await this.dce.setUIElement(e)}get singleFrameMode(){return this.dce.singleFrameMode}set singleFrameMode(e){this.dce.singleFrameMode=e,e&&(this.dce.ifShowScanRegionLaser=!1,(async()=>{let e=await this.getScanSettings();e.oneDTrustFrameCount=1,await this.updateScanSettings(e)})())}get onUnduplicatedRead(){return this.onUniqueRead}set onUnduplicatedRead(e){this.onUniqueRead=e}get video(){return this.dce&&this.dce.video}set videoSrc(e){this.dce&&(this.dce.videoSrc=e)}get videoSrc(){return this.dce&&this.dce.videoSrc}set onTipSuggested(e){this.dce&&(this.dce.onTipSuggested=e)}get onTipSuggested(){return this.dce&&this.dce.onTipSuggested}_assertOpen(){if(!this.dce.isOpen())throw Error("The scanner is not open.")}set barcodeFillStyle(e){this._barcodeFillStyle=e,this.dce&&this.dce.updateDrawingStyle(3,{fillStyle:e})}get barcodeFillStyle(){return this._barcodeFillStyle}set barcodeStrokeStyle(e){this._barcodeStrokeStyle=e,this.dce&&this.dce.updateDrawingStyle(3,{strokeStyle:e})}get barcodeStrokeStyle(){return this._barcodeStrokeStyle}set barcodeLineWidth(e){this._barcodeLineWidth=e,this.dce&&this.dce.updateDrawingStyle(3,{lineWidth:e})}get barcodeLineWidth(){return this._barcodeLineWidth}set barcodeFillStyleBeforeVerification(e){this._barcodeFillStyleBeforeVerification=e,this._styleIdBeforeVerification&&this.dce.updateDrawingStyle(this._styleIdBeforeVerification,{fillStyle:e})}get barcodeFillStyleBeforeVerification(){return this._barcodeFillStyleBeforeVerification}set barcodeStrokeStyleBeforeVerification(e){this._barcodeStrokeStyleBeforeVerification=e,this._styleIdBeforeVerification&&this.dce.updateDrawingStyle(this._styleIdBeforeVerification,{strokeStyle:e})}get barcodeStrokeStyleBeforeVerification(){return this._barcodeStrokeStyleBeforeVerification}set barcodeLineWidthBeforeVerification(e){this._barcodeLineWidthBeforeVerification=e,this._styleIdBeforeVerification&&this.dce.updateDrawingStyle(this._styleIdBeforeVerification,{lineWidth:e})}get barcodeLineWidthBeforeVerification(){return this._barcodeLineWidthBeforeVerification}set regionMaskFillStyle(e){this.dce.setScanRegionMaskStyle({fillStyle:e})}get regionMaskFillStyle(){return this.dce.regionMaskFillStyle}set regionMaskStrokeStyle(e){this.dce.setScanRegionMaskStyle({strolineWidth:e})}get regionMaskLineWidth(){return this.dce.regionMaskLineWidth}set region(e){this._region=e,this.dce&&(e?e instanceof Array||this.dce.setScanRegion(e):this.dce.setScanRegion(null)),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0}get region(){return this._region}set ifSaveOriginalImageInACanvas(e){this._ifSaveOriginalImageInACanvas=e,this.dce.framePixelFormat=e?"rgba":"grey"}get ifSaveOriginalImageInACanvas(){return this._ifSaveOriginalImageInACanvas}async createDCEInstance(){this.dce||(L._onLog&&L._onLog("createDCEInstance()"),ue.defaultUIElementURL=null,this.dce=await ue.createInstance(),this.dce.refreshInterval=200,this.dce.framePixelFormat="grey",this.dce.maxCvsSideLength=this.maxCvsSideLength,this._drawingItemNamespace=de,["iPhone","iPad","Android","HarmonyOS"].includes(L.browserInfo.OS)||this.dce.setResolution(1920,1080),this._styleIdBeforeVerification=this.dce.createDrawingStyle({fillStyle:"rgba(248,252,0,0.2)",strokeStyle:"transparent",paintMode:"strokeAndFill"}),this.barcodeLineWidth=this._barcodeLineWidth,this.dce.on("cameraChange",(()=>{this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),this._drawResults(null),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0})),this.dce.on("resolutionChange",(()=>{this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),this._drawResults(null),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0})),this.dce.on("cameraClose",(()=>{this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),this._drawResults(null),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0,this._bPauseScan=!1})),this.dce.on("singleFrameAcquired",(async t=>{if(!t)return;if(!t.data)return;let i;this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),this._drawResults(null),this.ifSaveOriginalImageInACanvas&&(this.oriCanvas=null,this.oriCanvasData={width:t.width,height:t.height,pixelFormat:t.pixelFormat,data:new Uint8Array(t.data),toCanvas:t.toCanvas});const{data:r,sx:n,sy:s,width:o,height:a,stride:h,pixelFormat:l,timeStamp:c,_sWidth:u,_sHeight:d}=t,f={timeStamp:c};if("grey"===l)i=await this._decodeBuffer_Uint8Array(r,o,a,h,e.EnumImagePixelFormat.IPF_GrayScaled,0,f);else if("rgba"===l)i=await this._decodeBuffer_Uint8Array(r,o,a,h,e.EnumImagePixelFormat.IPF_ABGR_8888,0,f);else{if("bgra"!==l)throw new Error(`Pixel format '${l}' is not supported.`);i=await this._decodeBuffer_Uint8Array(r,o,a,h,e.EnumImagePixelFormat.IPF_ARGB_8888,0,f)}if(await this.clearMapDecodeRecord(),L.recalculateResultLocation(i,n,s,u,d,o,a),this._drawResults(i),this.onFrameRead&&this.isOpen()&&!this._bPauseScan){let e=this._cloneDecodeResults(i);this.onFrameRead(e)}if(this.onUniqueRead&&this.isOpen()&&!this._bPauseScan)foset maxCvsSideLength(e){this._maxCvsSideLength=e,this.dce.maxCvsSideLength=e}get maxCvsSideLength(){return this._maxCvsSideLength}static async createInstance(e){const t=new pe;t._instanceID=await pe.createInstanceInWorker(!0),await t.createDCEInstance(),"string"==typeof e&&(e=JSON.parse(e));for(let i in e)t[i]=e[i];return await t.dce.setUIElement(pe.defaultUIElementURL),t.singleFrameMode&&console.warn("The `navigator.mediaDevices.getUserMedia` is unavailable. automatically change to `singleFrameMode`."),pe._fireHTTPSWarnning(),t.singleFrameMode||await t.updateRuntimeSettings("single"),t}async decodeCurrentFrame(e){this._assertOpen();let t=null;e&&e.region&&(t=e.region);const i=this.dce._getVideoData(null,{region:t});return this._decode_DCEFrame(i)}async updateRuntimeSettings(t){let i;if("string"==typeof t)if("speed"==t){let e=await this.getRuntimeSettings();await this.resetRuntimeSettings(),i=await this.getRuntimeSettings(),i.barcodeFormatIds=e.barcodeFormatIds,i.barcodeFormatIds_2=e.barcodeFormatIds_2,e.region&&(i.region=e.region),i.expectedBarcodesCount=0,i.localizationModes=[2,0,0,0,0,0,0,0],i.barcodeZoneMinDistanceToImageBorders=9}else if("balance"==t){let e=await this.getRuntimeSettings();await this.resetRuntimeSettings(),i=await this.getRuntimeSettings(),i.barcodeFormatIds=e.barcodeFormatIds,i.barcodeFormatIds_2=e.barcodeFormatIds_2,e.region&&(i.region=e.region),i.expectedBarcodesCount=512,i.deblurLevel=3,i.localizationModes=[2,16,0,0,0,0,0,0],i.barcodeZoneMinDistanceToImageBorders=9,i.timeout=1e5}else if("coverage"==t){let e=await this.getRuntimeSettings();await this.resetRuntimeSettings(),i=await this.getRuntimeSettings(),i.barcodeFormatIds=e.barcodeFormatIds,i.barcodeFormatIds_2=e.barcodeFormatIds_2,e.region&&(i.region=e.region),i.expectedBarcodesCount=512,i.deblurLevel=5,i.scaleDownThreshold=1e5,i.localizationModes=[2,16,4,8,0,0,0,0],i.barcodeZoneMinDistanceToImageBorders=9,i.timeout=1e5}else if("single"==t){let e=await this.getRuntimeSettings();await this.resetRuntimeSettings(),i=await this.getRuntimeSettings(),i.barcodeFormatIds=e.barcodeFormatIds,i.barcodeFormatIds_2=e.barcodeFormatIds_2,e.region&&(i.region=e.region)}else if("dense"==t){let e=await this.getRuntimeSettings();await this.resetRuntimeSettings(),this.maxCvsSideLength=4096,i=await this.getRuntimeSettings(),i.barcodeFormatIds=e.barcodeFormatIds,i.barcodeFormatIds_2=e.barcodeFormatIds_2,e.region&&(i.region=e.region),i.expectedBarcodesCount=0,i.deblurLevel=7,i.scaleDownThreshold=1e5,i.localizationModes=[2,8,0,0,0,0,0,0],i.minResultConfidence=0,i.barcodeZoneMinDistanceToImageBorders=9,i.timeout=1e5}else if("distance"==t){let e=await this.getRuntimeSettings();await this.resetRuntimeSettings(),this.maxCvsSideLength=4096,i=await this.getRuntimeSettings(),i.barcodeFormatIds=e.barcodeFormatIds,i.barcodeFormatIds_2=e.barcodeFormatIds_2,e.region&&(i.region=e.region),i.expectedBarcodesCount=0,i.scaleDownThreshold=1e5,i.localizationModes=[2,8,0,0,0,0,0,0],i.barcodeZoneMinDistanceToImageBorders=9,i.timeout=1e5}else i=JSON.parse(t);else{if("object"!=typeof t)throw TypeError("'UpdateRuntimeSettings(settings)': Type of 'settings' should be 'string' or 'PlainObject'.");if(i=JSON.parse(JSON.stringify(t)),i.region instanceof Array){let e=t.region;[e.regionLefe.regionLeft,e.regionBottom,e.regionMeasuredByPercentage].some((e=>void 0!==e))&&(i.region={regionLeft:e.regionLeft||0,regionTop:e.regionTop||0,regionRight:e.regionRight||0,regionBottom:e.regionBottom||0,regionMeasuredByPercentage:e.regionMeasuredByPercentage||0})}}if(!L._bUseFullFeature){if(0!=(i.barcodeFormatIds&~(e.EnumBarcodeFormat.BF_ONED|e.EnumBarcodeFormat.BF_QR_CODE|e.EnumBarcodeFormat.BF_PDF417|e.EnumBarcodeFormat.BF_DATAMATRIX))||0!=i.barcodeFormatIds_2)throw Error("Some of the specified barcode formats are not supported in the compact version. Please try the full-featured version.");if(0!=i.intermediateResultTypes)throw Error("Intermediate results is not supported in the compact version. Please try the full-featured version.")}{let e=i.region;if(this.bFilterRegionInJs?this.userDefinedRegion=JSON.parse(JSON.stringify(e)):this.userDefinedRegion=null,e instanceof Array)if(e.length){for(let t=0;t<e.length;++t){let i=e[t];i&&((i.regionLeft||i.regionTop||i.regionRight||i.regionBottom||i.regionMeasuredByPercentage)&&(i.regionLeft||i.regionTop||100!=i.regionRight||100!=i.regionBottom||!i.regionMeasuredByPercentage)||(e[t]=null))}this.region=e}else this.region=null;else e&&(e.regionLeft||e.regionTop||e.regionRight||e.regionBottom||e.regionMeasuredByPercentage)&&(e.regionLeft||e.regionTop||100!=e.regionRight||100!=e.regionBottom||!e.regionMeasuredByPercentage)?this.region=e:this.region=null;this.bFilterRegionInJs&&(i.region={regionLeft:0,regionTop:0,regionRight:0,regionBottom:0,regionMeasuredByPercentage:0})}(this.autoZoom||this.autoFocus)&&(i.intermediateResultTypes|=e.EnumIntermediateResultType.IRT_TYPED_BARCODE_ZONE),await new Promise(((e,t)=>{let r=L._nextTaskID++;L._taskCallbackMap.set(r,(i=>{if(i.success){try{this._handleRetJsonString(i.updateReturn)}catch(e){t(e)}return e()}{let e=new Error(i.message);return e.stack=i.stack+"\n"+e.stack,t(e)}})),L._dbrWorker.postMessage({type:"updateRuntimeSettings",id:r,instanceID:this._instanceID,body:{settings:JSON.stringify(i)}})})),"string"==typeof t&&["speed","balance","coverage","dense","distance"].includes(t)&&(await this.setModeArgument("BinarizationModes",0,"EnableFillBinaryVacancy","1"),await this.setModeArgument("BinarizationModes",0,"BlockSizeX","0"),await this.setModeArgument("BinarizationModes",0,"BlockSizeY","0"))}_bindUI(){if(!this.getUIElement())throw new Error("Need to define `UIElement` before opening.");if(this.dce._bindUI(),!this.dce.video)throw this._unbindUI(),Error("Can not find the video container element with class 'dce-video-container'")}_unbindUI(){this.dce._unbindUI()}set onPlayed(e){this.dce.off("=e,this.dce.on("played",this._onPlayed)}get onPlayed(){return this._onPlayed}async getAllCameras(){return this.dce.getAllCameras()}async getCurrentCamera(){return this.dce.getSelectedCamera()}async setCurrentCamera(e){const t=await this.dce.selectCamera(e);return this._fireResolutionWarning(),t}getResolution(){return this.dce.getResolution()}async setResolution(e,t){const i=await this.dce.setResolution(e,t);return this._fireResolutionWarning(),i}getVideoSettings(){return this.dce.getVideoSettings()}updateVideoSettings(e){returis.dce.setVideoFit(e)}getVideoFit(){return this.dce&&this.dce.getVideoFit()}set ifShowScanRegionMask(e){this.dce&&(this.dce.ifShowScanRegionMask=e)}get ifShowScanRegionMask(){return this.dce&&this.dce.ifShowScanRegionMask}set ifSaveLastUsedCamera(e){this.dce&&(this.dce.ifSaveLastUsedCamerat ifSkipCameraInspection(){return this.dce&&this.dce.ifSkipCameraInspection}stop(){this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),this._drawResults(null),this.dce.stop(),this.dce.ifShowScanRegionLaser=!1,this.dce.hideViewDecorator(),this.array_decodeFrameTimeCosrameTimeCost.length=0,this._intervalGetVideoFrame=0}pause(){this.dce.pause()}async play(e,t,i){this.dce.ifShowScanRegionLaser=!0;const r=await this.dce.play(e,t,i);return this._fireResolutionWarning(),r}pauseScan(e){this._assertOpen(),this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),e&&e.keepResultsHighlighted||this._drawResults(null),this._bPauseScan=!0,this.dce.ifShowScanRegionLaser=!1,this.dce.stopFetchingLoop()}resumeScan(){this._assertOpen(),this._bPauseScan=!1,this.dce.ifShowScanRegionLaser=!0}getCapabilities(){return this.dce.getCapabilities()}getCameraSettings(){return this.dce.getCameraSettings()}getConstraints(){return this.dce.getConstraints()}async applyConstraints(e){return this.dce.applyConstraints(e)}async turnOnTorch(){return this.dce.turnOnTorch()}async turnOffTorch(){return this.dce.turnOffTorch()}async setColorTemperature(e){return this.dce.setCotion(e)}getExposureCompensation(){return this.dce.getExposureCompensation()}async setZoom(e){return this.dce.setZoom(e)}getZoomSettings(){return this.dce.getZoomSettings()}resetZoom(){return this.dce.resetZoom()}async setFrameRate(e){return this.dce.setFrameRate(e)}getFrameRate(){return this.dce.getFrameRate()}async setFocus(e,t){return this.dce.setFocus(e,t)}getFocus(){return this.dce.getFocus()}getFocusSettings(){return this.dce.getFocusSettings()}async _loopReadVideo(){if(this.bDestroyed)return this.dce&&this.dce.stopFetchingLoop(),this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),void this._drawResults(null);if(!this.isOpen())return this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),this._drawResults(null),void await this.clearMapDecodeRecord();if(!this.dce.video||this.dce.video.paused||this._bPauseScan)return L._onLog&&L._onLog("Video or scan is paused. Ask in 1s."),await this.clearMapDecodeRecord(),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),void(this._loopReadVideoTimeoutId=setTimeout((()=>{this._loopReadVideo()}),this._intervalDetectVideoPause));L._onLog&&L._onLog("======= once read ======="),L._onLog&&(this._timeStartDecode=Date.now());const t=this._getVideoFrame();if(!t)return L._onLog&&L._onLog("Get invalid frame."),this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),this._drawResults(null),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),void(this._loopReadVideoTimeoutId=setTimeout((()=>{this._loopReadVideo()}),0));(async()=>{t._bUseWebGL||"grey"!==t.pixelFormat||(this.dce.framePixelFormat="rgba");let i=[];this.ifSaveOriginalImageInACanvas&&(this.oriCanvas=null,this.oriCanvasData={width:t.width,height:t.height,pixelFormat:t.pixelFormat,data:new Uint8Array(t.data),toCanvas:t.toCanvas});const{data:r,sx:n,sy:s,width:o,height:a,stride:h,pixelFormat:l,timeStamp:c,_sWidth:u,_sHeight:d}=t,f={timeStamp:c};if("grey"===l)i=await this._decodeBuffer_Uint8Array(r,o,a,h,e.EnumImagePixelFormat.IPF_GrayScaled,0,f);else if("rgba"===l)i=await this._decodeBuffer_Uint8Array(r,o,a,h,e.EnumImagePixelFormat.IPF_ABGR_8888,0,f);else{if("bgra"!==l)throw new Error(`Pixel format '${l}' is not supported.`);i=await this._decodeBuffer_Uint8Array(r,o,a,h,e.EnumImagePixelFormat.IPF_ARGB_8888,0,f)}if(L.recalculateResultLocation(i,n,s,u,d,o,a),0==this._resultHighlightingDuration?this._drawResults(null):this._drawResults(i),this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),this.ltsCanvasTimeoutId=setTimeout((()=>{this.bDestroyed||this._drawResults(null)}),this._resultHighlightingDuration)),this.isOpen()&&this.dce.video&&!this.dce.video.paused&&!this._bPauseScan&&(this.autoZoom||this.autoFocus||this.autoSuggestTip))if(i.length)this.autoZoomInFrameArray.length=0,this.autoZoomOutFrameCount=0,this.frameArrayInIdealZoom.length=0,this.suggestTipFrameArray.length=0,this.autoZoom&&this.autoFocus&&(this.nextActionInIdealZoom="focus"),this.autoFocusFrameArray.length=0,this.noIntermediateResultsCount=0;else{const t=await this.getIntermediateResults(),i=(e,t,i,r,n,s,o)=>{let a=s/r,h=o/n;e.x1=e.x1/a+t,e.x2=e.x2/a+t,e.x3=e.x3/a+t,e.x4=e.x4/a+t,e.y1=e.y1/h+i,e.y2=e.y2/h+i,e.y3=e.y3/h+i,e.y4=e.y4/h+i},r=t=>{if(!t)return null;const r={};let h,l,c,f,g;{const e=this.video.videoWidth*(1-this.autoZoomDetectionArea)/2,t=this.video.videoWidth*(1+this.autoZoomDetectionArea)/2,i=t,r=e,n=this.video.videoHeight*(1-this.autoZoomDetectionArea)/2,s=n,o=this.video.videoHeight*(1+this.autoZoomDetectionArea)/2;g={x1:e,x2:t,x3:i,x4:r,y1:n,y2:s,y3:o,y4:o}}const _=(e,t)=>{const i=(e,t)=>{if(!e&&!t)throw new Error("Invalid arguments.");return function(e,t,i){let r=!1;const n=e.length;if(n<=2)return!1;for(let s=0;s<n;s++){const o=e[s],a=e[(s+1)%n];if(fe(o,a,{x:t,y:i}))return!0;ge(o.y-i)>0!=ge(a.y-i)>0&&ge(t-(i-o.y)*(o.x-a.x)/(o.y-a.y)-o.x)<0&&(r=!r)}return r}([{x:t.x1,y:t.y1},{x:t.x2,y:t.y2},{x:t.x3,y:t.y3},{x:t.x4,y:t.y4}],e.x,e.y)},r=(e,t)=>!!(_e([e[0],e[1]],[e[2],e[3]],[t.x1,t.y1],[t.x2,t.y2])||_e([e[0],e[1]],[e[2],e[3]],[t.x2,t.y2],[t.x3,t.y3])||_e([e[0],e[1]],[e[2],e[3]],[t.x3,t.y3],[t.x4,t.y4])||_e([e[0],e[1]],[e[2],e[3]],[t.x4,t.y4],[t.x1,t.y1]));return!!(i({x:e.x1,y:e.y1},t)||i({x:e.x2,y:e.y2},t)||i({x:e.x3,y:e.y3},t)||i({x:e.x4,y:e.y4},t))||(!!(i({x:t.x1,y:t.y1},e)||i({x:t.x2,y:t.y2},e)||i({x:t.x3,y:t.y3},e)||i({x:t.x4,y:t.y4},e))||!!(r([t.x1,t.y1,t.x2,t.y2],e)||r([t.x2,t.y2,t.x3,t.y3],e)||r([t.x3,t.y3,t.x4,t.y4],e)||r([t.x4,t.y4,t.x1,t.y1],e)))},p=[];for(let r of t){if(r.resultType!==e.EnumIntermediateResultType.IRT_TYPED_BARCODE_ZONE)continue;const t=r.scaleDownRatio;for(let e of r.results){if(!e)continue;const r={x1:e.x1=e.x1*t,x2:e.x2=e.x2*t,x3:e.x3=e.x3*t,x4:e.x4=e.x4*t,y1:e.y1=e.y1*t,y2:e.y2=e.y2*t,y3:e.y4=e.y3*t,y4:e.y4=e.y4*t};i(r,n,s,u,d,o,a),_(g,r)&&p.push(e)}}const m=(t=>{if(!t||!t.length)return null;const i=e=>{const t=(e.x1+e.x2+e.x3+e.x4)/4,i=(e.y1+e.y2+e.y3+e.y4)/4;return(t-o/2)*(t-o/2)+(i-a/2)*(i-a/2)};let r,n=t.filter((t=>t.barcodeFormat==e.EnumBarcodeFormat.BF_QR_CODE||tX));if(n.length||(n=t.filter((t=>t.barcodeFormat==e.EnumBarcodeFormat.BF_ONED)),n.length||(n=t)),!n.length)return null;r=n[0];let s=i(r);if(1!=n.length)for(let e=1;e<n.length;e++){const t=i(n[e]);n[e].confidence>1.1*r.confidence?(r=n[e],s=t):n[e].confidence>.9*r.confidence&&t<s&&(r=n[e],s=t)}return r})(p);if(!m)return null;const v=m.x1,y=m.x2,S=m.x3,w=m.x4,C=m.y1,b=m.y2,x=m.y3,T=m.y4;return h=Math.min(v,y,S,w),l=Math.max(v,y,S,w),c=Math.min(C,b,x,T),f=Math.max(C,b,x,T),r.x1=r.x4=h,r.x2=r.x3=l,r.y1=r.y2=c,r.y3=r.y4=f,r.result=m,r},h=r(t);if(h&&h.x1){if(this.autoZoomOutFrameCount=0,this.noIntermediateResultsCount=0,this.suggestTipFrameArray.push(!0),this.suggestTipFrameArray.splice(0,this.suggestTipFrameArray.length-this.suggestTipFrameLimit[0]),this.autoSuggestTip&&this.suggestTipFrameArray.filter((e=>!0===e)).length>=this.suggestTipFrameLimit[1]){this.suggestTipFrameArray.length=0;const e=h.x3-h.x1,t=h.y3-h.y1;h.result.moduleSize<this.tinyBarcodeTipModuleSizeLimit?this.dce&&this.dce.suggestTip("tiny-barcode","Please zoom in or move closer."):e>t?e>o*this.hugeBarcodeTipLimit?this.dce&&this.dce.suggestTip("huge-barcode","Please zoom out or move farther."):e>.6*o&&Math.max(this.video.videoWidth,this.video.videoHeight)<=1280&&Math.min(this.video.videoWidth,this.video.videoHeight)<=720&&this.dce&&this.dce.suggestTip("low-resolution","Please use a higher resolution."):e<=t&&(t>a*this.hugeBarcodeTipLimit?this.dce&&this.dce.suggestTip("huge-barcode","Please zoom out or move farther."):t>.6*a&&Math.max(this.video.videoWidth,this.video.videoHeight)<=1280&&Math.min(this.video.videoWidth,this.video.videoHeight)<=720&&this.dce&&this.dce.suggestTip("low-resolution","Please use a higher resolution."))}if(this.autoZoom){const e=this.autoZoomIdealArea[1];let t=(1-this.autoZoomTargetBorder)/2;const r=h.x1/u,l=(u-h.x3)/u,c=h.y1/d,f=(d-h.y3)/d;if(r>e&&l>e&&c>e&&f>e&&h.result.moduleSize<this.autoZoomInIdealModuleSize){if(this.autoZoomInFrameArray.push(!0),this.autoZoomInFrameArray.splice(0,this.autoZoomInFrameArray.length-this.autoZoomInFrameLimit[0]),this.frameArrayInIdealZoom.length=0,this.autoFocus&&(this.nextActionInIdealZoom="focus",this.setFocus({mode:"continuous"}).catch((()=>{}))),this.autoZoomInFrameArray.filter((e=>!0===e)).length>=this.autoZoomInFrameLimit[1]){this.autoZoomInFrameArray.length=0;const e=[(.5-t)/(.5-r),(.5-t)/(.5-l),(.5-t)/(.5-c),(.5-t)/(.5-f)].filter((e=>e>0)),i=Math.min(...e,this.autoZoomInIdealModuleSize/h.result.moduleSize),n=this.dce.getZoomSettings().factor;let s=Math.max(Math.pow(n*i,1/this.autoZoomInMaxTimes),this.autoZoomInMinStep);s=Math.min(s,i);const o=n*s;await this.setZoom({factor:o}),this.dce.clearFrameBuffer()}}else if(this.autoZoomInFrameArray.length=0,this.frameArrayInIdealZoom.push(!0),this.frameArrayInIdealZoom.splice(0,this.frameArrayInIdealZoom.length-this.frameLimitInIdealZoom[0]),this.frameArrayInIdealZoom.filter((e=>!0===e)).length>=this.frameLimitInIdealZoom[1])if(this.frameArrayInIdealZoom.length=0,"focus"===this.nextActionInIdealZoom&&this.autoFocus){i(h,n,s,u,d,o,a);try{await this.setFocus({mode:"manual",area:{centerPoint:{x:(h.x1+h.x3)/2+"px",y:(h.y1+h.y3)/2+"px"},width:h.x3-h.x1+"px",height:h.y3-h.y1+"px"}})}catch(e){}this.dce.clearFrameBuffer(),this.nextActionInIdealZoom="zoomOut"}else{if("zoomOut"!==this.nextActionInIdealZoom&&this.autoFocus)throw new Error("Invalid action.");if(this.enableZoomOutInIdealZoom){t=this.autoZoomIdealArea[1]+this.autoZoomOutStepRatst e=[(.5-t)/(.5-r),(.5-t)/(.5-l),(.5-t)/(.5-c),(.5-t)/(.5-f)].filter((e=>e>0));let i=Math.min(...e)*this.dce.getZoomSettings().factor;await this.setZoom({factor:i}),this.dce.clearFrameBuffer(),this.autoFocus&&(this.nextActionInIdealZoom="focus",this.setFocus({mode:"continuous"}).catch((e=>{})))}}}else if(this.autoFocus&&(this.autoFocusFrameArray.push(!0),this.autoFocusFrameArray.splice(0,this.autoFocusFrength-this.autoFocusFrameLimit[0]),this.autoFocusFrameArray.filter((e=>!0===e)).length>=this.autoFocusFrameLimit[1])){this.autoFocusFrameArray.length=0;try{i(h,n,s,u,d,o,a),await this.setFocus({mode:"manual",area:{centerPoint:{x:(h.x1+h.x3)/2+"px",y:(h.y1+h.y3)/2+"px"},width:h.x3-h.x1+"px",height:h.y3-h.y1+"px"}})}catch(e){}this.dce.clearFrameBuffer()}}else if(this.noIntermediateResultsCount++,this.suggestTipFrameArray.push(!1),this.autoZoom){if(this.autoZoomInFrameArray.push(!1),this.autoZoomInFrameArray.splice(0,this.autoZoomInFrameArray.length-this.autoZoomInFrameLimit[0]),this.autoZoomOutFrameCount++,this.frameArrayInIdealZoom.push(!1),this.frameArrayInIdealZoom.splice(0,this.frameArrayInIdealZoom.length-this.frameLimitInIdealZoom[0]),this.autoZoomOutFrameCount>=this.autoZoomOutFrameLimit){this.autoZoomOutFrameCount=0;const e=this.getZoomSettings().factor;if(e>this.autoZoomOutMinValue){const t=Math.max((e-1)*this.autoZoomOutStepRate,this.autoZoomOutMinStep),i=Math.max(e-t,this.autoZoomOutMinValue);await this.setZoom({factor:i}),this.dce.clearFrameBuffer()}}this.autoFocus&&(this.nextActionInIdealZoom="focus",this.setFocus({mode:"continuous"}).catch((e=>{})))}else this.autoFocus&.autoFocusFrameArray.length=0,this.setFocus({mode:"continuous"}).catch((e=>{})))}return i})().then((e=>{if(L._onLog&&L._onLog(e),this.captureAndDecodeInParallel){let e=this.array_decodeFrameTimeCost,t=this.array_getFrameTimeCost,i=this._indexCurrentDecodingFrame;const r=()=>{let r=0;if(this.region instanceof Array){let n=0,s=0;n=i+1>=this.region.length?0:i+1,s=n+1>=this.region.length?0:n+1,r=e[n]&&e[n].length&&t[s]&&t[s].length?Math.min(...e[n])-Math.max(...t[s]):0}else if(t&&t.length){let i=Math.min(...e),n=Math.max(...t);i&&n&&(r=i-n)}else r=0;return r>0?r:0};(()=>{if(this.region instanceof Array){for(e[i]&&e[i]instanceof Array||(e[i]=[]);e[i].length>=5;)e[i].shift();e[i].push(this._lastInnerDecodeDuration)}else{for(;e.length>=5;)e.shift();e.push(this._lastInnerDecodeDuration)}})(),this._intervalGetVideoFrame=r()+this.intervalTime,L._onLog&&L._onLog("Next fetching frame loop interval: "+this._intervalGetVideoFrame)}if(this.isOpen()&&this.dce.video&&!this.dce.video.paused&&!this._bPauseScan){if(this.bPlaySoundOnSuccessfulRead&&e.length){let t=!1;!0===this.bPlaySoundOnSuccessfulRead||"frame"===this.bPlaySoundOnSuccessfulRead?t=e.some((e=>e.resultState>=0)):"unique"===this.bPlaySoundOnSuccessfulRead&&(t=e.some((e=>0==e.resultState))),t&&this.beepSound&&(this.beepSound.stop(),this.beepSound.play())}if(navigator.vibrate&&this.bVibrateOnSuccessfulRead&&e.length){let t=!1;if(!0===this.bVibrateOnSuccessfulRead||"frame"===this.bVibrateOnSuccessfulRead?t=e.some((e=>e.resultState>=0)):"unique"===this.bVibrateOnSuccessfulRead&&(t=e.some((e=>0==e.resultState))),t)try{navigator.vibrate(this.vibrateDuration)}catch(e){console.warn("Vibration not allowed. Uired: "+(e.message||e))}}if(this.onFrameRead){e=e.filter((e=>e.resultState>=0));const t=this(e);this.onFrameRead(t)}if(this.onUniqueRead){e=e.filter((e=>0==e.resultState));const t=this._cloneDecodeResults(e);for(let e of t)this.onUniqueRead(e.barcodeText,e)}}this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this.intervalTime?this._loopReadVideoTimeoutId=setTimeout((()=>{this._loopReadVideo()}),this.intervalTime):this._loopReadVideo()}))}_getVideoFrame(){if(!this.dce)return null;let e;if(this.captureAndDecodeInParallel){L._onLog&&L._onLog("Get frame in parallel.");let t=this.dce.isFetchingLoopStarted();if(this.dce.loopInterval=this._intervalGetVideoFrame,t||this.dce.startFetchingLoop(),!this.dce.numberOfFramesInBuffer)return this.dce.loopInterval=0,null;e=this.dce.getFrameFromBuffer();const i=e=>{if(!e)return;let t=e.timeSpent,i=this.array_getFrameTimeCost;for(;i.length>=5;)i.shift();i.push(t)};i(e)}else L._onLog&&L._onLog("Get frame in serial."),this.dce.stopFetchingLoop(),e=this.dce.getFrame();return e}async open(){this._bindUI();const e=await this.dce.open();return this._bPauseScan=!1,this.singleFrameMode||(this.dce&&(this.dce.ifShowScanRegionLaser=!0),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this._loopReadVideoTimeoutId=setTimeout((()=>{this._loopReadVideo()}),0)),this._fireResolutionWarning(),e}async openVideo(){this._bindUI(),this.dce.ifShowScanRegionLaser=!1;const e=await this.dce.open();return this._bPauseScan=!0,this.singleFrameMode||(this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this._loopReadVideoTimeoutId=setTimeout((()=>{this._loopReadVideo()}),0)),this._fireResolutionWarning(),e}close(){this.dce.close(),this._bPauseScan=!0,this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId)}async show(){this._bindUI();const e=await this.dce.open(!0);return this._bPauseScan=!1,this.singleFrameMode||(this.dce&&(this.dce.ifShowScanRegionLaser=!0),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this._loopReadVideoTimeoutId=setTimeout((()=>{this._loopReadVideo()}),0)),this._fireResolutionWarning(),e}async showVideo(){this._bindUI(),this.dce.ifShowScanRegionLaser=!1;const e=await this.dce.open(!0);return this._bPauseScan=!0,this.singleFrameMode||(this._loopReadVideoTimeoutId&&clearTmeoutId),this._loopReadVideoTimeoutId=setTimeout((()=>{this._loopReadVideo()}),0)),this._fireResolutionWarning(),e}hide(){this.dce.close(!0),this._bPauseScan=!0,this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId)}showTip(e,t,i,r,n=3e3,s=!0){this.dce.hideTip()}updateTipMessage(e){this.dce&&this.dce.updatnableTapToFocus()}disableTapToFocus(){this.dce&&this.dce.disableTapToFocus()}isTapToFocusEnabled(){return this.dce.isTapToFocusEnabled()}transformCoord(e){if(!this.isOpen())throw new Error("Unavailable when the camera is not open.");if(this.singleFrameMode&&!this.dce._cvsSingleFrameMode)throw new Error("No image is selected. ");const t=this.dce._elContainer.getBoundingClientRect();let i,r,n,s,o,a=t.left,h=t.top,l=a+window.scrollX,c=h+window.scrollY;this.singleFrameMode?(i=this.dce._cvsSingleFrameMode.width,r=this.dce._cvsSingleFrameMode.height,n=parseFloat(window.getComputedStyle(this.dce._cvsSingleFrameMode).width),s=parseFloat(window.getComputedStyle(this.dce._cvsSingleFrameMode).height),o="contain"):(i=this.video.videoWidth,r=this.video.videoHeight,n=parseFloat(window.getComputedStyle(this.dce._elContainer).width),s=parseFloat(window.getComputedStyle(this.dce._elContainer).height),o=this.getVideoFit());const u=n/s,d=i/r;let f,g,_,p,m=1;if("contain"===o)u<d?(m=n/i,f=a+e.x*m,g=h+e.y*m+(s-r*m)/2,_=l+e.x*m,p=c+e.y*m+(s-r*m)/2):(m=s/r,f=a+e.x*m+(n-i*m)/2,g=h+e.y*m,_=l+e.x*m+(n-i*m)/2,p=c+e.y*m);else if("cover"===o)if(u<d){m=s/r;let t=e.x*m-(i*m-n)/2;t=Math.max(t,0),t=Math.min(t,n),f=a+t,g=h+e.y*m,_=l+t,p=c+e.y*m}else{m=n/i;let t=e.y*m-(r*m-s)/2;t=Math.max(t,0),t=Math.min(t,s),f=a+e.x*m,g=h+t,_=l+e.x*m,p=c+t}return{clientX:Math.round(f),clientY:Math.round(g),pageX:Math.round(_),pageY:Math.round(p)}}convertToPageCoordinates(e){const t=this.transformCoord(e);return{x:t.pageX,y:t.pageY}}convertToClientCoordinates(e){const t=this.transformCoord(e);return{x:t.clientX,y:t.clientY}}destroyContext(){this.close(),this.dce&&this.dce.dispose(!1),this.bDestroyed||super.destroyContext()}}var me,ve,ye,Se,we,Ce,be,xe,Te,Ee,Ie,Oe,Ae,Re,De,Me,Fe,Le,Pe,ke,Be,Ne,je,Ve,Ue,Ge;e.EnumBarcodeColourMode=void 0,(me=e.EnumBarcodeColourMode||(e.EnumBarcodeColourMode={}))[me.BICM_DARK_ON_LIGHT=1]="BICM_DARK_ON_LIGHT",me[me.BICM_LIGHT_ON_DARK=2]="BICM_LIGHT_ON_DARK",me[me.BICM_DARK_ON_DARK=4]="BICM_DARK_ON_DARK",me[me.BICM_LIGHT_ON_LIGHT=8]="BICM_LIGHT_ON_LIGHT",me[me.BICM_DARK_LIGHT_MIXED=16]="BICM_DARK_LIGHT_MIXED",me[me.BICM_DARK_ON_LIGHT_DARK_SURROUNDING=32]="BICM_DARK_ON_LIGHT_DARK_SURROUNDING",me[me.BICM_SKIP=0]="BICM_SKIP",me[me.BICM_REV=2147483648]="BICM_REV",e.EnumBarcodeComplementMode=void 0,(ve=e.EnumBarcodeComplementMode||(e.EnumBarcodeComplementMode={}))[ve.BCM_AUTO=1]="BCM_AUTO",ve[ve.BCM_GENERAL=2]="BCM_GENERAL",ve[ve.BCM_SKIP=0]="BCM_SKIP",ve[ve.BCM_REV=2147483648]="BCM_REV",e.EnumBarcodeFormat_2=void 0,(ye=e.EnumBarcodeFormat_2||(e.EnumBarcodeFormat_2={}))[ye.BF2_NULL=0]="BF2_NULL",ye[ye.BF2_POSTALCODE=32505856]="BF2_POSTALCODE",ye[ye.BF2_NONSTANDARD_BARCODE=1]="BF2_NONSTANDARD_BARCODE",ye[ye.BF2_USPSINTELLIGENTMAIL=1048576]="BF2_USPSINTELLIGENTMAIL",ye[ye.BF2_POSTNET=2097152]="BF2_POSTNET",ye[ye.BF2_PLANET=4194304]="BF2_PLANET",ye[ye.BF2_AUSTRALIANPOST=8388608]="BF2_AUSTRALIANPOST",ye[ye.BF2_RM4SCC=16777216]="BF2_RM4SCC",ye[ye.BF2_DOTCODE=2]="BF2_DOTCODE",ye[ye.BF2_PHARMACODE_ONE_TRACK=4]="BF2_PHARMACODE_ONE_TRACK",ye[ye.BF2_PHARMACODE_TWO_TRACK=8]="BF2_PHARMACODE_TWO_TRACK",ye[ye.BF2_PHARMACODE=12]="BF2_PHARMACODE",ye[ye.BF2_ALL=-1]="BF2_ALL",e.EnumBinarizationMode=void 0,(Se=e.EnumBinarizationMode||(e.EnumBinarizationMode={}))[Se.BM_AUTO=1]="BM_AUTO",Se[Se.BM_LOCAL_BLOCK=2]="BM_LOCAL_BLOCK",Se[Se.BM_SKIP=0]="BM_SKIP",Se[Se.BM_THRESHOLD=4]="BM_THRESHOLD",Se[Se.BM_REV=2147483648]="BM_REV",e.EnumClarityCalculationMethod=void 0,(we=e.EnumClarityCalculationMethod||(e.EnumClarityCalculationMethod={}))[we.ECCM_CONTRAST=1]="ECCM_CONTRAST",e.EnumClarityFilterMode=void 0,(Ce=e.EnumClarityFilterMode||(e.EnumClarityFilterMode={}))[Ce.CFM_GENERAL=1]="CFM_GENERAL",e.EnumColourClusteringMode=void 0,(be=e.EnumColourClusteringMode||(e.EnumColourClusteringMode={}))[be.CCM_AUTO=1]="CCM_AUTO",be[be.CCM_GENERAL_HSV=2]="CCM_GENERAL_HSV",be[be.CCM_SKIP=0]="CCM_SKIP",be[be.CCM_REV=2147483648]="CCM_REV",e.EnumColourConversionMode=void 0,(xe=e.EnumColourConversionMode||(e.EnumColourConversionMode={}))[xe.CICM_GENERAL=1]="CICM_GENERAL",xe[xe.CICM_SKIP=0]="CICM_SKIP",xe[xe.CICM_REV=2147483648]="CICM_REV",e.EnumConflictMode=void 0,(Te=e.EnumConflictMode||(e.EnumConflictMode={}))[Te.CM_IGNORE=1]="CM_IGNORE",Te[Te.CM_OVERWRITE=2]="CM_OVERWRITE",e.EnumDeblurMode=void 0,(Ee=e.EnumDeblurMode||(e.EnumDeblurMode={}))[Ee.DM_SKIP=0]="DM_SKIP",Ee[Ee.DM_DIRECT_BINARIZATION=1]="DM_DIRECT_BINARIZATION",Ee[Ee.DM_THRESHOLD_BINARIZATION=2]="DM_THRESHOLD_BINARIZATION",Ee[Ee.DM_GRAY_EQUALIZATION=4]="DM_GRAY_EQUALIZATION",Ee[Ee.DM_SMOOTHING=8]="DM_SMOOTHING",Ee[Ee.DM_MORPHING=16]="DM_MORPHING",Ee[Ee.DM_DEEP_ANALYSIS=32]="DM_DEEP_ANALYSIS",Ee[Ee.DM_SHARPENING=64]="DM_SHARPENING",Ee[Ee.DM_BASED_ON_LOC_BIN=128]="DM_BASED_ON_LOC_BIN",Ee[Ee.DM_SHARPENING_SMOOTHING=256]="DM_SHARPENING_SMOOTHING",e.EnumDeformationResistingMode=void 0,(Ie=e.EnumDeformationResistingMode||(e.EnumDeformationResistingMode={}))[Ie.DRM_AUTO=1]="DRM_AUTO",Ie[Ie.DRM_GENERAL=2]="DRM_GENERAL",Ie[Ie.DRM_BROAD_WARP=4]="DRM_BROAD_WARP",Ie[Ie.DRM_LOCAL_REFERENCE=8]="DRM_LOCAL_REFERENCE",Ie[Ie.DRM_DEWRINKLE=16]="DRM_DEWRINKLE",Ie[Ie.DRM_SKIP=0]="DRM_SKIP",Ie[Ie.DRM_REV=2147483648]="DRM_REV",e.EnumDPMCodeReadingMode=void 0,(Oe=e.EnumDPMCodeReadingMode||(e.EnumDPMCodeReadingMode={}))[Oe.DPMCRM_AUTO=1]="DPMCRM_AUTO",Oe[Oe.DPMCRM_GENERAL=2]="DPMCRM_GENERAL",Oe[Oe.DPMCRM_SKIP=0]="DPMCRM_SKIP",Oe[Oe.DPMCRM_REV=2147483648]="DPMCRM_REV",e.EnumGrayscaleTransformationMode=void 0,(Ae=e.EnumGrayscaleTransformationMode||(e.EnumGrayscaleTransformationMode={}))[Ae.GTM_INVERTED=1]="GTM_INVERTED",Ae[Ae.GTM_ORIGINAL=2]="GTM_ORIGINAL",Ae[Ae.GTM_SKIP=0]="GTM_SKIP",Ae[Ae.GTM_REV=2147483648]="GTM_REV",e.EnumImagePreprocessingMode=void 0,(Re=e.EnumImagePreprocessingMode||(e.EnumImagePreprocessingMode={}))[Re.IPM_AUTO=1]="IPM_AUTO",Re[Re.IPM_GENERAL=2]="IPM_GENERAL",Re[Re.IPM_GRAY_EQUALIZE=4]="IPM_GRAY_EQUALIZE",Re[Re.IPM_GRAY_SMOOTH=8]="IPM_GRAY_SMOOTH",Re[Re.IPM_SHARPEN_SMOOTH=16]="IPM_SHARPEN_SMOOTH",Re[Re.IPM_MORPHOLOGY=32]="IPM_MORPHOLOGY",Re[Re.IPM_SKIP=0]="IPM_SKIP",Re[Re.IPM_REV=2147483648]="IPM_REV",e.EnumIntermediateResultSavingMode=void 0,(De=e.EnumIntermediateResultSavingMode||(e.EnumIntermediateResultSavingMode={}))[De.IRSM_MEMORY=1]="IRSM_MEMORY",De[De.IRSM_FILESYSTEM=2]="IRSM_FILESYSTEM",De[De.IRSM_BOTH=4]="IRSM_BOTH",e.EnumLocalizationMode=void 0,(Me=e.EnumLocalizationMode||(e.EnumLocalizationMode={}))[Me.LM_SKIP=0]="LM_SKIP",Me[Me.LM_AUTO=1]="LM_AUTO",Me[Me.LM_CONNECTED_BLOCKS=2]="LM_CONNECTED_BLOCKS",Me[Me.LM_LINES=8]="LM_LINES",Me[Me.LM_STATISTICS=4]="LM_STATISTICS",Me[Me.LM_SCAN_DIRECTLY=16]="LM_SCAN_DIRECTLY",Me[Me.LM_STATISTICS_MARKS=32]="LM_STATISTICS_MARKS",Me[Me.LM_STATISTICS_POSTAL_CODE=64]="LM_STATISTICS_POSTAL_CODE",Me[Me.LM_CENTRE=128]="LM_CENTRE",Me[Me.LM_ONED_FAST_SCAN=256]="LM_ONED_FAST_SCAN",Me[Me.LM_REV=2147483648]="LM_REV",e.EnumPDFReadingMode=void 0,(Fe=e.EnumPDFReadingMode||(e.EnumPDFReadingMode={}))[Fe.PDFRM_RASTER=1]="PDFRM_RASTER",Fe[Fe.PDFRM_AUTO=2]="PDFRM_AUTO",Fe[Fe.PDFRM_VECTOR=4]="PDFRM_VECTOR",Fe[Fe.PDFRM_REV=2147483648]="PDFRM_REV",e.EnumQRCodeErrorCorrectionLevel=void 0,(Le=e.EnumQRCodeErrorCorrectionLevel||(e.EnumQRCodeErrorCorrectionLevel={}))[Le.QRECL_ERROR_CORRECTION_H=0]="QRECL_ERROR_CORRECTION_H",Le[Le.QRECL_ERROR_CORRECTION_L=1]="QRECL_ERROR_CORRECTION_L",Le[Le.QRECL_ERROR_CORRECTION_M=2]="QRECL_ERROR_CORRECTION_M",Le[Le.QRECL_ERROR_CORRECTION_Q=3]="QRECL_ERROR_CORRECTION_Q",e.EnumRegionPredetectionMode=void 0,(Pe=e.EnumRegionPredetectionMode||(e.EnumRegionPredetectionMode={}))[Pe.RPM_AUTO=1]="RPM_AUTO",Pe[Pe.RPM_GENERAL=2]="RPM_GENERAL",Pe[Pe.RPM_GENERAL_RGB_CONTRAST=4]="RPM_GENERAL_RGB_CONTRAST",Pe[Pe.RPM_GENERAL_GRAY_CONTRAST=8]="RPM_GENERAL_GRAY_CONTRAST",Pe[Pe.RPM_GENERAL_HSV_CONTRAST=16]="RPM_GENERAL_HSV_CONTRAST",Pe[Pe.RPM_SKIP=0]="RPM_SKIP",Pe[Pe.RPM_REV=2147483648]="RPM_REV",e.EnumResultCoordinateType=void 0,(ke=e.EnumResultCoordinateType||(e.EnumResultCoordinateType={}))[ke.RCT_PIXEL=1]="RCT_PIXEL",ke[ke.RCT_PERCENTAGE=2]="RCT_PERCENTAGE",e.EnumResultType=void 0,(Be=e.EnumResultType||(e.EnumResultType={}))[Be.RT_STANDARD_TEXT=0]="RT_STANDARD_TEXT",Be[Be.RT_RAW_TEXT=1]="RT_RAW_TEXT",Be[Be.RT_CANDIDATE_TEXT=2]="RT_CANDIDATE_TEXT",Be[Be.RT_PARTIAL_TEXT=3]="RT_PARTIAL_TEXT",e.EnumScaleUpMode=void 0,(Ne=e.EnumScaleUpMode||(e.EnumScaleUpMode={}))[Ne.SUM_AUTO=1]="SUM_AUTO",Ne[Ne.SUM_LINEAR_INTERPOLATION=2]="SUM_LINEAR_INTERPOLATION",Ne[Ne.SUM_NEAREST_NEIGHBOUR_INTERPOLATION=4]="SUM_NEAREST_NEIGHBOUR_INTERPOLATION",Ne[Ne.SUM_SKIP=0]="SUM_SKIP",Ne[Ne.SUM_REV=2147483648]="SUM_REV",e.EnumTerminatePhase=void 0,(je=e.EnumTerminatePhase||(e.EnumTerminatePhase={}))[je.TP_REGION_PREDETECTED=1]="TP_REGION_PREDETECTED",je[je.TP_IMAGE_PREPROCESSED=2]="TP_IMAGE_PREPROCESSED",je[je.TP_IMAGE_BINARIZED=4]="TP_IMAGE_BINARIZED",je[je.TP_BARCODE_LOCALIZED=8]="TP_BARCODE_LOCALIZED",je[je.TP_BARCODE_TYPE_DETERMINED=16]="TP_BARCODE_TYPE_DETERMINED",je[je.TP_BARCODE_RECOGNIZED=32]="TP_BARCODE_RECOGNIZED",e.EnumTextFilterMode=void 0,(Ve=e.EnumTextFilterMode||(e.EnumTextFilterMode={}))[Ve.TFM_AUTO=1]="TFM_AUTO",Ve[Ve.TFM_GENERAL_CONTOUR=2]="TFM_GENERAL_CONTOUR",Ve[Ve.TFM_SKIP=0]="TFM_SKIP",Ve[Ve.TFM_REV=2147483648]="TFM_REV",e.EnumTextResultOrderMode=void 0,(Ue=e.EnumTextResultOrderMode||(e.EnumTextResultOrderMode={}))[Ue.TROM_CONFIDENCE=1]="TROM_CONFIDENCE",Ue[Ue.TROM_POSITION=2]="TROM_POSITION",Ue[Ue.TROM_FORMAT=4]="TROM_FORMAT",Ue[Ue.TROM_SKIP=0]="TROM_SKIP",Ue[Ue.TROM_REV=2147483648]="TROM_REV",e.EnumTextureDetectionMode=void 0,(Ge=e.EnumTextureDetectionMode||(e.EnumTextureDetectionMode={}))[Ge.TDM_AUTO=1]="TDM_AUTO",Ge[Ge.TDM_GENERAL_WIDTH_CONCENTRATION=2]="TDM_GENERAL_WIDTH_CONCENTRATION",Ge[Ge.TDM_SKIP=0]="TDM_SKIP",Ge[Ge.TDM_REV=2147483648]="TDM_REV",e.BarcodeReader=L,e.BarcodeScanner=pe,Object.defineProperty(e,"__esModule",{value:!0})}));
