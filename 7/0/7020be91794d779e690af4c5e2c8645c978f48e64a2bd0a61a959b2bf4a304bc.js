!function(e){"use strict";m.siteId=sm.conf.engagement.site_id,sm.rxVersion=6;var n=t(e);nction o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}unction a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}{(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var S="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{}; x=k((function(e){
/*!
     * EventEmitter v4.2.5 - git.io/ee
     * Oliver Caldwell
     * MIT license
     * @preserve
     */
(function(){function t(){}var n=t.prototype,r=this,i=r.EventEmitter;getListeners=function(e){var t,n,r=this._getEvents();if("object"===o(e))for(n in t={},r)r.hasOwnProperty(n)&&e.test(n)&&(t[n]=r[n]);else t=r[e]||(r[e]=[]);return t},n.flattenListeners=n.getListenersAsObject=n.addListener=n.on=a("addListener"),n.addOnceListener=n.once=a("addOnceListener"),n.defineEvent=n.defineEvents=n.removeListener=n.off=a("removeListener"),n.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},n.removeListeners=n.manipulateListeners=n.removeEvent=n.removeAllListeners=a("removeEvent"),n.emitEvent=n.trigger=a("emitEvent"),n.emit=n.setOnceReturnValue=n._getOnceReturnValue=n._getEvents=t.noConflict=e.exports?e.exports=t:this.EventEmitter=t}).call(S)})),I=k((function(e,t){(function(){var t,n,r,i,s,a,u,c={"@@functional/placeholder":!0},l=f=p=d=h=v=b=m=g=function(e){return e},y=),_=Array.isArray||w=Number.isInteger||E=function(e){return"[object Number]"===Object.prototype.toString.call(e)},O=function(e){return"[object Object]"===Object.prototype.toString.call(e)},S=T=k=A=x=I=N=M=R=function e(t,n,r){switch(arguments.length){case 1:return e(t,0,t.length);case 2:return e(t,n,t.length);default:for(var i=[],o=0,s=Math.max(0,Math.min(t.length,r)-n);o<s;)i[o]=t[n+o],o+=1;return i}},C=(t="function"==typeof Date.prototype.toISOString?function(e){return e.toISOString()}:,P={init:result:,j=),L=function(e,t){return function(){var n=arguments.length;if(0===n)return t();var r=arguments[n-1];return _(r)||"function"!=typeof r[e]?t.apply(this,arguments):r[e].apply(r,R(arguments,0,n-1))}},q=U=D=V=F=function(e,t,n){return function(){var r=arguments.length;if(0===r)return n();var i=arguments[r-1];if(!_(i)){var o=R(arguments,0,r-1);if("function"==typeof i[e])return i[e].apply(i,o);if(k(i)){var s=t.apply(null,o);return s(i)}}return n.apply(this,arguments)}},B=),H=),W=function(){function e(e,t){this.xf=t,this.pos=0,this.full=!1,this.acc=new Array(e)}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=function(e){return this.acc=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=e.prototype.store=function(e){this.acc[this.pos]=e,this.pos+=1,this.pos===this.acc.length&&(this.pos=0,this.full=!0)},e.prototype.getCopy=function(){return h(R(this.acc,this.pos),R(this.acc,0,this.pos))},U((function(t,n){return new e(t,n)}))}(),G=),z=),J=function(){eturn e.prototype["@@transducer/init"]=function(){return this.xf["@@transducer/init"]()},e.prototype["@@transducer/result"]=function(e){return this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=U((function(t,n){return new e(t,n)}))}(),Y=),Q=),K=),X=),$=),Z=),ee=),te=function(){function e(e,t){this.xf=t,this.n=e}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=P.result,e.prototype["@@transducer/step"]=function(e,t){return 0===this.n?M(e):(this.n-=1,this.xf["@@transducer/step"](e,t))},U((function(t,n){return new e(t,n)}))}(),ne=),re=U((function(e,t){return e+t})),ie=D((),oe=U(F("all",B,()),se=q((),ae=U((),ue=U(F("any",H,()),ce=U(F("aperture",W,(function(e,t){for(var n=0,r=t.length-(e-1),i=new Array(r>=0?r:0);n<r;)i[n]=R(t,n,n+e),n+=1;return i}))),le=U((function(e,t){return h(t,[e])})),fe=U((function(e,t){return e.apply(this,t)})),pe=D((function(e,t,n){var r={};for(var i in n)r[i]=n[i];return r[e]=t,r})),de=D((function e(t,n,r){switch(t.length){case 0:return n;case 1:return pe(t[0],n,r);default:return pe(t[0],e(R(t,1),n,Object(r[t[0]])),r)}})),he=U((),ve=U((function(e,t){return )),be=q((),me=q((function(e){return )),ge=U((function(e,t){for(var n={},r=t.length,i=0;i<r;){var o=e(t[i]);n[o]=(m(o,n)?n[o]:0)+1,i+=1}return n})),ye=U((),_e=re(-1),we=U((),Ee=D((),Oe=U((function(e,t){var n={};for(var r in t)r!==e&&(n[r]=t[r]);return n})),Se=U((function e(t,n){switch(t.length){case 0:return n;case 1:return Oe(t[0],n);default:var r=t[0],i=R(t,1);return null==n[r]?n:pe(r,e(i,n[r]),n)}})),Te=U((),ke=U(F("dropWhile",Y,(function(e,t){for(var n=0,r=t.length;n<r&&e(t[n]);)n+=1;return R(t,n)}))),Ae=U((function(e,t){return )),xe=q((function(e){return null!=e&&"function"==typeof e.empty?e.empty():null!=e&&null!=e.constructor&&"function"==typeof e.constructor.empty?e.constructor.empty():_(e)?[]:T(e)?"":O(e)?{}:y(e)?function(){return arguments}():void 0})),Ie=U((function e(t,n){var r,i,s,a={};for(i in n)s=o(r=t[i]),a[i]="function"===s?r(n[i]):"object"===s?e(t[i],n[i]):n[i];return a})),Ne=U(F("find",K,()),Me=U(F("findIndex",X,()),Re=U(F("findLast",$,()),Ce=U(F("findLastIndex",Z,()),Pe=U(L("forEach",()),je=q((function(e){for(var t=0,n=e.length,r={};t<n;)_(e[t])&&e[t].length&&(r[e[t][0]]=e[t][1]),t+=1;return r})),Le=U((),qe=U((),Ue=U(m),De=U((),Ve=U((),Fe=q(g),Be=D((),He=re(1),We=D((function(e,t,n){e=e<n.length&&e>=0?e:n.length;var r=R(n);return r.splice(e,0,t),r})),Ge=D((function(e,t,n){return e=e<n.length&&e>=0?e:n.length,h(h(R(n,0,e),t),R(n,e))})),ze=U(L("intersperse",()),Je=U((),Ye=q((function(e){return!!_(e)||!!e&&("object"===o(e)&&(!(e instanceof String)&&(1===e.nodeType?!!e.length:0===e.length||e.length>0&&(e.hasOwnProperty(0)&&e.hasOwnProperty(e.length-1)))))})),Qe=q((),Ke=function(){var e=!{toString:null}.propertyIsEnumerable("toString"),t=["constructor","valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],n=function(){return arguments.propertyIsEnumerable("length")}(),r=return"function"!=typeof Object.keys||n?q(():q(()}(),Xe=q((),$e=q((function(e){return null!=e&&Je(Number,e.length)?e.length:NaN})),Ze=U((),et=U((),tt=D((),nt=D((),rt=U((),it=U((),ot=U((function(e,t){return t>e?t:e})),st=D((),at=D((),ut=U((function(e,t){return t<e?t:e})),ct=D((),lt=U((),ft=U((),pt=U((),dt=q((),ht=U(d(F("any",H,ue))),vt=q((),bt=U((),mt=q((),gt=U((),yt=q((),_t=q((),wt=U((),Et=(n=D(()),Ot=U((),St=U((),Tt=D((function(e,t,n){return we(e,St(t,n))})),kt=D((),At=U((),xt=U((),It=U((),Nt=U((),Mt=U((),Rt=D((),Ct=D((),Pt=U((),jt=U((),Lt=D((function(e,t,n){for(var r=n.length-1;r>=0;)t=e(t,n[r]),r-=1;return t})),qt=q(M),Ut=D((function(e,t,n){return h(R(n,0,Math.min(e,n.length)),R(n,Math.min(n.length,e+t)))})),Dt=D((),Vt=q((function(e){return T(e)?e.split("").reverse().join(""):R(e).reverse()})),Ft=D((),Bt=D((),Ht=D(L("slice",()),Wt=U((),Gt=U((function(e,t){return R(t).sort(()})),zt=U((),Jt=U((),Yt=U((function(e,t){for(var n=0,r=t.length,i=[];n<r&&!e(t[n]);)i.push(t[n]),n+=1;return[i,R(t,n)]})),Qt=U((),Kt=L("tail",Ht(1,1/0)),Xt=U(F("take",te,()),$t=U((function(e,t){for(var n=t.length-1;n>=0&&e(t[n]);)n-=1;return R(t,n+1,1/0)})),Zt=U(F("takeWhile",ne,(function(e,t){for(var n=0,r=t.length;n<r&&e(t[n]);)n+=1;return R(t,0,n)}))),en=U((),tn=U((),nn=q((),rn=q((),on=q((),sn=(r="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff","function"==typeof String.prototype.trim&&!r.trim()&&"​".trim()?q(urn e.reptype.toSunction(){return e(R(arguments))}})),cn=q((function(e){return pt(1,e)})),ln=U((function(e,t){return ye(e,(function(){for(var n,r=1,i=t,o=0;r<=e&&"function"==typeof i;)n=r===e?arguments.length:o+i.length,i=i.apply(this,R(arguments,or.lengtho)||(o[ounction(e,t,n){return e(n)?n:t(n)})),hn=D((function(e,t,n){return ie(se(t),e,n)})),vn=U((function(e,t){return ye(t.length,(function(){for(var n=[],r=0;r<t.length;)n.push(t[r].call(this,arguments[r])),r+=1;return e.apply(this,n.concat(R0;i<n;)r(t in e)n[n.length]=e[t];return n})),gn=(i=function(e){return{value:unction(eunction(e)&&!e[n](t[n]))return!1;return!0})),wn=U((function(e,t){return ye(e.length,(function(){return t.apply(h]=[e[r]i;)n[r]=[e[r],t[r]],r+=1;return n})),Sn=U((function(e,t){for(var n=0,r=e.length,i={};n<r;)i;)r[i]=e(t[i],n[i]),i+=1;return r})),kn=se(!1),An=se(!0),xn=function e(t,n,r){var i=function(i){for(var o=n.length,s=0;s<o;){if(t===n[s])return r[s];s+=1}for(var a in n[s+1]=t,r[s+1]=i,t)i[a]=e(t[a],n,r);return i};switch(an(t)){case"Object":return i({});case"Array":return i([]);case"Date":return new Date(t.valueOf());case"RegExp".apply(this,e(n,arguments))}))}))},Nn=function e(t,n,r,i){if(Ve(t,n))return!0;if(an(t)!==an(n))return!1;if(null==t||null==n)return!1;if("function"==typeof t.equals||"function"==typeof n.equals)return"function"==typeof t.equals&&t.equals(n)&&"function"==typeof n.equals&&n.equals(t);switch(an(t)){case"Arguments":case"Array":case"Object":break;case"Boolean":case"Number":case"String":if(o(t)!==o(n)||!Ve(t.valueOf(),n.valueOf()))return!1;break;case"Date":if(!Ve(t.valueOf(),n.valueOf()))return!1;break;case"Error":return t.name===n.name&&t.message===n.message;case"RegExp":if(t.source!==n.source||t.global!==n.global||t.ignoreCase!==n.ignoreCase||t.multiline!==n.multiline||t.sticky!==n.sticky||t.unicode!==n.unicode)return!1;break;case"Map":case"Set":if(!e(f(t.entries()),f(n.entries()),r,i))return!1;break;case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"ArrayBuffer":break;default:return!1}var s=Ke(t);if(s.length!==Ke(n).length)return!1;for(var a=r.length-1;a>=0;){if(r[a]===t)return i[a]===n;a-=1}for(r.push(t),i.push(n),a=s.length-1;a>=0;){var u=s[a];if(!m(u,n)||!e(n[u],t[u],r,i))return!1;e s[s.length]=eturn e["@@transducer/result"](t)}var t="undefined"!=typeof Symbol?Symbol.iterator:"@@iterator";return function(n,r,i){if("functioneturn e["@@transducer/result"](t)}(n,r,i);if("function"==typeof i.reduce)return function(e,t,n){return e["@@transducer/result"](n.reduce(he(e["@@transducer/step"],e),t))}(n,r,i);if(null!=i[t])return e(n,r,i[t]());if("function"==typeof i.next)return e(n,r,i);throw new TypeError("reduce: list unction(t,n){retthis.xf=t,this.f=e,this.inputs={}}return e.prototype["@@transducer/init"]=P.init,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){var n=this.f(t);return this.inputs[n]=this.inputs[n]||[n,[]],this.inputs[n((function(t,n){return new e(t,n)}))}(),jn=q((function(e){return ye(e.length,(function(){var t=0,n=arguments[0],r=arguments[arguments.leh(arguments,[t,r]));return t+=1,e},e.apply(this,i)}))})),Ln=q((function(e){return pt(2,e)})),qn=q((function(e){return null!=e&&"function"==typeof e.clone?e.clone():xn(e,[],[])})),Un=q((function(e){return t){return Ht(Math.max(0,urn Xt(e<t.length?t.length-e:0,t)}))),Fn=U(F("dropLastWhile",Cn,(function(e,t){for(var n=t.length-1;n>=0&&e(t[n])unction(e,t){return N&(n[r]=t[r]),n}),{},Ke(t)):b(e,t)}))),Wn=q(Mn(!0)),Gn=q((function(e){return Un((function(t,n){var r=R(arguments);return r[0]=n,r[1]=t,e.apply(this,r)}))})),zn=U(F("groupBy",Pn,(function(e,t){return Rn((function(t,n){var r=e(n);return t[r]=le(n,t[r]||(t[r]=[])),t}),{},t)}))),Jn=bt(function(t,n){return t[e(n)]=n,t}),{},t)})),Qn=Ht(0,-1),Kn=D((function(e,t,n){for(var r=[],i=0;i<t.length;)v(e,t[i],n)&&(r[r.length]=s]=[];a[ar o=t[ron(e){return null!}return-1}return t.,{},Ke(t)rn n[r]=ction(t,n,r){return e(n,r)}),t,n)})),or=In(h),sr=In(Gn(h)),ar=U((function(e,t){return Rn((function(t,n){var r=t[e(n)?0:1];return r[rction(e,t,n){return Bn(St(e,n),t)})),cr=U((function(e,t){return nr(Mt(e),t)})),lr=vn(A,[xt,Fe]),fr=D((function(e,ction(e,t,n){return Ct(Je(e),t,n)})),dr=D(Rn),hr=U((functi(function(e,t){returt){return D"function"==typeof t?j(t):t),n,r)})),yr=D((function(e,t,n){return pn(e,h(t,n))})),_r=U((functiournBn(e[n(functiouments))return!1;t+=1}return!0}))})),Tr=q((function(e){for(var t=e.length,n=0;n<t;){if(Er(e,e[n],n+1)>uments))return!0;t+=1}return!1}))})),Ar=U((function(e,t){return"function"==typeof e.ap?e.ap(t):"function"==typeof e?ye(Math.max(e.length,t.length),(function(){return e.apply(this,argumentfunction(e,n){return h(e,nr(n,t))}),[],e)})),xr=Un((function(e){return e.apply(this,R(arguments,1))})),Ir=U(F("chain",Or,(function(e,t){return"function"==typeof t?function(){return t.call(this,e.apply(this,arguments)).apply(this,arguments)}:Mn(!1)(nr(e,t))}))),Nr=D((function(e,t,n){return Lt((function(t,n){return Ar(n new t(e,n,r,i,o,s,a,u,c,l)}})))})),Rr=U((function(e,t){return ye(Mation(e){return e.apply(r,n)}),t))|(n[n.lenction(e,ction(e,exOf||_(t)?Er(t,e,0):t.indexOf(e)})),qr=q((function(e){return function(){retuion(e){return t(e,r)}),n(e(r)))}}})),Dr=q((function(e){return Ur(bt(e),hn(e))})),Vr=q((function(unction(e){return Ur(Mt(e),pe(e))})),Br=U((function(e,t){var n=ye(e,t);return ye(e,(function(){return Rn(Ar,nr(n,argumenfunction(e){return br(e)/e.length})),Wr=q((function(e){var t=e.length;if(0===t)return NaN;var n=2-nction(e,t){return e<t?-1:e>t?1:0})).slice(r,r+n))})),Gr=iq((function(e){return dr(Gr,{},e)})),Jr=function(){if(0===arguments.length)throw new Error("pipe requires at least one argument");return l(arguments[0].length,dr(dr(I,arguments[0],{return ction(e,t,n){rfunction(e,t){return Er(t,e,0)>=0},ei=(s={"@@transducep":function(e,t){return h(e,[t])},"@@transducer/result":g},a={"@@transduceer/step":function(e,t){return e+t},"@@transducer/result":g},u={"@@transduceeturn Gr(e,Ye(t)?gt(t[0],annourn"{"+i(t,Ke(t)).join(", ")+"}"}},ni=Nr(Fe),ri=function(){if(0===arguments.length)throw new Error("compose requires at least one argument");return Jr.apply(this,Vt(arguments))},ii=function(){return ri.apply(this,Nt(Fe,nr(Ir,arguments)))},oi=q((function(e){retur|(n[n.length]=e[r]),r+=1;return n})),ui=q(F("dropRepeats",J(Bn),Cr(Bn))),ci=D((function(e,t,n){return k(e)?Rn(t(e),e["@@transducer/inifunctionn t)Zr(rpi=q((function(e){return ti(e,[])})),di=U("undefined"==typeof Set?function(e,t){for(var n,r,i=0,o=[],s=[];i<t.length;)n=e(r=t[i]),Zr(n,o)||(s.push(r),o.push(n)),i+=1;return s}:function(e,t){for(var n,r,i,s=new Set,a=[],u=0,c=[],l=!1,f=!1,p=0;p<t.length;){switch(o(n=e(r=t[p]))){case"number":if(0===n&&!f&&1/n==-1/0){f=!0,c.push(r);break}case"string":case"boolean":case"function":case"undefined":s.add(n),(i=s.size)>u&&(c.push(r),u=i);break;case"object":if(null===n){l||(l=!0,c.push(null));break}default:Zr(n,a)||(a.push(nction(e,t){return hr(Gn(Zr)(e),t)})),vi=li(vt),bi=U((function(e,t){return ye(e+1,(function(){var n=arguments[e];if(null!=n&&Je(Function,n[t]))return n[t].apply(n,R(arguments,0,e));throw new TypeError(pi(n)+' does not have a method named "'+t+'"')}))})),mi=bi(1,"join"),gi=q((function(e){var t={};return l(e.length,(function(){var n=pi(arguments);return m(n,t)||(t[n]=e.apply(this,arguments))ed "+pi(e));var n;return p(e).test(t)})),wi=bi(0,"toLowerCase"),Ei=bi(0,"toUpperCase"),Oi=di(Fe),Si=Gn(bi(1,"concat")),Ti=U((function(ection(e,e,t,n){return Si(Ee(e,t,n),Ee(e,n,t))})),xi=U(ri(Oi,h)),Ii={F:kn,T:An,__:c,add:re,addIndex:jn,adjust:ie,all:oe,allPass:Sr,allUniq:Tr,always:se,and:ae,any:ue,anyPass:kr,ap:Ar,aperture:ce,append:le,apply:fe,assoc:pe,assocPath:de,binary:Ln,bind:he,both:ve,call:xr,chain:Ir,clone:qn,commute:ni,commuteMap:Nr,comparator:be,complem);return Yr.apply(this,Vt(arguments))},concat:Si,cond:me,construct:oi,constructN:Mr,contains:si,converge:Rr,countBy:ge,curry:Un,curryN:ye,dec:_e,defaultTo:we,difference:ai,differenceWith:Ee,dissoc:Oe,dissocPath:Se,divide:Te,drop:Dn,dropLast:Vn,dropLastWhile:Fn,dropRepeats:ui,dropRepeatsWith:Cr,dropWhile:ke,either:Ae,empty:xe,eqBy:Pr,eqProps:jr,equals:Bn,evolve:Ie,filter:Hn,find:Ne,findIndex:Me,findLast:Re,findLastIndex:Ce,flatten:Wn,flip:Gn,forEach:Pe,fromPairs:je,groupBy:zn,gt:Le,gte:qe,has:Ue,hasIn:De,head:Jn,identical:Ve,identity:Fe,ifElse:Be,inc:He,indexBy:Yn,indexOf:Lr,init:Qn,insert:We,insertAll:Ge,intersection:Ti,intersectionWith:Kn,intersperse:ze,into:ci,invert:Xn,invertObj:$n,invoker:bi,is:Je,isArrayLike:Ye,isEmpty:Zn,isNil:Qe,join:mi,juxt:qr,keys:Ke,keysIn:Xe,last:er,lastIndexOf:tr,length:$e,lens:Ur,lensIndex:Dr,lensPath:Vr,lensProp:Fr,lift:li,liftN:Br,lt:Ze,lte:et,map:nr,mapAccum:tt,mapAccumRight:nt,mapObjIndexed:rr,match:rt,mathMod:it,max:ot,maxBy:st,mean:Hr,median:Wr,memoize:gi,merge:Gr,mergeAll:zr,mergeWith:ir,mergeWithKey:at,min:ut,minBy:ct,modulo:lt,multiply:ft,nAry:pt,negate:dt,none:ht,not:vt,nth:bt,nthArg:mt,objOf:gt,of:yt,omit:fi,once:_t,or:wt,over:Et,pair:Ot,partial:or,partialRight:sr,partition:ar,path:St,pathEq:ur,pathOr:Tt,pathSatisfies:kt,pick){return ii.apply(this,Vt(arguments))},pipeP:Yr,pluck:cr,prepend:Nt,product:Qr,project:lr,prop:Mt,propEq:fr,propIs:pr,propOr:Rt,propSatisfies:Ct,props:Pt,range:jt,reduce:dr,reduceRight:Lt,reduced:qt,reject:hr,remove:Ut,repeat:vr,replace:Dt,reverse:Vt,scan:Ft,sequence:Kr,set:Bt,slice:Ht,sort:Wt,sortBy:Gt,split:yi,splitAt:zt,splitEvery:Jt,splitWhen:Yt,subtract:Qt,sum:br,symmetricDifference:ki,symmetricDifferenceWith:Ai,tail:Kt,take:Xt,takeLast:mr,takeLastWhile:$t,takeWhile:Zt,tap:en,test:_i,times:tn,toLower:wi,toPairs:nn,toPairsIn:rn,toString:pi,toUpper:Ei,transduce:gr,transpose:on,traverse:Xr,trim:sn,type:an,unapply:un,unary:cn,uncurryN:ln,unfold:fn,union:xi,unionWith:yr,uniq:Oi,uniqBy:di,uniqWith:pn,unless:dn,unnest:$r,update:hn,useWith:vn,values:bn,valuesIn:mn,view:gn,when:yn,where:_n,whereEq:_r,without:hi,wrap:wn,xprod:En,zip:On,zipObj:Sn,zipWith:Tn};e.exports=Ii}).call(S)})),N={enabled:!0},M=function(e,t,n,r,i){t||(t=6e4),void 0===n&&(n=2),void 0===r&&(r=.5),i||(i=Math.random);var o=null,s=function(s){if(!N.enabled)return 6048e5;var a=e*Math.pow(n,s);o&&(a=Math.max(a,o),o=null);var u=i(),c=Math.floor(u*r*a),l=Math.floor(10*u)%2==0?a-c:a+c;return a=Math.min(l,t),N.maxDelay&&a>N.maxDelay?N.maxDelay:N.minDelay&&a<=N.minDelay?N.minDelay:a};return s.setNextDelayMinimum=function(e){o=e},s.maximizeNextDelay=function(){return s.setNextDelayMinimum(t)},s},R=function e(t){var n=t.calculateAttemptDelay,r=t.attempt,i=t.onGiveUp,o=t.retryLimit,s=t.retryCount,a=function(t){return r({context:{retryLimit:o,retryCount:s,delay:t},repeat:function(t){return 0===o||s<o?e({calculateAttemptDelay:n,attempt:r,onGiveUp:i,retryLimit:o,retryCount:s+1}):i(t)}})};if(0===s)a(0);else{var u=n(s);setTimeout((function(){return a(u)}),u)}},C=function(e){var t=e.calculateAttemptDelay,n=e.attempt,r=e.onGiveUp,i=e.retryLimit;if(0!==i&&!r)throw new Error("Must define onGiveUp if retryLimit is not 0");return R({calculateAttemptDelay:t,attempt:n,onGiveUp:r,retryLimit:i,retryCount:0})},P=function(){return sm.conf.integrities_enabled},j=function(e){if(P()||e.force){var t=e.name?I.propEq("name",e.name):I.propEq("versioned_name",e.versionedName),n=I.find(t,sm.conf.integrities);if(n)return I.prop("integrity",n);sm.logger.error("Could not find expected integrity for module",e)}},L=function(e){var t=e.beforeLoad,n=e.onAttempt,r=e.onLoad,i=e.onError,o=e.onGiveUp,s=e.integrity,a=e.fileUrl,u=e.retryLimit,c=void 0===u?5:u,l=e.backoffDelay;C({calculateAttemptDelay:M(void 0===l?1e3:l),attempt:function(e){var o=e.repeat;"function"==typeof n&&n();var u=document.createElement("script");return u.type="text/javascript",u.onload=function(){"function"==typeof r&&r()},u.onerror=function(){"function"==typeof i&&i(),document.head.removeChild(u),o()},u.src=a,s&&(u.setAttribute("integrity",s),u.setAttribute("crossorigin","*")),"function"==typeof t&&t(u),document.head.appendChild(u),u},onGiveUp:function(){"function"==typeof o&&o()},retryLimit:c})},q=function(e){var t=e.integrity,n=e.fileUrl,r=e.onAttempt,i=e.onError,o=e.onGiveUp;return C({calculateAttemptDelay:M(1e3),attempt:function(e){var o=e.repeat;"function"==typeof r&&r();var s=document.createElement("link");return s.type="text/css",s.rel="stylesheet",s.onerror=function(){"function"==typeof i&&i(),document.head.removeChild(s),o()},s.href=n,t&&(s.setAttribute("integrity",t),s.setAttribute("crossorigin","*")),do:function(){"function"==typeof o&&o()},retryLimit:5})};function U(e){return(U="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function D(){var e=this;this.list=[],this.add=function(t){10===e.list.length&&(e.list=[r];for(var i in t)n[i]=t[i];return n},F=function(e){var t={};for(var n in e){var r=e[n];t[n]="function"==typeof r?r():r}return t},B=function(e,t){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n)},H=["string","numbeys(e).map((function(t){sing CustomTransport");this.process=e},HttpTransport:function(e){var t=e.url,n=e.method,r=e.headers,i=e.encode;if(!t)throw new Error("url must be specificed when using HttpTransport");n||(n="POST"),r||(r={}),i||(i=function(e){return JSON.stringify(e)}),this.process=window.fetch?function(e){var o=e.payload;return window.fetch(t,{method:n,headers:r,keepalive:!0,body:i(o)})}:function(e){var o=e.payload;return new Promise((function(e,s){var a=new XMLHttpRequeunction(e){a.setRequestHeader(e,r[e])})),a.onload=function(){a.status<200||status>=300?s():e()},a.onerror=function(){return s()},a.send(i(o))}))}}},z=function(e){return function(t){var n=t.namespace;return{attempted:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.tags,i=void 0===r?[]:r,o=Date.now(),s=!1,a=function(t){var r=t.action,o=t.reason,s=["action:".concat(r)];return o&&s.push("reason:".concat(o)),e.increment{return a({action:"failed",reason:e})},c=function(t){var r=t.action;s=!0;var a=Date.now()-o;e.histogram("sm.timing.lib.".concat(n),a,I.concat(i,["client:browser","action:".concat(r)]))};ret"succeeded"}),c({action:"succeeded"})},failed:function(e){u(e),c({action:"failed"})},timedOut:function(){u("timed_outn(){u("unknown"),c({action:"failed"})},isFinished:function(){return s}}}}}},J=["timing","increment","decrement","gauge","histogram","set"],Y=function(){function e(){var t=this;s(this,e),this.withTags=this.withTags.bind(this),this.instrument=function(){return{attempted:function(){return{succeeded:function(){},failed:function(){},timedOut:function(){},failedUnknown:function(){},orEach((function(e){t[e]=function(){}}))}return u(e,[{key:"recordMessageHubConnectionEstablished",value:function(){}},{key:"recordBaseDomCaching",value:function(){}},{key:"clientHandlerError",value:function(){}},{key:"statApiUsage",value:function(e){e.resource;return function(e){return{attempted:function(){return{succeeded:function(){},failed:function(){},timedOut:function(){},failedUnknown:function(){},isFinished:function(){}}}}}}},{key:"statScreenShareUsagefunction(){},isFinished:function(){}}}}}},{key:"withTags",value:function(){return this}}]),e}(),Q=function(){function e(t,n){var r=this;s(this,e),this.statApiUsage=this.statApiUsage.bind(this),this.statScreenShareUsage=this.statScreenShareUsage.bind(this),this.withTags=this.withTags.bind(this),this.statsClient=t,this.latencyMeasurer=n,this.instrument=z(this.statsClient),J.forEach((function(e){r.statsClient[e]&&(r[e]=r.statsClient[e].bind(r.statsClient))}))}return u(e,[{key:"recordBaseDomCaching",value:function(e){var t=e.result;this.statsClient.increment("sm.app.visitor.api.cached_base_dom",["action:save","result:".concat(t)])}},{key:"clientHandlerError",value:function(e){this.statsClient.increment("sm.app.visitor.api.client_handler",["action:failed","executor:".concat(e)])}},{key:"statApiUsage",value:function(e){var t=this,n=e.protocol,r=e.resource;return function(e){return z(t.statsClient.withTags(["protocol:".concat(n),"method:".concat(e)]))({namespace:r})}}},{key:"statScreenShareUsage",value:function(e){var t=e.stage,n=e.resource;return z(this.statsClient.withTags(["stage:".concat(t)]))(n new e(this.statsClient.withTags(t))}}],[{key:"createDummy",vate(t)ction Z(e){return"function"==typeof e}var ee=!1,te={Promise:void 0,seHandling(e){e&&(new Error).stack;ee=e},get useDeprecated){setTimeout((function(){throw e}),0)}var ynchronousErrorHandling)th{re(e){rtype=iocat(t ber")ed=!1,tentSubscriber=null,e.unsubscribe()},t}(le);function pe(e){for(;e;){var t=e,n=t.closed,r=t.destination,i=t.isStopped;if(n||i)return!1;e=r&&r instanceof le?r:null}return!0}function de(e,t,n){if(e){if(e instanceof le)return e;if(e[ce])return e[ce]()}return eolce((function(e,s._isScalar=!1,e&&(thise;return n.source=this,n.operator=t,n},e.prototype.subscribe=function(e,t,n){var r=this.operator,i=de(e,t,n);if(r?i.add(r.call(i,this.source)):i.add(this.source||te.useDeprecatedSynchronousErrorHandling&&!i.syncErrorThrowable?this._subscribe(i):this._trySubscribe(i)),te.useDeprecatedSynchronousErrorHandling&&i.syncErrorThrowable&&(i.syncErrorThrowable=!1,i.syncErrorThrown))throw i.syncErrorVal=t),pe(e)?e.error(t)e){r(e),i&&i.unsubscrib=this.source;return t&&t.subscribe(e)},e.prototype[he]=fu;return 0===e.length?t n(e)}),(function(){return e(r)}))}))},e.crror("no Promise impl found");return e}var _e=function(){function e(){return Error.call(this),this.message="object unsubscribed",this.name="ObjectUnsubscribedError",this}return e.prototype=ubscriburn n.de=funct?thifunctiosed|cribe()Count=fconneonneon(i){return i.lift(new Re(e,t,n,r))}}var Re=function(){function e(e,t,n,r){this.keySelector=e,this.elementSelector=t,this.durationSelector=n,this.subjectSelector=r}return e.prototype.call=function(e,t){return t.subscribe(new Ce(e,this.keySelector,this.elementSelector,this.durationSelector,this.attemptedToUnsubscribe=!1,s.coun void this.error(e)}this._group(e,t)},t.prototype._group=function(e,t){var n=this.groups;n||(n=this.groups=new Map);var r,i=n.get(t);if(this.elementSelector)try{r=this.elementSelector(e)}catch(e){this.error(e)}else r=e;if(!i){i=this.subjectSelector?this.subjectSelector():new Oe,n.set(t,i);var o=new je(t,i,this);if(this.destination.next(o),this.durationSelector){var s=void 0;try{s=this.durationSelector(new je(t,i))}catch(e){return void this.error(e)}this.add(s.subscribe(new Pe(t,i,this)))}}i,t.clear()),this.desti.clear()),this.destination.complete()},t.prototype.removeGroup=function(e){this.gro&&e.prototis.parenew Le(tedToUntype.neschedulecId.cale.nowshift();)e.this,arguments)||this}return X(t,e),t}(Fe))(De),He=Be,We=new on(){return t.complete()}))}))}(e):We}function ze(e){return e&&")}:function(t){return t.error(e)})}function Ze(e){var t=e.error;e.ValueNotiw nt(eateComplete()),this.unsubscribe()},t}(le),rt=function(){return function(e,t){this.noh.max(o,i-t)),o>0&&r.splice(0,o),r},t}(Oe),ot=function(){return functioe),e.prototype.complete.call(this)},t}(Oe),at=1,ut=functi(e){return e in ct&&en((function(){),t},clearImmediate:function(e){lt(e)}},pt=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r.scheduler=t,r.work=n,r}return X(t,e),t.prototype.requestAsyncId=function(t,n,r){return void 0===r&&(r=0),null!==r&&r>0?e.prototype.requestAsyncId.call(this,t,n,r):(t.actions.push(this),t.scheduled||(t.scheduled=ft.setImmediate(t.flush.bind(t,null))))},t.prototype.recycleAsyncId=function(t,n,r){if(void 0===r&&(r=0),null!==r&&r>0||null===r&&this.delay>0)return e.prototype.recycleAsyncId.call(this,t,n,r);0===t.actions.length&&(ft.clearImmediate(n),t.scheduled=void 0)},t}(Ue),dt=new(function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return X(t,e),t.prototype.flush=function(e){this.active=!0,this.scheduled=void 0;var t,n=this.actions,r=-1,i=n.length;e=e||n.shift();do{if(t=e.execute(e.state,e.delay))break}while(++r<i&&(e=n.shift()));if(this.active=!1,t){for(;++r<i&&(e=n.shift());)e.unsubscribe();throw t}},t}mationFrameshift());)e.unsubsbe();throw e}},t.frdex=r,i.active=!0,i.index=t.index=k);return this.add(i),i.schi.push(this),i.sort(t.sortAotype.recycleAsyncId=n e.prototype.dex>t.index?1:-1:e.delay>t.delay?1:-1},t}(Ue);function Et(){}var Ot=function(){function e(){return Error.call(this),this.message="argument out of range",this.name="ArgumentOutOfRangeError",this}return e.prototype=Object.create(Error.prototype),e}(),St=function(){function e(){return Error.call(this),this.message="no elements in sequence",this.name="EmptyError",this}return e.prototype=typTo()`?");return n.lift(new At(e,t))}}var At=function(){function e(e,t){this.project=e,this.thisArg=t}return e.prototype.call=function(e,t){return t.subscribe(new xt(.err{u.error(e)}}this.add(u.subscribe(r))}function Nt(e){var t=e.vat(e)ion(e){yCompleiterator?Symbofunl.o.subscribe&&"function"==typeof e.then}var Ht=function(e){if(e&&"function"==typeof e[he])return Vt(e);if(Ft(e))return Ye(e);if(Bt(e))return Lt(e);if(e&&"function"==typeof e[Ut])return Dt(e);var t=oe(e)?"an invalid object":"'"+e+"'";throw new TypeError("You provided "+t+" where a stream was expected. You can provide an Obserinstanceof ge?t.subscribe(i):Ht(t)(i)}var Gt={};var zt=function(){function e(e){this.resultSelector=e}return e.prototype.call=function(e,t){return t.subscribe(n.error(e)}this.destination.next(t)},tion(){return n.error(e)})))}))}))),r}))}function Qt(e,t){if(!e)throw new Error("Itn.next(e),this.schedule())}})))}))),i}))}function Kte){return e&&"function"==typeof e[Ut]}functi{return n.complete()})))}}))}))),r}))}(e,t);if(Bt(e))return Yt(e,t);if(Ft(e))return Qe(e,t);if(Xt(e)||"string"==typeof e)return Qt(e,t)}throw new TypeError((nu(e,t):otifyCotiontion(n(e,tleted&&thinceof getion(n){return n.lift(new En(e,t))}}var En=function(){function e(e,t){this.predicate=e,this.thisArg=t}return e.prototype.call=function(e,t){return t.subscribe(new On(e,ror(e[0]}return Ke(e,void 0).lift(new Tn)}var Tn=function(){function e(){}return e.prototype.call=function(e,t){ionspop(),Ke(e,void 0).lift(new Mn(n))}var Mn=function(){function e(e){this.resultSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new Rn(e,this.resultSelector))},e}(),Rn=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.resultSelector=n,i.iterators=[],i.active=0,i.resultSelector="function"==typeof n?n:vopush(new jn(this.destie--}}else this.destination.s.active&&this.destination.Selector(o):n.next(o),i&&n.complete()},t.prototype._tryresultSelector=function(e){var t;try{t=this.resultSelector.apply(this,e)}catch(e){return void this.destination.error(xtResurn tn nn(this.observable,new en(this))},t}(tn),Ln=Object.freeze({__proto__:null,Observable:ge,ConnectableObservable:xe,GroupedObservable:je,observable:he,Subject:Oe,BehaviorSubject:qe,ReplaySubject:it,AsyncSubject:st,asap:ht,asapScheduler:dt,async:bt,asyncScheduler:vt,queue:He,queueScheduler:Be,animationFrame:yt,animationFrameScheduler:gt,VirtualTimeScheduler:_t,VirtualAction:wt,Scheduler:Ve,Subscription:ae,Subscriber:le,Notification:et,get NotificationKind(){return Je},pipe:be,noop:Et,identity:ve,isObservable:function(e){return!!e&&(e instanceof ge||"function"==typeof e.lift&&"function"==typeof e.subscribe)},ArgumentOutOfRangeError:Ot,EmptyError:St,ObjectUnsubscribedError:_e,UnsubscriptionError:se,TimeoutError:Tt,bindCallback:function e(t,n,r){if(n){if(!ze(n))return function(){for(var i=[],o=0;o<arguments.length;o++)i[o]=arguments[o];return e(t,r).apply(void 0,i).pipe(kt((function(e){return ie(e)?n.apply(void 0,e):n(e)})))};r=n}return function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var i,o=this,s={context:o,subject:i,callbackFunc:t,scheduler:r};return new ge((function(n){if(r){var a={args:e,subscriber:n,params:s};return r.schedule(It,0,a)}inext(e.length<=1?e[0]:e),i.complete()}]))}catch(e){pe(i)?i.error(e):console.warn(e)}}return i.subscribe(n)}))}},bindNodeCallback:futurn ie(e)?ole.warn(e)}}return s.subscribe(n)}))}},combineLatest:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=void 0,r=void 0;return ze(e[e.length-1])&&(r=e.pop()),"function"==typeof e[e.length-1]&&(n=e.pop()),1===e.length&&ie(e[0])&&(e=e[0]),Ke(e,r).lift(new zt(n))},concat:ln,defer:fn,empty:Ge,forkJoin:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length){var n=e[0];if(ie(n))return pn(n,null);if(oe(n)&&Object.getPrototypeOf(n)===Object.prototype){var r=Object.keys(n);return pn(r.map((function(e){return n[e]})),r)}}if("function"==typeof e[e.length-1]){var i=e.pop();return pn(e=1===e.(function(e){return i.apply(void 0,e)})))}return pn(e,null)},from:Zt,fromEvent:function e(t,n,r,i){return Z(r)&&(i=r,r=void 0),i?e(t,n,r).pipe(kt((function(e){return ieice.call(arguments)):e.next(t)}),e,r)}))},fromEventPattern:func){return ieZ(n))return function(){return n(i,r)}}))},generate:function(e,t,n,r,i){var o,s;if(1==arguments.length){var a=e;s=a.initialState,t=a.condition,n=a.iterate,o=a.resultSelector||ve,i=a.scheduler}else void 0===r||ze(r)?((r)}catch(t){return void e.error(t)}}}))},iif:function(e,t,n){return voi&(n=We),fn((function(){return e()?t:n}))},interval:function(e,t){return void 0===e&&(e=0),void 0===t&&(t=bt),(!vn(e)||e<0)&&(e=0),t&&"functi{subscriber:n,counter:0,period:e})),n}))},merge:mn,never:function(){return gn},of:Xe,onErrorResumeNext:function e(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];if(0===t.length)return We;var r=t[0],i=t.slice(1);return 1===t.lon(e){t.next(e)},error:n,complete:n})})rty(i)&&t.next([i,e[i]])}t.complete()})},partition:function(e,t,n){return[wn(t,n)(new ge(Ht(e))),wn(_n(t,n))(new ge(Ht(e)))]},race:Sn,range:function(e;break}if(r.next(o++),r.closed)break}}))},throwError:$e,timer){o.unsubscribe(),r&&r.unsubscribe()}}))},zip:Nn,scheduled:$t,EMPTY:We,NEVER:gn,config:te});var qn="undefined"!=typeof window&&window,Un="undefined"!=typeof self&&"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&self,Dn="undefinedew Yn({method:"GET",url:e,headers:t})}function Bn(e,t,n){return new Yn({Yn({method:"DELETE",url:e,headers:t})}function Wn(e,t,n){return new Yn(thod:"PATCH",url:e,body:t,headers:n})}var zn=rl:e,responseType:(i)&&(r[i]=t[i]);return n.request=r,tion(e){rHn,e.put=Wn,e.patch=Gn,en.headers,"Content-Type")),r.s}catch(e){return d(u):c.send()}catch(e){thin JSON.stringify(e);defoperty(n)&&e.setRequesrCase()===t.toLowerCase(is,a.progressSubscriber=(),e.protohis.rtyponse",t),this.name="AjaxTimeoutError",this},er=function(){return Yn.create}(),tr={url:"",deserializer:function(e){return JSON.parse(e.data)},serializer:function(e){return JSON.stringify(e)}},nr=function(e){function t(t,n){var r=e.call(this)||this;if(t instanceof ge)r.destination=n,r.source=t;else{var i=r._config=$({},tr);if(r._output=new Oe,"string"==typeof t)i.url=t;else for(var o in t)t.hasOwnProperty(o)&&(i[o]=t[o]);if(!i.WebSocketCtor&&WebSocket)i.WebSocketCtor=WebSocket;else if(!i.WebSocketCtor)throw new Error("no WebSocket constructor can be found");r.destination=new it}r);return n.operator=e,n.source=this,n},t.prototype._resetState=function(){this._socket=null,this.source||(this.destination=new it),this._output=new Oe},t.prototype.multiplex=fun}catch(e){i.error(e)}o.unsubscribe()}}))},t.prototype._connectSocket=function(){var e=this,t=this._config,n=t.WebSocketCtor,r=t.protocol,i=t.url,o=t.binaryType,s=this._output,a=null;try{a=r?new n(i,r):new n(i),this._socket=a,o&&(this._socket.binaryType=o)}catch(et=null,a&&1===a.readyState&&a.close()}));a.onopen=function(t){if(!e._socket)return a.close(),void e._resetState();var n=e._config.openObserver;n&&n.next(t);var r=(t, ext(void 0),a.close(),e._resetState()})),r&&r instanceof it&&u.add(r.subscribe(e.destination))},a.onerror=function(t)t),t.wasCleazer;s.next(n(t))}catch(eate&&e.close(),t._resetS(),e.pr}(Se);function rr(e){return new nr(e)}var ir=function(e){function t(t,n,r){void 0===n&&(n=0),void 0===r&&(r=ht);var i=e.call(this)||this;return i.source=t,i.delayTime=n,i.scheduler=r,(!vn(n)||n<0)&&(i.delayTime=0),r&&"function"==typeof r.schedule||(i.(n=0),void riber;return this.add(tt.dispatch,n,{source:r,subscriber:e})},t}(ge);var or=function(){return function(tion(rcumulis.seed=t,ton(e,t){this.value=e,this.interval=t}}(),lr={leading:!0,trailing:!1};var fr=function(){function e(e,t,n){this.durationSelector=e,this.leading=t,this.trailing=n}return e.prototype.call=function(e,t){return t.subscribe(new pr(e,this.durationSelector,this.leadinding=r,o._trailing=i,o._hasValuleading?this.sends._hasValue=!1,this._sendValue=void 0},t.prototype.throttle=function(e){var t=this.tryDurationSelector(e);t&&this.add(this._throttled=nn(t,new en(theturn this.destination.errothis._throttled=void 0,t&&this.send()},t.prototype.notifyNext=function(){this.throttlingDone()},t.prototype.notifyComplete=function(){this.thr{return hr.e=e,hr}finally{dr=void 0}}var mr=Object.freeze({__proto__:null,config:te,InnerSubscriber:jt,OuterSubscriber:Pt,Scheduler:Ve,AnonymousSubject:Se,SubjectSubn(e,t){return t?Yt(e,t):new ge(Lt(e))},fromIterable:function(e,t){if(!e)throw new Error("Iterable cannot be null");return t?Qt(e,t):new ge(Dt(e))},ajax:er,webSocket:rr,ajaxGet:Fn,ajaxPost:Bn,ajaxDelete:Hn,ajaxPut:Wn,ajaxPatch:Gn,ajaxGetJSON:Jn,AjaxObservable:Yn,AjaxSubscriber:Qn,AjaxResponse:Kn,AjaxError:Xn,AjaxTimeoutError:Zn,WebSocketSubject:nr,CombineLatestOperator:zt,dispatch:An,SubscribeOnObservable:ir,Timestamp:or,TimeInterval:cr,GroupedObservable:je,defaultThrottleConfig:lr,rxSubscriber:ce,iterator:Ut,observable:he,ArgumentOutOfRangeError:Ot,EmptyError:St,Immediate:ft,ObjectUnsubscribedError:_e,TimeoutErroru=o[s];e.prototype[u]=i.prototype[u]}},errorObject:hr,hostReportError:ne,identity:ve,isArray:ie,isArrayLike:Ft,isDate:vr,isFunction:Z,isIterable:Xt,isNumeric:vn,isObject:oe,isObservable:Kt,isPromise:Bt,isScheduler:ze,noop:Et,not:_n,pipe:be,root:Vn,subscribeTo:Ht,subscribeToArray:Ye,subscribeToIterable:Dt,subscribeToObservable:Vt,subscribeToPromise:Lt,subscrie,tryCatch:function(e){return dr=e,br}}),gr=A(Ln),yr=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.bindCallback=gr.bindCallback})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.bindNodeCallback=gr.bindNodeCallback})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.combineLatest=gr.combineLatest})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.concat=gr.concat})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.defer=gr.defer})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.empty=gr.empty})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.forkJoin=gr.forkJoin})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.from=gr.from})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.fromEvent=gr.fromEvent})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.fromEventPattern=gr.fromEventPattern})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.fromPromise=gr.from})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.generate=gr.generate})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.if=gr.iif})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.interval=gr.interval})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.merge=gr.merge})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Obserion(e,t){function n(){return gr.NEVER}Object.defineProperty(t,"__esModule",{value:!0}),t.staticNever=n,gr.Observable.never=n})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.of=gr.of})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.onErrorResumeNext=gr.onErrorResumeNext})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.pairs=gr.pairs})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.range=gr.range})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.using=gr.using})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.throw=gr.throwError,gr.Observable.throwError=gr.throwError})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.timer=gr.timer})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.zip=gr.zip})),A(Object.freeze({__proto__:null,ajax:er,AjaxResponse:Kn,AjaxError:Xn,AjaxTimeoutError:Zn}))),_r=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.ajax=yr.ajax})),A(Object.freeze({__proto__:null,webSocket:rr,WebSocketSubject:nr})));k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.webSocket=_r.webSocket}));function wr(e){return function(t){return t.lift(new Er(e))}}var Er=function(){function e(e){this.durationSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new Or(e,this.durationSelector))},e}(),Or=function(e){function t(t,n){var r=e.call(this,t)||this;return r.durationSelector=n,r.hasValue=!1,r}return X(t,e),t.prototype._next=function(e){if(this.value=e,this.hasValue=!0,!this.throttled){var t=void 0;try{t=(0,this.durationSelector)(e)}catch(e){return this.destination.error(e)}var n=nn(t,new en(this));!n||n.closed?this.clearThrottle():this.add(this.thhasValue=!1,this.destination.next(t))},t.prototype.notifyNext=function(){this.clearThrottle()},t.prototype.notifyComplete=function(){this.clearThrottle()},t}(tn);function Sr(e,t){return void 0===t&&(t=bt),wr((function(){return xn(e,t)}))}var Tr=function(){function e(e){this.closingNotifier=e}return e.prototype.call=function(e,t){return t.subscribe(new kr(e,this.closingNotifier))},e}(),kr=function(e){function t(t,n){var r=e.call(this,t)||this;return r.buffer=[],r.add(nn(n,new en(r))),r}return X(t,e),t.prototype._next=function(e){this.is.buffnctionbuffe),e.pro)}e.prototype._complete.call(this)},t}(le);var Mr=function(){function e(e,t,n,r){this.bufferTimeSpan=e,this.bufferCreationInterval=t,this.maxBufferSize=n,this.scheduler=r}return e.prototype.call=function(e,t){return t.subscribe(new Cr(e,this.bufferTimeSpan,this.bufferCreationInterval,this.mn(){return functi)),s.add(o.schedule(jr,r,l))}reerSize&&(t=o)}t&&thgth=0,e.prototype._errfer)}e.prototype._complete.call(this)},t.prototype._unsubscribe=function(){this.cion=this.scheduler.schednew Rr;return this.contexf(e):-1riber,n=e.context;t.closeContext(n)}var qr=function(){function e(e,t){this.openings=e,this.closingSelector=t}return e.prototype.call=function(e,t){return t.subscribe(new Ur(e,this.openings,this.closingSelector))},e}(),Ur=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.closingSelector=r,i.contexts=[],i.add(Wt(iength,r=0;r<n;r++)t=null,e.prototype._errnull,e.prototype._complhis.closeBuffer(e):this.openction(e){this.closeBufSubscribe(t)}catch(e){the),1),this.remove(r),r.unsubscribe()}},t.prototype.trySubscribe=function(e){var t=this.contexts,n=new ae,r={buffer:[],subscription:n};t.push(r);var i=Wt(this,e,r);!i||i.closed?this.closeBuffer(r):(i.context=r,this.add(i),n.add(i))},t}(Pt);var Dr=function(){function e(e){this.closingSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new Vr(e,this.r=n,r.subscribing=!1,r.openBuffer(),r}return X(t,e),t.prototype._next=function(e){thist(t),e.prototype._complethis.buffer=void 0,this.subscribing=!1},t.prototype.notifyNext=function(){this.oping?this.complete():this.openBuffer()},t.prototype.openBuffer=function(){var e=this.closingSubscription;e&&(this.remove(e),e.unsubscribe());var t,n=this.buffer;this.buffer&&this.destination.next(n),this.buffer=[];try{t=(0,this.closingSelector)()}catch(e){return this.error(e)}e=new ae,this.closingSubscription=e,this.add(e),this.subscribing=!0,e.add(nn(t,new  Br(e)w Hr(;var i=nn(n,r);i!==r&&this.add(i)}},t}(tn);function Wr(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=null;return"function"==typeof e[e.length-1]&&(n=e.pop()),1=))}}function Gr(e,t){return rn(e,t,1)}var zr=function(){function e(e,t){this.predicate=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new Jr(ecount),this.destination.complete()},t}(le);var Yr=function(){function e(e){this.durationSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new Qr(e,this.durationSelector))},e}(),Qr=function(e){function t(t,n){var r=e.call(this,t)||this;return r.durationSelector=n,r.hasValu)}catch(e){this.destination.error(e)}},t.prototype._complete=function(){this.emitValue(),this.destinthis.add(this.durationSubscription=n)},t.prototype.notifyNext=function(){this.emitValue()},t.prototype.notifyComplete=function(){tue=!1,enction(n){return n.lift(new Xr(e,t))}}var Xr=function(){function e(e,t){this.dueTime=e,this.scheduler=t}return e.prototype.call=function(e,t){return t.subscribe(new $r(e,),thunction(t){return t.lift(new ti(e))}}var ti=function(){function e(e){this.defaultValue=e}return e.prototype.call=function(e,t){return t.subscribeValue),this.destination.complete()},t}(le);var ri=function(){function e(e,t){this.delay=e,this.scheduler=t}return e.prototype.call=function(e,t){return t.subscribe(new ii(eateComplete()),this.unsubscribe()},t}(le),oi=function(){return function(e,t){this.time=e,this.notification=t}}();var si=function(){function e(e){this.delayDurationSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new ai(e,this.delayDyNotifierSubscriptions=[],r.index=0,oveSubscription(i),this.ifyError=function(e,t){thisestination.next(t))}catch(e){this.destinthis.tryComplete(),this.unsubscubscriptions.splice(t,1),e.outerValue},t.prototype.tryDelay=function(e,t){var n=Wt(this,e,t);n&&!n.closed&&(this.destination.add(n),this.delayNotifierSubscripts.length&&y.subschis.source.subscribe(this.parent))},t}(le);var li=function(){function e(){}return e.prototype.call=function(e,t){ion(e){e.observe(this.destination)},t}(le);function pi(e,t){return function(n){return n.lift(new di(e,t))}}var di=function(){function e(e,t){this.keySelector=e,this.flushes=t}return e.prototype.call=function(e,t){return t.subscribe(new hi(e,this.keySelector,this.flushes))},e}(),hi=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.keySelector=n,i.values=new Set,r&&i.add(nn(r,new en(i))),i}return X(t,e),t.prototype.notifyNext=function(){this.values.clear()},t.prototype.notifyError=functioeySelector(e):this._finalizeid n.error(e)}this._finali||(n.add(e),this.destination.next(t))},t}(tn);function vi(e,t){return function(n){return n.lift(new bi(e,t))}}var bi=function(){function e(e,t){this.compare=e,this.keySelector=t}return e.prototype.call=function(e,t){return t.subscribe(new mi(e,this.kfunction(t){return t.lift(new yi(e))}}var yi=function(){function e(e){this.errorFactory=e}return e.prototype.call=function(e,t){return t.subscribeh(t){e=t}this.destination.error(e)},t}(le);function wi(){return new St}function Ei(e){return function(t){return 0===e?Ge():t.lift(new Oi(e))}}var Oi=function(){function e(e){if(this.total=e,this.total<0)throw new Ot}return e.prototype.call=function(e,t){return t.suon.complete(),this.unsubscribe()))},t}(le);var Ti=function(){function e(e,t,n){this.predicate=e,this.thisArg=t,this.source=n}return e.prototype.call=function(e,t){return t.subscribe(new ki(e,this.predicafunction(){this.notifyComplete(!0)},t}(le);var Ai=function(){function e(){}return e.prototype.call=function(e,t){return t.subasCompleted=!1,n.hasSubscription=!1,n}return X(t,e),t.prototype._next=function(e){this.hasSubscription||(this.hasSubscription=!0,this.add(nn(e,cription||this.destination.complete()},t.prototype.notifyComplete=function(){this.hasSubscription=!1,this.hasCompleted&&this.destination.complete()},t}(tn);var Ii=function(){function e(e){this.project=e}return e.prototype.call=function(e,t){return t.subscribe(new Nition=!1,r.hasCompleted=!1,r.indthis.hasSubscription.hasSubscription=!0,this._innerSub(t)},t.prototype._innerSub=function(e){var t=new en(this),n=this.destination;n.add(t);var r=nn(e,t);ination.complete(),this.unsubscribe()},t.prototype.notifyNext=function(e){this.destination.next(e)},t.prototype.notifyError=function(e){this.destination.error(e)},t.prototype.notifyComplete=function(){this.hasSubscription=!1,this.hasCompleted&&this.destination.complete()},t}(tn);var Mi=function(){function e(e,t,n){this.project=e,this.concurrent=t,this.scheduler=n}return e.prototype.call=function(e,t){return t.subscribe(new Ri(e,this.project,this.concurrenter.POSITIVE_INFINITY&&(o.index;t.subscriben.error(e)}}else this.buffer.push(e)}},t.prototype.subscribeToProjection=function(e,t,n){this.active++,this.destination.add(nn(eination.complete(),this.unsubscribe()},t.prototype.notifyNext=function(e){this.active&&this.destination.complete()},t}(tn);function Ci(e){return function(t){return t.lift(new Pi(e))}}var Pi=function(){function e(e){this.callback=e}return e.prototype.call=function(e,t){return t.subscribe(new ji(e,this.callback))},e}(),ji=function(e){function t(t,n){var r=e.call(this,t)||this;return r.add(new ae(n)),r}return X(t,e),t}(le);var Li=function(){function e(e,t,n,r){this.predicate=e,this.source=t,this.yieldIndex=n,this.thisArg=r}return e.prototype.call=function(e,t){return t.subscribe(new qi(e,this.predicate,this.source,tomplete(this.yieldIndex?-1:void 0)},t}(le);var Ui=function(){function e(){}return e.prototype.call=function(e,t){,e),t.prototype._next=function(e){},t}(le);var Vi=function(){function e(){}return e.prototype.call=function(e,t){func{retur t.su o=t(t):gi((function(){return new St})))}}function zi(e){return function(t){return t.lift(new Ji(e))}}var Ji=function(){function e(e){this.value=e}return e.prototype.call=function(e,t){return t.su{this.destination.next(this.value)},t}(le);var Qi=function(){function e(){}return e.prototype.call=function(e,t){return t.subtion t(t){return e.call(this,t)is.destination.next(et.createNext(e))},t.prototype._error=function(e){var t=this.destination;t.next(et.createError(e)),t.complete()},t.prototype._complete=function(){var e=this.destination;e.next(et.createComplete()),e.complete()},t}(le);functt,n,r){return e(t,n,r+1)})),Bi(1))(t)}}function $i(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(t){return t.lift&&(n=t),rn((function(){return e}),n))}var eo=function(){function e(e,t,n){this.accumulator=e,this.seed=t,this.concurrent=n}return e.prototype.call=function(e,t){return t.subscribe(new to(e,this.accumulator,this.seed,!1,o.buffer=[],o.active=0,o.ind_innerSub(r)}else this.add(t);var r=nn(e,t);nation.complete()),thisthis.acc=e,this.hasValue=!0his.accturn i(e);return i.add(t.subscribe(r)),i},e}();var io=function(){function e(e){this.nextSources=e}return e.prototype.call=function(e,t){return t.subscribe(new oo(e,turn r.destination=t,r.nextSources=n,r}return X(t,e),t.prototype.notifyError=function(){this.subscribeToNextSource()},t.prototype.notifyComplete=function(){this.subscribeToNextSource(),thiribeToNextSource(),this.unsubscribe()},t.prototype.subscribeToNextSource=function(){var e=this.nextSources.shift();if(e){var t=new en(this),n=this.destination;n.add(t);var r=nn(e,t);r!==t&&n.add(r)}else thise,t){prev=e,t&&this.destination.next(t)},t}(le);function uo(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=e.length;if(0===n)throw new Error("list o 0;if(void 0===o)return;r=o}return r}}function lo(e){return e?no((function(){return new Oe}),e):no(new Oe)}function fo(e,t,n,r){n&&"function"!=typeof n&&(r=n);var i="function"==tyeturn no((function(){return o}),i)(e)}}function po(e){return void 0===e&&(e=-1),function(t){return 0===e?Ge():e<0?t.lift(new ho(-1,t)):t.lift(new ho(e-1,t))}}var ho=function(){function e(e,t){this.count=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new be(this._unbscribe(new mo(e,ce=r,i.sourceIsBeingSubscribedTo=!0,ibedTo=!0,this.source.subsceturn e.prototype.comle(),this.notifications.next(void 0)}},t.prototype._unsubscribe=function(){var e=this.notifications,t=this.retriesSubscription;e&&(e.unsubscribe(),this.notifications=void 0),t&&(t.unsubscribe(),this.retriesSubscription=void 0),this.retries=voide.call(this),this._unsubscribe=t,this},t.prototype.subscribeToRetries=function(){var t;this.notifications=new Oe;try{t=(0,this.notifier)(this.notifications)}catch(t){return e.prototype.complete.call(this)}this.retries=t,this.retriesSubscription=nn(t,new en(this))},t}(tn);var go=function(){function e(e,t){this.count=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new be(this._unsubscribeAndRecycle())}},t}(le);var _o=function(){function e(e,t){this.notifier=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new wo(e,this.notifthis;return i.notifier=n,i.source=r,i}return X(t,e),t.prototype.error=function(t){if(!this.isStopped){var n=this.errors,r=this.retries,i=this.retriesSubscription;if(r)this.errors=void 0,this.retriesSubscription=void 0;else{n=new Oe;try{r=(0,this.notifier)(n)}catch(t){return e.prototype.error.call(this,t)}i=nn(r,new en(this))}this._unsubscribeAndRecycle(),this.errors=n,this.retries=r,this.retriesSubscription=scription=void 0),this.bscribe=e,this.source.subscribe(this)},t}(tn);var Eo=function(){function e(e){this.notifier=e}return e.prototype.call=function(e,t){var n=new Oo(e),r=t.subscribe(n);return r.add(nn(this.notifguments)||this;return t.hasValue=!1,t}return X(t,e),t.prototype._next=function(e){this.value=e,this.hasValue=!0},t.prototype.notifyNext=function(){this.emitValue()},t.prototype.notifyComplete=function(){this.emitValue()},t.prototype.emitValue=function(){this.hasValue&&(this.hasValue=!1,this.destination.next(this.value))},t}(tn);var So=function(){function e(e,t){this.period=e,this.scheduler=t}return e.prototype.call=function(e,t){return t.subscribe(new To(e.desiod;t.notifyNext(),this.schedule(e,n)}var Ao=function(){function e(e,t){this.compareTo=e,this.comparator=t}return e.prototype.call=function(e,t){return t.subscribe(new xo(e,this.compareTo,ation.add(n.subscribe(new Io(t,i))),i}return X(t,e),t.prototype._next=function(e){this._oneComplete&&0===this._b.length?this.emit(!1):(this._a.push(e),thisis._oneComplete=!0,this.estination.error(is.destination;t.n:(this._b.push(e),this=this._b.lent.ribe(),n=void 0,t=void 0)}))}}(r))}}var Co=function(){function e(e,t){this.predicate=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new Po(e,this.predici.source=r,i.seenValue=!1,i.index=0,i}retuthis.seenValue=!0,tryNext(e,t):this.ap)}catch(e){this.destination.error(e)}},t.prototype._complete=function(){var e=this.destination;this.index>0?(e.next(this.seenValue?this.singleValue:void 0),e.complete()):e.error(new St)},t}(le);function jo(e){return function(t){return t.lift(new Lo(e))}}var Lo=function(){function e(e){this.total=e}return e.prototype.call=function(e,t){return t.suis.total&&this.destinaount=e,this._skipCount<0)throw new Ot}return e.prototype.call=function(e,t){return 0===this._skipCount?t.subscribe(new le(e)):t.subscri];i[r]=e,this.destination.next(o)}},t}(le);var Vo=function(){function e(e){this.notifier=e}return e.prototype.call=function(e,t){return t.subscribe(new Fo(e,this.notifier))},e}(),Fo=function(e){function t(t,n){var r=e.call(this,t)||this;r.hasValue=!1;var i=new en(r);r.add(i),r.innerSubscription=i;var o=nn(n,i);return o!==i&&(r.add(o),r.innerSubscriptioValue&&e.prototype._nex&this.innerSubscription.unsubscribe()},t.prototype.notifyComplete=function(){},t}(tn);var Bo=function(){function e(e){this.predicate=e}return e.prototype.call=function(e,t){return t.subscratch(e,t,ndefunction(t){return t.lift(new Jo(e))}}var Jo=function(){function e(e){this.project=e}return e.prototype.call=function(e,t){return t.subsnctiurn e}),t):zo((function(){return e}))}function Ko(e){return functinValuototype.notifyComplete=function(){},t}(tn);var Zo=function(){function e(e,t){this.predicate=e,this.inclusive=t}return e.prototype.call=function(e,t){return t.subscribe(new es(e,thincltion(rbservretuft(new os(e,t,n.leading,n.trailing))}}var os=function(){function e(e,t,n,r){this.duration=e,this.scheduler=t,this.leading=n,this.trailing=r}return e.prototype.call=function(e,t){return t.subscribe(new ss(e,this.duration,this.schedulerhis.on as(e){e.subscriber.clearThrottle()}functiabs(e);return r.lift(new cs(o,i,t,n))}}var cs=function(){function e(e,t,n,r){this.waitFor=e,this.absoluteTimeout=t,this.withObservable=n,this.scheduler=r}return e.prototype.call=function(e,t){return t.subscribe(new ls(e,this.absoluteTimeout,this.waitFor,this.withObservablei,s.scheduler=o,s.scheduleTimeobeAndRecycle(),e.add(nn(t,net.dispatchTimeout,eout(),e.prototype._next.heduler=null,this.withObservable=null},t}(tn);function fs(e,t){returnunction(t){return t.lift(new hs(e))}}var hs=function(){function e(e){this.windowBoundaries=e}return e.prototype.call=function(e,t){var n=new vs(e),r=t.subscribe(n);return r.closed||n.add(nn(this.windowBoundaries,new en(n))),r},e}(),vs=function(e){function t(t){var n=e.call(this,t)||this;return n.window=new Oe,t.next(n.window),n}return X(t,e),t.prototype.notifyNext=function(){this.openWindow()},t.prototype.notifyError=function(e){this._error(e)},t.prototype.notifyComplete=function(){this._complete()},t.prototype._next=function(e){tow.error(e),this.destiomplete(),this.destination.complete()},t.prototype._unsubscribe=function(){this.window=null},t.prototype.openWindow=function(){var e=this.window;e&&e.complete();var t=this.destination,n=this.window=new Oe;t.next(n)},t}(tn);var bs=function(){function e(e,t){this.windowSize=e,this.startWindowEvery=t}return e.prototype.call=function(e,t){return t.subscribe(new ms(e,this.windowSize,this.startWindowEvery))},e}(),ms=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.destination=t,i.windowSize=n,i.startWindowEvery=r,i.windows=[new Oe],i.count=0,t.next(i.windows[0]),i}return X(t,e),t.prototype._next=function(e){for(var t=this.startWindowEvery>0?this.startWindowEvery:this.windowSize,n=this.destination,r=this.windowSize,i=this.windows,o=i.length,s=0;s<o&&!this.closed;s++)i[s].next(e);var a=this.count-r+1;if(a>=0&&a%t==0&&!this.closed&&i.shift().complete(),++this.count%t==0&&!this.closed){var u=new Oe;i.().error(e);this.destiomplete();this.destinatiotion(){this.cohis.mes},enumerable:!0,cn};s.add(o.schedule(ws,n,l))}re.maxWindowSize&&thi().error(e);this.destiomplete()}this.destinatws.push(e),this.destinatthis.wive(r.subscription),t.closeWindow(n)}var Ss=function(){function e(e,t){this.openings=e,this.closingSelector=t}return e.prototype.call=function(e,t){return t.subscribe(new Ts(e,this.openings,this.closingSelector))},e}(),Ts=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.openings=n,i.closingSelector=r,i.contexts=[],i.add(i.openSubscription=Wt(i,nength,r=0;r<n;r++)tibe()}e.prototype._errbe()}e.prototype._completcribe(),r.subscription.unsubscribe()}},t.prototype.notifyNext=function(e,t,n,r,i){if(e===this.openings){var o=void 0;try{o=(0,this.closingSelector)(t)}catch(e){return this.error(e)}var s=new Oe,a=new ae,u={window:s,subscription:a};this.contexts.push(u);var c=Wt(this,o,u);c.closed?this.closeWindow(this.contexts.length-1):(c.context=u,a.add(c)),this.destination.next(s)}else this.closeWindow(this.contexts.indexOf(e))},t.prototype.notifyError=function(e){thidow(this.contexts.indexOce(e,1),r.compbe(new As(e,this.,r.closingSelector=n,r.openWindow(),unction(e,t,n,r,i){this.openWindow(i)},t.prototype.notifyError=function(e){thismplete=function(e){this.openWindow(e)},t.prototype._next=function(e){tthis.unsubscribeClosinthis.unsubscribeClosingNotification()},t.prototype.unsubscribeClosingNotification=function(){this.closingNotification&&this.closingNotification.unsubscribe()},t.prototype.openWindow=function(e){void 0===e&&(e=null),e&&(this.remove(e),e.unsubscribe());var t=this.window;t&&t.complete();var n,r=this.window=new Oe;this.destination.next(r);try{n=(0,this.closingSelector)()}catch(e){return this.destination.error(e),void this.window.error(e)}this.add(this.c);var (e,th.error(e)}this.destination.next(t)},t}(Pt);function Ms(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(t){return t.lift.call(Nn.apply(void 0,[t].concat(e)))}}var Rs=Object.freeze({__proto__:null,audit:wr,auditTime:Sr,buffer:function(e){return function(t){return t.lift(new Tr(e))}},bufferCount:Ar,bufferTime:function(e){var t=arguments.length,n=bt;ze(arguments[arguments.length-1])&&(n=arguments[arguments.length-1],t--);var r=null;t>=2&&(r=arguments[1]);var i=Number.POSITIVE_INFINITY;return t>=3&&(i=arguments[2]),function(t){return t.lift(new Mr(e,r,i,n))}},bufferToggle:function(e,t){return function(n){return n.lift(new qr(e,t))}},bufferWhen:function(e){return function(t){return t.lift(new Dr(e))}},catchError:Fr,combineAll:function(e){return function(t){return t.lift(new zt(e))}},combineLatest:Wr,concat:function(){for(var e=[],t=0;t<argumen.call(ln.apply(void 0,[t].concat(e)))}}){return Gr((function(){return e}),t)},count:function(e){return function(t){return t.lift(new zr(e,t))}},debounce:function(e){return function(t){return t.lift(new Yr(e))}},debounceTime:Kr,defaultIfEmpty:ei,delay:function(e,t){void 0===t&&(t=bt);var n=vr(e)?+e-t.now():Math.abs(e);return function(e){function(t){return t.lift(new si(e))}},dematerialize:function(){return function(e){return e.lift(new li)}},distinct:pi,distinctUntilChanged:vi,distinctUn,r){return t?t(n[e],r[e]):n[e]===r[e]}))},elementAt:function(e,t){if(e<0)throw ni(t):gi((function(){return new Ot})))}},endWith:function(){for(var e=[],t=0;t<argumenon(t){rtion(n){return n.lift(new Ti(e,t,n))}},exhaust:function(){return function(e){return e.lift(new Ai)nction(t,i){return n(e,t,r,i)})))})))}:function(e){return e.lift(new Ii(t))}},expand:function(e,t,n){return void 0===t&&(t=Number.POSITIVE_INFINITY),t=(t||0)<1?Number.POSITIVE_INFINITY:t,function(r){return r.lift(new Mn(n){return n.lift(new Li(e,n,!on(n){r(t):gi((function(){return new St})))}},groupBy:Me,ignoreElements:function(){return function(e){return e.lift(new Ui)}},isEmpty:function(){return function(e){return e.lift(new Vi)}},last:Gi,map:kt,mapTo:zi,materialize:function(){return function(e){return e.lift(new Qi)}},max:func)>0?t:n}:function(e,t){return e>t?e:t})},merge:$i,mergeAll:un,mergeMaption(r){return r.lift(new eo(e,t,n))}},min:func)<0?t:n}:function(e,t){return e<t?e:t})},multicast:no,observeOn:function(e,t){return void 0===t&&(t=0),function(n){return n.lift(new tt(e,t))}},onErrorResumeNext:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 1===e.length&&ie(e[0])&&(e=e[0]),function(rn function(e){return e.lift(ne(n){return[wn(e,t)(n),wn(_n(e,t))(n)]}},pluck:uo,publishn function(t){return no(new qe(turn function(e){return no(new st)(e)}},publishReplay:fo,race:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(t){return 1===e.length&&ie(e[0])&&(e=e[0]),t.lift.call(Sn.apply(void 0,[t].concat(e)))}},reduce:Xi,repeat:po,repeatWhen:function(e){return functinction(t){return t.lift(new go(e,t))}},retryWhen:function(e){return function(t){return t.lift(new _o(e,t))}},refCount:Te,sample:function(e){return function(t){return t.lift(new Eo(e))}},sampleTime:function(e,t){return void 0===t&&(t=bt),function(n){return n.lifnction(n){return n.lift(new Ao(nction(t){return t.lift(new Co(e,t))}},skip:jo,skipLast:function(e){return function(t){return t.lift(new Uo(e))}},skipUntil:function(e){return function(tfunction(t){return t.liftnction(n){return n.lift(new Go(e,t))}},switchAll:function(){return zo(ve)},switchMap:zo,switchMapTo:Qo,takenction(n){return n.lift(new Zo(e,t))}},tap:ts,throttle:ft(new fr(e,!!t.leading,!!t.trailing))}},throttleTime:is,throwIfEmpty:gi,timeInterval:function(e){return void 0===e&&(e=bt),function(t){return{value:n,current:e.now(),last:r}}),{current:e.last,r=e.value;return new cr(r,t-n)})))}))}},timeout:fs,timeoutWith:us,timestamp:fun(function(t},toArray:function(){return Xi(ps,[])},window:ds,windowCount:function(e,t){return void 0===t&&(t=0),function(n){return n.lift(new bs(e,t))}},windowTime:function(e){var t=bt,n=null,r=Number.POSITIVE_INFINITY;return ze(arguments[3])&&(t=arguments[3]),ze(arguments[2])?t=arguments[2]:vn(arguments[2])&&(r=Number(arguments[2])),ze(arguments[1])?t=arguments[1]:vn(aion(i){return i.lift(new gs(e,n,r,t))}},windowToggle:function(e,t){return function(n){return n.lift(new Ss(e,t))}},windowWhen:function(e){return function(t){return t.lift(new ks(e))}},withLatestFrom:xs,zip:Ms,zipAll:function(e){return function(t){return t.lift(new Mn(e))}}}),Cs=A(Rs),Ps=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.buffer=function(e){return Cs.buffer(e)(this)}})),js=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.buffer=Ps.buffer})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.bufferCount=function(e,t){return void 0===t&&(t=null),Cs.bufferCount(e,t)(this)}}))),Ls=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.bufferCount=js.bufferCount})),A(mr)),qs=k((function(e,t){Object.defineProperty(tents[2]),Cs.bufferTime(e,r,i,n)(this)}})),Us=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.bufferTime=qs.bufferTime})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.bufferToggle=function(e,t){return Cs.bufferToggle(e,t)(this)}}))),Ds=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.bufferToggle=Us.bufferToggle})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.bufferWhen=function(e){return Cs.bufferWhen(e)(this)}}))),Vs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.bufferWhen=Ds.bufferWhen})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t._catch=function(e){return Cs.catchError(e)(this)}}))),Fs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.catch=Vs._catch,gr.Observable.prototype._catch=Vs._catch})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.combineAll=function(e){return Cs.combineAll(e)(this)}}))),Bs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.combineAll=Fs.combineAll})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.combineLatest=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=null;return"function"==typeof e[e.length-1]&&(n=e.pop()),1===e.length&&Ls.isArray(e[0])&&(e=e[0].slice()),this.lift.call(gr.of.apply(void 0,[this].concat(e)),new Ls.CombineLatestOperator(n))}}))),Hs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.combineLatest=Bs.combineLatest})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.concat=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.lift.call(gr.concat.apply(void 0,[this].concat(e)))}}))),Ws=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.concat=Hs.concat})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.concatAll=function(){return Cs.concatAll()(this)}}))),Gs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.concatAll=Ws.concatAll})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.concatMap=function(e){return Cs.concatMap(e)(this)}}))),zs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.concatMap=Gs.concatMap})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.concatMapTo=function(e){return Cs.concatMapTo(e)(this)}}))),Js=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.concatMapTo=zs.concatMapTo})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.count=function(e){return Cs.count(e)(this)}}))),Ys=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.count=Js.count})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.dematerialize=function(){return Cs.dematerialize()(this)}}))),Qs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.dematerialize=Ys.dematerialize})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.debounce=function(e){return Cs.debounce(e)(this)}}))),Ks=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.debounce=Qs.debounce})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.debounceTime=function(e,t){return void 0===t&&(t=gr.asyncScheduler),Cs.debounceTime(e,t)(this)}}))),Xs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.debounceTime=Ks.debounceTime})),k((function(e,t){Object.defineProperty(t,"__&&(e=null),Cs.defaultIfEmpty(e)(this)}}))),$s=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.defaultIfEmpty=Xs.defaultIfEmpty})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.delay=function(e,t){return void 0===t&&(t=gr.asyncScheduler),Cs.delay(e,t)(this)}}))),Zs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.delay=$s.delay})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.delayWhen=function(e,t){return Cs.delayWhen(e,t)(this)}}))),ea=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.delayWhen=Zs.delayWhen})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.distinct=function(e,t){return Cs.distinct(e,t)(this)}}))),ta=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.distinct=ea.distinct})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.distinctUntilChanged=function(e,t){return Cs.distinctUntilChanged(e,t)(this)}}))),na=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.distinctUntilChanged=ta.distinctUntilChanged})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.distinctUntilKeyChanged=function(e,t){return Cs.distinctUntilKeyChanged(e,t)(this)}}))),ra=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.distinctUntilKeyChanged=na.distinctUntilKeyChanged})),k((function(e,t){Object.defineProion(e,t,n){return Cs.tap(e,t,n)(this)}}))),ia=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.do=ra._do,gr.Observable.prototype._do=ra._do})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.exhaust=function(){return Cs.exhaust()(this)}}))),oa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.exhaust=ia.exhaust})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.exhaustMap=function(e){return Cs.exhaustMap(e)(this)}}))),sa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.exhaustMap=oa.exhaustMap})),k((function(e,t){Object.defineProperIVE_INFINITY:t,Cs.expand(e,t,n)(this)}}))),aa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.expand=sa.expand})),k((function(e,t){Object.defineProperty(ementAt.apply(void 0,arguments)(this)}}))),ua=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.elementAt=aa.elementAt})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.filter=function(e,t){return Cs.filter(e,t)(this)}}))),ca=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.filter=ua.filter})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t._finally=function(e){return Cs.finalize(e)(this)}}))),la=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.finally=ca._finally,gr.Observable.prototype._finally=ca._finally})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.find=function(e,t){return Cs.find(e,t)(this)}}))),fa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.find=la.find})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.findIndex=function(e,t){return Cs.findIndex(e,t)(this)}}))),pa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.findIndex=fa.findIndex})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.first=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Cs.first.apply(void 0,e)(this)}}))),da=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.first=pa.first})),k((function(e,t){Object.definePropertn,r){return Cs.groupBy(e,t,n,r)(this)}}))),ha=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.groupBy=da.groupBy})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ignoreElements=function(){return Cs.ignoreElements()(this)}}))),va=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.ignoreElements=ha.ignoreElements})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.isEmpty=function(){return Cs.isEmpty()(this)}}))),ba=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.isEmpty=va.isEmpty})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.audit=function(e){return Cs.audit(e)(this)}}))),ma=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.audit=ba.audit})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.auditTime=function(e,t){return void 0===t&&(t=gr.asyncScheduler),Cs.auditTime(e,t)(this)}}))),ga=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.auditTime=ma.auditTime})),k((function(e,t){Object.defineProp;return Cs.last.apply(void 0,e)(this)}}))),ya=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.last=ga.last})),k((function(e,t){Object.definePropertyt.letProto=function(e){return e(this)}}))),_a=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.let=ya.letProto,gr.Observable.prototype.letBind=ya.letProto})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.every=function(e,t){return Cs.every(e,t)(this)}}))),wa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.every=_a.every})),k((function(e,t){Object.defineProunction(e,t){return Cs.map(e,t)(this)}}))),Ea=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.map=wa.map})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.mapTo=function(e){return Cs.mapTo(e)(this)}}))),Oa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.mapTo=Ea.mapTo})),k((function(e,t){Object.defineProperty(t,ction(){return Cs.materialize()(this)}}))),Sa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.materialize=Oa.materialize})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.max=function(e){return Cs.max(e)(this)}}))),Ta=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.max=Sa.max})),k((function(e,t){Object.definePropemerge.apply(void 0,[this].concat(e)))}}))),ka=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.merge=Ta.merge})),k((function(e,t){Object.definePropertySITIVE_INFINITY),Cs.mergeAll(e)(this)}}))),Aa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.mergeAll=ka.mergeAll})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.mergeMap=function(e,t){return void 0===t&&(t=Number.POSITIVE_INFINITY),Cs.mergeMap(e,t)(this)}}))),xa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.mergeMap=Aa.mergeMap,gr.Observable.prototype.flatMap=Aa.mergeMap})),k((function(e,t){Object.defineProperty(tVE_INFINITY),Cs.mergeMapTo(e,t)(this)}}))),Ia=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.flatMapTo=xa.mergeMapTo,gr.Observable.prototype.mergeMapTo=xa.mergeMapTo})),k((function(e,t){Object.defineProperty(E_INFINITY),Cs.mergeScan(e,t,n)(this)}}))),Na=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.mergeScan=Ia.mergeScan})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.min=function(e){return Cs.min(e)(this)}}))),Ma=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.min=Na.min})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.multicast=function(e,t){return Cs.multicast(e,t)(this)}}))),Ra=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.multicast=Ma.multicast})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.observeOn=function(e,t){return void 0===t&&(t=0),Cs.observeOn(e,t)(this)}}))),Ca=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.observeOn=Ra.observeOn})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.onErrorResumeNext=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Cs.onErrorResumeNext.apply(void 0,e)(this)}}))),Pa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.onErrorResumeNext=Ca.onErrorResumeNext})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.pairwise=function(){return Cs.pairwise()(this)}}))),ja=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.pairwise=Pa.pairwise})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.partition=function(e,t){return Cs.partition(e,t)(this)}}))),La=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.partition=ja.partition})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.pluck=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Cs.pluck.apply(void 0,e)(this)}}))),qa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.pluck=La.pluck})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.publish=function(e){return Cs.publish(e)(this)}}))),Ua=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.publish=qa.publish})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.publishBehavior=function(e){return Cs.publishBehavior(e)(this)}}))),Da=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.publishBehavior=Ua.publishBehavior})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.publishReplay=function(e,t,n,r){return Cs.publishReplay(e,t,n,r)(this)}}))),Va=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.publishReplay=Da.publishReplay})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.publishLast=function(){return Cs.publishLast()(this)}}))),Fa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.publishLast=Va.publishLast})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.race=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Cs.race.apply(void 0,e)(this)}}))),Ba=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.race=Fa.race})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.reduce=function(e,t){return arguments.length>=2?Cs.reduce(e,t)(this):Cs.reduce(e)(this)}}))),Ha=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.reduce=Ba.reduce})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.repeat=function(e){return void 0===e&&(e=-1),Cs.repeat(e)(this)}}))),Wa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.repeat=Ha.repeat})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.repeatWhen=function(e){return Cs.repeatWhen(e)(this)}}))),Ga=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.repeatWhen=Wa.repeatWhen})),k((function(e,t){Object.definePrope void 0===e&&(e=-1),Cs.retry(e)(this)}}))),za=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.retry=Ga.retry})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.retryWhen=function(e){return Cs.retryWhen(e)(this)}}))),Ja=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.retryWhen=za.retryWhen})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.sample=function(e){return Cs.sample(e)(this)}}))),Ya=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.sample=Ja.sample})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.sampleTime=function(e,t){return void 0===t&&(t=gr.asyncScheduler),Cs.sampleTime(e,t)(this)}}))),Qa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.sampleTime=Ya.sampleTime})),k((function(e,t){Object.defineProp2?Cs.scan(e,t)(this):Cs.scan(e)(this)}}))),Ka=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.scan=Qa.scan})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.sequenceEqual=function(e,t){return Cs.sequenceEqual(e,t)(this)}}))),Xa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.sequenceEqual=Ka.sequenceEqual})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.share=function(){return Cs.share()(this)}}))),$a=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.share=Xa.share})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.shareReplay=function(e,t,n){return e&&"object"===o(e)?Cs.shareReplay(e)(this):Cs.shareReplay(e,t,n)(this)}}))),Za=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.shareReplay=$a.shareReplay})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.single=function(e){return Cs.single(e)(this)}}))),eu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.single=Za.single})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.skip=function(e){return Cs.skip(e)(this)}}))),tu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.skip=eu.skip})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.skipLast=function(e){return Cs.skipLast(e)(this)}}))),nu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.skipLast=tu.skipLast})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.skipUntil=function(e){return Cs.skipUntil(e)(this)}}))),ru=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.skipUntil=nu.skipUntil})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.skipWhile=function(e){return Cs.skipWhile(e)(this)}}))),iu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.skipWhile=ru.skipWhile})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.startWith=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Cs.startWith.apply(void 0,e)(this)}}))),ou=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.startWith=iu.startWith})),k((function(e,t){Object.defineProperty(t,===t&&(t=0),Cs.subscribeOn(e,t)(this)}}))),su=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.subscribeOn=ou.subscribeOn})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t._switch=function(){return Cs.switchAll()(this)}}))),au=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.switch=su._switch,gr.Observable.prototype._switch=su._switch})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.switchMap=function(e){return Cs.switchMap(e)(this)}}))),uu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.switchMap=au.switchMap})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.switchMapTo=function(e){return Cs.switchMapTo(e)(this)}}))),cu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.switchMapTo=uu.switchMapTo})),k((function(e,t){Object.definePrope=function(e){return Cs.take(e)(this)}}))),lu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.take=cu.take})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.takeLast=function(e){return Cs.takeLast(e)(this)}}))),fu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.takeLast=lu.takeLast})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.takeUntil=function(e){return Cs.takeUntil(e)(this)}}))),pu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.takeUntil=fu.takeUntil})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.takeWhile=function(e){return Cs.takeWhile(e)(this)}}))),du=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.takeWhile=pu.takeWhile})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.throttle=function(e,t){return void 0===t&&(t=Ls.defaultThrottleConfig),Cs.throttle(e,t)(this)}}))),hu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.throttle=du.throttle})),k((function(e,t){Object.defineProperty(t,"eConfig),Cs.throttleTime(e,t,n)(this)}}))),vu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.throttleTime=hu.throttleTime})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.timeInterval=function(e){return void 0===e&&(e=gr.asyncScheduler),Cs.timeInterval(e)(this)}}))),bu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.timeInterval=vu.timeInterval})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.timeout=function(e,t){return void 0===t&&(t=gr.asyncScheduler),Cs.timeout(e,t)(this)}}))),mu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.timeout=bu.timeout})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.timeoutWith=function(e,t,n){return void 0===n&&(n=gr.asyncScheduler),Cs.timeoutWith(e,t,n)(this)}}))),gu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.timeoutWith=mu.timeoutWith})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.timestamp=function(e){return void 0===e&&(e=gr.asyncScheduler),Cs.timestamp(e)(this)}}))),yu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.timestamp=gu.timestamp})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.toArray=function(){return Cs.toArray()(this)}}))),_u=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.toArray=yu.toArray})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.window=function(e){return Cs.window(e)(this)}}))),wu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.window=_u.window})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.windowCount=function(e,t){return void 0===t&&(t=0),Cs.windowCount(e,t)(this)}}))),Eu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.windowCount=wu.windowCount})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.windowTime=function(e){var t=gr.asyncScheduler,n=null,r=Number.POSITIVE_INFINITY;return Ls.isScheduler(arguments[3])&&(t=arguments[3]),Ls.isScheduler(arguments[2])?t=arguments[2]:Ls.isNumeric(arguments[2])&&(r=Number(arguments[2])),Ls.isScheduler(arguments[1])?t=arguments[1]:Ls.isNumeric(arguments[1])&&(n=Number(arguments[1])),Cs.windowTime(e,n,r,t)(this)}}))),Ou=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.windowTime=Eu.windowTime})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.windowToggle=function(e,t){return Cs.windowToggle(e,t)(this)}}))),Su=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.windowToggle=Ou.windowToggle})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.windowWhen=function(e){return Cs.windowWhen(e)(this)}}))),Tu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.windowWhen=Su.windowWhen})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.withLatestFrom=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Cs.withLatestFrom.apply(void 0,e)(this)}}))),ku=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.withLatestFrom=Tu.withLatestFrom})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.zipProto=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.lift.call(gr.zip.apply(void 0,[this].concat(e)))}}))),Au=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.zip=ku.zipProto})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.zipAll=function(e){return Cs.zipAll(e)(this)}}))),xu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.ObibedFrame=e,this.unsubscribedFrame=t}}()),Iu=function(e){function t(t,n){var r=e.call(this,(function(e){var t=this,n=t.logSubscribedFrame(),r=new ae;return r.add(new ae((function(){t.logUnsubscribedFrame(n)}))),t.scheduleMessages(e),r}))||this;return r.messages=t,r.subscriptions=[],r.scheduler=n,r}retu),r.frame,{message:r,s=t,r.subscriptions=[],r.scheduler=n,r}return X(t,e),t.prototype._subscribe=function(t){var n=this,r=n.logSubscribedFrame(),i=new ae;return i.add(new ae((function(){n.logUnsubscribedFrame(r)}))),i.add(e.prototype._subscrnotification.observe(e)}),t.frame)}()},t}(Oe),Mu=function(e){function t(t){var n=e.call(this,wt,750)||this;return n.assertDeepEqual=t,n.hotObservables=[],n.coldObservables=[],n.flushTests=[],n.runMode=!1,rker "|"');return n*t.frameTimeFactor},t.prototype.createColdObservable=function(e,n,r){if(-1!==e.indexOf("^"))throw new Error('cold observable cannot have subscription offset "^"');if(-1!==e.indexOf("!"))throw new Error('cold observable cannot have unsubscription marker "!"');var i=t.parseMarbles(e,n,r,void 0,this.runMode),o=new Iu(i,this);return this.coldObservables.push(o),o},t.prototype.createHotObservable=function(e,n,r){if(-1!==e.indexOf("!"))throw new Error('hot observable cannot have unsubscription marker "!"');var i=t.parseMarbles(e,n,r,void 0,this.runMode),o=new Nu(i,this);return this.hotObservables.push(o),o},t.prototype.materializeInnerObservable=function(e,t){var n=this,r=[];return e.subscribe((function(e){r.push({frame:n.framme-t,notification:et.createComplete()})})),r},t.prototype.expectObservable=function(e,n){var r=this;void 0===n&&(n=null);var i,o=[],s={actual:o,ready:!1},a=t.parseMarblesAsSubscriptions(n,this.runMode),u=a.subscribedFrame===Number.POSITIVE_INFINITY?0:a.subscribedFrame,c=a.unsubscribedFrame;this.schedule((function(){i=e.subscribe((function(e){var t=e;e instanceof ge&&(t=r.materializeInnerObservable(t,r.frame)),o.push({frame:r.frrame,notification:et.createComplete()})}))}),u),c!==Number.POSITIVE_INFINITY&&this.schedule((function(){return i.unsubscribe()}),c),this.flushTests.push(s);var l=this.runMode;return{toBe:function(e,n,r){s.ready=!0,s.expected=t.parseMarbles(e,n,r,!0,l)}}},t.prototype.expectSubscriptions=function(e){var n={actual:e,ready:!1};this.flushTests.push(n);var r=this.runMode;return{toBe:function(e){var i="string"==typeof e?[e]:e;n.ready=!0,n.expected=i.map((function(e){return t.parseMarblesAsSubscriptions(e,r)}))}}},t.prototype.flush=function(){for(var t=this,n=this.hotObservables;n.length>0;)n.shift().setup();e.prototype.flush.call(this),this.flushTests=this.flushTests.filter((function(e){return!e.ready||(t.assertDeepEqual(e.actual,e.expected),!1)}))},t.parseMarblesAsSubscriptions=function(e,t){var n=this;if(void 0===t&&(t=!1),"string"!=typeof e)return new xu(Number.POSITIVE_INFINITY);for(var r,i=e.length,o=-1,s=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY,u=0,c=function(i){var c=u,f=function(e){c+=e*n.frameTimeFactor},p=e[i];switch(p){case" ":t||f(1);break;case"-":f(1);break;case"(":o=u,f(1);break;case")":o=-1,f(1);break;case"^":if(s!==Number.POSITIVE_INFINITY)throw new Error("found a second subscription point '^' in a subscription marble diagram. There can only be one.");s=o>-1?o:u,f(1);break;case"!":if(a!==Number.POSITIVE_INFINITY)throw new Error("found a second subscription point '^' in a subscription marble diagram. There can only be one.");a=o>-1?o:u;break;default:if(t&&p.match(/^[0-9]$/)&&(0===i||" "===e[i-1])){var d=e.slice(i).match(/^([0-9]+(?:\.[0-9]+)?)(ms|s|m) /);if(d){i+=d[0].length-1;var h=parseFloat(d[1]),v=void 0;switch(d[2]){case"ms":v=h;break;case"s":v=1e3*h;break;case"m":v=1e3*h*60}f(v/l.frameTimeFactor);break}}throw new Error("there can only be '^' and '!' markers in a subscription marble diagram. Found instead '"+p+"'.")}u=c,r=i},l=this,f=0;f<i;f++)c(f),f=r;return a<0?new xu(s):new xu(s,a)},t.parseMarbles=function(e,t,n,r,i){var s=this;if(void 0===r&&(r=!1),void 0===i&&(i=!1),-1!==e.indexOf("!"))throw new Error('conventional marble diagrams cannot have the unsubscription marker "!"');for(var a,u=e.length,c=[],l=i?e.replace(/^[ ]+/,"").indexOf("^"):e.indexOf("^"),f=-1===l?0:l*-this.frameTimeFactor,p&t[e]instanceof Iu?t[e].messa,o=function(e){r+=e*s.frameTimeFactor},u=void 0,l=e[t];switch(l){case" ":i||o(1);break;case"-":o(1);break;case"(":d=f,o(1);break;case")":d=-1,o(1);break;case"|":u=et.createComplete(),o(1);break;case"^":o(1);break;case"#":u=et.createError(n||"error"),o(1);break;default:if(i&&l.match(/^[0-9]$/)&&(0===t||" "===e[t-1])){var h=e.slice(t).match(/^([0-9]+(?:\.[0-9]+)?)(ms|s|m) /);if(h){t+=h[0].length-1;var b=parseFloat(h[1]),m=void 0;switch(h[2]){case"ms":m=b;break;case"s":m=1e3*b;break;case"m":m=1e3*b*60}o(m/v.frameTimeFactor);break}}u=et.createNext(p(l)),o(1)}u&&c.push({frame:d>-1?d:f,notification:u}),f=r,a=t},v=this,b=0;b<u;b++)h(b),b=a;return c},t.prototype.run=function(e){var n=t.frameTimeFactor,r=this.maxFrames;t.frameTimeFactor=1,this.maxFrames=Number.POSITIVE_INFINITY,this.runMode=!0,Fe.delegate=this;var i={cold:this.createColdObservable.bind(this),hot:this.createHotObservable.bind(this),flush:this.flush.bind(this),expectObservable:this.expectObservable.bind(this),expectSubscriptions:this.expectSubscriptions.bind(this)};try{var o=e(i);return this.flush(),o}finally{t.frameTimeFactor=n,this.maxFrames=r,this.runMode=!1,Fe.delegate=void 0}},t}(_t),Ru=A(Object.freeze({__proto__:null,TestScheduler:Mu})),Cu=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Observable=gr.Observable,t.Subject=gr.Subject,t.AnonymousSubject=Ls.AnonymousSubject;var n=Ls;t.config=n.config;var r=gr;t.Subscription=r.Subscription,t.ReplaySubject=r.ReplaySubject,t.BehaviorSubject=r.BehaviorSubject,t.Notification=r.Notification,t.EmptyError=r.EmptyError,t.ArgumentOutOfRangeError=r.ArgumentOutOfRangeError,t.ObjectUnsubscribedError=r.ObjectUnsubscribedError,t.UnsubscriptionError=r.UnsubscriptionError,t.pipe=r.pipe,t.TestScheduler=Ru.TestScheduler;var i=gr;t.Subscriber=i.Subscriber,t.AsyncSubject=i.AsyncSubject,t.ConnectableObservable=i.ConnectableObservable,t.TimeoutError=i.TimeoutError,t.VirtualTimeScheduler=i.VirtualTimeScheduler,t.AjaxResponse=yr.AjaxResponse,t.AjaxError=yr.AjaxError,t.AjaxTimeoutError=yr.AjaxTimeoutError;var o=gr,s=Ls,a=Ls;t.TimeInterval=a.TimeInterval,t.Timestamp=a.Timestamp,t.operators=Cs;var u={asap:o.asapScheduler,queue:o.queueScheduler,animationFrame:o.animationFrameScheduler,async:o.asyncScheduler};t.Scheduler=u;var c={rxSubscriber:s.rxSubscriber,observable:s.observable,iterator:s.iterator};t.Symbol=c})),Pu=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(Cu)})),ju=T(Pu),Lu=sm.visitorId,qu=function(){return Lu},Uu=new ju.Subject(1),Du=function(){return Uu.asObservable().startWith(qu()).distinctUntilChanged()},Vu=function(e){Lu=e,Uu.next(e),sm.visitorId=e},Fu=function(){return sm.siteId},Bu=new ju.BehaviorSubject(sm.authenticatedExternally||!1),Hu=function(){return Bu.value},Wu=function(e){Bu.next(Boolean(e))},Gu=function(e){return["accessToken","accesstoken","access_token","id_token","idToken","idtoken","external_access_token","externalAccessToken","externalaccesstoken","consolidation_token","consolidationtoken","consolidationToken"].reduce((function(e,t){return null==e?void 0:e.replaceAll(new RegExp("".concat(t,"[%=][a-zA-Z0-9-_.]+"),"g"),"".concat(t,"=-pruned-"))}),e)},zu=new function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.publishInterval,n=void 0===t?3e3:t,r=e.maximumBatchSize,i=void 0===r?50:r,o=e.maximumBufferSize,s=void 0===o?1e3:o,a=e.maximumConsecutiveRetries,u=void 0===a?10:a,c=e.transports,l=void 0===c?[]:c,f=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.position;void 0===n&&(n=l.length),l.splice(n,0,e)},p={},d={},h=function e(t){var n=t.transports,r=t.payload;return 0===n.length?Promise.reject():n[0].process({payload:r}).catch((function(){return e({payload:r,transports:n.slice(1)})}))},v=function(e){return 0===Object.keys(e).length||W(e).every((function(e){return 0===e.length}))},b=function(){vch((function(t){e[t]=p[t].splice(0,i)})),v(e)?Promise.resolve():h({transports:l,payload:e}).then((fund).forEach((function(e){return d[e]=0})),Promise.resolve()})).catch((function(){return Object.keys(e).forEach((function(t){d[t]++,d[t]<u?p[t]=e[t].concat(p[t]):d[t]=0})),Promise.reject()}))},m=!1,g=null,y=!1,_=function(){if(m)throw new Error("Publisher is already started");m=!0,g=setInterval((function(){y||(y=!0,b().then((function(){return y=!1}),(function(){return y=!1})))}),n),)},w=function(){m=!1,clearInterval(g)},E=function(e,t){p[e]||(d[e]||(d[e]=0),p[e]=[]),p[e].push(t),p[e].splice(s)};return{start:_,stop:w,addToBucket:E,flush:b,buckets:p,addTransport:f,transports:l}}({publishInterval:sm.conf.log_publish_interval_ms||3e3});zu.start(),zu.addTransport(new G.HttpTransport({url:sm.conf.client_logger_url,method:"POST",encode:function(e){var t=e.logs,n=e.stats;return JSON.stringify({logs:t||[],stats:n||[]})}}));sm.logger=new function e(t){for(var n=arguments,r=t.publisher,i=t.tags,o=void 0===tion(){return(new Date).toISOString()}:s,u=t.maxObjectDepth,c=void 0===u?3:u,l=t.maxArrayLength,f=void 0===l?10:l,p=t.windowConsole,d=void 0===p?window.console:p,h=t.localStorage,v=void 0===h?window.localStorage:h,b=t.liveLogsKey,m=void 0===b?"sm.live_logs":b,g=t.liveLogsEnabled,y=void 0!==g&&g,_=t.whitelist,w=void 0===_?[]:_,E={},O=0;O<w.length;O++)E[w[O]]=!0;var S=new D,T=function(e){return r.addToBucket("logs",e)},k=function(){return d&&(y||"1"===v[m])},A=function(e,t){if(c===t)return["-pruned-"];for(var n=[],r=0;r<e.length;r++){if(r===f){var i=e[r-1];Array.isArray(i)?n.push(["-pruned-"]):i&&"object"===U(i)?n.push({pruned:!0}):n.push("-pruned-");break}n.push(N(e[r],t+1))}return n},x=function(e,t){if(c===t)return"-pruned-";var n={};return B(e,(function(r){var i=e[r];0===w.length||E[r]?n[r]=N(i,t+1):Array.isArray(i)?n[r]=["-redacted-"]:i&&"object"===U(i)?n[r]={turn{message:e.message,stack:e.stack}},N=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return-1!==H.indexOf(U(e))?e:"function"==typeof e?"<Function>":null===e?null:e instanceof Error?I(e):Array.isArray(e)?A(e,t):x(e,t)},M=function(e){return function(){if(k()){var t=d[e]||d.log;t.apply(t,arguments)}var n=Arraments).mapfilter((function(e){return void 0!==e})),r=F(o);r=V(r,{level:e,attributes:n,timestamp:a()}),"error"===e?r=V(r,{breadcrumbs:S.list}):S.add(r)function(e){return e instanceof Error}))[0]};this.debug=M("debug"),this.log=M("info"),this.info=M("info"),this.warn=M("warn"),this.error=function(){var e=Array.prototype.slice.call(arguments),t=R(e);if(!t||!t._acked)return"string"!=typeof e[0]||t||(e[0]=new Error(e[0])),M("error").apply(null,e)},this.withTags=function(t){return new e(V(n[0leLiveLogs=function(){return v[m]="1"}}({publisher:zu,tags:{actor:"visitor",site_id:sm.siteId,visitor_id:function(){return qu()},tab_id:function(){return sm.tabId},use(){return Gu(String(window.location))},client_version:function(e){e||(e="visitor/bootstrapper-683dc24fd.js");var t=e.split("-")[1];if(t)return t.slice(0,-3)}()},whitelist:["$where","@timestamp","Operator","URL","__sm__mutation_summary_node_map_id__","accept","accountAction","account_actions","accurate_difference","accurate_recording_time","accurate_start_time","acknowledge_timeout","action","action_attributes","action_types","activeTicket","activity_at","actor","address","allow_rejection","app","application","applied_background_type","arg","asset_url","assignment","assumed_visitor_id","attachment","attempt","attributes","audio","audio_direction","audio_permissions_required","audio_type","authenticated","authentication_provider_id","available","blank_attributes","body","browser","browser_event_conditions","browser_events","browser_name","browser_tab_id","browser_type","business","cached_queues_length","caller","calls","canReceive","canSend","canShareScreen","candidate","candidate_info","capabilities","category","cause","channelUrl","channel_url","city","clear_previous","client_version","client_webrtc_mode","clock","code","component","component_name","conference","conferenceId","conference_id","configured_background_type","constraints","constructor","content","content-type","context","countClientButtons","country","createdAt","currentState","current_result","custom","custom_code_url","custom_command_id","custome","dealerId","debug_message","dependencies","description_info","details","device_type","difference","direction","dispatched_at","duration","early_recording","elementSelector","element_class_name","element_id","element_selector","element_tag_name","element_text","end_reason","ended_engagements","engagement","engagement id","engagementId","engagement_id","engagement_media","engagement_request_id","engagement_requests","engagements","enqueuedInCurrentTab","entrypoint","err","error","error_cause","error_count","error_details","error_message","event","eventName","event_id","event_name","event_type","events","fail_reason","feature","fields","filters","fn","formattedName","formatted_name","found_tab_id","foundation","four","frequency","generation","glia_team","headers","horizontal_offset","ice_connection_state","id","identifier","identity","idle_for","idle_timeout_seconds","iframe_src","in_browser","index_name","interval_seconds","isAsyncTransfer","isEngaged","isReestablishing","isTransfer","isTrusted","isVisitorAuthenticatedExternally","is_active_tab","joinState","joined_at","joins","kube_container","kube_host","kube_namespace","kube_pod","label","lastSelectedTimeframe","latitude","leavePresence","leaves","level","link_url","localAudioProvider","localAudioType","localVideoProvider","localVideoType","locale","localeKey","location","longitude","major_browser_version","max","max_occurrences","media","media_options","media_type","media_upgrade_request","medias","medra_version","message","message-1","message-2","message_id","metadata","metas","method","modified_url","muted_by_self","name","network-cost","newScreenSessionId","new_result","new_tab_id","new_transport","new_url","no_operators_online_text","observations","offer","offered_media_type","oldScreenSessionId","omniq","on_hold_by_host","on_hold_by_self","one","oneWay","oneWayMedias","one_way","online","operator","operator name","operatorFormattedName","operatorId","operatorMedia","operatorName","operatorPicture","operator_id","operator_name","operator_team_id","options","origin","original_url","os_type","outcome","overseerID","overseerName","page_description","page_url","params","participant_id","pause_async","payload","phx_ref","phx_ref_prev","picture","picture_url","platform","port","preferred_operator","prefix","priority","proactive_reactive","protocol","provider","pruned","pubsub_data","q2_user_id","queueID","queueState","queue_id","queue_ids","queue_state","queue_states","queue_status","queue_ticket_id","queue_tickets","queued","queues","readyState","reason","recording_time","redacted","ref","rejoin_count","relatedAddress","relatedPort","relayProtocol","remoteAudioProvider","remoteVideoProvider","remoteVideoType","request","requested_queue_ids","requests","resolved_conditions","resource","response","responseText","responseURL","response_body","restarted_from_engagement_id","route","routing","rule_id","rule_name","rx_version","screenId","screenSessionId","sdp","sdpMLineIndex","sdpMid","selector","self","send_to_server","sender","server_webrtc_mode","session_id","set_active_tab","site","site id","siteId","site_id","site_ids","sm_url","source","source_attributes","source_id","source_type","stack","start_time","startingMedia","starting_media","state","status","statusText","status_text","stream","subEngagementId","sub_engagement","sub_engagement_id","sub_engagement_legacy_id","sub_engagement_uuid","tabId","tab_id","tagFunction","tagId","tag_function","tag_id","tag_name","target","tcpType","teamNames","team_ids","teams","text","three","timeframe","timeout","timestamp","toJSON","to_save_key","to_save_value","topic","topics","transferrable_sites","transport","twilio_error_code","twilio_error_description","two","type","typing","typing_indicator","ufrag","undelivered_messages","updated_webcomponents","upgrade_request","url","url_length","user_agent","usernameFragment","vertical_offset","video","video_direction","video_permissions_required","video_type","visibility_state","visitor","visitor id","visitorId","visitorLeftReason","visitor_code","visitor_id","visitor_metadata","visitor_priority","warningName","webrtc_mode","webrtc_modes_different","welcome_message","window_name","x-salemove-tab-id"]});var Ju,Yu=sm.logger,Qu=new Q(new function e(t){var n=t.publisher,r=t.globalTags,i=void 0===r?[]:r,o=function(e){return n.addToBucket("stats",e)},s=function(e,t,n,r){return r||(r=[]),{stat:e,params:[t,n,i.concat(r)]}};this.increment=function(e,t,n){isNaN(parseInt(t))&&(n=t,t=1),o(s("increment",e,t,n))},this.decrement=function(e,t,n){isNaN(parseInt(t))&&(n=t,t=1),o(s("decrement",e,t,n))},this.gauge=function(e,t,n){o(s("gauge",e,t,n))},this.histogram=function(e,t,n){o(s("histogram",e,t,n))},this.timing=function(e,t,n){o(s("timing",e,t,n))},this.set=function(e,t,n){o(s("set",e,t,n))},this.withTags=function(t){return new e({publisher:n,globalTags:i.concat(t)})}}({publisher:zu,globalTags:["application:visitor","visitor_page_adaption:".concat(sm.conf.engagement.visitor_page_adaption),"site_id:".concat(sm.siteId)]}),(Ju={},{record:function(e){Ju[e]=Number(new Date)},currentLatencyFrom:function(e){var t=Ju[e];return t?Number(new Date)-t:-1}})),Ku="sm.app.visitor_api.dynamic_import",Xu="default"===sm.conf.communications.lib,$u=function(e){return-1!==sm.conf.assets.server.indexOf("libs.")?"".concat(sm.conf.assets.server,"/").concat(e):[sm.conf.assets.server,sm.conf.assets.prepend||"/",e].join("")},Zu={Medra:{url:Xu?"https://libs.salemove.com/medra-5.6.4.min.js":sm.conf.communications.lib,returning:function(){return sm.Medra},integrity:Xu?j({name:"medra"}):null,gliaTeam:"media"},Comms:{url:$u("visitor_app/comms/app-683dc24fd.js"),integrity:j({name:"comms"}),gliaTeam:"media"},Cobra:{url:"".concat(sm.conf.cobra.lib.visitor,".js"),returning:function(){return sm.Cobra},integrity:j({name:"visitor_cobra"}),gliaTeam:"engage"},webcomponents:{url:$u("visitor/webcomponents-683dc24fd.js"),integrity:j({name:"webcomponents"}),gliaTeam:"engage"},webcomponents_es5:{url:$u("visitor/webcomponents_es5-683dc24fd.js"),integrity:j({name:"webcomponents_es5"}),gliaTeam:"engage"},legacy_webcomponents:{url:$u("visitor/legacy_webcomponents-683dc24fd.js"),integrity:j({name:"legacy_webcomponents"}),gliaTeam:"engage"}},ec={},tc=function(e){var t,n=Zu,r=L,i=Qu,o=ec;"string"==typeof e?t=e:(t=e.target,e.loader&&(r=e.loader),e.possibleTargets&&(n=e.possibleTargets),e.stats&&(i=e.stats),e.loaded&&(o=e.loaded));var s=n[t];if(!s)return ju.Observable.throw("Invalid target");if(o[t]){if(s.returning){var a=s.returning();return void 0===a?ju.Observable.throw(new Error("An error occurred while loading ".concat(t,", as it is undefined"))):ju.Observable.of(a)}return ju.Observable.of(null)}return ju.Observable.create((function(e){r({fileUrl:s.url,integrity:s.integrity,onAttempt:function(){i.increment(Ku,["action:attempted","module:".concat(t),"glia_team:".concat(s.gliaTeam)])},onLoad:function(){if(o[t]=!0,s.returning){var n=s.returning();void 0===n?(i.increment(Ku,["action:failed","module:".concat(t),"glia_team:".concat(s.gliaTeam)]),e.error(new Error("An error occurred while loading ".concat(t,", as it is undefined")))):(i.increment(Ku,["action:succeeded","module:".concat(t),"glia_team:".concat(s.gliaTeam)]),e.next(n),e.complete())}else i.increment(Ku,["action:succeeded","module:".concat(t),"glia_team:".concat(s.gliaTeam)]),e.next(),e.complete()},onError:function(){i.increment(Ku,["action:warning","module:".concat(t),"glia_team:".concat(s.gliaTeam)])},onGiveUp:function(){i.increment(Ku,["action:failed","module:".concat(t),"glia_team:".concat(s.gliaTeam)]);var n=new Error("Loading ".concat(t," failed"));Yu.warn(n,{target:t}),n._acked=!0,e.error(n)},retryLimit:3,backoffDelay:500})}))},nc={MSG:{PROACTIVE_REQUEST:"proactive_call:request",PROACTIVE_ACCEPT:"proactive_call:accept",PROACTIVE_DECLINE:"proactive_call:decline",REACTIVE_ENGAGEMENT_REQUEST_TIMEOUT:"reactive_engagement_request_timeout",ENGAGEMENT_PREPARE:"engagement:prepare",ENGAGEMENT_CLEANUP:"engagement:cleanup",DISCONNECT:"connection_lost",RECONNECTED:"connection_restored",MEDIA_SELECTED:"media_selected",ENGAGEMENT_TRANSFERRED:"engagement:transferred",ENGAGEMENT_END_POPUP_CLOSED:"engagement:end:popup:closed",PUBLIC:{ENGAGEMENT_START:"sm:engagement:start",ENGAGEMENT_END:"sm:engagement:end",ENGAGEMENT_GET_AUDIO_TYPE:"sm:engagement:get_audio_type",ENGAGEMENT_GET_UPGRADE_MEDIA_TYPE:"sm:engagement:get_upgrade_media_type",ENGAGEMENT_MEDIA_UPGRADE_REQUEST:"sm:engagement:media_upgrade_request",ENGAGEMENT_SELECT_MEDIA_TYPE:"sm:engagement:select_media_type",ENGAGEMENT_ERROR:"sm:engagement:error"},WILL_ASK_MEDIA_PERMISSION:"engagement:media_permission:will_ask",SHOW_PERMISSION_ARROW:"communication:show_permission_arrow",HIDE_PERMISSION_ARROW:"communication:hide_permission_arrow",ALLOW_STREAM:"engagement:media_permission:allow",DENY_STREAM:"engagement:media_permission:_deny",IS_ENGAGED:"engagement:is_engaged",PHONE_STATUSES:{CONNECTED:"connected",CONNECTING:"connecting"},ENGAGEMENT_REMOVE_AUDIO:"engagement:remove_audiot){rc.next({eventName:e,eventBody:t})},observable:function(e){return rc.filter((function(t){return t.eventName===e})).map((function(e){return e.eventBody}))}};var ic={};nc.request=function(e,t){var n=ic[e];if(n)return n(t)},nc.reqres={setHandler:function(e,t){ic[e]=t},removeHandler:function(e){delete ic[e]}};var oc=[],sc=null,ac=function(){(sc=document.createElement("SPAN")).id="cobrowsing-mouse-container",document.body.appendChild(sc);var e=new MutationObserver((function(){var e,t,n=document.body.childNodes[document.body.childNodes.length-1];n!==sc&&-1===oc.indexOf(n)&&(e=document.body,(t=e.childNodes[e.childNodes.le.push(t),setTimeout((function(){oc=[]}),1e4),e.appendChild(sc)))}));return e.observe(document.body,{childList:!0}),{unsubscribe:function(){e.disconnect()}}},uc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Observable=gr.Observable})),cc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(uc)})),lc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.combineLatest=gr.combineLatest})),fc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(lc)})),pc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.from=gr.from})),dc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(pc)})),hc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Subject=gr.Subject})),vc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(hc)})),bc=function(){function e(t){var n=t.duration;s(this,e),this.duratd_reactive",{duration:ext=r,this.duration=i,this.priority=o}return u(e,[{key:"perform",value:function(){nc.vent.trigger("trigger_reactive_callout",{text:this.text,noOperatorsOnlineText:this.noOperatorsOnlineText,duration:this.duration,priority:this.priority})}}]),e}(),gc=function(){function e(t){var n=t.text;s(this,e),this.text=n}return u(e,[{key:"perform",value:function(){nc.vent.trigger("trigger_media_selection",{text:this.text,source:"callout"})}}]),e}(),yc=function(){function e(){s(this,e)}return u(e,[{key:"perform",value:function(){nc.vent.trigger("reactive_bar:enable")}}]),e}(),_c=function(){function e(){s(this,e)}return u(e,[{key:"perform",value:function(){nc.vent.trigger("reactive_bar:disable")}}]),e}(),wc=function(){function e(t){var n=t.vertical_offset,r=t.horizontal_offset;s(this,e),this.verticalOffset=n,this.horizontalOffset=r}return u(e,[{key:"perform",value:function(){nc.vent.trigger("reactive_bar:set_position",{verticalOffset:this.verticalOffset,horizontalOffset:this.horizontalOffset})}}]),e}(),Ec=function(e){var t=e.category,n=e.action,r=e.label;Yu.info("Tracking Google Analytics Event",{category:t,action:n,label:r}),"function"==typeof window.gtag?window.gtag("event",n,{event_category:t,event_label:r}):window._gaq&&window._gaq.push?window._gaq.push(["_trackEvent",t,n,r]):"function"==typeof window.ga&&window.ga("send","event",t,n,r)},Oc=function(){function e(t){s(this,e),this.options=t}return u(e,[{key:"perform",value:function(){switch(this.options.provider){case"google":this.trackGoogle(this.options);break;case"omniture":this.trackOmniture(this.options);break;default:Yu.error("Unknown analytics provider",this.options.provider)}}},{key:"trackGoogle",value:function(e){var t=e.category,n=e.action,r=e.fields;Ec({category:t,action:n,label:r?JSON.stringify(r):void 0})}},{key:"trackOmniture",value:function(e){!function(e){var t=e.tagFunction,n=e.tagId,r=e.params;try{var i=Object.keys(r||{}).reduce((function(e,t){return t.match(/url/i)&&"string"==typeof r[t]?e[t]=Gu(r[t]):e[t]=r[t],e}),{});Yu.info("Tracking Omniture Analytics Event",{tagFunction:t,tagId:n,params:i}),"function"==typeof window[t]&&window[t](n,I.clone(r))}catch(e){Yu.warn("Client error occurred during Omniture event tracking",e)}}({tagFunction:e.tag_function,tagId:e.tag_id,params:e.fields})}}]),e}(),Sc=function(e,t){var n=t.operator;return n&&-1!==n.teamNames.indexOf(e)},Tc=function(){function e(t){var n=t.operator_team;s(this,e),this.operatorTeam=n}return u(e,[{key:"perform",value:function(e){e.cobraObservable.filter(I.partial(Sc,this.operatorTeam)).pluck("cobraSourceInitializer").subscribe((function(e){retus(this,e),this.text=n,this.duratxt:this.text,duration:this.duration})}}]),e}(),Ac=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.empty=gr.empty})),xc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(Ac)})),Ic=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.of=gr.of})),Nc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(Ic)})),Mc=I.compose(I.isEmpty,I.symmetricDifference);(sm.BusinessRules={}).ACTION_TYPES={SHOW_OPERATORS_IN_SELECTOR_V2:"show_operators_in_selector_v2"};var Rc=function(e){var t=e.event,n=e.site_id,r=e.tab_id;return"business_rules"===t&key:"perform",va e(t){s(this,e),this.expectedAction=t}return u(e,[{key:"perform",value:function(){throw new Error("No handler found for action ".concat(this.expectedAction))}}]),e}(),jc={expand_operator_selector:bc,reactive_callout:mc,media_selection:gc,show_reactive_tab_only_when:yc,hide_reactive_tab:_c,set_reactive_tab_position:wc,show_operators_in_selector_v2:Cc,send_analytics_event:Oc,hide_page_from_operators:Tc,show_engagement_invitation:kc},Lc=new vc.Subject,qc=Lc.pipe(fo());qc.connect();var Uc=function(){function e(t){var n=t.volatileNotifications,r=t.cobraObservable,i=t.routingObservable;s(this,e),this._performAction=this._performAction.bind(this),this.cobraObservable=r,this.routingObservable=i,this.actionsObservable=qc.pipe($i(n.pipe(wn(Rc),kt(I.prop("payload"))))),this._routingUpdateTimeout=sm.conf.overseer.routing_update_timeout_in_millirvable.subscribe(this._performAction)}},{key:"_performAction",value:function(e){var t=e.type,n=e.rule_id,r=e.browser_event_conditions,i=this.cobraObservable,o=function(e,t){var n=jc[e];return n?new n(t):new Pc(e)}(t,e);(function(e){var t=e.expectedQueueIds,n=e.routingObservable,r=e.routingUpdateTimeout,i=e.loggerMetadata,o=void 0===i?{}:i,s=e.logger,a=void 0===s?Yu:s;return t?n.pipe(wn((function(e){var n=e.queue_ids;return!(!n||!t)&&Mc(n,t)})),Ei(1),fs(r),Fr((function(e){return"TimeoutError"===e.name?a.warn("In-browser business rule action not triggered, expected queue ids not received",I.merge(o,{queue_ids:t})):a.error("In-browser business rule action triggering error",e),xc.empty()}))):Nc.of(null)})({expectedQueueIds:I.prop("queue_ids",r),routingUpdateTimeout:this._routingUpdateTimeout,routingObservable:this.routingObservable,loggerMetadata:{type:t,rule_id:n}}).subscribe((function(){var t,n;t=e,n={rule_id:I.prop("rule_id",t)},Yu.log("In-browser business rule action triggered",n),o.perform(i)}),(function(e){return Yu.error("Error from should trigger in-browser action subscription",e)}))}}],[{key:"triggerAction",value:function(e){Lc.next(e)}},{key:"actionTriggers",value:function(e,t){return qc.pipe($i(e.pipe(wn(Rc),kt(I.prop("payload")))),wn((function(e){return e.type===t})))}}]),e}();sm.BusinessRules.Controller=Uc;var Dc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.merge=gr.merge})),Vc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasgName,element_class_name:e.className}},Bc=function(e){return!function(e){return 0===e.offsetWidth&&0===e.offsetHeight||e.style&&"none"===e.style.display}(e)},Hc=function(e){for(var t=e.parentElement,n=[];null!==t;)n.push(t),t=t.parentElement;return n},Wc=function(e){retches||e.msMatchesSelector).call(e,t)},zc=1,Jc=10;function Yc(e){if(!e)return null;for(var t=[];e&&e.nodeType===zc;e=e.parentNode){for(var n=0,r=e.previousSibling;r;r=r.previousSibling)r.nodeType!==Jc&&r.nodeName===e.nodeName&&++n;var i=(e.prefix?e.prefix+":":"")+e.localName,o="["+(n+1)+"]";t.splice(0,0,i+o)}return t.length?"/"+t.join("/"):null}var Qc=new RegExp(/\/([^/[]+)\[(\d+)\]/g),Kc=new RegExp(/:nth-of-type\(1\)/g);function Xc(e,t){if("/"===t)return e;if(t){var n=t.replace(Qc,"$1:nth-of-type($2) > ").slice(0,-2).replace(Kc,"");return e.querySelector(n)}return null}var $c=function(e,t){return ju.Observable.fromEventPattern((function(n){return e.addEventListener(t,n)}),(function(n){return e.removeEventListener(t,n)}))},Zc=function(e,t){return ju.Observable.fromEventPattern((function(n){return e.on(t,n)}),(function(n){return e.off(t,n)}))},el=function(e){return ju.Observable.create((function(t){var n=e.subscribe(t);return function(){return n.unsubscribe()}}))},tl=function(e){return ju.Observable.create((function(t){var n=e.subscribe(t.next.bind(t),t.error.bind(t),t.complete.bind(t));returnn(e){return ju.Observable.throw(e)}))},rl=fuunction(t){e.connect(),e.subscribe(t)}))},il=function(e,t){var n=t.maxRetries,r=t.calculateDelay,i=t.shouldRetry,o=void 0===i?I.always(!0):i,s=t.scheduler,a=void 0===s?ju.Scheduler.asap:s;return e.retryWhen((function(e){return function(e,t){return e.scan((function(e,n){return c({count:e.count+1},t,n)}),{count:0})}(e,"error").flatMap((function(e){var t=e.count,i=e.error;return o(i)&&t<=n?ju.Observable.timer(r(t),a):ju.Observable.throw(i)}))}))},ol=function(e){var t=e.target,n=e.selector;return"function"==typeof t.msMatchesSelector?t.msMatchesSelector(n):"function"==typeof t.matches&&t.matches(n)},sl=function(e){var t=e.pattern;return-1!function(e){return e&&e.nodeType===zc},ul=function(e){var t=e.selector;return t&&-1!==t.indexOf(":contains")},cl=function(e){var t=e.selector,n=t.replace(/'/g,'"').match(/(.*):contains\("([^"]+)"/);if(I.isNil(n))throw new Error("Failed to match :contains selector - ".concat(t));var r=n[1].trim(),i=n[2].trim();if(I.isEmpty(r))throw new Error("The :contains selector has no tag to match");return{cssSelector:r,containsText:i}},ll=function(e){return ul({selector:e})?function(e){var t=e.selector,n=cl({selector:t}),r=n.cssSelector,i=n.containsText,o=Wc(document.querySelectorAll(r));return I.filter((function(e){return sl({pattern:i,element:e})}),o)}({selector:e}):Wc(document.querySelectorAll(e))},fl=function(e,t){return Vc.merge.apply(void 0,w(I.map((function(t){return $c(t,e)}),t)))},pl=function(e){var t=e.elementSelector,n=e.eventName;return fl(n,ll(t))},dl=function(e){var t=e.target,n=e.selector;if(!al(t))return!1;if(ul({selector:n})){var r=cl({selector:n}),i=r.cssSelector,o=r.containsText;return ol({target:t,selector:i})&&sl({pattern:o,element:t})}return!I.isEmpty(n)&&ol({target:t,selector:n})},hl=function(){function e(t){var n=t.id,r=t.form_selector,i=t.input_selector,o=t.value;s(this,e),this.filteredValueOrFocusout=this.filteredValueOrFocusout.bind(this),this._valueMatching=this._valueMatching.bind(this),this._formatEvent=this._formatEvent.bind(this),this.id=n,this.formSelector=r,this.inputSelector=i,this.value=o}return u(e,[{key:"track",value:function(){return Vc.merge(this._trackTextFields(),this._trackChangeableFields(),this._trackCheckableFields()).pipe(kt(this._formatEvent))}},{key:"_trackTextFields",value:function(){var e;try{e=fl("keyup",this._getObservableFields("input[type=text], input:not([type]), textarea"))}catch(t){this._recordInvalidSelector(t),e=xc.empty()}return e.pipe(wn(this._valueChangingKey),kt(this._extractValueFromInput),vi(I.equals),wn(this._valueMatching),zo(this.filteredValueOrFocusout))}},{key:"_trackChangeableFields",value:function(){var e;try{e=fl("change",this._getObservableFields("select"))}catch(t){this._recordInvalidSelector(t),e=xc.empty()}return e.pipe(kt(this._extractValueFromOption),vi(I.equals),wn(this._valueMatching))}},{key:"_trackCheckableFields",value:function(){var e;try{e=fl("change",this._getObservableFields("input[type=radio], input[type=checkbox]"))}catch(t){this._recordInvalidSelector(t),e=xc.empty()}return e.pipe(kt(this._extractValueFromInput),wn(this._valueMatching))}},{key:"_getObservableFields",value:function(e){if(this.inputSelector)return Wc(document.querySen(t){return dl({target:t,selector:e})}));if(this.formSelector){var t=Wc(document.querySelectorAll("form"+thisn(t){return Wc(t.querySelectorAll(e))}),t))}return Wc(document.body.querySelectorAll(e))}},{key:"filteredValueOrFocusout",value:function(e){return this.value?Nc.of(e):$c(e.target,"focusout").pipe(zalue:function(e){return e.keyCode>=45}},{key:"_valueMatching",value:function(e){var t=e.target.value;return!this.value||t.match(new RegExp(this.value))target:e.target,value:e.target.value}}},{key:"_extractValueFromOption",value:function(e){var t=I.find((function(e){return e.selected}),Wc(e.target.querySelectorAll("option")));return{target:e.target,value:t&&t.value}}},{key:"_formatEvent",value:function(e){var t=e.target,n=e.value;return{id:this.id,type:"form_filling",source_attributes:I.merge(Fc(t),{value:n})}}},{key:"_recordInvalidSelector",value:function(e){Qu.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:form_filling","reason:invalid_selector"]),Yu.warn("Failed to track form filling. Invalid selector",{error:e,form_selector:this.formSelector,input_selector:this.inputSelector,source_id:this.id})}}]),e}(),vl="clicking",bl=function(){function e(t){var n=t.id,r=t.element_selector,i=t.element_tag,o=t.number,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Yu,u=arguments.length>2&&void 0!==arguments[2]?arguments[2]:500;s(this,e),this._isTargetElementsOrItsChild=this._isTargetElementsOrItsChild.bind(this),this._formatEvent=this._formatEvent.bind(this),this.id=n,this.elementSelector=r,this.elementTag=i,this.number=o,this.logger=a,this.throttleTime=u}return u(e,[{key:"track",value:function(){var e,t,n=this,r=(e=document,t="click",ju.Observable.fromEventPattern((function(n{return e.removeEventListener(t,n,!0)}))).pipe(wn((function(e){return n._isTargetElementsOrItsChild(e.target)}))),i=this.number||1;return function(e,t){var n=e.events,r=e.throttleTime,i=e.numberToTrigger;return n.pipe(is(r,t),jo(i-1))}({events:r,throttleTime:this.throttleTime,numberToTrigger:i}).map(this._formatEvent)}},{key:"_isTargetElementsOrItsChild",value:function(e){var t=this._getElementsSelector();t)t.push(e),e=e.parentElement;return t}(e)).length>0}catch(e){return Qu.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:".concat(vl),"reason:invalid_selector"]),this.logger.warn(e,"Failed to query DOM element",{elementSelector:t}),!nstraint()+this._selectorConsfunction(){return this.elementTag|or?"".concat(this.elementSelector):""}},{key:"_formatEvent",value:function(e){return{id:this.id,type:vl,source_attributes:Fc(e.target)}}}]),e}(),ml=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.timer=gr.timer})),gl=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(ml)}));var yl=function(){function e(t){var n=t.source_id;s(this,e),this.saveNavigationEvent=this.saveNavigationEvent.bind(this),this.clear=this.clear.bind(this),this._getHistory=this._getHistory.bind(this),this._formatHistory=this._formatHistory.bind(this),this.key="sm_navigations-"+n,this.storage=window.sessionStorage}returnItem(this.key,this._formatHistory(e))}},{key:"anyMatch",value:function(e){return I.any((function(t){return t.match(e)}))(thn(){this.storage.removeItem(this.key)}},{key:"_getHistory",value:function(){try{return JSON.parse(this.storage.getItem(this.key))||[]}catch(e){return sm.logger.error("Unexpected format for navigation history in sessionStorage",{error:e}),this.clear(),[]}}},{key:"_formatHistory",value:function(e){var t=I.takeLast(2,I.append(e,this._getHistory()));return JSON.stringify(t)}}]),e}();var _l=!1;try{var wl=Opassive",{get:function(){return _l=!0}});window.addEventListener("sm-passive-test",null,wl),window.removeEventListener("sm-passive-test",null,wl)}catch(e){}var El=function(e,t){return ju.Observable.fromEventPattern((function(n){return e.addEventListener(t,n,!!_l&&{passive:!0})}),(function(n){return e.removeEventListener(t,n)}))},Ol={getStream:function(e){var t,n=I.map((function(e){return El(document,e)}),e);return ju.Observable.merge((t=ju.Observable).merge.apply(t,w(n)),El(window,"focus"),El(window,"pageshow"))}};sm.PeriodicalActivityTracker=Ol;var Sl=function(){var e=_(void 0!==document.hidden?["hidden","visibilitychange"]:void 0!==document.mozHidden?["mozHidden","mozvisibilitychange"]:void 0!==document.msHidden?["msHidden","msvisibilitychange"]:["webkitHidden","webkitvisibilitychange"],2),t=e[0],n=e[1];if(void 0===document.addEventListener||void 0===t)return junction(){return{visible:!document[t]}};return El(document,n).map(r).startWith(r())},Tl=function(){var e=(window.crypto||window.msCrypto).getRandomValues(new Uint8Array(16));e[6]=15&e[6]|64,e[8]=191&e[8]|128;for(var t="",n=0;n<e.length;n++)e[n]<16&&(t+="0"),t+=e[n].toString(16),[3,5,7,9].indexOf(n)>-1&&(t+="-");return t},kl=function(e){return"object",payload:t};return n&&(r.options=n),r};function xl(e){var t=this,n=new Il({allowedSource:e});["on","offorEach((function(e){t[e]=n[e].bind(n)})),this.observable=function(e){return Zc(n,e)},this.emit=function(t,n,r){e.postMessage(Al(t,n,r),"*")},this.request=function(e,n,r){var i=e+":response",o=Tl();t.on(i,(function e(n,s,a,u){u&&u.requestId===o&&(t.off(i,e),r(n,s,a))})),t.emit(e,n,{requestId:o})}}function Il(e){var t=this,n=e.allowAnySource,r=e.allowedSource;if(n&&r)throw new Error("Pass allowedSource or allowAnySource, not both");if(!n&&!r)throw new Error("Pass allowedSource or allowAnySource");var i=function(e){if((n||e.source===r)&&kl(e.data)){var i=e.data,o=i.messageName,s=i.payload,a=i.options;return t.emitEvent(o{window.adListener("message",i),t.removeEvent()},this.respondTo=function(e,n){var r=function(t,r,i,o){n(t,(function(t){return r.postMessage(Al(e+":resp.on(e,r),function(){return t.off(e,r)}}}Il.prototype=Object.create(x.prototype);var Nl=null,Ml=function(){if(!Nl){var e=Ol.getStream(["scroll","keyup","mousemove","touchstart","orientationchange"]).share(),t=new Il({allowAnySource:!0});t.start();var n=Zc(t,"activity_from_cobrowsable_iframe"),r=Sl().filter(I.propEq("visible",!0));(Nl=ju.Observable.merge(e,n,r).publish()).connect()}return Nl};var Rl=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.interval=gr.interval})),Cl=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.haseFloat(e.replace(/[^\d\.]+/,"")):null},jl="number",Ll=function(){function e(t){var n=t.id,r=t.element_selector,i=t.minimum_value;s(this,e),this._elementValues=this._elementValues.bind(this),this._numberMatching=this._numberMatching.bind(this),this._formatEvent=this._formatEvent.bind(this),this.id=n,this.elementSelector=r,this.minimumValue=i}return u(e,[{key:"track",value:function(){return Cl.interval(100).pipe(an(this._elementValues),wn(this._numberMatching),kt(this._formatEvent),Ei(1))}},{key:"_elementValues",value:function(){var e;try{e=Wc(document.querySelectorAll(this.elementSelector))}catch(t){Qu.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:".concat(jl),"reason:invalid_selector"]),Yu.warn("Failed to track number. Invalid selector",{error:t,element_selector:this.elementSelector,source_id:this.id}),e=[]}return dc.from(I.flatten(e.map(this._elementValue)))}},{key:"_elementValue",value:function(e){return[{element:e,value:Pl(e.innerHTML)},{element:e,value:Pl(e.value)}]}},{key:"_numberMatching",value:function(e){var t=e.value;return"number"==typeof t&&t>=this.minimumValue}},{key:"_formatEvent",value:function(e){var t=e.element,n=e.value;return{id:this.id,type:jl,source_attributes:I.merge(Fc(t),{value:n})}}}]),e}();var ql={attributes:!0,characterData:!1,childList:!1,subtree:!1,attributeOldValue:!1,characterDataOldValue:!1};var Ul=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.fromPromise=gr.from})),Dl=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(Ul)}));var Vl={text:"chat",audio:"voice",phone:"phone",video:"video"};var Fl=function(){function e(){s(this,e)}return u(e,[{key:"track",value:function(){return xc.empty()}}]),e}(),Bl={form_filling:hl,clicking:bl,time_on_page:function(e){var t=e.id,n=e.seconds,r=function(){return{id:t,type:"time_on_page",source_attributes:{}}};this.track=function(){return gl.timer(1e3*n).pipe(kt(r))}},mouse_in:function(e){var t=e.id,n=e.element_selector,r=function(e){return{id:t,type:"mouse_in",source_attributes:Fc(e.target)}};this.track=function(){try{return pl({elementSelector:n,eventName:"mouseenter"}).pipe(kt(r))}catch(e){return Qu.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:mouse_in","reason:invalid_selector"]),Yu.warn("Failed to track mouse in. Invalid selector",{error:(null==e?void 0:e.message)||e,element_selector:n,source_id:t}),xc.empty()}}},mouse_out:function(e){var t=e.id,n=e.element_selector,r=function(e){return{id:t,type:"mouse_out",source_attributes:Fc(e.target)}};this.track=function(){try{return pl({elementSelector:n,eventName:"mouseleave"}).pipe(kt(r))}catch(e){return Qu.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:mouse_out","reason:invalid_selector"]),Yu.warn("Failed to track mouse out. Invalid selector",{error:e,element_selector:n,source_id:t}),xc.empty()}}},scrolling:function(e){var t=e.id,n=e.percentage,r=function(){return{id:t,type:"scrolling",source_attributes:{}}},i=function(){var e=window.pageYOffset,t=window.innerHeight;return e/(document.documentElement.scrollHeight-t)*100>n};this.track=function(){return $c(window,"scroll").pipe(wn(i),kt(r),Ei(1))}},navigation:function(e){var t=e.id,n=e.path,r=function(){return{id:t,type:"navigation",source_attributes:{}}};this.track=function(){var e=new RegExp(n,"i");return sm.hrefObservable.pipe(wn((function(t){return t.match(e)})),kt(r))}},activity:function(e){var t=e.id,n=function(){return{id:t,type:"activity",source_attributes:{}}};this.track=function(){return gl.timer(6e4).pipe(Zi(Ml()),Ei(1),po(),kt(n))}},number:Ll,element_created:function(e){var t=e.id,n=e.element_selector,r=e.on_page_load;this.track=function(e){var i=e.options;return n?i.initialLoad&&!r?xc.empty():Nc.of({id:t,type:"element_created",source_attributes:{}}):xc.empty()}},element_changed:function(e){var t=e.id,n=e.element_selector,r=function(e){return{id:t,type:"element_changed",source_attributes:Fc(e.target)}};this.track=function(e){var i=e.options,o=i.triggerObservable,s=i.mutationObserver;try{ll(n).forEach((function(e){s.observe(e,ql)}))}catch(e){Qu.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:element_changed","reason:invalid_selector"]),Yu.warn("Failed to observe element changes. Invalid selector",{error:e,element_selector:n,source_id:t})}return o.pipe(kt(r))}},transfer:function(e){var t=e.id,n=function(e){return{id:t,type:"transfer",source_attributes:{operator_id:e.operatorId,operator_name:e.operatorName,starting_media:e.startingMedia}}};this.track=function(){return nc.vent.observable(nc.MSG.ENGAGEMENT_TRANSFERRED).pipe(kt(n))}},proactive_accept:function(e){var t=e.id,n=function(e){var n=e.operator;return{id:t,type:"proactive_accept",source_attributes:{operator_id:n.id,operator_name:n.name}}};this.track=function(){return nc.vent.observable(nc.MSG.PROACTIVE_ACCEPT).pipe(pi(I.prop("engagement_request_id")),kt(n))}},proactive_decline:function(e){var t=e.id,n=function(e){var n=e.operator;return{id:t,type:"proactive_decline",source_attributes:{operator_id:n.id,operator_name:n.name}}};this.track=function(){return nc.vent.observable(nc.MSG.PROACTIVE_DECLINE).pipe(kt(n))}},engagement_start:function(e){var t=e.id,n=function(e){var n=e.operator,r=e.startingMedia,i=e.engagementId,o=e.type;return{id:t,type:"engagement_start",source_attributes:{operator_id:n.id,operator_name:n.name,proactive_or_reactive:o,engagement_media:Vl[r],engagement_id:i}}};this.track=function(){return Dl.fromPromiobservable(e.EVENTS.ENGAGEMENT_START)})),wn(I.complement(I.prop("isReestablishing"))),kt(n))}},reactive_engagement_request_timeout:function(e){var t=e.id,n=function(e){var n=e.operator;return{id:t,type:"reactive_engagement_request_timeout",source_attributes:{operator_id:n.id,operator_name:n.name}}};this.track=function(){return nc.vent.observable(nc.MSG.REACTIVE_ENGAGEMENT_REQUEST_TIMEOUT).pipe(kt(n))}},consecutive_navigation:function(e,t){var n=e.id,r=e.to,i=e.from,o=t||new yl({source_id:n}),s=function(){return o.anyMatch(new RegExp(i,"i"))},a=function(){return{id:n,type:"consecutive_navigation",source_attributes:{}}};this.track=function(){return sm.hrefObservable.pipe(wn((function(e){return e.match(new RegExp(i,"i"))}))).subscribe(o.saveNavigationEv(e){return e.match(new RegExp(r,"i"))}),s)),ts(o.clear),kt(a))}},enqueued:function(e){var t=e.id;this.track=function(e){var n=e.internalVisitorStateObservable,r=["enqueued","request_sent"],i=I.propEq("site_id",sm.siteId),o=I.compose(I.filter(i),I.pathOr([],["omniq","queue_tickets"])),s=I.compose(I.nth(0),I.filter((function(e){var t=I.lensPath(["visitor","browser_tab_id"]);return I.compose(I.equals(sm.tabId),I.view(t))(e)})),I.filter((function(e){return-1!==r.indexOf(e.state)})),o);return n.pipe(kt(s),wn(I.identity),vi(null,I.prop("id")),kt((function(e){return{id:t,type:"enqueued",source_attributes:{ticket_id:e.id}}})))}}},Hl={buildObservable:I.curry((function(e,t,n){var r=function(e){var t=e.sources,n=e.internalVisitorStateObservable,r=e.options;return 0===Object.keys(t).length?xc.empty():new(Bl[t.type]||Fl)(t).track({internalVisitorStateObservable:n,options:r})}({sources:t.sources,internalVisitorStateObservable:e,options:n});return t.url_matcher?r.pipe(xs(function(e){var t=new RegExp(e,"i");return sm.hrefObservable.pipe(kt((function(e){return e.match(t)})),vi(I.equals))}(t.url_matcher),(function(e,t){return{value:e,isMatching:t}})),wn(I.prop("isMatching")),kt(I.prop("value"))):r}))},Wl=function(){function e(){s(this,e)}return u(e,null,[{key:"observable",value:function(e,t){var n=this._selectorsToObserveOnElementCreated(e.sources);return n.length>0?this._trackCreatedElements(e,n,t):Nc.of({})}},{key:"_trackCreatedElements",value:function(e,t,n){var r=this._initiateSourceAon(e){return{target:e,initialLoad:!1}})),Wo({target:document.body,initialLoad:!0}),wn(this._filterBySourceType({source:e.sources,selectors:t,rawRule:e})),kt(I.pick(["initialLoad"])),kt(I.merge(r)))}},{key:"_filterBySourceType",value:function(e){var t=this,n=e.source,r=e.selectors,i=e.rawRule;return function(e){var o=e.target;return!(!e.initialLoad||"element_created"===n.type)||t._targetMatchesAny(o,r,i,n)}}},{key:"_initiateSourceAttributes",value:function(e){switch(e.type){case"element_changed":return this._getElementChangedAttributes(e);default:return{}}}},{key:"_getElementChangedAttributes",value:function(e){var t=new vc.Subject,n=new MutationObserver((function(n){return I.forEach((function(n){if(dl({target:n.target,selector:e.desired_selector}))return t.next(n)}),n)}));return{triggerObservable:t.asObservable(),mutationObserver:n}}},{key:"_selectorsToObserveOnElementCreated",value:function(e){switch(e.type){case"form_filling":return[e.form_selector,e.input_selector];case"mouse_in":case"mouse_out":case"element_changed":case"element_created":return[e.element_selector];default:return[]}}},{key:"_targetMatchesAny",value:function(e,t,n,r){return I.any((function(t){try{return dl({target:e,selector:t})||function(e){var t=e.target,n=e.selector;return!(!al(t)||!t.hasChildNodes())&&I.any((function e(t){var r=dl({target:t,selector:n});return!r&&t.hasChildNodes()?I.any(e,t.childNodes):r}),t.childNodes)}({target:e,selector:t})}catch(e){return Qu.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:".concat(r.type),"reason:invalid_selector"]),Yu.warn("Failed to track element. Invalid selector",{error:e&&e.message,selector:t,source_type:rArray(t(var i in n)r[i]=n[i];return r[e]=t,r},Kl=function(e){return function t(n){return 0===arguments.length?t:e.apply(this,arguments)}},Xl=Kl((function(e){return null===e||"object"!==Gl(e)?e:Array.isArray(e)?e.map((function(e){return Xl(e)})):Object.keys(e).reduce((function(t,n){return Ql(function(e){var t=e.split("_");return[t[0]].concat(zl(t.slice(1).map((function(e){return function(e){return"".concat(e.slice(0,1).toUpperCase()).concat(e.slice(1).toLowerCase())}(e)})))).join("")}(n),Xl(e[n]),t)}),{})})),$l=Kl((function(e){return null===e||"object"!==Gl(e)?e:Array.isArray(e)?e.map((function(e){return $l(e)})):Object.keys(e).reduce((function(t,n){return Ql(n.replace(/\W+/g," ").split(RegExp(" |\\B(?=[A-Z])")).map((function(e){return e.toLowerCase()})).join("_"),$l(e[n]),t)}),{})})),Zl=(Yl=function(e,t){return Object.keys(t).reduce((function(n,r){var i=e[r];if(Array.isArray(i)){var o=t[r];if(!o||"object"!==Gl(o))throw new Error("Nested value should be an object");return Ql(i[0]||r,Zl(i[1],o),n)}return Ql(i||r,t[r],n)}),{})},function e(t,n){return 0===arguments.length?e:1===arguments.length?Kl((function(e){return Yl(t,e)})):Yl(t,n)}),ef=u((function e(t){var n=t.status,r=t.medias;s(this,e),this.status=n,this.medias=r}));ef.prototype.STATUSES={OPEN:"open",CLOSED:"closed",FULned"===e?ef.prototype.STATUSES.OPEN:e},nf=u((function e(t){var n=t.id,r=t.name,i=t.status,o=t.medias;s(this,e),this.id=n,this.name=r,this.state=new ef({status:i,medias:o})})),rf={SALEMOVE:{ALREADY_QUEUED:"already queued",INVALID_INPUT:"invalid input",OPERATOR_UNAVAILABLE:"operator unavailable",INTERNAL_ERROR:"internal error",RESOURCE_NOT_FOUND:"not found",OPERATOR_DECLINED:"operator declined",DECLINE:"decline",CANCEL:"cancel",TIMEOUT:"timeout",NETWORK_TIMEOUT:"network timeout",CONNECTION_LOST:"connection lost",TOO_MANY_REQUESTS:"too many requests",FORBIDDEN:"forbidden",NOT_SUPPORTED:"not supported",DISABLED:"disabled",ALREADY_ENGAGED:"already engaged",CONFLICT:"conflict",FILE_CONTENT_TYPE_NOT_ALLOWED:"file content type not allowed",FILE_TOO_LARGE:"file too large",DENIED_BY_PERMISSIONS_POLICY:"denied by permissions policy",DEVICE_ACCESS_ERROR:"device access error",DENIED_BY_SYSTEM:"denied by system"}},of=5e3,sf=["text","phone","audio","video"],af=[502,503],uf=[400,413,422],cf="sm_change_element_attributes",lf="omnicore",ff="omnibrowse",pf={"content-type":"application/json",accept:"application/vnd.salemove.v1+json"},df=["af","al","dz","as","ad","ao","ai","ag","ar","am","aw","au","at","az","bs","bh","bd","bb","by","be","bz","bj","bm","bt","bo","ba","bw","br","io","vg","bn","bg","bf","bi","kh","cm","ca","cv","bq","ky","cf","td","cl","cn","cx","cc","co","km","cd","cg","ck","cr","ci","hr","cu","cw","cy","cz","dk","dj","dm","do","ec","eg","sv","gq","er","ee","et","fk","fo","fj","fi","fr","gf","pf","ga","gm","ge","de","gh","gi","gr","gl","gd","gp","gu","gt","gg","gn","gw","gy","ht","hn","hk","hu","is","in","id","ir","iq","ie","im","il","it","jm","jp","je","jo","kz","ke","ki","xk","kw","kg","la","lv","lb","ls","lr","ly","li","lt","lu","mo","mk","mg","mw","my","mv","ml","mt","mh","mq","mr","mu","yt","mx","fm","md","mc","mn","me","ms","ma","mz","mm","na","nr","np","nl","nc","nz","ni","ne","ng","nu","nf","kp","mp","no","om","pk","pw","ps","pa","pg","py","pe","ph","pl","pt","pr","qa","re","ro","ru","rw","bl","sh","kn","lc","mf","pm","vc","ws","sm","st","sa","sn","rs","sc","sl","sg","sx","sk","si","sb","so","za","kr","ss","es","lk","sd","sr","sj","sz","se","ch","sy","tw","tj","tz","th","tl","tg","tk","to","tt","tn","tr","tm","tc","tv","vi","ug","ua","ae","gb","us","uy","uz","vu","va","ve","vn","wf","eh","ye","zm","zw","ax"],hf=I.compose(I.chain(I.values),I.values)(rf),vf=u((function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(s(this,e),this.cause=n.cause,n.message&&(this.message=n.message),this.cause&&I.contains(this.cause,hf))||(this.cause=rf.SALEMOVE.INTERNAL_ERROR,(t=sm.logger).error.apply(t,["Incorrect Error usage"].concat(Array.prototype.slice.call(arguments))))})),bf=function(e){var t=String(e);if(0===t.indexOf("[object "))try{t=JSON.stringify(e)}catch(e){t=e instanceof TypeError?"Unable to parse param: ".concat(e.message):"Unexpected parse error ".concat(e)}return t},mf=function(e,t){t||(t={});var n,r=t.logger||Yu;return n=e.cause,I.contains(n,I.values(rf.SALEMOVE))?e:function(e,t){if(e||(e={}),t||(t=Yu),I.contains(e.status,af))return new vf({cause:rf.SALEMOVE.INTERNAL_ERROR});if(0===e.status||0===e.readyState)return new vf({cause:rf.SALEMOVE.NETWORK_TIMEOUT});var n="Uncaught error in 'public' observable. Wrapping as an internal error.";return e.details&&(n+=" Details: ".concat(bf(e.details),".")),e.error&&(n+=" Error: ".concat(bf(e.error),".")),e.debug_message&&(n+=" Debug message: ".concat(bf(e.debug_message),".")),e.message&&(n+=" Message: ".concat(bf(e.message))),t.error(n.substr(0,1e3),e),new vf({cause:rf.SALEMOVE.INTERNAL_ERROR})}(e,r)},gf=function(e){return e||(e={}),ju.Observable.throw(mf(e))},yf=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e instanceof vf)return ju.Observable.throw(e);var n=function(){return I.contains(e.status,uf)?new vf({cause:rf.SALEMOVE.INVALID_INPUT}):409===e.status?new vf({cause:rf.SALEMOVE.CONFLICT}):e.cause===rf.SALEMOVE.NETWORK_TIMEOUT?e:mf(e)},r=n();return t.allowedCauses&&r.cause!==rf.SALEMOVE.INTERNAL_ERROR&&!I.contains(r.cause,t.allowedCauses)?(Yu.error("Unhandled error treated as internal error",{status:e.status,message:e.message,debug_message:e.debugMessage}),ju.Observable.throw(new vf({cause:rf.SALEMOVE.INTERNAL_ERROR}))):ju.Observable.throw(r)},_f="queue:multi",wf={channelObservable:null,topicNotifications:{}},Ef=function(e){var t=e.queueId,n=e.name,r=e.state,i=e.medias;return new nf({id:t,name:n,status:tf(r),medias:i})},Of=function(e){var t=e.pubsub,n=e.cache;n||(n=wf);var r=n.channelObservable,i=n.topicNotifications||{};return function(e){var o=I.map(I.concat("queue:"),e);return ju.Observable.create((function(s){if(r){!function(e){var t=e.queueIds,n=e.observer;t.forEach((function(e){var t=i[e];if(t)return n.next(t)}))}({queueIds:e,observer:s}),r.flatMap((function(e){return e.watchNewTopics(o)})).toPromise().catch((function(e){return Yu.warn("Unable to update queue pubsub channel topics ",e)}))}eu.info("Joined ".concat(_f," topic"))})).publishReplay(1)).connect(),n.channelObservable=r;return r.flatMap((function(e){return e.observable("change")}))r n=t.queueId;})).map(Ef).do((function(e){i[e.id]=e})).subscribe(s)}))}},Sf=function(e){var t=e.queueIds;return(0,e.observeQueueStateUpdates)(t).pipe(sr((function(e,t){var n=I.findIndex(I.propEq("id",t.id))(e);return-1===n?I.append(t,e):I.equals(I.find(I.propEq("id",t.id))(e),t)?e:I.update(n,t,e)}),[]),vi((function(e,t){return e===t})))};var Tf=function(e){var t=e.queueIds;return(0,e.observeQueueStateUpdates)(t).pipe(Me(I.prop("id")),an((function(e){return e.distinctUntilChanged()})))},kf=function(e,t){if(!e)throw new vf({cause:rf.SALEMOVE.INVALID_INPUT,message:"Queue IDs list is undefined"});if(I.isEmpty(e))throw new vf({cause:rf.SALEMOVE.INVALID_INPUT,message:"Queue IDs list is empty"});if(!t)throw new vf({cause:rf.SALEMOVE.INVALID_INPUT,message:"Listener is undefined"})},Af=function(e){var t=e.enabled,n=e.createQueueStateObservable,r=e.createQueueStateAccumulateObservable,i=e.pubsub;r||(r=Sf),n||(n=Tf);var o=function(e){var n=e.queueIds,o=e.listener;if(t){var s=new ju.Subscription;kf(n,o);try{var a=r({queueIds:n,observeQueueStateUpdates:Of({pubsub:i})});s.add(a.subscribe(o,Yu.error.bind(Yu,"Failed to receive queue state list updates")))}catch(e){Yu.error("Failed subscribe to queue state list updates",e)}return s}};return{subscribe:function(e,r){if(t){var o=new ju.Subscription;kf(e,r);try{var s=n({queueIds:e,observeQueueStateUpdates:Of({pubsub:i})}).publish();o.add(s.subscribe(r,Yu.error.bind(Yu,"Failed to receive queue state updates"))),o.add(function(e,t){var n=new ju.Subscription;return n.add(t.bufferCount(e.length).take(1).subscribe((function(e){return Yu.info("Received initial queue states",{queue_states:I.map((function(e){return{id:e.id,status:e.state.status}}),e)})id:e.id,queue_status:e.state.status})}))),n}(e,s)),o.add(s.connect())}catch(e){Yu.error("Failed subscribe to queue state updates",e)}}},subscribeToList:o,subscribeToListAsObservable:function(e){var t=e.queueIds,n=e.subscribeToListFn;return n||(n=o),t?ju.Observable.create((function(e){return n({queueIds:t,listener:e.next.bind(e)})})):ju.Observable.empty()}}},xf=function(){function e(){s(this,e)}return u(e,[{key:"start",value:function(e,t){var n=t.routingObservable;return this.ruleTracker(t,e).pipe(an((function(r){var i,o=t.queuesAvailabilityObservable.pipe(Kr(100,i));return fc.combineLatest(t.currentStatusObservable,o).pipe(Ei(1),kt((function(t){var i=_(t,2),o=i[0],s=i[1];return{overseerApi:e,bufferedEvents:r,currentStatus:o,queuesState:s,routingObservable:n}})))}))).concatMap(this.actUponRules).subscribe(null,(function(e){Yu.error("Error from business rule subscription: ".concat(I.prop("message",e)||e),e)}))}},{key:"ruleTracker",value:function(t,n,r){var i=t.rules,o=t.domInsertObservable,s=t.buildRuleObservable,a=dc.from(i).pipe(an(Nf),an(function(e){var t=e.domInsertObservable,n=e.buildRuleObservable;return function(e){return Wl.observable(e,t).pipe(zo((function(t){return n(e,t)})),kt((function(t){return I.merge({attrs:t},e)})))}}({domInsertObservable:o,buildRuleObservable:s})),Ro(1)),u=cc.Observable.merge(a.pipe(Sr(e.BUFFER_TIME,r)),a.pipe(Gi(null,null)));return a.pipe(ds(u),rn((function(e){return e.toArray()}})),wn((function(e){return e.length>0})))}},{key:"actUponRules",value:function(e){var t=e.overseerApi,n=e.currentStatus,r=e.queuesState,i=e.bufferedEvents,o=e.controller,s=void 0===o?Uc:o,a=["visitor_status"];r&&a.push("queues_availability"),i=I.map((function(e){var t=I.map(I.prop("type"),e.conditions);return!I.isEmpty(I.difference(t,a))?I.merge(e,{actions:[],send_to_server:!0}):e}),i);var u=I.filter((function(e){return function(e){var t=e.event,n=e.currentStatus,r=e.queuesState,i=I.all((function(e){return function(e,t,n){return"visitor_status"===e.type?-1!==e.status.indexOf(t):"queues_availability"!==e.type||function(e,t){var n=_(I.partition(I.pathEq(["state","s=t.id;return I.contains(n,e.queueIds)};if("can_enqueue"===e.compareType)return I.any(o,r);if("cannot_enqueue"===e.compareType)return I.any(o,i)}(Zl({queue_ids:"queueIds",compare_type:"compareType"},e),n)}(e,n,r)}),t.conditions);i&&Yu.log("Business rule source matched: ",{send_to_server:t.send_to_server,rule_name:t.name,url:Gu(window.location.href),source_id:t.attrs.id,rule_id:t.id});return i}({event:e,currentStatserver?"serverEvents":"browserEvents"}))(u),l=c.serverEvents||[],f=c.browserEvents||[];u.forEach((function(e){var t=e.actions,n=e.attrs,r=e.id,i=e.name,o=e.browser_event_conditions;if(!I.isEmpty(t))return function(e,t,n,r,i,o){e.forEach((function(e){var s={rule_id:n,rule_name:r,browser_event_conditions:o},a=I.merge(s,function(e,t){t||(t={});if(e.fields){var n=function(e,t){var n={};return t.forEach((function(t){var r=t.key,i=t.value,o=t.custom_value,s="custom"===i?o:e[i];n[r]=s})),n}(I.merge({visitor_id:qu(),site_id:Fu(),url:window.location.href},t),e.fields);return I.merge(e,{fields:n})}return e}(e,t));i.triggerAction(a)}))}(t,n.source_attributes,r,i,s,o)}));var p=I.filter((function(e){var t=e.actions;return!I.isEmpty(t)}),f),d=I.map((function(e){var t=e.actions;return{ruleId:e.id,actionTypes:I.pluck("type",t)}}),p);return I.isEmpty(d)||function(e){var t=e.overseerApi,n=e.browserEvents;t.sendOverseerMetrics({browserEvents:n})}({overseerApi:t,browserEvents:d}),I.isEmpty(l)?cc.Observable.of(null):function(e,t,n){return e.sourcesTriggered({events:n,resolvedCon,n=e.id;return I.assoc("rule_id",n,t)}))(l)).pipe(Fr((function(e){return e instanceof window.Error?cc.Observable.throwError(e):cc.Observable.of(null)})))}}],[{key:"init",value:function(t,n){var r=n.currentStatusObservable,i=n.internalVisitorStateObservable,o=n.rules,s=n.queuesAvailabilityObservable,a=n.routingObservable,u=cc.Observable.create((function(e){var t=new MutationObserver((function(t){return I.stanceof HTMLElement)return e.next(t)}),t.addedNodes)}),t)}));return t.observe(document.body,{attributes:!1,characterData:!1,childList:!0,subtree:!0,attributeOldValue:!1,characterDataOldValue:!1}),function(){return t.disconnect()}})),c=Hl.buildObservable(i);return(new e).start(t,{currentStatusObservable:r,queuesAvailabilityObservable:s,rules:o,domInsertObservable:u,buildRuleObservable:c,routingObservable:a})}}]),e}();function If(e){return e.operator?If(e.left).concat(If(e.right)):[e]}function Nf(e){var t;t=Array.isArray(e.sources)?e.sources:If(e.sources);var n=I.map((function(t){return I.assoc("sources",t,e)}),t);return dc.from(n)}xf.BUFFER_TIME=100,xf.INIT_TIMESTAMP=(new Date).getTime();var Mf=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t._throw=gr.throwError})),Rf=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(Mf)})),Cf=[sm.conf.api_url,"libs.salemove.com","libs.glia.com","visitor.local.dev"],Pf=function(e){return I.any((function(t){return I.contains(t,e)}),Cf)},jf=function(e){if("string"!=typeof e&&(t=e,n=new RegExp("^(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$","i"),!Boolean(n.test(t))))return Yu.warn("Invalid URL provided",{rawUrl:e}),!1;var t,n;try{var r=new window.URL(e);return Pf(r.origin)}catch(t){try{var i=e.trim();return Boolean(i)&&i.length>2&&Pf(i)}catch(t){return Yu.warn("Error validating URL",{rawUrl:e,error:t}),!1}}},Lf=I.pick(["response","status","statusText","readyState","responseURL"]),qf=function(e){var t=e.method,n=e.url,r=e.payload,i=e.responseType,o=e.getRequestHeaders,s=e.onUploadProgress,a=e.onSuccess,u=e.onError,c=new XMLHttpRequest;if(c.open(t,n,!0),o){var l=o();r="application/json"===l["Content-Type"]&&"string"!=typeof r?JSON.e){var t=l[e];c.setRequestHeader(e,t)}))}return c.responseType=i,c.onreadystatechange=function(){if(4===c.readyState)if(c.status>=200&&c.status<300)if("json"===i&&"string"==typeof c.response)try{var e=I.assoc("response",c.response.length>0?JSON.parse(c.response):"",c);a(e)}catch(e){Yu.error("Could not parse response json in IE11",{error:e,server_response:c.response}),u(c)}else a(c);else u(c)},s&&c.upload.addEventListener("progress",(function(e){e.lengthComputable&&s({loaded:e.loaded,total:e.total})}),!1),jf(n)?c.send("GET"===t?void 0:r):(Yu.error("Trying to fetch from invalid URL",{rawUrl:n}),u(c)),function(){return c.abort()}},Uf=function(e){var t=e.method,n=e.url,r=e.payload,i=e.responseType,o=e.getRequestHeaders,s=e.onUploadProgress,a=e.sendRequest,u=e.contentType;return jf(n)?(t=t||"GET",i=i||"json",a=a||qf,o||(o=function(){return{Accept:"application/vnd.salemove.private+json",Authorization:"Bearer "+sm.accessToken}}),cc.Observable.create((function(e){return a({method:t,url:n,payload:r,responseType:i,getRequestHeaders:u?function(){return I.merge(o(),{"Content-Type":u})}:o,onUploadProgress:s,onSuccess:function(t){e.next(t),e.complete()},onError:function(t){return e.error(Lf(t))}})}))):(Yu.error("Trying to fetch from invalid URL",{rawUrl:n}),Rf._throw(new vf({cause:rf.SALEMOVE.INTERNAL_ERROR,message:"Request URL is invalid"})))},Df=function(e){var t=e.url,n=e.method,r=e.payload,i=e.responseType,o=e.contentType,s=e.getRequestHeaders,a=e.calculateAttemptDelay,u=e.retryLimit,c=void 0===u?5:u,l=e.onSuccess,f=e.onError,p=void 0===f?function(){}:f,d=e.onAttempt,h=void 0===d?function(){}:d,v=e.onAttemptError,b=void 0===v?function(){}:v,m=e.shouldRetry,g=void 0===m?function(){return!0}:m;C({calculateAttemptDelay:a,attempt:function(e){var a=e.repeat;h(),qf({method:n,url:t,payload:r,responseType:i,getRequestHeaders:o?function(){return I.merge(s(),{"Content-Type":o})}:s,onError:function(e){var t=g(e.status);b(t),(t?a:p)(e)},onSuccess:l})},onGiveUp:p,retryLimit:c})},Vf=function(e,t){var n=e.url,r=e.assetKey,i=e.onError,o=e.onSuccess,s=e.identifier,a={method:"GET",responseType:"json",onSuccess:function(e){t.increment("sm.assets.load",["action:succeeded","asset:".concat(r)]),o(e)},onAttempt:function(){t.increment("sm.assets.load",["action:attempted","asset:".concat(r)])},onAttemptError:function(e){Yu.warn("Failed fetching ".concat(r).concat(e?", retrying":""),{asset_url:n,identifier:s}),t.increment("sm.assets.load",["action:warning","asset:".concat(r)])},onError:function(){Yu.warn("Error fetching ".concat(r),{asset_url:n,identifier:s}),t.increment("sm.assets.load",["action:failed","asset:".concat(r)]),"function"==typeof i&&i()}};Df(I.merge(a,e))},Ff=function(){return{Accept:"application/vnd.salemove.private+json",Authorization:"Bearer "+sm.accessToken}};function Bf(e){var t=e.stats,n=function(e){return t.increment("sm.service.overseer_api.action_shortcircuited",["type:".m.lib.overseer",["action:attempted"])};return{sourcesTriggered:function(e){var n=e.events,i=e.tabId,o=e.resolvedConditions,s=e.xhrWithRetry,a=void 0===s?Df:s;return cc.Observable.create((function(e){var s=I.merge({visitor_id:qu(),site_id:Fu(),url:window.location.href},{events:n,tab_id:i,resolved_conditions:o});a({method:"POST",url:"".concat(sm.conf.api_url,"/overseer/sources_triggered"),payload:s,contentType:"application/json",responseType:"json",getRequestHeaders:Ff,onAttempt:r,onSuccess:function(){var n,r,i;r=(n={resource:"overseer",method:"sources_triggered"}).resource,i=n.method,Yu.log("Successfully executed '".concat(i,"' on resource ").concat(r)),t.increment("sm.lib.overseer",["action:succeeded"]),e.next(null),e.complete()},onError:function(n){var r,i,o;i=(r={resource:"overseer",method:"sources_triggered"}).resource,o=r.method,Yu.warn("Failed to execute '".concat(o,"' on resource ").concat(i)),t.increment("sm.lib.overseer",["action:failed"]),e.error(n)},cahouldRetry:function(e){return 422!==e}})}))},sendOverseerMetrics:function(e){var t=e.browserEvents;I.forEach(n,t.flatMap((function(e){return e.actionTypes})))}}}var Hf=function(e){var t=function(e){return I.compose(I.reject(I.isNil),I.chain(I.prop("queue_ids")),I.chain(I.prop("conditions")))(e)}(e)||[],n=function(e){return I.compose(I.reject(I.isNil),I.chain(I.path(["browser_event_conditions","queue_ids"])))(e)}(e)||[],r=t.concat(n);return I.uniq(r)},Wf=function(e){return I.filter(I.compose(I.or(I.isEmpty,I.isNil),I.chain(I.propOr([],"queue_ids")),I.prop("conditions")))(e)},Gf=function(e){return I.filter(I.compose(I.isEmpty,I.pathOr([],["browser_event_conditions","queue_ids"])))(e)};function zf(e){var t=e.cobraObservable,n=e.internalVisitorStateObservable,r=e.volatileNotifications,i=e.stats,o=e.currentStatusObservable,s=e.queuesStateUpdatesObservable,a=e.routingObservable;new Uc({volatileNotifications:r,cobraObservable:t,routingObservable:a}).start();var u=new Bf({stats:i}),c=sm.conf.overseer.rules,l=sm.conf.omniq.omniq_enabled?c:function(e){return I.compose(Wf,Gf)(e)}(c),f=Hf(l),p=function(){if(I.not(I.isEmpty(f))){var e=new ju.ReplaySubject(1);return s.subscribeToList({queueIds:f,listener:e.next.bind(e)}),e}return ju.Observable.of(null)}();xf.init(u,{currentStatusObservable:o.startWith("available"),internalVisitorStateObservable:n,queuesAvailabilityObservable:p,rules:l,routingObservable:a})}function Jf(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i=!1!==r.rethrow;return function(){try{return n.apply(this,arguments)}catch(n){if(Qu.clientHandlerError(t),Yu.warn(e,n),i)throw n;console.error(n)}}}var Yf=I.curryN(2,(fun n=_(t,2),r=n[0],i=n[1];return e(r,i)})),I.toPairs)(t)})),Qf=function(){var e={},t=function(e,t){return Jf("Event handler for ".concat(e," threw an error"),e,t,{rethrow:!1})},n=function(n,r){var i=(e[n]||{}).listenerEntries||[],o=I.compose(I.map((function(e){var i=e.listener;return{listener:i,subscription:r.sub){return e.subscription.unsubscribe()})))(i);e[n]={observable:r,listenerEntries:o}};return{observable:function(t){return e[t].observable},addEventListener:function(n,r){var i=e[n]||{},o=i.listenerEntries||[],s=i.observable;if(!I.any(I.propEq("listener",r),o)){var a=s?s.subscribe(t(n,r),Yu.error):ju.Subscription.EMPTY,u=I.append({listener:r,subscription:a},o);return e[n]={listenerEntries:u,observable:s},null}},removeEventListener:function(t,n){var r=e[t]||{},i=r.listenerEntries||[],o=r.observable,s=I.find(I.propEq("listener",n))(i);if(s){s.subscription.unsubscribe();var a=I.without([s])(i);e[t]={observable:o,listenerEntries:a}}return null},proxy:n,proxyAll:Yf(n),eventWithoutListenerObservable:function(t){return(e[t]||{}).observable.pipe(wn((function(){return!function(t){var n=(e[t]||{}).listenerEntries||[];return I.not(I.isEmpty(n))}(t)})))},stop:function(){I.compose(I.forEach((function(e){return e.unsubscribe()})),I.map(I.prop("subscription")),I.chain(I.prop("listenerEntries")),I.values)(e),e={}}}},Kf=function(){var e=new ju.Subscription,t=Qf(),n=function(n,r){var i=r.publishReplay(1);e.add(i.connect()),t.proxy(n,i)};return{addEventListener:t.addEventListener,removeEventListener:t.removeEventListener,eventWithoutListenerObservable:t.eventWithoutListenerObservable,proxy:n,proxyAll:Yf(n),stop:function(){e.unsubscribe(),t.stop()},observable:t.observable}};function Xf(e){var t=Kf();return t.proxy("change",e),{addEventListener:t.addEventListener,removeEventListener:t.removeEventListener}}var $f=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:sm.tracker;return Xfion(){return Xf(ju.Observable.of(!0))};function ep(e){var t=e.channelObservable,n=e.logger.withTags({feature:"cobra"}),r=t.flatMap((function(e){var t=e.channe{return{Cobra:e,channel:t,operatull,(function(e){return e.channel.url})).switchMap((function(e){var t=e.Cobra,r=e.channel,i=e.operator,o=new t.SourceInitializer(r,$f(),i.id,n),s=o.initialize(),a=function(){return o.stop()};return r.addDestroyListener((function(){return a()})),ju.Observable.create((function(e){return e.next({cobraSourceInitializer:o,cobraSource:s,operator:i}),function(){return a()}}))})).do((function(e){var t=e.operator;return n.info("Cobra: Started successfully",{operator_id:t.id})}),n.warn.bind(n,"Cobra: Failed to start"),(function(){return n.info("Cobra: Stopped and will not start again")})),i=r.publishReplay(1);return sm.cobraSubscription=i.connect(),{cobraObservable:r=i.filter(I.pathEq(["cobraSource","status"],"started"))}}var tp,np={UNKNOWN:"unknown",NESTED_COBROWSABLE_IFRAME:"nested_cobrowsable_visitor",ENGAGEMENT_IFRAME:"main_visitor"},rp="cobrowsable_iframe_id",ip="sm:source:nested_cobrowsable_iframe:channel_url",op="sm:iframe_context_check",sp=function e(t,n){var r=function(e,t){for(var n=e.querySelectorAll("iframe"),r=0;r<n.length;r++){var i=n[r];if(i.contentWindow===t)return i}}(t,n);if(r)return r;for(var i=t.querySelectorAll("*"),o=0;o<i.length;++o){var s=i[o];if(s.shadowRoot){var a=e(s.shadowRoot,n);if(a)return a}}return null},ap=new ju.ReplaySue){tp.has(e)||(tp.add(e),ap.next(tp))};function cp(e){var t={parent:{},top:{}},n=new xl(window.parent);this.start=function(){n.start()},this.stop=function(){n.stop()},this.request=function(){n.request(op,{tab_id:e},(function(e){e.context?(t.parent[e.context]=!0,up(e.tabId)):(Yu.warn("Received iframe identity check with unexpected payloaddCobrowsableVisitorIframeChannelUrl=n}))},this.getCurrentContext=function(){return t},this.getParentWindowMessenger=function(){return n}}var lp=function(e){var t=new Il({allowAnySource:!0});return t.start(),t.respondTo(op,(function(t,n,r){var i=sp(document,r);i&&function(e){var t=e.attributes[rp];t&&t.value||e.setAttribute(rp,Tl())}(i),t.tab_id?up(t.tab_id):Yu.warn("Received iframe identity check with unexpected payload",t),n({context:"visitor_page",tabId:e})})),t.stop.bind(t)},fp=function(e){var t=new Il({allowAnySource:!0});return t.start(),t.respondTo(op,(function(t,n,r){n({context:"visitor_browser",tabId:e})})),t.stop.bind(t)};function pp(e,t){var n=t.visitor_api.iframe_identity_detection_timeout||5e3,r=t.visitor_api.iframe_identity_validity_check_timeout||3e4,i=function(){var t=e.getCurrentContext();return t.parent.visitor_page?np.NESTED_COBROWSABLE_IFRAME:t.parent.visitor_browser?np.ENGAGEMENT_IFRAME:void 0};return{detect:i,identityObservable:function(t){var o=ju.Observable.interval(200,t).take(Math.round(n/200)).do((function(t){if(!t)return e.request()})).map(i).startWith(i()).filter((function(e){return Boolean(e)})).take(1).defaultIer((function(e){return e===np.UNKNOWN})).flatMap((function(){return ju.ake(2).do((function(t){t||e.request()})).map(i).filter((function(e){return Boolean(e)})).take(1)}));return o.merge(s)},IDENTITIES:np}}var dp=function(){var e,t,n=new ju.Subject;e=window.history,(t=e?e.pushState:void 0)&&(e.pushState=function(r){var i=t.apply(e,arguments);return n.next({state:r}),i}),function(){var e=window.history,t=e?e.replaceState:void 0;t&&(e.replaceState=function(r){var i=t.apply(e,arguments);return n.next({state:r}),i})}(),$c(window,"popstate").subscribe(n);var r=n.startWith({}).map((function(){return window.location.href})).distinct)return e;return function(){return e}},vp="undefined"!=typeof self?self:null,bp="undefined"!=typeof window?window:null,mp=vp||bp||mp,gp="2.0.0",yp=0,_p=1,wp=2,Ep=3,Op="closed",Sp="errored",Tp="joined",kp="joining",Ap="leaving",xp="phx_close",Ip="phx_error",Np="phx_join",Mp="phx_reply",Rp="phx_leave",Cp="longper=null,this.recHooks=[],this.sis.timeout=e,this.ref,join_ref:this.channooks.push({status:e,l,this.receivedResp=null,th((function(e){return e.callbavent&&this.channel.off(this..timeoutTimer),this.timeouttrigger("timeout",{})}),thvedResp&&this.received(this.refEv),this.timerCalc(this.tries+1))}}]),e}(),Up=function(){function e(t,n,r){var i=this;s(this,e),this.state=Op,this.topic=t,this.params=hp(n||{}),this.socket=r,this.bindings=[],this.bindingRef=0,this.timeout=this.socket.timeout,this.joinedOnce=!1,this.joinPush=new Lp(this,Np,this.params,this.timeout),this.pushBuffer=[],this.state(){i.socket.isConnected()&&i.rejoin()}),this.socket.rejoinAfterMs),this.stateChangeRefs.push(this.socket.onError((function(){return i.rejoinTimer.reset()}))),this.stmer.reset(),i.isErrored()&&i.ree){return e.send()})),i.pushBuffeed()&&i.rejoinTiRef())),i.state=ed()&&i.rejoinTimer.scheduleTimeouted()&&i.rejoine,t){i.trigger(i.replyEventName(edOnce=!0,this.rejoin(lose",value:function(ehis.on(Ip,(functigs.push({event:e,rvent===e&&(void 0===t|socket.isConnected()&&this.isJoined()}},{key:"push",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.timeout;if(t=t||{},!this.joinedOnce)throw new Error("tried to push '".concat(e,"' to '").concat(this.topic,"' before joining. Use channel.join() before pushing events"));var r=new Lp(this,e,(function(){return t}),n);return this.canPush()?r.send():(r.startTimeout(),this.push,this.canPush()||r.triggssage",value:function(e:e,event:t,payload:n,je:function(){return this.state=kp,this.joinPush.resend(e))}},{key:"trigger",value:function(e,t,n,r){var i=this.onMessage(e,t,n,r);if(t&&!i)throw new Error("channel onMessage callbacks must return the payload, modified or unmodiilter((function(t){return t.event===e})),s=0;s<o.length;s++){o[s].callback(i,n,r||this.joinRef())}}},{key:"replyEventName",value:function(e){return"chan_reply_".concat(e)}},{key:"isClosed",value:function(){return this.state===Op}},{key:"isErrored",value:function(){return this.state===Sp}},{key:"isJoined",value:function(){return this.state===Tp}},{key:"isJoining",value:function(){return thlue:function(){return ,Dp=function(){function e(){s(this,e)turn this.xhrRequest(u,e,t,n,e.onprogress=function(){}a(t)}},s&&(e.ontimeout=siled to parse JSON response",e),null}}},{key:"serialize",value:function(e,t){var n=[];for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var i=t?"".concat(t,"[").concat(r,"]"):r,s=e[r];"object"===o(s)?n.push(this.serialize(s,i)):n.push(encodeURIComponent(i)+"="+encodeURIComponent(s))}return n).concat(n).concat(thiint(t),this.readyState=yp,this.poll()}retulace(new RegExp("(.*)/"+Ppthis.pollEndpoint,{token:thi{this.close(e,t,n),this.this.closeAndRetry(1005readyState===_p||this.readyState===yp}},{key:"poll",value:function(){var e=this;this.ajax("GET",null,(function(){return e.ontimeout()}),(function(t){if(t){var n=t.status,r=t.token,i=t.messages;e.token=r}n(){return e.onmessage({data:t})}),0)})),e.poll();break;case 204:e.poll();break;case 410:e.readyState=_p,e.onopen({}),e.poll();break;case 403:e.onerror(403),e.close(1008,"forbidden",!1);break;case 0:case 500:e.onerror(500),e.closeAndRetry(1011,"internal server error",500);break;default:e.onerro(1011,"internal server error",!1))}))}},{keyn||n.return()}finally{if(a)throw o}}}}(this.reqs);try{for(i.s();!(r=i.n()).done;){r.value.abort()}}catch(e){i.e(e)}finally{i.f()}this.readyState=Ep;var o=Object.assign({code:1e3,reason:void 0,wasClean:!0},{code:e,reason:t,wasClean:n});"undefined"!=typeof CloseEvent?this.onclose(new CloseEvent("close",o.isActive()&&r(e)})),this.reqs.add(i)}}]),e}(),Fp=function(){function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};s(this,e);var i=r.events||{state:"presence_state",diff:"presence_diff"};this.state={},this.pendingDiffs=[],this.channel=t,this.joinRef=null,this.caller={onChange:null,onJoin:null,onLeave:null,onSync:function(){}},this.channel.on(i.state,(function(t){var r=n.caller,i=r.onChange,o=r.onJoin,s=r.onLeave,a=r.onSync;n.joinRef=n.channel.joinRef(),o||s?e.syncState(n.state,t,o,s):e.synchronizeState(n.state,t,i),n.pendingDiffs.forEach((function(t){o||s?e.syncDiff(n.state,t,o,s):e.synchronizeDiff(n.state,t,i)})),n.pendingDiffs=[],a()})),this.channel.on(i.diff,(function(t){var r=n.caller,i=r.onChange,o=r.onJoin,s=r.onLeave,a=r.onSync;n.inPendingSyncState()?n.pendingDiffs.push(t):(o||s?e.syncDiff(n.state,t,o,s):e.synchronizeDiff(n.state,t,i),a())}))}return u(e,[{key:"onJoin",value:function(e){console&&console.warn&&console.warn("onJoin is deprecated, use onChange instead"),this.caller.onJoin=e}},{key:"onLeave",value:function(e){console&&console.warn&&console.warn("onLeave is deprecated, use onChange instead"),this.caller.onLeave=e}},{key:"onChange",value:function(e){this.calue:function(e){thnction(t){return e.list(this.statthis.joinRef!==this.channel.joinRef()}}],[{key:"synchronizeState",value:function(e,t,n){var r={},i={};return this.map(e,(function(e,n){t[e]||(i[e]=n)})),this.map(t,(function(t,n){var o=e[t];if(o){var s=n.metas.map((function(e){return e.phx_ref})),a=o.metas.map((function(e){return e.phx_ref})),u=n.metas.filter((function(e){return a.indexOf(e.phx_ref)<0})),c=o.metas.filter((function(e){return s.indexOf(e.phx_ref)<0}));u.length>0&&(r[t]=n,r[t].metas=u),c.length>0&&(u.length>0?i[t]={metas:c}:(i[t]=n,i[t].metas=c))}else r[t]=n})),this.synchronizeDiff(e,{joins:r,leaves:i},n)}},{key:"syncState",value:function(e,t,n,r){var i=this,o=thiss.map(o,(function(e,n){t[e]||(a[e]=n)})),this.map(t,(function(e,t){var n=o[e];if(n){var r=t.metas.map((function(e){return e.phx_ref})),u=n.metas.map((function(e){return e.phx_ref})),c=t.metas.filter((function(e){return u.indexOf(e.phx_ref)<0})),l=n.metas.filter((function(e){return r.indexOf(e.phx_ref)<0}));c.length>0&&(s[e]=t,s[e].metas=c),l.length>0&&(a[e]=i.clone(n),a[e].metas=l)}else s[e]=t})),this.syncDiff(o,{joins:s,leaves:a},n,r)}},{key:"synchronizeDiff",value:function(e,t,n){var r=t.joins,i=t.leaves,o={};return this.map(r,(function(e,t){o[e]={joinedMetas:t.metas,leftMetas:[],update:t}})),this.map(i,(function(e,t){o[e]?o[e].leftMetas=t.metas:o[e]={joinedMetas:[],leftMetas:t.metas,update:t}})),this.map(o,(function(t,r){var i=r.joinedMetas,o=r.leftMetas,s=r.update,a=i.map((function(e){return e.phx_ref})),u=o.map((function(e){return e.phx_ref})),c=e[t],l={metas:c?c.metas:[]};l.metas=l.metas.filter((function(e){return-1===a.ion(e){return-1===u.indexOf(function(e){"metas"!==e&&(l[e]=s[e])})),0===l.metas.length?delete e[t]:e[t]=l,n&&n(t,c,l)})),e}},{key:"syncDiff",value:function(e,t,n,r){var i=this,o=this.clone(t),s=o.joins,a=o.leaves;return n||(n=function(){}),r||(r=function(){}),this.map(s,(function(t,r){var o=e[t];if(e[t]=i.clone(r),o){var s,a=e[t].metas.map((function(e){return e.phx_ref})),u=o.metas.filter((function(e){return a.indexOf(e.phx_ref)<0}));(s=e[t].metas).unshift.apply(s,w(u))}n(t,o,r)})),this.map(a,(function(t,n){var i=e[t];if(i){var o=n.metas.map((function(e){returtion(e){return o.indexOf(e.phx_ref)<0})),r(t,i,n),0===i.metas.length&map(e,(function(e,.map((function(n){return t(n,e[n])}))}},{key:"clone",value:function(e){return JSON.parse(JSON.stringify(e))}}]),e}(),Bp={HEADER_LENGTH:1,META_LENGTH:4,KINDS:{push:0,reply:1,broadcast:2},encode:function(e,t){if(e.payload.constructor===ArrayBuffer)return t(this.binaryEncode(e));var n=[e.join_ref,e.ref,e.topic,e.event,e.payloa,topic:n[2],e Uint8Array(ot:return thnt:c,payloadent:Mp,payload:{nt:a,payload:e.slice(o,e.byteLength)}}},Hp=function(){function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};s(this,e),this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.channels=[],this.sendBuffer=[],this.ref=0,this.timeout=r.timeout||1e4,this.transport=r.transport||mp.WebSocket||Vp,this.establishedConnections=0,this.defaultEncoder=Bp.encode.bind(Bp),this.defaultDecoder=Bp.decode.bind(Bp),this.closeWasClean=!1,this.binaryType=r.binaryType||"arraybuffer",this.connectClock=1,this.transport!==Vp?(this.encode=r.encode||this.defaultEncoder,this.decode=r.decode||this.defaultDecoder):(this.encode=this.defaultEncoder,this.decode=this.defaultDecoder);var i=null;bp&&bp.addEventListnn&&(n.disconnect(),i=n.connectClo=n.connectClock&&(i=null,n.connect())}))),this.heartbeatIntervalMs=r.heartoinAfterMs(e):[1e3,2e300,150,200,250,500,1e3,2e3][e-1]||5e3},this.logger=r.logger||null,this.longpollerTimeout=r.longpollerTimeout||2e4,this.params=hp(r.params||{}),this.endPoint="".concat(t,"/").concat(Pp),this.vsn=r.vsn||gp,this.heartbeatTimeoutTimer=null,this.heartbeatTimer=null,this.pendingHeartbeown((function(){return n.connect()}))}),this.reconnectAfterMs)}return u(e,[{key:"getLongPollTransport",value:function(){retse(),this.conn=null),thn.protocol.match(/^https/)://").concat(location.hosectTimer.reset(),this.teardown(e,t,n)}},{key:"connect",value:function(e){var t=this;e&&(console&&console.log("passing params to connect is deprecated. Instead pass :params to the Socket constructor"),this.params=hp(e)),this.conn||(this.connectClock++,this.closeWasClean=!1,this.conn=new this.transport(this.endPointURL()),this.conn.binaryType=this.binaryType,this.conn.timeout=this.longpollerTimeout,this.conn.onopen=function(){return t.onConnOpen()},this.conn.onerror=function(e){return t.onConnError(e)},this.conn.onmessage=function(e){return t.onConnMessage(e)},this.conn.onclose=function(e){returnue:function(e,t,n){this.:function(){return null!==this.logger}},{key:"onOpen",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.open.push([t,e]),t}},{key:"onClose",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.close.push([t,e]),t}},{key:"onError",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.error.ChangeCallbacks.mesoff([i]),e(Date.now()-r))}));rarTimeout(this.heartbeatTimeoutTimer)}},{key:"onConnOpen",value:function(){if(this.hasLogger()){var e=this.endPointURL().replace(/access_token=([^&#/]+)/,"access_token=-pruned-");this.log("transport","connected to ".concat(e))}this.closeWasClean=!1,this.establishedConnections++,this.flushSendBuffer(),this.reconnectTimer.reset(),this.resetHeartbeat(),tch((function(e){return(0,_(e,2)[1]Timeout()}),1e3,"heartbeat tirtbeat()}),this.heartbeunction(){},r.conn=null),e&&e()}waitForBufferDone(e,n+1)}),150*n):itForSocketClosed(e,n+1)}),150*n):e()}},{key:"onConnClose",value:function(e){this.hasLogger()&&this.log("transport","close",e),this.triggerChanError(),this.clearHeartbeats(),this.closeWasClean||this.reconnectTimer.scheduleTimeout(),thh((function(t){return(0,_(t,2nsport||n>0)&&this.triggerChanEing()||e.isClosed()||e.triggerturn"closing";default:retureturn"open"===this.c){return t.joinRef=_(t,1)[0];return-1===,this);return this.nction(e){return t.con.ref=0:this.ref=e,this.ref.toString()}},{key:"sendHeartbeat",value:function(){var e=this;this.pendingHeartbeatRef&&!this.isConnected()||(this.pendingHeartbeatRef=this.makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.heartbeatTimeoutTimer=setTimeout((function(){return e.heartbeatTimeout()}),this.heartbeatInter(e){return e()})),this.sendBuffer=[])}},{key:"onConnMessage",value:function(e){var t=this;this.decode(e.data,(function(e){var n=e.topic,r=e.event,i=e.payload,o=e.ref,s=e.join_ref;o&&o===t.pendingHeartbeatRef&&(t.clearHeartbeats(),t.pendingHeartbeatRef=null,t.heartbeatTimer=setTimeout((function(){return t.sendHeartbeat()}),t.heartbeatIntervalMs)),t.hasLogger()&&t.log("receive","".concat(i.status||""," ").concat(n," ").concat(r," ").concat(o&&"("+o+")"||""),i);for(var a=0;a<t.channels.length;a++){var u=t.channels[a];u.isMember(n,r,i,s)&&u.trigger(r,i,o,s)}for(var c=0;c<t.stateChangeCallbacks.message.length;c++){(0,_(t.stateChangeCallbacks.message[c],2)[1])(e)}}))}},{key:"leaveOpenTopic",value:function(e){for(var t,n=0;n<this.channels.length;n++){var r=this.channels[n];if(r.topic===e&&(r.isJoined()||r.isJoining())){t=r;break}}t&&(this.hasLogger()&&this.log("transport",'leaving duplicate topic "'rn"hidden"===document.visibilityState},Gp=function(){return navigator.onLine},zp=function(e,t){return t.onlyLongPollEnabled?Vp:window.WebSocket?Gp()?e.transport===window.WebSocket?Vp:window.WebSocket:e.transport:Vp};function Jp(e){var t,n={onlyLongPollEnabled:!1,connectionTriedOnce:!1,avoidLongPollWorkerInterval:6e5},r=function(t,r){n.onlyLongPollEnabled=!0,e.disconnect((function(){e.transport=Vp,r&&r(t),e.connect()}))};return{ensureConnected:function(i){var o=i.onInitialTry,s=i.onInitialError,a=i.avoidLongPollWorkerInterval;if(!n.connectionTriedOnce){o&&o(),"number"==typeof a&&(n.avoidLongPollWorkerInterval=a);try{e.connect(),e.conn.readyState===WebSocket.CLOSED&&r(null,s)}catch(e){r(e,s)}n.connectionTriedOnce=!0,t=function(e,t){if(t.avoidLongPollWorkerInterval>0&&!t.onlyLongPollEnabled){var n=setInterval((function(){if("open"===e.connectionState()&&e.transport===Vp){var n=zp(e,t);if(e.transport!==n)return e.transport=n,e.disconnect((function(){return e.connect()}))}}),t.avoidLongPollWorkerInterval);return function(){return clearInterval(n)}}}(e,n)}},selectNewTransport:function(){Gpport=zp(e,n))},stop:function(){t&&t()}}}var Yp=function(e){return e===window.WebSocket?"WebSocket":e===Vp?"LongPoll":"unknown"},Qp=function(e){return"object"===o(e)?null==e?void 0:e.reason:e},Kp={metrics:{}};function Xp(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{logPrefix:"PubSub"},o=r.logPrefix,s=0,a=!1;n=n||Kp;var u=function(e){n.metrics.connectionMetric&&n.increment(n.metrics.connectionMetric,e)},c=function(t){return i(i({},{transport:Yp(e.transport),online:Gp(),visibility_state:document.visibilityState,error_count:s}),t)},l=function(t,n){var r=(n||{}).transport;return["transport:".concat(r||Yp(e.transport)),"online:".concat(Gp())].concat(t)},f=function(){a=!0,u(l(["action:connected"])),t.info("".concat(o," socket opened"),c({}))},p=function(e){if(e){var n=Yp(window.WebSocket),r=c({reason:e.reason,type:e.type,code:e.code&&e.code.toString(),transport:n}),i=l(["action:disconnected","type:".concat(e.type),"code:".concat(e.code)],{transport:n});e.wasClean?(u(i.concat(["reason:closed"])),t.info("".concat(o," connection disconnected cleanly"),r)):Wp()?(u(i.concat(["reason:closed"])),t.info("".concat(o," connection disconnected while tab was hidden"),r)):(u(i.concat(["reason:closed"])),t.info("".concat(o," connection disconnected"),r))}else{var s=Yp(Vp),a=c({reason:"unknown",type:"unknown",code:"unknown",transport:s}),f=l(["action:disconnected","type:unknown","reason:unknown","code:unknown"],{transport:s});u(f),t.info("".concat(o," connection disconnected"),a)}},d=function(e){var n=e&&e.type||"unknown";s+=1;var r=e&&e.target?c({type:n}):c({type:n,error:e});Wp()?t.info("".concat(o," connection error while tab was hidden"),r):Gp()?1!==s||a?(u(l(["action:error"])),t.warn("".concat(o," socket connection error"),r)):t.info("".concat(o," socket connection error while attempting to establish the connection first time"),r):t.info("".concat(o," connection error while user was offline"),r)},h=function(n){return t.info("".concat(o," failed to connect with initial transport"),{new_transport:Yp(e.transport),error:Qp(n)})},v=function(){return u(l(["action:connect"]))};return{onOpen:f,onClose:p,onError:d,onInitialTry:v,onInitialConnectError:h}}var $p=function(e,t){var n=t.enabled,r=t.logPrefix;return n?function(t,n,o){var s=null!=o&&o.token?i(i({},o),{},{token:"-pruned-"}):o;e.info("".concat(r," ").concat(t,": ").concat(n),{pubsub_data:s})}:function(){}},Zp="sm.app.visitor_api.pubsub",ed="".concat(Zp,".connection"),td="".concat(Zp,".push"),nd=2147483647,rd=function(e){var t=e.server,n=e.socket,r=e.stats,i=e.logsEnabled,s=e.getAccessToken,a=e.visitorIdObservable,u=void 0===a?Du():a,c=e.reconnectConf,l=void 0===c?{}:c,f=e.getVisitorPriority,p=e.renewAccessToken,d=null;l={initialDelay:l.initialDelay||3e3,maxDelay:l.maxDelay||6e4,delayFactor:l.delayFactor||1.5};var h=M(l.initialDelay,l.maxDelay,l.delayFactor),v=0,b=Date.now(),m=l.maxDelay+1e4+1e3;n||(n=new Hp("".concat(t,"/notifications"),{logger:$p(Yu,{ereturn{access_token:s(),priority:f()}},reconnectAfterMs:function(e){return Date.now()-b>m&&(v=0,b=Date.now()),h(v)},heartbeatIntervalMs:1e4}));var g=new Jp(n),y=new Xp(n,Yu,{increment:r.increment.bind(r),metrics:{connectionMetric:ed}},{logPrefix:"PubSub"}),_=new ju.ReplaySubject(1),w=sm.conf.engagement.api_timeout_milliseconds||1e4;n.onOpen((function(){!function(e){var t=!1;e.channels.forEach((function(e){e.isJoined()&&(t||Yu.info("Detected joined channels during socket open callback, forcing re-join"),t=!0,e.trigger("phx_error","missed_close"))}))}(n),_.next(!0),y.onOpen()})),n.onClose((function(e){_.next(!1),v+=1,b=Date.now(),y.onClose(e),d&&n.disconnect()})),n.onError((function(e){if(_.next(!1),"number"==typeof e)switch(e){case 403:Yu.info("Detected likely pubsub authentication error, reconnecting after max delay"),h.setNextDelayMinimum(l.maxDelay);break;case 410:break;case 500:Yu.info("PubSub connection disconnected with error 500");break;case 503:var t=l.maxDelay/2;Yu.info("PubSub unavailable, postponing reconnecting for at least ".concat(t," ms")),h.setNextDelayMinimum(t);break;default:return Yu.error("Received unhandled pubsub error status ".concat(e,", stopping reconnecting")),void n.disconnect()}y.onError(e),g.selectNewTransport()}));var E=function(e){return"object"===o(e)?null==e?void 0:e.reason:e},O=function(e,t,i,o){var s=function(e){iams because it is a closure already")},e;var t=I.clone(e||{}),n n.modify=function(e,n){t[e]=n(t[e])},n}(t);o||(o={}),i||(i=[]);var a=ju.Observable.create((function(a){var u=!1,c=(t||{}).timeout||nd,l=n.channel(e,s);return l.join(c).receive("ok",(function(){u=!0,a.next(function(e,t){var n=function(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=i.dr a=function(e,t){o||r.increment(e,t)};return ju.Observable.create((function",(function(e){r.next(e),r.complete()})).receive("error",(function(e){a(td,["action:error"]),r.error({type:"error",error:e})})).receive("timeout",(function(){a(td,["action:timeout"]),r.error({type:"timeout"})})),function(){}}))};return{observable:function(t,n){return n||(n={}),ju.Observable.create((function(r){var i=e.on(t,(function(e){return r.next(e)}));return function(){e.off(t,i),n.leaveChannelOnDispose&&e.leave()}}))},push:n,phoenixChannel:e,leave:function(){return e.leave()},watchNewTopics:function(e){return t.modify("topics",(function(t){return I.union(t||[],e)})),n("watch",{topics:e},{timeout:nd})}}}(l,s)),a.complete()})).receive("error",(function(t){t&&"join crashed"===t.reason?Yu.info("Joining Pubsub channel failed with crash, retrying",{reason:"error",error:E(t),topic:e}):t&&"overload"===t.reason?Yu.info("Joining Pubsub channel failed because of overload, retrying",{topic:e}):(t&&-1!==i.indexOf(t.reason)?Yu.info("Joining Pubsub channel failed with expected reason",{reason:"error",error:E(t),topic:e}):Yu.warn("Joining Pubsub channel failed",{reason:"error",error:E(t),topic:e}),a.error({type:"el failed",{reason:"timeout",topic:e})})),function(){u&&!o.leaveChannelOnDispose||l.leave()}}));return ju.Observable.defer((function(){return g.ensureConnected({onInitialTry:function(){return y.onInitialTry},onInitialError:function(e){return y.onInitialConnectError(e)}}),ju.Observable.of({})})).flatMapTo(_).filter(I.equals(!0)).take(1).flatMapTo(a)},S=function(e){return ju.Observable.create((function(t){return t.next(e),function(){return e.leave()}}))},T=u.switchMap((function(e){return O("visitor_volatile:".concat(e)).flatMap(S)})).publishReplay(1);T.connect(),T.flatMap((function(e){return e.observable("system:avoid_reconnection")})).subscribe((function(e){var t,r,i=e.duration_in_seconds;r=.5,i=(t=i)+Math.floor(Math.random()*r*t),Yu.info("Disabling reconnections to pubsub",{duration_in_seconds:i}),d&&clearTimeout(d),d=setTimeout((function(){Yu.info("Enabling reconnections to pubsub"),d=null,n.connect()}),1e3*i)}));var k,A,x,N=I.compose(I.not,I.isEmpty,I.symmetricDifite_visitor:".concat(e,":").concat(t)}),t)},C=[];return{joinChannel:O,volatileChannelObservable:T,joinSiteVisitorNotifications:function(e,t){return!I.isEmpty(C)&&k&&A===e||(A=e,C=t,(k=O("site_visitor:".concat(e),{topics:R(e,C)}).publishReplay(1)).connect(),(x=k.flatMap((function(e){return(0,e.observable)("message")})).filter(I.identity).publishReplay(50)).connect()),N(t,C)&&(C=I.union(t,C),k.take(1).flatMap((function(t){return(0,tg("Subscribed to additional sites",C)}),(function(e){return Yu.warn("Error subscribing to additional sites",e,C)}))),x},connectedObservable:_.distinctUntilChanged(),disconnect:n.disconnect.bind(ect((function(){return n.connect()}))},renewTokenAndReconnectWaitForTeardown:function(e){var t=e.consolidationSecret;return p({consolidationSecret:t}).flatMap((function(){return ju.Observn(){n.connect(),e.next(),e.connection:function(){return null===d},__socket__:n}};function id(e,t){var n=t.visitorId,r=t.visitorIdObservable,o=t.tabId,s=t.idleTimeoutSeconds,a=t.visitorMetadata;n=n||qu(),r=(r||Du()).share();var u="JOIN_NOT_REQUESTED",c="JOINING_ALLOW_REJECTION",l="JOINING_ALLOW_REJECTION_BUT_NO_REJECTION_REQUESTED",f="JOINING_NO_REJECTION",p="JOIN_REJECTED",d="JOINED",h="JOIN_ERROR",v="JOIN_REQUESTED_ALLOW_REJECTION",b="JOIN_REJECTED",m="JOIN_ERROR",g="JOIN_SUCCESSFUL",y="JOIN_REQUESTED_NO_REJECTION",w="VISITOR_ID_CHANGED",E="too_many_tracked",O=new ju.ReplaySubject(1),S=function(t,n,i){var u="visitor_presence:".concat(t),c=n?[E]:[],l=!1;e.joinChannel(u,(function(){return{tab_id:o,page_url:location.href,page_description:document.title,idle_timeout_seconds:s,visitor_metadata:I.pick(["location"],a),allow_rejection:n&&!l}}),c).take(1).takeUntil(r).map((function(e){var t=e.phoenixChannel,n=e.leave;return[new Fp(t),n]})).subscribe((function(e){var t=_(e,2),n=t[0],r=t[1];l=!0,i(g,{presence:n,leavePresence:r})}),(function(e){I.pathEq(["error","reason"],E,e)?i(b):i(m)}))},T={joinState:u,visitorId:n},k=function e(t,n){var r=_(function(e,t,n){switch(t){case v:switch(e.joinState){case u:return[i(i({},e),{},{joinState:c}),function(t){return S(e.visitorId,!0,t)}];default:return[e]}case y:switch(e.joinState){case u:case p:return[i(i({},e),{},{joinState:f}),function(t){return S(e.visitorId,!1,t)}];case c:return[i(i({},e),{},{joinState:l})];default:return[e]}case b:switch(e.joinState){case l:return[i(i({},e),{},{joinState:f}),function(t){return S(e.visitorId,!1,t)}];case c:return[i(i({},e),{},{joinState:p})];case f:return Yu.error("Request to join visitor presence channel was rejected, although we did not allow rejection"),[i(i({},e),{},{joinState:p})];default:return Yu.error("Received join rejection while we were not joining channel",{currentState:e}),[e]}case m:switch(e.joinState){case c:case f:case l:return[i(i({},e),{},{joinState:h})];default:return Yu.error("Received join error while we were not joining channel",{currentState:e}),[e]}case g:switch(e.joinState){case c:case f:case l:return[i(i({},e),{},{joinS,function(){return O.next(n.presence)}];default:return Yu.error("Received join successful while we were not joining channel",{currentState:e}),[e]}case w:var r=n;if(r===e.visitorId)return[e];switch(e.joinState){case c:case f:case l:var o=e.joinState=torId:r}),function(e){return S(r,o,e)}];case d:return[i(i({},e),{},{visitorId:r,joinState:f}),function(t){e.leavePresence(),S(r,!1,t)}];default:return Yu.info("Visitor ID changed, but not joining visitor presence"),[e]}default:return Yu.error("Received invalid action",{action:t}),[e]}}(T,t,n),2),o.subscribe((function(e){return k(w,e)}),Yu.error.bind(Yu,"Error from visitor ID subscription in visitor presence channel")),this.requestJoin=function(estJoinAllowRejection=function(){k(v)},this.getPresenceObservable=function(){return O.asObservable()};var A=O.switchMap((function(e){return ju.Observable.create((function(t){e.onSync((function(){var n=e.list();n[0]?I.any(I.equals(void 0),n[0].metas)?Yu.warn("Visitor Presence metas included undefined value"):t.next(n[0].metas):t.next([])}))}))})).publishReplay(1);A=rl(A),this.getSameVisitorConnections=function(){return A}}var od="undefined"!=typeof window?window:"undefined"!=typeof global?ge(t={exports:{}},t.exports),t.exports}var ad=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,ud=["source","protocol","authority","userInfo","user","password","host","port","relative","path",""").replace(/;/g,":"),o.ipv6uri=!0),o},ld="function"==typeof Symbol&&"symbol"===o(Syml&&("Cturn n&&e(t.prototyppero destructure non-iterable instance")},vd=1e3,bd=60*vd,md=60*bd,gd=24*md,yd=365.25*gd,_d=function(e,t){t=t||{};var n,r=void 0===e?"undefined":ldec":case"ms":return n;default:return}}(e);if("number"===r&&!1===isNaN(e))return t.long?wd(n=e,gd,"day")||wd(n,md,"hour")||wd(n,bdrn Math.round(e/vd)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))};function wd(e,t,n){if(!(e<t))return e<1.5*t?Math.floor(e/t)+" "+n:Math.ceil(e/t)+" "+n+"s"}var Ed=sd((function(e,t){(t=e.exports=o.debug=o).coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){t.enable("")},t.enable=function(e){t.save(e);for(var n=(e||"").split(/[\s,]+/),r=n.length,i=0;i<r;i++)n[i]&&("-"===(e=n[i].replace(/[\\^$+?.()|[\]{}]/g,"\\$&").replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){var n,r;for(n=0,r=t.skips.length;n<r;n++)if(t.skips[n].test(e))return!1;for(n=0,r=t.names.length;n<r;n++)if(t.names[n].test(e))return!0;return!1},t.humanize=_d,t.names=[],t.skips=[],t.formatters={};var n,r=0;function i(enabled(e)?o:r;return s.v"in process)return process.env.DEBUG}(t=e.exports=Ed).log=function(){return"object"===("undefined"==typeof console?"undefined":ld(console))&&console.log&&Function.prototype.apply.call(console.log,console,arguments)},t.formatArgs=function(){var e=arguments,n=this.useColors;if(e[0]=(n?"%c":"")+this.namespace+(n?" %c":" ")+e[0]+(n?"%c ":" ")+"+"+t.humanize(this.diff),!n)return e;var r="color: "+this.color;e=[e[0],r,"color: inherit"].concat(Array.prototype.slice.call(e,1));var i=0,o=0;return e[0].replace(/%[a-z%]/g,(function(e){"%%"!==e&&(i++,"%c"===e&&(o=i))})),e.splice(o,0,r),e},t.save=function(e){try{null==e?t.storage.removeItem("debug"):t.storage.debug=e}catch(e){}},t.load=n,t.useColors=function(){return"undefined"!=typeof document&&"WebkitAppearance"in document.documentElement.style||window.console&&(console.firebug||console.exception&&console.table)||navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31},t.storage="undefined"!=typeof chrome&&void 0!==chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(e){}}(),t.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue",expectedJSONParseError]: "+e.message}},t.enable(n())})),Sd=cd,Td=Od("socket.io-client:url"),kd=function(e,t){var n=e;t=t||od.location,null==e&&(e=t.protocol+"//"+t.host);"string"==typeof e&&("/"===e.charAt(0)&&(e="/"===e.charAt(1)?t.protocol+e:t.host+e),/^(https?|wss?):\/\//.test(e)||(Td("protocol-less url %s",e),e=void 0!==t?t.protocol+"//"+e:"https://"+e),Td("parse %s",e),n=Sd(e));n.port||(/^(http|ws)$/.test(n.protocol)?n.port="80":/^(http|ws)s$/.test(n.protocol)&&(n.port="443"));n.path=n.path||"/";var r=-1!==n.host.indexOf(":")?"["+n.host+"]":n.host;return n.id=n.protocol+"://"+r+":"+n.port,n.href=n.protocol+"://"+r+(t&&t.port===n.port?"":":"+n.port),n};var Ad=1e3,xdr(e/t)+" "+n:Math.ceil(e/t)+" "+n+"s"enabled(instanceof Error?e.stack||e.message:e},t.dis:t.names.p(t.names[n].test(e))return!0;return!1},t.humanize=Rd,t.names=[{return t.colors[r++%t.c{e=t.storage.debug}cy.call(consol"%c"==="debug"):t.storage.de\/(\d+)/)&&parseInt(RegExp.$1,10)>=31},t.storage="undefined"!=typeof chrome&&void 0return window.localStorage}catch(e){}}(),t.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"],t.formatters.j=function(e){return JSON.stringify(e)},t.enable(n())})),Ld=sd((function(e,t){
/*! JSON v3.3.2 | http://bestiejs.github.io/json3 | Copyright 2012-2014, Kit Cambridge | http://kit.mit-license.org */
(function(){var n={function:!0,object:!0},r=n.object&&t&&!t.nodeType&&t,i=n["undefined"==typeof window?"undefined":ld(window)]&&window||this,o=r&&n.object&&e&&!e.nodeType&&"object"==ld(od)&&od;function s(e,t){e||(e=i.Object()),t||(t=i.Object());var r=e.Number||i.Number,o=e.String||i.String,a=e.Object||i.Object,u=e.Date||i.Date,c=e.SyntaxError||i.SyntaxError,l=e.TypeError||i.TypeError,f=e.Math||i.Math,p=e.JSON||i.JSON;"object"==(void 0===p?"undefined":ld(p))&&p&&(t.stringify=p.stringify,t.parse=p.parse);var d,h,v,b=a.prototype,m=b.toString,g=new u(-0xc782b5b800cec);try{g=-109252==g.getUTCFullYear()&&0===g.getUTCMonth()&&1===g.getUTCDate()&&10==g.getUTCHours()&&37==g.getUTCMinutes()&&6==g.getUTCSeconds()&}}}catch(e){f=!1}n=f}}return y[e]=!!n}if(!y("json")){var _="[object Function]",w="[object Number]",E="[object String]",O="[object Array]",S=y("bug-string-char-index");if(!g)var T=f.floor,k=[0,31,59)-T((e-1901+t)/100)+T((e-160is[e]===n[e])}),n=null,d.call(this,e)}),h=function(e,t){var r,i,o,s=0;for(o in(r=function(){this.valueOf=0}).prototype.valueOf=0,i=new r)d.c;(r||d.call(e,n="constructor"))&&t(n)}:(i=["valueOf","toString","toLocaleString","propertyIsEnumerable","isPrototypi.length;r=i[--o];a.call(e,r)&&t(r));}),h(e,t)},!y("json-stringify")){var x={92:"\\\\",34:'\\"',8:"\\b",tk}t+=i?o[n]:e.charAt(n)}}return t+'"'},M=function e(t,n,r,i,o,s,a){var u,c,f,p,b,g,y,_,S,k,x,M,R,C,P,j;try{u=n[t]}catch(e){}if("object"==(void 0===u?"undefined":ld(u))&&u)if("[object Date]"!=(c=m.call(u))||d.call(u,"toJSON"))"function"==typeof u.toJSON&&(c!=w&&c!=E&&c!=O||d.call(u,"toJSON"))&&(u=u.toJSON(t));else if(u>-1/0&&u<1/0){if(A){for(b=T(u/864e5),f=T(b/365.2425)+1970-1;A(f+1,0)<=b;f++);for(p=T((b-A(f,0))/30.42);A(f,p+1)<=b;p++);b=1+b-A(f,p),y=T((g=(u%864e5+864e5)%864e5)/36e5)%24,_=T(g/6e4)%60,S=T(g/1e3)%60,k=g%1e3}else f=u.getUTCFullYear(),p=u.getUTCMonth(),b=u.getUTCDate(),y=u.getUTCHours(),_=u.getUTCMinutes(),S=u.getUTCSeconds(),k=u.getUTCMilliseconds();u=(f<=0||f>=1e4?(f<0?"-":"+")+I(6,f<0?-f:f):I(4,f))+"-"+I(2,p+1)+"-"+I(2,b)+"T"+I(2,y)+":"+I(2,_)+":"+I(2,S)+"."+I(3,k)+"Z"}else u=null;if(r&&(u=r.call(n,t,u)),null===u)return"null";if("[object Boolean]"==(c=m.call(u)))return""+u;if(c==w)return u>-1/0&&u<1/0?""+u:"null";if(c==E)return N(""+u);if("object"==(void 0===u?"undefined":ld(u))){for(C=a.length;C--;)if(a[C]===u)throw l();if(a.push(u),x=[],P=s,s+=o,c==O){for(R=0,C=u.length;R<C;R++)M=e(R,u,r,i,o,s,a),x.push(M===v?"null":M);j=x.length?o?"[\n"+s+x.join(",\n"+s)+"\n"+P+"]";n!==v&&x.push(N(t)+":"+(o?" ":"")+n)})),j=x.length?o?"{\n"+s+x.join(",\n"+s)+"\n"+P+"}":"{"+x.join(",")+"}":"{}";return a.pop(),j}};t.stringify=function(e,t,r){var i,o,s,a;if(n[void 0===t?"undefined":ld(t)]&&t)if((a=m.call(t))==_)o=t;else if(a==O){s={};for(var u,c=0,l=t.length;c<l;u=t[c++],((a=m.call(u))==E||a==w)&&(s[u]=1));}if(r)if((a=m.call(r))==w){if((r-=r%1)>0)for(i="",r>10&&(r=10);i.length<r;i+=" ");}else a==E&&(i=r.length<=10?r:r.slice(0,10));return M("",((u={})[""]=e,u),o,s,i,"",[])}}if(!y("json-parse")){var R,C,P=o.fromCharCode,j={92:"\\",34:'"',47:"/",98:"\b","\R,lir r=V(e,t,n);r===v?delete e[t]:e[t]=r},V=function(e,t,n){var r,i=e[t];if("object"==(void 0===i?"undefined":ld(i))&&i)if(m.call(i)==O)i,r,n);else h(i,(function(e){D(icall(t)==_?V(((r={})[""]=n,r),"",t):n}}}return t.runInContext=s,t}if(!o||o.global!==o&&o.window!==o&&o.self!==o||(i=o),r)s(i,r);else{var a=i.JSON,u=|(c=!0,i.JSON=a,i.JSON3=u,a=u=null),l}});i.JSON={parse:l.parse,stringify:l.stringify}}}).call(od)})),qd=Ud;function Ud(e){if(e)return function(e){for(var t in Ud.prototype)e[t]=Ud.prototype[t];return e}(e)}Ud.prot=this._callbacks[eallbacks||{},r.fn=t,this.on(e,r),this},Ud.prototype.off=Ud.prototype.removeListener=Ud.prototype.removeAllList===t){r.splice(i,1<i;++r)n[r].apply(this,_callbacks||{},this._callbacks[e]||[]},Ud.prototype.hasListeners=function(e){return!!this.listeners(e).length};var Dd=Array.isArray||function(e){return"[object Array]"=ArrayBuffer&&e instanceof ArrayBuffer};var Fd=Dd,Bd=Vd,Hd={deconstructPacket:function(e){var t=[],n=e.data;var r=e;return r.data=function e(n){if(!n)return n;if(Bd(n)){var r={_placeholder:!0,num:t.length};return t.push(n),r}if(Fd(n)){for(var i=new Array(n.length),o=0;o<n.length;o++)i[o]=e(n[o]);return i}if("object"==(void 0===n?"undefined":ld(n))&&!(n instanceof Date)){i={};for(var s in n)i[s]=e(n[s]);return i}return n}(n),r.attachments=t.length,{packet:r,buffers:t}},reconstructPacket:function(e,t){return e.data=function e(n){if(n&&n._placeholder)return t[n.num];if(Fd(n)){for(var r=0;r<n.length;r++)n[r]=e(n[r]);return n}if(n&&"object"==(void 0===n?"undefined":ld(n))){for(var i in n)n[i]=e(n[i]);return n}return n}(e.data),e.attachments=void 0,e},removeBlobs:function(e,t){var n=0,r=e;!function e(i,o,s){if(!i)return i;if(od.Blob&&i instanceof Blob||od.File&&i instanceof F]=this.result:r=this.result,--n||t(r)},a.readAsArrayBuffer(i)}else if(Fd(i))for(var u=0;u<i.length;u++)e(i[u],u,i);else if(i&&"object"==(void 0===i?"undefined":ld(i))&&!Bd(i))for(var c in i)e(i[c],c,i)}(r),n||t(r)}},Wd=sd((function(e,t){var n=jd("socket.io-pars{type:t.ERROR,data:"parser error"}}t.protocol=4,t.types=["CONNECT","DISCONNECT","EVENT","ACK","ERROR","BINARY_EVENT","BINARY_ACK"],t.CONNECT=0,t.DISCONNECT=1,t.EVENT=2,t.ACK=3,t.ERROR=4,t.BINARY_EVENT=5,t.BINARY_ACK=6,t.Encoder=a,t.Decoder=c,a.prototype.encode=function(e,r){(n("encoding packet %j",e),t.BINAR;i.unshift(r),t(i)}o.removeBlobs(e,n)}(e,r):r([u(e)])},i(c.prototype),c.prototype.add=function(e){var i;if("string"==typeof e)i=function(e){var i={},o=0;if(i.type=Number(e.charAt(0)),null==t.types[i.type])return f();if(t.BINARY_EVENT==i.type||t.BINARY_ACK==i.type){for(var s="";"-"!=e.charAt(++o)&&(s+=e.charAt(o),o!=e.length););if(s!=Number(s)||"-"!=e.charAt(o))throw new Error("Illegal attachments");i.attachments=Number(s)}if("/"==e.charAt(o+1))for(i.nsp="";++o;){if(","==(u=e.charAt(o)))break;if(i.nsp+=u,o==e.length)break}else i.nsp="/";var a=e.charAt(o+1);if(""!==a&&Number(a)==a){for(i.id="";++o;){var u;if(null==(u=e.charAt(o))||Number(u)!=u){--o;break}if(i.id+=e.charAt(o),o==e.length)break}i.id=Number(i.id)}e.charAt(++o)&&(i=function(e,t){try{e.data=r.parse(t)}catch(e){return f()}return e}(i,e.substr(o)));return n("decoded %s as %j",e,i),i}(e),t.BINARY_EVENT==i.type||t.BINARY_ACK==i.type?(this.reconstructor=new l(i),0===this.reconstructor.reconPack.attachments&&this.emit("decoded",i)):this.emit("decoded",i);else{if(!s(e)&&!e.base64)throw new Error("Unknown type: "+e);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");(i=this.reconstructor.takeBinaryData(e))&&(this.reconstructor=null,this.emeconstructor.finishedReconsinishedReconstruction(),t}return nu){this.recXMLHtX")])("Microsoft in e)n.call(e,r)&]"==Object.prototype.toString.call(e)},Qd=function(e){return function e(t){if(!t)return!1;if(od.Buffer&&od.Buffer.isBuffer&&od.Buffer.isBuffer(t)||od.ArrayBuffer&&t instanceof ArrayBuffer||od.Blob&&t instanceof Blob||od.File&&t instanceof File)return!0;if(Yd(t)){for(var n=0;n<t.length;n++)if(e(t[n]))return!0}else if(t&&"object"==(void 0===t?"undefined":ld(t)))for(var r in t.toJSON&&"function"==typeof t.toJSON&&(t=t.toJSON()),t)if(Object.prototype.hasOwnProperty.call(t,r)&s<n,t(e),t=n):0!==i.count||r||t(null,o)}};function $d(){}var Zd=sd((function(e,t){
/*! https://mths.be/wtf8 v1.0.0 by @mathias */
!function(n){var r=t,i=e&&e.exports==r&&e,o="object"==ld(od)&&od;o.global!==o&&o.window!==o|Error("Invalid continuation byte")}function h(){var e,t;if(u>a)throw Error("Invalid byte index");if(u==a)return!1;if(e=255&s[u],u++,0==(128&e))return e;if(192==(224&e)){if((t=(31&e)<<6|d())>=128)return t;throw Error("Invalid continuation byte")}if(224==(240&e)){if((t=(15&e)<<12|d()<<6|d())>=2048)return t;throw Error("Invalid continuation byte")}if(240==(248&e)&&(t=(15&e)<<18|d()<<12|d()<<6|d())>=65536&&t<=1114111)return t;throw Error("Invalid WTF-8 de,r=-1,i,t=56320|1023&t),i+=c(t);return i}(n)}};if(r&&!r.nodeType)if(i)i.exports=v;else{var b={}.hasOwnProperty;for(var m in v)b.call(v,m)&&(r[m]=v[m])}else n.wtf8=v}(od)})),eh=sd((function(e,t){!function(){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n=new Uint8Array(256),r=0;r<e.le&(o=o.sub<4|o>>2,f[c++]=(3&o)<<6|63&s;return l}}()})),th=od.BlobBuilder||od.WebKitBlobBuilder|| Blob(["hrray([1,2])]).size}catch(e){return!1}}(),ih=th&&th.e,t){return oh(e),new Blob(e,t||{})}var uh=nh?rh?od.Blob:ah:ih?sh:void 0,ch=sd((function(e,t){var n,r=Jd,i=Qd,o=Kd,s=Xd,a=Zd;od&&od.ArrayBuffer&&(n=eh);var u="undefined"!=typeof navigator&&/Android/i.test(navigator.userAgent),c="undefined"!=typeof navigator&&/PhantomJS/i.test(navigator.userAgent),l=u||c;t.protocol=3;var f=t.packets={open:0,close:1,ping:2,pong:3,message:4,upgrade:5,noop:6},p=r(f),d={r)}))},a=0;a<e.length;a++)o(a,e[a],i)}t.encodePacket=function(e,n,r,i){"function"==typeof n&&(i=n,n=!1),"function"==typeof r&&(i=r,r=null);var o=void 0===e.data?void 0:e.data.buffer||e.data;if(od.ArrayBth;a++)s[a+1]=o[a];return r(s.buffer)}(e,=new h([i.buffer,e.data]);retckets[e.type]+e.data.data;return n(r)}(e,i);var s=f[e.type];return void 0!==e.data&&(s+=r?a.encode(String(e.data)):String(ply(null,a)}return i+=od.btoa(r),n(i)},t.decodePacket=function(e,n,r){if(void 0===e)return d;if("string"==typeof e){if("b"==e.charAt(0))return t.decodeBase64Packet(e.substr(1),n);if(r&&!1===(e=function(e){try{e=a.decode(e)}catch(e){return!1}return e}(e)))return d;var i=e.charAt(0);return Number(i)==i&&p[i]?e.length>1?{type:p[i],data:e.substring(1)}:{type:p[i]}:d}i=new Uint8Array(e)[0];var s=o(e,1);return h&&"blob"===n&&(s=new h([s])),{t=t&&h&&(i=new h(function(e,t){re+=o,a=""}}return""!=a?r(d,0,1gth;s++)i[o++]=r[s]})),(function(e,t){return ne,i){r(t.d(e){return!!thders,this.localAddress=e.localAddressscription=t,this.edyState="opening",t|(this.doClose(),tr("Transport not open",this.writable=!0,s.socket.binaryType);tket=function(e){this.eadyState="closed"="+enco])]=otype=new n,e.prototype.constructor=e},mh="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrn e!==hh?(yh=0,hh=e):e+"."+wh(yh++)}for(;_h<64;_h+_h++)t=64*t+gh[e.charAt(_h)];return t};var Oh=Eh,Sh=ph,Th=vh,kh=ch,Ah=bh,xh=Oh,Ih=Od("engine.io-client:polling"),Nh=Rh,Mh=nis.supportsBinary=!1),Sh.call(this,e)}Ah(Rh,Sh),Rh.prototype.name="polling",Rh.prototype.doOpen=functing complete"),--ng=!0,this.doPoll(),ansport state "%s"',teferring close"),thBinary,(function(name+"]":this.hostname)+n+this.path+e};var Ch=zd,Ph=Nh,jh=lh,Lh=bh,qh=Od("engine.io-client:poProperty(e)&&Bh.requests[e].abort()}Lh(Fh,Ph),Fh.prototype.raHeaders=this.extraH"xhr post error",e)}"xhr poll error",e)})),this.pollXhr=e},jh(Bh.prototype),Bh.prototype.create=function(){var e={agent:this.agent,xdomain:this.xd,xscheme:this.xs,enablesXDR:this.enablesXDR};e.pfx=this.pfx,e.key=this.key,e.passphrase=this.passphrase,e.cert=this.cert,e.ca=this.ca,e.ciphers=this.ciphers,e.rejectUnauthorized=this.rejectUnauthorized;var t=this.xhr=new Ch(e),n=this;try{qh("xhr open %s: %s",this.method,this.uri),t.open(this.method,this.uri,this.async);try{if(this.extraHeaders)for(var r in t.setDisableHeaderCheck(!0),this.extraHeaders)this.extraHeaders.hasOwnProperty(r)&&t.setRequestHeader(r,this.extraHeaders[r])}catch(e){}if(this.supportsBinary&&(t.responseType="arraybuffer"),"POST"===this.method)try{this.isBinary?t.setRequestHeader("Content-type","application/octet-stream"):t.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(e){}try{t.setRequestHeader("Accept","*/*")}catch(e){}"withCredentials"in t&&(t.withCredentials=!0),this.requestTimeout&&(t.timeout=this.requestTimeout),this.hasXDR()?(t.onload=function(){n.onLoad()},t.onerror=function(){n.onError((function(){n.onError(t.status)}),0))},qh("xhr data %s",this.data),t.send(this.d setTimeout((function(){n.onError(e)}),0)}od.document&&(this.index=Bh.requestsCount++,Bh.requests[thi){this.emit("success{this.emit("data",e),this.emit("error",e),h.requests[this.indeis.onError(e)}null!=ainRequest&&!this.xotype.abort=function(){this.cleanup()},Bh.requestsCount=0,Bh.requests={},od.document&&(od.attachEvent?od.attachEvent("onunload",Hh):od.addEventListener&&od.addEventListener("beforeunload",Hh,!1)),Uh.Request=Dh.script&&(t.script.onerror=Qh)}),!1)}bh(Kh,Gh),Kh.prototype.null),Gh.prototype.d),document.body.removreadyState&&a()}:this.iframe.onload=a};var Xh,$h={},Zh=Object.freeze({default:$h}),ev=Zh&&$h||Zh,tv=ph,nv=ch,rv=vh,iv=bh,ov=Oh,sv=Od("engine.io-client:websocket"),av=od.WebSocket||od.MozWebSocket;if("undefined"==typeof window)try{Xh=ev}catch(e){}var uv=av;uv||"undefined"!=typeof window||(uv=Xh);var cv=lv;function lv(e){e&&e.forceBase64&&(this.supportsBinary=!1),this.perMessageDeflate=e.perMessageDeflate,this.usingBrowserWebSocket=av&&!e.forceNode,this.usingBrowserWebSocket||(uv=Xh),tv.call(this,e)}iv(lv,tv),lv.prototype.name="websocket",lv.prototype.supportsBinary=!0,lv.prototype.doOpen=function(){if(this.check()){var e=this.uri(),t={agent:this.agent,perMessageDeflate:this.perMessageDeflate};t.pfx=this.pfx,t.key=this.key,t.passphrase=this.passphrase,t.cert=this.cert,t.ca=this.ca,t.ciphers=this.ciphers,t.rejectUnauthorized=this.rejectUnauthorized,this.extraHeaders&&(t.headers=this.extraHeaders),this.localAddress&&(t.localAddress=this.localAddress);try{this.ws=this.usingBrowserWebSocket?new uv(e):new uv(e,void 0,t)}catch(e){return this.emit("error",e)}void 0===this.ws.binaryType&&(this.supportsBinary=!1),this.ws.supports&&this.ws.supports.binary?(this.supportsBinary=!0,this.ws.binaryType="nodebuffer"):this.ws.binaryType="arraybuffer",this.addEventListenon(t){e.onError("websocket error",t)}},lv.prototype.write=function(e){var t=this;this.writable=!1;for(var n=e.length,r=0,i=n;r<i;r++)!function(e){nv.encodePacket(e,t.supportsBinary,(function(r){if(!t.usingBrowserWebSocket){var i={};if(e.options&&(i.compress=e.options.compress),t.perMessageDeflate)("string"==typeof r?od.Buffer.byteLength(r):r.length)<t.perMessageDeflate.threshold&&(i.compress=!1)}try{t.usingBrowserWebSocket?t.ws.send(r):t.ws.send(r,i)}catch(e){sv("websocket closed bef(){t.writable=!0,t.emiion(){tv.prototype.onn(){void 0!==thisname+"]":this.hostnin uv&&this.name===lv.prototype.name)}or("JSONP disabled");return newgth;++n)if(e[n]===t)return n;return-1},mv=/^[\],:{}\s]*$/,gv=/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,yv=/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,_v=/(?:^|:|,)(?:\s*\[)+/g,wv=/^\s+/,Ev=/\s+$/,Ov=hv,Sv=lh,Tv=Od("engine.i Function("return "+e)():void 0):null},Nv=vh,Mv=Rv;function Rv(e,t){if(!(this instanceof Rv))return new Rv(e,t);t=t||{},e&&"object"===(void 0===e?"undefined":ld(e))&&(t=e,e=null),e?(e=xv(e),t.hostname=e.host,t.secure="https"===e.protocol||"wss"===e.protocol,t.port=e.port,e.query&&(t.query=e.query)):t.host&&(t.hostname=xv(t.host).host),this.secure=null!=t.secure?t.secure:od.location&&"https:"===location.protocol,t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.agent=t.agent||!1,this.hostname=t.hostname||(od.location?location.hostname:"localhost"),this.port=t.port||(od.location&&location.port?location.port:this.secure?443:80),this.query=t.query||{},"string"==typeof this.query&&(this.query=Nv.decode(this.query)),this.upgrade=!1!==t.upgrade,this.path=(t.path||"/engine.io").replace(/\/$/,"")+"/",this.forceJSONP=!!t.forceJSONP,this.jsonp=!1!==t.jsonp,this.forceBase64=!!t.forceBase64,this.enablesXDR=!!t.enablesXDR,this.timestampParam=t.timestampParam||"t",this.timestampRequests=t.timestampRequests,this.transports=t.transports||["polling","websocket"],this.readyState="",this.writeBuffer=[],this.prevBufferLen=0,this.policyPort=t.policyPort||843,this.rememberUpgrade=t.rememberUpgrade||!1,this.binaryType=null,this.onlyBinaryUpgrades=t.onlyBinaryUpgrades,this.perMessageDeflate=!1!==t.perMessageDeflate&&(t.perMessageDeflate||{}),!0===this.perMessageDeflate&&(this.perMessageDeflate={}),this.perMessageDeflate&&null==this.perMessageDeflate.threshold&&(this.perMessageDeflate.threshold=1024),this.pfx=t.pfx||null,this.key=t.key||null,this.passphrase=t.passphrase||null,this.cert=t.cert||null,this.ca=t.ca||null,this.ciphers=t.ciphers||null,this.rejectUnauthorized=void 0===t.rejectUnauthorized?null:t.rejectUnauthorized,this.forceNode=!!t.forceNode;var n="object"===ld(od)&&od;n.global===n&&(t.extraHeaders&&Object.keys(t.extraHeaders).length>0&&(this.extraHeaders=t.extraHeaders),t.localAddress&&(this.localAddress=t.localAddress)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingIntervalTimer=null,this.pingTimeoutTimer=null,this.open()}Rv.priorWebsocketSuccess=!1,Sv(Rv.prototype),Rv.protocol=Av.protocol,Rv.Socket=Rv,Rv.Transport=ph,Rv.transports=hv,Rv.parser=ch,Rv.prototype.createTransport=function(e)sOwnProperty(n)&&(t[n]=e[n]);return t}(this.query);return t.EIO=Av.protocol,t.transport=e,this.id&&(t.sid=this.id),new Ov[e]({agent:this.agent,hostname:this.hostname,port:this.port,secure:this.secure,path:this.path,query:t,forceJSONP:this.forceJSONP,jsonp:this.jsonp,forceBase64:this.forceBase64,enablesXDR:this.enablesXDR,timestampRequests:this.timestampRequests,timestampParam:this.timestampParam,policyPort:this.policyPort,socket:this,pfx:this.pfx,key:this.key,passphrase:this.passphrase,cert:this.cert,ca:this.ca,ciphers:this.ciphers,rejectUnauthorized:this.rejectUnauthorized,perMessageDeflate:this.perMessageDeflate,extraHeaders:this.extraHeaders,forceNode:this.forceNode,localAddress:.open()}e.open(),this.setTion(){t.onClose("tr,u),this.once("upgrae<t;e++)this.probe(thiket readyState "%s"',thishis.on("heartbeat",this.o")}),e||t.pingIntervabeat(e.pingTimeout("ping",(function(){eength?this.emit("drriteBuffer.length,this.emit("flush"))this.sendPacket("messager&&this.once("flush,e.once("upgradeError,e),this.onClose("tra.writeBuffer=[],this.prevBufansports,e[n])&&t.push(e[n]);return t};var0;r<e.loy:function(){e.rempply(e,n.concat(Uv.call(arguments)))}},Vv=sd((function(e,t){var n=Wd,r=lh,i=Lv,o=qv,s=Dv,a=Od("socket.io-client:socket"),u=Qd;e.exports=f;var c={connect:1,connect_error:1,connect_timeout:1,connecting:1,disconnect:1,error:1,reconnect:1,reconnect_attempt:1,reconnect_failed:1,reconnect_error:1,reconnectiery),this.io.autoConnect&&this.open(t")),o(e,"close",s(this,"onclose"))]}nopen(),this.emitessage"),this.emiBuffer.push(o),delen(e){e.nsp=this.nspuery}):this.packet({ete this.id,this.emitse n.ERROR:this.emitly(this,t):this..ACK;t.packet({typthis.acks[e.id]):a("bas.emit("connect"),this.emhis.sendBuffer[e]);this.s,this.onclose("io se;this.subs=null}this.io.destroy(this)},f..onclose("io client d.flags||{.jitter<=1?e.jitter:0e-n:e+n}return 0|Matype.reset=function(){this.attempts=0},Bv.prototype.setMin=function(e){this.ms=e},Bv.prototype.setMax=functione.setJitter=function(e){this.jitter=e};var Hv=jv,Wv=Vv,Gv=lh,zv=Wd,Jv=qv,Yv=Dv,Qv=Od("socket.io-client:manager"),Kv=bv,Xv=Fv,$v=Object.prototype.hasOwnProperty,Zv=eb;function eb(e,t){if(!(this instanceof eb))return new eb(e,t);e&&"object"===(void 0===e?"undefined":ld(e))&&(t=e,e=void 0),(t=t||{}).path=t.path||"/socket.io",this.nsps={},this.subs=[],this.opts=t,this.reconnection(!1!==t.reconnection),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor(t.randomizationFactor||.5),this.backoff=new Xv({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==t.timeout?2e4:t.timeout),this.readyState="closed",this.uri=e,this.connecting=[],this.lastPing=null,this.encoding=!1,this.packetBuffer=[],this.encoder=new zv.Encoder,this.decoder=new zv.Decoder,this.autoConnect=!1!==t.autoConnect,this.autoCone].emit.apply(this.nsps[e],ar,e)&&(this.nsps[e].id=this.engine.id)},Gv(ennection=!!e,this):this._reconnection},eb.prototype.reconnectionAttempts=function(e){return arguments.length?(this._reconnectionAttempts=e,this):this._reconnectionAttempts},eb.prototype.reconnectionDelay=function(e){return arguments.length?(this._reconnectionDelay=e,this.backoff&&this.backoff.setMin(e),this):this._reconnectionDelay},eb.prototype.randomizationFactor=function(e){return arguments.length?(this._randomizationFactor=e,this.backoff&&this.backoff.setJitter(e),this):this._randomizationFacx(e),this):this._reco?(this._timeout=e,this):this._timeis.backoff.attempts&&this.reconnect()},s.subs.push(i),this.oder,"decoded",Yv(thastPing=new Date,thimitAll("pong",new Date-this.lastPing)},eb.prototype.ondata=function(e){this.decoder.add(e)},eb.prototype.ondecoded=function(e){this.Qv("error",e),this.emitAll("error",e)},eb.prototype.socket=function(e,t){var n=this.nsps[e];if(!n){n=new Wv(this,e,t),this.nsps[e]=n;var r=thiconnect",(function(){n.ir.connecting,n)||r.connecting.,this.connecting.lenncoding=!1,t.processPacketQueue(.packetBuffer.shift().lastPing=null,this.decoder.destroy()},eb.psed",this.engine&&thi!this.skipReconnect&&thestroy:function(){clearTicketIds(),this.emitAll("reconnect",e)};var tb=sd((function(e,t){var n=kd,r=Wd,i=Zv,o=Od("socket.io-client");e.exports=t=a;var s=t.managers={};function a(e,t){"object"===(void 0===e?"undefined":ld(e))&&(t=e,e=void 0),t=t||{};var r,a=n(e),u=a.source,c=a.id,l=a.path,f=s[c]&&l in s[c].nsps;return t.forceNew||t["force new connection"]||!1===t.multiplex||f?(o("ignoring socket cache for %s",u),r=i(u,t)):(s[c]||(o("new io instance for %s",u),s[c]=i(u,t)),r=s[c]),a.query&&!t.query?t.query=a.queRIComponent(e[n]));return t.join("&")}(t.query)),r.socket(a.path,t)}t.protocol=r.protocol,t.cob=function(e,t){return void 0===t?e:t},rb=function(){function e(){fd(this,e)}return pd(e,null,[{key:"establish",value:function(e){var t=e.url,n=e.id,r=e.isActiveTab,i=e.options;e.logger.info("Establishing Kluster connection via Channel lib;");var o=function(e,t){return e+(e.split("?")[1]?"&":"?")+t}(t,"id="+n+"&tags="+function(e){var t=e?[{name:"cobrowse",unique:!0}]:[];return encodeURIComponent(JSON.stringify(t))}(r));return tb.connect(o,{"force new connection":!0,timeout:nb(15e3,i.timeout),reconnectionDelay:nb(1e3,i.reconnectionDelay),reconnectionDelayMax:nb(1e3,i.reconnectionDelayMax),randomizationFactor:nb(0,i.randomizationFactor),reconnectionAttempts:nb(Infinity,i.reconnectionAttempts),upgrade:nb(undefined,i.upgrade)})}}]),e}(),ib=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];fd(this,e),this.emit=this.emit.bind(this),this.socket=t,this.stopped=null===this.socket,this.tags=n,this.childEmitters=[]}return pd(e,[{key:"stop",value:function(){return this.stopped=!0,this.socket=null,this.childEmitters.map((function(e){return e.stop()}))}},{key:"in",value:function(e){var t=new this.constructor(this.socket,[e],this);return this.childEmitters.push(t),t}},{key:"emit",value:function(e,t){if(!this.stopped){var n={"channel:event_name":e,"channel:event_data":t,"channel:tags":this.tags};return this.socket.emit("announce",n)}}},{key:"authorize",value:function(e){if(!this.stopped)return this.socket.emit("authorthis.id=n,this.socketId=r,this.tags=i}return pd(e,null,[{key:"build",value:function(t){var n=t.tags.map((function(e){return e._name}));return new e({id:t.id,socketId:t.socketId,tags:n})}}]),e}(),sb=function(e){if("function"==typeof e)return e;return function(){return e}},ab="undefined"!=typeof self?self:null,ub="undefined"!=typeof window?window:null,cb=ab||ub||cb,lb="2.0.0",fb=0,pb=1,db=2,hb=3,vb="closed",bb="errored",mb="joined",gb="joining",yb="leaving",_b="phx_close",wb="phx_error",Eb="phx_join",Ob="phx_reply",Sb="phx_leave",Tb="longpoll",kb="websocket",Ab=4,xb=function(){function e(t,n,r,i){fd(this,e),this.channel=t,this.event=n,this.payload=r||function(){return{}},this.receivedResp=null,this.timeout=i,this.timeoutTimer=null,this.recHooks=[],this.sent=!1}return pd(e,[{key:"resend",value:function(e){this.timeout=e,this.reset(),this.send()}},{key:"send",value:function(){this.hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload(),ref:this.ref,join_ref:this.channel.joinRef()}))}},{key:"receive",value:function(e,t){return this.hasReceived(e)&&t(this.receivedResp.response),this.recHooks.push({status:e,callback:t}),this}},{key:"reset",value:function(){this.cancelRefEvent(),this.ref=null,this.refEvent=null,this.receivedResp=null,this.sent=!1}},{key:"matchReceive",value:function(e){var t=e.status,n=e.response;e._ref;this.recHooks.filter((function(e){return e.status===t})).forEach((function(e){return e.callback(n)}))}},{key:"cancelRefEvent",value:function(){this.refEvent&&this.channel.off(this.refEvent)}},{key:"cancelTimeout",value:function(){clearTimeout(this.timeoutTimer),this.timeoutTimer=null}},{key:"startTimeout",value:function(){var e=this;this.timeoutTimer&&this.cancelTimeout(),this.ref=this.channel.socket.makeRef(),this.refEvent=this.channel.replyEventName(this.ref),this.channel.on(this.refEvent,(function(t){e.cancelRefEvent(),e.cancelTimeout(),e.receivedResp=t,e.matchReceive(t)})),this.timeoutTimer=setTimeout((function(){e.trigger("timeout",{})}),this.timeout)}},{key:"hasReceived",value:function(e){return this.receivedResp&&this.receivedResp.status===e}},{key:"trigger",value:function(e,t){this.channel.trigger(this.refEvent,{status:e,response:t})}}]),e}(),Ib=function(){function e(t,n){fd(this,e),this.callback=t,this.timerCalc=n,this.timer=null,this.tries=0}return pd(e,[{key:"reset",value:function(){this.tries=0,clearTimeout(this.timer)}},{key:"scheduleTimeout",value:function(){var e=this;clearTimeout(this.timer),this.timer=setTimeout((function(){e.tries=e.tries+1,e.callback()}),this.timerCalc(this.tries+1))}}]),e}(),Nb=function(){function e(t,n,r){var i=this;fd(this,e),this.state=vb,this.topic=t,this.params=sb(n||{}),this.socket=r,this.bindings=[],this.bindingRef=0,this.timeout=this.socket.timeout,this.joinedOnce=!1,this.joinPush=new xb(this,Eb,this.params,this.timeout),this.pushBuffer=[],this.stateChangeRefs=[],this.rejoinTimer=new Ib((function(){i.socket.isConnected()&&i.rejoin()}),this.socket.rejoinAfterMs),this.stateChangeRefs.push(this.socket.onError((function(){return i.rejoinTimer.reset()}))),this.stateChangeRefs.push(this.socket.onOpen((function(){i.rejoinTimer.reset(),i.isErrored()&&i.rejoin()}))),this.joinPush.receive("ok",(function(){i.state=mb,i.rejoinTimer.reset(),i.pushBuffer.forEach((function(e){return e.send()})),i.pushBuffer=[]})),this.joinPush.receive("error",(function(){i.state=bb,i.socket.isConnected()&&i.rejoinTimer.scheduleTimeout()})),this.onClose((function(){i.rejoinTimer.reset(),i.socket.hasLogger()&&i.socket.log("channel","close "+i.topic+" "+i.joinRef()),i.state=vb,i.socket.remove(i)})),this.onError((function(e){i.socket.hasLogger()&&i.socket.log("channel","error "+i.topic,e),i.isJoining()&&i.joinPush.reset(),i.state=bb,i.socket.isConnected()&&i.rejoinTimer.scheduleTimeout()})),this.joinPush.receive("timeout",(function(){i.socket.hasLogger()&&i.socket.log("channel","timeout "+i.topic+" ("+i.joinRef()+")",i.joinPush.timeout),new xb(i,Sb,sb({}),i.timeout).send(),i.state=bb,i.joinPush.reset(),i.socket.isConnected()&&i.rejoinTimer.scheduleTimeout()})),this.on(Ob,(function(e,t){i.trigger(i.replyEventName(t),e)}))}return pd(e,[{key:"join",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeout;if(this.joinedOnce)throw new Error("tried to join multiple times. 'join' can only be called a single time per channel instance");return this.timeout=e,this.joinedOnce=!0,this.rejoin(),this.joinPush}},{key:"onClose",value:function(e){this.on(_b,e)}},{key:"onError",value:function(e){return this.on(wb,(function(t){return e(t)}))}},{key:"on",value:function(e,t){var n=this.bindingRef++;return this.bindings.push({event:e,ref:n,callback:t}),n}},{key:"off",value:function(e,t){this.bindings=this.bindings.filter((function(n){return!(n.event===e&&(void 0===t||t===n.ref))}))}},{key:"canPush",value:function(){return this.socket.isConnected()&&this.isJoined()}},{key:"push",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.timeout;if(t=t||{},!this.joinedOnce)throw new Error("tried to push '"+e+"' to '"+this.topic+"' before joining. Use channel.join() before pushing events");var r=new xb(this,e,(function(){return t}),n);return this.canPush()?r.send():(r.startTimeout(),this.pushBuffer.push(r)),r}},{key:"leave",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeout;this.rejoinTimer.reset(),this.joinPush.cancelTimeout(),this.state=yb;var n=function(){e.socket.hasLogger()&&e.socket.log("channel","leave "+e.topic),e.trigger(_b,"leave")},r=new xb(this,Sb,sb({}),t);return r.receive("ok",(function(){return n()})).receive("timeout",(function(){return n()})),r.send(),this.canPush()||r.trigger("ok",{}),r}},{key:"onMessage",value:function(e,t,n){return t}},{key:"isMember",value:function(e,t,n,r){return this.topic===e&&(!r||r===this.joinRef()||(this.socket.hasLogger()&&this.socket.log("channel","dropping outdated message",{topic:e,event:t,payload:n,joinRef:r}),!1))}},{key:"joinRef",value:function(){return this.joinPush.ref}},{key:"rejoin",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeout;this.isLeaving()||(this.socket.leaveOpenTopic(this.topic),this.state=gb,this.joinPush.resend(e))}},{key:"trigger",value:function(e,t,n,r){var i=this.onMessage(e,t,n,r);if(t&&!i)throw new Error("channel onMessage callbacks must return the payload, modified or unmodified");for(var o=this.bindings.filter((function(t){return t.event===e})),s=0;s<o.length;s++){o[s].callback(i,n,r||this.joilue:function(e){return"chan_reply_"+e}},{key:"isClosed",value:function(){return this.state===vb}},{key:"isErrored",value:function(){return this.state===bb}},{key:"isJoined",value:function(){return this.state===mb}},{key:"isJoining",value:function(){return this.state===gb}},{key:"isLeaving",value:function(){return this.state===yb}}]),e}(),Mb=function(){function e(){fd(this,e)}return pd(e,null,[{key:"request",value:function(e,t,n,r,i,o,s){if(cb.XDomainRequest){var a=new cb.XDomainRequest;return this.xdomainRequest(a,e,t,r,i,o,s)}var u=new cb.XMLHttpRequest;return this.xhrRequest(u,e,t,n,r,i,o,s)}},{key:"xdomainRequest",value:function(e,t,n,r,i,o,s){var a=this;return e.timeout=i,e.open(t,n),e.onload=function(){var t=a.parseJSON(e.responseText);s&&s(t)},o&&(e.ontimeout=o),e.onprogress=function(){},e.send(r),e}},{key:"xhrRequest",value:function(e,t,n,r,i,o,s,a){var u=this;return e.open(t,n,!0),e.timeout=o,e.setRequestHeader("Content-Type",r),e.onerror=function(){return a&&a(null)},e.onreadystatechange=function(){if(e.readyState===Ab&&a){var t=u.parseJSON(e.responseText);a(t)}},s&&(e.ontimeout=s),e.send(i),e}},{key:"parseJSON",value:function(e){if(!e||""===e)return null;try{return JSON.parse(e)}catch(t){return console&&console.log("failed to parse JSON response",e),null}}},{key:"serialize",value:function(e,t){var n=[];for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var i=t?t+"["+r+"]":r,o=e[r];"object"===(void 0===o?"undefined":ld(o))?n.push(this.serialize(o,i)):n.push(encodeURIComponent(i)+"="+encodeURIComponent(o))}return n.join("&")}},{key:"appendParams",value:function(e,t){if(0===Object.keys(t).length)return e;var n=e.match(/\?/)?"&":"?";return""+e+n+this.serialize(t)}}]),e}(),Rb=function(){function e(t){fd(this,e),this.endPoint=null,this.token=null,this.skipHeartbeat=!0,this.reqs=new Set,this.onopen=function(){},this.onerror=function(){},this.onmessage=function(){},this.onclose=function(){},this.pollEndpoint=this.normalizeEndpoint(t),this.readyState=fb,this.poll()}return pd(e,[{key:"normalizeEndpoint",value:function(e){return e.replace("ws://","http://").replace("wss://","https://").replace(new RegExp("(.*)/"+kb),"$1/"+Tb)}},{key:"endpointURL",value:function(){return Mb.appendParams(this.pollEndpoint,{token:this.token})}},{key:"closeAndRetry",value:function(e,t,n){this.close(e,t,n),this.readyState=fb}},{key:"ontimeout",value:function(){this.onerror("timeout"),this.closeAndRetry(1005,"timeout",!1)}},{key:"isActive",value:function(){return this.readyState===pb||this.readyState===fb}},{key:"poll",value:function(){var e=this;this.ajax("GET",null,(function(){return e.ontimeout()}),(function(t){if(t){var n=t.status,r=t.token,i=t.messages;e.token=r}else n=0;switch(n){case 200:i.forEach((function(t){setTimeout((function(){return e.onmessage({data:t})}),0)})),e.poll();break;case 204:e.poll();break;case 410:e.readyState=pb,e.onopen({}),e.poll();break;case 403:e.onerror(403),e.close(1008,"forbidden",!1);break;case 0:case 500:e.onerror(500),e.closeAndRetry(1011,"internal server error",500);break;default:e.onerror(n),e.close()}}))}},{key:"send",value:function(e){var t=this;this.ajax("POST",e,(function(){return t.onerror("timeout")}),(function(e){e&&200===e.status||(t.onerror(e&&e.status),t.closeAndRetry(1011,"internal server error",!1))}))}},{key:"close",value:function(e,t,n){var r=!0,i=!1,o=void 0;try{for(var s,a=this.reqs[Symbol.iterator]();!(r=(s=a.next()).done);r=!0){s.value.abort()}}catch(e){i=!0,o=e}finally{try{!r&&a.return&&a.return()}finally{if(i)throw o}}this.readyState=hb;var u=Object.assign({code:1e3,reason:void 0,wasClean:!0},{code:e,reason:t,wasClean:n});"undefined"!=typeof CloseEvent?this.onclose(new CloseEvent("close",u)):this.onclose(u)}},{key:"ajax",value:function(e,t,n,r){var i=this,o=void 0;o=Mb.request(e,this.endpointURL(),"application/json",t,this.timeout,(function(){i.reqs.delete(o),n()}),(function(e){i.reqs.delete(o),i.isActive()&&r(e)})),this.reqs.add(o)}}]),e}(),Cb=function(){function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};fd(this,e);var i=r.events||{state:"presence_state",diff:"presence_diff"};this.state={},this.pendingDiffs=[],this.channel=t,this.joinRef=null,this.caller={onChange:null,onJoin:null,onLeave:null,onSync:function(){}},this.channel.on(i.state,(function(t){var r=n.caller,i=r.onChange,o=r.onJoin,s=r.onLeave,a=r.onSync;n.joinRef=n.channel.joinRef(),o||s?e.syncState(n.state,t,o,s):e.synchronizeState(n.state,t,i),n.pendingDiffs.forEach((function(t){o||s?e.syncDiff(n.state,t,o,s):e.synchronizeDiff(n.state,t,i)})),n.pendingDiffs=[],a()})),this.channel.on(i.diff,(function(t){var r=n.caller,i=r.onChange,o=r.onJoin,s=r.onLeave,a=r.onSync;n.inPendingSyncState()?n.pendingDiffs.push(t):(o||s?e.syncDiff(n.state,t,o,s):e.synchronizeDiff(n.state,t,i),a())}))}return pd(e,[{key:"onJoin",value:function(e){console&&console.warn&&console.warn("onJoin is deprecated, use onChange instead"),this.caller.onJoin=e}},{key:"onLeave",value:function(e){console&&console.warn&&console.warn("onLeave is deprecated, use onChange instead"),this.caller.onLeave=e}},{key:"onChange",value:function(e){this.caller.onChange=e}},{key:"onSync",value:function(e){this.caller.onSync=e}},{key:"list",value:function(t){return e.list(this.state,t)}},{key:"inPendingSyncState",value:function(){return!this.joinRef||this.joinRef!==this.channel.joinRef()}}],[{key:"synchronizeState",value:function(e,t,n){var r={},i={};return this.map(e,(function(e,n){t[e]||(i[e]=n)})),this.map(t,(function(t,n){var o=e[t];if(o){var s=n.metas.map((function(e){return e.phx_ref})),a=o.metas.map((function(e){return e.phx_ref})),u=n.metas.filter((function(e){return a.indexOf(e.phx_ref)<0})),c=o.metas.filter((function(e){return s.indexOf(e.phx_ref)<0}));u.length>0&&(r[t]=n,r[t].metas=u),c.length>0&&(u.length>0?i[t]={metas:c}:(i[t]=n,i[t].metas=c))}else r[t]=n})),this.synchronizeDiff(e,{joins:r,leaves:i},n)}},{key:"syncState",value:function(e,t,n,r){var i=this,o=this.clone(e),s={},a={};return this.map(o,(function(e,n){t[e]||(a[e]=n)})),this.map(t,(function(e,t){var n=o[e];if(n){var r=t.metas.map((function(e){return e.phx_ref})),u=n.metas.map((function(e){return e.phx_ref})),c=t.metas.filter((function(e){return u.indexOf(e.phx_ref)<0})),l=n.metas.filter((function(e){return r.indexOf(e.phx_ref)<0}));c.length>0&&(s[e]=t,s[e].metas=c),l.length>0&&(a[e]=i.clone(n),a[e].metas=l)}else s[e]=t})),this.syncDiff(o,{joins:s,leaves:a},n,r)}},{key:"synchronizeDiff",value:function(e,t,n){var r=t.joins,i=t.leaves,o={};return this.map(r,(function(e,t){o[e]={joinedMetas:t.metas,leftMetas:[],update:t}})),this.map(i,(function(e,t){o[e]?o[e].leftMetas=t.metas:o[e]={joinedMetas:[],leftMetas:t.metas,update:t}})),this.map(o,(function(t,r){var i=r.joinedMetas,o=r.leftMetas,s=r.update,a=i.map((function(e){return e.phx_ref})),u=o.map((function(e){return e.phx_ref})),c=e[t],l={metas:c?c.metas:[]};l.metas=l.metas.filter((function(e){return-1===a.indexOf(e.phx_ref)})).concat(i).filter((function(e){return-1===u.indexOf(e.phx_ref)})),Object.keys(s).forEach((function(e){"metas"!==e&&(l[e]=s[e])})),0===l.metas.length?delete e[t]:e[t]=l,n&&n(t,c,l)})),e}},{key:"syncDiff",value:function(e,t,n,r){var i=this,o=this.clone(t),s=o.joins,a=o.leaves;return n||(n=function(){}),r||(r=function(){}),this.map(s,(function(t,r){var o=e[t];if(e[t]=i.clone(r),o){var s,a=e[t].metas.map((function(e){return e.phx_ref})),u=o.metas.filter((function(e){return a.indexOf(e.phx_ret]=e[t];return n}return Array.from(e)}(u))}n(t,o,r)})),this.map(a,(function(t,n){var i=e[t];if(i){var o=n.metas.map((function(e){return e.phx_ref}));i.metas=i.metas.filter((function(e){return o.indexOf(e.phx_ref)<0})),r(t,i,n),0===i.metas.length&&delete e[t]}})),e}},{key:"list",value:function(e,t){return t||(t=function(e,t){return t}),this.map(e,(function(e,n){return t(e,n)}))}},{key:"map",value:function(e,t){return Object.getOwnPropertyNames(e).map((function(n){return t(n,e[n])}))}},{key:"clone",value:function(e){return JSON.parse(JSON.stringify(e))}}]),e}(),Pb={HEADER_LENGTH:1,META_LENGTH:4,KINDS:{push:0,reply:1,broadcast:2},encode:function(e,t){if(e.payload.constructor===ArrayBuffer)return t(this.binaryEncode(e));var n=[e.join_ref,e.ref,e.topic,e.event,e.payloa,topic:r[2],event:r[3],payload:r[4]})},binaryEncode:function(e){var t=e.join_ref,n=e.ref,r=e.event,i=e.topic,o=e.payload,s=this.META_LENGTH+t.length+n.length+i.length+r.length,a=new ArrayBuffer(this.HEADER_LENGTH+s),u=new DataView(a),c=0;u.setUint8(c++,this.KINDS.push),u.setUint8(c++,t.length),u.setUint8(c++,n.length),u.setUint8(c++,i.length),u.setUint8(c++,r.length),Array.from(t,(function(e){return u.setUint8(c++,e.charCodeAt(0))})),Array.from(n,(function(e){return u.setUint8(c++,e.charCodeAt(0))})),Array.from(i,(function(e){return u.setUint8(c++,e.charCodeAt(0))})),Array.from(r,(function(e){return u.setUint8(c++,e.charCodeAt(0))}));var l=new Uint8Array(a.byteLength+o.byteLength);return l.set(new Uint8Array(a),0),l.set(new Uint8Array(o),a.byteLength),l.buffer},binaryDecode:function(e){var t=new DataView(e),n=t.getUint8(0),r=new TextDecoder;switch(n){case this.KINDS.push:return this.decodePush(e,t,r);case this.KINDS.reply:return this.decodeReply(e,t,r);case this.KINDS.broadcast:return this.decodeBroadcast(e,t,r)}},decodePush:function(e,t,n){var r=t.getUint8(1),i=t.getUint8(2),o=t.getUint8(3),s=this.HEADER_LENGTH+this.META_LENGTH-1,a=n.decode(e.slice(s,s+r));s+=r;var u=n.decode(e.slice(s,s+i));s+=i;var c=n.decode(e.slice(s,s+o));return s+=o,{join_ref:a,ref:null,topic:u,event:c,payload:e.slice(s,e.byteLength)}},decodeReply:function(e,t,n){var r=t.getUint8(1),i=t.getUint8(2),o=t.getUint8(3),s=t.getUint8(4),a=this.HEADER_LENGTH+this.META_LENGTH,u=n.decode(e.slice(a,a+r));a+=r;var c=n.decode(e.slice(a,a+i));a+=i;var l=n.decode(e.slice(a,a+o));a+=o;var f=n.decode(e.slice(a,a+s));a+=s;var p=e.slice(a,e.byteLength);return{join_ref:u,ref:c,topic:l,event:Ob,payload:{status:f,response:p}}},decodeBroadcast:function(e,t,n){var r=t.getUint8(1),i=t.getUint8(2),o=this.HEADER_LENGTH+2,s=n.decode(e.slice(o,o+r));o+=r;var a=n.decode(e.slice(o,o+i));return o+=i,{join_ref:null,ref:null,topic:s,event:a,payload:e.slice(o,e.byteLength)}}},jb=function(){function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};fd(this,e),this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.channels=[],this.sendBuffer=[],this.ref=0,this.timeout=r.timeout||1e4,this.transport=r.transport||cb.WebSocket||Rb,this.establishedConnections=0,this.defaultEncoder=Pb.encode.bind(Pb),this.defaultDecoder=Pb.decode.bind(Pb),this.closeWasClean=!1,this.binaryType=r.binaryType||"arraybuffer",this.connectClock=1,this.transport!==Rb?(this.encode=r.encode||this.defaultEncoder,this.decode=r.decode||this.defaultDecoder):(this.encode=this.defaultEncoder,this.decode=this.defaultDecoder);var i=null;ub&&ub.addEventListener&&(ub.addEventListener("pagehide",(function(e){n.conn&&(n.disconnect(),i=n.connectClock)})),ub.addEventListener("pageshow",(function(e){i===n.connectClock&&(i=null,n.connect())}))),this.heartbeatIntervalMs=r.heartbeatIntervalMs||3e4,this.rejoinAfterMs=function(e){return r.rejoinAfterMs?r.rejoinAfterMs(e):[1e3,2e3,5e3][e-1]||1e4},this.reconnectAfterMs=function(e){return r.reconnectAfterMs?r.reconnectAfterMs(e):[10,50,100,150,200,250,500,1e3,2e3][e-1]||5e3},this.logger=r.logger||null,this.longpollerTimeout=r.longpollerTimeout||2e4,this.params=sb(r.params||{}),this.endPoint=t+"/"+kb,this.vsn=r.vsn||lb,this.heartbeatTimeoutTimer=null,this.heartbeatTimer=null,this.pendingHeartbeatRef=null,this.reconnectTimer=new Ib((function(){n.teardown((function(){return n.connect()}))}),this.reconnectAfterMs)}return pd(e,[{key:"getLongPollTransport",value:function(){return Rb}},{key:"replaceTransport",value:function(e){this.connectClock++,this.closeWasClean=!0,this.reconnectTimer.reset(),this.sendBuffer=[],this.conn&&(this.conn.close(),this.conn=null),this.transport=e}},{key:"protocol",value:function(){return location.protocol.match(/^https/)?"wss":"ws"}},{key:"endPointURL",value:function(){var e=Mb.appendParams(Mb.appendParams(this.endPoint,this.params()),{vsn:this.vsn});return"/"!==e.charAt(0)?e:"/"===e.charAt(1)?this.protocol()+":"+e:this.protocol()+"://"+location.host+e}},{key:"disconnect",value:function(e,t,n){this.connectClock++,this.closeWasClean=!0,this.reconnectTimer.reset(),this.teardown(e,t,n)}},{key:"connect",value:function(e){var t=this;e&&(console&&console.log("passing params to connect is deprecated. Instead pass :params to the Socket constructor"),this.params=sb(e)),this.conn||(this.connectClock++,this.closeWasClean=!1,this.conn=new this.transport(this.endPointURL()),this.conn.binaryType=this.binaryType,this.conn.timeout=this.longpollerTimeout,this.conn.onopen=function(){return t.onConnOpen()},this.conn.onerror=function(e){return t.onConnError(e)},this.conn.onmessage=function(e){return t.onConnMessage(e)},this.conn.onclose=function(e){return t.onConnClose(e)})}},{key:"log",value:function(e,t,n){this.logger(e,t,n)}},{key:"hasLogger",value:function(){return null!==this.logger}},{key:"onOpen",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.open.push([t,e]),t}},{key:"onClose",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.close.push([t,e]),t}},{key:"onError",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.error.push([t,e]),t}},{key:"onMessage",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.message.push([t,e]),t}},{key:"ping",value:function(e){var t=this;if(!this.isConnected())return!1;var n=this.makeRef(),r=Date.now();this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:n});var i=this.onMessage((function(o){o.ref===n&&(t.off([i]),e(Date.now()-r))}));return!0}},{key:"clearHeartbeats",value:function(){clearTimeout(this.heartbeatTimer),clearTimeout(this.heartbeatTimeoutTimer)}},{key:"onConnOpen",value:function(){if(this.hasLogger()){var e=this.endPointURL().replace(/access_token=([^&#/]+)/,"access_token=-pruned-");this.log("transport","connected to "+e)}this.closeWasClean=!1,this.establishedConnections++,this.flushSendBuffer(),this.reconnectTimer.reset(),this.resetHeartbeat(),this.stateChangeCallbacks.open.forEach((function(e){return(0,hd(e,2)[1])()}))}},{key:"heartbeatTimeout",value:function(){var e=this;this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null,this.hasLogger()&&this.log("transport","heartbeat timeout. Attempting to re-establish connection"),this.triggerChanError(),this.closeWasClean=!1,this.teardown((function(){return e.reconnectTimer.scheduleTimeout()}),1e3,"heartbeat timeout"))}},{key:"resetHeartbeat",value:function(){var e=this;this.conn&&this.conn.skipHeartbeat||(this.pendingHeartbeatRef=null,this.clearHeartbeats(),this.heartbeatTimer=setTimeout((function(){return e.sendHeartbeat()}),this.heartbeatIntervalMs))}},{key:"teardown",value:function(e,t,n){var r=this;if(!this.conn)return e&&e();this.waitForBufferDone((function(){r.conn&&(t?r.conn.close(t,n||""):r.conn.close()),r.waitForSocketClosed((function(){r.conn&&(r.conn.onopen=function(){},r.conn.onerror=function(){},r.conn.onmessage=function(){},r.conn.onclose=function(){},r.conn=null),e&&e()}))}))}},{key:"waitForBufferDone",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;5!==n&&this.conn&&this.conn.bufferedAmount?setTimeout((function(){t.waitForBufferDone(e,n+1)}),150*n):e()}},{key:"waitForSocketClosed",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;5!==n&&this.conn&&this.conn.readyState!==hb?setTimeout((function(){t.waitForSocketClosed(e,n+1)}),150*n):e()}},{key:"onConnClose",value:function(e){this.hasLogger()&&this.log("transport","close",e),this.triggerChanError(),this.clearHeartbeats(),this.closeWasClean||this.reconnectTimer.scheduleTimeout(),this.stateChangeCallbacks.close.forEach((function(t){return(0,hd(t,2)[1])(e)}))}},{key:"onConnError",value:function(e){this.hasLogger()&&this.log("transport",e);var t=this.transport,n=this.establishedConnections;this.stateChangeCallbacks.error.forEach((function(r){(0,hd(r,2)[1])(e,t,n)})),(t===this.transport||n>0)&&this.triggerChanError()}},{key:"triggerChanError",value:function(){this.channels.forEach((function(e){e.isErrored()||e.isLeaving()||e.isClosed()||e.trigger(wb)}))}},{key:"connectionState",value:function(){switch(this.conn&&this.conn.readyState){case fb:return"connecting";case pb:return"open";case db:return"closing";default:return"closed"}}},{key:"isConnected",value:function(){return"open"===this.connectionState()}},{key:"remove",value:function(e){this.off(e.stateChangeRefs),this.channels=this.channels.filter((function(t){return t.joinRef()!==e.joinRef()}))}},{key:"off",value:function(e){for(var t in this.stateChangeCallbacks)this.stateChangeCallbacks[t]=this.stateChangeCallbacks[t].filter((function(t){var n=hd(t,1)[0];return-1===e.indexOf(n)}))}},{key:"channel",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=new Nb(e,t,this);return this.channels.push(n),n}},{key:"push",value:function(e){var t=this;if(this.hasLogger()){var n=e.topic,r=e.event,i=e.payload,o=e.ref,s=e.join_ref;this.log("push",n+" "+r+" ("+s+", "+o+")",i)}this.isConnected()?this.encode(e,(function(e){return t.conn.send(e)})):this.sendBuffer.push((function(){return t.encode(e,(function(e){return t.conn.send(e)}))}))}},{key:"makeRef",value:function(){var e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}},{key:"sendHeartbeat",value:function(){var e=this;this.pendingHeartbeatRef&&!this.isConnected()||(this.pendingHeartbeatRef=this.makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.heartbeatTimeoutTimer=setTimeout((function(){return e.heartbeatTimeout()}),this.heartbeatIntervalMs))}},{key:"flushSendBuffer",value:function(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach((function(e){return e()})),this.sendBuffer=[])}},{key:"onConnMessage",value:function(e){var t=this;this.decode(e.data,(function(e){var n=e.topic,r=e.event,i=e.payload,o=e.ref,s=e.join_ref;o&&o===t.pendingHeartbeatRef&&(t.clearHeartbeats(),t.pendingHeartbeatRef=null,t.heartbeatTimer=setTimeout((function(){return t.sendHeartbeat()}),t.heartbeatIntervalMs)),t.hasLogger()&&t.log("receive",(i.status||"")+" "+n+" "+r+" "+(o&&"("+o+")"||""),i);for(var a=0;a<t.channels.length;a++){var u=t.channels[a];u.isMember(n,r,i,s)&&u.trigger(r,i,o,s)}for(var c=0;c<t.stateChangeCallbacks.message.length;c++){(0,hd(t.stateChangeCallbacks.message[c],2)[1])(e)}}))}},{key:"leaveOpenTopic",value:function(e){for(var t=void 0,n=0;n<this.channels.length;n++){var r=this.channels[n];if(r.topic===e&&(r.isJoined()||r.isJoining())){t=r;break}}t&&(this.hasLogger()&&this.log("transport",'leaving duplicate topic "'+e+'"'),t.leave())}}]),e}(),Lb=function(e,t){return t.onlyLongPollEnabled?Rb:window.WebSocket?window.navigator.onLine?e.transport===window.WebSocket?Rb:window.WebSocketunction(e){return e&&"error"===e.type}(e)};function Ub(e){var t={onlyLongPollEnabled:!1,connectionTriedOnce:!1,avoidLongPollWorkerInterval:6e5},n=void 0,r=function(n,r){t.onlyLongPollEnabled=!0,e.disconnect((function(){e.transport=Rb,r&&r(n),e.connect()}))},i=void 0;return{ensureConnected:function(i){var o=i.onInitialTry,s=i.onInitialError,a=i.avoidLongPollWorkerInterval;if(!t.connectionTriedOnce){o&&o(),"number"==typeof a&&(t.avoidLongPollWorkerInterval=a);try{e.connect(),e.conn.readyState===window.WebSocket.CLOSED&&r(null,s)}catch(e){r(e,s)}t.connectionTriedOnce=!0,n=function(e,t){if(t.avoidLongPollWorkerInterval>0&&!t.onlyLongPollEnabled){var n=setInterval((function(){if("open"===e.connectionState()&&e.transport===Rb){var n=Lb(e,t);if(e.transport!==n)return e.transport=n,e.disconnect((function(){return e.connect()}))}}),t.avoidLongPollWorkerInterval);return function(){return clearInterval(n)}}}(e,t)}},selectNewTransport:function(n){qb(n)&&qb(i)||(e.transport=Lb(e,t),i=n)},stop:function(){n&&n()}}}var Db=function(){return"hidden"===document.visibilityState},Vb=function(){return window.navigator.onLine},Fb=function(e){return"object"===(void 0===e?"undefined":ld(e))?e&&e.reason:e},Bb=function(e){for(var t=[],n=0;n<e.length;n++)for(var r=0;r<e[n].length;r++)t.push(e[n][r]);return t},Hb=function(e){return e===window.WebSocket?"WebSocket":e===Rb?"LongPoll":"unknown"},Wb=function(e){return"object"===(void 0===e?"undefined":ld(e))?e&&e.reason:e},Gb={metrics:{}};function zb(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{logPrefix:"PubSub"},i=r.logPrefix,o=0,s=!1;n=n||Gb;var a=function(e){n.metrics.connectionMetric&&n.increment(n.metrics.connectionMetric,e)},u=function(t){var n={transport:Hb(e.transport),online:Vb(),visibility_state:document.visibilityState,error_count:o};return dd({},n,t)},c=function(t,n){return["transport:"+((n||{}).transport||Hb(e.transport)),"online:"+Vb()].concat(t)},l=function(){s=!0,a(c(["action:connected"])),t.info(i+" socket opened",u({}))},f=function(e){if(e){var n=Hb(window.WebSocket),r=u({reason:e.reason,type:e.type,code:e.code&&e.code.toString(),transport:n}),o=c(["action:disconnected","type:"+e.type,"code:"+e.code],{transport:n});e.wasClean?(a(o.concat(["reason:closed"])),t.info(i+" connection disconnected cleanly",r)):Db()?(a(o.concat(["reason:closed"])),t.info(i+" connection disconnected while tab was hidden",r)):(a(o.concat(["reason:closed"])),t.info(i+" connection disconnected",r))}else{var s=Hb(Rb),l=u({reason:"unknown",type:"unknown",code:"unknown",transport:s}),f=c(["action:disconnected","type:unknown","reason:unknown","code:unknown"],{transport:s});a(f),t.info(i+" connection disconnected",l)}},p=function(e){var n=e&&e.type||"unknown";o+=1;var r=e&&e.target?u({type:n}):u({type:n,error:e});Db()?t.info(i+" connection error while tab was hidden",r):Vb()?1!==o||s?(a(c(["action:error"])),t.warn(i+" socket connection error",r)):t.info(i+" socket connection error while attempting to establish the connection first time",r):t.info(i+" connection error while user was offline",r)},d=function(n){return t.info(i+" failed to connect with initial transport",{new_transport:Hb(e.transport),error:Wb(n)})},h=function(){return a(c(["action:connect"]))};return{onOpen:l,onClose:f,onError:p,onInitialTry:h,onInitialConnectError:d}}var Jb=function(e,t){var n=t.enabled,r=t.logPrefix;return n?function(t,n,i){return e.info(r+" "+t+": ),window.addEventListener("online",e)},Qb="[Channel Phoenix]",Kb={initialDelay:500,maxDelay:1e4,factor:1.2};function Xb(e){var t=e.logger,n=e.serverURL,r=e.phoenixLogsEnabled,i=e.getAccessToken,o=e.transport,s=e.socketOverride,a=function(e){var t=e.initialDelay,n=e.maxDelay,r=e.factor,i=e.jitter,o=e.random;n||(n=6e4),void 0===r&&(r=2),void 0===i&&(i=.5),o||(o=Math.random);var s=null,a=function(e){var a=t*Math.pow(r,e);s&&(a=Math.max(a,s),s=null);var u=o(),c=Math.floor(u*i*a),l=Math.floor(10*u)%2==0?a-c:a+c;return Math.min(l,n)};return a.setNextDelayMinimum=function(e){s=e},a.maximizeNextDelay=function(){return a.setNextDelayMinimum(n)},a}(Kb),u=n.split("?")[0],c={loggers:function(){return{access_token:i()}},reconnectAfterMs:a,timeout:864e5,transport:o};o&&o.customSerializer&&(c.decode=o.decode,c.encode=o.encode);var l=s||new jb("wss://"+u,c),f=new Ub(l),p=new zb(l,t,null,{logPrefix:Qb});l.onOpen((function(){p.onOpen()})),l.onClose((function(e){p.onClose(e)})),l.onError((function(e){if("number"==typeof e)switch(e){case 403:t.info(Qb+" Detected likely pubsub authentication error, reconnecting after max delay"),a.setNextDelayMinimum(Kb.maxDelay);break;case 410:break;case 500:t.info(Qb+" PubSub connection disconnected with error 500");break;case 503:var n=Kb.maxDelay/2;t.info(Qb+" PubSub unavailable, postponing reconnecting for at least "+n+" ms"),a.setNextDelayMinimum(n);break;default:return t.error(Qb+" Received unhandled pubsub error status "+e+", stopping reconnecting"),void l.disconnect()}p.onError(e),f.selectNewTransport(e)}));var d=void 0,h=function(e){var n=e.checkInterval,r=e.cutoff,i=Date.now();clearInterval(d),d=setInterval((function(){if(l.channels.length>0)i=Date.now();else{var e=Date.now()-i;e>=r&&(t.info(Qb+" Disconnecting from PubSub due to idle",{idle_for:e}),l.disconnect(),clearInterval(d))}}),n||6e4)},v=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};f.ensureConnected({onInitialTry:function(){return p.onInitialTry},onInitialError:function(e){return p.onInitialConnectError(e)}}),l.connect(),e.idleDisconnectCutoff>0&&h({checkInterval:e.idleCheckInterval,cutoff:e.idleDisconnectCutoff})},b=l.disconnect.bind(l),m=l.channel.bind(l),g=function(e,t){var n=e.disconnect,r=e.connect,i=e.triggerChanError,o=!1;return function(e){if(!e&&!o){t.info("Forcefully reconnecting to the socket"),o=!0;try{i()}catch(e){t.wrChanError",e)}n((function(){r(),o=!1}))}}}({disconnect:b,connect:v,triggerChanError:l.triggerChanError.bind(l)},t);return{connect:v,disconnect:b,channel:m,forceReconnect:g,socket:l}}var $b="phoenix_signaler.proxy_channel",Zb=function(e){return dd({},e,{event:"phx_reply",payload:{response:{},status:"ok"}})};function em(e,t){var n=this;this.skipHeartbeat=!0,this.readyState=1,setTimeout((function(){return n.onopen()})),e.onmessage=function(e){n.onmessage(e)},this.send=function(t){e.postMessage(t)},this.close=function(){}}var tm=function(e){var t=em.bind(null,e);return t.customSerializer=!0,t.deco)},t.encode=function(e,t){return t(e)},t};function nm(){var e=void 0;return{listenForProxyTransport:function(t){var n=t.logger,kOrigin;i=i||function(e){return e===r};var o=function(t){if(t.source===window.parent&&t.data===$b)if(i(t.origin)){var r=t.ports[0];e=tm(r)}else n.warn("Received CrossFrameMultiplexer message from unexpected origin, discarding",{origin:t.origin})};window.addEventListener("message",o);return function(){return window.removeEventListener("message",o)}},getProxyTransport:function(){return e},creainRefs={},this.outboundMessageRefs={}}returoinRefs[e]={innerJoinRef:t,channel:n}}},{key:"registerInnerLeave",value:function(e){var t=this.joinRefs[e].channel;return delete this.joinRefs[e],t}},{key:"isFresh",value:function(e,t){return this.joinRefs[e]&&this.joinRefs[e].innerJoinRef===t}},{key:"registerOutboundMessage",value:function(e,t,n){return this.outboundMessageRefs[t]=n,this.joinRefs[e].channel}},{key:"processMessageFromBackend",value:function(e){var t=e.topic,n=e.event,r=e.payload,i=e.ref,o=this.joinRefs[t];if(o&&(!i||this.outboundMessageRefs[i])){var s=i&&this.outboundMessageRefs[i];return delete this.outboundMessageRefs[i],{topic:t,event:n,payload:r,ref:s,join_ref:o.innerJoinRef}}}}]),e}();function im(){return{proxyTo:function(e){var t=e.allowedDomain,n=e.phoenixSocket,r=e.iFrame,i=e.logger,o=new MessageChannel,s=new rm,a=[];o.port1.onmessage=function(e){var t=e.data,r=t.topic,u=t.event,c=t.join_ref,l=t.ref;if("phx_join"===u){var fic===t&&(e.isJoined()||e.isJoining())}))}(n,r);if(f)return s.registerInnerJoin(r,c,f),void o.port1.postMessage(Zb(e.data));var p=n.chion(){o.port1.postMessage(Zb(e.data))})).receive("error",(function(e){i.warn("Failed to join extra channel in proxy transport",{topic:r,error:e})})),a.push(p),void s.registerInnerJoin(r,c,p)}if("phx_leave"!==u)if(s.isFresh(r,c)){var d=n.makeRef(),h=s.registerOutboundMessage(r,d,l);e.data.ref=d,e.data.join_ref=h.joinRef(),n.push(e.data)}else i.info("Discarding stale proxy push",{topic:r,event:u});else{if(s.isFresh(r,c)){var v=s.registerInnerLeave(r);v&&-1!==a.indexOf(v)&&(a.splice(a.indexOf(v),1),v.leave())}else i.info("Discarding stale proxy phx_leave instruction",{topic:r});o.port1.postMessage(Zb(e.data))}},r.contentWindow.postMessmBackend(e);t&&o.port1.postMessage(t)}));return function(){a.forEach((function(e){return e.leave()})),n.off([u]),oreturn{asInner:new nm,asOuter:new im}},um=function(e){if(e)return[{name:"cobrowse",unique:!0}]},cm=function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=function(e,i){var o={0:e,1:i};r.length>0&&(o[2]=r),t.push("send",o).receive("error",(function(r){t.isClosed()||n.warn("Failed to push channel message",{eventName:e,error:r})})).receive("timeout",(function(){t.isClosed()||n.warn("Failed to push channel message due to timeout",{eventName:e})}))},o=function(i){return e(t,n,r.concat([i]))};return{emit:i,toTag:o}},lm=function(e,t,n){var r={},i=!1;return{on:function(o,s){if(i)t.warn("Tried to add eventHandler to stopped channel",{topic:n,eventName:o});else{var a=e.on(o,function(e){return function(t){t&&t.__value?e(t.__value):e(t)}}(s));!function(e,t,n){r[e]=r[e]||[],r[e].push({handler:t,ref:n})}(o,s,a)}},off:function(t,n){var i=function(e,t){var n=(r[e]||[]).filter((function(e){return e.handler===t}));ter((function(e){return e.handler!==t})),n[e.off(t,i)},stop:function(){i=!0,r={}}}};function fm(e){var t=e.url,n=e.getAccessToken,r=e.isActiveTab,i=e.logger,o=e.callback,s=e.clientOverride,a=e.idleDisconnectCutoff,u=om,c=am.asInner.getProxyTransport();u||(u=s||new Xb({logger:i,serverURL:t,phoenixLogsEnabled:!1,getAccessToken:n,transport:c}),om=u);var l=[],f=!1,p=function(e){try{return e.split("?")[1].match(/topic=([^&]+)/)[1]}catch(e){throw new Error("Cannot find topic in chnnel(p,(function(){return{tags:um(r)}})),h=cm(d,i),v=lm(d,i,p),b=function(e){var t=[],n=new Cb(e),r=function(e,t){return t.metas.map((function(t){return new ob({id:e.match(/visitor/)?"visitor":e,socketId:t.connection_id,tags:t.tags.map((function(e){return e.name}))})}))},i=Bb(n.list(r));return n.onSync((function(){i=Bb(n.list(r)),t.forEach((function(e).filter((function(t){return t!==e}))}}}}(d).onParticipantState,m=function(){d.leave(),l.forEach((function(e){return e.call()})),l=[],v.stop(),f=!0},g=function(e){var t=e.name,n=e.unique?[{name:t,unique:!0}]:[{name:t}];d.puo register tag",{erroter tag due to timeout",{tag_name:t})}))},y={url:t,on:v.on,off:v.off,onParticipantState:b,emit:h.emit,emitAll:h.emit,toTag:h.toTag,registerTag:g,registerUniqueTag:function(e){var t=e.name;g({name:t,unique:!0})},authorize:function(){},proxyToIframe:function(e,t){return am.asOuter.proxyTo({allowedDomain:t,phoenixSocket:d.socket,logger:i,iFrame:e})},close:m,destroy:m,addDestroyListener:function(e){l.push(e)},isStopped:function(){return f}};return function(e){var t=!1;(arguments.length>1&&void 0!==arguments[1]?arguments[1]:Y(t)return t=!1,e()}),(function(){t=!0}))}((function(){return function(e,t){var n=arguments.length>2&&void 0!==argumeni=void 0ng((function(e){i=setTimeout((function(){return o(!1)}),n):o(!1)}(u.forceReconnect,u.socket)})),{start:function(){u.connect({idleDisconnectCutoff:a||3e5});var e=void 0,t=!1;d.join().receive("ok",(function(){t||o(null,y),t=!0,i.info("Joining engagement channel succeeded",{topic:p})})).receive("error",(function(t){t&&"join crashed"===t.reason?i.info("Joining engagement channel failed with crash, retrying",{topic:p}):"unauthorized"===t&&(!e||e<Date.now()-1e4)?(i.info("Joining engagement channel failed due to unauthorized, reconnecting to refresh server side user state",{topic:p}),e=Date.now(),u.disconnect((function(){return u.connect()}))):(i.warn("Joining engagement channel failed",{topic:p,error:Fb(t)}),d.leave(),o({reason:t},null))})).receive("timeout",(function(){i.warn("Joining engagement channel failed",{topic:p,reason:"timeout"}),o({reason:"timeout"},null)}))}}}var pm="channel:meta",dm="current-participants",hm="authorization-response",vm=function(e){return function(t){if(t.type===dm){var n=t.participants.map(ob.build);e(n)}}},bm=function(){function e(t){var n=this,r=t.socket,i=t.url,o=t.id,s=t.logger;fd(this,e),this.url=i,this.id=o,this.socket=r,this.logger=s,this._stopped=!1,this._destroyListeners=[],this.emitter=new ib(this.socket),this.emitAll=this.emitter.emit,this.emit=this.emitter.emit,["on","once"].forEach((function(e){n[e]=function(t,r){if(n._stopped)n.logger.warn("Tried to add eventHandler to stopped channel",{eventType:t});else{if(t===pm)throw new Error("Don't set meta message listeners directly, use specialized functions");n.socket[e](t,r)}}}))}return pd(e,null,[{key:"join",value:function(t){var n=t.url,r=t.id,i=t.isInitiallyActive,o=t.options,s=t.callback,a=t.getAccessToken,u=t.logger,c=t.idleDisconnectCutoff;if(u=u||sm.logger,n.match(/engagement_signaler/)){new fm({url:n,getAccessToken:a,isActiveTab:i,logger:u,callback:s,idleDisconnectCutoff:c}).start()}else{var l=rb.establish({url:n,id:r,isActiveTab:i,options:o,logger:u}),f=new e({socket:l,url:n,id:r,logger:u});f.start(),f"cnnion(){o(),t()},i=function(e){o(),n(e)},e.on("cct_error",i)}(l,(function(){s(null,f)}),(function(e){f.close();var t=new Error("Engagement.Kluster: Could not establish channel");t.channelUrl=n,t.reason=e,s(ue:function(e,t){this.socket.off(e,t)}},{key:"removeAllListeners",value:function(e){this.socket.removeAllListeners(e)}},{key:"onParticipantState",value:function(e){var t=this;if(!this._stopped){this._lastKnownParticipantState&&e(this._lastKnownParticipantState);v,function(){return t.socket.off(pm,n)}}this.logger.warn("Tried to add eventHandler to stopped channel",{eventType:pm})}},{key:"authorize",value:function(e,t){var n=this,r=function e(r){r.type===hm&&(n.socket.off(pm,e),r.success?(n.logger.info("Engagement.Kluster: Channel authorization succeeded",{url:n.url}),t&&t(!0)):(n.logger.warn("Engagement.Kluster: Channel authorization failed",{url:n.url}),t&&t(!1)))},i=function(){n.socket.on(pm,r),n.emitter.authorize(e())};return this.socket.on("reconnect",i),i(),function(){n.socket.off(pm,r),n.socket.off("reconnect",i)}}},{key:"toTag",value:function(e){return this.emitter.in(e)}},{key:"start",value:function(){var e=this;this.socket.on(pm,vm((function(t){e._lastKnownParticipantState=t}))),this.socket.on("disconnect",(function(t){e.logger.info("Engagement.Kluster: Channel disconnected",{url:e.url,reason:t})})),this.socket.on("connect_error",(function(t){e.logger.warn("Engagement.Kluster: Channel connection error",{url:e.url,error:t})}))}},{key:"destroy",value:function(){null===this.socket||this._stopped||this.socket.emit("close_channel"),this.close()}},{key:"close",value:function(){var e=this;return mm(this.emitter,(function(e){return e.stop()})),null===this.socket||this._stopped||(this._stopped=!0,setTimeout((function(){return e.socket.disconnect()}),50)),this.cleanUp(),mm(this.socket,(function(e){return e.removeAllListeners(return this._destroyListeners.push(e)}},{key:"registerTag",value:function(e){var t=e.name;this.socket.emit("register_tags",[{name:t}])}},{key:"registerUniqueTag",value:function(e){var t=e.name;this.socket.emit("register_tags",[{namee.call()})),this._destroyListeners=[]}},{key:"isStopped",value:fuon mm(e,t){return null!=e?t(e):void 0}bm.listenForProxyTransport=function(e){return am.asInner.listenForProxyTransport(e)};var gm=function(){},ym={},_m=function(e){return ym[e]?ym[e].promi){_m(t)===e&&function(e){delete ym[e]}(t)},Em=function(e,t,n){n.ter((function(){return wm(n,e.otherId)}))}),gm),ym[e]={promise:n,url:t}},Om=_m,Sm="Engagement.Kluster",Tm=function(e){var t=e.isActiveTab,n=e.participantId,r=e.operatorId,i=e.channelUrl,o=e.getAccessToken,s=e.stats,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:bm,u=s.withTags(["protocol:websocket"]).instrument({namespace:"join-channel"}).attempted(),c={operator_id:r,channel_url:i,is_active_tab:t};Yu.log("".concat(Sm,": Channel join started"),c);var l=new Promise((function(e,r){var s={timeout:3e4,reconnectionDelay:2e3,reconnectionDelayMax:3e3,randomizationFactor:.5,reconnectionAttempts:15,upgrade:!0};a.join({url:i,id:n,isInitiallyActive:t,options:s,getAccessToken:o,logger:Yu,callback:function(t,n){t?(Yu.warn("".concat(Sm,": Channel join failed"),I.merge(c,{error:t})),u.failed(),r(t)):(n.authorize(o),Yu.info("".concat(Sm,": Channel join succeeded"),c),u.succeeded(),n.observable=function(e){return Zc(n,e)},e(n))}})}));return Em(r,i,l),ju.Observable.fromPromise(l)},km=["scroll","keyup","mousemove"];function Am(e){var t=e.getAccessToken,n=e.stats,r=e.start,i=e.stop,o=e.hideMouse,s=e.createChannelObservable,a=e.dynamicImport;s||(s=Tm),a||(a=tc);var u=r.pipe(vi(),zo((function(e){return s({channelUrl:e,participantId:"source",isActiveTab:!0,getAccessToken:t,stats:n})})),fo(1),Te());this.sourceObservable=u.pipe(an((function(e){return a("Cobra").map((function(t){return{Cobra:t,channel:e}}))})),kt((function(e){var t=e.Cobra,n=e.channel;return new t.SourceInitializer(n,Zf()).initialize()})),fo(),Te()),this.stopSourceObservable=this.sourceObservable.pipe(zo((function(e){return i.pipe(Ei(1),kt((function(){return e})))})),Fr((function(){return ju.Observable.empty()}))),this.hideMouseObservable=u.pipe(zo((function(e){return o.pipe(Ko(i),kt((function(){return e})))})),Fr((function(){return ju.Observable.empty()})))}var xm,Im,Nm=function(){function e(t,n,r,i){s(this,e),this._sendActivityFromCobrowsableIframe=this._sendActivityFromCobrowsableIframe.bind(this),this.windowMessenger=t,this.channelUrl=n,this.getAccessToken=r,this.stats=i}return u(e,[{key:"boot",value:function(){this._activityObservable().subscribe(this._sendActivityFromCobrowsableIframe);var e=new Am({getAccessToken:this.getAccessToken,stats:this.stats,start:this._startObservable(),stop:this._stopObservable(),hideMouse:this._hideMouseObservable()});e.sourceObservable.subscribe((function(){return Yu.log("Soursitor cobrowsable iframe ".concat(e))})),e.stopSourceObservable.subscribe((function(e){return e.stop()}),Yu.error.bind(Yu,"cobra stop subscription err("cobrowse").emit("cobra:hide_mouse")}),Yu.error.bind(Yu,"cobra hide mouse subscription error")),Yu.info("Started for visitor Nested CoBrowsable iFrame")}},{key:"_startObservable",value:function(){var e=this.channelUrl?ju.Observable.of(this.channelUrl):ju.Observable.empty();return this._cobrowsableFrameInviteObservable(this.windowMessenger).share().merge(e)}},{key:"_stopObservable",value:function(){return this.windowMessenger.observable("cobra:cobrowsable_iframe:stop")}},{key:"_hideMouseObservable",value:function(){return this.windowMessenger.observable("cobra:hide_mousriodicalActivityTracker.getStream(km)}},{key:"_cobrowsableFrameInviteObservable",value:function(e){return ju.Observable.create((function(t){return e.respondTo("cobra:cobrowsable_iframe:join_channel_and_cobrowse",(function(e,n){var r=e.url;return n(),t.next(r)}))}))}},{key:"_set("activity_from_cobrowsable_iframe")}}]),e}(),Mm=new Error("Tried to connect internal visitor state subscription after already connected"),Rm=null,Cm=I.compose(I.map(I.pick(["id","site_id","operator_id"])),I.pathOr([],["engagement","observations"])),Pm=I.compose(I.map(I.pick(["id","site_id","operator_id","outcome"])),I.pathOr([],["engagement","requests"])),jm=["id","site_id","status","sub_engagement_id","visitor","restarted_m=function(e){return I.map(I.pick(e))},qm=I.map((function(e){return I.merge(e,{visitor:I.pick(["authenticated","browser_tab_id"],e.visitor)})})),Um=I.compose(qm,Lm(jm),I.pathOr([],["engagement","engagements"])),Dm=I.compose(I.map(I.pick(["id","site_id","state"])),I.pathOr([],["omniq","queue_tickets"])),Vm=function(e,t){return I.pathOr({},["routing","".concat(sm.siteId),"".concat(t)],e)},Fm=I.compose(qm,Lm(I.append("end_reason",jm)),I.pathOr([],["engagement","ended_engagements"])),Bm=function(e){var t=e.pubsub,n=e.tabId,r=e.allowConnectingMultipleTimes,o=e.visitorIdObservable,s=void 0===o?Du():o;return Rm&&!r?Yu.error(Mm):((Rm=s.switchMap((function(e){return t.joinChannel("visitor_state:".concat(e)).flatMap((function(e){return(0,e.observable)("change",{leaveChannelOnDispose:!0})})).map((function(t){return i(i({},t||{}),{},{visitor_id:e})}))})).do((function(e){return function(e,t){return Yu.info("Received internal visitor state",{routing:Vm(e,t),observations:Cm(e),engagement_requests:Pm(e),engagements:Um(e),ended_engagements:Fm(e),queue_tickets:Dm(e)})}(e,n)})).publishReplay(1)).connect(),Rm)},Hm=sm.logger,Wm=function(e){var t=e.status,n=e.body,r=e.error;if(t>=200&&t<300)return ju.Observable.of(n);var i=I.find(I.compose(I.not,I.isNil),[r,n,"unknown"]);return I.is(String,i)?ju.Observable.throw({status:t,reason:i}):ju.Observable.throw(I.merge({status:t},i))},Gm=function(e){return I.is(Object,e)&&"timeout"===e.type?ju.Observable.throw(new vf({cause:rf.SALEMOVE.NETWORK_TIMEOUT})):ju.Observable.throw(e)},zm=I.propEq("persisted",!0);I.has("onpagehide",window)?(xm=ju.Observable.fromEvent(window,"pageshow").share(),Im=ju.Observable.fromEvent(window,"pagehide").share()):(xm=ju.Observable.fromEvent(window,"load").share(),Im=ju.Observable.fromEvent(window,"unload").share());var Jm={unloadMaybeToPageCache:Im,loadFromPageCache:,Qm=function(e){return"sm.".concat(e)},Km={set:function(e,t){sessionStorage.setItem(Qm(e),function(e){return JSON.strn JSON.parse(e)}catch(e){return null}}(n(e){sessionStorage.removeItem(Qm(e))},removeAll:function(){for(var e=0;e<sessionStorage.length;e++){var t=sessionStorage.key(e);Ym.test(t)&&sessionStorage.removeItem(t)}}};var Xm=function(){function e(t){var n=t.urlParams,r=t.storage,i=t.unloadMaybeToPageCache,o=t.loadFromPageCache,a=t.windowNameStorage,u=t.sessionContext,c=t.tabIdFromConfiguration;s(this,e),this.markAsAlive=this.markAsAlive.bind(this),this.markAsUnloaded=this.markAsUnloaded.bind(this),this.urlParams=n,this.storage=r,this.unloadMaybeToPageCache=i,this.loadFromPageCache=o,this.windowNameStorage=a,this.sessionContext=u,this.tabIdFromConfiguration=c}return u(e,[{key:"init",value:function(){this.localTabId=this._createOrReuseId(),this.markAsAlive(),this.unloadMaybeToPageCache.subscribe(this.markAsUnloaded,sm.logger.error),this.loadFromPageCache.subscribe(this.markAsAlive,sm.logger.error)}},{key:"markAsAlive",value:function(){this._changeTabStatus(n(){this._changeTabStatus("unloaded")}},{key:"getId",value:function(){return this.localTabId}},{key:"_createOrReuseId",value:function(){var e;if(e=this.tabIdFromConfiguration||this._findIdFromSessionContext()||this._findIdFromWindowName()||this._findIdFromUrlParams()||this._findIdFromStorage())return e;var t,n=(t=new Uint32Array(2),(window.crypto||window.msCrypto).getRandomValues(t),(t[0]*t[1]).toString(36).replace(".","").substring(0,11));return sm.logger.info("No existing tab ID found, generated new tab ID",{new_tab_id:n}),n}},{key:"_changeTabStatus",value:function(e){var t=this.storage.get("tab_ids")||{};return t[this.localTabId]=e,this.storage.set("tab_ids",t),this.windowNameStorage.setItem("tab_ids",t)}},{key:"_findIdFromStorage",value:function(){var e;return(e=this._findIdFromTabIds(this.storage.get("tab_ids")||{}))?(sm.logger.info("Found tab ID from session storage",{found_tab_id:e}),e):null}},ntext?this.sessionContext.tab_id:null}},{key:"_findIdFromWindowName",value:function(){var e,t=this.windowNameStorage.getItem("tab_ids")||{};return(e=this._anyFromTabIds(t))?(sm.logger.info('Found tab ID from "window.name"',{window_name:window.name,found_tab_id:e}),e):null}},{key:"_findIdFromTabIds",value:function(e){for(var t=Object.keys(e),n=0;n<t.length;n++){var r=t[n];if("unloaded"===e[r])r:function(e){return Object.keys(e)[0]}},{key:"_findIdFromUrlParams",value:function(){var e;return(e=this.urlParams.tabId)?(sm.logger.info("Found tab ID from url params",{found_tab_id:e}),e):null}}],[{key:"setup",value:function(t,n){var r=n.sessionContext,i=n.tabIdFromConfiguration,o=new e({urlParams:sm.urlParams,storage:Km,windowNameStorage:t,unloadMaybeToPageCache:Jm.unloadMaybeToPageCache,loadFromPageCache:Jm.loadFromPageCache,sessionContext:r,tabIdFromConfiguration:i});return o.init(),o}}]),e}(),$m=function(e){return function(e){var t=I.propEq("site_id",sm.siteId),n=I.compose(I.any(I.propEq("id",sm.siteId)),I.propOr([],"transferrable_sites")),r=I.pathOr([],["engagement","engagements"],e);try{return I.compose(I.complement(I.isEmpty),I.filter(I.either(t,n)))(r)}catch(t){return void Yu.error("Engagements were undefined in state",{state:e,engagements:r})}}(e)?"engaged":function(e){return I.compose(I.complement(I.isEmpty),I.filter(I.propEq("site_id",sm.siteId)),I.pathOr([],["engagement","observationsturn e.map($m).distinctUntilChanged()},eg="high",tg="low",ng="visitor_priority",rg=I.pathOr([],["omniq","queue_tickets"]),ig=I.pathOr([],["engagement","requests"]),og=I.pathOr([],["engagement","engagements"]),sg=function(e){return function(e){return rg(e).length>0||ig(e).length>0||og(e).length>0}(e)?eg:tg},ag=function(e,t){var n=e.indexOf(t);return n>-1?[e.substring(0,n),e.substring(n+1)]:[e]},ug=function(e,t,n){n||(n="");var r=_(ag(e,"#"),2),i=r[0],o=r[1],s=_(ag(i,"?"),2),a=s[0],u=s[1],c=I.compose(I.join("&"),I.map(I.concat(n)),I.map(I.join("=")),I.map(I.map(encodeURIComponent)),I.toPairs)(t),l=u?"".concat(a,"?").concat(u,"&").concat(c):"".concat(a,"?").concat(c);return o?"".concat(l,"#").concat(o):l},cg=function(){if("function"!=typeof window.getGliaContext)return Promise.resolve({sessionId:null,idToken:null,accessToken:null});try{var e=window.getGliaContext();"function"!=typeof e.then&&(e=Promise.resolve(e));return e.then((function(e){return Promise.resolve(i(i({},{sessionId:null,idToken:null,accessToken:null}),e))}),(function(e){return Yu.warn("getGliaContext() promise rejected",{error:e}),Promise.resolve({sessionId:null,idToken:null,accessToken:null})})).catch((function(e){return Yu.warn("Unexpected error in getGliaContext() promise",{error:e}),Promise.resolve({sessionId:null,idToken:null,accessToken:null})}))}catch(e){return Yu.warn("Unexpected error in getGliaContext()",{error:e}),Promise.resolve({sessionId:null,idToken:null,accessToken:null})}},lg=function(){return ju.Observable.create((function(e){cg().then((function(t){e.next(t),e.complete()}))}))},fg=function(e){var t=e.split(".")[1],n=deccharCodeAt(0).toString(16)).slice(-2)})).join(""));return JSON.parse(n)},pg=function(e){return 1e3*fg(e).exp},dg=function(e){try{var t=fg(e);return(t.exp-t.iat)/2*1e3}catch(e){return Yu.warn("Fetching interval fction(e){return e&&"string"==typeof e},vg=function(e){var t=e.priority,n=e.accessToken,r=e.consolidationSecret,i=e.url,o=e.tabId,s=e.detectVisitorByExternalSessionTokenEnabled,a=e.includeIdToken,u=void 0===a||a;return i||(i=sm.visitorConfigUrl),i=ug(i,{priority:t,tab_id:o}),ju.Observable.create((function(e){var t=new XMLHttpRequest;return t.onreadystatechange=function(){if(4===this.readyState)if(200===this.status){var n=JSON.parse(t.responseText);e.next({accessToken:n.access_token,visitorId:n.visitor_id,authenticatedExternally:Boolean(n.authenticated_externally)}),e.complete()}else e.error({responseText:t.responseText,status:t.status})},function(e){var t=e.detectVisitorByExternalSessionTokenEnabled;return cg().then((function(e){var n=e.sessionId,r=e.idToken,i=e.accessToken;return[t&&hg(n)?"external_session_id=".concat(n):"",hg(r)?"id_token=".concat(r):"",hg(i)?"external_access_token=".concat(i):""]}))}({detectVisitorByExternalSessionTokenEnabled:s}).then((function(e){var o=_(e,3),s=o[0],a=o[1],c=o[2],l=""!==a?"tab_id=".concat(sm.tabId):"",f=[r?"consolidation_token=".concat(encodeURIComponent(r)):null,n?"access_token=".concat(encodeURIComponent(n)):null,s,u?a:"",c,l].filter(I.identity).join("&");t.open("POST",i,!0),t.withCredentials=!0,t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.send(f)})),function(){return t.abort()}}))},bg=function(){function e(t){s(this,e),this.attributes=I.clone(t),this.id=this.attrfunction(e){return this.attributes[e]}},{key:"set",value:functionction(n){var r=e[n];t.attributes[n]=r}))}},{key:"getId",value:function(){return this.get("id")}},{key:"getName",value:function(){return this.get("name")}},{key:"getFormattedName",value:function(){return this.get("formaction(){return this.get("media_type")}},{key:"isOnline",value:function(){return!this.isUnavailab(){return!this.currentlyUnavailablehis.isEngaged()||this.is{return"engaged"===this.ase"video":return 1;default:return 0}}},{key:"getPictureUrl",value:function(){var e=this.get("picture")&&this.get("picture").url,t=sm.conf.visitor_app.always_use_default_operator_picture,n=sm.conf.visitor_app.default_operator_picture.url;if(!n||!t&&e){var r=-1!==sm.conf.assets.server.indexOf("libs.")?"/":sm.conf.assets.prepend;return e||[sm.conf.assets.server,r||"/","default_operator_picture-683dc24fd.png"].join("")on(){return!1===this.get("available")}}]),e}(),mg=function(e){return I.filter(I.contains(I.__,["video"]),e)};function gg(e){return/iPad|ion wg(e,t){return-1!==t.indexOf(e)}function Eg(e){var t=e.match(/OS ((\d+_?){2,3})\s/);if(!t)return!1;var n=t[1].split("_"),r=n[0]+"."+n[1];return parseFloat(r)>=11.3}function Og(e){if(gg(e))return Eg(e);var t=function(e){var t=e.match(/Version\/([0-9]+\.[0-9]*)/);return t&&parseFloat(t[1],10)}(e);return!!t&&t>=11}function Sg(){return[{name:"RTCPeerConnection",pass:Boolean(window.RTCPeerConnection)},{name:"RTCIceCandidate",pass:Boolean(window.RTCIceCandidate)},{name:"AudioContext",pass:Boolean(window.AudioContext)||Boolean(window.webkitAudioContext)},{name:"MediaStream",pass:Boolean(window.MediaStream)}]}function Tg(){return[].concat(w(Sg()),[{name:"getUserMedia",pass:Boolean(window.navigator.mediaDevices)&&Boolean(window.navigator.mediaDevices.getUserMedia)}])}var kg={video:"camera",audio:"microphone"};function Ag(e,t,n){if(null==n)return!0;var r=kg[t];return!!wg(r,n)&&(!yg(e)||!wg("".concat(r," *"),n))}function xg(){var e=window.navigator.userAgent;return!(yg(e)&&gg(e)&&!Eg(e))&&_g(Sg().filter((function(e){return!e.pass})))}function Ig(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.media,n=e.iframeAllow,r=window.navigator.userAgent;if(!Ag(r,t,n))return!1;if(yg(r)&&!Og(r))return!1;var i=Tg().filter((function(e){return!e.pass}));return _g(i)}var Ng=Object.freeze({__proto__:null,canReceiveMedia:xg,canSendMedia:Ig}),Mg="none",Rg="receiver",Cg="duplex",Pg=function(){return xg()?Ig()?Cg:Rg:Mg},jg=["video","audio"],Lg={video:["video","audio","phone","text"],audio:["audio","phone","text"],phone:["phone","text"],text:["text"]},qg=I.lensPath(["state","medias"]),Ug=I.lensPath(["state","oneWayMedias"]),Dg=function(e,t){var n=I.difference(e.state[t],jg);return I.assocPath(["state",t],n,e)},Vg=I.curry((function(e,t){return e===Cg||e===Rg?t:Dg(t,"oneWayMedias")})),Fg=I.curry((function(e,t){return e===Cg?t:Dg(t,"medias")})),Bg=function(e){return I.assocPath(["state","media"],e.state.medias,e)},Hg=I.curry((function(e,t){var n,r=e.enabledMediaType,i=e.webRtcMode;return I.compose(Bg,Vg(i),Fg(i),(n=rturn I.over(qg,I.intersection(Lg[e]))}(r))(t)})),Wg=u((function e(t){var n=t.id,r=t.name,i=t.formattedName,o=t.picture,a=t.state;s(this,e),this.id=n,this.name=r,this.formattedName=i||(null==r?void 0:r.split(" ")[0]),this.picture=o,this.state=a,this.assignment={type:"direct"}})),Gg=function(e){l(n,e);var t=m(n);function n(){return s(this,n),t.apply(this,arguments)}return u(n,[{key:"serialize",value:function(){return new Wg({id:this.getId(),name:this.getName(),formattedName:this.getFormattedName(),picture:this._getPicture(),state:this._gon(){return{url:this.getPictureUrl()}}},{key:"_getState",value:function(){var e=Lg[this.getMediaType()];return{available:this.currentlyAvailable(),medias:e,oneWayMedias:mg(e)}}}]),n}(bg),zg=I.curry((function(e,t){var n=e.enabledMediaType,r=e.webRtcMode,i=new Gg(t.attributes).serialize();return Hg({enabledMediaType:n,webRtcMode:r},i)})),Jg=function(e){var t=e.id,n=e.name,r=e.formattedName,i=e.picture,o=e.mediaType,s=e.webRtcMode,a=e.enabledMediaType,u=new Gg({id:t,name:n,formattedName:r,picture:i,media_type:o});return zg({enabledMediaType:a,webRtcMode:s},u)},Yg=function(e){var t=e.enabledMediaLevel,n=e.webRtcMode,r=function(e,t){return{operator:e,isVisible:void 0!==e.state.available&&e.reactiveEnabled&&(I.isEmpty(t)||!I.isEmpty(I.intersection(e.teamIds,t)))}};return{fromPresence:function(e,i,o){var s=i.state,a=I.pathOr("operator",["operator_information","name"],s),u=I.pathOr(null,["operator_information","picture","url"],s),c=I.pathOr([],["operator_information","teams"],s),l=I.map(I.prop("id"),c),f=I.pathOr(!0,["operator_information","reactive_enabled"],s),p=I.pathOr([],["engagement","media"],s),d=I.has("engagement",s);-1!==p.indexOf("audio")&&p.push("phone");var h={id:e,name:a,picture:{url:u},state:{available:d?!I.isEmpty(p):void 0,media:p,medias:p,oneWayMedias:p},teamIds:l,reactiveEnabled:f};return h=Hg({enabledMediaType:t,webRtcMode:n},h),r(h,o)},updateVisibility:r}},Qg=function e(t,n){t||(t={}),n||(n={});return{omit:function(r){return e(I.dissoc(r,t),I.dissoc(r,n))},set:function(r){var i=r.operator,o=r.isVisible?I.assoc(i.id,i,n):I.dissoc(i.id,n);tion(e){return I.values(t).forEach(e)},immutableFacade:function(){return{get:function(e){var t=n[e];return t?new Wg(t):t},values:function(){return I.map(I.construct(Wg),I.values(n))}}}}},Kg=function(e){var t=e.presence,n=e.presenceMapper,r=e.visibleTeamsObservable,i=e.onChange,o=Qg(),s=[],a=r.subscribe((function(e){s=e,o.forEach((function(e){var t=n.updateVisibility(e,s),r=t.operator,i=t.isVisible;o=o.set({operator:r,isVisible:i}ion(e,t){return n.fromPresence(e,t,s)})).forEach((function(e){var t=e.operator,n=e.isVisible;o=o.set({operator:t,isVisible:n})})),i(o.immutableFacade()),t.onChange((function(e,t,r){if(r.metas.length>0){var a=n.fromPresence(e,r,s),u=a.operator,c=a.isVisible;o=o.set({operator:u,isVisible:c})}else o=o.omit(e);i(o.immutableFacade())}));return{stop:function(){return a.unsubscribe()}}},Xg="salemove",$g=function(e){try{return JSON.parse(e.name)||{}}catch(e){return{}}},Zg=function(e){return""=on(e){rfunction(e){return I.lensPath([Xg,e])},ny=[void 0,null,"javascript:;",""],ry=!1,iy=function(e,t){if(t||(t=sm.conf.navigatable_hostnames),I.contains(e,ny))return!0;var n=ry?t.engaged:t.available;return I.any((function(t){return e.indexOf(t)>-1}))(n)},oy={isInEngagement:ry,setEngagedStatus:function(e){ry=e},extractLinkFromEvent:function(e){try{var t=e.target;return t&&(t=function(e,t){t=t.toUpperCase();do{if(e.nodeName===t)return e}while(e=e.parentNode);return null}(t,"a")),t}catch(e){return null}},isAllowedToNavigate:iy},sy=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.isAllowed,n=void 0===t?iy:t;Wc(document.querySele){return"javascript:void(0)"!==e.href})).filter((function(e){return n(e.hostname)})).forEach((function(e){return e.setAttribute("target","_self")}))},ay=["target","defaultPrevented","ctrlKey","shiftKey","metaKey","button"],uy=function(e){var t=e.getCurrentUrl,n=e.linkHandler,r=e.clicks,o=e.navigate,s={},a=function(e){var t=e.event,n=e.link;try{var r,a=n.href,u=null!==(r=s)&&void 0!==r&&r.accessToken?i(i({},s),{},{accessToken:"-pruned-"}):s;sm.logger.info("XDomainUrlStorage: adding params to URL",{params:u});var c=ug(a,s,"__sm.");sm.logger.info("XDomainUrlStorage: navigating to modified URL",{original_url:Gu(a),modified_url:Gu(c)}),t.preventDefault(),o(c)}catch(e){sm.logger.error("XDomainUrlStorage: errorion(e){return"_blank"!==e.link.target},c=function(e){var t=e.link;return!I.isEmpty(t.href)&&!I.isNil(t.href)&&I.contains(t.protocol,["http:","https:"])},l=function(e){var n=e.linurn n.isAllowedToNavigate(t.hostname)},p=function(e){var t=e.event;returnfunction(e){return 0===e.event.button},h=function(e){try{return ay.forEach((function(t){return e[t]})),!0}catch(e){return!1}},v=function(e){return!e.defaultPrevented},b=function(e){for(var t=e.target;t&&t.nodeName&&"a"!==t.nodeName.toLowerCase();)t=t.parentElement;return t};retpe(wn((function(){function(e){return{event:e,link:b(e)}})),wn(I.where({link:I.complement(I.isNil)})),wn(c),wn(u) wge: clicks etItem:fn sm.urlParams?sm.urlParams[e]:void 0}}},cy="sm.",ly=function(){return{getItem:function(e){return window.localStorage.getItem(cy+e)},setItem:function(e,t){return window.localStorage.setItem(cy+e,t)},removeItem:function(e){return window.localStorage.removeItem(cy+e)}}},fy=function(){var e,t,n=(e=window,{getItem:function(t){if(!Zg(e))return I.view(ty(t),$g(e))},setItem:function(t,n){if(ey(e)){var r=$g(e),i=I.set(ty(t),n,r);e.name=JSON.stringify(i)}}}),r=(t=ju.Observable.merge($c(document,"click"),$c(document,"mousedown")),new uy({getCurrentUrl:function(){return window.location.te:function(e){window.location.href=e}}));sm.conf.visitor_api&&sm.conf.visitor_api.persist_visitor_session_in_url&&r.start();var i,o=new ly;return{bestEffortXDomainStorage:(i={prioritizedStorages:[n,r,o]}.prioritizedStorages,{getItem:function(e){return function(e,t){for(var n=0;n<e.length;n++){var r=e[n].getItem((function(n){return n.setItem(e,t)}))}}),windowNameStorage:n,xDomainUrlStorage:r,localStorage:o}},py=function(e){var t=e.internalVisitorStateObservable,n=e.defaultQueues;return t.pipe(kt((function(e){return function(e,t){var n=I.pathOr({},["routing",sm.siteId,sm.tabId],e);return I.has("queues",n)?{queue_ids:n.queues}:t.length>0?{queue_ids:t.map((function(e){return e.id}))}:{}}(e,n)})),vi(I.equals))},dy="sm.app.visitor_api.custom_code",hy=function(e){var t=e.stats,n=e.loadCustomCodeScript,r=sm.conf.customCodeFile?sm.conf.customCodeFile.url:void 0;return r?(n||(n=L),new Promise((function(e,i){var o={integrity:P()?sm.conf.customoad:function(){return e({ignored:!1})},onAttempt:function(){return t.increment(dy,["action:attempted"])},onLoad:function(){return t.increment(dy,["action:succeeded"])},onError:function(){return t.increment(dy,["action:warning"])},onGiveUp:function(){return t.increment(dy,["action:failed"]),sm.logger.warn(new Error("Failed to load custom code"),{custom_code_url:r})}};return n(o)n e.increment("sm.gva.assets.load",t)},by=function(e){var t=e.stats,n=((sm.conf||{}).gva||{}).assets||{},r=sm.conf.visitor_api.load_gva_custom_renderer;return new Promise((function(e){return r&&n.js&&n.css?(n.js.forEach((function(e){return function(e,t){return L({fileUrl:t,integrity:j({versionedName:t.split("/").pop()}),onLoad:function(){return vy(e,["action:succeeded","asset:js"])},onError:function(){return vy(e,["action:warning","asset:js"])},onAttempt:function(){return vy(e,["action:attempted","asset:js"])},onGiveUp:function(){return vy(e,["action:failed","asset:js"]),sm.logger.warn(new Error("Failed to load script file from sm.conf.gva.assets"),{asset_url:t})}})}(t,e)})),n.css.forEach((function(e){return function(e,t){return q({fileUrl:t,integrity:j({versionedName:t.split("/").pop()}),onError:function(){return vy(e,["acy(e,["action:attempted","asset:css"])},onGiveUp:function(){return vy(e,["action:failed","asset:css"]),sm.logger.warn(new Error("Failed to load css file from sm.conf.gva.assets"),{asset_url:t})}})}(t,e)})),e({gvaAssetsRequested:!0})):e({gvaAssetsRequested:!1})}))};function my(e,t){var n=t.targetWindow,r=t.logger,o="__sm.",s=n.location.search,a=n.location.href;try{var r((function(e){return e.indexOf(o)>-1})),c=function(t){return Object.keys(e).filter((fu){return{key:n,value:t[n],regex:e[n]}})).reduce((function(e,t){var n=t.key,i=t.value,o=t.regex;return i.match(o)?e[n]=i:r.error("URL query param does no satisfy provided regex",{param_key:n,param_value:i,regex:o}),e}),{})}(u.map((function(e){return e.split("=")})).map((function(e){var t=_(e,2),n=t[0],r=t[1];returonent(t),vvar n=t.key,r=t.value;return e[n]=r,e}),{})),l=u.reduce((function(e,t){return e.replace("?".concat(t),"").replace("&".concat(t),"")}),a);if(l!==a){var f=null!=c&&c.accessToken?i(i({},c),{},{accessToken:"-pruned-"}):c;r.info("Found sm params in URL",{params:f,url_length:a.length}),(n.history?n.history.replaceState:void 0)&&(r.info("Replacing page URL",{original_url:Gu(a),new_url:Gu(l)}),n.history.replaceState(n.history.state,n.document.title,l))}return c}catch(e){return r.error("Error reading sm params from URL",e),{}}}function gy(e,t){var n,r=t.salemovePresentInParent,i=function(){var t={url:e.location.href,page_title:e.title};if(r)return window.parent.postMessage(JSON.stringify({"sm-xdr-url":t.url}),"*")};this.start=function(){return n=sm.hrefObseris.stop=function(){n&&n.unsubscribe()}}var yy=function(e){return I.reduce(I.maxBy(I.prop("activity_at")),e[0],e)},_y=function(e,t){return t?!e||e.activity_at<t.activity_at?t:e:(Yu.warn("New active tab is not defined",{new_active_tab:t}),e)};function wy(e,t,n){var r=this,i=t.salemovePresentInParent,o=t.renewFrequency,s=t.visitorPresenceChannel,a=t.tabId,u=void 0===a?sm.tabId:a;this.onStart=n;var c,l=1e3*o,f=ju.Observable.timer(1e4).mapTo({tab_id:u,page_url:location.href}).do((function(){return Yu.warn("Defaulting active tab to true, multi-tab cobrowsing can misbehave")})),p=s.getSameVisitorConnections().filter(I.complement(I.isEmpty)),d=p.map(yy).scan(_y).merge(f.takeUntil(p)).publishReplay(1),h=d.combineLatest(ap.asObservable()).map((function(e){var t=_(e,2),n=t[0],r=t[1];return n.tab_id===u||r.has(n.tab_id)})).distinctUntilChanged(I.equals),v=new gy(e,{salemovePresentInParent:i}),b=Ml(),m=h.switchMap((function(e){var t=e?l:1500;return b.throttleTime(t)})).map((function(e){return{value:e,timestamp:Date.now()}})).share(),g=function(){return s.getPresenceObservable().take(1).switchion(t){return{presence:e,activeTab:t}}))})).subscribe((function(t){var n=t.presence,r=t.activeTab,i={page_description:e.title};return r.tab_id!==u&&(i.set_active_tab=!0,i.page_url=location.href),r.tab_id===u&&r.page_url!==location.href&&(i.page_url=location.href),n.channel.p send activity update to presence",e)})).receive("timeout",(function(){}))}),(function(e){return Yu.warn("Unable to send activity update to presence",{error:e})}))},y=function(){if(!r.started){r.started=!0,Yu.info("Starting activity tracker"),v.start(),m.skip(1).subscribe((function(){return g()}),Yu.error);var e,t=new ju.Subscription([d.connect(),(e=v,new ju.Subscription((function(){return e.stop()})))]);r.onStart(t)}};this.requestStart=function(){s.requestJoin(),s.getPresenceObservable().take(1).subscribe((function(){return y()}))},this.requestStartWhenSpaceAvailable=function(){s.requestJoinAllowRejection(),s.getPresenceObservable().take(1).subscribe((function(){return y()=function(){return r.requestStart(),h},this.avoidGoingIdle=function(){r.requestStart(),c&&clearInterval(c),c=setInterval((function(){return g()}),5e3)}}wy.NavigationUpdater=gy;var Ey=function(){},Oy=I.propEq("site_id",sm.siteId),Sy=I.compose(I.any(I.propEq("id",sm.siteId)),I.propOr([],"transferrable_sites")),Ty=I.compose(I.nth(0),I.filter(I.either(Oy,Sy)),I.pathOr([],["engagement","engagemen.filter((function(e){return!e.outcome})),I.filter(Oy),I.pathOr([],["engagement","requests"])),Ay=I.compose(I.nth(0),I.filter(I.propEq("site_id",sm.siteId)),I.pathOrf(t)return{name:t.name,email:t.email}},Iy=function(e){var t=e.operator,n=I.map(I.prop("name"),t.teams);return{id:t.id,teamNames:n}},Ny=function(e){var t,n,r;return(t=Ty(e))?{interaction:"engagement",channelUrl:t.channel_url,operator:Iy(t),visitor:xy(t),engagement:t}:(n=ky(e))?{interaction:"engagement",channelUrl:n.channel_url,operator:Iy(n),visitor:xy(n)}:(r=Ay(e))?{interaction:"observation",channelUrl:r.channel_url,operator:Iy(r),visitor:xy(r)}:{}},My=function(e){var t=_(e,2),n=t[0],r=t[1],i=n.operator?n.operator.id:void 0,o=n.channelUrl,s=r.channelUrl;if(i&&o&&o!==s){var a=Om(i);if(a)return a.then((function(e){return e.destroy()}),Ey)}},Ry=function(e){var t,n,r,i=e.internalVisitorStateObservable,o=e.getAccessToken,s=e.stats,a=e.visitorPresenceChannel,u=e.salemovePresentInParent;if(sm.trackerSubscription=new ju.Subscription,sm.tracker=t=new wy(document,{renewFrequency:(n=sm.conf.engagement.visitor_time_to_inactive_sec,r=sm.conf.engagement.renew_freq_muliplier||.8,Math.max(10,Math.round(n*r))),salemovePresentInParen{return sm.trackerSubscription.add(e)})),sm.conf.visitor_api.visitor_presence_join_limited){var c=I.pathOr([],["engagement","observations"]),l=I.pathOr([],["engagement","requests"]),f=I.pathOr([],["engagement","engagements"]),p=I.pathOr([],["omniq","queue_tickets"]),d=function(e){return c(e).length>0||l(e).length>0||f(e).length>0||p(e).length>0};i.filter(d).take(1).subscribe((function(){return t.requestStart()})),i.takern t.requestStartWhenSpaceAvailable()}))}else t.requestStart();var h,v=(h={internalVisitorStateObservable:i},h.internalVisitorStateObservable.pipe(kt(Ny),vi(I.etion(e){var t=_(e,2);return t[0],t[1]})),dStatus("engagement"===e.interaction)}));var b=function(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Du();return e.pipe(vi(null,(function(e){return e.channelUrl})),zo((function(e){return i.pipe(kt((function(){return e})))})),ts(null,Yu.warn.bind(Yu,"Failed to setup channel observable")),wn((function(e){return Boolean(e.interaction)})),zo((function(e){return t.getUserIsActiveTabObservable().pipe(Ei(1),kt((function(t){return{status:e,isActiveTab:t}})))})),zo((function(e){var t=e.status,i=e.isActiveTab;return Tm({channelUrl:t.channelUrl,participantId:"visitor",operatorId:t.operator.id,isActiveTab:i,getAccessToken:n,stats:r}).pipe(Fr((functionreturn{channel:e,operator:t.operator}})))})),Mo())}(v,t,o,s).publishReplay(1);return sm.channelSubscription=b.connect(),v.connect(),{statusObservable:v,channelObservable:b.filter((function(e){var t=e.channel,n=e.operator;return!t.isStopped()||(Yu.warn("Filtering out stopped channel in channelObservable",{channelUrl:t.url,operator:n,siteId:sm.siteId}),!1)})),tracker:t}},Cy={get:function(e){return e.checked},set:function(e,t){e.checked=t}},Py={select:{get:function(unction(e){return[e.index,e.selected]})))(e.ch((function(e){e.selected=t[e.index]}))(e.options)}},option:{ected},set:function(e,t){e.selected=t}},radio:Cy,checkbox:Cy,default:{get:function(e){return e.value},set:function(e,t){if("function"==typeof Object.getOwnPropertyDescriptor&&Object.getOwnPropertyDescriptor(e,"value")&&Object.getOwnPropertyDescriptor(e,"value").set)try{return Object.getOwnPropertyDescriptor(e.constructor.prototype,"value").set.call(e,t)}catch(n){e.value=t}else e.value=t}}},jy=function(e){var t=Py[e.type]||Py[e.nodeName&&e.nodeName.toLowerCase()]||Py.default,n=t.get,r=t.set;){return n(e)},set:function(t){r(e,t)}}},Ly="sm_engagement_serialized_inputs",qy=function(e,t){return I.compose(I.forEach((function(t){var n=t.destInput,r=t.value;return t.hook.set(r),function(e,t){var n=e.createEvent("HTMLEvents");return n.initEvent("change",!0,!1),t.dispatchEvent(n)}(e,n)})),I.filter((function(e){var t=e.hook,n=e.value;return!I.equals(t.get(),n)})),I.map((function(e){var t=e.destInput;return{destInput:t,){var t=e.destInput;return Boolean(t)})),I.map((function(t){var n=t.value,r=t.xpath;return{value:n,destInput:Xc(e,r)}}){return Array.prototype.slice.call(e)}),(function(t){return e.getElementsByTagName(t)})),n=I.chain(t,["INPUT","TEXTAREA","SELECT","PASSWORD","CHECKBOX","RADIO"]);return I.map((function(e){return{value:jy(e).get(),xpath:Yc(e)}}),n)},Dy=[I.ifElse(I.path(["state","available"]),I.always(1),I.always(0)),I.compose(I.length,I.path(["saxBy((funct=function(e){return sm.conf.api_url+e},By=function(e){return function(e){return e.pipe(wn(I.propEq("connected",!1)))}(e).pipe(zo((function(){return e.pipe(wn(I.propEq("connected",!0)),Ei(1))})))},Hy=function(e,t,n){t||(t=Uf);var r=(n&&void 0!==n.authenticatedExternally?n.authenticatedExternally:Hu())?"/messaging/chat_transcript?_=".concat(Date.now()):"/engagements/".concat(e,"/chat_transcript?_=").concat(Date.now());return t({url:Fy(r)}).pipe(kt(I.prop("response")),Ro(),Fr((function(t){return Yu.warn("Failed to fetch chat history",{error:t,engagement_id:e}),Nc.of([])})))},Wy=function(e){var t=e.engagementId,n=e.connectionStatusObservable,r=e.reqn).pipe(an((function(){return Hy(t,r)})),Mo())},Gy=ju.Observable.throw(new vf({cause:rf.SALEMOVE.INTERNAL_ERROR})).pipe(ts(null,(function(){return Yu.warn("Operators observable timed out!")}))),zy=function(e,t){t||(t=[]);return e.increment("engagement.flow",["entrypoint:reactive-request"].concat(t))},Jy=function(e,t,n,r){r||(r=ju.Scheduler.asap);var i=t||{},o=i.operatorId,s=i.phoneNumber,a=i.phoneExtension,u=i.source,c=i.oneWay,l=i.siteId;l||(l=sm.siteId);var f=n.api,p=n.operatorsObservable,d=n.serverResponseTimeout,h=n.engagementCoreObservable,v=n.mediaValidation,b=n.statsClient;Yu.info("Engagement: Reactive request initiated",{media:e,options:t});var m=o?I.find(I.propEq("id",o)):Vy,g=p.pipe(us(d,Gy,r),kt(m),an((function(e){return e?ju.Observable.of(e):ju.Observable.throw(new vf({cause:rf.SALEMOVE.OPERATOR_UNAVAILABLE}))})));return ju.Observable.combineLatest(g,h).pipe(an((function(n){return function(n){var i=n.state.medias,o=n.state.oneWayMedias,s=v({media:e,options:t,availableMediaTypes:i,availableOneWayMediaTypes:o});return(s instanceof ju.Observable?s:ju.Observable.from(s,r)).pipe(kt(I.always(n)))}(_(n,1)[0])})),an((function(t){var n={phoneNumber:s,phoneExtension:a,oneWay:c};return zy(b,["action:reach","stage:create-request"]),f.create({operatorId:t.id,siteId:l,medi,{operator:t,media:e,mediaOptions:n})})))})))},Yy=function(e,t){t||(t=ju.Scheduler.asap);var n=e.media,r=e.mediaOptions,i=e.mediaValidation,o=e.api,s=e.notifyOfTimeout,a=e.operatorsObservable,u=e.engagementCoreObservable,c=e.cobraObservable,l=e.channelObservable,f=e.serverResponseTimeout,p=e.communicationLib,d=e.engagementApi,h=e.webRtcMode,v=e.enabledMediaLevel,b=e.statsClient,m=Jy(n,r,{api:o,operatorsObservable:a,serverResponseTimeout:f,engagementCoreObservable:u,mediaValidation:i,statsClient:b},t).pipe(fo()),g=m.connect();zy(b,["action:begin"]);var y=m.pipe(an((function(e){var n=e.engagementRequestId,r=e.acknowledgeTimeoutSeconds,i=e.operator;return zy(b,["action:reach","stage:requested"]),ju.Observable.combineLatest(o.acceptedObservable,c,l,(function(e,t){return I.merge(e,{cobra:t})})).pipe(us(1e3*r+f,function(e,t){return ju.Observable.throw(new vf({cause:rf.SALEMOVE.NETWORK_TIMEOUT})).pipe(ts(null,(function(){return Yu.warn("Engagement request timed out! Some internal listener must be missing.")})),ts(null,(function(){return e.notifyOfReactiveFailure({id:t})})))}(o,n),t),$i(nl(function(e){return ju.Observable.merge(o.declinedObservable.pipe(kt(I.always(new vf({cause:rf.SALEMOVE.OPERATOR_DECLINED})))),o.timedOutObservable.pipe(ts((function(){return s({operator:e})})),kt(I.always(new vf({cause:rf.SALEMOVE.TIMEOUT})))))}(i))),Ei(1),Ci((function(){return g.unsubscribe()})))})),ts(null,I.ifElse(I.propEq("cause",rf.SALEMOVE.INTERNAL_ERROR),Yu.warn.bind(Yu,"Engagement: Reactive request failed"),Yu.info.bind(Yu,"Engagement: Reactive request failed"))),ts(null,(function(e){return zy(b,["action:end"].concat(function(e){return e&&e.cause===rf.SALEMOVE.OPERATOR_UNAVAILABLE?["stage:pre-request","expected:true","reason:target-unavailable"]:e&&e.cause===rf.SALEMOVE.INVALID_INPUT?["stage:pre-request","reason:invalid-input"]:e&&e.cause===rf.SALEMOVE.INTERNAL_ERROR?["stage:create-request","reason:internal-error"]:e&&e.cause===rf.SALEMOVE.TIMEOUT?["stage:requested","expected:true","reason:accept-timeout"]:e&&e.cause===rf.SALEMOVE.OPERATOR_DECLINED?["stage:requested","expected:true","reason:decline"]:e&&e.cause===rf.SALEMOVE.NETWORK_TIMEOUT?["stage:create-request","reason:network-error"]:["stage:pre-request","reason:script-load-error"]}(e)))})),kt((function(e){var t,r,i,o,s,a,u,c,f,b;i=e.engagementId,b=e.subEngagementId,t=e.cobra,n=e.media,s=e.operatorId,u=e.operatorName,c=e.operatorFormattedName,f=e.operatorPicture,a=e.operatorMediaType,o=e.entrypoint,r=e.createdAt;var m=Jg({id:s,name:u,formattedName:c,picture:f,mediaType:a,webRtcMode:h,enabledMediaType:v});return Yu.info("Engagement: Reactive request accepted",{engagementId:i,subEngagementId:b,operator:m}),{engagementId:i,subEngagementId:b,startingMedia:n,type:"reactive",isReestablishing:!1,initialChatHistoryObservable:Hy(i),operator:m,communicationLib:p,cobra:t,channelObservable:l,engagementApi:d,entrypoint:o,createdAt:r}})),Ei(1));return{requestObservable:m,resultObservable:y}},Qy=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Subscription=gr.Subscription})),Ky=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(Qy)})),Xy=u((function e(t){var n=t.id,r=t.content,i=t.status,o=t.attachment,a=t.created_at;if(s(this,e),this.id=n,this.content=r,this.sender="visitor",this.sender_details={type:"visitor"},this.status=null,this.attachment=o,this.created_at=a,i){if(!I.find(I.equals(i),I.values(this.STATUSES)))throw new vf({cause:rf.SALEMOVE.INTERNAL_ERROR,message:"Unknown status ".concat(i)});this.status=i}})),$y=I.propEq("sender","visitor");Xy.prototype.STATUSES={SENDING:"sending",DELIVERED:"delivered",FAILED:"failed"},Xy.prototype.ATTACHMENT_RESPONSE_TYPES={SINGLE_CHOICE_RESPONSE:"single_choice_response",FILES:"files"};var Zy=u((function e(t){var n=t.id,r=t.content,i=t.attachment,o=t.metadata,a=t.created_at,u=t.sender,c=void 0===u?{}:u;s(this,e),this.id=n,this.content=r,this.sender="operator",this.sender_details={type:"operator",name:c.name,picture:c.picture?c.picture.url:"",id:c.id},this.attachment=i,this.metadata=o,this.created_at=a}));Zy.prototype.ATTACHMENT_TYPES={SINGLE_CHOICE:"single_choice",FILES:"files"};var e_=u((function e(t){var n=t.id,r=t.content,i=t.attachment,o=t.metadata,a=t.created_at;s(this,e),this.id=n,this.content=r,this.sender="system",this.sender_details={type:"system"},this.attachment=i,this.metadata=o,this.created_at=a}));e_.prototype.ATTACHMENT_TYPES={SINGLE_CHOICE:"single_choice",FILES:"files"_option,n_=function(e,t){return e===t},r_={VISITOR:"visitor",OPERATOR:"operator",SYSTEM:"system"},i_=function(e,t){var n=I.differenceWith(I.eqProps("id"),e,t);return 0===n.length?t:I.concat(n,t)},o_=function(e,t,n){var r=e.pipe($i(t),sr((function(e,t){var n=I.findIndex(I.propEq("id",t.id),e);return-1!==n?I.update(n,t,e):I.prepend(t,e)}),[]),Wo([]));return fc.combineLatest(r,n,i_).pipe(vi(n_))},s_=function(e){var t=e.sender.type;return t===r_.VISITOR?new Xy(e):t===r_.OPERATOR?new Zy(e):t===r_.SYSTEM?new e_(e):void 0},a_=function(e){var t=e.sender.type;return s_(i(i({},e),{},t===r_.VISITOR?{content:e.message,status:Xy.prototype.STATUSEction(e){return I.map(a_,e).reverse()},c_=function(e){var t=e.chatHistoryObservable,n=e.ownMessages,r=e.otherMessages,i=e.statsClient,o=e.fetchExtraOperatorInfo,s=n.pipe(kt((function(e){var t=e.id,n=e.content,r=e.attachment;return new Xy({id:t,content:n,attachment:r,status:null})}))),a=n.pipe(an((function(e){var t=e.id,n=e.content,r=e.status,i=e.attachment;return r.pipe(kt((function(e){return new Xy({id:t,content:n,attachment:i,status:e})})))}))),u=r.pipe(pi(I.prop("id")),an((function(e){var t=I.path(["sender","type"],e);if(t===r_.OPERATOR){var n=e.sender.id;return o(n).pipe(kt((function(t){return I.evolve({sender:I.merge(t)})(e)})))}return t===r_.SYSTEM?Nc.of(e):(Yu.warn("Received other chat message of unknown sender origin",{id:e.id,sender_type:t}),xc.empty())})),kt(s_)),c=t.pipe(kt(u_)),l=o_(a,u,c).pipe(ts((function(){i.increment("sm.app.visitor_api.chat.messages",["action:emitted","visitor_app:".concat(t_)])})));return{messages:o_(s,u,c),messagesWithStatusUpdates:l}},l_=u((function e(t){var n=t.typing;s(this,e),this.typing=n})),f_="visitor";function p_(e){this.recordChatMessageSent=function(t){1===t?e.increment("sm.".concat(f_,".communication.chat.message.sent")):e.increment("sm.".concat(f_,".communication.chat.message.retry"))},this.recordChatMessageDeliveryFailed=function(){e.increment("sm.".concat(f_,".communication.chat.message.delivery_failmmunicatio!0}),t.Rt.hasOwnProperty(n)||(t[n]=e[n])}(d_)})),v_={SENDING:"sending",DELIVERED:"delivered",FAILED:"failed"},b_="Chat",m_=function(){function e(t){var n=t.chatApi,r=t.messagesToSend,i=t.previewToSend,o=t.deliveryTimeout,a=void 0===o?sm.conf.chat_message_send_timeout_ms||15e3:o,u=t.history,c=t.guid,l=void 0===c?Tl:c,f=t.stats,p=t.logger;s(this,e),this._chatApi=n,this._previewToSend=i,this._history=u,this._generateGuid=l,this._messagesToSend=r,this._deliveryTimeout=a,this.stats=f,this.logger=p,this._messengerStoppedSubject=new vc.Subject,this._sentMessages=new vc.Subject,this._deliveryEvents=this._chatEvents("deliveredMessages"),this._receivedMessageIds=[],this._subscription=new Ky.Subscription}return u(e,[{key:"start",value:function(){var e=this;this._subscription.add(this._messagesToSend.subscribe(this._sendMessage.bind(this),this.logger.error)),this._subscriptn e._chatApi.sendPreview({content:t})}),this.logger.error)),this._subscription.add(this._messagesReceivedFromHistory().subscribe(t,": Failed to fetch chaxt(),this._subscription.unsubscribe()}},{key:"observables",value:function(){return{ownMessages:this._sentMessages.pipe($i(this._receivedVisitorMessages())),otherMessages:this._receivedOtherMessages(),operatorTypingIndicator:this._chatApi.operatorTypingIndicator}}},{key:"_chatEvents",value:function(e){return this._chatApi[e].pipe(Ko(this._messengerStoppedSubject))}},{key:"_receivedVisitorMessages",value:function(){return this._chatEvents("receivedVisitorMessages").pipe(kt(I.merge({status:Nc.of(v_.DELIVERED)})))}},{key:"_sendMessageAndWaitForAcknowledgement",value:function(e){var t=this,n=e.message,r=this._deliveryEvents.pipe(wn((function(e){return I.equals(n.id,e.id)})),Ei(1),Mo()),i=r.subscribe(I.always);return this._chatApi.sendMessage(n).pipe(Qo(r.pipe(zi(v_.DELIVERED),us(this._deliveryTimeout,Rf._throw("".concat(b_,": Message timed out before being delivered to other participant"))))),Fr((function(e){return t.logger.info("".concat(b_,": Message delivery failed with error"),{error:e,message_id:n.id}),Nc.of(v_.FAILED)})),Ei(1),Ci(i.unsubscribe))}},{key:"_sendMessage",value:function(e){var t,n,r,i,o,s,a=this,u=(t=e,n=this._generateGuid,r=t.content,i=t.options,o=i?i.attachment:void 0,s=i?i.metadata:void 0,{id:n(),content:r,attachment:o,metadata:s}),c=new h_.ReplaySubject(1).distinctUntilChanged();return c.next(v_.SENDING),this._sentMessages.next(I.merge(u,{status:c})),this._addToReceived(u),this._subscription.add(this._sendMessageAndWaitForAcknowledgement({message:u}).subscribe((function(e){e===v_.DELIVERED&&(c.complete(),a.stats.recordChatMessageDelivered(),a.logger.info("".concat(b_,": Message delivered to other participant"),{message_id:u.id})),e===v_.FAILED&&(c.next(v_.FAILED),a.stats.recordChatMessageDeliveryFailed())}),this.logger.error))}},{key:"_acceptReceivedMessage",value:function(e){var t=this;return function(n){t.logger.info("".concat(b_,": Message received"),{message_id:n.id,source:e}),t._addToReceived(n),I.pathEq(["sender","type"],"visitor",n)||n.delivered_at||t._chatApi.markMessageAsDelivered(n.id)}}},{key:"_receivedOtherMessages",value:function(){var e=this;return this._chatEvents("receivedOtherMessages").pipe(wn((function(t){return e._messageNotReceived(t)})),an((function(t){return Nc.of(t).pipe(ts(e._acceptReceivedMessage("participant")),Fr((function(){return Nc.of(t)})))})),Mo())}},{key:"_messagesReceivedFromHistory",value:function(){var e=this;return this._history.pipe(wn((function(t){return e._messageNotReceived(t)})),an((function(e){return dc.from(e)})))}},{key:"_messageNotReceived",value:function(e){return!I.contains(e.id,this._receivedMesappend(e.id,this._receivedMessageIds)}}]),e}();m_.STATUSES=v_;var g_=n.default.visitor_api.own_typing_duration||5e3;var y_="engagement.chat.message",__="engagement.chat.system_message",w_="engagement.chat.message_status",E_="engagement.chat.typing_indicator.operator",O_="engagement:chat_message:preview_update",S_="Chat",T_={retryLimit:5,initialDelay:1e3,maxDelay:void 0,factor:1.5},k_=function(e){return 0===e||421===e||429===e||e>=50es((function(e){return e===y_||e===__}),"event_type"),I_=I.propEq("event_type",w_),N_=function(e){var t=I.pathEq(["message","engagement_id"],e);return I.allPass([x_,t])},M_=function(e){var t,n,r=e.engagementId,i=e.visitorId,o=e.logger,s=e.stats,a=e.channelObservable,u=e.xhrWithRetry,c=void 0===u?Df:u,l=e.getRequestHeaders,f=e.siteVisitorNotifications,p=new vc.Subject,d=function(e){return e.attachment?{content:e.content,attachment:e.attachment}:{content:e.content}},h=(t=p.map(I.prop("content")),t.pipe(zo((function(e){return""===e?Pu.Observable.of(!1):Pu.Observable.merge(Pu.Observable.of(!0),Pu.Observable.timer(g_,n).map((function(){return!1})))})),is(50,n,{leading:!0,trailing:!0}),vi())).subscribe((function(e){qf({method:"PUT",url:"".concat(sm.conf.api_url,"/engagements/").concat(r,"/typing_indicator"),payload:JSON.stringify({typing:e}),responseType:"json",getRequestHeaders:function(){return I.merge(l?l():{},{"Content-Type":"application/json"})},onSuccess:A_,onError:function(){return o.warn("Could not set typing indicator")},onAttempt:A_,shouldRetry:function(){return!1}})})),v=p.startWith({content:""}).combineLatest(a).subscribe((function(e){var t=_(e,2),n=t[0];t[1].emit(O_,{engagement_id:r,content:n.content,visitor_id:i})}),o.error.bind(o,"".concat(S_,": Error sending chat preview"))),b=I.compose(I.merge({type:"user"}),I.pick(["id","engagement_id","content","attachment","metadata","sender"]),I.prop("message")),m=I.compose(I.pick(["id","engagement_id"]),I.prop("message")),g=I.pathEq(["message","engagement_id"],r),y=I.pathEq(["message","sender","type"],"visitor"),w=I.pathEq(["message","status"],"delivered"),E=f.pipe(wn(N_(r))),O=E.pipe(wn(I.complement(y)),kt(b)),S=E.pipe(wn(y),kt(b)),T=f.pipe(wn(I.allPass([I_,g,w])),kt(m)),k=I.propEq("event_type",E_),A=I.pathEq(["typing_indicator","engagement_id"],r);return{stop:function(){v.unsubscribe(),h.unsubscribe()},sendMessage:function(e){var t=e.id;return cc.Observable.create((function(n){var i=0;c({method:"PUT",url:"".concat(sm.conf.api_url,"/engagements/").concat(r,"/chat_messages/").concat(t),payload:JSON.stringify(d(e)),responseType:"json",contentType:"application/json",getRequestHeaders:l,calculateAttemptDelay:M(T_.initialDelay,T_.maxDelay,T_.factor),retryLimit:T_.retryLimit,onSuccess:function(t){o.info("".concat(S_,": Message sent to system, waiting for it to be delivered to other participant"),{message_id:e.id}),n.next(t),n.complete()},onError:function(e){var r=e.status,i=e.statusText,s="".concat(S_,": Failed to send message to system");o.warn(s,{message_id:t,status:r,status_text:i}),n.error(s)},onAttempt:function(){++i>1&&o.info("Chat: Send message request failed, retrying",{message_id:t,attempt:i}),s.recordChatMessageSent(i)},shouldRetry:k_})})).pipe(Ei(1))},sendPreview:function(e){return p.next(e)},markMessageAsDelivered:function(e,t,n){c({method:"PATCH",url:"".concat(sm.conf.api_url,"/engagements/").concat(r,"/chat_messages/").concat(e),payload:JSON.stringify({status:"delivered"}),responseType:"json",contentType:"application/json",getRequestHeaders:l,calculateAttemptDelay:M(T_.initialDelay,T_.maxDelay,T_.factor),retryLimit:T_.retryLimit,onSuccess:function(){o.info("".concat(S_,": Marked message as delivered"),{message_id:e}),"function"==typeof t&&t()},onError:function(t){var r=t.status,i=t.statusText;o.warn("".concat(S_,": Failed to mark message as delivered"),{message_id:e,status:r,status_text:i}),"function"==typeof n&&n()},shouldRetry:k_})},receivedOtherMessages:O,receivedVisitorMessages:S,deliveredMessages:T,operatorTypingIndicator:f.pipe(wn(I.allPass([k,Action(e,t){return t.clock>e.clock?t:e})),kt(I.pick(["typing"])),vi(I.equals))}},R_=function(e,t){for(var n,r=[];n=t.exec(e);)r.push(n[1]);return r},C_=function(e,t,n){return t&&I.forEach((function(t){var r=t.split("").join(".*?");e=e.replace(new RegExp(r),n)}),t),e},P_=function(e){var t=!0;return e.split("").reduceRight((function(e,n){return n=parseInt(n,10),(t=!t)&&(n*=2),n>9&&(n-=9),e+n}),0)%10==0},j_=I.compose((function(e){var t=new RegExp(/(?:^|\D)(\d{3}(-| )\d{2}(-| )\d{4})(?=\D|$)/g),n=R_(e,t);return C_(e,n,"***Social Security Number Not Allowed***")}),(function(e){var t=new Reg£¢)])","gm");return e.replace(t,"$1")}(e),t),r=I.filter(P_,n);return C_(e,r,"***Credit Card Number Not Allowed***")}),(function(e,t){return t.reduce((function(e,t){try{var n=new RegExp(t,"g");return e.replace(n,(function(e){return"*".repeat(e.length)}))}catch(t){return e}}),e)})),L_=function(e){return e.replace(/[0-9]/g,"*")},q_=function(){function e(t){var n=t.channelObservable,r=t.historyObservable,i=t.getRequestHeaders,o=t.logger,a=t.statsClient,u=t.engagementId,c=t.visitorId,l=t.siteVisitorNotifications,f=t.maskingRegularExpressions;s(this,e);var p=new p_(a);this._messagesToSend=new vc.Subject,this._previewToSend=new vc.Subject,this.chatApi=new M_({engagementId:u,visitorId:c,logger:o,stats:p,channelObservable:n,getRequestHeaders:i,siteVisitorNotifications:l}),this.messenger=new m_({chatApi:this.chatApi,stats:p,logger:o,messagesToSend:this._messagesToSend.pipe(kt((function(e){return function(e,t){var n=e.content,r=e.options;return{content:j_(n,t),options:r}}(e,f)}))),previewToSend:this._previewToSend.pipe(kt(L_)),history:r}),this.messenger.stessagesToSend.next({content:e,opte:function(e){this._previewToSend.next(e)}},{key:"stop",value:function(){this.messenger.stop()}},{key:"observables",value:function(){return this.messenger.observables()}}]),e}(),U_=function(){function e(t){var n=t.chatHistoryObservable,r=t.engagementEndObservable,i=t.observeChatMessages,o=t.statsClient,a=t.chatController,u=t.fetchExtraOperatorInfo;s(this,e);var c=new Ky.Subscription,l=Qf(),f=a.observables(),p=f.otherMessages,d=f.ownMessages,h=f.operatorTypingIndicator,v=i({chatHistoryObservable:n,otherMessages:p,ownMessages:d,statsClient:o,fetchExtraOperatorInfo:u}),b=v.messages.pipe(fo(1)),m=v.messagesWithStatusUpdates.pipe(fo(1));c.add(b.connect()),c.add(m.connect());var g=h.pipe(kt(I.construct(l_)),Wo(new l_({typing:!1})),fo(1));c.add(g.connect());var y=function(){l.stop(),c.unsubscribe()},_=I.fromPairs([[this.EVENTS.MESSAGES,b],[this.EVENTS.MESSAGES_WITH_STATUS_UPDATES,m],[this.EVENTS.OPERATOR_TYPING_STATUS_UPDATE,g]]);l.proxyAll(_),this.addEventListener=l.addEventListener,this.removeEventListener=l.removeEventListener,this.observablesendMessage(e,t),a.sendMeview=function(e){a.sendMessagePreview(e)},r.subscribe((function(){}),y,y)}return u(e,null,[{key:"create",value:function(t){var n=t.chatHistoryObservable,r=t.engagementEndObservable,i=t.statsClient,o=t.engagementId,s=t.getRequestHeaders,a=t.siteVisitorNotifications,u=t.maskingRegularExpressions,c=nc.vent.observable(nc.MSG.PUBLIgement_observables").engagementObservable})),f=function(e){var t=e.getRequestHeaders,n=e.xhrWithRetry,r=void 0===n?Df:n,i=e.takeUntilNotifier,o={},s={},a=i||new ju.Subject;return function(e){return o[e]?Nc.of(o[e]):cc.Observable.create((function(n){if(s[e])s[e].push(n);else{s[e]=[n];var i=functionorEach((function(e){e.next(),e.complete()})),delete s[e])}}(e);r({method:"GET",url:"".concat(sm.conf.api_url,"/operators/").concat(e,"?include_engagements=false"),responseType:"json",contentType:"application/json",getRequestHeaders:t,onSuccess:functinction(e){e.next(t.response),e.complete()})),deletonError:i,shouldRetry:function(){return!1}})}})).pipe(Ko(a))}}({getRequestHeaders:s}),p=function(e){var t=e.chatHistoryObservable,n=e.engagementStartObservable,r=e.engagementObservables,i=e.siteVisitorNotifications,o=e.getRequestHeaders,s=e.statsClient,a=e.engagementId,u=e.maskingRegularExpressions,c=n.pipe(Zi(r),uo("channel"),fo(1)),l=c.connect(),f=new q_({channelObservable:c,historyObservable:t,getRequestHeaders:o,statsClient:s,logger:sm.logger.withTags({engagement_id:a,site_id:sm.siteId}),engagementId:a,visitorId:qu(),siteVisitorNotifications:i,maskingRegularExpressions:u});return{chatController:f,stopChat:function(){f.stop(),l.unsubscribe()}}}({chatHistoryObservable:n,engagementStartObservable:c,siteVisitorNotifications:a,engagementObservables:l,statsClient:i,engagementId:o,getRequestHeaders:s,maskingRegularExpressions:u}),d=p.chatController,h=p.stopChat;return{chat:new e({chatHistoryObservable:n,engagementEndObservable:r,observeChatMessages:c_,statsClient:i,chatController:d,fetchExtraOperatorInfo:f}),stopChat:h}}}]),e}();U_.prototype.EVENTS={MESSAGES:"messages",MESSAGES_WITH_STATUS_UPDATES:"messages-with-status-updates",OPERATOR_TYPING_STATUS_UPDATE:"operator-typing-status-update"},U_.prototype.SENDERS=r_;var D_=["engagement","engagements"],V_=["engagement","requests"],F_=["visitor","browser_tab_id"],B_=function(e){return I.any(I.propEq("id",sm.siteId),e.transferrable_sites)},H_=function(e){return e&&"transferring"===e.status&&e.capabilities.text},W_=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=void 0!==t.includeAsyncTransfer&&t.includeAsyncTransfer,r=I.pathOr([],D_,e);try{var i=I.find(B_,r);return H_(i)?n?i:void 0:i}catch(t){return void Yu.error("Engagement was undefined in internalVisitorState",{internalVisitorState:e,engagements:r})}},G_=function(e){return B_(e)&&I.path(F_,e)===sm.tabId&&!H_(e)},z_=I.compose(I.nth(0),I.filter(G_),I.pathOr([],D_)),J_=I.compose(I.nth(0),I.filter(I.complement(G_)),I.pathOr([],D_)),Y_=I.compose(I.nth(0),I.filter(I.allPass([B_,I.propEq("outcome",null),I.propEq("type","reactive")])),I.pathOr([],V_)),Q_={OBSERVATION:"OBSERVATION",ENGAGEMENT:"ENGAGEMENT",POINTER:"POINTER"},K_=function(){function e(t,n,r){s(this,e),this.mode=t,this.session=n,this.canVisitorEndCobrowsing=r.canVisitorEndCobrowsing||!1}return u(e,null,[{key:"createObservation",value:function(){return new this(Q_.OBSERVATION,null,{})}},{key:"createActive",value:function(e){return new this(e.mode,e.session,e.metadata)}}]),e}(),X_=function(){function e(t){var n=t.cobra;s(this,e),this.stop=function(){return n.switchToObservation()}}return u(e,[{key:"stop",value:function(){}}]),e}(),$_=function(){function e(t){var n=t.operator,r=t.channel;s(this,e),this.operator=n,this.allow=function(){return r.emitAll("engagement:offer_cobrowsing:allow"),Yu.info("Visitor accepted cobrowsing request"),null},this.decline=function(){return r.emitAll("engagement:offer_cobrowsing:deny"),Yu.info("Visitor declined cobrowsing request"),null}}return u(e,[{key:"allow",value:function(){}},{key:"decline",value:function(){}}]),e}(),Z_=u((function e(t){var n=this,r=t.cobraObservable,i=t.internalVisitorStateObservable,o=t.channelObservable,a=t.fromRxJs4,u=void 0===a?tl:a;s(this,e);var c=o.switchMap((function(e){var t=e.channel;return t.emitAll("engagement:offer_cobrowsing:ready"),t.observable("engagement:offer_cobrowsing:offer_cobrowsing").do((function(){return t.emitAll("engagement:offer_cobrowsing:ack")})).map((function(e){return{operator:void 0!==e&&"operator"in e?e.operator:null,channel:t}}))})).do((function(){return Yu.info("Recnel;return new $_({operator:t,channel:n})})),l=o.switchMap((function(e){return e.channel.observable("engagement:offer_cobrowsing:deny").map((function(){return{}}))})),f=i.map((function(e){var t=W_(e),n=void 0!==t?t.platform:void 0;return void 0===n?{}:{canVisitorEndCobrowsing:n!==lf}})).startWith({}).distinctUntilChanged(I.equals),p=r.switchMap((function(e){reluck("name").map((function(t){return[t,e]})))})).withLatestFrom(f).map((function(e){var t=_(e,2),r=_(t[0],2),i=r[0],o=r[1];return function(e,t,r){return e===n.MODES.OBSERVATION?K_.createObservation():K_.createActive({mode:e,metadata:t,session:new X_({cobra:r})})}(i,t[1],o)})),d=I.fromPairs([[this.EVENTS.COBROWSING_REQUEST,c],[this.EVENTS.MODE_CHANGE,p],[this.EVENTS.COBROWSING_REQUEST_REJECTED,l]]),h=Kf(),v=Qf();v.proxyAll(d),h.proxyAll(d),this.resendPage=function(){returromise().then((function(e){e.resendPage()}))},this.addUnbufferedEventListener=v.addEventListener,this.removeUnbufferedEventListener=v.removeEventListener,this.addBufferedEventListener=h.addEventListener,this.removeBufferedEventListener=h.removeEventListener,this.observable=function(e){return v.observable(e)},this.bufferedObservable=function(e){return h.observable(e)}}));Z_.prototype.EVENTS={COBROWSING_REQUEST:"cobrowsing_request",MODE_CHANGE:"cobrowser_mode_change",COBROWSING_REQUEST_REJECTED:"cobrowsing_requeon(e){return"browser"===e?"audio":"phone"},tw=function(e){var t=e.upgradeRequest,n=e.currentMediaState,r={audio:I.path(["audio","direction"],n),video:I.path(["video","direction"],n)},i=I.pick(["audio","video"],t),o=I.invert(r).two_way||[],s=I.invert(i).two_way||[];return!I.isEmpty(I.difference(s,o))},nw="two_way",rw="one_way",iw=function(e,t){return I.maxBy((function(e){return e===nw?2:e===rw?1:0}),e,t)},ow=function(e){if(e){if(e.video)return"video";if(e.audio&&"browser"===e.audio.type)return"audio";if(e.audio&&"phone"===e.audio.type)return"phone"}return"text"},sw=function(e){return e.stateObservable.bufferCount(2,1).filter((function(e){var t=_(e,2),n=t[0],r=t[1];return n.sub_engagement_id!==r.sub_engagement_id})).do(Yu.log.bind(Yu,"Detect sub_engagement change")).map((function(e){var t=_(e,2);t[0];return t[1]})).map((function(e){var t=new bg({id:e.operator.id,name:e.operator.name||"Operator",formattedName:e.operator.formatted_name,picture:{url:e.operator.picture_url},media_type:e.operator.media_type}),n={id:e.id,subEngagementId:e.sub_engagement_legacy_id,channelUrl:e.channel_url,mediaState:e.media_state,operatorId:t.getId(),operatorName:t.getName(),operatorFormattedName:t.getFormattedName(),operatorPicture:t.getPictureUrl(),operatorMedia:t.getMediaType()};return n=I.assoc("startingMedia",ow(n),n)})).map(I.pick(["operatorId","operatorName","operatorFormattedName","operatorPicture","operatorMedia","startingMedia","subEngagementId","id"])).map(I.merge({isReestablishing:!1,isTransfer:!0})).do(Yu.log.bind(Yu,"Engagement transferred"))},aw=function(e){var t,n=e.engagement,r=e.transfers,i=e.channelObservable,o=e.webRtcMode,s=e.statusObservable,a={id:n.engagementId,subEngagementId:n.subEngagementId,startingMedia:n.startingMedia,isReestablishing:n.isReestablishing,operatorId:n.operator.id,operatorName:n.operator.name,operatorFormattedName:n.operator.formattedName,operatorPicture:n.operator.picture?n.operator.picture.url:void 0,operatorMedia:(t=n.operator.state.medias,I.findLast(I.contains(I.__,t),sf)),observable:n.observable.bind(n),EVENTS:n.EVENTS},u=s.filter(I.propEq("interaction","engagement")).map(I.prop("channelUrl")).take(1),c=i.switchMap((function(e){var t=e.channel;return u.map((function(e){return{channn=e.engagementChannelUrl;return t.url===n})).take(1);return ju.Observable.of(a).merge(r).switchMap((function(e){return c.map((function(t){var n=t.channel;return I.merge({channel:n},e)}))})).map(I.evolve({startingMedia:I.when(I.isNil,I.always(n.startingMedia))})).map((function(e){return I.merge(e,{webRtcMode:o})}))};function uw(e){retthen((function(t){return I.append(t,e)}))}))}),Promise.resolve([.map((function(e){return"'".concat(e,"'")}))),lw=/^\+?[1-9]\d{1,14}$/,fw=function(ection(e){return Boolean(e&&e.phoneNumber)}(e)?(r=e.phoneNumber,lw.test(r)?void t():n(new vf({cause:rf.SALEMOVE.INVALID_INPUT,message:"Invalid phone number: '".concat(e.phoneNumber,"'! Make sure that country code is present in the number and it has plus sign (+) prefix")}))):n(new vf({cause:rf.SALEMOVE.INVALID_INPUT,message:"'phone' was specified as the media but the 'phoneNumber' option is missing!"}));var r}))},pw=functiurn e&&e.hasOwnProperty("phoneExtension")}(e)&&(null!==(r=e.phoneExtension)&&!r.match(/^(,*\d,*){1,25}$/)))return n(new vf({cause:rf.SALEMOVE.INVALID_INPUT,message:"Invalid phone extension: '".concat(e.phoneExtension,"'! The phone extension can only contain commas and up to 25 digits.")}));var r;t()}))},dw=function(e){var t=e.media,n=e.options,r=e.availableMediaTypes,i=e.availableOneWayMediaTypes,o=e.visitorUpgradesAllowed,s=e.highestAllowedMediaType,a=[],u=!1===o?I.drop(r.indexOf(s),r):r;return a.push(function(e,t,n,r,i){return new Promise((function(o,s){if(i.oneWay){if(!1===r)return s(new vf({cause:rf.SALEMOVE.INVALID_INPUT,message:"This site does not support 'one-way' option!"}));if(!I.contains(e,n))return s(new vf({cause:rf.SALEMOVE.INVALID_INPUT,message:"Media must be one of: ".concat(cw(n),"!")}))}if(!i.oneWay&&!I.contains(e,t))return s(new vf({cause:rf.SALEMOVE.INVALID_INPUT,message:"Media must be one of: ".concat(cw(t),"!")}));o()}))}(t,u,i,o,n||{})),"phone"===t&&(a.push(fw(n)),a.push(pw(n))),uw(a)},hw=function(e){var t=e.options,n=e.availableMediaTypes,r=e.availableOneWayMediaTypes,i=e.visitorUpgradesAllowed,o=e.highestAllowedMediaType,s=[],a=!1===i?I.drop(n.indexOf(o),n):n;return s.push(function(e,t,n,r){return new Promise((function(i,o){if(e.audio){var s=["browser","phone"];if(!I.contains(e.audio,s))return o(new vf({cause:rf.SALEMOVE.INVALID_INPUT,message:"Audio must be one of: ".concat(cw(s),"!")}));if(!I.contains("audio",t)&&!I.contains("phone",t))return o(new vf({cause:rf.SALEMOVE.INVALID_INPUT,message:"Audio is not supported!"}))}if(e.video){var a=["one_way","two_way"];if(!I.contains(e.video,a))return o(new vf({cause:rf.SALEMOVE.INVALID_INPUT,message:"Video must be one of: ".concat(cw(a),"!")}));if("one_way"===e.video&&!1===r)return o(new vf({cause:rf.SALEMOVE.INVALID_INPUT,message:"This site does not support 'one-way' option!"}));if("one_way"===e.video&&!I.contains("video",n))return o(new vf({cause:rf.SALEMOVE.INVALID_INPUT,message:"One-way video is not supported!"}));if("two_way"===e.video&&!I.contains("video",t))return o(new vf({cause:rf.SALEMOVE.INVALID_INPUT,message:"Video is not supported!"}))}i()}))}(t,a,r,i)),"phone"===t.audio&&(s.push(fw(t)),s.push(pw(t))),uw(s)},vw=u((function e(t){var n=this;s(this,e);var r=t.visitor,i=t.operator;this.visitor=I.compose(I.evolve({phoneStatus:function(e){switch(e){case nc.MSG.PHONE_STATUSES.CONNECTED:return n.PHONE_STATUSES.CONNECTED;case nc.MSG.PHONE_STATUSES.CONNECTING:return n.PHONE_STATUSES.CONNECTING;default:return n.PHONE_STATUSES.UNUSED}}}),I.pickAll(["media","audioMuted","videoMuted","phoneStatus"]))(r),this.operator=I.pickAll(["media","audioMuted","videoMuted"],i)}));vw.prototype.PHONE_STATUSES={CONNECTED:"connected",CONNECTING:"connecting",UNUSED:"unused"};var bw=u((function e(t){var n=t.id,r=t.label,i=t.is_default,o=t.position;if(s(this,e),this.id=n,this.label=r,this.is_default=i,this.position=o,!this.id||!this.label)throw Yu.error("Survey choice missing parameters",{parameters:{id:n,label:r,is_default:i,position:o}}),new vf({cause:rf.SALEMOVE.INTERNAL_ERROR,message:"Survey choice is missing required parameters"})})),mw=u((function e(t){var n=this,r=t.id,i=t.text,o=t.name,a=t.type,u=t.required,c=t.position,l=t.options;s(this,e),this.id=r,this.text=i,this.name=o,this.type=a,this.required=u,this.position=c,this.options=l;var f=function(){return n.options&&Array.isArray(n.options)&&!I.isEmpty(n.options)};if("single_choice"===this.type&&f()&&(this.options=this.options.map((function(e){return new bw(e)}))),"single_choice"!==this.type||f()||Yu.warn("Single choice survey question missing options",{parameters:arguments[0]}),!(this.id&&this.text&&this.name&&this.type))throw Yu.error("Survey question missing parameters",{parameters:arguments[0]}),new vf({cause:rf.SALEMOVE.INTERNAL_ERROR,message:"Survey question is missing required parameters"})})),gw=u((function e(t,n){var r=this,i=t.survey;s(this,e),this.id=i.id,this.description=i.description,this.title=i.title,this.type=i.type,this.name=i.name,this.questions=i.questions.map((function(e){return new mw(e)})).filter((function(e){return!(e.type===r.QUESTION_TYPES.SINGLE_CH){return n({surveyId:i.id,answers:$l(e)})}}));gw.prototype.QUESTION_TYPES={BOOLEAN:"boolean",SCALE:"scale",TEXT:"text",SINGLE_CHOICE:"single_choice"};var yw=function(e){var t=e.stats,n=e.protocol,r=e.failureTagProperty,i=e.timeout,o=e.timeoutError,s=e.scheduler;return function(e,a){var u=e.resource,c=e.method,l=t.statApiUsage({protocol:n,resource:u})(c).attempted();return a().do(l.succeeded,I.compose(l.failed,I.prop(r))).timeoutWith(i,o.do(null,(function(){l.timedOut(),Yu.warn("'".concat(c,"' on resource ").concat(u," has timed out"))})),s).do((function(e){return Yu.log("Successfully executed ' '".concat(c,"' on resource ").concat(u))})).finally((function(){if(!l.isFinished())return l.failed("aborted")}))}},_w=new vf({cause:rf.SALEMOVE.NETWORK_TIMEOUT}),ww=["#inner-page",".socketio","script[src*='".concat(n.default.assets.server,"']"),"#cobrowsing-mouse-container","style[data-page-iframer='keep']"],Ew=n.default.visitor_app.is_custom_theme?["body > link","head > link"]:["link[href*='".concat(n.default.assets.server,"']"),"link[href*='".concat(n.default.api_url,"']"),"link[href*='https://uploads.salemove.com']"],Ow=ww.concat(Ew),Sw=function(){function e(t,n){s(this,e),this._retainedElementsBySelector=this._retainedElementsBySelector.bind(this),this._document=t,n||(n=[]),this),this._hideParentsOfKeptHiddenElements()}},{key:"_removeAccordingToFiltersLeavingTopLevelInPlace",value:function(){var e=I.chain(this._retainedElementsBySelector,this._filters),t=Wc(this._document.head.querySelectorAll("*")).concat(Wc(this._document.body.querySelectorAll("*")));return I.differenceWith(I.identical,t,e).filter((function(e){return"title"!==e.localName})).map((function(e){return e.parentNode.removeChild(e)}))}},{key:"_retainedElementsBySelector",value:function(e){var t=Wc(this._document.querySelectorAll(e));return I.chain((function(e){return Wc(e.querySelectorAll("*")).concat([e]).concat(Hc(e))}),t)}},{key:"_cleanHtmlElementOfUnnecessaryAttributes",value:function(){var e=this._document.querySelector("html");Wc(e.attributes).filter((function(t){return e.removeAttribute(t.name)})s._document.body.removeAttribute("style")}},{key:"_hideParentsOfKeptHiddenElements",value:function(){if(this._filters.length>0){var e=Wc(this._document.body.querySelectorAll("*")).filter(Bc),t=Wc(this._document.body.querySelectorAll(this._filters.join(","))),n=I.chain((function(e){var t=Wc(e.querySelectorAll("*")).concat([e]);return Bc(e)?t.concat(Hc(e)):t}),t);rEach((function(e){e.style.display="none"}))}}}]),e}(),Tw=sm.conf.visitor_app.css_prefix||"sm-",kw={id:"inner-page",getTargetUrl:function(){return window.location.href},document:window.document,nonRemoved:[]},Aw=function(){function e(t){s(this,e);var n=I.merge(kw,t);this._id=n.id,this._targetUrl=n.getTargetUrl(),this._targetDocument=n.document||window.document,this._iframeElement=this._createIframeElement(this._targetDocument);var r=(n.nonRemoved||[]).concat(["#".concat(this._id)]).concat(Ow);this._cleaner=new Sw(this._targetDocument,r),this._iframeTargetPointer=n.targetId,this._wrapIframe=n.wrapIframe}return u(e,[{key:"putIntoIframe",value:function(){var e=this;return new Promise((function(t,n){var r=Uy(e._targetDocument);return e._iframeElement.style.visibility="hidden",e._callWhenIframeLoaded((function(){return e._iframeElement.style.visibility="",qy(e._iframeElement.contentDocument,r),e._clearCurrentDom(),t({iframe:e._iframeElement})})),e._insertIframe()}))}},{key:"_clearCurrentDom",value:function(){return this._cleaner.clean()}},{key:"_createIframeElement",value:function(e){var t=e.createElement("iframe");return t.setAttribute("id",this._id),t}},{key:"_insertIframe",value:function(){var e;this._iframeElement.src=this._targetUrl,this._ensureBodyExists();var t=this._iframeSiblingElement();if(this._wrapIframe){var n=this._targetDocument.createElement("div");n.setAttribute("id","".concat(Tw,"inner-page-wrapper")),n.appendChild(this._iframeElement),e=n}else e=this._iframeElement;t?this._targetDocument.body.insertBefore(e,this._iframeSiblingElement()):this._targetDocument.body.appendChild(e),this._iframeElement.contentWindow.location.href=this._targgetElementById(this._iframeTargetPointer)}},{key:"_callWhenIframeLoaded",value:function(e){return this._iframeElement.addEventListener("load",(function t(n){return n.target.removeEventListener("load",t),e()}))}},{key:"_ensureBodyExists",value:function(){if(!this._targetDocument.body){var e=this._targetDocument.createElement("body");return this._targetDocument.appendChild(e)}}}]),e}(),xw="sm-wrapped-page",Iw=function(){function e(t){var n=t.document,r=t.nonRemoved;s(this,e),this.wrap=this.wrap.bind(this),this.unwrap=this.unwrap.bind(this),this.document=n,this.nonRemoved=(r||[]).concat(["#".concat(this._id)]).concat(Ow)}return u(e,[{key:"wrap",value:function(){var e=this._createWrappingDiv(),t=this.nonRemoved.join(", ");Wc(this.document.body.children).forEach((function(n){Gc(n,t)||Gc(n,"iframe")&&"none"===window.getComputedStyle(n).display||e.appendChild(n)}));var n=this.document.body.children[0];this.document.body.insertBefore(e,n)}},{key:"unwrap",value:function(){var e=this.document.getE((function(t){e.parentNode.appendChild(t)})),e.parentNode.removeChild(e))}},{key:"_createWrappingDiv",value:function(){var e=this.document.createElement("div");return e.id=xw,e.className=xw,e}}]),e}(),Nw=u((function e(t){var n=t.media,r=t.medias;s(this,e),this.media=n,this.medias=r})),Mw=function(e,t){"iframe"===e?document.querySelector("#inner-page").contentWindow.location.assign(t):window.location.href=t},Rw=function(e){var t=e.volatileNotifications,n=e.visitorPageAdaption;return t.filter(I.both(I.propEq("site_id",sm.siteId),I.propEq("event","navigation_to_url"))).map(I.prop("payload")).subscribe(Mw.bind(this,n),Yu.error.bind(Yu,"Unable to navigate to url"))},Cw=u((function e(t){var n=t.medraStream;s(this,e),this.stream=n.getWebMediaStream()})),Pw=function(){function e(t){var n=t.medraStream,r=t.connection;s(this,e),n.getWebMediaStream().getVideoTracks()[0].onended=fuopSharing=function(){return r.stop(),null}}return u(e,[{key:"stopSharing",value:function(){}}]),e}(),jw=u((function e(t){var n=t.status,r=t.screen;s(this,e),this.status=n,this.screen=r}));jw.prototype.STATUSES={SHARING:"sharing",NOT_SHARING:"not_sharing"};var Lw=u((function e(t){var n=t.status,r=t.screen;s(this,e),this.status=n,this.screen=r}));Lw.prototype.STATUSES={SHARING:"sharing",NOT_SHARING:"not_sharing"};var qw=u((function e(t){var n=t.onAccept,r=t.onDecline;s(this,e),this.accept=function(){return n().{returturundError"===e.name||"AbortError"===e.name},Vw=function(e){return"Permission denied by system"===e.message?new vf({cause:rf.SALEMOVE.DENIED_BY_SYSTEM}):new vf({cause:rf.SALEMOVE.CANCEL})},Fw=function(e){var t,n=e.conf,r=e.channelObservable,i=e.namespace,o=e.videoProvider;return tc("Medra").map(I.prop("default")).map((function(e){return new e({webRTC:{iceServers:n.communications.webrtc_server,videoProvider:o}})})).flatMap((function(e){return r.do((function(){t&&(sm.logger.info("Stopping Medra connection due to new channel"),t.stop())})).flatMap((function(t){var n=t.channel;return el(e.connect(n,{namespace:i}))})).do((function(e){t=e}))}))},Bw=function(){function e(t){var n=t.adapter,r=t.operatorScreenSharedObservable,i=t.visitorScreenSharedObservable,o=t.screenShareRequestedObservable;s(this,e),this.EVENTS={OPERATOR_STATE_UPDATE:"operator_state_update",VISITOR_STATE_UPDATE:"visitor_state_update",SCREEN_SHARING_REQUEST:"screen_sharing_request"};var a=I.fromPairs([[this.EVENTS.OPERATOR_STATE_UPDATE,r],[this.EVENTS.VISITOR_STATE_UPDATE,i],[this.EVENTS.SCREEN_SHARING_REQUEST,o]]);n.proxyAll(a),this.addBufferedEventListener=n.addEventListener,this.removeBufferedEventListener=n.removeEventListener}return u(e,null,[{key:"start",value:function(t){var n,r,i=t.conf,o=t.channelObservable,s=t.connectMedra,a=t.fromRxJs5,u=t.scheduler,c=t.videoProvider,l=t.isReestablishing,f=t.stats;a||(a=el),s||(s=Fw);var p=new ju.Subscription,d=new ju.Subject,h=new ju.Subject;c||(c=function(e,t){var n=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:Uw()).mediaDevices;return{getStream:function(){return new Promise((function(r,i){t.next(new qw({onAccept:function(){Yu.info("Requesting screen capture");var t=e.statScreenShareUsage({stage:"capture",resource:"visitor_api.screen_sharing"}).attempted();return n.getDisplayMedia({video:!0}).then((function(e){r(e),Yu.info("Screen capture successful"),t.succeeded()})).catch((function(e){return i(e),"NotAllowedError"===e.name?(Yu.info("Screen capture permissions denied",e),t.failed("canceled"),Promise.reject(Vw(e))):Dw(e)?(Yu.info("Screen capture failed due to no access to screen",e),t.failed("device-error"),Promise.reject(new vf({cause:rf.SALEMOVE.DEVICE_ACCESS_ERROR}))):"SecurityError"===e.name?(Yu.info("Screen capture failed due to Permissions Policy",e),t.failed("permissions-policy"),Promise.reject(new vf({cause:rf.SALEMOVE.DENIED_BY_PERMISSIONS_POLICY}))):(t.failedUnknown(),Promise.reject(new vf({cause:rf.SALEMOVE.INTERNAL_ERROR})))}))},onDecline:function(){sm.logger.info("Screen sharing request declined"),i({name:"NotAllowedError"})}}))}))}}}(f,h));var v=new ju.Subject,b=v.switchMap((function(){return s({conf:i,channelObservable:o,namespace:"visitor-screensharing",videoProvider:c})})).publishReplay(1);if(ion(t){return{proposal:t,connection:e}}))})).subscribe((function(e){var t=e.proposal,n=e.connection,r=f.statScreenShareUsage({stage:"sharing",resource:"visitor_api.screen_sharing"}).attempted();return t.accept({video:{type:"browser"}}).then((function(e){var t=e.localVideoStream;r.succeeded(),sm.logger.info("Screen sharing succeeded"),d.next({connection:n,localVideoStream:t})})).catch((function(e){e&&e.cause===n.ERRORS.DENIED_BY_SYSTEM?(r.failed("canceled"),sm.logger.info("Screen sharing canceled")):e&&e.cause===n.ERRORS.DEVICE_ACCESS_ERROR?(r.failed("device_access_error"),sm.logger.warn("Screen sharing failed due to device access error",e)):(r.failedUnknown(),sm.logger.warn("Screen sharing failed",e))}))}),sm.logger.error.bind(sm.logger,"Failed to receive screen sharing request")),l){p.add(b.take(1).subscribe((function(e){return e.reestablish().then((function(t){var n=t.localVideoStream;if(n)return d.next({connection:e,localVideoStream:n})}))}),sm.logger.error.bind(sm.logger,"Failed to reestablish visitor screen")))}var m=new jw({status:jw.prototype.STATUSES.NOT_SHARING}),g=(n=s({conf:i,channelObservable:o,namespace:"operator-screensharing"}).switchMap((function(e){var t=a(e.communicationRequest).pipe(an((function(t){return ju.Observable.from(t.accept({})).catch((function(t){return t&&t.cause===e.ERRORS.REMOTE_PARTICIPANT_ERROR?sm.logger.info("Failed to receive operator screen due to error on operator side",t):sm.logger.warn("Failed to receive operator screen",t),ju.Observable.empty()}))})));return l?ju.Observable.merge(ju.Observabr t=e.remoteVideoStream;return!I.isNil(t)})):t})).do((function(){return sm.logger.info("Remote screen sharing stream received")})).flatMap((function(e){var t=e.remoteVideoStream,n=ju.Observable.defer((function(){var e="playing"===t.getMediaState()?jw.prototype.STATUSES.SHARING:jw.prototype.STATUSES.NOT_SHARING;return ju.Observable.of(new jw({screen:new Cw({medraStream:t}),status:e}))})),r=a(t.observe(t.EVENTS.DISCONNECTED)).map((function(){return m}));return ju.Observable.merge(n,r)}))).startWith.apply(n,w([m,u].filter(I.identity))),y=new Lw({status:Lw.prototype.STATUSES.NOT_SHARING}),_=null,E=(r=d.do((function(){return sm.logger.info("Screen sharing request accepted")})).switchMap((function(e){var t=e.localVideoStream,n=e.connection;_=new Pw({medraStream:t,connection:n});var r=ju.Observable.of(new Lw({screen:_,status:Lw.prototype.STATUSES.SHARING})),i=a(t.observe(t.EVENTS.DISCONNECTED)).do((function(){return v.next({})})).map((function(){return y}));return ju.Observable.merge(r,i)}))).startWith.apply(r,w([y,u].filter(I.identity))).share(),O=Kf();return{screenSharing:new e({adapter:O,operatorScreenSharedObservable:g,visitorScreenSharedObservable:E,screenShareRequestedObservable:h}),stopScreenSharing:function(){_&&_.stopSharing(),O.stop(),p.unsubscribe()}}}}]),e}(),Hw=u((function e(t){var n=t.id,r=t.properties;ssm.conf.visitor_app.visitor_page_adaption},Gw=function(){return Ww()?document.getElementById("inner-page").contentWindow.document:document},zw=function(e){try{var t=Gw();return Ww()?t.body.querySelector(e):t.querySelector(e)}catch(e){return Yu.info("Target element not found",{error:e}),null}},Jw="virtual_assistant_cobrowsing_cursor",Yw="virtual_assistant_cobrowsing_cursor_label",Qw=function(e){var t=e.cursorIdentifier,n=e.onRemove;if(!Ww()){var r=zw(t||"#"+Jw);if(r&&(r.parentElement.removeChild(r),n))return n()}},Kw=function(e,t){var n=zw("#"+Jw);if(!n){var r=function(){var e=Gw().createElement("div");return e.setAttribute("id",Jw),e.style.display="none",e.style.opacity="0",e.style.position="absolute",e.style.zIndex="10",e.style.top="0",e.style.left="0",e.style.width="20px",e.style.height="20px",e.style.backgroundRepeat="no-repeat",e.style.backgroundImage="url('data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAAwAAAARCAYAAADpPU2iAAAAAXNSR0IArs4c6QAAAiNJREFUKBV1kl9oUlEcx39eR21JEAwEHQQ9OKcr2mDoemgsfV5vSdFLqzEu9NSo6MHF8iUIevRBtJfyrdjbarVQF8un7ELWnKUiNzFw88+qqyL3evoe22LG/MGHe87vfL+/37nnHGprWpLtRSKROE9EAugdrVZL8ly+yhYX7zNN01rRaHQa6t6mRqPxaWraxSBi0dg6U1W1GQgEzvQ0wbApijc7Bm56tfqaIbfj9XpPYa4D3dFsNtPXb8z/M2CVRSIxpiiK7Ha7BzHvNsGQ/d8ADUsmP7NqtSrBYDjYQtDpdIf8ICOnc5JKpe2xWq0Wg2Fg38TFffuTg996/Tc5HA4qFn9MVCqVVaz183Vu0PPBYbG7WyO73UbfMtmpQqHwFJr+PuFvdOkFvZ4eLPkI90Ky/J0aikJDZvOlcql0gm8H8EMiWli4Tfl8npaXX9Ds7DVaW3uTbbfVejaXPappKplNpkHCRVUsVjsTBH3ngZR3yp0jttlsLBgMbqEO30oQBMBDgRjT37t7h95vbJAoih9WXq7knJPnKJVK0bBl2OrxeH5B+G6PNLXRgpf2+/2bSD43Go3hjwmp08U6YmOyLOeQHwMmMER4cSyXychcDB6DOVT/Mjp6umMKhZ4wn88nIn8ckPA2Erl1dnz8GcbbIAHWw+Hwo1AwRAPHDCRJErlcrivIG4EAyALmwRwYAUfAyXg8Hi0Wiq2vW+mfF2dmeMELwPAHu44LBYcnDWwAAAAASUVORK5CYII=')",e}(),i=function(e,t){var n=Gw().createElement("div");return n.setAttribute("id",Yw),n.style.display="inline-block",n.style.color="#ffffff",n.style.fontSize="13px",n.style.padding="2px 12px",n.style.margin="18px 0 0 14px",n.style.boxShadow="1px 1px 4px rgba(50, 50, 50, 0.75)",n.style.border="1px solid #ffffff",n.style.borderRadius="4px",n.style.backgroundColor="#232323",n.style.whiteSpace="nowrap",n.innerText=t,n}(0,t);r.appendChild(i),n=Gw().body.appendChild(r)}return n.style.display="block",ju.Observable.of({cursor:n})},Xw=function(e){return function(t){var n=t.interval.value+1;e.style.left=function(e,t){return(t=e.cursorInitialPosLeft-e.cursorDistanceDiffLeft*t/e.totalCircleSteps).toFixed(0)}(t,n)+"px",e.style.top=function(e,t){return(t=e.cursorInitialPosTop-e.cursorDistanceDiffTop*t/e.totalCircleSteps).toFixed(0)}(t,n)+"px"}},$w=function(e,t){var n=10*t;e.style.left=function(e,t){return(e+3*Math.cos(t*Math.PI/180)).toFixed(0)}(e.offsetLeft,n)+"px",e.style.top=function(e,t){return(e-3*Math.sin(t*Math.PI/180)).toFixed(0)}(e.offsetTop,n)+"px"},Zw=function(e){return e||(e={moveCursorToPosition:Xw,moveFrequency:20}),function(t){var n,r,i,o=t.cursor.offsetLeft,s=t.cursor.offsetTop,a=(n=t.targetElement,r=n.getBoundingClientRect(),i=r.top+Gw().documentElement.scrollTop,{left:r.left+Gw().documentElement.scrollLeft+n.offsetWidth/2,top:i+n.offsetHeight/2}),u=o-a.left,c=s-a.top,l=Math.abs((u+c)/50).toFixed(0),f=l>0?l:1;return ju.Observable.inteDiffTop:c,totalCircleSteps:l,interval:e}})).do(e.moveCursorToPosition(t.cursor)).skip(f-1).take(1).mapTo(t)}},eE=function(e){return e||(e={moveCursorCirclePosition:$w,circleFrequency:50}),function(t){return ju.Observable.inteoveCursorCirclePosition(t.cursor,n.value)})).skip(107).take(1).mapTo(t)}},tE=function(e,t){e.style.opacity=t>=1?1:(parseFloat(t)+.1).toFixed(1)},nE=function(e,t){t<=.1?(e.style.opacity=0,e.style.display="none"):e.style.opacity=(parseFloat(t)-.1).toFixed(1)},rE=function(e,t,n){return ju.Observable.interval(t.stepDuration).do((function(){var r=e.cursor.style.opacity;"in"===n&&t.fadeInStep(e.cursor,r),"out"===n&&t.fadeOutStep(e.cursor,r)})).skip(9).take(1).mapTo(e)},iE=function(e){return e||(e={fadeInStep:tE,stepDuration:20}),function(t){return rE(t,e,"in")}},oE=function(e){returon:1}},sE=function(e){e.targageocalStorage.setItem(aE,JSON.stringify(e))},lE=function(e){cE([].concat(w(u().filter((function(t){return t.id!==e.id})))},pE="virtual_assistant_cobrowsing",dE="point",hE="scroll",vE="click",bE="navigate",mE=[hE,dE,vE],gE=function(e){return e.targetElement.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})},yE=function(e,t){e.operatorName;var n=e.operatorFormattedName;return function(e){var t,r,i=e.properties[pE];if(t=i.target,!((r=i.type)===bE?t&&t.length:I.contains(r,mE)?Boolean(zw(t)):(Yu.info("Invalid Virtual Assistant Cobrowsing action type",{type:r}),0)))return fE(e),ju.Observable.of(e);switch(i.type){case dE:return Kw(0,n).map(I.assoc("targetElement",zw(i.target))).do(gE).flatMap(iE()).flatMap(Zw()).flatMap(eE()).flatMap(oE()).do((function(){return fE(e)})).mapTo(e);case vE:return Kw(0,n).map(I.assoc("targetElement",zw(i.target))).do(gE).flatMap(iE()).flatMap(Zw()).flatMap(eE()).do((function(){return fE(e)})).do(sE).flatMap(oE()).mapTo(e);case hE:return Kw(0,n).map(I.assoc("targetElement",zw(i.target))).do(gE).flatMap(iE()).flatMap(Zw()).do((function(){return fE(e)})).mapTo(e);case bE:return function(e){return Ww()?document.getElementById("inner-page").contentWindow.location.assign(e):window.location.href=e,ju.Observable.of({})}(i.target).do((function(){return fE(e)})).mapTo(e);default:throw new Error("Unknown action: "function(e){return I.has(pE,e.properties)},EE=u((function e(t){var n=this,r=t.media,i=t.medias,o=t.onAccept,a=t.onDecline,u=t.validateMedia;s(this,e),this.media=r,this.medias=i,u=u||dw;this.select=function(e,t){return u({options:t,availableMediaTypes:n.medias,availableOneWayMedianction(e,t){return o({media:e,options:t})}(e,t)}))},this.decline=a})),OE=new vf({cause:rf.SALEMOVE.NETWORK_TIMEOUT}),SE=function(e){var t=e.visitorId,r=e.engagementId,i=e.volatileNotifications,o=e.engagementStateObservable,s=e.wsProxy,a=e.apiTimeoutMilliseconds,u=e.stats,c=yw({stats:u,protocol:"rest",failureTagProperty:"message",timeout:a,timeoutError:ju.Observable.throw(OE)});return{mediaUpgradeRequestObservable:function(e,t){var n=I.propEq("event_type","engagement.media_upgrade_request"),r=I.pathEq(["media_upgrade_request","engagement_id"],e),i=I.pathEq(["media_upgrade_request","target"],"visitor"),o=I.compose(I.pick(["id","audio","video"]),I.prop("media_upgrade_request"));return t.filter(I.allPass([n,r,i])).map(o)}(r,i),mediaStateObservable:function(e){return e.filter(I.identity).map(I.prop("media")).distinctUntilChanged(I.equals)}(o),requestMediaUpgrade:function(e){var t=e.mediaUpgradeRequest;return c({resource:"media-upgrade-request",method:"create"},(function(){return s.request({method:"POST",url:"".concat(n.default.api_url,"/engagements/").concat(r,"/media_upgrade_requests"),payload:t,headers:pf}).catch((function(e){return yf(e,{allowedCauses:[rf.SALEMOVE.INVALID_INPUT,rf.SALEMOVE.NETWORK_TIMEOUT,rf.SALEMOVE.CONFLICT]})}))})).toPromise()},acceptUpgradeRequest:function(e,t){return c({resource:"media-upgrade-request",method:"accept"},(function(){return s.request({method:"PATCH",url:"".concat(n.default.api_url,"/engagements/").concat(r,"/media_upgrade_requests/").concat(e.id),payload:I.merge(t,{action:"accept"}),headers:pf}).catch((function(e){return yf(e,{allowedCauses:[rf.SALEMOVE.INVALID_INPUT,rf.SALEMOVE.NETWORK_TIMEOUT,rf.SALEMOVE.CONFLICT]})}))})).toPromise()},declineUpgradeRequest:function(e){return c({resource:"media-upgrade-request",method:"decline"},(function(){return s.request({method:"PATCH",url:"".concat(n.default.api_url,"/engagements/").concat(r,"/media_upgrade_requests/").concat(e.id),payload:{action:"decline"},headers:pf}).catch((function(e){return yf(e,{allowedCauses:[rf.SALEMOVE.INVALID_INPUT,rf.SALEMOVE.NETWORK_TIMEOUT,rf.SALEMOVE.CONFLICT]})}))})).toPromise()},removeVideo:function(){return c({resource:"engagement-participant",method:"remove video"},(function(){return s.request({method:"PATCH",url:"".concat(n.default.api_url,"/engagements/").concat(r,"/participants/").concat(t),payload:{action:"remove_video"},headers:pf}).catch(yf)})).map((function(){return{}})).toPromise()},removeAudio:function(){return c({resource:"engagement-participant",method:"remove audio"},(function(){return s.request({method:"PATCH",url:"".concat(n.default.api_url,"/engagements/").concat(r,"/participants/").concat(t),payload:{action:"remove_audio"},headers:pf}).catch(yf)})).mapion(e){return/android/i.test(e.userAgent)},kE=Object.freeze({__proto__:null,screenCapturingSupported:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.navigator;return Boolean(I.path(["mediaDevices","getDisplayMedia"],e))&&!TE(e)}}),AE=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ng,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:kE,n=e.canReceiveMedia()?["browser"]:[],r=e.canSendMedia()?["browser"]:[];return{canReceive:{video:n,audio:n.concat(["phone"])},canSend:{video:r,audio:r.concat(["phone"])},canShareScreen:t.screenCapturingSupported()&&e.canSendMedia()}},xE=function(e,t){return t.filter(tw).map((function(t){var n=t.upgradeRequest,r=t.currentMediaState,i=function(e,t){if("two_way"===e.video)return{media:"video",medias:["video"]};if("two_way"===e.audio)return{media:"audio",medias:t.canSend.audio.map(ew)};throw new Error("Tried to create upgrade offer for one way media")}(n,AE());return new EE(I.merge(i,{onAccept:function(t){return e.acceptUpgradeRequest(n,function(e,t){var n=(e.options?e.options.phoneNumber:void 0)||I.path(["audio","phone_number"],t),r=(e.options?e.options.phoneExtension:void 0)||I.path(["audio","phone_extension"],t);return{audio_type:"video"===e.media?I.path(["audio","type"],t)||"browser":"phone"===e.media?"phone":"browser",phone_number:n,phone_extension:r}}(t,r)).then(I.always({}))},onDecline:function(){return e.declineUpgradeRequest(n).then(I.always({}))}}))})).share()},IE=function(e){var t,n=e.commsApi||SE(I.pick(["engagementId","visitorId","volatileNotifications","engagementStateObservable","wsProxy","apiTimeoutMilliseconds","stats"],e)),r=new ju.Subscription,i=n.mediaUpgradeRequestObservable.switchMap((t=e.channelOmms:media_upgrade_request:ack",{id:e.id})})).mapTo(e)})).withLatestFrom(n.mediaStateObservable).map(I.zipObj(["upgradeRequest","currentMediaState"])).share();r.add(function(quest automatically",{upgrade_request:t})})).switchMap((function(t){var n=t.upgradeRequest,r=t.currentMediaState;return e.acceptUpgradeRequest(n,{audio_type:I.path(["audio","type"],r),phone_number:I.path(["audio","phone_number"],r),phone_extension:I.path(((function(){return ju.Observable.empty()})).subscribe((function(){}))}(n,i));return r.add(nc.vent.observable(nc.MSG.ENGAGEMENT_REMOVE_AUDIO).subscribe(n.removeAudio,Yu.error.bind(Yu,"Error removing visitor's audio"))),{removeVideo:n.removeVideo.bind(n),mediaUpgradeOffers:xE(n,i),mediaStateObservable:n.mediaStateObservable,requestMediaUpgrade:function(e){return n.mediaStateObservable.take(1).switchMap((function(t){var r=function(e){var t=e.options,n=e.currentMediaState,r=I.path(["audio","direction"],n),i=I.path(["video","direction"],n),o=t.audio?nw:null,s=t.video?t.video:null,a=iw(o,r),u=iw(s,i),c=I.path(["audio","phone_number"],n)||t.phoneNumber||null,l=I.path(["audio","phone_extension"],n)||t.phoneExtension||null;return{audio:a,video:u,audio_type:I.path(["audio","type"],n)||t.audio||null,phone_number:c,phone_extension:l}}({options:e,currentMediaState:t});return n.requestMediaUpgrade({mediaUpgradeRequest:rays({}))},stop:function(){r.unsubscribe()}}},NE=new vf({cause:rf.SALEMOVE.NETWORK_TIMEOUT}),ME=function(e){return e instanceof DOMException?mf(e):e instanceof vf?e:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(0===e)return new vf({cause:rf.SALEMOVE.CONNECTION_LOST});var o=I.equals(e,404)?rf.SALEMOVE.RESOURCE_NOT_FOUND:I.contains(e,uf)?rf.SALEMOVE.INVALID_INPUT:I.equals(e,429)?rf.SALEMOVE.TOO_MANY_REQUESTS:401===e||403===e?rf.SALEMOVE.FORBIDDEN:(Yu.warn("An INTERNAL_ERROR error from XHR occurred. Can we expose this error as non-internal?",i({status:e,message:n,responseText:t},r)),rf.SALEMOVE.INTERNAL_ERROR),s=function(){try{return JSON.parse(t).message}catch(e){}};return n||(n=t?s():void 0),new vf(n?{cause:o,message:n}:{cause:o})}(e.status,e.response&&e.response.text&&e.response.text(),e.response?e.response.message:void 0,e)},RE=function(){function e(t,n){var r=this,i=t.id,o=t.securityScanningRequired,a=t.url;if(s(this,e),this.id=i,this.securityScanningRequired=o,this.url=a,this.securityScanningRequired){var u=I.pathEq(["security_scan_result","file_id"],this.id);this.scanResultObservable=n.find(u).map(I.path(["security_scan_result","result"])).map((function(e){return{result:e,file:r}}ject("Security scanning is not required")}}]),e}(),CE=function(e,t,n,r,i){var o=n.onUploadProgress,s=n.getRequestHeaders,a=new FormData;a.append("content",t),a.append("site_id",sm.siteId);var u=Fy(e?"/engagements/".concat(e,"/files"):"/messaging/files");return I.contains(t.type,i)?t.size>25e6?ju.Observable.throw(new vf({cause:rf.SALEMOVE.FILE_TOO_LARGE,message:"File exceeds the maximum file size"})):function(e){var t=e.method,n=e.url,r=e.payload,i=e.onUploadProgress,o=e.getRequestHeaders;return Uf({method:t,url:n,payload:r,responseType:"json",onUploadProgress:i,getRequestHeaders:o})}({url:u,method:"POST",payload:a,getRequestHeaders:s,onUploadProgress:o}).map((function(e){var t=e.response;return new RE({id:t.file_id,securityScanningRequired:t.security_scanning_required,url:u},r)})).catch((function(e){return ju.Observable.throw(ME(e))})):ju.Observable.throw(new vf({cause:rf.SALEMOVE.FILE_CONTENT_TYPE_NOT_ALLOWED,message:"File content type is not allowed"}))},PE=["visitor_authenticatedt){var n=t.iframe;s(this,e),thison(){nc.vent.trigger("visit:restore_url")}}]),e}(),LE=u((function e(t){var n=t.unwrap;s(this,e),this.unwrap=n})),qE=u((function e(){s(this,e),this.responsePromise=ju.Observable.merge(nc.vent.observable(nc.MSG.ALLOW_STREAM).map(I.always("allowed")),nc.vent.observable(nc.MSG.DENY_STREAM).map(I.always("denied"))).take(1).toPromise()})),UE=u((function e(t){var n=t.asynchronous;s(this,e),this.asynchronous=n})),DE=u((function e(t){var n=t.status,r=t.authenticated,i=t.isAsyncTransfer;s(this,e),this.status=n,this.authenticated=r,this.transfer="transferring"===n?new UE({asynchronous:i}):{}}));DE.prototype.STATUSES={ENGAGED:"engaged",TRANSFERRING:"transferring"};var VE=u((function e(t){var n=t.text;s(this,e),this.text=n})),FE=function(){function e(t){var n=this;s(this,e),this.startSalemoveViews=this.startSalemoveViews.bind(this);var r=t.engagementId,i=t.subEngagementId,a=t.startingMedia,u=t.type,c=t.isReestablishing,l=t.chat,f=t.stopChat,p=t.webRtcMode,d=t.enabledMediaLevel,h=t.channelObservable,v=t.operator,b=t.operatorFocusObservable,m=t.communicationWidget,g=t.createEngagementObservable,y=t.mediaStateObservable,_=t.backend,w=t.platform,E=t.startScreenSharing,O=t.stateObservable,S=t.statsClient,T=t.entrypoint,k=t.volatileNotifications,A=t.statusObservable,x=t.comms,N=t.events,M=t.surveyApi,R=t.getRequestHeaders,C=t.siteVisitorNotifications,P=t.createdAt,j=t.cobrowser;this.engagementId=r,this.chat=l,this.mediaState=null,this.isReestablishing=c,this.createdAt=P,this.subEngagementId=i,this.startingMedia=a,this.type=u,this.operator=v,this.cobrowser=j,this.allowFileSending=sm.conf.communications.allow_file_sending,this.allowedFileContentTypes=sm.conf.communications.allowed_file_content_types;var L=E({conf:sm.conf,channelObservable:h,isReestablishing:this.isReestablishing,stats:S}),q=L.screenSharing,U=L.stopScreenSharing;this.screenSharing=q;var D=new ju.Subscription,V=t.engagementEndObservable.map((function(e){return"object"!==o(e)&&null!==e?{}:I.pick(n.ENGAGEMENT_END_EVENT_PAYLOAD_KEYS,e)})).take(1);y=y.publishReplay(1).refCount(),b=b.map((function(e){return"chat"===e?n.FOCUS_TARGETS.CHAT:"cobrowse"===e?n.FOCUS_TARGETS.COBROWSER:(Yu.error("Unexpected focus target!",e),"")}));var F=nc.vent.observable(nc.MSG.PUBLIC.ENGAGEMENT_MEDIA_UPGRADE_REQUEST).map(I.construct(Nw)),B=nc.vent.observable(nc.MSG.WILL_ASK_MEDIA_PERMISSION).map(I.construct(qE));c||localStorage.removeItem(aE);var H=function(e){return e.pipe(wn(I.propEq("event",_E)),kt((function(e){var t=e.payload,n=e.custom_command_id;return I})})),wn((function(e){return I.not(wE(e))})),pi(I.prop("id")),ts((function(e){return Yu.info("Custom Command: received",{custom_command_id:e.id})})))}(k),W=function(e){var t=ju.Observable.from(uE()),n=e.pipe(wn(I.propEq("event",_E)),kt((function(e){var t=e.payload,n=e.custom_command_id;return I:t,id:n})})),wn((function(e){return wE(e)})),pi(I.prop("id")),ts((function(e){return Yu.info("Virtual CoBrowsing Command: received",{custom_command_idnd: processing",{custom_command_id:e.id})})))}(k).concatMap(yE({operatorName:v.name,operatorFormattedName:v.formattedName})).subscribe((function(){}),Yu.error),G=Qf(),z=O.distinctUntilChanged(I.equals,function(e){return new VE(e.capabilities)})),J=I.fromPairs([[this.EVENTS.END,V],[this.EVENTS.STATE_CHANGE,O.map((function(e){return{status:e.status,authenticated:I.propOr(!1,"authenticated")(e.visitor),isAsyncTransfer:H_(e)}})).map(I.construct(DE))],[this.EVENTS.CAPABILITIES,z],[this.EVENTS.MEDIA_UPGRADE_OFFER,x.mediaUpgradeOffers],[this.EVENTS.FOCUS,b],[this.EVENTS.MEDIA_STATE_CHANGE,y],[this.EVENTS.MEDIA_PERMISSION_REQUEST,B],[this.EVENTS.WIDGET_MEDIA_UPGRADE_REQUEST,F],[this.EVENTS.CUSTOM_COMMAND,H]]);G.proxyAll(J),this.addEventListener=function(e,t){e===this.EVENTS.COBROWSING_REQUEST?this.cobrowser.addUnbufferedEventListener(Z_.prototype.EVENTS.COBROWSING_REQUEST,t):G.addEventListener(e,t)},this.removeEventListener=function(e,t){e===this.EVENTS.COBROWSING_REQUEST?this.cobrowser.removeUnbufferedEventListener(Z_.prototype.EVENTS.COBROWSING_REQUEST,t):G.removeEventListener(e,t)},this.recordEvent=function(e){return N.recordEvent(e)};var Y=I.propEq("event_type","engagement.files.security_scan_result"),Q=C.filter(Y).publishReplay(this.SCAN_EVENT_REPLAY_COUNT);D.add(Q.connect()),this.uploadFile=function(e,t){t||(t={});var n=t.onUploadProgress;return CE(this.engagementId,e,{onUploadProgress:n,getRequestHeaders:R},Q,this.allowedFileContentTypes).toPromise()},this.getChatTranscript=function(){return _.chatTranscript().then((function(e){return Promise.resolve(I.map((function(e){var t=e.id,n=e.message,r=e.sender,i=e.attachment,o=e.metadata,s=e.created_at,a=r.type;return"operator"===a?new Zy({id:t,content:n,attachment:i,metadata:o,created_at:s,sender:r}):"visitor"===a?new Xy({id:t,content:n,status:Xy.prototype.STATUSES.DELIVERED,attachment:i,created_at:s}):null}),e))}))},this.observable=function(e){return e===this.EVENTS.COBROWSING_REQUEST?this.cobrowser.observable(Z_.prototype.EVENTS.setTimeout((function(){return G.stop()}))};V.subscribe((function(){}),K,K),this.iframePage=function(e){e||(e={});var t=e.keptElementSelectors;Yu.info("Engagement: Iframe page started");rl:function(){return window.location.href},document:window.document,nonRemoved:t||[]});return sm.visitorPageNotifierSubscription&&sm.visitorPageNotifierSubscription.unsubscribe(),sm.trackerSubscription.unsubscribe(),sm.cobraSubscription.unsubscribe(),n.putIntoIframe().then((function(e){var t=e.iframe;return Yu.info("Engagement: Iframe page finished"),Promise.resolve(new jE({iframe:t}))}))},this.wrapPage=function(e){e||(e={});var t=e.keptElementSelectors;Yu.info("Engagement: Wrap page started");var n=new Iw({document:window.document,nonRemoved:t||[]});return n.wrap(),Yu.info("Engagement: Wrap page finished"),Promise.resolve(new LE({unwrap:n.unwrap}))};var X=sw({stateObservable:O}).share();D.add(Rw({volatileNotifications:k,visitorPageAdaption:sm.conf.visitor_app.visitor_page_adaption})),this.getSurvey=function(){return M.fetchSurvey()};var $=G.eventWithoutListenerObservable(this.EVENTS.WIDGET_MEDIA_UPGRADE_REQUEST);D.add($.subscribe((function(){console.warn("No listener set for the Engagement WIDGET_MEDIA_UPGRADE_REQUEST event. See 'WidgetMediaUpgradeRequest' documentation for how to add the listener to enable media upgrades from the sm-engaged-visitor widget."),Yu.warn("Listener is not set for WIDGET_MEDIA_UPGRADEd(y.subscribe((function(e){n.mediaState=e}),Yu.error));var Z=g({engagement:this,transfers:X,channelObservable:h,webRtcMode:p,statusObservable:A});m.start(Z),this.communicationWidget=m;var ee=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return m.stop({mediaContinues:Boolean(e.isEngagementRestart)}),x.stop(),f(),U(),Qw({}),Yu.info("Triggering ENGAGEMENT_END event"),nc.vent.trigger(nc.MSG.PUBLIC.ENGAGEMENT_END,n),D.unsubscribe()};this.start=function(){var e;n.isReestablishing||(e=["action:reach","stage:establish-engagement"],S.increment("engagement.flow",["entrypoint:".concat(T)].concat(e)));var t,r=nc.vent.trigger.bind(nc.vent,nc.MSG.ENGAGEMENT_TRANSFERRED);t={engagementObservable:Z},nc.reqres.setHandler("get:engagement_observables",I.always(t)),D.add(X.subscribe((function(e){return function(e){n.operator=Jg({id:e.operatorId,name:e.operatorName,formattedName:e.operatorFormattedName,picture:{url:e.operatorPicture},mediaType:e.operatorMedia,webRtcMode:p,enabledMediaType:d})}(e),r(e)}),Yu.error)),D.add(V.subscribe(ee,Yu.error)),nc.vent.trigger(nc.MSG.PUBLIC.ENGAGEMENT_START,n)},this.upgrade=function(e){if(w===ff)return Promise.reject(new vf({cause:rf.SALEMOVE.NOT_SUPPORTED,message:"Unsupported functionality for OmniBrowse engagement"}));var t=n.operator.state.media,r=n.operator.state.oneWayMedias,i=sm.conf.communications.allow_upgrade_requests,o=n.mediaState.operator.media,s="phone"===o?"audio":o;return Yu.info("Initiating media upgrade",{audio_type:e.audio,video_type:e.video,caller:(e?e.caller:void 0)||"client_integrator"}),hw({options:e,availableMediaTypes:t,availableOneWayMediaTypes:r,visitorUpgradesAllowed:i,highestAllowedMediaType:s}).then((function(){return x.requestMediaUpgrade(e)}))},this.end=function(){return ee(),_.end().then(I.always({})).catch((function(e){return 422===(e?e.status:void 0)?(Yu.warn("Engagement already ended",{error:e,engagement_id:n.engagementId}),Promise.reject(new vf({cause:rf.SALEMOVE.CONFLICT}))):I.isNil(e.status)?(Yu.warn("Engagement end failed. No connection",{error:e,engagement_id:n.engagementId}),Promise.reject(new vf({cause:rf.SALEMOVE.NETWORK_TIMEOUT}))):e.status>500&&e.status<=504?(Yu.warn("Engagement end failed. Service unavailable",{error:e,engagement_id:n.engagementId}),Promise.reject(new vf({cause:rf.SALEMOVE.NETWORK_TIMEOUT}))):(Yu.error("Engagement end failed",{error:e,engagement_id:n.engagementId}),Promise.reject(new vf({cause:rf.SALEMOVE.INTERNAL_ERROR})))}))};var te=new ju.Subject;this.notifyOfFocusChange=function(e){return te.next(e)};var ne=te.asObservable(n(e,t){returnhannel.emitAll("visitor:focus_changed",t)}),Yu.error);D.add(ne),D.add(W)}return u(e,[{key:"start",value:function(){}},{key:"upgrade",value:function(e){return null}},{key:"iframePage",value:function(e){return null}},{key:"wrapPage",value:function(e){}},{key:"getSurvey",value:function(){return null}},{key:"end",value:function(){return null}},{key:"notifyOfFocusChange",value:function(){retent#startSalemoveViews is not supported")}},{key:"addEventListener",value:functioremoveEventListener",valueecordEvent",value:functioloadFile",value:function(e,t){return null}},{key:"getChatTranscript",value:function(){return null}}],[{key:"create",value:function(t){var n=t.engagementId,r=t.subEngagementId,i=t.startingMedia,o=t.mediaState,s=t.type,a=t.isReestablishing,u=t.initialChatHistoryObservable,c=t.operator,l=t.statsClient,f=t.cobra,p=t.channelObservable,d=t.platform,h=t.engagementApi,v=t.connectionStatusObservable,b=t.getRequestHeaders,m=t.internalVisitorStateObservable,g=t.entrypoint,y=t.volatileNotifications,_=t.statusObservable,w=t.pubsub,E=t.wsProxy,O=t.createdAt,S=t.cobrowser,T=m.map(I.compose(I.find(I.propEq("id",n)),I.pathOr([],["engagement","engagements"]))),k=T.filter(I.identity).take(1),A=k.flatMap((function(){return T.filter(I.complement(I.identity)).switchMap((function(){return function(e){var t=e.engagementId,n=e.internalVisitorStateObservable,r=e.logger;return n.take(1).map((function(e){var n=I.pathOr([],["engagement","ended_engagements"],e),i=I.find(I.propEq("id",t),n),o=Boolean(i&&I.contains(i.end_reason,PE));return o&&r.info("Received engagement end signal with authentication end_reason. Initiating engagement restart",{engagement_id:t}),{isEngagementRestart:o}}))}({engagementId:n,internalVisitorStateObservable:m,logger:Yu})})).take(1)})),x=nc.vent.observable("engagement:prepare_for_restart").map(I.always({isEngagementRestart:!0})),N=ju.Obannel.observable("visitor:state_changed")})),R=k.map(I.prop("transferrable_sites")),C=qu(),P=R.flatMap((function(e){var t=e.map((function(e){return e.id}));return w.joinSiteVisitorNotifications(C,t)})),j=sm.conf.engagement.api_timeout_milliseconds||of,L=IE({visitorId:qu(),engagementId:n,volatileNotifications:y,engagementStateObservable:T,apiTimeoutMilliseconds:j,wsProxy:E,stats:l,channelObservable:p});Yu.info("Starting medra communication controller");var q=nc.request("comms:create_controller",{getRequestHeaders:b,visitorAppConf:sm.conf.visitor_app,statsClient:l,volatileNotifications:y,comms:L,pubsub:w,localCapabilities:AE(),onMediaUpgrade:function(e){return h.createMediaUpgrade(e).subscribe(Yu.log.bind(Yu,"Media upgrade successfully created"),Yu.warn.bind(Yu,"Failed to create media upgrade"))}}),U=function(e){var t=e.mediaState,n=e.mediaStateChanges,r=t?ge.of(t):ge.of(new vw({visitor:{media:"text",audioMuted:!1,videoMuted:!1},operator:{media:"text",audioMuted:!1,videoMuted:!1}}));return n.pipe($i(r),kt(I.construct(vw)))}({mediaState:o,mediaStateChanges:q.mediaStateChanges()}),D=ju.Observable.merge(u,Wy({engagementId:n,connectionStatusObservable:v})),V=sm.conf.masking_regular_expressions;V||(Yu.error("Failed to fetch masking_regular_expressions for site",{site_id:sm.siteId,visitor_id:qu()}),V=[]);var F=U_.create({chatHistoryObservable:D,engagementEndObservable:N,engagementId:n,statsClient:l,getRequestHeaders:b,siteVisitorNotifications:P,maskingRegularExpressions:V}),B=F.chat,H=F.stopChat,W={end:function(){return h.endEngagement({engagementId:n}).toPromise()},chatTranscript:function(){return h.getChatTranscript(n).map(I.filter((function(e){var t=e.sender.type;return I.contains(t,["operator","visitor"])}))).toPromise()}},G=Pg(),z=sm.conf.communications.enabled_media_level,J=function(e){var t=e.engagementId,n=e.wsProxy,r=e.apiTimeoutMilliseconds,i=e.stats,o=yw({stats:i,protocol:"rest",failureTagProperty:"message",timeout:r,timeoutError:ju.Observable.throw(NE)});return{recordEvent:function(e){return o({resource:"record-event",method:"create"},(function(){return n.request({method:"POST",url:"".concat(sm.conf.api_url,"/engagements/").concat(t,"/events"),payload:e,headers:pf}).catch(yf,{allowedCauses:[rf.SALEMOVE.INVALID_INPUT,rf.SALEMOVE.NETWORK_TIMEOUT]})})).toPromise()}}}({engagementId:n,wsProxy:E,apiTimeoutMilliseconds:j,stats:l}),Y=function(e){var t=e.engagementId,n=e.wsProxy,r=e.apiTimeoutMilliseconds,i=e.stats,o=yw({stats:i,protocol:"rest",failureTagProperty:"message",timeout:r,timeoutError:ju.Observable.throw(_w)}),s=function(e){switch(e.status){case 409:return Yu.warn("Survey was not accepted because at least some answers were not unique for engagement. This could happen when survey was answered twice for the same engagement.",{engagement_id:t}),ju.Observable.throw(new vf({cause:rf.SALEMOVE.CONFLICT}));default:return yf(e)}},a=function(e){var r=e.surveyId,i=e.answers;return o({resource:"survey-answers-post",method:"create"},(function(){return n.request({method:"POST",url:"".concat(sm.conf.api_url,"/surveys/").concat(r,"/answers"),payload:{engagement_id:t,answers:i},headers:pf}).catch(s)})).toPromise()};return{fetchSurvey:function(){return o({resource:"survey-request",method:"get"},(function(){return n.request({method:"GET",url:"".concat(sm.conf.api_url,"/engagements/").concat(t,"/survey"),pf)})).map((function(e){return new gw(e,a)})).toPromise()},saveSurveyAnswers:a}}({engagementId:n,wsProxy:E,apiTimeoutMilliseconds:j,stats:l});return i&&(c=function(e,t){var n=e.media,r=e.enabledMediaType,i=e.webRtcMode;if(I.indexOf(n,t.state.medias)>-1)return t;var o=Lg[n];return I.compose(Hg({enabledMediaType:r,webRtcMode:i}),I.set(Ug,o),I.set(qg,o))(t)}({media:i,enabledMediaType:z,webRtcMode:G},c)),new e({engagementId:n,subEngagementId:r,engagementEndObservable:N,startingMedia:i,type:s,isReestablishing:a,chatHistoryObservable:D,chat:B,stopChat:H,webRtcMode:G,enabledMediaLevel:z,channelObservable:p,operator:c,operatorFocusObservable:M,communicationWidget:q,createEngagementObservable:aw,mediaStateObservable:U,cobra:f,backend:W,platform:d,startScreenSharing:Bw.start,stateObservable:T.filter(I.identity).distinctUntilChanged(I.equals),statsClient:l,entrypoint:g,volatileNotifications:y,statusObservable:_,comms:L,events:J,surveyApi:Y,getRequestHeaders:b,siteVisitorNotifications:P,createdAt:O,cobrowser:S})}}]),e}();FE.prototype.SCAN_EVENT_REPLAY_COUNT=100,FE.prototype.EVENTS={END:"end",STATE_CHANGE:"state_change",CAPABILITIES:"capabilities",MEDIA_UPGRADE_OFFER:"media_upgrade_offer",FOCUS:"focus",MEDIA_STATE_CHANGE:"media_state_change",COBROWSING_REQUEST:"cobrowsing_request",MEDIA_PERMISSION_REQUEST:"media_permission_request",WIDGET_MEDIA_UPGRADE_REQUEST:"widget_media_upgrade_request",CUSTOM_COMMAND:"custom_command"},FE.prototype.ENGAGEMENT_END_EVENT_PAYLOAD_KEYS=["isEngagementRestart"],FE.prototype.FOCUS_TARGETS={CHAT:"chat",COBROWSER:"cobrowse"},FE.prototype.MEDIA_TYPES={TEXT:"text",AUDIO:"audio",PHONE:"phone",VIDEO:"video"};var BE=function(e){var t,n,r=e.api,i=e.conf,o=e.operatorsObservable,s=e.media,a=e.options,u=e.statsClient,c=e.cobraObservable,l=e.channelObservable,f=e.cobrowser,p=e.engagementApi,d=e.webRtcMode,h=e.enabledMediaLevel,v=e.connectionStatusObservable,b=e.getRequestHeaders,m=e.internalVisitorStateObservable,g=e.volatileNotifications,y=e.statusObservable,_=e.pubsub,w=e.wsProxy,E=e.dynamicImport,O=new ju.AsyncSubject,S=Yy({media:s,mediaOptions:a,mediaValidation:dw,api:r,notifyOfTimeout:nc.vent.trigger.bind(nc.vent,nc.MSG.REACTIVE_ENGAGEMENT_REQUEST_TIMEOUT),operatorsObservable:o,engagementCoreObservable:E("Comms"),cobraObservable:c,channelObservable:l,serverResponseTimeout:of,communicationLib:i.communications.lib,engagementApi:p,webRtcMode:d,enabledMediaLevel:h,statsClient:u}),T=S.requestObservable,k=S.resultObservable,A=nl(O),x=k.merge(A).take(1).map((function(e){return I.merge(e,{statsClient:u,connectionStatusObservable:v,getRequestHeaders:b,internalVisitorStateObservable:m,volatileNotifications:g,statusObservable:y,pubsub:_,cobrowser:f,wsProxy:w})})).map(FE.create).do(I.invoker(0,"start")).catch(gf);return{operatorObservable:(t=T,n=A,t.pipe(kt(I.prop("operator")),$i(n),Ei(1))).catch(gf),engagementObservable:x,cancelEngagementRequest:function(){return function(e){var t=e.api,n=e.requestObservable,r=e.resultEr ju.Observable.of({requestNotCreated:!0})})).flatMap((function(e){var n=e.engagementRequestId;return e.requestNotCreated?ju.Observable.of({}):t.cancel({id:n}).do((function(){return r.next(new vf({cause:rf.SALEMOVE.CANCEL}))})).do((function(){return i.increment("engagement.flow",["entrypoint:reactive-request","action:end","stage:requested","expected:true","reason:cancel"])}))}))}({statsClient:u,api:r,requestObservable:T,resultErrorSubject:O}).toPromise()},engagementRequestTimeout:1e3*i.engagement.reactive_call_timeout}},HE=u((function e(t){var n=t.timeout,r=t.engagementPromise,i=t.cancel,o=t.operatorPromise;s(this,e),this.timeout=n,this.engagementPromise=r,this.cancel=i,this.operatorPromise=o})),WE=function(e){l(n,e);var t=m(n);function n(){var e;return s(this,n),(e=t.call(this))._currentSubscription=Ky.Subscription.EMPTY,e}return u(n,[{key:"add",value:function(e){if(!this.closed)return"function"==typeof e&&(e=new Ky.Subscription(e)),this._currentSubscription&&(this.remove(this._currentSubscription),this._currentSubscription.unsubscribe(),this._currentSubscription=null),y(f(n.prototype),"add",this).call(this,this._currentSubscription=e),this}}]),n}(Ky.Subscription),GE=u((function e(t,n){s(this,e),this.code=t,this.validDuration=n})),zE=function(){function e(t){s(this,e);var n=t.incomingEngagementRequestObservable,r=t.setOmnibrowseReestablishHandler,i=t.statsClient,o=t.wsProxy,a=new WE,u=n.filter(I.propEq("platform",ff)).map(I.prop("incomingEngagementRequest"));this.setIncomingEngagementRequestHandler=function(e){return a.add(u.subscribe(e,Yu.error))},this.setEngagementReestablishHandler=r,this.getVisitorCode=function(){return yw({stats:i,protocol:"rest",failureTagProperty:"error",timeout:of,timeoutError:ju.Observable.throw(new vf({cause:rf.SALEMOVE.NETWORK_TIMEOUT}))})({resource:"omnibrowse",method:"get"},(function(){return o.request({method:"GET",url:"".concat(sm.conf.api_url,"/omnibrowse/sites/").concat(Fu(),"/visitor_code/").concat(qu()),payload:null,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})})).map((function(e){var t=Date.parse(e.expires_at)-new Date;return new GE(e.code,t)})).catch(I.compose(ju.Observable.throw,I.unless(I.is(vf),I.always(new vf({causer code failed",{site_id:sm.siteId,err:e})})).toPromise()}}return u(e,[{key:"setIncomingEngagementRequestHandler",value:function(e){}},{key:"setEngagementReestablishHandler",value:function(e){}},{key:"getVisitorCode",value:function(){return null}}]),e}(),JE=u((function e(t){var n=t.text,r=t.noOperatorsOnlineText,i=t.duration,o=t.priority;s(this,e),this.text=n,this.noOperatorsOnlineText=r,this.duration=i,this.priority=o})),YE=u((function e(t){s(this,e),this.duration=t})),QE=u((function e(t){var n=t.verticalOffset,r=t.horizontalOffset;s(this,e),this.verticaKE=u((fu,n){s(this,e),this.text=t,this.duration=n})),$E=u((function e(t){var n=t.operatorListReady,r=t.isOmniqEnabled,i=t.queueStateReady,o=t.routingObservable;s(this,e);var a=function(e){return r?e.flatMap((function(e){return ju.Observable.combineLatest(o,i).take(1).mapTo(e)})):e.flatMap((function(e){return n.mapTo(e)}))},u=nc.vent.observable("reactive_bar:enable").map(I.always({})),c=nc.vent.observable("reactive_bar:disable").map(I.always({})),l=nc.vent.obition").map((function(e){return new QE(e)})),f=nc.vent.observable("trigger_expand_reactive").map((function(e){return new YE(e.duration)})),p=nc.vent.observable("trigger_media_selection").map((function(e){return new KE(e.text)})),d=nc.vent.oduration:e.duration,priority:e.priority})})),h=nc.vent.obsction(e){return new XE(e.text,e.duration)})),v=I.fromPairs([[this.EVENTS.REACTIVE_ENABLE,u],[this.EVENTS.REACTIVE_DISABLE,c],[this.EVENTS.REACTIVE_SET_POSITION,l],[this.EVENTS.REACTIVE_EXPAND,a(f)],[this.EVENTS.MEDIA_SELECTION_START,a(p)],[this.EVENTS.REACTIVE_CALLOUT_START,a(d)],[this.EVENTS.ENGAGEMENT_INVITATION_SHOW,a(h)]]),b=Qf();b.proxyAll(v);var m=Kf();m.proxyAll(v),this.addUnbufferedEventListener=b.addEventListener,this.removeUnbufferedEventListener=b.removeEventListener,this.addBufferedEventListener=m.addEventListener,this.removeBufferedEventListener=m.removeEventListener,this.observable=function(e){return b.observable(e)},this.bufferedObservable=function(e){return m.observable(e)}}));$E.prototype.EVENTS={REACTIVE_ENABLE:"overseer:reactive_enable",REACTIVE_DISABLE:"overseer:reactive_disable",REACTIVE_SET_POSITION:"overseer:reactive_set_position",REACTIVE_EXPAND:"overseer:reactive_expand",MEDIA_SELECTION_START:"overseer:media_selection_start",REACTIVE_CALLOUT_START:"overseer:reactive_callout_start",ENGAGEMENT_INVITATION_SHOW:"overseer:engagement_invitation_show"};var ZE,eO=function(){function e(){s(this,e),this.EVENTS={ENGAGEMENT_REQUEST:"omnicall:engagement_request",PHONE_NUMBER_AVAILABLE:"omnicall:phone_number_available"};var t=I.fromPairs([[this.EVENTS.ENGAGEMENT_REQUEST,ju.Observable.never()],[this.EVENTS.PHONE_NUMBER_AVAILABLE,ju.Observable.never()]]),n=Qf();n.proxyAll(t),this.addEventListener=n.addEventListener,this.removeEventListener=n.removeEventListener,this.observable=function(e){return t[e]}}return u(e,[{key:"addEventListener",value:function(e,t){}},{key:"removeEventListener",value:function(e,t){}}]),e}(),tO=u((function e(){s(this,e),this.url=sm.conf.visitor_app.site_logo.url})),nO=function(){function e(){s(this,e),this.visibleOperatorCount=sm.conf.visitor_app.reactive_tab.visible_operator_count,this.backColor=sm.conf.visitor_app.reactive_tab.back_color,this.fontSize=sm.conf.visitor_app.reactive_tab.font_size,this.format=sm.conf.visitor_app.reactive_tab.format,this.frontColor=sm.conf.visitor_app.reactive_tab.front_color,this.iconType=this._iconClassToType(sm.conf.visitor_app.reactive_tab.icon_class),this.placement=sm.conf.visitor_app.reactive_tab.placement,this.size=sm.conf.visitor_app.reactive_tab.size,this.text=sm.conf.visitor_app.reactive_tab.text,this.verticalOffset=sm.conf.visitor_app.reactive_tab.vertical_offseton class of the reactive tab",e),"video"}}}]),e}(),rO=u((function e(){s(this,e),this.apiUrl=sm.conf.api_url,this.alwaysUseDefaultOperatorPicture=sm.conf.visitor_app.always_use_default_operator_picture,this.visitorPageAdaption=sm.conf.visitor_appeturn"nowrap";default:return"iframeless"}}(sm.conf),this.offlineMessagesEnabled=sm.conf.visitor_app.reactive_tab.contact_when_unstaffed,this.reactiveTabEnabled=sm.conf.visitor_app.reactive_tab.enabled,this.widgetMode=sm.conf.visitor_app.widget_mode,this.showReactiveTabWhenOperatorsUnavailable=sm.conf.visitor_app.reactive_tab.show_unavailable,this.theme=sm.conf.visitor_app.theme,this.isCustomTheme=sm.conf.visitor_app.is_custom_theme,this.locale=sm.conf.visitor_app.visitor_app_default_locale,this.reactiveTabVisuals=new nO,this.siteLogo=new tO,this.queuingEnabled=sm.conf.omniq.omniq_enabled,this.panelPosition=sm.conf.visitor_app.reactive_tab.position,this.phoneExtensionEnabled=sm.conf.visitor_app.phone_extension_enabled,this.phoneNumberDefaultCountry=sm.conf.visitor_app.phone_number_default_country,this.hideVisitorInfo=sm.conf.visitor_app.hide_visitor_info_in_visitor_app,this.enableVisitorTranscriptDownload=sm.conf.visitor_app.enable_visitor_transcript_download,this.watchForNewContactOperatorIntegrations=!1!==sm.conf.visitor_app.watch_for_new_contact_operator_integrations,this.engagementInvitationAudio=sm.conf.visitor_app.engagement_invitation_audio})),iO=function(e,t,n,r){e||(e={}),n||(n=[]),r||(r=ju.Scheduler.asap);var i=e,o=i.phone,s=i.email;if(!o&&!s)return ju.Observable.throw({cause:rf.SALEMOVE.INVALID_INPUT,message:"Either phone or email must be specified"});var a=t.createApiRequestObservable,u=t.serverResponseTimeout;return a(I.pick(I.concat(["name","phone","email","message"],n),e)).pipe(kt((function(){return{}})),Fr((function(e){return ju.Observable.throw(ME(e))})),us(u,ju.Observable.throw(new vf({cause:rf.SALEMOVE.NETWORK_TIMEOUT,message:"Leave message request timed out"})),r),ts(null,I.ifElse(I.propEq("cause",rf.SALEMOVE.TOO_MANY_REQUESTS),Yu.warn.bind(Yu,"Leaving a message failed: too many requests"),Yu.info.bind(Yu,"Leaving a message failed"))),Ei(1))},oO=function(e,t){return function(e,t){return Uf({method:"GET",url:e,responseType:"blob",getRequestHeaders:t})}(e,t).map((function(e){return e.response})).catch((function(e){return ju.Observable.throw(ME(e))})).do(null,I.ifElse(I.propEq("cause",rf.SALEMOVE.TOO_MANY_REQUESTS),Yu.warn.bind(Yu,"Requesting asset failed: too many requests"),Yu.info.bind(Yu,"Requesting asset failed"))).take(1)},sO=function(){function e(t){var n=t.id,r=t.api,i=t.operator,o=t.restrictedOperator,a=t.cobraObservable,u=t.channelObservable,c=t.message,l=t.logoUrl,f=t.platform,p=t.timeout,d=t.engagementApi,h=t.statsClient,v=t.cobrowser,b=t.communicationLib,m=t.notifyOfAccept,g=t.notifyOfDecline,y=t.createEngagement,_=t.cobraLoadTimeout,w=t.connectionStatusObservable,E=t.getRequestHeaders,O=t.internalVisitorStateObservable,S=t.volatileNotifications,T=t.statusObservable,k=t.pubsub,A=t.wsProxy;s(this,e),this.message=c,this.timeout=p,this.operator=o,this.logo={url:l};var x=new ju.AsyncSubject,N=x.merge(nl(ju.Observable.merge(r.canceledObservable.map(I.always(new vf({cause:rf.SALEMOVE.CANCEL}))),r.timedOutObservable.map(I.always(new vf({cause:rf.SALEMOVE.TIMEOUT})))))).((function(t){return I.merge({cobra:t},e)})).take(1).timeoutWith(_,ju.Observable.throw(new vf({cause:rf.SALEMOVE.INTERNAL_ERROR,message:"Cobra load timeout exceeded"})).do(null,(function(e){return Yu.warn("Cobra loading timed out",e)}))).do(null,(function(t){return Yu.warn("Loading cobra failed, ending engagement",t),d.endEngagement({engagementId:e.engagementId,reason:"error",subReason:"visitor_cobra_load_failure"}).take(1).subscribe(Yu.log.bind(Yu,"Successfully ended engagement after cobra load failure"),Yu.warn.bind(Yu,"Failed to end engagement after cobra load failure"))})).map((function(e){var t=e.engagementId,n=e.subEngagementId,r=e.media,o=e.cobra,s=e.createdAt;return y({operator:i,engagementId:t,subEngagementId:n,startingMedia:r,type:"proactive",isReestablishing:!1,initialChatHistoryObservable:Hy(t),communicationLib:b,statsClient:h,cobra:o,channelObservable:u,platform:f,engagementApi:d,connectionStatusObservable:w,getRequestHeaders:E,internalVisitorStateObservable:O,entrypoint:"proactive-request",volatileNotifications:S,statusObservable:T,pubsub:k,wsProxy:A,createdAt:s,cobrowser:v})})).do((function(e){return e.start()})).catch(gf)}));this.engagementPromise=N.toPromise(),this.accept=fn m({eProactive request accepted",{operator:i})})).mapTo({}).catch(gf).toPromise()},this.selectMedia=function(e,t){if(f===ff&&"text"!==e)return Promise.reject(new vf({cause:rf.SALEMOVE.NOT_SUPPORTED,message:"OmniBrowse engagements only support text media."}));var s=o.state.medias,a=mg(o.state.oneWayMedias),u=t||{},c=u.phoneNumber,l=u.phoneExtension,p=u.oneWay;return dw({options:t,availableMediaTypes:s,availableOneWayMediaTypes:a,media:e}).then((function(){return m({engagement_request_id:n,operator:i}),r.accept({id:n,selectedMedia:e,mediaOptions:{phoneNumber:c,phoneExtension:l,oneWay:p}}).do((function(){sm.logger.info("Engagement: Proactive req((function(t){return I.merge(t,{media:e})})).do(x).mapTo({}).catch(gf).toPromise()}))},this.declin}).do((function(){return g({operator:i})})).do((function(){return x.error(new vf({cause:rf.SALEMOVE.DECLINE}))})).do((function(){return sm.logger.info("Engagement, Proactive request declined",arguments[0])})).mapTo({}).catch(gf).toPromise()}}return u(e,null,[{key:"create",value:function(t){var n=t.api,r=t.id,i=t.operator,o=t.restrictedOperator,s=t.message,a=t.logoUrl,u=t.platform,c=t.timeout,l=t.statsClient,f=t.cobraObservable,p=t.channelObservable,d=t.engagementApi,h=t.connectionStatusObservable,v=t.getRequestHeaders,b=t.internalVisitorStateObservable,m=t.volatileNotifications,g=t.statusObservable,y=t.pubsub,_=t.wsProxy,w=t.cobrowser;return new e({api:n,id:r,statsClient:l,communicationLib:sm.conf.communications.lib,createEngagement:FE.create,cobraObservable:f,operator:i,restrictedOperator:o,platform:u,timeout:c,message:s,logoUrl:a,cobraLoadTimeout:1e4,notifyOfAccept:nc.vent.trigger.bind(nc.vent,nc.MSG.PROACTIVE_ACCEPT),notifyOfDecline:nc.vent.trigger.bind(nc.vent,nc.MSG.PROACTIVE_DECLINE),channelObservable:p,engagementApi:d,connectionStatusObservable:h,getRequestHeaders:v,internalVisitorStateObservable:b,volatileNotifications:m,statusObservable:g,pubsub:y,wsProxy:_,cobrowser:w})}}]),e}(),aO=function(e,t){return t.pipe(wn((function(t){var n=function(e,t){return I.compose(I.find(I.propEq("id",e)),I.pathOr([],V_))(t)}(e.id,t);return Boolean(n.outcome)})),Ei(1),kt((function(t){var n=z_(t);return n&&n.operator.id===e.operator.id?n:null})),wn(I.identity))},uO=function(e){var t=e.channelObservable,n=e.internalVisitorStateObservable,r=e.statusObservable,i=e.webRtcMode,o=e.enabledMediaLevel,s=e.statsClient,a=e.cobraObservable,u=e.isEngagedObservable,c=e.engagementApi,l=e.connectionStatusObservable,f=e.getRequestHeaders,p=e.volatileNotifications,d=e.pubsub,h=e.wsProxy,v=e.cobrowser,b=e.dynamicImport;return function(e){var t=e.reestablishRequestObservable,n=e.channelObservable,r=e.statusObservable,i=e.cobraObservable,o=e.isEngagedObservable;return t.pipe(zo((function(e){var t=r.pipe(wn(I.equals({}))),o=n.pipe(wn(I.compose(I.propEq("id",e.operatorId),I.prop("operator"))),Ei(1),zi(e),Ko(t)),s=i.pipe(wn(I.pathEq(["operator","id"],e.operatorId)),uo("cobraSource"),Ei(1function(e,t){return I.merge(e,{cobra:t})}))})),xs(o,(function(e,t){return{engagemeinfo("Reestablishing ongoing engagement")})),wn((function(e){return!e.isEngaged})),kt((function(e){return e.engagementReestablishMessage})))}({reestablishRequestObservable:function(e){var t=e.pipe(Ar(2,1),kt((function(e){var t=_(e,2),n=t[0],r=t[1],i=J_(n),o=z_(r),s=o&&i,a=o&&n.visitor_id!==r.visitor_id,u=o&&!I.path(["engagement","engagements",0],n)&&I.path(["engagement","engagements",0,"restarted_from_engagement_id"],r);return s||a||u?o:null})),wn(I.identity));return e.pipe(Ei(1),an((function(t){var n=ju.Observable.of(t).map(z_).filter(I.identity),r=Y_(t),i=r?aO(r,e):ju.Observable.empty();return ju.Observable.merge(n,i)})),$i(t),kt((function(e){return{id:e.id,platform:e.platform,subEngagementId:e.sub_engagement_legacy_id,channelUrl:e.channel_url,operatorId:e.operator.id,operatorName:e.operator.name,operatorFormattedName:e.operator.formatted_name,operatorMediaType:e.operator.media_type,operatorPicture:{url:e.operator.picture_url},entrypoint:e.entrypoint,createdAt:e.start_time}})))}(n),channelObservable:t,statusObservable:r,cobraObsp((function(e){return b("Comms").mapTo(e)})).observeOn(ju.Scheduler.asap).map((function(e){var a=Jg({id:e.operatorId,name:e.operatorName,formattedName:e.operatorFormattedName,picture:e.operatorPicture,mediaType:e.operatorMediaType,webRtcMode:i,enabledMediaType:o}),u=FE.create({engagementId:e.id,subEngagementId:e.subEngagementId,initialChatHistoryObservable:Hy(e.id),operator:a,isReestablishing:!0,mediaState:e.mediaState,platform:e.platform,communicationLib:sm.conf.communications.lib,statsClient:s,cobra:e.cobra,channelObservable:t,engagementApi:c,connectionStatusObservable:l,getRequestHeaders:f,internalVisitorStateObservable:n,entrypoint:e.entrypoint,volatileNotifications:p,statusObservable:r,pubsub:d,wsProxy:h,createdAt:e.createdAt,cobrowser:v});return u.start(),{engagement:u,platform:e.platform}}))},cO=function(e){var t=e.replayedReestablishObservable,n=e.defaultHandler,r=e.storeKey,i=e.platform,o=e.sessionStore,s=e.timeout,a=new WE,u=t.filter(I.propEq((e){return a.add(u.subscribe(e,Yu.error))},l=new ju.Subject;return c((function(e){return o.get(r)?ju.Observable.timer(s).takeUntil(l).subscribe((function(){return o.remove(r),Yu.error("Waited for custom reestablish handler to be set, but it wasn't set before timeout."),l.subscribe((function(){return Yu.error("Custom reestablish handler was set, but after timeout."),console.error("Salemove#setEngagementReestablishHandler() was called too late!"+" Glia waits ".concat(Math.round(15)," seconds after page load")+" for the custom reestablish handler to be set. Executing the handler anyway, although the default handler has already been called.")})),n(e)})):n(e)})),func),this.engaged=n,this.name=r,this.email=i})),fO=u((function e(t){var n=t.connected;s(this,e),this.connected=n})),pO="__sm_mutation_event_trigger_flip__",dO=new vf({cause:rf.SALEMOVE.INTERNAL_ERROR}),hO=function(e,t){var n=e.wsProxy,r=e.stats,i=e.apiTimeoutMilliseconds;t||(t=ju.Scheduler.asap);var o=function(){return yw({stats:r,protocol:"rest",failureTagProperty:"message",timeout:i,timeoutError:ju.Observable.throw(dO),scheduler:t})};return{createMediaUpgrade:function(e){var t=e.engagementId,r=e.media;return o()({resource:"media-upgrade",method:"create"},(function(){return n.request({method:"POST",url:"".concat(sm.conf.api_url,"/engagements/").concat(t,"/media_upgrades"),payload:{media:r},headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})}))},getChatTranscript:function(e){return o()({resource:"chat-transcript",method:"fetch"},(function(){return n.request({method:"GET",url:"".concat(sm.conf.api_url,"/engagements/").concat(e,"/chat_transcript"),payload:null,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})}))},endEngagement:function(e){var t=e.engagementId,r=I.compose(I.assoc("action","end"),Zl({subReason:"sub_reason"}),I.pick(["reason","subReason"]))(e);return o()({resource:"engagement",method:"end"},(function(){return n.request({method:"PATCH",url:"".concat(sm.conf.api_url,"/engagements/").concat(t),payload:r,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})}))}}},vO=new vf({cause:rf.SALEMOVE.NETWORK_TIMEOUT}),bO={"'operator_id' Operator is not available to be engaged":rf.SALEMOVE.OPERATOR_UNAVAILABLE,"Operator cannot be engaged":rf.SALEMOVE.OPERATOR_UNAVAILABLE,"Visitor cannot be engaged":rf.SALEMOVE.ALREADY_ENGAGED,"'engagement_request_id' already failed":rf.SALEMOVE.CONFLICT,"'engagement_request_id' already accepted":rf.SALEMOVE.CONFLICT,"'engagement_request_id' already acknowledged":rf.SALEMOVE.CONFLICT},mO=(c(ZE={},403,rf.SALEMOVE.FORBIDDEN),c(ZE,409,rf.SALEMOVE.CONFLICT),ZE),gO=["'engagement_request_id' already failed","'engagement_request_id' already accepted","'engagement_request_id' already acknowledged"],yO=function(e,t,n){var r=I.merge(n,{error:e});e&&I.contains(e.message,gO)||e instanceof vf?Yu.warn("Failed to ".concat(t," engagement request"),r):Yu.error("Failed to ".concat(t," engagement request"),r)},_O=function(e){var t=bO[e&&e.message]||mO[e&&e.status]||rf.SALEMOVE.INTERNAL_ERROR;return new vf({cause:t})},wO=function(e,t){var n=e.wsProxy,r=e.stats,i=e.apiTimeoutMilliseconds,o=e.visitorMetadata,s=e.internalVisitorStateObservable;t||(t=ju.Scheduler.asap);var a=yw({stats:r,protocol:"rest",failureTagProperty:"cause",timeout:i,timeoutError:ju.Observable.throw(vO),scheduler:t}),u=function(e){var t=e.id,r=e.data;return n.request({method:"PATCH",url:"".concat(sm.conf.api_url,"/engagement_requests/").concat(t),payload:r,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json","x-salemove-tab-id":sm.tabId}})},c=function(e){r.increment("engagement.flow",["entrypoint:proactive-request","stage:requested","action:end"].concat(e))},l=s.pipe(kt(W_),Ar(2,1),wn((function(e){var t=_(e,2)function(e){var t=_(e,2);t[0];return t[1]}))),f=l.pipe(wn(G_),ts((function(e){var t=e.id;return Yu.info("Found new accepted engagement",{engagement_id:t})})),kt((function(e){return{engagementId:e.id,subEngagementId:e.sub_engagement_legacy_id,operatorId:e.operator.id,operatorMediaType:e.operator.media_type,operatorName:e.operator.name,operatorFormattedName:e.operator.formatted_name,operatorPicture:{url:e.operator.picture_url},media:ow(e.media),entrypoint:e.entrypoint,platform:e.platform,createdAt:e.start_time}}))),p=l.pipe(wn(I.complement(G_)),zi({})),d=function(e){var t=I.propEq("site_id",sm.siteId);return I.compose(I.filter(t),I.pathOr([],["engagement","requests"]))(e)},h=I.compose(I.nth(0),I.filter(I.propEq("outcome",null)),d),v=function(e){return I.compose(I.nth(0),I.filter(I.propEq("id",e)),d)},b=s.pipe(kt(h),wn(I.identity)),m=I.curry((function(e,t){reunction(t){return I.contains(t.outcome,e)})),Ei(1),Ko(function(e,t){reunction(e){return!I.contains(e.outcome,t)})))}(t,I.append(null,e))))})),g=b.pipe(an(m(["operator_cancel","operator_left"])),zi({})),y=ju.Observable.merge(p,g),w=b.pipe(an(m(["timed_out"])),zi({}));return{create:function(e){var t=e.operatorId,r=e.siteId,i=e.media,s=e.source,u=e.mediaOptions,c={operator_id:t,site_id:r,media:i,source:s||"sdk",visitor_metadata:o,media_options:{phone_number:u.phoneNumber,phone_extension:u.phoneExtension,one_way:u.oneWay}};return Yu.info("Engagement: Sending reactive request",c),a({resource:"engagement-request",method:"create"},(function(){return(e=c,n.request({method:"POST",url:"".concat(sm.conf.api_url,"/engagement_requests"),payload:e,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+jquestId:e.id,acknowledgeTimeoutSeconds:t}})).catch((function(e){var n={error:e,operator_id:t,site_id:r,media:i,source:s,media_options:u};return e instanceof vf?(Yu.info("Failed to create engagement request",n),ju.Observable.throw(e)):(403===(e&&e.status)?Yu.info("Visitor forbidden to create engagement request",n):422===(e&&e.status)?Yu.info("Operator is not available to be engaged",n):409===(e&&e.status)?Yu.info("Operator cannot be engaged",n):Yu.error("Failed to create engagement request",n),ju.Observable.throw(_O(e)))}));var e}))},cancel:function(e){var t=e.id,n="cancel";return a({resource:"engagement-request",method:n},(function(){return u({id:t,data:{action:n}}).catch((function(e){return yO(e,n,{engagement_request_id:t}),ju.Observable.throw(_O(e))}))}))},acknowledge:function(e){var t=e.id,n="acknowledge";return a({resource:"engagement-request",method:n},(function(){return u({id:t,data:{action:n}}).catch((function(e){return yO(e,n,{engagement_request_id:t}),ju.Observable.throw(_O(e))})).do(null,(function(e){e.cause===rf.SALEMOVE.INTERNAL_ERROR?c(["reason:internal-error"]):e.cause!==rf.SALEMOVE.CONFLICT&&c(["reason:unknown"])}))}))},accept:function(e){var t=e.id,n=e.selectedMedia,r=e.mediaOptions,i="accept";return a({resource:"engagement-request",method:i},(function(){return u({id:t,data:{action:i,media:n,media_options:{phone_number:r.phoneNumber,phone_extension:r.phoneExtension,one_way:r.oneWay},visitor_metadata:o}}).catch((function(e){return yO(e,i,{engagement_request_id:t,media:n,media_options:r}),ju.Observable.throw(_O(e))})).do(null,(function(e){e.cause===rf.SALEMOVE.INTERNAL_ERROR?c(["reason:internal-error"]):e.cause!==rf.SALEMOVE.CONFLICT&&c(["reason:unknown"])})).map(Zl({engagement_id:"engagementId",sub_engagement_id:"subEngagementId",created_at:"createdAt"}))}))},decline:function(e){var t=e.id,n="decline";return a({resource:"engagement-request",method:n},(function(){return u({id:t,data:{action:n}}).catch((function(e){return yO(e,n,{engagement_request_id:t}),ju.Observable.throw(_O(e))}))}))},notifyOfReactiveFailure:function(e){var t=e.id;return a({resource:"engagement-request",method:"cancel-due-to-error"},(function(){return u({id:t,data:{action:"cancel",reason:"error"}}).catch((function(e){return ju.Observable.throw(_O(e))})).do(null,Yu.warn.bind(Yu,"Failed to cancel reactive engagement request due to error"))}))},acceptedObservable:f,declinedObservable:b.pipe(an(m(["rejected"])),zi({})),canceledObservable:y,timedOutObservable:w}},EO=["name","email","phone","note","customAttributes","customAttributesUpdateMethod"],OO={customAttributes:"custom_attributes",customAttributesUpdateMethod:"custom_attributes_update_method"},SO="last_known_ci:".concat(Fu()),TO=function(e){var t=qu(),n=JSON.stringify(e);return function(e){for(var t=0,n=0,r=e.length;n<r;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return t}(Math.floor(Date.now()/864e5).toString()+t+n).toString()},kO=new ly,AO=0,xO=function(e,t,n){var r;n||(n=ju.Scheduler.asap);var i=t.createApiRequestObservable,s=t.serverResponseTimeout,a=t.tabId,u=t.visitorMetadata,c=t.status;if(e.customAttributes&&"object"!==o(e.customAttributes))return ju.Observable.throw({cause:rf.SALEMOVE.INVALID_INPUT,message:"Custom attributes must be an object"});if(I.has("customAttributesUpdateMethod",e)&&!I.contains(e.customAttributesUpdateMethod,["merge","replace"]))return ju.Observable.throw({cause:rf.SALEMOVE.INVALID_INPUT,message:"Custom attributes update method must be either merge or replace"});var l=I.compose(Zl(OO),I.pick(EO)),f=I.has("externalId",e)?I.compose(I.assocPath(["custom_attributes","external_id"],e.externalId),l)(e):l(e);return f.context={tab_id:a,url:window.location.href,metadata:u,status:c},null!==(r=sm.conf.visitor_api)&&void 0!==r&&r.disable_repeat_updates_optimization||0!==AO||!function(e){try{return kO.getItem(SO)===TO(e)}catch(e){return Yu.info("Could not read last saved contact information hash",e),!1}}(I.dissoc("context",f))?(AO+=1,i(f).pipe(ts((function(){return function(e){try{kO.setItem(SO,TO(e))}catch(e){Yu.info("Could not save last saved contact informatio("context",f))})),kt((function(){return{}})),Fr((function(e){return ju.Observable.throw(ME(e))})),us(s,ju.Observable.throw(new vf({cause:rf.SALEMOVE.NETWORK_TIMEOUT,message:"Set visitor information request timed out"})),n),ts(null,I.ifElse(I.propEq("cause",rf.SALEMOVE.TOO_MANY_REQUESTS),Yu.warn.bind(Yu,"Setting visitor information failed: too many requests"),Yu.info.bind(Yu,"Setting visitor information failed"))),Fr(gf))):(Yu.info("Avoiding first visitor information update as it matches a previous update"),ju.Observable.of({}))},IO={setTimeout:setTimeout,clearTimeout:clearTimeout},NO=function(e,t,n){var r,i,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:IO,s=o.setTimeout,a=o.clearTimturn r=e,i&&a(i),i=s((function(){r=void 0}),t),e};return function(){return r?(n(eason=i,this.ticket=o,this.activeTicket=a}));MO.prototype.QUEUE_STATES={CAN_QUEUE:"can_queue",CANNOT_QUEUE:"cannot_queue",QUEUED:"queued"},MO.prototype.TRANSITION_REASONS={ENGAGED:"engaged",CANCELED:"canceled",UNSTAFFED:"unstaffed",CLOSED:"closed",DISCONNECTED:"disconnected",FAILED:"failed",ALREADY_QUEUED:"already_queued",FORBIDDEN:"forbidden"};var RO=u((function e(t){var n=t.averageDurationInSeconds;s(this,e),this.averageDurationInSeconds=n})),CO=new vf({cause:rf.SALEMOVE.INTERNAL_ERROR}),PO=new vf({cause:rf.SALEMOVE.CANCEL}),jO=function(e,t){return e.increment("engagement.flow",["entrypoint:queue-request"].concat(t))},LO=function(e){var t=e.wsProxy,n=e.statsClient,r=e.apiTimeoutMilliseconds,i=e.ticket_id;return function(e,t){return yw({stats:e,protocol:"rest",failureTagProperty:"error",timeout:t,timeoutError:ju.Observable.throw(CO)})}(n,r)({resource:"queue_tickets",method:"delete"},(function(){return t.request({method:"DELETE",url:"".concat(sm.conf.api_url,"/queue_tickets/").concat(i),payload:{},headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+jon:end","expected:true","reason:cancel"])}(n)})).catch(gf)},qO=function(e){var t=e.engagementApi,n=e.engagementRequestApi,r=e.cobraObservable,i=e.fetchEngagementDependencies,o=e.channelObservable,s=e.communicationLib,a=e.statsClient,u=e.webRtcMode,c=e.enabledMediaLevel,l=e.connectionStatusObservable,f=e.getRequestHeaders,p=e.internalVisitorStateObservable,d=e.volatileNotifications,h=e.pubsub,v=e.statusObservable,b=e.wsProxy,m=e.cobrLatest(r,i(),(function(e){return{cobra:e}})).publishReplay(1),y=g.connect();return n.acceptedObservable.take(1).flatMap((function(e){var n=e.engagementId,r=e.subEngagementId,i=e.operatorId,y=e.media,_=e.operatorName,w=e.operatorFormattedName,E=e.operatorPicture,O=e.operatorMediaType,S=e.entrypoint,T=e.createdAt;return g.take(1).map((function(e){var g=e.cobra,k=Jg({id:i,name:_,formattedName:w,picture:E,mediaType:O,webRtcMode:u,enabledMediaType:c});return{engagementId:n,subEngagementId:r,startingMedia:y,type:"reactive",isReestablishing:!1,initialChatHistoryObservable:Hy(n),operator:k,cobra:g,channelObservable:o,communicationLib:s,engagementApi:t,getRequestHeaders:f,internalVisitorStateObservable:p,entrypoint:S,volatileNotifications:d,pubsub:h,statusObservable:v,wsProxy:b,createdAt:T,statsClient:a,connectionStatusObservable:l,cobrowser:m}}))"action:end","reason:script-load-error"])}(a)})).do(null,(function(){return t.endEngagement({engagementId:n,reason:"error",subReason:"setup_failed"})}))})).finally((function(){return y.unsubscribe()}))},UO=function(){function e(t){s(this,e);var n=t.ticket_id,r=t.apiTimeoutMilliseconds,i=t.statsClient,o=t.wsProxy,a=t.stopObservable,u=new ju.Subject,c=ju.Observable.merge(u,a);Yu.info("Queue Ticket created, waiting for engagement",{queue_ticket_id:n});var l=qO(t).takeUntil(c).do((function(e){return e.start()})).catch(gf).publishReplay(1);l.connect(),this.engagementPromise=l.merge(c.flatMapTo(ju.Observable.throw(PO))).take(1).toPromise(),this.cancel=function(){return u.next(),l.last(null,null,null).flatMap((function(e){return e?ju.Observable.fromPromise(e.end()):LO({wsProxy:o,statsClient:i,apiTimeoutMilliseconds:r,ticket_id:n})})).toPromise()}}return u(e,null,[{key:"create",value:function(t,n){var r=new ju.Subject;return{ticket:I.compose(I.construct(e),I.assoc("stopObservable",r.asObservable()))(I.merge(t,{ticket_id:I.path(["activeTicket","idunction(){return r.next(),r.unsubscribe()}))}}}]),e}(),DO="requesting",VO="created",FO={open:1,opened:1,full:2,unstaffed:3,closed:4},BO=I.compose(I.reduce(I.minBy((function(e){return FO[e]})),"closed"),I.map(I.path(["state","status"]))),HO=I.compose(I.uniq,I.chain(I.path(["state","medias"]))),WO=function(e){var t=I.filter(I.pathEq(["state","status"],"open"),e),n=HO(t);n I.pick(Object.getOwnPropertyNames(e),e)},zO=["enqueued","request_sent"],JO=I.propEq("site_id",sm.siteId),YO=I.compose(I.filter(JO),I.pathOr([],["omniq","queue_tunction(e){return-1!==zO.indexOf(e.state)})),YO),KO=I.curry((function(e,t){return I.compose(I.nth(0),I.filter(I.propEq("id",e)),YO)(t)})),XO=function(e){var t=e.queueState,n=e.queued,r=e.enqueuedInCurrentTab;return n||!(I.isNil(t)||I.isNil(n)||I.isNil(r))},$O=function(e,t){return I.intersection(function(e){var t=["text","phone"];return e&&(t=t.concat(["messaging"])),Pg()===Cg&&(t=t.concat(["audio","video"])),t}(t),e)},ZO=function(e){var t=e.queueState,n=e.queued,r=e.visitorLeftReason,i=e.enqueuedInCurrentTab,o=e.isEngaged,s=e.activeTicket,a=e.isVisitorAuthenticatedExternally,u=e.isAsyncTransfer;if(n)return new MO(i?{state:MO.prototype.QUEUE_STATES.QUEUED,activeTicket:s}:{state:MO.prototype.QUEUE_STATES.CANNOT_QUEUE,transitionReason:MO.prototype.TRANSITION_REASONS.ALREADY_QUEUED});var c=function(e,t){if(t)return MO.prototype.TRANSITION_REASONS.ENGAGED;if(e)switch(e){case"finished":return MO.prototype.TRANSITION_REASONS.ENGAGED;case"canceled":return MO.prototype.TRANSITION_REASONS.CANCELED;case"unstaffed":return MO.prototype.TRANSITION_REASONS.UNSTAFFED;case"closed":return MO.prototype.TRANSITION_REASONS.CLOSED;case"disconnected":return MO.prototype.TRANSITION_REASONS.DISCONNECTED;case"failure":return MO.prototype.TRANSITION_REASONS.FAILED;case"forbidden":return MO.prototype.TRANSITION_REASONS.FORBIDDEN;case"visitor_conflict":return MO.prototype.TRANSITION_REASONS.FAILED;default:return void Yu.error("Unknown visitor left reason",{reason:e})}}(r,o);if(c===MO.prototype.TRANSITION_REASONS.ENGAGED||"opened"!==t.state&&"open"!==t.state)return new MO({state:MO.prototype.QUEUE_STATES.CANNOT_QUEUE,transitionReason:c});var l=$O(u?t.medias.concat(["messaging"]):t.medias,a);return 0===l.length?new MO({state:MO.prototype.QUEUE_STATES.CANNOT_QUEUE,transitionReason:c}):new MO({state:MO.prototype.QUEUE_STATES.CAN_QUEUE,medias:l,transitionReason:c})},eS=I.both(I.propEq("state",MO.prototype.QUEUE_STATES.CANNOT_QUEUE),I.propEq("transitionReason",MO.prototype.TRANSITION_REASONS.ENGAGED)),tS=function(e){var t=e.routingObservable,n=e.internalVisitorStateObservable,r=e.visitorAuthenticatedExternallyObservable,i=e.queuesStateUpdatesObservable,o=e.createQueueTicketStateObservable,s=e.queueTicketBindings,a=e.scheduler;if(a||(a=ju.Scheduler.asap),I.path(["conf","omniq","omniq_enabled"],sm)){var u=new ju.ReplaySubject(1);o.subscribe((function(e){return u.next(!I.contains(e,[DO,VO]))}));var c=function(e,t){return eturn e,t){return t})),wn((function(e){return e})),lo((function(t){return e.bufferWhen((function(){return t.take(1)}))})))})),an((function(e){return ju.Observable.from(e)})))}(function(e){var t=e.routingObservable,n=e.queuesStateUpdatesObservable;return t.pipe(zo((function(e){var t=e.queue_ids;return I.not(t)?Nc.of([]):n.subscribeToListAsObservable({queueIds:t})})),kt(WO),kt(I.objOf("queueState")),vi(I.equals))}({routingObservable:t,queuesStateUpdatesObservable:i}),u),l=ju.Observable.combineLatest(n,r).scan((function(e,t){var n,r,i,o=_(t,2),s=o[0],a=o[1],u=e&&e.activeTicket&&e.activeTicket.id,c=QO(s),l=W_(s,{includeAsyncTransfer:!0}),f=Boolean(l)&&!H_(l);return c?{queued:!0,enqueuedInCurrentTab:(r=c,i=I.lensPath(["visitor","browser_tab_id"]),I.compose(I.equals(sm.tabId),I.view(i))(r)),activeTicket:{id:c.id},visitorLeftReason:null,isEngaged:f,isAsyncTransfer:H_(l),isVisitorAuthenticatedExternally:a}:u&&(n=KO(u,s))?{queued:!1,enqueuedInCurrentTab:!1,activeTicket:null,visitorLeftReason:n.state,isEngaged:f,isAsyncTransfer:H_(l),isVisitorAuthenticatedExternally:a}:{queued:!1,enqueuedInCurrentTab:!1,activeTicket:null,visitorLeftReason:null,isEngaged:f,isAsyncTransfer:H_(l),isV,{}).do((function(e){e.queued||u.next(!0)})).distinctUntilChanged(I.equals);return{aggregateQueueStateObservable:ju.Observable.merge(c,l).scan(I.merge,{}).filter(XO).do((function(e){sm.conf.visitor_api.enable_staffing_logs&&Yu.info("[staffing-logs] Recording raw aggregate queue state",e)})).map(ZO).distinctUntilChanged(I.equals,GO).scan(function(e){return function(t,n){var r;if(n.state===MO.prototype.QUEUE_STATES.QUEUED){var i;t.subscription.unsubscribe();var o=UO.create(e,n);return i=o.ticket,r=o.subscription,n.ticket=i,{queueState:n,subscription:r}}return eS(n)?(Yu.info("Discarding queue ticket subscription as Visitor got engaged"),{queueState:n,subscription:ju.Subscription.EMPTY}):(t.subscription!==ju.Subscription.EMPTY&&Yu.info("Dispose queue ticket subscription as Visitor is no longer queued"),t.subscription.unsubscribe(),{queueState:n,subscription:ju.Subscription.EMPTY})}}(s),{subscription:ju.Subscription.EMPTY}).map(I.prop("queueState")).publishReplay(1,Number.POSITIVE_INFINITY,a).refCount()}}return{aggregateQueueStateObservable:ju.Observable.empty()}},nS=function(e){return e&&e.cause===rf.SALEMOVE.FORBIDDEN||e&&e.cause===rf.SALEMOVE.INVALID_INPUT?["reason:invalid-input"]:["reason:unknown"]},rS=[],iS=function(e){l(n,e);var t=m(n);function n(e){var r;return s(this,n),e||(e={}),(r=t.apply(this,arguments)).ticket=e.ticket,r}return u(n)}(vf),oS=new vf({cause:rf.SALEMOVE.NETWORK_TIMEOUT}),sS=function(e){r=e}(e.status)?!function(e){return 403===e}(e.status)?"Service Unavailable"===e.errorThrown&&(e=new vf({cause:rf.SALEMOVE.INTERNAL_ERROR})):e=new vf({cause:rf.SALEMOVE.FORBIDDEN}):e=new vf({cause:rf.SALEMOVE.NETWORK_TIMEOUT}),ju.Observable.throw(e)},aS=function(e,t){return yw({stats:e,protocol:"rest",failureTagProperty:"error",timeout:t,timeoutError:ju.Observable.throw(oS)})},uS=function(e,t){return e.omniq.omniq_enabled?t():Promise.reject(new vf({cause:rf.SALEMOVE.DISABLED}))},cS=function(e){var t=e.conf,n=e.statsClient,r=e.apiTimeoutMilliseconds;return function(){return uS(t,(function(){return aS(n,r)({resource:"queue_wait_duration",method:"get"},(function(){return Uf({url:Fy("/engagements/queue/wait_duration"),responseType:"json"})})).map(I.compose(I.construct(RO),Zl({average_duration_in_seconds:"averageDurationInSeconds"}),I.mtion(e){return ju.Observable.throw(ME(e))})).catch(gf).toPromise()}))}},lS=I.compose((function(e){var t=e.id,n=e.name,r=e.status,i=e.availableProperties;return new nf({id:t,name:n,status:r,medias:i.media})}),I.evolve({status:tf}),I.pick(["id","name","status","availableProperties"])),fS=function(e){var t=e.conf,n=e.wsProxy,r=e.statsClient,i=e.apiTimeoutMilliseconds,o=e.apiMaxRetries,s=e.apiRetryIntervalMilliseconds;return function(){var e=function(e){return I.not(I.contains(e.status,I.range(400,499)))};return uS(t,(function(){var t=ju.Observable.defer((function(){return aS(r,i)({resource:"queues",method:"get"},(function(){return n.request({method:"GET",url:"".concat(sm.conf.api_url,"/queues?site_ids[]=").concat(sm.siteId),payload:null,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})}))}));return il(t,{maxRetries:o,calculateDelay:M(s),shouldRetry:e}).map(I.prop("queues")).map(I.map(Zl({available_properties:"availableProperties"}))).map(I.map(lS)).catch(sS).catch(gf).toPromise()}))}},pS=function(e){var t=e.wsProxy,n=e.pubsub,r=e.routingObservable,i=e.engagementApi,o=e.engagementRequestApi,s=e.operatorsObservable,a=e.cobraObservable,u=e.channelObservable,c=e.communicationLib,l=e.statsClient,f=e.fetchEngagementDependencies,p=e.apiTimeoutMilliseconds,d=e.apiRetryIntervalMilliseconds,h=e.apiMaxRetries,v=e.connectionStatusObservable,b=e.webRtcMode,m=e.enabledMediaLevel,g=e.visitorMetadata,y=e.conf,w=e.getRequestHeaders,E=e.internalVisitorStateObservable,O=e.visitorAuthenticatedExternallyObservable,S=e.volatileNotifications,T=e.statusObservable,k=e.queuesStateUpdatesObservable,A=e.cobrowsed(r.subscribe((function(e){rS=e.queue_ids})));var N=function(e){return l.increment("engagement.flow",["entrypoint:queue-request"].concat(e))},M=new ju.Subject,R=tS({routingObservable:r,internalVisitorStateObservable:E,visitorAuthenticatedExternallyObservable:O,queuesStateUpdatesObservable:k,createQueueTicketStateObservable:M,queueTicketBindings:{apiTimeoutMilliseconds:p,statsClient:l,wsProxy:t,engagementApi:i,engagementRequestApi:o,cobraObservable:a,fetchEngagementDependencies:f,operatorsObservable:s,channelObservable:u,communicationLib:c,webRtcMode:b,enabledMediaLevel:m,connectionStatusObservable:v,getRequestHeaders:w,internalVisitorStateObservable:E,volatileNotifications:S,pubsub:n,statusObservable:T,cobrowser:A}}).aggregateQueueStateObservable,C=function(e,t){return R.take(1).flatMap((function(n){var r=n.state,i=n.medias;return r===MO.prototype.QUEUE_STATES.CAN_QUEUE?function(e){var t=e.media,n=e.options,r=e.availableMediaTypes;return dw({media:t,options:n,availableMediaTypes:r,availableOneWayMediaTypes:mg(r)})}({media:e,options:t,availableMediaTypes:i}):ju.Observable.throw(new vf({cause:rf.SALEMOVE.FORBIDDEN,message:"Queue state must be: ".concat(MO.prototype.QUEUE_STATES.CAN_QUEUE)}))}))},P=function(){return E.take(1).flatMap((function(e){return Boolean(W_(e))?ju.Observable.throw(new vf({cause:rf.SALEMOVE.FORBIDDEN,message:"Visitor is already engaged"})):ju.Observable.of({})}))},j=function(e){return-1!==["Queue is closed","Queue is full"].indexOf(e.details)?ju.Observable.throw(new vf({cause:rf.SALEMOVE.INVALID_INPUT,message:e.message})):409===e.status?R.take(1).flatMap((function(e){return function(e){return ju.Observable.throw(new iS({cause:rf.SALEMOVE.ALREADY_QUEUED,message:"Visitor is already queued",ticket:e}))}(e.ticket)})):403===e.status?ju.Observable.throw(new vf({cause:rf.SALEMOVE.FORBIDDEN})):"Validation error"===e.error?ju.Observable.throw(new vf({cause:rf.SALEMOVE.INVALID_INPUT,message:e.error})):gf(e)};return{subscription:x,queueForEngagement:function(e,n){return n||(n={}),N(["action:begin"]),uS(y,(function(){var r=_(n.queueId?[{media:e,options:n},P]:[{media:e,options:n,queueIds:rS},C],2),i=r[0],o=r[1],s=function(e){var t=e.wsProxy,n=e.statsClient,r=e.apiTimeoutMilliseconds,i=e.errorHandling,o=e.visitorMetadata;return function(e){var s=e.media,a=e.options,u=e.queueIds;return aS(n,r)({resource:"queue_tickets",method:"create"},(function(){var e={};a.phoneNumber&&(e.phone_number=a.phoneNumber),a.phoneExtension&&(e.phone_extension=a.phoneExtension),a.oneWay&&(e.one_way=a.oneWay);var n=a.source||"sdk",r={media:s,visitor_id:qu(),media_options:e,source:n,visitor_metadata:o,pause_async:!!I.isNil(a.pauseAsync)||a.pauseAsync};a.queueId?r=I.merge(r,{queue_id:a.queueId}):u&&(r=I.merge(r,{queue_ids:u}));var c={method:"POST",url:"".concat(sm.conf.api_url,"/queue_tickets"),payload:I.merge(r,{site_id:sm.siteId}),headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json","x-salemove-tab-id":sm.tabId}};return t.request(c).catch(i||gf).do(null,(function(e){return Yu.warn("Failed to create a queue ticket",{error:e,payload:I.pick(["media","source","queue_id","queue_ids"],r)})}))}))}}({wsProxy:t,statsClient:l,apiTimeoutMilliseconds:p,visitorMetadata:g,errorHandling:j})(i);return o(e,n).do((function(){return M.next(DO)})).do((function(){return N(["action:reach","stage:create-request"])}),(function(e){return N(["action:end","stage:pre-request"].courn N(["action:reach","stage:requested"])}),(function(e){return N(["action:end","st(ection(){return M.next("failed-to-create")})).toPromise()}))},fetchWaitDuration:cS({conf:y,statsClient:l,apiTimeoutMilliseconds:p}),aggregateQueueStateObservable:R,getQueues:NO(fS({conf:y,wsProxy:t,statsClient:l,apiTimeoutMilliseconds:p,apiMaxRetries:h,apiRetryIntervalMilliseconds:d}),6e4,(function(e){return Yu.info("Returning cached response for queues",{cached_queues_length:null==e?void 0:e.length})}))}},dS=function(e,t,n){return function(){if("function"==typeof n&&n(arguments),e&&"function"==typeof e[t])return e[t].apply(e,arguments);throw new vf({cause:rf.SALEMOVE.NOT_SUPPORTED})}},hS=function(e){if(!I.contains(e[0],df))throw new vf({cause:rf.SALEMOVE.INVALID_INPUT,message:"Make sure function argument is one of ISO 3166-1 alpha-2 country codes"})},vS=function(){function e(t){s(this,e),this.triggerQueueMediaSelection=dS(t,"triggerQueueMediaSelection"),this.setChatMessageRenderer=dS(t,"setChatMessageRenderer"),this.setPhoneNumberDefaultCountry=dS(t,"setPhoneNumberDefaultCountry",hS),this.showVisitorCode=dS(t,"showVisitorCode")}return u(e,[{key:"triggerQueueMediaSelection",value:function(e){}},{key:"setChatMessageRenderer",value:function(e){}}eNumberDefaultCountry",value:function(e){}},{key:"showVisitorCode",value:function(){}}]),e}(),bS=u((function e(t){var n=t.id,r=t.siteId,i=t.visitorId,o=t.url,a=t.authenticationApi;s(this,e),this.id=n,this.siteId=r,this.visitorId=i,this.url=o,this.decline=function(e){return a.deleteAuthenticationRequest({id:this.id,siteId:this.siteId,visitorId:this.visitorId,reason:e})}})),mS=new vf({cause:rf.SALEMOVE.NETWORK_TIMEOUT}),gS=function(e){var t=e.wsProxy,n=e.apiTimeoutMilliseconds,r=e.stats,i=yw({stats:r,protocol:"rest",failureTagProperty:"message",timeout:n,timeoutError:ju.Observable.throw(mS)});return{createAuthenticationRequest:function(e){var n=(e=Xl(e)).webhooks||[];return i({resource:"authentication-request",method:"create"},(function(){return t.request({method:"POST",url:"".concat(sm.conf.api_url,"/visitor_authentication_requests"),payload:{authentication_provider_id:e.authenticationProviderId,webhooks:n,visitor_id:qu(),site_id:sm.siteId},headers:pf}).catch((function(t){return function(e,t){var n=404===e.status?new vf({cause:rf.SALEMOVE.INVALID_INPUT,message:"The authentication provider with ID ".concat(t.authenticationProviderId," was not found.")}):mf(e);return ju.Observable.throw(n)}(t,e)}))})).toPromise()},deleteAuthenticationRequest:function(e){var n=e.id,r=e.siteId,o=e.visitorId,s=e.reason;return i({resource:"authentication-request",method:"delete"},(function(){return t.request({method:"DELETE",url:"".concat(sm.conf.api_url,"/visitor_authentication_requests/").concat(n),payload:{site_id:r,visitor_id:o,fail_reason:s},headers:pf}).catch(yf,{allowedCauses:[rf.SALEMOVE.INVALID_INPUT,rf.SALEMOVE.NETWORK_TIMEOUT]})})).toPromise()}}},yS=!1,_S=function(e){var t=e.volatileChannelObservable,n=e.joinChannel,r=e.renewTokenAndReconnectWaitForTeardown;return function(e,t){return t.pipe(zo((function(r_consolidation.requested"===e.event_type})),zo((function(n){var r=n.site_id,o=n.visitor_id,s=n.token_event_id;return e("site_visitor:".concat(o),{topics:["site_visitor:".concat(o,":").concat(r)]}).pipe(Fr((function(e){return e&&"unauthorized"===e.error?cc.Observable.empty():cc.Observable.throw(e)})),an((function(e){return(0,e.observable)("molidation"=={return i(i({},e),{},{volatileChannel:t})})))})))})))}(n,t).subscribe((function(e){var t=e.secret,n=e.assumed_visitor_id,i=e.volatileChannel;Yu.info("Consolidating visitor",{assumed_visitor_id:n}),i.leave(),r({consolidationSecret:t}).delay(0).subscribe((function(){return Vu(n)}),Yu.error.bind(Yu,"Error from renewing token and reconnecting in visitor consolidation"))}),Yu.error.bind(Yu,"Error from visitor consolidation subscription"))},wS=I.prop("id"),ES=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};s(this,e),this._elements=[],this._ids=new Set,this._changeSubject=new ju.Subject,this._insertToBeginning=!0===t.insertToBeginning,this.observable=this._changeSubject.asObservable()}return u(e,[{key:"change",value:function(e,t)ents.map((function(n){return n.id===e?t:n})),this._changeSubject.next(this._elements),this}},{key:"add",value:function(e){return this._ids.has(e.id)?this.change(e.id,e):(this._ids.add(e.id),this._insertToBeginning?this._elements=[e].concat(this._elements):this._elements=this._elements.concat([e])),this._changeSubject.next(this._elements),this}},{key:"replace",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Each((function(e){return t._ids.add(e.id)})),r){var ements.filter((function(e){return!i[e.id]}));this._insertToBeginning?this._elements=o.concat(e):this._elements=e.concat(o)}else this._elements=e;return this._changeSubject.next(s",value:function(){return this._elements}},{key:"valuesUntil",value:function(e){return I.takeWhile((function(t){return!I.propEq("id",e,t)}),this._elements)}}]),e}(),OS=I.pathOr(0,["engagement","unread_message_count"]),SS={MESSAGES:"MESSAGES",UNREA M(T_.initialDelay,T_.maxDelay,T_.factor)},kS={latestQueueIds:[],unreadMessageCount:0,markAsReadCount:0,lastSeenMessageDuringMarkRead:{id:void 0}};function AS(e){var t,n=e.pubsub,r=e.routingObservable,o=e.getRequestHeaders,s=e.internalVisitorStateObservable,a=new ju.Subscription,u=Qf(),c=s.map(OS).distinctUntilChanged().publise){return W_(e,{includeAsyncTransfer:!0})}));a.add(l.subscribe((function(e){t=e})));var f=kS;a.add(r.subscribe((function(e){var t=e.queue_ids;f=i(i({},f),{},e){f=i(i({},f),{},{unreadMessageCount:e})})));var p,d=new ES({insertToBeginning:!0}),h=I.pipe(I.prop("message"),Zl({content:"message",timestamp:"created_at"}),a_),v=I.propEq("event_type","queued_message.created"),b=qu(),m=I.pathEq(["message","sender","type"],"visitor"),g=ju.Observable.create((function(e){var r=n.joinSiteVisitorNotifications(b,[sm.siteId]).pipe(I.filter((function(e){return v(e)||t&&N_(t.id)(e)})),I.reject(m),I.map(h)),i=d.observable.subscribe(e);return i.add(r.subscribe(d.add.bind(d))),i})).throttleTime(50,vt,{leading:!0,trailing:!0}).distinctUntilChanged(I.equals).share(),y=I.propEq("event_type","engagement.files.security_scan_result");u.proxyAll(I.fromPairs([[SS.MESSAGES,g],[SS.UNREAD_MESSAGE_COUNT,c]]));var _=u.addEventListener,w=u.removeEventListener;return{EVENTS:SS,addEventListener:_,uploadFile:function(e,t){var r=t.onUploadProgress,i=qu();return CE(null,e,{onUploadProgress:r,getRequestHeaders:o},function(e){var t=e.visitorId;return p||((p=n.joinSiteVisitorNotifications(t,[sm.siteId]).filter(y).publishReplay(100)).connect(),p)}({visitorId:i}),sm.conf.communications.allowed_file_content_types).toPromise()},removeEventListener:w,fetchMessages:function(){return new Promise((function(e,t){!function(e){var t=e.getRequestHeaders,n=e.onSuccess,r=e.onError;Df({url:"".concat(sm.conf.api_url,"/messaging/chat_transcript"),method:"GET",getRequestHeaders:t,responseType:"nSuccess:function(e){return n(e.response)},shouldRetry:function(e){return e>=500},onError:r})}({getRequestHeaders:o,onSuccess:function(t){var n=u_(t).filter(I.identity);d.replace(n,{retainMissingElements:!0}),e(d.values())},onError:function(e){return t(ME(e))}})}))},send:function(e){var n=e.message,r=e.attachment,s=function(e){var t=e.message,n=e.attachment;return new Xy({id:Tl(),content:t,attachment:n,status:Xy.prototype.STATUSES.SENDING})}({message:n,attachment:r});return d.add(s),new Promise((function(e,a){!function(e){var t=e.id,n=e.ongoingEngagement,r=e.message,i=e.attachment,o=e.queueIds,s=e.getRequestHeaders,a=e.onSuccess,u=e.onError,c=n?"/engagements/".concat(n.id,"/chat_messages/").concat(t):"/messaging/chat_messages/".concat(t);Df({url:sm.conf.api_url+c,method:"PUT",getRequestHeaders:s,contentType:"application/json",responseType:"json",payload:JSON.stringify({source:"tab",content:r,attachment:i,queue_ids:o}),calculateAttemptDelay:TS(),onSuccess:a,shouldRetry:function(e){return e>=500},onError:u})}({id:s.id,ongoingEngagement:t,message:n,attachment:r,queueIds:f.latestQueueIds,getRequestHeaders:o,onSuccess:function(){var t=function(e){return i(i({},e),{},{status:Xy.prototype.STATUSES.DELIVERED})}(s);d.chan{},{status:Xy.prototype.STATUSES.FAILED})}(s);Yu.warn("Failed to send message using message center",{error:e.response||{status:e.status}}),d.change(s.id,t),a(t)}})}))},markMessagesAsRead:function e(){var t=f,n=t.markAsReadCount,r=t.lastSeenMessageDuringMarkRead;f=i(i({},f),{},{markAsReadCount:n+1});var s=d.values()[0];if(s){if(0===n)return 0===f.unreadMessageCount?Promise.resolve():e();var a=d.valuesUntil(r.id);return I.all($y,a)?Promise.resolve():(f=i(i({},f),{},{lastSeenMessageDuringMarkRead:s}),new Promise((function(e,t){Df({url:"".concat(sm.conf.api_url,"/messaging/mark_chat_messages_read"),method:"POST",responseType:"json",getRequestHeaders:o,calculateAttemptDelay:TS(),on()},shouldRetry:function(e){return e>=500},onError:function(e){f=i(i({},f),{},{lastSeenMessageDuringMarkRead:kS.lastSeenMessageDuringMarkRead}),t(ME(_stop:function(){a.unsubscrAPI, do not use"),e.apply(this,arguments)}},IS=function(){function e(t){var n=this,r=t.statusObservable,i=t.cobraObservable,o=t.webRtcMode,a=t.enabledMediaLevel,u=t.statsClient,c=t.channelObservable,l=t.apiStart,f=t.visitorAppPublicInterface,p=t.pubsub,d=t.routingObservable,h=t.visitorMetadata,v=t.internalVisitorStateObservable,b=t.volatileNotifications,m=t.wsProxy,g=t.currentStatusObservable,y=t.operatorPresenceObservable,w=t.getVisitorPriority,E=t.queuesStateUpdatesObservable,O=t.dynamicImport,S=void 0===O?tc:O;s(this,e),this.willNavigate=this.willNavigate.bind(this),this.statsClient=u,this.visitorApp=new vS(f);var T,k=new ju.ReplaySubject(1);this.cobrowser=new Z_({channelObservable:c,internalVisitorStateObservable:v,cobraObservable:i.pluck("cobraSource")}),this.setLocale=function(e){if(I.contains(e,I.keys(sm.conf.visitor_app_assets.locales)))return Vf({url:sm.conf.visitor_app_assets.locales[e],retryLimit:5,calculateAttemptDelay:M(1e3),assetKey:"locale-change",identifier:e,onSuccess:function(t){return Yu.info("Locale updated",{locale:e}),k.next(t.response)}},this.statsClient),{};throw new vf({cause:this.ERRORS.INVALID_INPUT})},this.messageCenter=new AS({routingObservable:(T={internalVisitorStateObservable:v,pubsub:p,routingObservable:d,getRequestHeaders:this.getRequestHeaders}).routingObservable,getRequestHeaders:T.getRequestHeaders,pubsub:T.pubsub,internalVisitorStateObservable:T.intar A=y.map((function(e){return e.values()})),x=y.bufferCount(2,1).flatMap((function(e){var t=_(e,2),n=t[0],r=t[1],i=[];return n.values().forEach((function(e){var t=r.get(e.id);if(t&&!I.equals(e,t))return i.push(t)})),ju.Observable.from(i)})),N=A,R=nc.vent.observable(nc.MSG.PUBLIC.ENGAGEMENT_START),C=nc.vent.observable(nc.MSG.PUBLIC.ENGAGEMENT_END),P=nc.vent.observable(nc.MSG.PUBLIC.ENGAGEMENT_ERROR),j=!1,L=function(e,t){return Vc.merge(e.pipe(kt(I.always(!0))),t.pipe(kt(I.always(!1)))).pipe(Wo(!1))}(R,C);L.subscribe((function(e){j=e})),this.isInEngagement=function(){return j};var q=new ju.ReplaySubject(1),U=function(e){var t=I.equals("engagement");return e.pipe(kt((function(e){var n=e.interaction,r=e.visitor,i=e.engagement;return new lO({engaged:t(n)&&!H_(i),name:r&&r.name,email:r&&r.email})})))}(r),D=functio(function(e){return new fO({connected:e})})))}(p);_S(p);var V=sm.conf.engagement.api_timeout_milliseconds||of,F=sm.conf.omniq.api_retry_interval_milliseconds||1e3,B=sm.conf.omniq.api_max_retries||100,H=new hO({wsProxy:m,stats:this.statsClient,apiTimeoutMilliseconds:V}),W=new wO({wsProxy:m,stats:this.statsClient,apiTimeoutMilliseconds:V,visitorMetadata:h,internalVisitorStateObservable:v}),G=new gS({wsProxy:m,apiTimeoutMilliseconds:V,stats:this.statsClient}),z=pS({wsProxy:m,pubsub:p,routingObservable:d,engagementApi:H,engagementRequestApi:W,operatorsObservable:N,cobraObservable:i.pluck(Dependencies:function(){return S("Comms")},channelObservable:c,communicationLib:sm.conf.communications.lib,statsClient:this.statsClient,apiTimeoutMilliseconds:V,apiRetryIntervalMilliseconds:F,apiMaxRetries:B,connectionStatusObservable:D,webRtcMode:o,enabledMediaLevel:a,visitorMetadata:h,conf:sm.conf,getRequestHeaders:this.getRequestHeaders,internalVisitorStateObservable:v,visitorAuthenticatedExternallyObservable:Bu.asObservable().distinctUntilChanged(),volatileNotifications:b,statusObservable:r,queuesStateUpdatesObservable:E,cobrowser:this.cobrowser});this.queueForEngagement=z.queueForEngagement,this.getQueueWaitDuration=z.fetchWaitDuration,this.getQueues=z.getQueues;var J=z.aggregateQueueStateObservable;this.__queueForEngagement=z.oldQueueForEngagement,this.__setQueueReestablishListener=z.oldSetQueueReestablishListener,this.__fetchQueueWaitDuration=z.getQueueWaitDuration,this.subscribeToQueueStateUpdates=Af({enabled:sm.conf.omniq.omniq_enabled,statsClient:this.statsClient,pubsub:p}).subscribe,this.requestEngagement=function(e,t){var s=BE({api:W,conf:sm.conf,operatorsObservable:N.take(1),media:e,options:t,statsClient:n.statsClient,cobraObservable:i.take(1).pluck("cobraSource"),channelObservable:c,engagementApi:H,webRtcMode:o,enabledMediaLevel:a,connectionStatusObservable:D,getRequestHeaders:n.getRequestHeaders,internalVisitorStateObservable:v,volatileNotifications:b,statusObservable:r,pubsub:p,wsProxy:m,dynamicImport:S,cobrowser:n.cobrowser});return function(e){var t=e.operatorObservable,n=e.engagementObservable,r=e.cancelEngagementRequest,i=e.engagementRequestTimeout;return new HE({timeout:i,engagementPromise:n.toPromise(),operatorPromise:t.toPromise(),cancel:r})}({operatorObservable:s.operatorObservable,engagementObservable:s.engagementObservable,cancelEngagementRequest:s.cancelEngagementRequest,engagementRequestTimeout:s.engagementRequestTimeout})};var Y=function(e){var t=e.internalVisitorStateObservable,n=e.webRtcMode,r=e.enabledMediaLevel,i=e.engagementRequestApi,o=e.statsClient,s=e.cobraObservable,a=e.channelObservable,u=e.engagementApi,c=e.connectionStatus,l=e.getRequestHeaders,f=e.volatileNotifications,p=e.statusObservable,d=e.pubsub,h=e.wsProxy,v=e.dynamicImport,b=e.cobrowser,m=1e3*sm.conf.engagement.proactive_call_timeout,g=I.compose(I.nth(0),I.filter((function(e){return I.any(I.propEq("id",sm.siteId),e.transferrable_sites)})),I.filter(I.propEq("outcome",null)),I.filter(I.propEq("type","proactive")),I.pathOr([],["engagement","requests"]));return t.map(g).filter(I.identity).distinctUntilChanged(null,I.prop("id")).map((function(e){var v=Jg({id:e.operator.id,name:e.operator.name,formattedName:e.operator.formatted_name,picture:{url:e.operator.picture_url},mediaType:e.operator.media_type,webRtcMode:n,enabledMediaType:r}),g=Jg({id:e.operator.id,name:e.operator.name,formattedName:e.operator.formatted_name,picture:{url:e.operator.picture_url},mediaType:e.offered_media_type,webRtcMode:n,enabledMediaType:r});return{incomingEngagementRequest:sO.create({api:i,id:e.id,operator:v,restrictedOperator:g,message:e.welcome_message,logoUrl:sm.conf.visitor_app.site_logo.url,platform:e.platform,timeout:m,statsClient:o,cobraObservable:s.take(1).pluck("cobraSource"),channelObservable:a,engagementApi:u,connectionStatusObservable:c,getRequestHeaders:l,internalVisitorStateObservable:t,volatileNotifications:f,statusObservable:p,pubsub:d,wsProxy:h,cobrowser:b}),platform:e.platform}})).switchMap((function(e){var t=e.incomingEngagementRequest,n=e.platform;return v("Comms").mapTo({incomingEngagementRequest:t,platform:n})}))}({dynamicImport:S,internalVisitorStateObservable:v,webRtcMode:o,enabledMediaLevel:a,engagementRequestApi:W,statsClient:this.statsClient,cobraObservable:i,channelObservable:c,engagementApi:H,connectionStatus:D,getRequestHeaders:this.getRequestHeaders,volatileNotifications:b,statusObservable:r,pubsub:p,wsProxy:m,cobrowser:this.cobrowser}),Q=new WE,K=Y.filter(I.propEq("platform",lf)).map(I.prop("incomingEngagementRequest")unction(e){Q.add(K.subscribe(e,Yu.error))};var X=function(e){var t=e.reestablishObservable,n=e.defaultOmnicoreHandler,r=e.defaultOmnibrowseHandler,i=e.internalVisitorStateObservable,o=e.sessionStore||Km,s=e.timeout||15e3,a=t.publishReplay(1);a.connect();var u={replayetion(e,t){return{source:e,visitorState:t}})).filter((function(e){var t=e.source,n=e.visitorState;return!!t.engagement.engagementId&&I.compose(I.find(I.propEq("id",t.engagement.engagementId)),I.pathOr([],["engagement","engagements"]))(n)})).map((function(e){return e.source})),sessionStore:o,timeout:s};return{setOmnicoreReestablishHandler:cO(I.merge(u,{defaultHandler:n,storeKey:"custom_reestablish_handler_set",platform:lf})),setOmnibrowseReestablishHandler:cO(I.merge(u,{defaultHandler:r,storeKey:"omnibrowse_custom_reestablish_handler_set",platform:ff}))}}({reestablishObservable:l.flatMap((function(){return uO({channelObservable:c,cobrowser:n.cobrowser,internalVisitorStateObservable:v,statusObservable:r,webRtcMode:o,enabledMediaLevel:a,statsClient:n.statsClient,cobraObservable:i,isEngagedObservable:L,engagementApi:H,connectionStatusObservable:D,getRequestHeaders:n.getRequestHeaders,volatileNotifications:b,pubsub:p,wsProxy:m,dynamicImport:S})})),defaultOmnicoreHandler:function(e){return Yu.warn("Engagement reestablished without a reestablish handler in place")},defaultOmnibrowseHandler:function(e){return Yu.warn("Phone-first (OmniBrowse) engagement reestablished without a reestablish handler in place")},internalVisitorStateObservable:v}),$=X.setOmnicoreReestablishHandler,Z=X.setOmnibrowseReestablishHandler;this.setEngagementReestablishHandler=$,this.request){return I.merge(n.getRequestHeaders(),t)})).toPromise()},this.omnibrowse=new zE({incomingEngagementRequestObservable:Y,setOmnibrowseReestablishHandler:Z,statsClient:this.statsClient,wsProxy:m}),this.overseer=new $E({operatorListReady:A.take(1),isOmniqEnabled:sm.conf.omniq.omniq_enabled,routingObservable:d,queueStateReady:J.take(1)}),this.omnicall=new eO,this.config=new rO,this.getBrowserContext=function(){return g.take(1).map((function(e){return{tab_id:sm.tabId,url:window.location.href,metadata:sm.conf.visitor_metadata,status:e}})).toPromise()},this.updateInformation=function(e){return g.take(1).flatMap((function(t){return xO(e,{createApiRequestObservable:function(e){return Uf({url:Fy("/sites/".concat(Fu(),"/visitors/").concat(qu())),method:"PATCH",contentType:"application/json",payload:e})},serverResponseTimeout:of,tabId:sm.tabId,visitorMetadata:sm.conf.visitor_metadata,status:t})})).toPlled",e),G.createAuthenticationRequest(e)},this.setupContactOperatorButton=function(e){return e||(e={}),Yu.warn("setupContactOperatorButton is deprecated!"),q.next(e)};var ee=function(e){var t=e.internalVisitorStateObservable,n=e.authenticationApi,r=I.compose(I.find((function(e){return e.site_id===Fu()&&e.visitor_id===qu()})),I.pathOr([],["authentication_requests"]));return t.pipe(kt(r),wn(I.identity),vi(I.equals),kt((function(e){return I.construct(bS)({id:e.id,siteId:e.site_id,visitorId:e.visitor_id,url:e.url,authenticationApi:n})})))}({internalVisitorStateObservable:v,authenticationApi:G}),te=I.fromPairs([[this.EVENTS.ENGAGEMENT_START,R],[this.EVENTS.ENGAGEMENT_END,C],[this.EVENTS.ENGAGEMENT_ERROR,P],[this.EVENTS.VISITOR_STATUS_UPDATE,U],[this.EVENTS.OPERATOR_STATUS_UPDATE,x],[this.EVENTS.OPERATOR_LIST_UPDATE,A],[this.EVENTS.ENGAGEMENT_REQUEST,Y.map(I.always({}))],[this.EVENTS.CONNECTION_STATUS_UPDATE,D],[this.EVENTS.QUEUE_STATE_UPDATE,J],[this.EVENTS.AUTHENTICATION_REQUEST,ee],["contact_operator_button_configuration",q],["locale_change_requested",k]]),ne=Qf();ne.proxyAll(te),this.addEventListener=ne.addEventListener,this.removeEventListe,this.observable=function(e){return te[e]},function(e){var t,n=e.internalVisitorStateObservable,r=e.useOmniq,i=e.operatorListUpdate,o=e.queueStateUpdate,s=e.statsClient,a=e.staffingCheckDelayMs,u=void 0===a?1e4:a,c=e.recordingMaxTime,l=void 0===c?6e4:c,f=I.compose(I.length,I.filte=n.map((function(e){return Boolean(W_(e))})).filter(I.equals(!0));t=r?o.map((function(e){return sm.conf.visitor_api.enable_staffing_logs&&Yu.info("[staffing-logs] Recording queue state",{queue_state:e.state}),I.contains(e.state,[e.QUEUE_STATES.CAN_QUEUE,e.QUEUE_STATES.QUEUED])?"staffed":"general"})):i.map((function(e){return sm.conf.visitor_api.enable_staffing_logs&&Yu.info("[staffing-logs] Recording operator state",{operator_count:f(e)}),f(e)>0?"staffed":"general"})),sm.conf.visitor_api.enable_staffing_logs&&Yu.info("[staffing-logs] Starting recorder timer",{duration:u});var d=ju.Observvar t=setTimeout((function(){e.next(null)}),u);return functionperformance.now&&window.performance.now()},b=v();d.flatMapTo(t).take(1).takeUntil(p).subscribe((function(e){var t=new Date,n=v(),r=t-h+1e3<=u;r||t-h>l?Yu.warn("Recording staffing failed due to browser timer issues",{type:e,early_recording:r,start_time:h.toISOString(),recording_time:t.toISOString(),accurate_start_time:b,accurate_recording_time:n,difference:t&&t-h,accurate_difference:n&&n-b}):s.increment("usage_metrics.visitor.reactive_tab_showed",["type:".concat(e),"source:desktop","site_id:".concat(Fu()),"visitor_id:".concat(qu())])}),Yu.error)}({internalVisitorStateObservable:v,useOmniq:sm.conf.omniq.omniq_enabled,operatorListUpdate:this.observable(this.EVENTS.OPERATOR_LIST_UPDATE),queueStateUpdate:this.observable(this.EVENTS.QUEUE_STATE_UPDATE),statsClient:this.statsClient});var re=Ml();!function(e){var t=e.visitorIdleAfterTime,n=e.pubsub;t.subscribe((function(){sm.logger.info("Visitor was idle for too long, disconnecting"),n.disconnect(),yS=!0}))}({visitorIdleAfterTime:function(e,t){var n=e.activityObservable,r=e.engagementEndObservable,i=e.timeUntilIdle,o=e.maxIdleTime,s=e.isEngaged;return ju.ObservaTime(i+o,t).filter((function(){return!s()})).map((function(){}))}({activityObservable:re,engagementEndObservable:C,timeUntilIdle:1e3*sm.conf.engagement.visitor_time_to_inactive_sec,maxIdleTime:1e3*sm.conf.visitor_api.max_idle_time_secondconf.visitor_api.disconnect_idle_visitors})),pubsub:p}),function(e){var tnction(){return yS&&n.allowReconnection()})).subscribe((function(){sm.logger.info("Reconnecting idle visitor due to detected activity"),yS=!1,n.connect()}))}({activityObservable:re,pubsub:p}),this.getSessionContext=function(){var e={tab_id:sm.tabId,visitor_priority:w(),access_token:sm.accessToken};return encodeURIComponent(btoa(JSON.stringify(e)))},this.__pubsub__={reconnect:xS(p.reconnect),socket:xS((function(){return p.__socket__}))}}",Authorization:"Bearer "+sm.accessToken}}},{key:"getVisitorId",value:funct:"getSiteId",value:function(){return Fu()}},{key:"leaveMessage",value:function(e){return iO(e,{createApiRequestObservable:function(e){return Uf({url:Fy("/visitor/offline_message"),method:"POST",contentType:"application/json",payload:e})},serverResponseTimeout:of}).toPromise()}},{key:"leaveOperatorMessage",value:function(e){return function(e,t,n){e||(e={}),n||(n=ju.Scheduler.asap);var r=e.operatorId;return r?iO(I.merge({operator_id:r},e),t,["operator_id"],n):ju.Observable.throw({cause:rf.SALEMOVE.INVALID_INPUT,message:"operatorId must be specified"})}(e,{createApiRequestObservable:function(e){return Uf({url:Fy("/visitor/operator_message"),method:"POST",contentType:"application/json",payload:e})},serverResponseTimeout:oflue:function(){return Promise.resolve({})}},{key:"changeElementAttributesForCobrowsing",value:function(e,t){if("function"!=typeof t)throw new vf({cause:this.ERRORS.INVALID_INPUT});return e.sm_change_element_attributes=Jf("Custom element attribute serializer threw error",cf,t),function(e){e.setAttribute(pO,"0"===(e.getAttribute(pO)||"0")?"1":"0")}(e),null}}]),e}();IS.prototype.ERRORS={INVALID_INPUT:"invalid input",OPERATOR_UNAVAILABLE:"operator unavailable",INTERNAL_ERROR:"internal error",RESOURCE_NOT_FOUND:"not found",OPERATOR_DECLINED:"operator declined",DECLINE:"decline",CANCEL:"cancel",TIMEOUT:"timeout",NETWORK_TIMEOUT:"network timeout",CONNECTION_LOST:"connection lost",TOO_MANY_REQUESTS:"too many requests",FORBIDDEN:"forbidden",NOT_SUPPORTED:"not supported",DISABLED:"disabled",ALREADY_QUEUED:"already queued",ALREADY_ENGAGED:"already engaged",CONFLICT:"conflict",FILE_TOO_LARGE:"file too large",FILE_CONTENT_TYPE_NOT_ALLOWED:"file content type not allowed",DENIED_BY_PERMISSIONS_POLICY:"denied by permissions policy",DEVICE_ACCESS_ERROR:"device access error",DENIED_BY_SYSTEM:"denied by system"},IS.prototype.EVENTS={ENGAGEMENT_END:"sm:engagement:end",ENGAGEMENT_START:"sm:engagement:start",ENGAGEMENT_ERROR:"sm:engagement:error",VISITOR_STATUS_UPDATE:"sm:visitor_status:update",ENGAGEMENT_REQUEST:"sm:engagement:request",OPERATOR_LIST_UPDATE:"sm:operator_list:update",OPERATOR_STATUS_UPDATE:"sm:operator_status:update",CONNECTION_STATUS_UPDATE:"sm:connection_status:update",QUEUE_STATE_UPDATE:"sm:queue:update",AUTHENTICATION_REQUEST:"sm:authentication:request"};var NS="sm.app.visitor_api.send_capabilities",MS=function(){function e(t){var n=t.channelObservable,r=t.statsClient,i=t.getLocalCapabilities,o=void 0===i?AE:i;s(this,e),this.channelObservable=n,this.statsClient=r,this.getLocalCapabilities=o,this._receivePostMessage=this._receivePostMessage.bind(this),this._restoreLastUrl=this._restoreLastUrl.bind(this),this._subscription=new ju.Subscription,this.lastUrl=window.location.href}return u(e,[{key:"start",value:function(){return this._addListeners()}},{key:"capabilitiesRequestObservable",value:function(){return this.channelObservable.switchMap((function(e){var t=e.channel;return function(e){return sm.logger.log("Capabilities response, received request"),e.observable("capabilities:request")}(t).map((function(){return t}))}))}},{key:"_addListeners",value:function(){var e=this;nc.vent.observable("visit:restore_url").subscribe(this._restoreLastUrl,sm.logger.error),window.addEventListener("message",this._receivePostMessage,!1),this._subscription.addcalCapabilities:e.getLocalCapabilities()}})).do((function(){return e.statsClient.increment(NS,["action:succeeded"])})).do(null,(function(){return e.statsClient.increment(NS,["action:failed"])})).subscribe((function(e){var t=e.channel,n=e.localCapabilities;sm.logger.log("Sending local capabilities",n),t.emit("capabilities:response",n)}),sm.logger.warn.bind(sm.logger,"Failed to send visitor capabilities")))}},{key:"_receivePostMessage",value:function(e){try{var t=JSON.parse(e.data);t["sm-xdr-url"]&&(this.lastUrl=t["sm-xdr-url"])}catch(e){}}},{key:"_restoreLastUrl",value:function(){var e;null!==(e=sm.conf.visitor_api)&&void 0!==e&&e.use_buggy_iframe_reload?this._oldRestoreLastUrl():window.location.hash&&this.lastUrl.split("#")[0]===window.location.href.split("#")[0]?window.location.reload():window.location.href=this.lastUrl}},{key:"_oldRestoreLastUrl",value:function(){this.lastUrl&&this.lastUrl.split("#")===window.location.href.split("#")[0]?window.location.reload():window.location.href=this.lastUrl}}]),e}(),RS=["v1"],CS=new Promise((function(e,t){return sm._apiHandlers.push({resolve:e,options:{version:"v1"}})})),PS=new ju.Subject,jS=ju.Observable.fromPromise(CS).flatMap((function(e){return ju.Observable.merge(e.observable(e.EVENTS.ENGAGEMENT_START),GAGEMENT_END).map((function(){return null})))})).publishReplay(1);jS.connect();var LS=function(){function e(t){var n=t.element;s(this,e),this._empty=this._empty.bind(this),this._startOperatorMediaInElement=this._startOperatorMediaInElement.bind(this),this.element=n,this._subscription=new ju.Subscription;var r=_(jS.partition(I.identity),2);this.startMediaObservable=r[0],this.endMediaObservable=r[1]}return u(e,[{key:"start",value:function(){this._subscription.add(this.startMediaObservable.subscribe(this._startOperatorMediaInElement,Yu.error)),this._subscription.add(this.endMediaObservable.subscribe(this._empty,Yu.error))}},{key:"destroy",value:function(){this._subscription.unsubscribe()}},{key:"_empty",value:function(){this.element.innerHTML=""}},{key:"_startOperatorMediaInElement",value:function(e){var t=n.default.visitor_api?n.default.visitor_api.use_updated_webcomponents:void 0;e.communicationWidget.startOperatorMedia(this.element),Yu.info("Starting operator media in widget",{engagement_id:e.engagementId,updated_webcomponents:t}),Qu.increment("sm.app.visitor.customElements",["action:succeeded","type:engaged_operator","updated_webcomponents:".concat(t)])}}]),e}(),qS=function(){if(sm.conf.visitor_api&&sm.conf.visitor_api.use_updated_webcompo{return s(this,n),t.apply(this,arguments)}return u(n,[{key:"connectedCallback",value:function(){return this._controller=new LS({element:this}),this._controller.start()}},{key:"disconnectedCallback",value:function(){return this._controller.destroy()}}]),n}(v(HTMindow.Reflect.construct(HTMLElement,[],e)};return Object.setPrototypeOf(e.prototype,HTMLElement.prototype),Object.setPrototypeOf(e,HTMLElement),e.prototype.connectedCallback=function(){return this._controller=new LS({element:this}),this._controller.start()},e.prototype.disconnectedCallback=function(){return this._controller.destroy()},e}super__.constructor.apply(this,arguments)}return function(e,n)[r]=n[r]);function i(){this.constructor=e}i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype}(n,HTMLElement),n.prototype.attachedCallback=function(){return this._controller=new LS({element:this}),this._controction(){return this._controller.destroy()},n}()},US=function(){var e=qS();if(window.customElements)try{customElements.get("sm-engaged-operator")||window.customElements.define("sm-engaged-operator",e)}catch(e){var t=n.default.visitor_api?n.default.visitor_api.use_updated_webcomponents:void 0;Qu.increment("sm.app.visitor.customElements",["action:failed","type:engaged_operator","updated_webcomponents:".concat(t)]),Yu.error("Failed to initiate sm-engaged-operator",{error_message:e?e.message:void 0,updated_webcomponents:t})}else document.registerElement("sm-engaged-operator",e)},DS=function(){function e(t){var n=t.engagedVisitorElement,r=t.attributes;s(this,e),this._addListeners=this._addListeners.bind(this),this._empty=this._empty.bind(this),this._startVisitorMedia=this._startVisitorMedia.bind(this),this.engagedVisitorElement=n,this._subscription=new ju.Subscription,this._aue:function(){return this._addListeners()}},{key:"destroy",value:function(){return this._subscription.unsubscribe()}},{key:"_addListeners",value:function(){var e=_(jS.partition(I.identity),2),t=e[0],n=e[1];return this._subscription.add(t.subscribe(this._startVisitorMedia,Yu.error)),this._subscription.add(n.subscribe(th){this.engagedVisitorElement.innerHTML=""}},{key:"_startVisitorMedia",value:function(e){var t=n.default.visitor_api?n.default.visitor_api.use_updated_webcomponents:void 0,r=document.createElement("div");this.engagedVisitorElement.appendChild(r),e.communicationWidget.startVisitorMedia(r,this._attributes),Yu.info("Starting visitor media in widget",{engagement_id:e.engagementId,updated_webcomponents:t}),Qu.increment("sm.app.visitor.customElements",["action:succeeded","type:engaged_visitor","updated_webcomponents:".concat(t)])}}]),e}(),VS=function(){if(sm.conf.visitor_api&&sm.conf.visitor_api.use_updated_webcomponents)return function(e){l(n,e);var t=m(n);function n(){return s(this,n),t.apply(this,arguments)}return u(n,[{key:"connectedCallback",value:function(){this._controller=new DS({engagedVisitorElement:this,attributes:{translations:JSON.parse(this.getAttribute("translations"))||{}}}),this._controller.start()}},{key:"disconnectedCallback",value:function(){this._controller.destroy()}}]),n}(v(HTMLElement));if(window.customElements){var e=function e(){return window.Reflect.construct(HTMLElement,[],e)};return Object.setPrototypeOf(e.prototype,HTMLElement.prototype),Object.setPrototypeOf(e,HTMLElement),e.prototype.connectedCallback=function(){this._controller=new DS({engagedVisitorElement:this,attributes:{translations:JSON.parse(this.getAttribute("translations"))||{}}}),this._controllerack=function(){this._controller.destroy()},e}var t={}.hasOwnProperty;return function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return function(e,n){var r;for(r in n)t.call(n,r)&&(e[r]=n[r]);function i(){this.constructor=e}i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype}(n,HTMLElement),n.prototype.attachedCallback=function(){return this._controller=new DS({engagedVisitorElement:this,translations:this.getAttribute("translations")||{}}),this._controller.start()},n.prototype.detachedCallback=function(){return this._controller.destroy()},n}()},FS=function(){var e=VS();if(window.customElements)try{customElements.get("sm-engaged-visitor")||window.customElements.define("sm-engaged-visitor",e)}catch(e){var t=n.default.visitor_api?n.default.visitor_api.use_updated_webcomponents:void 0;Qu.increment("sm.app.visitor.customElements",["action:failed","type:engaged_visitor","updated_webcomponents:".concat(t)]),Yu.error("Failed to initiate sm-engaged-visitor",{error_message:e?e.message:void 0,updated_webcomponents:t})}else document.registerElement("sm-engaged-visitor",e)},BS=!1,HS=!1,WS=[],GS=function e(){if(!HS){if(!document.body)return setTimeout(e,13);if(HS=!0,WS){for(var t,n=0entListener("DOMContentLoaded",e,!1),GS()};function JS(e){!function(){if(!BS){if(BS=!0,"complete"===document.readyState||"interactive"===document.readyState)return GS();document.addEventListener("DOMContentLoaded",zS,!1),window.addEventListener("load",GS,!1)}}(),HS?e.call(dlocalStorage.setItem("sm.access_token",e)},QS=function(e){var t=e.token,n=e.offset,r=void 0===n?-5e3:n,i=e.scheduler,o=void 0===i?ju.Scheduler.asap:i,s=e.getJwtExpMSFn,a=void 0===s?pg:s,u=e.startDate,c=void 0===u?Date.now():u;return ju.Observable.timer(a(t)+r-c,o)},KS=function(e){var t=e.accessTokenRenewalSignal,n=e.accessToken,r=e.getGliaContextObservable,i=void 0===r?lg:r,o=e.tokenExpirationObservable,s=void 0===o?QS:o,a=e.isVisitorAuthenticatedExternallyFn,u=void 0===a?Hu:a;I.not(u)||i().switchMap((function(e){var t=e.idToken,r=function(e,t){return 3===e.split(".").length?e:t}(t,n);return s({offset:-5e3,token:r}).mapTo(t)})).switchMap((function(e){return i().map((function(t)nction(e){vareturn t.next({expiringIdTokenRefresh:!0})}))};if(sm.conf.visitor_api.persist_visitor_session_in_url){sm.urlParams=my({accessToken:/.+/,tabId:/.+/},{targetWindow:window,logger:Yu})}else sm.urlParams={};if("show_visitor_code"===sm.conf.visitor_app.chat_link_visitor_consolidation){var XS=my({showVisitorCode:/true/},{targetWindow:window,logger:Yu});I.isEmpty(XS)||(sm.urlParams.showVisitorCode=!0)}var $S={setStatsClient,setLogger:function(){},ready:function(){}},ZS=function(e){var t=sm.conf.visitor_app_assets,n="visitor_app";return new Promise((function(r,i){var o,s,a;-1!==["latest_new_app","latest_v2","latest_v2_plus"].indexOf(sm.conf.visitor_app_option)?(o=function(e){e.setAttribute("data-sm-visitor-app-asset",""),e.setAttribute("data-loaded-callback","sm.visitorAppAttribute("data-sm-visitor-app-asset","")},a=function(){return r($S)}),t.js.forEach((function(t){s=t.substring(t.lastIndexOf("/")+1),L({integrity:j({versionedName:s}),fileUrl:t,beforeLoad:o,onAttempt:function(){e.increment("sm.assets.load",["action:attempted","asset:".concat(n,".js")])},onLoad:function(){e.increment("sm.assets.load",["action:succeeded","asset:".concat(n,".js")]),a&&a()},onError:function(){e.increment("sm.assets.load",["action:warning","asset:".concat(n,".js")])},onGiveUp:function(){e.increment("sm.assets.load",["action:failed","asset:".concat(n,".js")]),Yu.warn(new Error("Failed to load visitor app JS asset"),{asset_url:t})}})})),t.css.forEach((function(t){s=t.substring(t.lastIndexOf("/")+1),q({integrity:j({versionedName:s}),fileUrl:t,onAttempt:function(){e.increment("sm.assets.load",["action:attempted","asset:".concat(n,".css")])},onError:function(){e.increment("sm.assets.load",["action:warning","asset:".concat(n,".css")])},onGiveUp:function(){e.increment("sm.assets.load",["action:failed","asset:".concat(n,".css")]),Yu.warn(new Error("Failed to load visitor app CSS asset"),{asset_url:t})}})}))}))},eT=function(){return-1!==["latest_new_app","latest_v2","latest_v2_plus","custom","omnibrowse"].indexOf(sm.conf.visitor_app_option)},tT=function(e){var t=e.statsisitor_app.visitor_app_default_locale||""},rT={translations:{}},iT=function(e){return new Promise((function(t,n){var r=nT(),i=(sm.conf.visitor_app_assets.locales||{})[r];i?Vf({url:i,retryLimit:5,calculateAttemptDelay:M(1e3:functiolocale failed, using empty locale"),t(rT)}},e):(e.increment("sm.assets.load",["action:failed","asset:locale","reason:locale_missing"]),Yu.warn("Locale is not present, starting with defaultMessages",{localeKey:r,localeUrl:i}),t(rT))}))},oT=function(e){return"en-US"===nT()?Promise.resolve(rT):eT()?iT(e):Promise.resolve(rT)},sT=function(e){var t=oy.extractLinkFromEvent(e);t&&function(e,t){"https:"!==t.protocol&&"http:"!==t.protocol||oy.isAllowedToNavigate(t.hostname)||(e.preventDefault(),window.open(t.href))}(e,t)},aT=function(){return Jm.unloadMaybeToPageCache.subscribe((function(){return Km.set(Ly,Uy(document))}))},uT=function(e){var t=e.getAccessToken,n=e.stats,r=e.pubsub,i=e.visitorPresenceChannel,o=e.internalVisitorStateObservable,s=e.volatileNotifications,a=e.wsProxy,u=e.operatorPresenceObservable,c=e.routingObservable;document.body.addEventListener("click",sT),aT(),function(e){var t=e.getAccessToken,n=e.stats,r=e.pubsub,i=e.visitorPresenceChannel,o=e.internalVisitorStateObservable,s=e.volatileNotifications,a=(e.wsProxy,e.operatorPresenceObservable),u=e.routingObservable;dp();var c=ep({channelObservable:Ry({internalVisitorStateObservable:o,getAccessToken:t,stats:n,visitorPresenceChannel:i,salemovePresentInParent:!0}).channelObservable,logger:Yu}).cobraObservable,l=Af({enabled:sm.conf.omniq.omniq_enabled,statsClient:n,pubsub:r});zf({internalVisitorStateObservable:o,cobraObservable:c,volatileNotifications:s,stats:n,currentStatusObservable:Zm(o),operatorPresenceObservable:a,queuesStateUpdatesObservable:l,routingObservable:u})}({getAccessToken:t,stats:n,pubsub:r,visitorPresenceChannel:i,internalVisitorStateObservable:o,volatileNotifications:s,wsProxy:a,operatorPresenceObservable:u,routingObservable:c}),ac(),sy()},cT={setup:function(){YS(sm.accessToken),Yu.info("Visitor WebRTC mode",{webrtc_mode:Pg()}),sm.conf.visitor_app.theme=sm.conf.visitor_app.theme.desktop_css_url;var e=fy(),t=e.bestEffortXDomainStorage,n=e.windowNameStorage,r=e.xDomainUrlStorage,i=Xm.setup(n,{sessionContext:sm._sessionContext,tabIdFromConfiguration:sm.tabId}).getId();sm.tabId=i;var o=new ju.Subject;!function(e,t){N=I.merge(N,{enabled:t}),e.take(1).subscribe((functible("system:visitor_retry_configuration")})).subscribe((function(e){N=e}))}))}(o,sm.conf.visitor_request_retries_enabled);var s=getItem(ng)}(t)||tg,a=function(){return s},u=I.pathOr(!1,["sm","conf","site_visitor_config","detect_visitor_by_external_session_token"])(window),c=I.pathOr(!1,["sm","conf","engagement_restart","skip_on_unauthentication"])(window),l=new ju.Subject,f=function(e){var t=e.fetchToken,n=void 0===t?vg:t,r=e.accessToken,i=e.scheduler,o=void 0===i?ju.Scheduler.asap:i,s=e.accessTokenRenewalSignal,a=void 0===s?ju.Observable.empty():s,u=e.backoffStrategy,c=void 0===u?M:u,l=e.getVisitorPriority,f=e.getVisitorTabId,p=void 0===f?function(){return sm.tabId}:f,d=e.detectVisitorByExternalSessionTokenEnabled,h=void 0!==d&&d,v=new ju.ReplaySubject(1),b=dg(r);v.next(b);var m=c(3e3),g=function(e){return function(e){return e&&e.consolidationSecret}(eion(e){return e&&e.expirnction(e){return ju.Observable.timer(e,o)})).merge(a.filter(I.complement(g))).throttleTime(6e4,o).merge(a.filter(g)).switchMap((function(e){var t={priority:l(),tabId:p(),detectVisitorByExternalSessionTokenEnabled:h};e&&e.consolidationSecret?t.consolidationSecret=e.consolidationSecret:e&&e.expiringIdTokenRefresh?t.includeIdToken=!1:t.accessToken=r,Yu.info("Refreshing.Observable.defer((function(){return n(t)})).do(null,(function(e){503!==e.status&&429!==e.status||(Yu.warn("Visitor access token unavailable, switching to maximum backoff"),m.maximizeNextDelay()),Yu.warn("Failed to fetch JWT token. Retrying...",e.responseText)}));return il(i,{maxRetries:403200,calculateDelay:m,scheduler:o}).do((function(e){var t=e.accessToken;r=t;var n=dg(t);v.next(n),Yu.info("Access token refresh succeeded",{interval_seconds:n/1e3})}))}))}({accessToken:sm.accessToken,accessTokenRenewalSignal:l,getVisitorPriority:a,detectVisitorBhare(),p=function(){return sm.accessToken};Hu()&&KS({accessTokenRenewalSignal:l,accessToken:sm.accessToken});var d=rd({server:sm.conf.pubsub_server,stats:Qu,logsEnabled:sm.conf.visitor_api.pubsub_logsfunction(e){return l.next(e),f.delay(1e3)},reconnectConf:{initialDelay:sm.conf.visitor_api.socket_connection_error_retry_delay,maxDelay:sm.conf.visitor_api.socket_connection_error_max_delay,delayFactor:sm.conf.visitor_api.socket_connection_error_delay_factor},getVisitorPriority:a});o.next(d),f.subscribe((function(e){var t,n,r,i,o,s=e.accessToken,a=e.visitorId,u=e.authenticatedExternally,f=pg(sm.accessToken)!==pg(s);sm.accessToken=s,YS(s),f&&u&&KS({accessTokenRenewalSignal:l,accessToken:sm.accessToken}),t={oldVisitorId:qu(),newVisitorId:a,oldAuthenticatedExternally:Hu(),newAuthenticatedExternally:u},n=t.oldVisitorId,r=t.newVisitorId,i=t.oldAuthenticatedExternally,o=t.newAuthenticatedExternally,r!==n&&o!==i&&function(e){var t=e.visitorId,n=e.authenticatedExternally,r=e.pubsub,i=e.skipEngagementRestartOnUnauthentication,o=void 0!==i&&i,s=e.App,a=void 0===s?nc:s,u=e.setNewVisitorIdFn,c=void 0===u?Vu:u,l=e.setVisitorAuthenticatedExternallyFn,f=void 0===l?Wu:l;(n||!o)&&a.vent.trigger("engagemenr.disconnect((function(){c(t),r.connect()}))}({visitorId:a,authenticatedExternally:u,pubsub:d,skipEngagementRestartOnUnauthentication:c})})),lg().switchMap((function(e){var t=e.idToken;return function(e){var t=e.accessTokenObservable,n=e.timeInterval,r=void 0===n?1e3:n,i=e.scheduler,o=void 0===i?ju.Scheduler.asap:i,s=e.initialValue,a=e.getGliaContextAsObservable,u=void 0===a?lg:a,c=s;return ju.Observable.merge(t,ju.Observable.of(null)).switchMap((function(){return ju.Observable.timer(r,r,o).switchMap((function(){return u().filter((function(e){var t=e.idToken,n=t===c;return c=t,!n}))})).take(1)}))}({accessTokenOcribe((function(){l.next({newIdToken:!0})}));var h=new id(d,{tabId:sm.tabId,idleTimeoutSeconds:sm.conf.engagement.visitor_time_to_inactive_sec,visitorMetadata:sm.conf.visitor_metadata}),v=Bm({pubsub:d,tabId:sm.tabId});(function(e,t){r().do((function(e){rg,e)}))})(v,t).subscribe((function(e){s=e}));vation(e){return(0,e.observable)("message")})),g=function(e){var t=e.pubsub,n=t.joinChannel("websocket_proxy").publishReplay(1);return n.connect(),{connectedObservable:t.connectedObservable,updateAccessToken:function(e){n.take(1).flatMap((function(t){return t.push("update_access_token",{token:e})})).subscribe()},request:function(e,t){return t||(t={}),"GET"===e.method&&null!==e.payload?(Hm.error("Request with GET method cannot have payload",{params:e}),ju.Observable.throw("Request with GE(function(n){return n.push("request",e,t)})).flatMapar t=e.accessToken;g.updateAccessToken(t)})),b=sm.conf.visitor_api.use_updated_webcomponents?window.customElements&&window.customElements.define?"webcomponents_es5":"webcomponents":"legacy_webcomponents";var y=sm.BusinessRules.Controller.actionTriggers(m,sm.BusinessRules.ACTION_TYPES.SHOW_OPERATORS_IN_SELECTOR_V2).scan((function(e,t){var n=t.operator_team_id,r=t.rule_id,i=t.rule_name,o=t.clear_previous;return o?{team_ids:[n],rule_id:r,rule_name:i,clear_previous:o}:{team_ids:I.union(e.team_ids,[n]),rule_id:r,rule_name:i,clear_previous:o}}),{}).do((function(e){return Yu.info("Business rule setting visible teams",{team_ids:e.team_ids,rule_id:e.rule_id,rule_name:e.rule_name,clear_previous:e.clear_previous})})).pluck("team_ids").publishReplay(1);y.connect();var _=function(e){var t=e.pubsub,n=e.visibleTeamsObservable,r=e.enabledMediaLevel,i=e.webRtcMode,o=t.joinChannel("site_o){var t=e.phoenixChannel;return new Fp(t)})).switchMap((function(e){return ju.Observable.create((function(t){return Kg({presence:e,presenceMapper:Yg({enabledMediaLevel:r,webRtce:n,onChange:function(e){return t.next(e)}})}))})).publishReplay(1);return(o=rl(o)).sampleTime(300)}({pubsub:d,visibleTeamsObservable:y,enabledMediaLevel:sm.conf.communications.enabled_media_level,webRtcMode:Pg()}),w=sm.conf.engagement.default_queues||[],E=py({internalVisitorStateObservable:v,defaultQueues:w});tc(b).subscribe((function(){JS((function(){window!==window.top?cT.setupIFrame({getAccessToken:p,stats:Qu,pubsub:d,visitorPresenceChannel:h,internalVisitorStateObservable:v,volatileNotifications:m,wsProxy:g,bestEffortXDomainStorage:t,operatorPresenceObservable:_,xDomainUrlStorage:r,getVisitorPriority:a,routingObservable:E,tabId:i}):(sm.visitorPageNotifierSubscription={unsubscribe:lp(i)},fp(i),cT.setupApp({getAccessToken:p,stats:Qu,pubsub:d,visitorPresenceChannel:h,internalVisitorStateObservable:v,volatileNotifications:m,wsProxy:g,operatorPresenceObservable:_,bestEffortXDomainStorage:t,xDomainUrlStorage:r,getVisitorPriority:a,routingObservable:E}))}))}))},setupApp:function(e){var t=e.getAccessToken,n=e.stats,r=e.pubsub,i=e.visitorPresenceChannel,o=e.internalVisitorStateObservable,s=e.volatileNotifications,a=e.wsProxy,u=e.operatorPresenceObservable,c=e.xDomainUrlStorage,l=e.getVisitorPriority,f=e.routingObservable;US(),FS();return Promise.all([tT({stats:n}),oT(n),hy({stats:n}),by({stats:n})]).then((function(e){return"[0]"!==JSON.stringify([0])?(r.disconnect(),Promise.reject('Misimplemented array stringification: (JSON.stringify([0]) !== "[0]"')):e})).then((function(e){var t=_(e,2);return function(e){var t=e.visitorApp,r=e.locale;return void 0===t.setStatsClient&&Yu.warn("Setting dependencies failed. visitorApp.setStatsClient was undefined.",{visitorApp:t}),t.setStatsClient(n),t.setLogger(Yu),t.ready({locale:r}),t}({visitorApp:t[0],locale:t[1]})})).then((function(e){c.setItem("tabId",sm.tabId),c.setItem("accessToken",sm.accessToken);var p=function(e){var t=e.getAccessToken,n=e.stats,r=e.visitorPresenceChannel,i=e.internalVisitorStateObservable;dp();var o=Ry({internalVisitorStateObservable:i,getAccessToken:t,stats:n,visitorPresenceChannel:r,salemovePresentInParent:!1}),s=o.channelObservable;return{channelObservable:s,statusObservable:o.statusObservable,cobraObservable:ep({channelObservable:s,logger:Yu}).cobraObservable}}({getAccessToken:t,stats:n,pubsub:r,visitorPresenceChannel:i,internalVisitorStateObservable:o}),d=Zm(o),h=Af({enabled:sm.conf.omniq.omniq_enabled,statsClient:n,pubsub:r});!function(e){var t,n=e.statusObservable,r=e.cobraObservable,i=e.statsClient,o=e.channelObservable,s=e.visitorAppPublicInterface,a=e.pubsub,u=e.visitorMetadata,c=e.internalVisitorStateObservable,l=e.routingObservable,f=e.volatileNotifications,p=e.wsProxy,d=e.currentStatusObservable,h=e.operatorPresenceObservable,v=e.getVisitorPriority,b=e.queuesStateUpdatesObservable,m=Pg(),g=sm.conf.communications.enabled_media_level,y=new IS({statusObservable:n,webRtcMode:m,enabledMediaLevel:g,statsClient:i,cobraObservable:r,channelObservable:o,apiStart:PS,visitorAppPublicInterface:s,pubsub:a,visitorMetadata:u,internalVisitorStateObservable:c,routingObservable:l,volatileNotifications:f,wsProxy:p,currentStatusObservable:d,operatorPresenceObservable:h,getVisitorPriority:v,queuesStateUpdatesObservable:b});sm._getApi=t=function(e){e||(e={});var t=e.version;return t?I.contains(t,RS)?Promise.resolve(y):(Yu.warn("getApi used with unsupported version ".concat(t," at ").concat(window.location.host)),Promise.reject(new Error("".concat(t," is not supported for Glia API. ")+"The supported versions are: ".concat(cw(RS))))):(console.warn("Requesting the Glia API without a version is deprecated. Provide the 'version' parameter to the sm.getApi function. Example: sm.getApi({version: 'v1'})"),Yu.warn("getApi used without version at ".concat(window.location.host)),Promise.resolve(y))},I.forEach((function(e){t(e.options).then(e.resolve.bind(e))}),sm._apiHandlers),new MS({channelObservable:o,statsClient:i}).start(),PS.next(),PS.complete(),setTimeout((function(){sm.urlParams.showVisitorCode&&s&&(s.showVisitorCode?s.showVisitorCode():Yu.info("showVisitorCode is undefined on visitorAppPublicInterface"))}))}({statusObservable:p.statusObservable,cobraObservable:p.cobraObservable,channelObservable:p.channelObservable,statsClient:n,visitorAppPublicInterface:e,pubsub:r,visitorMetadata:sm.conf.visitor_metadata,internalVisitorStateObservable:o,routingObservable:f,volatileNotifications:s,wsProxy:a,currentStatusObservable:d,operatorPresenceObservable:u,getVisitorPriority:l,queuesStateUpdatesObservable:h}),zf({internalVisitorStateObservable:o,cobraObservable:p.cobraObservable,volatileNotifications:s,stats:n,currentStatusObservable:d,operatorPresenceObservable:u,queuesStateUpdatesObservable:h,routingObservable:f}),ac(),function(){var e=Km.get(Ly);if(e("Starting visitor app failed",{error:e})}))},setupIFrame:function(e){var t=e.getAccessToken,n=e.stats,r=e.pubsub,i=e.visitorPresenceChannel,o=e.internalVisitorStateObservable,s=e.volatileNotifications,a=e.wsProxy,u=e.bestEffortXDomainStorage,c=e.operatorPresenceObservable,l=e.xDomainUrlStorage,f=e.getVisitorPriority,p=e.routingObservable,d=e.tabId,h=new cp(d);h.start(),h.request(),sm.visitorPageNotifierSubscription={unsubscribe:lp(d)};var v=new pp(h,sm.conf),b=!1;return v.identityObservable().subscribe((function(e){if(b)Yu.warn("Received iFrame identity after defaulting to unknown",{identity:e});else switch(b=!0,e){case v.IDENTITIES.NESTED_COBROWSABLE_IFRAME:ac(),function(e){var t=e.parentWindowMessenger,n=e.iframeContext,r=e.getAccessToken,i=e.stats;new Nm(t,n.nestedCobrowsableVisitorIframeChannelUrl,r,i).boot()}({getAccessToken:t,parentWindowMessenger:h.getParentWindowMessenger(),iframeContext:h.getCurrentContext(),stats:n});break;case v.IDENTITIES.ENGAGEMENT_IFRAME:h.stop(),uT({stats:n,pubsub:r,getAccessToken:t,visitorPresenceChannel:i,internalVisitorStateObservable:o,volatileNotifications:s,wsProxy:a,operatorPresenceObservable:c,routingObservable:p});break;default:sm.conf.visitor_api.allow_embedding?(Yu.info("Did not receive iFrame identity from parent, bootstrapping as top frame"),fp(d),cT.setupApp({stats:n,pubsub:r,getAccessToken:t,visitorPresenceChannel:i,internalVisitorStateObservable:o,volatileNotifications:s,wsProxy:a,operatorPresenceObservable:c,bestEffortXDomainStorage:u,xDomainUrlStorage:l,getVisitorPriority:f,routingObservable:p})):Yu.warn("Starting base app failed. IFrame has unknown identity.                 Top frame likely does not have Glia scripts installed.",{identity:e})}}))}};sm.EventEmitter=x,sm.dynamicImport=tc,sm.R=I,sm.Rx=ju,sm.App=nc;var lT=Boolean(sm.Bootstrapper);sm.Bootstrapper={boot:function(){lT||sm.installed||(sm.installed=!0,cT.setup())}}}(sm.conf);
//# sourceMappingURL=bootstrapper-683dc24fd.js.map
