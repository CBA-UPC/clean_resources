import{delegate as t,isFunction as i,objDataset as h,debounced as o,debug}from"../base/croco.js";import{LOGGERS as l}from"../base/config.js";const g="accordion";let u=null;const p=l.DEFAULT;export class Accordion{constructor(t,options={}){this.$el=t;this.options=options;this.$active=null;this.$ariaControls=null;this.$ariaTarget=null;this.onResizeDebounced=o(200,this.onResize.bind(this));this.bindEvents();h(this.$el,g,this)}bindEvents(){t(this.$el,".js-accordion-handle","click",this.onHandleClick.bind(this));window.addEventListener("resize",this.onResizeDebounced,false)}onResize(e){let o=this.$el.querySelectorAll(".js-accordion.is-active");if(o){for(let i=0,t=o.length;i<t;i++){let t=o[i];this.setMaxHeight(t,t.classList.contains("is-active"));if(this.options.linked){this.$active=t}}}}onHandleClick(e){e.preventDefault();let t=e.delegateTarget.closest(".js-accordion");this.toggle(t)}ariaToggle(t){clearTimeout(u);let i=t.querySelector(".js-accordion-handle");let o=t.querySelector(".js-accordion-target");if(i!==null&&o!==null){let isActive=t.classList.contains("is-active");i.setAttribute("aria-expanded",!isActive);o.setAttribute("aria-hidden",isActive);if(isActive){u=setTimeout(600)}else{o.removeAttribute("hidden")}}}setMaxHeight(o,isActive,t){let l=o.querySelector(".js-accordion-target");if(l.style.maxHeight){l.style.maxHeight=0}if(isActive){let t=o.querySelector(".js-accordion-child");let i=window.getComputedStyle(t);let height=t.offsetHeight;height+=parseFloat(i["marginTop"])+parseFloat(i["marginBottom"]);l.style.maxHeight=height+"px"}if(i(t)){t()}}toggle(t){if(t){if(this.options.linked&&this.$active!==t){this.close(this.$active);this.$active=null}this.ariaToggle(t);this.setMaxHeight(t,!t.classList.contains("is-active"),()=>{t.classList.toggle("is-active");if(this.options.linked&&t.classList.contains("is-active")){this.$active=t}if(i(this.options.openCallback)){this.options.openCallback(t)}})}}openItem(t){return new Promise(done=>{if(t){if(this.options.linked&&this.$active!==t){this.close(this.$active);this.$active=null}if(!t.classList.contains("is-active")){this.ariaToggle(t)}this.setMaxHeight(t,true,()=>{t.classList.add("is-active");if(this.options.linked){this.$active=t}if(i(this.options.openCallback)){this.options.openCallback(t)}})}setTimeout(600)})}open(t){if(t){this.setMaxHeight(t,true);t.classList.add("is-active")}}close(t){if(t){this.setMaxHeight(t,false);t.classList.remove("is-active")}}closeAll(){let t=this.$el.querySelectorAll(".js-accordion");for(let i=0,o=t.length;i<o;i++){this.close(t[i])}}}export function accordionInit(t=document,o,options){const i=t.querySelectorAll(".js-accordion-wrapper");let l=[];if(i.length){[...i].forEach(t=>{let i=h(t,g);if(!i){i=new Accordion(t,{...options,linked:t.dataset.accordionLinked||false});o&&i.onResize()}else{i.onResize()}l.push(i)})}else{debug("warn",p,"[accordion]","missing element")}return l}