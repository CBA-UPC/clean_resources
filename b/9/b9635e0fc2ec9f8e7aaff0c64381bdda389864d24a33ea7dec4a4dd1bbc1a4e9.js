import{debounced as Y,debug,delegate as o,forceRepaintSVG as k,isFunction as W,resolve,throttled as X,lockScroll as A,onTransitionEndIfExist as Z,onAnimationEndIfExist as ee,objDataset as m}from"../base/croco.js";import{mediaQuery as S,EVENTS as t,LOGGERS as te,MODULE_ALREADY_INITIALIZED as ne,getLocalData as q,isHeaderFoldedDown as se,isPLPStickyFilterEnabled as i}from"../base/config.js";import{Mediator as u}from"../base/mediator.js";import{THEME as l,setThemeState as p,enableTransparentHeader as h,updateTransparentHeader as g}from"./header-transparent.js";import{sendEvent as v}from"../base/event-tracker.js";import{trackingPromotion as le}from"./tracking-promotion.js";import{getGuestReinsurance as oe}from"./guest-reinsurance.js";import{isSearchPopinOpened as ae}from"./search/search-utils.js";let j=false;let L=null;let O=null;let T=null;let D=null;let I=null;let $=null;let H=0;let M=null;let _=null;let P=null;let N=null;let ce=null;let re=null;const ie=te.DEFAULT;const B="is-active";const ue="lock-scroll";const C="header-submenu-collapsed";const de="is-submenu-opened";const F="is-m-scrollable";const R="is-d-scrollable";const G="is-expanded";export function isHeaderMenuOpened(){return document.documentElement.classList.contains(ue)}function K(t,{opacity=0,height=0,zIndex=0}={},l){t.style=`--opacity:${opacity};--height:${height}px;z-index:${zIndex}`;Z(t,()=>{W(l)&&l(t)})}function U(t){return t&&document.querySelector(`.js-submenu-item[data-submenu="${t.dataset.submenuTarget}`)}function me(t,level){return t.closest(`.js-submenu-item[data-submenu-level='${parseInt(level-1)}']`)}function J(level){let t=[...document.querySelectorAll(`.js-menu-item.${B}`)];t=level?t.filter(t=>{return parseInt(t.dataset.submenuLevel,10)>=parseInt(level,10)}):t;return t}function fe(t){const l=t.querySelectorAll(".js-push-tracking-wrapper");[...l].forEach(t=>{const l=t.querySelectorAll(".js-push-tracking");[...l].forEach(t=>{le(t,".js-push-tracking")})})}export const toggleExpiredContents=t=>{const l=[...t.querySelectorAll(".js-check-online")];l.forEach(t=>{const{onlineFrom:l,onlineTo:o}=t?.dataset||{};if(l||o){const i=l&&Date.parse(l);const u=o&&Date.parse(o);const now=Date.now();t.classList.toggle("is-hidden",i&&now<i||u&&now>u)}})};async function pe(l,level,open){let o=U(l);if(!o&&P&&P.dataset.context!=="home"){const i=l.dataset.submenuTarget;const u=await q("menu")||{};const m=resolve("children",u);const category=m&&m[i];if(category){const{render:p}=await import("../vendors/lit-html/lit-html.js");const{tplSubmenuLevel1:h}=await import("../templates/navigation/submenu.tpl.js");const g=document.createElement("li");g.className="js-submenu-item header-submenu-item header-submenu-collapsed flex--row-reverse flex--align-start is-m-scrollable l-mt-fill-height";g.setAttribute("data-submenu",i);g.setAttribute("data-submenu-level",level);g.setAttribute("aria-hidden","true");p(h(u,category,i),g);P.append(g);k(g);o=U(l)}}toggleExpiredContents(o);const t=me(l,level);if(t){t.classList.remove(F)}else{_.classList.toggle(B,parseInt(level)===1&&!open)}if(o){const v=o.scrollHeight;let t=0;const j=J(level);if(j&&j[0]){const L=U(j[0]);if(L){t=L.offsetHeight}}if(S.desktopOnly.matches){A.lock();if(o.parentElement.offsetTop+v>window.innerHeight){o.parentElement.classList.add(R)}else{o.parentElement.classList.remove(R)}}else{A.lockAfterTransition(o)}fe(o);o.style=`--height:${t}px;z-index: 2;`;requestAnimationFrame(()=>{document.documentElement.classList.add(de);l.classList.add(B);o.classList.add(B);o.scrollTo(0,0);o.classList.add(F);o.classList.remove(C);K(o,{opacity:1,height:v,zIndex:2},t=>t.classList.remove(C))})}}export function toggleMenu(i,open){let t;let u=0;let m;let level=0;if(i){t=U(i);u=t?t.offsetHeight:0;m=!i.classList.contains(B);level=i.dataset.submenuLevel;m&&pe(i,level,open);if(m&&i.dataset.theme&&i.dataset.theme==="dark"){p(l.DARK.label)}else{p(l.LIGHT.label)}}J(level).forEach(t=>{const l=U(t);if((!open||!(m&&t===i))&&l){const o=me(t,level);t.classList.remove(B);if(o){o.scrollTo(0,0);o.classList.add(F)}else{_.scrollTo(0,0);_.classList.add(B)}l.classList.remove(B);K(l,{height:m?u:0},t=>{t.classList.add(C);if(!J().length){document.documentElement.classList.remove(de);g();l.parentElement.classList.remove(R);S.desktopOnly.matches&&A.unlock()}t.style=t.dataset.submenuLevel==="2"?"--opacity: 0":"--height: 0"})}})}function he(){for(let t=0,l=T.length;t<l;t++){if(S.desktopOnly.matches){T[t].removeAttribute("hidden")}else{T[t].setAttribute("hidden","hidden")}}for(let t=0,l=O.length;t<l;t++){O[t].setAttribute("style","");O[t].setAttribute("hidden","hidden")}}function ge(e){if(resolve("detail",e)){if(e.detail==="desktopOnly"){D.removeAttribute("role");if(!I.hasAttribute("role")){I.setAttribute("role","navigation")}}else{I.removeAttribute("role");if(!D.hasAttribute("role")){D.setAttribute("role","navigation")}}for(let t=0,l=$.length;t<l;t++){if(S.desktopOnly.matches){$[t].removeAttribute("tabindex")}else{$[t].setAttribute("tabindex","0")}}}}function ye(e){if(S.desktopOnly.matches){u.publish("header-burger.reset")}he();ge(e);let t=e.detail!=="desktopOnly";u.publish("header-burger.toggleBindEvents",t);let l=e.detail==="desktopOnly";u.publish("header-rich-menu.toggleBindEvents",l)}function V(){const l=window.scrollY;if(l!==H&&!re&&!document.querySelector(".js-header-panel."+G)){let t=false;if(l>160){if(l>H){t=true}}if(S.mobileOnly.matches&&!N&&!ce&&!ae()){if(M&&t!==se()){const o=i?t&&document.documentElement.classList.contains("plp-sticky-visible"):t;i&&document.documentElement.classList.toggle("plp-search-folded-down",o);M.classList.toggle("is-folded-down",o)}}else if(S.desktopOnly.matches){document.documentElement.classList.toggle("header-is-folded-down",t);if(t){[...J(1)].forEach(t=>{toggleMenu(t)})}}}H=l}function be(){window.addEventListener(t.BREAKPOINT_CHANGE,ye)}const ve=async()=>{const t=document.querySelector(".js-myaccount-panel");if(t&&!m(t,"myAccountPanel")){const l=await q("navigation.myAccountPanel");if(l){const{render:o}=await import("../vendors/lit-html/lit-html.js");const{tplMyAccountPanel:i}=await import("../templates/navigation/myaccount-panel.tpl.js");o(i(l),t);k(t);const u=document.querySelector(".js-guest-reinsurance");oe(u);m(t,"myAccountPanel",true)}}};export function headerResponsiveInit(){if(j){debug("error",ie,ne);return}M=document.querySelector(".js-search-bar-form");_=document.querySelector(".js-menu-main");P=document.querySelector(".js-header-submenu");N=document.querySelector(".js-storelocator");ce=document.querySelector(".js-offline-section");re=document.querySelector(".js-container");if(S.desktopOnly.matches){const t=document.querySelector(".js-header");if(t){t.addEventListener("mouseenter",()=>{h(false,true)});t.addEventListener("mouseleave",()=>{g()})}[...document.querySelectorAll(".js-header-panel-wrapper")].forEach(l=>{const o=l.querySelector(".js-header-panel");l.addEventListener("mouseenter",function(){if(o){o.classList.add(G);o.classList.toggle("main-menu-expanded",document.documentElement.classList.contains("header-is-folded-down"));if(l.querySelector(".js-myaccount-link")){ve();const t=resolve("pageViewData.page_data.name",window);t&&ee(o,()=>{v("loyalty_panel",{event_data:{area:t,action:"open"}})})}}});l.addEventListener("mouseleave",function(){o&&o.classList.remove(G)})});const l=document.querySelector(".js-myaccount-link");l&&l.addEventListener("click",()=>{window.location=l.dataset.myaccountUrl})}else{[...document.querySelectorAll(".js-submenu-item.header-submenu-level2")].forEach(t=>K(t))}[...document.querySelectorAll(".js-header-panel-btn")].forEach(o=>{o.addEventListener("click",async()=>{const t=o.closest(".js-header-panel-wrapper");const l=t&&t.querySelector(".js-header-panel");if(l&&!l.classList.contains(G)){if(o.classList.contains("js-myaccount-link")){ve()}l.classList.add(G);h(false)}})});[...document.querySelectorAll(".js-close-panel")].forEach(l=>{l.addEventListener("click",()=>{const t=l.closest(`.js-header-panel.${G}`);t&&t.classList.remove(G);h(true)})});o(document.documentElement,".js-menu-item","click",function(e){const t=e.delegateTarget;if(!(S.desktopOnly.matches&&t.href)){e.preventDefault();toggleMenu(t,true)}});o(document.documentElement,".js-menu-close","click",function(e){e.preventDefault();toggleMenu(e.delegateTarget);g()});o(document.documentElement,".js-menu-track","click",async function(e){if(!(e.delegateTarget.classList.contains("js-menu-item")&&!S.desktopOnly.matches)){e.preventDefault();const data=JSON.parse(resolve("dataset.tracking",e.delegateTarget));data&&await v("menu_click",{event_data:data});document.location=e.delegateTarget.href}});L=document.querySelector(".js-nav");if(L){O=L.querySelectorAll(".js-rich-menu");D=document.querySelector(".js-main-nav");I=document.querySelector(".js-header-ada");T=D.querySelectorAll(".js-sub-nav");$=D.querySelectorAll(".js-ada-loop-start, .js-ada-loop-stop");he();if(S.desktopOnly.matches){ge({detail:"desktopOnly"})}be()}else{}window.addEventListener("scroll",Y(200,V));window.addEventListener("scroll",X(200,V));V();j=true}