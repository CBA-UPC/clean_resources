/*! #metadata# bp-nc-sdk: 2.13.0-4ad7fb82 (Wed Nov 22 2023 06:35:43 GMT+0000 (Coordinated Universal Time)) mode: production*/
var e,t;e=self,t=function(){return function(){var e={2307:8718:8036:function(e,t){"use strict";var n;function r(e,t,r){if(!r||typeof r.value!==n.typeOfFunction)throw new TypeError("Only methods can be decorated with @bind. <"+t+"> is not a method!");return{configurable:n.boolTrue,get:}Object.defineProperty(t,"__esModule",{value:!0}),n||(n={})),t.bind=r,t.default=r},3470:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OPEN_BROADCAST_CHANNELS=t.BroadcastChannel=void 0,t.clearNodeFolder=function(e){e=(0,s.fillOptionsWithDefaults)(e);var t=(0,i.chooseMethod)(e);return"node"===t.type?t.clearNodeFolder().then((function(){return!0})):r.PROMISE_RESOLVED_FALSE},t.enforceOptions=var r=n(9403),i=n(8821),s=n(8975),o=new Set;t.OPEN_BROADCAST_CHANNELS=o;var a,c=0,d=function(e,t){var n,d;this.id=c++,o.add(this),this.name=e,a&&(t=a),this.options=(0,s.fillOptionsWithDefaults)(t),this.method=(0,i.chooseMethod)(this.options),this._iL=!1,this._onML=null,this._addEL={message:[],internal:[]},this._uMP=new Set,this._befC=[],this._prepP=null,d=(n=this).method.create(n.name,n.options),(0,r.isPromise)(d)?(n._prepP=d,d.then((function(e){n._state=e}))):n._state=d};oadcastChannel=d,d._pubkey=!0,d.prototype={postMessage:postInternal:set onmessageaddEventListener:removeEventListener:close:function(){var e=this;if(!this.closed){o.delete(this),this.closed=!0;var t=this._prepP?this._prepP:r.PROMISE_RESOLVED_VOID;return this._onML=null,this._addEL.message=[],t.then(().then(().then(()}},get type(){return this.method.type},get isClosed},4023:509:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"BroadcastChannel",{enumerable:!0,get:function(){return r.BroadcastChannel}}),Object.defineProperty(t,"OPEN_BROADCAST_CHANNELS",{enumerable:!0,get:function(){return r.OPEN_BROADCAST_CHANNELS}}),Object.defineProperty(t,"beLeader",{enumerable:!0,get:function(){return i.beLeader}}),Object.defineProperty(t,"clearNodeFolder",{enumerable:!0,get:function(){return r.clearNodeFolder}}),Object.defineProperty(t,"createLeaderElection",{enumerable:!0,get:function(){return i.createLeaderElection}}),Object.defineProperty(t,"enforceOptions",{enumerable:!0,get:function(){return r.enforceOptions}});var r=n(3470),i=n(2781)},2781:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.beLeader=a,t.createLeaderElection=function(e,t){if(e._leaderElector)throw new Error("BroadcastChannel already has a leader-elector");t=t,e);var n=new s(e,t);return e._befC.push((function(){return n.die()})),e._leaderElector=n,n};var r=n(9403),i=n(8238),s=function(e,t){var n=this;this.broadcastChannel=e,this._options=t,this.isLeader=!1,this.hasLeader=!1,this.isDead=!1,this.token=(0,r.randomToken)(),this._aplQ=r.PROMISE_RESOLVED_VOID,this._aplQC=0,this._unl=[],this._lstns=[],this._dpL=function(){},this._dpLC=!1;var i=this.broadcastChannel.addEventListener("internal",i),this._lstns.push(i)};unction a(e){e.isLeader=!0,e.hasLeader=!0;var t=(0,i.add)(();e._unl.push(t);var n=return e.broadcastChannel.addEventListener("internal",n),e._lstns.push(n),o(e,"tell")}s.prototype={applyOnce:function(e){var t=this;return this.isLeader?(0,r.sleep)(0,!0):this.isDead?(0,r.sleep)(0,!1):this._aplQC>1?this._aplQ:(this._aplQC=this._aplQC+1,this._aplQ=this._aplQ.then((function(){return function(){if(t.isLeader)return r.PROMISE_RESOLVED_TRUE;var n,i=!1,s=new Promise((),c=[],d=t.broadcastChannel.addEventListener("internal",d);var l=e?4*t._options.responseTime:t._options.responseTime;return o(t,"apply").then((function(){return Promise.race([(0,r.sleep)(l),s.then((function(){return Promise.reject(new Error)}))])})).then(().then(().catch((function(){})).then(()}()})).then((),this._aplQ.then((function(){return t.isLeader})))},awaitLeadership:function(){return this._aLP||(this._aLP=(e=this).isLeader?r.PROMISE_RESOLVED_VOID:new Promise((function(t){var n=!1;.applyOnce().then((function(){e.isLeader&&i()})),);var s=e.broadcastChannel.addEventListener("internal",s),e._lstns.push(s)}))),this._aLP;var e},set onduplicate(e){this._dpL=e},die:},8821:function(e,t,n){"use strict";var r=n(3203);n(7501),Object.defineProperty(t,"__esModule",{value:!0}),t.chooseMethod=function(e){var t=[].concat(e.methods,d).filter(Boolean);if(e.type){if("simulate"===e.type)return a.default;var n=t.find((function(t){return t.type===e.type}));if(n)return n;throw new Error("method-type "+e.type+" not found")}e.webWorkerSupport||c.isNode||(t=t.filter((function(e){return"idb"!==e.type})));var r=t.find(();if(r)return r;throw new Error("No useable method found in "+JSON.stringify(d.map((function(e){return e.type}))))};var i=r(n(1467)),s=r(n(4903)),o=r(n(1571)),a=r(n(789)),c=n(9403),d=[i.default,s.default,o.default]},4903:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TRANSACTION_SETTINGS=void 0,t.averageResponseTime=T,t.canBeUsed=R,t.cleanOldMessages=y,t.close=S,t.commitIndexedDBTransaction=u,t.create=v,t.createDatabase=h,t.default=void 0,t.getAllMessages=function(e){var t=e.transaction(c,"readonly",d),n=t.objectStore(c),r=[];return new Promise(()},t.getIdb=l,t.getMessagesHigherThan=f,t.getOldMessages=g,t.microSeconds=void 0,t.onMessage=w,t.postMessage=C,t.removeMessagesById=m,t.type=void 0,t.writeMessage=p;var r=n(9403),i=n(7763),s=n(8975),o=r.microSeconds;t.microSeconds=o;var a="pubkey.broadcast-channel-0-",c="messages",d={durability:"relaxed"};nction h(e){var t=l(),n=a+e,r=t.open(n);return r.onupgradeneeded=new Promise(()}function p(e,t,n){var r={uuid:t,time:(new Date).getTime(),data:n},i=e.transaction([c],"readwrite",d);return new Promise(()}unction m(e,t){var n=e.transaction([c],"readwrite",d).objectStore(c);return Promise.all(t.map(())}function g(e,t){var n=(new Date).getTime()-t,r=e.transaction(c,"readonly",d),i=r.objectStore(c),s=[];return new Promise(()}function y(e,t){return g(e,t).then(()}nction _(e){return e.closed?r.PROMISE_RESOLVED_VOID:e.messagesCallback?f(e.db,e.lastCursorId).then((function(t){var n=t.filter(().map(().filter(().sort(();return n.forEach((),r.PROMISE_RESOLVED_VOID})):r.PROMISE_RESOLVED_VOID}unction C(e,t){return e.writeBlockPromise=e.writeBlockPromise.then(().then((),e.writeBlockPromise}unction R(){return!r.isNode&&!!l()}.TRANSACTION_SETTINGS=d,t.type="idb";var k={create:v,close:S,onMessage:w,postMessage:C,canBeUsed:R,type:"idb",averageResponseTime:T,microSeconds:o};t.default=k},1571:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addStorageEventListener=h,t.averageResponseTime=v,t.canBeUsed=y,t.close=m,t.create=f,t.default=void 0,t.getLocalStorage=d,t.microSeconds=void 0,t.onMessage=g,t.postMessage=u,t.removeStorageEventListener=p,t.storageKey=l,t.type=void 0;var r=n(7763),i=n(8975),s=n(9403),o=s.microSeconds;t.microSeconds=o;var a="pubkey.broadcastChannel-",c="localstorage";nction u(e,t){return new Promise(()}c;var b={create:f,close:m,onMessage:g,postMessage:u,canBeUsed:y,type:c,averageResponseTime:v,microSeconds:o};t.default=b},1467:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.averageResponseTime=u,t.canBeUsed=l,t.close=a,t.create=o,t.microSeconds=t.default=void 0,t.onMessage=d,t.postMessage=c,t.type=void 0;var r=n(9403),i=r.microSeconds;t.microSeconds=i;var s="native";ction d(e,t){e.messagesCallback=t}function l(){if(r.isNode&&"undefined"==typeof window)return!1;if("function"==typeof BroadcastChannel){if(BroadcastChannel._pubkey)throw new Error("BroadcastChannel: Do not overwrite window.BroadcastChannel with this module, this is not a polyfill");return!0}return!1}function u(){return 150}t.type=s;var h={create:o,close:a,onMessage:d,postMessage:c,canBeUsed:l,type:s,averageResponseTime:u,microSeconds:i};t.default=h},789:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.averageResponseTime=u,t.canBeUsed=l,t.close=a,t.create=o,t.microSeconds=t.default=void 0,t.onMessage=d,t.postMessage=c,t.type=void 0;var r=n(9403).microSeconds;t.microSeconds=r;var i="simulate";t.type=i;var s=new Set;{create:o,close:a,onMessage:d,postMessage:c,canBeUsed:l,type:i,averageResponseTime:u,microSeconds:r};t.default=h},8975:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fillOptionsWithDefaults=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=JSON.parse(JSON.stringify(e));return void 0===t.webWorkerSupport&&(t.webWorkerSupport=!0),t.idb||(t.idb={}),t.idb.ttl||(t.idb.ttl=45e3),t.idb.fallbackInterval||(t.idb.fallbackInterval=150),e.idb&&"function"==typeof e.idb.onclose&&(t.idb.onclose=e.idb.onclose),t.localstorage||(t.localstorage={}),t.localstorage.removeTimeout||(t.localstorage.removeTimeout=6e4),e.methods&&(t.methods=e.methods),t.node||(t.node={}),t.node.ttl||(t.node.ttl=12e4),t.node.maxParallelWrites||(t.node.maxParallelWrites=2048),void 0===t.node.useFastPath&&(t.node.useFastPath=!0),t}},9403:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isNode=t.PROMISE_RESOLVED_VOID=t.PROMISE_RESOLVED_TRUE=t.PROMISE_RESOLVED_FALSE=void 0,t.isPromise=t.microSeconds=function(){var e=(new Date).getTime();return e===s?1e3*e+ ++o:(s=e,o=0,1e3*e)},t.randomInt=t.randomToken=t.sleep=function(e,t){return e||(e=0),new Promise(()};var n=Promise.resolve(!1);t.PROMISE_RESOLVED_FALSE=n;var r=Promise.resolve(!0);t.PROMISE_RESOLVED_TRUE=r;var i=Promise.resolve();t.PROMISE_RESOLVED_VOID=i;var s=0,o=0,a="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0);t.isNode=a},4398:6292:function(e,t,n){t.formatArgs=t.save=t.load=t.useColors=t.storage=),t.destroy=((),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=n(9374)(t);const{formatters:r}=e.exports;r.j=,9374:3302:8475:6306:function(e,t,n){const r=n(4684);e.exports=e.exports.Socket=r,e.exports.protocol=r.protocol,e.exports.Transport=n(7753),e.exports.transports=n(1492),e.exports.parser=n(8686)},4684:function(e,t,n){const r=n(1492),i=n(4398),s=n(6292)("engine.io-client:socket"),o=n(8686),a=n(5649),c=n(8370);class d extends i{constructor(e,t={}){super(),e&&"object"==typeof e&&(t=e,e=null),e?(e=a(e),t.hostname=e.host,t.secure="https"===e.protocol||"wss"===e.protocol,t.port=e.port,e.query&&(t.query=e.query)):t.host&&(t.hostname=a(t.host).host),this.secure=null!=t.secure?t.secure:"undefined"!=typeof location&&"https:"===location.protocol,t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||("undefined"!=typeof location?location.hostname:"localhost"),this.port=t.port||("undefined"!=typeof location&&location.port?location.port:this.secure?443:80),this.transports=t.transports||["polling","websocket"],this.readyState="",this.writeBuffer=[],this.prevBufferLen=0,this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,jsonp:!0,timestampParam:"t",rememberUpgrade:!1,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{}},t),this.opts.path=this.opts.path.replace(/\/$/,"")+"/","string"==typeof this.opts.query&&(this.opts.query=c.decode(this.opts.query)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingTimeoutTimer=null,"function"==typeof addEventListener&&addEventListener("beforeunload",(,!1),this.open()}pen(){let e;if(this.opts.rememberUpgrade&&d.priorWebsocketSuccess&&-1!==this.transports.indexOf("websocket"))e="websocket";else{if(0===this.transports.length){const e=this;return void setTimeout((,0)}e=this.transports[0]}this.readyState="opening";try{e=this.createTransport(e)}catch(e){return s("error while creating transport: %s",e),this.transports.shift(),void this.open()}e.open(),this.setTransport(e)}setTransportrobe(e){s('probing transport "%s"',e);let t=this.createTransport(e,{probe:1}),n=!1;const r=this;ction c(){a("transport closed")}riorWebsocketSuccess=!1,t.once("open",i),t.once("error",a),t.once("close",c),this.once("close",l),this.once("upgrading",u),t.open()}nPacket(e){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(s('socket receive: type "%s", data "%s"',e.type,e.data),this.emit("packet",e),this.emit("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this.resetPingTimeout(),this.sendPacket("pong"),this.emit("pong");break;case"error":const t=new Error("server error");t.code=e.data,this.onError(t);break;case"message":this.emit("data",e.data),this.emit("message",e.data)}else s('packet received with socket readyState "%s"',this.readyState)}esetPingTimeout(){clearTimeout(this.pingTimeoutTimer),this.pingTimeoutTimer=setTimeout((,this.pingInterval+this.pingTimeout)}ite(e,t,n){return this.sendPacket("message",e,t,n),this}ose(){const e=this;urn"opening"!==this.readyState&&"open"!==this.readyState||(this.readyState="closing",this.writeBuffer.length?this.once("drain",():this.upgrading?r():t()),this}nClose.priorWebsocketSuccess=!1,d.protocol=o.protocol,e.exports=d},7753:function(e,t,n){const r=n(8686),i=n(4398),s=n(6292)("engine.io-client:transport");e.exports=class extends i{constructor(e){super(),this.opts=e,this.query=e.query,this.readyState="",this.socket=e.socket}function(e,t,n){const r=n(5016),i=n(344),s=n(9642),o=n(3133);t.polling=function(e){let t,n=!1,o=!1;const a=!1!==e.jsonp;if("undefined"!=typeof location){const t="https:"===location.protocol;let r=location.port;r||(r=t?443:80),n=e.hostname!==location.hostname||r!==e.port,o=e.secure!==t}if(e.xdomain=n,e.xscheme=o,t=new r(e),"open"in t&&!e.forceJSONP)return new i(e);if(!a)throw new Error("JSONP disabled");return new s(e)},t.websocket=o},9642:function(e,t,n){const r=n(260),i=n(8475),s=/\n/g,o=/\\n/g;let a;e.exports=class extends r{constructor(e){super(e),this.query=this.query||{},a||(a=i.___eio=i.___eio||[]),this.index=a.length;const t=this;a.push((function(e){t.onData(e)})),this.query.j=this.index}PolloWrite(e,t){const n=this;let r;if(!this.form){const e=document.createElement("form"),t=document.createElement("textarea"),n=this.iframeId="eio_iframe_"+this.index;e.className="socketio",e.style.position="absolute",e.style.top="-1000px",e.style.left="-1000px",e.target=n,e.method="POST",e.setAttribute("accept-charset","utf-8"),t.name="d",e.appendChild(t),document.body.appendChild(e),this.form=e,this.area=t}is.form.action=this.uri(),a(),e=e.replace(o,"\\\n"),this.area.value=e.replace(s,"\\n");try{this.form.submit()}catch(e){}this.iframe.attachEvent?this.iframe.onreadystatechange=this.iframe.onload=i}}},344:function(e,t,n){const r=n(5016),i=n(260),s=n(4398),{pick:o}=n(7492),a=n(8475),c=n(6292)("engine.io-client:polling-xhr");function d(){}const l=null!=new r({xdomain:!1}).responseType;class u extends s{constructor(e,t){super(),this.opts=t,this.method=t.method||"GET",this.uri=e,this.async=!1!==t.async,this.data=void 0!==t.data?t.data:null,this.create()}create(){const e=o(this.opts,"agent","enablesXDR","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized");e.xdomain=!!this.opts.xd,e.xscheme=!!this.opts.xs;const t=this.xhr=new r(e),n=this;try{c("xhr open %s: %s",this.method,this.uri),t.open(this.method,this.uri,this.async);try{if(this.opts.extraHeaders){t.setDisableHeaderCheck&&t.setDisableHeaderCheck(!0);for(let e in this.opts.extraHeaders)this.opts.extraHeaders.hasOwnProperty(e)&&t.setRequestHeader(e,this.opts.extraHeaders[e])}}catch(e){}if("POST"===this.method)try{t.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(e){}try{t.setRequestHeader("Accept","*/*")}catch(e){}"withCredentials"in t&&(t.withCredentials=this.opts.withCredentials),this.opts.requestTimeout&&(t.timeout=this.opts.requestTimeout),this.hasXDR()?(t.onload=function(){n.onLoad()},t.onerror=:t.onreadystatechange=c("xhr data %s",this.data),t.send(this.data)}catch(e){return void setTimeout((,0)}"undefined"!=typeof document&&(this.index=u.requestsCount++,u.requests[this.index]=this)}){this.cleanup()}}.requestsCount=0,u.requests={},"undefined"!=typeof document&&("function"==typeof attachEvent?attachEvent("onunload",h):"function"==typeof addEventListener&&addEventListener("onpagehide"in a?"pagehide":"unload",h,!1)),e.exports=class extends i{WriteoPoll,e.exports.Request=u},260:function(e,t,n){const r=n(7753),i=n(8370),s=n(8686),o=n(327),a=n(6292)("engine.io-client:polling");e.exports=class extends r{get name(){return"polling"}auseData(e){const t=this;a("polling got data %s",e),s.decodePayload(e,this.socket.binaryType).forEach((),"closed"!==this.readyState&&(this.polling=!1,this.emit("pollComplete"),"open"===this.readyState?this.poll():a('ignoring poll - transport state "%s"',this.readyState))}doClosei(){let e=this.query||{};const t=this.opts.secure?"https":"http";let n="";return!1!==this.opts.timestampRequests&&(e[this.opts.timestampParam]=o()),this.supportsBinary||e.sid||(e.b64=1),e=i.encode(e),this.opts.port&&("https"===t&&443!==Number(this.opts.port)||"http"===t&&80!==Number(this.opts.port))&&(n=":"+this.opts.port),e.length&&(e="?"+e),t+"://"+(-1!==this.opts.hostname.indexOf(":")?"["+this.opts.hostname+"]":this.opts.hostname)+n+this.opts.path+e}}},4286:3133:function(e,t,n){const r=n(7753),i=n(8686),s=n(8370),o=n(327),{pick:a}=n(7492),{WebSocket:c,usingBrowserWebSocket:d,defaultBinaryType:l}=n(4286),u=n(6292)("engine.io-client:websocket"),h="undefined"!=typeof navigator&&"string"==typeof navigator.product&&"reactnative"===navigator.product.toLowerCase();class p extends r{EventListenersrite(e){const t=this;this.writable=!1;let n=e.length,r=0;const s=n;for(;r<s;r++)!function(e){i.encodePacket(e,t.supportsBinary,(function(r){const i={};!d&&(e.options&&(i.compress=e.options.compress),t.opts.perMessageDeflate)&&("string"==typeof r?Buffer.byteLength(r):r.length)<t.opts.perMessageDeflate.threshold&&(i.compress=!1);try{d?t.ws.send(r):t.ws.send(r,i)}catch(e){u("websocket closed before onclose event")}--n||(t.emit("flush"),setTimeout((,0))}))}(e[r])}i(){let e=this.query||{};const t=this.opts.secure?"wss":"ws";let n="";return this.opts.port&&("wss"===t&&443!==Number(this.opts.port)||"ws"===t&&80!==Number(this.opts.port))&&(n=":"+this.opts.port),this.opts.timestampRequests&&(e[this.opts.timestampParam]=o()),this.supportsBinary||(e.b64=1),e=s.encode(e),e.length&&(e="?"+e),t+"://"+(-1!==this.opts.hostname.indexOf(":")?"["+this.opts.hostname+"]":this.opts.hostname)+n+this.opts.path+e}e.exports=p},7492:function(e){e.exports.pick=,5016:3167:function(e){const t=Object.create(null);t.open="0",t.close="1",t.ping="2",t.pong="3",t.message="4",t.upgrade="5",t.noop="6";const n=Object.create(null);Object.keys(t).forEach((),e.exports={PACKET_TYPES:t,PACKET_TYPES_REVERSE:n,ERROR_PACKET:{type:"error",data:"parser error"}}},6948:function(e,t,n){const{PACKET_TYPES_REVERSE:r,ERROR_PACKET:i}=n(3167);let s;"function"==typeof ArrayBuffer&&(s=n(8718));const o=a=e.exports=,3867:function(e,t,n){const{PACKET_TYPES:r}=n(3167),i="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===Object.prototype.toString.call(Blob),s="function"==typeof ArrayBuffer,o=e.exports=,8686:function(e,t,n){const r=n(3867),i=n(6948),s=String.fromCharCode(30);e.exports={protocol:4,encodePacket:r,encodePayload:decodePacket:i,decodePayload:},6048:8628:function(e){var t=1e3,n=60*t,r=60*n,i=24*r,s=7*i,o=365.25*i;.exports=function(e,c){c=c||{};var d,l,u=typeof e;if("string"===u&&e.length>0)return function(e){if(!((e=String(e)).length>100)){var a=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(a){var c=parseFloat(a[1]);switch((a[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return c*o;case"weeks":case"week":case"w":return c*s;case"days":case"day":case"d":return c*i;case"hours":case"hour":case"hrs":case"hr":case"h":return c*r;case"minutes":case"minute":case"mins":case"min":case"m":return c*n;case"seconds":case"second":case"secs":case"sec":case"s":return c*t;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return c;default:return}}}}(e);if("number"===u&&isFinite(e))return c.long?(d=e,(l=Math.abs(d))>=i?a(d,l,i,"day"):l>=r?a(d,l,r,"hour"):l>=n?a(d,l,n,"minute"):l>=t?a(d,l,t,"second"):d+" ms"):e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},5418:function(e){"use strict";function t(e){if(this._offset=0,e instanceof ArrayBuffer)this._buffer=e,this._view=new DataView(this._buffer);else{if(!ArrayBuffer.isView(e))throw new Error("Invalid argument");this._buffer=e.buffer,this._view=new DataView(this._buffer,e.byteOffset,e.byteLength)}}t.prototype._array=t.prototype._map=function(e){for(var t={},n=0;n<e;n++)t[this._parse()]=this._parse();return t},t.prototype._str=function(e){var t=function(e,t,n){for(var r="",i=0,s=t,o=t+n;s<o;s++){var a=e.getUint8(s);if(0!=(128&a))if(192!=(224&a))if(224!=(240&a)){if(240!=(248&a))throw new Error("Invalid byte "+a.toString(16));(i=(7&a)<<18|(63&e.getUint8(++s))<<12|(63&e.getUint8(++s))<<6|(63&e.getUint8(++s))<<0)>=65536?(i-=65536,r+=String.fromCharCode(55296+(i>>>10),56320+(1023&i))):r+=String.fromCharCode(i)}else r+=String.fromCharCode((15&a)<<12|(63&e.getUint8(++s))<<6|(63&e.getUint8(++s))<<0);else r+=String.fromCharCode((31&a)<<6|63&e.getUint8(++s));else r+=String.fromCharCode(a)}return r}(this._view,this._offset,e);return this._offset+=e,t},t.prototype._bin=t.prototype._parse=function(){var e,t=this._view.getUint8(this._offset++),n=0,r=0,i=0,s=0;if(t<192)return t<128?t:t<144?this._map(15&t):t<160?this._array(15&t):this._str(31&t);if(t>223)return-1*(255-t+1);switch(t){case 192:return null;case 194:return!1;case 195:return!0;case 196:return n=this._view.getUint8(this._offset),this._offset+=1,this._bin(n);case 197:return n=this._view.getUint16(this._offset),this._offset+=2,this._bin(n);case 198:return n=this._view.getUint32(this._offset),this._offset+=4,this._bin(n);case 199:return n=this._view.getUint8(this._offset),r=this._view.getInt8(this._offset+1),this._offset+=2,[r,this._bin(n)];case 200:return n=this._view.getUint16(this._offset),r=this._view.getInt8(this._offset+2),this._offset+=3,[r,this._bin(n)];case 201:return n=this._view.getUint32(this._offset),r=this._view.getInt8(this._offset+4),this._offset+=5,[r,this._bin(n)];case 202:return e=this._view.getFloat32(this._offset),this._offset+=4,e;case 203:return e=this._view.getFloat64(this._offset),this._offset+=8,e;case 204:return e=this._view.getUint8(this._offset),this._offset+=1,e;case 205:return e=this._view.getUint16(this._offset),this._offset+=2,e;case 206:return e=this._view.getUint32(this._offset),this._offset+=4,e;case 207:return i=this._view.getUint32(this._offset)*Math.pow(2,32),s=this._view.getUint32(this._offset+4),this._offset+=8,i+s;case 208:return e=this._view.getInt8(this._offset),this._offset+=1,e;case 209:return e=this._view.getInt16(this._offset),this._offset+=2,e;case 210:return e=this._view.getInt32(this._offset),this._offset+=4,e;case 211:return i=this._view.getInt32(this._offset)*Math.pow(2,32),s=this._view.getUint32(this._offset+4),this._offset+=8,i+s;case 212:return r=this._view.getInt8(this._offset),this._offset+=1,0===r?void(this._offset+=1):[r,this._bin(1)];case 213:return r=this._view.getInt8(this._offset),this._offset+=1,[r,this._bin(2)];case 214:return r=this._view.getInt8(this._offset),this._offset+=1,[r,this._bin(4)];case 215:return r=this._view.getInt8(this._offset),this._offset+=1,0===r?(i=this._view.getInt32(this._offset)*Math.pow(2,32),s=this._view.getUint32(this._offset+4),this._offset+=8,new Date(i+s)):[r,this._bin(8)];case 216:return r=this._view.getInt8(this._offset),this._offset+=1,[r,this._bin(16)];case 217:return n=this._view.getUint8(this._offset),this._offset+=1,this._str(n);case 218:return n=this._view.getUint16(this._offset),this._offset+=2,this._str(n);case 219:return n=this._view.getUint32(this._offset),this._offset+=4,this._str(n);case 220:return n=this._view.getUint16(this._offset),this._offset+=2,this._array(n);case 221:return n=this._view.getUint32(this._offset),this._offset+=4,this._array(n);case 222:return n=this._view.getUint16(this._offset),this._offset+=2,this._map(n);case 223:return n=this._view.getUint32(this._offset),this._offset+=4,this._map(n)}throw new Error("Could not parse")},e.exports=function(e){var n=new t(e),r=n._parse();if(n._offset!==e.byteLength)throw new Error(e.byteLength-n._offset+" trailing bytes");return r}},5559:function(e){"use strict";function t(e,t,n){for(var r=0,i=0,s=n.length;i<s;i++)(r=n.charCodeAt(i))<128?e.setUint8(t++,r):r<2048?(e.setUint8(t++,192|r>>6),e.setUint8(t++,128|63&r)):r<55296||r>=57344?(e.setUint8(t++,224|r>>12),e.setUint8(t++,128|r>>6&63),e.setUint8(t++,128|63&r)):(i++,r=65536+((1023&r)<<10|1023&n.charCodeAt(i)),e.setUint8(t++,240|r>>18),e.setUint8(t++,128|r>>12&63),e.setUint8(t++,128|r>>6&63),e.setUint8(t++,128|63&r))}function n(e,t,r){var i=typeof r,s=0,o=0,a=0,c=0,d=0,l=0;if("string"===i){if(d=r),d<32)e.push(160|d),l=1;else if(d<256)e.push(217,d),l=2;else if(d<65536)e.push(218,d>>8,d),l=3;else{if(!(d<4294967296))throw new Error("String too long");e.push(219,d>>24,d>>16,d>>8,d),l=5}return t.push({_str:r,_length:d,_offset:e.length}),l+d}if("number"===i)return Math.floor(r)===r&&isFinite(r)?r>=0?r<128?(e.push(r),1):r<256?(e.push(204,r),2):r<65536?(e.push(205,r>>8,r),3):r<4294967296?(e.push(206,r>>24,r>>16,r>>8,r),5):(a=r/Math.pow(2,32)>>0,c=r>>>0,e.push(207,a>>24,a>>16,a>>8,a,c>>24,c>>16,c>>8,c),9):r>=-32?(e.push(r),1):r>=-128?(e.push(208,r),2):r>=-32768?(e.push(209,r>>8,r),3):r>=-2147483648?(e.push(210,r>>24,r>>16,r>>8,r),5):(a=Math.floor(r/Math.pow(2,32)),c=r>>>0,e.push(211,a>>24,a>>16,a>>8,a,c>>24,c>>16,c>>8,c),9):(e.push(203),t.push({_float:r,_length:8,_offset:e.length}),9);if("object"===i){if(null===r)return e.push(192),1;if(Array.isArray(r)){if((d=r.length)<16)e.push(144|d),l=1;else if(d<65536)e.push(220,d>>8,d),l=3;else{if(!(d<4294967296))throw new Error("Array too large");e.push(221,d>>24,d>>16,d>>8,d),l=5}for(s=0;s<d;s++)l+=n(e,t,r[s]);return l}if(r instanceof Date){var u=r.getTime();return a=Math.floor(u/Math.pow(2,32)),c=u>>>0,e.push(215,0,a>>24,a>>16,a>>8,a,c>>24,c>>16,c>>8,c),10}if(r instanceof ArrayBuffer){if((d=r.byteLength)<256)e.push(196,d),l=2;else if(d<65536)e.push(197,d>>8,d),l=3;else{if(!(d<4294967296))throw new Error("Buffer too large");e.push(198,d>>24,d>>16,d>>8,d),l=5}return t.push({_bin:r,_length:d,_offset:e.length}),l+d}if("function"==typeof r.toJSON)return n(e,t,r.toJSON());var h=[],p="",f=Object.keys(r);for(s=0,o=f.length;s<o;s++)"function"!=typeof r[p=f[s]]&&h.push(p);if((d=h.length)<16)e.push(128|d),l=1;else if(d<65536)e.push(222,d>>8,d),l=3;else{if(!(d<4294967296))throw new Error("Object too large");e.push(223,d>>24,d>>16,d>>8,d),l=5}for(s=0;s<d;s++)l+=n(e,t,p=h[s]),l+=n(e,t,r[p]);return l}if("boolean"===i)return e.push(r?195:194),1;if("undefined"===i)return e.push(212,0,0),3;throw new Error("Could not encode")}e.exports=function(e){var r=[],i=[],s=n(r,i,e),o=new ArrayBuffer(s),a=new DataView(o),c=0,d=0,l=-1;i.length>0&&(l=i[0]._offset);for(var u,h=0,p=0,f=0,m=r.length;f<m;f++)if(a.setUint8(d+f,r[f]),f+1===l){if(h=(u=i[c])._length,p=d+l,u._bin)for(var g=new Uint8Array(u._bin),y=0;y<h;y++)a.setUint8(p+y,g[y]);else u._str?t(a,p,u._str):void 0!==u._float&&a.setFloat64(p,u._float);d+=h,i[++c]&&(l=i[c]._offset)}return o}},711:7763:function(e,t,n){"use strict";n.r(t),n.d(t,{ObliviousSet:function(){return r},now:function(){return s},removeTooOldValues:function(){return i}});var r=);8370:5649:function(e){var t=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,n=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];e.exports=function(e){var r,i,s,o=e,a=e.indexOf("["),c=e.indexOf("]");-1!=a&&-1!=c&&(e=e.substring(0,a)+e.substring(a,c).replace(/:/g,";")+e.substring(c,e.length));for(var d,l,u=t.exec(e||""),h={},p=14;p--;)h[n[p]]=u[p]||"";return-1!=a&&-1!=c&&(h.source=o,h.host=h.host.substring(1,h.host.length-1).replace(/;/g,":"),h.authority=h.authority.replace("[","").replace("]","").replace(/;/g,":"),h.ipv6uri=!0),h.pathNames=(r=h.path,i=/\/{2,9}/g,s=r.replace(i,"/").split("/"),"/"!=r.substr(0,1)&&0!==r.length||s.splice(0,1),"/"==r.substr(r.length-1,1)&&s.splice(s.length-1,1),s),h.queryKey=(d=h.query,l={},d.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,(),l),h}},531:function(e,t,n){"use strict";n.r(t);var r=i=setTimeout;unction o(){}type.catch=a.prototype.then=a.prototype.finally=r,a.all=a.resolve=a.reject=a.race=a._immediateFn="function"==typeof setImmediate&&function(e){setImmediate(e)}||a._unhandledRejectionFn=var f=a,m=);"Promise"in m?m.Promise.prototype.finally||(m.Promise.prototype.finally=r):m.Promise=f},2226:function(e,t,n){"use strict";var r=n(347);orts=function(e,t){r l=Object.defineProperty(l.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(l.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),l.prototype.onicecandidate=null,l.prototype.onaddstream=null,l.prototype.ontrack=null,l.prototype.onremovestream=null,l.prototype.onsignalingstatechange=null,l.prototype.oniceconnectionstatechange=null,l.prototype.onconnectionstatechange=null,l.prototype.onicegatheringstatechange=null,l.prototype.onnegotiationneeded=null,l.prototype.ondatachannel=null,l.prototype._dispatchEvent=l.prototype._emitGatheringStateChange=l.prototype.getConfiguration=function(){return this._config},l.prototype.getLocalStreams=function(){return this.localStreams},l.prototype.getRemoteStreams=function(){return this.remoteStreams},l.prototype._createTransceiver=l.prototype.addTrack=l.prototype.addStream=l.prototype.removeTrack=l.prototype.removeStream=l.prototype.getSenders=function(){return this.transceivers.filter((function(e){return!!e.rtpSender})).map((function(e){return e.rtpSender}))},l.prototype.getReceivers=l.prototype._createIceGatherer=l.prototype._gather=l.prototype._createIceAndDtlsTransports=l.prototype._disposeIceAndDtlsTransports=l.prototype._transceive=l.prototype.setLocalDescription=l.prototype.setRemoteDescription=function(i){var l=this;if(-1===["offer","answer"].indexOf(i.type))return Promise.reject(c("TypeError",'Unsupported type "'+i.type+'"'));if(!o("setRemoteDescription",i.type,l.signalingState)||l._isClosed)return Promise.reject(c("InvalidStateError","Can not set remote "+i.type+" in state "+l.signalingState));var u={};l.remoteStreams.forEach(();var h=[],p=r.splitSections(i.sdp),f=p.shift(),m=r.matchPrefix(f,"a=ice-lite").length>0,g=r.matchPrefix(f,"a=group:BUNDLE ").length>0;l.usingBundle=g;var y=r.matchPrefix(f,"a=ice-options:")[0];return l.canTrickleIceCandidates=!!y&&y.substr(14).split(" ").indexOf("trickle")>=0,p.forEach((function(o,c){var d=r.splitLines(o),p=r.getKind(o),y=r.isRejected(o)&&0===r.matchPrefix(o,"a=bundle-only").length,v=d[0].substr(2).split(" ")[2],b=r.getDirection(o,f),_=r.parseMsid(o),S=r.getMid(o)||r.generateIdentifier();if(y||"application"===p&&("DTLS/SCTP"===v||"UDP/DTLS/SCTP"===v))l.transceivers[c]={mid:S,kind:p,protocol:v,rejected:!0};else{var C,w,R,T,k,P,D,E,O;!y&&l.transceivers[c]&&l.transceivers[c].rejected&&(l.transceivers[c]=l._createTransceiver(p,!0));var I,x,B=r.parseRtpParameters(o);y||(I=r.getIceParameters(o,f),(x=r.getDtlsParameters(o,f)).role="client"),D=r.parseRtpEncodingParameters(o);var A=r.parseRtcpParameters(o),N=r.matchPrefix(o,"a=end-of-candidates",f).length>0,M=r.matchPrefix(o,"a=candidate:").map((function(e){return r.parseCandidate(e)})).filter(();if(("offer"===i.type||"answer"===i.type)&&!y&&g&&c>0&&l.transceivers[c]&&(l._disposeIceAndDtlsTransports(c),l.transceivers[c].iceGatherer=l.transceivers[0].iceGatherer,l.transceivers[c].iceTransport=l.transceivers[0].iceTransport,l.transceivers[c].dtlsTransport=l.transceivers[0].dtlsTransport,l.transceivers[c].rtpSender&&l.transceivers[c].rtpSender.setTransport(l.transceivers[0].dtlsTransport),l.transceivers[c].rtpReceiver&&l.transceivers[c].rtpReceiver.setTransport(l.transceivers[0].dtlsTransport)),"offer"!==i.type||y)"answer"!==i.type||y||(w=(C=l.transceivers[c]).iceGatherer,R=C.iceTransport,T=C.dtlsTransport,k=C.rtpReceiver,P=C.sendEncodingParameters,E=C.localCapabilities,l.transceivers[c].recvEncodingParameters=D,l.transceivers[c].remoteCapabilities=B,l.transceivers[c].rtcpParameters=A,M.length&&"new"===R.state&&(!m&&!N||g&&0!==c?M.forEach((function(e){a(C.iceTransport,e)})):R.setRemoteCandidates(M)),g&&0!==c||("new"===R.state&&R.start(w,I,"controlling"),"new"===T.state&&T.start(x)),!s(C.localCapabilities,C.remoteCapabilities).codecs.filter(().length&&C.sendEncodingParameters[0].rtx&&delete C.sendEncodingParameters[0].rtx,l._transceive(C,"sendrecv"===b||"recvonly"===b,"sendrecv"===b||"sendonly"===b),!k||"sendrecv"!==b&&"sendonly"!==b?delete C.rtpReceiver:(O=k.track,_?(u[_.stream]||(u[_.stream]=new e.MediaStream),n(O,u[_.stream]),h.push([O,k,u[_.stream]])):(u.default||(u.default=new e.MediaStream),n(O,u.default),h.push([O,k,u.default]))));else{(C=l.transceivers[c]||l._createTransceiver(p)).mid=S,C.iceGatherer||(C.iceGatherer=l._createIceGatherer(c,g)),M.length&&"new"===C.iceTransport.state&&(!N||g&&0!==c?M.forEach(():C.iceTransport.setRemoteCandidates(M)),E=e.RTCRtpReceiver.getCapabilities(p),t<15019&&(E.codecs=E.codecs.filter(()),P=C.sendEncodingParameters||[{ssrc:1001*(2*c+2)}];var L,j=!1;"sendrecv"===b||"sendonly"===b?(j=!C.rtpReceiver,k=C.rtpReceiver||new e.RTCRtpReceiver(C.dtlsTransport,p),j&&(O=k.track,_&&"-"===_.stream||(_?(u[_.stream]||(u[_.stream]=new e.MediaStream,Object.defineProperty(u[_.stream],"id",{get:function(){return _.stream}})),Object.defineProperty(O,"id",{get:function(){return _.track}}),L=u[_.stream]):(u.default||(u.default=new e.MediaStream),L=u.default)),L&&(n(O,L),C.associatedRemoteMediaStreams.push(L)),h.push([O,k,L]))):C.rtpReceiver&&C.rtpReceiver.track&&(C.associatedRemoteMediaStreams.forEach((),C.associatedRemoteMediaStreams=[]),C.localCapabilities=E,C.remoteCapabilities=B,C.rtpReceiver=k,C.rtcpParameters=A,C.sendEncodingParameters=P,C.recvEncodingParameters=D,l._transceive(l.transceivers[c],!1,j)}}})),void 0===l._dtlsRole&&(l._dtlsRole="offer"===i.type?"active":"passive"),l._remoteDescription={type:i.type,sdp:i.sdp},"offer"===i.type?l._updateSignalingState("have-remote-offer"):l._updateSignalingState("stable"),Object.keys(u).forEach((),h.forEach((),e.setTimeout((,4e3),Promise.resolve()},l.prototype.close=l.prototype._updateSignalingState=l.prototype._maybeFireNegotiationNeeded=l.prototype._updateIceConnectionState=l.prototype._updateConnectionState=l.prototype.createOffer=l.prototype.createAnswer=l.prototype.addIceCandidate=l.prototype.getStats=["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach(();var u=["createOffer","createAnswer"];return u.forEach((),(u=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach((),["getStats"].forEach((),l}},347:function(e){"use strict";var t={generateIdentifier:;t.localCName=t.generateIdentifier(),t.splitLines=t.splitSections=t.getDescription=t.getMediaSections=t.matchPrefix=t.parseCandidate=t.writeCandidate=t.parseIceOptions=t.parseRtpMap=t.writeRtpMap=t.parseExtmap=t.writeExtmap=t.parseFmtp=t.writeFmtp=t.parseRtcpFb=t.writeRtcpFb=t.parseSsrcMedia=t.parseSsrcGroup=t.getMid=t.parseFingerprint=t.getDtlsParameters=t.writeDtlsParameters=t.parseCryptoLine=t.writeCryptoLine=t.parseCryptoKeyParams=t.writeCryptoKeyParams=t.getCryptoParameters=t.getIceParameters=t.writeIceParameters=t.parseRtpParameters=t.writeRtpDescription=t.parseRtpEncodingParameters=t.parseRtcpParameters=t.parseMsid=t.parseSctpDescription=t.writeSctpDescription=t.generateSessionId=t.writeSessionBoilerplate=t.writeMediaSection=t.getDirection=t.getKind=t.isRejected=t.parseMLine=t.parseOLine=t.isValidSDP=e.exports=t},8663:function(e,t,n){var r=n(711),i=n(4398);t.protocol=5;var s=t.PacketType={CONNECT:0,DISCONNECT:1,EVENT:2,ACK:3,CONNECT_ERROR:4},o=Number.isInteger||a=c=function(e){return"[object Object]"===Object.prototype.toString.call(e)};function d(){}function l(){}d.prototype.encode=i(l.prototype),l.prototype.add=function(e){var t=r.decode(e);this.checkPacket(t),this.emit("decoded",t)},l.prototype.checkPacket=function(e){if(!(o(e.type)&&e.type>=s.CONNECT&&e.type<=s.CONNECT_ERROR))throw new Error("invalid packet type");if(!a(e.nsp))throw new Error("invalid namespace");if(!function(e){switch(e.type){case s.CONNECT:return void 0===e.data||c(e.data);case s.DISCONNECT:return void 0===e.data;case s.CONNECT_ERROR:return a(e.data)||c(e.data);default:return Array.isArray(e.data)}}(e))throw new Error("invalid payload");if(void 0!==e.id&&!o(e.id))throw new Error("invalid packet id")},l.prototype.destroy=function(){},t.Encoder=d,t.Decoder=l},2475:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.reconstructPacket=t.deconstructPacket=void 0;const r=n(7306);function i(e,t){if(!e)return e;if(r.isBinary(e)){const n={_placeholder:!0,num:t.length};return t.push(e),n}if(Array.isArray(e)){const n=new Array(e.length);for(let r=0;r<e.length;r++)n[r]=i(e[r],t);return n}if("object"==typeof e&&!(e instanceof Date)){const n={};for(const r in e)e.hasOwnProperty(r)&&(n[r]=i(e[r],t));return n}return e}function s(e,t){if(!e)return e;if(e&&!0===e._placeholder){if("number"==typeof e.num&&e.num>=0&&e.num<t.length)return t[e.num];throw new Error("illegal attachments")}if(Array.isArray(e))for(let n=0;n<e.length;n++)e[n]=s(e[n],t);else if("object"==typeof e)for(const n in e)e.hasOwnProperty(n)&&(e[n]=s(e[n],t));return e}t.deconstructPacket=t.reconstructPacket=,8552:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Decoder=t.Encoder=t.PacketType=t.protocol=void 0;const r=n(4398),i=n(2475),s=n(7306),o=n(6292)("socket.io-parser");var a;t.protocol=5,a=t.PacketType||(t.PacketType={})),t.Encoder=class{lass c extends r{dd(e){let t;if("string"==typeof e){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");t=this.decodeString(e),t.type===a.BINARY_EVENT||t.type===a.BINARY_ACK?(this.reconstructor=new d(t),0===t.attachments&&super.emit("decoded",t)):super.emit("decoded",t)}else{if(!s.isBinary(e)&&!e.base64)throw new Error("Unknown type: "+e);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emit("decoded",t))}}decodeString(e){let t=0;const n={type:Number(e.charAt(0))};if(void 0===a[n.type])throw new Error("unknown packet type "+n.type);if(n.type===a.BINARY_EVENT||n.type===a.BINARY_ACK){const r=t+1;for(;"-"!==e.charAt(++t)&&t!=e.length;);const i=e.substring(r,t);if(i!=Number(i)||"-"!==e.charAt(t))throw new Error("Illegal attachments");n.attachments=Number(i)}if("/"===e.charAt(t+1)){const r=t+1;for(;++t&&","!==e.charAt(t)&&t!==e.length;);n.nsp=e.substring(r,t)}else n.nsp="/";const r=e.charAt(t+1);if(""!==r&&Number(r)==r){const r=t+1;for(;++t;){const n=e.charAt(t);if(null==n||Number(n)!=n){--t;break}if(t===e.length)break}n.id=Number(e.substring(r,t+1))}if(e.charAt(++t)){const r=e.substr(t));if(!c.isPayloadValid(n.type,r))throw new Error("invalid payload");n.data=r}return o("decoded %s as %j",e,n),n}.Decoder=c;,7306:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hasBinary=t.isBinary=void 0;const n="function"==typeof ArrayBuffer,r=i=Object.prototype.toString,s="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===i.call(Blob),o="function"==typeof File||"undefined"!=typeof File&&"[object FileConstructor]"===i.call(File);.isBinary=a,t.hasBinary=,5862:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(1908);class i{constructor(){this.version=r.metadata.version+"-"+r.metadata.hash.slice(0,8)}static getInstance(){return i.instance||(i.instance=new i),i.instance}reset(){}}i.BLOCK_SIZE=1048576,t.default=i},3951:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.broadcast=void 0;const r=n(4023),i=n(3188),s=new r.BroadcastChannel("pcdn");t.broadcast=function(e,t){s.postMessage({type:e,data:t}).catch((´¥"+e)}))}},3444:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Config=void 0;const r=n(9312),i=n(990),s=n(3188),o=r.__importDefault(n(2827)),a=r.__importDefault(n(1788)),c=n(9685),d=n(278),l=n(1380);t.Config=class{constructor(e,t){this.sdk=e,this.aid=0,this.cid=0,this.bvid="",this.buvid="",this.isAdmin=!1,this.debugKey="",this.duration=0,this.isPCApp=!1,this.homepage=!1,this.fid="Default:Unknown:0",this.rpDisabled=!1,this.reportToTrackerEnabled=!1,this.sessionid=(0,c.nanoid)(),this.vendor="hw2",this.socketUrl="wss://hw-v2-web-player-tracker.biliapi.net",this.mid=parseInt(a.default.getCookie("DedeUserID"))||0,this.saveMaxSize=524288e3,this.ogvExtraSize=104857600,this.ridMaxNum=400,this.enableDonation=!1,this.realP2PSaveRestriction={qn:[[3e4,30126],[1e5,100999],[30200,30280]]},this.realP2PUsageRestriction={qn:[[3e4,30126],[1e5,100999],[30200,30280]]},this.fawkesConfig={useCidLastNumCount:3,enableReportTrackerRatio:5,leecherChannelOpenTimeout:2e3,leecherChannelMessageTimeout:3500,dashBufferTime:30,resourceBlockSize:s.DBUtils.resourceBlockSize,maxRetryPeerConfig:{browserPeer:20,boxPeer:10},disableDonationTime:5,cidLastNumsWithVendors:{"[0,100]":{vendor:"ali",socketUrl:"wss://ali-web-player-tracker.biliapi.net"},"[100,1000]":{vendor:"hw2",socketUrl:"wss://hw-v2-web-player-tracker.biliapi.net"}},iceServersUrlsWithVendors:{ali:["stun:39.107.142.158:3478"],hw2:["stun:hw-v2-web-player-tracker.biliapi.net:3478"]},sdpReservedAttrs:i.SdpParser.sdpAttrs,badHistoryPeerMax:30,pcdnEnabledBrowserList:["chromium"],pcdnBannedBrowserList:["safari"],pcdnAllowedMaxQn:this.realP2PSaveRestriction.qn[0][1],pcdnAllowedAV1MaxQn:this.realP2PSaveRestriction.qn[1][1],enableDonationPercentage:0,successiveBoxOpenFailV2:28,pcdnCidBlackList:[],pcdnAidBlackList:[],pcdnEnabledCidRange:["0","999"],donatePeerSingleBitrate:614400,donatePeerMaxNum:4,donatePeerMinBitrate:524288,normalPeerSingleBitrate:524288,normalPeerMaxNum:15},this.pcdnDisabledLSName="pcdn-disabled",this.pcdnInfoLSName="pcdn-info",this.setPassedConfig(t),this.getFawkesConfig(t),this.setComputedCion=!1}setPassedConfig(e){const{aid:t,isAdmin:n,cid:r,bvid:i,debugKey:s,duration:o,isPCApp:c,fid:d,rpDisabled:l}=e||{};t&&(this.aid=Math.floor(t)),r&&(this.cid=Math.floor(r)),i&&(this.bvid=i+""),n&&(this.isAdmin=n),s&&(this.debugKey=s+""),o&&(this.duration=Math.floor(o)),d&&(this.fid=d+""),!0===c&&(this.isPCApp=c),this.homepage=e.homepage,!0===l&&(this.rpDisabled=!0),this.buvid=a.default.getCookie("buvid3")}getFawkesConfig(e){if(a.default.isObject(e)&&a.default.isObject(e.fawkesConfig)){try{e.fawkesConfig["nc_sdk_policy.cid_last_nums_with_vendors_v2"]&&(this.fawkesConfig.cidLastNumsWithVendors=JSON.parse(e.fawkesConfig["nc_sdk_policy.cid_last_nums_with_vendors_v2"]))}catch(e){o.default.getInstance().warn("JSON.parse nc_sdk_policy.cid_last_nums_with_vendors_v2",e)}try{if(e.fawkesConfig["nc_sdk_policy.ice_servers_urls_with_vendors"]){const t=JSON.parse(e.fawkesConfig["nc_sdk_policy.ice_servers_urls_with_vendors"]);if(Object.keys(t||{}).length<=0)throw new Error("no vendor");for(const e in t){if(!e||!Array.isArray(t[e])||t[e].length<=0)throw new Error("iceServersUrlsWithVendors is invalid");for(const n of t[e])if("string"!=typeof n||!n)throw new Error("iceServersUrlsWithVendors url is invalid")}this.fawkesConfig.iceServersUrlsWithVendors=t}}catch(e){o.default.getInstance().warn("JSON.parse nc_sdk_policy.ice_servers_urls_with_vendors",e)}if(e.fawkesConfig["nc_sdk_policy.leecher_channel_open_timeout"]){const t=parseInt(e.fawkesConfig["nc_sdk_policy.leecher_channel_open_timeout"]);Number.isNaN(t)||(this.fawkesConfig.leecherChannelOpenTimeout=t)}if(e.fawkesConfig["nc_sdk_policy.leecher_channel_message_timeout"]){const t=parseInt(e.fawkesConfig["nc_sdk_policy.leecher_channel_message_timeout"]);Number.isNaN(t)||(this.fawkesConfig.leecherChannelMessageTimeout=t)}if(e.fawkesConfig["nc_sdk_policy.dash_buffer_time"]){const t=parseInt(e.fawkesConfig["nc_sdk_policy.dash_buffer_time"]);Number.isNaN(t)||(this.fawkesConfig.dashBufferTime=t)}if(e.fawkesConfig["nc_sdk_policy.pcdn_allowed_max_qn"]){const t=parseInt(e.fawkesConfig["nc_sdk_policy.pcdn_allowed_max_qn"]);Number.isNaN(t)||(this.fawkesConfig.pcdnAllowedMaxQn=t,this.realP2PSaveRestriction.qn[0][1]=t)}if(e.fawkesConfig["nc_sdk_policy.pcdn_allowed_av1_max_qn"]){const t=parseInt(e.fawkesConfig["nc_sdk_policy.pcdn_allowed_av1_max_qn"]);Number.isNaN(t)||(this.fawkesConfig.pcdnAllowedAV1MaxQn=t,this.realP2PSaveRestriction.qn[1][1]=t)}if(e.fawkesConfig["nc_sdk_policy.resource_block_size"]){const t=parseInt(e.fawkesConfig["nc_sdk_policy.resource_block_size"]);Number.isNaN(t)||(this.fawkesConfig.resourceBlockSize=t),s.DBUtils.resourceBlockSize=this.fawkesConfig.resourceBlockSize}if(e.fawkesConfig["nc_sdk_policy.max_retry_peer_config"])try{const t=JSON.parse(e.fawkesConfig["nc_sdk_policy.max_retry_peer_config"]),n=Object.keys(t),r=["browserPeer","boxPeer"];for(const e of n){const n=parseInt(t[e]);if(Number.isNaN(n)||n<=0)throw new Error("å€¼ä¸ä¸ºæ•°å­—æˆ–è€…å€¼å°äºŽç­‰äºŽ0")}if(!r.every((e=>n.includes(e))))throw new Error("å°‘ key");this.fawkesConfig.maxRetryPeerConfig=t}catch(e){o.default.getInstance().warn("JSON.parse nc_sdk_policy.max_retry_peer_config error"+e)}if(e.fawkesConfig["nc_sdk_policy.disable_donation_time"]){const t=parseInt(e.fawkesConfig["nc_sdk_policy.disable_donation_time"]);Number.isNaN(t)||(this.fawkesConfig.disableDonationTime=t)}if(e.fawkesConfig["common_policy.sdp_reserved_attrs"])try{const t=JSON.parse(e.fawkesConfig["common_policy.sdp_reserved_at>i.SdpParser.sdpAttrs.includes(e)))&&(this.fawkesConfig.sdpReservedAttrs=t)}catch(e){o.default.getInstance().warn("JSON.parse common_policy.sdp_reserved_attrs error"+e)}if(e.fawkesConfig["nc_sdk_policy.bad_history_peer_max"]){const t=parseInt(e.fawkesConfig["nc_sdk_policy.bad_history_peer_max"]);Number.isNaN(t)||(this.fawkesConfig.badHistoryPeerMax=t)}if(e.fawkesConfig["common_policy.pcdn_enabled_browser_list"])try{const t=JSON.parse(e.fawkesConfig["common_policy.pcdn_enabled_browser_list"]);Array.isArray(t)&&(this.fawkesConfig.pcdnEnabledBrowserList=t)}catch(e){o.default.getInstance().warn("JSON.parse common_policy.pcdn_enabled_browser_list error"+e)}if(e.fawkesConfig["common_policy.pcdn_banned_browser_list"])try{const t=JSON.parse(e.fawkesConfig["common_policy.pcdn_banned_browser_list"]);Array.isArray(t)&&(this.fawkesConfig.pcdnBannedBrowserList=t)}catch(e){o.default.getInstance().warn("JSON.parse common_policy.pcdn_banned_browser_list error"+e)}if(e.fawkesConfig["nc_sdk_policy.enable_donation_percentage"])try{const t=parseInt(e.fawkesConfig["nc_sdk_policy.enable_donation_percentage"]);if(Number.isNaN(t))throw new Error("nc_sdk_policy.enable_donation_percentage is NaN");this.fawkesConfig.enableDonationPercentage=t}catch(e){o.default.getInstance().warn("JSON.parse nc_sdk_policy.enable_donation_percentage error"+e)}if(e.fawkesConfig["nc_sdk_policy.successive_box_open_fail_v2"]){const t=Number(e.fawkesConfig["nc_sdk_policy.successive_box_open_fail_v2"]);t>0&&(this.fawkesConfig.successiveBoxOpenFailV2=t)}if(e.fawkesConfig["reward_pcdn_loader_policy.pcdn_aid_black_list"])try{const t=JSON.parse(e.fawkesConfig["reward_pcdn_loader_policy.pcdn_aid_black_list"]);Array.isArray(t)&&t.every((e=>"number"==typeof e))&&(this.fawkesConfig.pcdnAidBlackList=t)}catch(e){o.default.getInstance().warn("JSON.parse reward_pcdn_loader_policy.pcdn_aid_black_list error"+e)}if(e.fawkesConfig["reward_pcdn_loader_policy.pcdn_cid_black_list"])try{const t=JSON.parse(e.fawkesConfig["reward_pcdn_loader_policy.pcdn_cid_black_list"]);Array.isArray(t)&&t.every((e=>"number"==typeof e))&&(this.fawkesConfig.pcdnCidBlackList=t)}catch(e){o.default.getInstance().warn("JSON.parse reward_pcdn_loader_policy.pcdn_cid_black_list error"+e)}if(e.fawkesConfig["nc_sdk_policy.pcdn_enabled_cid_range"])try{const t=JSON.parse(e.fawkesConfig["nc_sdk_policy.pcdn_enabled_cid_range"]);this.fawkesConfig.pcdnEnabledCidRange=t}catch(e){o.default.getInstance().warn("JSON.parse nc_sdk_policy.pcdn_enabled_cid_range error"+e)}if(e.fawkesConfig["nc_sdk_policy.donate_peer_single_bitrate"])try{const t=Number(e.fawkesConfig["nc_sdk_policy.donate_peer_single_bitrate"]);Number.isNaN(t)||(this.fawkesConfig.donatePeerSingleBitrate=t)}catch(e){o.default.getInstance().warn("JSON.parse nc_sdk_policy.donate_peer_single_bitrate error"+e)}if(e.fawkesConfig["nc_sdk_policy.donate_peer_max_num"])try{const t=Number(e.fawkesConfig["nc_sdk_policy.donate_peer_max_num"]);Number.isNaN(t)||(this.fawkesConfig.donatePeerMaxNum=t)}catch(e){o.default.getInstance().warn("JSON.parse nc_sdk_policy.donate_peer_max_num error"+e)}if(e.fawkesConfig["nc_sdk_policy.donate_peer_min_bitrate"])try{const t=Number(e.fawkesConfig["nc_sdk_policy.donate_peer_min_bitrate"]);Number.isNaN(t)||(this.fawkesConfig.donatePeerMinBitrate=t)}catch(e){o.default.getInstance().warn("JSON.parse nc_sdk_policy.donate_peer_min_bitrate error"+e)}if(e.fawkesConfig["nc_sdk_policy.normal_peer_single_bitrate"])try{const t=Number(e.fawkesConfig["nc_sdk_policy.normal_peer_single_bitrate"]);Number.isNaN(t)||(this.fawkesConfig.normalPeerSingleBitrate=t)}catch(e){o.default.getInstance().warn("JSON.parse nc_sdk_policy.normal_peer_single_bitrate error"+e)}if(e.fawkesConfig["nc_sdk_policy.normal_peer_max_num"])try{const t=Number(e.fawkesConfig["nc_sdk_policy.normal_peer_max_num"]);Number.isNaN(t)||(this.fawkesConfig.normalPeerMaxNum=t)}catch(e){o.default.getInstance().warn("JSON.parse nc_sdk_policy.normal_peer_max_num error"+e)}}}setComputedConfig(){this.computeSaveMaxSize(),this.setVendorAndSocketUrl(),this.homepage||this.rpDisabled?this.enableDonation=!1:this.enableDonation=this.calcCidEnablePCDN()}computeSaveMaxSize(){let e=0;const[t,n]=a.default.tryCatchSync(JSON.parse,localStorage.getItem(this.pcdnInfoLSName));if((null==n?void 0:n.level)&&(e=n.level),0===e)return this.saveMaxSize=0,void(this.ogvExtraSize=0);const r="chromium"===(null===l.browserInfo||void 0===l.browserInfo?void 0:l.browserInfo.name)?"chrome":"nonChrome";this.saveMaxSize=d.levelStrategyCollection[e].saveMaxSize[r]}setVendorAndSocketUrl(){try{const e=this.cid.toString(),t=+e.substring(e.length-this.fawkesConfig.useCidLastNumCount),n=Object.keys(this.fawkesConfig.cidLastNumsWithVendors);for(const e of n){const n=JSON.parse(e);if(t>=n[0]&&t<n[1]){const t=this.fawkesConfig.cidLastNumsWithVendors[e];(null==t?void 0:t.vendor)&&(this.vendor=t.vendor),(null==t?void 0:t.socketUrl)&&(this.socketUrl=t.socketUrl);break}}}catch(e){o.default.getInstance().warn("[setVendorAndSocketUrl] error",e)}}calcCidEnablePCDN(){const{pcdnEnabledCidRange:e=[]}=this.fawkesConfig||{};if(0===e.length)return!1;const t=e[0].length,n=e.map(Number),r=+this.cid.toString().slice(-t);return r>=n[0]&&r<=n[1]}}},1400:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DonationRecord=void 0;const r=n(7535);t.DonationRecord=class{constructor(e){this.sdk=e,this.name="donationRecord",this.donationRecord={}}updateRecord(e,t,n){var i;if(e&&5===t&&n.donationShouldResPeerNum>0&&0=eviceType===r.DEVICE_TYPE.BROWSER)).length)){const t=60*this.sdk.config.fawkesConfig.disableDonationTime*1e3+30*Math.random()*1e3,n=(i=this.donationRecord)[e]||(i[e]={rid:e,count:0,disableDonationTimer:0});++n.count%3==0&&(this.sdk.main.socketController.reportStatToTracker("noDonationPeer"),n.disableDonationTimer=window.setTimeout((()=>{n.disableDonationTimer=0}),t))}}destroy(){Object.keys(this.donationRecord||{}).forEach((e=>{var t,n;(null===(n=null===(t=this.donationRecord)||void 0===t?void 0:t[e])||void 0===n?void 0:n.disableDonationTimer)&&(window.clearTimeout(this.donationRecord[e].disableDonationTimer),this.donationRecord[e].disableDonationTimer=0)})),this.donationRecord={}}isDonationDisabled(e){var t;return!!(null===(t=this.donationRecord[e])||void 0===t?void 0:t.disableDonationTimer)}}},8649:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HistoryPeers=void 0,t.HistoryPeers=class{constructor(e){this.sdk=e,this.name="historyPeers",this.goodHistoryPeers=[],this.badHistoryPeers={}}updateRecord(e){"goodHistory"===e.target?this.updateGoodHistoryPeers(e.cPeerSID):this.updateBadHistoryPeers(e.cPeerSID,e.instantReject)}updateBadHistoryPeers(e,t){var n,r;if(this.goodHistoryPeers.includes(e))return;const i=(r=this.badHistoryPeers)[e]||(r[e]={count:0,reported:!1});i.count++,Object.keys(this.badHistoryPeers).length>=this.sdk.config.fawkesConfig.badHistoryPeerMax&&!this.goodHistoryPeers.length?t():i.count>=5&&!i.reported&&(i.reported=!0,null===(n=this.sdk.main.socketController)||void 0===n||n.reportBadCPeerSID(e))}updateGoodHistoryPeers(e){this.goodHistoryPeers.includes(e)||this.goodHistoryPeers.push(e),this.badHistoryPeers[ePeers=[],this.badHistoryPeers={}}}},7639:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LocalRecord=void 0;const r=n(1400),i=n(8649),s=n(2905),o=n(1372);t.LocalRecord=class{constructor(e){this.sdk=e,this.recordMap={donation:new r.DonationRecord(this.sdk),historyPeers:new i.HistoryPeers(this.sdk),noPeer:new s.NoPeerRecord(this.sdk),openFail:new o.OpenFailRecord(e){return this.recordMap[e]}destroy(){Object.values(this.recordMap).forEach((e=>e.destroy()))}}},2905:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NoPeerRPeerRecord",this.noPeerRecord={}}updateRecord(e,t){if(!e)return;let n=this.noPeerRecord[e];if(null==t?void 0:t.length)n&&(n.noPeerCount=0,n.disableNCTimer&&(window.clearTimeout(n.disableNCTimer),n.disableNCTimer=0),delete this.noPeerRecord[e]);else{n||(this.noPeerRecord[e]=n={rid:e,noPeerCount:0,disableNCTimer:0}),n.noPeerCount++;const t=4;if(!n.disableNCTimer&&n.noPeerCount%t==0){const e=60*Math.floor(n.noPeerCount/t)*1e3+30*Math.random()*1e3;n.Timeout((()=>{n.disableNCTimer=0}),e)}}}destroy(){for(let e in this.noPeerRecord){const t=this.noPeerRecord[e];(null==t?void 0:t.disableNCTimer)&&(window.clearTimeout(t.disableNCTimer),t.disableNCTimer=0)}this.noPeerRecord={}}isRidRestricted(e){var t;return!!(null===(t=this.noPeerRecord[e])||void 0===t?void 0:t.disableNCTimer)}}},1372:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OpenFailRecord=void 0;const r=n(9312).__importDefault(n(1788));t.OpenFailRecord=class{constructor(e){this.sdk=e,this.name="openFailRecord",this.channelOpenFailRecord={boxPeer:0,browserPeer:0}}updateRecord(e){var t;const n=r.default.getPeerTarget(e.cPeerSID);if("unknown"===n)return;if("clear"===e.action)return void("box"===n?"number"==typeof this.channelOpenFailRecord.boxPeer&&(this.channelOpenFailRecord.boxPeer=0):"number"==typeof this.channelOpenFailRecord.browserPeer&&(this.channelOpenFailRecord.browserPeer=0));const i=this.sdk.config.fawkesConfig.maxRetryPeerConfig,s=this.sdk.config.fawkesConfig.successiveBoxOpenFailV2;"box"===n&&"number"==typeof this.channelOpenFailRecord.boxPeer?++this.channelOpenFailRecord.boxPeer>=s&&(this.sdk.state.otherStat.openFailBannedCount++,this.sdk.state.otherStat.savedUselessCount=100-this.channelOpenFailRecord.boxPeer,this.channelOpenFailRecord.boxPeer="rejected",e.instantReject()):"browser"===n&&"number"==typeof this.channelOpenFailRecord.browserPeer&&++this.channelOpenFailRecord.browserPeer>=i.browserPeer&&(null===(t=this.sdk.main.socketController)||void 0===t||t.reportStatToTracker("successiveBrowserPeerNotOpen"),this.channelOpenFannelOpenFailRecord.browserPeer}}},1274:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(9312),i=r.__importDefault(n(1788)),s=r.__importDefault(n(5862)),o=r.__importDefault(n(4890)),a=r.__importDefault(n(2565)),c=r.__importDefault(n(2827)),d=r.__importDefault(n(5761)),l=n(5192),u=n(3188),h=n(3206),p=n(4932);t.default=class{constructor(e){this.sdk=e,this.needSaveResources={},this.onceSaveDataSizeMax=52428800,this.useP2PGetDataObj={},this.refreshTimeout=5e4,this.enableRepeatLog=!0,this.failureRecord={},this.getDataStat=this.sdk.state.getDataStat,this.getDataContinuousStat=this.sdk.state.getData,this.dbStat=this.sdk.state.dbStat,this.socketController=new d.default(this.sdk),this.promiseQueue=new p.PromiseQueue,this.dbController=new l.DBController(this.sdk,this.socketController,this.promiseQueue),this.webrtcFactory=new h.WebRTCFactory(this.sdk,this.socketController,this.dbController)}destroy(){var e,t,n,r,i;clearTimeout(this.refreshTimer),null===(e=this.socketController)||void 0===e||e.off(o.default.SOCKET_MESSAGE),null===(t=this.webrtcFactory)||void 0===t||t.destroy(),null===(n=this.dbController)||void 0===n||n.destroy(),null===(r=this.socketController)||void 0===r||r.destroy(),null===(i=this.promiseQueue)||void 0===i||i.destroy(),delete this.needSaveResources,delete this.dbController,delete this.socketController,delete this.webrtcFactory,delete this.refreshTimer;for(const e in this.useP2PGetDataObj)for(let t=0;t<this.useP2PGetDataObj[e].length;t++)this.clearGetDataObj(this.useP2PGetDataObj[e][t]);this.useP2PGetDataObj={},Object.vaer:e})=>e&&window.clearTimeout(e))),this.failureRecord={}}saveData(e){const{path:t,data:n}=this.handleDataParam("save",e)||{},[r,s]=i.default.tryCatchSync(i.default.getQnAndCid,t),{cid:o}=s||{};if(!n||!t||r)return;if(n.byteLength>this.onceSaveDataSizeMax)return void c.default.getInstance().warn(`more than onceSaveDataSizeMax -- dataSize: ${n.byteLength}`);const a=u.DBUtils.getSaveRestriction();if([()=>{var e;return!(null===(e=null==a?void 0:a[o])||void 0===e?void 0:e.timestamp)},()=>Date.now()-a[o].timestamp>18e4,()=>a[o].token===this.sdk.saveDataToken].every((e=>!e())))this.enableRepeatLog&&(u.DBUtils.warn("åŒä¸€ä¸ª cid åœ¨å¦å¤–ä¸€ä¸ª tab å†™æ•°æ®, ä½ å°±åˆ«å†™äº†"),this.enableRepeatLog=!1);else{try{u.DBUtils.setSaveRestriction(o,{timestamp:Date.now(),token:this.sdk.saveDataToken})}catch(e){return void(this.dbStat.saveFailure=++this.dbStat.saveFailure)}u.DBUtils.log("main.tsè°ƒç”¨saveDataäº†, å¼€å§‹å­˜äº†"),this.enableRepeatLog=!0,this.promiseQueue.enqueue((()=>{var r;return null===(r=this.dbController)||void 0===r?void 0:r.saveResource({range:u.DBUtils.parseRange(e.range),data:n,rid:t}).thenaveSucog("å­˜å‚¨æˆåŠŸ! ç›¸åŒçš„ridå’Œrangeå·²ç»å­˜è¿‡",e),43012:()=>{u.DBUtils.happyLog("å­˜å‚¨æˆåŠŸ! å­˜å‚¨äº†æ–°åˆ†ç‰‡",e)}};null===(t=n[e.code])||void 0===t||t.call(n)})).catch((e=>{u.DBUtils.handleError(e,!1,"save Resourceå¤±è´¥",43010),this.dbStat.saveFailure=++this.dbStat.saveFailure||1})).finally((()=>this.dbStat.saveCount++))}))}}abortGetData(e){for(const t in this.useP2PGetDataObj)for(let n=0;n<this.useP2PGetDataObj[t].length;n++){const r=this.useP2PGetDataObj[t][n];if(r&&r.token&&r.token===e){const e=0===n;c.default.getInstance().log("abortGetData i:",n,r.internalParam),this.webrtcFactory.abortGetData(r.internalParam),this.removeGetDataObj(r,e);break}}}getData(e){var t;let n=this.handleDataParam("get",e);if(!n)return Promise.reject({code:4e4,msg:"data param invalid",responseData:{path:null==n?void 0:n.path,range:(null==n?void 0:n.rangeStart)+"-"+(null==n?void 0:n.rangeEnd)}});const{path:r}=n;if(this.sdk.newTrack.addRIDRtcStats(r,"getData",1),this.sdk.newTrack.addRIDRtcStats(r,"getDataBytes",n.rangeEnd-n.rangeStart+1),this.socketController){let e=0,t="",r=!1;this.socketController.disableAllRNCTimer&&(r=!0,e=40017,t="search peer limit, disable getData");const i=this.socketController.localRecord.getRecord("noPeer");if((null==i?void 0:i.isRidRestricted(n.path))&&(r=!0,e=40007,t="current resource has no peer for several times, disable getData"),r)return Promise.reject({code:e,msg:t,responseData:{path:n.path,range:(null==n?void 0:n.rangeStart)+"-"+(null==n?void 0:n.rangeEnd)}})}if(null===(t=this.failureRecord[r])||void 0===t?void 0:t.disableNCTimer)return Promise.reject({code:40011,msg:"browser seeder fail too many times, disable getData",responseData:{path:n.path,range:(null==n?void 0:n.rangeStart)+"-"+(null==n?void 0:n.rangeEnd)}});const i=this.createGetDataObj(e,n);return this.useP2PGetDataObj[r].length>1?(c.default.getInstance().log("wait for getting video data, getDataObjArr.length:",this.useP2PGetDataObj[r].length),i.promise):(this.internalGetData(this.useP2PGetDataObj[r][0]),i.promise)}internalGetData(e){var t,n,s,o;return r.__awaiter(this,void 0,void 0,(function*(){const{path:r}=e.internalParam;if(c.default.getInstance().log(`${r} internalGetData`,e),clearTimeout(this.refreshTimer),this.createRefreshTimer(e),!this.socketController)return null===(t=e.onReject)||void 0===t||t.call(e,{code:40002,msg:"no socketController"}),this.removeGetDataObj(e,!0),void(this.getDataStat.useP2PNoSCFail=++this.getDataStat.useP2PNoSCFail||1);try{const t=yield this.webrtcFactory.getData(e.internalParam);null===(n=e.onResolve)||void 0===n||n.call(e,t),this.getDataContinuousStat.useP2PSuccess=++this.getDataContinuousSttat.useP2PSuccess++,(null===(s=t.responseData.usePeerSids)||void 0===s?void 0:s.some((e=>"browser"===i.default.getPeerTarget(e))))?this.sdk.state.commonStat.useRealP2PSuccess++:t.responseData.gotDataByteFromBr>0&&this.sdk.state.commonStat.useRealP2PFailure++,this.sdk.newTrack.addRIDRtcStats(r,"getDataSuccess",1)}catch(t){c.default.getInstance().log(`${r} rtcRejeect)||void 0===o||o.call(e,t),this.handleGetDataErrorStatistics(t),this.handleFailureRecord(r,t)}}))}handleFailureRecord(e,t){}clearGetDataObj(e){e&&(e.onResolve=null,e.onReject=null,e.promise=null)}removeGetDataObj(e,t=!1){if(!e)return;this.clearGetDataObj(e);const n=this.useP2PGetDataObj[e.internalParam.path]||[],r=n.findIndex((t=>t===e));n.splice(r,1),n.length&&(0===r&&t?this.internalGetData(n[0]):c.default.getInstance().warn(`removeGetDataObj is not first and need getNextData -- removeI: ' + ${r}`))}handleDataParam(e,t){if(!t||!t.url)return null;let n=""+t.url,r=n.split("?")[0].split("/"),i=r[r.length-1];if(!i)return null;let s=(""+t.range).split("-");if(s.length<2)return null;let o=parseInt(s[0],10),a=parseInt(s[1],10);if(isNaN(o)||isNaN(a)||o<0||a<o)return null;if(!t.token||"string"!=typeof t.token)return c.default.getInstance().log("no valid token"),null;if(t.totalSize&&a>=t.totalSize)return c.default.getInstance().log("è¦èŽ·å–çš„æ•°æ®èŒƒå›´è¶…å‡ºèµ„æºæœ€å¤§å­—èŠ‚èŒƒå›´"),null;let d=t.data;return"save"!==e||d&&d.byteLength&&d.byteLenme:t.startTime,data:d,totalSize:t.totalSize,bitrate:t.bitrate,latency:t.latency}:null}getNodeVar(e,t){this.socketController&&this.socketController.getNodeVar(e,t)}hotPushToTracker(e,t){var n;e&&t?null===(n=this.socketController)||void 0===n||n.hotPushToTracker(e,t):c.default.getInstance().log("hotPushToTracker -- param invalid")}handleGetDataErrorStatistics(e){const t={43e3:"useP2PFileReaderError",41e3:"useP2PWebRTCOpenTimeout",41001:"useP2PWebRTCOpenTimeoutByNoLDP",41002:"useP2PWebRTCOpenTimeoutByNoRDP",41003:"useP2PWebRTCOpenTimeoutByNoRC",41004:"useP2PWebRTCOpenTimeoutByNoACS",__default__:"useP2PWebRTCFail"},n=t[null==e?void 0:e.code]||t.__default__;this.getDataStat[n]=++this.getDataStat[n]||1}createRefreshTimer(e){this.refreshTimer=window.setTimeout((()=>{var t,n,r,i,s;const o={range:(null===(t=e.internalParam)||void 0===t?void 0:t.rangeStart)+"-"+(null===(n=e.internalParam)||void 0===n?void 0:n.rangeEnd),from:0,path:null===(r=e.internalParam)||void 0===r?void 0:r.path,getDataTime:Date.now()-(null===(i=e.internalParam)||void 0===i?void 0:i.startTime),data:void 0,gotDataByte:0,rtcDataChannelState:void 0,cPeerSID:""};null===(s=e.onReject)||void 0===s||s.call(e,{code:40005,msg:`current ${e.internalParam.path} peer lose`,responseData:o},!1)}),this.refreshTimeout)}createGetDataObj(e,t){const n={token:e.token,dataParam:e,internalParam:t};return n.promise=new Promise(((e,r)=>{const i=this;n.onResolve=function(r,d=!0){var l;e(r),i.removeGetDataObj(this,d);const u=n.internalParam.rangeEnd-n.internalParam.rangeStart+1;if(u!==r.responseData.data.byteLength){let e={type:a.default.TRACK_TYPE.DEBUG_TOTAL_SIZE_NOT_EQUAL,version:s.default.getInstance().version,totalSize:u,byteLength:r.responseData.data.byteLength,rid:t.path,rangeStart:t.rangeStart,rangeEnd:t.rangeEnd};null===(l=i.sdk.eventBus)||void 0===l||l.trigger(o.default.TRACK,e),c.default.getInstance().log("------- totalSize !== response data byteLength")}},n.onReject=function(e,t=!0){r(e),i.removeGetDataObj(this,t)}})),this.getDataStat.useP2P=++this.getDataStat.useP2P||1,this.getDataContinuousStat.useP2P=++this.getDataContinuousStat.useP2P||1,this.useP2PGetDataObj[t.path]=[...this.useP2PGetDataObj[t.path]||[],n],n}}},4870:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sessionid=t.NewTrack=void 0;const r=n(9312),i=n(5826),s=r.__importDefault(n(1788)),o=n(9685),a=n(1908);t.NewTrack=class{constructor(e){this.eventTableID="001114",this.conf=e,this.reset(!0),this.intervalReport(),this.beforeUnload()}get trackingData(){return Object.assign(Object.assign(Object.assign(Object.assign({},this.rtcStat),this.dbStat),this.otherStat),{ridRtcStats:this.ridRtcStats,sessionid:t.sessionid,vendor:this.conf.vendor})}intervalReport(){this.reportTimer=window.setInterval((()=>{this.sendTrackingData("pcdn__leecher__track",this.trackingData).then((e=>{if(200===e.status)return s.default.pLog("ä¸ŠæŠ¥åŸ‹ç‚¹æˆåŠŸ",this.trackingData),void this.reset(!1);throw e.text()})).catch((e=>s.default.pLog("ä¸ŠæŠ¥åŸ‹ç‚¹å¤±è´¥"+e)))}),3e5)}beforeUnloaunload",(()=>{(0,i.alwaysSend)({url:this.basicURL+this.convertTrackData("pcdn__leecher__track",this.trackingData),method:"get"},{credentials:"include"},(e=>{e.withCredentials=!0,e.send()}),(()=>s.default.pLog("ä¸ŠæŠ¥åŸ‹ç‚¹æˆåŠŸ",JSON.stringify(this.trackingData))))}))}get basicURL(){return`//data.bilibili.com/log/web?${this.eventTableID}${Date.now()}`}sendTrackingData(e,t){return 0===Object.keys(t||{}).length?Promise.reject("åŸ‹ç‚¹æ•°æ®ä¸ºç©º"):fetch(this.basicURL+this.convertTrackData(e,t),{method:"GET",credentials:"include"})}convertTrackData(e,t){return[Date.now(),this.conf.fid,"",e,JSON.stringify(t),"",0,0,0,0,0,0,0,0,0,0,0,0,"","","",JSON.stringify({webAbTest:window.webAbTest,leecherVersion:a.metadata.version})].join("|")}reset(e){if(this.ridRtcStats={},!1===e)return Object.keys(this.rtcStat).forEach((e=>{"object"==typeof this.rtcStat[e]?this.rtcStat[e]={}:this.rtcStat[e]=0})),Object.keys(this.dbStat).forEach((e=>this.dbStat[e]=0)),void Object.keys(this.otherStat).forEach((e=>this.otherStat[e]=0));this.rtcStat={receivedByteFromBrowser:0,ridReceivedByteFromBrowser:{},sidReceivedByteFromBrowser:{}},this.dbStat={deleteDBFailure:0,dbStateInaccurate:0,attemptedSavingSize:0},this.otherStat={outerTraffic:0,innerTraffic:0,seederUseOldDB:0,deleteV3Failure:0,getPeerContainingDonation:0,donationNoPeer:0}}addRIDRtcStats(e,t,n){e&&t&&!isNaN(n)&&(this.ridRtcStats[e]||(this.ridRtcStats[e]={}),this.ridRtcStats[e][t]=this.ridRtcStats[e][t]+n||n)}destroy(){this.reportTimer&&window.clearInterval(t("pcdn__leecher__track",this.trackingData).then((e=>{if(200===e.status)return s.default.pLog("destroyæ—¶ä¸ŠæŠ¥åŸ‹,this.trackingData),void this.reset(!1);throw e.text()})).catch((e=>s.default.pLog("destroyæ—¶ä¸ŠæŠ¥åŸ‹ç‚¹å¤±è´¥"+e)))}},t.sessionid=(0,o.nanoid)()},2565:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class n{}n.TRACK_TYPE={TEST:1e3,ENTER:1001,QUIT:1002,SAVE_DATA:2001,GET_DATA:2002,OPEN_DB:2003,DB_UPGRADE:2004,OPEN_DB_ERROR:2005,OPEN_DB_SUCCESS:2006,DB_CLOSE:2007,PUT_DB:2008,PUT_DB_SUCCESS:2009,PUT_DB_ERROR:2010,DB_RESOURCE:2011,DEL_DB_ERROR:2012,REPORT_RESOURCE:2013,DEBUG_TOTAL_SIZE_NOT_EQUAL:5e3},n.RESOURCE_OPTION={UPDATE:1,ADD:2,DEL:3},n.RESPONSE_CODE={SUCCESS:1,ERROR:-1,FILE_READER_ERROR:-2,ANSWER_INVALID:-3,WEBRTC_OPEN_TIMEOUT:-300,WEBRTC_OPEN_TIMEOUT_BY_NO_LDP:-301,WEBRTC_OPEN_TIMEOUT_BY_NO_RDP:-302,WEBRTC_OPEN_TIMEOUT_BY_NO_RC:-303,WEBRTC_OPEN_TIMEOUT_BY_NO_ACS:-304},n.RTC_STATE_CODE={INIT:1,DATA_CHANNEL_OPEN_SUCCESS:2,DATA_CHANNEL_OPEN_ERROR:3,SEND_DATA_SUCCESS:4,GET_DATA_SUCCESS:5},t.default=n},2459:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(){this.getData={useP2P:0,useP2PSuccess:0},this.pcdnStat={pcdnReportError:0,pcdnReportFailure:0},this.ridsArray=[],this.succRidsArray=[],this.reset()}reset(){this.getDataStat={useP2P:0,useP2PSuccess:0,useP2PFileReaderError:0,useP2PWebRTCOpenTimeout:0,useP2PWebRTCOpenTimeoutByNoLDP:0,useP2PWebRTCOpenTimeoutByNoRDP:0,useP2PWebRTCOpenTimeoutByNoRC:0,useP2PWebRTCOpenTimeoutByNoACS:0,useP2PWebRTCFail:0,useP2PNoSCFail:0,useP2PFromBrowser:0,useP2PFromBox:0},this.rtcStat={offerInitToBrowser:0,getSuccessFromBrowser:0,offerDataChannelOpenToBrowser:0,answerInit:0,answerDataChannelOpen:0,sendSuccess:0,getDataFromDBSuccess:0,getDataFromDBFail:0,sendBytes:0,sendSuccessBytes:0,receivedByteTotal:0,receivedByteFromBrowser:0,receivedByteFromBox:0,receivedOffer:0,receivedGetData:0,sendFinished:0,offerAccepted:0,receivedCandidate3:0,receivedCandidate2:0,receivedCandidate1:0,addCandidateTooEarly:0,setRemoteDescErr:0,setLocalDescErr:0,createAnswerErr:0,noDonationPeer:0,successiveBrowserPeerNotOpen:0},this.dbStat={saveSuccess:0,saveFailure:0,saveRidAndSliceFailure:0,saveIDAndSliceFailure:0,saveSliceFailure:0,reportTotalSize:0,reportFailure:0,reportSuccess:0,deleteFailureForAllBelow24h:0,deleteFailure:0,deleteRids:0,deleteBytes:0,deleteSlices:0,deleteSuccess:0,deleteDBFailure:0,saveRids:0,savedRids:0,saveSlices:0,savedSlices:0,saveBytes:0,savedBytes:0,saveCount:0,exceedingDBTotalSize:0,exceedingRidMax:0,dbStateInaccurate:0},this.weightStat={sameISPNum:0,notSameISPNum:0,sameISPOpenNum:0,notSameISPOpenNum:0,ChinaTelecomNum:0,ChinaMobileNum:0,ChinaUnicomNum:0,OtherISPNum:0,ChinaTelecomOpenNum:0,ChinaMobileOpenNum:0,ChinaUnicomOpenNum:0,OtherISPOpenNum:0},this.commonStat={getPeersCount:0,getPeersRidCount:0,getPeersSuccRidsCount:0,useP2PSuccess:0,useRealP2PSuccess:0,useRealP2PFailure:0},this.boxStat={webrtcInitedCount:0,addIceCandidate:0,dataChannelOpen:0,setRemoteDescErr:0,addIceCandidateErr:0,peersCount:0},this.browserStat={webrtcInitedCount:0,addIceCandidate:0,dataChannelO:0,addIceCandidateErr:0,peersCount:0},this.otherStat={openFailBannedCount:0,savedUselessCount:0,getPeerContainingDonation:0,donationNoPeer:0},this.ridsArray=[],this.succRidsArray=[],Object.keys(this.pcdnStat).forEach((e=>this.pcdnStat[e]=0))}addBoxOrBrowserStat(e,t,n){"box"===n?this.boxStat[e]+=t:"browser"===n&&(this.browserStat[e]+=t)}destroy(){this.reset(),this.getData={useP2P:0,useP2PSuccess:0}}}},5192:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DBController=void 0;const r=n(9312),i=r.__importDefault(n(8036)),s=r.__importDefault(n(4127)),o=n(1380),a=n(3951),c=r.__importDefault(n(2204)),d=r.__importStar(n(1788)),l=n(2320),u=n(6262),h=n(3188);class p extends s.default{constructor(e,t,n){super(p.dbName),this.promiseQueue=n,this.enableEncryption=!0,this.events=new c.default,this.intervalCheckTotalSizeTimer=0,this.needDeleteDBNames=["bilibiliPlayerCacheData","BP_CD_V2","BP_CD_V3"],this.updateLocalStorageTimer=null,this.enableReport=!1,this.DFARes={state:"ready"},this.tmpTimer=0,this.needDeleteDBNames.forEach((e=>p.deleteDB(e).catch((()=>{"BP_CD_V3"===e&&this.sdk.newTrack.otherStat.deleteV3Failure++,h.DBUtils.warn(`è€æ•°æ®åº“${e}åˆ é™¤å¤±è´¥`)})))),this.socketController=t,this.dbStat=e.state.dbStat,this.sdk=e}initDB(){if(this.judgeEnableEncryption(),!this.isOpen()){try{this.version(p.dbVersion).stores({resource:"ridRange, [rid+ridRange+range+rangeMB], range, rangeMB",meta:"rid, priority, lastUpdatedTime"})}catch(e){"Cannot add version when database is open"===e.message&&(this.close(),this.version(p.dbVersion).stores({resource:"ridRange, [rid+ridRange+range+rangeMB], range, rangeMB",meta:"rid, priority, lastUpdatedTime"}))}Object.defineProperties(this,{resourceTable:{value:this.resource,enumerable:!1,writable:!1},metaTable:{value:this.meta,enumerable:!1,writable:!1}}),this.promiseQueue.enqueue((()=>this.refreshDBState({isFirst:!0}).then((()=>this.forceCheckTotalSize())).catch((()=>this.sdk.disableSaveDataByDB=!0))),!0),d.default.onBeforeUnload(this.beforeUnload.bind(this,this.sdk.saveDataToken)),this.tmpTimer=window.setTimeout((()=>{var e,t,n;const r=null===(n=null===(t=null===(e=window.bpSeeder)||void 0===e?void 0:e.main)||void 0===t?void 0:t.dbController)||void 0===n?void 0:n.id;"string"==typeof r&&"new-db-controller"!==r&&this.sdk.newTrack.otherStat.seederUseOldDB++}),2e3)}}initDFA(){this.stateHandlerMap={ready:this.dbState.checkSliceExistence.bind(this.dbState),hasSlice:e=>(this.calcAlreadySaved(e),{code:43005,rid:this.decode(e.rid),rangeArr:[e.range],byteLength:0,state:"finished"}),notHasSlice:this.dbState.checkExceedDBMax.bind(this.dbState),overDBMax:this.delAndSave.bind(this),lessThanDBMax:this.dbState.checkExceedRidMax.bind(this.dbState),overRidMax:this.delAndSave.bind(this),lessThanRidMax:this.saveSlice.bind(this)}}interpretDFA(e,t){return r.__awaiter(this,void 0,void 0,(function*(){this.DFARes={state:t};let n=0;for(;"finished"!==this.DFARes.state;)if(h.DBUtils.log(this.DFARes),this.DFARes=yield this.stateHandlerMap[this.DFARes.state](e),n++>50)throw new l.DBError(43020,"DFA æ­»å¾ªçŽ¯äº†");return this.DFARes}))}saveResource(e){return r.__awaiter(this,void 0,void 0,(function*(){switch(!0){case!e:throw new l.DBError(43018,"æ²¡ä¼ saving resource");case!this.sdk.saveDataEnabled:throw new l.DBError(43019,"å­˜å‚¨åŠŸèƒ½è¢«ç¦äº†");case!this.dbState:case!this.stateHandlerMap:throw new l.DBError(43017,"æ•°æ®åº“è¿˜æ²¡åˆå§‹åŒ–å¥½")}return this.enableEncryption&&".nc"!==e.rid.slice(-3)&&(e.rid=h.DBUtils.encode(e.rid)),h.DBUtils.log("start saving resource"),this.interpretDFA(e,"ready")}))}delAndSave(e){return r.__awaiter(this,void 0,void 0,(function*(){co;if(h.DBUtils.log("canDeletedRidsOrMs","number"==typeof t?`å…³é—­sdkå­˜å‚¨${h.DBUtils.formatMs(t)}`:`å¯ä»¥åˆ é™¤çš„rid: ${t}`),"number"==typeof t)throw this.sdk.disableSaveDataByDB=!0,this.disableTimer&&window.clearTimeout(this.disableTimer),this.disableTimer=window.setTimeout((()=>{this.sdk.disableSaveDataByDB=!1}),t),this.dbStat.deleteFailureForAllBelow24h++,new l.DBError(43004,`æ‰€æœ‰ridæœ€è¿‘æ›´æ–°æ—¶é—´éƒ½å°äºŽ24h, å…³é—­sdkå­˜å‚¨${h.DBUtils.formatMs(t)}`);const n=this.dbState.getPriorityArr(t),r=yield this.del(n);return h.DBUtils.happyLog("åˆ é™¤æˆåŠŸ!",r),this.saveResource(e)}))}del(e){return r.__awaiter(this,void 0,void 0,(function*(){for(const{rid:t}of e){const e=this.dbState.selectByRid(t);try{return yield Promise.all([this.resourceTable.where({rid:t}).delete(),this.metaTable.delete(t)]),(0,a.broadcast)("deleteRidV2",t),this.dbState.deleteRid(t),{code:43013,byteLength:(null==e?void 0:e.reduce(((e,[t,n])=>e+n-t+1),0))||0,rid:this.decode(t),rangeArr:e}}catch(e){continue}}throw new l.DBError(43014,"åˆ é™¤å¯åˆ é™¤èµ„æºå¤±è´¥")}))}saveSlice(e){return r.__awaiter(this,void 0,void 0,(function*(){const{rid:t,range:n,data:r}=e,i=r.byteLength,s=`${t}:${n.join("-")}`,o=h.DBUtils.getRangeMB(n);yield this.resourceTable.add({ridRange:s,rid:t,range:n,data:r,rangeMB:o});const c=Date.now();Boolean(yield this.metaTable.where({rid:t}).count())?yield this.metaTable.update(t,{lastUpdatedTime:c}):yield this.metaTable.add({rid:t,lastUpdatedTime:c,priority:-1,fid:this.sdk.config.fid});const l=d.default.getVideoType(this.sdk.config.broadcast)("saveSliceV2",Object.assign({rid:t,range:n,rangeMB:o,lastUpdatedTime:c},l!==d.VideoType.Unknown?{fid:l}:null)),this.dbState.updateState,byteLength:i,rangeArr:[n],code:43012,state:"finished"}}))}getOneItem(){return new Promise(((e,t)=>{const n=indexedDB.open(p.dbName,10*p.dbVersion);n.onerror=()=>t(n.error),n.onsuccess=()=>e(n.result)})).then((e=>function(e){return new Promise(((t,n)=>{const r=e.transaction("resource","readonly").objectStore("resource").getAll(null,1);r.onerror=()=>{e.close(),n(r.error)},r.onsuccess=()=>{e.close(),t(r.res)}(e)))}reon*(){const[rce(["rid","range"]),this.getMeta()]);this.dbState=new u.DBState(this.sdk,t,n),(null==e?void 0:e.isFirst)&&this.initDFA()}))}deleteDatabase(e){return new Promise(((t,n)=>{this.close();cse(e);r.onsuccess=()=>{t()},r.onerror=e=>{var t;n(null===(t=e.target)||void 0===t?void 0:t.error)},r.onblocked=()=>{n(new Error("Database is blocked"))}}))}intervalRefreshDBState(){this.intervalCheckTotalSizeTimer=window.setInterval((()=>{this.promiseQueue.enqueue((()=>this.refreshDBState().then((()=>this.forceCheckTotalSize())).catch((()=>this.sdk.disableSaveDataByDB=!0))),!0)}),3e5)}forceCheckTotalSize(){return r.__awaiter(this,void 0,void 0,(function*(){if(!this.dbState)return void(this.sdk.disableSaveDataByDB=!0);if(this.dbState.isEmpty()&&(yield this.getOneItem()))return this.sdk.disableSaveDataByDB=!0,this.dbStat.dbStateInaccurate++,void this.sdk.newTrack.dbStat.dbStateInaccurate++;const e=this.dbState.getSize("all");if(!(e<=this.sdk.config.saveMaxSize+this.sdk.config.ogvExtraSize))try{yield this.forceDel(e)}catch(e){h.DBUtils.warn("å¼ºåˆ¶åˆ é™¤å‡ºé”™",e),this.sdk.disableSaveDataByDB=!0}}))}forceDel(e){return r.__awaiter(this,void 0,void 0,(function*(){const t=this.dbState.getPriorityArr();if(h.DBUtils.log("å¼ºåˆ¶åˆ é™¤èŽ·å–ä¼˜å…ˆçº§æ•°ç»„æˆåŠŸ",t),!t.length)return e;const n=[];for(const r of t)if(n.push(r),(e-=r.size)<=this.sdk.config.saveMaxSize+this.sdk.config.ogvExtraSize)break;const r=n.map((e=>e.rid));return yield Promise.all([this.resourceTable.where("rid").anyOf(r).delete(),this.metaTable.bulkDelete(r)]),(0,a.broadcast)("bulkDeleteV2",r),this.dbState.deleteRid(r),h.DBUtils.happyLog("å¼ºåˆ¶åˆ é™¤æˆåŠŸ",n),e<0?0:e}))}destroy(){var e;window.clearTimeout(this.tmpTimer),this.sdk.saveDataEnabled&&this.beforeUnload(this.sdk.saveDataToken),void 0!==this.disableTimer&&window.clearTimeout(this.disableTimer),null!==this.updateLocalStorageTimer&&window.clearTimeout(this.updateLocalStorageTimer),this.intervalCheckTotalSizeTimer&&window.clearInterval(this.intervalCheckTotalSizeTimer),this.events&&(this.evehis.dbState)||void 0===e||e.destroy()}beforeUnload(e){const t=h.DBUtils.getSaveRestriction(),n=Object.keys(t).find((n=>{var r;return t[n].token===((null===(r=this.sdk)||void 0===r?void 0:r.saveDataToken)||e)}));delete t[n],d.default.setLocalStorage(h.DBUtils.SAVE_RESTRICTION,t)}judgeEnableEncryption(){const{enableEncryption:e}=h.DBUtils.getBPNCConfig();this.enableEncryption=!!e}getMeta(){return this.metaTable.toArray()}getSavedResource(e,t){return r.__awaiter(this,void 0,void 0,(function*(){if(0===(yield this.resourceTable.count()))return[];const{name:n,version:r}=o.browserInfo;return"chromium"===n||"safari"===n&&r>=10?this.getSavedResourceByNewBrowser(e,t):this.getSavedResourceByOldBrowser(e,t)}))}getSavedResourceByNewBrowser(e,t){return r.__awaiter(this,void 0,void 0,(function*(){const n={rid:0,ridRange:1,range:2,rangeMB:3},r=[];t||(t=yield this.resourceTable.orderBy("rid").uniqueKeys());for(const i of t){const t=yield this.resourceTable.where("[rid+ridRange+raninKey,s.default.minKey],[i,s.default.maxKey,s.default.maxKey,s.default.maxKey]).keys((t=>t.map((t=>e.reduce(((e,r)=>Object.assign(e,{[r]:t[n[r]]})),{})))));r.push(...t)}return r}))}getSavedResourceByOldBrowser(e,t){return r.__awaiter(this,void 0,void 0,(function*(){function n(e,t){const n=[];return e.each((e=>n.push(t(e)))).then((()=>n))}function r(t){return e.reduce(((e,n)=>Object.assign(Object.assign({},e),{[n]:t[n]})),{})}t||(t=yield this.resourceTable.orderBy("rid").un[];for(const e of t){const t=this.resourceTable.where("rid").equals(e);try{const e=yield n(t,(e=>r(e)));i.push(...e)}catch(e){h.DBUtils.warn("getSavedResource error"+e)}}_awaiter(this,void 0,void 0,(function*(){const e=yield this.getSavedResource(["rid","range"]);return{savedSlices:e.length,savedBytes:e.reduce(((e,{range:t})=>e+t[1]-t[0]+1),0),savedRids:e.reduce(((e,eadySaved(e){this.sdk.newTrack.dbStat.attemptedSavingSize+=e.range[1return this.enableEncryption?h.DBUtils.encode(e):e}decode(e){return h.DBUtils.decode(e)}NCOn(e,t){var n;null===(n=this.events)||void 0===n||n.on(e,t)}off(e,t){var n;null===(n=this.events)||void 0===n||n.off(e,t)}trigger(e,...t){var n;null===(n=this.events)||void 0===n||n.trigger(e,...t)}static deleteDB(e){return super.delete(e)}static isWriteResourceRes(e,t=!1){return Array.isArray(e)?t?e.every((e=>void 0!==e.byteLength)):void 0!==e[0].byteLength:void 0!==e.byteLength}}p.dbName="BP_CD_V4",p.dbVersion=1,r.__decorate([h.DBUtils.trackComplete({failure:["deleteFailure"],success:["deleteRids","deleteSuccess",["deleteBytes",e=>e.byteLength],["deleteSlices",e=>e.rangeArr.length]]}),h.DBUtils.transaction("rw",["resource","meta"],"åˆ é™¤æŸä¸ªridçš„æ‰€æœ‰åˆ†ç‰‡")],p.prototype,"del",null),r.__decorate([h.DBUtils.updateLocalStorage,h.DBUtils.trackComplete({failure:["saveSliceFailure"],success:["saveSlices",["saveBytes",e=>e.byteLength]]}),h.DBUtils.transaction("rw",["resource","meta"],"å­˜å‚¨åˆ†ç‰‡")],p.prototype,"saveSlice",null),r.__decorate([h.DBUtils.transaction("r",["resource","meta"],"åˆå§‹åŒ–dbState")],p.prototype,"refreshDBState",null),r.__decorate([h.DBUtils.transaction("rw",["resource","meta"],"å¼ºåˆ¶åˆ é™¤")],p.prototype,"forceDel",null),r.__decorate([i.default],p.prototype,"destroy",null),r.__decorate([i.default],p.prototype,"beforeUnload",null),r.__decorate([h.DBUtils.transaction("r",["resource"],"èŽ·å–å·²å­˜å‚¨æ•°æ®")],p.prototype,"getSavedStats",null),t.DBController=p},2368:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dbEncryption=void 0,t.dbEncryption=new class{constructor(){this.hex="0123456789abcdef",this.chars="ghijklmnopqrstuv",this.map={};for(let e=0;e<this.hex.length;++e)this.map[this.hex[e]]=this.chars[e],this.map[this.chars[e]]=this.hex[e]}encode(e){let t="";for(let n=0;n}decode(e){if(".nc"!==e.slice(-3))return e;const t=this.hexTransformation(e.slice(0,-3));let n="";for(let e=0;e<t.length;e+=2){const r=parseInt(t.slice(e,e+2),16);n+=String.fromCharCode(r)}return n}hexTransformation(e){let t="";for(let n=0;n<e.length;++n)t+=this.map[e[n]];return t}}},2320:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DBError=void 0;class n extends Error{constructor(e,t){super(t),this.code=e,this.name="CustomIndexedDBError"}}t.DBError=n},6262:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DBState=void 0;const r=n(9312),i=n(3188),s=r.__importDefault(n(1788));t.DBState=class{constructor(e,t,n){this.sdk=e,this.resourceState=s.default.groupBy({arr:t,groupFn:e=>e.rid,mapFn:e=>e.range,useMap:!0}),this.metaState=n}checkExceedDBMax(e){const t=this.getSize("all"),n=i.DBUtils.getVideoType(this.sdk.conftraSize:s}=this.sdk.config,o=r+("Pgc"===n?s:0);return t+e.data.byteLength>o?(this.sdk.state.dbStat.exceedingDBTotalSize++,{state:"overDBMax"}):{state:"lessThanDBMax"}}checkExceedRidMax(){return this.resourceState.size>=this.sdk.config.ridMaxNum?(this.sdk.state.dbStat.exceedingRidMax++,{state:"overRidMax"}):{state:"lessThanRidMax"}}checkSliceExistence(e){var t;const{rid:n,range:r}=e;return(null===(t=this.selectByRid(n))||void 0===t?void 0:t.find((([e,t])=>e===r[0]&&t===r[1])))?{state:"hasSlice"}:{state:"notHasSlice"}}getAllSize(){let e=0;for(const[t,n]of this(e,[t,n])=>e+n-t+1),0);return e}getRidSize(e){var t;return(null===(t=this.selectByRid(e))||void 0===t?void 0:t.reduce(((e,[t,n])=>e+n-t+1),0))||0}getSize(e){var t;if("all"===e)return this.getAllSize();if("ogv"===e){let e=0;for(const[n]of this.resourceState){const r=null===(t=this===n)))||void 0===t?void 0:t.fid;"Pgc"===i.DBUtils.getVideoType(r)&&(e+=this.getRidSize(n))}return e}return"string"==typeof e&&(e=[e]),e.reduce(((e,t)=>e+this.getRw(),t=[];let n=0;for(const{rid:r,lastUpdatedTime:s}of this.metaState){const o=e-s;o>=i.DBUtils.canDeleteMaxTimeDelta?t.push(r):o>=n&&(n=o)}return t.length?t:i.DBUtils.canDeleteMaxTimeDelta-n}getPriorityArr(e){return e?this.metaState.filter((({rid:t})=>e.includes(t))).sort(((e,t)=>e.priority-t.prit)=>e.priority-t.priority)).map((e=>Objen(id(e){return this.resourceState.get(e)}updatis.resourceState.set(e,[t]);const i=this.metaState.find((t=>t.rid===e));i?i.lastUpdatedTime=Date.now():this.metaState.push({rid:e,priority:-1,lastUpdatedTime:n,fid:this.sdk.config.fid})}deleteRid(e){(e="string"==typeof e?[e]:e).forEach((e=>this.resourceState.delete(e))),this.metaState=this.metaState.filter((t=>!e.includes(t.rid)))}notEmpty(){return this.resourceState.size>0}isEmpty(){return 0===this.resourceState.size}destroy(){this.resourceState=new Map,this.metaState=[]}}},3188:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DBUtils=void 0;const r=n(9312),i=r.__importDefault(n(5862)),s=n(5192),o=n(2320),a=n(8074),c=n(2368),d=r.__importDefault(n(1788));class l{static transaction(e,t,n,i){return(s,o,a)=>{const c=(a=a||Object.getOwnPropertyDescriptor(s,o)).value;return a.value=function(...s){return r.__awaiter(this,void 0,void 0,(function*(){return this.transaction(e,t,(()=>r.__awaiter(this,void 0,void 0,(function*(){return yield c.apply(this,s)})))).catch((e=>{l.handleError(e,!0,n+"é”™è¯¯",i)}))}))},a}}static trackComplete(e){function t(t,n){var r;null===(r=e[t])||void 0===r||r.forEach((e=>{Array.isArray(e)?"function"==typeof e[1]?this.sdk.state.dbStat[e[0]]+=e[1](n):this.sdk.state.dbStat[e[0]]+=e[1]:this.sdk.state.dbStat[e]++}))}return(e,n,i)=>{const s=(i=i||Object.getOwnPropertyDescriptor(e,n)).value;i.value=function(...e){return r.__awaiter(this,void 0,void 0,(function*(){try{const n=yield s.apply(this,e);return t.call(this,"success",n),n}catch(e){t.call(this,"failure"),l.handleError(e,!0)}}))}}}static updateLocalStorage(e,t,n){const i=(n=n||Object.getOwnPropertyDescriptor(e,t)).value;n.value=function(...e){return r.__awaiter(this,void 0,void 0,(function*(){try{const t=yield i.apply(this,e),n=Array.isArray(t)?d.default.getQnAndCid(l.decode(t[0].rid)).cid:d.default.getQnAndCid(l.decode(t.rid)).cid;return null===this.updateLocalStorageTimer&&(l.setSaveRestriction(n,{timestamp:Date.now()}),this.updateLocalStorageTimer=window.setTimeout((()=>{this.updateLocalStorageTimer=null}),3e4)),t}catch(e){l.handleError(e,!0)}}))}}static timeout(e){return(t,n,i)=>{const s=(i=i||Object.getOwnPropertyDescriptor(t,n)).value;return i.value=function(...t){return r.__awaiter(this,void 0,void 0,(functield Promise.race([s.apply(this,t),new Promise(((t,n)=>{setTimeout((()=>n(new o.DBError(43006,"ä¾›è¡€ç«¯èŽ·å–indexedDBæ•°æ®è¶…æ—¶"))),e)}))])}))},i}}static getSaveRestriction(){const e=d.default.getLocalStorage(l.SAVE_RESTRICTION),[t,n]=d.default.tryCatchSync(JSON.parse,e);return t||!d.default.isObsetSaveRestriction(e,t){const n=l.getSaveRestriction();if(Object.keys(n).filter((e=>{const t=n[e].timestamp;return"number"!=typeof t||Date.now()-t>18e4})).forEach((e=>delete n[e])),Object.keys(n).length>=l.localStorageMaxItem)throw new Error("ä¸å…è®¸åŒæ—¶å­˜è¶…è¿‡10ä¸ªè§†é¢‘");d.default.setLocalStorage(this.SAVE_RESTRICTION,Object.assign(Object.assign({},n),{[e]:Object.assign(Object.assign({},n[e]),t)}))}static parseRange(e){if(Array.isArray(e))return e;const t=e.split("-").map(Number).filter((e=>!Number.isNaN(e)));if(2!==t.length)throw new o.DBError(43002,`invalid range: ${e}`);return t}static getSizeFromRange(e){const t=this.parseRange(e);return t[1]-t[0]+1}static getRangeMB(e){const[t,n]=this.parseRange(e),r=l.resourceBlockSize*i.default.BLOCK_SIZE,s=Math.floor(t/r),[o,a]=[s*l.resourceBlockSize,(s+1)*l.resourceBlockSize-1];return`${o}-${a}`}static getBPNCConfig(){try{return Object.assign({showDBLog:0,showNCLog:0,showLog:0,enableEncryption:1,showSeederLog:0},JSON.parse(d.default.getLocalStorage("bp_nc_config")||"{}"))}catch(e){return{showDBLog:0,showNCLog:0,showLog:0,showSeederLog:0,enableEncryption:1}}}static configureLog(){const e=new Date,t=`DBLog-[v${i.default.getInstance().version}]-[${e.toTimeString().slice(0,8)}-${e.getTime()}]`,{showDBLog:n,showSeederLog:r}=this.getBPNCConfig();return{baseLog:t,showDBLog:n,showSeederLog:r}}static log(...e){const t=["color: #fff","background-color: #444","padding: 2px 4px","border-radius: 2px"],{baseLog:n,showDBLog:r}=this.configureLog();0!==r&&r<=1&&console.log("%cDebug Logs",t.join(";"),n,...e)}static happyLog(...e){const t=["color: #fff","background-color: green","padding: 2px 4px","border-radius: 2px"],{baseLog:n,showDBLog:r}=this.configureLog();0!==r&&r<=2&&console.log("%cSuccess Logs",t.join(";"),n,...e)}static warn(...e){const t=["color: #eee","background-color: red","padding: 2px 4px","border-radius: 2px"],{baseLog:n,showDBLog:r}=this.configureLog();0!==r&&r<=3&&console.log("%cWarn Logs",t.join(";"),n,...e)}static sLog(...e){const t=["color: #fff","background-color: green","padding: 2px 4px","border-radius: 2px"],{baseLog:n,showSeederLog:r}=this.configureLog();r>=1&&console.log("%cSeeder Logs",t.jrror(e,t,n,r){let i=43009;r&&(i=r),e instanceof o.DBError&&(i=e.code);const s=(n?[n,e.message]:[e.messageow new o.DBError(i,s);l.warn(`é”™è¯¯æ˜¯${null==e?void 0:e.name}ç±»åž‹, é”™è¯¯ä¿¡æ¯æ˜¯${s}, é”™è¯¯ç æ˜¯${i}`)}static transformResource(e){if(e)return e.map((({id:e,rangeArr:t})=>{const[n,r]=e.split(":");return{id:l.decode(n)+":"+r,rangeArr:t}}))}static encode(e){return c.dbEncryption.encode(e)}static decode(e){return c.dbEncryption.decode(e)}static getSizeFromRangeArr(e){return e.reduce(((e,t)=>e+l.getSizeFromRange(t)),0)}static getSizeFromResources(e){return e&&0!==e.length?s.DBController.isWriteResourceRes(e)?e.reduce(((e,t)=>e+t.byteLength),0):a.ResourceDocument.isResourceDocument(e)?e.reduce(((e,t)=>e+t.getSize()),0):e.reduce(((e,t)=>e+l.getSizeFromRangeArr(t.rangeArr)),0):0}static formatMs(e){if(e<=1e3)return`${e}ms`;if(e<=6e4)return`${Math.floor(e/1e3)}s`;const t=Math.floor(e/1e3);return`${Math.floor(t/60)}min${t%60}s`}static setLocalStorageV2(e,t,n){if("function"!=typeof t)return void localStorage.setItem(e,JSON.stringify(t));const r=d.default.getLocalStorage(e);if(null!==r)try{const n=JSON.parse(r);localStorage.setItem(e,JSON.stringify(t(n)))}catch(t){localStorage.setItem(e,JSON.stringify(n))}else localStorage.setItem(e,JSON.stringify(t))}static isContainRangarseRange);return n<=i&&r>=s}const[r,i]=l.parseRange(e);return r<=t&&i>=n}static getVideoType(e){try{const t=e.split(":")[1];return["Pugv","Pgc","Ugc"].includes(t)?t:"Unknown"}catch(e){return"Unknown"}}}l.SAVE_RESTRICTION="bp_nc_sr",l.localStorageMaxItem=10,l.resourceBlo64e5,t.DBUtils=l},8074:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AllDocument=t.ResourceDocument=t.BaseDocument=void 0;const r=n(3188);class i{constructor(e,t,n){this.id=e,this.rid=t,this.lastUpdatedTime=n}setLastUpdatedTime(e){return this.lastUpdatedTime=e,t.BaseDocument=i,t.ResourceDocument=class extends i{constructor(e,t,n){super(e,t,n),this.priority=-1,this.slices={},this.rangeArr=[]}getSize(){return Object.keys(this.slices).reduceeturn{id:r.DBUtils.decode(this.rid)+":"+this.id.split(":")[1],rid:r.DBUtils.decode(this.rid),rangeArr:this.rangeArr,byteLength:this.getSize()}}addSlice(e,t){return this.slices[e]=t,this.rangeArr.push(e),this}static isResourceDocument(e,t=!1){return Array.isArray(e)?!0===t?e.every((e=>e.id&&e.rid&&e.rangeArr&&e.slices)):e[0].id&&e[0].rid&&e[0].rangeArr&&e[0].slices:e.id&&e.rid&&e.rangeArr&&e.slices}},t.AllDocument=class extends i{constructor(e,t,n,r){super(e,t,n),void 0!==r&&(this.dbTotalSize=r)}setDbTotalSize(e){return this.dbTotalSize=e,this}getSize(){return this.dbTotalSize}}},4890:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorkshopEvent=void 0;class n{}n.TRACK="track",n.SOCKET_CONNECT="socket_connect",n.SOCKET_MESSAGE="socket_message",n.SOCKET_DISCONNECT="socket_disconnect",n.WEBRTC_ANSWER_TIMEOUT="webrtc_answer_timeout",n.WEBRTC_CHANNEL_OPEN_TIMEOUT="webrtc_channel_open_timeout",n.WEBRTC_CHTC_CHANNEL_OPEN="webrtc_channel_open",n.WEBRTC_GET_DATA_FAIL="webrtc_get_data_fail",n.WEBRTC_GET_DATA_TIMEOUT="webrtc_get_data_timeout",n.WEBRTC_OFFER_REJECTED="webrtc_offer_rejected",n.WEBRTC_SET_REMOTE_DESC="webrtc_set_remote_description";class r{}r.GET_DATA_SUCCESS="workshop_get_data_success",r.GET_DATA_FAIL="workshop_get_data_fail",t.WorkshopEvent=r,t.default=n},5199:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(9312).__importDefault(n(2204));t.default=class{constructor(){this.events=new r.default}on(e,t){var n;null===(n=this.events)||void 0===n||n.on(e,t)}off(e,t){var n;null===(n=this.events)||void 0===n||n.off(e,t)}trigger(e,...t){var n;null===(n=this.events)||void 0===n||n.trigger(e,...t)}destroy(){this.events&&(this.events.destroy(),this.events=new r.default)}}},2204:function(e,t,n){"use str(t,"__e1&&this.events[e].splice(n,1)}else this.events[e]=[]}trigger(e,...t){this.events[e]&&this.events[e].length&&[...this.events[e]].forEach((e=>{try{e(...t)}catch(e){i.default.getInstance().error(e)}}))}destroy(){this.events={}}}},1908:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.metadata=void 0,t.metadata={name:"browser-client",version:"2.13.0",hash:"4ad7fb8",branch:"Detached: 4ad7fb82e1d1eec36e795d0db606ed6f8e2253b1",lastModified:"Wed Nov 22 2023 06:35:43 GMT+0000 (Coordinated Universal Time)",mode:"production"}},5761:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(9312),i=r.__importDefault(n(1788)),s=r.__importDefault(n(2827)),o=r.__importDefault(n(2204)),a=n(208),c=r.__importDefault(n(4890)),d=r.__importDefault(n(5862)),l=n(7535),u=n(2337),h=n(1380),p=n(7639),f=n(8663);t.default=class{constructor(e){this.sdk=e,this.getPeerInfoTimeout=2e3,this.localRecord=new p.LocalRecord(this.sdk),this.disableAllRNCTimer=0,this.canReconnect=!0,this.init()}init(){var e;this.events=new o.default;let t=1e4;i.default.BROWSER_ENV===l.RUNTIME_MODE.DEV&&(t=3e3);let n={buvid:this.sdk.config.buvid?this.sdk.config.buvid:"",sdkVersion:d.default.getInstance().version.split("-")[0]+":leecher",aid:""+this.sdk.config.aid,cid:""+this.sdk.config.cid,sessionid:this.sdk.config.sessionid,mid:this.sdk.config.mid+""};this.sdk.config.isAdmin&&(n.isAdmin="1"),this.sdk.config.debugKey&&(n.debugKey=this.sdk.config.debugKey),"chromium"!==(null===h.browserInfo||void 0===h.browserInfo?void 0:h.browserInfo.name)&&(n.bkt="1");const r=this.sdk.config.duration>0?this.sdk.config.duration:0;n.duration=""+r,n.testID=String((null===(e=window.webAbTest)||void 0===e?void 0:e.nc_test)||0),this.socket=(0,a.io)(this.getSocketURL(),{autoConnect:!1,reconnectionAttempts:3,reconnectionDelay:t,reconnectionDelayMax:6e4,transports:["websocket"],secure:!0,parser:f,query:n}),this.createSocket("connect").on((()=>{this.countOuterTraffic(),this.countInnerTraffic(),s.default.getInstance().log(this.socket.id+" connect success"),this.socketID=this.socket.id,this.sdk.saveAndGetDataSwitch=!0,this.sdk.saveDataBuvidSwitch=!0,this.trigger(c.default.SOCKET_CONNECT)}));const u=()=>{this.trigger(c.default.SOCKET_DISCONNECT),this.socketID="",this.sdk.saveAndGetDataSwitch=!1,this.sdk.saveDataBuvidSwitch=!1,this.sdk.disableGetData=!0};this.createSocket("disconnect").on((e=>{s.default.getInstance().log("socket disconnect",e),u()})),this.createSocket("connect_error").on((e=>{s.default.getInstance().log("connection is refused",e.message),u()})),this.createSocket("error").on((e=>{s.default.getInstance().log("connection error",e.message),u()})),this.createSocket("message").on((e=>{e&&e.fromSocketID&&("trackerVersion"===e.type?(this.sdk.trackerVersion=e.version,s.default.getInstance().log(`tracker version is: ${this.sdk.trackerVersion}`)):"enableGetData"===e.type&&(this.sdk.disableGetData=!1,s.default.getInstance().log(`tracker enable getData, aid is ${this.sdk.config.aid}, cid is ${this.sdk.config.cid}`)),this.trigger(c.default.SOCKET_MESSAGE,e))})),this.socket.connect()}getSocketURL(){let e=this.sdk.config.socketUrl;i.default.BROWSER_ENV===l.RUNTIME_MODE.PRE&&(e="wss://pre-web-player-tracker.biliapi.net");try{const t=JSON.parse(i.default.getLocalSettings("bp_nc_config"));(null==t?void 0:t.socketURL)&&"string"==typeof t.socketURL&&(e=t.socketURL)}catch(e){}return e}on(e,t){var n;null===(n=this.events)||void 0===n||n.on(e,t)}off(e,t){var n;null===(n=this.events)||void 0===n||n.off(e,t)}trigger(e,...t){var n;null===(n=this.events)||void 0===n||n.trigger(e,...t)}getPeerInfo(e,t,n){return new Promise(((r,o)=>{var a,c;if(!e||!t||!(null===(a=this.socket)||void 0===a?void 0:a.connected))return o({code:40001,msg:"no valid peer, getPeerInfo sdk internal error"}),void s.default.getInstance().warn(`[getPeerInfo] rid: ${e}, sliceRange: ${t}, connected: ${null===(c=this.socket)||void 0===c?void 0:c.connected}`);let d,l=window.setTimeout((()=>{var t;l=0,o({code:40004,msg:"no valid peer, getPeerInfo timeout"}),null===(t=this.localRecord)||void 0===t||t.getRecord("noPeer").updateRecord(e)}),this.getPeerInfoTimeout);switch(!0){case this.localRecord.getRecord("openFail").isBrowserPeerRejected:case this.localRecord.getRecord("donation").isDonationDisabled(e):case!this.canUseRealP2P(e):d=1;break;case this.sdk.config.enableDonation:d=5;break;default:d=1}const{normalShouldResNum:u,donationShouldResNum:h}=this.getResPeerNum(n,d,e);h>0&&(this.sdk.newTrack.otherStat.getPeerContainingDonation++,this.sdk.state.otherStat.getPeerContainingDonation++,this.sdk.newTrack.addRIDRtcStats(e,"getPeerContainingDonation",1),this.sdk.newTrack.addRIDRtcStats(e,"getPeersCountDonation",h)),this.sdk.newTrack.addRIDRtcStats(e,"getPeersCountNormal",u),this.createSocket("getPeerInfoV5").emit(e,t,"",n,d,{NPM:u,DPM:h},(t=>{const n=null==t?void 0:t.peers;if(null==n?void 0:n.length){this.countISPStat(n);let t=0,r=0;n.forEach((e=>{(null==e?void 0:e.id)&&("browser"===i.default.getPeerTarget(e.id)?r++:t++)})),this.sdk.newTrack.addRIDRtcStats(e,"gotPeersCount_br",r),this.sdk.newTrack.addRIDRtcStats(e,"gotPeersCount_box",t),this.sdk.newTrack.addRIDRtcStats(e.newTrack.addRIDRtcStats(e,"gotPeerCount_box",1),h>0&&r>0&&this.sdk.newTrack.addRIDRtcStats(e,"gotPeerCountContainingDonation",1),h>0&&r<1&&(this.sdk.newTrack.otherStat.donationNoPeer++,this.sdk.state.otherStat.donationNoPeer++)}if(l){if(s.default.getInstance().log(`[getPeerInfo] rid: ${e} res:`,t),window.clearTimeout(l),l=0,[25e3,25001,2e3].includes(t.code))t.dispatchTime=Date.now(),r(t);else{if(51003===t.code&&!this.disableAllRNCTimer){const e=6e4+30*Math.random()*1e3;this.disableAllRNCTimer=window.setTimeout((()=>{this.disableAllRNCTimer=0}),e)}o(t)}this.localRecord.getRecord("donation").updateRecord(e,d,t),this.localRecord.getRecord("noPeer").updateRecord(e,null==t?void 0:t.peers)}else if(null==n?void 0:n.length)for(let t=0;t<n.length;t++){const r=n[t];(null==r?void 0:r.id)&&this.releasePeerInfo(r.id,e)}}))natePeerSingleBitrate:r,donatePeerMaxNum:i,donatePeerMinBitrate:s,normalPeerSingleBitrate:o,normalPeerMaxNum:a}=this.sdk.config.fawkesConfig,c=Math.ceil(e/o)||1;let d=0;return 5===t&&(d=e>=s?Math.ceil(e/r)||1:0),{normalShouldResNum:Math.min(c,a),donationShouldResNum:Math.min(d,i)}}canUseRealP2P(e){const t=parseInt(i.default.getQnAndCid(e).qn);return t>0&&this.sdk.config.realP2PUsageRestriction.qn.some((e=>t>e[0]&&t<=e[1]))}countISPStat(e){const t=i.default.getISPFromSid(this.socketID);if(t)for(const n of e.map((e=>i.default.getISPFromSid(e.id))).filter(i.default.nonNullable)){const e=this.sdk.state.weightStat;switch(n){case"1":e.ChinaTelecomNum++;break;case"2":e.ChinaUnicomNum++;break;case"3":e.ChinaMobileNum++;break;default:e.OtherISPNum++}n===t?this.sdk.state.weightStat.sameISPNum++:this.sdk.state.weightStat.notSameISPNum++}}countInnerTraffic(){try{this.socket.io.engine.transport.ws.addEventListener("message",(e=>{e.data instanceof ArrayBuffer&&(this.sdk.newTrack.otherStat.innerTraffic+=e.data.byteLength)}))}catch(e){s.default.getInstance().error("[countInnerTraffic] error:",e)}}countOuterTraffic(){try{const e=WebSocket.prototype.send,t=this;Object.assign(this.socket.io.engine.transport.ws,{send(n){return n instanceof ArrayBuffer&&(t.sdk.newTrack.otherStat.outerTraffic+=n.byteLength),e.call(this,n)}})}catch(e){s.default.getInstance().error("[countOuterTraffic] error:",e)}}releasePeerInfo(e,t){var n;(null===(n=this.socket)||void 0===n?void 0:n.connected)&&this.createSocket("releasePeerInfo").emit(e,t)}sendMessage(e,t){var n;(null===(n=this.socket)||void 0===n?void 0:n.connected)&&this.createSocket("message").emit(e,t)}reportResource(e,t,n){var r;if(e&&(null==t?void 0:t.length)&&(null===(r=this.socket)||void 0===r?void 0:r.connected))return this.createSocket("report").emit(e,t,2,n),this.sdk.state.dbStat.reportTotalSize+=n,void this.sdk.state.dbStat.reportSuccess++;this.sdk.state.dbStat.reportFailure++}reportRTCState(e,t,n,r){var i;(null===(i=this.socket)||void 0===i?void 0:i.connected)&&this.createSocket("reportRTCState").emit(e,t,n,r)}reportBadCPeerSID(e){var t;(null===(t=this.socket)||void 0===t?void 0:t.connected)&&this.createSocket("RBCPS").emit(e)}getNodeVar(e,t){var n;(null===(n=this.socket)||void 0===n?void 0:n.connected)&&this.createSocket("getVar").emit(e,t)}hotPushToTracker(e,t){var n;(null===(n=this.socket)||void 0===n?void 0:n.connected)&&this.createSocket("hotPushToTracker").emit(e,t)}reportStatToTracker(e,t){var n;(null===(n=this.socket)||void 0===n?void 0:n.connected)&&("sendSuccessBytes"!==e?this.sdk.reportToTrackerEnabled&&this.createSocket("reporet.off("connect"),this.socket.off("disconnect"),this.socket.off("message"),this.socketID="",this.socket.disconnect(),this.socket=null),this.events&&(this.events.destroy(),this.events=null),this.localRecord&&(this.localResableAllRNCTimer&&(window.clearTimeout(this.disableAllRNCTimer),this.disableAllRNCTimer=0),this.socketConnectTimer&&(window.clearTimeout(this.socketConnectTimer),this.socketConnectTimer=0)}disccanReconnect&&this.sdk.config.homepage&&(this.socket.connected||(this.canReconnect=!1,this.socket.connect()),clearTim((()=>{this.canReconnect=!0,this.disconnect()}),3e5))}}},2827:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LOG_LEVEL=void 0;const r=n(9312),i=r.__importDefault(n(5862)),s=r.__importDefault(n(1788));var o;!function(e){e[e.NONE=0]="NONE",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARNING=3]="WARNING",e[e.ERROR=4]="ERROR"}(o=t.LOG_LEVEL||(t.LOG_LEVEL={}));class a{constructor(e=""){this.namespace=e,this.state={level:o.INFO,historyList:[]}}static getInstance(){return a.instance||(a.instance=new a),a.instance}setLevel(e){this.state.level=e}debug(e,...t){this.baseLog([e,...t],o.VERBOSE)}log(e,...t){this.baseLog([e,...t],o.INFO)}logNoRecord(e,...t){this.baseLog([e,...t],o.INFO,!1)}warn(e,...t){this.baseLog([e,...t],o.WARNING)}error(e,...t){this.baseLog([e,...t],o.ERROR)}baseLog(e,t=o.INFO,n=!0){const r=new Date,c={level:t,time:`${r.getMonth()+1}/${r.getDate()} ${r.toTimeString().substr(0,8)}.${r.getMilliseconds()}`,timeStamp:r.getTime(),msgArr:e};let d;try{d=JSON.parse(s.default.getLocalStorage("bp_nc_config")||"{}").showNCLog}catch(e){console.log("bp_nc_config error",e)}if(n){const t=JSON.stringify(e);t.length<5e3?this.state.historyList.push(c):d&&console.warn(`---big log: ${t}`),this.state.historyList.length>=a.MAX_LOG_LENGTH&&this.state.historyList.shift()}if(c.level>=this.state.level&&1===d){const t=`[v${i.default.getInstance().version}]-[${c.time}]`;switch(c.level){case o.WARNING:console.warn(t,...e);break;case o.ERROR:console.error(t,...e);break;case o.VERBOSE:console.debug(t,...e);break;default:console.log(t,...e)}}}getHistory(e=o.INFO){let t="";return this.state.historyList.forEach((n=>{n.level>=e&&(t+=`\n[BPNC ${this.namespace} ${n.time}] ${JSON.stringify(n.msgArr)}`)})),t}reset(){this.state={level:o.INFO,historyList:[]}}}a.MAX_LOG_LENGTH=1e3,t.default=a},4932:function(e,t){"use strirty(t,"__esModule",{value:!0}),t.PromiseQueue=void 0,t.PromiseQueue=class{constructor(e){this._queue=[],this.isPending=!1,this.lastFulfillTime=null,this.dequeueTimer=null,this.config=Object.assign({interval:0},e)}enqueue(e,t=!1){return new Promise(((n,r)=>{this._queue[t?"unshift":"push"]({promiseMaker:e,resolve:n,reject:r}),this._dequeue()}))}_dequeue(){if(this.isPending)return;if(null!==this.lastFulfillTime){const e=Date.now()-this.lastFulfillTime;if(e<this.config.interval)return void(this.dequeueTimer=window.setTimeout((()=>{this._dequeue()}),this.config.interval-e))}const e=this._queue.shift();if(e)try{this.isPending=!0,e.promiseMaker().then(this.afterFulfill.bind(this,e,"resolve")).catch(this.afterFulfill.bind(this,e,"reject"))}catch(t){this.afterFulfill(e,"reject",t)}}afterFulfill(e,t,n){this.lastFulfillTime=Date.now(),this.isPending=!1,e[t](n),this._dequeue()}destroy(){this._queue=[],this.isPending=!1,this.dequeueTimer&&window.clearTimeout(this.dequeueTimer)}}},1788:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VideoType=void 0;const r=n(9312),i=n(1908),s=n(7535),o=r.__importDefault(n(5862)),a=n(652);class c{static bindAll(e,t){for(let n=0;n<e.length;n+=1)t[e[n]]&&(t[e[n]]=t[e[n]].bind(t))}static cloneDeep(e,t){if(null===e||"object"!=typeof e)return e;let n;if(c.isTypedArray(e)&&"function"==typeof e.slice)return n=e.slice(),n;n=Array.isArray(e)?[]:{};for(const r in e)if(Object.prototype.hasOwnProperty.call(e,r)){const i=e[r];n[r]=t&&"object"==typeof i?c.cloneDeep(i,t):i}return n}static isTypedArray(e){return!!(e&&e.buffer instanceof ArrayBuffer&&e.BYTES_PER_ELEMENT)}static downloadFile(e,t){let n=document.createElement("a"),r=t.slice&&"data:"===t.slice(0,5),i=t.lastIndexOf&&t.lastIndexOf(".")>-1;n.download=e,n.style.display="none",n.href=i||r?t:URL.createObjectURL(new Blob([t])),document.body.appendChild(n),n.click(),document.body.removeChild(n)}static concatArrayBuffer(e,t){if(!e)return t;if(!t)return e;let n=new Uint8Array(e.byteLength+t.byteLength);return n.set(new Uint8Array(e),0),n.set(new Uint8Array(t),e.byteLength),n.buffer}static concatUint8Array(e,t){if(!e)return t;if(!t)return e;let n=new Uint8Array(e.byteLength+t.byteLength);return n.set(e,0),n.set(t,e.byteLength),n}static encodeUTF8(e){const t=encodeURIComponent(e),n=[];for(let e=0;e<t.length;e++){const r=t.charAt(e);if("%"===r){const r=t.charAt(e+1)+t.charAt(e+2),i=parseInt(r,16);n.push(i),e+=2}else n.push(r.charCodeAt(0))}return new Uint8Array(n)}static decodeUTF8(e){let t="";for(let n=0;n<e.byteLength;n++)t+="%"+e[n].toString(16);return decodeURIComponent(t)}static isSupportP2ection||window.webkitRTCPeerConnection,n=null===(e=window.RTCDataChannel)||void 0===e?void 0:e.prototype.send;return!!(window.indexedDB&&(null==t?void 0:t.prototype.createDataChannel)&&n&&c.checkLocalStorage())}catch(e){return!1}}static getCookie(e){if(null==e)return"";const t=document.cookie.split(";"),n=decodeURIComponent(e);for(let e=0;e<t.length;e++){const[r,i]=t[e].trim().split("=");if(decodeURIComponent(r)===n)return decodeURIComponent(i)}return""}static getLocalSettings(e){return c.getLocalStorage(e)?c.getLocalStorage(e):c.getCookie(e)}static getLocalStorage(e){return localStorage[e]&&"getItem"!==e?localStorage[e]:localStorage.getItem(e)}static setLocalStorage(e,t){localtem(e,JSOgify(t))}static randomStrinopqrstuvwxyz".split(""),n=t.length,r=[];forst e=Math.floor(Math.random()*n);r.push(t[e])}return r.join("")}static get BROWSER_ENV(){return window.ldes("pre-")?s.RUNTIME_MODE.PRE:i.metadata.mode}static getQnAndCid(e){const t=e.split(/t){try{return[null,e(...t)]}catch(e){return[e]}}static tryCatchAsync(e){return e.then((e=>[null,e])).catch((e=>[e]))}static checkLocalStorage(){try{return c.getLocalStorage("happy"),!0}catch(e){return!1}}static getAttrsOfObj(e,t){return t?t.reduce(((.atic omitAttrsOfObj(e,t){return Object.fromEntries(Object.entries(e).filter((([e])=>!t.includes(e))))}static getSuffixObj(e,t){return Object.keys(e).reduce(((n,r)=>(n[r+t]=e[r],n)),{})}static onBeforeUnload(e){window.addEventListener("beforeunload",e)}static isObject(e){return"[object Object]"===Object.prototype.toString.call(e)}static getPeerTarget(e){return e?parseInt(e.split(":")[1])===s.DEVICE_TYPE.BOX?"bo((e=>e===t?"pending":"fulfilled"),(()=>"rejected"))}static configureLog(){const e=new Date,t=`LeecherLog-[v${o.default.getInstance().version}]-[${e.toTimeString().slice(0,8)}-${e.getTime()}]`;return Object.assign({baseLog:t},a.PCDNUtils.getPCDNConfig())}static pLog(...e){const t=["color: #fff","background-color: #ee89b3","padding: 2px 4px","border-radius: 2px"],{baseLog:n,showLeecherLog:r}=c.configureLog();r>=1&&console.log("%cPCDN Logs",t.join(";"),n,...e)}static isEmpty(e){return null==e}static noop(){}static nonNullable(e){return null!=e}static getISPFromSid(e){var t;return null===(t=e.split(":")[4])||void 0===t?void 0:t.slice(-1)}static retry(e){const{action:t,times:n,beforeRetry:r=(()=>{})}=e;return new Promise(((i,s)=>{t().then(i).catch((t=>{1===n?s(t):(r(),c.retry(Object.assign(Object.assign({},e),{times:n-1})).then(i,s))}))}))}static splitRid(e){let{groups:{cid:t,barrier:n,qn:r}}=/^(?<cid>\d+)(?<barrier>[-_].*[-_])(?<qn>\d+)\.m4s$/g.exec(e);return{cid:Number(t),barrier:n,qn:Number(r)}}static =new Map;return t.forEach(((t,r)=>{const s=n(t,r),o=e.get(s);o?o.push(i(t,r)):e.set(s,[i(t,r)])})),e}const s={};return t.forEach(((e,t)=>{const r=n(e,t);(s[r]||(s[r]=[])).push(i(e,t))})),s}static tmpLog(...e){console.log("%cTemp Logs",["color: #fff","background-color: #3f8df8","padding: 2px 4px","border-radius: 2px"].join(";"),...e)}static getVideoType(e){if("string"!=typeof e)return d.Unknown;const t=e.split(":")[1];return Object.keys(t).find((e=>e===t))||d.Unknown}}var d;!function(e){e.Pugv="Pugv",e.Pgc="Pgc",e.Ugc="Ugc",e.Unknown="Unknown"}(d=t.VideoType||(t.VideoType={})),t.default=c},7657:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WebRTCBase=void 0;const r=n(9312),i=n(2337),s=r.__importDefault(n(2204)),o=r.__importDefault(n(2827)),a=r.__importDefault(n(1788));t.WebRTCBase=class{constructor(e,t,n,r,i){this.isSameIP=!1,this.maxMessageSize=64e3,this.isDestroyed=!1,this.isOpen=!1,this.hasLocalDescription=!1,this.hasRemoteDescription=!1,this.hasReceivedRemoteCandidate=!1,this.hasAddCandidateSuccess=!1,this.hasReceivedLocalCandidate=!1,this.storedCandidates=[],a.default.bindAll(["onSetRemoteDescription"],this),this.events=new s.default,this.sdk=e,this.socketController=t,this.cPeerSocketID=n,this.isSameIP=r,this.path=i,this.peerTarget=a.default.getPeerTarget(n),this.rtcStat=this.sdk.state.rtcStat}init(){const e=this.sdk.config.fawkesConfig.iceServersUrlsWithVendors[this.sdk.config.vendor]||["stun:hw-v2-web-player-tracker.biliapi.net:3478"];let t=Object.assign({iceServers:[{urls:e}]},"seeder"===this.identity?{iceCandidatePoolSize:1}:void 0);this.peerConnection=new RTCPeerConnection(t),this.sdk.state.addBoxOrBrowserStat("webrtcInitedCount",1,this.peerTarget),this.peerConnection.onicecandidate=e=>{var t,n;if(!this.dataChannel||"connecting"===(null===(t=this.dataChannel)||void 0===t?void 0:t.readyState))if(e.candidate){if("seeder"===this.identity&&(this.hasReceivedLocalCandidate=!0),this.filterIceCandidate(e.candidate))return;const t=this.createCandidateMessage(e.candidate);null===(n=this.socketController)||void 0===n||n.sendMessage(this.cPeerSocketID,t),o.default.getInstance().log("--------onicecandidate",this.cPeerSocketID,t)}else o.default.getInstance().log(`End of candidates, cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}`)}}createCandidateMessage(e){const{cid:t,barrier:n,qn:r}=a.default.splitRid(this.path);return(0,i.createMessage)("ca",{c:t,b:n,q:r,d:JSON.stringify(e)})}onSetRemoteDescription(){var e;"seeder"===this.identity&&(null===(e=this.socketController)||void 0===e||e.reportStatToTracker("addCandidateAfterRD")),this.storedCandidates.forEach((e=>this.addIcecandidate(e)))}filterIceCandidate(e){if(this.isSameIP)return!1;try{if("host"===(null==e?void 0:e.type))return!0}catch(e){o.default.getInstance().warn(`${this.path} filterIceCandidate filter error: `+e)}return!1}dataChannelRemoveEvent(){this.dataChannel&&(this.dataChannel.onmessage=null,this.dataChannel.onopen=null,this.dataChannel.onclose=null)}on(e,t){var n;null===(n=this.events)||void 0===n||n.on(e,t)}off(e,t){var n;null===(n=this.events)||void 0===n||n.off(e,t)}trigger(e,...t){var n;null===(n=this.events)||void 0===n||n.trigger(e,...t)}destroy(){var e;"seeder"!==this.identity||this.hasReceivedLocalCandidate||null===(e=this.socketController)||void 0===e||e.reportStatToTracker("destroyedTooEarly"),o.default.getInstance().log(`${this.path} webRTCController destroy -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}`),this.isDestroyed=!0,this.maxMessageSize=64e3,tasReceivedLocalCandidate=!1,this.hasAddCandidateSuccess=!1,this.storedCandidates=[],this.cPeerSocketID="",this.socketController=null,this.sdk=null,this.dataChannel&&(this.dataChannelRemoveEvent(),this.dataChannel.close(),this.dataChannel=null),this.peerConnection&&(this.peerConnection.ondatachannel=null,this.peerConnection.onicecandi=null),this.events&&(this.events.destroy(),this.events=null)}get dataChannelState(){var e;return null===(e=this.dataChannel)||void 0===e?void 0:e.readyState}addIcecandidate(e){var t,n;if("open"===(null===(t=this.dataChannel)||void 0===t?void 0:t.readyState))return;this.hasReceivedRemoteCandidate=!0;let r=JSON.parse(e.data),i=new RTCIceCandidate(r);this.sdk.state.addBoxOrBrowserStat("addIceCandidate",1,this.peerTarget),null===(n=this.peerConnection)||void 0===n||n.addIceCandidate(i).then((()=>{this.isDestroyed||(this.hasAddCandidateSuccess=!0)}),(e=>{this.isDestroyed||(this.sdk.state.addBoxOrBrowserStat("addIceCandidateErr",1,this.peerTarget),o.default.getInstance().warn(`${this.path} webRTCController addIceCandidate error -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}, error: ${e.toString()}`))})).catch((e=>{this.isDestroyed||(this.sdk.state.addBoxOrBrowserStat("addIceCandidateErr",1,this.peerTarget),o.default.getInstance().warn(`${this.path} webRTCController addIceCandidate error -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}, error: `+e))}))}}},3206:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WebRTCFactory=void 0;const r=n(9312),i=r.__importDefault(n(4890)),s=n(4290),o=n(3188),a=r.__importDefault(n(1788));t.WebRTCFactory=class{constructor(e,t,n){this.sdk=e,this.socketController=t,this.dbController=n,a.default.bindAll(["ontat,this.webrtcWorkshop2=new s.WebrtcWorkshop(this.sdk,this.socketController),this.socketController.on(i.default.SOCKET_MESSAGE,this.onSocketMessage)}onSocketMessage(e){if("trackerVersion"===(null==e?void 0:e.type)&&this.sdk.saveDataEnabled)return o.DBUtils.happyLog("æ”¶åˆ°trackerVersionæ¶ˆæ¯äº†, ä¸”å…è®¸å­˜å‚¨"),void this.dbController.initDB()}getData(e){const{path:t,rangeStart:n,rangeEnd:r,token:i,bitrate:s,latency:o,startTime:a,duration:c}=e;return this.webrtcWorkshop2.getData(t,{start:n,end:r},i,c,s,o,a)}abortGetData(e){this.webrtcWorkshop2.abortGetData(e)}destroy(){var e,t,n;null===(e=this.webrtcWorkshop2)||void 0===e||e.destroy(),null===(n=null===(t=this.socketController)||void 0===t?void 0:t.off)||void 0===n||n.call(t,i.default.SOCKET_MESSAGE,this.onSocketMessage),delete this.webrtcWorkshop2,delete this.sdk,delete this.socketController,delete this.dbController}}},2636:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WebRTCLeecher=void 0;const r=n(9312),i=n(2337),s=r.__importDefault(n(4890)),o=r.__importDefault(n(2827)),a=r.__importDefault(n(1788)),c=n(7657),d=n(990);class l extends c.WebRTCBase{constructor(e,t,n,r,i,o,c,d,l){super(e,t,n,r,o),this.isSMid=i,this.needDataByte=0,this.receivedDataByte=0,this.tempPassageByteLength=0,this.saveRangeIndex=0,this.heartbeatTime=2e3,this.dataChannelOpenTimer=0,this.dataChannelOpenTimeout=this.sdk.config.fawkesConfig.leecherChannelOpenTimeout,this.dataChannelMessageTimeoutTimer=0,this.dataChannelMessageTimeout=3500,this.isSucking=!1,a.default.bindAll(["onSocketMessage"],this),this.identity="leecher",this.index=c,this.uuid=d,this.webrtcStore=l,this.socketController.on(s.default.SOCKET_MESSAGE,this.onSocketMessage),this.init()}init(){o.default.getInstance().log(`init ${this.path} index: ${this.index} WebRTCLeecher -- cSid: ${this.cPeerSocketID}`),super.init(),this.dataChannel=this.peerConnection.createDataChannel("receiveDataChannel",Object.assign({ordered:!0},"browser"===this.peerTarget?{negotiated:!0,id:0}:null)),this.dataChannel.binaryType="arraybuffer",this.dataChannelBindEvent()}dataChannelBindEvent(){this.dataChannel.onmessage=e=>{var t,n,r,i,a,c,d,l,u,h,p,f,m;if(!this.leecherGetDataParam)return void(null===(t=this.getDataOnReject)||void 0===t||t.call(this,{code:42e3,msg:"webRTC onmessage no getDataInternalParam",responseData:this.makeResponseData()}));if(this.createDataChannelMessageTimeout(),o.default.getInstance().log(`[onDataChannelMessage] ${this.path} index: ${this.index} cSid: ${this.cPeerSocketID}, label: ${this.dataChannel.label}`,"string"==typeof e.data?e.data:e.data.byteLength),this.leecherGetDataParam.prefetch){if("string"==typeof e.data){if(!isNaN(Number(e.data)))return this.saveRangeIndex=this.leecherGetDataParam.allocatedIndex,void(this.needDataByte=Number(e.data));o.default.getInstance().log(`[heartbeat] ${this.path} index: ${this.index} webRTCController heartbeat -- cPeerSocketID: ${this.cPeerSocketID}, isPaused: ${this.isPaused}`),this.isPaused&&"pending"===this.webrtcStore.detectActiveBuffer(this.path)&&this.webrtcStore.resumeSend(this.path,this.cPeerSocketID,!0),this.heartbeatTimer||(this.heartbeatTimer=setTimeout((()=>{o.default.getInstance().log(`${this.path} index: ${this.index} webRTCController heartbeat stop -- cPeerSocketID: ${this.cPeerSocketID}, isPaused: ${this.isPaused}`),this.isPaused||this.trigger(s.default.WEBRTC_CHANNEL_CLOSE,this.cPeerSocketID,this.path,this.index)}),this.heartbeatTime))}else{if(clearTimeout(this.heartbeatTimer),this.heartbeatTimer=setTimeout((()=>{o.default.getInstance().log(`${this.path} index: ${this.index} webRTCController heartbeat stop -- cPeerSocketID: ${this.cPeerSocketID}, isPaused: ${this.isPaused}`),!this.isPaused&&this.webrtcStore.getReceivedLastDataCount(this.path)<5&&this.trigger(s.default.WEBRTC_CHANNEL_CLOSE,this.cPeerSocketID,this.path,this.index)}),this.heartbeatTime),!this.needDataByte)return void o.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController received invalid buffer -- cSid: ${this.cPeerSocketID}`);const t=new Uint8Array(e.data);t.byteLength!==this.leecherGetDataParam.allocatedByteLength?(this.webrtcStore.setReceivedLastDataCount(this.path,1),o.default.getInstance().error("[onDataChannelMessage-error]",this.path,e.data)):this.webrtcStore.setReceivedLastDataCount(this.path,0),this.addRIDRtcStats(),this.isPaused=!1,this.receivedDataByte+=t.byteLength,this.tempPassageByteLength+=t.byteLength,this.tempPassageByteLength>=this.leecherGetDataParam.prefetch&&(this.isPaused=!0,this.tempPassageByteLength=0),this.webrtcStore.saveArrayBuffer(this.path,this.cPeerSocketID,t,this.leecherGetDataParam.originRange.start,this.saveRangeIndex,this.leecherGetDataParam.allocatedByteLength),this.saveRangeIndex+=this.leecherGetDataParam.totalPeerCount}return}const g=this.leecherGetDataParam.useRange.end-this.leecherGetDataParam.useRange.start+1;if("string"==typeof e.data){const t=parseInt(e.data,10);return this.needDataByte=parseInt(e.data,10),t!==g?(o.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController received invalid totalSize -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}, totalSize: ${t}`),null===(n=this.getDataOnReject)||void 0===n||n.call(this,{code:42001,msg:`${this.path} webRTCController received invalid totalSize`,responseData:this.makeResponseData()}),void this.trigger(s.default.WEBRTC_GET_DATA_FAIL,this.cPeerSocketID,this.path,this.index)):this.receivedU8Buffer?(o.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController received totalSize after receivedU8Buffer -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}, totalSize: ${t}`),null===(r=this.getDataOnReject)||void 0===r||r.call(this,{code:42002,msg:`${this.path} webRTCController received totalSize after receivedU8Buffer`,responseData:this.makeResponseData()}),void this.trigger(s.default.WEBRTC_GET_DATA_FAIL,this.cPeerSocketID,this.path,this.index)):(this.receivedU8Buffer=new Uint8Array(parseInt(e.data,10)),this.receivedDataByte=0,void o.default.getInstance().log(`${this.path} index: ${this.index} webRTCController received totalSize -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}, totalSize: ${null===(i=this.receivedU8Buffer)||void 0===i?void 0:i.byteLength}`))}if(0===this.needDataByte)return void o.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController received invalid buffer -- cSid: ${this.cPeerSocketID}`);if(!this.receivedU8Buffer)return o.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController received data before received totalSize -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}`),null===(a=this.getDataOnReject)||void 0===a||a.call(this,{code:42003,msg:`${this.path} webRTCController received data before received totalSize`,responseData:this.makeResponseData()}),void this.trigger(s.default.WEBRTC_GET_DATA_FAIL,this.cPeerSocketID,this.path,this.index);let y=new Uint8Array(e.data);if(this.updateReceiveRtcStat(y.byteLength),!y.byteLength)return o.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController received 0 byte data -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}`),void(null===(c=this.getDataOnReject)||void 0===c||c.call(this,{code:42004,msg:`${this.path} webRTCController received 0 byte data`,responseData:this.makeResponseData()}));if(this.receivedDataByte+y.byteLength>g)return o.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController received data more than needed -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}`),null===(d=this.getDataOnReject)||void 0===d||d.call(this,{code:42005,msg:`${this.path} webRTCController received data more than needed`,responseData:this.makeResponseData()}),void this.trigger(s.default.WEBRTC_GET_DATA_FAIL,this.cPeerSocketID,this.path,this.index);if(this.receivedU8Buffer.set(y,this.receivedDataByte),this.addRIDRtcStats(),this.receivedDataByte+=y.byteLength,this.receivedDataByte===(null===(l=this.receivedU8Buffer)||void 0===l?void 0:l.byteLength)){if(o.default.getInstance().log(`${this.path} index: ${this.index} webRTCController received all data -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}, totalSize: ${null===(u=this.receivedU8Buffer)||void 0===u?void 0:u.byteLength}`),(null===(h=this.receivedU8Buffer)||void 0===h?void 0:h.byteLength)!==g)return null===(p=this.getDataOnReject)||void 0===p||p.call(this,{code:42006,msg:"WebRTC get data not enough",responseData:this.makeResponseData()}),o.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController received data not enough -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}, totalSize: ${null===(f=this.receivedU8Buffer)||void 0===f?void 0:f.byteLength}`),void this.trigger(s.default.WEBRTC_GET_DATA_FAIL,this.cPeerSocketID,this.path,this.index);null===(m=this.getDataOnResolve)||void 0===m||m.call(this,{code:24e3,msg:"success",responseData:this.makeResponseData()}),"browser"===this.peerTarget&&this.rtcStat.getSuccessFromBrowser++}},this.dataChannel.onopen=()=>{var e,t,n;if(this.isOpen=!0,this.trigger(s.default.WEBRTC_CHANNEL_OPEN,this.cPeerSocketID,this.path,this.index),this.dataChannelOpenTimer&&window.clearTimeout(this.dataChannelOpenTimer),"open"===(null===(e=this.dataChannel)||void 0===e?void 0:e.readyState)){const e=this.peerConnection.sctp;if(e&&e.maxMessageSize&&(this.maxMessageSize=e.maxMessageSize),o.default.getInstance().log(`${this.path} index: ${this.index} dataChannel open -- cSid: ${this.cPeerSocketID}, label: ${this.dataChannel.label}`),"browser"===this.peerTarget&&(null===(t=this.socketController)||void 0===t||t.reportStatToTracker("leecherDataChannelOpen")),this.sdk.state.addBoxOrBrowserStat("dataChannelOpen",1,this.peerTarget),this.leecherGetDataParam&&"box"===this.peerTarget){const e=this.createGetDataMessage(this.leecherGetDataParam);null===(n=this.socketController)||void 0===n||n.sendMessage(this.cPeerSocketID,e)}"browser"===this.peerTarget&&this.rtcStat.offerDataChannelOpenToBrowser++}},this.dataChannel.onclose=()=>{this.isOpen=!1,this.getDataOnReject?(this.getDataOnReject({code:40014,msg:"dataChannel Close",responseData:this.makeResponseData()}),this.trigger(s.default.WEBRTC_CHANNEL_CLOSE,this.cPeerSocketID,this.path,this.index)):this.trigger(s.default.WEBRTC_CHANNEL_CLOSE,this.cPeerSocketID,this.path,this.index,{code:40014,msg:"dataChannel Close"}),o.default.getInstance().log(`${this.path} index: ${this.index} webRTCController dataChannel closed -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}`)}}addRIDRtcStats(){var e,t;0===this.receivedDataByte&&("browser"===this.peerTarget?null===(e=this.sdk)||void 0===e||e.newTrack.addRIDRtcStats(this.path,"taskGotByteCount_br",1):null===(t=this.sdk)||void 0===t||t.newTrack.addRIDRtcStats(this.path,"taskGotByteCount_box",1))}changePeer(){var e;null===(e=this.getDataOnReject)||void 0===e||e.call(this,{code:41005,msg:"answer peer lose",responseData:this.makeResponseData()}),o.default.getInstance().log(`${this.path} index: ${this.index} answer peer lose -- cSid: ${this.cPeerSocketID}, WebRTC: ${this.identity}`)}createOffer(){var e;null===(e=this.peerConnection)||void 0===e||e.createOffer({offerToReceiveAudio:!1,offerToReceiveVideo:!1}).then((e=>{var t,n,r;if(this.isDestroyed)return;null===(t=this.peerConnection)||void 0===t||t.setLocalDescription(e).then((()=>{this.hasLocalDescription=!0,o.default.getInstance().log(`${this.path} index: ${this.index} webRTCController setLocalDescription success from createOffer -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}`)})).catch((e=>{o.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController createOffer setLocalDescription error -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}, errorMessage: ${""+e}`)})),o.default.getInstance().log(`${this.path} index: ${this.index} webRTCController setLocalDescription from createOffer -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}`);const i=this.createOfferMessage(e);"browser"===this.peerTarget&&(this.rtcStat.offerInitToBrowser++,null===(n=this.socketController)||void 0===n||n.reportStatToTracker("offerSent")),null===(r=this.socketController)||void 0===r||r.sendMessage(this.cPeerSocketID,i)}),(e=>{var t;"browser"===this.peerTarget&&(null===(t=this.socketController)||void 0===t||t.reportStatToTracker("createOfferErr")),this.isDestroyed||o.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController createOffer error -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}, error: ${e.toString()}`)})),this.createDataChannelOpenTimeout()}createOfferMessage(e){const{cid:t,barrier:n,qn:r}=a.default.splitRid(this.path);return(0,i.createMessage)("of",{c:t,b:n,q:r,d:"box"===this.peerTarget?d.SdpParser.minify(e.sdp,this.sdk.config.fawkesConfig.sdpReservedAttrs):JSON.stringify(e),sip:this.isSameIP})}createDataChannelMessageTimeout(){this.dataChannelMessageTimeoutTimer&&window.clearTimeout(this.dataChannelMessageTimeoutTimer),this.dataChannelMessageTnull===(e=this.getDataOnReject)||void 0===e||e.call(this,{code:40013,msg:"inner getData timeout",respger(s.default.WEBRTC_GET_DATA_TIMEOUT,this.cPeerSocketID,this.path,this.index)}),this.dataChannelMessageTimeout)}createDataChannelOpenTimeout(){this.dataChannelOpenTimer=window.setTimeout((()=>{this.trigger(s.default.WEBRTC_CHANNEL_OPEN_TIMEOUT,this.cPeerSocketID,this.path,this.index),this.dataChannelOpenTimer=0}),this.dataChannelOpenTimeout)}reset(){this.needDataByte=0,this.receivedDataByte=0,this.receivedU8Buffer=null}getReceivedU8Buffer(){return this.receivedU8Buffer}getReceivedDataByte(){return this.receivedDataByte}getNeedDataByte(){return this.needDataByte}getData(e){return new Promise(((t,n)=>{var r,i;if(this.isSucking=!0,this.leecherGetDataParam=e,this.saveRangeIndex=e.allocatedIndex,this.getDataOnResolve=e=>{t(e),this.dataChannelMessageTimeoutTimer&&window.clearTimeout(this.dataChannelMessageTimeoutTimer),this.isSucking=!1,this.receivedDataByte=0},this.getDataOnReject=e=>{n(e),this.dataChannelMessageTimeoutTimer&&window.clearTimeout(this.dataChannelMessageTimeoutTimer),this.isSucking=!1,this.receivedDataByte=0},this.reset(),!this.leecherGetDataParam)return void(null===(r=this.getDataOnReject)||void 0===r||r.call(this,{code:40006,msg:"webRTC getData data param invalid",responseData:this.makeResponseData()}));const s=this.createGetDataMessage(e);null===(i=this.socketController)||void 0===i||i.sendMessage(this.cPeerSocketID,s),o.default.getInstance().log(`[getDataSocketParams] ${this.path} index: ${this.index}`,s)}))}createGetDataMessage(e){const{cid:t,barrier:n,qn:r}=a.default.splitRid(e.rid),s={c:t,b:n,q:r,nd:{s:e.useRange.start,e:e.useRange.end,st:e.startTime}};return"box"===this.peerTarget?s.nd.l=e.latency:"browser"===this.peerTarget&&(s.nd.os=e.originRange.start,s.nd.oe=e.originRange.end),(0,i.createMessage)("gd",s)}onSocketMessage(e){var t,n,r;if(e&&e.fromSocketID&&e.fromSocketID===this.cPeerSocketID){if("offerRejected"===e.type){if(!e.rid||e.rid!==this.path)return;return o.default.getInstance().log(`${this.path} index: ${this.index} answer peer rejected offer -- cSid: ${this.cPeerSocketID}, ${e.msg}`),void this.trigger(s.default.WEBRTC_OFFER_REJECTED,this.cPeerSocketID,this.path,this.index,{code:e.code,msg:e.msg,responseData:this.makeResponseData()})}if(e.data)if("changePeerV2"!==e.type){if(e.rid&&e.rid===this.path){if("candidate"!==e.type)return"answer"===e.type?(o.default.getInstance().log(`${this.path} index: ${this.index} webRTCController received answer -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}`),void(null===(n=this.peerConnection)||void 0===n||n.setRemoteDescription("box"===this.peerTarget?d.SdpParser.assemble(e.data,"answer"):new RTCSessionDescription(JSON.parse(e.data))).then((()=>{this.hasRemoteDescription=!0,o.default.getInstance().log(`${this.path} index: ${this.index} webRTCController received answer setRemoteDescription success from createOffer -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}`)})).catch((e=>{this.sdk.state.addBoxOrBrowserStat("setRemoteDescErr",1,this.peerTarget),o.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController received answer setRemoteDescription error -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}, errorMessage: ${""+e}`)})))):"getDataFail"===e.type||"getDataFromDBFail"===e.type?(o.default.getInstance().log(`${this.path} index: ${this.index} answer peer get data fail -- cSid: ${this.cPeerSocketID}, ${e.msg}`),null===(r=this.getDataOnReject)||void 0===r||r.call(this,{code:e.code,msg:e.msg,responseData:this.makeResponseData()}),void this.trigger(s.default.WEBRTC_GET_DATA_FAIL,this.cPeerSocketID,this.path,this.index)):void 0;"box"!==this.peerTarget&&1!==e.s||(o.default.getInstance().log("--------leecher onSocketMessage",this.cPeerSocketID,e),super.addIcecandidate(e))}}else(null===(t=e.rids)||void 0===t?void 0:t.length)&&e.rids.includes(this.path)&&this.changePeer()}}updateReceiveRtcStat(e){if(this.rtcStat.receivedByteTotal+=e,"browser"===this.peerTarget){this.rtcStat.receivedByteFromBrowser+=e,this.sdk.newTrack.rtcStat.receivedByteFromBrowser+=e,this.sdk.newTrack.addRIDRtcStats(this.path,"receivedByte_br",e);const t=this.sdk.newTrack.rtcStat.ridReceivedByteFromBrowser;t&&(t[this.path||""]=(t[this.path||""]||0)+e);const n=this.sdk.newTrack.rtcStat.sidReceivedByteFromBrowser;n&&(n[this.cPeerSocketID||""]=(n[this.cPeerSocketID||""]||0)+e)}else"box"===this.peerTarget&&(this.rtcStat.receivedByteFromBox+=e,this.sdk.newTrack.addRIDRtcStats(this.path,"receivedByte_box",e))}makeResponseData(){var e,t,n,r,i,s,o,a,c,d;return{range:(null===(e=this.leecherGetDataParam)||void 0===e?void 0:e.originRange.start)+"-"+(null===(t=this.leecherGetDataParam)||void 0===t?void 0:t.originRange.end),useRange:null===(n=this.leecherGetDataParam)||void 0===n?void 0:n.useRange,originRange:null===(r=this.leecherGetDataParam)||void 0===r?void 0:r.originRange,from:0,path:null!==(s=null===(i=this.leecherGetDataParam)||void 0===i?void 0:i.rid)&&void 0!==s?s:this.path,getDataTime:Date.now()-(null===(o=this.leecherGetDataParam)||void 0===o?void 0:o.startTime),startTime:null===(a=this.leecherGetDataParam)||void 0===a?void 0:a.startTime,uint8:this.receivedU8Buffer,gotDataByte:this.receivedDataByte,rtcDataChannelState:this.dataChannelState,cPeerSID:this.cPeerSocketID,latency:null===(c=this.leecherGetDataParam)||void 0===c?void 0:c.latency,retryCount:null===(d=this.leecherGetDataParam)||void 0===d?void 0:d.retryCount,rtcIndex:this.index}}destroy(){var e;o.default.getInstance().log(`${this.path} index: ${this.index} webRTCController destroy -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}`),this.leecherGetDataParam=null,null===(e=this.socketController)||void 0===e||e.off(s.default.SOCKET_MESSAGE,this.onSocketMessage),super.destroy(),this.needDataByte=0,this.receivedDataByte=0,this.receivedU8Buffer=null,this.getDataOnResolve=this.getDataOnReject=null,this.dataChannelOpenTimer&&window.clearTimeout(this.dataChannelOpenTimer),this.dataChannelMessageTimeoutTimer&&window.clearTimeout(this.dataChannelMessageTimeoutTimer),clearTimeout(this.heartbeatTimer),delete this.heartbeatTimer}}t.WebRTCLeecher=l},4290:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WebrtcWorkshop=void 0;const r=n(9312),i=r.__importStar(n(4890)),s=r.__importDefault(n(2827)),o=n(2636),a=r.__importDefault(n(1788));class c{constructor(e,t){var n,r;this.sdk=e,this.peerRtcInfoByRid={},this.overallTimeoutTimerByRid={},this.peersCounter=0,a.default.bindAll(["onWorkshopGetDataSuccess","onWorkshannelOpen","onWebRTCChannelClose","onWebRTCOfferRejected","onWebRTCGetDataTimeout","onWebRTCChannelOpenTimeout"],this),this.socketContr.sdk.state.commonStat,null===(n=this.sdk.eventBus)||void 0===n||n.on(i.WorkshopEvent.GET_DATA_SUCCESS,this.onWorkshopGetDataSuccess),null===(r=this.sdk.eventBus)||void 0===r||r.on(i.WorkshopEvent.GET_DATA_FAIL,this.onWorkshopGetDataFail)}getData(e,t,n,i=5,s=0,o=5e3,a){return r.__awaiter(this,void 0,void 0,(function*(){return new Promise(((r,d)=>{const l=t=>n=>{t(n),this.afterOutermostResolveOrReject(e)};try{o=this.fiddleLatency(o,a),this.createWorkShop(e,t,n,s,o,i,l(r),l(d)),this.createOverallTimeout(e,o,l(d)),this.initLeecher(e).then((()=>this.startConnection(e))).catch((t=>{c.isPromiseResponse(t)?l(d)(t):l(d)({code:40016,msg:"getData initialization error",responseData:this.makeResponseData(e)})}))}catch(e){l(d)(e)}}))}))}fiddleLatency(e,t){const n=e;return t>0&&(e-=Date.now()-t),(isNaN(e)||e<100)&&(e=100),n-e>1e3&&s.default.getInstance().log(`------ latency is ${e}, originLatency is ${n}`),e}abortGetData(e){this.releasePeer(e.path,"auto"),this.clearOverallTimeout(e.path),this.peerRtcInfoByRid[e.path]={peerRtcControllers:this.peerRtcInfoByRid[e.path].peerRtcControllers,startTime:Date.now()}}createWorkShop(e,t,n,r,i,s,o,a){this.peerRtcInfoByRid[e]=Object.assign(Object.assign({},this.peerRtcInfoByRid[e]),{rid:e,originRange:t,originToken:n,bitrate:r,duration:s,latency:i,startTime:Date.now(),outermostResolve:o,outermostReject:a,receivedTotalBytes:0,receivedTotalBytesFromBr:0,receivedSuccessBytes:0,bufferPromise:[],finished:!1,failureReason:[],availableData:[]}),this.checkRidCount(e)}checkRidCount(e){const t=Object.keys(this.peerRtcInfoByRid||{});t.length>=3&&t.filter((t=>{const n=this.peerRtcInfoByRid[t].startTime;return t!==e&&"number"==typeof n&&Date.now()-n>6e4})).forEach((e=>{this.releasePeer(e,!0),this.clearPeerInfo(e),this.clearOverallTimeout(e)}))}createOverallTimeout(e,t,n){s.default.getInstance().log(`[createGetDataTimeout], rid: ${e}, latency: ${t}`),this.overallTimeoutTimerByRid[e]=window.setTimeout((()=>{var r,i;if(this.overallTimeoutTimerByRid[e]=0,s.default.getInstance().log(`[getDataTimeoutTimerByRid], rid: ${e}, latency: ${t}`),!this.peerRtcInfoByRid[e])return;const o={code:40003,msg:"getData timeout: "+(null===(i=null===(r=this.peerRtcInfoByRid[e].failureReason)||void 0===r?void 0:r.map((e=>e.msg)))||void 0===i?void 0:i.join(",")),responseData:this.makeResponseData(e)};this.releasePeer(e,"auto"),n(o)}),t-this.sdk.config.fawkesConfig.dashBufferTime)}initLeecher(e){var t,n,s;return r.__awaiter(this,void 0,void 0,(function*(){if(null===(t=this.peerRtcInfoByRid[e].peerRtcControllers)||void 0===t?void 0:t.length){const{peerRtcControllers:t}=this.peerRtcInfoByRid[e];for(const n of t)"open"!==n.dataChannelState&&this.releasePeer(e,n.index);if(t.length)return void(t.some((e=>"browser"===e.peerTarget))&&(null===(n=this.socketController)||void 0===n||n.reportStatToTracker("hasBrowserPeer")))}const[r,c]=yield a.default.tryCatchAsync(this.getPeers(e));if(r)throw{code:r.code||40016,msg:r.msg,responseData:this.makeResponseData(e)};this.sdk.state.succRidsArray=Array.from(new Set(this.sdk.state.succRidsArray.concat(e))),this.commonStat.getPeersSuccRidsCount=this.sdk.state.succRidsArray.length,this.peerRtcInfoByRid[e].shouldResPeerNum=c.shouldResPeerNum,this.peerRtcInfoByRid[e].donationShouldResPeerNum=c.donationShouldResPeerNum,this.peerRtcInfoByRid[e].peerRtcControllers=[];for(const t of c.peers){const n=new o.WebRTCLeecher(this.sdk,this.socketController,t.id,!!t.isSameIP,!!t.isSMid,e,this.peersCounter);n.createOffer(),n.on(i.default.WEBRTC_CHANNEL_OPEN,this.onWebRTCChannelOpen),n.on(i.default.WEBRTC_CHANNEL_CLOSE,this.onWebRTCChannelClose),n.on(i.default.WEBRTC_CHANNEL_OPEN_TIMEOUT,this.onWebRTCChannelOpenTimeout),n.on(i.default.WEBRTC_GET_DATA_FAIL,this.onWebRTCGetDataFail),n.on(i.default.WEBRTC_GET_DATA_TIMEOUT,this.onWebRTCGetDataTimeout),n.on(i.default.WEBRTC_OFFER_REJECTED,this.onWebRTCOfferRejected),this.peerRtcInfoByRid[e].peerRtcControllers.push(n),this.peersCounter++,this.sdk.state.addBoxOrBrowserStat("peersCount",1,a.default.getPeerTarget(t.id))}this.peerRtcInfoByRid[e].peerRtcControllers.some((e=>"browser"===e.peerTarget))&&(null===(s=this.socketController)||void 0===s||s.reportStatToTracker("hasBrowserPeer"))}))}getPeers(e){var t;const{originRange:n,bitrate:r}=this.peerRtcInfoByRid[e];return this.commonStat.newTrack.addRIDRtcStats(e,"getPeer",1),this.sdk.state.ridsArray=Array.from(new Set(this.sdk.state.ridsArray.concat(e))),this.commonStat.getPeersRidCount=this.sdk.state.ridsArray.length,this.socketController.getPeerInfo(e,n,r)}startConnection(e){const{peerRtcControllers:t}=this.peerRtcInfoByRid[e];this.setUseRanges(e,t.length);for(const n of t.filter((e=>e.isOpen))){const t=this.peerRtcInfoByRid[e].useRanges.find((e=>!e.assigned||e.aborted));if(!t)return;this.assignTask(n,t,e)}}setUseRanges(e,t){var n,r,i;const s=e=>({range:e,assigned:!1,completed:!1,aborted:!1}),o=this.peerRtcInfoByRid[e].originRange;if(!o)return void(null===(r=(n=this.peerRtcInfoByRid[e]).outermostReject)||void 0===r||r.call(n,{code:40016,msg:"originRange doesn't exist",responseData:this.makeResponseData(e)}));let a=t;if(t>1&&this.peerRtcInfoByRid[e].bitrate>3145728&&(a=2*t),null===(i=this.sdk)||void 0===i||i.newTrack.addRIDRtcStats(e,"taskCount",a),a<=1)return void(this.peerRtcInfoByRid[e].useRanges=[s(o)]);const{start:c,end:d}=o,l=Math.floor((d-c+1)/a),u=Math.floor((d-c+1)%a);if(l<=1)return void(this.peerRtcInfoByRid[e].useRanges=[s(o)]);const h=[];for(let e=0;e<a;e++){let t=c+e*l,n=c+(e+1)*l-1;e===a-1&&(n+=u),h.push(s({start:t,end:n}))}this.peerRtcInfoByRid[e].useRanges=h}assignTask(e,t,n){var r,o,a,d;if("open"!==(null==e?void 0:e.dataChannelState)||(null==e?void 0:e.isSucking)||this.isRidFinished(n)||!t)return;const l=t.range.end-t.range.start+1;"browser"===e.peerTarget?(null===(r=this.sdk)||void 0===r||r.newTrack.addRIDRtcStats(n,"taskAssignCount_br",1),null===(o=this.sdk)||void 0===o||o.newTrack.addRIDRtcStats(n,"taskAssignBytes_br",l)):(null===(a=this.sdk)||void 0===a||a.newTrack.addRIDRtcStats(n,"taskAssignCount_box",1),null===(d=this.sdk)||void 0===d||d.newTrack.addRIDRtcStats(n,"taskAssignBytes_box",l)),s.default.getInstance().log("æ´¾æ´»å•¦",e.index,JSON.stringify(t),n);const{originToken:u,originRange:h,latency:p,startTime:f,bitrate:m,duration:g}=this.peerRtcInfoByRid[n]||{};this.setUseRangeStatus(t,"start"),this.peerRtcInfoByRid[n].bufferPromise.push({leecher:e,promise:e.getData({rid:n,originRange:h,useRange:t.range,originToken:u,token:u+"-"+t.range.end,startTime:f||Date.now(),latency:p}).then((r=>{var o,a,c,d,l,u;if(this.isRidFinished(n))return;this.setUseRangeStatus(t,"fulfilled",e.index),s.default.getInstance().log(e.index,"å®Œæˆä»»åŠ¡",n,JSON.stringify(t));const{useRange:{start:h,end:p},originRange:f,uint8:m}=r.responseData;return(null===(o=this.peerRtcInfoByRid[n].bufferPromise)||void 0===o?void 0:o.length)&&h>=this.peerRtcInfoByRid[n].originRange.start&&p<=this.peerRtcInfoByRid[n].originRange.end&&this.peerRtcInfoByRid[n].availableData.push({data:m.buffer,start:h,end:p}),this.mergeBuffer(n,r,e.peerTarget),"browser"===e.peerTarget?(null===(a=this.sdk)||void 0===a||a.newTrack.addRIDRtcStats(n,"taskSuccessCount_br",1),null===(c=this.sdk)||void 0===c||c.newTrack.addRIDRtcStats(n,"taskSuccessBytes_br",r.responseData.gotDataByte)):(null===(d=this.sdk)||void 0===d||d.newTrack.addRIDRtcStats(n,"taskSuccessCount_box",1),null===(l=this.sdk)||void 0===l||l.newTrack.addRIDRtcStats(n,"taskSuccessBytes_box",r.responseData.gotDataByte)),null===(u=this.sdk.eventBus)||void 0===u||u.trigger(i.WorkshopEvent.GET_DATA_SUCCESS,e,n),r})).catch((r=>{var s;if(!this.isRidFinished(n))return this.setUseRangeStatus(t,"rejected"),null===(s=this.sdk.eventBus)||void 0===s||s.trigger(i.WorkshopEvent.GET_DATA_FAIL,n,t),c.isPromiseResponse(r)&&(this.peerRtcInfoByRid[n].receivedTotalBytes+=r.responseData.gotDataByte||0,"browser"===e.peerTarget&&(this.peerRtcInfoByRid[n].receivedTotalBytesFromBr+=r.responseData.gotDataByte||0),this.peerRtcInfoByRid[n].failureReason.push({code:r.code,msg:r.msg})),r}))})}isRidFinished(e){var t,n;return void 0===(null===(t=this.peerRtcInfoByRid[e])||void 0===t?void 0:t.finished)||!0===(null===(n=this.peerRtcInfoByRid[e])||void 0===n?void 0:n.finished)}mergeBuffer(e,t,n){var r;let{originRange:i,useRanges:s}=this.peerRtcInfoByRid[e];if(!i||!s)throw{code:40015,msg:"merge buffer error",responseData:{gotDataByte:t.responseData.uint8.byteLength,gotDataByteFromBr:"browser"===n?t.responseData.uint8.byteLength:0}};const o=i.end-i.start+1,a=(r=this.peerRtcInfoByRid[e]).resBuffer||(r.resBuffer=new Uint8Array(o));a.set(t.responseData.uint8,t.responseData.useRange.start-i.start),this.peerRtcInfoByRid[e].receivedTotalBytes+=t.responseData.uint8.byteLength,"browser"===n&&(this.peerRtcInfoByRid[e].receivedTotalBytesFromBr+=t.responseData.uint8.byteLength),this.peerRtcInfoByRid[e].receivedSuccessBytes+=t.responseData.uint8.byteLength,s.every((e=>e.completed))&&this.peerRtcInfoByRid[e].receivedSuccessBytes===o&&a.byteLength===o&&this.peerRtcInfoByRid[e].outermostResolve({code:24e3,msg:"success",responseData:Object.assign(Object.assign({},this.makeResponseData(e)),{data:a.buffer,cPeerSID:""})})}setUseRangeStatus(e,t,n){switch(t){case"start":e.assigned=!0,e.completed=!1,e.aborted=!1;break;case"fulfilled":e.assigned=!0,e.completed=!0,e.aborted=!1,e.ownerIndex=n;break;case"rejected":e.assigned=!0,e.completed=!1,e.aborted=!0}}onWebRTCGetDataFail(e,t,n){s.default.getInstance().log(`[onWebRTCGetDataFail], sid: ${e}, rid: ${t}, index: ${n}`),this.releasePeer(t,n)}onWebRTCChannelClose(e,t,n,r){var i,o;s.default.getInstance().log(`[onWebRTCChannelClose], sid: ${e}, rid: ${t}, index: ${n}`),r&&(null===(i=this.peerRtcInfoByRid[t].failureReason)||void 0===i||i.push({code:r.code,msg:r.msg})),"browser"===a.default.getPeerTarget(e)&&(null===(o=this.socketController)||void 0===o||o.reportStatToTracker("browserSeederClose")),this.releasePeer(t,n)}onWebRTCOfferRejected(e,t,n,{code:r,msg:i}){var o;s.default.getInstance().log(`[onWebRTCOfferRejected], sid: ${e}, rid: ${t}, index: ${n}`),null===(o=this.peerRtcInfoByRid[t].failureReason)||void 0===o||o.push({code:r,msg:i}),this.releasePeer(t,n)}onWebRTCGetDataTimeout(e,t,n){s.default.getInstance().log(`[onWebRTCGetDataTimeout], sid: ${e}, rid: ${t}, index: ${n}`),this.releasePeer(t,n)}onWebRTCChannelOpenTimeout(e,t,n){var r;s.default.getInstance().log(`[onWebRTCChannelOpenTimeout], sid: ${e}InfoByRid[t].failureReason)||void 0===r||r.push({code:40012,msg:"channelOpenTimeout"}),this.releasePeer(t,n),this.socketController.localRecord.getRecord("historyPeers").updateRecord({cPeerSID:e,target:"badHistory",instantReject:()=>{this.instantReject("all","this client's quality is bad, shut down nc"),this.socketController.disconnect(),this.sdk.destroy()}}),this.socketController.localRecord.getRecord("openFail").updateRecord({cPeerSID:e,action:"incr",instantReject:()=>{this.socketController.disableAllRNCTimer=window.setTimeout((()=>{this.socketController.disableAllRNCTimer=0}),3e5)}})}onWebRTCChannelOpen(e,t,n){s.default.getInstance().log(`[onWebRTCChannelOpen], sid: ${e}, rid: ${t}, index: ${n}`);const{useRanges:r=[],peerRtcControllers:i=[],bitrate:o,duration:a}=this.peerRtcInfoByRid[t]||{},c=i.find((e=>e.index===n));if(!c)return;this.countISPStat(e),this.socketController.localRecord.getRecord("historyPeers").updateRecord({cPeerSID:e,target:"goodHistory"}),this.socketController.localRecord.getRecord("openFail").updateRecord({cPeerSID:e,action:"clear"});const d=r.find((e=>!e.assigned||e.ak(c,d,t)}countISPStat(e){const t=this.sdk.state.weightStat,n=a.default.getISPFromSid(this.socketController.socketID),r=a.default.getISPFromSid(e);if(n&&r){switch(r){case"1":t.ChinaTelecomOpenNum++;break;case"2":t.ChinaUnicomOpenNum++;break;case"3":t.ChinaMobileOpenNum++;break;default:t.OtherISPOpenNum++}r===n?t.sameISPOpenNum++:t.notSameISPOpenNum++}}onWorkshopGetDataSuccess(e,t){var n;if(s.default.getInstance().log(`[onWorkshopGetDataSuccess], rid: ${t}, leecher: ${e}`),!this.peerRtcInfoByRid[t])return;const r=this.peerRtcInfoByRid[t].useRanges.find((e=>!e.assigned||e.aborted));r&&(null===(n=this.peerRtcInfoByRid[t].bufferPromirt>=this.peerRtcInfoByRid[t].originRange.start&&r.range.end<=this.peerRtcInfoByRid[t].originRange.end&&this.assignTask(e,r,t)}onWorkshopGetDataFail(e,t){var n;if(s.default.getInstance().log(`[onWorkshopGetDataFail], rid: ${e}, useRange: ${JSON.stringify(t)}`),this.peerRtcInfoByRid[e]&&(null===(n=this.peerRtcInfoByRid[e].bufferPromise)||void 0===n?void 0:n.length)&&t.range.start>=this.peerRtcInfoByRid[e].originRange.start&&t.range.end<=this.peerRtcInfoByRid[e].originRange.end){const n=this.peerRtcInfoByRid[e].peerRtcControllers.find((e=>"open"===e.dataChannelState&&!e.isSucking));if(!n)return;this.assignTask(n,t,e)}}afterOutermostResolveOrReject(e){var t;s.default.getInstance().log(`[afterOutermostResolveOrReject], rid: ${e}`),this.clearOverallTimeout(e),(null===(t=this.peerRtcInfoByRid)||void 0===t?void 0:t[e])&&(delete this.peerRtcInfoByRid[e].resBuffer,delete this.peerRtcInfoByRid[e].bufferPromise,this.peerRtcInfoBtes=0,this.peerRtcInfoByRid[e].receivedTotalBytesFromBr=0,this.peerRtcInfoByRid[e].finished=!0,this.peerRtcInfoByRid[e].failureReason=[],this.peerRtcInfoByRid[e].availableData=[])}instantReject(e,t){Object.keys(this.peerRtcInfoByRid||{}).forEach((e=>{this.peerRtcInfoByRid[e].outermostReject({code:40020,msg:t,responseData:this.makeResponseData(e)}),this.peerRtcInfoByRid[e].finished=!0}))}handleAvailableData(e){var t,n;let{originRange:r,availableData:i}=this.peerRtcInfoByRid[e]||{};if(!r||!i)return{availableData:[],missingData:[]};let s,o=[],a=[];i=i.sort(((e,t)=>e.start-t.start));for(let e in i){const c=+i[+e].start,d=+i[+e].end,l=+(null===(t=i[+e+1])||void 0===t?void 0:t.start),u=+(null===(n=i[+e+1])||void 0===n?void 0:n.end);if(s||(s=i[+e]),0==+e&&c>r.c-1}),l&&u)if(l-d!=1)o.push({start:d+1,end:l-1}),s&&(a.push(s),s=void 0);else{let t=new Uint8Array(u-s.start+1);t.set(new Uint8Array(s.data)),t.set(new Uint8Array(i[+e+1].data),s.data.byteLength),s={start:s.start,end:u,data:t.buffer}}+e==i.length-1&&(d<r.end&&o.push({start:d+1,end:r.end}),s&&(a.push(s),s=void 0))}return{availableData:a,missingData:o}}makeResponseData(e){const{originRange:t,startTime:n,latency:r,receivedTotalB:s=0,useRanges:o,peerRtcControllers:a}=this.peerRtcInfoByRid[e]||{},c=(d=(o||[]).filter((e=>"number"==typeof e.ownerIndex)).map((e=>e.ownerIndex)).reduce(((e,t)=>{const n=a.find((e=>e.index===t));return(null==n?void 0:n.cPeerSocketID)&&e.push(n.cPeerSocketID),e}),[]),[...new Set(d)]);var d;const{availableData:l,missingData:u}=this.handleAvailableData(e);return{range:(null==t?void 0:t.start)+"-"+(null==t?void 0:t.end),originRange:t,usePeerSids:c,from:0,path:e,getDataTime:Date.now()-n,startTime:n,latency:r,gotDataByte:i+((null==a?void 0:a.reduce(((e,t)=>e+t.getReceivedDataByte()),0))||0),gotDataByteFromBr:s+((null==a?void 0:a.reduce(((e,t)=>e+("browser"===t.peerTarget?t.getReceivedDataByte():0)),0))||0),availableData:l,missingData:u}}clearOverallTimeout(e){var t;(null===(t=this.overallTimeoutTimerByRid)||void 0===t?void 0:t[e])&&(this.overallTimeoutTimerByRid[e]&&window.clearTimeout(this.overallTimeoutTimerByRid[e]),delete this.overallTimeoutTimerByRid[e])}clearPeerInfo(e){var t;null===(t=this.peerRtcInfoByRid)||void 0===t||delete t[e]}destroy(){var e,t;Object.keys(this.peerRtcInfoByRid||{}).forEach((e=>{this.releasePeer(e,!0),this.clearPeerInfo(e),this.clearOverallTimeout(e)})),null===(e=this.sdk.eventBus)||void 0===e||e.off(i.WorkshopEvent.GET_DATA_SUCCESS,this.onWorkshopGetDataSuccess),null===(t=this.sdk.eventBus)||void 0===t||t.off(i.WorkshopEvent.GET_DATA_FAIL,this.onWorkshopGetDataFail),delete this.sdk,delete this.socketController}releasePeer(e,t){var n,r,o,a,c;if(s.default.getInstance().log(`[releasePeer], rid: ${e}, arg: ${t}`),!this.peerRtcInfoByRid[e])return;const{peerRtcControllers:d=[],useRanges:l=[]}=this.peerRtcInfoByRid[e];let u=!1;for(const r of d)"auto"===t&&r.getReceivedDataByte()===r.getNeedDataByte()&&0!==r.getReceivedDataByte()||("auto"===t&&0!==r.getNeedDataByte()&&r.getReceivedDataByte()/r.getNeedDataByte()>=.85?s.default.getInstance().log(`[releasePeer-continue], rid: ${e}, arg: ${r.index}`):"auto"===t&&l.some((({ownerIndex:e})=>"number"==typeof e&&e===r.index))||r.path===e&&(r.index!==t&&"auto"!==t&&!0!==t||(u=!0,this.socketConto(r.cPeerSocketID,e),r.off(i.default.WEBRTC_CHANNEL_OPEN,this.onWebRTCChannelOpen),r.off(i.default.WEBRTC_CHANNEL_CLOSE,this.onWebRTCChannelClose),r.off(i.default.WEBRTC_CHANNEL_OPEN_TIMEOUT,this.onWebRTCChannelOpenTimeout),r.off(i.default.WEBRTC_GET_DATA_FAIL,this.onWebRTCGetDataFail),r.off(i.default.WEBRTC_GET_DATA_TIMEOUT,this.onWebRTCGetDataTimeout),r.off(i.default.WEBRTC_OFFER_REJECTED,this.onWebRTCOfferRejected),r.destroy(),this.peerRtcInfoByRid[e].peerRtcControllers=(null===(n=this.peerRtcInfoByRid[e].peerRtcControllers)||void 0===n?void 0:n.filter((e=>e.index!==r.index)))||[])));0===(null===(r=this.peerRtcInfoByRid[e].peerRtcControllers)||void 0===r?void 0:r.length)&&this.overallTimeoutTimerByRid[e]&&u&&this.peerRtcInfoByRid[e].outermostReject({code:(null===(o=this.peerRtcInfoByRid[e].failureReason[0])||void 0===o?void 0:o.code)||40016,msg:null===(c=null===(a=this.peerRtcInfoByRid[e].failureReason)||void 0===a?void 0:a.map((e=>e.msg)))||void 0===c?void 0:c.join(","),responseData:this.makeResponseData(e)})}static isPromiseResponse(e){return!(!e||"object"!=typeof e)&&"code"in e&&"msg"in e&&"responseData"in e}}t.WebrtcWorkshop=c},1380:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.browserInfo=void 0;const n=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,r=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/]];t.browserInfo=voidif(t)return t;const i=r.exec(e);return!!i&&[n,i]}),!1)}(e);if(!t)return null;const[i,s]=t;if("searchbot"===i)return null;const o=n.exec(e);if(o&&o[1])return null;const a=s[1]&&s[1].split(".").join("_").split("_").slice(0,3),c=a?parseInt(a[0]):NaN;return{name:["chrome","edge-chromium"].includes(i)?"chromium":i,version:c}}(window.navigator.userAgent):null},2955:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReportFilter=void 0;const r=n(278),i=n(652);class s{constructor(e,t){this.commonInfo=e,this.config=t}updateCtime(e){this.commonInfo.ctime=e}filterBeforeCreate(e){return s.isLeecher(this.commonInfo)&&s.isLeecher(e)&&this.commonInfo.leecher.mid===e.seeder.mid?{status:!1,desc:"leecher mid is equal with seeder mid"}:s.isSeeder(this.commonInfo)&&s.isSeeder(e)&&this.commonInfo.seeder.mid===e.leecher.mid?{status:!1,desc:"seeder mid is equal with leecher mid"}:{status:!0}}filterBeforeRequest(e){if(!1===this.nonEmpty(this.commonInfo).status)return{status:!1,illegalItems:[{item:this.commonInfo,desc:"commonInfo field is empty"}]};const t=[this.nonEmpty.bind(this),this.levelConstraint.bind(this),this.maxSizeConstraint.bind(this)],n=e.report.flatMap((e=>{coDesc(t,(t=>t(e)));return!1===n.status?[{item:e,desc:n.desc}]:[]}));return e.report=e.report.filter((e=>this.everyWithDesc(t,(t=>t(e))).status)),e.report.length?Object.assign({status:!0},n.length?{illegalItems:n}:null):Object.assign({status:!1},n.length?{illegalItems:n}:{desc:"report array is empty"})}everyWithDesc(e,t){for(const n of e){const e=t(n);if(!0!==e.status)return{status:!1,desc:e.desc}}return{status:!0}}nonEmpty(e){return i.PCDNUtils.isObject(e)?this.everyWithDesc(Object.values(e),(e=>this.nonEmpty(e))):i.PCDNUtils.isArray(e)?this.everyWithDesc(e,(e=>this.nonEmpty(e))):e?{status:!0}:{status:!1,desc:"field is empty"}}mediaConstraint(e){const{media:{bitrate:t=0,duration:n=0}={},data:{size:r=0}={}}=e;return t*n<8*r*5?{status:!0}:{status:!1,desc:"bitrate * duration is larger than size"}}levelConstraint(e){if(s.isLeecher(this.commonInfo)&&s.isLeecher(e)){const{size:t,start_time:n,end_time:i}=e.data||{};return 8*t/(i-n)<1024*(r.levelStrategyCollection[e.seeder.level].maxBitrate+1)*1024?{status:!0}:{status:!1,desc:"bitrate is larger than level policy"}}if(s.isSeeder(this.commonInfo)&&s.isSeeder(e)){const{size:t,start_time:n,end_time:i}=e.data||{};return 8*t/(i-n)<1024*(r.levelStrategyCollection[this.commonInfo.seeder.level].maxBitrate+1)*1024?{status:!0}:{status:!1,desc:"bitrate is larger than level policy"}}return{status:!1,desc:"reportInfo belongs to unknown"}}maxSizeConstraint(e){return e.data.size<this.config.maxSize?{status:!0}:{status:!1,desc:`single transmission size is larger than ${this.config.maxSize}Byte`}}static isLeecher(e){return"type"in e&&"leecher"in e||"media"in e&&"seeder"in e}static isSeeder(e){return"type"in e&&"seeder"in e||"media"in e&&"leecher"in e}}t.ReportFilter=s},278:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.levelStrategyCollection=t.PCDNLevelCollection=void 0,t.PCDNLevelCollection=[1,2,3],t.levelStrategyCollection={0:{saveMaxSize:{chrome:0,nonChrome:0},maxBitrate:0,maxRTCLoad:0,maxDownloadBitrate:0},1:{saveMaxSize:{chrome:524288e3,nonChrome:524288e3},maxBitrate:2,maxRTCLoad:2,maxDownloadBitrate:1},2:{saveMaxSize:{chrome:2147483648,nonChrome:1073741824},maxBitrate:5,maxRTCLoad:5,maxDownloadBitrate:2},3:{saveMaxSize:{chrome:10737418240,nonChrome:1073741824},maxBitrate:20,maxRTCLoad:20,maxDownloadBitrate:5}}},5826:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.alwaysSend=t.PCDNReport=void 0;const r=n(2712),i=n(1380),s=n(2955),o=n(652),a=Symbol("uuid"),c=Symbol("destroyed"),d=Symbol("duration");t.PCDNReport=class{constructor(e,t,n,r){this.commonInfo=e,this.pLog=t,this.trackData=n,this.reportItems=[],this.reportDetailLSKey="pcdn_seeder_report_v1",this.pcdnConfigLSKey="pcdn_config",this.localStorageMaxDays=10,this.reportFilter=new s.ReportFilter(this.commonInfo,r),this.identity=1===this.commonInfo.type?"leecher":"seeder",this.intervalReport(),this.beforeUnload()}get reportURL(){const e=`api.bilibili.com/x/web-interface/pcdn/report?csrf=${o.PCDNUtils.getCookie("bili_jct")}`;return(window.location.host.includes("pre-")?"//pre-":"//")+e}handleFilterResult(e){return e.illegalItems?this.pLog("æˆåŠŸè¿‡æ»¤!",e.illegalItems):e.desc&&this.pLog("æˆåŠŸè¿‡æ»¤!",e.dtatus}beforeUistener("beforeunload",(()=>{const e=Object.assign(Object.assign({},this.commonInfo),{report:this.reportItems});this.updateCtime(e),this.updateEndTime(e);const n=this.reportFilter.filterBeforeRequest(e);if(this.handleFilterResult(n))return;const r=new Headers;r.append("Content-Type","application/json");const i=JSON.stringify(e);this.reportToLocalStorage(e),(0,t.alwaysSend)({url:this.reportURL,method:"post"},{headers:r,body:i,redirect:"follow",credentials:"include"},(e=>{e.setRequestHeader("content-type","application/json"),e.onreadystatechange=function(){},e.send(i)}),(()=>this.pLog("ä¸ŠæŠ¥æˆåŠŸ",i)))}))}createReportItem(e,t){const n=this.reportFilter.filterBeforeCreate(t);if(this.handleFilterResult(n))return;const r=t.media.duration;t.media.duration=0;const i=Object.assign(Obje({},t),{[a]:e,[c]:!1,[d]:r});return this.reportItems.push(i),this.pLog("åˆ›å»ºäº†ä¸€æ¡reportItem",i),i}updateReportItem(e,t){const n=this.reportItems.find((t=>t[a]===e));if(n){if("byteLength"in t)return n.data.size+=t.byteLength,void(n.media.duration+=n[d]);if("endTime"in t){if(n[c])return;return n.data.end_time=t.endTime,n[c]=!0,void this.pLog("äº§ç”Ÿäº†ä¸€æ¡å¯ä¸ŠæŠ¥æ•°æ®",n)}}}intervalReport(){this.reportTimer=window.setInterval((()=>{const e=this.reportItems.filter((e=>e[c]));0!==e.length&&(this.reportPCDNByFetch(Object.assign(Object.assign({},this.commonInfo),{report:e})),this.reportItems=this.reportItems.filter((e=>!e[c])))}),6e4)}reportPCDNByFetch(e,t=!1){this.updateCtime(e);const n=this.reportFilter.filterBeforeRequest(e);if(this.handleFilterResult(n))return;const r=JSON.stringify(e),i=new Headers;i.append("Content-Type","application/json");const s=Object.assign({method:"POST",headers:i,body:r,redirect:"follow",credentials:"include"},t?{keepalive:!0}:null);fetch(this.>{if(200===e.status)return e.json();throw e.text()})).then((t=>{0===(null==t?void 0:t.code)?this.logResponse("success",e):(this.logResponse("failure",t),this.trackData.pcdnReportFailure++)})).catch((e=>{this.logResponse("error",e),tReportError++Storage(e)}shouldDisplayPCDNReport(){const e=o.PCDNUtils.getLocalObject(this.pcdnConfigLSKey);return o.PCDNUtils.isObject(e)&&!!Boolean(e.showReportDetail)||(localStorage.removeItem(this.reportDetailLSKey),!1)}reportToLocalStorage(e){if("leecher"===this.identity||!1===this.shouldDisplayPCDNReport())return;const t=e.report.reduce(((e,t)=>e+t.data.size),0),n=e.ctime,r=new Date(n),i=`${r.getMonth()+1}.${r.getDate()}`,s=r.getHours()+"";let a=o.PCDNUtils.getLocalObject(this.reportDetailLSKey);const c=Object.keys(a||{});if(c.length>this.localStorageMaxDays){const e=Math.min(...c.map((e=>a[e].timestamp))),t=c.find((t=>a[t].timestamp===e));delete a[t]}null===a&&(a={}),void 0===a[i]&&(a[i]={}),void 0===a[i][s]&&(a[i][s]=0),a[i][s]+=t,a[i].totalSize=Object.keys(a[i]).reduce(((e,t)=>"totalSize"===t||"timestamp"===t?e:e+a[i][t]),0),a[i].timestamp=n,o.PCDNUtils.setLocalObject(this.reportDetailLSKey,a)}updateCtime(e){const t=Date.now();e.ctime=t,this.reportFilter.updateCtime(t)}updateEndTime(e){e.report.forEach((e=>e.data.end_time=Date.now()))}logResponse(e,t){switch(e){case"success":this.pLog("ä¸ŠæŠ¥æˆåŠŸ",t);break;case"failure":this.pLog("ä¸ŠæŠ¥å¤±è´¥",t);break;case"error":this.pLog("ä¸ŠæŠ¥é”™è¯¯",t)}}destroy(){this.reportTimer&&window.clearInterval(this.reportTimer),this.reportItems.length&&this.reportPCDNByFetch(Object.assign(Object.assign({},this.commonInfo),{report:this.reportItems}))}},t.alwaysSend=(e,t,n,s)=>{const o="chromium"===i.browserInfo.name&&i.browserInfo.version>=66||"safari"===i.browserInfo.name&&i.browserInfo.version>=13,{url:a,method:c}=e;if(o){const{onSuccess:e,onError:n}=t,i=r.__rest(t,["onSuccess","onError"]);return fetch(a,Object.assign(Object.assign({},i),{method:c.toUpperCase(),keepalive:!0})).then(e).catch(n),void(null==s||s())}const d=new XMLHttpRequest;d.open(c.toLowerCase(),a,!1),n(d),null==s||s()}},652:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PCDNUtils=void 0;class n{static getPCDNConfig(){try{return Object.assign({showLoaderLog:0,showLeecherLog:0,showSeederLog:0},JSON.parse(localStorage.getItem("pcdn_config")||"{}"))}catch(e){return{showLoaderLorAgent;return-1===e.indexOf("Edge")&&e.indexOf("Chrome")>-1&&e.indexOf("Safari")>-1}static isChromeAboveCertainVersion(e){vaaN(r)||r<e)}static getCookie(e){if(null==e)return"";const t=document.cookie.split(";"),n=decodeURIComponent(e);for(let e=0;e<t.length;e++){const[r,i]=t[e].trim().split("=");if(decodeURIComponent(r)===n)return decodeURIComponent(i)}returnect]"===Object.prototype.toString.call(e)}static isArray(e){returt.prototype.toString.call(e)}static getLocalStorage(e){return localStorage[e]&&"getItem"!==e?localStorage[e]:localStorage.getItem(e)}static getLocalObject(e){try{return JSON.parse(n.getLocalStorage(e))}catch(e){return null}}static setLocalObject(e,t){localStorage.setItem(e,JSON.stringify(t))}}t.PCDNUttrict";Object.defineProperty(t,"__esModule",{value:!0}),t.SdpParser=void 0;class n{static minify(e,t=n.sdpAttrs){const r=e.split("\r\n"),i=[];""===r[r.length-1]&&r.pop();for(const e of r){if(t.some((t=>e.startsWith(n.sdpConstObj[t].start)))){i.push(e);continue}const r=Object.values(n.sdpConstObj).find((t=>e.startsWith(t.start)));r?i.push(r.position):i.push(e)}return i.join(",")}static assemble(e,t){const r={type:t},i=e.split(","),s=n.sdpConstArray(t),o=[];return i.forEach((e=>{const t=parseInt(e);Number.isNaN(t)?o.push(e):o.push(s[t])})),r.sdp=o.join("\r\n")+"\r\n",r}static getIceUFragment(e){return e.split("\r\n").filter((e=>e.startsWith("a=ice-ufrag")))[0].split(":")[1]}static sdpConstArray(e){return["v=0","o=- 1234 2 IN IP4 127.0.0.1","s=-","t=0 0","a=group:BUNDLE 0","a=extmap-allow-mixed","a=msid-semantic: WMS","m=application 9 UDP/DTLS/SCTP webrtc-datachannel","c=IN IP4 0.0.0.0","a=ice-ufrag:xxx","a=ice-pwd:xxx","a=ice-options:trickle","a=fingerprint:sha-256 xxx","a=setup:"+("offer"===e?"actpass":"active"),"a=mid:0","a=sctp-port:5000","a=max-message-size:262144"]}}n.sdpConstObj={version:{start:"v=",position:0},origin:{start:"o=",position:1},sessionName:{start:"s=",position:2},timing:{start:"t=",position:3},bundlePolicy:{start:"a=group",position:4},extensionMap:{start:"a=extmap-allow-mixed",position:5},mediaStreamID:{start:"a=msid-seman",position:7},connectionData:{start:"c=INent:{start:"a=ice-uf9},icePassword:{start:"a=ice-pwd",position:10},iceOption:{start:"a=ice-options",position:11},fingerprint:{start:"a=fingerprint",position:12},setup:{start:"a=setup",position:13},mediaIDForBundlePolicy:{start:"a=mid",position:14},sctpPort:{start:"a=sctp-port",position:15},maxMessageSize:{start:"a=max-message-size",position:16}},n.sdpAttrs=Object.keys(n.sdpConstObj),t.SdpParser=n},2337:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createSocket=t.createMessage=void 0,t.createMessage=function(e,t){return Object.assign({type:e},t)},t.createSocket=function(e,t){return{emit:(...n)=>t.emit(e,...n),on:n=>t.on(e,n),off:n=>t.off(e,n)}}},7535:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ISPS=t.NatType=t.DISTRIBUTION_LASTPUSH_KEY=t.DISTRIBUTION_BASEURL=t.qnWithId=t.CODE_RATIO_MAP=t.CLEAR_MAP=t.RATIO_MAP=t.RTC_LOAD_TYPE=t.RUNTIME_MODE=t.OPERATION=t.HOT_PUSH_FROM=t.RID_TYPE=t.DEVICE_TYPE=t.REDIS_KEY=t.STRING=void 0,t.STRING={BOX:"box",BROWSER:"browser",AUTO_HOT_PUSH:"autoHotPush",CLIENT:"client",RESOURCE:"resource",RESOURCES:"resources",HOT_RESOURCES:"hotResources",NO_RESOURCES:"noResources",SIDS:"sids",PRID:"prid",PRIDS:"prids",BP_NC_TRACKER:"bpNcTracker",CLIENT_NUM:"clientNum",LAST_ACTIVE_TIME:"lastActiveTime",URLS:"urls",DISPATCH:"dispatch",SEARCHINFO:"searchInfo",MD5S:"md5s",SEEDER:"seeder"},t.REDIS_KEY={SIDS_BOX:"sids:box",PRIDS_QUIT:"prids:quit",PRIDS_CONNECT:"prids:connect",PRIDS_LAST_ACTIVE_TIME:"prids:lastActiveTime",CONNECT_NUM_BOX:"connect:num:box",TOP_CID_LIST_SET_NAME:"topCIDListKey",TOP_AID_LIST_SET_NAME:"topAIDListKey",ENABLED_CID_LIST_SET_NAME:"enabledCIDListKey",MD5_RESOURCES:"md5:resources",MD5_INVALID:"md5:invalid"},t.DEVICE_TYPE={BROWSER:0,BOX:1,AUTO_HOT_PUSH:2,RESOURCE_MD5_VOTE:3,REWARD_DISTRIBUTION:4},t.RID_TYPE={VIDEO:0,AUDIO:1},t.HOT_PUSH_FROM={HAND_HOT_PUSH:1,AUTO_HOT_PUSH:2,EM_HOT_PUSH:3,EXTRA_HOT_PUSH:4,BOX_HOT_PUSH:5,REWARD_DISTRIBUTION:6},t.OPERATION={UPDATE:1,ADD:2,REMOVE:3},t.RUNTIME_MODE={PROD:"production",DEV:"development",PRE:"preliminary"},t.RTC_LOAD_TYPE={SEND:1,GET:2},t.RATIO_MAP={H264:.75,H265:.25,STANDARD:.75,UNSTANDARD:.25},t.CLEAR_MAP={V_1080P:2656,V_720P:1200,V_480P:500,V_1080PP:652,V_360P:200,V_1080P60:322},t.CODE_RATIO_MAP=[{code:"30011",msg:"360P-h265",ratio:t.CLEAR_MAP.V_360P*t.RATIO_MAP.H265},{code:"30015",msg:"360P-h264-éžæ ‡å‡†",ratio:t.CLEAR_MAP.V_360P*t.RATIO_MAP.H264*t.RATIO_MAP.UNSTANDARD},{code:"30016",msg:"360P-h264-æ ‡å‡†",ratio:t.CLEAR_MAP.V_360P*t.RATIO_MAP.H264*t.RATIO_MAP.STANDARD},{code:"30033",msg:"480P-h265",ratio:t.CLEAR_MAP.V_480P*t.RATIO_MAP.H265},{code:"30029",msg:"480P-h264-éžæ ‡å‡†",ratio:t.CLEAR_MAP.V_480P*t.RATIO_MAP.H264*t.RATIO_MAP.UNSTANDARD},{code:"30032",msg:"480P-h264-æ ‡å‡†",ratio:t.CLEAR_MAP.V_480P*t.RATIO_MAP.H264*t.RATIO_MAP.STANDARD},{code:"30066",msg:"720P-h265",ratio:t.CLEAR_MAP.V_720P*t.RATIO_MAP.H265},{code:"30064",msg:"720P-h264",ratio:t.CLEAR_MAP.V_720P*t.RATIO_MAP.H264},{code:"30077",msg:"1080P-h265",ratio:t.CLEAR_MAP.V_1080P*t.RATIO_MAP.H265},{code:"30080",msg:"1080P-h264",ratio:t.CLEAR_MAP.V_1080P*t.RATIO_MAP.H264},{code:"30102",msg:"1080PP-h265",ratio:t.CLEAR_MAP.V_1080PP*t.RATIO_MAP.H265},{code:"30112",msg:"1080PP-h264",ratio:t.CLEAR_MAP.V_1080PP*t.RATIO_MAP.H264},{code:"30106",msg:"1080P60-h265",ratio:t.CLEAR_MAP.V_,(t=e[n](t)).done,t.value)}))}}}function w(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}var R=Object.create?function(e,t){Object.defineProperty(e,"defaule}}function P(e,t){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return t.get(e)}function D(e,t,n){if(!t.has(e))throw new TypeError("an no8(){return h}});var r=n(3302),i=n.n(r),s={add:function(e){if("function"==typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope);else{if("function"!=typeof window.addEventListener)return;window.addEventListener("beforeunload",(function(){e()}),!0),window.addEventListener("unload",(function(){e()}),!0)}}},o=n(5050),a=n.n(o),c=i()?a():s,d=new Set,l=!1;function u(e){if(l||(l=!0,c.add(h)),"function"!=typeof e)throw new Error("Listener is no function");return d.add(e),{remove:function(){return d.delete(e)},run:function(){return d.delete(e),e()}}}function h(){var e=[];return d.forEach((function(t){e.push(t()),d.delete(t)})),Promise.all(e)}function p(){d.clear()}function f(){return d.size}},6994:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return fe}});var r={};n.r(r),n.d(r,{fixNegotiationNeeded:function(){return x},shimAddTrackRemoveTrack:function(){return O},shimAddTrackRemoveTrackWithNative:function(){return E},shimGetDisplayMedia:function(){return w},shimGetSendersWithDtmf:function(){return k},shimGetStats:function(){return P},shimGetUserMedia:function(){return C},shimMediaStream:function(){return R},shimOnTrack:function(){return T},shimPeerConnection:function(){return I},shimSenderReceiverGetStats:function(){return D}});var i={};n.r(i),n.d(i,{shimGetDisplayMedia:function(){return M},shimGetUserMedia:function(){return N},shimPeerConnection:function(){return L},shimReplaceTrack:function(){return j}});var s={};n.r(s),n.d(s,{shimAddTransceiver:function(){return q},shimCreateAnswer:function(){return Y},shimCreateOffer:function(){return J},shimGetDisplayMedia:function(){return U},shimGetParameters:function(){return H},shimGetUserMedia:function(){return F},shimOnTrack:function(){return $},shimPeerConnection:function(){return G},shimRTCDataChannel:function(){return z},shimReceiverGetStats:function(){returfunction(){return t}function y(e){return"[object Object]"===Object.prototype.toString.call(e)et"=stringify(e)),i(e)ction(e){return n.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",eLocalStreams[e.id]=[e].concat(r)};const r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shim.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},(e);const n=e.RTCPeerConnection.prototype.getLocalStream;e.RTCPeerConnection.prototype.addStr")})),!this._reverseStreams[t.id]){consl(arguments,1);if(1!==r.length||!r[0].ge},this._reverseStreams=this._reverseStreams||{};const i=this._streams[n.id];if(i)i.addTrack(t),Promise.resolvets.length&&"function"==typeof arguments[0]?n.apply(this,[t=>{const n=s(this,t);e[0].apply(null,[n])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):n.apply(this,argume=r[t]}));const o=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(e,t){let n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const r=e._reverseStreams[t],i=e._streams[r.id];n=n.replace(new RegExp(r.id,"g"),i.id)})),new RTCSessionDescription({type:t.type,sdp:n})}(this,arguments[0]),o.apply(this,arguments)):o.apply(this,arguments)};const a=Object.getOwnPropertyDty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=a.get.apply(this);return""===e.type?e:s(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(e._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach((n=>{this._streams[n].getTracks().find((t=>e.track===t))&&(t=this._streams[n])})),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.treerConnection)return;const n=0===e.RTCPeerConnectionTCPeerConnection.prototyp2||n.getConfiguration&&"plan-b"===n.getConfiguration().sdpSemantics)||"stable"===n.signalingState)return e}))}var B=n(2226),A=n.n(B);function N(e){const t=e&&evices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return n(e).catch((e=>Promise.reject(function(e){return{name:{PermissionDeniedError){return this.name}}}(e))))}}function M(e){"getDisplayMedia"in e.navigator&&e.navigator.mediaDevices&&(e.navigatornction L(e){const t=g(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSesull)),this._dtmf}}),e.RTCDtmfSender&&!e.RTe,t){let n=!1;return(e=JSON.parse(JSON.stringify(e))).filter((e=>{if(e&&(e.urls||e.ur]),t=t.filter((e=>{if(0===e.indexOf("stun:"))return!1;const t=e.startsWith("turn")&&!e.startsWith("turn:[")&&e.includes("transport=udp");return t&&!n?(n=!0,!0):t&&!n})),delete e.url,e.urls=r?t[0]:t,!!t.length}}))}(e.iceServers,t.type.replaceTrack=e.RTCRtpSender.prototype.setTrack)}function F(e){const t=g(e),n=e&aDevices.getUserMedia(e).then(t,r)},!(t.version>55&&"autoGainControl"in n.mediaDevices.getSupportedConobt=r.prototype.applyConstraints;r.prototype.applyConstraints=function(n){return"audio"===this.kind&&"object"==typeof n&&(n=JSON.parse(JSON.stringify(n)),e(n,"autoGainControl","mozAutoGainControl"),e(n,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[n])}}}}function U(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(n){if(!n||!n.video){const e=new DOMException("getDisplayMedia without video constraints is undever"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEven.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const n=e.RTCPeerConnection.prototype[t],r={[t](){ree.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),u(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function V(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){m("removeStream","removeTrack"),this.getSenders().forEach((t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)}))})}function z(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function q(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];const e=arguments[1],n=e&&"sendEncodings"in e;=>{if("rid"in eate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const r=t.apply(this,arguments);if(n){const{sender:t}=r,n=t.getParameters();(!("encodings"in n)||1===n.encodings.length&&0===Object.keys(n.encodings[0]).length)&&(n.encodings=e.sendEncodings,t.sendEncodings=e.sendEncodings,this.setParametersPromises.push(t.setParameters(n).then((()=>{delete t.sendEncodings})).catch(((t.direction&&(teCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const n=new t(e),r=ae().parseCandidate(e.candidate),i=Object.assign(n,r);return i.toJSON=function(){return{candidate:i.candidate,sdpMid:i.sdpMid,sdpMLineIndex:i.sdpMLineIndex,usernameFragment:i.usernate.prototype=t.prototype,u(e,"icecin e.RTCPeerConnection.ection.prototypepSemas(e.sdp);return t.shift(),t.some((e=>{const t=ae().parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))}(arguments[0])){const e=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\ange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescriptiotate!==t.connectionState){t._lastConnectionState=t.connectionState;const n=new Event("connectionstatechange",e);t.dispatchEvent(n)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),n.apply(this,arguments)}}))}function he(e){if(!e.RTCPeerConnection)return;const t=g(e);if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t.version>=605)return;const n=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(e){return e&&e.sdp&&-1!==e.sdp.indexOf("\na=extmap-allow-mixed")&&(e.sdp=e.sdp.split("\n").filter((e=>"a=extmap-allow-mixed"!==e.trim())).join("\n")),n.apply(this,arguments)}}const pe=function({window:e}={},t={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0}){const n=f,c=g(e),d={browserDetails:c,commonShim:a,extractVersion:l,disableLog:h,disableWarnings:p};switch(c.browser){case"chrome":if(!r||!I||!t.shimChrome)return n("Chrome shim is not included in this adapter release."),d;if(null===c.version)return n("Chrome shim can not determine version, not shimming."),d;n("adapter.js shimming chrome."),d.browserShim=r,C(e),R(e),I(e),T(e),O(e),k(e),P(e),D(e),x(e),ce(e),ue(e),de(e),le(e),he(e);break;case"firefox":if(!s||!G||!t.shimFirefox)return n("Firefox shim is nrn n("Safari shim is noe),senew Date);return e!==t?(s=0,t=e):e+"."+a(s++)}for(;o<r;o++)i[n[o]]=o;c.encode=a,c.decode=function(e){var t=0;for(o=0;o<e.length;o++)t=t*r+i[e.charAt(o)];return t},e.exports=c},5050:function(){},3203:function(e){e.exports=function(e){return e&&e.__esModule?e:{default:e}},e.exports.__esModule=!0,e.exports.default=e.exports},7501:function(e){function t(n){return e.exports=t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e.exports.__esModule=!0,e.exports.default=e.exports,t(n)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports},208:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Socket=t.io=t.Manager=t.protocol=void 0;const r=n(8303),i=n(6907),s=n(6899);Object.defineProperty(t,"Socket",{enumerable:!0,get:function(){return s.Socket}});const o=n(6292)("socket.io-client");e.exports=t=c;const a=t.managers={};function c(e,t){"object"==typeof e&&(t=e,e=void 0),t=t||{};const n=r.url(e,t.path),s=n.source,c=n.id,d=n.path,l=a[c]&&d in a[c].nsps;let u;return t.forceNew||t["force new connection"]||!1===t.multiplex||l?(o("ignoring socket cache for %s",s),u=new i.Manager(s,t)):(a[c]||(o("new io instance for %s",s),a[c]=new i.Manager(s,t)),u=a[c]),n.query&&!t.query&&(t.query=n.queryKey),u.socket(n.path,t)}t.io=c;var d=n(8552);Object.defineProperty(t,"protocol",{enumerable:!0,get:function(){return d.protocol}}),t.connect=c;var l=n(6907);Object.defineProperty(t,"Manager",{enumerable:!0,get:function(){return l.Manager}})},6907:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Manager=void 0;const r=n(6306),i=n(6899),s=n(4398),o=n(8552),a=n(8666),c=n(2307),d=n(6292)("socket.io-client:manager");t.Manager=class extends s{constructor(e,t){super(),this|1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor(t.randomizationFactor||.5),this.backoff=new c({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==t.timeout?2ttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return void 0===e?this._reconnectionDelay:(this._reconnectionDelay=e,null===(t=this.backoff)||void 0===t||t.setMin(e),this)}randomizationFactor(e){var t;return void 0===e?this._domizationFactor=e,null===(t=this.backoff)||void 0===t||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return void 0===e?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,null===(t=this.backoff)||void 0===t||t.setMax(e),this)}timeout(e){ting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()}open(e){if(d("readyState %s",this._readyState),~this._readyState.indexOf("open"))return this;d("opening %s",this.uri),this.engine=r(this.uri,this.opts);const t=this.engine,n=this;this._readyState="opening",this.skipReconnect=!1;const i=a.on(t,"open",(function(){n.onopen(),e&&e()})),s=a.on(t,"error",(t=>{d("error"),n.cleanup(),n._readyState="closed",super.emit("error",t),e?e(t):n.m1!==this._timeout){const e=thimeout after %d",e),0===e&&i();const n=setTimError("timeout"))}),e);this.subs.push((function(){clearTimeout(n)}))}return this.subs.push(i),this.subs.push(s),this}connect(e){return this.open(e)}onopen(){){d("error",e),super.emit("error",e)}socket(e,t){let n=this.nsps[e];return n||(n=new i.Socket(this,e,t),this.nsps[e]=n),n}_destroy(e){const t=Object.keys(this.nsps);for(const e of t)if(this.nsps[e].active)return void d("socket %s is still active, skipping close",e);this._close()}_packet(e){d("writing packet %j",e);const t=this.encoder.encode(e);for(let n=0;n<t.length;n++)this.engine.write(t[n],e.options)}cleanup(){d("cleanup"),this.subs.forEach((e=>e())),this.subs.length=0,this.decoder.destroy()}_close(){d("disconnect"),this.skipReconnect=!0,this._reconnecting=!1,"opening"===this._readyState&&this.cleanup(),this.backoff.reset(),this._readyState="closed",this.engine&&this.engine.close()}disconnect(){return this._close()}onclose(e){d("onclose"),this.cleanup(),this.backoff.reset(),this._readyState="closed",super.emit("close",e),this._rnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempf.duration();d("will wait %dms before reconnect attempt",t),this._reconnecting=!0;const n=setTimeout((()=>{e.skipReconnect||(d("attempting reconnect"),super.emit("reconnect_attempt",e.backoff.attempts),e.skipReconnect||e.open((t=>{t?(d("reconnect attempt error"),e._reconnecting=!1,e.reconnect(),super.emit("reconnect_error",t)):(d("reconnect success"),e.onreconnect())})))}),t);this.subs.push((function(){clearTimeout(n)}))}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),super.emit("reconnect",e)}}},8666:function(e,t){"use strict";Object.defineProperty(t,"__esModule",tructor(e,t,n){super(),thiags={},this.io=e,this.nsp=t,this.ids=0,this.acks={},this.receiveBuffer=[],this.sendBuffer=[],this.connected=!1,this.disconnected=!0,this.flags={},n&&n.auth&&(this.auth=n.auth),this.io._autoConnect&&this.open()}subEvents(){if(this.subs)return;const e=this.io;this.subs=[s.on(e,"open",this.onopen.bind(this)),s.on(e,"packet",this.onpacket.bind(this)),s.on(e,"error",this.onerror.bind(this)),s.on(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected||(this.subEvents(),this.io._reconnecting||this.io.open(),"open"===this.io._readyState&&this.onT,data:t,options:{}};n.options.compress=!1!==this.flags.compress,"function"==typeof t[t.length-1]&&(o("emitting packet with ack id %d",this.ids),this.acks[this.ids]=t.pop(),n.id=this.ids++);const i=this.io.engine&&this.io.engine.transport&&this.io.engine.transport.writable;return!this.flags.volatile||i&&this.connected?this.connected?this.packet(n):this.sendBuffer.push(n):o("discard packet as the transport is not currently writable"),this.flags={},this}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){o("transport is open - connecting"),"function"==typeof this.auth?this.auth((e=>{this.packet({type:r.PacketType.CONNECT,data:e})})):this.packet({type:r.PacketType.CONNECT,data:this.auth})}onerror(e){this.connected||super.emit("connect_error",e)}onclose(e){o("close (%s)",e),this.connected=!1,this.disconnected=!0,delete this.id,super.emit("disconne.data.data,super.emit("connect_error",t)}}onevent(e){const t=e.data||[];o("emitting event %j",t),null!=e.id&&(o("attaching ack callback %s",e.id)}onconnect(e){o("st"),this.emitBuffered()}emitBuffered(){this.receiveBuffer.forEach((e=>this.emitEvent(e))rming disconnect (%s)",this.nsp),this.packet({type:r.PacketType.DISCONNECT})),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}}},8303:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.url=void 0;const r=n(5649),i=n(6292)("socket.io-client:url");t.url=function(e,t="",n){let s=e;n=n||"undefined"!=typeof location&&location,null==e&&(e=n.protocol+"//"+n.host),"string"==typeof e&&("/"===e.charAt(0)&&(e="/"===e.charAt(1)?n.protocol+e:n.host+e),/^(https?|wss?):\/\//.test(e)||(i("protocol-less url %s",e),e=void 0!==n?n.protocol+"//"+e:"https://"+e),i("parse %s",e),s=r(e)),s.port||(/^(http|ws)$/.test(s.protocol)?s.port="80":/^(http|ws)s$/.test(s.protocol)&&(s.port="443")),s.path=s.path||"/";const o=-1!==s.host.indexOf(":")?"["+s.host+"]":s.host;return s.id=s.protocol+"://"+o+":"+s.port+t,s.href=s.protocol+"://"+o+(n&&n.port===s.port?"":":"+s.port),s}},2712:function(e,t,n){"use strict";n.r(t),n.d(t,{__assign:function(){return s},__asyncDelegator:function(){return T},__asyncGenerator:function(){return R},__asyncValues:function(){return k},__await:function(){return w},__awaiter:function(){return f},__classPrivateFieldGet:function(){return I},__classPrivateFieldIn:function(){return B},__classPrivateFieldSet:function(){return x},__createBinding:function(){return g},__decorate:function(){return a},__esDecorate:function(){return d},__exportStar:function(){return y},__extends:function(){return i},__generator:function(){return m},__importDefault:function(){return O},__importStar:function(){return E},__makeTemplateObject:function(){return P},__metadata:function(){return p},__param:function(){return c},__propKey:function(){return u},__read:function(){return b},__rest:function(){return o},__runInitializers:function(){return l},__setFunctionName:function(){return h},__spread:function(){return _},__spreadArray:function(){return C},__spreadArrays:function(){return S},__values:function(){return v}});var r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},r(e,t)};function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var s=function(){return s=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},s.apply(this,arguments)};functe||null))};var g=(0,n[p])("accessor"===c?{get:u.get,set:u.set}:u[d],f);if("accessor"===c){if(void 0===g)continue;if(null===g||"object"!=typeof g)throw new TypeError("Object expected");(a=o(g.get))&&(u.get=a),(a=o(g.set))&&(u.set=a),(a=o(g.init))&&i.unshift(a)}else(a=o(g))&&("field"===c?i.unshift(a):u[d]=a)}l&&Object.defineProperty(l,r.name,u),h=!0}function l(e,t,n){for(var r=arguments.length>2,i=]?r.return:a[0]?r.t];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}var g=Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]};function y(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||g(t,e,n)}function v(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){r[Symbol.iterator];if(!n)return e;var r,i,s=n.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(r=s.next()).done;)o.push(r.value)}catch(e){i={error:e}}finally{try{r&&!r.done&&(n=s.return)&&n.call(s)}finally{if(i)throw i.error}}return o}function _(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(b(arguments[t]));return e}function S(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),i=0;for(t=0;t<n;t++)for(var s=arguments[t],o=0,a=s.length;o<a;o++,i++)r[i]=s[o];return r}function C(e,t,n){if(n||2===arguments.length)for(var r,i=0,s=t.length;i<s;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[ir r,i=n.apply(e,t||[]),s=[];return r={},o("next"),o("throw"),o("return"),r[Symbol.asyncIterator]=function(){return this},r;function o(e){i[e]&&(r[e]=function(t){return new Promise((function(n,r){s.push([e,t,n,r])>1||a(e,t)}))})}function a(e,t){try{(n=i[e](t)).value instanceof w?Promise.resolve(n.value.v).then(c,d):l(s[0][2],n)}catch(e){l(s[0][3],e)}var n}function c(e){a("next",e)}function d(e){a("throw",e)}function l(e,t){e(t),s.shift(),s.length&&a(s[0][0],s[0][1])}}function T(e){var t,n;return t={},r("next"),r("throw",(function(e){throw e})),r("return"),t[Symbol.iterator]=function(){return this},t;function r(r,i){t[r]=e[r]?function(t){return(n=!n)?{value:w(e[r](t)),done:!1}:i?i(t):t}:i}}function k(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e=v(e),t={},r(:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)}function x(e,t,n,r,i){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?i.call(e,n):i?i.value=n:t.set(e,n),n}function B(e,t){if(null===t||"object"!=typeof t&&"function"!=typeof t)throw new TypeError("Cannot use 'in' operator on non-object");return"function"==typeof e?t===e:e.has(t)}t.default={__extends:i,__assign:s,__rest:o,__decorate:a,__param:c,__metadata:p,__awaiter:f,_dArrays:S,__spreadArray:C,__await:w,__asyncGenerator:R,__asyncDelegator:T,__asyncValues:k,__makeTemplateObjec:function(){return Wn},Rangey.isArray;function o(e,t){return"objec"undefined"==typ.length;r<urn n}var o=t.indexOf(".");if(-1!==o){var a=e[t.substr(0,o)];return void 0===a?void 0:C(a,t.substr(o+1))}}function w(e,t,n){if(e&&void 0!==t&&(!("isFrozen"in Object)||!Object.isFrozen(e)))if("sof n&&"length"in n);for(var r=0,i=t.length;r<i[r],n[r])}elsring,Date,RegExp,Bluffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",")filteor(var i in t=n===Object.prototype&&(t[i]=I(e[i]))}return t}const{toString:x}={};function B(e){return x.call(e).slice(8,-1)}const A="undefinedteratterator",N="symbol"==typeof Aurn n}if(null==e)return[e];if("number"==typeof(t=e.length)){for(n=new Array(t);t--;)n[t]=e[t];return n}return[e]}for(t=arguments.length,n=new Array(t);t--;)n[t]=arguments[t];return n}const j="undefined"!=typeof Symbol?e=>"AsyncFunction"===e[Symbol.toStringTag]:()=>!1;var F="undefined"!=typeof location&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function U(e,t){F=e,$=t}var $=()=>!0;const G=!new Error("").stack;function W(){if(G)try{throw W.arguments,new Error}catch(e){return e}return new Error}function K(e,t){var n=e.stack;return n?(t=t||0,0===n.indexOf(e.name)&&(t+=(e.name+e.message).split("\n").length),n.split("\n").slice(t).filter($).map((e=>"\n"+e)).join("")):""}va:"Database version changed by otborted",Trleted or failed",MissingAPI:"IndexedDB API m://tinyurl.com/y2uuvskb"};functinction Q(e,t){this._e=W(),this.name="BulkError",this.failures=Object.keys(t).map((,this.message=J(e,._staeturn e===re?t:function(n){var r=e.apply(this,arguments);o(n,r);var i=this.onsuccess,s=this.onerr,this.onerror):s),void 0===r?void 0===a?void 0:a:o(r,a)}}functio===re?t:function(){return!1!==t.apply(this,arguments)&&e.applh,shen((function(){return t.apply(r,s)}))}return t.apply(this,arguments)}}ne.ModifyError=Y,ne.DexieError=H,ne.BulkError=Q;var.resolve();if("undefined),we&&(_e(),w[],Io"function"!=typeof e){ition n(n,r){var i=!e.global&&(e!==Ee||t!==Ze);const s=i&&!rt();var o=new Be(((t,o)=>{Fe(this,new Ne(ut(n,e,i,s),ut(r,e,i,s),t,o,e))}));return F&&Ge(o,this),o}return n.prototype=he,Anu=n,this.reject=r,t(e._stackHolder,2))v,t,n)t=0;t<n;!0,we=!0}fu!1,e)}fun.prototype,{then:Ae,_then:function(e,t){Fe(this,new Ne(null,null,e,t,Ee))},catch:function(e){if(1===arguments.length)returnunction(("\nFrom previo(n,r)=>{var i=setTimeout((()=>r(new ee.Timeout(t))),e);this.then(n,r).finally(clearTimeout.bind(null,i))})):this}}),"undefined"!=typeof Symbol&StringTag&&h(Be.prototype,Symbol.toStringTag,"Dexie.Promise"),De.env=ct(),l(Be,{all:function(){var e=L.apply(null,arguments).map(itt([]);var r((i,s)=e:e=>{if(e instanceof Be)return e;if(e&&"function"==typeof e.then)return:dt,scheduler:{get:()=>Se,set:e=>{Se=e}},rejectionMapper:{this.unhandleds.length?t():n(this.unhandleds[0])}))}),r.finalize),e e?e:function(){var i=Ee;n&&nt(),at(t,!0);try{return e.apply(this,arguments)}finally{at(i,!1),r&&lt(rt)}}}function ht(e,t){return function(n,r){return e.call(this,ut(n,t),ut(r,t))}}function pt(e,t){var n;try{n=t.onuncatched(e)}catch(e){}if(!1!==n)try{var i,s={promise:t,reason:e};if(r.document&&document.createEvent?((i=document.createEvent("Event")).initEvent("unhandledrejection",!0,!0),o(i,s)):r.CustomEvent&&o(idetail:satchEvent(i),!r.PromiseRejectionEvent&&r.onunhandledrejection))try{r.onunhandledrejection(i)}catch(e){}F&&i&&!i.defaultPrevented&&console.warn(`Unhandled rejection: ${e.stack||e}`)}catch(e){}}-1===(""+ge).indexOf("[native ce);var ft=Be.reject;function mt(e,t,n,r){if(e.idbdb&&(e._state.openComplete||Ee.letThrough||e._vip)){var i=e._createTransaction(t,n,e._dbSchema);try{i.create(),e._state.PR1398_maxLoop=3}catch(i){return i.name===X.InvalidState&&e.isOpen()&&--e._=>tt((()=>(Ee.trans=i,r(e,t,i)))))).then((e=>i._completion.then((ngOpened>e.compound&&t.every((t=>e.keyPath.indexOf(t)>=0))&&e.keyPath.every((e=>t.indexOf(e)>=0))))[0];if(n&&this.db._maxKey!==gt)return this.where(n.name).equals(n.keyPath.map((t=>e[t])));!n&&F&&console.warn(`The query ${JSON.stringify(e)} on ${this.name} would benefit of a co;return r&&n&&(i=Tt(r)(e)),this._trans("readwrite",(e=>this.core.mutate({trans:e,type:"put",values:[i],keys:null!=t?[t]:null}))).then((e=>e.numFailures?Be.reject(e.failures[0]):e.lastResult)).then((t=>{if(r)try{w(e,r,t)}catch(e){}return t}))}delete(e){return this._trans("readwrite",(t=>this.core.mutate({trans:t,type:"delete",keys:[e]}))).then((e=>e.numFailures?Be.reject(e.failures[0]):void 0))}clear(){return this._trans("readwrite",(e=>this.core.mutate({trans:e,type:"deleteRange",range:Rt}))).then((e=>e.numFailures?Be.reject(e.failures[0]):void 0))}bulkGet(e){return this._trans("readonly",(t=>this.core.getMany({keys:e,trans:t}).then((e=>e.mUt=(e,t)=>t.value=null;function $t(e,t){return e<t?-1:e===t?0:1}function Gt(e,t){return e>t?-1:e===t?0:1}function Wt(e,t,n){var r=e instanceof Jt?new e.Collection(e):e;return r._ctx.error=n?new n(t)(""))).limit(0)}function Vt(e,t,n,r,a=-1,c=i(e[c],n[c])<0?e.substr(0,c)+n[c]+n.substr(c+1):i([c]+n.substr(c+1):a>=0?e.substr(0,a)+t[a]+n.substr(a+1):nullturn o<r.length&&"next"length):o<e.length&&"prev"===s?eower(e){retn(e,n,r){var i=e.key;if("string"!=typeof i)return!1;var h=s(i);if(t(h,c,f))returngth-1])));n._ondirectionchange=n=>{t="next"===n?this._ascending:this._descending,e.sort(t)};let r=0;return n._addAlgorithm(((n,i,.length)return i(s),!1;return 0===t(o,e[r])||(i((()=>{n.continue(e[r])})),!1)})),n}notEqual(e){return this.inAnyRange([[-1/0,e],[e,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})}noneOf(){const e=L.apply(M,arguments);if(0===his);try{e.sortKey]),this.inAnyRange(t,{includeLowers:!1,includeUppers:!1})}inAnyRange(e,t){const n=this._cmp,r=this._min,o=this._max;if(0===e.length)return Ktoid 0!==e[1]&&r(e[0],e[1])<=0)() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than low!t||!1!==t.includeLowers,c=t&&!0===t.includeUppers;let d,l=r(function(ea,!c)));return g._ondirectionchanitidbtrans.abort(),this._reject(nbort))}table(e){const t=this._memoizedTables||(this._memoizedT);if(d(t,e))reee.NotFo);return r.core=th:e,primKey:t,indexes:n,mappcrement:n}=e,r=s(t),i=null==t,o={},a={name:e.name,primaryKey:{name:null,isPrimary;if(0===nst[let t=0;t<h;++t)f.push(p=,key:n})=>new P;i&&(1;return this.start((()=>e--?tthis.stop())).then((()=>this))},n.start=e=>{const t=new P.continue=n.continuePrimaryKey=n.advance=o,e(t)}})),a=()=>{if(f.result)try{e()}catch(e){n.fail(e)}else n.done=!0,n.start=()=>{throw new Error("Cursor behind lastccess=He((e=>{f.onsuccess=a,a()})),n.continue=r,n.continuePrimaryKey=i,n.advance=s,a(),t},a(n)}),c)}))},cam,i),e.dbcore);return{dbcore:s}}(e._middlewares,n,e._deps,t);e.core=r.dbcore,e.tables.forEach((t=>{const n=t.name;e.core.schema.tables.some((e=>e.name===n))&&(t.core=e.core.table(n),e[n]instanceof e.Table&&(e[n].core=t.core))})ch((n=>{const i=r[n];,n);(!r||"value"in r&&void 0===r.value)&&(t===e.Transaction.prototype||t instanceof e.Transaction?h(t,n,{get(){return th(this,n,{value:e,writabforEach((e,yn(t._cfg.veotype]),un(e,[e.Transactalued");r.forEach((e=>{if(e.auto)throw new ee.Schema("Only primary key can be marked as autoIncrement (++)");if(!e.keyPath)throw new ee.Schema("Index must have a name and cigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise((function(t){var n=function(){return indexedDB.databases().finally(t)};e=setInterval(n,100),n()})).finally((function(){return clearInterval(e)})):Promise.resolve()}function Tn(e){var t=t=>e.next(t),n=i(t),r=i((t=>e.throw(t))) t=>{var i=e(t),o=i.value;return i.done?o:o&&"function"ee.InvalidArgument("Too few arguments");for(var i=new Array(en((()=>{const s=Ee.trans),a={tranidbtrX.InvalidState&&e.isOpen()&&--e._state.PR1398_maxLoop>0?(console.warn("Dexie: Need to reopen db"),e._close(),e.open().then((()=>Pn(e,t,n,null,i)action committed too early. See http://bit.ly/2kdckMn")))):l.then((()=>d))).then((e=>(r&&o._resolve(),o._completion.then((()=>e))))).catch((e=>(o._reject(e),ft(e))))}))}function Dn(e,t,n){const r=s(e)?e.slice():[e];for(let e=0;e<n;++e)r.push(t);return r}const En={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(e){return{...e,table(t){const n=e.table(t),{schema:r}=n,i={},s=[];function o(e,t,n){const r=cn(e),a=i[r]=i[r]||[],c=nl={...n,isVirtual:d,keyTail:t,keyLength:c,extractKey:sn(en,schema:{...rntinue(Dn(i,t.reverse?e.MAX_KEY:e.MIN_KEY,r)):t.unique?n.continue(n.key.slice(0,s).concat(t.reverse?e.MIN_KEY:e.MAX_KEY,r)):n.continue()}},continuePrimaryKey:{value(t,i){n.continuePrimaryKey(Dn(t,e.MAX_KEY,r),i)}},primaryKey:{get:()=>n.primaryKey},key:{get(){const e=n.key;return 1===s?e[0]:e.slice(0,s)}},value:{get:()=>n.value}});return i}(n))):n.openCursor(t)}};return d}}}};function On(e,t,n,r){return n=n||{},r=r||"",i(e).forEach((i=>{if(d(t,i)){var s=e[i],o=t[i];if("object"==typeof s&&"object"==typeof o&&s&&o){const e=B(s);e!==B(o)?n[r=o&&(n[r+i]=t[i])}else s!==o&&(n[r+i]=t[i])}else n[r+i]=void 0})),i(ddleware",level:2,create:e=>({...e,table(t){const n=e.table(t),{primaryKey:r}=n.schema,i={...n,mutate(e){const i=Ee.trans,{deleting:s,creating:o,updating:a}=i.table(t).hook;swire&&a.fire======e.type)s.fire.call(u,n,l,t);else if("add"===e.type||void 0===l){const s=o.fire.call(u,n,e.vs[e]:w(t,e,s[e])}))}}return u}));return n.mutate(e).then((({failures:t,results:n,numFailures:r,lastResult:s})=>{for(let r=0;r<i.length;++r){const s=n?n[r]:i[r],o=l[r];null==s?o.onerror&&o.onerror(t[r]):o.onsuccess&&o.onsuccess("put"===e.type&&c[r]?e.values[r]:s)}return{failures:t,results:n,numFailures:r,lastResult:s}})v,lowerOprn!("from"in e)}const Nn=function(e,t){if(!this){const t=new Nn;return e&&"d"in e&&o(t,e),t}o(this,arguments.length?{d:1,from:e,to:arguments.length>1?t:e}:{d:0})};function Mn(e,t,n){const r=Mt(t,n);if(isNaN(r))return;if(r>0)throw RangeError();if(An(e))return o(e,{from:t,to:n,d:1}}return!1}functi:0,n:eents.leor(m)<0;)t={up:t,n:t.n.l,s:1};else for(;t.n.l;)t={up:t,n:t.n.l,s:1};case 1:if(t.s=2,!n||Mt(e,t.n.to)<=0)return{value:t.n,done:!1};case 2:if(t.n.r){t.s=3,t={up:t,n:t.n.r,s:0};continue}case 3:t=t.up}return{done:!0}}}}function Un(e){var t,n;const r=((null===(t=e.r)||void 0===t?void 0:t.d)||0)-((null===(n=e.l)||void 0===n?void 0:n.d)||0),i=r>1?"r":r<-1?"l":"";if(i){const t="r"===i?"l":"r",n={...e},r=e[i];e.from=r.from,e.to=r.to,e[i]=r[i],n[i]=r[t],e[t]=n,n.d=$n(n)}e.d=$n(e)}function $n({r:e,l:t}){return(e?t?Math.max(e.d,t[p,f]=(e=>{if(p=e.resm);t||"add"===h||u.addKeys(p),(t||f)&&function(e,t,n,r){t.indexes.forEach((function(t){const i=e(t.name||=>t.multiEntry&&s(e)?e.forEach((e=>i.addKey(e))):i.addKey(e);(n||r).forEach(((e,t)=>{const i=n&&o(n[t]),s=r&&o(r[t]);0!==Mt(i,s)&&(null!=i&&a(i),null!=s&&a(s))}))}))}(d,a,t,f)}else if(p){constn(i){const{subscr:s}=Ee;if(s){const a=e=>{const n=`idb://${t}/${r}/${e}`;return s[n]||(s[n]=new Nn)},c=a(""),u=a(":dels"),[h,f]=p[e](i);if(a(h.name||"").add(f),!h.isPrimaryKey){if("count"!==e){const t="query"===e&&l&&i.values&&o.query({...i,values:!1});return o[e].apply(this,arguments).then((n=>{if("query"===e){if(l&&i.values)return t.then((({result:e})=>(c.addKeys(e),n)));const e=i.values?n.result.map(d):n.result;i.values?c.addKeys(e):u.addKeys(e)}else if("openCursor"===e){const e=n,t=i.values;return e&&Object.create(e,{key:{get:()=>(u.addKey(e.primaryKey),e.key)},primaryKey:{get(){const t=e.primaryKey;return u.addKey(t),t}},value:{get:()=>(t&&c.addKey(e.primaryKey),e.value)}})}return n}))}u.add(n)}}return o[e].apply(this,arguments)}})),u}}}};class Wn{constructor(e,t){this._middlewares={},this.verno=0;const n=Wn.dependencies;this._options=t={addons:Wn.addons,aunull,isBeingOpened:!1,onReadyBeingFired:nul(()=>{const r=(e)}))}}))})),this.Coll(this),this.Transacity=i,this.idbtrans=nule()}),(e=>{var t=this.active;reontentUpgrade:null}})s._ascending=i.cmp.bind(i),this._descending=(e,t)=>i.cmp(eyRange=e._deps.IDBK Closing db now to resume the upgrade.`):console.warn(`Another connection wants to delete database '${this.namg .openComplete||Ee.letThrough||this._vip)?e():new Be(((e,t)=>{if(this._state.openComplete)return t(new ee.DatabaseClosedtate.isBeingOpened){if(!this._options.autoOpen)return void t(new ee.DatabaseClosed);this.open().catch(re)}this._state.dbk:e,name:r});const i=this._middlewares[e]||(this._middlewares[e]=[]);return i.push({stack:e,create:t,level:null==n?10:n,name:r}),i.sort(((e,t)=>e.level-t.level)),this}unuse({stack:e,name:t,create:n}){return e&&this._middlewares[e]&&(this._middlewares[e]=this._middlewares[e].filter((e=>n?e.create!==n:!!t&&e.name!==t))),this}open(){return function(e){const t=e._state,{indexedDB:n}=e._deps;if(t.isBeingOpened||e.idbdb)return t.dbReadyPromise.then((()=>t.dbOpenError?ft(t.dbOpenError):e));F&&(trror=null,t.openComplete=!1;const r=t.openCanceller;function s(){if(t.openCanceller!==r)throw new ee.DatabaseClosed("db.open() was cancelled")}let o=t.dbReadyResolve,a=null,c=!1;return Be.race([r,("undefined"==typeof navigator?Be.resolve():Rn()).then((()=>new Be(((r,o)=>{if(s(),!n)throw new ee.M(e._fireOnBlocked),l.onupgraleteDatabase(d);e.onsuccess=e.onerror=He((()=>{o(new ee.NoSuchDatabase(`Database ${d} doesnt exist`))}))}else{a.onerror=Yt(o);var i=r.oldVersion>Math.pow(2,62)?0:r.oldVersion;c=i<1,e._novip.idbdb)=>{a=null;consts=y(n.objectStoreNames);if(s.length>0)try{const r=n.transaction(1===(o=s).length?o[0]:o,"readonly");t.autoSchema?function({_novip:e},t,n.add.lengthhemaDiff: Schema was ex)}catch(e){nchange=Hue,re);return t.onReadyBeingFired=[],Be.resolve(wn((()=>r(e.vip)))).then(n)}}))))).finally((()=>{t.onReadyBeingFired=null,t.isBeingOpened=!1})).then((()=>e)).catch((n=>{t.dbOpenError=n;try{a&&a.abort()}catch(e){}return r===t.openCanceller&&e._close(),ft(n)})).finally((()=>{t.openComplete=!0,o()}))}(this)}_close(){const e=this._state,t=vt.indexOf(this);if(t>=0&&vt.splice(t,1),this.idbdb){try{this.idbdb.close()}catch(e){}this._novip.idbdb=null}e.dbReadyPromise=new Be((t=>{e.dbReadyResolve=t}))tion({indexedDB:e,IDBKeyRange:t},n){!Cn(e)&&"__dbnames"!==n&&Sn(e,t).delete(n).catch(re)}(this._deps,this.name),n()})),e.onerror=Yt(r),e.onblocked=this._fireOnBloc==this.idbdb}hasBeenClosed(){const e=this._state.dbOpenError;return e&&"DatabaseClosed"===e.name}hasFailed(){return null!==this._state.dbOpenError}dynamicallyOpened(){return this._state.autoSchema}get tables(){return i(this._allTables).map((e=>this._allTables[e]))}transaction(){const e=kn.apply(this,arguments);return this._transaction..replace("!","").replace("?","");try{if(o=t.map((e=>{var t=e insable?e.name:e;if("string"!=typeof t)throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");returnsaction mode: "+e);s="readwrite"}if(r){if("readonly"===r.mode&&"readwrite"===s){if(!i)throw  parent transaction.");r=null}})),i&&r&&!r.active&&(r=null)}}catch(e){return r?r._promise(null,((t,n)=>{n(e);return r?r._promise(s,a,"lock"):Ee.trans?dt(Ee.transless,(()=>thi_whenReadys.](){return this}}function zn(e,t){return i(t).forEach((n=>{Ln(e[n]||(e[n]=new Nn),t[n])})),e}function qn(e){return new Vn((t=>{const n=j(e);let r=!1,s={},o={};const a={get closed(){return r},unsubscribe:()=>{rnction l(){return )}const>tt(e,{subscr:t,let Hn;try{H.mozIndexedDB||r.wyRange:r.IDBKe)}fin!0))).catch("NoSuchDatab,getDatabter((e=>"__dbnames"!==e)))):Sn(e}(Jn.dependencies).then(e)}catch(e){return ft(new ee.MissingAPI)}},defineClass:()=>function(e){o(this,e)},ignoreTransaction:e=>Ee.trans?turn t&&"function"==typeof t.then?t:Be.resolve(t)}catch(e){return ft(e)}}},spawn:function(e,t,n){try{var r=Tn(e.apply(n,t||[]));return r&&"function"==typeof r.then?r:Be.resolve(r)}catch(e){returget:()=>Ee.trans||null},waitFor:function(e,t){const n=Be.resolve("function"==typeof e?Jn.ignoreTransaction(e):e).timeout(t||6e4);return Ee.trans?Ee.trans.waitFor(n):n},Promise:Be,debug:{get:()=>F,set:e=>{U(e,"dexie"===e?()=>!0:Ct)}},derive:p,extend:o,props:l,override:v,Events:Pt,on:Xt,liveQuery:qn,extendObservabilitySet:zn,getByKeyPath:C,setByKeyPath:w,delByKeyPath:functt?w(e,t,void 0):"length"in t&&[].map.call(t,(function(t){w(e,t,void 0)}))},shallowClone:R,deepClone:O,getObjectDiff:On,cmp:Mt,[],connectionsies:Hn,semVer:"3.2.1",version:"3.2.1".split(".").map((e=>parseInt(e))).reduce(((e,t,n),{detail:e}),Qn=!0,dispatchEve1;if("undefined"!=typeof BroadcastChannel){const e=new BroadcastChannel("x-storagee=>{e.data&&Yn(e.data"object"==typeof self.clients&&[...self.clients.matchAll({includeUncontrolled:!0})].forEach((t=>t.postMessage({type:"x-storagemutated-1",changedParts:e}))))}catch(e){}})),addEventListener("storage",(e=>{if("x-storagemutated-1"===e.key){const t=JSON.parse(e.newValue);t&&Yn(t.changedParts)}}));r;Tyof}}),n},etuando)),s*t/et8Array(e)).reduce(((e,t)=>e+=(t&=63)<36?t.toString(36):t<62?(t-26).toString(36).toUpperCase():t>62?"-":"_"),"")}},t={};function n(r){var i=t[r];if(void 0!==i)return i.exports;var s=t[r]={exports:{}};return e[r](s,s.exports,n),s.exports}n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,{a:t}),t},n.d=function(e,t){for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var r={};return function(){"use strict";var e=r;const t=n(9312);n(531),n(6994);const i=t.__importDefault=t.__importDefault(n(5199)),c=t.__importDefault(n(4890)),d=t.__importDefault(n(2565)),l=t.__importStar(n(2827)),u=t.__importDefault(n(2459)),h=n(3444),p=n(1380),f=n(4870);class m{constructor(e){this.enterReportTimer=0,this.saveDataToken=s.default.randomString(10),this.saveDataBuvidSwitch=!0,this.disableSaveDataByDB=!1,this.disableGetData=!0,this.saveAndGetDataSwitch=!1,this.reportToTrackerEnabled=!1,this.trackerVersion="",this.state=new u.default,this.saveCompatibility=!1,this.config=new h.Config(this,e),this.newTrack=new f.NewTrack(this.config),this.init()}get verull===(e=this.config)||void 0===e||e.disableRP()}get saveDataEnabled(){return this.saveAndGetDataSwitch&&this.saveDataBuvidSwitch&&!this.disableSaveDataByDB&&this.saveCompatibility&&["www.bilibili.com","pre-www.bilibili.com","player.bilibili.com","uat-www.bilibili.com","localhost:22331","bilipc.bilibili.com"].includes(window.location.host)&&this.config.enableDonation&&!this.isAdminBanSeeder().banned&&!this.config.homepage}checkCompatibility(){if(!s.default.checkLocalStorage())return!1;if(!p.browserInfo)return!1;const{name:e,version:t}=p.browserInfo;return!this.config.fawkesConfig.pcdnBannedBrowserList.includes(e)}ch&&!this.disableGetData}init(){var e;l.default.getInstance().log(`init -- version: ${o.default.getInstance().version}, isSupportNC: ${s.default.isSupportP2P()}`),s.default.pLog(`init -- version: ${o.default.getInstance().version}`),this.eventBus=new a.default,this.saveCompatibility=this.checkCompatibility(),s.default.isSupportP2P()&&(this.main=new i.default(this),null===(e=this.main.socketController)||void 0===e||e.updateSocketConnectTimer()),this.enterReportTimer=window.setTimeout((()=>{let e={type:d.default.TRACK_TYPE.ENTER,version:o.default.getInstance().version,isSupportP2P:s.default.isSupportP2P()};this.trigger(c.default.TRACK,e)}))}updateConfig(e){e&&this.config.setPassedConfig(e)}quit(){const{getDataStat:e,rtcStat:t,dbStat:n}=this.state;let r={type:d.default.TRACK_TYPE.QUIT,version:o.default.getInstance().version,getDataStat:e,rtcStat:t,dbStat:n};this.trigger(c.default.TRACK,r)}destroy(){var e;l.default.getInstance().log("destroy"),window.clearTimeout(this.enterReportTimer),this.main&&(this.main.destroy(),this.main=null),this.eventBus&&(this.eventBus.destroy(),this.eventBus=null),this.saveAndGetDataSwitch=!1,this.saveDataBuvidSwitch=!1,this.disableSaveDataByDB=!1,l.default.getInstance().reset(),this.state.destroy(),null===(e=this.newTrack)||void 0===e||e.destroy()}getData(e){if(s.default.ied){let t=`\n            ----\n            getData -- url: ${e.url}, range: ${e.range}`;return l.default.getInstance().log(t),e.startTime=Date.now(),this.main.getData(e)}return Promise.reject({code:-1,msg:"basic error"})}saveData(e){var t;if(s.default.isSupportP2P()&&this.main&&e&&this.saveDataEnabled){const n=`saveData -- url: ${e.url}, range: ${e.range}, totalSize: ${e.totalSize}, dataSize: ${null===(t=e.data)||void 0===t?void 0:t.byteLength}`;l.default.getInstance().log(n);try{this.main.saveData(e)}catch(e){this.state.dbStat.saveFailure++}}}abortGetData(e){s.default.isSupportP2P()&&this.main&&e&&"string"==typeof e&&this.main.abortGetData(e)}getToken(){return s.default.randomString(16)}allowDPGetDataByNC(e){var t,n;if(null===(n=null===(t=this.main)||void 0===t?void 0:t.socketController)||von!1;if(!e)return!1;if(this.config.homepage)return!0;const r=+e.rangeStart,i=Math.floor(e.qn),s=+e.originBufferLevel,o=Math.floor(e.bitrate);return!(isNaN(r)||r<100||isNaN(i)||i<=0||!(i>3e4&&i<=30126||i>30200&&i<=30280||i>1e5&&i<=100999)||o>20971520||s<9||!(.5*Math.ceil(o/1e6)<s))}allowDPSaveDataByNC(e){if(!this.saveDataEnabled)return!1;if(!e)return!1;const t=Math.floor(e.qn);return void 0!==t&&(!(Number.isNaN(t)||t<=0)&&!!this.config.realP2PSaveRestriction.qn.some((e=>t>e[0]&&t<=e[1])))}getLogHistory(e=l.LOG_LEVEL.INFO){return l.default.getInstance().getHistory(e)}on(e,t){var n;null===(n=this.eventBus)||void 0===n||n.on(e,t)}off(e,t){var n;null===(n=this.eventBus)||void 0===n||n.off(e,t)}trigger(e,...t){var n;null===(n=this.eventBus)||void 0===n||n.trigger(e,...t)}isAdminBanSeeder(){const e=s.default.getLocalStorage("bp_nc_admin"),[t,n]=s.default.tryCatchSync(JSON.parse,e);return t?{banned:!1}:(null==n?void 0:n.ban_save_and_seeder)?{banned:!0,msg:"user banned browser p2p",code:40010}:{banned:!1}}getSdkStats(){const e=s.default.omitAttrsOfObj(this.state.dbStat,["reportTotalSize","reportFailure","reportSuccess","savedRids","savedSlices","savedBytes"]),t=s.default.getAttrsOfObj(this.state.rtcStat,["receivedByteTotal","receivedByteFromBrowser","receivedByteFromBox","offerInitToBrowser","offerDataChannelOpenToBrowser","getSuccessFromBrowser","receivedCandidate3","receivedCandidate2","receivedCandidate1","noDonationPeer","successiveBrowserPeerNotOpen"]),n=s.default.getAttrsOfObj(this.state.weightStat),r=s.default.getAttrsOfObj(this.state.pcdnStat,["pcdnReportError","pcdnReportFailure"]),i=s.default.getSuffixObj(this.state.boxStat,"_box"),o=s.default.getSuffixObj(this.state.browserStat,"_browser"),a=this.state.commonStat,c=Object.assign({vendor:this.config.vendor},s.default.getAttrsOfObj(this.state.otherStat));return this.state.reset(),Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},e),t),n),r),i),o),a),c)}}m.LOG_LEVEL=l.LOG_LEVEL,m.BPP2PEvent=c.default,m.isSupport=s.default.isSupportP2P,e.default=m}(),r=r.default}()},"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("BPP2PSDK",[],t):"object"==typeof exports?exports.BPP2PSDK=t():e.BPP2PSDK=t();