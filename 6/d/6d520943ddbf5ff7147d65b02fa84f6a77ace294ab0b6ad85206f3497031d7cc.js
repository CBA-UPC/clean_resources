/* Built on 2023-10-16 13:29:03 */
define("text!skins/chat/window_error.mustache",[],function(){return'<div id="chat-window" class="{{#window_class}}{{window_class}}{{/window_class}}">\n\t<div class="overlay-container">\n\t\t<h3 class="chat-title">\n\t\t\t<div class="close"><div>_</div></div>\n\t\t\t<div class="chat-icon"><span class="icon-f icf-comments-o">&nbsp;</span></div>\n\t\t\t<span class="chat-title-text">{{{ trad.xvideos_chat }}}</span>\n\t\t</h3>\n\t\t<div class="row">\n\t\t</div>\n\t</div>\n</div>'}),this,function(){return [function(t,e,i){ar r=i(1),s=i(7),o=i(12),a=i(3)("socket.io-client");t.exports=e=n;var c=e.managers={};e.protocol=s.protocol,e.connect=n,e.Manager=i(12),e.Socket=i(37)},function(t,e,i){function n(t,e){var i=t;e=e||"undefined"!=typeof location&&location,null==t&&(t=e.protocol+"//"+e.host),"string"==typeof t&&("/"===t.charAt(0)&&(t="/"===t.charAt(1)?e.protocol+t:e.host+t),/^(https?|wss?):\/\//.test(t)||(s("protocol-less url %s",t),t=void 0!==e?e.protocol+"//"+t:"https://"+t),s("parse %s",t),i=r(t)),i.port||(/^(http|ws)$/.test(i.protocol)?i.port="80":/^(http|ws)s$/.test(i.protocol)&&(i.port="443")),i.path=i.path||"/";var n=-1!==i.host.indexOf(":"),o=n?"["+i.host+"]":i.host;return i.id=i.protocol+"://"+o+":"+i.port,i.href=i.protocol+"://"+o+(e&&e.port===i.port?"":":"+i.port),i}var r=i(2),s=i(3)("socket.io-client:url");t.exports=n},function(t,e){r r=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,s=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];t.exports=,function(t,e,i){(function(n){"use strict";="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?e=t.exports=i(5),e.log=o,e.formatArgs=s,e.save=a,e.load=c,e.useColors=r,e.storage="undefined"!=typeof chrome&&"undefined"!=typeof chrome.storage?chrome.storage.local:),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],e.formatters.j=e.enable(c())}).call(e,i(4))},function(t,e,i){"use strict";orts=r.debug=r["default"]=r,e.coerce=d,e.disable=a,e.enable=o,e.enabled=c,e.humanize=i(6),e.instances=[],e.names=[],e.skips=[],e.formatters={}},function(t,e){o=1e3,a=60*o,c=60*a,d=24*c,h=365.25*d;t.exports=,function(t,e,i){function n(){}unction s(t){try{return JSON.stringify(t)}catch(e){return!1}}i(3)("socket.io-parser"),u=i(8),f=i(9),p=i(10),g=i(11);e.protocol=4,e.types=["CONNECT","DISCONNECT","EVENT","ACK","ERROR","BINARY_EVENT","BINARY_ACK"],e.CONNECT=0,e.DISCONNECT=1,e.EVENT=2,e.ACK=3,e.ERROR=4,e.BINARY_EVENT=5,e.BINARY_ACK=6,e.Encoder=n,e.Decoder=a;var m=e.ERROR+'"encode error"';n.prototype.encode=function(t,i){if(l("encoding packet %j",t),e.BINARY_EVENT===t.type||e.BINARY_ACK===t.type)o(t,i);else{i([r(t)])}},u(a.prototype),a.prototype.add=a.prototype.destroy=function(){this.reconstructor&&this.reconstructor.finishedReconstruction()},h.prototype.takeBinaryData=h.prototype.finishedReconstruction=,function(t,e,i){function n(t,e){if(!(this instanceof n))return new n(t,e);t&&"object"==typeof t&&(e=t,t=void 0),e=e||{},e.path=e.path||"/socket.io",this.nsps={},this.subs=[],this.opts=e,this.reconnection(!1!==e.reconnection),this.reconnectionAttempts(e.reconnectionAttempts||1/0),this.reconnectionDelay(e.reconnectionDelay||1e3),this.reconnectionDelayMax(e.reconnectionDelayMax||5e3),this.randomizationFactor(e.randomizationFactor||.5),this.backoff=new l({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==e.timeout?2e4:e.timeout),this.readyState="closed",this.uri=t,this.connecting=[],this.lastPing=null,this.encoding=!1,this.packetBuffer=[];var i=e.parser||a;this.encoder=new i.Encoder,this.decoder=new i.Decoder,this.autoConnect=!1!==e.autoConnect,this.autoConnect&&this.open()}var r=i(13),s=i(37),o=i(8),a=i(7),c=i(39),d=i(40),h=i(3)("socket.io-client:manager"),_=i(36),l=i(41),u=Object.prototype.hasOwnProperty;t.exports=n,n.prototype.emitAll=n.prototype.updateSocketIds=n.prototype.generateId=o(n.prototype),n.prototype.reconnection=n.prototype.reconnectionAttempts=function(t){return arguments.length?(this._reconnectionAttempts=t,this):this._reconnectionAttempts},n.prototype.reconnectionDelay=function(t){return arguments.length?(this._reconnectionDelay=t,this.backoff&&this.backoff.setMin(t),this):this._reconnectionDelay},n.prototype.randomizationFactor=function(t){return arguments.length?(this._randomizationFactor=t,this.backoff&&this.backoff.setJitter(t),this):this._randomizationFactor},n.prototype.reconnectionDelayMax=n.prototype.timeout=n.prototype.maybeReconnectOnOpen=n.prototype.open=n.prototype.connect=n.prototype.onopen=n.prototype.onping=n.prototype.onpong=n.prototype.ondata=n.prototype.ondecoded=function(t){this.emit("packet",t)},n.prototype.onerror=n.prototype.socket=n.prototype.destroy=n.prototype.packet=n.prototype.processPacketQueue=n.prototype.cleanup=n.prototype.close=n.prototype.disconnect=n.prototype.onclose=n.prototype.reconnect=n.prototype.onreconnect=,function(t,e,i){r s=i(15),o=i(8),a=i(3)("engine.io-client:socket"),c=i(36),d=i(22),h=i(2),_=i(30);t.exports=n,n.priorWebsocketSuccess=!1,o(n.prototype),n.protocol=d.protocol,n.Socket=n,n.Transport=i(21),n.transports=i(15),n.parser=i(22),n.prototype.createTransport=n.prototype.open=n.prototype.setTransport=n.prototype.probe=n.prototype.onOpen=n.prototype.onPacket=n.prototype.onHandshake=n.prototype.onHeartbeat=n.prototype.setPing=n.prototype.ping=n.prototype.onDrain=n.prototype.flush=n.prototype.write=n.prototype.send=n.prototype.sendPacket=n.prototype.close=
n.prototype.onError=n.prototype.onClose=n.prototype.filterUpgrades=,function(t,e,i){ar r=i(16),s=i(19),o=i(33),a=i(34);e.polling=n,e.websocket=a},function(t,e,i){ar r=i(21),s=i(30),o=i(22),a=i(31),c=i(32),d=i(3)("engine.io-client:polling");t.exports=n;var h=);a(n,r),n.prototype.name="polling",n.prototype.doOpen=n.prototype.pause=n.prototype.poll=n.prototype.onData=n.prototype.doClose=n.prototype.write=n.prototype.uri=,function(t,e,i){h=i(23),_=i(24),l=i(25),u=i(26),f=i(27);"undefined"!=typeof ArrayBuffer&&(d=i(28));var p="undefined"!=typeof navigator&&/Android/i.test(navigator.userAgent),g="undefined"!=typeof navigator&&/PhantomJS/i.test(navigator.userAgent),m=p||g;e.protocol=3;var v=e.packets={open:0,close:1,ping:2,pong:3,message:4,upgrade:5,noop:6},y=h(v),b={type:"error",data:"parser error"},w=i(29);e.encodePacket=e.encodeBase64Packet=function(t,i){var n="b"+e.packets[t.type];if(void 0!==w&&t.data instanceof w){var r=new FileReader;return r.onload=r.readAsDataURL(t.data)}var s;try{s=String.fromCharCode.apply(null,new Uint8Array(t.data))}catch(o){for(var o=new Uint8Array(t.data),a=new Array(o.length),c=0;c<o.length;c++)a[c]=o[c];s=String.fromCharCode.apply(null,a)}return n+=btoa(s),i(n)},e.decodePacket=e.decodeBase64Packet=e.encodePayload=e.decodePayload=e.encodePayloadAsArrayBuffer=e.encodePayloadAsBlob=e.decodePayloadAsBinary=,function(t,e){"use strict";(var s,o="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),a=64,c={},d=0,h=0;h<a;h++)c[o[h]]=h;r.encode=i,r.decode=n,t.exports=r},function(t,e,i){function n(){}ar s=i(20),o=i(31),a=i(18);t.exports=r;var c,d=/\n/g,h=/\\n/g;o(r,s),r.prototype.supportsBinary=!1,r.prototype.doClose=r.prototype.doPoll=r.prototype.doWrite=,function(t,e,i){ar r,s,o=i(21),a=i(22),c=i(30),d=i(31),h=i(32),_=i(3)("engine.io-client:websocket");if("undefined"!=typeof WebSocket?r=WebSocket:"undefined"!=typeof self&&(r=self.WebSocket||self.MozWebSocket),"undefined"==typeof window)try{s=i(35)}catch(u){}var l=r||s;t.exports=n,d(n,o),n.prototype.name="websocket",n.prototype.supportsBinary=!0,n.prototype.doOpen=n.prototype.addEventListeners=n.prototype.write=function(t){ar i=this;this.writable=!1;for(var n=t.length,r=0,s=n;r<s;r++)!function(t){a.encodePacket(t,i.supportsBinary,function(r){if(!i.usingBrowserWebSocket){var s={};if(t.options&&(s.compress=t.options.compress),i.perMessageDeflate){("string"==typeof r?Buffer.byteLength(r):r.length)<i.perMessageDeflate.threshold&&(s.compress=!1)}}try{i.usingBrowserWebSocket?i.ws.send(r):i.ws.send(r,s)}catch(a){_("websocket closed before onclose event")}--n||e()})}(t[r])},n.prototype.onClose=n.prototype.doClose=n.prototype.uri=n.prototype.check=,function(t,e,i){ar r=i(7),s=i(8),o=i(38),a=i(39),c=i(40),d=i(3)("socket.io-client:socket"),h=i(30),_=i(24);t.exports=n;var l={connect:1,connect_error:1,connect_timeout:1,connecting:1,disconnect:1,error:1,reconnect:1,reconnect_attempt:1,reconnect_failed:1,reconnect_error:1,reconnecting:1,ping:1,pong:1},u=s.prototype.emit;s(n.prototype),n.prototype.subEvents=n.prototype.open=n.prototype.connect=n.prototype.send=n.prototype.emit=n.prototype.packet=n.prototype.onopen=n.prototype.onclose=n.prototype.onpacket=n.prototype.onevent=n.prototype.ack=n.prototype.onack=n.prototype.onconnect=n.prototype.emitBuffered=n.prototype.ondisconnect=n.prototype.destroy=n.prototype.close=n.prototype.disconnect=n.prototype.compress=function(t){return this.flags.compress=t,this},n.prototype.binary=,)}),define("text!skins/chat/message.mustache",[],function(){return'<li class="clearfix chat-message-from-{{ message_from }}">\n\t<div class="chat-body clearfix">\n\t\t<div class="header">\n\t\t\t<strong class="primary-font {{ class_name }} chat-message-profile-name" title="{{ user_name }}">{{ user_name }}</strong> <small class="{{ class_date }} text-muted">\n\t\t\t<span></span> <span class="chat-message-date">{{ time }}</span></small>\n\t\t</div>\n\t\t<div class="chat_message_display">\n\t\t\t{{>inside}}\n\t\t</div>\n\t</div>\n</li>'}),define("text!skins/chat/message_inside.mustache",[],function(){
return'<div id="chat_message_{{ message_id }}" class="{{class_multi}} chat_message_id">\n    <div class="chat-actions {{ class_actions }}">\n        {{#not_read}}<div class="chat_message_status_not_read"></div>{{/not_read}}\n        {{#has_delete}}<div class="remove-message"><a href="#"><span class="icon-f icf-close"></span></a></div>{{/has_delete}}\n        {{^has_delete}}<div class="report-message"><a href="#"><span class="icon-f icf-flag"></span></a></div>{{/has_delete}}\n    </div>\n\t<div class="chat_message_inner {{ class_li }}">\n        {{{ quote }}}\n\t\t{{#message_html}}\n\t\t\t{{{ message_html }}}\n\t\t{{/message_html}}\n\t\t{{#message}}\n\t\t    <p class="chat_message">{{ message }}</p>\n\t\t    <p class="chat_message_report">{{ message }}</p>\n\t\t{{/message}}\n\t</div>\n</div>'}),define("text!skins/chat/message_quote.mustache",[],function(){return'<figure class="chat-quote{{# modifier }} chat-quote--{{ modifier }}{{/ modifier }}">\n\t<div class="chat-quote__inner">\n\t\t<blockquote>{{{ content }}}</blockquote>\n\t\t<figcaption class="chat-quote__metas">\n\t\t\t<cite class="chat-quote__meta chat-quote__meta--cite"{{# user_id }}data-user-id="{{ user_id }}"{{/ user_id }}>{{ user_name }} -</cite>\n\t\t\t<time class="chat-quote__meta chat-quote__meta--time" title="{{ time }}" data-timestamp="{{ timestamp }}"{{#enable_refresh_rt}} data-refresh-rt{{/enable_refresh_rt}}>{{{ relative_time }}}</time>\n\t\t</figcaption>\n\t</div>\n</figure>'}),define("text!skins/chat/window.mustache",[],function(){return'<div id="chat-window" class="{{#window_class}}{{window_class}}{{/window_class}}">\r\n\t<div id="chat_loading_overlay" >\r\n\t\t<div class="loading_back">&nbsp;</div>\r\n\t\t<div class="loading_text">\r\n\t\t\t<i class="icon-f icf-spinner icf-anim-pulse icf-2x icf-fw"></i>\r\n\t\t</div>\r\n\t</div>\r\n\t<div class="overlay-container">\r\n\t\t<audio id="mess_notif">\r\n\t\t\t<source src="{{{ sound_file }}}"></source>\r\n\t\t</audio>\r\n\t\t<h3 class="chat-title">\r\n\t\t\t<div class="close"><div>_</div></div>\r\n\t\t\t<div class="chat-settings"><span class="icon-f icf-cog">&nbsp;</span></div>\r\n\t\t\t<div class="chat-icon-home icon-f icf-home">&nbsp;</div>\r\n\t\t\t<div class="chat-icon"><span class="icon-f icf-comments-o">&nbsp;</span></div>\r\n\t\t\t<span class="chat-title-text">{{{ trad.xvideos_chat }}}</span>\r\n\t\t</h3>\r\n\t\t<div id="chat-settings-list">\r\n\r\n\t\t\t{{#is_dev}}\r\n\t\t\t\t<div class="chat-settings-option chat-option-status" id="chat-title-link-debug">\r\n\t\t\t\t\t<div class="chat-settings-option-text">Debug</div>\r\n\t\t\t\t\t<div class="chat-settings-option-icon">&nbsp;</div>\r\n\t\t\t\t</div>\r\n\t\t\t{{/is_dev}}\r\n\t\t\t\r\n\t\t\t<div class="chat-settings-option chat-option-status {{#is_dev}}separator{{/is_dev}}" id="chat-option-status-online">\r\n\t\t\t\t<div class="chat-settings-option-text">{{{ trad.status_online }}}</div>\r\n\t\t\t\t<div class="chat-settings-option-icon">&nbsp;</div>\r\n\t\t\t</div>\r\n\t\t\t<div class="chat-settings-option chat-option-status" id="chat-option-status-away">\r\n\t\t\t\t<div class="chat-settings-option-text">{{{ trad.status_away }}}</div>\r\n\t\t\t\t<div class="chat-settings-option-icon">&nbsp;</div>\r\n\t\t\t</div>\r\n\t\t\t<div class="chat-settings-option chat-option-status" id="chat-option-status-invisible">\r\n\t\t\t\t<div class="chat-settings-option-text">{{{ trad.status_invisible }}}</div>\r\n\t\t\t\t<div class="chat-settings-option-icon">&nbsp;</div>\r\n\t\t\t</div>\r\n\t\t\t<div class="chat-settings-option separator" id="chat-option-size-small">\r\n\t\t\t\t<div class="chat-settings-option-text">{{{ trad.small_size }}}</div>\r\n\t\t\t\t<div class="chat-settings-option-checked chat-settings-option-icon icon">&nbsp;</div>\r\n\t\t\t</div>\r\n\t\t\t<div class="chat-settings-option" id="chat-option-size-medium">\r\n\t\t\t\t<div class="chat-settings-option-text">{{{ trad.medium_size }}}</div>\r\n\t\t\t\t<div class="chat-settings-option-icon">&nbsp;</div>\r\n\t\t\t</div>\r\n\t\t\t<div class="chat-settings-option" id="chat-option-size-big">\r\n\t\t\t\t<div class="chat-settings-option-text">{{{ trad.big_size }}}</div>\r\n\t\t\t\t<div class="chat-settings-option-icon">&nbsp;</div>\r\n\t\t\t</div>\r\n\t\t\t<div class="chat-settings-option separator" id="chat-option-sound">\r\n\t\t\t\t<div class="chat-settings-option-text">{{{ trad.sound }}}</div>\r\n\t\t\t\t<div class="chat-settings-option-icon">&nbsp;</div>\r\n\t\t\t</div>\r\n\t\t\t<div class="chat-settings-option separator" id="chat-option-notification">\r\n\t\t\t\t<div class="chat-settings-option-text">{{{ trad.notifications }}}</div>\r\n\t\t\t\t<div class="chat-settings-option-unchecked chat-settings-option-icon icon">&nbsp;</div>\r\n\t\t\t</div>\r\n\t\t\t<div class="chat-settings-option separator" id="chat-option-color0">\r\n\t\t\t\t<div class="chat-settings-option-text color color0-left"></div>\r\n\t\t\t\t<div class="chat-settings-option-text">/</div>\r\n\t\t\t\t<div class="chat-settings-option-text color color0-right"></div>\r\n\t\t\t\t<div class="chat-settings-option-checked chat-settings-option-icon icon">&nbsp;</div>\r\n\t\t\t</div>\r\n\t\t\t<div class="chat-settings-option" id="chat-option-color1">\r\n\t\t\t\t<div class="chat-settings-option-text color color1-left"></div>\r\n\t\t\t\t<div class="chat-settings-option-text">/</div>\r\n\t\t\t\t<div class="chat-settings-option-text color color1-right"></div>\r\n\t\t\t\t<div class="chat-settings-option-icon">&nbsp;</div>\r\n\t\t\t</div>\r\n\t\t\t<div class="chat-settings-option" id="chat-option-color2">\r\n\t\t\t\t<div class="chat-settings-option-text color color2-left"></div>\r\n\t\t\t\t<div class="chat-settings-option-text">/</div>\r\n\t\t\t\t<div class="chat-settings-option-text color color2-right"></div>\r\n\t\t\t\t<div class="chat-settings-option-icon">&nbsp;</div>\r\n\t\t\t</div>\r\n\t\t\t<div class="chat-settings-option separator" id="chat-option-blur-image">\r\n\t\t\t\t<div class="chat-settings-option-text">{{{ trad.blur_image }}}</div>\r\n\t\t\t\t<div class="chat-settings-option-unchecked chat-settings-option-icon icon">&nbsp;</div>\r\n\t\t\t</div>\r\n\t\t\t<div class="chat-settings-option separator" id="chat-option-mini-disabled">\r\n\t\t\t\t<div class="chat-settings-option-text">{{{ trad.disable_mini_chat }}}</div>\r\n\t\t\t\t<div class="chat-settings-option-icon">&nbsp;</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<div id="chat-drag-file" class="row">\r\n\t\t\t<div id="chat-drag-file-overlay" >\r\n\t\t\t\t<div id="chat-drag-file-overlay-opacity"></div>\r\n\t\t\t\t<div id="chat-drag-file-overlay-icon"><span class="icon-f icf-image"></span></div>\r\n\t\t\t</div>\r\n\t\t\t<div class="col-xs-8 chat-messenger chat-home">\r\n\t\t\t\t<div id="chat-home">\r\n\t\t\t\t\t<div id="chat-home-title"><h3>{{{ trad.welcome }}}</h3></div>\r\n\t\t\t\t\t<ul id="chat-home-tabs">\r\n\t\t\t\t\t\t<li id="chat-home-tabs-news" class="chat-selected">\r\n\t\t\t\t\t\t\t<div class="chat-home-tabs-icon"><span class="icon-f icf-home"></span></div>\r\n\t\t\t\t\t\t</li>\r\n\t\t\t\t\t\t<li id="chat-home-tabs-requests" class="chat-home-tabs-hide">\r\n\t\t\t\t\t\t\t<div class="chat-home-tabs-icon"><span class="icon-f icf-user-plus" title="{{{ trad.friend_requests }}}"></span> <span class="chat-home-tabs-text">{{{ trad.friend_requests }}}</span></div>\r\n\t\t\t\t\t\t</li>\r\n\t\t\t\t\t\t<li id="chat-home-tabs-requests-sent" class="chat-home-tabs-hide">\r\n\t\t\t\t\t\t\t<div class="chat-home-tabs-icon"><span class="icon-f icf-user-hourglass" title="{{{ trad.friend_requests_sent }}}"></span> <span class="chat-home-tabs-text">{{{ trad.friend_requests_sent }}}</span></div>\r\n\t\t\t\t\t\t</li>\r\n\t\t\t\t\t</ul>\r\n\r\n\t\t\t\t\t<div id="chat-home-tabs-content">\r\n\t\t\t\t\t\t<div id="chat-home-tab-container-home" class="chat-home-tab-container chat-selected chat-home-message-bottom">\r\n\t\t\t\t\t\t\t<p>{{{ trad.all_conv_encrypted }}}</p>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div id="chat-home-tab-container-requests" class="chat-home-tab-container">\r\n\t\t\t\t\t\t\t<p id="chat-home-friend-request"></p>\r\n\t\t\t\t\t\t\t<div id="chat-home-last-friend-request"></div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div id="chat-home-tab-container-requests-sent" class="chat-home-tab-container">\r\n\t\t\t\t\t\t\t<p id="chat-home-friend-request-sent"></p>\r\n\t\t\t\t\t\t\t<div id="chat-home-last-friend-request-sent"></div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class="chat-header-messages"></div>\r\n\t\t\t\t<div class="chat-messages"></div>\r\n\t\t\t\t<div class="chat-message-form">\r\n\t\t\t\t\t<div class="input-group">\r\n\t\t\t\t\t\t<div id="textarea-group">\r\n\t\t\t\t\t\t\t<textarea id="chat-textarea-message" class="form-control" style="resize:none" placeholder="{{{ trad.textarea_message_placeholder }}}" ></textarea>\r\n\t\t\t\t\t\t\t<div id="container-smiley"></div>\r\n\t\t\t\t\t\t\t<button id="chat-send-file" class="icon-f icf-image"></button>\r\n\t\t\t\t\t\t\t<input id="chat-file" type="file" />\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<button id="chat-send-btn" class="btn input-group-addon">\r\n\t\t\t\t\t\t\t{{{ trad.message_send }}}\r\n\t\t\t\t\t\t\t<span id="chat-send-btn-loader" style="display: none;"><span class=\'icon-f icf-spinner icf-anim-pulse\'></span></span>\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div class="col-xs-4" id="chat-side-column">\r\n\t\t\t\t<div id="chat-users-lists">\r\n\t\t\t\t\t<div id="chat-users-not-friend" class="chat-users"></div>\r\n\t\t\t\t\t<div id="chat-users-not-read" class="chat-users"></div>\r\n\t\t\t\t\t<div id="chat-users-favorite" class="chat-users"></div>\r\n\t\t\t\t\t<div id="chat-users-offline-favorite" class="chat-users"></div>\r\n\t\t\t\t\t<div id="chat-users-others" class="chat-users"></div>\r\n\t\t\t\t\t<div id="chat-users-offline-others" class="chat-users"></div>\r\n\t\t\t\t\t<div id="chat-users-more" class="chat-users"></div>\r\n\t\t\t\t\t<div id="chat-users-search" class="chat-users"></div>\r\n\t\t\t\t\t<div id="chat-users-search-close" class="chat-users">\r\n\t\t\t\t\t\t<a class="chat_back_to_friends">{{{ trad.button_return_friends }}}</a>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div id="chat-users-search-input" class="input-group">\r\n\t\t\t\t\t<input type="text" name="friend_name" disabled class="search-input form-control" maxlength="40" placeholder="{{{ trad.input_search_placeholder }}}">\r\n\t\t\t\t\t<span class="input-group-btn">\r\n\t\t\t\t\t\t<button type="button" id="chat-search-button" title="{{{ trad.button_search_friends }}}" class="search-submit btn btn-default"><span class="icon search-small gray"></span></button>\r\n\t\t\t\t\t</span>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n\t<div id="chat-preloader"></div>\r\n</div>'}),define("text!skins/chat/system_message.mustache",[],function(){return'<li class="clearfix chat-message-from-system">\n\t<div class="chat-body clearfix">\n\t\t<div class="chat_message_display">\n\t\t\t<p class="chat_message_system">{{ message }}</p>\n\t\t</div>\n\t</div>\n</li>'}),function(t,e){"object"==typeof exports?module.exports=exports=e():"function"==typeof define&&define.amd?define("libs/c3r18y25p16t",[],e):t.CryptoJS=e()}(this,function(){var t=t||Math);return ),Math),),Math),),),Math),),),),),),function(e){var i=t,n=i.lib,r=n.WordArray,s=n.Hasher,o=i.x64,a=o.Word,c=i.algo,d=[],h=[],_=[];!);var l=[];!);var u=c.SHA3=s.extend({cfg:s.cfg.extend({outputLength:512}),_doReset:_doProcessBlock:_doFinalize:clone:);i.SHA3=s._createHelper(u),i.HmacSHA3=s._createHmacHelper(u)}(Math),function(){ar i=t,n=i.lib,r=n.Hasher,s=i.x64,o=s.Word,a=s.WordArray,c=i.algo,d=[e(1116352408,3609767458),e(1899447441,602891725),e(3049323471,3964484399),e(3921009573,2173295548),e(961987163,4081628472),e(1508970993,3053834265),e(2453635748,2937671579),e(2870763221,3664609560),e(3624381080,2734883394),e(310598401,1164996542),e(607225278,1323610764),e(1426881987,3590304994),e(1925078388,4068182383),e(2162078206,991336113),e(2614888103,633803317),e(3248222580,3479774868),e(3835390401,2666613458),e(4022224774,944711139),e(264347078,2341262773),e(604807628,2007800933),e(770255983,1495990901),e(1249150122,1856431235),e(1555081692,3175218132),e(1996064986,2198950837),e(2554220882,3999719339),e(2821834349,766784016),e(2952996808,2566594879),e(3210313671,3203337956),e(3336571891,1034457026),e(3584528711,2466948901),e(113926993,3758326383),e(338241895,168717936),e(666307205,1188179964),e(773529912,1546045734),e(1294757372,1522805485),e(1396182291,2643833823),e(1695183700,2343527390),e(1986661051,1014477480),e(2177026350,1206759142),e(2456956037,344077627),e(2730485921,1290863460),e(2820302411,3158454273),e(3259730800,3505952657),e(3345764771,106217008),e(3516065817,3606008344),e(3600352804,1432725776),e(4094571909,1467031594),e(275423344,851169720),e(430227734,3100823752),e(506948616,1363258195),e(659060556,3750685593),e(883997877,3785050280),e(958139571,3318307427),e(1322822218,3812723403),e(1537002063,2003034995),e(1747873779,3602036899),e(1955562222,1575990012),e(2024104815,1125592928),e(2227730452,2716904306),e(2361852424,442776044),e(2428436474,593698344),e(2756734187,3733110249),e(3204031479,2999351573),e(3329325298,3815920427),e(3391569614,3928383900),e(3515267271,566280711),e(3940187606,3454069534),e(4118630271,4000239992),e(116418474,1914138554),e(174292421,2731055270),e(289380356,3203993006),e(460393269,320620315),e(685471733,587496836),e(852142971,1086792851),e(1017036298,365543100),e(1126000580,2618297676),e(1288033470,3409855158),e(1501505948,4234509866),e(1607167915,987167468),e(1816402316,1246189591)],h=[];!);var _=c.SHA512=r.extend({_doReset:function(){
this._hash=new a.init([new o.init(1779033703,4089235720),new o.init(3144134277,2227873595),new o.init(1013904242,4271175723),new o.init(2773480762,1595750129),new o.init(1359893119,2917565137),new o.init(2600822924,725511199),new o.init(528734635,4215389547),new o.init(1541459225,327033209)])},_doProcessBlock:_doFinalize:clone:blockSize:32});i.SHA512=r._createHelper(_),i.HmacSHA512=r._createHmacHelper(_)}(),),t.lib.Cipher||),t.mode.CFB=function(){function e(t,e,i,n){var r=this._iv;if(r){var s=r.slice(0);this._iv=undefined}else var s=this._prevBlock;n.encryptBlock(s,0);for(var o=0;o<i;o++)t[e+o]^=s[o]}var i=t.lib.BlockCipherMode.extend();return i.Encryptor=i.extend({processBlock:),i.Decryptor=i.extend({processBlock:),i}(),t.mode.ECB=),t.pad.AnsiX923={pad:unpad:function(t){var e=255&t.words[t.sigBytes-1>>>2];t.sigBytes-=e}},t.pad.Iso10126={pad:unpad:,t.pad.Iso97971={pad:unpad:,t.mode.OFB=function(){var e=t.lib.BlockCipherMode.extend(),i=e.Encryptor=e.extend({processBlock:);return e.Decryptor=i,e}(),t.pad.NoPadding={pad:function(){},unpad:function(){}},),function(){var e=t,i=e.lib,n=i.BlockCipher,r=e.algo,s=[],o=[],a=[],c=[],d=[],h=[],_=[],l=[],u=[],f=[];!);var p=[0,1,2,4,8,16,32,64,128,27,54],g=r.AES=n.extend({_doReset:function(){if(!this._nRounds||this._keyPriorReset!==this._key){for(var t=this._keyPriorReset=this._key,e=t.words,i=t.sigBytes/4,n=this._nRounds=i+6,r=4*(n+1),o=this._keySchedule=[],a=0;a<r;a++)if(a<i)o[a]=e[a];else{var c=o[a-1];a%i?i>6&&a%i==4&&(c=s[c>>>24]<<24|s[c>>>16&255]<<16|s[c>>>8&255]<<8|s[255&c]):(c=c<<8|c>>>24,c=s[c>>>24]<<24|s[c>>>16&255]<<16|s[c>>>8&255]<<8|s[255&c],c^=p[a/i|0]<<24),o[a]=o[a-i]^c}for(var d=this._invKeySchedule=[],h=0;h<r;h++){var a=r-h;if(h%4)var c=o[a];else var c=o[a-4];d[h]=h<4||a<=4?c:_[s[c>>>24]]^l[s[c>>>16&255]]^u[s[c>>>8&255]]^f[s[255&c]]}}},encryptBlock:decryptBlock:_doCryptBlock:keySize:8});e.AES=n._createHelper(g)}(),),),t.mode.CTRGladman=function(){r n=t.lib.BlockCipherMode.extend(),r=n.Encryptor=n.extend({processBlock:function(t,e){var n=this._cipher,r=n.blockSize,s=this._iv,o=this._counter;s&&(o=this._counter=s.slice(0),this._iv=undefined),i(o);var a=o.slice(0);n.encryptBlock(a,0);for(var c=0;c<r;c++)t[e+c]^=a[c]}});return n.Decryptor=r,n}(),),t.mode.CTR=function(){var e=t.lib.BlockCipherMode.extend(),i=e.Encryptor=e.extend({processBlock:);return e.Decryptor=i,e}(),),t.pad.ZeroPadding={pad:unpad:,t}),this,function(t){"use strict";3456789abcdefghijklmnopqrstuvwxyz",w="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",k=S=,E={decode},re:/-----BEGIN [^-]+-----([A-Za-z0-9+\/=\s]+)-----END [^-]+-----|begin-base64[^\n]+\n([A-Za-z0-9+\/=\s]+)====/,unarmo}},x=1e13,}(),A="…",C=/^(\d\d)(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])([01]\d|2[0-3])(?:([0-5]\d)(?:([0-5]\d)(?:[.,](\d{1,3}))?)?)?(Z|[-+](?:[0]\d|1[0-2])([0-5]\d)?)?$/,D=/^(\d\d\d\d)(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])([01]\d|2[0-3])(?:([0-5]\d)(?:([0-5]\d)(?:[.,](\d{1,3}))?)?)?(Z|[-+](?:[0]\d|1[0-2])([0-5]\d)?)?$,t}(,t}(,t}(),$=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],N=(1<<26)/$[$.length-1,t}(,t}(,t}(,t}(,t}();"Microsoft Internet Explorer"==navigator.appName?(B.prototype r},y=30):"Netscape"!=navigator.appName?(B.prototype r},y=26):(B.prototype r},y=28),B.prototype.DB=y,B.prototype.DM=(1<<y)-1,B.prototype.DV=1<<y,B.prototype.FV=Math.pow(2,52),B.prototype.F1=52-y,B.prototype.F2=2*y-52;var M,L,H=[];for(M="0".charCodeAt(0),L=0;L<=9;++L)H[M++]=L;for(M="a".charCodeAt(0),L=10;L<36;++L)H[M++]=L;for(M="A".charCodeAt(0),L=10;L<36;++L)H[M++]=L;B.ZERO=f(0),B.ONE=f(1);var U,,t}(),V=256,K=null;if(null==K){K=[];var Y=void(W=0);if(window.crypto&&window.crypto.getRandomValues){var G=new Uint32Array(256);for(window.crypto.getRandomValues(G),Y=0;Y<G.length;++Y)K[W++]=255&G[Y]}va{}};window.addEventListener?window.addEventListener("mousemove",X,!1):window.attachEvent&&window.attachEvent("onmousemove",X)}va,t}(,t}(),Q={md2:"3020300c06082a864886f70d020205000410",md5:"3020300c06082a864886f70d020505000410",sha1:"3021300906052b0e03021a05000414",sha224:"302d300d06096086480165030402040500041c",sha256:"3031300d060960864801650304020105000420",sha384:"3041300d060960864801650304020205000430",sha512:"3051300d060960864801650304020305000440",ripemd160:"3021300906052b2403020105000414"},tt={};tt.lang={ext)}}};var et={};void 0!==et.asn1&&et.asn1||(et.asn1={}),et.asn1.ASN1Util=)}},et.asn1.ASN1Util.oidHexTo e},et.asn1.ASN1Util.oidIntToHex=function(t){var e=function(t){var e=t.toString(16);return 1==e.length&&(e="0"+e),e};if(!t.match(/^[0-9.]+$/))throw"malformed oid string: "+t;var i="",n=t.split("."),r=40*parseInt(n[0])+parseInt(n[1]);i+=e(r),n.splice(0,2);for(var s=0;s<n.length;s++)i+=function(t){var i="",n=new B(t,10).toString(2),r=7-n.length%7;7==r&&(r=0);for(var s="",o=0;o<r;o++)s+="0";for(n=s+n,o=0;o<n.length-1;o+=7){var a=n.substr(o,7);o!=n.length-7&&(a="1"+a),i+=e(parseInt(a,2))}return i}(n[s]);return i},et.asn1.ASN1Obj"}},et.asn1.DERAbstractStr))},tt.lang.extend(et.asn1.DERAbstractString,et.asn1.ASN1Object),et.asn1.DERAbstractTV}},tt.lang.extend(et.asn1.DERAbstractTime,et.asn1.ASN1Object),et.asn1.DERAbstractStructuy)},tt.lang.extend(et.asn1.DERAbstractStructured,et.asn1.ASN1Object),et.asn1.DERBoolean=function(){et.asn1.DERBoolean.superclass.constructor.call(this),this.hT="01",this.hTLV="0101ff"},tt.lang.extend(et.asn1.DERBoolean,et.asn1.ASN1Object),et.asn1.DERInte))},tt.lang.extend(et.asn1.DERInteger,et.asn1.ASN1Object),et.asn1.DERBitStr))},tt.lang.extend(et.asn1.DERBitString,et.asn1.ASN1Object),et.asn1.DEROctetStr4"},tt.lang.extend(et.asn1.DEROctetString,et.asn1.DERAbstractString),et.asn1.DERN0"},tt.lang.extend(et.asn1.DERNull,et.asn1.ASN1Object),et.asn1.DERObjectIdentif))},tt.lang.extend(et.asn1.DERObjectIdentifier,et.asn1.ASN1Object),et.asn1.DEREnumera))},tt.lang.extend(et.asn1.DEREnumerated,et.asn1.ASN1Object),et.asn1.DERUTF8String=function(t){et.asn1.DERUTF8String.superclass.constructor.call(this,t),this.hT="0c"},tt.lang.extend(et.asn1.DERUTF8String,et.asn1.DERAbstractString),et.asn1.DERNumericString=function(t){et.asn1.DERNumericString.superclass.constructor.call(this,t),this.hT="12"},tt.lang.extend(et.asn1.DERNumericString,et.asn1.DERAbstractString),et.asn1.DERPrintableString=function(t){et.asn1.DERPrintableString.superclass.constructor.call(this,t),this.hT="13"},tt.lang.extend(et.asn1.DERPrintableString,et.asn1.DERAbstractString),et.asn1.DERTeletexString=function(t){et.asn1.DERTeletexString.superclass.constructor.call(this,t),this.hT="14"},tt.lang.extend(et.asn1.DERTeletexString,et.asn1.DERAbstractString),et.asn1.DERIA5Str6"},tt.lang.extend(et.asn1.DERIA5String,et.asn1.DERAbstractString),et.asn1.DERUTCT))},tt.lang.extend(et.asn1.DERUTCTime,et.asn1.DERAbstractTime),et.asn1.DERGeneralizedT))},tt.lang.extend(et.asn1.DERGeneralizedTime,et.asn1.DERAbstractTime),et.asn1.DERSequeV}},tt.lang.extend(et.asn1.DERSequence,et.asn1.DERAbstractStructured),et.asn1.DER1)},tt.lang.extend(et.asn1.DERSet,et.asn1.DERAbstractStructured),et.asn1.DERTaggedObj))},tt.lang.extend(et.asn1.DERTaggedObject,et.asn1.ASN1Object);var,e}(Z),t}();window.JSEncrypt=nt,t.JSEncrypt=nt,t["default"]=nt,Object.defineProperty(t,"__esModule",{value:!0})}),define("skins/chat/log_and_tooltip",["config/main","static/console","lib/i18n!front","lib/helpers/popup","lib/helpers/overlay","static/storage"],function(t,e,i,n,r,s){var o=function(e,i){this.debug=e,this.overlay=r,this.debug_id=i,this.xv_console_on=!0,this.log_debug_on=1==s.get("chat_log_debug_on"),this.log_important_on=!0,this.log_error_on=!0,this.debug_me=!1,"undefined"!=typeof t.data&&"undefined"!=typeof t.dyn.login_info&&"undefined"!=typeof t.dyn.login_info.id&&t.dyn.login_info.id===this.debug_id&&(this.debug_i=0,this.debug_me=!0,$("#chat-window").append('<div id="log-display-box" style="overflow:auto;display:none;position:absolute;left:12px;bottom:0;right:0;top:0;z-index:780;"></div>'),$("#chat-window").append('<div id="display-log" style="position:absolute;left:0;bottom:0;height:10px;width:3px;z-index:800;"></div>'),$("#display-log").on("cli()})),this.display_message_old_browser=!1,this.popup=!1,this.overlay=!1};return o.prototype={encode_html_special_cars:function(t){for(var e,i=["<",">","'",'"',"/"],n="",r=0;r<t.length;r++)e=t[r],-1!==i.indexOf(e)&&(e="&#"+e.charCodeAt()+";"),n+=e;return n},set_log_debug:function(t){0!==t&&1!==t||(this.log_debug_on=t)},write_error:function(t,e,n){var r="<p><a onclick='window.location.reload();'>"+i.__("misc.refresh_this_page")+"</a></p>";void 0!==e&&!1===e&&(r="");var s=t.message;this.write_error.caller&&this.write_error.caller.name&&(s+=" < "+this.write_error.caller.name,this.write_error.caller.caller&&this.write_error.caller.caller.name&&(s+=" < "+this.write_error.caller.caller.name)),this.log_error("write_error",s),this.modal(i.__("misc.error"),"<p>"+t.message+"</p>"+r,n)},write_error_old_browser:function(){this.write_error({message:i.__("chat.old_not_supported_browser")},!1),this.display_message_old_browser=!0},write_message:function(t){this.log_debug("MESSAGE",t),this.modal("Message","<p>"+t.message+"</p>")},write_message_no_private_key:function(t){this.log_debug("write_message_no_private_key"),"function"==typeof t?this.write_message_no_private_key_pwd(t):this.write_message_no_private_key_rct(),$("#chat-window .chat-icon #chat-icon-badge").length>0?$("#chat-icon-badge").html("!"):$("#chat-window .chat-icon").append('<span class="badge" id="chat-icon-badge">!</span>')},write_message_no_private_key_pwd:function(t){var e="<br />";e+="<p>"+i.__("chat.enter_password")+"</p><br />",e+='<div id="chat_pass_no_key_check_pass">'+i.__("chat.check_password")+"</div>",e+='<div id="chat_pass_no_key_form"><div id="chat_pass_no_key_error"></div>',e+="<div>"+i.__("login_form.your_password")+' <input type="password" id="chat_pass_no_key" /> <button id="chat_pass_no_key_submit">'+i.__("misc.OK")+"</button></div>",e+="</div>",this.modal(i.__("chat.password_required"),e,!1),$(".chat-title").on("click.chat_dont_ask_crypt_pwd",this.set_dont_ask_password_on_chat_close),$("#chat_pass_no_key_submit").on("click",function(){$("#chat_pass_no_key_form").hide(),$("#chat_pass_no_key_check_pass").show(),t($("#chat_pass_no_key").val())})},remove_dont_ask_password_on_chat_cl")},set_dont_ask_password_on_chat_cl1)},write_message_no_private_key_rct:function(){var t="<br /><p><b>"+i.__("chat.crypt_need_reconnect",{"%start_link%":"<a href='/account/signout'>","%end_link%":"</a>"})+"</b></p>";this.modal(i.__("chat.reconnection_required"),t,!0)},modal:function(t,e,n){this.display_message_old_browser&&(e="<p>"+i.__("chat.old_not_supported_browser")+"</p>"+e),void 0!==n&&1==n&&(this.overlay=r.get($("#chat-window").find(".overlay-container"),!1,"hide")),this.overlay||(this.overlay=r.get($("#chat-window").find(".overlay-container"),!0,"hide")),this.overlay.setContent("<h3>"+t+"</h3>"+e).show()},overlay_close:function(){this.overlay&&this.overlay.close()},overlay_remove:function(){this.overlay&&this.overlay.remove()},log_debug:function(t,e){(this.log_debug_on||this.debug_me)&&this.log(t,e)},log_important:function(t,e){(this.log_important_on||this.debug_me)&&this.log(t,e)},log_error:function(t,e){(this.log_error_on||this.debug_me)&&this.log(t,e)},log:function(t,i){try{desc_display="",void 0!==i&&(desc_display=" -> "+JSON.stringify(i))}catch(a){desc_display=" -> log's JSON stringify failed"}var n="";try{var r=new Error("StackLog").stack.split("\n");for(var s in r)if(s>0&&"undefined"!=typeof r[s]&&-1==r[s].indexOf("log_and_tooltip.js")){var o=r[s].split("/");n=o[o.length-1];break}}catch(a){}this.debug_me&&(this.debug_i++,color=this.debug_i%2==0?"#FFFFFF":"#DDDDDD",$("#log-display-box").append('<div style="background-color:'+color+'">'+t+desc_display+"</div>")),(this.xv_console_on||this.debug_me)&&e.log(n+" "+t+desc_display,"chat"),this.debug&&(void 0===i?console.log("CHAT "+n+": "+t):console.log("CHAT "+n+": "+t,i))},popup_open:function(t,e,i){var r=Math.min($("#chat-window .chat-header-container").width(),400),s={closebtn:!0,max_width:r,popup_class:"chat_xv_popup"},o=$.extend({},s,i||{});$(".chat_xv_popup").remove(),this.popup=new n(t,e,o),this.popup.open()},popup_title_open:function(t){var e={position:{v:"below",h:"left"}};this.popup_open($("#chat-window .chat-title"),t,e)},popup_cl()}},o}),define("skins/chat/internal_message",["config/main","static/cookies","libs/jsencrypt.min","skins/chat/log_and_tooltip"],function(t,e,i,n){var r={};return r.ask_conv_key=function(i,n,r,s,o,a){if(s==i.user_id)return!0;if("undefined"==typeof r.timestamp)return{error:"missing timestamp"};if("undefined"==typeof i.chat_friend_manager.friends[s]||"undefined"==typeof i.chat_friend_manager.friends[s].conversation_key)return{error:"missing friend conv keys"};var c=null;"undefined"!=typeof i.chat_friend_manager.friends[s].conversation_key[r.timestamp]&&(c=i.chat_friend_manager.friends[s].conversation_key[r.timestamp]);var d={id_friend:s,action:"add_message",params:{message:i.make_real_message(JSON.stringify({action:"send_conv_key",timestamp:r.timestamp,conv_key:c}),s),message_id:n}};return d[t.dyn.chat.cookie_name]=e.get(t.dyn.chat.cookie_name),i.socket_connection.emit("internal_message",d),!0},r.send_conv_key=function(n,r,s,o,a,c){if(o==n.user_id)return!0;if("undefined"==typeof s.conv_key)return{error:"missing conv_key"};if("undefined"==typeof s.timestamp)return{error:"missing timestamp"};var d="null";if(null!==s.conv_key){var h=new i.JSEncrypt;h.setPrivateKey(n.priv_key),d=h.encrypt(s.conv_key)}var _={id_friend:o,action:"set_conv_key",params:{message_id:r,conv_key:d,timestamp:s.timestamp}};return _[t.dyn.chat.cookie_name]=e.get(t.dyn.chat.cookie_name),n.socket_connection.emit("internal_message",_),!0},{execute_action:function(e,i,s,o,a,c){"undefined"==typeof params&&(params={});try{s=JSON.parse(s)}catch(d){return log_and_tooltip=new n(!0,47530703,t.dyn.chat.is_dev),log_and_tooltip.log_debug("failed to parse JSON"),!1}return"undefined"==typeof s.action||"function"!=typeof r[s.action]?{error:"bad action"}:r[s.action](e,i,s,o,a,c)}}});var firebase=function(){var t=void 0===t?self:t;return functionts}var n=t.webpackJsonpFirebase;t.webpackJsonpFireb d};var r={},s={6:0};return i.m=e,i.c=r,})},,e},e)},i.p="",i,t},i(i.s=59ay},,function(t,e,i){"use strinction d(t}}var r,s,o,a,c={label:0,s1]},trys:[],ops:[]};return a={next:i(0),"throw":i(1),"return":i(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}defineProperty(e,"__esModule",{value:!0}),e.__extends=n,
i.d(e,"__assign",function(){return k}),e.__rest=r,e.__decorate=s,e.__param=o,e.__metadata=a,e.__awaiter=c,e.__generator=d,e.__exportStar=h,e.__values=_,e.__read=l,e.__spread=u,e.__await=f,e.__asyncGenerator=p,e.__asyncDelegator=g,e.__asyncValues=m,e.__makeTemplateObject=v,e.__importStar=y,e.__importDefault=b;var w=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])},k=Object.assi t}},,,,,function(t,e,i){"use stri)}Object.defineProperty(e,"__esModule",{value:!0});var s=i(0),o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},a="[DEFAULT]",c=[],d=functio}}}return Object.defineProperty(t.prototype,"name",{get:function(){return this.h(),this.u},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"options",{get:function(){return this.h(),this.f},enumerable:!0,configurable:!0}),t.prototype["delete"]=function(){var t=this;return new Prom()}).then(function(){t.t.INTERNAL.removeApp(t.u);var e=[];return Object.keys(t.a).forE})}),Promise.all(e.()}))}).t{}})},t.prototype]},t.prototype.extend])},t.prototyp})},t}();d.prototype.name&&d.prototype.options||d.prototype["delete"]||console.log("dc");var h={"no-app":"No Firebase App '{$name}' has been created - call Firebase App.initializeApp()","bad-app-name":"Illegal App name: '{$name}","duplicate-app":"Firebase App named '{$name}' already exists","app-deleted":"Firebase App named '{$name}' already deleted","duplicate-service":"Firebase service named '{$name}' already registered","sa-not-supported":"Initializing the Firebase SDK with a service account is only allowed in a Node.js environment. On client devices, you should instead initialize the SDK with an api key and auth domain","invalid-app-argument":"firebase.{$name}() takes either no argument or a Firebase App instance."},_=new s.ErrorFactory("app","Firebase",h);i.d(e,"firebase",function(){return l});var l=n();e["default"]=l}=n},,,,,,"}},,,,0}},,,,,,,,,,,,,,,,,,,,,,,,,,function(t,e,i){i(60),t.exports=i(7)["default))},function(t,e,i){"use strict";(function(e){function i_=setTimeout;r.prototype["catct)},r.prototype.t,n},r.prototype["finall})},r.})},r.reso})},r.rej})},r.r})},r.A="function"==typeof e&&function(t){e(t0)},t)},t.exports=r}).call(e,i(63).setImmediat=s},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=functio})}return t.prototype.wrapCallback=function(t){var e=this;return function(i,n){i?e.reject(i):e.resolve(n),"function"==typeof t&&(e.promise["catch"](function(){}),1===t.length?t(i):t(i,n))}},t}();e.Deferred=n},function(t,e,i){"use strii)}function r(t,e){return function(){for(var i=[],n=0;n<arguments.length;n++)i[n]=arguments[n];Promise.resolve(!0).ti)})["catct)!1}function o(){}Object.defineProperty(e,"__esModule",{value:!0}),e.createSubscribe=n;var a=function(){function t(t,e){var i=this;this.observers=[],this.unsubscribes=[],this.observerCount=0,this.task=Promise.resolve(),this.finalized=!1,this.onNoObservers=e,this.task.then(function(){t(i)})["catch"](function(t){i.error(t)})}return t.prototype.n})},t.prototype.ert)},t.prototype.compl()},t.prototype.subscr,a},t.prototype.unsubscribe))},t.prototype.forEachObsert)},t.prototype.send})},t.prototype.cl))},t}();e.asynce}}])}()["default"];define("@firebase/app",function(){});try{webpackJsonpFirebase([3],{1)},121:function(t,e,i){"use stri))}function r(t){if(t.objectStoreNames.contains(S)){var e=t.transaction(S),i=e.objectStore(S),n=new w,r=i.openCursor();r.onerror=function(t){console.warn("Unable to cleanup old IDB.",t)},r.onsuccess=function(){var e=r.result;if(e){var i=e.value;n.deleteToken(i.fcmSenderId,i.fcmToken,i.fcmPushSet),e["continue"]()}else t.close(),indexedDB.deleteDatabase(k)}}function oi)}Object.defineProperty(e,"__esModule",{value:!0});var c,d=i(2),h=i(0),_={AVAILABLE_IN_WINDOW:"only-available-in-window",AVAILABLE_IN_SW:"only-available-in-sw",SHOULD_BE_INHERITED:"should-be-overriden",BAD_SENDER_ID:"bad-sender-id",INCORRECT_GCM_SENDER_ID:"incorrect-gcm-sender-id",PERMISSION_DEFAULT:"permission-default",PERMISSION_BLOCKED:"permission-blocked",UNSUPPORTED_BROWSER:"unsupported-browser",NOTIFICATIONS_BLOCKED:"notifications-blocked",FAILED_DEFAULT_REGISTRATION:"failed-serviceworker-registration",SW_REGISTRATION_EXPECTED:"sw-registration-expected",GET_SUBSCRIPTION_FAILED:"get-subscription-failed",INVALID_SAVED_TOKEN:"invalid-saved-token",SW_REG_REDUNDANT:"sw-reg-redundant",TOKEN_SUBSCRIBE_FAILED:"token-subscribe-failed",TOKEN_SUBSCRIBE_NO_TOKEN:"token-subscribe-no-token",TOKEN_SUBSCRIBE_NO_PUSH_SET:"token-subscribe-no-push-set",TOKEN_UNSUBSCRIBE_FAILED:"token-unsubscribe-failed",TOKEN_UPDATE_FAILED:"token-update-failed",TOKEN_UPDATE_NO_TOKEN:"token-update-no-token",USE_SW_BEFORE_GET_TOKEN:"use-sw-before-get-token",INVALID_DELETE_TOKEN:"invalid-delete-token",DELETE_TOKEN_NOT_FOUND:"delete-token-not-found",DELETE_SCOPE_NOT_FOUND:"delete-scope-not-found",BG_HANDLER_FUNCTION_EXPECTED:"bg-handler-function-expected",NO_WINDOW_CLIENT_TO_MSG:"no-window-client-to-msg",UNABLE_TO_RESUBSCRIBE:"unable-to-resubscribe",NO_FCM_TOKEN_FOR_RESUBSCRIBE:"no-fcm-token-for-resubscribe",FAILED_TO_DELETE_TOKEN:"failed-to-delete-token",NO_SW_IN_REG:"no-sw-in-reg",BAD_SCOPE:"bad-scope",BAD_VAPID_KEY:"bad-vapid-key",BAD_SUBSCRIPTION:"bad-subscription",BAD_TOKEN:"bad-token",BAD_PUSH_SET:"bad-push-set",FAILED_DELETE_VAPID_KEY:"failed-delete-vapid-key",INVALID_PUBLIC_VAPID_KEY:"invalid-public-vapid-key",USE_PUBLIC_KEY_BEFORE_GET_TOKEN:"use-public-key-before-get-token",PUBLIC_KEY_DECRYPTION_FAILED:"public-vapid-key-decryption-failed"},l=(c={},c[_.AVAILABLE_IN_WINDOW]="This method is available in a Window context.",c[_.AVAILABLE_IN_SW]="This method is available in a service worker context.",c["should-be-overriden"]="This method should be overriden by extended classes.",c["bad-sender-id"]="Please ensure that 'messagingSenderId' is set correctly in the options passed into firebase.initializeApp().",c["permission-default"]="The required permissions were not granted and dismissed instead.",c["permission-blocked"]="The required permissions were not granted and blocked instead.",c["unsupported-browser"]="This browser doesn't support the API's required to use the firebase SDK.",c["notifications-blocked"]="Notifications have been blocked.",c[_.FAILED_DEFAULT_REGISTRATION]="We are unable to register the default service worker. {$browserErrorMessage}",c["sw-registration-expected"]="A service worker registration was the expected input.",c["get-subscription-failed"]="There was an error when trying to get any existing Push Subscriptions.",c["invalid-saved-token"]="Unable to access details of the saved token.",c["sw-reg-redundant"]="The service worker being used for push was made redundant.",c["token-subscribe-failed"]="A problem occured while subscribing the user to FCM: {$message}",c["token-subscribe-no-token"]="FCM returned no token when subscribing the user to push.",c["token-subscribe-no-push-set"]="FCM returned an invalid response when getting an FCM token.",c["token-unsubscribe-failed"]="A problem occured while unsubscribing the user from FCM: {$message}",c["token-update-failed"]="A problem occured while updating the user from FCM: {$message}",c["token-update-no-token"]="FCM returned no token when updating the user to push.",c["use-sw-before-get-token"]="The useServiceWorker() method may only be called once and must be called before calling getToken() to ensure your service worker is used.",c["invalid-delete-token"]="You must pass a valid token into deleteToken(), i.e. the token from getToken().",c["delete-token-not-found"]="The deletion attempt for token could not be performed as the token was not found.",
c["delete-scope-not-found"]="The deletion attempt for service worker scope could not be performed as the scope was not found.",c["bg-handler-function-expected"]="The input to setBackgroundMessageHandler() must be a function.",c["no-window-client-to-msg"]="An attempt was made to message a non-existant window client.",c["unable-to-resubscribe"]="There was an error while re-subscribing the FCM token for push messaging. Will have to resubscribe the user on next visit. {$message}",c["no-fcm-token-for-resubscribe"]="Could not find an FCM token and as a result, unable to resubscribe. Will have to resubscribe the user on next visit.",c["failed-to-delete-token"]="Unable to delete the currently saved token.",c["no-sw-in-reg"]="Even though the service worker registration was successful, there was a problem accessing the service worker itself.",c["incorrect-gcm-sender-id"]="Please change your web app manifest's 'gcm_sender_id' value to '103953800507' to use Firebase messaging.",c["bad-scope"]="The service worker scope must be a string with at least one character.",c["bad-vapid-key"]="The public VAPID key is not a Uint8Array with 65 bytes.",c["bad-subscription"]="The subscription must be a valid PushSubscription.",c["bad-token"]="The FCM Token used for storage / lookup was not a valid token string.",c["bad-push-set"]="The FCM push set used for storage / lookup was not not a valid push set string.",c["failed-delete-vapid-key"]="The VAPID key could not be deleted.",c["invalid-public-vapid-key"]="The public VAPID key must be a string.",c[_.PUBLIC_KEY_DECRYPTION_FAILED]="The public VAPID key did not equal 65 bytes when decrypted.",c),u={codes:_,map:l,t}(),p=")},m=new Uint8Array([4,51,148,247,223,161,235,177,220,3,162,94,21,113,219,72,211,46,237,237,178,52,219,183,71,58,12,143,196,204,225,111,60,140,132,223,171,182,102,62,242,12,212,139,254,227,249,118,47,20,28,99,8,106,111,45,177,26,149,176,206,55,192,156,110]),v={userVisibleOnly:!0,applicationServerKey:m},y={DEFAULT_PUBLIC_VAPID_KEY:m,SUBSCRIPTION_DETAILS:v,ENDPOINT:"https://fcm.googleapis.com"},b=functiop)}return t.prototype.getToken=function(t,e,i){var n=this,r=g(e.getKey("p256dh")),s=g(e.getKey("auth")),o="authorized_entity="+t+"&endpoint="+e.endpoint+"&encryption_key="+r+"&encryption_auth="+s;i!==y.DEFAULT_PUBLIC_VAPID_KEY&&(o+="&application_pub_key="+g(i));var a=new Headers;a.append("Content-Type","application/x-www-form-urlencoded");var c={method:"POST",headers:a,body:o};return fetch(y.ENDPOINT+"/fcm/connect/subscribe",c).then(function(t){return t.json()})["catch"](function(){throw n.e.create(u.codes.TOKEN_SUBSCRIBE_FAILED)}).tt}})},t.prototype.updateToken=function(t,e,i,n,r){var s=this,o=g(n.getKey("p256dh")),a=g(n.getKey("auth")),c="push_set="+i+"&token="+e+"&authorized_entity="+t+"&endpoint="+n.endpoint+"&encryption_key="+o+"&encryption_auth="+a;r!==y.DEFAULT_PUBLIC_VAPID_KEY&&(c+="&application_pub_key="+g(r));var d=new Headers;d.append("Content-Type","application/x-www-form-urlencoded");var h,_={method:"POST",headers:d,body:c};return fetch(y.ENDPOINT+"/fcm/connect/subscribe",_).t()})["catcD)}).ten})},t.prototype.deleteTo})},t}(),w=b,k="undefined",S="fcm_token_object_Store",E="fcm_token_details_db",x=2;o.prototype.fcmToken,o.prototype.swScope,o.prototype.vapidKey,o.prototype.subscription,o.prototype.fcmSenderId,o.prototype.fcmPushSet;var T=function(t){function e(){return t.call(this,E,x)||this}return d.__extends(e,t),e.prototype.onDBUpgr()},e.prototyp})},e.prototype.getTokenDetailsFromTo))},e.prototype.getTokenDetailsFromSWSc))},e.prototype.saveTokenDeta))},e.prototype.deleteToken=function(t){var e=this;return"string"!=typeof t||0===t.length?Promise.reject(this.e.create(u.codes.INVALID_DELETE_TOKEN)):this.getTokenDetailsFromToken(t).then(function(t){if(!t)throw e.e.create(u.codes.DELETE_TOKEN_NOT_FOUND);return e.openDatabase().then(function(i){return new Promise(function(n,r){var s=i.transaction(["fcm_token_object_Store"],e.TRANSACTION_READ_WRITE),o=s.objectStore("fcm_token_object_Store"),a=o["delete"](t.swScope);a.onerr)},a.onsucct)}})})})},e}(p),A=T,C="fcm_vapid_details_db",D=1,I=functionis}return d.__extends(e,t),e.prototype.onDBUpgr})},e.prototype.getVapidFromSWSc})},e.prototype.saveVapidDeta})},e.prototype.deleteVapidDetails=function(t){var e=this;return this.getVapidFromSWScope(t).then(function(i){if(!i)throw e.e.create(u.codes.DELETE_SCOPE_NOT_FOUND);return e.openDatabase().then(function(n){return new Promise(function(r,s){var o=n.transaction(["fcm_vapid_object_Store"],e.TRANSACTION_READ_WRITE),a=o.objectStore("fcm_vapid_object_Store"),c=a["delete"](t);c.onerr)},c.onsucci)}})})})},e}(p),P=I,O="messagingSenderId",$=function(){function t(t){var e=this;if(this.e=new h.ErrorFactory("messaging","Messaging",u.map),!t.options[O]||"string"!=typeof t.options[O])throw this.e.create(u.codes.BAD_SENDER_ID);this.i=t.options[O],this.s=new A,this.a=new P,this.c=new w,this.app=t,this.INTERNAL={},this.INTERNAL["delet()}}return t.prototype.getTo})},t.prototype.manageExistingTo})},t.prototype.isTokenStillVadh},t.prototype.updateTo})},t.prototype.getNewTo})},t.prototype.deleteTo})},t.prototype._=function(){throw this.e.create(u.codes.SHOULD_BE_INHERITED)},t.prototype.d=function(){throw this.e.create(u.codes.SHOULD_BE_INHERITED)},t.prototype.requestPermissW)},t.prototype.getPushSubscript})},t.prototype.useServiceWorker=function(t){throw this.e.create(u.codes.AVAILABLE_IN_WINDOW)},t.prototype.usePublicVapidKey=function(t){throw this.e.create(u.codes.AVAILABLE_IN_WINDOW)},t.prototype.onMessage=function(t,e,i){throw this.e.create(u.codes.AVAILABLE_IN_WINDOW)},t.prototype.onTokenRefrW)},t.prototype.setBackgroundMessageHandW)},t.prototype["delet])},t.prototypon},t.prototype.getTokenDetailsModel=function(){return this.s},t.prototype.getVapidDetailsModel=function(){return this.a},t.prototype.getIIDModel=function(){return this.c},t}(),N=$,B={TYPE_OF_MSG:"firebase-messaging-msg-type",DATA:"firebase-messaging-msg-data"},R={PUSH_MSG_RECEIVED:"push-msg-received",NOTIFICATION_CLICKED:"notification-clicked" i},j={PARAMS:B,TYPES_OF_MSG:R,createNewMsg:q},F={path:"/firebase-messaging-sw.js",scope:"/firebase-cloud-messaging-push-scope" r},L=function,i}return d.__extends(e,t),e.prototype.getTo))},e.prototype.m=function(){var t=this;if(this.T)return this.T;var e=document.querySelector('link[rel="manifest"]');return this.T=e?fetch(e.href).t()})["catch"](function(){}).tD)}):Promise.resolve(),this.T},e.prototype.requestPermiss})},e.prototype.useServiceWor=t},e.prototype.usePublicVapid=e},e.prototype.onMessage=function(t,e,i){return this.f(t,e,i)},e.prototype.onTokenRefri)},e.prototyp})},e.prototype._=function(){var t=this;return this.g?this.v(this.g):(this.g=null,navigator.serviceWorker.register(F.path,{scope:F.scope})["catc})}).t})}))},e.prototypY)},e.prototyp1)},e.prototyp")},e}(N),H=L,U=function,i}return d.__extends(e,t),e.prototypn)},e.prototype.I=function(t){var e=this,i=this._().then(function(t){return t.pushManager.getSubscription().t){})["catc})})})["catc})});t.waitUntil(i)},e.prototyp}}},e.prototypi}},e.prototype.setBackgroundMessageHand=t},e.prototyp})},e.prototyp})},e.prototyp})},e.prototyp})},e.prototypn)},e.prototyp})},e}(N),W=U,z=i(7);e.registerMessaging=a,a(z.firebase)}},[120])}catch(e){throw Error("Cannot instantiate firebase-messaging.js - be sure to load firebase-app.js first.")}define("@firebase/messaging",function(){}),define("skins/chat/firebase",["@firebase/ap])}),define("skins/chat/chat_inits",["config/main","static/cookies","static/storage","libs/c3r18y25p16t","lib/i18n!front","./firebase"],function(t,i,n,r,s){var o=function(e,i){this.log_and_tooltip=e,this.service_worker_file="/js/workers/chat-prive-sw.js",this.shared_worker_file="/js/workers/chat-prive-shared.js",this.notif=!1,this.notif_allowed=!0,this.service_worker_register=!1,this.useServiceWorkerDone=!1,this.serviceWorkerRegistration=null,this.sound=!1,this.blur_image=!1,this.mini_disabled=0,this.notif_permission_asked=!1,this.status="Online",t.dyn.chat.prefs.invisible,t.dyn.chat.prefs.invisible&&(this.status="Invisible"),this.log_and_tooltip.log_debug("status "+this.status),this.change_status_fct=i,this.set_timer_away(),this.notif_asked_permission_done=null,this.notif_asked_time=0};return o.prototype={initKey:function(){this.log_and_tooltip.log_debug("init key");var s="",o={stringe)},pa,i}},a=i.get("chat_data_c");if(a){try{s=JSON.parse(r.AES.decrypt(a,t.dyn.login_info.id+"",{format:o}).toString(r.enc.Utf8))}catch(e){this.log_and_tooltip.log_error("failed to decrypt key"),s=""}""!=s?(n.set("chat-pk",a),i.setLocal("chat_data_c","",0,"/")):i.setLocal("chat_data_c",a,2592e6,"/")}if(""==s)try{var c=n.get("chat-pk");if(c)try{s=JSON.parse(r.AES.decrypt(c,t.dyn.login_info.id+"",{format:o}).toString(r.enc.Utf8))}catch(e){this.log_and_tooltip.log_error("failed to decrypt key"),s=""}}catch(e){this.log_and_tooltip.log_error("Storage get chat-pk exception",e.message)}return""!=s&&s},initNotif:function(e){return this.log_and_tooltip.log_debug("initNotif"),"Notification"in window?(this.notif_allowed=!0,this.notif_permission_asked=!0,"undefined"==typeof t.dyn.chat||"undefined"==typeof t.dyn.chat.prefs?void this.log_and_tooltip.log_error("initNotif : unable to get prefs"):("denied"===Notification.permission||"default"===Notification.permission?void 0!==n.get("chat_notif_asked")&&0!=n.get("chat_notif_asked")||(this.notif_permission_asked=!1):this.notif_allowed&&void 0!==n.get("chat_notification")&&1==n.get("chat_notification")&&(this.notif=!0,e.prop("checked",this.notif)),void this.log_and_tooltip.log_debug("notif",this.notif))):(this.log_and_tooltip.log_important("This browser does not support desktop notification"),this.notif_allowed=!1,!1)},setNotif:function(t){this.notif=t,t?(n.set("chat_notification",1),this.notif_option_check.removeClass("chat-settings-option-unchecked").addClass("chat-settings-option-checked")):(n.set("chat_notification",0),this.notif_option_check.removeClass("chat-settings-option-checked").addClass("chat-settings-option-unchecked"))},initSharedWorker:function(t,i,n){if(this.log_and_tooltip.log_debug("initSharedWorker"),!window.SharedWorker)return this.log_and_tooltip.log_important("Browser doesn't support shared worker"),void(this.shared_worker_no_support=!0);try{this.shared_worker=new SharedWorker(this.shared_worker_file),this.shared_worker.port.start(),this.shared_status="close"}catch(e){return this.log_and_tooltip.log_error("init shared_worker error",e.message),void(this.shared_worker_no_support=!0)}this.log_and_tooltip.log_debug("initSharedWorker before set events");var r=this;this.shared_worker.port.addEventListener("message",function(e){r.log_and_tooltip.log_debug("shared worker message",e.data),e.data.hasOwnProperty("action")&&("open"==e.data.action&&"close"==r.shared_status&&(r.log_and_tooltip.log_debug("page open"),r.shared_status="open",r.serviceWorkerRegistration?i():t()),"close"==e.data.action&&"open"==r.shared_status&&(r.log_and_tooltip.log_debug("page close"),r.shared_status="close",n()),"opened"==e.data.action&&r.log_and_tooltip.log_debug("Another page opened"))},!1),window.addEventListener("unlo})}),document.addEventListener("visibilitychange",function(){r.log_and_tooltip.log_debug("visibilitychange",document.visibilityState),"visible"==document.visibilityState&&"undefined"!=typeof r.shared_worker&&"undefined"!=typeof r.shared_worker.port&&r.shared_worker.port.postMessage({action:"focus"})},!1)},initServiceWorker:function(i,n,r,s){if(this.log_and_tooltip.log_debug("initServiceWorker"),!1 in navigator||"undefined"==typeof navigator.serviceWorker)return this.log_and_tooltip.log_debug("serviceWorker not avialable"),void i();if(this.firebase_messaging=!1,"Notification"in window&&"undefined"!=typeof Notification&&"denied"!==Notification.permission){try{firebase.initializeApp(t.dyn.chat.firebase)}catch(e){this.log_and_tooltip.log_error("firebase init failed",e.message)}firebase&&"undefined"!=typeof firebase.apps&&firebase.apps.length&&(this.firebase_messaging=firebase.messaging())}var o=this;this.log_and_tooltip.log_debug("serviceWorker in navigator"),navigator.serviceWorker.register(this.service_worker_file).then(function(t){o.service_worker_register=!0;!o.useServiceWorkerDone&&o.firebase_messaging&&(o.firebase_messaging.useServiceWorker(t),o.useServiceWorkerDone=!0),o.notif&&o.firebase_messaging&&o.firebase_messaging.requestPermission().t()}).tt)})["catc()}),t.active&&(o.serviceWorkerRegistration=t.active,navigator.serviceWorker.onmessage=function(t){r(t)}),"visible"==document.visibilityState&&"undefined"!=typeof o.shared_worker&&"undefined"!=typeof o.shared_worker.port&&o.shared_worker.port.postMessage({action:"focus"}),n()})["catch"](function(t){o.log_and_tooltip.log_error("Firebase registration error Occured.",t),"visible"==document.visibilityState&&("visible"==document.visibilityState&&"undefined"!=typeof o.shared_worker&&"undefined"!=typeof o.shared_worker.port&&o.shared_worker.port.postMessage({action:"focus"}),i())}),o.firebase_messaging&&(o.firebase_messaging.onTokenRefresh(function(){o.log_and_tooltip.log_debug("onTokenRefresh"),o.firebase_messaging.getToken().tt)})["catch"](function(t){o.log_and_tooltip.log_error("Unable to retrieve refreshed token ",t)})}),o.firebase_messaging.onMesst)}))},checkNotifPermissionAsked:function(t){if(!this.notif_permission_asked&&"Notification"in window&&Notification&&"granted"!==Notification.permission&&$("#chat-window .chat-title").length>0){var e="<h4>"+s.__("chat.activate_notification")+"</h4>";e+='<p class="chat_popup_buttons"><button id="chat_permission_ask">'+s.__("misc.yes")+'</button><button id="chat_permission_not_ask">'+s.__("misc.no")+"</button></p>",this.log_and_tooltip.popup_open($("#chat-window .chat-title"),e,{trigger:!1,autoclose:!1});var i=this;$("#chat_permission_ask").on("click",function(e){if(e.stopPropagation(),i.log_and_tooltip.popup_close(),i.notif_permission_asked=!0,n.set("chat_notif_asked",1),"denied"===Notification.permission)return void i.log_and_tooltip.popup_open($("#chat-window .chat-settings"),"<p>"+s.__("chat.infos.notification_refused")+"</p>",{trigger:!1});"default"===Notification.permission&&i.askNotifPermission(t)}),$("#chat_permission_not_ask").on("click",function(t){t.stopPropagation(),i.notif_permission_asked=!0,n.set("chat_notif_asked",1),i.log_and_tooltip.popup_close()})}},askNotifPermission:function(t){if(this.log_and_tooltip.log_debug("askNotifPermission"),!("Notification"in window))return this.log_and_tooltip.log_debug("askNotifPermission","Browser don't support Notif"),!1;if(!Notification||"denied"==Notification.permission)return this.log_and_tooltip.log_debug("askNotifPermission","already denied"),!1;if("granted"==Notification.permission)return this.log_and_tooltip.log_debug("askNotifPermission","already granted"),!0;var e=this;if("default"===Notification.permission){var i=(new Date).getTime();!1===this.notif_asked_permission_done&&i-this.notif_asked_time<12e4&&e.log_and_tooltip.popup_open($("#chat-window .chat-settings"),"<p>"+s.__("chat.infos.notification_refused")+"</p>",{trigger:!1}),this.notif_asked_permission_done=!1,this.notif_asked_time=(new Date).getTime(),Notification.requestPermission().then(function(){return e.notif_asked_permission_done=!0,"granted"==Notification.permission&&(e.log_and_tooltip.log_debug("askNotifPermission","granted"),e.setNotif(!0),setTimeout(function(){e.getTokenFromSW(t,2)},3e3),!0)})["catch"](function(i){e.notif_asked_permission_done=!0,"granted"===Notification.permission?(e.log_and_tooltip.log_error("failed to get SW token, will retry in 5s.",i),e.setNotif(!0),setTime1)},5e3)):e.log_and_tooltip.log_error("Notification init failed.",i)})}},getTokenFromSW:function(t,e){if(!("Notification"in window&&"granted"===Notification.permission&&this.firebase_messaging))return!1;var i=this;this.firebase_messaging.getToken().te)})["catch"](function(n){i.log_and_tooltip.log_error("getTokenFromSW failed.",n),e&&e===parseInt(e)&&e>0&&setTime1)},3e3)})},removeServiceWorker:function(){this.log_and_tooltip.log_debug("removeServiceWorker"),"serviceWorker"in navigator&&navigator.serviceWorker.getRegistrations().t()}),this.service_worker_register=!1},initSettings:function(e,i,r,o,a,c,d){this.log_and_tooltip.log_debug("init settings"),this.change_status_fct=e,this.emit_change_pref_fct=i,this.remove_SW_token_fct=d;var h=$(".chat-settings");this.settings_list=$("#chat-settings-list");var _=this;h.on("cli()}),this.settings_list.on("cli()}),$("#chat-option-status-online").on("click",function(){_.change_status_fct("Online")}),$("#chat-option-status-away").on("click",function(){_.change_status_fct("Away")}),$("#chat-option-status-invisible").on("click",function(){_.change_status_fct("Invisible")}),"Invisible"==this.status?($("#chat-option-status-invisible .chat-settings-option-icon").addClass("icon chat-settings-option-checked"),$(".chat-title-text").html(s.__("chat.infos.xvideos_chat")+" ("+s.__("chat.status.invisible")+")")):$("#chat-option-status-online .chat-settings-option-icon").addClass("icon chat-settings-option-checked"),$("#chat-option-size-small").on("click",function(){_.change_size(0,a)}),$("#chat-option-size-medium").on("click",function(){_.change_size(1,a)}),$("#chat-option-size-big").on("clia)});var l=$("#chat-option-sound");l.on("cli()}),this.sound_option_check=l.find(".chat-settings-option-icon"),"undefined"!=typeof t.dyn.chat.prefs.sound&&(this.sound=1==t.dyn.chat.prefs.sound),this.sound?this.sound_option_check.addClass("icon chat-settings-option-checked"):this.sound_option_check.addClass("icon chat-settings-option-unchecked");var u=$("#chat-option-notification");u.on("clic)}),this.notif_option_check=u.find(".chat-settings-option-icon"),!0===this.notif&&this.notif_option_check.removeClass("chat-settings-option-unchecked").addClass("chat-settings-option-checked"),"undefined"!=typeof t.dyn.chat.prefs.notif_asked&&(this.notif_permission_asked=1==n.get("chat_notif_asked")),$("#chat-option-color0").on("click",function(t){_.change_messages_color(0,a,t)}),$("#chat-option-color1").on("click",function(t){_.change_messages_color(1,a,t)}),$("#chat-option-color2").on("clit)});var f=this.get_size();0!=f&&this.change_size(f,a);var p=this.get_messages_color();this.log_and_tooltip.log_debug("chat colors : "+p),0!=p&&this.change_messages_color(p,a),o.on("clit)}),this.mini_disabled_option=$("#chat-option-mini-disabled").find(".chat-settings-option-text"),this.mini_disabled=0,"undefined"!=typeof t.dyn.chat.prefs.mini_disabled&&1==t.dyn.chat.prefs.mini_disabled&&(this.mini_disabled_option.html(s.__("chat.settings.enable_mini_chat")),this.mini_disabled=1),$("#chat-option-mini-disabled").on("cli()});var g=$("#chat-option-blur-image");g.on("click",function(t){t.stopPropagation(),_.switch_blur_image()}),this.blur_image_option_check=g.find(".chat-settings-option-icon"),1==t.dyn.chat.prefs.blur_image&&(this.blur_image=!0,this.blur_image_option_check.removeClass("chat-settings-option-unchecked").addClass("chat-settings-option-checked"))},get_size:function(){var t=0;return t=n.get("chat-size"),0!=t&&1!=t&&2!=t?0:t},change_size:function(t,e){return this.set_timer_away(),0==t?(e.removeClass("zoom1 zoom2"),this.set_size(0),e.find("#chat-option-size-small .chat-settings-option-icon").addClass("chat-settings-option-checked icon"),e.find("#chat-option-size-medium .chat-settings-option-icon").removeClass("chat-settings-option-checked icon"),void e.find("#chat-option-size-big .chat-settings-option-icon").removeClass("chat-settings-option-checked icon")):1==t?(e.removeClass("zoom2"),e.addClass("zoom1"),this.set_size(1),e.find("#chat-option-size-small .chat-settings-option-icon").removeClass("chat-settings-option-checked icon"),e.find("#chat-option-size-medium .chat-settings-option-icon").addClass("chat-settings-option-checked icon"),void e.find("#chat-option-size-big .chat-settings-option-icon").removeClass("chat-settings-option-checked icon")):2==t?(e.removeClass("zoom1"),e.addClass("zoom2"),this.set_size(2),e.find("#chat-option-size-small .chat-settings-option-icon").removeClass("chat-settings-option-checked icon"),e.find("#chat-option-size-medium .chat-settings-option-icon").removeClass("chat-settings-option-checked icon"),void e.find("#chat-option-size-big .chat-settings-option-icon").addClass("chat-settings-option-checked icon")):void 0},set_size:function(t){n.set("chat-size",t)},get_messages_color:function(){var t=0;return t=n.get("chat-color"),0!=t&&1!=t&&2!=t?0:t},change_messages_color:function(t,e,i){return this.set_timer_away(),void 0!==i&&i.stopPropagation(),0==t?(e.removeClass("color1 color2"),this.set_messages_color(0),e.find("#chat-option-color0 .chat-settings-option-icon").addClass("chat-settings-option-checked icon"),e.find("#chat-option-color1 .chat-settings-option-icon").removeClass("chat-settings-option-checked icon"),void e.find("#chat-option-color2 .chat-settings-option-icon").removeClass("chat-settings-option-checked icon")):1==t?(e.removeClass("color2"),e.addClass("color1"),this.set_messages_color(1),e.find("#chat-option-color0 .chat-settings-option-icon").removeClass("chat-settings-option-checked icon"),e.find("#chat-option-color1 .chat-settings-option-icon").addClass("chat-settings-option-checked icon"),void e.find("#chat-option-color2 .chat-settings-option-icon").removeClass("chat-settings-option-checked icon")):2==t?(e.removeClass("color1"),e.addClass("color2"),this.set_messages_color(2),e.find("#chat-option-color0 .chat-settings-option-icon").removeClass("chat-settings-option-checked icon"),e.find("#chat-option-color1 .chat-settings-option-icon").removeClass("chat-settings-option-checked icon"),void e.find("#chat-option-color2 .chat-settings-option-icon").addClass("chat-settings-option-checked icon")):void 0},set_messages_color:function(t){n.set("chat-color",t)},switch_sound:function(){this.set_timer_away();var t=!this.sound;this.log_and_tooltip.log_debug("switch sound ",t),this.sound=t,this.sound_option_check.toggleClass("chat-settings-option-checked chat-settings-option-unchecked"),this.emit_change_pref_fct(this.sound,this.mini_disabled,this.blur_image)},play_notif:function(){if(this.sound){var t=$("#mess_notif");t[0]&&t[0].play()}},switch_notification:function(t){return this.log_and_tooltip.log_debug("switch notification"),this.set_timer_away(),!0===this.notif?(this.log_and_tooltip.log_debug("switch_notification","emit notif -> false"),this.setNotif(!1),void this.remove_SW_token_fct()):this.notif_allowed&&"Notification"in window?"denied"===Notification.permission?(this.settings_list.toggle(),void this.log_and_tooltip.popup_open($("#chat-window .chat-settings"),"<p>"+s.__("chat.infos.notification_refused")+"</p>")):"default"===Notification.permission?(this.log_and_tooltip.log_debug("asking for desktop notification permission"),void this.askNotifPermission(t)):!1===this.notif?(this.log_and_tooltip.log_debug("switch_notification","emit notif -> true"),this.setNotif(!0),void this.getTokenFromSW(t,2)):void 0:(this.settings_list.toggle(),void this.log_and_tooltip.popup_open($("#chat-window .chat-settings"),"<p>"+s.__("chat.infos.no_support_notification")+"</p>"))},switch_blur_image:function(t){this.log_and_tooltip.log_debug("switch blur image"),this.set_timer_away();var e=this.blur_image;"boolean"==typeof t&&(e=!t),e?this.emit_change_pref_fct(this.sound,this.mini_disabled,0):this.emit_change_pref_fct(this.sound,this.mini_disabled,1)},deactivate_chat_on_website:function(){this.set_timer_away(),1==this.mini_disabled?this.emit_change_pref_fct(this.sound,0,this.blur_image):confirm($("<textarea />").html(s.__("chat.infos.confirm_disable_mini_chat")).text().replace("\\n","\n"))&&this.emit_change_pref_fct(this.sound,1,this.blur_image)},set_change_prefs:function(e,n){this.log_and_tooltip.log_debug("set_change_prefs",e),"undefined"!=typeof e.prefs&&("undefined"!=typeof e.prefs.mini_disabled&&e.prefs.mini_disabled!=this.mini_disabled&&(this.mini_disabled=parseInt(e.prefs.mini_disabled),0==this.mini_disabled?this.mini_disabled_option.html(s.__("chat.settings.disable_mini_chat")):(this.mini_disabled_option.html(s.__("chat.settings.enable_mini_chat")),0===$("#account-chat-private-container").length&&(n(),$("#chat-window").remove()))),"undefined"!=typeof e.prefs.blur_image&&e.prefs.blur_image!=this.blur_image&&(1==e.prefs.blur_image?(this.blur_image=!0,this.blur_image_option_check.removeClass("chat-settings-option-unchecked").addClass("chat-settings-option-checked"),$(".chat-messages .chat_message_display .chat_upload_blur_button").remove()):(this.blur_image=!1,this.blur_image_option_check.removeClass("chat-settings-option-checked").addClass("chat-settings-option-unchecked")))),"undefined"!=typeof e[t.dyn.chat.cookie_name]&&(this.log_and_tooltip.log_debug("set cookie"),i.setLocal(t.dyn.chat.cookie_name,e[t.dyn.chat.cookie_name],0,"/"))},set_timer_away:function(){if(this.log_and_tooltip.log_debug("set_timer_away"),"Invisible"!=this.status||0!=this.timer_away){if("undefined"!=typeof this.timer_away&&0!=this.timer_away&&clearTimeout(this.timer_away),"Invisible"==this.status)return void(this.timer_away=!1);var t=this;this.timer_away=setTimeout(function(){t.change_status_fct("Away")},6e5),"Away"==this.status&&this.change_status_fct("Online")}}},o}),define("text!skins/chat/photos.mustache",[],function(){return'<div id="chat-container-photos">\n    <div id="chat-photos-container-img" style="">\n        <img id="chat-photos-loader" class="chat-photos-img-loader" src="{{ loading }}">\n        <div id="chat-photos-slider">\n            <div id="chat-photos-previous"></div>\n            <div id="chat-photos-next"></div>\n        </div>\n    </div>\n    <div id="chat-photos-container-bottom">\n        <div id="chat-photos-container-title"></div>\n        <div id="chat-photos-container-nb-pics"></div>\n    </div>\n    <div id="chat-photos-preloader"></div>\n</div>'}),define("skins/chat/chat_preview",["config/main","mustache","lib/helpers/overlay","text!skins/chat/photos.mustache","lib/i18n!front","lib/tools","lib/helpers/thumbs_rotator"],function(t,e,i,n,r,s,o){var a=function(){this.container=$(e.render(n,{loading:t.domains["static"]+"/v3/img/skins/default/xv-big-loader.gif"})),this.overlay=i.get($("#chat-window").find(".overlay-container"),!0,"hide"),this.overlay.addClass("chat-overlay-photos"),this.overlay.setContent(this.container),this.overlay.show(),this.urls=[],this.title="",this.index_photo=0,this.loader=$("#chat-photos-loader"),this.preloader=$("#chat-photos-preloader"),this.img_container=$("#chat-photos-container-img");var r=this;return $("#chat-photos-previous").on("click",function(t){t.stopPropagation(),r.previous()}),$("#chat-photos-next").on("click",function(t){t.stopPropagation(),r.next()}),this};return a.prototype={init:function(t,e,i,n,s){this.urls=i,this.title=e,this.index_photo=0,this.nb_pics=n,n>this.urls.length&&this.img_container.append('<div id="chat-photos-img10" class="chat-photos-img chat-photos-img-text"><a href="'+s+'" target="_blank">'+r.__("profile.see_full_album")+"</a></div>"),$("#chat-photos-container-title").html(e),this.update_nb_pics(),this.showCurrentImage()},update_nb_pics:function(){var t=this.index_photo+1;t>this.urls.length&&(t=this.urls.length+"+"),$("#chat-photos-container-nb-pics").html(t+"/"+this.nb_pics)},o()},h()},previous:function(){this.index_photo--,this.index_photo<0&&(this.index_photo=this.urls.length-1,this.nb_pics>this.urls.length&&this.index_photo++),this.showCurrentImage()},next:function(){this.index_photo++,this.index_photo>=this.urls.length&&(this.index_photo!==this.urls.length||this.nb_pics<=this.urls.length)&&(this.index_photo=0),this.showCurrentImage()},showCurrentImage:function(){var t=this.index_photo;if(this.update_nb_pics(),$("#chat-photos-img"+t).length>0)return void this.showImage(t);$(".chat-photos-img").hide(),this.loader.show();var e=this,i=$(new Image);i.attr("src",e.urls[t]),i.addClass("chat-photos-img"),e.preloader.append(i),i.load(function(){i.attr("id","chat-photos-img"+t),i.css("display","none"),e.img_container.append(i),t==e.index_photo&&e.showImage(t)}).error(function(){var i=$(new Image);i.attr("id","chat-photos-img"+t),i.addClass("chat-photos-img"),i.css("display","none"),e.img_container.append(i),t==e.index_photo&&e.showImage(t)})},showImage:function(t){$("#chat-photos-slider").removeClass("full-gallery"),t==this.urls.length?$("#chat-photos-slider").addClass("full-gallery"):$(".chat-photos-img").hide(),this.loader.hide(),$("#chat-photos-img"+t).show()}},function(t,e,i,n,r,c,d,h){var _=/^(.*)\s?http[s]?:\/\/[a-zA-Z0-9_\-]*\.xvideos\.(com|red)\/profiles\/([^\/]*)\/photos\/([0-9]*)\/[^\s]*\s?(.*)$/g,l=_.exec(e);if(!l)var u=/^(.*)\s?http[s]?:\/\/[a-zA-Z0-9_\-]*\.xvideos\.(com|red)\/videos\/profiles\/galleries\/[a-z0-9]*\/[a-z0-9]*\/[a-z0-9]*\/([^\/]*)\/gal([0-9]*)\/pic_([0-9]*)_[^\s]*\s?(.*)$/g,l=u.exec(e);if(l){6==l.length&&(l[6]=l[5],l[5]="");var f=Math.abs(n.scrollHeight-n.scrollTop-n.clientHeight)<10;return void $.ajax({type:"POST",dataType:"json",data:{image:l[5]},url:"/profiles/"+l[3]+"/galleries/"+l[4]+"/chat-get",success:function(e){var s=Math.abs(n.scrollHeight-n.scrollTop-n.clientHeight)<10,o=$(new Image);o.attr("src",e.selected_pics),c.append(o),o.load(function(){var c=Math.abs(n.scrollHeight-n.scrollTop-n.clientHeight)<10,h="";""!=l[1].trim()&&(h="<div>"+l[1].trim()+"</div>"),$("#"+t+" .chat_message").html(h+'<div class="chat_message_gallery"></div>'),$("#"+t+" .chat_message .chat_message_gallery").append(o),$("#"+t+" .chat_message").append('<div class="chat_message_gallery"><a href="'+e.url+'">'+e.title+"</a></div>"),""!=l[5].trim()&&$("#"+t+" .chat_message").append("<div>"+l[6].trim()+"</div>"),i==r&&(f||s||c)&&d(i);var _=Object.keys(e.pics).t]});$("#"+t+" .chat_message img").on("click",function(t){t.stopPropagation(),new a($("#chat-window")).init(e.id,e.title,_,e.nb_pics,e.url)})}).er")})},error:function(t){h.log_error("ERROR get gallery",t)}})}var p=/^(.*)\s?http[s]?:\/\/[a-zA-Z0-9_\-]*\.xvideos\.(com|red)\/video([0-9]*)\/[^\s]*\s?(.*)$/g,g=p.exec(e);if(g){var f=Math.abs(n.scrollHeight-n.scrollTop-n.clientHeight)<10;return void $.ajax({type:"POST",dataType:"json",url:"/video-thumb/"+g[3],success:function(e){if("boolean"==typeof e.result&&e.result&&"string"==typeof e.preview){var a=Math.abs(n.scrollHeight-n.scrollTop-n.clientHeight)<10,c="",h="";""!=g[1].trim()&&(c="<div>"+g[1].trim()+"</div>"),""!=g[4].trim()&&(h="<div>"+g[4].trim()+"</div>");var _=$(s.replaceThumbcast(e.preview.replace(/\\'/gi,"'")));$("#"+t+" .chat_message").html(_),$("#"+t+" .chat_message").prepend(c),$("#"+t+" .chat_message").append(h),s.executePendingPrepare($("#"+t+" .chat_message").find(".thumb-block")),o(_,!0),i==r&&(f||a)&&d(i)}},error:function(t){h.log_error("ERROR get thumb video",t)}})}var m=/^(.*)\s?http[s]?:\/\/[a-zA-Z0-9_\-]*\.xvideos\.(com|red)\/(profiles|channels|pornstars)\/([^\s#\/]*)[#?\/]?[^\s\/]*\s?(.*)$/g,v=m.exec(e);if(v){var f=Math.abs(n.scrollHeight-n.scrollTop-n.clientHeight)<10,y=$(new Image);return y.attr("src","/profiles-picture/"+v[4]),c.append(y),void y.load(function(){var e=Math.abs(n.scrollHeight-n.scrollTop-n.clientHeight)<10;y.addClass("chat_profile");var s=v[4].substring(0,1).toUpperCase()+v[4].substring(1),o="";""!=v[1].trim()&&(o="<div>"+v[1].trim()+"</div>"),$("#"+t+" .chat_message").html(o+'<div class="chat_message_gallery"><a href="'+v[0]+'" target="_blank"></a></div>'),$("#"+t+" .chat_message .chat_message_gallery a").append(y),$("#"+t+" .chat_message").append('<div class="chat_message_gallery"><a href="'+v[0]+'" target="_blank">'+s+"</a></div>"),""!=v[5].trim()&&$("#"+t+" .chat_message").append("<div>"+v[5].trim()+"</div>"),i==r&&(f||e)&&d(i)}).ert)})}}}),define("skins/chat/chat_send_file",["config/main","lib/i18n!front","lib/helpers/overlay","lib/tools","static/cookies"],function(t,i,n,r,s){var o=function(t,e,r,s,o,a,c,d){this.allowedTypes=["png","jpg","jpeg","gif","mp4","avi","mkv"],this.extensions={images:["png","jpg","jpeg","gif"],videos:["mp4","avi","mkv"]},this.file_max_size_megabytes=150,this.upload_expire_time=604800,this.thumb_max_width=150,this.thumb_max_height=100,this.chat_init_prefs=d,this.browser_compatibility=!0;try{if("undefined"==typeof File||!File)return void(this.browser_compatibility=!1);if("undefined"==typeof window.Worker||!window.Worker||"undefined"==typeof Worker)return void(this.browser_compatibility=!1)}catch(e){return void(this.browser_compatibility=!1)}this.log_and_tooltip=t,this.make_real_message_fct=e,this.get_last_conv_key_fct=r,this.scroll_down_conversation_fct=s,this.scroll_conversation_is_down_fct=o,this.message_for_upload_progress_bar_fct=a,this.friend_is_from_sheer_fct=c,this.files={},this.thumbs={},this.worker_crypt=null,this.worker_decrypt=null,this.preloader=$("#chat-photos-preloader");var h=this;try{"undefined"!=typeof Worker&&(h.worker_crypt=new Worker("/js/workers/chat-prive-crypt-worker.js"),h.worker_crypt.addEventListener("message",function(t){"undefined"!=typeof t.data.type&&"crypt"===t.data.type&&("undefined"!=typeof t.data.error&&!0===t.data.error?(h.log_and_tooltip.log_error("File crypt failed."),"undefined"!=typeof t.data.id_file&&h.progress_bar_delete(t.data.id_file),overlayCrypt=n.get($("#chat-window").find(".overlay-container"),!0,"hide"),overlayCrypt.setContent(i.__("misc.error_please_retry")).show()):"undefined"!=typeof t.data.contentCrypted&&h.file_crypted(t.data)),"undefined"!=typeof t.data.type&&"progress"===t.data.type&&"undefined"!=typeof t.data.pourcent&&"undefined"!=typeof t.data.id_file&&"undefined"!=typeof t.data.id_recipient&&h.progress_bar_pourcent(t.data.id_file,t.data.pourcent)}),h.worker_decrypt=new Worker("/js/workers/chat-prive-decrypt-worker.js"),h.worker_decrypt.addEventListener("message",function(t){"undefined"!=typeof t.data.type&&"decrypt"===t.data.type&&("undefined"!=typeof t.data.error&&!0===t.data.error?(h.log_and_tooltip.log_error("File decrypt failed.",t.data),"undefined"!=typeof t.data.id_div_message?"undefined"!=typeof t.data.thumb&&t.data.thumb?"undefined"==typeof t.data.key||"undefined"==typeof t.data.recipient_id||"undefined"==typeof t.data.id_div_message||"undefined"==typeof t.data.message_obj?$("#"+t.data.id_div_message+" .chat_message").html(i.__("misc.error_please_retry")):h.make_link_decrypt_file(t.data.message_obj,t.data.recipient_id,t.data.id_div_message,t.data.key,t.data.timestamp):$("#"+t.data.id_div_message+" .chat_message").html(i.__("misc.error_please_retry")):(overlayDecrypt=n.get($("#chat-window").find(".overlay-container"),!0,"hide"),overlayDecrypt.setContent(i.__("misc.error_please_retry")).show())):t.data.thumb?h.file_thumb_decrypted(t.data):h.file_decrypted(t.data)),"undefined"!=typeof t.data.type&&"progress"===t.data.type&&"undefined"!=typeof t.data.pourcent&&"undefined"!=typeof t.data.id_div_message&&h.progress_bar_pourcent(t.data.id_div_message,t.data.pourcent)}))}catch(e){return void(this.browser_compatibility=!1)}};return o.prototype={is_compatible:function(){return this.browser_compatibility},init_input_file:function(){this.allowedTypes.length>0&&$("#chat-file").attr("accept","."+this.allowedTypes.join(",."))},init_socket:function(t){var e=this;t.on("get_token_send_fit)}),this.socket=t,t.init_send_file=!0},progress_bar_get+t},progress_bar_create_html:function(t,e,i,n){n||(n=e.css("background-color"));var r='style="background-color: '+n+';"',s='<div class="chat_progress_bar" id="'+this.progress_bar_get_id(t)+'"><div class="progress" '+r+">";return s+='<div class="progress_bar">',s+="</div>",s+='<div class="progress_bar_text">'+i,s+="</div>",s+="</div></div>"},progress_bar_create:function(t,e,i,n){$("#"+this.progress_bar_get_id(t)).length>0||e.append(this.progress_bar_create_html(t,e,i,n))},progress_bar_create_message:function(t,e,i,n,r){if(!($("#"+this.progress_bar_get_id(t)).length>0)){var s=this.progress_bar_create_html(t,e,i,n);this.message_for_upload_progress_bar_fct(t,s,r)}},progress_bar_pourcent:function(t,e,i){0!==$("#"+this.progress_bar_get_id(t)).length&&($("#"+this.progress_bar_get_id(t)+" .progress_bar").width(e+"%"),void 0!==i&&$("#"+this.progress_bar_get_id(t)+" .progress_bar_text").html(i),$("#"+this.progress_bar_get_id(t)).show())},progress_bar_delete:function(t){$("#"+this.progress_bar_get_id(t)).remove(),$("#chat_message_upload_bar_"+t).length>0&&$("#chat_message_upload_bar_"+t).closest("li").remove()},send_file:function(t,e,n,r){var s=this;if(r.size>1024*this.file_max_size_megabytes*1024)return void setTimeout(function(){var t="<p>"+i.__("upload.cant_start_check_file_size_and_internet_connection",{"%max_size%":s.file_max_size_megabytes+i.__("units.file_size_megabytes")})+"</p>",e={};e.position={v:"above",h:"right"},e.trigger=!1,s.log_and_tooltip.popup_open($("#chat-send-file"),t,e)},200);var o=this.sanitize_filename(r.name);if(imgType=o.split("."),imgType=imgType[imgType.length-1].toLowerCase(),-1==this.allowedTypes.indexOf(imgType))return void setTimeout(function(){var t="<p>"+i.__("chat.send_file_bad_type",{"%types%":s.allowedTypes.join(", ")})+"</p>",e={};e.position={v:"above",h:"right"},e.trigger=!1,s.log_and_tooltip.popup_open($("#chat-send-file"),t,e)},200);var a=o.replace(/\./g,"_").replace(/[\s()]/g,"_")+"_"+(new Date).getTime()+"_"+n;this.files[a]={},this.files[a].file=r,this.files[a].size=r.size,t.init_send_file||this.init_socket(t),t.emit("get_token_send_file",{id_file:a,filename:o,id_recipient:n})},sanitize_filen")},get_token_send_file:function(t){if("undefined"==typeof t.token||"undefined"==typeof t.id_file||"undefined"==typeof this.files[t.id_file]||"undefined"==typeof t.id_recipient){var e="<p>"+i.__("misc.error_please_retry",{"%types%":s.allowedTypes.join(", ")})+"</p>",n={};return n.position={v:"above",h:"right"},n.trigger=!1,s.log_and_tooltip.popup_open($("#chat-send-file"),e,n),void s.log_and_tooltip.log_error("get_token_send_file","don't find file")}this.files[t.id_file].token=t.token;var r=new FileReader,s=this;r.addEventListener("load",function(){var e=this.result.substring(0,10);if("data:image"!=e&&"data:video"!=e){var n="<p>"+i.__("chat.send_file_bad_type",{"%types%":s.allowedTypes.join(", ")})+"</p>",r={};return r.position={v:"above",h:"right"},r.trigger=!1,s.log_and_tooltip.popup_open($("#chat-send-file"),n,r),void s.log_and_tooltip.log_error("get_token_send_file","load failed")}var o=null,a=this.result;if("data:image"==e){var c=$(new Image);c.attr("src",a),s.preloader.append(c),c.load(function(){var e=document.createElement("canvas"),i=e.getContext("2d"),n=document.createElement("canvas"),r=n.getContext("2d");e.width=this.width,e.height=this.height,n.width=this.width,n.height=this.height,(this.width>s.thumb_max_width||this.height>s.thumb_max_height)&&(this.width/s.thumb_max_width>this.height/s.thumb_max_height?(n.width=s.thumb_max_width,n.height=Math.round(n.width*this.height/this.width)):(n.height=s.thumb_max_height,n.width=Math.round(n.height*this.width/this.height))),r.drawImage(this,0,0,n.width,n.height),o=n.toDataURL("image/png"),"data:image/gif"!=a.substring(0,14)&&(i.drawImage(this,0,0,e.width,e.height),a=e.toDataURL("image/png")),s.file_launch(t,a,o),$(this).remove()}).error(function(){s.file_launch(t,a,o),$(this).remove()})}else if("data:video"==e){var d=$(document.createElement("VIDEO"));d.attr("preload","metadata"),d.attr("src",a),s.preloader.append(d),d.on("canplay",function(){var e=document.createElement("canvas"),i=e.getContext("2d");e.width=this.videoWidth,e.height=this.videoHeight,(this.videoWidth>s.thumb_max_width||this.videoHeight>s.thumb_max_height)&&(this.videoWidth/s.thumb_max_width>this.videoHeight/s.thumb_max_height?(e.width=s.thumb_max_width,e.height=Math.round(e.width*this.videoHeight/this.videoWidth)):(e.height=s.thumb_max_height,e.width=Math.round(e.height*this.videoWidth/this.videoHeight))),this.videoWidth<this.videoHeight?(i.rotate(90*Math.PI/180),i.translate(0,-e.width),i.drawImage(this,0,0,e.height,e.width)):i.drawImage(this,0,0,e.width,e.height),o=e.toDataURL("image/png"),s.file_launch(t,a,o),$(this).remove()}),d.error(function(e){s.file_launch(t,a,o),$(this).remove()})}}),r.readAsDataURL(this.files[t.id_file].file)},file_launch:function(t,e,i){this.friend_is_from_sheer_fct(t.id_recipient)?this.file_launch_unencrypted(t,e,i):this.file_launch_crypt(t,e,i)},file_launch_unencrypted:function(t,e,i){var n={id_file:t.id_file};n.contentCrypted=this.files[t.id_file].file,n.contentCryptedThumb=i?this.data_url_to_blob(i):i,this.file_crypted(n)},file_launch_crypt:function(t,e,n){var r=this.get_last_conv_key_fct(t.id_recipient);if(""==r){var s="<p>"+i.__("error.internal_err_please_reload")+"</p>",o={};return o.position={v:"above",h:"right"},o.trigger=!1,this.log_and_tooltip.popup_open($("#chat-send-file"),s,o),void this.log_and_tooltip.log_error("file_launch_crypt","no conv key found")}var a=this.scroll_conversation_is_down_fct(t.id_recipient);this.progress_bar_create_message(t.id_file,$("#chat_messages_tab_"+t.id_recipient),i.__("chat.file_encryting"),$(".chat-messenger").css("background-color"),t.id_recipient),a&&this.scroll_down_conversation_fct(t.id_recipient),this.worker_crypt.postMessage({content:e,thumb:n,key:r,id_file:t.id_file,id_recipient:t.id_recipient})},file_crypted:function(r){if(!r.id_file||!r.contentCrypted){var o="<p>"+i.__("misc.error_please_retry",{"%types%":c.allowedTypes.join(", ")})+"</p>",a={};return a.position={v:"above",h:"right"},a.trigger=!1,c.log_and_tooltip.popup_open($("#chat-send-file"),o,a),void c.log_and_tooltip.log_error("file_crypted","crypt failed")}r.contentCryptedThumb||(r.contentCryptedThumb="");var c=this,d=new XMLHttpRequest;d.open("POST",window.location.protocol+"//"+t.dyn.chat.server_upload+"/chat_ajax/upload_file"),d.addEventListener("load",function(){try{var t=JSON.parse(d.response)}catch(e){c.progress_bar_delete(r.id_file);var s="<p>"+i.__("misc.error_please_retry")+"</p>",o={};return o.position={v:"above",h:"right"},o.trigger=!1,c.log_and_tooltip.popup_open($("#chat-send-file"),s,o),void c.log_and_tooltip.log_error("ajax upload",e.message)}if(!(t&&t.result&&t.file_id&&t.filename&&t.recipient&&t.extension&&"boolean"==typeof t.thumb&&t.original_filename))return c.progress_bar_delete(r.id_file),overlayCrypted=n.get($("#chat-window").find(".overlay-container"),!0,"hide"),void overlayCrypted.setContent(i.__("misc.error_please_retry")).show();var a=0;"object"==typeof c.files[t.file_id]&&"number"==typeof c.files[t.file_id].size&&(a=c.files[t.file_id].size);var h={type:"upload",filename:t.filename,extension:t.extension,thumb:t.thumb,size:a,original_filename:t.original_filename};c.progress_bar_delete(r.id_file);var _=c.make_real_message_fct(JSON.stringify(h),t.recipient);c.socket.emit("send_message",{message:_,recipient_id:t.recipient}),delete c.files[t.file_id]}),d.upload.addEventListener("progress",function(t){var e=Math.round(100*t.loaded/t.total);c.progress_bar_pourcent(r.id_file,e,i.__("chat.file_uploading"))}),d.addEventListener("error",function(t){c.log_and_tooltip.log_error("upload XHR ERROR",t),c.progress_bar_delete(r.id_file);var e="<p>"+i.__("misc.error_please_retry")+"</p>",n={};n.position={v:"above",h:"right"},n.trigger=!1,c.log_and_tooltip.popup_open($("#chat-send-file"),e,n)});var h=new FormData;h.append("check_cookie",s.get(t.dyn.chat.cookie_name)),h.append("token",this.files[r.id_file].token),h.append("file_id",r.id_file),h.append("file",r.contentCrypted),h.append("file_thumb",r.contentCryptedThumb),d.send(h)},check_for_upload:function(t,e,n,r,s,o,a,c){var d;try{d=JSON.parse(e)}catch(e){return}if("string"==typeof d.type&&"upload"==d.type){if("string"!=typeof d.filename||"string"!=typeof d.extension||"boolean"!=typeof d.thumb||"number"!=typeof d.size||"string"!=typeof d.original_filename)return void this.log_and_tooltip.log_error("message type upload with bad data",d);if((new Date).getTime()>1e3*(c+this.upload_expire_time)){t.find(".chat_message_report").html('{"type":"upload","verif":"file uploaded in chat", "file_broken": true}');var e='<div class="chat_upload_image_div"><div class="icon-f icf-file-broken"></div>'+i.__("chat.file_expired")+"</div>";return t.find(".chat_message").html(e),void t.find(".chat_message").css("text-align","center")}if(!this.is_compatible())return void t.find(".chat_message").html(i.__("chat.file_friend_sent")+" "+i.__("misc.device_not_compatible"));d.thumb?(t.find(".chat_message_report").html('{"type":"upload","verif":"file uploaded in chat"}'),t.find(".chat_message").html(this.progress_bar_create_html(s,$("#"+s+" .chat_message"),i.__("chat.file_loading"))),this.load_thumb(d,r,s,o,c)):this.make_link_decrypt_file(d,r,s,o,c,t)}},load_thumb:function(t,e,n,r,s){var o=this,a=this.scroll_conversation_is_down_fct(e);o.progress_bar_create(n,$("#"+n+" .chat_message"),i.__("chat.file_loading")),a&&this.scroll_down_conversation_fct(e);var c=this.get_file_urls(t.filename,t.extension);if(o.friend_is_from_sheer_fct(e))return o.progress_bar_delete(n),void o.display_unencrypted_thumb({thumb_url:c.thumb_url,content:null,for_download:!1,id_div_message:n,message_obj:t,recipient_id:e,thumb:!0,timestamp:s});$.ajax({type:"GET",url:c.thumb_url,xhr:function(){var t=new window.XMLHttpRequest;return t.addEventListener("progress",function(t){if(t.lengthComputable){var e=t.loaded/t.total;o.progress_bar_pourcent(n,100*e)}},!1),t},success:function(a){if(!a)return void $("#"+n+" .chat_message").html(i.__("chat.file_unable_get")+"(error: 1)");o.progress_bar_pourcent(n,0,i.__("chat.file_decrypting")),o.worker_decrypt.postMessage({cryptedContent:a,key:r,recipient_id:e,id_div_message:n,thumb:!0,message_obj:t,timestamp:s})},error:function(a){o.log_and_tooltip.log_error("load_thumb error",a.message),$("#"+n+" .chat_message").html(i.__("chat.file_unable_get")+"(error: 2)"),o.make_link_decrypt_file(t,e,n,r,s)}})},display_unencrypted_thumb:function(t){var e=this.scroll_conversation_is_down_fct(t.recipient_id),n=this,r=$(new Image);r.attr("src",t.thumb_url),this.preloader.append(r),r.load(function(){var r=$(document.createElement("div"));if(r.css("text-align","center"),r.addClass("chat_upload_image_div"),$(this).appendTo(r),$("#"+t.id_div_message+" .chat_message").html(r),n.add_link_decrypt_file_on_thumb(t.message_obj,t.recipient_id,t.id_div_message,t.key,t.timestamp,$("#"+t.id_div_message+" .chat_message .chat_upload_image_div")),n.add_link_download_file_on_thumb(t.message_obj,t.recipient_id,t.id_div_message,t.key,t.timestamp,$("#"+t.id_div_message+" .chat_message .chat_upload_image_div")),$("#"+t.id_div_message+" .chat_message_report").html('{"type":"upload","verif":"file uploaded in chat", "thumb_data":"'+t.content+'"}'),n.chat_init_prefs.blur_image)n.add_blur(t.id_div_message);else{var s='<div class="chat_upload_blur_button"><span class="icon-f icf-eye-blocked" title="'+i.__("chat.blur_image_confirm")+'"></span></div>';$("#"+t.id_div_message+" .chat_message .chat_upload_image_div").append(s),$("#"+t.id_div_message+" .chat_message .chat_upload_image_div .chat_upload_blur_button").on("click",function(){var t="<p>"+i.__("chat.blur_image_confirm")+"</p>";t+='<p id="chat_popup_buttons"><button id="chat_popup_blur_next_yes">'+i.__("misc.OK")+'</button><button id="chat_popup_blur_next_cancel">'+i.__("misc.cancel")+"</button></p>";var e={};e.position={v:"above",h:"right"},e.trigger=!1,n.log_and_tooltip.popup_open($(this),t,e),$("#chat_popup_blur_next_yes").on("click",function(){n.log_and_tooltip.popup_close(),n.chat_init_prefs.switch_blur_image(!0)}),$("#chat_popup_blur_next_cancel").on("click",function(){n.log_and_tooltip.popup_close()})})}e&&n.scroll_down_conversation_fct(t.recipient_id)}).error(function(){n.make_link_decrypt_file(t.message_obj,t.recipient_id,t.id_div_message,t.key,t.timestamp)})},file_thumb_decrypted:function(t){
if(!(t.content&&t.id_div_message&&t.recipient_id&&t.message_obj))return void $("#"+t.id_div_message+" .chat_message").html(i.__("chat.file_unable_get")+"(error: 3)");var e=this.scroll_conversation_is_down_fct(t.recipient_id);if("data:image"==t.content.substring(0,10)){var n=this,r=$(new Image);r.attr("src",t.content),n.preloader.append(r),r.load(function(){var r=$(document.createElement("div"));if(r.css("text-align","center"),r.addClass("chat_upload_image_div"),$(this).appendTo(r),$("#"+t.id_div_message+" .chat_message").html(r),n.add_link_decrypt_file_on_thumb(t.message_obj,t.recipient_id,t.id_div_message,t.key,t.timestamp,$("#"+t.id_div_message+" .chat_message .chat_upload_image_div")),n.add_link_download_file_on_thumb(t.message_obj,t.recipient_id,t.id_div_message,t.key,t.timestamp,$("#"+t.id_div_message+" .chat_message .chat_upload_image_div")),$("#"+t.id_div_message+" .chat_message_report").html('{"type":"upload","verif":"file uploaded in chat", "thumb_data":"'+t.content+'"}'),n.chat_init_prefs.blur_image)n.add_blur(t.id_div_message);else{var s='<div class="chat_upload_blur_button"><span class="icon-f icf-eye-blocked" title="'+i.__("chat.blur_image_confirm")+'"></span></div>';$("#"+t.id_div_message+" .chat_message .chat_upload_image_div").append(s),$("#"+t.id_div_message+" .chat_message .chat_upload_image_div .chat_upload_blur_button").on("click",function(){var t="<p>"+i.__("chat.blur_image_confirm")+"</p>";t+='<p id="chat_popup_buttons"><button id="chat_popup_blur_next_yes">'+i.__("misc.OK")+'</button><button id="chat_popup_blur_next_cancel">'+i.__("misc.cancel")+"</button></p>";var e={};e.position={v:"above",h:"right"},e.trigger=!1,n.log_and_tooltip.popup_open($(this),t,e),$("#chat_popup_blur_next_yes").on("cli0)}),$("#chat_popup_blur_next_cancel").on("click",function(){n.log_and_tooltip.popup_close()})})}e&&n.scroll_down_conversation_fct(t.recipient_id)}).erp)})}else this.make_link_decrypt_file(t.message_obj,t.recipient_id,t.id_div_message,t.key,t.timestamp);e&&this.scroll_down_conversation_fct(t.recipient_id)},get_file:function(t,e,n,r,s,o){var a=this,c=this.scroll_conversation_is_down_fct(e);a.progress_bar_create(n,$("#"+n+" .chat_message"),i.__("chat.file_loading")),"boolean"!=typeof o&&(o=!1),c&&this.scroll_down_conversation_fct(e);var d=this.get_file_urls(t.filename,t.extension);if(this.friend_is_from_sheer_fct(e))return this.progress_bar_delete(n),void this.file_decrypted({file_url:d.file_url,content:null,for_download:o,id_div_message:n,message_obj:t,recipient_id:e,thumb:!0,timestamp:s});$.ajax({type:"GET",url:d.file_url,xhr:function(){var t=new window.XMLHttpRequest;return t.addEventListener("progress",function(t){if(t.lengthComputable){var e=t.loaded/t.total;a.progress_bar_pourcent(n,100*e)}},!1),t},success:function(c){if(!c)return void $("#"+n+" .chat_message").html(i.__("chat.file_unable_get")+"(error: 4)");a.progress_bar_pourcent(n,0,i.__("chat.file_decrypting")),a.worker_decrypt.postMessage({cryptedContent:c,key:r,recipient_id:e,id_div_message:n,message_obj:t,thumb:!1,timestamp:s,for_download:o})},error:function(t){$("#"+n+" .chat_message").html(i.__("chat.file_unable_get")+"(error: 5)")}})},file_decrypted:function(t){if(!t.content&&!t.file_url||!t.id_div_message||!t.recipient_id||!t.message_obj)return void $("#"+id_div_message+" .chat_message").html(i.__("chat.file_unable_get")+"(error: 6)");var e=!1,r=this.scroll_conversation_is_down_fct(t.recipient_id),s=null,o=null,a="",c=t.message_obj.extension.substring(1);if(t.file_url&&this.extensions.images.indexOf(c)>-1?(s=$(new Image).attr("src",t.file_url),a=t.file_url):t.file_url&&this.extensions.videos.indexOf(c)>-1?(o=$(document.createElement("VIDEO")).attr("src",t.file_url),a=t.file_url):t.content&&"data:image"===t.content.substring(0,10)?(s=$(new Image).attr("src",t.content),a=t.content):t.content&&"data:video"===t.content.substring(0,10)?(o=$(document.createElement("VIDEO")).attr("src",t.content),a=t.content):this.make_link_download(t.id_div_message,t.message_obj,t.content,!0),a&&t.for_download&&(this.start_url_download(a,t.message_obj.filename),e=$("#"+t.id_div_message+" .chat_message .chat_upload_blured").length>0),s){var d=this;this.preloader.append(s),s.load(function(){s.css("max-width","100%"),s.css("max-height","100px");var o=$(document.createElement("div"));if(o.addClass("chat_upload_image_div"),s.appendTo(o),$("#"+t.id_div_message+" .chat_message").html(o),e&&d.add_blur(t.id_div_message),r&&d.scroll_down_conversation_fct(t.recipient_id),!t.for_download){var c=$(document.createElement("div")),h=s.clone();h.css("max-height","100%"),h.appendTo(c),overlayImg=n.get($("#chat-window").find(".overlay-container"),!0,"hide"),overlayImg.addClass("chat-overlay-photos-upload"),overlayImg.setContent(c).show()}message_load='<div class="chat_upload_load_button"><span class="icon-f icf-search-plus"></span></div>',$("#"+t.id_div_message+" .chat_message .chat_upload_image_div").append(message_load),$("#"+t.id_div_message+" .chat_message").find("div.chat_upload_load_button span").on("click",function(t){var e=$(this).closest(".chat_message").find("img");if(overlayImg=n.get($("#chat-window").find(".overlay-container"),!0,"hide"),e.length>0){overlayImg.addClass("chat-overlay-photos-upload");var r=$(document.createElement("div")),s=e.clone();s.css("max-height","100%"),s.appendTo(r),overlayImg.setContent(r).show()}else overlayImg.setContent(i.__("misc.error_please_retry")).show()}),d.make_link_download_thumb(t.id_div_message,t.message_obj,a,$("#"+t.id_div_message+" .chat_message div.chat_upload_load_button"))}).er0)})}else if(o){var d=this;d.preloader.append(o),o.error(function(e){d.make_link_download(t.id_div_message,t.message_obj,a,!0)}),o.on("canplay",function(){o.css("width","100%"),o.attr("controls","controls");var i=$(document.createElement("div"));i.addClass("chat_upload_image_div"),o.appendTo(i),$("#"+t.id_div_message+" .chat_message").html(i),e&&d.add_blur(t.id_div_message),d.make_link_download_thumb(t.id_div_message,t.message_obj,a,$("#"+t.id_div_message+" .chat_message .chat_upload_image_div")),r&&d.scroll_down_conversation_fct(t.recipient_id)})}r&&this.scroll_down_conversation_fct(t.recipient_id)},add_blur:function(t){$("#"+t+" .chat_message .chat_upload_image_div").addClass("chat_upload_blured"),$("#"+t+" .chat_message .chat_upload_image_div").append('<div class="chat_upload_blured_button"><span class="icon-f icf-eye"></span></div>'),$("#"+t+" .chat_message .chat_upload_image_div .chat_upload_blured_button .icon-f").on("click",function(){$("#"+t+" .chat_message .chat_upload_image_div .chat_upload_blured_button").remove(),$("#"+t+" .chat_message .chat_upload_image_div").removeClass("chat_upload_blured")})},add_decrypt_link_to_container:function(t,e,n,s,o,a,c){if(c=c||"icf-search-plus",a.append('<div class="chat_upload_load_button"><span class="icon-f '+c+'"></span></div>'),(new Date).getTime()<1e3*(o+this.upload_expire_time)){var d=r.formatDuration(o+this.upload_expire_time-(new Date).getTime()/1e3);$("#"+n+" .chat_message").append('<div class="chat_upload_expire_in">'+i.__("chat.file_expire_in",{"%duration%":d})+"</div>")}var h=this;a.find("span").on("click",function(r){var a=$(this).parent();$(this).remove(),h.progress_bar_create(n,a,i.__("chat.file_loading"),a.closest(".chat_message").css("background-color")),h.get_file(t,e,n,s,o,!1)})},add_download_link_to_container:function(t,e,n,r,s,o){var a=this;o.append('<div class="chat-upload-download"><span class="icon-f icf-download" title="'+i.__("misc.download")+'"></span></div>'),o.find("span.icf-download").on("click",function(o){var c=$(this).parent();$(this).remove(),a.progress_bar_create(n,c,i.__("chat.file_loading"),c.closest(".chat_message").css("background-color")),a.get_file(t,e,n,r,s,!0)})},add_link_decrypt_file_on_thumb:function(t,e,i,n,r,s){s||(s=$("#"+i+" .chat_message"));var o=t.extension.substr(1);this.extensions.images.indexOf(o)>-1?this.add_decrypt_link_to_container(t,e,i,n,r,s):this.extensions.videos.indexOf(o)>-1?this.add_decrypt_link_to_container(t,e,i,n,r,s,"icf-play-rectangle"):this.log_and_tooltip.log_error("add_link_decrypt_file_on_thumb","not an image and not a video ...")},add_link_download_file_on_thumb:function(t,e,i,n,r,s){s||(s=$("#"+i+" .chat_message"));var o=t.extension.substr(1);this.extensions.images.indexOf(o)>-1?this.add_download_link_to_container(t,e,i,n,r,s):this.extensions.videos.indexOf(o)>-1?this.add_download_link_to_container(t,e,i,n,r,s):this.log_and_tooltip.log_error("add_link_decrypt_file_on_thumb","not an image and not a video ...")},data_url_to_b})},get_file_urls:function(e,i){var n="https://"+t.dyn.chat.server_media+"/"+e.substring(0,1)+"/"+e.substring(1,2)+"/"+e.substring(2,3);return{file_url:n+"/"+e+i,thumb_url:n+"/"+e+"_thumb.png"}},make_link_decrypt_file:function(t,e,n,s,o,a){var c;void 0!==a?(c=a.find(".chat_message"),a.find(".chat_message_report").html('{"type":"upload","verif":"file uploaded in chat"}')):(c=$("#"+n+" .chat_message"),$("#"+n+" .chat_message_report").html('{"type":"upload","verif":"file uploaded in chat"}'));var d=this,h='<div class="chat_upload_image_div"><a>'+i.__("chat.file_load")+"</a>";if((new Date).getTime()<1e3*(o+this.upload_expire_time)){var _=r.formatDuration(o+this.upload_expire_time-(new Date).getTime()/1e3);h+="<div>"+i.__("chat.file_expire_in",{"%duration%":_})+"</div></div>"}c.html(h),c.find("a").on("click",function(i){$("#"+n+" .chat_message").html(""),d.get_file(t,e,n,s,o,!1)})},make_link_download_thumb:function(t,e,n,s){s.append('<div class="chat-upload-download"><div>'+r.formatFileSize(e.size)+'</div><span class="icon-f icf-download" title="'+i.__("misc.download")+'"></span></div>'),s.find(".chat-upload-download span").on("click",null,{self:this,url:n,message_obj:e},this.on_click_start_url_download)},make_link_download:function(t,e,n,s){var o="<span><a>"+i.__("chat.file_download",{"%size%":r.formatFileSize(e.size)})+"</a></span>";s&&(o="<span>"+i.__("chat.file_unable_display",{"%start_link%":"<a>","%end_link%":"</a>","%size%":r.formatFileSize(e.size)})+"</span>"),o="<div class='chat_upload_image_div'>"+o+'<span style="display:none;" class="chat-icon-home icon-f icf-spinner icf-anim-pulse"></span></div>',$("#"+t+" .chat_message").html(o),$("#"+t+" .chat_message_report").html('{"type":"upload","verif":"file uploaded in chat"}'),$("#"+t+" .chat_message a").on("click",null,{self:this,url:n,message_obj:e},this.on_click_start_url_download)},on_click_start_url_download:function(t){t.preventDefault(),$(this).parent().parent().find("span").toggle();var e=$(this);setTime()},3e3),t.data.self.start_url_download(t.data.url,t.data.message_obj.filename)},start_url_download:function(t,e){if("data:"===t.substring(0,5)){var i=this.data_url_to_blob(t);if(window.navigator&&window.navigator.msSaveBlob)return void window.navigator.msSaveBlob(i,e);t=URL.createObjectURL(i)}var n=document.createElement("a");n.setAttribute("href",t),n.setAttribute("download",e),n.setAttribute("target","_blank"),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}},o}),define("text!skins/chat/friend.mustache",[],function(){return'<a id="select_friend_li_{{#search}}search_{{/search}}{{ id_user }}" class="user{{ id_user }} list-group-item {{#selected}}friend_selected{{/selected}} {{^is_online}}chat_friend_offline{{/is_online}}" href="#">\n\t<div class="chat_picture_status" style="background-image:url(\'{{{ profile_picture }}}\');">\n\t\t<div class="chat_status_nb_unread">{{#nb_unread}}<span class="badge">{{nb_unread}}</span>{{/nb_unread}}&nbsp;</div>\n\t\t<div class="chat_picture_filter"><span title="{{{ status_trad }}}">{{{ status_trad }}}</span></div>\n\t</div>\n\t<div class="chat_profile_name" title="{{ profile_name }}">{{#is_favorite}}<div class="chat_profile_name_favorite icon-f icf-star-full">&nbsp;</div> {{/is_favorite}}{{ profile_name }}</div>\n\t<div class="chat_list_user_is_typing {{#is_favorite}}chat_list_user_is_typing_fav{{/is_favorite}}">is typing ...</div>\n</a>\n'}),define("text!skins/chat/header_messages.mustache",[],function(){return'<div class="chat-header-container">\r\n\t<div class="chat_picture_status" style="background-image:url(\'{{{ profile_picture }}}\');">\r\n\t</div>\r\n\t<div class="chat_profile_name" title="{{{ trad.profile_page }}}">{{#is_favorite}}<div class="icon-f icf-star-full">&nbsp;</div> {{/is_favorite}}\r\n\t<a class="chat_profile_link" target="_blank" href="">{{ profile_name }}</a>\r\n\t{{#is_sheer_creator}}<a class="btn btn-primary chat_sheer_tip_btn" href="/sheer/redirect/tip/{{id_user}}" target="_blank"><span class="icon-f icf-money"></span> {{trad.tip}}</a>{{/is_sheer_creator}}</div>\r\n\t{{^not_friend}}\r\n\r\n\t<div id="chat_friend_menu_switch" class="chat-header-icon">...</div>\r\n\r\n\t<div id="chat_friend_menu">\r\n\t\t<div class="chat-header-change-fav chat-header-menu-icon" title="{{#is_favorite}}{{{ trad.remove_favorite }}}{{/is_favorite}}{{^is_favorite}}{{{ trad.add_favorite }}}{{/is_favorite}}">\r\n\t\t\t<div class="icon-f icf-2x {{#is_favorite}}icf-star-full{{/is_favorite}}{{^is_favorite}}icf-star-o{{/is_favorite}}"></div>\r\n\t\t\t<div class="chat-header-menu-text">{{{ trad.menu.favorite }}}</div>\r\n\t\t</div>\r\n\t\t<div class="chat-header-block chat-header-menu-icon" title="{{{ trad.block_user }}}">\r\n\t\t\t<div class="icon-f icf-ban icf-2x"></div>\r\n\t\t\t<div class="chat-header-menu-text">{{{ trad.menu.block_report }}}</div>\r\n\t\t</div>\r\n\t\t<div class="chat-header-copy chat-header-menu-icon" title="{{{ trad.copy_conv_to_clipboard }}}">\r\n\t\t\t<div class="icon-f icf-copy icf-2x"></div>\r\n\t\t\t<div class="chat-header-menu-text">{{{ trad.menu.copy }}}</div>\r\n\t\t</div>\r\n\t\t<div class="chat-header-warning-crypt chat-header-menu-icon">\r\n\t\t\t<div class="icon-f icf-warning icf-2x"></div>\r\n\t\t\t<div class="chat-header-menu-text">{{{ trad.menu.not_encrypted }}}</div>\r\n\t\t</div>\r\n\t\t<div class="chat-header-crypt-old chat-header-menu-icon">\r\n\t\t\t<div class="icon-f icf-unlock icf-2x"></div>\r\n\t\t\t<div class="chat-header-menu-text">{{{ trad.menu.encrypt }}}</div>\r\n\t\t</div>\r\n\t\t<div class="chat-header-crypt-old-done chat-header-menu-icon">\r\n\t\t\t<div class="chat-icon-home icon-f icf-lock icf-2x" title="{{{ trad.crypt_old_messages_done }}}"></div>\r\n\t\t\t<div class="chat-header-menu-text">{{{ trad.menu.encrypted }}}</div>\r\n\t\t</div>\r\n\t\t<div class="chat-header-delete-all chat-header-menu-icon">\r\n\t\t\t<div class="chat-icon-home icon-f icf-close icf-2x" title="{{{ trad.delete_all_messages }}}"></div>\r\n\t\t\t<div class="chat-header-menu-text">{{{ trad.menu.delete }}}</div>\r\n\t\t</div>\r\n\t</div>\r\n\r\n\t{{/not_friend}}\r\n</div>\r\n'}),define("skins/chat/chat_friends_manager",["mustache","config/main","static/cookies","static/storage","lib/i18n!front","lib/helpers/inline_loader","libs/jsencrypt.min","text!skins/chat/friend.mustache","text!skins/chat/header_messages.mustache"],function(t,e,i,n,r,s,o,a,c){var d=function(t,e,i,n,r,s,o,a,c,d,h){this.friends={},this.friends_ids=[],this.selected_friend=0,this.nb_friends_get_with_more_link=40,this.log_and_tooltip=t,this.chatInitsAndPrefs=e,this.chat_friend_action=i,this.priv_key=n,this.node=r,this.input=h,this.send_button=this.node.find("#chat-send-btn"),this.search_button=this.node.find("#chat-users-search-input button#chat-search-button"),this.search_input=this.node.find("#chat-users-search-input input"),this.userlistfavorite=this.node.find("#chat-users-favorite"),this.userlistothers=this.node.find("#chat-users-others"),this.userlistofflinefavorite=this.node.find("#chat-users-offline-favorite"),this.userlistofflineothers=this.node.find("#chat-users-offline-others"),this.userlistmore=this.node.find("#chat-users-more"),this.userlistnotread=this.node.find("#chat-users-not-read"),this.userlistnotfriend=this.node.find("#chat-users-not-friend"),this.userlistsearch=this.node.find("#chat-users-search"),this.userlistsearchclose=this.node.find("#chat-users-search-close"),this.msglist=this.node.find(".chat-messages"),this.chat_header_messages=this.node.find(".chat-header-messages"),this.url_base_profile=s,this.get_conversation_fct=o,this.make_real_message_fct=a,this.scroll_down_conversation_fct=c,this.set_read_date_fct=d};return d.prototype={set_friends:function(t){this.friends=t},set_selected_friend:function(t){this.selected_friend=t},set_user_id:function(t){this.user_id=t},set_keys_create_timestamp:function(t){this.keys_create_timestamp=t},set_socket_connection:function(t){this.socket_connection=t},get_friend_int]},get_selected_friend_ind)},set_friends_id:function(t){this.friends_ids=t},set_friend_last_message_infos:function(t,e,i,n){this.friends.hasOwnProperty(t)&&(this.friends[t].last_timestamp=e,this.friends[t].last_id_message=i,this.friends[t].last_id_sender=n)},set_friend_attribut:function(t,e,i){if(this.friends.hasOwnProperty(t)){if(-1==["first_timestamp","new_conv_key_asked","last_read","nb_unread","interaction","is_favorite","last_timestamp","load_history"].indexOf(e))return void this.log_and_tooltip.log_error("set_friend_attribut : bad name attribut","name : '"+e+"'");this.friends[t][e]=i}},friend_add_unread:function(t,e){this.friends.hasOwnProperty(t)&&("number"!=typeof e&&(e=1),"undefined"==typeof this.friends[t].nb_unread&&(this.friends[t].nb_unread=0),this.friends[t].nb_unread+=e)},sort_friends:function(t,e){return"Offline"!=t.status&&"Offline"==e.status?-1:"Offline"==t.status&&"Offline"!=e.status?1:1==t.is_favorite&&0==e.is_favorite?-1:0==t.is_favorite&&1==e.is_favorite?1:"undefined"==typeof t.interaction&&"undefined"==typeof e.interaction?0:"undefined"==typeof t.interaction?1:"undefined"==typeof e.interaction?-1:t.interaction>e.interaction?-1:e.interaction>t.interaction?1:0},add_friend:function(t,e){if(void 0===t||"undefined"==typeof t.id_user)return void this.log_and_tooltip.log_error("add_friend","friend_info missing");var i=t.id_user,n=!1;if(this.friends.hasOwnProperty(i)&&"undefined"!=typeof this.friends[i].not_friend&&this.friends[i].not_friend&&($("#select_friend_li_"+i).remove(),$("#chat_messages_tab_"+i).remove(),this.selected_friend==i&&(n=!0),this.chatInitsAndPrefs.serviceWorkerRegistration))try{this.chatInitsAndPrefs.serviceWorkerRegistration.postMessage({action:"add_friend",friend_infos:t})}catch(e){this.log_and_tooltip.log_error("Failed to send last_friend_conv to SW")}if(this.friends[i]=t,0!==$("#select_friend_li_"+i).length&&$("#select_friend_li_"+i).remove(),i===this.user_id)return void this.log_and_tooltip.log_debug("not adding the user as friend");var r="userlist";"Offline"==t.status&&(r+="offline"),1==t.is_favorite?r+="favorite":r+="others","undefined"!=typeof t.nb_unread&&parseInt(t.nb_unread)>0&&(r="userlistnotread"),"undefined"!=typeof t.not_friend&&t.not_friend&&(r="userlistnotfriend");var s=this[r];"number"!=typeof this.friends_premium_on_top&&(this.friends_premium_on_top=0),("Offline"!=t.status||1==t.is_favorite)&&"undefined"!=typeof t.is_premium&&!0===t.is_premium&&this.friends_premium_on_top<3&&(e=!0,this.friends_premium_on_top++),void 0!==e&&!0===e?s.prepend(this.add_friend_html(t,"online")):s.append(this.add_friend_html(t,"online")),n&&this.select_friend(i)},add_friend_html:function(e,i){var n=e;n.selected=this.selected_friend==e.id_user,n.profile_url=this.url_base_profile+e.profile_name,n.picture_default=this.url_picture_default,n.search="search"==i,n.favorite=!1,n.is_online=!1,"Online"==e.status?n.is_online=!0:"Offline"==e.status?n.status_trad=r.__("chat.status.offline"):"Away"==e.status&&(n.status_trad=r.__("chat.status.away"));var s=this,o=$(t.render(a,n));return"search"==i?o.on("click",function(t){t.preventDefault(),$("#select_friend_li_"+e.id_user).remove(),s.add_friend(e,!0),s.select_friend(e.id_user),s.hide_search_list()}):"online"==i&&o.on("clir)}),o},select_friend:function(t){if(this.log_and_tooltip.log_debug("select_friend"),this.hasOwnProperty("not_logged")&&1==this.not_logged)return void this.log_and_tooltip.write_error({message:"You need to log in for using chat."});0!==this.selected_friend&&"undefined"!=typeof this.friends[this.selected_friend]&&this.friends[this.selected_friend].not_friend&&(this.input.prop("disabled",!1),this.send_button.prop("disabled",!1));var e=this,i="chat_messages_tab_"+t;if(t==this.selected_friend&&$("#"+i).length>0&&!$("div.chat-messenger").hasClass("chat-home"))return this.log_and_tooltip.log_debug("friend already selected"),void this.chatInitsAndPrefs.set_timer_away();var n=!1;"undefined"!=typeof this.typing_to_friend&&this.typing_to_friend&&this.typing_to_friend!=t&&this.input.val().length>0&&(this.socket_connection.emit("typing_stop",{id_friend:this.selected_friend}),n=!0),$("div.chat-messenger").removeClass("chat-home");var r="chat_group_messages_tab_"+t;$(".chat_tab_container").hide(),this.selected_friend=t,$("#chat-side-column .friend_selected").removeClass("friend_selected"),$("#select_friend_li_"+t).addClass("friend_selected").parent(".chat-users").addClass("friend_selected"),this.header_messages_html(t);var s=$("#"+i);if("undefined"!=typeof this.friends[t]&&this.friends[t].not_friend)return this.input.prop("disabled",!0),this.input.val(""),this.send_button.prop("disabled",!0),void s.show();if(0===s.length){this.send_button.prop("disabled",!0),this.send_button.addClass("disabled"),"undefined"!=typeof this.friends[t]&&(this.friends[t].load_history=!0);var o=" is typing ...";"undefined"!=typeof this.friends[t]&&"undefined"!=typeof this.friends[t].profile_name&&(o=this.friends[t].profile_name+o);var a="";$("#select_friend_li_"+t).hasClass("chat_friend_typing")&&(a=" chat_is_typing"),this.msglist.append('<div id="'+i+'" class="chat_tab_container'+a+'"><ul id="'+r+'" class="chat_group_tab_container"></ul><div class="chat_typing">'+o+"</div></div>"),0==$("#account-chat-private-container").length&&$("#"+r).scrollLock(),this.get_conversation_fct(t)}else s.show(),this.scroll_down_conversation_fct(t),this.set_read_date_fct(t);if(this.friends[t].hasOwnProperty("sending")&&(this.send_button.prop("disabled",this.friends[t].sending),$("#chat-send-btn-loader").toggle(this.friends[t].sending)),this.message_user_has_to_subscribed(),$("#"+r).on("scroll",function(t){"undefined"!=typeof e.messages_client_height&&e.messages_client_height!=this.clientHeight||(e.messages_from_bottom=this.scrollHeight-this.clientHeight-this.scrollTop,e.messages_client_height=this.clientHeight)}),n&&(this.typing_to_friend=t,this.socket_connection.emit("typing_start",{id_friend:t})),this.friends[t].is_sheer_creator?this.chat_header_messages.find(".chat-header-block, .chat-header-delete-all, .chat-header-warning-crypt, .chat-header-crypt-old, .chat-header-crypt-old-done").hide():this.chat_header_messages.find(".chat-header-block, .chat-header-delete-all, .chat-header-warning-crypt, .chat-header-crypt-old, .chat-header-crypt-old-done").show(),this.chatInitsAndPrefs.serviceWorkerRegistration)try{this.chatInitsAndPrefs.serviceWorkerRegistration.postMessage({action:"last_friend_conv",friend_id:t})}catch(e){this.log_and_tooltip.log_error("Failed to send last_friend_conv to SW")}},header_messages_html:function(e){this.log_and_tooltip.log_debug("header_messages_html"),this.chat_header_messages.empty();var i=this.get_friend_infos(e);if(!i)return void this.log_and_tooltip.log_error("header_messages_html","no data for this friend");var n=this,s=i;s.favorite=!1,1==s.is_favorite&&(s.favorite=this.favorite_img);var o="";o=s.hasOwnProperty("profile_name_lower")?s.profile_name_lower:s.profile_name.toLowerCase(),s.trad={},s.trad.profile_page=r.__("profile.title_link_page"),s.trad.remove_favorite=r.__("chat.remove_from_favorites"),s.trad.add_favorite=r.__("chat.add_to_favorites"),s.trad.block_user=r.__("chat.block_or_report"),s.trad.crypt_old_messages_done=r.__("chat.crypt_old_messages_done"),s.trad.report_last_message=r.__("chat.report_last_message"),s.trad.delete_all_messages=r.__("chat.delete_all_messages"),s.trad.copy_conv_to_clipboard=r.__("chat.copy_conv_to_clipboard"),s.trad.tip=r.__("chat.header.sheer_tip_link_label"),s.trad.menu={},s.trad.menu.favorite=r.__("chat.menu.favorite"),s.trad.menu.block_report=r.__("chat.menu.block_report"),s.trad.menu.copy=r.__("chat.menu.copy"),s.trad.menu.not_encrypted=r.__("chat.menu.not_encrypted"),s.trad.menu.encrypt=r.__("chat.menu.encrypt"),s.trad.menu.encrypted=r.__("chat.menu.encrypted"),s.trad.menu["delete"]=r.__("chat.menu.delete");var a=$(t.render(c,s));this.chat_header_messages.append(a);var d=document.getElementsByClassName("chat_profile_link");1===d.length&&(d[0].href=n.url_base_profile+o),this.chat_header_messages.find(".chat-header-change-fav").on("clit)}),this.chat_header_messages.find(".chat-header-block").on("clis)}),this.chat_header_messages.find(".chat-header-copy").on("clid)}),this.chat_header_messages.find("#chat_friend_menu_switch").on("cli()}),this.chat_header_messages.find(".chat-header-delete-all").on("cli))}),this.header_message_set_warning_crypt(),this.header_message_set_crypt_old()},message_user_has_to_subscribed:function(){var t=this;document.addEventListener("sub-action",function(e){t.hide_has_to_subscribe_message_and_enable_buttons(e.detail.friend_id)},!1),document.addEventListener("unsub-actid)},!1);var e=this.get_selected_friend_infos();e.is_sheer_creator&&!1!==e&&"undefined"!=typeof e.is_subscribed&&!e.is_subscribed?this.display_has_to_subscribe_message_and_disable_buttons(e.id_user):this.hide_has_to_subscribe_message_and_enable_buttons(e.id_user)},display_has_to_subscribe_message_and_disable_buttons:function(t){var e=this.get_friend_infos(t);if(null===document.querySelector("#chat_group_messages_tab_"+t+" .chat_user_has_to_subscribe")){document.querySelector("#chat_group_messages_tab_"+t).insertAdjacentHTML("beforeend","<li class='chat_user_has_to_subscribe'>"+r.__("chat.user_has_to_subscribed",{"%channel_name%":"<span>"+e.profile_name+"</span>"})+"</li>");var i="";i="undefined"!=typeof e.profile_name_lower?e.profile_name_lower:e.profile_name.toLowerCase();var n=this;document.querySelector(".chat_user_has_to_subscribe span").addEventListener("click",function(){window.open(n.url_base_profile+i,"_blank")})}this.input.data("emojioneArea").disable(),this.send_button.addClass("disabled"),this.scroll_down_conversation_fct(t)},hide_has_to_subscribe_message_and_enable_buttons:function(t){var e=document.querySelector("#chat_group_messages_tab_"+t+" .chat_user_has_to_subscribe");null!==e&&e.remove(),this.input.data("emojioneArea").enable(),this.send_button.removeClass("disabled")},header_message_set_warning_crypt:function(){var t=this.get_selected_friend_infos();if(!1!==t&&t.hasOwnProperty("no_conversation_key_reason")&&t.no_conversation_key_reason){$(".chat-header-warning-crypt").prop("title",t.no_conversation_key_reason);var e=this;$(".chat-header-warning-crypt").on("click",function(i){i.stopPropagation(),e.log_and_tooltip.popup_open($(".chat-header-warning-crypt"),"<p class='message'>"+t.no_conversation_key_reason+"</p>",{trigger:!1})}),$(".chat-header-crypt-old").hide()}},can_crypt:function(t){if(!this.priv_key)return!1;var e=this.get_friend_infos(t);for(var i in e.conversation_key)if(null!=e.conversation_key[i])return!0;return!1},set_priv_key:function(t){this.priv_key=t},header_message_set_crypt_rn},old_conversation_to_crypt_set:function(t){if(!this.hasOwnProperty("old_conversation_to_crypt"))return this.old_conversation_to_crypt=[t],void this.old_conversation_to_crypt_launch(t);-1==this.old_conversation_to_crypt.indexOf(t)&&(this.old_conversation_to_crypt.push(t),this.friends[t].crypt_old_conv_pourcent="pending",this.friends[t].crypt_old_conv_todo=!1,this.header_message_set_crypt_old())},old_conversation_to_crypt_rem1)},old_conversation_to_crypt_launch:function(t){this.socket_connection.emit("crypt_old_conv",{id_friend:t}),this.friends[t].crypt_old_conv_pourcent=0,this.friends[t].crypt_old_conv_todo=!1,this.header_message_set_crypt_old()},old_conversation_to_crypt_launch_next:function(){return!!this.hasOwnProperty("old_conversation_to_crypt")&&(0==this.old_conversation_to_crypt.length?void delete this.old_conversation_to_crypt:(id_friend=this.old_conversation_to_crypt.shift(),void(this.get_friend_infos(id_friend)?this.old_conversation_to_crypt_launch(id_friend):this.old_conversation_to_crypt_launch_next())))},search_friend:function(){if(this.chatInitsAndPrefs.set_timer_away(),1!=this.on_search){var t=this.search_input.val();if(this.log_and_tooltip.log_debug("search_friend",t),t.length<2){var e={};return e.position={v:"above",h:"right",trigger:!1},void this.log_and_tooltip.popup_open($("#chat-window #chat-search-button"),"<p>"+r.__("chat.minimum_length",{"%nb_chars%":"2"})+"</p>",e)}this.search_button.attr("disabled",!0),this.on_search=!0,this.socket_connection.emit("search_friends",{search:t})}},found_friends:function(t){if(this.searching_friends=!0,this.log_and_tooltip.log_debug("found_friends",t),this.userlistsearch.empty(),this.userlistfavorite.hide(),this.userlistothers.hide(),this.userlistofflinefavorite.hide(),this.userlistofflineothers.hide(),this.userlistmore.hide(),this.userlistnotread.hide(),this.userlistsearch.show(),this.userlistsearchclose.show(),this.search_button.removeAttr("disabled"),this.on_search=!1,0==t.length)this.userlistsearch.append('<a class="chat_no_friends">'+r.__("chat.infos.no_friends_found")+"</a>");else{this.userlistsearch.append('<a class="chat_no_friends">'+r.__("chat.infos.nb_friends_found",{"%nb_friends%":t.length.toString()})+"</a>");for(var e in t)friend=t[e],this.userlistsearch.append(this.add_friend_html(friend,"search"))}},hide_search_l()},addlink_more_friends:function(){this.log_and_tooltip.log_debug("addlink_more_friends");var t=this;$("#chat_get_more_friends_link").remove(),this.userlistmore.append($('<a href="#" class="list-group-item text-center" id="chat_get_more_friends_link">'+r.__("chat.get_more_friends")+"</a>").on("cli()}))},get_more_friends:function(){this.log_and_tooltip.log_debug("get_more_friends"),this.chatInitsAndPrefs.set_timer_away(),$("#chat_get_more_friends_link").remove(),this.userlistmore.append('<a id="new_tab_select_spin" class="list-group-item text-center">'+s.getImg()+"</a>");var t=[]
;for(var e in this.friends_ids)if("undefined"==typeof this.friends[this.friends_ids[e]]&&t.push(this.friends_ids[e]),t.length>=this.nb_friends_get_with_more_link)break;t.length>0&&this.socket_connection.emit("get_users_infos",{friends_ids:t})},friend_status_changed:function(t){if(this.log_and_tooltip.log_debug("friend_status_changed",t),"undefined"!=typeof this.friends[t.id_user]){this.friends[t.id_user].status=t.status,$(".user"+t.id_user).remove();var e=!1;"Offline"==t.status&&(e=!0),this.add_friend(this.friends[t.id_user],e),"Online"!=t.status&&this.stop_typing({id_friend:t.id_user})}},is_typing:function(t){if(this.log_and_tooltip.log_debug("is_typing",t),"undefined"==typeof t.id_friend||"undefined"==typeof this.friends[t.id_friend])return void this.log_and_tooltip.log_error("is_typing","bad id_friend");$("#select_friend_li_"+t.id_friend).removeClass("chat_friend_typing").addClass("chat_friend_typing");var e=$("#chat_group_messages_tab_"+t.id_friend);if(e.length>0){var i=e[0],n=Math.abs(i.scrollHeight-i.scrollTop-i.clientHeight)<10;$("#chat_messages_tab_"+t.id_friend).removeClass("chat_is_typing").addClass("chat_is_typing"),n&&this.scroll_down_conversation_fct(t.id_friend)}},stop_typing:function(t){if(this.log_and_tooltip.log_debug("stop_typing",t),"undefined"==typeof t.id_friend||"undefined"==typeof this.friends[t.id_friend])return void this.log_and_tooltip.log_error("stop_typing","bad id_friend");$("#select_friend_li_"+t.id_friend).removeClass("chat_friend_typing"),$("#chat_messages_tab_"+t.id_friend).removeClass("chat_is_typing")},user_online:function(t){if("undefined"!=typeof t.id_user&&t.id_user!==this.user_id)if(this.log_and_tooltip.log_debug("user online",t.id_user),"undefined"!=typeof this.friends&&"undefined"!=typeof this.friends[t.id_user]){if(this.friends[t.id_user].status="Online",$(".user"+t.id_user).remove(),this.add_friend(this.friends[t.id_user]),this.chatInitsAndPrefs.serviceWorkerRegistration)try{this.chatInitsAndPrefs.serviceWorkerRegistration.postMessage({action:"friend_online",friend_id:t.id_user})}catch(e){this.log_and_tooltip.log_error("Failed to send friend_online to SW")}}else this.socket_connection.emit("get_users_infos",{friends_ids:[t.id_user]})},user_offline:function(t){if(this.log_and_tooltip.log_debug("user offline",t),void 0!==t&&t!==this.user_id&&"undefined"!=typeof this.friends&&"undefined"!=typeof this.friends[t]&&"Offline"!=this.friends[t].status&&("undefined"!=typeof this.friends&&"undefined"!=typeof this.friends[t]&&(this.friends[t].status="Offline",$(".user"+t).remove(),this.add_friend(this.friends[t])),this.chatInitsAndPrefs.serviceWorkerRegistration))try{this.chatInitsAndPrefs.serviceWorkerRegistration.postMessage({action:"friend_offline",friend_id:t})}catch(e){this.log_and_tooltip.log_error("Failed to send friend_offline to SW")}},decrypt_conv_keys:function(t){var n=this.get_friend_infos(t.recipient_id);if(n.is_sheer_creator)return void this.log_and_tooltip.log_debug("decrypt_conv_keys skip it because sheer creator");if(delete this.friends[t.recipient_id].no_conversation_key_reason,"undefined"==typeof t.key||"undefined"==t.key){var s="";"undefined"==typeof t.no_key||"undefined"==t.no_key?(s=r.__("chat.unable_crypt_friend",{"%reason%":r.__("error.internal_err_please_reload")}),this.log_and_tooltip.log_error('no_private_key "undefined"')):"user"==t.no_key?(this.log_and_tooltip.write_message_no_private_key(),this.log_and_tooltip.log_error('no_private_key "user"')):"friend"==t.no_key?(s=r.__("chat.unable_crypt_friend",{"%reason%":r.__("chat.unable_crypt_friend_friend_key")}),this.log_and_tooltip.log_error('no_private_key "friend"')):"create_failed"==t.no_key&&(s=r.__("chat.unable_crypt_friend",{"%reason%":r.__("error.internal_err_please_reload")}),this.log_and_tooltip.log_error('no_private_key "create_failed"')),this.friends[t.recipient_id].no_conversation_key_reason=s,this.header_message_set_warning_crypt()}else if(!1!==n){this.log_and_tooltip.log_debug("data.key",t.key);var o=this.decrypt_conv_key(t.key);this.log_and_tooltip.log_debug("keys",o),this.friends[t.recipient_id].conversation_key=o;var a=null,c=0;for(var d in o)d>c&&null!=o[d]&&(c=d,a=o[d]);if(0!=c){var h=Math.round((new Date).getTime()/1e3)-604800;for(var d in o)d!==c&&null==o[d]&&"null"!==t.key[d]&&(parseInt(t.key[d])!=t.key[d]||t.key[d]<h)&&this.socket_connection.emit("internal_message",{hexavid_login:i.get(e.dyn.chat.cookie_name),id_friend:t.recipient_id,action:"ask_conv_key",params:{message:this.make_real_message_fct(JSON.stringify({action:"ask_conv_key",timestamp:d}),t.recipient_id),timestamp_key:d}})}if(this.log_and_tooltip.log_debug("most_recent_key",a),null==a||0==a){if(this.log_and_tooltip.log_error("data key",t.key),this.log_and_tooltip.log_error("no key found",o),this.log_and_tooltip.log_error("cookie",this.priv_key.substring(0,50)+" ... "+this.priv_key.substring(this.priv_key.length-50)),"undefined"!=typeof this.keys_create_timestamp){var _,l=!1;for(var d in o)if(d>this.keys_create_timestamp){l=!0,_=d;break}l?n.disable_encryption||(this.log_and_tooltip.log_error("conv_key not decryptable : ",t.key[_]),this.socket_connection.emit("create_new_conv_key",{id_friend:t.recipient_id})):(this.log_and_tooltip.log_error("no conv key found after the priv/pub keys create_date",o),!1===n||"undefined"!=typeof n.new_conv_key_asked&&!0===n.new_conv_key_asked||(this.friends[t.recipient_id].new_conv_key_asked=!0,this.socket_connection.emit("get_conv_key",{id_friend:t.recipient_id})))}this.friends[t.recipient_id].no_conversation_key_reason=r.__("chat.unable_crypt_friend",{"%reason%":r.__("error.internal_err_please_reload")}),t.recipient_id==this.selected_friend&&this.header_message_set_warning_crypt()}else this.friends[t.recipient_id].all_conv_crypted=!1,"undefined"!=typeof t.all_conv_crypted&&t.all_conv_crypted?(this.friends[t.recipient_id].all_conv_crypted=!0,this.friends[t.recipient_id].crypt_old_conv_pourcent=100):(this.friends[t.recipient_id].crypt_old_conv_todo=!0,this.old_conversation_to_crypt_set(t.recipient_id)),t.recipient_id==this.selected_friend&&this.header_message_set_crypt_old()}},new_conversation_key:function(t){return this.log_and_tooltip.log_debug("new_conversation_key",t),"undefined"==typeof t.recipient_id||"undefined"==typeof t.new_key&&"undefined"==typeof t.refresh_conv?void this.log_and_tooltip.log_error("new_conversation_key","missing param"):!1===this.get_friend_infos(t.recipient_id)?void this.log_and_tooltip.log_debug("new_conversation_key","no infos for friend "+t.recipient_id):void("undefined"!=typeof t.refresh_conv&&t.refresh_conv?($("#chat_group_messages_tab_"+t.recipient_id).empty(),this.get_conversation_fct(t.recipient_id)):this.friends[t.recipient_id].conversation_key=this.decrypt_conv_key(t.new_key))},decrypt_conv_key:function(t){var e=new o.JSEncrypt;e.setPrivateKey(this.priv_key);var i={};for(var n in t)i[n]=e.decrypt(t[n]);return i},crypt_old_conversation:function(t){var e=this.get_friend_infos(t.id_friend);if(e.disable_encryption)return void this.log_and_tooltip.log_debug("crypt_old_conversation","encryption disabled");if(this.log_and_tooltip.log_debug("crypt_old_conversation",t),"undefined"!=typeof t.conversation&&0==t.conversation)return"undefined"!=typeof t.id_friend&&(this.friends[t.id_friend].crypt_old_conv_pourcent=100,this.header_message_set_crypt_old(),this.old_conversation_to_crypt_remove(t.id_friend),this.old_conversation_to_crypt_launch_next()),void this.log_and_tooltip.log_debug("crypt_old_conversation all crypted :)");if("undefined"==typeof t.conversation||!t.conversation||"ERROR"==t.conversation||"undefined"==typeof t.id_friend||!1===e)return"undefined"!=typeof t.id_friend&&(this.friends[t.id_friend].crypt_old_conv_pourcent="error",this.header_message_set_crypt_old()),void this.log_and_tooltip.log_debug("crypt_old_conversation ERROR");if("undefined"!=typeof t.conversation.nb_conv&&"undefined"!=typeof t.conversation.nb_conv_crypted){var i=Math.floor(parseInt(t.conversation.nb_conv_crypted)/parseInt(t.conversation.nb_conv)*100);this.log_and_tooltip.log_debug("crypt previous messages : "+i+"%"),this.friends[t.id_friend].crypt_old_conv_pourcent=i,this.header_message_set_crypt_old()}var n;if("undefined"!=typeof t.conversation.index&&"undefined"!=typeof t.conversation.messages)for(var r in t.conversation.messages)n=t.conversation.messages[r].m,(n.length<21||"chatcrypt1"!=n.substring(0,10)||"1tpyrctahc"!=n.substring(n.length-10))&&(t.conversation.messages[r].m=this.make_real_message_fct(n,t.id_friend));this.socket_connection.emit("crypt_old_conv",{id_friend:t.id_friend,crypted_conv:JSON.stringify(t.conversation)})}},d}),define("skins/chat/chat_friend_action",["config/main","lib/tools","static/cookies","lib/i18n!front","lib/helpers/inline_loader"],function(t,e,n,r,s){var o=function(t,e,i,n,r,s,o){this.nb_friend_request_sent=0,this.nb_friend_request_sent_display=0,this.log_and_tooltip=t,this.chatInitsAndPrefs=e,this.url_base_profile=i,this.url_friends_requests="/account/friends/requests",this.chat_icon_home=n,this.msglist=r,this.get_conversation_fct=s,this.escape_javascript_fct=o,this.aReportDeleteReasons=[]};return o.prototype={set_user_in=e},set_socket_connection:function(t){this.socket_connection=t},set_chat_friend_manager:function(t){this.chat_friend_manager=t},fnDeleteReasons:function(){var t=this;return new Promise(function(e,n){$.ajax({url:"/account/report-delete-reasons",type:"GET",dataType:"JSON",success:function(r){if(0==r.code){for(i in r.delete_reasons)t.aReportDeleteReasons[i]=r.delete_reasons[i];e()}else n()},er()}})})},friend_requests_html:function(t){if("undefined"!=typeof t.nb_friend_request&&parseInt(t.nb_friend_request)>0){$("#chat-home-friend-request").html(r.__("chat.infos.nb_friends_requests_received",{"%nb_friend_request%":t.nb_friend_request.toString(),"%start_link%":'<a href="'+this.url_friends_requests+'" target="_blank" rel="noopener noreferrer">',"%end_link%":"</a>"})),this.set_badge_friend_request(t.nb_friend_request);var e=this;if("undefined"!=typeof t.last_friend_request&&t.last_friend_request.length>0){var i="<p>"+r.__("chat.infos.last_friends_requests")+'</p><ul id="chat-friend-requests">';t.last_friend_request.sort(function(t,e){return"undefined"==typeof t.ts&&"undefined"==typeof e.ts?0:"undefined"==typeof t.ts?1:"undefined"==typeof e.ts?-1:t.ts>e.ts?-1:t.ts<e.ts?1:0});for(var n in t.last_friend_request)i+=this.friend_requests_li_html(t.last_friend_request[n]);i+="</ul>",$("#chat-home-last-friend-request").html(i);for(var n in t.last_friend_request)$("#chat-friend-request-"+t.last_friend_request[n].id_friend+"-link").on("click",function(t){t.stopPropagation(),e.friend_request_accept(this)}),$("#chat-friend-request-"+t.last_friend_request[n].id_friend+"-link-refuse").on("click",function(t){t.stopPropagation(),e.friend_request_refuse(this)})}}else $("#chat-home-friend-request").html(r.__("chat.infos.no_friends_requests"));if("undefined"!=typeof t.nb_friend_request_sent&&parseInt(t.nb_friend_request_sent)>0){$("#chat-home-friend-request-sent").html(r.__("chat.infos.nb_friends_requests_sent",{"%nb_friend_request_sent%":t.nb_friend_request_sent.toString()})),this.set_badge_friend_request_sent(t.nb_friend_request_sent),this.nb_friend_request_sent=0,this.nb_friend_request_sent_display=0;var e=this;if("undefined"!=typeof t.last_friend_request_sent&&t.last_friend_request_sent.length>0){var i="<p>"+r.__("chat.infos.last_friends_requests_sent")+'</p><ul id="chat-friend-requests-sent">';t.last_friend_request_sent.sort(function(t,e){return"undefined"==typeof t.ts&&"undefined"==typeof e.ts?0:"undefined"==typeof t.ts?1:"undefined"==typeof e.ts?-1:t.ts>e.ts?-1:t.ts<e.ts?1:0});for(var n in t.last_friend_request_sent)i+=this.friend_requests_li_html(t.last_friend_request_sent[n],!0);i+="</ul>",$("#chat-home-last-friend-request-sent").html(i);for(var n in t.last_friend_request_sent)$("#chat-friend-request-"+t.last_friend_request_sent[n].id_friend+"-link-cancel").on("click",function(t){t.stopPropagation(),e.friend_request_sent_cancel(this)});this.nb_friend_request_sent=parseInt(t.nb_friend_request_sent),this.nb_friend_request_sent_display=$("#chat-friend-requests-sent li").length}}else $("#chat-home-friend-request-sent").html(r.__("chat.infos.no_friends_requests_sent"));$("#chat-home-tabs").show(),$("#chat-home-tabs-news .chat-home-tabs-icon").on("click",function(){$("#chat-home-tabs li").removeClass("chat-selected"),$("#chat-home-tabs-news").addClass("chat-selected"),$(".chat-home-tab-container").removeClass("chat-selected"),$("#chat-home-tab-container-home").addClass("chat-selected")}),$("#chat-home-tabs-requests").css("display","inline-block"),$("#chat-home-tabs-requests .chat-home-tabs-icon").on("click",function(){$("#chat-home-tabs li").removeClass("chat-selected"),$("#chat-home-tabs-requests").addClass("chat-selected"),$(".chat-home-tab-container").removeClass("chat-selected"),$("#chat-home-tab-container-requests").addClass("chat-selected")}),$("#chat-home-tabs-requests-sent").css("display","inline-block"),$("#chat-home-tabs-requests-sent .chat-home-tabs-icon").on("cli")})},set_badge_friend_request:function(t){if(0==t||t!=parseInt(t))return this.chat_icon_home.find("span.badge").remove(),void $("#chat-home-tabs-requests span.icon-f span.badge").remove();this.chat_icon_home.html('<span class="badge">'+parseInt(t)+"</span>"),$("#chat-home-tabs-requests span.icon-f").html('<span class="badge">'+parseInt(t)+"</span>")},set_badge_friend_request_sent:function(t){if(0==t||t!=parseInt(t))return void $("#chat-home-tabs-requests-sent span.icon-f span.badge").remove();$("#chat-home-tabs-requests-sent span.icon-f").html('<span class="badge">'+parseInt(t)+"</span>")},friend_requests_li_html:function(t,i){var n='<li id="chat-friend-request-'+t.id_friend+'">';n+='<div class="chat-friend-request-image"><a href="'+this.url_base_profile+t.profile_name+'" title="'+r.__("profile.title_link_page")+'" target="_blank" rel="noopener noreferrer"><img src="'+t.profile_picture+'" /></a></div>',i?n+='<div class="chat-friend-request-button"><span id="chat-friend-request-'+t.id_friend+'-link-cancel" title="'+r.__("misc.cancel")+'" class="icon-f icf-close-circle"></span></div>':(n+='<div class="chat-friend-request-button"><span id="chat-friend-request-'+t.id_friend+'-link-refuse" title="'+r.__("misc.refuse")+'" class="icon-f icf-close-circle"></span></div>',n+='<div class="chat-friend-request-button"><span id="chat-friend-request-'+t.id_friend+'-link" title="'+r.__("misc.accept")+'" class="icon-f icf-check-circle"></span></div>');var s="";return"number"==typeof t.ts&&(s=" ("+e.formatDuration((new Date).getTime()/1e3-t.ts,e.formatDurationMethods.diff)+")"),n+='<div class="chat-friend-request-name"><a href="'+this.url_base_profile+t.profile_name+'" title="'+t.profile_name_display+'" target="_blank" rel="noopener noreferrer">'+t.profile_name_display+"</a>"+s+"</div>",n+="</li>"},friend_request_accept:function(t){this.chatInitsAndPrefs.set_timer_away();var e=parseInt(t.id.replace("chat-friend-request-","").replace("-link",""));if(0==e)return void this.log_and_tooltip.popup_title_open("<p>"+r.__("misc.error_please_retry")+"</p>");"undefined"!=typeof this.socket_connection&&"function"==typeof this.socket_connection.emit?(this.socket_connection.emit("accept_friend",{friend_id:e}),$("#chat-friend-request-"+e).find(".chat-friend-request-button button").hide(),$(t).parent().append('<div id="div-load-request-'+e+'">'+s.getImg()+"</div>"),setTimeout(function(){$("#div-load-request-"+e).remove(),$("#chat-friend-request-"+e).find(".chat-friend-request-button button").show()},12e3)):this.log_and_tooltip.popup_title_open("<p>"+r.__("misc.error_please_retry")+"</p>")},friend_request_accepted:function(t){if(this.log_and_tooltip.log_debug("friend_request_accepted"),"undefined"==typeof t.user||"undefined"==typeof t.friend)return void("undefined"!=typeof t.user&&t.user.id_user==this.user_id&&this.log_and_tooltip.popup_title_open("<p>"+r.__("misc.error_please_retry")+"</p>"));if(t.user.id_user==this.user_id&&(this.chat_friend_manager.add_friend(t.friend,!0),$("#chat-friend-request-"+t.friend.id_user).remove(),"undefined"!=typeof t.nb_friend_request))if(0==parseInt(t.nb_friend_request))$("#chat-home-friend-request").html(r.__("chat.infos.no_friends_requests")),$("#chat-home-last-friend-request").html(""),this.set_badge_friend_request(0);else{this.set_badge_friend_request(t.nb_friend_request),$("#chat-home-friend-request").html(r.__("chat.infos.nb_friends_requests_received",{"%nb_friend_request%":t.nb_friend_request.toString(),"%start_link%":'<a href="'+this.url_friends_requests+'" target="_blank" rel="noopener noreferrer">',"%end_link%":"</a>"}));var e=this;if("undefined"!=typeof t.last_friend_request)for(var i in t.last_friend_request)0==$("#chat-friend-request-"+t.last_friend_request[i].id_friend).length&&($("#chat-friend-requests").append(this.friend_requests_li_html(t.last_friend_request[i])),$("#chat-friend-request-"+t.last_friend_request[i].id_friend+"-link").on("click",function(t){t.stopPropagation(),e.friend_request_accept(this)}),$("#chat-friend-request-"+t.last_friend_request[i].id_friend+"-link-refuse").on("click",function(t){t.stopPropagation(),e.friend_request_refuse(this)}))}t.friend.id_user==this.user_id&&this.chat_friend_manager.add_friend(t.user,!0)},friend_request_refuse:function(t){this.chatInitsAndPrefs.set_timer_away();var e=parseInt(t.id.replace("chat-friend-request-","").replace("-link-refuse",""));if(0==e)return void this.log_and_tooltip.popup_title_open("<p>"+r.__("misc.error_please_retry")+"</p>");"undefined"!=typeof this.socket_connection&&"function"==typeof this.socket_connection.emit?(this.socket_connection.emit("refuse_friend_request",{friend_id:e}),$("#chat-friend-request-"+e).find(".chat-friend-request-button button").hide(),$(t).parent().append('<div id="div-load-request-'+e+'">'+s.getImg()+"</div>"),setTimeout(function(){$("#div-load-request-"+e).remove(),$("#chat-friend-request-"+e).find(".chat-friend-request-button button").show()},12e3)):this.log_and_tooltip.popup_title_open("<p>"+r.__("misc.error_please_retry")+"</p>")},friend_request_refused:function(t){if(this.log_and_tooltip.log_debug("friend_request_refused"),"undefined"==typeof t.user_id||"undefined"==typeof t.friend_id)return void("undefined"!=typeof t.user_id&&t.user_id==this.user_id&&this.log_and_tooltip.popup_title_open("<p>"+r.__("misc.error_please_retry")+"</p>"));if(t.user_id==this.user_id&&($("#chat-friend-request-"+t.friend_id).remove(),"undefined"!=typeof t.nb_friend_request))if(0==parseInt(t.nb_friend_request))$("#chat-home-friend-request").html(r.__("chat.infos.no_friends_requests")),$("#chat-home-last-friend-request").html(""),this.set_badge_friend_request(0);else{this.set_badge_friend_request(t.nb_friend_request),$("#chat-home-friend-request").html(r.__("chat.infos.nb_friends_requests_received",{"%nb_friend_request%":t.nb_friend_request.toString(),"%start_link%":'<a href="'+this.url_friends_requests+'" target="_blank" rel="noopener noreferrer">',"%end_link%":"</a>"}));var e=this;if("undefined"!=typeof t.last_friend_request)for(var i in t.last_friend_request)0==$("#chat-friend-request-"+t.last_friend_request[i].id_friend).length&&($("#chat-friend-requests").append(this.friend_requests_li_html(t.last_friend_request[i])),$("#chat-friend-request-"+t.last_friend_request[i].id_friend+"-link").on("click",function(t){e.friend_request_accept(this)}),$("#chat-friend-request-"+t.last_friend_request[i].id_friend+"-link-refuse").on("click",function(t){e.friend_request_refuse(this)}))}},friend_request_sent_cancel:function(t){this.chatInitsAndPrefs.set_timer_away();var e=parseInt(t.id.replace("chat-friend-request-","").replace("-link-cancel",""));if(0==e)return void this.log_and_tooltip.popup_title_open("<p>"+r.__("misc.error_please_retry")+"</p>");"undefined"!=typeof this.socket_connection&&"function"==typeof this.socket_connection.emit?(this.socket_connection.emit("cancel_friend_request_sent",{friend_id:e}),$("#chat-friend-request-"+e).find(".chat-friend-request-button button").hide(),$(t).parent().append('<div id="div-load-request-'+e+'">'+s.getImg()+"</div>"),setTimeout(function(){$("#div-load-request-"+e).remove(),$("#chat-friend-request-"+e).find(".chat-friend-request-button button").show()},12e3)):this.log_and_tooltip.popup_title_open("<p>"+r.__("misc.error_please_retry")+"</p>")},friend_request_sent_canceled:function(t){if(this.log_and_tooltip.log_debug("friend_request_sent_canceled"),"undefined"==typeof t.user_id||"undefined"==typeof t.friend_id)return void("undefined"!=typeof t.user_id&&t.user_id==this.user_id&&this.log_and_tooltip.popup_title_open("<p>"+r.__("misc.error_please_retry")+"</p>"));t.user_id==this.user_id?($("#chat-friend-request-"+t.friend_id).remove(),this.friend_request_sent_reinit_count()):t.friend_id==this.user_id&&$("#chat-friend-request-"+t.user_id).remove()},friend_request_sent_reinit_count:function(){var t=$("#chat-friend-requests-sent li").length;t!=this.nb_friend_request_sent_display&&(this.nb_friend_request_sent=this.nb_friend_request_sent-(this.nb_friend_request_sent_display-t),this.nb_friend_request_sent>0?$("#chat-home-friend-request-sent").html(r.__("chat.infos.nb_friends_requests_sent",{"%nb_friend_request_sent%":this.nb_friend_request_sent.toString()})):($("#chat-home-friend-request-sent").html(r.__("chat.infos.no_friends_requests_sent")),$("#chat-home-last-friend-request-sent").html("")),this.set_badge_friend_request_sent(this.nb_friend_request_sent))},friend_request_send:function(e){if(this.chatInitsAndPrefs.set_timer_away(),this.log_and_tooltip.log_debug("friend_request_send"),0==(e=parseInt(e)))return void this.log_and_tooltip.popup_title_open("<p>"+r.__("misc.error_please_retry")+"</p>");if("undefined"!=typeof this.socket_connection&&"function"==typeof this.socket_connection.emit){this.socket_connection.emit("make_friend_request",{friend_id:e,hexavid_login:n.get(t.dyn.chat.cookie_name)});var i=$("#chat-profile-send-request");$('<p id="div-send-request-profile">'+s.getImg()+"</p>").insertAfter(i),i.hide(),setTime()},12e3)}else this.log_and_tooltip.popup_title_open("<p>"+r.__("misc.error_please_retry")+"</p>")},friend_request_done:function(e){if(this.log_and_tooltip.log_debug("friend_request_done"),"undefined"!=typeof e.vpn&&1==e.vpn){var i="<p><b>"+r.__("chat.error.using_vpn")+"</b></p><p>"+r.__("chat.error.vpn_red_member_needed",{"%link_start%":'<a href="https://www.xvideos.red">',"%link_end%":"</a>","%verif_link_start%":'<a href="/account/verify_account">'})+"</p>";return"undefined"!=typeof e.friend_id&&0!==$("#chat_group_messages_tab_"+e.friend_id).length||this.log_and_tooltip.write_error({message:i},!1),void $("#chat_group_messages_tab_"+e.friend_id).html('<li id="chat-profile-send-request">'+i+"</li>")}if("undefined"==typeof e.user||"undefined"==typeof e.friend)return void(e.user.id_user==this.user_id&&this.log_and_tooltip.popup_title_open("<p>"+r.__("misc.error_please_retry")+"</p>"));var n=this;if(e.user.id_user==this.user_id){if($("#chat-profile-send-request").html("<p>"+r.__("profile.friends.you_asked_friends",{"%name%":e.friend.profile_name})+"</p><p>"+r.__("chat.waiting_request_response")+"</p>"),$("#chat-profile-send-request").show(),$("#div-send-request-profile").remove(),"undefined"!=typeof t.data&&"undefined"!=typeof t.data.user&&e.friend.id_user==t.data.user.id_user){0==$("#chat-friend-requests-sent").length&&$("#chat-home-last-friend-request-sent").html("<p>"+r.__("chat.infos.last_friends_requests_sent")+'</p><ul id="chat-friend-requests-sent"></ul>');var s={};s.id_friend=e.friend.id_user,s.profile_name=t.data.user.display,$("select_friend_li_"+e.friend.id_user+" .chat_profile_name").length>0?s.profile_name_display=$("select_friend_li_"+e.friend.id_user+" .chat_profile_name").html():s.profile_name_display=t.data.user.display,s.profile_picture=t.data.user.profile_picture_small,$("#chat-friend-requests-sent").append(this.friend_requests_li_html(s,!0)),$("#chat-friend-request-"+e.friend.id_user+"-link-cancel").on("clis)}),this.friend_request_sent_reinit_count()}}else if(e.friend.id_user==this.user_id&&($("#chat-friend-request-"+e.user.id_user).remove(),0==$("#chat-friend-requests").length&&$("#chat-home-last-friend-request").html("<p>"+r.__("chat.infos.last_friends_requests")+'</p><ul id="chat-friend-requests"></ul>'),"undefined"!=typeof e.nb_request&&($("#chat-home-friend-request").html(r.__("chat.infos.nb_friends_requests_received",{"%nb_friend_request%":e.nb_request.toString(),"%start_link%":'<a href="'+this.url_friends_requests+'" target="_blank" rel="noopener noreferrer">',"%end_link%":"</a>"})),this.set_badge_friend_request(e.nb_request)),0==$("#chat-friend-request-"+e.user.id_user).length)){var o={};o.id_friend=e.user.id_user,o.profile_picture=e.user.profile_picture,o.profile_name=e.user.profile_name_lower,o.profile_name_display=e.user.profile_name,$("#chat-friend-requests").prepend(this.friend_requests_li_html(o)),$("#chat-friend-request-"+e.user.id_user+"-link").on("click",function(t){n.friend_request_accept(this)}),$("#chat-friend-request-"+e.user.id_user+"-link-refuse").on("clis)})}},pending_request_checked:function(e){if(this.log_and_tooltip.log_debug("pending_request_checked",e),"undefined"!=typeof e.pending_request&&"undefined"!=typeof e.friend_id&&"undefined"!=typeof e.friend_name&&"undefined"!=typeof e.can_request){if("undefined"!=typeof e.display&&!e.display)return void this.log_and_tooltip.log_debug("pending_request_checked","user_id: "+t.data.user.id_user+"one of users is blocked, do not display it");if(t.hasOwnProperty("data")&&t.data.hasOwnProperty("user")&&t.data.user.hasOwnProperty("id_user")&&t.data.user.id_user==e.friend_id){var i={};i.nb_unread=0,i.profile_name=t.data.user.display,i.profile_name_lower=t.data.user.username,i.is_favorite=!1,i.is_online=!0,i.selected=!1,i.id_user=t.data.user.id_user,i.profile_picture=t.data.user.profile_picture_small,i.not_friend=!0,i.is_sheer_creator=e.is_sheer_creator,i.disable_encryption=e.disable_encryption,i.is_subscribed=e.is_subscribed;var n="chat_messages_tab_"+i.id_user,s="chat_group_messages_tab_"+i.id_user;if(0===$("#"+n).length&&this.msglist.append('<div id="'+n+'" class="chat_tab_container"><ul id="'+s+'" class="chat_group_tab_container"></ul></div>'),e.pending_request){var o="chat.waiting_request_response";if(t.data.user.hasOwnProperty("sex")){var a=t.data.user.sex;"Woman"==a||"Lesbian woman"==a||"Transsexual"==a?o="chat.waiting_request_response_her":-1!==a.toLowerCase().indexOf("couple")&&(o="chat.waiting_request_response_them")}o=r.__(o),$("#"+s).html('<li id="chat-profile-send-request"><p>'+r.__("profile.friends.you_asked_friends",{"%name%":e.friend_name})+"</p><p>"+o+"</p></li>")}else if(i.is_sheer_creator)i.not_friend=!1;else if(e.can_request)if(e.asked_you)$("#"+s).html('<li id="chat-profile-send-request">'+r.__("profile.friends.asked_you_friend",{"%name%":e.friend_name})+"</li>");else{var c="chat.friend_request_from_profile";if(t.data.user.hasOwnProperty("sex")){var a=t.data.user.sex;"Woman"==a||"Lesbian woman"==a||"Transsexual"==a?c="chat.friend_request_from_profile_her":-1!==a.toLowerCase().indexOf("couple")&&(c="chat.friend_request_from_profile_them")}var d=r.__(c,{"%name%":e.friend_name,"%start_link%":'<a id="chat-profile-send-request-link">',"%end_link%":"</a>"});$("#"+s).html('<li id="chat-profile-send-request">'+d+"</li>");var h=this;t.dyn.chat.vpn?$("#chat-profile-send-request").find("a").on("click",function(t){t.stopPropagation(),h.log_and_tooltip.popup_open($("#chat-profile-send-request-link"),"<p>"+r.__("chat.error.using_vpn")+"</p><p>"+r.__("chat.error.vpn_red_member_needed",{"%link_start%":'<a href="https://www.xvideos.red">',"%link_end%":"</a>","%verif_link_start%":'<a href="/account/verify_account">'})+"</p>",{trigger:!1})}):$("#chat-profile-send-request").find("a").on("clir)})}else $("#"+s).html('<li id="chat-profile-send-request">'+r.__("profile.friends.ask_friend_not_allowed",{"%user%":e.friend_name})+"</li>");$("#select_friend_li_"+t.data.user.id_user).remove(),this.chat_friend_manager.add_friend(i),this.chat_friend_manager.select_friend(t.data.user.id_user)}}},block_report:function(t,e,i){null!=t&&t.stopPropagation();var n=e;if(0==n)return this.log_and_tooltip.log_error("block_report","no friend selected"),void this.log_and_tooltip.popup_open($(".chat-header-container .chat-header-block"),"<p>"+r.__("chat.error.no_friends_selected")+"</p>");var s=(i[n],'<ul class="chat_popup_choice"><li id="chat_popup_li_report_block">'+r.__("profile.actions.block_&_report_user")+'</li><li id="chat_popup_li_block">'+r.__("profile.actions.block_user")+'</li><li id="chat_popup_li_report">'+r.__("profile.actions.report_user")+"</li></ul>");this.log_and_tooltip.popup_open($(".chat-header-container .chat-header-block"),s);var o=this;$("#chat_popup_li_report_block").on("click",function(t){t.stopPropagation(),o.log_and_tooltip.popup_close(),o.report_last_message($(".chat-header-container .chat-header-block"),1,e,i)}),$("#chat_popup_li_block").on("click",function(t){t.stopPropagation(),o.log_and_tooltip.popup_close(),o.block_friend(e,null,i)}),$("#chat_popup_li_report").on("click",function(t){t.stopPropagation(),o.log_and_tooltip.popup_close(),o.report_last_message($(".chat-header-container .chat-header-block"),0,e,i)})},block_friend:function(t,e,i){if(0==t||void 0===i||"undefined"==typeof i[t])return this.log_and_tooltip.log_error("block_friend","no friend selected"),void this.log_and_tooltip.popup_open($(".chat-header-container .chat-header-block"),"<p>"+r.__("chat.error.no_friends_selected")+"</p>");var n=i[t];null==e&&(e=r.__("profile.confirm_block",{"%user%":n.profile_name})),"undefined"!=typeof this.socket_connection&&"function"==typeof this.socket_connection.emit?this.socket_connection.emit("block_friend",{friend_id:t}):this.log_and_tooltip.log_error("block_friend","no socket connection")},friend_blocked:function(t){if("undefined"==typeof t.friend_id)return void this.log_and_tooltip.popup_title_open("<p>"+r.__("misc.error_please_retry")+"</p>");if($("#select_friend_li_"+t.friend_id).remove(),$("#chat_group_messages_tab_"+t.friend_id).remove(),this.chatInitsAndPrefs.serviceWorkerRegistration)try{this.chatInitsAndPrefs.serviceWorkerRegistration.postMessage({action:"block_friend",friend_id:t.friend_id})}catch(e){this.log_and_tooltip.log_error("Failed to send block_friend to SW")}},report_message:function(t,e,i){this.log_and_tooltip.log_debug("report_message");var n=$(t).closest(".chat-actions").parent().find(".chat_message_report"),r={};$(t).offset().top-$("#chat-window").offset().top>$("#chat-window").height()/2&&(r.position={v:"above",h:"right"}),this.report_message_confirm(n,$(t),0,0,e,i,r)},report_last_message:function(t,e,i,n){this.log_and_tooltip.log_debug("report_last_message"),1!=e&&(e=0);var r=$("#chat_group_messages_tab_"+i+" .chat_message_report.message_left"),s=r[r.length-1];this.report_message_confirm(s,$(".chat-header-container .chat-header-block"),e,1,i,n[i])},report_message_confirm:function(t,e,i,n,s,o,a){"object"!=typeof a&&(a={});var c=this;this.fnDeleteReasons().then(function(){var d="<h4>"+r.__("chat.report_message")+"</h4>";d+='<div id="popup_report_message_errors" class="error"></div>',d+="<p><span>"+r.__("report_form.reason")+': </span><select id="popup_report_message_select">'
;for(var h in c.aReportDeleteReasons)d+='<option value="'+h+'">'+c.aReportDeleteReasons[h]+"</option>";d+='</select></p><p><textarea id="popup_report_message_text" placeholder="'+r.__("report_form.give_details")+'"></textarea></p>',d+='<p class="chat_popup_buttons"><button id="chat_popup_report_yes">'+r.__("misc.yes")+'</button><button id="chat_popup_report_no">'+r.__("misc.no")+"</button></p>",c.log_and_tooltip.popup_open(e,d,a),$("#chat_popup_report_yes").on("click",function(){$("#popup_report_message_errors").hide(),$("#popup_report_message_errors").empty();var e=$("#popup_report_message_select").val(),a=$("#popup_report_message_text").val(),d=[];if(e&&-1!=Object.keys(c.aReportDeleteReasons).indexOf(e)||d.push(r.__("report_form.sending_failed_2")),(!a||a.length<10)&&d.push(r.__("report_form.enter_reason",{"%nb_chars%":"10"})),d.length>0)for(var h in d)$("#popup_report_message_errors").append("<p>"+d[h]+"</p>"),$("#popup_report_message_errors").show();else c.report_message_send(t,i,n,s,o,e,a),c.log_and_tooltip.popup_close()}),$("#chat_popup_report_no").on("click",function(){c.log_and_tooltip.popup_close()})})},report_message_send:function(t,e,i,n,r,s,o){this.log_and_tooltip.log_debug("report_message_send"),1!=e&&(e=0),1!=i&&(i=0);var a=$("#chat_group_messages_tab_"+n+" .chat_message_report");if(a.length<100&&$("#history_"+n).length>0){var c={nb_messages:a.length,block:e,user:i,message_id:$(t).closest(".chat_message_id").attr("id")};return void this.get_conversation_fct(n,r.first_timestamp-1,null,c)}var d=a.index(t),h=this.get_messages_for_report(a,d,r);this.report_message_confirmed(h,e,i,n,s,o)},get_messages_for_report:function(t,e,i){for(var n,r,s,o=Math.max(0,t.length-100),a=t.length-1,c=[],d=o;d<=a;d++)t.hasOwnProperty(d)&&(r=t[d].closest(".chat_message_inner"),n=$(t[d]).clone(),s={},$(r).hasClass("message_right")?(s.name=this.profile_name,s.id_user=this.user_id):(s.name=i.profile_name,s.id_user=i.id_user),s.message=n.html().trim(),d==e&&(s.reported=!0),c.push(s));return c},report_message_confirmed:function(t,e,i,n,r,s){1!=e&&(e=0),1!=i&&(i=0),"undefined"!=typeof this.socket_connection&&"function"==typeof this.socket_connection.emit?this.socket_connection.emit("report_friend",{friend_id:n,messages:JSON.stringify(t),block:e,trad_user:i,deleteReasonId:r,reason_text:s}):this.log_and_tooltip.log_error("report_message_confirmed","bad socket connection"),this.log_and_tooltip.popup_close()},friend_reported:function(t,e){if(this.log_and_tooltip.log_debug("friend_reported"),!t.hasOwnProperty("friend_id")||!e.hasOwnProperty(t.friend_id))return void this.log_and_tooltip.log_error("friend_reported","unknowd friend_id "+t.friend_id);$("#chat_friend_menu").hide();var i="<p>"+r.__("chat.message_reported")+"</p>";t.hasOwnProperty("trad_user")&&1===parseInt(t.trad_user)&&(i="<p>"+r.__("profile.user_reported")+"</p>"),this.log_and_tooltip.popup_open($("#chat_friend_menu_switch"),i)},copy_messages_to_clipboard:function(t){$("#chat_friend_menu").hide();var e="",i=this;$("#chat_group_messages_tab_"+t+" li div.chat-body").each(function(){e+=$(this).find("div.header strong.chat-message-profile-name").html(),e+=", "+$(this).find("div.header span.chat-message-date").html(),e+="\n",$(this).find(".chat_message_display>div>p.chat_message_report").each(function(){var t=$(this).html();try{var n=JSON.parse(t);n&&"upload"==n.type&&"file uploaded in chat"==n.verif&&(t=n.file_broken?"[ "+r.__("chat.file_expired")+" ]":"[ "+r.__("chat.uploaded_file")+" ]")}catch(e){}e+="  "+i.escape_javascript_fct(t)+"\n"})});var n=document.createElement("textarea");n.value=e,n.id="chat_textarea_clipboard",n.style.width="0",n.style.height="0",n.style.border="0",$("div#chat-window div.chat-messages")[0].appendChild(n),n.select(),document.execCommand("copy"),$("#chat_textarea_clipboard").remove(),this.log_and_tooltip.popup_open($("#chat_friend_menu_switch"),"<p class='message'>"+r.__("chat.conv_copied_to_clipboard")+"</p>",{trigger:!1})},delete_all_messages:function(t){var e,i=!1;!1!==t&&"undefined"!=typeof t.profile_name||(i=!0,e="<p>"+r.__("misc.error_please_retry")+"</p>"),i||(e="<h4 style='text-align:center;margin-bottom:15px;'>"+r.__("chat.delete_all_messages")+"</h4>",e+='<div class="chat_delete_all"><div><div><div class="icon-f icf-warning"></div></div><div>'+r.__("chat.delete_all_messages_ask",{"%friend%":t.profile_name})+"</div></div></div>",e+='<p class="chat_popup_buttons"><button id="chat_popup_delete_all_yes" class="chat_popup_button_red" disabled>'+r.__("chat.delete_all_messages")+'</button><button id="chat_popup_delete_all_no">'+r.__("misc.no")+"</button></p>"),this.log_and_tooltip.popup_open($(".chat-header-delete-all"),e);var n,s=4e3;if(setTimeout(function(){$("#chat_popup_delete_all_yes").prop("disabled",!1),$("#chat_popup_delete_all_yes").removeClass("chat_popup_button_red"),clearInterval(n),$("#chat_popup_delete_all_yes").html(r.__("chat.delete_all_messages"))},s),$("#chat_popup_delete_all_yes").html(r.__("chat.delete_all_messages")+" ... "+Math.round(s/1e3)),n=setInterval(function(){s-=1e3,$("#chat_popup_delete_all_yes").html(r.__("chat.delete_all_messages")+" ... "+Math.round(s/1e3))},1e3),!i){var o=this,a=t.id_user;$("#chat_popup_delete_all_yes").on("click",function(){o.socket_connection.emit("delete_allmessages",{recipient_id:a}),o.log_and_tooltip.popup_close(),o.log_and_tooltip.log_debug("emit delete_allmessages",{recipient_id:a})}),$("#chat_popup_delete_all_no").on("cli()})}},message_all_deleted:function(t){this.log_and_tooltip.log_debug("message_all_deleted",t),$("#chat_friend_menu").hide();var e=this.chat_friend_manager.get_friend_infos(t.recipient_id);if("undefined"!=typeof t.recipient_id&&!1!==e&&"undefined"!=typeof t.deleted&&("me"==t.deleted||"friend"==t.deleted)){$("ul#chat_group_messages_tab_"+t.recipient_id+" li.chat-message-from-"+t.deleted).remove();var i=this.user_id;"friend"==t.deleted&&(i=t.recipient_id),i==e.last_id_sender&&this.chat_friend_manager.set_friend_attribut(t.recipient_id,"last_timestamp",0),0==$("ul#chat_group_messages_tab_"+t.recipient_id+" li").length&&$("ul#chat_group_messages_tab_"+t.recipient_id).html('<li class="chat-no-messages">'+r.__("chat.infos.no_history")+"</li>")}},change_favorite_state:function(t){if(this.chatInitsAndPrefs.set_timer_away(),t.stopPropagation(),0==this.chat_friend_manager.selected_friend)return this.log_and_tooltip.log_error("change_favorite_state","no friend selected"),void this.log_and_tooltip.popup_open($("#chat-window .chat-header-change-fav"),"<p>"+r.__("chat.error.no_friends_selected")+"</p>");var e=this.chat_friend_manager.get_selected_friend_infos();if(!e)return void this.log_and_tooltip.popup_open($("#chat-window .chat-header-change-fav"),"<p>"+r.__("chat.error.no_friends_selected")+"</p>");this.log_and_tooltip.log_debug("change_favorite_state",e.id_user);var i=$(".chat-header-container .chat-header-change-fav");if(i.length>0){var n=(i[0],this.chat_friend_manager.selected_friend),s=this;i.remove(),setTimeout(function(){s.chat_friend_manager.selected_friend==n&&0==$(".chat-header-container .chat-header-change-fav").length&&s.chat_friend_manager.header_messages_html(s.chat_friend_manager.selected_friend)},5e3)}1==e.is_favorite?this.socket_connection.emit("unfavorite_friend",{id:e.id_user}):this.socket_connection.emit("favorite_friend",{id:e.id_user})},update_favorite:function(t){if(this.log_and_tooltip.log_debug("update_favorite",t),"undefined"==typeof t.id||"undefined"==typeof t.favorite)return void this.log_and_tooltip.popup_open($("#chat-window #chat_friend_menu_switch"),"<p>"+r.__("chat.error.update_favorite_failed")+"</p>");var e=this.chat_friend_manager.get_friend_infos(t.id);if(!1===e)return void this.log_and_tooltip.popup_open($("#chat-window #chat_friend_menu_switch"),"<p>"+r.__("chat.error.update_favorite_failed")+"</p>");if(t.favorite?this.chat_friend_manager.set_friend_attribut(t.id,"is_favorite",1):this.chat_friend_manager.set_friend_attribut(t.id,"is_favorite",0),this.chatInitsAndPrefs.serviceWorkerRegistration)try{this.chatInitsAndPrefs.serviceWorkerRegistration.postMessage({action:"friend_favorite",friend_id:t.id,favorite:e.is_favorite})}catch(e){this.log_and_tooltip.log_error("Failed to send friend_favorite to SW")}$("#select_friend_li_"+t.id).remove(),this.chat_friend_manager.add_friend(e,!0),t.id==this.chat_friend_manager.selected_friend&&this.chat_friend_manager.header_messages_html(this.chat_friend_manager.selected_friend)}},o}),define("skins/common/basic_feature",["config/main","lib/i18n!front","lib/helpers/overlay/contextual_popu,n}),define("text!skins/chat/chat_notifications_feature_toggle.mustache",[],function(){return'<span class="alert-toggle {{{ disabled_alert_class }}}">\n\t<span class="icon-f icf-square unchecked"></span><span class="icon-f icf-check-square checked"></span> <span class="text">{{{ disabled_alert_text }}}</span>\n</span>'}),define("skins/chat/chat_user_notif",["mustache","config/main","lib/i18n!front","skins/common/basic_feature","text!skins/chat/chat_notifications_feature_toggle.mustache"],function(t,e,i,n,r){va()};return s.prototype={init:function(){this.count=!1,this.count_unread=!1,this.socket=null,this.feature_switch=null,window.xv||(window.xv={}),this.oFeature=new n(n.S_F_CHAT_NOTIF),this.oFeature.activateLoadingPopup(),this.oFeature.activateErrorPopup(),window.xv.get_messages_from_chat=this.get_notifs.bind(this),window.xv.get_messages_counts_from_chat=this.get_counts.bind(this),window.xv.get_messages_toggle_feature=this.toggle_feature.bind(this),window.xv.get_messages_feature_enabled=this.feature_enabled.bind(this);var e=this;window.xv.messages&&(window.xv.messages.setNotificationFeatureEnabled(this.feature_enabled()),window.xv.messages.addXMessageSetting(t.render(r,{disabled_alert_class:this.feature_enabled()?"":"disabled-feat",disabled_alert_text:i.__("chat.settings."+(this.feature_enabled()?"disable_notifications":"notifications_disabled")()}))},set_socket_connection:function(t){if("object"!=typeof t)return this.log_and_tooltip.log_error("chat_xv_notifs","bad type for set_socket"),!1;this.socket=t;var e=this;this.socket.on("notif_user",function(t){e.receive_event(t)}),this.socket.on("set_user_notifs",function(t){return"undefined"!=typeof t.error?(e.log_and_tooltip.log_error("set_user_notifs error: "+t.error),window.xv.messages.removeChatLoader(),!1):"undefined"==typeof t.notifs?(e.log_and_tooltip.log_error("set_user_notifs without notifs"),window.xv.messages.removeChatLoader(),!1):void("object"==typeof window.xv&&"object"==typeof window.xv.messages&&"function"==typeof window.xv.messages.setMessagesFromChat&&window.xv.messages.setMessagesFromChat(t.notifs))})},get_notifs:function(){if("object"!=typeof this.socket||null===this.socket)return!1;this.socket.emit("get_user_notifs")},get_coud}},set_counts:function(t){if(null==t||"object"!=typeof t||"undefined"==typeof t.count||"undefined"==typeof t.unread)return this.log_and_tooltip.log_error("user_notif set_counts with bad param: ",t),!1;var e=parseInt(t.count);if(isNaN(e))return this.log_and_tooltip.log_error("user_notif set_counts count with NaN: "+t.count),!1;var i=parseInt(t.unread);if(isNaN(i))return this.log_and_tooltip.log_error("user_notif set_counts count with NaN: "+t.unread),!1;this.count=e,this.count_unread=i,"object"==typeof window.xv&&"object"==typeof window.xv.messages&&"function"==typeof window.xv.messages.setMessagesCountsFromChat&&window.xv.messages.setMessagesCountsFromChat(this.get_counts())},receive_event:function(t){if(this.log_and_tooltip.log_debug("notifs_user event"),t.event&&"notification_sent"===t.event){if(!t.data)return;if("object"!=typeof t.data)return void this.log_and_tooltip.log_error("notification_sent invalid param");"object"==typeof window.xv&&"object"==typeof window.xv.messages&&"function"==typeof window.xv.messages.addMessageFromChat&&window.xv.messages.addMessageFromChat(t.data)}},feature_enab()},set_feature_swit)},update_feature_switch:function(){if(!this.feature_switch||0===this.feature_switch.length)return!1;var t=this.feature_switch.find(".alert-toggle"),e=t.find(".text");this.feature_enabled()?(t.removeClass("disabled-feat"),e.html(i.__("chat.settings.disable_notifications"))):(t.addClass("disabled-feat"),e.html(i.__("chat.settings.notifications_disabled")))},toggle_feature:function(t,e){var i=this;e="boolean"==typeof e?e:!this.feature_enabled(),this.oFeature.toggle(function(e){e||(xv.messages.xmmDelById("x-message-main-cat-alert-back"),xv.messages.xmmDelById("x-message-main-cat-alert-stop")),window.xv.messages&&window.xv.messages.setNotificationFeatureEnabled(e),i.update_feature_switch(),"function"==typeof t&&t()},e)}},s}),define("text!skins/chat/vault_message.mustache",[],function(){return'<div class="chat-content {{classes}}">\n\t{{#thumb_url}}\n\t<div class="chat-content__thumb-wrapper">\n\t\t<img class="chat-content__thumb" src="{{thumb_url}}" alt="">\n\t</div>\n\t{{/thumb_url}}\n\t<div class="chat-content__inner">\n\t{{#link}}\n\t\t<a class="chat-content__button {{#disabled}}chat-content__button--disabled {{/disabled}}chat-btn" target="_blank" {{#url}}href="{{url}}"{{/url}}>{{{label}}}</a>\n\t{{/link}}\n\t{{#message}}\n\t\t<p class="chat-content__message chat_message">{{{ message }}}</p>\n\t\t<p class="chat_message_report">{{ message }}</p>\n\t{{/message}}\n\t</div>\n</div>\n'}),define("skins/chat/vault",["mustache","config/main","lib/i18n!front","text!skins/chat/vault_message.mustache"],function(t,e,i,n){var r=null,s=null,o=function(){s||(console.error("Vault::constructor: Can not instantiate more than one instance, use Vault.getInstance()."),s={},s.error=console.error,s.log_debug=console.log),null!==r&&s.error("Vault::constructor: Can not instantiate more than one instance, use Vault.getInstance()."),this.contents=new Map,this.socket=null};return o.prototype={formatDate:function(t){var i=new Date(1e3*t);return new Intl.DateTimeFormat(e.local).format(i)},getMessageHtml:function(e){var r=Object.assign({classes:"",thumb_url:"",disabled:!0,link:{label:i.__("chat.vault.getting_infos"),url:""},message:""},e);return t.render(n,r)},getTempContentHtml:function(t,e){t.message_other_classes="chat-message--content";var i=e.c+"-"+Date.now(),n=$("<textarea />").text(e.m||"").html(),r=this.getMessageHtml({classes:"chat-content--loading-"+i,message:emojione.toShort(n).replace(new RegExp("\n","g"),"<br>")});return this.requestContent(e.c,i),r},onSocketVaultContentGet:function(t){for(var e in t){var i=t[e];this.contents.set(e,i);var n=i.temp_id||e,r=$(".chat-content--loading-"+n);if(0!==r.length){var s=this.prepareMessageHtmlParams(i,r);r.closest(".chat-message-temp").removeClass("chat-message-temp").find(".chat-message__actions").show().siblings(".chat-message__delivery-status").hide(),r.replaceWith(this.getMessageHtml(s))}}},prepareMessageHtmlParams:function(t,n){var r={classes:"",thumb_url:"",link:{disabled:!1,label:"",url:""},message:n.find(".chat-content__message").html()||""};if("boolean"==typeof t.exist&&!t.exist)return r.link.label=i.__("chat.vault.content_not_exist"),r.link.disabled=!0,r.link.deleted=!0,r;if(r.thumb_url=t.thumbnail.url,r.link.label=i.__("chat.vault.buy_content"),r.link.url=t.buy_button.url,r.thumb_url||(r.classes+=" chat-content--no-thumb"),t.buy_button.price&&(r.link.label=i.__("chat.vault.buy_for",{"%price%":new Intl.NumberFormat(e.locale,{style:"currency",currency:"USD"}).format(t.buy_button.price)})),t.deleted&&t.has_access&&!t.is_post_page_available&&(t.has_access=!1),t.has_access){t.is_post_page_available&&t.post_page_url?(r.link.label=i.__("chat.vault.view_content"),r.link.url=t.post_page_url):(r.link.disabled=!0,r.link.label=i.__("chat.vault.processing"),r.link.url="")}else t.deleted&&(r.link.disabled=!0,r.link.deleted=!0,r.link.label="Content not found",r.link.url="",r.thumb_url="");return r},requestContent:function(t,e){return"number"==typeof t&&(t=""+t),"string"!=typeof t?void s.log_debug("Vault::requestContent","contentId argument must be a string or number"):"string"!=typeof e?void s.log_debug("Vault::requestContent","tempId argument must be a string or number"):void this.socket.emit("get_vault_content",{contents:[{id:t,temp_id:e}]})},setSocket:function(t){this.socket=t,this.socket.on("vault_content_get",this.onSocketVaultContentGet.bind(this))}},o.getInsta,r},o.setLogAndTool=t},{getInstance:o.getInstance,setLogAndTooltip:o.setLogAndTooltip(t),t}),Function.prototype.bind||(Function.prototype.bind=function(t){var e=Array.prototype.slice.call(arguments,1),i=this;return function(){return i.apply(t,new Array(e,arguments))}}),define("skins/chat/manager",["config/main","static/storage"],function(t,i){xv.chat||(xv.chat={}),xv.chat.infos||(xv.chat.infos={}),xv.chat.actions||(xv.chat.actions={}),i.get("chat_storage_test")||(i.set("chat_storage_test","1"),i.remove("chat-display"),i.remove("server_connection_time"),i.remove("server_connection"),i.remove("popup-crypt-old"),i.remove("chat-size"),i.remove("chat-color"));var n=function(t,e){require(["mustache","lib/helpers/overlay","text!skins/chat/window_error.mustache","lib/i18n!front"],function(i,n,r,s){var o,a={xvideos_chat:s.__("chat.infos.xvideos_chat")};o="object"==typeof e?s.__(t,e):s.__(t);var c=$("#account-chat-private-container");if(c.length>0){var d=$(i.render(r,{window_class:"",trad:a}));c.html(d),d.height()>window.innerHeight-d.offset().top&&d.height(window.innerHeight-d.offset().top),n=n.get(d.children(".overlay-container"),!1,"hide"),n.setContent("<h3>"+s.__("misc.error")+"</h3><p>"+o+"</p>").show()}else d=$(i.render(r,{window_class:"chat-hidden",trad:a})).appendTo("div#page"),n=n.get(d.children(".overlay-container"),!1,"hide"),n.setContent("<h3>"+s.__("misc.error")+"</h3><p>"+o+"</p>").show(),$(".chat-title").on("click",function(){d.toggleClass("chat-hidden")})})};if(t.dyn.chat.enabled){if(t.dyn.login_info.is_logged||i.remove("chat-pk"),!(t.dyn.login_info.is_logged||t.data.user&&t.data.user.show_mini_chat))return void console.log("no chat if !logged and not a profile page with recent chat interaction");if(0===$("#account-chat-private-container").length&&"undefined"!=typeof t.dyn.chat.prefs&&1==t.dyn.chat.prefs.mini_disabled)return void console.log("mini chat has been disabled");var r=!0;if(!window.WebSocket){if(r=!1,"undefined"!=typeof navigator.userAgent&&/safari/i.test(navigator.userAgent)){var s=navigator.userAgent.match(/version\/(\d+)/i);null!=s&&"undefined"!=typeof s[1]&&parseInt(s[1])>=4&&(r=!0)}if("undefined"!=typeof navigator.userAgent&&/MSIE/i.test(navigator.userAgent)&&null!==(s=navigator.userAgent.match(/MSIE\s(\d+)/i))&&"undefined"!=typeof s[1]&&parseInt(s[1])>=9&&(r=!0),0===$("#account-chat-private-container").length&&!r)return void console.log("Browser doesn't support Websocket")}var o=!1;window.emojioneVersion="2.1.1",require(["mustache","static/cookies","lib/tools","lib/helpers/inline_loader","libs/socket.io","text!skins/chat/message.mustache","text!skins/chat/message_inside.mustache","text!skins/chat/message_quote.mustache","text!skins/chat/window.mustache","text!skins/chat/system_message.mustache","static/console","lib/i18n!front","libs/c3r18y25p16t","skins/chat/internal_message","skins/chat/log_and_tooltip","skins/chat/chat_inits","skins/chat/chat_preview","skins/chat/chat_send_file","skins/chat/chat_friends_manager","skins/chat/chat_friend_action","skins/chat/chat_user_notif","skins/chat/vault","jquery-scrollLock","jquery.textcomplete.min","libs/emojione.min"],function(n,s,a,c,d,h,_,l,u,f,p,g,m,v,y,b,w,k,S,E,x,T){o=!0;var A=function(i){this.connection_master=window.location.protocol+"//"+t.dyn.chat.server_master,this.url_base_profile="/profiles/",this.url_picture_default=t.domains["static"]+"/img/profile_default_small.jpg",this.sound_file=t.domains["static"]+"/v2/sound/notif1.mp3",this.friends_infos_from_SW=null,this.connect_done=!1,this.force_friend=null,this.cookie_deco_name="chat_deco",this.interval_check_deco=3e3,this.interval_check_nb_user=12e4,this.interval_check_nb_user_function=null,this.typing_to_friend=!1,this.typing_event_interval=3e3,this.typing_event_nb_carac=3,this.typing_event_last_event_ts=0,this.log_and_tooltip=new y(i,47530703),this.chat_user_notif=new x(this.log_and_tooltip),this.display_message_old_browser=!1,this.send_message_loader_timeouts={};var n=this;if(xv.chat.actions.set_chat_toggle=function(t){if(t=$(t),0===t.length)return!1;t.on("click",function(t){t.stopPropagation(),n.chat_toggle_display()})},xv.chat.infos.to_set_chat_toggle)for(var r in xv.chat.infos.to_set_chat_toggle)xv.chat.actions.set_chat_toggle(xv.chat.infos.to_set_chat_toggle[r]);if(this.time_for_message_group=60,this.chatInitsAndPrefs=new b(this.log_and_tooltip,this.change_status.bind(this)),this.chat_send_file=new k(this.log_and_tooltip,this.make_real_message.bind(this),this.get_last_conv_key.bind(this),this.scroll_down_conversation.bind(this),this.scroll_conversation_is_down.bind(this),this.message_for_upload_progress_bar.bind(this),this.friend_is_from_sheer.bind(this),this.chatInitsAndPrefs),!t.dyn.login_info.is_logged){this.initNode(!1),this.chatInitsAndPrefs.initSettings(this.change_status.bind(this),this.emit_change_prefs.bind(this),this.toggle_home.bind(this),this.chat_icon_home,this.node,this.setSwToken.bind(this),this.remove_SW_token.bind(this)),$("#chat-option-notification").hide(),$("#chat-option-mini-disabled").hide();var s={};return s.nb_unread=0,s.profile_name=t.data.user.display,s.is_favorite=!1,s.status="Online",s.selected=!0,s.id_user=t.data.user.id_user,s.profile_picture=t.data.user.profile_picture_small,this.chat_friend_manager.userlistothers.append(this.chat_friend_manager.add_friend_html(s,"offline")),$("#chat-home p").hide(),void require(["skins/default/form/login"],function(t){t.setupLinks($('<h4 class="text-danger">'+g.__("chat.must_have_account")+' <a class="text-danger">'+g.__("misc.click_here_login_create_account")+"</a></h4>").appendTo($("#chat-home")).children("a").on("click",function(){n.chat_toggle_display()}))})}if("http:"==window.location.protocol.toLowerCase()){if(this.initNode(!1),this.chatInitsAndPrefs.initSettings(this.change_status.bind(this),this.emit_change_prefs.bind(this),this.toggle_home.bind(this),this.chat_icon_home,this.node,this.setSwToken.bind(this),this.remove_SW_token.bind(this)),this.no_https=!0,$("#chat-option-notification").hide(),$("#chat-option-mini-disabled").hide(),$("#chat_loading_overlay").hide(),"undefined"!==t.dyn.chat.no_support_SSL&&1==t.dyn.chat.no_support_SSL)return this.log_and_tooltip.log_error("NOT HTTPS && no support HTTPS"),void this.log_and_tooltip.write_error({message:g.__("chat.https_not_supported")},!1,!0);var o=window.location.href.replace("http://","https://");return this.log_and_tooltip.log_error("NOT HTTPS -> need reload"),void this.log_and_tooltip.write_error({message:g.__("chat.need_https_reload",{"%link_start%":'<a href="'+o+'">',"%link_end%":"</a>"})},!1,!0)}if(this.priv_key=this.chatInitsAndPrefs.initKey(),0==this.priv_key&&(this.log_and_tooltip.log_error("no private key in local"),this.no_priv_key=!0,this.priv_key=""),!1 in navigator||"undefined"==typeof navigator.serviceWorker||this.no_priv_key)try{if(this.initNode(!1),this.chatInitsAndPrefs.initSettings(this.change_status.bind(this),this.emit_change_prefs.bind(this),this.toggle_home.bind(this),this.chat_icon_home,this.node,this.setSwToken.bind(this),this.remove_SW_token.bind(this)),window.SharedWorker)try{this.chatInitsAndPrefs.initSharedWorker(this.connect.bind(this),this.connect_SW.bind(this),this.reinitChat.bind(this)),"undefined"!=typeof this.shared_worker_no_support&&!0===this.shared_worker_no_support||"visible"==document.visibilityState&&"undefined"!=typeof this.chatInitsAndPrefs.shared_worker&&"undefined"!=typeof this.chatInitsAndPrefs.shared_worker.port&&(this.chatInitsAndPrefs.shared_worker.port.postMessage({action:"focus"}),connect_to_do=!1),this.connect()}catch(e){this.log_and_tooltip.log_error("init (no SW / w shared",e),this.connect()}else this.connect()}catch(e){this.log_and_tooltip.log_error("inits failed (no SW)",e.message),this.connect()}else{try{this.initNode(!0),this.chatInitsAndPrefs.initNotif(this.inputnotif),this.chatInitsAndPrefs.initSettings(this.change_status.bind(this),this.emit_change_prefs.bind(this),this.toggle_home.bind(this),this.chat_icon_home,this.node,this.setSwToken.bind(this),this.remove_SW_token.bind(this))}catch(e){return void this.log_and_tooltip.log_error("first inits failed -> stop loading chat",e.message+"\n"+e.stack)}try{this.chatInitsAndPrefs.initSharedWorker(this.connect.bind(this),this.connect_SW.bind(this),this.reinitChat.bind(this)),this.chatInitsAndPrefs.initServiceWorker(this.connect.bind(this),this.connect_SW.bind(this),this.serviceWorkerOnMessage.bind(this),this.setSwToken.bind(this))}catch(e){this.log_and_tooltip.log_error("inits (SW) failed -> launch connect manually",e.message),this.connect()}}};A.prototype={initNode:function(e){this.log_and_tooltip.log_debug("init node "+e);var s=this,o=$("#account-chat-private-container"),a={};a.xvideos_chat=g.__("chat.infos.xvideos_chat"),a.small_size=g.__("chat.settings.small_size"),a.medium_size=g.__("chat.settings.medium_size"),a.big_size=g.__("chat.settings.big_size"),a.sound=g.__("chat.settings.sound"),a.notifications=g.__("chat.settings.notifications"),a.disable_mini_chat=g.__("chat.settings.disable_mini_chat"),a.welcome=g.__("chat.infos.welcome"),a.still_working=g.__("chat.infos.still_working"),a.textarea_message_placeholder=g.__("chat.textarea_message_placeholder"),a.message_send=g.__("chat.message_send"),a.button_return_friends=g.__("chat.button_return_friends"),a.input_search_placeholder=g.__("chat.input_search_placeholder"),a.button_search_friends=g.__("chat.button_search_friends"),a.loading=g.__("loading.loading"),a.status_online=g.__("chat.status.online"),a.status_away=g.__("chat.status.away"),a.status_invisible=g.__("chat.status.invisible"),a.crypt_home=g.__("chat.crypt_home"),a.new_feature=g.__("chat.new_feature"),a.all_conv_encrypted=g.__("chat.all_conv_encrypted"),a.crypt_enabling=g.__("chat.crypt_enabling"),a.crypt_even_for_us=g.__("chat.crypt_even_for_us"),a.friend_requests=g.__("chat.infos.friend_requests"),a.friend_requests_sent=g.__("chat.infos.friend_requests_sent"),a.blur_image=g.__("chat.blur_option");var c=!1;o.length>0?(c=!0,this.node=$(n.render(u,{window_class:"",sound_file:this.sound_file,trad:a,is_dev:t.dyn.chat.is_dev,chat_log_debug_on:i.get("chat_log_debug_on")})),o.html(this.node),this.node.height()>window.innerHeight-this.node.offset().top&&this.node.height(window.innerHeight-this.node.offset().top)):this.node=$(n.render(u,{window_class:"chat-hidden",sound_file:this.sound_file,trad:a,is_dev:t.dyn.chat.is_dev,chat_log_debug_on:i.get("chat_log_debug_on")})).appendTo("div#page"),this.title=this.node.find(".chat-title"),c||this.title.on("click",function(){s.chat_toggle_display()}),t.dyn.chat.is_dev&&(1==i.get("chat_log_debug_on")?$("#chat-title-link-debug .chat-settings-option-icon").addClass("icon chat-settings-option-checked"):$("#chat-title-link-debug .chat-settings-option-icon").addClass("icon chat-settings-option-unchecked"),$("#chat-title-link-debug").on("click",function(t){t.stopPropagation();var e;1==i.get("chat_log_debug_on")?($("#chat-title-link-debug .chat-settings-option-icon").removeClass("icon chat-settings-option-checked").addClass("icon chat-settings-option-unchecked"),e=0):($("#chat-title-link-debug .chat-settings-option-icon").removeClass("icon chat-settings-option-unchecked").addClass("icon chat-settings-option-checked"),e=1),i.set("chat_log_debug_on",e),s.log_and_tooltip.set_log_debug(e)})),this.msglist=this.node.find(".chat-messages"),this.input=this.node.find("textarea"),this.inputnotif=this.node.find("#chat_checkbox_notif"),this.inputsound=this.node.find("#chat_checkbox_sound"),this.search_back_button=this.node.find("#chat-users-search-close a.chat_back_to_friends"),this.chat_icon_home=this.node.find(".chat-icon-home"),this.preloader=this.node.find("#chat-preloader"),this.opened=!1,this.log_and_tooltip.log_debug("init node : after init vars");var d=/^#chat_friend_([0-9]+)$/;if("undefined"!=typeof window.location.hash&&""!==window.location.hash){var h=d.exec(window.location.hash);if(h&&2===h.length){var _=parseInt(h[1]);0!==_&&(this.force_friend=_)}}if($("#account-chat-force-friend").length>0){var _=parseInt($("#account-chat-force-friend").html());0!==_&&(this.force_friend=_)}this.log_and_tooltip.log_debug("force_friend",this.force_friend),!r&&$("#account-chat-private-container").length>0&&(this.log_and_tooltip.log_error("Old browser"),$("#chat_loading_overlay").hide(),this.log_and_tooltip.write_error_old_browser(),this.display_message_old_browser=!0),this.chat_send_file.init_input_file(),"object"==typeof window.xv&&"object"==typeof window.xv.messages&&"function"==typeof window.xv.messages.setMessageNextToChat&&window.xv.messages.setMessageNextToChat();var l=null;if(this.chat_send_file.is_compatible()&&(l=document.getElementById("chat-drag-file")),l){var s=this;l&&(l.addEventListener("dragenter",function(t){t.preventDefault(),t.stopPropagation(),s.chat_friend_manager.selected_friend&&!$("div.chat-messenger").hasClass("chat-home")&&$("#chat-drag-file-overlay").show()}),l.addEventListener("dragover",function(t){t.preventDefault(),t.stopPropagation(),!s.chat_friend_manager.selected_friend||$("div.chat-messenger").hasClass("chat-home")}),l.addEventListener("dragleave",function(t){t.preventDefault(),t.stopPropagation(),!s.chat_friend_manager.selected_friend||$("div.chat-messenger").hasClass("chat-home")}),l.addEventListener("dragend",function(t){t.preventDefault(),t.stopPropagation(),!s.chat_friend_manager.selected_friend||$("div.chat-messenger").hasClass("chat-home")}),l.addEventListener("dragexit",function(t){t.preventDefault(),t.stopPropagation(),s.chat_friend_manager.selected_friend&&!$("div.chat-messenger").hasClass("chat-home")&&$("#chat-drag-file-overlay").hide()}),l.addEventListener("drop",function(t){t.preventDefault(),t.stopPropagation(),s.chat_friend_manager.selected_friend&&!$("div.chat-messenger").hasClass("chat-home")&&($("#chat-drag-file-overlay").hide(),"undefined"!=typeof t.dataTransfer&&"undefined"!=typeof t.dataTransfer.files&&t.dataTransfer.files.length>0&&s.chat_send_file.send_file(s.socket_connection,s.id_user,s.chat_friend_manager.selected_friend,t.dataTransfer.files[0]))}))}this.chat_friend_action=new E(this.log_and_tooltip,this.chatInitsAndPrefs,this.url_base_profile,this.chat_icon_home,this.msglist,this.get_conversation.bind(this),this.escape_javascript.bind(this)),this.chat_friend_manager=new S(this.log_and_tooltip,this.chatInitsAndPrefs,this.chat_friend_action,this.priv_key,this.node,this.url_base_profile,this.get_conversation.bind(this),this.make_real_message.bind(this),this.scroll_down_conversation.bind(this),this.set_read_date.bind(this),this.input),this.chat_friend_action.set_chat_friend_manager(this.chat_friend_manager)},reinitChat:function(){this.log_and_tooltip.log_debug("reinitChat"),this.reinit=!0,this.chat_toggle_display(!1,!0),this.connect_done=!1,this.cookie_deco_name&&(clearInterval(this.check_deco_interval),delete this.cookie_deco_name),this.socketMaster&&this.socketMaster.disconnect(),this.socket_connection&&this.socket_connection.disconnect(),$(".chat_tab_container").remove(),$("div.chat-messenger").removeClass("chat-home").addClass("chat-home"),this.input.prop("disabled",!0),this.chat_friend_manager.search_input.prop("disabled",!0),this.input.val(""),this.chat_friend_manager.search_input.val(""),this.chat_friend_manager.send_button.prop("disabled",!0),this.chat_friend_manager.search_button.prop("disabled",!0),null!=this.interval_check_nb_user_function&&(clearInterval(this.interval_check_nb_user_function),this.interval_check_nb_user_function=null)},serviceWorkerOnMessage:function(t){if(this.log_and_tooltip.log_debug("service worker onmessage",t.data.action),"undefined"!=typeof t.data.action&&"selectFriend"===t.data.action&&"undefined"!=typeof t.data.userId){if("undefined"==typeof this.chat_friend_manager.friends[t.data.userId])return this.log_and_tooltip.log_debug("click on notif from an unknown friend. Ask for informations for user "+t.data.userId),void this.socket_connection.emit("getuserinfos",{friend_id:t.data.userId,callback_obj:{open_tab:!0}});this.chat_toggle_display(!0),this.chat_friend_manager.select_friend(t.data.userId)}},connect_SW:function(){if(this.log_and_tooltip.log_debug("connect_SW"),this.chatInitsAndPrefs.serviceWorkerRegistration){var e=this;new Promise(function(i,n){var r=new MessageChannel;r.port1.onmessage=function(t){if(e.log_and_tooltip.log_debug("connect_SW callback",t.data),t.data.error)return void n(t.data.error);if("undefined"==typeof t.data.connected||"ok"!==t.data.connected)return void n("sw connect failed");if("undefined"==typeof t.data.friends_ids)return void n("no friends ids return");if("undefined"==typeof t.data.friends_infos)return void n("no first friends infos");var r=!1;"boolean"==typeof t.data.chat_display&&(r=t.data.chat_display);var s=0;"undefined"!=typeof t.data.last_friend_conv&&parseInt(t.data.last_friend_conv)>0&&(s=t.data.last_friend_conv),i({friends_ids:t.data.friends_ids,friends_infos:t.data.friends_infos,chat_display:r,last_friend_conv:s,last_set_friend:t.data.last_set_friend})},e.chatInitsAndPrefs.serviceWorkerRegistration.postMessage({action:"connect_sw",id_user:t.dyn.login_info.id},[r.port2]);setT ms")},4e3)}).then(function(t){var i=Date.now()-864e5;"undefined"!=typeof t.last_set_friend&&t.last_set_friend&&t.last_set_friend>i?(e.chat_friend_manager.set_friends_id(t.friends_ids),e.friends_infos_from_SW=t.friends_infos):e.log_and_tooltip.log_debug("SW friends data expired"),"undefined"!=typeof t.last_friend_conv&&0!==t.last_friend_conv&&(e.last_friend_conv=t.last_friend_conv),e.connect()})["catch"](function(t){e.log_and_tooltip.log_error("connect_sw failed : ",t),e.connect()})}else this.log_and_tooltip.log_debug("no serviceWorkerRegistration"),this.connect()},chat_toggle_display:function(e,n){if(this.log_and_tooltip.log_debug("chat_toggle_display"),this.chatInitsAndPrefs.set_timer_away(),!($("#account-chat-private-container").length>0||void 0!==e&&e==this.opened||("undefined"==typeof noSW&&(noSW=!1),this.log_and_tooltip.log_debug("toggle display"),this.opened=!this.opened,/XXXAndroidApp/.test(navigator.userAgent)&&"undefined"!=typeof AndroidInterface&&AndroidInterface.isChatOpened(this.opened?"true":"false"),this.node.toggleClass("chat-hidden"),this.no_https||""==this.priv_key))){if(!t.dyn.login_info.is_logged)return this.log_and_tooltip.overlay_remove(),void $("#chat_loading_overlay").remove();this.connect_done&&this.opened&&"undefined"!=typeof this.chat_friend_manager.selected_friend&&0!=this.chat_friend_manager.selected_friend&&(this.scroll_down_conversation(this.chat_friend_manager.selected_friend),this.set_read_date(this.chat_friend_manager.selected_friend)),!this.connect_done&&this.opened&&this.connect(),this.set_interval_nb_users(),this.opened&&this.chatInitsAndPrefs.checkNotifPermissionAsked(this.setSwToken.bind(this)),n||i.set("chat-display",this.opened)}},toggle_home:function(t,e){this.chatInitsAndPrefs.set_timer_away(),null!==t&&t.stopPropagation(),0!=this.chat_friend_manager.selected_friend&&(void 0!==e?($("div.chat-messenger").removeClass("chat-home").addClass("chat-home"),$("#select_friend_li_"+this.chat_friend_manager.selected_friend).removeClass("friend_selected")):($("div.chat-messenger").toggleClass("chat-home"),$("#select_friend_li_"+this.chat_friend_manager.selected_friend).toggleClass("friend_selected")))},connect:function(){this.log_and_tooltip.log_debug("connect");var t=this;if(!this.connect_done){this.connect_done=!0;var e,n=i.get("server_connection_time"),r=(new Date).getTime();if(n&&(r-parseInt(n)<864e5?e=i.get("server_connection"):i.set("server_connection_time",(new Date).getTime()-864e5+6e4)),void 0!==e&&""!=e&&e)return t.log_and_tooltip.log_important("got host from local : "+e),void t.connect_js_connection(e);this.connect_master()}},connect_master:function(){this.log_and_tooltip.log_debug("connect_master",this.connection_master);var t=this;if(t.master_call_ajax){if(t.master_call_ajax>2)return t.log_and_tooltip.log_error("AJAX MASTER ERROR","too much try"),t.log_and_tooltip.log_error("AJAX MASTER ERROR / host_from_master",t.host_from_master),t.log_and_tooltip.write_error({message:g.__("error.err_please_reload")}),i.set("server_connection",""),void i.set("server_connection_time",0)}else t.master_call_ajax=0;t.master_call_ajax++,$.ajax({type:"GET",url:t.connection_master+"/get_server_connection",success:function(n){try{var r=JSON.parse(n)}catch(e){return t.log_and_tooltip.log_error("connection master json parse error",e),void t.connect_master()}return r.error?(t.log_and_tooltip.log_error("connection master error",r.error),void t.connect_master()):r.server?(t.master_call_ajax=0,t.log_and_tooltip.log_debug("connected to master and got host : "+r.server),i.set("server_connection",r.server),i.set("server_connection_time",(new Date).getTime()),t.host_from_master=r.server,void t.connect_js_connection(r.server)):(t.log_and_tooltip.log_error("connection master error","missing server"),void t.connect_master())}ter()}})},connect_js_connection:function(n){this.log_and_tooltip.log_debug("connect_js_connection");var r=this;r.timeout_connection=setTimeout(function(){r.verifConnectionConnect()},6e4),r.socket_connection_connected=!1,r.socket_connection_connect_error=0,r.reinit=!1,r.nb_switch_server||(r.nb_switch_server=0),r.socket_connection&&(r.socket_connection.disconnect(),delete r.socket_connection),"undefined"==typeof this.force_close&&(r.force_close=!1,window.addEventListener("beforeunload",function(t){r.force_close=!0,"undefined"!=typeof r.socket_connection&&r.socket_connection.emit("force_close")})),this.log_and_tooltip.log_debug("socket connection to "+n);var o=s.get(t.dyn.chat.cookie_name);this.log_and_tooltip.log_debug("socket connection with "+o);var a=0;t.dyn.is_premium&&(a=1);var c={no_priv_key:r.no_priv_key,cookie_name:t.dyn.chat.cookie_name,is_premium:a};c[t.dyn.chat.cookie_name]=o;try{r.socket_connection=d(window.location.protocol+"//"+n,{reconnection:!0,reconnectionDelay:500,reconnectionAttempts:4,query:$.param(c)}),r.chat_friend_action.set_socket_connection(r.socket_connection),r.chat_friend_manager.set_socket_connection(r.socket_connection),r.chat_user_notif.set_socket_connection(r.socket_connection)}catch(e){r.log_and_tooltip.log_error("socket connection error",e.message),r.log_and_tooltip.write_error({message:g.__("chat.error.connection_error")},!0,!0)}if(r.log_and_tooltip.log_debug("socket connection","right after create"),r.socket_connection.on("user_connected",function(t){r.user_connected(t)}),r.socket_connection.on("send_users_allids_and_first_infos",function(t){r.get_users_allids_and_first_infos(t)}),r.socket_connection.on("get_online_friends",function(t){r.get_online_friends(t)}),r.log_and_tooltip.log_debug("socket connection","after 1st events."),r.socket_connection.on("send_conversation",function(t){r.put_history(t)}),r.socket_connection.on("message_received",function(t){r.receive_message(t)}),r.socket_connection.on("message_deleted",function(t){r.delete_message(t)}),r.socket_connection.on("message_edited",function(t){r.edit_message(t)}),r.socket_connection.on("read_date_set",function(t){r.read_date_set(t)}),r.socket_connection.on("new_conversation_key",function(t){r.chat_friend_manager.new_conversation_key(t)}),r.socket_connection.on("get_priv_key_error",function(t){$("#chat_pass_no_key_check_pass").hide(),$("#chat_pass_no_key_form").show(),$("#chat_pass_no_key_error").html(g.__("error.invalid_password"))}),r.socket_connection.on("crypt_old_conversation",function(t){r.chat_friend_manager.crypt_old_conversation(t)}),r.socket_connection.on("setuserinfos",function(t){r.setuserinfos(t)}),r.socket_connection.on("send_users_infos",function(t){r.send_users_infos(t)}),r.socket_connection.on("found_friends",function(t){r.chat_friend_manager.found_friends(t)}),r.socket_connection.on("user_log_on",function(t){r.chat_friend_manager.user_online(t)}),r.socket_connection.on("user_log_off",function(t){r.chat_friend_manager.user_offline(t)}),r.socket_connection.on("change_d(r))}),r.socket_connection.on("change_favorite",function(t){r.chat_friend_action.update_favorite(t)}),r.socket_connection.on("friend_request_accepted",function(t){r.chat_friend_action.friend_request_accepted(t)}),r.socket_connection.on("friend_request_refused",function(t){r.chat_friend_action.friend_request_refused(t)}),r.socket_connection.on("friend_request_done",function(t){r.chat_friend_action.friend_request_done(t)}),r.socket_connection.on("pending_request_checked",function(t){r.chat_friend_action.pending_request_checked(t)}),r.socket_connection.on("friend_request_sent_canceled",function(t){r.chat_friend_action.friend_request_sent_canceled(t)}),r.socket_connection.on("friend_blocked",function(t){t.friend_id==r.chat_friend_manager.selected_friend&&(r.toggle_home(null),r.chat_friend_manager.set_selected_friend(0)),r.chat_friend_action.friend_blocked(t)}),r.socket_connection.on("blocked_by_friend",function(t){r.blocked_by_friend(t)}),r.socket_connection.on("friend_repends)}),r.socket_connection.on("auto_boad()}),r.socket_connection.on("message_all_deleted",function(t){r.chat_friend_action.message_all_deleted(t)}),r.socket_connection.on("status_changed",function(t){r.status_changed(t)}),r.socket_connection.on("friend_status_changed",function(t){r.chat_friend_manager.friend_status_changed(t)}),r.socket_connection.on("is_typing",function(t){r.chat_friend_manager.is_typing(t)}),r.socket_connection.on("stop_typing",function(t){r.chat_friend_manager.stop_typing(t)}),r.socket_connection.on("set_nb_users",function(t){r.set_nb_users(t)}),r.socket_connection.on("update_report_words",function(t){r.log_and_tooltip.log_debug("update_report_words",t),"object"==typeof t.black_words&&"object"==typeof t.white_words&&(r.report_blacklist=t.black_words,r.report_whitelist=t.white_words)}),r.socket_connection.on("update_ban_words",function(t){r.log_and_tooltip.log_debug("update_ban_words",t),"object"==typeof t.ban_words&&(r.ban_words=t.ban_words)}),r.socket_connection.on("chat_error",function(t){if(r.log_and_tooltip.log_error("chat_error event",t),"undefined"==typeof t.message)return void r.log_and_tooltip.write_error({message:g.__("misc.error_please_retry")});var e="",i=t;"string"==typeof t.message&&(i={},i.message=[t]);var n;for(var s in i.message)""!=e&&(e+="<br />"),n=i.message[s],"string"==typeof n?e+=r.log_and_tooltip.encode_html_special_cars(g.__(n)):"string"==typeof n.message&&("undefined"!=typeof n.params?e+=r.log_and_tooltip.encode_html_special_cars(g.__(n.message,n.params)):e+=r.log_and_tooltip.encode_html_special_cars(g.__(n.message)));""==e&&(e=g.__("misc.error_please_retry")),r.log_and_tooltip.write_error({message:e})}),r.socket_connection.on("chat_error_no_private_key",function(t){r.log_and_tooltip.log_debug("chat_error_no_private_key"),r.no_priv_key=!0,clearTimeout(r.timeout_connection),r.log_and_tooltip.write_message_no_private_key(r.no_key_send_pass.bind(r)),i.get("chat_dont_ask_crypt_pwd")||r.chat_toggle_display(!0,!1)}),r.log_and_tooltip.log_debug("socket connection","after 3rds events"),r.socket_connection.on("chat_error_fatal",function(t){if(r.log_and_tooltip.log_error("chat_error_fatal event",t),r.reinit=!0,r.reinitChat(),"undefined"==typeof t.message)return void r.log_and_tooltip.write_error({message:g.__("misc.error_please_retry")});var e;e="undefined"!=typeof t.params?g.__(t.message,t.params):g.__(t.message),""!=e&&e!=t.message||(e=g.__("misc.error_please_retry")),r.log_and_tooltip.write_error({message:e},!0,!0)}),r.socket_connection.on("switch_server",function(t){if(r.log_and_tooltip.log_debug("switch_server event"),r.nb_switch_server++,r.reinit=!0,r.socketMaster&&r.socketMaster.disconnect(),r.socket_connection&&r.socket_connection.disconnect(),r.nb_switch_server>3)return i.set("server_connection",""),i.set("server_connection_time",0),r.log_and_tooltip.log_error("too much switch_server event"),void r.log_and_tooltip.write_error({message:g.__("chat.error.no_server_avialable")},!0,!0);r.log_and_tooltip.write_error({message:g.__("chat.error.disconnected")}),r.connect_master()}),r.log_and_tooltip.log_debug("socket connection","before connection error events"),r.socket_connection.on("disconnect",function(){if(r.log_and_tooltip.log_debug("disconnect event"),r.socket_conn_disco=!0,1!=r.reinit)return r.hasOwnProperty("not_logged")&&1==r.not_logged?void r.log_and_tooltip.write_error({message:g.__("chat.error.not_logged")}):void(!r.force_close&&r.socket_conn_disco&&r.log_and_tooltip.write_error({message:g.__("chat.error.disconnected")}))}),r.socket_connection.on("reconnect",function(){r.log_and_tooltip.log_debug("reconnect event"),r.socket_conn_disco=!1,r.socket_connection_connect_error=0,r.log_and_tooltip.overlay_close()}),r.socket_connection.on("connect_failed",function(t){r.log_and_tooltip.log_debug("SOCKET connect_failed",t)}),r.socket_connection.on("coose()}),r.socket_connection.on("connecting",function(t){r.log_and_tooltip.log_debug("SOCKET connecting",t)}),r.socket_connection.on("error",function(t){r.log_and_tooltip.log_debug("SOCKET ERROR",t)}),r.socket_connection.on("connect_error",function(t){return"websocket error"==t.message?("undefined"==typeof r.connect_websocket_nb_error&&(r.connect_websocket_nb_error=0),++r.connect_websocket_nb_error>2?(r.log_and_tooltip.log_error("websocket errors"),r.log_and_tooltip.write_error({message:g.__("chat.error.connection_adblock")}),r.socket_connection.disconnect(),void delete r.socket_connection):void r.connect_master()):(r.socket_connection_connect_error++,r.socket_connection_connected&&r.socket_connection_connect_error<4?void r.log_and_tooltip.log_important("connect_error event",r.socket_connection_connect_error+" errors in a raw"):(r.log_and_tooltip.log_important("connect_error event"),void r.connect_master()))}),r.log_and_tooltip.log_debug("connect_js_connection","after set events"),r.input.val(""),"undefined"==typeof r.event_after_connection_done){r.event_after_connection_done=!0,r.input.on("keyup",function(t){r.key_pressed(t)}),r.input.on("click",function(){r.set_read_date(r.chat_friend_manager.selected_friend)});try{emojione.sprites=!0,emojione.ascii=!0,$("#chat-textarea-message").emojioneArea({container:"#container-smiley",hideSource:!0,useInternalCDN:!0,sprite:!0,autocomplete:!0,textcomplete:{maxCount:12},attributes:{spellcheck:!0,autocorrect:"on",autocomplete:"on"},events:(e,t)}iend)}}})}catch(e){r.log_and_tooltip.log_error("emojionearea textarea init failed",e)}r.chat_friend_manager.search_input.length>0&&r.chat_friend_manager.search_input.on("keyup",function(t){r.search_key_pressed(t)}),r.chat_friend_manager.send_button.length>0&&r.chat_friend_manager.send_button.on("click",function(t){t.stopPropagation(),r.send_message()}),r.chat_friend_manager.search_button.length>0&&r.chat_friend_manager.search_button.on("click",function(t){t.stopPropagation(),r.chat_friend_manager.search_friend()}),r.search_back_button.on("click",function(t){t.stopPropagation(),r.chat_friend_manager.hide_search_list()}),this.chat_send_file.is_compatible()?($("#chat-send-file").on("click",function(t){$("#chat-file").click()}),this.last_file_uploaded={},$("#chat-file").on("change",function(t){if("undefined"!=typeof $(this)[0].files&&"undefined"!=typeof $(this)[0].files&&"undefined"!=typeof $(this)[0].files[0]){var e=$(this)[0].files[0],i={};i.position={v:"above",h:"right",trigger:!1};var n=r.chat_send_file.sanitize_filename(e.name),s="<p>"+g.__("chat.confirm_send_file",{"%filename%":n})+"</p>";s+='<p id="chat_popup_buttons"><button id="chat_popup_send_file_send">'+g.__("misc.OK")+'</button><button id="chat_popup_send_file_cancel">'+g.__("misc.cancel")+"</button></p>",r.log_and_tooltip.popup_open($("#chat-send-file"),s,i),$("#chat_popup_send_file_send").on("click",function(){if(r.log_and_tooltip.popup_close(),n==r.last_file_uploaded.filename&&r.chat_friend_manager.selected_friend==r.last_file_uploaded.friend&&"number"==typeof r.last_file_uploaded.timestamp&&(new Date).getTime()-r.last_file_uploaded.timestamp<2e3)return void console.log("double click ?");r.last_file_uploaded.filename=n,r.last_file_uploaded.friend=r.chat_friend_manager.selected_friend,r.last_file_uploaded.timestamp=(new Date).getTime(),r.chat_send_file.send_file(r.socket_connection,r.id_user,r.chat_friend_manager.selected_friend,e)}),$("#chat_popup_send_file_cancel").on("click",function(){r.log_and_tooltip.popup_close()})}})):$("#chat-send-file").on("click",function(t){var e="<p>"+g.__("misc.device_not_compatible")+"</p>",i={};i.position={v:"above",h:"right"},i.trigger=!1,r.log_and_tooltip.popup_open($("#chat-send-file"),e,i)})}$(window).resize(function(){if("undefined"!=typeof r.chat_friend_manager.selected_friend&&r.chat_friend_manager.selected_friend>0){var t=$("#chat_group_messages_tab_"+r.chat_friend_manager.selected_friend);if(0==t.length)return;t=t[0],"undefined"==typeof r.messages_from_bottom&&(r.messages_from_bottom=t.scrollHeight-t.clientHeight-t.scrollTop),$(t).scrollTop(t.scrollHeight-t.clientHeight-r.messages_from_bottom),r.messages_client_height=t.clientHeight}});var h=i.get("chat-display");void 0===h||!0!==h&&"true"!==h||setTy(!0)},500),$("#account-chat-private-container").length>0&&this.chatInitsAndPrefs.checkNotifPermissionAsked(this.setSwToken.bind(this)),r.log_and_tooltip.log_debug("connect_js_connection","end")},verifConnectionConnect:function(){this.log_and_tooltip.log_debug("verifConnectionConnect"),"undefined"==typeof this.verif_connection_done&&(this.verif_connection_done=0),++this.verif_connection_done>=3||this.socket_connection_connected||this.no_priv_key||(this.reinitChat(),this.connect_master())},no_key_send_pass:function(t){void 0!==t&&t.length>0&&this.socket_connection.emit("get_priv_key",{password:t})},user_connected:function(t){if(this.log_and_tooltip.log_debug("socket user_connected"),"undefined"!=typeof t.priv_key&&($("#chat-window .chat-icon #chat-icon-badge").remove(),this.log_and_tooltip.remove_dont_ask_password_on_chat_close(),i.set("chat-pk",t.priv_key),s.setLocal("chat_data_c","",0,"/"),this.priv_key=this.chatInitsAndPrefs.initKey(),this.chat_friend_manager.set_priv_key(this.priv_key),0==this.priv_key))return i.set("chat-pk",""),this.log_and_tooltip.log_error("no private key in local"),this.no_priv_key=!0,this.priv_key="",void($("#chat_pass_no_key_check_pass").length>0&&($("#chat_pass_no_key_check_pass").hide(),$("#chat_pass_no_key_form").show(),$("#chat_pass_no_key_error").html(g.__("error.err_please_reload"))));"undefined"!=typeof t.notifs_user_count&&null!=t.notifs_user_count&&this.chat_user_notif.set_counts(t.notifs_user_count);var e=this;if(clearTimeout(this.timeout_connection),this.display_message_old_browser||this.log_and_tooltip.overlay_close(),this.socket_connection_connected=!0,"undefined"==typeof t.infos_user)return this.log_and_tooltip.log_error("infos_user is undefined"),void this.log_and_tooltip.write_error(g.__("chat.error.no_infos_user"));if("undefined"!=typeof this.user_id&&this.user_id!=t.infos_user.id_user&&(delete this.last_friend_conv,this.chat_friend_manager.set_friends({}),this.chat_friend_manager.set_friends_id([]),this.friends_infos_from_SW=null,this.force_friend=null,this.chat_friend_manager.set_selected_friend(0),$("#chat-users-lists .list-group-item").remove(),$("#chat_loading_overlay").show()),this.user_id=t.infos_user.id_user,this.profile_name=t.infos_user.profile_name,this.chat_friend_action.set_user_infos(t.infos_user.id_user,t.infos_user.profile_name),this.chat_friend_manager.set_user_id(t.infos_user.id_user),this.profile_picture=t.infos_user.profile_picture,this.nb_unread_messages=t.nb_unread_messages,this.nb_unread_messages_sum=t.nb_unread_messages_sum,this.updateTotalNbUnread(t.nb_unread_messages_sum),"undefined"==typeof t.unread_message_friends&&(t.unread_message_friends=[]),this.unread_message_friends=t.unread_message_friends,"undefined"!=typeof t.keys_create_timestamp&&t.keys_create_timestamp==parseInt(t.keys_create_timestamp)&&this.chat_friend_manager.set_keys_create_timestamp(parseInt(t.keys_create_timestamp)),this.chat_friend_action.friend_requests_html(t),null!==this.friends_infos_from_SW||$.isEmptyObject(this.chat_friend_manager.friends)||0==this.chat_friend_manager.friends_ids.length||(this.friends_infos_from_SW=this.chat_friend_manager.friends),"undefined"!=typeof this.chatInitsAndPrefs.sw_token&&""!=this.chatInitsAndPrefs.sw_token&&this.setSwToken(this.chatInitsAndPrefs.sw_token),$("div.chat-loader").hide(),null!==this.friends_infos_from_SW?this.socket_connection.emit("send_online_and_get_friends_online",{friends_ids:this.chat_friend_manager.friends_ids,invisible:"Invisible"==this.chatInitsAndPrefs.status}):this.socket_connection.emit("get_allusersids_and_firstusersinfos",{invisible:"Invisible"==this.chatInitsAndPrefs.status}),s.setLocal(this.cookie_deco_name,0,0,"/"),this.check_deco_interval=setInterval(function(){e.check_cookie_deco()},this.interval_check_deco),"undefined"!=typeof t.ban_words&&(this.ban_words=t.ban_words),"undefined"!=typeof t.report_blacklist&&(this.report_blacklist=t.report_blacklist),"undefined"!=typeof t.report_whitelist&&(this.report_whitelist=t.report_whitelist),this.chatInitsAndPrefs.serviceWorkerRegistration)try{this.chatInitsAndPrefs.serviceWorkerRegistration.postMessage({action:"set_id_user",id_user:t.infos_user.id_user})}catch(e){this.log_and_tooltip.log_error("Failed to send id_user to SW")}},check_cookie_deco:function(){1==s.get(this.cookie_deco_name)&&(clearInterval(this.check_deco_interval),this.reinitChat())},get_online_friends:function(e){if(this.log_and_tooltip.log_debug("get_online_friends"),!e.hasOwnProperty("friends_online"))return this.log_and_tooltip.log_debug("get_online_friends","parameter friends_online missing"),void this.connect_and_friends_done(this.friends_infos_from_SW);"undefined"!=typeof e.friends_id&&this.chat_friend_manager.set_friends_id(e.friends_id);var i=[];for(var n in e.friends_online)"undefined"!=typeof this.friends_infos_from_SW[e.friends_online[n]]?this.friends_infos_from_SW[e.friends_online[n]].status="Online":i.push(e.friends_online[n]);for(var r in this.friends_infos_from_SW)-1===e.friends_online.indexOf(parseInt(r))&&(this.friends_infos_from_SW[r].status="Offline"),this.friends_infos_from_SW[r].nb_unread=0,this.nb_unread_messages.hasOwnProperty(r)&&(this.friends_infos_from_SW[r].nb_unread=this.nb_unread_messages[r]);for(var s=0;i.length>0&&s<5;)this.socket_connection.emit("get_users_infos",{friends_ids:i.splice(0,99),is_premium:t.dyn.is_premium}),s++;this.connect_and_friends_done(this.friends_infos_from_SW)},get_users_allids_and_first_infos:function(t){if("undefined"==typeof t.friends_ids||"undefined"==typeof t.first_friends_infos)return this.log_and_tooltip.write_error(g.__("chat.error.unable_get_friends")),!1;if(this.log_and_tooltip.log_debug("get_users_allids_and_first_infos",t.first_friends_infos),this.chat_friend_manager.set_friends_id(t.friends_ids),this.connect_and_friends_done(t.first_friends_infos),this.chatInitsAndPrefs.serviceWorkerRegistration)try{this.chatInitsAndPrefs.serviceWorkerRegistration.postMessage({action:"set_friends",friends_ids:t.friends_ids,first_friends_infos:t.first_friends_infos})}catch(e){this.log_and_tooltip.log_error("Failed to send friends_ids to SW")}},connect_and_friends_done:function(e){this.log_and_tooltip.log_debug("connect_and_friends_done");var i=this;if(T.setLogAndTooltip(this.log_and_tooltip),T.getInstance().setSocket(this.socket_connection),i.input.prop("disabled",!1),i.chat_friend_manager.search_input.prop("disabled",!1),i.chat_friend_manager.send_button.prop("disabled",!1),i.chat_friend_manager.search_button.prop("disabled",!1),"undefined"==typeof this.link_outside_done&&t.hasOwnProperty("data")&&t.data.hasOwnProperty("user")&&t.data.user.hasOwnProperty("id_user")){if(this.link_outside_done=!0,xv.chat.infos.link_outside_done=!0,"undefined"!=typeof xv.chat.infos.to_set_chat_toggle_link_outside_done){console.log("xv.chat.infos.to_set_chat_toggle_link_outside_done",xv.chat.infos.to_set_chat_toggle_link_outside_done);for(var n in xv.chat.infos.to_set_chat_toggle_link_outside_done){var r=xv.chat.infos.to_set_chat_toggle_link_outside_done[n];xv.chat.actions.set_chat_toggle(r.elem),"function"==typeof r.setted_func&&r.setted_func()}}$("#profile-title .profile-pic .external-link").addClass("mobile-hide");var s=$(".has-banner .chat-toggle-button-outside");if(s.length>0){var o=function(){s.each(function(){$(this).css("left",$(".has-banner .profile-pic img:first").width()-$(this).width()+2)})};$(window).resize(o),o()}$(".chat-toggle-button-outside").css("display","inline-block").on("click",function(t){t.stopPropagation(),i.chat_toggle_display()}),-1==this.chat_friend_manager.friends_ids.indexOf(t.data.user.id_user)&&t.data.user.id_user!=this.user_id&&"undefined"!=typeof this.socket_connection&&this.socket_connection.emit("check_pending_request",{friend_id:t.data.user.id_user})}if(0===e.length)return this.chat_friend_manager.userlistfavorite.append('<a class="chat_no_friends">'+g.__("chat.infos.no_friends")+"</a>"),void $("#chat_loading_overlay").hide();var a=$.map(e,function(t,e){return t});a.sort(this.chat_friend_manager.sort_friends);var c=!1;this.force_friend?c=this.force_friend:t.hasOwnProperty("data")&&t.data.hasOwnProperty("user")&&t.data.user.hasOwnProperty("id_user")?c=t.data.user.id_user:"undefined"!=typeof this.last_friend_conv&&0!==this.last_friend_conv?c=this.last_friend_conv:"undefined"!=typeof this.chat_friend_manager.selected_friend&&0!=this.chat_friend_manager.selected_friend&&(c=this.chat_friend_manager.selected_friend);var d=this.unread_message_friends;for(var n in a)a[n].id_user==c?this.chat_friend_manager.add_friend(a[n],!0):this.chat_friend_manager.add_friend(a[n]),index_friend_unread=d.indexOf(a[n].id_user),-1!==index_friend_unread&&d.splice(index_friend_unread,1);var h=[];for(var _ in this.chat_friend_manager.friends)h.push(_);if(h.length<this.chat_friend_manager.friends_ids.length&&this.chat_friend_manager.addlink_more_friends(),this.force_friend&&this.chat_friend_manager.select_friend(this.force_friend),this.chat_friend_manager.selected_friend)if(this.chat_friend_manager.friends.hasOwnProperty(this.chat_friend_manager.selected_friend)){var l=this.chat_friend_manager.get_selected_friend_infos();"undefined"==typeof l.conversation_key&&this.socket_connection.emit("get_conv_key",{id_friend:this.chat_friend_manager.selected_friend})}else this.socket_connection.emit("getuserinfos",{friend_id:this.chat_friend_manager.selected_friend,callback_obj:{open_tab:!0}});else c&&(this.chat_friend_manager.friends.hasOwnProperty(c)?this.chat_friend_manager.select_friend(c):-1!==this.chat_friend_manager.friends_ids.indexOf(c)&&this.socket_connection.emit("getuserinfos",{friend_id:c,callback_obj:{open_tab:!0}}));for(var u=0;d.length>0&&u<5;)this.socket_connection.emit("get_users_infos",{friends_ids:d.splice(0,99),is_premium:t.dyn.is_premium}),u++;this.socket_connection.emit("get_nb_users"),this.set_interval_nb_users(),$("#chat_loading_overlay").hide()},set_interval_nb_users:function(){if(this.opened){if(null==this.interval_check_nb_user_function){var t=this;this.interval_check_nb_user_function=setIners")},this.interval_check_nb_user)}}else null!=this.interval_check_nb_user_function&&(clearInterval(this.interval_check_nb_user_function),this.interval_check_nb_user_function=null)},set_nb_users:function(t){if("undefined"==typeof t.nb_users||!parseInt(t.nb_users)||0==parseInt(t.nb_users))return void this.log_and_tooltip.log_error("set_nb_users","bad nb_users : "+parseInt(t.nb_users));var e=$("#chat-window .chat-title .chat-nb-users"),i=this;this.nb_users_display=a.formatNumberUnits(parseInt(t.nb_users),0),e&&0!=e.length||($("#chat-window .chat-title .chat-icon-home").after('<div class="chat-nb-users"><div class="chat-nb-users-count"></div><div class="chat-nb-users-icon icon-f icf-users">&nbsp;</div></div>'),$("#chat-window .chat-title .chat-nb-users").on("click",function(t){t.stopPropagation(),"undefined"!=typeof i.nb_users_display&&0!=i.nb_users_display&&i.log_and_tooltip.popup_open($("#chat-window .chat-title .chat-nb-users"),"<p class='message'>"+g.__("chat.infos.nb_users_on_chat",{"%nb_users%":i.nb_users_display.toString()})+"</p>")}),e=$("#chat-window .chat-title .chat-nb-users"));var n=$("#chat-window .chat-title .chat-nb-users .chat-nb-users-count");n&&0!=n.length&&(n.html(this.nb_users_display),e&&e.length>0&&$(e[0]).prop("title",g.__("chat.infos.nb_users_on_chat",{"%nb_users%":this.nb_users_display})))},get_conversation:function(t,e,i,n){this.log_and_tooltip.log_debug("get_conversation",t+" "+e),void 0!==i&&null!==i&&$(i).remove(),void 0===e&&(e=0),void 0!==n&&null!==n||(n=!1),$("#chat_group_messages_tab_"+t).prepend('<div class="div_load_history">'+c.getImg()+"</div>"),this.socket_connection.emit("get_conversation_friend",{sender_id:this.user_id,recipient_id:t,offset:e,report:n})},put_history:function(t){this.log_and_tooltip.log_debug("put history",t),0!=$("div.div_load_history").length&&$("div.div_load_history").remove();var e="chat_group_messages_tab_"+t.recipient_id,i=this.chat_friend_manager.get_friend_infos(t.recipient_id),n=this;if(this.chat_friend_manager.decrypt_conv_keys(t),i.is_sheer_creator&&!i.is_subscribed||(this.chat_friend_manager.send_button.prop("disabled",!1),this.chat_friend_manager.send_button.removeClass("disabled")),this.chat_friend_manager.set_friend_attribut(t.recipient_id,"load_history",!1),$("#"+e+" li.chat-no-messages").remove(),$.isEmptyObject(t.conversations))return void(0==$("#"+e+" > li").length&&$("#"+e).append('<li class="chat-no-messages">'+g.__("chat.infos.no_history")+"</li>"));if(!1===i)return void this.log_and_tooltip.write_error({message:g.__("misc.error_please_retry")});var r=!0;if($("#"+e+" > li").length>0){r=!1;var s=$("#"+e)[0].scrollHeight-$("#"+e)[0].scrollTop}$("#history_"+t.recipient_id).remove();var o={};o[t.recipient_id]=i,o[this.user_id]={},o[this.user_id].profile_name=this.profile_name,o[this.user_id].profile_picture=this.profile_picture;var a=0,c=null,d=0,h=0,_=!1,l=this.chat_friend_manager.can_crypt(t.recipient_id),u=[];if(r)for(var f in t.conversations){var p=this.check_display_message(t.conversations[f].m,t.conversations[f].t,t.recipient_id);0!==p&&(!1!==p?(1!==p||!l||"undefined"!=typeof t.conversations[f].y&&"f"!=t.conversations[f].y||u.push(t.conversations[f]),null!==c&&"f"!==c||!(t.conversations[f].t-d<this.time_for_message_group)||h!==t.conversations[f].s||0==d||"undefined"!=typeof t.conversations[f].y&&"f"!=t.conversations[f].y?$("#"+e).append(this.message_html(t.conversations[f].id,t.conversations[f].m,t.conversations[f].s,o[t.conversations[f].s].profile_name,o[t.conversations[f].s].profile_picture,t.conversations[f].t,i,t.conversations[f].y)):$("#chat_message_"+a).parent().append(this.message_inside_html(t.conversations[f].id,t.conversations[f].m,t.conversations[f].s,t.conversations[f].t,i,t.conversations[f].y)),a=t.conversations[f].id,d=t.conversations[f].t,h=t.conversations[f].s,c=t.conversations[f].y,this.chat_friend_manager.set_friend_last_message_infos(t.recipient_id,t.conversations[f].t,t.conversations[f].id,t.conversations[f].s)):_=!0)}else{first_li=$("#"+e+" > li").first();for(var f in t.conversations){var p=this.check_display_message(t.conversations[f].m,t.conversations[f].t,t.recipient_id);0!==p&&(!1!==p?(1!==p||!l||"undefined"!=typeof t.conversations[f].y&&"f"!=t.conversations[f].y||u.push(t.conversations[f]),t.conversations[f].t-d<this.time_for_message_group&&h===t.conversations[f].s&&0!=d&&("undefined"==typeof t.conversations[f].y||"f"==t.conversations[f].y)?$("#chat_message_"+a).parent().append(this.message_inside_html(t.conversations[f].id,t.conversations[f].m,t.conversations[f].s,t.conversations[f].t,i,t.conversations[f].y)):$(this.message_html(t.conversations[f].id,t.conversations[f].m,t.conversations[f].s,o[t.conversations[f].s].profile_name,o[t.conversations[f].s].profile_picture,t.conversations[f].t,i,t.conversations[f].y)).insertBefore(first_li),a=t.conversations[f].id,d=t.conversations[f].t,h=t.conversations[f].s):_=!0)}}this.chat_friend_manager.set_friend_attribut(t.recipient_id,"first_timestamp",t.conversations[0].t);var n=this;if(_?$("#"+e).prepend('<div class="cannot_decrypt_previous"><span>'+g.__("chat.previous_messages_cannot_decrypted")+"</span></div>").find("#history_"+t.recipient_id).on("click",function(){n.get_conversation(t.recipient_id,t.conversations[0].t-1,this)}):("undefined"==typeof t.more_conversation||t.more_conversation)&&$("#"+e).prepend('<div id="history_'+t.recipient_id+'" class="get_history" ><span class="icon history">&nbsp;</span><span>'+g.__("chat.get_more_conversation")+"</span></div>").find("#history_"+t.recipient_id).on("click",function(){n.get_conversation(t.recipient_id,t.conversations[0].t-1,this)}),r?this.scroll_down_conversation(t.recipient_id):$("#"+e).scrollTop($("#"+e)[0].scrollHeight-s),this.set_read_date(t.recipient_id,!0),t.hasOwnProperty("report")&&t.report&&t.report.hasOwnProperty("message_id")&&t.report.hasOwnProperty("block")&&t.report.hasOwnProperty("user")){var m=$("#chat_group_messages_tab_"+t.recipient_id+" #"+t.report.message_id+" .chat_message_report");m.length>0&&this.chat_friend_action.report_message_send(m[0],t.report.block,t.report.user,t.recipient_id,i)}if(u=[],u.length>0){for(var f in u)u[f].m.length>=21&&"chatcrypt1"==u[f].m.substring(0,10)&&"1tpyrctahc"==u[f].m.substring(m.length-10)?u.splice(f,1):u[f].mc=this.make_real_message(u[f].m,t.recipient_id);this.socket_connection.emit("crypt_some_old_messages",{id_friend:t.recipient_id,messages:u})}},message_html:function(t,e,i,n,r,s,o,a){return"i"==a?(this.message_internal(t,this.get_real_message(e,s,o.id_user),i,n,s,o),""):this.message_html_all(t,e,i,n,r,s,o,a,!1)},message_inside_html:function(t,e,i,n,r,s){return this.message_html_all(t,e,i,"","",n,r,s,!0)},message_for_upload_progress_bar:function(t,e,i){var n=this.message_html_all("upload_bar_"+t,"Encrypting file ...",this.user_id,this.profile_name,this.profile_picture,(new Date).getTime()/1e3,this.chat_friend_manager.get_friend_infos(i),"js",!1);n.find(".chat_message.message_right").html(e),$("#chat_group_messages_tab_"+i).append($(n))},message_html_all:function(t,e,i,r,s,o,a,c,d){var u={};u.class_date="",u.class_name="",u.message_from="",i===this.user_id?(u.class_li="message_right",u.class_actions="pull-left",u.class_name="header_message_right",u.message_from="me"):(u.class_li="message_left",u.class_actions="pull-right",u.class_name="header_message_left",u.message_from="friend"),u.class_date="pull-right",u.message_id=t,u.message=this.get_real_message(e,o,a.id_user),u.user_id=i,u.user_name=r,u.user_picture=s,u.last_read=a.last_read,u.not_read=i!==this.user_id&&("undefined"==typeof u.last_read||u.last_read<o),u.has_delete=i===this.user_id,u.time=this.format_timestamp(o),u.class_multi=d?"message_multi":"";var p,m=this;if(void 0===c||"f"===c||"c"===c||"js"===c){var v;if(u.message.startsWith("{")&&u.message.endsWith("}"))try{v=JSON.parse(u.message)}catch(e){}if(v&&v.q){var y=parseInt(v.t);u.message=v.m,u.message_report='"'+v.m+'" – '+v.aN+", "+this.format_timestamp(y),d=!1,u.class_multi="",u.user_name=a.profile_name,u.quote=n.render(l,{modifier:"message",enable_refresh_rt:Date.now()-1e3*o<864e5,content:"<p>"+v.q+"</p>",time:this.format_timestamp(y),timestamp:y,relative_time:this.format_timestamp_relative(y),user_id:v.aI||"",user_name:v.aN||""})}v&&"c"===c&&(u.message_html=T.getInstance().getTempContentHtml(u,v),delete u.message),p=d?$(n.render(_,u)):$(n.render(h,u,{inside:_}))}else if("s"==c){var b,w="";try{b=JSON.parse(u.message)}catch(e){return this.log_and_tooltip.log_debug("system message: failed to parse JSON"),""}if("undefined"==typeof b.trad&&"undefined"==typeof b.raw)return"";if("undefined"!=typeof b.trad){var k={};if("undefined"!=typeof b.param)for(var S in b.param)"undefined"!=typeof b.param[S].trad?k[S]=g.__(b.param[S].trad):"undefined"!=typeof b.param[S].raw&&(k[S]=b.param[S].raw);w=$("<textarea />").html(g.__(b.trad,k)).text()}else w=$("<textarea />").html(b.raw).text();if(""==w)return"";u.message=w,p=$(n.render(f,u))}p.find(".remove-message a").on("click",function(e){e.preventDefault(),m.ask_delete_message(t)});var E=p;d||(E=p.find("#chat_message_"+t)),$("html").hasClass("notouch")&&(E.on("mouseover",function(){$("#chat_message_"+t+" .report-message").show()}),E.on("mouseout",function(){$("#chat_message_"+t+" .report-message").hide()})),E.on("mouseover",function(){$("#chat_message_"+t+" .remove-message").show()}),E.on("m.hide()}),p.find(".report-message a").on("click",function(t){t.preventDefault(),t.stopPropagation(),m.chat_friend_action.report_message(this,i,a)});var x=p.find(".chat_message").html();if(x){var A=emojione.shortnameToImage(x),C=$.parseHTML(A);if(1==C.length&&"SPAN"==C[0].nodeName){var D=$(C[0]);D.addClass("emoji-only"),"undefined"!=typeof D[0]&&"undefined"!=typeof D[0].outerHTML&&(A=D[0].outerHTML)}p.find(".chat_message").html(A)}return void 0!==c&&"f"!=c||(this.checkMessageForPreview("chat_message_"+t,u.message,a.id_user),this.chat_send_file.check_for_upload(p,u.message,this.user_id,a.id_user,"chat_message_"+t,this.key_decrypt_last_message,u.not_read,o)),p},format_timestamp_relative:function(t,e){var i=Date.now()/1e3-t/(e?1e3:1),n=i>=0?"":"in ",r=i>=0?"ago":"medium";return n+a.formatDuration(Math.abs(i),r)},message_internal:function(t,e,i,n,r,s){var o=v.execute_action(this,t,e,i,r,s);return!0===o||("undefined"!=typeof o.error&&this.log_and_tooltip.log_debug("chat_internal_message",o.error),!1)},check_display_message:function(t,e,i){return t.length<21||"chatcrypt1"!=t.substring(0,10)||"1tpyrctahc"!=t.substring(t.length-10)?1:!!this.get_real_message_try_decrypt(t,e,i)||("undefined"==typeof this.chat_friend_manager.keys_create_timestamp||e>this.chat_friend_manager.keys_create_timestamp)&&0},get_real_message:function(t,e,i){var n=this.get_real_message_decrypt(t,e,i);return this.log_and_tooltip.log_debug("get_real_message",n),"string"!=typeof n&&(n=g.__("chat.unable_decrypt")),this.escape_javascript(n)},escape_javascript:function(t){return t=t.replace(/&/g,"&amp;").replace(/\//g,"&#x2F;"),t=t.replace(/\</g,"&lt;").replace(/\>/g,"&gt;"),t=t.replace(/\'/g,"&#x27;").replace(/\"/g,"&quot;"),$("<textarea />").html(t).text()},get_real_message_decrypt:function(t,e,i){var n=t.substring(0,2);if("c-"===n)return t.substring(2);if("x-"!==n&&(t.length<21||"chatcrypt1"!=t.substring(0,10)||"1tpyrctahc"!=t.substring(t.length-10)))return t;var r=this.chat_friend_manager.get_friend_infos(i);return!1===r||"undefined"==typeof r.conversation_key&&!r.is_sheer_creator?("false"===r||"undefined"!=typeof r.new_conv_key_asked&&!0===r.new_conv_key_asked||(this.chat_friend_manager.set_friend_attribut(i,"new_conv_key_asked",!0),this.socket_connection.emit("get_conv_key",{id_friend:i})),g.__("chat.unable_decrypt")+" "+g.__("misc.reload_the_page")):(t=this.get_real_message_try_decrypt(t,e,i),!1===t?g.__("chat.unable_decrypt"):t)},get_real_message_try_decrypt:function(t,e,i){t="x-"===t.substring(0,2)?t.substring(2):t.substring(10,t.length-10);var n=[],r=this.chat_friend_manager.get_friend_infos(i);for(var s in r.conversation_key)null!=r.conversation_key[s]&&n.push(r.conversation_key[s]);var o;this.key_decrypt_last_message="";for(var a in n){try{o=m.AES.decrypt(t,n[a]).toString(m.enc.Utf8),this.key_decrypt_last_message=n[a]}catch(e){continue}if(o)break}return o||!1},make_real_message:function(t,e){if(t=emojione.toShort(t),this.chat_friend_manager.get_friend_infos(e).disable_encryption)return"c-"+t;var i=this.get_last_conv_key(e);if(""===i)return"c-"+t;try{var n=m.AES.encrypt(t,i).toString()}catch(e){return this.log_and_tooltip.log_error("Failed to encrypt message"),"c-"+t}return"x-"+n},get_last_conv_key:function(t){var e=this.chat_friend_manager.get_friend_infos(t);if(e.is_sheer_creator)return void this.log_and_tooltip.log_debug("get_last_conv_key skip it because sheer creator");if(!1===e)return this.log_and_tooltip.log_error("Failed to encrypt message, no friend infos"),"";if("undefined"==typeof e.conversation_key)return this.log_and_tooltip.log_error("Failed to encrypt message, no friend keys"),"";var i="";for(var n in e.conversation_key)n>i&&null!=e.conversation_key[n]&&(i=n);return""==i?(this.log_and_tooltip.log_error("Failed to encrypt message, no decryptable friend keys"),""):e.conversation_key[i]},checkMessageForPreview:function(t,e,i){var n=$("#chat_group_messages_tab_"+i);0!=n.length&&(n=n[0],
w(t,e,i,n,this.chat_friend_manager.selected_friend,this.preloader,this.scroll_down_conversation.bind(this),this.log_and_tooltip))},scroll_down_conversation:function(t){this.log_and_tooltip.log_debug("scroll_down_conversation",t),"undefined"!=typeof $("#chat_group_messages_tab_"+t)[0]&&$("#chat_group_messages_tab_"+t).scrollTop($("#chat_group_messages_tab_"+t)[0].scrollHeight)},scroll_conversation_is_down:function(t){if(0==$("#chat_group_messages_tab_"+t).length)return!1;var e=$("#chat_group_messages_tab_"+t)[0];return Math.abs(e.scrollHeight-e.scrollTop-e.clientHeight)<10},set_read_date:function(t,e,i){if(this.log_and_tooltip.log_debug("set_read_date "+t),this.chatInitsAndPrefs.set_timer_away(),0==t)return void this.log_and_tooltip.log_debug("id_user = 0");var n=this.chat_friend_manager.get_friend_infos(t);if(0==n.nb_unread)return void this.log_and_tooltip.log_debug("set_read_date","no need : 0 messages unread");void 0!==e&&!1!==e||this.socket_connection.emit("set_read_date",{type:"friend",id:t});var r=$("#chat_group_messages_tab_"+t).find(".chat_message_status_not_read");setTimeout(function(){r.remove()},6e3);var s=Math.round((new Date).getTime()/1e3);if(!1!==n&&(this.chat_friend_manager.set_friend_attribut(t,"last_read",s),void 0!==i&&!1!==i||(total_unread=this.nb_unread_messages_sum-n.nb_unread,total_unread<0&&(total_unread=0),this.updateTotalNbUnread(total_unread),n.nb_unread=0,this.update_badge(t)),this.chat_friend_manager.userlistnotread.find(".user"+t).length>0&&($(".user"+t).remove(),this.chat_friend_manager.add_friend(n,!0))),this.chatInitsAndPrefs.serviceWorkerRegistration)try{this.chatInitsAndPrefs.serviceWorkerRegistration.postMessage({action:"update_friend_last_read",friend_id:t,friend_last_read:s})}catch(e){this.log_and_tooltip.log_error("Failed to send update_friend_last_read to SW")}},read_date_set:function(t){if(this.log_and_tooltip.log_debug("read_date_set",t),"undefined"==typeof t.id)return void this.log_and_tooltip.log_error("read_date_set","missing id");if("undefined"==typeof t.type)return void this.log_and_tooltip.log_error("read_date_set","type");var e=this.chat_friend_manager.get_friend_infos(t.id);if(!(!1===e||"undefined"==typeof e.nb_unread||parseInt(e.nb_unread)<=0)){var i=$("#chat_group_messages_tab_"+t.id).find(".chat_message_status_not_read");setTimeout(function(){i.remove()},6e3);var n=Math.round((new Date).getTime()/1e3);this.chat_friend_manager.set_friend_attribut(t.id,"last_read",n),total_unread=this.nb_unread_messages_sum-e.nb_unread,total_unread<0&&(total_unread=0),this.updateTotalNbUnread(total_unread),this.chat_friend_manager.set_friend_attribut(t.id,"nb_unread",0),this.update_badge(t.id),this.chat_friend_manager.userlistnotread.find(".user"+t.id).length>0&&($(".user"+t.id).remove(),this.chat_friend_manager.add_friend(e,!0))}},update_badge:function(t){this.log_and_tooltip.log_debug("update_badge",t);var e=0,i=this.chat_friend_manager.get_friend_infos(t);!1!==i&&"undefined"!=typeof i.nb_unread&&(e=i.nb_unread),$("#select_friend_li_"+t+" span.badge").remove(),0!==e&&($("#select_friend_li_"+t+"  .chat_status_nb_unread").prepend('<span class="badge">'+e+"</span>"),this.log_and_tooltip.log_debug("update",e))},updateTotalNbUnread:function(t){var e=parseInt(t);if(e!=t||e<0)return void this.log_and_tooltip.log_error("updateTotalNbUnread","bad value for nb_unread : "+t);this.nb_unread_messages_sum=e,$(".chat-title > .badge").remove(),0!==e&&this.title.append('<span class="badge">'+e+"</span>")},send_message:function(){if(this.log_and_tooltip.log_debug("send message to "+this.chat_friend_manager.selected_friend,this.input.val()),this.chatInitsAndPrefs.set_timer_away(),this.chat_friend_manager.get_friend_infos(this.chat_friend_manager.selected_friend).load_history)return void this.log_and_tooltip.log_debug("send message","loading history");if(""===this.input.val().trim())return void this.log_and_tooltip.log_debug("send message","textarea empty");if(0==this.chat_friend_manager.selected_friend)return void this.log_and_tooltip.log_error("send message","no friend selected");var t={};if(t.position={v:"above",h:"right",trigger:!1},this.input.val().trim().length>=1e3)return void this.log_and_tooltip.popup_open($("#chat-window #chat-send-btn"),"<p>"+g.__("chat.error.message_too_long",{"%nb_chars%":"1000"})+"</p>",t);var e=this.input.val().trim();if(!this.check_auto_report_and_ban(e)){var i=this.chat_friend_manager.get_friend_infos(this.chat_friend_manager.selected_friend);if(!i.is_sheer_creator&&"undefined"==typeof i.conversation_key)return this.log_and_tooltip.popup_open($("#chat-window #chat-send-btn"),"<p>"+g.__("chat.unable_crypt")+"</p><p>"+g.__("chat.unable_crypt_friend_friend_key")+"</p>",t),void this.log_and_tooltip.log_error("Failed to encrypt message, no friend keys");var n=this.make_real_message(e,this.chat_friend_manager.selected_friend);if(e==n)return this.log_and_tooltip.popup_open($("#chat-window #chat-send-btn"),"<p>"+g.__("chat.unable_crypt")+"</p>",t),void this.log_and_tooltip.log_error("popup unable_crypt");var r=this,s=this.chat_friend_manager.selected_friend;this.chat_friend_manager.friends[s].sending=!0,$("#chat-send-btn").prop("disabled",!0),setTimeout(function(){r.chat_friend_manager.friends[s].sending&&$("#chat-send-btn-loader").show()},500),this.socket_connection.emit("send_message",{message:n,recipient_id:this.chat_friend_manager.selected_friend}),this.input.val(""),$("#container-smiley .emojionearea-editor").empty(),$("#container-smiley .emojionearea-editor").focus(),this.socket_connection.emit("typing_stop",{id_friend:this.chat_friend_manager.selected_friend})}},check_auto_report_and_ban:function(t){this.log_and_tooltip.log_debug("check_auto_report_and_ban",t);var e=t;if("undefined"!=typeof this.ban_words&&"undefined"!=typeof this.ban_words.length&&this.ban_words.length>0)for(var i in this.ban_words)if(-1!=e.indexOf(this.ban_words[i].toLowerCase()))return this.log_and_tooltip.log_debug("check_auto_report_and_ban","send autoban"),this.socket_connection.emit("auto_ban",{message:t}),!0;e=this.cleanup_words(t);var n,r,s,o,a=!1;if("undefined"!=typeof this.report_blacklist&&"undefined"!=typeof this.report_blacklist.length&&this.report_blacklist.length>0)for(var i in this.report_blacklist)if(n=this.report_blacklist[i].split("*"),r=0,"undefined"!=typeof n.length&&0!=n.length){o=0;for(var c=0;c<n.length;c++)-1!==(s=e.indexOf(n[c].toLowerCase(),r))&&(o++,r=s);if(o==n.length){a=!0;break}}if(!1===a)return!1;if("undefined"!=typeof this.report_whitelist&&"undefined"!=typeof this.report_whitelist.length&&this.report_whitelist.length>0)for(var i in this.report_whitelist)if(n=this.report_whitelist[i].split("*"),r=0,"undefined"!=typeof n.length&&0!=n.length){o=0;for(var c=0;c<n.length;c++)-1!==(s=e.indexOf(n[c].toLowerCase(),r))&&(o++,r=s);if(o==n.length)return!1}if(!a)return!1;var d=$("#chat_group_messages_tab_"+this.chat_friend_manager.selected_friend+" .chat_message_report"),h=this.chat_friend_action.get_messages_for_report(d,d.length,this.chat_friend_manager.get_selected_friend_infos()),_={id_user:this.user_id,name:this.profile_name,message:t,reported:!0};h.push(_),this.socket_connection.emit("auto_report",{messages:JSON.stringify(h)})},cleanup_words:function(t){return t=t.toLowerCase(),t=t.replace(/'s/g,"s"),t=t.replace(/_/g," "),t=t.replace(/-/g," "),t=t.replace(/\./g," ")},receive_message:function(t){if(this.log_and_tooltip.log_debug("receive message",t),"undefined"==typeof t.message_id)return void this.log_and_tooltip.log_error("data.message_id is undefined");if("undefined"==typeof t.sender_id)return void this.log_and_tooltip.log_error("data.sender_id is undefined");if("undefined"==typeof t.recipient_id)return void this.log_and_tooltip.log_error("data.recipient_id is undefined");if("undefined"==typeof t.message)return void this.log_and_tooltip.log_error("data.message is undefined");var e=parseInt(t.recipient_id)===this.user_id?parseInt(t.sender_id):parseInt(t.recipient_id),i=this.chat_friend_manager.get_friend_infos(e);if(!1!==i&&"undefined"!=typeof i.not_friend&&i.not_friend)return this.log_and_tooltip.log_error("receive message from a non friend"),void this.socket_connection.emit("getuserinfos",{friend_id:e,callback_obj:{new_message:!0}});if(!1===i)return this.log_and_tooltip.log_error("receive message from an unknown friend. Ask for informations for user "+e),void this.socket_connection.emit("getuserinfos",{friend_id:e,callback_obj:{new_message:!0}});if(this.chat_friend_manager.set_friend_attribut(e,"interaction",Math.round((new Date).getTime()/1e3)),this.chat_friend_manager.set_friend_attribut(t.id,"nb_unread",0),t.sender_id!=this.user_id&&("undefined"==typeof t.type||"f"==t.type)&&(this.chatInitsAndPrefs.play_notif(),$("#select_friend_li_"+e).remove(),this.chat_friend_manager.add_friend(i,!0),this.chat_friend_manager.friend_add_unread(e),this.update_badge(e),this.updateTotalNbUnread(this.nb_unread_messages_sum+1),$("#select_friend_li_"+e).remove(),this.chat_friend_manager.add_friend(i),0===$("#chat_messages_tab_"+e).length))return void this.log_and_tooltip.log_error("no tab for this friend");if($("#chat_group_messages_tab_"+e+" .chat-no-messages").remove(),this.add_message_friend(t.message_id,e,t.sender_id,t.message,Math.round((new Date).getTime()/1e3),t.type),t.sender_id!=this.user_id&&t.sender_id!=this.chat_friend_manager.selected_friend||!this.opened||document.hidden||this.set_read_date(e,!1,!0),t.sender_id==this.user_id&&i.sending&&(i.sending=!1,$("#chat-send-btn-loader").hide(),$("#chat-send-btn").prop("disabled",!1)),this.chatInitsAndPrefs.serviceWorkerRegistration)try{this.chatInitsAndPrefs.serviceWorkerRegistration.postMessage({action:"update_friend_interaction",friend_id:e,friend_interaction:i.interaction})}catch(e){this.log_and_tooltip.log_error("Failed to send update_friends_interaction to SW")}},add_message_friend:function(t,e,i,n,r,s){this.log_and_tooltip.log_debug("add_message_friend");var o=$("#chat_group_messages_tab_"+e);if(0===o.length)return void this.log_and_tooltip.log_error("add_message_friend","No tab for this friend");var a=this.chat_friend_manager.get_friend_infos(e);if(!1===a)return void this.log_and_tooltip.log_error("add_message_friend","No informations for this friend");var c=this;i!=this.user_id&&(c=a);var d=o[0],h=Math.abs(d.scrollHeight-d.scrollTop-d.clientHeight)<10;"undefined"!=typeof a.last_timestamp&&r-a.last_timestamp<this.time_for_message_group&&a.last_id_sender===i&&(void 0===s||"f"==s)&&$("#chat_message_"+a.last_id_message).length?$("#chat_message_"+a.last_id_message).parent().append(this.message_inside_html(t,n,i,r,a,s)):o.append(this.message_html(t,n,i,c.profile_name,c.profile_picture,r,a,s)),this.chat_friend_manager.set_friend_last_message_infos(e,r,t,i),h&&this.scroll_down_conversation(e)},setuserinfos:function(t){this.log_and_tooltip.log_debug("setuserinfos");var e=!1;"undefined"!=typeof t.callback_obj.new_message&&!0===t.callback_obj.new_message&&(e=!0),"undefined"!=typeof t.callback_obj.open_tab&&!0===t.callback_obj.open_tab&&(e=!0);var n=t.friendlist.shift();if(void 0===n||"undefined"==typeof n.id_user)return void this.log_and_tooltip.log_error("setuserinfos","no friend infos found");if(this.chat_friend_manager.add_friend(n,e),this.chat_friend_manager.selected_friend&&n.id_user==this.chat_friend_manager.selected_friend){"undefined"==typeof this.chat_friend_manager.get_selected_friend_infos().conversation_key&&this.socket_connection.emit("get_conv_key",{id_friend:this.chat_friend_manager.selected_friend})}if("undefined"!=typeof t.callback_obj.open_tab&&!0===t.callback_obj.open_tab&&(this.chat_friend_manager.select_friend(n.id_user),i.get("chat-display")&&this.chat_toggle_display(!0)),this.chatInitsAndPrefs.serviceWorkerRegistration)try{this.chatInitsAndPrefs.serviceWorkerRegistration.postMessage({action:"add_friend_info",friend_info:n})}catch(e){this.log_and_tooltip.log_error("Failed to send add_friend_info to SW")}},send_users_infos:function(t){if(this.log_and_tooltip.log_debug("send_users_infos",t),$("#new_tab_select_spin").remove(),"undefined"==typeof t.friendlist)return void this.log_and_tooltip.log_error("no friendlist");var e=$.map(t.freturn t});e.sort(this.chat_friend_manager.sort_friends);for(var i in e)this.chat_friend_manager.add_friend(e[i]);var n=[];for(var r in this.chat_friend_manager.friends)n.push(r);if(n.length<this.chat_friend_manager.friends_ids.length&&this.chat_friend_manager.addlink_more_friends(),this.chatInitsAndPrefs.serviceWorkerRegistration)try{this.chatInitsAndPrefs.serviceWorkerRegistration.postMessage({action:"add_friends_infos",friendlist:t.friendlist})}catch(e){this.log_and_tooltip.log_error("Failed to send add_friends_infos to SW")}},ask_delete_message:function(t){this.chatInitsAndPrefs.set_timer_away(),confirm($("<textarea />").html(g.__("chat.confirm_delete_message")).text())&&this.emit_delete_message(t)},emit_delete_message:function(t){this.log_and_tooltip.log_debug("emit_delete_message",t),this.socket_connection.emit("delete_message",{message_id:t,recipient_id:this.chat_friend_manager.selected_friend,type:"friend"})},delete_message:function(t){this.log_and_tooltip.log_debug("delete_message",t);var e=$("#chat_message_"+t.message_id);if(0!==e.length){var i=e.parent();$("#chat_message_"+t.message_id).remove(),0===i.children().length&&i.closest("li").remove()}},edit_message:function(t){this.log_and_tooltip.log_debug("edit_message",t);var e=this.get_real_message(t.message),i=$("#chat_message_"+t.message_id),n=i.find(".chat_message"),r=i.find(".chat_message_report");n.html(e),r.html(e)},emit_change_prefs:function(e,i,n){if(this.log_and_tooltip.log_debug("emit_change_prefs"),"undefined"!=typeof this.socket_connection){var r={sound:e,mini_disabled:i,invisible:"Invisible"==this.chatInitsAndPrefs.status,blur_image:n};r[t.dyn.chat.cookie_name]=s.get(t.dyn.chat.cookie_name),this.socket_connection.emit("change_prefs",r)}},remove_SW_token:function(){this.log_and_tooltip.log_debug("remove_SW_token"),"undefined"!=typeof this.socket_connection&&this.socket_connection.emit("remove_SW_token")},change_status:function(e){if(this.log_and_tooltip.log_debug("change_status",e),"Online"!=e&&"Away"!=e&&"Invisible"!=e)return void this.log_and_tooltip.log_error("bad status for change_status : "+e);this.socket_connection&&this.socket_connection.emit("change_status",{status:e,invisible:"Invisible"==this.chatInitsAndPrefs.status,sound:this.chatInitsAndPrefs.sound,notif:this.chatInitsAndPrefs.notif,mini_disabled:this.chatInitsAndPrefs.mini_disabled,blur:this.chatInitsAndPrefs.blur_image,hexavid_login:s.get(t.dyn.chat.cookie_name)})},status_changed:function(e){if(this.log_and_tooltip.log_debug("status_changed",e),"Online"!=e.status&&"Away"!=e.status&&"Invisible"!=e.status)return void this.log_and_tooltip.log_error("bad status for status_changed : "+e.status);this.chatInitsAndPrefs.status=e.status,"Away"!=e.status&&this.chatInitsAndPrefs.set_timer_away(),$(".chat-option-status .chat-settings-option-icon").removeClass("icon chat-settings-option-checked"),"Online"==this.chatInitsAndPrefs.status?($("#chat-option-status-online .chat-settings-option-icon").addClass("icon chat-settings-option-checked"),$(".chat-title-text").html(g.__("chat.infos.xvideos_chat"))):"Away"==this.chatInitsAndPrefs.status?($("#chat-option-status-away .chat-settings-option-icon").addClass("icon chat-settings-option-checked"),$(".chat-title-text").html(g.__("chat.infos.xvideos_chat")+" ("+g.__("chat.status.away")+")")):"Invisible"==this.chatInitsAndPrefs.status&&($("#chat-option-status-invisible .chat-settings-option-icon").addClass("icon chat-settings-option-checked"),$(".chat-title-text").html(g.__("chat.infos.xvideos_chat")+" ("+g.__("chat.status.invisible")+")")),"Online"!=e.status&&(this.typing_to_friend=!1),"Online"==e.status&&this.input.val().length>0&&0!=this.chat_friend_manager.selected_friend&&(this.typing_to_friend=this.chat_friend_manager.selected_friend,this.socket_connection.emit("typing_start",{id_friend:this.chat_friend_manager.selected_friend})),"undefined"!=typeof e.cookie&&(this.log_and_tooltip.log_debug("set cookie"),s.setLocal(t.dyn.chat.cookie_name,e.cookie,0,"/"))},setSwToken:function(t){this.chatInitsAndPrefs.sw_token=t,this.chatInitsAndPrefs.notif&&this.socket_connection&&(this.socket_connection.emit("SW_token",{token:this.chatInitsAndPrefs.sw_token}),s.setLocal("chat_sw_token",t,864e6,"/"))},key_pressed:function(t,e){this.log_and_tooltip.log_debug("key pressed"),this.chatInitsAndPrefs.set_timer_away();var i=this.chat_friend_manager.selected_friend;0!=i&&(t.which=t.which||t.keyCode,13==t.which?(void 0!==e&&e.blur(),this.send_message(t),this.typing_to_friend=!1):"Invisible"!=this.chatInitsAndPrefs.status&&(void 0!==e&&"undefined"!=typeof e[0]?e[0].innerHTML.length>0?(this.typing_to_friend=i,e[0].innerHTML.length>=this.typing_event_nb_carac&&(new Date).getTime()-this.typing_event_last_event_ts>this.typing_event_interval&&(this.typing_event_last_event_ts=(new Date).getTime(),this.socket_connection.emit("typing_start",{id_friend:i}))):"undefined"!=typeof this.typing_to_friend&&this.typing_to_friend||(this.typing_to_friend=!1,this.socket_connection.emit("typing_stop",{id_friend:i})):0==this.input.val().length?(this.typing_to_friend=!1,this.socket_connection.emit("typing_stop",{id_friend:i})):"undefined"!=typeof this.typing_to_friend&&this.typing_to_friend||e[0].innerHTML.length>=this.typing_event_nb_carac&&(new Date).getTime()-this.typing_event_last_event_ts>this.typing_event_interval&&(this.typing_to_friend=i,this.typing_event_last_event_ts=(new Date).getTime(),this.socket_connection.emit("typing_start",{id_friend:i}))))},search_key_pressed:function(t){this.log_and_tooltip.log_debug("key pressed"),this.chatInitsAndPrefs.set_timer_away(),t.which=t.which||t.keyCode,13==t.which&&this.chat_friend_manager.search_friend()},format_timestamp:function(t){var e=new Date(1e3*t),i=new Date,n="";return e.getFullYear()!=i.getFullYear()&&(n+=e.getFullYear()+"/"),e.getDate()!=i.getDate()&&(n+=this.format_date_number(e.getMonth()+1)+"/"+this.format_date_number(e.getDate())+" "),n+=this.format_date_number(e.getHours())+":"+this.format_date_number(e.getMinutes())},format_dat"0"+t:t},friend_is_frcreator}},require(["libs/emojionearw A(!0)},function(t){return console.log("failed to load emojionearea",t),new A(!0)})},function(t){console.log("requirejs send error",t),o||n("chat.error.connection_adblock")})}}),require(["skins/chat/manager"]),define("skins/chat",function(){});