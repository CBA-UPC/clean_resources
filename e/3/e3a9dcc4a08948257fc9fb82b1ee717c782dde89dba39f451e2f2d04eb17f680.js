(window.officehome_webpackJsonp=window.officehome_webpackJsonp||[]).push([[103],{"/ieh":function(e,t,s){"use strict";var o=Object.prototype.hasOwnProperty,n="~";t.create&&(i.prototype=Object.create(null),(new i).__proto__||(n=!1)),l.prototype.eventNames=l.prototype.listeners=l.prototype.listenerCount=l.prototype.emit=l.prototype.on=function(e,t,s){return a(this,e,t,s,!1)},l.prototype.once=l.prototype.removeListener=l.prototype.removeAllListeners=l.prototype.off=l.prototype.removeListener,l.prototype.addListener=l.prototype.on,l.prefixed=n,l.EventEmitter=l,e.exports=l},"01JL":function(e,t,s){"use strict";s.d(t,"b",(function(){return o})),s.d(t,"a",(function(){return n}));const{AugLoopTextEncoder:o,AugLoopTextDecoder:n}=(()=>{if("undefined"==typeof TextEncoder){s("0kE7");const e={AugLoopTextEncoder:TextEncoder,AugLoopTextDecoder:TextDecoder};return TextEncoder=void 0,TextDecoder=void 0,e}return{AugLoopTextEncoder:TextEncoder,AugLoopTextDecoder:TextDecoder}})()},"0kE7":function(e,t,s){(function(e,t){!function(e){"use strict";function s(e){for(var t=0,s=Math.min(65536,e.length+1),o=new Uint16Array(s),n=[],i=0;;){var r=t<e.length;if(!r||i>=s-1){var a=o.subarray(0,i);if(n.push(String.fromCharCode.apply(null,a)),!r)return n.join("");e=e.subarray(t),t=0,i=0}var c=e[t++];if(0==(128&c))o[i++]=c;else if(192==(224&c)){var l=63&e[t++];o[i++]=(31&c)<<6|l}else if(224==(240&c)){l=63&e[t++];var u=63&e[t++];o[i++]=(31&c)<<12|l<<6|u}else if(240==(248&c)){var p=(7&c)<<18|(l=63&e[t++])<<12|(u=63&e[t++])<<6|63&e[t++];p>65535&&(o[i++]=(p-=65536)>>>10&1023|55296,p=56320|1023&p),o[i++]=p}}}var o="Failed to ",n=i="function"==typeof t&&t.from,r=i?function(e){return t.from(e)}:.prototype.encode=var c=!i&&"function"==typeof Blob&&"function"==typeof URL&&"function"==typeof URL.createObjectURL,l=["utf-8","utf8","unicode-1-1-utf-8"],u=s;i?u=c&&(u=;var p="construct 'TextDecoder'",h="".concat(o," ").concat(p,": the ");.prototype.decode=e.TextEncoder=e.TextEncoder||a,e.TextDecoder=e.TextDecoder||d}("undefined"!=typeof window?window:void 0!==e?e:this)}).call(this,s("pCvA"),s("zkTx").Buffer)},"3YFW":function(e,t,s){"use strict";function o(e){if(this._capacity=i(e),this._length=0,this._front=0,n(e)){for(var t=e.length,s=0;s<t;++s)this[s]=e[s];this._length=t}}o.prototype.toArray=function(){for(var e=this._length,t=new Array(e),s=this._front,o=this._capacity,n=0;n<e;++n)t[n]=this[s+n&o-1];return t},o.prototype.push=function(e){var t=arguments.length,s=this._length;if(t>1){var o=this._capacity;if(s+t>o){for(var n=0;n<t;++n)this._checkCapacity(s+1),this[i=this._front+s&this._capacity-1]=arguments[n],s++,this._length=s;return s}var i=this._front;for(n=0;n<t;++n)this[i+s&o-1]=arguments[n],i++;return this._length=s+t,s+t}return 0===t?s:(this._checkCapacity(s+1),this[n=this._front+s&this._capacity-1]=e,this._length=s+1,s+1)},o.prototype.pop=o.prototype.shift=o.prototype.unshift=function(e){var t=this._length,s=arguments.length;if(s>1){if(t+s>(n=this._capacity)){for(var o=s-1;o>=0;o--){var n;this._checkCapacity(t+1),this[r=(this._front-1&(n=this._capacity)-1^n)-n]=arguments[o],t++,this._length=t,this._front=r}return t}var i=this._front;for(o=s-1;o>=0;o--){var r;this[r=(i-1&n-1^n)-n]=arguments[o],i=r}return this._front=i,this._length=t+s,t+s}return 0===s?t:(this._checkCapacity(t+1),this[o=(this._front-1&(n=this._capacity)-1^n)-n]=e,this._length=t+1,this._front=o,t+1)},o.prototype.peekBack=o.prototype.peekFront=o.prototype.get=function(e){var t=e;if(t===(0|t)){var s=this._length;if(t<0&&(t+=s),!(t<0||t>=s))return this[this._front+t&this._capacity-1]}},o.prototype.isEmpty=o.prototype.clear=function(){for(var e=this._length,t=this._front,s=this._capacity,o=0;o<e;++o)this[t+o&s-1]=void 0;this._length=0,this._front=0},o.prototype.valueOf=o.prototype.toString=o.prototype.removeFront=o.prototype.shift,o.prototype.removeBack=o.prototype.pop,o.prototype.insertFront=o.prototype.unshift,o.prototype.insertBack=o.prototype.push,o.prototype.enqueue=o.prototype.push,o.prototype.dequeue=o.prototype.shift,o.prototype.toJSON=o.prototype.toArray,Object.defineProperty(o.prototype,"length",{get:function(){return this._length},set:function(){throw new RangeError("")}}),o.prototype._checkCapacity=o.prototype._resizeTo=function(e){var t=this._capacity;this._capacity=e;var s=this._front,o=this._length;s+o>t&&this,0,this,t,s+o&t-1)};var n=Array.isArray;function i(e){if("number"!=typeof e){if(!n(e))return 16;e=e.length}return function(e){return e>>>=0,e-=1,e|=e>>1,e|=e>>2,e|=e>>4,1+((e|=e>>8)|e>>16)}(Math.min(Math.max(16,e),1073741824))}e.exports=o},"5Q+G":function(e,t,s){"use strict";s.d(t,"a",(function(){return c})),s.d(t,"b",(function(){return T}));var o=s("V2nY");class n{constructor(e){o.a.assign(n,this,e)}static getTypeName(){return"AugLoop_Core_ItemDelta"}static getBaseTypes(){return[]}static typeGuard(e){return o.a.matchesTypesFor(e,[n.getTypeName()])}}n.H_={T_:n.getTypeName(),B_:n.getBaseTypes()};class i{constructor(e){o.a.assign(i,this,e)}static getTypeName(){return"AugLoop_Core_ItemChangesDelta"}static getBaseTypes(){return["AugLoop_Core_ItemDelta"]}static typeGuard(e){return o.a.matchesTypesFor(e,[i.getTypeName()])}}i.H_={T_:i.getTypeName(),B_:i.getBaseTypes()};class r{constructor(e){o.a.assign(r,this,e)}static getTypeName(){return"AugLoop_Core_Operation"}static getBaseTypes(){return[]}static typeGuard(e){return o.a.matchesTypesFor(e,[r.getTypeName()])}}r.H_={T_:r.getTypeName(),B_:r.getBaseTypes()};class a{constructor(e){o.a.assign(a,this,e)}static getTypeName(){return"AugLoop_Core_OperationWithSiblingContext"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return o.a.matchesTypesFor(e,[a.getTypeName()])}}a.H_={T_:a.getTypeName(),B_:a.getBaseTypes()};class c{constructor(e){o.a.assign(c,this,e)}static getTypeName(){return"AugLoop_Core_AddOperation"}static getBaseTypes(){return["AugLoop_Core_OperationWithSiblingContext","AugLoop_Core_Operation"]}static typeGuard(e){return o.a.matchesTypesFor(e,[c.getTypeName()])}}c.H_={T_:c.getTypeName(),B_:c.getBaseTypes()};class l{constructor(e){o.a.assign(l,this,e)}static getTypeName(){return"AugLoop_Core_MoveOperation"}static getBaseTypes(){return["AugLoop_Core_OperationWithSiblingContext","AugLoop_Core_Operation"]}static typeGuard(e){return o.a.matchesTypesFor(e,[l.getTypeName()])}}l.H_={T_:l.getTypeName(),B_:l.getBaseTypes()};class u{constructor(e){o.a.assign(u,this,e)}static getTypeName(){return"AugLoop_Core_UpdateAnnotationMetaDataOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return o.a.matchesTypesFor(e,[u.getTypeName()])}}u.H_={T_:u.getTypeName(),B_:u.getBaseTypes()};class p{constructor(e){o.a.assign(p,this,e)}static getTypeName(){return"AugLoop_Core_UpdateOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return o.a.matchesTypesFor(e,[p.getTypeName()])}}p.H_={T_:p.getTypeName(),B_:p.getBaseTypes()};class h{constructor(e){o.a.assign(h,this,e)}static getTypeName(){return"AugLoop_Core_DeleteOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return o.a.matchesTypesFor(e,[h.getTypeName()])}}h.H_={T_:h.getTypeName(),B_:h.getBaseTypes()};class d{constructor(e){o.a.assign(d,this,e)}static getTypeName(){return"AugLoop_Core_PurgeOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return o.a.matchesTypesFor(e,[d.getTypeName()])}}d.H_={T_:d.getTypeName(),B_:d.getBaseTypes()};class g{constructor(e){o.a.assign(g,this,e)}static getTypeName(){return"AugLoop_Core_FocusOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return o.a.matchesTypesFor(e,[g.getTypeName()])}}g.H_={T_:g.getTypeName(),B_:g.getBaseTypes()};class f{constructor(e){o.a.assign(f,this,e)}static getTypeName(){return"AugLoop_Core_VisibilityOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return o.a.matchesTypesFor(e,[f.getTypeName()])}}f.H_={T_:f.getTypeName(),B_:f.getBaseTypes()};class m{constructor(e){o.a.assign(m,this,e)}static getTypeName(){return"AugLoop_Core_DeltaUpdateOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return o.a.matchesTypesFor(e,[m.getTypeName()])}}m.H_={T_:m.getTypeName(),B_:m.getBaseTypes()};class y{constructor(e){o.a.assign(y,this,e)}static getTypeName(){return"AugLoop_Core_MicroSyncOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return o.a.matchesTypesFor(e,[y.getTypeName()])}}y.H_={T_:y.getTypeName(),B_:y.getBaseTypes()};class T{constructor(e){o.a.assign(T,this,e)}static getTypeName(){return"AugLoop_Signals_SignalOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return o.a.matchesTypesFor(e,[T.getTypeName()])}}T.H_={T_:T.getTypeName(),B_:T.getBaseTypes()}},"5V7u":function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var o=s("4Zdx"),n=s("GBVN"),i=s("mXGw"),r=s.n(i),a=s("p/uK"),c=s("DU/N"),l=Object(a.a)({previewBadge:{fontSize:c.a.fontSizeBase100,lineHeight:c.a.lineHeightBase100}}),u=function(e){var t=e.previewBadgeResources,s=e.className,i=l();return r.a.createElement(o.a,{appearance:"tint",color:"informative",className:Object(n.a)(i.previewBadge,s)},t.previewBadgeText)}},"5f5u":function(e,t){var s="undefined"!=typeof self?self:this,o=);!function(e){!function(t){var s="URLSearchParams"in e,o="Symbol"in e&&"iterator"in Symbol,n="FileReader"in e&&"Blob"in e&&),i="FormData"in e,r="ArrayBuffer"in e;if(r)var a=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],c=ArrayBuffer.isView||pe.append=h.prototype.delete=h.prototype.get=h.prototype.has=h.prototype.set=h.prototype.forEach=h.prototype.keys=h.prototype.values=h.prototype.entries=o&&(h.prototype[Symbol.iterator]=h.prototype.entries);var T=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];ototype.clone=y.call(w.prototype),y.call(k.prototype),k.prototype.clone=k.error=var _=[301,302,303,307,308];k.redirect=t.DOMException=e.DOMException;try{new t.DOMException}catch(e){t.DOMException=t.DOMException.prototype=Object.create(Error.prototype),t.DOMException.prototype.constructor=t.DOMException}function b(e,s){return new Promise((function(o,i){var r=new w(e,s);if(r.signal&&r.signal.aborted)return i(new t.DOMException("Aborted","AbortError"));var a=new XMLHttpRequest;.onload=a.onerror=function(){i(new TypeError("Network request failed"))},a.ontimeout=a.onabort=a.open(r.method,r.url,!0),"include"===r.credentials?a.withCredentials=!0:"omit"===r.credentials&&(a.withCredentials=!1),"responseType"in a&&n&&(a.responseType="blob"),r.headers.forEach((),r.signal&&(r.signal.addEventListener("abort",c),a.onreadystatechange=,a.send(void 0===r._bodyInit?null:r._bodyInit)}))}b.polyfill=!0,e.fetch||(e.fetch=b,e.Headers=h,e.Request=w,e.Response=k),t.Headers=h,t.Request=w,t.Response=k,t.fetch=b,Object.defineProperty(t,"__esModule",{value:!0})}({})}(o),o.fetch.ponyfill=!0,delete o.fetch.polyfill;var n=o;(t=n.fetch).default=n.fetch,t.fetch=n.fetch,t.Headers=n.Headers,t.Request=n.Request,t.Response=n.Response,e.exports=t},"7Owc":function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return y})),s.d(t,"c",(function(){return _})),s.d(t,"b",(function(){return D}));var o=s("fW/M"),n=s("RJ4T");const i=void 0!==e&&e.env?e.env.SERVICE_NAME:"client",r="abcdefghijklmnopqrstuvwxyz0123456789",a={97:0,98:1,99:2,100:3,101:4,102:5,103:6,104:7,105:8,106:9,107:10,108:11,109:12,110:13,111:14,112:15,113:16,114:17,115:18,116:19,117:20,118:21,119:22,120:23,121:24,122:25,48:26,49:27,50:28,51:29,52:30,53:31,54:32,55:33,56:34,57:35};let c,l=[],u=[],p=h=const d=new Map,g=new Map,f=new Map,m=new Map;var y;!function(e){e.defineCoreLogCategory=e=>({root:"Core",name:e}),e.defineWorkflowLogCategory=e.clearLoggers=()=>{l=[],u=[],g.clear(),f.clear()},e.clearAggregators=()=>{d.clear()},e.addLogger=e=>{-1===l.indexOf(e)&&(l.push(e),T(g,e))},e.addDecidingLogger=e=>{-1===u.indexOf(e)&&(u.push(e),T(f,e))},e.setCorrelationContextCallback=e=>{c=e},e.setStartPerformanceEventCallback=e=>{p=e},e.setStopPerformanceEventCallback=e=>{h=e},e.addAggregator=e=>{e.init((),d.has(e.eventName)?d.get(e.eventName).push(e):d.set(e.eventName,[e])},e.flushAggregators=e=>{d.forEach(()},e.setTagLevelOverride=e.resetTagLevelOverrides=e.error=(e,t,s,n,i,r,a,c,l,u)=>{A(e,t,o.a.error,s,n,i,r,a,c,l,u)},e.warn=(e,t,s,n,i,r,a,c,l,u)=>{A(e,t,o.a.warn,s,n,i,r,a,c,l,u)},e.info=(e,t,s,n,i,r,a,c,l,u)=>{A(e,t,o.a.info,s,n,i,r,a,c,l,u)},e.verbose=(e,t,s,n,i,r,a,c,l,u)=>{A(e,t,o.a.verbose,s,n,i,r,a,c,l,u)},e.debug=(e,t,s,n,i,r,a,c,l,u)=>{A(e,t,o.a.debug,s,n,i,r,a,c,l,u)},e.metric=(e,t,s,n,i,r,a,c,l,u)=>{A(e,t,o.a.metric,s,n,i,r,a,c,l,u)},e.formatMetric=(e,t,s,o)=>{const n={};return n[e]={dimensionNames:s,dimensionValues:o,value:t},n},e.dynamic=e=>{I(e)}}(y||(y={}));const T=(e,t)=>{const s=t.level;Object.keys(o.a).map(().filter(().filter(().forEach(()},w=e=>{if("string"==typeof e)return e;let t="";for(let s=0;s<e.length;s++){s>0&&(t+=" ");const o=e[s];o instanceof Error?t+=JSON.stringify({message:o.message,name:o.name,stack:o.stack}):t+="object"==typeof o?JSON.stringify(o):o}return t},v=[],C=["Level","Tag"],k=["Level","Tag","Workflow"],_=b=e=>void 0!==e?g.get(e)||v:l,S=(e,t)=>(void 0!==e?f.get(e)||[]:u).filter((e=>e.shouldLog(t))),A=(e,t,s,o,i,r,a,l,u,g,f)=>{s=m.get(e)||s;const y=b(s),T=S(s,o);if(0==y.length&&0==T.length)return;const v=p(n.a.Log),_=M(e),A=((e,t,s,o,n,i,r,a)=>{if(void 0===t&&("string"==typeof e||"object"==typeof e))return e;if(void 0===t&&"function"==typeof e)return e();const c=[];for(const l of[e,t,s,o,n,i,r,a])void 0!==l&&c.push("function"==typeof l?l():l);return c})(o,i,r,a,l,u,g,f);if(x(t))N(A)&&I({eventName:"Metrics",tagId:_,category:`${t.root}.${t.name}`,traceLevel:s,message:"",getMetrics:()=>A},!1,y,T);else if(N(A)){const e=A;e.tagId=_,e.category=`${t.root}.${t.name}`,"Operation"===e.eventName&&"Workflow"===t.root&&(e.eventName="WorkflowOperation",c&&(e.joinContextId=c().joinContextId)),e.traceLevel=s;const o=d.get(e.eventName);if(o)for(let t=0;t<o.length;++t){const s=o[t];if(s&&s.add(e,t===o.length-1))break}else I(e,!1,y,T)}else{const e=()=>{var e;return"Core"===t.root?{TraceEventV2:{dimensionNames:()=>C,dimensionValues:[String(s),_],value:1}}:{WorkflowTraceEvent:{dimensionNames:()=>k,dimensionValues:[String(s),_,c?null===(e=c())||void 0===e?void 0:e.workflow:""],value:1}}};I({eventName:"Log",tagId:_,category:`${t.root}.${t.name}`,traceLevel:s,message:w(A),getMetrics:e},!1,y,T)}h(v)},I=(e,t=!1,s,o)=>{var n,r,a;if(null==s&&(s=b(e.traceLevel)),o=o||v,s.length>0||o.length>0){if(e.serviceName=i,!t&&c){const t=c();if(t){e.cv=e.cv?e.cv:t.cv.toString(),e.sessionKey=e.sessionKey?e.sessionKey:t.sessionKey,e.workflow=e.workflow?e.workflow:t.workflow;const s=null===(n=t.clientMetadata)||void 0===n?void 0:n.appName;e.clientAppName=e.clientAppName?e.clientAppName:s;const o=null===(r=t.clientMetadata)||void 0===r?void 0:r.appPlatform;e.clientAppPlatform=e.clientAppPlatform?e.clientAppPlatform:o;const i=null===(a=t.clientMetadata)||void 0===a?void 0:a.releaseAudienceGroup;e.clientReleaseAudienceGroup=e.clientReleaseAudienceGroup?e.clientReleaseAudienceGroup:i}}for(const t of s)t.log(e);for(const t of o)t.log(e)}},x=N=e=>!Array.isArray(e)&&"object"==typeof e,M=e=>r[e>>24&63]+r[e>>18&63]+r[e>>12&63]+r[e>>6&63]+r[e>>0&63],B=e=>e&&5===e.length?a[e.charCodeAt(0)]<<24|a[e.charCodeAt(1)]<<18|a[e.charCodeAt(2)]<<12|a[e.charCodeAt(3)]<<6|a[e.charCodeAt(4)]:-1;class D{}D.CoreDefault=y.defineCoreLogCategory("Default"),D.CoreSystem=y.defineCoreLogCategory("System"),D.WorkflowDefault=y.defineWorkflowLogCategory("Default"),D.WorkflowUnsampled=y.defineWorkflowLogCategory("Unsampled"),D.WorkflowMetricsOnly=y.defineWorkflowLogCategory("MetricsOnly")}).call(this,s("5IsQ"))},"9u6N":FJrl:LlSO:function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));class o{constructor(e){o.assign(o,this,e)}static getTypeName(){return"AugLoop_Core_SchemaObject"}static getBaseTypes(){return[]}static getTypeNameFor(e){return e&&e.H_?e.H_.T_:void 0}static getBaseTypesFor(e){return e&&e.H_&&e.H_.B_?e.H_.B_:[]}static getAllTypesFor(e){const t=o.getTypeNameFor(e);return t?[t,...o.getBaseTypesFor(e)]:[]}static matchesTypesFor(e,t){if(!Array.isArray(t)||0===t.length)return!0;const s=o.getTypeNameFor(e),n=o.getBaseTypesFor(e);for(const e of t){if(e===s)return!0;if(n.indexOf(e)>=0)return!0}return!1}static assign(e,t,s){if(s)for(const e of Object.keys(s))t[e]=s[e];return t.H_=e.H_,t}}o.H_={T_:o.getTypeName(),B_:o.getBaseTypes()}},MwDM:function(e,t,s){"use strict";var o,n,i;s.d(t,"a",(function(){return o})),o||(o={})),function(e){e.System="system",e.User="user",e.Assistant="assistant"}(n||(n={})),function(e){e.NotStarted="NotStarted",e.Running="Running",e.Succeeded="Succeeded"}(i||(i={}))},RJ4T:V2nY:function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));class o{constructor(e){o.assign(o,this,e)}static getTypeName(){return"AugLoop_Core_SchemaObject"}static getBaseTypes(){return[]}static getTypeNameFor(e){return e&&e.H_?e.H_.T_:void 0}static getBaseTypesFor(e){return e&&e.H_&&e.H_.B_?e.H_.B_:[]}static getAllTypesFor(e){const t=o.getTypeNameFor(e);return t?[t,...o.getBaseTypesFor(e)]:[]}static matchesTypesFor(e,t){if(!Array.isArray(t)||0===t.length)return!0;const s=o.getTypeNameFor(e),n=o.getBaseTypesFor(e);for(const e of t){if(e===s)return!0;if(n.indexOf(e)>=0)return!0}return!1}static assign(e,t,s){if(s)for(const e of Object.keys(s))t[e]=s[e];return t.H_=e.H_,t}}o.H_={T_:o.getTypeName(),B_:o.getBaseTypes()}},Wux9:function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return n}));var o=s("01JL");class n{static deserialize(t,s=(e=>e)){if(t[0]!==n.IDENTIFIERBYTE)throw new Error("Invalid Binary: Incorrect Identifier");let o=1;const i=[],r=new DataView(t.buffer,t.byteOffset,t.byteLength);for(;o<t.byteLength;){if(o+4>t.byteLength)throw new Error("Invalid Binary: Error reading fragment length");const s=r.getUint32(o);if(o+s+4>t.byteLength)throw new Error("Invalid Binary: Fragment out of range");i.push(void 0!==e&&e.from?e.from(t.buffer,t.byteOffset+o+4,s):new Uint8Array(t.buffer,t.byteOffset+o+4,s)),o+=4+s}if(i.length<1)throw new Error("Invalid Binary: No fragments found");const a=n.textDecoder.decode(i[0]);return JSON.parse(a,((e,t)=>{if("string"==typeof t){if(t.substring(0,n.BINARYKEYWORD.length)===n.BINARYKEYWORD){const e=parseInt(t.substring(n.BINARYKEYWORD.length),10);if("number"!=typeof e||e>=i.length-1)throw new Error("Invalid Binary: Binary index out of range");return s(i[e+1])}if(t.substring(0,n.ESCAPEKEYWORD.length)===n.ESCAPEKEYWORD)return t.substring(n.ESCAPEKEYWORD.length)}return t}))}static serialize(e){const t=[void 0],s=JSON.stringify(e,((e,s)=>ArrayBuffer.isView(s)?(t.push(s),`${n.BINARYKEYWORD}${t.length-2}`):s&&"Buffer"===s.type&&Array.isArray(s.data)?(t.push(new Uint8Array(s.data)),`${n.BINARYKEYWORD}${t.length-2}`):"string"==typeof s&&s.substring(0,n.ESCAPEKEYWORD.length)===n.ESCAPEKEYWORD?n.ESCAPEKEYWORD+s:s));t[0]=n.textEncoder.encode(s);const o=t.reduce((,0),i=new Uint8Array(o+1);i[0]=n.IDENTIFIERBYTE;let r=1;const a=new DataView(i.buffer,i.byteOffset,i.byteLength);for(const e of t)a.setUint32(r,e.byteLength),i.set(e,r+4),r+=4+e.byteLength;return i}}n.IDENTIFIERBYTE=3,n.BINARYKEYWORD=":b",n.ESCAPEKEYWORD=":",n.textDecoder=new o.a,n.textEncoder=new o.b}).call(this,s("zkTx").Buffer)},b8Ug:function(e,t,s){"use strict";s.d(t,"a",(function(){return Uo}));var o=s("QjXU"),n=s("mXGw"),i={Test:"https://augloop-test.officeppe.com",Int:"https://augloop-int.officeppe.com",Dogfood:"https://augloop-dogfood.officeppe.com",Prod:"https://augloop.office.com"},r="Int",a=s("fW/M"),c={util:{},roots:{default:{}}},l=(c.roots.default||(c.roots.default={}),function(){function e(e){if(e)for(var t in e)null!=e[t]&&(this[t]=e[t])}return e.prototype.count=0,e.prototype.cv="",e.prototype.serviceName="",e.prototype.sessionKey="",e.prototype.durationMs=0,e.prototype.success=!1,e.prototype.resultDescription="",e.prototype.resultJSON="",e.prototype.resultSignature="",e.prototype.operationName="",e.prototype.resourceId="",e.prototype.dimension0="",e.prototype.dimension1="",e.prototype.dimension2="",e.prototype.dimension3="",e.prototype.clientAppName="",e.prototype.clientAppPlatform="",e.prototype.clientRuntimeVersion="",e.prototype.clientAppVersion="",e.prototype.clientReleaseAudienceGroup="",e.prototype.clientReleaseChannel="",e.prototype.clientReleaseFork="",e.prototype.clientSessionId="",e.prototype.clientFlights="",e.prototype.clientIPRange="",e.prototype.clientDocSessionId="",e.prototype.clientDeviceId="",e.prototype.clientUserAgent="",e.prototype.userType="",e.prototype.userId="",e.prototype.userTenantId="",e.prototype.joinContextId="",e.prototype.ariaTenant="",e.prototype.ariaNamespace="",e.prototype.dataFields="",e}()),u=s("hs6A");class p extends l{constructor(e,t){super(e),this.eventName="Operation",this.options=t,this.durationMs=null==e?void 0:e.durationMs,e&&null!=e.count||(this.count=1)}setClientMetadata(e){return e&&(this.clientAppName=e.appName,this.clientAppPlatform=e.appPlatform,this.clientAppVersion=e.appVersion,this.clientFlights=e.flights,this.clientReleaseAudienceGroup=e.releaseAudienceGroup,this.clientReleaseChannel=e.releaseChannel,this.clientReleaseFork=e.releaseFork,this.clientRuntimeVersion=e.runtimeVersion,this.clientSessionId=e.sessionId,this.clientDocSessionId=e.docSessionId,this.clientDeviceId=e.deviceId,this.clientUserAgent=e.userAgent),this}setUserContext(e){return e&&(this.userId=e.puid||e.oid,this.userType=e.userType&&e.userType.toString(),this.userTenantId=e.tid),this}setMetricCustomDimensions(e,t){if(!this.options)throw new Error(`Attempting to set custom dimensions ${e} to operation ${this.operationName} without activating MetricCount or MetricDuration`);this.options.metricCustomDimensions=this.options.metricCustomDimensions||{},this.options.metricCustomDimensions[e]=t}setDataField(e,t){const s=this.dataFields?JSON.parse(this.dataFields):{};s[e]=t,this.dataFields=JSON.stringify(s)}setDataFields(e){this.dataFields=this.dataFields?JSON.stringify(Object.assign(Object.assign({},JSON.parse(this.dataFields)),e)):JSON.stringify(e)}start(){return this.startTime=Object(u.a)(),this}stop(){const e=Object(u.a)();return this.durationMs=Math.round(e-this.startTime),this}getMetrics(e){var t,s;const o={};if(this.operationName)switch(this.operationName){case"SessionHealthOrphanedEventsWithoutProperSessionKey":case"SessionHealthOrphanedSessions":case"WorkflowActivationState":o[this.operationName+".CountV2"]={dimensionNames:p.getOrphanedSessionHealthDimensionNames.bind(p),dimensionValues:this.getOrphanedSessionHealthDimensionValues(),value:this.count};break;case"MarkUnhealthySession":case"MarkHealthWarningSession":o[this.operationName+".Reason"]={dimensionNames:p.getSessionHealthDimensionNames.bind(p),dimensionValues:this.getSessionHealthDimensionValues(),value:1};break;default:if("matchmaker_timer"===this.operationName&&(o["Workflow.DurationMs"]={dimensionNames:p.getWorkflowDimensionNames.bind(p),dimensionValues:this.getWorkflowDimensionValues(),value:this.durationMs||0},o["Workflow.Count"]={dimensionNames:p.getWorkflowDimensionNames.bind(p),dimensionValues:this.getWorkflowDimensionValues(),value:1}),void 0!==this.durationMs){const s=`${this.operationName}.DurationMsV2`;((null===(t=this.options)||void 0===t?void 0:t.metricDuration)||e.indexOf(s)>=0)&&(o[s]={dimensionNames:this.getDimensionNames.bind(this),dimensionValues:this.getDimensionValues(),value:this.durationMs})}{const t=`${this.operationName}.CountV2`;((null===(s=this.options)||void 0===s?void 0:s.metricCount)||e.indexOf(t)>=0)&&(o[t]={dimensionNames:this.getDimensionNames.bind(this),dimensionValues:this.getDimensionValues(),value:this.count})}}return o}getDimensionNames(){var e,t;let s=p.dimensionNames;if(null===(e=this.options)||void 0===e?void 0:e.metricCustomDimensions){s=s.slice();for(const e in null===(t=this.options)||void 0===t?void 0:t.metricCustomDimensions)s.push(e)}return s}getDimensionValues(){var e,t;const s=[this.success,this.clientAppName,this.clientAppPlatform,this.resourceId,this.dimension0,this.dimension1,this.dimension2,this.dimension3];if(null===(e=this.options)||void 0===e?void 0:e.metricCustomDimensions)for(const e in null===(t=this.options)||void 0===t?void 0:t.metricCustomDimensions)s.push(this.options.metricCustomDimensions[e]);return s}static getOrphanedSessionHealthDimensionNames(){return this.orphanedSessionHealthDimensionNames}getOrphanedSessionHealthDimensionValuestatic getSessionHealthDimensionNames(){return this.sessionHealthDimensionNames}tatic getWorkflowDimensionNames(){return this.workflowDimensionNames}p.dimensionNames=["Success","ClientAppName","ClientAppPlatform","ResourceId","Dimension0","Dimension1","Dimension2","Dimension3"],p.orphanedSessionHealthDimensionNames=["Success","ClientAppName","ClientAppPlatform","ClientReleaseAudienceGroup","ResourceId","Dimension0","Dimension1","Dimension2","Dimension3"],p.sessionHealthDimensionNames=["Reason","ClientAppName","ClientAppPlatform","ClientAppVersion","Dimension0","Dimension1","Dimension2","Dimension3"],p.workflowDimensionNames=["ResultSignature","WorkflowId","ResourceId","Success"];var h,d,g=s("7Owc");!function(e){e[e.ProductServiceUsage=2]="ProductServiceUsage",e[e.ProductServicePerformance=4]="ProductServicePerformance"}(h||(h={})),function(e){e[e.BasicEvent=10]="BasicEvent",e[e.FullEvent=100]="FullEvent",e[e.RequiredServiceDataEvent=110]="RequiredServiceDataEvent"}(d||(d={}));const f="n~",m=/\|\~/g;class y{class T{constructor(e,t,s,o,n){this.buckets=new Map,this.init=this.add=(e,t=!0)=>{if(!this.condition||!this.condition(e))return!0===t&&this.log(e,!1),!1;const s=[];for(const t of this.dimensions)if(null==e[t])s.push(null);else{let o="";"boolean"==typeof e[t]?o="b~":"number"==typeof e[t]&&(o=f),s.push(`${o}${e[t].toString().replace(m,"_")}`)}const o=s.join("|");let n=this.buckets.get(o);if(!n){n=new y,n.traceLevel=e.traceLevel;for(const e of this.avgMeasures)n.measureSums.set(e,0);this.buckets.set(o,n)}n.count++;for(const t of this.avgMeasures)e[t]&&n.measureSums.set(t,n.measureSums.get(t)+e[t]);return!0},this.flush=(e=!1)=>{this.buckets.forEach(((e,t)=>{const s={traceLevel:e.traceLevel,eventName:this.eventName,count:e.count},o=t.split("|");for(let e=0;e<this.dimensions.length;e++){const t=o[e];s[this.dimensions[e]]=0===t.indexOf("b~")?"b~true"===t:0===t.indexOf(f)?parseInt(t.slice(f.length),10):t}for(const t of this.avgMeasures)s[t]=Math.round(e.measureSums.get(t)/e.count);this.log(s,!0)})),this.buckets.clear(),e&&(this.condition=null,clearInterval(this.interval))},this.eventName=e,this.condition=t,this.dimensions=s,this.avgMeasures=o,n>0&&(this.interval=setInterval(this.flush,1e3*n))}}const w=(e,t,s,o)=>new T(e,(e=>e.success&&s.indexOf(e[t])>=0),[t,"resourceId","success","resultSignature","clientDocSessionId","dimension0","dimension1","dimension2","dimension3"],["durationMs"],o);class v{og(e){if(null==this.hostCallbacks||null==this.hostCallbacks.sendTelemetryEvent)return;const t=(e,t,s,o,n)=>{let i=t.charAt(0).toUpperCase()+t.slice(1),r={DocSessionId:e.clientDocSessionId,ResourceId:e.resourceId,ResultDescription:e.resultDescription,ResultSignature:e.resultSignature,Dimension0:e.dimension0,Dimension1:e.dimension1,Dimension2:e.dimension2,Dimension3:e.dimension3,JoinContextId:e.joinContextId};s&&(r=Object.assign(Object.assign({},r),JSON.parse(s)));const a=o||v.augLoopAriaTenantToken,c=n||a!=v.augLoopAriaTenantToken?n:v.augLoopAriaNamespace;i=i||v.operationNamePlaceholder,this.hostCallbacks.sendTelemetryEvent(a,c?`${c}_${i}`:i,r,"Office.System.Activity",{CV:e.cv,Duration:1e3*(e.durationMs||0),Count:e.count,AggMode:2,Success:e.success},!1,h.ProductServiceUsage|h.ProductServicePerformance,d.RequiredServiceDataEvent)};"Workflow.MetricsOnly"==e.category||("Operation"===e.eventName?t(e,e.operationName,e.dataFields):"SessionHealth"===e.eventName?t(e,e.sessionHealthEventName):"WorkflowOperation"===e.eventName?t(e,e.operationName,e.dataFields,e.ariaTenant,e.ariaNamespace):"Log"===e.eventName&&((e,t,s)=>{this.hostCallbacks.sendDiagnosticTrace&&this.hostCallbacks.sendDiagnosticTrace(e,t,s)})(e.tagId,e.traceLevel,e.message))}}v.augLoopAriaTenantToken="3de4087d4de34817b1c376e3d1e6e293-983c4292-5ba9-485a-ab10-9797863c788b-6770",v.augLoopAriaNamespace="Office_AugLoop_Client",v.operationNamePlaceholder="OperationNameNotProvided";var C,k=s("FJrl"),_=s.n(k);!function(e){e[e.Undefined=0]="Undefined",e[e.Schema=1]="Schema",e[e.Boolean=2]="Boolean",e[e.Number=3]="Number",e[e.String=4]="String",e[e.Buffer=5]="Buffer",e[e.Function=6]="Function"}(C||(C={}));class b{constructor(e){b.assign(b,this,e)}static getTypeName(){return"AugLoop_Core_SchemaObject"}static getBaseTypes(){return[]}static getTypeNameFortatic getBaseTypesFortatic getAllTypesFor(e){const t=b.getTypeNameFor(e);return t?[t,...b.getBaseTypesFor(e)]:[]}static matchesTypesFor(e,t){if(!Array.isArray(t)||0===t.length)return!0;const s=b.getTypeNameFor(e),o=b.getBaseTypesFor(e);for(const e of t){if(e===s)return!0;if(o.indexOf(e)>=0)return!0}return!1}static assign(e,t,s){if(s)for(const e of Object.keys(s))t[e]=s[e];return t.H_=e.H_,t}}b.H_={T_:b.getTypeName(),B_:b.getBaseTypes()};class S{constructor(e){b.assign(S,this,e)}get metadata(){return this.M_}set metadata(e){this.M_=e}static getTypeName(){return"AugLoop_Core_Annotation"}static getBaseTypes(){return[]}static typeGuard(e){return b.matchesTypesFor(e,[S.getTypeName()])}}S.H_={T_:S.getTypeName(),B_:S.getBaseTypes()};class A{constructor(e){b.assign(A,this,e)}get metadata(){return this.M_}set metadata(e){this.M_=e}static getTypeName(){return"AugLoop_Core_BinaryClassificationAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return b.matchesTypesFor(e,[A.getTypeName()])}}A.H_={T_:A.getTypeName(),B_:A.getBaseTypes()};class I{constructor(e){b.assign(I,this,e)}static getTypeName(){return"AugLoop_Signals_Signal"}static getBaseTypes(){return[]}static typeGuard(e){return b.matchesTypesFor(e,[I.getTypeName()])}}I.H_={T_:I.getTypeName(),B_:I.getBaseTypes()};class x{constructor(e){b.assign(x,this,e)}static getTypeName(){return"AugLoop_Core_ItemDelta"}static getBaseTypes(){return[]}static typeGuard(e){return b.matchesTypesFor(e,[x.getTypeName()])}}x.H_={T_:x.getTypeName(),B_:x.getBaseTypes()};class N{constructor(e){b.assign(N,this,e)}static getTypeName(){return"AugLoop_Core_ItemChangesDelta"}static getBaseTypes(){return["AugLoop_Core_ItemDelta"]}static typeGuard(e){return b.matchesTypesFor(e,[N.getTypeName()])}}N.H_={T_:N.getTypeName(),B_:N.getBaseTypes()};class M{constructor(e){b.assign(M,this,e)}static getTypeName(){return"AugLoop_Core_Operation"}static getBaseTypes(){return[]}static typeGuard(e){return b.matchesTypesFor(e,[M.getTypeName()])}}M.H_={T_:M.getTypeName(),B_:M.getBaseTypes()};class B{constructor(e){b.assign(B,this,e)}static getTypeName(){return"AugLoop_Core_OperationWithSiblingContext"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return b.matchesTypesFor(e,[B.getTypeName()])}}B.H_={T_:B.getTypeName(),B_:B.getBaseTypes()};class D{constructor(e){b.assign(D,this,e)}static getTypeName(){return"AugLoop_Core_AddOperation"}static getBaseTypes(){return["AugLoop_Core_OperationWithSiblingContext","AugLoop_Core_Operation"]}static typeGuard(e){return b.matchesTypesFor(e,[D.getTypeName()])}}D.H_={T_:D.getTypeName(),B_:D.getBaseTypes()};class E{constructor(e){b.assign(E,this,e)}static getTypeName(){return"AugLoop_Core_MoveOperation"}static getBaseTypes(){return["AugLoop_Core_OperationWithSiblingContext","AugLoop_Core_Operation"]}static typeGuard(e){return b.matchesTypesFor(e,[E.getTypeName()])}}E.H_={T_:E.getTypeName(),B_:E.getBaseTypes()};class O{constructor(e){b.assign(O,this,e)}static getTypeName(){return"AugLoop_Core_UpdateAnnotationMetaDataOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return b.matchesTypesFor(e,[O.getTypeName()])}}O.H_={T_:O.getTypeName(),B_:O.getBaseTypes()};class W{constructor(e){b.assign(W,this,e)}static getTypeName(){return"AugLoop_Core_UpdateOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return b.matchesTypesFor(e,[W.getTypeName()])}}W.H_={T_:W.getTypeName(),B_:W.getBaseTypes()};class L{constructor(e){b.assign(L,this,e)}static getTypeName(){return"AugLoop_Core_DeleteOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return b.matchesTypesFor(e,[L.getTypeName()])}}L.H_={T_:L.getTypeName(),B_:L.getBaseTypes()};class R{constructor(e){b.assign(R,this,e)}static getTypeName(){return"AugLoop_Core_PurgeOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return b.matchesTypesFor(e,[R.getTypeName()])}}R.H_={T_:R.getTypeName(),B_:R.getBaseTypes()};class P{constructor(e){b.assign(P,this,e)}static getTypeName(){return"AugLoop_Core_FocusOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return b.matchesTypesFor(e,[P.getTypeName()])}}P.H_={T_:P.getTypeName(),B_:P.getBaseTypes()};class F{constructor(e){b.assign(F,this,e)}static getTypeName(){return"AugLoop_Core_VisibilityOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return b.matchesTypesFor(e,[F.getTypeName()])}}F.H_={T_:F.getTypeName(),B_:F.getBaseTypes()};class G{constructor(e){b.assign(G,this,e)}static getTypeName(){return"AugLoop_Core_DeltaUpdateOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return b.matchesTypesFor(e,[G.getTypeName()])}}G.H_={T_:G.getTypeName(),B_:G.getBaseTypes()};class H{constructor(e){b.assign(H,this,e)}static getTypeName(){return"AugLoop_Core_MicroSyncOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return b.matchesTypesFor(e,[H.getTypeName()])}}H.H_={T_:H.getTypeName(),B_:H.getBaseTypes()};class U{constructor(e){b.assign(U,this,e)}static getTypeName(){return"AugLoop_Signals_SignalOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return b.matchesTypesFor(e,[U.getTypeName()])}}U.H_={T_:U.getTypeName(),B_:U.getBaseTypes()};class ${static createHealthCheckRequest(e){return{payload:{},payloadSchema:{category:C.Schema,schema:{name:"HealthCheckRequest"}},requestedSchema:{category:C.Schema,schema:{name:"HealthCheckResponse"}},clientMetadata:e}}static isFeatureEnabled(e,t,s=!1,o="None"){return e&&e.isFeatureEnabled?e.isFeatureEnabled("Microsoft.Office.AugLoop."+t,o).catch(():Promise.resolve(s)}static convertWebSocketUrlToHttp(e){return this.convertUrl(e,!1)}tatic convertUrl(e,t){if(!e)return e;const s=e.split(":");let o=s[0].toLowerCase();return 0==o.indexOf(t?"http":"ws")?(o=t?o.replace("http","ws"):o.replace("ws","http"),s[0]=o,s.join(":")):e}}$.getCurrentTimeMs=class q{og(e){if(this.numberOfLogs<this.maxNumberOfLogs&&(this.numberOfLogs++,e(),this.numberOfLogs===this.maxNumberOfLogs)){const e=new p({operationName:"OnLastLog",success:!0,resourceId:this.id,resultDescription:`Limit for number of logs for id: ${this.id} reached - all next logs will be dropped`});g.a.warn(572838107,g.b.CoreDefault,e)}}}b.getTypeName(),S.getTypeName(),I.getTypeName();const j=(e,t=0)=>Number.isFinite(e)?e:t;class z{constructor(){this.hasBeenOpened=!1,this.hadEgressError=!1,this.lastEgressTime=0,this.lastPongTime=0,this.remainingPingFailures=3,this.egressMessageCount=0,this.egressByteCount=0,this.pendingEgress=[]}init(e,t,s,o,n){this.ws=new _.a(e),this.logOp=new p({operationName:z.className,success:!0}).start(),this.egressTimer=Date.now(),this.egressMessageCountOp=new p({operationName:"WSEgressMessageCount",success:!0}),this.egressByteCountOp=new p({operationName:"WSEgressByteOrderOfMagnitude",success:!0}),this.ingressByteCountOp=new p({operationName:"WSIngressByteOrderOfMagnitude",success:!0}),this.improvedWebSocketEnabled=n;const i=e=>{this.logPingLatencyOp&&(this.logPingLatencyOp.success=e,g.a.info(572838091,g.b.CoreDefault,this.logPingLatencyOp.stop()),this.logPingLatencyOp=void 0)};this.ws.addEventListener("open",(e=>{s(),z.logCountLimiter.log((()=>{this.logOp.resourceId="OnOpen",this.logOp.resultDescription="",this.logOp.success=!0,this.logOp.dimension0=this.pendingEgress.length.toString(),g.a.info(572838092,g.b.CoreDefault,this.logOp.stop())})),this.improvedWebSocketEnabled||(this.hasBeenOpened=!0,this.pendingEgress.forEach((),this.pendingEgress=[],this.pingInterval=setInterval((()=>{this.logPingLatencyOp&&(--this.remainingPingFailures,i(!1)),this.remainingPingFailures>0&&this.hasBeenOpened&&this.lastPongTime<this.lastEgressTime&&(this.logPingLatencyOp=new p({operationName:"Ping",success:!0,dimension0:this.ws.bufferedAmount>=0?this.ws.bufferedAmount.toString().length.toString():void 0}).start(),this.ws.send(z.pingPongMessage,(e=>{e&&(--this.remainingPingFailures,i(!1))})))}),3e4))})),this.ws.addEventListener("message",(e=>{!this.improvedWebSocketEnabled&&this.logPingLatencyOp&&"string"==typeof e.data&&1===e.data.length&&e.data[0]===z.pingPongMessage?(i(!0),this.lastPongTime=Date.now()):(this.logIngressCount(e.data),t(e.data))})),this.ws.addEventListener("error",(e=>{this.errorMessage=e.message,z.logCountLimiter.log((()=>{this.logOp.resourceId="OnError",this.logOp.resultDescription=this.errorMessage,this.logOp.success=!1,g.a.info(572838093,g.b.CoreDefault,this.logOp.stop())})),this.ws.close()})),this.ws.addEventListener("close",(e=>{z.logCountLimiter.log((()=>{this.logOp.resourceId="OnClose",this.logOp.resultDescription=e?`code: ${e.code}. reason: ${e.reason}`:"",this.logOp.success=!0,g.a.info(572838094,g.b.CoreDefault,this.logOp.stop())})),!this.improvedWebSocketEnabled&&this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=void 0),o(this.errorMessage)}))}egress(e){this.improvedWebSocketEnabled?this.ws.send(e,(e=>{e&&!this.hadEgressError&&(this.hadEgressError=!0,z.logCountLimiter.log((()=>{this.logOp.resourceId="OnEgressError",this.logOp.resultDescription=e.message,this.logOp.success=!1,g.a.info(509370640,g.b.CoreDefault,this.logOp.stop())})))})):(this.logEgressCount(e instanceof ArrayBuffer?e.byteLength:e.length),this.lastEgressTime=Date.now(),this.hasBeenOpened?this.ws.send(e,(e=>{e&&!this.hadEgressError&&(this.hadEgressError=!0,z.logCountLimiter.log((()=>{this.logOp.resourceId="OnFirstEgressError",this.logOp.resultDescription=e.message,this.logOp.success=!1,g.a.info(572838095,g.b.CoreDefault,this.logOp.stop())})))})):this.pendingEgress.push(e))}close(){!this.improvedWebSocketEnabled&&this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=void 0),this.ws.close()}logEgressCount(e){const t=Date.now(),s=t-this.egressTimer;s>1e3&&(this.egressMessageCount>50&&(this.egressMessageCountOp.start(),this.egressMessageCountOp.resultDescription="Egress message count: "+this.egressMessageCount.toString()+", Buffered amount: "+(this.ws.bufferedAmount>=0?this.ws.bufferedAmount.toString():"-")+", Time elapsed: "+s.toString(),g.a.info(512234761,g.b.CoreDefault,this.egressMessageCountOp.stop())),this.egressByteCount>1e5&&(this.egressByteCountOp.start(),this.egressByteCountOp.dimension2=this.egressByteCount.toString().length.toString(),this.egressMessageCountOp.resultDescription="Buffered amount: "+(this.ws.bufferedAmount>=0?this.ws.bufferedAmount.toString():"-")+", Time elapsed: "+s.toString(),g.a.info(512234760,g.b.CoreDefault,this.egressByteCountOp.stop())),this.egressTimer=t,this.egressMessageCount=0,this.egressByteCount=0),this.egressMessageCount++,this.egressByteCount+=null!=e?e:0}logIngressCount(e){const t=e.length;t>1e5&&(this.ingressByteCountOp.start(),this.ingressByteCountOp.dimension2=t.toString().length.toString(),g.a.info(508957778,g.b.CoreDefault,this.ingressByteCountOp.stop()))}}z.className="WebSocketWorker",z.logCountLimiter=new q(z.className),z.pingPongMessage="~";class V{constructor(e){this.childCount=0,this.id=e||function(){for(let e=0;e<22;e++)K[e]=J[Math.floor(Math.random()*J.length)];return K.join("")}()}static fromString(e,t){if(!e)throw new Error("Received invalid correlation vector string");let s;return s=e.endsWith(".0")?new V(e.substring(0,e.length-2)):new V(e),t&&(s.childCount=t),s}newChild(){return++this.childCount,new V(this.id+"."+this.childCount.toString())}toStringconst J=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],K=new Array(22);var Q,Y,X,Z,ee,te={util:{},roots:{default:{}}},se=(te.roots.default||(te.roots.default={}),function(){function e(e){if(e)for(var t in e)null!=e[t]&&(this[t]=e[t])}return e.prototype.cv="",e.prototype.serviceName="",e.prototype.sessionKey="",e.prototype.clientAppName="",e.prototype.clientAppPlatform="",e.prototype.clientRuntimeVersion="",e.prototype.clientAppVersion="",e.prototype.clientReleaseAudienceGroup="",e.prototype.clientReleaseChannel="",e.prototype.clientReleaseFork="",e.prototype.clientSessionId="",e.prototype.clientFlights="",e.prototype.clientIPRange="",e.prototype.clientDocSessionId="",e.prototype.clientDeviceId="",e.prototype.clientUserAgent="",e.prototype.userType="",e.prototype.userId="",e.prototype.sessionHealthEventName="",e.prototype.source="",e.prototype.reason="",e.prototype.reasonDependency="",e.prototype.subReason="",e.prototype.impact="",e.prototype.success=!1,e.prototype.durationMs=0,e.prototype.count=0,e.prototype.message="",e.prototype.affectedWorkflows="",e.prototype.resourceId="",e.prototype.dimension0="",e.prototype.dimension1="",e.prototype.dimension2="",e.prototype.dimension3="",e.prototype.resultDescription="",e.prototype.resultSignature="",e.prototype.joinContextId="",e}());!Q||(Q={})),Y||(Y={})),X||(X={}));class oe extends se{constructor(e,t){var s,o;super({source:Q[e.source],reason:Y[e.reason],reasonDependency:e.reasonDependency,subReason:e.subReason,sessionHealthEventName:e.sessionHealthEventName,impact:X[e.impact],success:e.success,durationMs:null!==(s=e.durationMs)&&void 0!==s?s:0,count:"number"==typeof e.count?e.count:1,message:e.message,affectedWorkflows:(null!==(o=e.affectedWorkflows)&&void 0!==o?o:[]).join(","),resourceId:e.resourceId,dimension0:e.dimension0,dimension1:e.dimension1,dimension2:e.dimension2,dimension3:e.dimension3,cv:e.cv,resultSignature:e.resultSignature,resultDescription:e.resultDescription,joinContextId:e.joinContextId}),this.eventName="SessionHealth",t&&this.setClientMetadata(t),this.metricCount=e.metricCount,this.metricDuration=e.metricDuration}getMetrics(){const e={};return(void 0===this.metricCount||this.metricCount)&&(e[`${this.sessionHealthEventName}.CountV2`]={dimensionNames:()=>oe.dimensionNames,dimensionValues:this.getDimensionValues(),value:this.count}),(void 0===this.metricDuration||this.metricDuration)&&(e[`${this.sessionHealthEventName}.DurationMsV2`]={dimensionNames:dimensionValues:this.getDimensionValues(),value:this.durationMs}),e}setClientMetadata(e){return e&&(this.clientAppName=e.appName,this.clientAppPlatform=e.appPlatform,this.clientAppVersion=e.appVersion,this.clientFlights=e.flights,this.clientReleaseAudienceGroup=e.releaseAudienceGroup,this.clientReleaseChannel=e.releaseChannel,this.clientReleaseFork=e.releaseFork,this.clientRuntimeVersion=e.runtimeVersion,this.clientSessionId=e.sessionId,this.clientDocSessionId=e.docSessionId,this.clientUserAgent=e.userAgent,this.clientDeviceId=e.deviceId),this}setReason(e){return this.reason=Y[e],this}setSource(e){return this.source=Q[e],this}etAffectedWorkflows(e){return this.affectedWorkflows=(null!=e?e:[]).join(","),this}tart(){return this.startTime=Object(u.a)(),this}stop(){const e=Object(u.a)();return this.durationMs=Math.round(e-this.startTime),this}getDimensionValues(){var e;return[this.clientAppName,this.clientAppPlatform,this.clientAppVersion,this.success?"1":"0",`${this.reason}_${this.reasonDependency}`,this.impact,null!==(e=this.getAffectedWorkflows()[0])&&void 0!==e?e:"",this.resourceId,this.dimension0,this.dimension1,this.dimension2,this.dimension3]}}oe.dimensionNames=["ClientAppName","ClientAppPlatform","ClientAppVersion","Success","Reason","Impact","FirstAffectedWorkflow","ResourceId","Dimension0","Dimension1","Dimension2","Dimension3"];class ne{constructor(e){b.assign(ne,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Message"}static getBaseTypes(){return[]}static typeGuard(e){return b.matchesTypesFor(e,[ne.getTypeName()])}}ne.H_={T_:ne.getTypeName(),B_:ne.getBaseTypes()};class ie{constructor(e){b.assign(ie,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Response"}static getBaseTypes(){return[]}static typeGuard(e){return b.matchesTypesFor(e,[ie.getTypeName()])}}ie.H_={T_:ie.getTypeName(),B_:ie.getBaseTypes()};class re{constructor(e){b.assign(re,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_ErrorResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return b.matchesTypesFor(e,[re.getTypeName()])}}re.H_={T_:re.getTypeName(),B_:re.getBaseTypes()};class ae{constructor(e){b.assign(ae,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_TimeoutErrorResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_ErrorResponse","AugLoop_Session_Protocol_Response"]}static typeGuard(e){return b.matchesTypesFor(e,[ae.getTypeName()])}}ae.H_={T_:ae.getTypeName(),B_:ae.getBaseTypes()};class ce{constructor(e){b.assign(ce,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionInitMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return b.matchesTypesFor(e,[ce.getTypeName()])}}ce.H_={T_:ce.getTypeName(),B_:ce.getBaseTypes()};class le{constructor(e){b.assign(le,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionInitResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return b.matchesTypesFor(e,[le.getTypeName()])}}le.H_={T_:le.getTypeName(),B_:le.getBaseTypes()};class ue{constructor(e){b.assign(ue,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionCloseMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return b.matchesTypesFor(e,[ue.getTypeName()])}}ue.H_={T_:ue.getTypeName(),B_:ue.getBaseTypes()};class pe{constructor(e){b.assign(pe,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_CacheDumpRequestMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return b.matchesTypesFor(e,[pe.getTypeName()])}}pe.H_={T_:pe.getTypeName(),B_:pe.getBaseTypes()};class he{constructor(e){b.assign(he,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_CacheDumpRequestResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return b.matchesTypesFor(e,[he.getTypeName()])}}he.H_={T_:he.getTypeName(),B_:he.getBaseTypes()};class de{constructor(e){b.assign(de,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationActivationMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return b.matchesTypesFor(e,[de.getTypeName()])}}de.H_={T_:de.getTypeName(),B_:de.getBaseTypes()};class ge{constructor(e){b.assign(ge,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationActivationResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return b.matchesTypesFor(e,[ge.getTypeName()])}}ge.H_={T_:ge.getTypeName(),B_:ge.getBaseTypes()};class fe{constructor(e){b.assign(fe,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationResultStateMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return b.matchesTypesFor(e,[fe.getTypeName()])}}fe.H_={T_:fe.getTypeName(),B_:fe.getBaseTypes()};class me{constructor(e){b.assign(me,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationReleaseMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return b.matchesTypesFor(e,[me.getTypeName()])}}me.H_={T_:me.getTypeName(),B_:me.getBaseTypes()};class ye{constructor(e){b.assign(ye,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationReleaseResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return b.matchesTypesFor(e,[ye.getTypeName()])}}ye.H_={T_:ye.getTypeName(),B_:ye.getBaseTypes()};class Te{constructor(e){b.assign(Te,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationConfigUpdateMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return b.matchesTypesFor(e,[Te.getTypeName()])}}Te.H_={T_:Te.getTypeName(),B_:Te.getBaseTypes()};class we{constructor(e){b.assign(we,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationConfigUpdateResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return b.matchesTypesFor(e,[we.getTypeName()])}}we.H_={T_:we.getTypeName(),B_:we.getBaseTypes()};class ve{constructor(e){b.assign(ve,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SyncMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return b.matchesTypesFor(e,[ve.getTypeName()])}}ve.H_={T_:ve.getTypeName(),B_:ve.getBaseTypes()};class Ce{constructor(e){b.assign(Ce,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_MicroSyncMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return b.matchesTypesFor(e,[Ce.getTypeName()])}}Ce.H_={T_:Ce.getTypeName(),B_:Ce.getBaseTypes()};class ke{constructor(e){b.assign(ke,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SyncResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return b.matchesTypesFor(e,[ke.getTypeName()])}}ke.H_={T_:ke.getTypeName(),B_:ke.getBaseTypes()};class _e{constructor(e){b.assign(_e,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionDeleteMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return b.matchesTypesFor(e,[_e.getTypeName()])}}_e.H_={T_:_e.getTypeName(),B_:_e.getBaseTypes()};class be{constructor(e){b.assign(be,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationResultsMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_SyncMessage","AugLoop_Session_Protocol_Message"]}static typeGuard(e){return b.matchesTypesFor(e,[be.getTypeName()])}}be.H_={T_:be.getTypeName(),B_:be.getBaseTypes()};class Se{constructor(e){b.assign(Se,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_TokenProvisionMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return b.matchesTypesFor(e,[Se.getTypeName()])}}Se.H_={T_:Se.getTypeName(),B_:Se.getBaseTypes()};class Ae{constructor(e){b.assign(Ae,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_TokenProvisionResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return b.matchesTypesFor(e,[Ae.getTypeName()])}}Ae.H_={T_:Ae.getTypeName(),B_:Ae.getBaseTypes()};class Ie{constructor(e){b.assign(Ie,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_KeepAlive"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return b.matchesTypesFor(e,[Ie.getTypeName()])}}Ie.H_={T_:Ie.getTypeName(),B_:Ie.getBaseTypes()};class xe{constructor(e){b.assign(xe,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowGraphInitMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return b.matchesTypesFor(e,[xe.getTypeName()])}}xe.H_={T_:xe.getTypeName(),B_:xe.getBaseTypes()};class Ne{constructor(e){b.assign(Ne,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowGraphInitResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return b.matchesTypesFor(e,[Ne.getTypeName()])}}Ne.H_={T_:Ne.getTypeName(),B_:Ne.getBaseTypes()};class Me{constructor(e){b.assign(Me,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowExecutionCompleteMessage"}tatic typeGuard(e){return b.matchesTypesFor(e,[Me.getTypeName()])}}Me.H_={T_:Me.getTypeName(),B_:Me.getBaseTypes()};class Be{constructor(e){b.assign(Be,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_OAuth2InitMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return b.matchesTypesFor(e,[Be.getTypeName()])}}Be.H_={T_:Be.getTypeName(),B_:Be.getBaseTypes()};class De{constructor(e){b.assign(De,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_OAuth2InitResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return b.matchesTypesFor(e,[De.getTypeName()])}}De.H_={T_:De.getTypeName(),B_:De.getBaseTypes()};class Ee{constructor(e){b.assign(Ee,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_OAuth2CallbackMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return b.matchesTypesFor(e,[Ee.getTypeName()])}}Ee.H_={T_:Ee.getTypeName(),B_:Ee.getBaseTypes()};class Oe{constructor(e){b.assign(Oe,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_BridgeMessage"}static getBaseTypes(){return[]}static typeGuard(e){return b.matchesTypesFor(e,[Oe.getTypeName()])}}Oe.H_={T_:Oe.getTypeName(),B_:Oe.getBaseTypes()};class We{constructor(e){if(this.cache=new Map,this.options=e||{sweepInterval:100},null!=this.options.idleDurationMs&&this.options.idleDurationMs<=0)throw new Error("Idle duration must be positive");if(this.interval=this.options.sweepInterval||100,this.interval<=0)throw new Error("Sweep interval must be a positive number")}put(e,t,s,o,n,i,r){if(null==s||s<=0)throw new Error("Cache timeout must be a positive number");(null==n||n<=0)&&(n=this.options.idleDurationMs);const a={value:t,lastUsed:n?Date.now():void 0,expire:s+Date.now(),idleDurationMs:n,expireCallback:o,expiringTriggerTime:i+Date.now(),expiringCallback:r};return this.cache.set(e,a),this.timeout||(this.timeout=setInterval(this.onInterval.bind(this),this.interval),this.timeout.unref&&this.timeout.unref()),t}del(e){if(this.options.delCallback){const t=this.cache.get(e);t&&this.options.delCallback(e,t.value)}const t=this.cache.delete(e);return 0===this.size()&&this.clear(),t}clearet(e){const t=this.cache.get(e);if(t)return this.options.idleDurationMs&&(t.lastUsed=Date.now()),t.value}orEach(e){this.cache.forEach(()}size(){return this.cache.size}updateExpireTime(e,t){return!!(this.cache.has(e)&&t>=0)&&(this.cache.get(e).expire=t+Date.now(),!0)}onInterval(){const e=Date.now();this.cache.forEach(((t,s)=>{if(t.idleDurationMs&&t.lastUsed<e-t.idleDurationMs)return this.del(s),void(this.options.idleCallback&&this.options.idleCallback(s,t.value));t.expire<e&&(this.del(s),t.expireCallback&&t.expireCallback(s,t.value)),t.expiringTriggerTime<e&&t.expiringCallback&&(t.expiringCallback(s,t.value),t.expiringCallback=void 0)}))}}function Le(e){const t=["AugLoop_Excel_Session_Protocol_","AugLoop_Powerpoint_Session_Protocol_","AugLoop_Session_Protocol_"];let s;for(const o of t)if(0===e.indexOf(o)){s=o;break}if(!s)return"MalformedMessageName";const o="Message",n=e.indexOf(o,e.length-o.length)===e.length-o.length;return e.slice(s.length,n?-o.length:void 0)}!function(e){e.ClientDisconnected="Client disconnected.",e.UnsupportedSyncMessage="SyncMessages with seq = -1 are not supported anymore.",e.UnexpectedSeedMessage="Unexpected seed message",e.SyncMessageUnsupportedBatch="SyncMessage with unsupported batching.",e.AnnotationTokenNotFound="Token not found"}(Z||(Z={})),function(e){e.ProvisionTokenValidationError="Token provision message didn't pass token validation.",e.ProvisionTokenDecryptAndTransformError="Token provision message didn't pass token decrypt and transform."}(ee||(ee={}));class Re{constructor(e){this.nextMessageId=1,this.pendingResponseCallbacks=new We({sweepInterval:5e3}),this.pendingMessageCallbacks=new We({sweepInterval:5e3}),this.messageCallbacks=new Map,this.messageIdPrefix=e,this.source="c"===e?Q.ClientRuntime:Q.Core,this.stats={sendMessageCount:0,sendMessageClientDisconnectedErrors:0,sendMessageErrors:0,sendMessageDurationMsMax:0,processMessageCount:0,processMessageProvisionTokenErrors:0,processMessageErrors:0,processMessageDurationMsMax:0}}setClientMetadata(e){this.clientMetadata=e}setEgress(e){this.egress=e}ingress(e,t){const s=b.getBaseTypesFor(e),o=b.getTypeNameFor(e);o===ie.getTypeName()||s&&s.indexOf(ie.getTypeName())>=0?(this.processResponse(e),t()):this.processMessage(e,t),o!==ue.getTypeName()||e.reconnectAllowed||this.clearAllPendingResponses()}sendMessage(e,t,s,o=0){const n=new oe({sessionHealthEventName:"SendMessage",source:this.source,reason:Y.Client,impact:this.source===Q.ClientRuntime?X.MissingInput:X.MissingOutput,success:!0,message:"",affectedWorkflows:["All"],cv:e.cv,resourceId:Le(b.getTypeNameFor(e)),dimension0:o.toString()}).start(),i=()=>{n.setClientMetadata(this.clientMetadata),n.success?g.a.info(572836e3,g.b.CoreDefault,n.stop()):(n.message=JSON.stringify({errorNotPropagatedToDoneCallback:"ErrorWithoutPendingResponse"===n.resultSignature||"ResponseCallbackException"===n.resultSignature||"We called into done callback"!==n.message}),g.a.error(572836001,g.b.CoreDefault,n.stop()))};e.messageId=`${this.messageIdPrefix}${this.nextMessageId++}`;const r=b.getTypeNameFor(e)===ue.getTypeName();if(!s&&!r){const s=(s,o)=>{var r;if(s?(n.success=!1,n.resultSignature=s.error,n.resultDescription=`Error for ${b.getTypeNameFor(e)} message ${e.messageId}: ${s.error}`):n.resultSignature="Success",t)try{n.message="We called into done callback",t(s,o)}catch(e){n.success=!1,n.resultSignature="ResponseCallbackException",n.resultDescription="Web"===(null===(r=this.clientMetadata)||void 0===r?void 0:r.appPlatform)?JSON.stringify({message:e.message,stack:e.stack}):JSON.stringify({message:e.message})}this.pendingMessageCallbacks.del(e.messageId),i(),this.updateSendMessageStats(n.success,n.durationMs,s?new Error(s.error):void 0)},o=()=>{s(new ae({error:"Timeout waiting for response"}),void 0)};this.pendingResponseCallbacks.put(e.messageId,s,3e4,o)}this.egress(e,(t=>{var s,o;if(t){const a=this.pendingResponseCallbacks.get(e.messageId);a?(this.pendingResponseCallbacks.del(e.messageId),a(new re({messageId:e.messageId,error:t.message}))):r?(n.success=null!==(o=null===(s=t.message)||void 0===s?void 0:s.endsWith("Client disconnected."))&&void 0!==o&&o,n.resultSignature="ErrorSendingSessionCloseMessage",n.resultDescription=`Error for ${b.getTypeNameFor(e)} message ${e.messageId}: ${t.message}`,i()):(n.success=!1,n.resultSignature="ErrorWithoutPendingResponse",n.resultDescription=`Error for ${b.getTypeNameFor(e)} message ${e.messageId}: ${t.message}`,i())}}))}onMessage(e,t){this.messageCallbacks.set(e,t)}getStats(){return this.stats}ancelPendingResponseCallbacks(){this.pendingResponseCallbacks.forEach(((e,t)=>{e&&(this.pendingResponseCallbacks.del(t),e(new re({messageId:t,error:"Cancelled"})))}))}clearAllPendingResponses(){if(0==this.pendingResponseCallbacks.size())return;const e=new p({operationName:"PurgePendingResponses",resultDescription:this.pendingResponseCallbacks.size().toString(),success:!0});g.a.info(572836002,g.b.CoreDefault,e),this.pendingResponseCallbacks.clear()}processMessage(e,t){var s;const o=new oe({sessionHealthEventName:"ProcessMessage",source:this.source,reason:Y.Client,impact:this.source===Q.ClientRuntime?X.MissingOutput:X.MissingInput,success:!0,message:"",affectedWorkflows:["All"],cv:e.cv}).start(),n=()=>{o.setClientMetadata(this.clientMetadata),o.success?g.a.info(572836003,g.b.CoreDefault,o.stop()):(o.message=JSON.stringify({errorHappenedOutsideRegisteredMessageCallback:"UnsupportedMessage"===o.resourceId||"Timeout"===o.resultSignature||"OnResponseInvokedMoreThanOnce"===o.resultSignature||"MessageCallbackException"===o.resultSignature||"We called into messageCallback"!==o.message}),g.a.error(572836032,g.b.CoreDefault,o.stop()))};let i=this.messageCallbacks.get(b.getTypeNameFor(e));i?o.resourceId=Le(b.getTypeNameFor(e)):i=(e,t)=>{o.resourceId=Le(b.getTypeNameFor(e)),"MalformedMessageName"!==o.resourceId&&(o.resourceId="UnsupportedMessage"),t(new re({messageId:e.messageId,error:`Message type ${b.getTypeNameFor(e)} is not supported`}))},this.pendingMessageCallbacks.put(e.messageId,void 0,1e4,(()=>{o.success=!1,o.resultSignature="Timeout",o.resultDescription="Timeout processing message callback",n(),g.a.error(572836033,g.b.CoreDefault,`Timeout processing ${o.resourceId}`),this.updateProcessMessageStats(!1,o.durationMs,new Error("timeout"))}));let r=!1;const a=(s,i)=>{this.pendingMessageCallbacks.del(e.messageId),r?(o.success=!1,o.resultSignature="OnResponseInvokedMoreThanOnce",o.resultDescription=`Invoked onResponse for ${b.getTypeNameFor(e)} message ${e.messageId} more than once`):s?(o.success=!1,o.resultSignature=s.error,o.resultDescription=`Error for ${b.getTypeNameFor(e)} message ${e.messageId}: ${s.error}`):o.resultSignature="Success",r=!0,n(),s&&!b.matchesTypesFor(s,[re.getTypeName()])&&(s=new re({error:"Internal Server Error"})),this.updateProcessMessageStats(o.success,o.durationMs,s?new Error(s.error):void 0),s?(s.messageId=e.messageId,t(s)):i?(i.messageId=e.messageId,t(void 0,i)):t()};try{o.message="We called into messageCallback",i(e,a)}catch(i){this.pendingMessageCallbacks.del(e.messageId),o.success=!1,o.resultSignature="MessageCallbackException",o.resultDescription="Web"===(null===(s=this.clientMetadata)||void 0===s?void 0:s.appPlatform)?JSON.stringify({message:i.message,stack:i.stack}):JSON.stringify({message:i.message}),n(),this.updateProcessMessageStats(!1,o.durationMs,i),t()}}processResponse(e){var t;const s=new p({operationName:"ProcessResponse"});if(s.success=!0,s.setClientMetadata(this.clientMetadata),s.start(),e.messageId){const t=this.pendingResponseCallbacks.get(e.messageId);t?(this.pendingResponseCallbacks.del(e.messageId),b.matchesTypesFor(e,[re.getTypeName()])?t(e):t(void 0,e)):(s.resultSignature="NoPendingMessage",s.resultDescription=`${e.messageId}`,s.success=!1)}else s.resultSignature="NoMessageIdSetInResponse",s.resultDescription=re.typeGuard(e)?e.error:"MessageId is not available",s.success=!1;"Production"!==(null===(t=this.clientMetadata)||void 0===t?void 0:t.releaseAudienceGroup)&&(s.resourceId=Le(b.getTypeNameFor(e)),g.a.info(572836034,g.b.CoreDefault,s.stop()))}updateSendMessageStats(e,t,s){this.stats.sendMessageCount++,this.stats.sendMessageDurationMsMax=Math.max(t,this.stats.sendMessageDurationMsMax),e||s?e&&s&&g.a.warn(572836036,g.b.CoreDefault,"Succeeded send message provided error object."):g.a.warn(572836035,g.b.CoreDefault,"Failed send message did not provide error object."),e||(s&&s.message===Z.ClientDisconnected?this.stats.sendMessageClientDisconnectedErrors++:this.stats.sendMessageErrors++)}updateProcessMessageStats(e,t,s){this.stats.processMessageCount++,this.stats.processMessageDurationMsMax=Math.max(t,this.stats.processMessageDurationMsMax),e||s?e&&s&&g.a.warn(572836038,g.b.CoreDefault,"Succeeded process message provided error object."):g.a.warn(572836037,g.b.CoreDefault,"Failed process message did not provide error object."),e||(s&&s.message===ee.ProvisionTokenValidationError?this.stats.processMessageProvisionTokenErrors++:this.stats.processMessageErrors++)}}var Pe,Fe,Ge=s("/ieh"),He=s("3YFW"),Ue=s.n(He);!function(e){e.ArrivedBeforeReseeding="Message is dropped from queue since it arrived before reseeding is started",e.DroppedAsOldestInQueue="Message is dropped as oldest in full queue",e.DroppedBecauseClientDisconnected="Message is dropped because client is disconnected from server"}(Pe||(Pe={}));class $e{constructor(e){this.logOp=new p({operationName:"MessageQueue",success:!0}),this.messageQueueLogCountLimiter=new q("MessageQueue"),this.queue=new Ue.a(1e3),this.callbacks=e}ize(){return this.queue.length}push(e,t,s){const o=this.queue;if(1e3===o.length){this.messageQueueLogCountLimiter.log((()=>{this.logOp.resourceId="QueueFull",this.logOp.durationMs=0,g.a.warn(573187741,g.b.CoreDefault,this.logOp)}));const e=o.shift();e.onResponse&&e.onResponse(new re({error:Pe.DroppedAsOldestInQueue}))}o.push({message:e,onResponse:t,timeQueued:$.getCurrentTimeMs(),attemptNumber:s})}sendOnSessionInitialized(e){const t=this.queue.length;let s=0;if(t>0){const o=$.getCurrentTimeMs()-this.queue.get(0).timeQueued;for(;this.queue.length>0&&this.callbacks.canSendMessage();){const t=this.queue.shift();e&&t.message instanceof ve&&b.matchesTypesFor(t.message,[ve.getTypeName()])&&(!this.callbacks.dropOnlySequencedSyncsOnReseed||t.message.seq>=0)?(s++,t.onResponse&&t.onResponse(new re({error:Pe.ArrivedBeforeReseeding}))):t.message instanceof Uint8Array?this.callbacks.sendBytes(t.message):this.callbacks.sendMessage(t.message,t.onResponse,t.attemptNumber)}this.messageQueueLogCountLimiter.log((()=>{this.logOp.resourceId="SendOnSessionInitialized",this.logOp.resultDescription=`Queue size before: ${t}, after: ${this.queue.length}. droppedSyncMessages: ${s}`,this.logOp.durationMs=o,g.a.warn(573187742,g.b.CoreDefault,this.logOp)}))}}}!function(e){e[e.Initing=0]="Initing",e[e.Running=1]="Running",e[e.Disconnected=2]="Disconnected",e[e.Closed=3]="Closed"}(Fe||(Fe={}));const qe=(e,t,s,o)=>{t&&(t.cv||(t.cv=e.cvParent.newChild().toString()),e.messageEndpoint.sendMessage(t,((t,o)=>{t||b.getTypeNameFor(o)!==ke.getTypeName()||(e.stats.lastSyncMessage=Date.now()),s&&s(t,o)}),void 0,o))},je=(e,t,s,o)=>{t&&(e.messageQueue.push(t,s,o),e.webSocketWorkerManager.init(void 0,e.customInitPromise).catch((e=>{const t=new p({operationName:"WorkerManagerInit",success:!1,resultDescription:`${e}`});g.a.error(509674973,g.b.CoreDefault,t)})))},ze=(e,t)=>{t&&(e.messageQueue.push(t),e.webSocketWorkerManager.init(void 0,e.customInitPromise).catch((e=>{g.a.error(509674972,g.b.CoreDefault,`Init failed: ${e}`)})))};class Ve{constructor(e){this.context=e}onEnter(e){}endBytes(e){}canSendMessage(){return!1}onConnectionClose(){}}class Je extends Ve{constructor(){super(...arguments),this.stateName=Fe.Initing,this.possibleNextStates=[Fe.Running,Fe.Disconnected,Fe.Closed]}sendMessage(e,t,s){b.matchesTypesFor(e,[ce.getTypeName()])?qe(this.context,e,t,s):je(this.context,e,t)}sendBytes(e){ze(this.context,e)}onConnectionClose(){this.context.setState(Fe.Disconnected)}}class Ke extends Ve{constructor(){super(...arguments),this.stateName=Fe.Running,this.possibleNextStates=[Fe.Disconnected,Fe.Closed]}onEnter(e){e&&e.isSessionReseedingStarted&&this.context.resetNextSyncSequenceId(),this.context.messageQueue.sendOnSessionInitialized(e&&e.isSessionReseedingStarted)}sendMessage(e,t,s,o){qe(this.context,e,t,s)}sendBytesass Qe extends Ve{constructor(){super(...arguments),this.stateName=Fe.Disconnected,this.possibleNextStates=[Fe.Initing,Fe.Closed]}onEnter(e){this.context.messageEndpoint.cancelPendingResponseCallbacks()}sendMessage(e,t,s,o){if(b.matchesTypesFor(e,[ce.getTypeName()]))this.context.setState(Fe.Initing),qe(this.context,e,t,s);else if(b.matchesTypesFor(e,[ue.getTypeName()]))this.context.setState(Fe.Closed);else{if(!o)return void je(this.context,e,t,s);t&&t(new re({messageId:e.messageId,error:Pe.DroppedBecauseClientDisconnected}))}}class Ye extends Ve{constructor(){super(...arguments),this.stateName=Fe.Closed,this.possibleNextStates=[]}var Xe=s("Wux9"),Ze=s("5f5u");const et=new class{constructor(e,t,s){if(this.requestInProgress=!1,this.queuedRequests=[],null==e)throw new Error("No request.");this.fetch=e,this.fetchTimeout=t,this.queueTimeout=s}tryProcessNextRequest(){if(this.requestInProgress=!1,this.queuedRequests.length>0){const[e,t,s]=this.queuedRequests.shift();clearTimeout(s),this.add(e,t)}}add(e,t){if(this.requestInProgress){const s=setTimeout((()=>{t(new Error("Timed out waiting in queue"),null),this.queuedRequests.shift()}),this.queueTimeout);this.queuedRequests.push([e,t,s])}else this.requestInProgress=!0,new Promise(((t,s)=>{let o=!1;const n=setTimeout((,this.fetchTimeout);this.fetch(e).then((e=>{o||(clearTimeout(n),t(e))})).catch(()})).then((e=>{t(null,e),this.tryProcessNextRequest()})).catch((e=>{t(e,null),this.tryProcessNextRequest()}))}}(Ze.fetch,2e4,12e4),tt=1e5;class st{constructor(e){var t,s,o,n,i;this.logCountLimiter=new q(st.className),this.hasBeenOpened=!1,this.lastPingTime=0,this.lastPongTime=0,this.lastEgressTime=0,this.emptyMessageId=0,this.egressMessageCount=0,this.egressByteCount=0,this.prevSeq=-1,this.remainingPingFailures=3,this.pendingQueue=[],this.egressBytesTotal=0,this.egressRateLogOp=new p({operationName:"WSEgressRate",success:!0}),this.egressLogOp=new p({operationName:"WSEgressControl",success:!0}).start(),this.egressedCache=new Map,this.rpsThreshold=null!==(t=null==e?void 0:e.rpsThreshold)&&void 0!==t?t:150,this.bpsThreshold=null!==(s=null==e?void 0:e.bpsThreshold)&&void 0!==s?s:5e8,this.pendingMaxSize=null!==(o=null==e?void 0:e.pendingMaxSize)&&void 0!==o?o:1e4,this.egressedMaxSize=null!==(n=null==e?void 0:e.egressedMaxSize)&&void 0!==n?n:1e4,this.egressedBytesMaxSize=null!==(i=null==e?void 0:e.egressedBytesMaxSize)&&void 0!==i?i:1e7}init(e,t,s){this.worker=e,this.ingress=t,this.clientMetadata=s,this.egressRateControlTimer=setInterval((,1e3)}ingressFromWebSocket(e){1===e.length&&e===st.pingPongMessage?this.lastPongTime=Date.now():this.ingress(e,this.updateEgressedCache.bind(this))}open(){this.collectTelemetry(!0,"OnOpen"),this.hasBeenOpened=!0,this.egressRateControlIntervalStart=Date.now(),this.ping(),this.collectTelemetry(!0,"ping","initial ping"),this.flush(),this.pingInterval=setInterval((()=>{if(this.hasBeenOpened=this.lastPongTime>=this.lastPingTime&&this.lastPongTime-this.lastPingTime<=3e4,this.lastPongTime>this.lastEgressTime)return;const e=this.lastPongTime-this.lastPingTime;this.hasBeenOpened?(this.remainingPingFailures=3,this.collectTelemetry(!0,"ping","WebSocket channel active",[`${e}`,`${this.remainingPingFailures}`]),this.ping()):this.remainingPingFailures>0?(--this.remainingPingFailures,this.collectTelemetry(!0,"ping","Pong not received within 30000 ms",[`${e}`,`${this.remainingPingFailures}`]),this.ping()):(this.collectTelemetry(!1,"ping","Pong still not received after all retry attempts",[`${e}`,`${this.remainingPingFailures}`]),this.close())}),3e4)}close(){this.collectTelemetry(!0,"OnClose"),this.worker=void 0,this.prevSeq=-1,this.hasBeenOpened=!1,this.lastPingTime=0,this.lastPongTime=0,this.clearIntervalAndTimeout()}learIntervalAndTimeouting(){this.lastPingTime=Date.now(),this.worker&&this.worker.egress(st.pingPongMessage)}updateEgressedCache(e){this.egressedCache.has(e)&&(this.egressBytesTotal-=this.egressedCache.get(e),this.egressedCache.delete(e))}collectTelemetry(e,t,s,o){var n,i,r,a;this.egressLogOp.start(),this.egressLogOp.resultSignature=null!=t?t:"",this.egressLogOp.resultDescription=null!=s?s:"",this.egressLogOp.success=e,o?(this.egressLogOp.dimension0=null!==(n=o[0])&&void 0!==n?n:"",this.egressLogOp.dimension1=null!==(i=o[1])&&void 0!==i?i:"",this.egressLogOp.dimension2=null!==(r=o[2])&&void 0!==r?r:"",this.egressLogOp.dimension3=null!==(a=o[3])&&void 0!==a?a:""):(this.egressLogOp.dimension0="",this.egressLogOp.dimension1="",this.egressLogOp.dimension2="",this.egressLogOp.dimension3=""),this.logCountLimiter.log((()=>g.a.info(508954211,g.b.CoreDefault,this.egressLogOp.stop())))}egress(e,t,s){if(e instanceof ArrayBuffer&&this.worker)return void this.worker.egress(e);this.validateSyncMessage(t,s);const o=this.egressMessageCount>=this.rpsThreshold||this.egressByteCount>=this.bpsThreshold,n=this.egressBytesTotal>this.egressedBytesMaxSize||this.pendingQueue.length>this.pendingMaxSize||this.egressedCache.size>this.egressedMaxSize;if(o||n){let e="";e+=this.pendingQueue.length>=this.pendingMaxSize?"Pending queue max exceeded. ":"",e+=this.egressedCache.size>=this.egressedMaxSize?"Egressed cache max exceeded. ":"",e+=this.egressBytesTotal>this.egressedBytesMaxSize?"Egressed bytes max exceeded. ":"",e+=this.egressMessageCount>=this.rpsThreshold?"RPS exceeded. ":"",e+=this.egressByteCount>=this.bpsThreshold?"BPS exceeded. ":"",this.collectTelemetry(!1,e,`pendingQueueSize: ${this.pendingQueue.length} | egressedCacheSize: ${this.egressedCache.size} | egressedBytesTotal: ${this.egressBytesTotal} | rpsThreshold: ${this.rpsThreshold} | bpsThreshold: ${this.bpsThreshold}`)}else!this.hasBeenOpened||o||this.pendingQueue.length>0||n?this.pendingQueue.push({messageId:null!=t?t:"id"+this.emptyMessageId++,message:e}):this.sendToWebSocket(e,t)}sendToWebSocket(e,t){try{this.worker.egress(e);const s=e instanceof ArrayBuffer?e.byteLength:e.length;this.logEgressCount(s),this.lastEgressTime=Date.now(),t&&t.startsWith("c")&&(this.egressBytesTotal+=s,this.egressedCache.set(t,s))}catch(e){this.collectTelemetry(!1,"sendToWebSocket")}}flush(){for(;this.hasBeenOpened&&this.pendingQueue.length>0&&this.pendingQueue.length<this.pendingMaxSize&&this.egressedCache.size<this.egressedMaxSize&&this.egressMessageCount<this.rpsThreshold&&this.egressByteCount<this.bpsThreshold&&this.egressBytesTotal<this.egressedBytesMaxSize;){const{message:e,messageId:t}=this.pendingQueue.shift();this.sendToWebSocket(e,t)}}validateSyncMessage(e,t){void 0===t||void 0===e||t<=this.prevSeq||(t&&t!==this.prevSeq+1&&this.collectTelemetry(!0,"abandonedSyncMessage","Gap in sync message",[`${this.prevSeq}`,`${t}`,""+(t-this.prevSeq)]),this.prevSeq=t)}logEgressCount(e){var t;const s=Date.now();s-this.egressRateControlIntervalStart>1e3&&((this.egressMessageCount>50||this.egressByteCount>tt)&&(this.egressRateLogOp.start(),this.egressRateLogOp.resultDescription=this.egressMessageCount>50?"rps limit exceeded":"",this.egressRateLogOp.resultDescription=this.egressByteCount>tt?"bps limit exceeded":"",this.egressRateLogOp.dimension0=(s-this.egressRateControlIntervalStart).toString(),this.egressRateLogOp.dimension1=`${this.egressMessageCount}`,this.egressRateLogOp.dimension2=`${this.egressByteCount}`,g.a.info(509370642,g.b.CoreDefault,this.egressRateLogOp.stop())),"Production"!==(null===(t=this.clientMetadata)||void 0===t?void 0:t.releaseAudienceGroup)&&this.collectTelemetry(!0,"","egress",[`${0===this.pendingQueue.length?"0":this.pendingQueue.length.toString().length}`,`${0===this.egressedCache.size?"0":this.egressedCache.size.toString().length}`,`${0===this.egressBytesTotal?"0":this.egressBytesTotal.toString().length}`,`${this.rpsThreshold} | ${this.bpsThreshold}`]),this.egressRateControlIntervalStart=s,this.egressMessageCount=0,this.egressByteCount=0),this.egressMessageCount++,this.egressByteCount+=null!=e?e:0}}st.pingPongMessage="~",st.className="WebSocketRateController";class ot{constructor(e,t,s,o,n,i,r,a,c){this.logCountLimiter=new q(ot.className),this.isWorkerReady=!1,this.permanentlyClosed=!1,this.currentReconnectAttempt=0,this.lastInitializationAttemptTimeMs=0,this.offlineInterval=void 0,this.alreadyLoggedReconnectAttempt=!1,this.httpTestsLeft=5,this.httpTestsSuccessCount=0,this.wsOpenCount=0,this.testHttpConnection=e=>{const t=$.convertWebSocketUrlToHttp(this.globalUrl),s=!e,o=null!=e?e:new p({operationName:"HttpsTest",resourceId:t,success:!1,resultDescription:"",resultSignature:"HttpResponse:"}).start();!function(e,t,s){const o=new Ze.Request(e,t);et.add(o,s)}(t,{method:"POST",headers:{"content-type":"application/json","X-CorrelationId":o.cv},body:JSON.stringify($.createHealthCheckRequest(this.clientMetadata))},((e,t)=>{e?(o.dimension1="HttpErr",o.resultDescription+=`HttpErr: ${e.message}`):t&&t.ok?(o.dimension1="HttpOK",this.leaveOfflineMode(),this.httpTestsSuccessCount++,s&&(o.success=!0)):(o.dimension1="HttpNoResp",o.resultDescription+=`HttpStatus: ${null==t?void 0:t.status}`),s&&o.stop(),this.logCountLimiter.log((()=>{g.a.info(558445283,g.b.CoreDefault,o)}))}))},this.globalUrl=e,this.clientMetadata=t,this.workerFactory=s,this.sessionInitializer=o,this.ingress=n,this.onConnectionClose=i,this.onDetectedWSBlock=r,this.closeWSBlockedSession=a.closeWSBlockedSessionEnabled,this.sessionOfflineModeEnabled=a.sessionOfflineModeEnabled,this.improvedWebSocketEnabled=a.improvedWebSocketEnabled,this.improvedWebSocketEnabled&&(this.websocketSettings=c)}init(e,t,s=!1){if(this.permanentlyClosed)return Promise.reject(new Error("permanentlyClosed"));if(this.isWorkerReady||this.pendingInitPromise)return this.pendingInitPromise?this.pendingInitPromise:Promise.resolve();this.extensionConfigs=e||this.extensionConfigs;const o=()=>{if(s||!this.alreadyLoggedReconnectAttempt){const e=s?ot.initialAttemptTimeout:ot.reconnectAttemptTimeout;this.connTimeout=setTimeout((()=>{const t=new p({operationName:"ConnectionFailingOrSlow",dimension0:s?"Initial":"Reconnect",dimension1:e.toString(),dimension2:this.currentReconnectAttempt.toString()});g.a.info(572838096,g.b.CoreDefault,t),this.alreadyLoggedReconnectAttempt=!s,this.connTimeout=void 0}),e)}};return t?this.pendingInitPromise=t().catch((e=>{const t=new p({operationName:"WorkerManagerCustomInit",success:!1,resultDescription:`${e}`});g.a.error(572838097,g.b.CoreDefault,t)})).then(():(this.pendingInitPromise=Promise.resolve(),o(),this.initInternal()),this.pendingInitPromise}egress(e){return!this.isWorkerReady&&this.pendingInitPromise?this.pendingInitPromise.then((()=>{this.egressInternal(e)})):(this.egressInternal(e),Promise.resolve())}egressBytes(e){return!this.isWorkerReady&&this.pendingInitPromise?this.pendingInitPromise.then(():(this.egressBytesInternal(e),Promise.resolve())}close(e){this.isWorkerReady=!1,this.worker&&(this.worker.close(),this.worker=null),this.improvedWebSocketEnabled&&(this.websocketRateController&&this.getWebSocketRateController().close(),this.websocketRateController=null),this.permanentlyClosed=e||this.permanentlyClosed,this.permanentlyClosed&&(this.leaveOfflineMode(),clearTimeout(this.connTimeout))}initInternal(){if(this.isWorkerReady=!1,this.permanentlyClosed||this.isOffline()){const e=new p({operationName:"WorkerManagerInitOffline",success:!0,resultSignature:this.permanentlyClosed?"PermanentlyClosed":"Offline"});g.a.info(509134870,g.b.CoreDefault,e)}else this.currentReconnectAttempt>0?setTimeout((()=>{this.tryToConnectAndInitializeSession()}),((e,t)=>{let s=0;const o=$.getCurrentTimeMs()?$.getCurrentTimeMs()-t:0,n=[1e3,2e3,5e3,1e4,6e4];return s=n[Math.max(0,Math.min(n.length-1,e-1))],s=Math.max(s-o,1e3),s})(this.currentReconnectAttempt,this.lastInitializationAttemptTimeMs)):this.tryToConnectAndInitializeSession()}egressInternal(e){if(!this.isWorkerReady&&!b.matchesTypesFor(e,[ce.getTypeName()]))return void(b.matchesTypesFor(e,[ie.getTypeName()])||g.a.error(572838098,g.b.CoreDefault,new p({operationName:"UnexpectedEgressCall",resultDescription:`isWorkerReady: ${this.isWorkerReady}`})));let t;if(b.matchesTypesFor(e,[Ce.getTypeName()])?(this.castBinaryData(e),t=Xe.a.serialize(e)):t=JSON.stringify(e),this.improvedWebSocketEnabled){let s;ve.typeGuard(e)&&(s=e.seq),this.getWebSocketRateController().egress(t,e.messageId,s)}else this.worker.egress(t)}egressBytesInternal(e){this.isWorkerReady?this.improvedWebSocketEnabled?this.getWebSocketRateController().egress(e):this.worker.egress(e):g.a.error(572838099,g.b.CoreDefault,new p({operationName:"UnexpectedEgressBytesCall",resultDescription:`isWorkerReady: ${this.isWorkerReady}`}))}tryToConnectAndInitializeSession(){this.currentReconnectAttempt++,this.lastInitializationAttemptTimeMs=$.getCurrentTimeMs();const e=t=>{this.permanentlyClosed||this.isOffline()||(this.connect(this.sliceUrl?this.sliceUrl:this.globalUrl),this.sessionInitializer.initSession({isTokenRefresh:!1,isReconnectOnSameSlice:!!this.sliceUrl,extensionConfigs:this.extensionConfigs,onResponse:(s,o)=>{if(t.success=!s,t.resultDescription=s?`WS Error: ${s.error}`:"",t.resourceId=o?o.sliceUrl:"",t.dimension0=t.success?"WSOK":"WSFail",s||!this.worker)return this.sliceUrl=void 0,this.close(),this.httpTestsLeft>0?(this.httpTestsLeft--,this.testHttpConnection(t.stop())):(this.closeWSBlockedSession&&0===this.wsOpenCount&&this.httpTestsSuccessCount>=5?(this.permanentlyClosed=!0,t.dimension1="WSBlocked",this.onDetectedWSBlock()):this.sessionOfflineModeEnabled&&0===this.httpTestsSuccessCount&&(this.startOfflineMode(),t.dimension1="WSOffline"),this.logCountLimiter.log((()=>{g.a.info(572838100,g.b.CoreDefault,t.stop())}))),void this.initInternal();if(this.logCountLimiter.log((()=>{g.a.info(555823373,g.b.CoreDefault,t.stop())})),o.forceReconnect){this.close();const t=new p({operationName:"ForcedReconnect"}).start();t.resultSignature=`globalUrl: ${this.globalUrl}. sliceUrl: ${this.sliceUrl}`,this.sliceUrl=void 0,setTimeout((()=>{e(t)}),1e3)}else clearTimeout(this.connTimeout),this.sliceUrl=o.sliceUrl,this.ready();this.resetHttpTestsCounter()}}))},t=new p({operationName:"TryToConnectAndInitializeSession",resultSignature:`Reconnection attempt #${this.currentReconnectAttempt}`}).start();e(t)}onnect(e){this.worker=this.workerFactory(),this.worker.init(e,this.improvedWebSocketEnabled?this.getWebSocketRateController().ingressFromWebSocket.bind(this.websocketRateController):this.ingress,(()=>{this.wsOpenCount++,this.improvedWebSocketEnabled&&this.getWebSocketRateController().open(),this.leaveOfflineMode()}),(,this.improvedWebSocketEnabled),this.improvedWebSocketEnabled&&this.getWebSocketRateController().init(this.worker,this.ingress,this.clientMetadata)}readyastBinaryData(e){if(e){if(Array.isArray(e.__binaryMembers__))for(const t of e.__binaryMembers__)ArrayBuffer.isView(e[t])||(e[t]=new Uint8Array(e[t]));for(const t of Object.keys(e))"object"==typeof e[t]&&null!==e[t]&&this.castBinaryData(e[t])}}isOffline(){return!!this.offlineInterval}eaveOfflineMode(){this.isOffline()&&(clearInterval(this.offlineInterval),this.offlineInterval=void 0,this.resetHttpTestsCounter(),this.tryToConnectAndInitializeSession())}ot.initialAttemptTimeout=1e5,ot.reconnectAttemptTimeout=2e4,ot.className="WebSocketWorkerManager";class nt extends Ge.EventEmitter{constructor(e,t,s,o,n,i,r,a){super(),this.cvParent=new V,this.logOp=new p({operationName:"SessionState",success:!0}).start(),this.sessionStateChangeLogCountLimiter=new q("SessionState"),this.stats=t,this.allStates={[Fe.Initing]:new Je(this),[Fe.Running]:new Ke(this),[Fe.Disconnected]:new Qe(this),[Fe.Closed]:new Ye(this)},this.setState(Fe.Initing),this.improvedWebSocketEnabled=r.improvedWebSocketEnabled,this.messageEndpoint=new Re("c"),this.messageEndpoint.setClientMetadata(n),this.messageEndpoint.setEgress(this.egress.bind(this)),this.messageEndpoint.onMessage(ue.getTypeName(),(),this.webSocketWorkerManager=new ot(e,n,s,o,this.ingress.bind(this),this.onConnectionClose.bind(this),(()=>{this.onSessionClose(void 0,"WSNotSupported")}),r,a),this.messageQueue=new $e({sendMessage:(e,t,s,o)=>this.state.sendMessage(e,t,s,o),sendBytes:this.sendBytes.bind(this),canSendMessage:dropOnlySequencedSyncsOnReseed:r.dropOnlySequencedSyncsOnReseedEnabled}),o.on("connect",((e,t,s,o,n,i)=>{this.setState(Fe.Running,"",{isSessionReseedingStarted:e&&t}),this.emit("connect",e,s,o,n,i)})),o.on("reconnect",(()=>this.emit("reconnect"))),o.on("serverAuthenticationStateChange",(),this.resetNextSyncSequenceId=this.tokenRefreshManager=i}setState(e,t,s){if(this.state&&e===this.state.stateName)return;const o=this.state?Fe[this.state.stateName]:"undefined",n=this.state?this.state.possibleNextStates.indexOf(e)>=0:e===Fe.Initing;this.sessionStateChangeLogCountLimiter.log((()=>{this.logOp.stop(),this.logOp.resourceId=`New state: ${n?Fe[e]:o}`,this.logOp.resultDescription=`Previous state: ${o}`,this.logOp.dimension0=`Attempted state: ${Fe[e]||"undefined"}`,this.logOp.resultSignature=t+(this.state&&!n?"Unexpected state change":""),this.logOp.success=n,g.a.info(573167323,g.b.CoreDefault,this.logOp)})),n&&(this.state=this.allStates[e],this.logOp.start(),this.state.onEnter(s))}init(e,t){return this.extensionConfigs=e,this.customInitPromise=t,this.webSocketWorkerManager.init(this.extensionConfigs,this.customInitPromise,!0)}sendMessageendBytes(e){this.state.sendBytes(e)}onMessage(e,t){this.messageEndpoint.onMessage(e,t)}getCorrelationVector(){return this.cvParent}forceReconnect(e){return this.extensionConfigs=e||this.extensionConfigs,this.webSocketWorkerManager.close(!1),new Promise((e=>setTimeout((()=>{e(this.webSocketWorkerManager.init(this.extensionConfigs))}),100)))}closeSession(){this.sendMessage(new ue),this.webSocketWorkerManager.close(!0),this.onSessionClose(void 0,"ClientRequested")}ingress(e,t){let s;try{s=JSON.parse(e)}catch(e){g.a.error(573167324,g.b.CoreDefault,new oe({sessionHealthEventName:"ProcessMessage",resourceId:"Unknown",success:!1,resultSignature:"ParseError",resultDescription:e.message,durationMs:0,source:Q.ClientRuntime,reason:Y.Client,impact:X.MissingOutput,affectedWorkflows:["All"],message:""}))}this.improvedWebSocketEnabled&&t&&ie.typeGuard(s)&&t(s.messageId),s&&this.messageEndpoint.ingress(s,((e,t)=>this.egress(e||t,(()=>{}))))}egress(e,t){e&&this.webSocketWorkerManager.egress(e).then(().catch((e=>t(e)))}onSessionCloseMessage(e,t){e.reconnectAllowed?this.webSocketWorkerManager.close():this.onSessionClose(e,"CloseMessageReceived"),t()}onSessionClose(e,t){this.setState(Fe.Closed,t),this.tokenRefreshManager.clearAllTimeouts(),this.onConnectionClose(void 0),e&&this.emit("sessionClose",e)}onConnectionClose(e){this.state.onConnectionClose(),this.stats.lastConnectionClose=$.getCurrentTimeMs(),this.emit("disconnect",e)}retrySendMessage(e,t,s,o){this.state.sendMessage(e,((n,i)=>{n&&s>0&&this.canBeRetried(e)&&this.isTransientError(n)?this.retrySendMessage(e,t,s-1,o):t&&t(n,i)}),nt.maxRetries-s,o)}canBeRetried(e){return!b.matchesTypesFor(e,[ce.getTypeName(),Ce.getTypeName()])}isTransientError(e){const t=e.error;return t!==Z.SyncMessageUnsupportedBatch&&t!==Z.UnexpectedSeedMessage&&t!==Z.UnsupportedSyncMessage&&t!==Z.AnnotationTokenNotFound&&t!==Pe.ArrivedBeforeReseeding&&t!==Pe.DroppedAsOldestInQueue&&t!==Pe.DroppedBecauseClientDisconnected}}var it,rt,at,ct,lt,ut,pt,ht,dt;nt.maxRetries=2,function(e){e[e.Idle=0]="Idle",e[e.Pending=1]="Pending"}(it||(it={}));class gt{constructor(e){b.assign(gt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_WorkflowRegistrationMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return b.matchesTypesFor(e,[gt.getTypeName()])}}gt.H_={T_:gt.getTypeName(),B_:gt.getBaseTypes()};class ft{constructor(e){b.assign(ft,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowExecutionRequest"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return b.matchesTypesFor(e,[ft.getTypeName()])}}ft.H_={T_:ft.getTypeName(),B_:ft.getBaseTypes()};class mt{constructor(e){b.assign(mt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowExecutionResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return b.matchesTypesFor(e,[mt.getTypeName()])}}mt.H_={T_:mt.getTypeName(),B_:mt.getBaseTypes()};class yt{constructor(e){b.assign(yt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_RuntimeInitMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return b.matchesTypesFor(e,[yt.getTypeName()])}}yt.H_={T_:yt.getTypeName(),B_:yt.getBaseTypes()};class Tt{constructor(e){b.assign(Tt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_DiagnosticTraceMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return b.matchesTypesFor(e,[Tt.getTypeName()])}}Tt.H_={T_:Tt.getTypeName(),B_:Tt.getBaseTypes()};class wt{constructor(e){b.assign(wt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_TelemetryMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return b.matchesTypesFor(e,[wt.getTypeName()])}}wt.H_={T_:wt.getTypeName(),B_:wt.getBaseTypes()};class vt{constructor(e){b.assign(vt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_TelemetryFlushMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return b.matchesTypesFor(e,[vt.getTypeName()])}}vt.H_={T_:vt.getTypeName(),B_:vt.getBaseTypes()};class Ct{constructor(e){b.assign(Ct,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_SessionCloseResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return b.matchesTypesFor(e,[Ct.getTypeName()])}}Ct.H_={T_:Ct.getTypeName(),B_:Ct.getBaseTypes()};class kt{constructor(e){b.assign(kt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_WorkflowDefinitionOverrideMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return b.matchesTypesFor(e,[kt.getTypeName()])}}kt.H_={T_:kt.getTypeName(),B_:kt.getBaseTypes()},function(e){e[e.JSWebSockets=0]="JSWebSockets",e[e.LocalWorkflowsOnly=1]="LocalWorkflowsOnly",e[e.HostWebSockets=2]="HostWebSockets"}(rt||(rt={})),function(e){e[e.None=0]="None",e[e.HttpsGetDownloadUrl=1]="HttpsGetDownloadUrl",e[e.AlCodedLocation=2]="AlCodedLocation"}(at||(at={})),function(e){e[e.NewDocument=0]="NewDocument",e[e.EditDocument=1]="EditDocument",e[e.ViewOnlyDocument=2]="ViewOnlyDocument"}(ct||(ct={}));class _t{}_t.lowerIndexBound=1,_t.maxNumberOfRows=1048576,_t.maxNumberOfColumns=16384,_t.firstColumnName="A",_t.lastColumnName="XFD",lt||(lt={})),function(e){e[e.Augloop=0]="Augloop",e[e.Substrate=1]="Substrate"}(ut||(ut={}));class bt{constructor(e,t,s){this.sendMessage=e,this.annotationType=t,this.options=s,this.token=`${t}-${bt.nextActivationResultBatchId++}`}activate(e,t){return new Promise(((s,o)=>{this.sendMessage(new de({annotationType:this.annotationType,token:this.token,config:this.options?this.options.config:void 0,ignoreExistingAnnotations:e,sendStateUpdates:this.options?!!this.options.stateUpdateCallback:void 0}),((e,t)=>{e?o(new Error(e.error)):s({token:this.token})}),t)}))}release(){return new Promise(((e,t)=>{this.sendMessage(new me({token:this.token}),((s,o)=>{s?t(new Error(s.error)):e(o.lastRelease)}))}))}}bt.nextActivationResultBatchId=1,function(e){e[e.Input=0]="Input",e[e.Exception=1]="Exception",e[e.WaitOn=2]="WaitOn",e[e.StopAndFilterWorkflow=3]="StopAndFilterWorkflow"}(pt||(pt={})),function(e){e[e.Unknown=0]="Unknown",e[e.NoOutput=1]="NoOutput",e[e.Authentication=2]="Authentication",e[e.JoinTimedOut=3]="JoinTimedOut",e[e.LambdaThrow=4]="LambdaThrow",e[e.LambdaErrorCallback=5]="LambdaErrorCallback"}(ht||(ht={})),function(e){e[e.ExceedingMaxSize=0]="ExceedingMaxSize",e[e.GroupComplete=1]="GroupComplete",e[e.BatchIntervalElapsed=2]="BatchIntervalElapsed"}(dt||(dt={}));class St{ddBatchItem(e,t,s,o,n,i){const{delayMs:r,maxInputSize:a,estimateSize:c,groupingKeyExtractor:l}=t,u=c(e),p=l(e);if(t.split&&u>a){let r;try{r=t.split(e)}catch(e){const t=new Error("Split error: "+e.message);return void(i?i(t):g.a.error(573366352,g.b.CoreDefault,t))}if(r&&Array.isArray(r.inputs)&&r.inputs.length>1){let e;const a=[],c=i?(t,s)=>{if(e=e||t,a.push(s),a.length===r.inputs.length){let s;try{s=r.join(a)}catch(t){return void i(new Error("Join error: "+t.message))}i(e,s)}}:void 0;for(let e=0;e<r.inputs.length;e++)this.addBatchItem(r.inputs[e],t,s,o,n&&e===r.inputs.length-1,c);return}}let h=this.batchesByGroupingKey.get(p);h&&h.size+u>a&&(clearTimeout(h.timeout),this.executeBatch(p,h,t,dt.ExceedingMaxSize),h=void 0),h||(h={items:[],size:0,hasItemsWithCallbacks:!1,context:s},this.batchesByGroupingKey.set(p,h)),h.items.push({input:e,size:u,callback:i}),h.size+=u,h.hasItemsWithCallbacks=h.hasItemsWithCallbacks||!!i,h.cv=o,h.groupComplete=n,clearTimeout(h.timeout),h.groupComplete?this.executeBatch(p,h,t,dt.GroupComplete):h.timeout=setTimeout((()=>{this.executeBatch(p,h,t,dt.BatchIntervalElapsed)}),r)}removeAllBatchedItems(){this.batchesByGroupingKey.forEach((),this.batchesByGroupingKey.clear()}executeBatch(e,t,s,o){this.batchesByGroupingKey.delete(e);const n=t.items,i=e=>e<0?"Negative":0===e?"0":1===e?"1":`Magnitude ${e.toString().length}`,r=new p({operationName:"ExecuteBatch",cv:t.cv,resourceId:t.context.name,dimension0:`Count ${i(n.length)}`,dimension1:`Size ${i(t.size)}`,dimension2:o.toString()}).start(),a=(e,s,o)=>{let i;if(s&&s.exceptionType===ht.NoOutput)r.success=!0,g.a.info(573366353,g.b.CoreDefault,r.stop());else{const o=`${e} error: ${s?s.message||s:"Unknown error"}`;i=s||new Error(o),r.success=!1,r.resultDescription=`Batch of ${n.length} items of size ${t.size} with ${o}`,r.resultSignature=`${e} Error`,g.a.error(573366354,g.b.CoreDefault,r.stop())}if(t.hasItemsWithCallbacks)for(const e of n)e.callback&&e.callback(i,o)};let c;try{c=s.multiplex(n.map((e=>e.input)))}catch(e){return void a("Multiplex",e)}this.submit(c.input,t,((e,o)=>{if(e||o&&("exceptionType"in o||o instanceof Error))a("Submit",e||o,o);else if(t.hasItemsWithCallbacks||s.summaryExtractor){let i,l,u;if(t.hasItemsWithCallbacks)try{if(i=c.demultiplex(o),i.length!==n.length)throw new Error("Mismatched output length")}catch(e){return void a("Demultiplex",e)}if(s.summaryExtractor)try{[u,l]=s.summaryExtractor(o)}catch(e){return void a("SummaryExtractor",e)}if(r.success=!0,g.a.info(573366342,g.b.CoreDefault,r.stop()),t.hasItemsWithCallbacks)for(let e=0;e<n.length;e++)n[e].callback&&n[e].callback(void 0,i[e]);l&&this.onSummary(u,l,t.context)}else r.success=!0,g.a.info(573366343,g.b.CoreDefault,r.stop())}))}}const At=It=(e,t)=>{let s=0;const o=[],n=[e];for(;n.length>0;){const e=n.pop(),i=typeof e;if("boolean"===i)s+=4;else if("string"===i)s+=2*e.length;else if("number"===i)s+=8;else if("object"===i&&e&&-1===o.indexOf(e))if(e instanceof Uint8Array)s+=e.length;else{o.push(e);for(const t in e)n.push(e[t])}if(s>t)return s}return s};var xt,Nt,Mt,Bt,Dt,Et,Ot,Wt,Lt,Rt,Pt,Ft,Gt,Ht;!function(e){e[e.NotAuthenticated=0]="NotAuthenticated",e[e.Pending=1]="Pending",e[e.Authenticated=2]="Authenticated"}(xt||(xt={})),Nt||(Nt={})),function(e){e[e.Unknown=0]="Unknown",e[e.Consumer=1]="Consumer",e[e.Enterprise=2]="Enterprise"}(Mt||(Mt={})),Bt||(Bt={})),function(e){e[e.SingleItem=0]="SingleItem",e[e.Reduce=1]="Reduce",e[e.Grid=2]="Grid",e[e.DynamicText=3]="DynamicText",e[e.Join=4]="Join",e[e.Generic=5]="Generic"}(Dt||(Dt={})),function(e){e[e.Default=0]="Default",e[e.LocalOnly=1]="LocalOnly",e[e.Exclusive=2]="Exclusive"}(Et||(Et={})),function(e){e[e.PreActivate=0]="PreActivate",e[e.Default=1]="Default",e[e.DelayActivate=1]="DelayActivate",e[e.NeverActivate=2]="NeverActivate"}(Ot||(Ot={})),Wt||(Wt={})),function(e){e[e.Never=0]="Never",e[e.Always=1]="Always"}(Lt||(Lt={})),function(e){e[e.PreSeed=1]="PreSeed",e[e.OnSeed=2]="OnSeed",e[e.PostSeed=4]="PostSeed",e[e.All=5]="All"}(Rt||(Rt={})),function(e){e[e.UpstreamWorkflowsReady=0]="UpstreamWorkflowsReady",e[e.AnnotationMetadataUpdated=1]="AnnotationMetadataUpdated",e[e.DeltaUpdate=2]="DeltaUpdate",e[e.NonExclusiveTriggerSignals=3]="NonExclusiveTriggerSignals"}(Pt||(Pt={})),function(e){e[e.Character=1]="Character",e[e.Paragraph=2]="Paragraph"}(Ft||(Ft={})),Gt||(Gt={})),function(e){e.SetPredefinedAnnotation="SetPredefinedAnnotation",e.ClearAnnotations="ClearAnnotations"}(Ht||(Ht={}));const Ut=(e,t)=>{const s=[];for(const o of null!=e?e:[])if(void 0===t||t===o.cardinality)for(const e of o.contextTypes)s.push([e,o.cardinality,o.producerWaitPolicy]);return s},$t=qt=e=>Array.isArray(e)?5===e.length?`${e[0]}\\${e[1]}\\${e[2]}\\${e[3]}\\${e[4]}`:4===e.length?`${e[0]}\\${e[1]}\\${e[2]}\\${e[3]}`:3===e.length?`${e[0]}\\${e[1]}\\${e[2]}`:2===e.length?`${e[0]}\\${e[1]}`:1===e.length?e[0]:e.join("\\"):"(malformed path)";var jt;!function(e){e[e.Local=0]="Local",e[e.External=1]="External"}(jt||(jt={}));class zt{constructor(){this.graphNodeByLocationAndWorkflowId=new Map}getWorkflow(e,t){var s;const o=this.getLocation(t);return null===(s=this.graphNodeByLocationAndWorkflowId.get(o))||void 0===s?void 0:s.get(e)}addWorkflow(e,t=!1){if(this.getWorkflow(e.id,t)){const s=new p({operationName:"AddWorkflowToGraphFailure",success:!1,resourceId:e.id,resultDescription:`Adding a new with workflow with a duplicated workflowId: ${t}`}).start();return void g.a.error(524300630,g.b.CoreDefault,s.stop())}const s=this.getLocation(t),o=new Vt(e,s);this.addWorkflowAsDependency(o);let n=this.graphNodeByLocationAndWorkflowId.get(s);n||(n=new Map,this.graphNodeByLocationAndWorkflowId.set(s,n)),n.set(e.id,o)}getUpstreamRuntimeVisibleWorkflows(){const e=[];for(const t of this.graphNodeByLocationAndWorkflowId.values()||[])for(const s of t.values()||[]){const t=this.createWorkflowDefinition(s.workflow);s.workflow.visibility===Et.LocalOnly?this.compressDownstreamWorkflows(t,s):t.outputTypes.push(...s.workflow.outputTypes),0!==t.inputTypes.length&&e.push(t)}return e}removeWorkflows(e){const t=this.getLocation(e),s=this.graphNodeByLocationAndWorkflowId.get(t),o=Array.from((null==s?void 0:s.values())||[]);for(const e of o){for(const t of e.upstreamWorkflows.values())t.downstreamWorkflows.delete(e);for(const t of e.downstreamWorkflows.values())t.upstreamWorkflows.delete(e);s.delete(e.workflow.id)}}getWorkflowsDefinitions(){const e=[];for(const t of this.graphNodeByLocationAndWorkflowId.values()||[])for(const s of t.values()||[])e.push(s.workflow);return e}getWorkflowNodes(e){const t=[];for(const e of this.graphNodeByLocationAndWorkflowId.values())for(const s of e.values())t.push(s);return t}getLocationreateWorkflowDefinition(e){return Object.assign(Object.assign({},e),{outputTypes:[]})}compressDownstreamWorkflows(e,t){for(const s of t.downstreamWorkflows)if(s.workflow.visibility!==Et.LocalOnly){if(s.workflow.kind!==Dt.Join||-1!==e.inputTypes.indexOf(s.workflow.collectionScopeType))for(const t of s.workflow.outputTypes)-1===e.outputTypes.indexOf(t)&&e.outputTypes.push(t)}else this.compressDownstreamWorkflows(e,s)}addWorkflowAsDependency(e){for(const t of this.graphNodeByLocationAndWorkflowId.values())for(const s of t.values()){for(const t of s.workflow.inputTypes)-1!==e.workflow.outputTypes.indexOf(t)&&this.addWorkflowChain(e,s);for(const t of s.workflow.outputTypes)-1!==e.workflow.inputTypes.indexOf(t)&&this.addWorkflowChain(s,e)}}addWorkflowChainclass Vt{constructor(e,t){this.upstreamWorkflows=new Set,this.downstreamWorkflows=new Set,this.location=t,this.workflow=Object.assign(Object.assign({},e),{inputTypes:Array.isArray(e.inputTypes)?e.inputTypes:[],outputTypes:Array.isArray(e.outputTypes)?e.outputTypes:[]})}}const Jt=Kt=(e,t)=>null!=e&&null!=t&&e.length>0&&(e===t||0===t.indexOf(e)&&"."===t.charAt(e.length));class Qt{tatic mergeDefinitions(e,t,s){return Object.assign(Object.assign(Object.assign({},e),t),s)}mergeWorkflowDefinition(e,t,s){if(s){const o=((e,t,s)=>{let o=e.get(t);return o||(o=(()=>new Map)(),e.set(t,o)),o})(this.workflowDefByWorkflowAndContextId,e.id);o.set(s,Qt.mergeDefinitions(e,o.get(s),t))}else this.workflowDefByWorkflow.set(e.id,Qt.mergeDefinitions(e,this.workflowDefByWorkflow.get(e.id),t))}getWorkflowDefinition(e,t){var s;let o;return t&&(o=null===(s=this.workflowDefByWorkflowAndContextId.get(e.id))||void 0===s?void 0:s.get(t)),o||(o=this.workflowDefByWorkflow.get(e.id)),o||(o=e),o}deleteWorkflowDefinition(e,t){const s=this.workflowDefByWorkflowAndContextId.get(e.id);s&&(s.delete(t),0===s.size&&this.workflowDefByWorkflowAndContextId.delete(e.id))}}const Yt=new Set([D.getTypeName(),W.getTypeName(),U.getTypeName(),G.getTypeName()]);class Xt{plyContextIdOnOperations(e){for(const t of e){const e=b.getTypeNameFor(t);if(this.isSupportedOperation(e))for(const e of t.items)e.contextId?e.source&&this.workflowGraph.getWorkflow(e.source,!1)?e.contextId=this.addNewContextId(e.contextId):this.tryLogMessage(new p({operationName:"ApplyContextIdOnOperations",success:!0}).start(),"Item with a contextId but without a workflow source atribute"):e.contextId=this.addNewContextId()}}addNewContextId(e){const t=`${this.runtimeKind}${this.nextId++}`;return e?`${e}.${t}`:t}ryLogMessage(e,t,s=!0){e&&(e.success=s,e.resultDescription=t,g.a.verbose(527308633,g.b.CoreDefault,e.stop()))}}var Zt,es,ts,ss;!function(e){e[e.Idle=1]="Idle",e[e.Pending=2]="Pending",e[e.Running=3]="Running",e[e.Executed=4]="Executed"}(Zt||(Zt={}));class os{etScopeItem(e,t){var s;const o=e.contextId;if(o)if(this.itemsByWorkflowAndContextId.has(t.id)||this.itemsByWorkflowAndContextId.set(t.id,new Map),this.itemsByWorkflowAndContextId.get(t.id).set(o,[]),this.scopeItemsByContextId.has(o)){if(null===(s=this.itemsByWorkflowAndContextId.get(t.id))||void 0===s?void 0:s.has(o)){const s=new p({resultDescription:`Trying to set new scope item: ${e.id} with already existing contextId ${o} for workflow ${t.id}`,operationName:"WIS.setScopeItem",resourceId:t.id,success:!0}).start();g.a.verbose(527291288,g.b.CoreDefault,s.stop())}}else this.scopeItemsByContextId.set(o,e)}getScopeItem(e,t){var s;for(const o of(null===(s=this.itemsByWorkflowAndContextId.get(t.id))||void 0===s?void 0:s.keys())||[])if(Kt(o,e))return this.scopeItemsByContextId.get(o)}addItemToWorkflowList(e,t){const s=e.contextId;if(!s)return;const o=this.itemsByWorkflowAndContextId.get(t.id);if(o)for(const[n,i]of o)if(Kt(n,s)){i.push(e);const s=new p({resultDescription:`Items for contextId ${n}: [${i.map((e=>e.id)).join(",")}]`,operationName:"WIS.addItemOnContextIdList",resourceId:t.id,success:!0}).start();g.a.info(526403808,g.b.CoreDefault,s.stop())}}isWorkflowReady(e,t){const s=this.workflowDefinitionManager.getWorkflowDefinition(t,e).maxAnnotations;return this.getGeneratedItems(e,t).length>=s}getItemsToExecute(e,t){const s=this.getGeneratedItems(e,t);return this.itemsByWorkflowAndContextId.get(t.id).delete(e),s}onWorkflowExecuted(e,t){const s=e.contextId,o=this.itemsByWorkflowAndContextId.get(t.id);o&&(o.delete(s),0===o.size&&this.itemsByWorkflowAndContextId.delete(t.id)),this.hasWorkflowsAwaitingExecution(s)||this.scopeItemsByContextId.delete(s)}getGeneratedItems(e,t){var s;if(!(null===(s=this.itemsByWorkflowAndContextId.get(t.id))||void 0===s?void 0:s.get(e)))return[];const o=this.workflowDefinitionManager.getWorkflowDefinition(t,e).maxAnnotations;return this.itemsByWorkflowAndContextId.get(t.id).get(e).slice(0,o)}hasWorkflowsAwaitingExecution(e){for(const t of this.itemsByWorkflowAndContextId.values())for(const s of t.keys())if(s===e)return!0;return!1}}!es||(es={}));class ns{constructor(e){b.assign(ns,this,e)}static getTypeName(){return"AugLoop_Text_TextTile"}static getBaseTypes(){return[]}static typeGuard(e){return b.matchesTypesFor(e,[ns.getTypeName()])}}ns.H_={T_:ns.getTypeName(),B_:ns.getBaseTypes()};class is{constructor(e){b.assign(is,this,e)}static getTypeName(){return"AugLoop_Text_FormattedTextTile"}static getBaseTypes(){return["AugLoop_Text_TextTile"]}static typeGuard(e){return b.matchesTypesFor(e,[is.getTypeName()])}}is.H_={T_:is.getTypeName(),B_:is.getBaseTypes()};class rs{constructor(e){b.assign(rs,this,e)}static getTypeName(){return"AugLoop_Text_DynamicTextContext"}static getBaseTypes(){return["AugLoop_Core_DynamicContext"]}static typeGuard(e){return b.matchesTypesFor(e,[rs.getTypeName()])}}rs.H_={T_:rs.getTypeName(),B_:rs.getBaseTypes()};class as{constructor(e){b.assign(as,this,e)}static getTypeName(){return"AugLoop_Text_TaskTile"}static getBaseTypes(){return["AugLoop_Text_FormattedTextTile","AugLoop_Text_TextTile"]}static typeGuard(e){return b.matchesTypesFor(e,[as.getTypeName()])}}as.H_={T_:as.getTypeName(),B_:as.getBaseTypes()};class cs{constructor(e){b.assign(cs,this,e)}static getTypeName(){return"AugLoop_Text_PersonTile"}static getBaseTypes(){return["AugLoop_Text_TextTile"]}static typeGuard(e){return b.matchesTypesFor(e,[cs.getTypeName()])}}cs.H_={T_:cs.getTypeName(),B_:cs.getBaseTypes()};class ls{constructor(e){b.assign(ls,this,e)}static getTypeName(){return"AugLoop_Text_DateTile"}static getBaseTypes(){return["AugLoop_Text_TextTile"]}static typeGuard(e){return b.matchesTypesFor(e,[ls.getTypeName()])}}ls.H_={T_:ls.getTypeName(),B_:ls.getBaseTypes()},function(e){e[e.Add=0]="Add",e[e.Delete=1]="Delete",e[e.Update=2]="Update",e[e.CursorUpdate=3]="CursorUpdate",e[e.FormattingUpdate=4]="FormattingUpdate",e[e.OtherNonContentUpdate=5]="OtherNonContentUpdate"}(ts||(ts={})),ss||(ss={}));class us{constructor(e){b.assign(us,this,e)}static getTypeName(){return"AugLoop_Text_TextTileDelta"}static getBaseTypes(){return["AugLoop_Core_ItemDelta"]}static typeGuard(e){return b.matchesTypesFor(e,[us.getTypeName()])}}us.H_={T_:us.getTypeName(),B_:us.getBaseTypes()};class ps{constructor(e){b.assign(ps,this,e)}static getTypeName(){return"AugLoop_Text_FormattedTextTileDelta"}static getBaseTypes(){return["AugLoop_Text_TextTileDelta","AugLoop_Core_ItemDelta"]}static typeGuard(e){return b.matchesTypesFor(e,[ps.getTypeName()])}}function hs(e,t=!1){switch(e){case 12288:case 8197:case 32:case 11:case 9:case 160:return!0;case 13:case 10:case 65532:return!t}return!1}function ds(e,t){return e.charCodeAt(t)>=56320&&e.charCodeAt(t)<=57343}ps.H_={T_:ps.getTypeName(),B_:ps.getBaseTypes()};var gs=s("OoM2"),fs=s.n(gs);const ms=/[ \u00a0\u2000-\u200a\u202f\u205f\u3000\t]/g,ys=/[.!?]/g;function Ts(e,t){const s=[],o=vs(e,t);return o&&s.push(o),s}function ws(e,t){const s=[],o=vs(e,t);o&&s.push(o);const n=function(e,t,s){var o,n,i,r,a,c;if((null==e?void 0:e.ipPosition)!==(null==t?void 0:t.ipPosition)||(null==e?void 0:e.isColdIp)!==(null==t?void 0:t.isColdIp)){if((null==e?void 0:e.isColdIp)===(null==t?void 0:t.isColdIp)&&s)if(s.deltaType===ts.Add){if((null==t?void 0:t.ipPosition)===(null!==(o=s.position)&&void 0!==o?o:0)+(null!==(n=s.length)&&void 0!==n?n:0))return}else if(s.deltaType===ts.Update){if((null==t?void 0:t.ipPosition)===(null!==(i=s.position)&&void 0!==i?i:0)+(null!==(a=null===(r=s.content)||void 0===r?void 0:r.length)&&void 0!==a?a:0))return}else if(s.deltaType===ts.Delete&&(null==t?void 0:t.ipPosition)===(null!==(c=s.position)&&void 0!==c?c:0))return;return new ps({deltaType:ts.CursorUpdate,cursorData:{ipPosition:null==t?void 0:t.ipPosition,isColdIp:null==t?void 0:t.isColdIp}})}}(e,t,o);n&&s.push(n);const i=function(e,t,s){var o,n,i,r,a,c,l;const u=e,p=t;if((null===(o=p.formattedRanges)||void 0===o?void 0:o.length)<=(null===(n=u.formattedRanges)||void 0===n?void 0:n.length))if(s){let e=u.formattedRanges?[...u.formattedRanges]:[];const t=function(e,t,s){if(e){if(t.deltaType===ts.Add){const t=e.find(();if(t)return t;s=Math.max(s-1,0)}return e.find((e=>0===e.length?e.start===s:e.start<=s&&s<e.start+e.length))}}(u.formattedRanges,s,s.position),o=t?e.indexOf(t):-1;if(-1!==o&&(s.position+(s.length||0)>t.start+t.length?t.length=s.position+(null!==(i=s.content)&&void 0!==i?i:"").length-t.start:t.length+=(null!==(r=s.content)&&void 0!==r?r:"").length-(s.length||0),e[o]=t),e.length>0){for(const t of e.slice(o+1))t.start<s.position||(s.position+(s.length||0)>t.start?(t.length=t.start+t.length-(s.position+(s.length||0)),t.start=s.position+(null!==(a=s.content)&&void 0!==a?a:"").length):t.start+=(null!==(c=s.content)&&void 0!==c?c:"").length-(s.length||0));e=e.filter(()}const n=null!==(l=null==p?void 0:p.formattedRanges)&&void 0!==l?l:[];if(fs()(e,n)||0===e.length&&0===n.length)return}else if(fs()(null==u?void 0:u.formattedRanges,null==p?void 0:p.formattedRanges))return;return new ps({deltaType:ts.FormattingUpdate,formattedRanges:null==p?void 0:p.formattedRanges})}(e,t,o);i&&s.push(i);const r=function(e,t){const s=e,o=t;let n;const i={};let r=!1;for(n in o)-1===["ipPosition","isColdIp","content","formattedRanges"].indexOf(n)&&(fs()(o[n],s[n])||(r=!0,i[n]=o[n]));if(r)return new ps({deltaType:ts.OtherNonContentUpdate,otherNonContentData:i})}(e,t);return r&&s.push(r),s}function vs(e,t){const s=e.content,o=t.content,n=function(e,t,s=!1){let o,n,i={firstDiffLeft:0,firstDiffRight:t.length};return e.length<t.length?(o=e,n=t):(o=t,n=e),0===n.indexOf(o)?(i.firstDiffLeft=o.length,i.firstDiffRight=0):n.endsWith(o)?(i.firstDiffLeft=0,i.firstDiffRight=o.length):(i=function(e,t,s=!1){const o={firstDiffLeft:0,firstDiffRight:t.length};let n;for(n=0;n<e.length&&n<t.length;n+=1){const o=e.charCodeAt(n),i=t.charCodeAt(n);if(!(o===i||hs(o,s)&&hs(i,s)))break}for(o.firstDiffLeft=n,n=0;n<e.length&&n<t.length;n+=1){const o=e.charCodeAt(e.length-n-1),i=t.charCodeAt(t.length-n-1);if(!(o===i||hs(o,s)&&hs(i,s)))break}return o.firstDiffRight=n,o}(e,t,s),i.firstDiffLeft+i.firstDiffRight>o.length&&(i.firstDiffRight=o.length-i.firstDiffLeft)),function(e,t,s){if(e.firstDiffLeft>0){const o=e.firstDiffLeft<t.length&&ds(t,e.firstDiffLeft),n=e.firstDiffLeft<s.length&&ds(s,e.firstDiffLeft);(o||n)&&(e.firstDiffLeft-=1)}if(e.firstDiffRight>1){const o=e.firstDiffRight<t.length&&ds(t,t.length-e.firstDiffRight),n=e.firstDiffRight<s.length&&ds(s,s.length-e.firstDiffRight);(o||n)&&(e.firstDiffRight-=1)}}(i,e,t),i}(s,o),i=n.firstDiffLeft,r=s.length-n.firstDiffRight,a=o.length-n.firstDiffRight;let c,l=ts.Update;if(s.length!==o.length)r===i?(l=ts.Add,c=s[s.length-1]):a===i&&(l=ts.Delete,c=o[o.length-1]);else if(s===o)return;let u,p=0;switch(l){case ts.Update:p=r-i,u=o.substring(i,a);break;case ts.Add:u=o.substring(i,a);break;case ts.Delete:p=r-i,u=s.substring(i,r)}const h=function(e,t){const s=Array.from(e.matchAll(ms));if(ms.lastIndex=0,0===s.length)return ss.Chars;if(1===s.length){if(0===s[0].index)return t&&ys.test(t)?ss.Sentence:t&&!ms.test(t)?ss.Word:ss.Chars;if(s[0].index+1===e.length)return ys.test(e[s[0].index-1])?ss.Sentence:ms.test(e[s[0].index-1])?ss.Chars:ss.Word;if(e[s[0].index-1]){const t=e[s[0].index-1];if(ys.test(t))return ss.Sentence;if(ms.test(t))return ss.Chars}return ss.Word}const o=Array.from(e.matchAll(ys));return ys.lastIndex=0,0===o.length?ss.PartialSentence:o.length>1?ss.Paragraph:o[0].index+1<=e.length?ms.test(e[o[0].index+1])?ss.Sentence:ss.Paragraph:void 0}(u,c);if(void 0!==h)return new ps({content:l!==ts.Delete?u:void 0,deltaType:l,unit:h,position:i,length:l!==ts.Add?p:0})}class Cs{constructor(){this.deltaBuilderHandlers=new Map,this.registerDeltaBuilderHandler(ns.getTypeName(),Ts),this.registerDeltaBuilderHandler(is.getTypeName(),ws)}xecuteDeltaBuilderHandler(e,t,s){const o=this.deltaBuilderHandlers.get(e);return o?o(t,s):[]}}const ks=(e,t)=>t?`${t.join("\\")}-${e}`:e;class _s{constructor(){this.createTextTileDeltasFromItem=(e,t)=>{var s;const o=new p({operationName:"CreateTextTileDeltaFromItem",success:!0}).start();try{if(!e)return o.success=!1,o.resultDescription="Unable to create text tile delta, parent item is undefined",void g.a.info(524883085,g.b.CoreDefault,o.stop());if(!e.body)return o.success=!1,o.resultDescription="Unable to create text tile delta, parent item has undefined body",void g.a.info(524883086,g.b.CoreDefault,o.stop());const n=e.body;if(!ns.typeGuard(n))return o.success=!1,void(o.resultDescription=`Unable to create text tile delta, parent item body is not proper type: expected ${ns.getTypeName()}, received ${b.getTypeNameFor(n)}`);const i=ks(e.id,t),r=null!==(s=this.lastSeenTileByTileId.get(i))&&void 0!==s?s:new ns({content:""}),a=this.createDeltas(r,n);return a&&0!==a.length?(o.dimension0=a.length.toString(),this.lastSeenTileByTileId.set(i,n)):(o.dimension0="0",o.resultDescription="No delta differences found"),g.a.info(524883087,g.b.CoreDefault,o.stop()),a}catch(e){return o.success=!1,o.resultDescription=`Error creating text tile delta: ${e}`,void g.a.info(524883088,g.b.CoreDefault,o.stop())}},this.lastSeenTileByTileId=new Map,this.deltaBuilder=new Cs}addItemToLocalMap(e,t){const s=ks(e.id,t),o=e.body;ns.typeGuard(o)&&!this.lastSeenTileByTileId.has(s)&&this.lastSeenTileByTileId.set(s,o)}deleteItemFromLocalMap(e,t){const s=ks(e.id,t);this.lastSeenTileByTileId.has(s)&&this.lastSeenTileByTileId.delete(s)}createDeltas(e,t){return this.deltaBuilder.executeDeltaBuilderHandler(b.getTypeNameFor(t),e,t)}}ar Ss,As;!Ss||(Ss={})),function(e){e[e.Internal=0]="Internal",e[e.External=1]="External"}(As||(As={}));const Is=(e,t)=>{t?(e.resultDescription=t,e.success=!1,g.a.error(509203144,g.b.CoreDefault,e.stop())):g.a.info(509203143,g.b.CoreDefault,e.stop())};class xs{constructor(e){var t;this.annotationActivationTrackers=new Map,this.annotationCallbacks=new Map,this.annotationResultStates=new Map,this.tokensByAnnotationType=new Map,this.registeredContextTypes=new Set,this.availableContexts=new Map,this.nextSyncSequenceId=1,this.allowSeed=!0,this.allowGroupSeed=!0,this.seedGroupSize=0,this.hasSessionConnected=!1,this.isSessionClosed=!1,this.serverAuthenticationState=xt.NotAuthenticated,this.workflowGraph=new zt,this.workflowDefinitionManager=new Qt,this.contextIdManager=new Xt(es.JsClient,this.workflowGraph),this.workflowItemStorage=new os(this.workflowDefinitionManager),this.graphInitMessageTimer=!1,this.pendingConnectCallbacks=[],this.hostCallbacks=e.hostCallbacks,this.sessionManager=e.sessionManager,this.operationBatchConfig=e.batchOptions?this.getOperationBatchConfig(e.batchOptions):void 0,this.extensionConfigs=e.extensionConfigs,this.clientMetadata=e.clientMetadata,this.userContext=e.userContext,this.localWorkflowManager=e.localWorkflowManager,this.annotationResultsProcessor=e.annotationResultsProcessor,e.workflowRuntimeFactory&&(this.workflowRuntime=e.workflowRuntimeFactory(this.sessionManager)),this.localRegisteredWorkflows=e.localRegisteredWorkflows||[],this.skipGraphInitOnWorkflowRegistration=e.skipGraphInitOnWorkflowRegistration,this.enableRemoteExecutionNotification=e.enableRemoteExecutionNotification||!1,this.networkMode=e.networkMode,this.egress=e.egress,this.serverAuthenticationStateChangeCallback=[],this.sessionManager.on("sessionClose",this.onSessionClose.bind(this)),this.sessionManager.on("reconnect",this.onReconnect.bind(this)),this.sessionManager.on("connect",this.onConnect.bind(this)),this.sessionManager.on("disconnect",this.onDisconnect.bind(this)),this.sessionManager.on("resetNextSyncSequenceId",this.resetNextSyncSequenceId.bind(this)),this.sessionManager.on("serverAuthenticationStateChange",this.onServerAuthenticationStateChange.bind(this)),this.sessionManager.onMessage(be.getTypeName(),this.workflowRuntime?this.onAnnotationResultsFromLocal.bind(this):this.onAnnotationResultsFromServer.bind(this)),this.sessionManager.onMessage(fe.getTypeName(),this.onAnnotationResultStateMessage.bind(this)),this.sessionManager.onMessage(Me.getTypeName(),this.onWorkflowExecutionCompleteMessage.bind(this)),e.isDeltaGeneratorEnabled&&(this.enableSyncDeltaSending=!e.disableSyncDeltaSending,this.syncDeltaTimeout=null!==(t=e.syncDeltaTimeout)&&void 0!==t?t:700,this.enableDeltaGenerator())}initialize(){return this.localWorkflowManager&&this.localWorkflowManager.addSession(this),this.registerLocalWorkflows(this.localRegisteredWorkflows),this.sessionManager.init(this.extensionConfigs,this.hostCallbacks.onInitSession?this.hostCallbacks.onInitSession:void 0,this.egress).then((()=>(this.localWorkflowManager&&this.localWorkflowManager.setTokenCallback(this.getAuthToken.bind(this)),this)))}et hasConnected(){return this.hasSessionConnected}get isClosed(){return this.isSessionClosed}getServerAuthenticationState(){return this.serverAuthenticationState}getContextIdManager(){return this.contextIdManager}getWorkflowItemStorage(){return this.workflowItemStorage}egisterLocalWorkflows(e){if(e.length){if(this.workflowRuntime)for(const t of e)this.workflowRuntime.registerWorkflow(t),this.sendMessageToSession(new gt({workflowDefinition:t}));if(this.localWorkflowManager)for(const t of e)this.localWorkflowManager.registerLocalWorkflow(t,this);this.trySendWorkflowGraphInitMessage()}}registerLocalWorkflow(e){this.registerLocalWorkflows([e]);const t=new p({operationName:"SessionRegisterLocalWorkflow",resourceId:e.id,success:!0}).setClientMetadata(this.clientMetadata).start();Is(t)}activateAnnotation(e,t){var s;const o=new bt(this.sendMessageToSession.bind(this),e,t);if(t&&t.callback){let s=this.annotationCallbacks.get(e);s||(s=new Map,this.annotationCallbacks.set(e,s)),s.set(o.token,t.callback)}const n=null!==(s=this.tokensByAnnotationType.get(e))&&void 0!==s?s:[];return-1===n.indexOf(o.token)&&n.push(o.token),this.tokensByAnnotationType.set(e,n),this.annotationActivationTrackers.set(o.token,o),this.activateAnnotationForTracker(o,{ignoreExistingAnnotations:!1,sendOnlyIfConnected:!1})}activateAnnotationForTracker(e,t){const s=new p({operationName:"ActivateAnnotation",resourceId:e.annotationType,success:!0}).setClientMetadata(this.clientMetadata).start();return e.activate(t.ignoreExistingAnnotations,t.sendOnlyIfConnected).then((o=>(s.resultSignature="Ok",s.resultDescription=`Activated annotation ${e.annotationType} with token ${e.token}; sendOnlyIfConnected: ${t.sendOnlyIfConnected}`,Is(s),o))).catch((o=>{throw Is(s,`error on activate annotation type ${e.annotationType}: ${o}; sendOnlyIfConnected: ${t.sendOnlyIfConnected}`),o}))}updateAnnotationConfig(e,t){const s=new Te({token:e,config:t});this.sendMessageToSession(s);const o=this.annotationActivationTrackers.get(e);o&&o.options&&(o.options.config=t)}releaseAnnotation(e){const t=this.annotationActivationTrackers.get(e);if(t){this.annotationActivationTrackers.delete(e);const s=this.annotationCallbacks.get(t.annotationType);return s&&(s.delete(e),0==s.size&&this.annotationCallbacks.delete(t.annotationType)),t.release()}return Promise.resolve(!1)}setAnnotationState(e,t,s){this.submitOperation(new O({parentPath:e,items:[{id:t}],M_:{state:s}}))}setAnnotationMetadata(e,t,s){this.submitOperation(new O({parentPath:e,items:[{id:t}],M_:s}))}submitOperationubmitOperations(e,t){this.contextIdManager.applyContextIdOnOperations(e),this.updateWorkflowExecutionStates(e);const s=e.filter(this.filterOperationsForSession.bind(this));if(this.workflowRuntime)return void this.submitOperationsToSession(s,t);const o=[];if(this.deltaGenerator){const e=new p({operationName:"ExecuteDeltaGenerator",success:!0}).setClientMetadata(this.clientMetadata).start();for(const e of s)if(W.typeGuard(e))o.push(...this.createDeltasFromUpdateOperation(e));else{const t=e;for(const s of t.items)D.typeGuard(e)?this.deltaGenerator.addItemToLocalMap(s,t.parentPath):L.typeGuard(e)&&this.deltaGenerator.deleteItemFromLocalMap(s,t.parentPath);o.push(e)}Is(e)}this.submitOperationsToSession(o.length?o:s,t),this.localWorkflowManager&&this.localWorkflowManager.runLocalWorkflows(e,this,!0)}submitSeedOperations(e,t){if(!this.allowSeed)throw new Error("Cannot submit seed operations more than once per session");this.networkMode===rt.LocalWorkflowsOnly&&this.localWorkflowManager?this.localWorkflowManager.runLocalWorkflows(e,this):(this.allowSeed=!1,this.allowGroupSeed=!1,this.operationBatchConfig?this.sendSeedMessagesViaBatchManager(e,!0,t):this.sendMessageToSession(new ve({cv:t,seq:0,ops:e})))}submitSeedGroupOperations(e,t,s){if(!this.allowGroupSeed)throw new Error("Seed operations are not allowed for this session");this.networkMode===rt.LocalWorkflowsOnly&&this.localWorkflowManager?this.localWorkflowManager.runLocalWorkflows(e,this):(t&&(this.allowGroupSeed=!1),this.allowSeed=!1,this.operationBatchConfig?this.sendSeedMessagesViaBatchManager(e,!!t,s):(this.seedGroupSize++,this.sendMessageToSession(new ve({cv:s,seq:0,ops:e,groupId:"Seed",groupSize:t?this.seedGroupSize:void 0,groupComplete:t||void 0}))))}submitCustomMessage(e){return new Promise(((t,s)=>{this.sendMessageToSession(e,((e,o)=>{e?s(new Error(e.error)):t(o)}))}))}submitLargeBinaryDataMessage(e){return new Promise(((t,s)=>{this.sendMessageToSessionPostEndpoint(e,((e,o)=>{e?s(new Error(e.error)):t(o)}))}))}requestBinaryDataForBlob(e){return e.data?Promise.resolve(e.data):e.dataPointer&&e.dataPointer.refType!==at.None?new Promise(((t,s)=>{this.requestBinaryDataFromSessionBlobEndpoint(e.dataPointer,()})):Promise.reject(new Error("Blob does not have a data pointer"))}requestCacheDump(e){if(e)throw new Error("NYI");return this.submitCustomMessage(new pe)}lose(){this.isSessionClosed=!0,this.sessionManager.closeSession(),this.workflowRuntime&&this.workflowRuntime.close(),this.localWorkflowManager&&this.localWorkflowManager.closeSession(this)}getClientMetadata(){return this.clientMetadata}etSessionCloseCallback(e){this.sessionCloseCallback=e}setConnectCallback(e){this.connectCallback=e}setDisconnectCallback(e){this.disconnectCallback=e}etServerAuthenticationStateChangeCallbacknAnnotationResults(e,t,s){g.a.info(508916486,g.b.CoreDefault,new p({operationName:"OnAnnotationResultsEgress",dimension0:null==e?void 0:e.annotationType,success:!0})),s(void 0,new ie),t===Ss.LocalWorkflow&&this.contextIdManager.applyContextIdOnOperations(e.ops),this.updateWorkflowExecutionStates(e.ops),this.egress&&this.egress(e,(()=>{})),this.annotationResultsProcessor.process(e,(,(t=>{if(this.callAnnotationCallbacks(t,e.annotationType),this.hostCallbacks.onAnnotationResult)try{this.hostCallbacks.onAnnotationResult(t)}catch(e){g.a.error(540301151,g.b.CoreDefault,`onAnnotationResult error: ${e}`)}}),(e=>{if(t!==Ss.ServerWorkflow){const t=e.ops.filter(this.filterOperationsForSession.bind(this));this.submitOperationsToSession(t,e.cv)}this.localWorkflowManager&&this.localWorkflowManager.runLocalWorkflows(e.ops,this)}))}onAnnotationResultStateMessage(e,t){var s;t(void 0,new ie);for(const t of e.updates){const{annotationType:e,state:o}=t;if(!this.tokensByAnnotationType.has(e))continue;let n;n=this.annotationResultStates.has(e)?this.annotationResultStates.get(e):o===it.Idle?it.Pending:it.Idle;for(const t of this.tokensByAnnotationType.get(e)){const e=this.annotationActivationTrackers.get(t);(null===(s=e.options)||void 0===s?void 0:s.stateUpdateCallback)&&e.options.stateUpdateCallback(n,o)}}}submitOperationsToSession(e,t){const s=e.filter((),o=e.filter(();s.length>0&&this.sendMessageToSession(new ve({cv:t,ops:s})),o.length>0&&(this.operationBatchConfig?(this.batchedOperationsManager||(this.batchedOperationsManager=new St(((e,t,s)=>{this.sendMessageToSession(new ve({cv:t.cv,seq:this.nextSyncSequenceId++,ops:e}),(e=>{s(e?new Error(e.error):void 0)}))}))),this.batchedOperationsManager.addBatchItem(o,this.operationBatchConfig,{name:"SubmitOperations"},t)):this.sendMessageToSession(new ve({cv:t,seq:this.nextSyncSequenceId++,ops:o})))}sendMessageToSession(e,t){this.sessionManager.sendMessage(e,t),ue.typeGuard(e)&&this.close()}sendMessageToSessionPostEndpoint(e,t){if(this.connectParams)this.sendLargeBinaryDataMessage(this.connectParams,e,t);else{const s=(s=>this.sendLargeBinaryDataMessage(s,e,t)).bind(this);this.pendingConnectCallbacks.push(s)}}requestBinaryDataFromSessionBlobEndpoint(e,t){if(this.connectParams)this.requestBinaryData(this.connectParams,e,t);else{const s=(.bind(this);this.pendingConnectCallbacks.push(s)}}registerContextTypes(e){for(const t of e)this.activateAnnotation(t),this.registeredContextTypes.add(t)}applyOperationForContext(e,t,s){let o=b.getTypeNameFor(e);if(o!=D.getTypeName()&&o!=M.getTypeName()&&o!=W.getTypeName()&&o!=L.getTypeName())return;o==M.getTypeName()&&(o=D.getTypeName());const n=$t(this.resolvePlaceholdersInOperationParentPath(e.parentPath),t),i=qt(n.parentPath);if(o==D.getTypeName()||o==W.getTypeName()){if(!n.body)return;const e=b.getTypeNameFor(n.body);if(!this.registeredContextTypes.has(e))return;let t=this.availableContexts.get(e);t||(t=new Map,this.availableContexts.set(e,t));let r=t.get(s);if(r||(r=[],t.set(s,r)),!n.id){if(this.workflowRuntime)throw new Error("Expected item to have id already");this.localWorkflowManager&&(n.id=this.localWorkflowManager.getNextClientAnnotationId())}if(o==D.getTypeName())0==r.filter((e=>qt(e.parentPath)==i&&e.id==n.id)).length?r.push(n):g.a.info(540848911,g.b.CoreDefault,`AddOperation for (${s}, ${n.id}, ${n.source}) can't be applied as the context item with matching path and ID already exists. Use UpdateOperation instead.`);else for(let e=0;e<r.length;e++)if(r[e].id==n.id&&qt(r[e].parentPath)==i){if(r[e].source==n.source){r[e]=n;break}g.a.warn(540848912,g.b.CoreDefault,`UpdateOperation for (${s}, ${n.id}, ${n.source}) can't be applied as the context item with provided path and ID has different source: ${r[e].source}`)}else g.a.warn(540848913,g.b.CoreDefault,`UpdateOperation for (${s}, ${n.id}, ${n.source}) can't be applied as the context item with matching path and ID was not found. AddOperation should be used instead`)}else if(o==L.getTypeName()){if(!n.id)return;this.availableContexts.forEach(((e,t)=>{let o=e.get(s);o&&(o=o.filter((e=>!(qt(e.parentPath)==i&&e.id==n.id))),0==o.length?e.delete(s):e.set(s,o),0==e.size?this.availableContexts.delete(t):this.availableContexts.set(t,e))}))}}updateWorkflowExecutionStates(e){if(this.localWorkflowManager){const t=this.enableRemoteExecutionNotification?this.workflowGraph.getWorkflowNodes().map((e=>e.workflow)):this.localWorkflowManager.getAllRegisteredWorkflowsFromSession(this);for(const s of e)if(Yt.has(b.getTypeNameFor(s)))for(const e of s.items)for(const s of t||[])this.localWorkflowManager.preProcessItemToWorkflow(s,e,this)}}resolveRequestedContexts(e){const t=[];for(const[s,o,n]of Ut(e.requestedContextTypesRules)){if(!this.availableContexts.has(s)){if(o==Wt.Required)return[!1,[]];continue}const e=Array.from(this.availableContexts.get(s).values()).reduce(((e,t)=>e.concat(t)),[]);if(0==e.length)throw new Error(`Assert: availableContexts have the entry for ${s} which does not contain any context annotation.`);t.push(...e)}return[!0,t]}getContextAnnotations(e,t,s,o){var n,i;const r=s?qt(s):void 0;return null===(i=null===(n=this.availableContexts.get(e))||void 0===n?void 0:n.get(t))||void 0===i?void 0:i.filter((e=>!(r&&qt(e.parentPath)!=r||o&&e.source!=o)))}onWorkflowDefinitionOverrideMessage(e){const t=new p({operationName:"WorkflowDefinitionOverride",success:!0}).setClientMetadata(this.clientMetadata).start(),s=e=>{throw Is(t,e),Error(`WorkflowDefinitionOverride: ${e}`)};if(!this.localWorkflowManager)return void s("Not supported by this local SessionProxy instance.");const o=this.localWorkflowManager.getWorkflowDefinitionsByName(this),n=o.get(e.sourceWorkflowId);if(!n)return void s(`Workflow registration for source workflow '${e.targetWorkflowId}' was not found.`);t.resourceId=n.id;const i=o.get(e.targetWorkflowId);i&&(i.allowDefinitionOverride?n.definitionOverrideTargetWorkflows&&-1!==n.definitionOverrideTargetWorkflows.indexOf(i.id)?(this.workflowDefinitionManager.mergeWorkflowDefinition(i,e.definition,e.contextId),t.resultDescription=`Updated config for workflow: ${e.targetWorkflowId}, context id: ${e.contextId}`,Is(t)):s(`Workflow '${n.id}' does not allow workflow definition for workflow '${i.id}'.`):s(`Workflow '${i.id}' does not allow workflow definition override.`))}tachExecutionTrackerToEachWorkflow(){this.localWorkflowManager&&this.localWorkflowManager.attachExecutionTrackerToEachWorkflow(this.workflowGraph,this,this.onWorkflowExecutionComplete.bind(this))}onWorkflowExecutionCompleteMessage(e,t){t(void 0,new ie),this.localWorkflowManager&&this.localWorkflowManager.onExternalWorkflowExecuted(e.contextId,e.workflowId,this)}nableDeltaGenerator(){var e,t;this.deltaGenerator=null!==(e=this.deltaGenerator)&&void 0!==e?e:new _s,this.syncDeltaTimers=null!==(t=this.syncDeltaTimers)&&void 0!==t?t:new Map}createDeltasFromUpdateOperation(e){var t,s;const o=[];g.a.info(523776396,g.b.CoreDefault,`Calling delta create for UpdateOperation under parent path [${e.parentPath}] (${null===(t=e.items)||void 0===t?void 0:t.length} item(s), first item id: ${(null===(s=e.items)||void 0===s?void 0:s.length)>0?e.items[0].id:"(no items)"})`);let n=[...e.parentPath];for(const t of e.items){const s=[],i=this.deltaGenerator.createTextTileDeltasFromItem(t,e.parentPath);if(null==i?void 0:i.length){for(const o of i){const i=bs();n=[...e.parentPath,t.id],s.push({id:i,revId:t.revId,body:o,contextId:t.contextId,source:t.source})}s.length>0&&(o.push(new G({parentPath:n,items:s})),this.enableSyncDeltaSending&&this.setupSyncDeltaAfterDelay(t,n,s))}else g.a.info(523329632,g.b.CoreDefault,`Failed to create delta on item ${t.id}`)}return o}setupSyncDeltaAfterDelay(e,t,s){var o,n,i;const r=this.syncDeltaTimers.get(e.id);r&&(clearTimeout(r),this.syncDeltaTimers.delete(e.id));const a=s.find(();if(a){const s=a.body,r={content:"",deltaType:ts.Update,length:0,position:(null!==(o=null==s?void 0:s.position)&&void 0!==o?o:0)+(null!==(i=null===(n=null==s?void 0:s.content)||void 0===n?void 0:n.length)&&void 0!==i?i:0),unit:ss.Sentence},c=is.typeGuard(e.body)?new ps(r):new us(r),l={id:bs(),revId:e.revId,body:c,contextId:e.contextId,source:e.source},u=new G({parentPath:t,items:[l]}),p=setTimeout(((e,t)=>{this.submitOperation(e),this.syncDeltaTimers.delete(t)}),this.syncDeltaTimeout,u,e.id);this.syncDeltaTimers.set(e.id,p)}}etAuthToken(e,t){const s={Tickets:[]};this.clientMetadata.docSessionId&&(s.DocSessionId=this.clientMetadata.docSessionId);const o=(e=>{if(e===Nt.Substrate)return ut.Substrate})(e);o&&(s.TokenType=o),this.hostCallbacks.requestAuthToken(s).then((s=>{var o;s?t(void 0,s.Token,{returnedTokenType:e,timeToLiveSec:null===(o=s.TokenProperties)||void 0===o?void 0:o.timeToLiveSec}):t(new Error("Missing AuthTokenResponse from requestAuthToken"))})).catch((e=>t(e)))}nReconnect(){if(this.annotationActivationTrackers.forEach((e=>{this.activateAnnotationForTracker(e,{ignoreExistingAnnotations:!0,sendOnlyIfConnected:!0}).catch((()=>{}))})),this.reconnectCallback&&this.reconnectCallback(),!this.connectParams)throw new Error("Expected onConnect before onReconnect")}onSessionClose(e){this.isSessionClosed=!0,this.connectParams=void 0,this.sessionCloseCallback&&this.sessionCloseCallback(e)}onConnect(e,t,s,o,n){this.hasSessionConnected?e&&(this.allowSeed=!0,this.allowGroupSeed=!0,this.seedGroupSize=0,this.seedBatchedOperationsManager&&(this.seedBatchedOperationsManager.removeAllBatchedItems(),this.seedBatchedOperationsManager=void 0),this.batchedOperationsManager&&(this.batchedOperationsManager.removeAllBatchedItems(),this.batchedOperationsManager=void 0)):this.sendWorkflowGraphInitMessage(),this.connectParams={isSeedingRequired:e,sessionUrl:t,origin:s,authToken:o},this.hasSessionConnected=!0;for(const e of this.pendingConnectCallbacks)e(this.connectParams);this.connectCallback&&this.connectCallback(e,t,s,o),this.serverInputTypes=n}onDisconnect(e){this.connectParams=void 0,this.disconnectCallback&&this.disconnectCallback(e)}onServerAuthenticationStateChange(e){if(e!=this.serverAuthenticationState){if(this.serverAuthenticationState==xt.Authenticated&&e==xt.Pending)return;this.serverAuthenticationState=e;for(const e of this.serverAuthenticationStateChangeCallback)e(this.serverAuthenticationState)}}callAnnotationCallbacks(e,t){if(0===this.annotationCallbacks.size)return;const s=this.annotationCallbacks.get(t);s&&s.forEach(()}getOperationBatchConfig(e){return{delayMs:e.delayMs,maxInputSize:e.maxInputSize,estimateSize:At,groupingKeyExtractor:multiplex:e=>({input:e.filter((e=>e.length)).reduce((,[]),demultiplex:),split:e=>{if(!(e.length<=1))return{inputs:e.reduce(((e,t)=>(e.push([t]),e)),[]),join:}}}sendSeedMessagesViaBatchManager(e,t,s){this.seedBatchedOperationsManager||(this.seedBatchedOperationsManager=new St(((e,t,s)=>{this.seedGroupSize++,this.sendMessageToSession(new ve({cv:t.cv,seq:0,ops:e,groupId:"Seed",groupSize:t.groupComplete?this.seedGroupSize:void 0,groupComplete:t.groupComplete?t.groupComplete:void 0}),(e=>{s(e?new Error(e.error):void 0)}))}))),this.seedBatchedOperationsManager.addBatchItem(e,this.operationBatchConfig,{name:"SubmitSeedOperations"},s,t)}onAnnotationResultsFromServer(e,t){this.onAnnotationResults(e,Ss.ServerWorkflow,t)}onAnnotationResultsFromLocaletLocalRegisteredWorkflows(){return this.workflowRuntime?this.workflowRuntime.getRegisteredWorkflows():this.localWorkflowManager?this.localWorkflowManager.getAllRegisteredWorkflowsFromSession(this).map(():[]}sendWorkflowGraphInitMessage(){const e=this.getLocalRegisteredWorkflows(),t=new p({operationName:"WorkflowGraphInit",success:!0}).setClientMetadata(this.clientMetadata).start(),s=new xe({upstreamRuntimeWorkflows:e});this.sendMessageToSession(s,((s,o)=>{s?Is(t,s.error):(t.resultDescription=`local workflows: ${e.map((e=>e.id))}, remote workflows: ${o.downstreamRuntimeWorkflows.map(()}`,Is(t),this.onWorkflowGraphInitResponse(o))}))}trySendWorkflowGraphInitMessage(){this.graphInitMessageTimer||this.skipGraphInitOnWorkflowRegistration||(this.graphInitMessageTimer=!0,setTimeout((,500))}onWorkflowGraphInitResponse(e){this.workflowGraph.removeWorkflows(!0);for(const t of e.downstreamRuntimeWorkflows||[])this.workflowGraph.addWorkflow(t,!0);this.workflowRuntime||this.attachExecutionTrackerToEachWorkflow()}resolvePlaceholdersInOperationParentPath(e){let t=e;return 3==t.length&&"session"==t[0]&&"user"==t[1]&&t[2].startsWith("user_")&&(g.a.info(540848914,g.b.CoreDefault,`Replacing user context placeholder for: ${qt(e)}.`),t=["session","#userContext#"]),3==t.length&&"session"==t[0]&&"user"==t[1]&&t[2].startsWith("tenant_")&&(g.a.info(540848915,g.b.CoreDefault,`Replacing tenant context placeholder for: ${qt(e)}.`),t=["session","#tenantContext#"]),t}filterOperationsForSession(e){return!!this.workflowRuntime||((e,t)=>{if(!Array.isArray(t)||0===t.length)return!0;if(G.typeGuard(e)||O.typeGuard(e))return!0;for(const s of e.items)if(!s.body||b.matchesTypesFor(s.body,t))return!0;return!1})(e,this.serverInputTypes)}makeRequestForConnectParams(e,t){const{authToken:s,origin:o,sessionUrl:n}=e,{body:i,cv:r,method:a,requestUrl:c}=t;return Object(Ze.fetch)(c||n,{method:a,headers:{Authorization:`Bearer ${s}`,"x-origin":o,"x-correlationid":r},body:i}).then((e=>{if(200!==e.status)throw new Error(`Unexpected status code: ${e.status}`);return e}))}sendLargeBinaryDataMessage(e,t,s){const o=new p({operationName:"SendLargeBinaryDataMessage",success:!0,cv:t.cv}).setClientMetadata(this.clientMetadata).start();let n;this.makeRequestForConnectParams(e,{body:Xe.a.serialize(t),cv:o.cv,method:"POST"}).then((e=>e.json())).catch((e=>{n=new re({messageId:t.messageId,error:e.message})})).then((e=>{Is(o,n?n.error:void 0),s(n,e)}))}requestBinaryData(e,t,s){const o=new p({operationName:"RequestBinaryData",success:!0,cv:(new V).toString()}).setClientMetadata(this.clientMetadata).start(),{sessionUrl:n}=e;let i;this.makeRequestForConnectParams(e,{cv:o.cv,method:"GET",requestUrl:t.refType===at.AlCodedLocation?`${n}/blob/${t.value}`:t.value}).then(().then(().catch(().then((e=>{Is(o,i?i.message:void 0),s(i,e)}))}}ar Ms,Bs,Ds;!Ms||(Ms={}));class Es{cheduleRefresh(e,t,s,o){let n=this.timers.get(e);n||(n={numberOfAttempts:0},this.timers.set(e,n)),n.refreshTimeoutId&&(clearTimeout(n.refreshTimeoutId),n.refreshTimeoutId=void 0),n.expiredTimeoutId&&(clearTimeout(n.expiredTimeoutId),n.expiredTimeoutId=void 0);let i=1e3*t-Es.tokenRefreshBufferMs,r=1e3*t-Es.tokenExpirationBufferMs;i>0?n.numberOfAttempts=0:(++n.numberOfAttempts,i=Es.tokenRefreshBackoffIntervalMs,r=Es.tokenExpirationBufferMs),n.numberOfAttempts<=Es.tokenRefreshMaximumAttempts&&(n.refreshTimeoutId=setTimeout((()=>{s()}),i)),o&&(n.expiredTimeoutId=setTimeout((,r))}clearRefreshTimeouts(){this.clearTimeouts(!1)}learTimeouts(e){this.timers.forEach(((t,s)=>{t.refreshTimeoutId&&(clearTimeout(t.refreshTimeoutId),t.refreshTimeoutId=void 0),e&&t.expiredTimeoutId&&(clearTimeout(t.expiredTimeoutId),t.expiredTimeoutId=void 0),t.expiredTimeoutId||this.timers.delete(s)}))}}Es.tokenRefreshBufferMs=24e4,Es.tokenExpirationBufferMs=12e4,Es.tokenRefreshBackoffIntervalMs=3e4,Es.tokenRefreshMaximumAttempts=3;class Os extends Ge.EventEmitter{constructor(e,t,s,o,n){super(),this.getSessionStats=e,this.clientMetadata=t,this.tokenRefreshManager=s,this.sendMessage=o,this.options=n||{},this.options.overrideSessionInitMessage=this.options.overrideSessionInitMessage||(}initSession(e){e.onResponse=e.onResponse||(;const t=$.getCurrentTimeMs(),s=this.getSessionStats().lastConnectionClose&&t-this.getSessionStats().lastConnectionClose,o=this.getSessionStats().lastSyncMessage&&t-this.getSessionStats().lastSyncMessage,n=new p({operationName:"SessionInit"}).start(),i={sessionKey:this.sessionKey,sessionId:this.clientMetadata.sessionId,timeSinceLastConnectionClose:s,timeSinceLastSyncMessage:o,isTokenRefresh:e.isTokenRefresh,enableRemoteExecutionNotification:this.options.enableRemoteExecutionNotification,error:void 0},r=this.options.overrideSessionInitMessage(new ce({protocolVersion:2,clientMetadata:this.clientMetadata,sessionKey:this.sessionKey,origin:this.origin,authToken:this.anonymousToken,extensionConfigs:e.extensionConfigs,returnWorkflowInputTypes:!0,enableRemoteExecutionNotification:this.options.enableRemoteExecutionNotification}));this.sendMessage(r,((t,s)=>{if(n.success=!t,n.resultSignature=this.getSessionStats().lastConnectionClose?"Reconnect":"FirstConnect",n.resourceId=null==s?void 0:s.sliceUrl,n.setClientMetadata(this.clientMetadata),(null==s?void 0:s.sessionKey)&&i.sessionKey!==s.sessionKey&&(i.sessionKey=s.sessionKey),t&&(i.error=t.error),n.resultDescription=JSON.stringify(i),g.a.info(572838103,g.b.CoreDefault,n.stop()),e.onResponse(t,s),t)this.emit("serverAuthenticationStateChange",xt.NotAuthenticated);else if(e.isReconnectOnSameSlice&&s.forceReconnect)this.emit("serverAuthenticationStateChange",xt.NotAuthenticated);else{if(!s.anonymousToken||!s.tokenExpirationSeconds)return this.emit("serverAuthenticationStateChange",xt.NotAuthenticated),void g.a.error(572838104,g.b.CoreDefault,"AL Anonymous token was not generated for the session");this.anonymousToken=s.anonymousToken,this.onSuccessfulSessionInitOnServerSide(s)}}))}onSuccessfulSessionInitOnServerSide(e){this.tokenRefreshManager.scheduleRefresh(Ms.Anonymous,e.tokenExpirationSeconds,this.initSession.bind(this,{isTokenRefresh:!0}),(),this.initHostAuthToken();const t=!!this.sessionKey,s=this.sessionKey!==e.sessionKey;this.sessionKey=e.sessionKey,this.origin=e.origin,this.emit("connect",s,t,`${e.sessionUrlBase}/${e.sessionKey}`,e.origin,this.anonymousToken,e.workflowInputTypes),t&&this.emit("reconnect")}initHostAuthToken(){if(this.options.getAuthToken){const e=new p({operationName:"RefreshAuthToken",success:!0}).setClientMetadata(this.clientMetadata).start();this.options.getAuthToken().then((t=>{if(!t)return this.emit("serverAuthenticationStateChange",xt.NotAuthenticated),e.success=!1,e.resultDescription="Host auth token provision failed",void g.a.info(572838105,g.b.CoreDefault,e.stop());g.a.info(509162971,g.b.CoreDefault,e.stop()),this.sendTokenProvisionMessage(t)})).catch((t=>{this.emit("serverAuthenticationStateChange",xt.NotAuthenticated),e.success=!1,e.resultDescription=`Error happened while attempting to fetch host token: ${t}`,g.a.error(572838106,g.b.CoreDefault,e.stop())}))}}sendTokenProvisionMessage(e){const t=new Se({authToken:e});this.emit("serverAuthenticationStateChange",xt.Pending),this.sendMessage(t,this.onTokenProvisionResponse.bind(this),!0)}onTokenProvisionResponse(e,t){!e&&t&&t.tokenExpirationSeconds?(this.emit("serverAuthenticationStateChange",xt.Authenticated),this.tokenRefreshManager.scheduleRefresh(Ms.Host,t.tokenExpirationSeconds,this.initHostAuthToken.bind(this))):this.emit("serverAuthenticationStateChange",xt.NotAuthenticated)}}class Ws{constructor(e){b.assign(Ws,this,e)}static getTypeName(){return"AugLoop_Core_Blob"}static getBaseTypes(){return[]}static typeGuard(e){return b.matchesTypesFor(e,[Ws.getTypeName()])}}Ws.H_={T_:Ws.getTypeName(),B_:Ws.getBaseTypes()};class Ls{constructor(e){b.assign(Ls,this,e)}static getTypeName(){return"AugLoop_Core_Binary"}static getBaseTypes(){return[]}static typeGuard(e){return b.matchesTypesFor(e,[Ls.getTypeName()])}}Ls.H_={T_:Ls.getTypeName(),B_:Ls.getBaseTypes()};class Rs{constructor(e){b.assign(Rs,this,e)}static getTypeName(){return"AugLoop_Core_TileGroup"}static getBaseTypes(){return[]}static typeGuard(e){return b.matchesTypesFor(e,[Rs.getTypeName()])}}Rs.H_={T_:Rs.getTypeName(),B_:Rs.getBaseTypes()};class Ps{constructor(e){b.assign(Ps,this,e)}static getTypeName(){return"AugLoop_Core_Session"}static getBaseTypes(){return["AugLoop_Core_TileGroup"]}static typeGuard(e){return b.matchesTypesFor(e,[Ps.getTypeName()])}}Ps.H_={T_:Ps.getTypeName(),B_:Ps.getBaseTypes()};class Fs{constructor(e){b.assign(Fs,this,e)}static getTypeName(){return"AugLoop_Core_Document"}tatic typeGuard(e){return b.matchesTypesFor(e,[Fs.getTypeName()])}}Fs.H_={T_:Fs.getTypeName(),B_:Fs.getBaseTypes()};class Gs{constructor(e){b.assign(Gs,this,e)}static getTypeName(){return"AugLoop_Core_SubDocument"}static getBaseTypes(){return[]}static typeGuard(e){return b.matchesTypesFor(e,[Gs.getTypeName()])}}Gs.H_={T_:Gs.getTypeName(),B_:Gs.getBaseTypes()};class Hs{constructor(e){b.assign(Hs,this,e)}static getTypeName(){return"AugLoop_Core_GridCell"}static getBaseTypes(){return[]}static typeGuard(e){return b.matchesTypesFor(e,[Hs.getTypeName()])}}Hs.H_={T_:Hs.getTypeName(),B_:Hs.getBaseTypes()};class Us{constructor(e){b.assign(Us,this,e)}static getTypeName(){return"AugLoop_Core_GridNeighborhoodContext"}static getBaseTypes(){return[]}static typeGuard(e){return b.matchesTypesFor(e,[Us.getTypeName()])}}Us.H_={T_:Us.getTypeName(),B_:Us.getBaseTypes()};class $s{constructor(e){b.assign($s,this,e)}static getTypeName(){return"AugLoop_Core_ItemFilter"}static getBaseTypes(){return[]}static typeGuard(e){return b.matchesTypesFor(e,[$s.getTypeName()])}}$s.H_={T_:$s.getTypeName(),B_:$s.getBaseTypes()};class qs{constructor(e){b.assign(qs,this,e)}static getTypeName(){return"AugLoop_Core_DynamicContext"}tatic typeGuard(e){return b.matchesTypesFor(e,[qs.getTypeName()])}}qs.H_={T_:qs.getTypeName(),B_:qs.getBaseTypes()};class js{constructoratic getBaseTypes(){return[]}static typeGuard(e){return b.matchesTypesFor(e,[js.getTypeName()])}}js.H_={T_:js.getTypeName(),B_:js.getBaseTypes()};class zs{constructor(e){b.assign(zs,this,e)}static getTypeName(){return"AugLoop_Core_UserContextHolder"}static getBaseTypes(){return["AugLoop_Core_ContextHolder"]}static typeGuard(e){return b.matchesTypesFor(e,[zs.getTypeName()])}}zs.H_={T_:zs.getTypeName(),B_:zs.getBaseTypes()};class Vs{constructor(e){b.assign(Vs,this,e)}static getTypeName(){return"AugLoop_Core_TenantContextHolder"}static getBaseTypes(){return["AugLoop_Core_ContextHolder"]}static typeGuard(e){return b.matchesTypesFor(e,[Vs.getTypeName()])}}Vs.H_={T_:Vs.getTypeName(),B_:Vs.getBaseTypes()};class Js{constructor(e){b.assign(Js,this,e)}static getTypeName(){return"AugLoop_Core_EventsHolder"}static getBaseTypes(){return[]}static typeGuard(e){return b.matchesTypesFor(e,[Js.getTypeName()])}}Js.H_={T_:Js.getTypeName(),B_:Js.getBaseTypes()};class Ks{constructor(e){b.assign(Ks,this,e)}static getTypeName(){return"AugLoop_Core_UserCommandsHolder"}static getBaseTypes(){return["AugLoop_Core_EventsHolder"]}static typeGuard(e){return b.matchesTypesFor(e,[Ks.getTypeName()])}}Ks.H_={T_:Ks.getTypeName(),B_:Ks.getBaseTypes()},function(e){e[e.Undefined=0]="Undefined",e[e.Created=10]="Created",e[e.Sent=20]="Sent",e[e.Duplicated=30]="Duplicated",e[e.Seen=40]="Seen",e[e.Tried=50]="Tried",e[e.Kept=60]="Kept",e[e.Rejected=70]="Rejected"}(Bs||(Bs={})),function(e){e[e.JoinContext=0]="JoinContext",e[e.Session=1]="Session"}(Ds||(Ds={})),Error;var Qs={util:{},roots:{default:{}}},Ys=(Qs.roots.default||(Qs.roots.default={}),function(){function e(e){if(e)for(var t in e)null!=e[t]&&(this[t]=e[t])}return e.prototype.sessionKey="",e.prototype.annotationType="",e.prototype.annotationState=0,e.prototype.workflowId="",e}());lass Zs{constructor(e){this.item=e,this.operation=e.op,this.delta=e.delta,this.deltas=e.deltas,this.id=qt(this.itemPath),this.revId=e.revId}get itemPath(){return[...this.item.parentPath,this.item.id]}getModelIterator(){throw new Error("Method not implemented.")}getBody(){return this.item.body}etParentItem(e){throw new Error("Method not implemented.")}getParentItemBody(e){throw new Error("Method not implemented.")}getPrevItem(e,t){throw new Error("Method not implemented.")}getPrevItemBody(e,t){throw new Error("Method not implemented.")}getNextItem(e,t){throw new Error("Method not implemented.")}getNextItemBody(e,t){throw new Error("Method not implemented.")}getChildItem(e){throw new Error("Method not implemented.")}getChildItemBody(e){throw new Error("Method not implemented.")}getChildItems(e){throw new Error("Method not implemented.")}getChildItemBodies(e){throw new Error("Method not implemented.")}getSubtreeItem(e){throw new Error("Method not implemented.")}getSubtreeItemBody(e){throw new Error("Method not implemented.")}getSubtreeItems(e){throw new Error("Method not implemented.")}getSubtreeItemBodies(e){throw new Error("Method not implemented.")}getContextItem(e){throw new Error("Method not implemented.")}getContextItemBody(e){throw new Error("Method not implemented.")}getContextItems(e){throw new Error("Method not implemented.")}getContextItemBodies(e){throw new Error("Method not implemented.")}addAnnotation(e,t){throw new Error("Method not implemented.")}eleteAnnotation(e){throw new Error("Method not implemented.")}loadSubtree(e){throw new Error("Method not implemented.")}getSourceTimestamp(){return this.item.sourceTimestamp}class eo{constructor(e,t=[]){this.scopeItem=void 0,this.rootItem=void 0,this.normalizeFilter=e=>{if(!e)return if("function"==typeof e)throw new Error("Not implemented yet");if((e.id?1:0)+(e.ids?1:0)+(e.itemType?1:0)+(e.itemTypes?1:0)!=1)throw new Error("Exactly one condition expected on IItemFilter");if(e.itemType)return t=>t&&b.matchesTypesFor(t.body,[e.itemType]);if(e.itemTypes)return t=>t&&b.matchesTypesFor(t.body,e.itemTypes);throw new Error("Not implemented yet")},this.items=[...t,e],this.scopeItem=new Zs(e)}getItem(e){throw new Error("Method not implemented.")}getItems(e){throw new Error("Method not implemented.")}etItemBodies(e){const t=this.normalizeFilter(e);return this.items.filter(t).map((e=>e.body))}getItemByReference(e){throw new Error("Method not implemented.")}const to=[ts.CursorUpdate,ts.FormattingUpdate,ts.OtherNonContentUpdate];function so(e,t,s){const o=new p({operationName:"ApplyTextTileDeltaForLocalWorkflows",dimension0:"0",success:!0}).start();try{if(!t)return o.success=!1,o.resultDescription="Unable to apply text tile delta, parent tile is undefined",void g.a.info(538798173,g.b.CoreDefault,o.stop());if(b.getTypeNameFor(t)!==ns.getTypeName())return o.success=!1,o.resultDescription=`Unable to apply text tile delta, parent tile is not proper type: expected ${us.getTypeName()}, received ${b.getTypeNameFor(t)}`,void g.a.info(538798174,g.b.CoreDefault,o.stop());const s=e,n=t.content;let i="";if(void 0===s.position||s.position<0)return o.success=!1,o.resultDescription="Unable to apply text tile delta, invalid text tile position",void g.a.info(538798175,g.b.CoreDefault,o.stop());switch(s.deltaType){case ts.Add:i=s.position<n.length?`${n.slice(0,s.position)}${s.content}${n.slice(s.position,n.length)}`:n+s.content;break;case ts.Update:s.content||s.unit!==ss.Sentence||(o.dimension0="1"),i=`${n.slice(0,s.position)}${s.content}${n.slice(s.position+(s.length||0),n.length)}`;break;case ts.Delete:i=`${n.slice(0,s.position)}${n.slice(s.position+(s.length||0),n.length)}`}return g.a.info(538837071,g.b.CoreDefault,o.stop()),new ns({content:i})}catch(e){return o.success=!1,o.resultDescription=`Error applying text tile delta: ${e}`,void g.a.info(538798176,g.b.CoreDefault,o.stop())}}function oo(e,t,s){var o,n,i,r,a,c,l,u;const h=new p({operationName:"ApplyFormattedTextTileDeltaForLocalWorkflows",dimension0:"0",success:!0}).start();h.clientFlights=s;try{if(!t)return h.success=!1,h.resultDescription="Unable to apply formatted text tile delta, parent tile is undefined",void g.a.info(538798177,g.b.CoreDefault,h.stop());if(b.getTypeNameFor(t)!==is.getTypeName())return h.success=!1,h.resultDescription=`Unable to apply formatted text tile delta, parent tile is not proper type: expected ${is.getTypeName()}, received ${b.getTypeNameFor(t)}`,void g.a.info(538798178,g.b.CoreDefault,h.stop());const s=t,d=e,f=s.content;let m="";if((void 0===d.position||d.position<0)&&!io(d.deltaType))return h.success=!1,h.resultDescription="Unable to apply formatted text tile delta, invalid text tile position",void g.a.info(538798179,g.b.CoreDefault,h.stop());if(void 0===d.content&&!io(d.deltaType))return h.success=!1,h.resultDescription="Unable to apply formatted text tile delta, non-delete, non-formatting, non-other-non-content-update and non-cursor-update operation without content defined",void g.a.info(538798208,g.b.CoreDefault,h.stop());if(d.deltaType===ts.Add&&0!==d.length?g.a.info(538798209,g.b.CoreDefault,new p({operationName:"ApplyDeltaChecks",resultDescription:"Received formatted text tile delta add operation with delta length, expected length 0",success:!0})):io(d.deltaType)&&void 0!==d.content&&g.a.info(538798210,g.b.CoreDefault,new p({operationName:"ApplyDeltaChecks",resultDescription:"Received formatted text tile delta delete or non-content related operation with content defined, expected undefined",success:!0})),!no(d.deltaType)){const e=function(e,t,s){const o=new p({operationName:"FindRangeForDelta",success:!0});if(o.start(),!e)return o.resultDescription="No formatted ranges found within the tile, skipping.",void g.a.info(538798212,g.b.CoreDefault,o.stop());if(t===ts.Add){const t=e.find((e=>e.start===s&&0===e.length));if(t)return o.resultDescription=`Found a zero-length formatted range for add operation with start ${t.start}.`,g.a.info(538798213,g.b.CoreDefault,o.stop()),t;s=Math.max(s-1,0)}const n=e.find((e=>0===e.length?e.start===s:e.start<=s&&s<e.start+e.length));return n?(o.resultDescription=`Updating formatted range for operation with start: ${n.start} and length: ${n.length}`,g.a.info(538798214,g.b.CoreDefault,o.stop())):(o.resultDescription=`Unable to find formatted range for operation at position ${s}, skipping.`,g.a.info(538798215,g.b.CoreDefault,o.stop())),n}(s.formattedRanges,d.deltaType,d.position);let t=s.formattedRanges?[...s.formattedRanges]:[];const l=e?t.indexOf(e):-1;-1!==l&&(d.position+(d.length||0)>e.start+e.length?e.length=d.position+(null!==(o=d.content)&&void 0!==o?o:"").length-e.start:e.length+=(null!==(n=d.content)&&void 0!==n?n:"").length-(d.length||0),t[l]=e);let u=s.ipPosition;switch(d.deltaType){case ts.Add:m=d.position<f.length?`${f.slice(0,d.position)}${d.content}${f.slice(d.position,f.length)}`:f+d.content,u=d.position+d.length;break;case ts.Update:d.content||d.unit!==ss.Sentence||(h.dimension0="1"),m=`${f.slice(0,d.position)}${d.content}${f.slice(d.position+(null!==(i=d.length)&&void 0!==i?i:0),f.length)}`,u=d.position+d.content.length;break;case ts.Delete:m=`${f.slice(0,d.position)}${f.slice(d.position+(null!==(r=d.length)&&void 0!==r?r:0),f.length)}`,u=d.position}for(const e of t.slice(l+1))e.start<d.position||(d.position+(d.length||0)>e.start?(e.length=e.start+e.length-(d.position+(d.length||0)),e.start=d.position+(null!==(a=d.content)&&void 0!==a?a:"").length):e.start+=(null!==(c=d.content)&&void 0!==c?c:"").length-(d.length||0));t=t.filter((e=>e.length>0));const y=new is(Object.assign(Object.assign({},s),{ipPosition:u,content:m,formattedRanges:t,queryRange:d.queryRange}));return g.a.info(538837073,g.b.CoreDefault,h.stop()),y}if(d.deltaType===ts.CursorUpdate)return new is(Object.assign(Object.assign({},s),{ipPosition:null===(l=d.cursorData)||void 0===l?void 0:l.ipPosition,isColdIp:null===(u=d.cursorData)||void 0===u?void 0:u.isColdIp}));if(d.deltaType===ts.FormattingUpdate)return new is(Object.assign(Object.assign({},s),{formattedRanges:d.formattedRanges}));if(d.deltaType===ts.OtherNonContentUpdate){let e;const t={};for(e in d.otherNonContentData)t[e]=d.otherNonContentData[e];return new is(Object.assign(Object.assign({},s),t))}return}catch(e){return h.success=!1,h.resultDescription=`Error applying formatted text tile delta: ${e}`,void g.a.info(538798211,g.b.CoreDefault,h.stop())}}unction io(e){return no(e)||ts.Delete===e}function ro(e){if(!e)return new ao([],new Set,new Map);const t=e.split(";"),s=new Set,o=new Map;for(const e of t){const t=e.trim();if(""===t)continue;s.add(ao.normalizeName(t));const[n,i]=t.split(":"),r=ao.normalizeName(n);r&&o.set(r,i)}return new ao(t,s,o)}class ao{sFlight(e){const t=ao.normalizeName(e),s=this.normalizedFlights.has(t),o=this.keyValueFlightsMap.has(t);return s||o}getBooleanValue(e,t){var s;switch(null===(s=this.getStringValue(e))||void 0===s?void 0:s.toLowerCase()){case"true":return!0;case"false":return!1;default:return t}}getIntValue(e,t){const s=this.getStringValue(e),o=Number.parseInt(s,10);return Number.isNaN(o)?t:o}getStringValue(e,t){var s;return null!==(s=this.keyValueFlightsMap.get(ao.normalizeName(e)))&&void 0!==s?s:t}getAll(){return this.originalFlights}getAllParsed(){const e=[];return this.keyValueFlightsMap.forEach(((t,s)=>{const o=null==t?void 0:t.toLowerCase();switch(o){case"true":e.push({name:s,value:!0});break;case"false":e.push({name:s,value:!1});break;default:{const n=Number.parseInt(o,10);Number.isNaN(n)?e.push({name:s,value:t}):e.push({name:s,value:n})}}})),e}}class co{et flights(){var e;return null!==(e=this._flights)&&void 0!==e||(this._flights=ro(this.clientMetadata.flights)),this._flights}class lo{constructor(e,t,s){this.itemsContextId=new Set,this.executionState=new Map,this.graphNode=e,this.onContextIdWorkflowExecutionComplete=t,s&&(this.itemsContextId=s.itemsContextId,this.executionState=s.executionState)}addInputItemToProcess(e){this.itemsContextId.add(e)}removeProcessedInputItem(e){this.itemsContextId.delete(e)}countItemsToProcess(e){let t=0;for(const s of this.itemsContextId)0===s.indexOf(e)&&(t+=1);return t}getExecutionState(){return this.executionState}setExecutionState(e,t){e?this.executionState.set(e,t):g.a.warn(520217546,g.b.CoreDefault,new p({operationName:"WorkflowExecutionTracker",resourceId:this.graphNode.workflow.id,resultDescription:`Trying to set state ${t} for a undefined contextId (setExecutionState)`}))}beforeWorkflowExecution(e){e?this.executionState.set(e,Zt.Pending):g.a.warn(520217545,g.b.CoreDefault,new p({operationName:"WorkflowExecutionTracker",resourceId:this.graphNode.workflow.id,resultDescription:`Trying to set state ${Zt.Idle} for a undefined contextId (beforeWorkflowExecution)`}))}afterWorkflowExecution(e){e?(this.executionState.set(e,Zt.Executed),this.tryToCompleteWorkflowExecution(e)):g.a.warn(520217544,g.b.CoreDefault,new p({operationName:"WorkflowExecutionTracker",resourceId:this.graphNode.workflow.id,resultDescription:`Trying to set state ${Zt.Executed} for a undefined contextId (afterWorkflowExecution)`}))}tryToCompleteWorkflowExecution(e){if(this.executionState.get(e)===Zt.Executed&&this.canCompleteExecution(e)){this.executionState.delete(e),this.onContextIdWorkflowExecutionComplete&&this.onContextIdWorkflowExecutionComplete(this.graphNode.workflow.id,e);for(const t of this.downstreamWorkflowExecutionTrackers)for(const[s,o]of t.getExecutionState())o===Zt.Executed&&Xt.isParentContextId(e,s)&&t.tryToCompleteWorkflowExecution(s)}}canCompleteExecution(e){for(const t of this.upstreamWorkflowExecutionTrackers)for(const s of t.getExecutionState().keys())if(Xt.isParentContextId(s,e))return!1;return!0}}var uo;!uo||(uo={}));class po{constructor(e,t,s){this.executionTrackersByWorkflowNameBySession=new Map,this.workflowsWithSessionAffinity=new Map,this.workflowDefinitionsWithSessionAffinity=[],this.workflowsWithoutSessionAffinity=[],this.pendingScopeExecutionNotificationsByWorkflow=new Map,this.sweepIntervalMs=200,this.sweepTimers=new Map,this.getResourceAsArrayBuffer=(e,t,s)=>this.modelDownloader?this.modelDownloader.getResourceAsArrayBuffer(e,t,s):Promise.reject(new Error("Resource Downloader never created")),this.getResourceAsURL=(e,t,s)=>this.modelDownloader?this.modelDownloader.getResourceAsURL(e,t,s):Promise.reject(new Error("Resource Downloader never created")),this.createModel=e=>(!this.inferenceService&&this.inferenceServiceFactory&&(this.inferenceService=this.inferenceServiceFactory()),this.inferenceService?this.inferenceService.then((t=>t.createModel(e))):Promise.reject(new Error("Inference Service never created"))),this.createModelInputs=()=>{if(!this.inferenceService&&this.inferenceServiceFactory&&(this.inferenceService=this.inferenceServiceFactory()),this.inferenceService)return this.inferenceService.then((e=>e.createInputs()));throw new Error("Inference Service never created")},this.nextAnnotationId=1,this.nextSignalId=1,this.modelDownloader=e,this.inferenceServiceFactory=t,s.enableDeltas&&(this.deltaHandlers=(new Map).set(b.getTypeNameFor(us),so).set(b.getTypeNameFor(ps),oo),this.deltaItems=new Map),this.enableEarlyJoin=s.enableEarlyJoin||!1,this.site={getResourceAsArrayBuffer:this.getResourceAsArrayBuffer,getResourceAsURL:this.getResourceAsURL,createModel:this.createModel,createModelInputs:this.createModelInputs}}getNextClientAnnotationId(){return"#AC"+this.nextAnnotationId++}egisterLocalWorkflow(e,t){const s=new p({operationName:"WorkflowRegistration",resourceId:e.id}).start();if(0===e.inputTypes.length)throw new Error("Invalid workflow params");t?(this.workflowsWithSessionAffinity.get(t).push(this.createWorkflowImplementation(e,t)),t.registerContextTypes(Ut(e.requestedContextTypesRules).map((([e,t])=>e))),t.attachToWorkflowGraph(e),s.setClientMetadata(t.getClientMetadata())):(e.isStateful?(this.workflowDefinitionsWithSessionAffinity.push(e),this.workflowsWithSessionAffinity.forEach(()):this.workflowsWithoutSessionAffinity.push(this.createWorkflowImplementation(e)),this.workflowsWithSessionAffinity.forEach(((t,s)=>{s.registerContextTypes(Ut(e.requestedContextTypesRules).map(()),s.attachToWorkflowGraph(e)}))),s.success=!0,g.a.info(572838110,g.b.CoreDefault,s.stop())}getAllRegisteredWorkflowsFromSession(e){const t=[];return t.push(...this.workflowsWithoutSessionAffinity||[]),t.push(...this.workflowsWithSessionAffinity.get(e)||[]),t.map((e=>e.workflow))}getWorkflowDefinitionsByName(e){var t;const s=new Map;return null===(t=this.workflowsWithSessionAffinity.get(e))||void 0===t||t.forEach((),s}getWorkflowDefinitionsWithSessionAffinity(){return this.workflowDefinitionsWithSessionAffinity}attachExecutionTrackerToEachWorkflow(e,t,s){const o=e.getWorkflowNodes(),n=this.executionTrackersByWorkflowNameBySession.get(t),i=(e,o)=>{s&&s(e,o),this.enableEarlyJoin&&(()=>{for(const e of this.executionTrackersByWorkflowNameBySession.get(t).values())if(e.graphNode.workflow.kind===Dt.Join)for(const t of e.getExecutionState().keys())if(Xt.isParentContextId(t,o))return!0;return!1})()&&(this.cancelSweepTimer(t),this.ensureSweepTimer(t),this.sweepScopeExecutionNotifications())};for(const e of o){const t=n.get(e.workflow.id),s=new lo(e,i.bind(this),t);n.set(e.workflow.id,s)}for(const e of n.values())this.setDownstreamWorkflowExecutionTrackers(e,n),this.setUpstreamWorkflowExecutionTrackers(e,n)}setDownstreamWorkflowExecutionTrackers(e,t){if(void 0!==e.downstreamWorkflowExecutionTrackers)return;e.downstreamWorkflowExecutionTrackers=new Set;const{graphNode:s}=e;for(const o of s.downstreamWorkflows||[]){const s=t.get(o.workflow.id);this.setDownstreamWorkflowExecutionTrackers(s,t),e.downstreamWorkflowExecutionTrackers.add(s)}}setUpstreamWorkflowExecutionTrackers(e,t){if(void 0!==e.upstreamWorkflowExecutionTrackers)return;e.upstreamWorkflowExecutionTrackers=new Set;const{graphNode:s}=e;for(const o of s.upstreamWorkflows||[]){const s=t.get(o.workflow.id);this.setUpstreamWorkflowExecutionTrackers(s,t),e.upstreamWorkflowExecutionTrackers.add(s)}}addSession(e){this.executionTrackersByWorkflowNameBySession.set(e,new Map);const t=[];for(const s of this.workflowDefinitionsWithSessionAffinity)t.push(this.createWorkflowImplementation(s)),e.attachToWorkflowGraph(s);this.workflowsWithSessionAffinity.set(e,t);for(const t of this.workflowsWithoutSessionAffinity)e.attachToWorkflowGraph(t.workflow)}closeSession(e){this.cancelSweepTimer(e);for(const t of this.workflowsWithSessionAffinity.get(e)||[])t.workflowLambda.dispose();this.workflowsWithSessionAffinity.delete(e)}setTokenCallback(e){this.getAuthTokenCallback=e}preProcessItemToWorkflow(e,t,s){const o=this.executionTrackersByWorkflowNameBySession.get(s).get(e.id);e.kind===Dt.Join&&b.matchesTypesFor(t.body,e.inputTypes)&&o.addInputItemToProcess(t.contextId),(e.kind===Dt.SingleItem&&b.matchesTypesFor(t.body,e.inputTypes)||e.kind===Dt.Join&&b.matchesTypesFor(t.body,[e.collectionScopeType]))&&o.beforeWorkflowExecution(t.contextId)}isReadyToEarlyJoin(e,t,s){const o=o=>{var n;const i=Array.from(null!==(n=o.states)&&void 0!==n?n:[]).map((e=>`${e[0]}: ${e[1].map((e=>e.join()))}`)).join(),r=new p({operationName:"EarlyJoinCompletion",resourceId:e.graphNode.workflow.id,joinContextId:t,success:!0}).start();r.setClientMetadata(s),r.resultDescription=`isReadyToEarlyJoin (${this.enableEarlyJoin}) -> hasProcessedAllInputItems: ${o.hasProcessedAllInputItems}, allUpstreamComplete: ${o.allUpstreamComplete}, states: ${i}`,g.a.info(512550800,g.b.CoreDefault,r.stop())},n=0===e.countItemsToProcess(t);if(!n)return this.enableEarlyJoin||o({hasProcessedAllInputItems:n}),!1;const{allUpstreamComplete:i,states:r}=this.areAllUpstreamWorkflowComplete(e,t);return this.enableEarlyJoin?i:(o({hasProcessedAllInputItems:n,allUpstreamComplete:i,states:r}),!1)}areAllUpstreamWorkflowComplete(e,t){const s=new Map;for(const o of e.upstreamWorkflowExecutionTrackers){const e=[];for(const[n,i]of o.getExecutionState())if(e.push([n,i]),Xt.isParentContextId(t,n))return s.set(o.graphNode.workflow.id,e),{allUpstreamComplete:!1,states:s};e.length>0&&s.set(o.graphNode.workflow.id,e)}return{allUpstreamComplete:!0,states:s}}runLocalWorkflows(e,t,s=!1){var o,n,i;const r=(e,s,o)=>{var n,i;const r=t.getWorkflowItemStorage(),{workflow:a}=e,c=null===(n=this.executionTrackersByWorkflowNameBySession.get(t))||void 0===n?void 0:n.get(a.id),l=a.inputTypes.concat(a.kind===Dt.Join?a.collectionScopeType:[]),u=new p({operationName:"RunLocalWorkflows",success:!0,resourceId:a.id,joinContextId:s.contextId}).start();if(u.setClientMetadata(t.getClientMetadata()),b.matchesTypesFor(s.body,l)){const n=$t(o.parentPath,s);if(a.kind===Dt.Join){if(b.matchesTypesFor(n.body,[a.collectionScopeType]))return r.setScopeItem(n,a),u.resultDescription=`Scope item: ${s.id} (${b.getTypeNameFor(s.body)})`,g.a.info(524126153,g.b.CoreDefault,u.stop()),void this.setScopeExecutionNotification(t,e,n,As.Internal);{c.removeProcessedInputItem(n.contextId);const e=r.getScopeItem(n.contextId,a);if(!e)return u.resultDescription=`Filtered out join invalidation: out of scope type (${a.collectionScopeType}), item id: ${n.id}`,void g.a.info(541173894,g.b.CoreDefault,u.stop());r.addItemToWorkflowList(n,a),u.joinContextId=e.contextId,u.resultDescription=`Input item: ${s.id} (${b.getTypeNameFor(s.body)})`}}if(b.getBaseTypesFor(n.body).indexOf(js.getTypeName())>=0){const e=[...n.parentPath,n.id];let s=!0;for(const o of null!==(i=a.outputTypes)&&void 0!==i?i:[])if(!t.getContextAnnotations(o,Ss.LocalWorkflow,e,a.id)){s=!1;break}if(s)return}const l=()=>{var o;const[i,p]=t.resolveRequestedContexts(a);if(!i)return u.resultDescription=`Required contexts are not ready for ${a.id}. Retrying execution in 500 milliseconds...`,g.a.info(545837259,g.b.CoreDefault,u.stop()),void setTimeout(l,500);if(a.kind===Dt.SingleItem)this.queueWorkflow({workflowInfo:e,scopeItem:n,inputItems:[n],requestedContexts:p,session:t,orchestrationMode:As.Internal,triggerReason:uo.InputReceived,onCompleteCallback:this.onWorkflowExecuted.bind(this,n,a,t)}).then((e=>{g.a.info(509154263,g.b.WorkflowDefault,u.stop())})).catch((e=>{u.resultDescription=e,g.a.error(572838111,g.b.CoreDefault,u.stop())}));else if(a.kind===Dt.Join){const n=s.contextId,i=r.getScopeItem(n,e.workflow);if(!i)return u.resultDescription=`No scope item for ${a.id} workflow from contextId ${n}`,void g.a.info(526758475,g.b.CoreDefault,u.stop());const l=this.isReadyToEarlyJoin(c,i.contextId,t.getClientMetadata()),h=l?uo.JoinEarlyCompletion:uo.JoinMaxAnnnotation;if(r.isWorkflowReady(i.contextId,a)||l){if(!(null===(o=this.pendingScopeExecutionNotificationsByWorkflow.get(a.id))||void 0===o?void 0:o.get(i.contextId)))return u.resultDescription=`Workflow ${a.id}, contextId ${i.contextId}, already queued, skipping new scope execution`,void g.a.info(528048977,g.b.CoreDefault,u.stop());const s=r.getItemsToExecute(i.contextId,a);this.queueWorkflow({workflowInfo:e,scopeItem:i,inputItems:s,requestedContexts:p,session:t,orchestrationMode:As.Internal,triggerReason:h,onCompleteCallback:this.onWorkflowExecuted.bind(this,i,a,t)}).then((e=>{g.a.info(509154262,g.b.WorkflowDefault,u.stop())})).catch((e=>{u.resultDescription=e,g.a.error(541173895,g.b.CoreDefault,u.stop())})),this.pendingScopeExecutionNotificationsByWorkflow.get(a.id).delete(i.contextId),0===this.pendingScopeExecutionNotificationsByWorkflow.get(a.id).size&&this.pendingScopeExecutionNotificationsByWorkflow.delete(a.id)}}};l()}};let a=e;s&&(a=[new D({parentPath:["session"],items:[{id:"#userContext#",body:new zs}]}),new D({parentPath:["session"],items:[{id:"#tenantContext#",body:new Vs}]})],t.getContextIdManager().applyContextIdOnOperations(a),a=a.concat(e));for(const e of a){const s=b.getTypeNameFor(e);for(const a of e.items)if(t.applyOperationForContext(e,a,Ss.Submitted),s!==L.getTypeName()){if(a.body)if(s===G.getTypeName()&&this.deltaHandlers&&this.deltaItems)this.handleLocalDeltaUpdate(a,e,t);else{null===(n=this.deltaItems)||void 0===n||n.set(a.id,a.body);for(const t of this.workflowsWithoutSessionAffinity)r(t,a,e);for(const s of null!==(i=this.workflowsWithSessionAffinity.get(t))&&void 0!==i?i:[])r(s,a,e)}}else null===(o=this.deltaItems)||void 0===o||o.delete(a.id)}}handleLocalDeltaUpdate(e,t,s){const o=new p({operationName:"LocalDeltaUpdate",dimension0:b.getTypeNameFor(e.body),success:!0});o.start();try{const n=this.deltaHandlers.get(b.getTypeNameFor(e.body)),i=this.deltaItems.get(t.parentPath[t.parentPath.length-1]);if(n&&i){const r=n(e.body,i);if(r){const n={id:e.id,revId:e.revId,body:r,parentPath:t.parentPath,delta:e.body,contextId:e.contextId},i=new M({parentPath:n.parentPath,items:[n]});g.a.info(539637591,g.b.CoreDefault,o.stop()),this.runLocalWorkflows([i],s)}else o.success=!1,o.resultDescription="Failed because the handler did not produce valid updated item",g.a.info(539637592,g.b.CoreDefault,o.stop())}else o.success=!1,o.resultDescription="Failed due to lack of handler or parent item",g.a.info(539637593,g.b.CoreDefault,o.stop())}catch(e){o.success=!1,o.resultDescription=`Failed to apply delta, error: ${e}`,g.a.info(539637594,g.b.CoreDefault,o.stop())}}createWorkflowImplementation(e,t){const s=e.factory();return{workflow:e,workflowLambda:s,initPromise:this.initWorkflow(e.kind,s,t)}}initWorkflow(e,t,s){var o;const n=new co({model:void 0,clientMetadata:s?s.getClientMetadata():void 0,userContext:s?s.getUserContext():void 0,site:this.site,getTokenCallback:null===(o=this.getAuthTokenCallback)||void 0===o?void 0:o.bind(this)});return e===Dt.SingleItem||e===Dt.Join?t.init(this.site,n):Promise.resolve()}queueWorkflow(e){var t,s;const o=e.session.getClientMetadata();let n;return o&&"outlook"==(null===(t=o.appName)||void 0===t?void 0:t.toLowerCase())&&"web"==(null===(s=o.appPlatform)||void 0===s?void 0:s.toLowerCase())&&"Production"!=o.releaseAudienceGroup&&(n=new p({operationName:"QueueLocalWorkflows",success:!0,resourceId:e.workflowInfo.workflow.id,joinContextId:e.scopeItem.contextId,dimension0:e.triggerReason}).start().setClientMetadata(o)),new Promise(((t,s)=>{setTimeout((()=>{n&&g.a.info(509154261,g.b.CoreDefault,n.stop()),this.executionTrackersByWorkflowNameBySession.get(e.session).get(e.workflowInfo.workflow.id).setExecutionState(e.scopeItem.contextId,Zt.Running),this.executeLocalWorkflow(e.workflowInfo,e.scopeItem,e.inputItems,e.session,e.requestedContexts,e.orchestrationMode,e.triggerReason).then((s=>{e.onCompleteCallback(),t(s)})).catch(()}),0)}))}executeLocalWorkflow(e,t,s,o,n,i,r){return new Promise(((a,c)=>{var l,u,h;const d={annotations:[]},f=[],m=e.workflow,y=new p({operationName:"ExecuteWorkflow",resourceId:m.id,joinContextId:null!==(l=null==t?void 0:t.contextId)&&void 0!==l?l:"",resultDescription:null!=r?r:"",success:!0}).setClientMetadata(o.getClientMetadata());y.start();const T=null!==(u=null==t?void 0:t.contextId)&&void 0!==u?u:s[0].contextId,w=null!==(h=null==t?void 0:t.revId)&&void 0!==h?h:s[0].revId,v=(()=>{const e=new Map;if(t&&(t.parentPath||g.a.error(525382231,g.b.CoreDefault,`Missing scope item parent. Workflow: ${m.id}. Type: ${b.getTypeNameFor(t.body)}`),e.set(t.body,t)),Array.isArray(s))for(const t of s)t&&t.body&&(t.parentPath||g.a.error(525382232,g.b.CoreDefault,`Missing parent. Workflow: ${m.id}. Type: ${b.getTypeNameFor(t.body)}`),e.set(t.body,t));return e})(),C=(e,t=y)=>{if(e)return t.success=!1,t.resultDescription+="string"==typeof e?e:e.message,t.resultSignature="Exception",g.a.error(572838112,g.b.CoreDefault,t.stop()),"string"==typeof e?new Error(e):e;g.a.info(572838113,g.b.CoreDefault,t.stop())},k=new co({model:new eo(s[0],n),clientMetadata:o.getClientMetadata(),userContext:o.getUserContext(),site:this.site,getTokenCallback:this.getAuthTokenCallback.bind(this)}),_=e=>{if(C(e?e.message:void 0),e)c(e);else{for(const e of f)o.onAnnotationResults(e,Ss.LocalWorkflow,(()=>{}));a(d)}},A={setAnnotations:(n,r,a,l)=>{var u;const h=new p({operationName:"SetAnnotations",resourceId:r,joinContextId:null!==(u=null==t?void 0:t.contextId)&&void 0!==u?u:"",success:!0}).setClientMetadata(o.getClientMetadata());h.start();const y=t=>{g.a.info(555866112,g.b.CoreDefault,new Xs({annotationType:r,annotationState:t,workflowId:e.workflow.id}))};for(const e of a)e.metadata=Object.assign(Object.assign({},e.metadata),{state:Bs.Created}),y(Bs.Created);const k=v.get(n),_=b.getTypeNameFor(k.body),A=(()=>{var e;if(m.kind===Dt.SingleItem&&s[0].body!==n){const e=`Expected obj to be ${s[0].body} but instead it was ${n}`;return C(e,h),void c(C(e))}let t,u;if(Array.isArray(a))if(!m.outputTypes||m.outputTypes.indexOf(r)<0)t=`Workflow said it would output one of [${m.outputTypes}] but instead output ${r}`;else if(k)for(const e of a)b.matchesTypesFor(e,[S.getTypeName()])?b.getTypeNameFor(e)!==r&&(t=`Workflow produced inconsistent annotation types in setAnnotations call (${b.getTypeNameFor(e)} did not match expected ${r})`):t=`Workflow produced an output that is not an annotation ${b.getTypeNameFor(e)}`;else t="No item provided";else t="Workflow produced an invalid annotation array";if(t)return C(t,h),void c(C(t));if(u=l&&l.isSessionAnnotation?["session"]:l&&l.ancestorType?k.parentPath:k.parentPath.concat(k.id),d.annotations.push({path:u,annotationType:r,annotations:a}),i===As.External)return;const p=[],f=[];for(const t of a){t.metadata=Object.assign(Object.assign({},t.metadata),{state:Bs.Sent}),y(Bs.Sent);const s=t.id,n=s?null===(e=o.getContextAnnotations(r,Ss.LocalWorkflow,u,m.id))||void 0===e?void 0:e.filter((e=>{var t;return(null===(t=e.body)||void 0===t?void 0:t.id)==s})):void 0;1==(null==n?void 0:n.length)?1==n.length?f.push({id:n[0].id,source:m.id,revId:w,body:t,contextId:T}):g.a.error(545837260,g.b.CoreDefault,`Assert: Multiple existing context annotations with body id ${s} found for ${r} and local workflow ${m.id}).`):p.push({id:this.getNextClientAnnotationId(),source:m.id,revId:w,body:t,contextId:T})}const v=[];return p.length>0&&v.push(new D({parentPath:u,items:p,parentRevId:w})),f.length>0&&v.push(new W({parentPath:u,items:f,parentRevId:w})),new be({annotationType:r,ops:v})})();A?(l&&l.immediate?o.onAnnotationResults(A,Ss.LocalWorkflow,(()=>{})):f.push(A),(_==zs.getTypeName()||_==Vs.getTypeName()||b.matchesTypesFor(k.body,[Fs.getTypeName(),Gs.getTypeName()]))&&o.submitOperationsToSession(A.ops),g.a.info(509644822,g.b.CoreDefault,h.stop())):g.a.info(509644823,g.b.CoreDefault,h.stop())},submitSignals:e=>{if(i===As.External)return void c(C("NYI"));const t=new p({operationName:"submitSignalsAction",resourceId:m.id,success:!0}).setClientMetadata(o.getClientMetadata());for(const s of e){const e=b.getTypeNameFor(s);b.matchesTypesFor(s,[I.getTypeName()])||(t.resultDescription=`Workflow produced an output that is not an signal (${b.getTypeNameFor(s)})`,g.a.info(521413954,g.b.CoreDefault,t)),m.outputTypes&&-1!==m.outputTypes.indexOf(e)||(t.resultDescription=`Workflow said it would output one of [${m.outputTypes}] but instead output ${e}`,g.a.info(521413953,g.b.CoreDefault,t)),s.timestamp&&(po.logTimestampUsageByWorkflowId.has(m.id)||(po.logTimestampUsageByWorkflowId.add(m.id),t.resultDescription=`Workflow "${m.id}" sets signal.timeStamp`,g.a.info(509212803,g.b.CoreDefault,t)))}const s=e.map((e=>({id:this.getNextClientSignalId(),source:m.id,revId:w,body:e,contextId:T}))),n=new U({parentPath:["session"],parentRevId:w,items:s});o.submitOperations([n])},done:_,overrideWorkflowDefinition:(e,s,n)=>{let i;switch(n){case Ds.JoinContext:if(!t.contextId){const e="ContextId is not defined for this scope item.";throw g.a.error(527472289,g.b.CoreDefault,e),new Error(e)}i=t.contextId;break;case Ds.Session:i=void 0;break;default:{const e="Defined scope is not supported. "+n;throw g.a.error(527472290,g.b.CoreDefault,e),new Error(e)}}const r=new kt({definition:s,contextId:i,sourceWorkflowId:m.id,targetWorkflowId:e});o.onWorkflowDefinitionOverrideMessage(r)}},x=e.workflowLambda;if(m.kind===Dt.SingleItem){1!==s.length&&_(new Error("Single item workflows expect a single input")),k.delta=s[0].delta,k.deltas=s[0].deltas;try{const t=x;e.initPromise||(e.initPromise=t.init(this.site,k)),e.initPromise.then((()=>{t.execute(s[0].body,k,A)})).catch((e=>{C(e)}))}catch(e){C(e)}}else if(m.kind===Dt.Join){0===s.length&&_(new Error("Join workflows expect an inputs array")),k.delta=t.delta,k.deltas=t.deltas;try{const o=x;e.initPromise||(e.initPromise=o.init(this.site,k)),e.initPromise.then((()=>{o.execute(t.body,s.map((e=>e.body)),k,A)})).catch((e=>{C(e)}))}catch(e){C(e)}}else C(`Workflow kind ${m.kind} not supported`)}))}ensureSweepTimer(e){if(!this.sweepTimers.get(e)){const t=setInterval(this.onSweep.bind(this),this.sweepIntervalMs);this.sweepTimers.set(e,t)}}cancelSweepTimer(e){const t=this.sweepTimers.get(e);this.sweepTimers.get(e)&&(clearInterval(t),this.sweepTimers.delete(e))}etScopeExecutionNotification(e,t,s,o){var n,i;const r=Date.now(),a={session:e,workflowImplementation:t,scopeItem:s,startTime:r,minTime:r+j(t.workflow.minDelayMs,1e3),maxTime:r+j(t.workflow.maxDelayMs,5e3),orchestrationMode:o},c=t.workflow.kind===Dt.Join?s.contextId:a.scopeItem.parentPath.concat(s.id).join("\\");if(this.pendingScopeExecutionNotificationsByWorkflow.get(t.workflow.id)||this.pendingScopeExecutionNotificationsByWorkflow.set(t.workflow.id,new Map),this.pendingScopeExecutionNotificationsByWorkflow.get(t.workflow.id).get(c)){const o=new p({resultDescription:`Duplicated pending scope execution for ${t.workflow.id} at ${c}`,operationName:"LocalScopeExecutionNotification",resourceId:t.workflow.id,joinContextId:null!==(i=null==s?void 0:s.contextId)&&void 0!==i?i:"",success:!0}).setClientMetadata(e.getClientMetadata()).start();g.a.info(509727899,g.b.CoreDefault,o.stop())}else{const o=new p({resultDescription:`New pending scope execution for ${t.workflow.id} at ${c}`,operationName:"LocalScopeExecutionNotification",resourceId:t.workflow.id,joinContextId:null!==(n=null==s?void 0:s.contextId)&&void 0!==n?n:"",success:!0}).setClientMetadata(e.getClientMetadata()).start();g.a.info(539883075,g.b.CoreDefault,o.stop()),this.pendingScopeExecutionNotificationsByWorkflow.get(t.workflow.id).set(c,a)}this.ensureSweepTimer(e)}sweepScopeExecutionNotifications(){var e,t;const s=new Set(Array.from(this.sweepTimers.keys()));for(const[o,n]of Array.from(this.pendingScopeExecutionNotificationsByWorkflow.entries()))for(const[i,r]of Array.from(n.entries())){const{session:n,workflowImplementation:{workflow:a},orchestrationMode:c}=r,l=n.getWorkflowItemStorage(),u=new p({operationName:"LocalScopeExecutionNotification",resourceId:a.id,joinContextId:null!==(t=null===(e=r.scopeItem)||void 0===e?void 0:e.contextId)&&void 0!==t?t:"",success:!0}).setClientMetadata(n.getClientMetadata()).start(),h=()=>{if(a.kind===Dt.Join){const e=Date.now(),{workflow:t}=r.workflowImplementation,s=r.scopeItem.contextId,o=n.getWorkflowDefinition(t,s).maxDelayMs;return l.isWorkflowReady(s,t)?(u.resultDescription=`Join Workflow: ${t.id} queuing by maxAnnotation, contextId: ${s}`,g.a.info(528048978,g.b.CoreDefault,u.stop()),{isValid:!0,triggerReason:uo.JoinMaxAnnnotation}):r.startTime+o<e?(u.resultDescription=`Join Workflow: ${t.id} queuing by maxTimeout, contextId: ${s}`,g.a.info(528048979,g.b.CoreDefault,u.stop()),{isValid:!0,triggerReason:uo.JoinMaxTimeout}):this.isReadyToEarlyJoin(this.executionTrackersByWorkflowNameBySession.get(n).get(t.id),s,n.getClientMetadata())?(g.a.info(512550856,g.b.CoreDefault,`Workflow: ${t.id} queuing by early completion, contextId: ${s}, timeout: ${o}`),{isValid:!0,triggerReason:uo.JoinEarlyCompletion}):{isValid:!1,triggerReason:uo.Unknown}}return{isValid:!0,triggerReason:uo.Unknown}};(()=>{const{isValid:e,triggerReason:t}=h();if(!e)return!1;const[s,o]=n.resolveRequestedContexts(a);if(!s)return!1;try{if(a.kind===Dt.Join){const e=r.scopeItem.contextId,s=l.getScopeItem(e,a);if(s){const i=l.getItemsToExecute(s.contextId,a);if(0===i.length)return u.resultDescription=`Failed to retrieve items for workflow: ${a.id}, contextId: ${e}, skipping execution`,g.a.info(527472291,g.b.CoreDefault,u.stop()),this.onWorkflowExecuted(s,a,n),!0;this.queueWorkflow({workflowInfo:r.workflowImplementation,scopeItem:s,inputItems:i,requestedContexts:o,session:n,orchestrationMode:c,triggerReason:t,onCompleteCallback:this.onWorkflowExecuted.bind(this,s,a,n)}).catch((e=>{u.success=!1,u.resultDescription=e.message,g.a.error(509092189,g.b.CoreDefault,u.stop())}))}else u.resultDescription="ContextId no longer exists, skipping workflow execution",g.a.info(539883076,g.b.CoreDefault,u.stop())}else u.resultDescription=`Workflow in type ${a.kind} is not supported`,g.a.error(539883077,g.b.CoreDefault,u.stop())}catch(e){u.resultDescription=`Trying to execute ${a.id} caused an exception: ${e}`,g.a.warn(539883078,g.b.CoreDefault,u.stop())}return!0})()?(this.pendingScopeExecutionNotificationsByWorkflow.get(o).delete(i),0===this.pendingScopeExecutionNotificationsByWorkflow.get(o).size&&this.pendingScopeExecutionNotificationsByWorkflow.delete(o)):s.delete(n)}if(0!==s.size)for(const e of Array.from(s)){const t=new p({resultDescription:"No pending scope notifications left, cancelling sweep timer",operationName:"LocalScopeExecutionNotification",success:!0}).start();g.a.debug(539883079,g.b.CoreDefault,t.stop()),this.cancelSweepTimer(e)}}onExternalWorkflowExecuted(e,t,s){this.onWorkflowExecuted({id:"",parentPath:[],contextId:e},{id:t},s,!1)}onWorkflowExecuted(e,t,s,o=!0){var n;null===(n=this.executionTrackersByWorkflowNameBySession.get(s).get(t.id))||void 0===n||n.afterWorkflowExecution(e.contextId),o&&t.kind===Dt.Join&&s.getWorkflowItemStorage().onWorkflowExecuted(e,t)}}class ho{constructor(e=500,t=!1){this.prevSeq=-1,this.bufferingTimeMs=e,this.rejectOutdatedSequenceNumbers=t}sequence(e){return new Promise(((t,s)=>{if(e<this.prevSeq){if(this.rejectOutdatedSequenceNumbers){const t=new Error(`BufferingSequencer: Item out of order. Expecting seqId > ${this.prevSeq}. Actual seqId ${e}`);return t.name=ho.Rejected,void s(t)}this.prevSeq=-1}e!=this.prevSeq+1&&g.a.warn(542712385,g.b.CoreDefault,`BufferingSequencer: got out of order sequence number. Got ${e}, expected ${this.prevSeq+1}`);const o={seq:e,resolve:t};this.insertItem(o),this.runInOrder(o,!0,!1)}))}insertItem(e){if(!this.firstQueueItem)return this.firstQueueItem=e,void(this.lastQueueItem=e);let t=this.lastQueueItem,s=null;do{if(e.seq>t.seq)return e.prev=t,t.next=e,void(s?s.prev=e:this.lastQueueItem=e);s=t,t=t.prev}while(t);s&&(s.prev=e),e.next=s,this.firstQueueItem=e}runInOrder(e,t,s){let o=this.prevSeq,n=!1;const i=[];for(;this.firstQueueItem;){const t=this.firstQueueItem;if(o+1!=t.seq&&(!s||t.seq>e.seq))break;o=t.seq,t.timeout&&clearTimeout(t.timeout),i.push(t),e==t&&(n=!0),this.firstQueueItem=this.firstQueueItem.next,this.firstQueueItem&&(this.firstQueueItem.prev=null)}i.length>0&&setTimeout((,0),this.prevSeq=o,!n&&t&&(e.timeout=setTimeout((,this.bufferingTimeMs))}}ho.Rejected="SequenceItemRejected";class go{constructor(e=500){this.bufferingTimeMs=500,this.workflowIdToSequencersMap=new Map,this.bufferingTimeMs=e}create(e){if(!e.ownerId)return null;let t=this.workflowIdToSequencersMap.get(e.ownerId);return t||(t=new ho(this.bufferingTimeMs),this.workflowIdToSequencersMap.set(e.ownerId,t)),t}}class fo{constructor(e=500,t){this.sequencerFactory=null!=t?t:new go(e)}sequence(e){var t;return function(e,t,s,o){return new(s||(s=Promise))((function(t,n){function i(e){try{a(o.next(e))}catch(e){n(e)}}(o=o.apply(e,[])).next())}))}(this,0,void 0,(function*(){if(null==(null===(t=null==e?void 0:e.metadata)||void 0===t?void 0:t.seq))return;const s=this.sequencerFactory.create(e);s&&(yield s.sequence(e.metadata.seq))}))}}class mo{constructor(e){this.annotationSequencer=null!=e?e:new fo}process(e,t,s,o){const n=[];for(const o of e.ops){const e=[];if(null==o?void 0:o.items)for(const s of o.items){const n=this.annotationSequencer.sequence(s.body).then(();e.push(n)}n.push(Promise.all(e).then(())}Promise.all(n).then(()}}class yo{process(e,t,s,o){for(const o of e.ops){if(null==o?void 0:o.items)for(const e of o.items)t(o,e);s(o)}o(e)}}class To{constructor(e,t,s){this.isOrderingEnabled=e,this.orderedAnnotationResultsProcessor=null!=t?t:new mo,this.unorderedAnnotationResultsProcessor=null!=s?s:new yo}process(e,t,s,o){this.isOrderingEnabled()?this.orderedAnnotationResultsProcessor.process(e,t,s,o):this.unorderedAnnotationResultsProcessor.process(e,t,s,o)}}class wo extends Ge.EventEmitter{init(){return Promise.resolve()}nMessage(e,t){}ndBytes(e){}lass vo{constructor(e,t,s){this.sessionsByDocSessionId=new Map,this.isDeltaGeneratorEnabled=!1,this.disableSyncDeltaSending=!1,this.hasBeenInitialized=!1,this.settings={dropOnlySequencedSyncsOnReseedEnabled:!0,closeWSBlockedSessionEnabled:!0,sessionOfflineModeEnabled:!0,annotationsOrderingEnabled:!1,deltaOperationsEnabled:!1,checkIdbByFeatures:!1,improvedWebSocketEnabled:!1,defaultBatchingEnabled:!0,batchingWith20msIntervalEnabled:!0},this.isDownloaderCompatible=()=>{if(this.settings.checkIdbByFeatures)return"undefined"!=typeof Array&&void 0!==Array.from&&"undefined"!=typeof URL&&void 0!==URL.createObjectURL;if("undefined"!=typeof navigator&&navigator.userAgent){const e=navigator.userAgent;return!(!e.indexOf||e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0)}return!1},this.workerFactory=e||(()=>new z);const o=this.createDefaultSessionManagerFactory();this.sessionManagerFactory=(...e)=>(null==t?void 0:t(...e))||o(...e),this.sessionFactory=s||(e=>new xs(e))}init(e,t,o,n){var i,r,c,l,u,h;const d=new p({operationName:"InitRuntime",resourceId:e,dimension1:this.hasBeenInitialized.toString()});d.start(),this.hasBeenInitialized=!0,this.hostCallbacks=o,this.shouldAddLogger(d)?(g.a.addLogger(new v(this.hostCallbacks)),this.addLoggingAggregator(n)):(g.a.clearLoggers(),g.a.addLogger(new v(this.hostCallbacks))),vo.haveCalledInit=!0,n&&n.networkMode===rt.LocalWorkflowsOnly&&(this.sessionManagerFactory=()=>new wo),this.annotationResultsProcessor=new To((),this.inferenceServiceFactory=n.inferenceServiceFactory,this.clientMetadata=t,this.clientMetadata&&(this.clientMetadata.runtimeVersion=(()),this.websocketSettings=n.websocketSettings,d.dimension2=Object(g.c)(a.a.info).toString();const f=[];e&&(this.defaultServiceUrl=$.convertServiceUrlToWebSocket(e),this.serviceProtocol=this.defaultServiceUrl.split(":")[0].toLowerCase()),f.push(this.isFeatureEnabled("CheckIdbByFeatures",!1).then((e=>{this.settings.checkIdbByFeatures=e}))),f.push(this.isFeatureEnabled("DropOnlySequencedSyncsOnReseedDisabled").then((e=>{this.settings.dropOnlySequencedSyncsOnReseedEnabled=!e}))),f.push(this.isFeatureEnabled("CloseWSBlockedSessionDisabled").then((e=>{this.settings.closeWSBlockedSessionEnabled=!e}))),f.push(this.isFeatureEnabled("SessionOfflineModeDisabled").then(()),f.push(this.isFeatureEnabled("AnnotationsOrderingEnabled",!1).then(()),f.push(this.isFeatureEnabled("ImprovedWebsocketEnabled").then((e=>{var t;(t=this.settings).improvedWebSocketEnabled||(t.improvedWebSocketEnabled=e)}))),f.push(this.isFeatureEnabled("DefaultBatchingDisabled").then((e=>{var t;(t=this.settings).defaultBatchingEnabled&&(t.defaultBatchingEnabled=!e)}))),f.push(this.isFeatureEnabled("BatchingWith20msIntervalDisabled").then((e=>{var t;(t=this.settings).batchingWith20msIntervalEnabled&&(t.batchingWith20msIntervalEnabled=!e)})));const m={enableDeltas:!1,enableEarlyJoin:!1};f.push(Promise.all([this.isFeatureEnabled("DeltaOperationsEnabled").then((e=>m.enableDeltas=e)).catch((()=>m.enableDeltas=!1)),this.isFeatureEnabled("EarlyJoinCompletionEnabled").then(().catch(()]).then((()=>{this.localWorkflowManager=new po(n.modelDownloader&&this.isDownloaderCompatible()?n.modelDownloader:void 0,this.inferenceServiceFactory,m)})));const y=ro(null!==(i=t.flights)&&void 0!==i?i:"");return this.isDeltaGeneratorEnabled=y.getBooleanValue("Microsoft.Office.WordOnline.AugloopDeltas",null!==(r=n.isDeltaGeneratorEnabled)&&void 0!==r&&r),this.disableSyncDeltaSending=y.getBooleanValue("Microsoft.Office.WordOnline.DisableSyncDeltaSending",null!==(c=n.disableSyncDeltaSending)&&void 0!==c&&c),this.syncDeltaTimeout=y.getIntValue("Microsoft.Office.WordOnline.SyncDeltaTimeout",n.syncDeltaTimeout),(l=this.settings).improvedWebSocketEnabled||(l.improvedWebSocketEnabled=y.getBooleanValue("Microsoft.Office.WordOnline.Augloop.ImprovedWebsocketEnabled",!1)),(u=this.settings).defaultBatchingEnabled&&(u.defaultBatchingEnabled=!y.getBooleanValue("Microsoft.Office.WordOnline.Augloop.DefaultBatchingDisabled",!1)),(h=this.settings).batchingWith20msIntervalEnabled&&(h.batchingWith20msIntervalEnabled=!y.getBooleanValue("Microsoft.Office.WordOnline.Augloop.BatchingWith20msIntervalDisabled",!1)),Promise.all(f).then((()=>{this.batchOptions=n.batchOptions,!this.batchOptions&&this.settings.defaultBatchingEnabled&&(this.batchOptions={delayMs:1,maxInputSize:1e6},this.settings.batchingWith20msIntervalEnabled&&(this.batchOptions.delayMs=20)),d.dimension0=JSON.stringify(this.batchOptions),this.logOperation(d,!0)})).catch((e=>{this.logOperation(d,!1,"Error",e?e.message:"(no error)")}))}getServiceProtocol(){return this.serviceProtocol}registerLocalWorkflow(e){this.localWorkflowManager.registerLocalWorkflow(e)}reateSession(e){var t;const s=e&&e.docSessionId?e.docSessionId:bs(),o=this.sessionsByDocSessionId.get(s);if(o&&!1===o.isClosed)throw new Error("docSessionId already exists");let n=e&&null!==(t=e.serviceUrl)&&void 0!==t?t:this.defaultServiceUrl;n=$.convertServiceUrlToWebSocket(n),n||(e.networkMode=rt.LocalWorkflowsOnly);const i=Object.assign({},this.clientMetadata);i.docSessionId=s,e&&e.flights&&(i.flights=i.flights?i.flights+";"+e.flights:e.flights);const r=this.sessionFactory({hostCallbacks:this.hostCallbacks,sessionManager:this.sessionManagerFactory(i,n,e,this.websocketSettings),batchOptions:this.batchOptions,extensionConfigs:(null==e?void 0:e.extensionConfigs)||[],clientMetadata:i,userContext:e?e.userContext:void 0,localWorkflowManager:e&&e.enableComplexLocalWorkflows?void 0:this.localWorkflowManager,annotationResultsProcessor:this.annotationResultsProcessor,localRegisteredWorkflows:(null==e?void 0:e.localRegisteredWorkflows)||[],enableRemoteExecutionNotification:(null==e?void 0:e.enableRemoteExecutionNotification)||!1,networkMode:e&&void 0!==e.networkMode?e.networkMode:void 0,egress:e?e.egress:void 0,isDeltaGeneratorEnabled:this.isDeltaGeneratorEnabled,disableSyncDeltaSending:this.disableSyncDeltaSending,syncDeltaTimeout:this.syncDeltaTimeout});return this.sessionsByDocSessionId.set(s,r),e&&e.onSessionConnect&&r.setConnectCallback(e.onSessionConnect),e&&e.onSessionDisconnect&&r.setDisconnectCallback(e.onSessionDisconnect),e&&e.onSessionReconnect&&r.setReconnectCallback(e.onSessionReconnect),e&&e.onSessionClose&&r.setSessionCloseCallback(e.onSessionClose),e&&e.onServerAuthenticationStateChangeCallback&&r.setServerAuthenticationStateChangeCallback(e.onServerAuthenticationStateChangeCallback),r.initialize?r.initialize():Promise.resolve(r)}getSessionManagerFactory(){return this.sessionManagerFactory}shouldAddLogger(e){if(vo.haveCalledInit){const t=new Error("Runtime already initialized");return e.dimension3=t.stack,e.dimension2=Object(g.c)(a.a.info).toString(),this.logOperation(e,!1,"Error",t.message),!1}return!0}createDefaultSessionManagerFactory(){return(e,t,s)=>{if(s&&s.enableComplexLocalWorkflows)throw new Error("NYI");if(s&&s.networkMode==rt.LocalWorkflowsOnly)return new wo;const o=new Es,n=new Ns;let i=()=>{g.a.error(573321615,g.b.CoreDefault,"Unexpectedly not set sendMessage")};const r=new Os((,e,o,(,{getAuthToken:this.getAuthToken.bind(this,e.docSessionId),overrideSessionInitMessage:this.hostCallbacks.overrideSessionInitMessage,enableRemoteExecutionNotification:(null==s?void 0:s.enableRemoteExecutionNotification)||!1}),a=new nt($.convertServiceUrlToWebSocket(t),n,this.workerFactory,r,e,o,this.settings,this.websocketSettings);return i=a.sendMessage.bind(a),a.on("disconnect",(()=>o.clearRefreshTimeouts())),a.on("connect",((e,t,s,o)=>{e&&this.hostCallbacks.setSessionData&&this.hostCallbacks.setSessionData(t,s,o)})),a}}getAuthToken(e){const t={Tickets:[]};return e&&(t.DocSessionId=e),this.hostCallbacks.requestAuthToken(t).then(().catch((()=>{}))}isFeatureEnabled(e,t=!1,s="None"){return $.isFeatureEnabled(this.hostCallbacks,e,t,s)}logOperation(e,t,s,o){e.stop(),e.success=t,e.resultSignature=s,e.resultDescription=o,g.a.info(573321622,g.b.CoreDefault,e)}addLoggingAggregator(e){var t,s,o;g.a.addAggregator(w("Operation","operationName",["ExecuteBatch","ProcessResponse","LocalDeltaUpdate","ApplyFormattedTextTileDeltaForLocalWorkflows","ApplyTextTileDeltaForLocalWorkflows","FindRangeForDelta","RunModelForInferencing","GetResource","CreateTextTileDeltaFromItem","WSEgressControl","OnAnnotationResultsEgress"],null!==(t=e.telemetryAggregationIntervalSec)&&void 0!==t?t:30)),g.a.addAggregator(w("Operation","operationName",["ExecuteWorkflow","ExecuteLambda","RunLocalWorkflows"],null!==(s=e.telemetryAggregationIntervalSec)&&void 0!==s?s:60)),g.a.addAggregator(w("SessionHealth","sessionHealthEventName",["SendMessage","ProcessMessage"],null!==(o=e.telemetryAggregationIntervalSec)&&void 0!==o?o:60))}uninitialize(){this.flushTelemetry(!0),this.hostCallbacks=null,this.hasBeenInitialized=!1,vo.haveCalledInit=!1,g.a.clearAggregators(),g.a.clearLoggers()}}new vo;var Co=s("5Q+G"),ko=s("V2nY");class _o{constructor(e){ko.a.assign(_o,this,e)}static getTypeName(){return"AugLoop_Core_Blob"}static getBaseTypes(){return[]}static typeGuard(e){return ko.a.matchesTypesFor(e,[_o.getTypeName()])}}_o.H_={T_:_o.getTypeName(),B_:_o.getBaseTypes()};class bo{constructor(e){ko.a.assign(bo,this,e)}static getTypeName(){return"AugLoop_Core_Binary"}static getBaseTypes(){return[]}static typeGuard(e){return ko.a.matchesTypesFor(e,[bo.getTypeName()])}}bo.H_={T_:bo.getTypeName(),B_:bo.getBaseTypes()};class So{constructor(e){ko.a.assign(So,this,e)}static getTypeName(){return"AugLoop_Core_TileGroup"}static getBaseTypes(){return[]}static typeGuard(e){return ko.a.matchesTypesFor(e,[So.getTypeName()])}}So.H_={T_:So.getTypeName(),B_:So.getBaseTypes()};class Ao{constructor(e){ko.a.assign(Ao,this,e)}static getTypeName(){return"AugLoop_Core_Session"}static getBaseTypes(){return["AugLoop_Core_TileGroup"]}static typeGuard(e){return ko.a.matchesTypesFor(e,[Ao.getTypeName()])}}Ao.H_={T_:Ao.getTypeName(),B_:Ao.getBaseTypes()};class Io{constructor(e){ko.a.assign(Io,this,e)}static getTypeName(){return"AugLoop_Core_Document"}static getBaseTypes(){return["AugLoop_Core_TileGroup"]}static typeGuard(e){return ko.a.matchesTypesFor(e,[Io.getTypeName()])}}Io.H_={T_:Io.getTypeName(),B_:Io.getBaseTypes()};class xo{constructor(e){ko.a.assign(xo,this,e)}static getTypeName(){return"AugLoop_Core_SubDocument"}static getBaseTypes(){return[]}static typeGuard(e){return ko.a.matchesTypesFor(e,[xo.getTypeName()])}}xo.H_={T_:xo.getTypeName(),B_:xo.getBaseTypes()};class No{constructor(e){ko.a.assign(No,this,e)}static getTypeName(){return"AugLoop_Core_GridCell"}static getBaseTypes(){return[]}static typeGuard(e){return ko.a.matchesTypesFor(e,[No.getTypeName()])}}No.H_={T_:No.getTypeName(),B_:No.getBaseTypes()};class Mo{constructor(e){ko.a.assign(Mo,this,e)}static getTypeName(){return"AugLoop_Core_GridNeighborhoodContext"}static getBaseTypes(){return[]}static typeGuard(e){return ko.a.matchesTypesFor(e,[Mo.getTypeName()])}}Mo.H_={T_:Mo.getTypeName(),B_:Mo.getBaseTypes()};class Bo{constructor(e){ko.a.assign(Bo,this,e)}static getTypeName(){return"AugLoop_Core_ItemFilter"}static getBaseTypes(){return[]}static typeGuard(e){return ko.a.matchesTypesFor(e,[Bo.getTypeName()])}}Bo.H_={T_:Bo.getTypeName(),B_:Bo.getBaseTypes()};class Do{constructor(e){ko.a.assign(Do,this,e)}static getTypeName(){return"AugLoop_Core_DynamicContext"}static getBaseTypes(){return[]}static typeGuard(e){return ko.a.matchesTypesFor(e,[Do.getTypeName()])}}Do.H_={T_:Do.getTypeName(),B_:Do.getBaseTypes()};class Eo{constructor(e){ko.a.assign(Eo,this,e)}static getTypeName(){return"AugLoop_Core_ContextHolder"}static getBaseTypes(){return[]}static typeGuard(e){return ko.a.matchesTypesFor(e,[Eo.getTypeName()])}}Eo.H_={T_:Eo.getTypeName(),B_:Eo.getBaseTypes()};class Oo{constructor(e){ko.a.assign(Oo,this,e)}static getTypeName(){return"AugLoop_Core_UserContextHolder"}static getBaseTypes(){return["AugLoop_Core_ContextHolder"]}static typeGuard(e){return ko.a.matchesTypesFor(e,[Oo.getTypeName()])}}Oo.H_={T_:Oo.getTypeName(),B_:Oo.getBaseTypes()};class Wo{constructor(e){ko.a.assign(Wo,this,e)}static getTypeName(){return"AugLoop_Core_TenantContextHolder"}static getBaseTypes(){return["AugLoop_Core_ContextHolder"]}static typeGuard(e){return ko.a.matchesTypesFor(e,[Wo.getTypeName()])}}Wo.H_={T_:Wo.getTypeName(),B_:Wo.getBaseTypes()};class Lo{constructor(e){ko.a.assign(Lo,this,e)}static getTypeName(){return"AugLoop_Core_EventsHolder"}static getBaseTypes(){return[]}static typeGuard(e){return ko.a.matchesTypesFor(e,[Lo.getTypeName()])}}Lo.H_={T_:Lo.getTypeName(),B_:Lo.getBaseTypes()};class Ro{constructor(e){ko.a.assign(Ro,this,e)}static getTypeName(){return"AugLoop_Core_UserCommandsHolder"}static getBaseTypes(){return["AugLoop_Core_EventsHolder"]}static typeGuard(e){return ko.a.matchesTypesFor(e,[Ro.getTypeName()])}}Ro.H_={T_:Ro.getTypeName(),B_:Ro.getBaseTypes()};var Po=s("MJsD"),Fo=s("gCKw"),Go=s("elnK"),Ho=s.n(Go)()((function(e,t){return{runtimeInitPromises:new Map,getRuntime:function(s){void 0===s&&(s=r);var n=t().runtimeInitPromises,a=n.get(s);if(a)return a;var c=((),l=new Promise((function(e,t){return Object(o.__awaiter)(void 0,void 0,void 0,(function(){var n,r,a,l,u;return Object(o.__generator)(this,(function(o){switch(o.label){case 0:return[4,Object(Po.a)()];case 1:return n=o.sent(),r=function(e){var t=1===e.TokenType?"Substrate":"AugLoop";return n.getAccessToken(t,!1,"AugLoop"===t&&"Int"===s?"https://augloop-int.officeppe.com/v2":void 0).then((function(t){return{Token:t.token,TokenProperties:{returnedTokenType:1===e.TokenType?1:0,timeToLiveSec:t.expiryMs}}}))},[4,Object(Fo.a)()];case 2:return a=o.sent(),l=(null===(u=a.result.magicGroupingGates)||void 0===u?void 0:u.magicGroupingLLMWorkflowEnabled)?"magicGroupingLLMWorkflowEnabled":"",c.init(i[s],{appName:"OfficeHome",appPlatform:"Web",appVersion:"1",releaseAudienceGroup:"Microsoft",sessionId:n.correlationId,flights:l},{requestAuthToken:r,sendTelemetryEvent:isFeatureEnabled:areLicenseFeaturesEnabled:,{telemetryAggregationIntervalSec:30}).then(().catch((),[2]}}))}))}));return e({runtimeInitPromises:n.set(s,l)}),l},createSession:function(e){return void 0===e&&(e=r),t().getRuntime(e).then(().then((function(e){return e.setConnectCallback((function(t){if(t){var s=new Co.a({parentPath:["session"],items:[{id:"doc",revId:"0",body:new Io({isReadonly:!1})}]});e.submitSeedOperations([s])}})),e}))}}}));function Uo(e,t,s){var i=this;void 0===s&&(s=r);var a=Ho(),c=function(e,t){var s=Object(o.__read)(Object(n.useState)(void 0),2),i=s[0],r=s[1],a=Object(n.useRef)(),c=Object(n.useRef)(e),l=Object(n.useRef)(t);return Object(n.useEffect)((function(){var e,t=null!==(e=a.current)&&void 0!==e?e:c.current();a.current||(a.current=t),t.then(();var s=l.current;return function(){t.then(()}}),[]),i}(Object(n.useCallback)((function(){return Object(o.__awaiter)(i,void 0,void 0,(function(){var t,n;return Object(o.__generator)(this,(function(o){switch(o.label){case 0:return[4,a.createSession(s)];case 1:return t=o.sent(),[4,e(t)];case 2:return n=o.sent(),[2,[t,n]]}}))}))}),[a,e,s]),Object(n.useCallback)((function(e){var s=Object(o.__read)(e,2),n=s[0];null==t||t(s[1]),n.close()}),[t]));return Object(o.__read)(null!=c?c:[void 0,void 0],2)[1]}},"fW/M":hs6A:function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return o}));const o=(()=>void 0!==e&&e.hrtime?()=>{const t=e.hrtime();return 1e3*t[0]+t[1]/1e6}:"undefined"!=typeof performance&&performance.now?()=>performance.now():()}).call(this,s("5IsQ"))},p0jh:function(e,t,s){"use strict";s.d(t,"d",(function(){return n})),s.d(t,"b",(function(){return r})),s.d(t,"c",(function(){return a})),s.d(t,"a",();var o=s("LlSO");class n{constructor(e){o.a.assign(n,this,e)}get metadata(){return this.M_}set metadata(e){this.M_=e}static getTypeName(){return"AugLoop_HarmonyCopilot_HarmonyFirstDraftDocumentTypeResponse"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return o.a.matchesTypesFor(e,[n.getTypeName()])}}n.H_={T_:n.getTypeName(),B_:n.getBaseTypes()};class i{constructor(e){o.a.assign(i,this,e)}get metadata(){return this.M_}set metadata(e){this.M_=e}static getTypeName(){return"AugLoop_HarmonyCopilot_HarmonyFirstDraftContentGenerationAskAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return o.a.matchesTypesFor(e,[i.getTypeName()])}}i.H_={T_:i.getTypeName(),B_:i.getBaseTypes()};class r{constructor(e){o.a.assign(r,this,e)}get metadata(){return this.M_}set metadata(e){this.M_=e}static getTypeName(){return"AugLoop_HarmonyCopilot_HarmonyFirstDraftContentResponse"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return o.a.matchesTypesFor(e,[r.getTypeName()])}}r.H_={T_:r.getTypeName(),B_:r.getBaseTypes()};class a{constructor(e){o.a.assign(a,this,e)}get metadata(){return this.M_}set metadata(e){this.M_=e}static getTypeName(){return"AugLoop_HarmonyCopilot_HarmonyFirstDraftCreateDocumentResponse"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return o.a.matchesTypesFor(e,[a.getTypeName()])}}a.H_={T_:a.getTypeName(),B_:a.getBaseTypes()};class c{constructor(e){o.a.assign(c,this,e)}get metadata(){return this.M_}set metadata(e){this.M_=e}static getTypeName(){return"AugLoop_HarmonyCopilot_HarmonyFileSuggestions"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return o.a.matchesTypesFor(e,[c.getTypeName()])}}c.H_={T_:c.getTypeName(),B_:c.getBaseTypes()};class l{constructoret metadata(){return this.M_}set metadata(e){this.M_=e}static getTypeName(){return"AugLoop_HarmonyCopilot_HarmonyCopilotOutputAnnotation"}static getBaseTypes(){return["AugLoop_Copilot_CopilotOutputAnnotation","AugLoop_Core_Annotation"]}static typeGuard(e){return o.a.matchesTypesFor(e,[l.getTypeName()])}}l.H_={T_:l.getTypeName(),B_:l.getBaseTypes()}}}]);
//# sourceMappingURL=103.f07237a216929546a12c.chunk.v7.js.map