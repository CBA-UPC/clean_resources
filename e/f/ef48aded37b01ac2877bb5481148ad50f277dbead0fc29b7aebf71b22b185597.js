;
(self.AMP=self.AMP||[]).push({m:0,v:"2401191523000",n:"amp-web-push",ev:"0.1",l:!0,f:function(t,n){!function(){isArray;var s=Object.prototype;.hasOwnProperty,s.toString;var a=/(\0)|^(-)$|([\x01-\x1f\x7f]|^-?[0-9])|([\x80-\uffff0-9a-zA-Z_-]+)|[^]/g;var l=/(?:^[#?]?|&)([^=&]+)(?:=([^&]*))?/ar m="elf.__AMP_LOG=self.__AMP_LOG||{user:null,dev:null,userForEmbed:null};var y=self.__AMP_LO P="amp-web-push",k=P,_=P+"-service",x=P+"-widget",A="granted",T="denied",M="defaultar var W,F=function(t){i(e,t);var n=u(e);function e(t){return n.call(this,t)}var r=e.prototype;return r.isLayoutSupporte},r.buildCallbac},e}(t.BaseElement),V="subscribed",G="unsubscribed",K="blocked}function q(t,n,i,e){var r=i,o=function(t,n,i,e){var r=t,o=i,},}(),c=!(null==e||!e.capture);return r.addEventListener(n,u,s?e:c}}(t,n}),e);return }var B,Q,Y=function(){function t(t,n){this.wi=t,this.Vt=n,this.Evt=null,this.di=new Promise((function(){}))}var n=t.prototype;return n.load=function(){var t=this;return this.wi.whenReady().then((function(){var n,i;return t.Evt=t.wi.win.document.createElement("iframe"),n=t.Evt,void 0===(i=!1)&&(i=n.hasAttribute("hidden")),i?n.removeAttribute("hidden"):n.setAttribute("hidden",""),t.Evt.sandbox="allow-same-origin allow-scripts",t.Evt.src=t.Vt,t.wi.getBody().appendChild(t.Evt),t.d}(t.Evt),t.whenReady()}))},n.getDomElement=function(){return this.Evt},n.whenRead},t}(),}(}var $=function(){function t(t){t||(t={debug:!1,windowContext:window}),this.ir={},this.av={},this.lv=t.debug,this.hv=!1,this.vv=!1,this.Xn=!1,this.dv=null,this.pv=null,this.mv=null,this.gv=null,this.wv=null,this.yv=t.windowContext||window}var n=t.prototype;return n.listen=function(n){var i=this;return new Promise((function(t,e){i.Xn?e(new Error("Already connected.")):i.hv?e(new Error("Already listening for connections.")):Array.isArray(n)?(i.mv=i.Ev.bind(i,n,t,e),i.yv.addEventListener("message",i.mv),i.lv&&I().fine(P,"Listening for a connection message...")):e(new Error("allowedOrigins should be a string array of allowed origins to accept messages from. Got:",n))})).then((function(){i.send(t.Topics.CONNECT_HANDSHAKE,null),i.Xn=!0}))},n.ra=function(t,n){for(var i=Z(t).origin,e=0;e<n.length;e++)if(Z(n[e]).origin===i)return!0;return!1},n.Ev=function(n,i,e,r){var o=H(r),u=r.origin,s=r.ports;this.lv&&I().fine(P,"Window message for listen() connection received:",o),this.ra(u,n)?o&&o.topic===t.Topics.CONNECT_HANDSHAKE?(I().fine(P,"Received expected connection handshake message:",o),this.yv.removeEventListener("message",this.mv),this.pv=s[0],this.wv=this.bv.bind(this),this.pv.addEventListener("message",this.wv,!1),this.pv.start(),i()):I().fine(P,"Discarding connection message because it did not contain our expected handshake:",o):I().fine(P,"Discarding connection message from ".concat(u," ")+"because it isn't an allowed origin:",o," (allowed  origins are)",n)},n.connect=function(n,i){var e=this;return new Promise((function(r,o){n||o(new Error("Provide a valid Window context to connect to.")),i||o(new Error("Provide an expected origin for the remote Window or provide the wildcard *.")),e.Xn?o(new Error("Already connected.")):e.vv?o(new Error("Already connecting.")):(e.dv=new MessageChannel,e.pv=e.dv.port1,e.gv=e.Rv.bind(e,e.pv,i,r),e.pv.addEventListener("message",e.gv),e.pv.start(),n.postMessage({topic:t.Topics.CONNECT_HANDSHAKE},"*"===i?"*":Z(i).origin,[e.dv.port2]),I().fine(P,"Opening channel to ".concat(i,"...")))}))},n.Rv=function(t,n,i){this.Xn=!0,this.lv&&I().fine(P,"Messenger channel to ".concat(n," established.")),t.removeEventListener("message",this.gv),this.wv=this.bv.bind(this),t.addEventListener("message",this.wv,!1),i()},n.bv=function(t){var n=H(t);if(this.ir[n.id]&&n.isReply){var i=this.ir[n.id];delete this.ir[n.id];var e=i.promiseResolver;i.message=n.data,this.lv&&I().fine(P,"Received reply for topic '%s': %s",n.topic,n.data),e([n.data,this.Av.bind(this,n.id,i.topic)])}else{var r=this.av[n.topic];if(!r)return;this.lv&&I().fine(P,"Received new message for "+"topic '".concat(n.topic,"': ").concat(n.data));for(var o=0;o<r.length;o++)(0,r[o])(n.data,this.Av.bind(this,n.id,n.topic))}},n.o},n.off=function(t,n){if(n){var i=this.av[t].indexOf(n);-1!==i&&this.av[t].splice(i,1)}else this.av[t]&&delete this.av[t]},n.Av=function(t,n,i){var e=this,r={id:t,topic:n,data:i,isReply:!0};return this.pv.postMessage(r),new Promise((function(t){e.ir[r.id]={message:i,topic:n,promiseResolver:t}}))},n.send=function(t,n){var i=this,e={id:crypto.getRandomValues(new Uint8Array(10)).join(""),topic:t,data:n};return this.lv&&I().fine(P,"Sending %s: %s",t,n),this.pv.postMessage(e),new Promise((function(r){i.ir[e.id]={message:n,topic:t,promiseResolver:r}}))},C(t,null,[{key:"Topics",ge}}]),t}(),X="amp-web-push-widget.amp-invisible{visibility:hidden}\n/*# sourceURL=/extensions/amp-web-push/0.1/amp-web-push.css*/function it(t){return n=_,function(t,n){var i=function(t,n){var i=D(t)[n];return i?i.promise?i.promise:(N(t,n),i.promise=Promise.resolve(i.obj)):null}(t,n);if(i)return i;var e,r,o,u,s=D(t);return s[n]=(r=(e=new L).promise,o=e.reject,u=e.resolve,r.catch((function(){})),{obj:null,promise:r,resolve:u,reject:o,context:null,ctor:null}),s[n].promise}((o=(i=t).nodeType?(r=i,e=(r.ownerDocument||r).defaultView,function(t,n){return N(}(t),"ampdoc")}(e)).getAmpDoc(i):i).isSingleDoc()?o.win:o,n);var n,i,e,r,o}var et=function(){function t(t){this.ampdoc=}(t,0,(function(){})),this.ek={"helper-iframe-url":null,"permission-dialog-url":null,"service-worker-url":null,debug:null},this.lv=w().development,this.fb=null,this.Rvt=null,this.Pvt=new $({debug:this.lv}),this.kvt=null}var n=t.prototype;return n.start=function(t){var n=this;if(I().fine(P,"amp-web-push extension starting up."),!this.environmentSupportsWebPush())return R().warn(P,"Web push is not supported."),Promise.reject("Web push is not supported");this.initializeConfig(t);var i=this.installHelperFrame();return i.then((function(){return I().fine(P,"Helper frame ".concat(n.ek["helper-iframe-url"]," ")+"DOM loaded. Connecting to the frame via postMessage()..."),n.Pvt.connect(n.fb.getDomElement().contentWindow,Z(n.ek["helper-iframe-url"]).origin)})).then((function(){if(!n.isContinuingSubscriptionFromRedirect())return n.updateWidgetVisibilities();n._vt()})),i},n.initializeConfi},n.installHelperFrame=function(){var t=-1!==this.ek["helper-iframe-url"].indexOf("?")?"&":"?",n="".concat(this.ek["helper-iframe-url"]).concat(t)+"parentOrigin=".concat(this.ampdoc.win.location.origin);return this.fb=new Y(this.ampdoc,n),this.fb.load()},n.isContinuingSubscriptionFromRedirect=function(){return-1!==(this.ampdoc.win.testLocation||this.ampdoc.win.location).search.indexOf(t.PERMISSION_POPUP_URL_FRAGMENT)},n.removePermissionPopupUrlFragmentFromUrl=function(n){return n.replace("?".concat(t.PERMISSION_POPUP_URL_FRAGMENT),"").replace("&".concat(t.PERMISSION_POPUP_URL_FRAGMENT),"")},n.xvt=function(t,n){var i=this;return this.fb.whenReady().then})).then((function(i){var e=i[0];if(e.success)return e.result;throw new Error("AMP page helper iframe query topic ".concat(t," ")+"and message ".concat(n," failed with: ").concat(e.error))}))},n.Av},n.queryNotificationPermission=function(){return this.xvt($.Topics.NOTIFICATION_PERMISSION_STATE,null)},n.Tv},n.registerServiceWorker=function(){var t=this.ek["service-worker-url"],n=this.ek["service-worker-scope"];return this.xvt($.Topics.SERVICE_WORKER_REGISTRATION,{workerUrl:t,registrationOptions:n?{scope:n}:{}})},n.querySubscriptionStateRemotely=function(){return this.Avt("amp-web-push-subscription-state",null)},n.subscribeForPushRemotely=function(){return this.Avt("amp-web-push-subscribe",null)},n.unsubscribeFromPushRemotel},n.isServiceWorkerActivated=function(){var t=this,n=this;return this.Tvt().then((function(i){var e=!0===i.isControllingFrame,r=t.isUrlSimilarForQueryParams(i.url,n.ek["service-worker-url"]),o="activated"===i.state;return e&&r&&o}))},n.isUrlSimilarForQueryParams=function(t,n){var i=Z(t),e=d(i.search),r=Z(n),o=d(r.search);for(var u in e)if(o[u]!==e[u])return!1;return i.origin===r.origin&&i.pathname===r.pathname},n.setWidgetVisibilities=function(t,n){for(var i=this.ampdoc.getRootNode().querySelectorAll("".concat(h(x),"[visibility=").concat(h(t),"]")),e="amp-invisible",r=0;r<i.length;r++){var o=i[r];n?o.classList.remove(e):o.classList.add(e)}},n.Mvt=function(t){return this.ampdoc.getRootNode().querySelectorAll("".concat(h(x),"[visibility=").concat(h(t),"]")).length>0},n.Uvt=function(t){if("boolean"==typeof t)return 1},n.Cvt=function(){var t=this;return this.queryNotificationPermission().then}))},n.updateWidgetVisibilities=function(){var t=this;return this.Cvt().then})).then((function(n){return!0===n?t.Nvt("amp-web-push-notification-permission"):Promise.resolve(M)})).then((function(n){if(n!==T)return t.isServiceWorkerActivated().then}));t.Mvt(K)?t.Fvt():t.Wvt()}))},n.Dvt=function(){var n,i=this;return(n=this.ampdoc.win,N(n,"timer")).timeoutPromise(5e3,this.querySubscriptionStateRemotely().then((function(n){if(i.Uvt(n)!==t.AMP_VERSION_INITIAL)throw R().createError("The controlling service worker replied to amp-web-push with an unexpected value.");n?(i.setWidgetVisibilities(G,!1),i.setWidgetVisibilities(V,!0),i.setWidgetVisibilities(K,!1)):i.Wvt()})),"The controlling service worker does not support amp-web-push.")},n.Wvt=function(){this.setWidgetVisibilities(G,!0),this.setWidgetVisibilities(V,!1),this.setWidgetVisibilities(K,!1)},n.Fvt=function(){this.setWidgetVisibilities(G,!1),this.setWidgetVisibilities(V,!1),this.setWidgetVisibilities(K,!0)},n.subscribe=function(t){var n=this,i=[];return i.push(this.registerServiceWorker()),i.push(new Promise((function(i){if(n.Rvt===A)return n.Vvt().then((function(){i()}));var e=n.openPopupOrRedirect();n.Gvt(e,t),n.kvt=new $({debug:n.lv}),n.kvt.listen([n.ek["permission-dialog-url"]]),n.onPermissionDialogInteracted().then})).then}))}))),Promise.all(i)},n.Gvt=function(t,n){var i=this;if(t&&!t.closed)var e=this.ampdoc.win.setInterval((function(){t.closed&&(n(),i.ampdoc.win.clearInterval(e))}),500)},n.handlePermissionDialogInteraction=function(t){var n=t[0],i=t[1];switch(n){case T:case M:return i({closeFrame:!0}),this.updateWidgetVisibilities();case A:i({closeFrame:!0}),this.Vvt();break;default:throw new Error("Unexpected permission value:",n)}},n.Vvt=function(){var t=this;return this.subscribeForPushRemotely().then((function(){return t.updateWidgetVisibilities()}))},n.unsubscrib},n.Lvt=function(t){return this.xvt($.Topics.NOTIFICATION_PERMISSION_STATE,{isQueryTopicSupported:t})},n.Nv},n.onPermissionDialogInteracted=function(){var t=this;return new Promise((function(n){t.kvt.on($.Topics.NOTIFICATION_PERMISSION_STATE}))}))},t.Kvt=function(){var t=Math.floor(Math.min(700,.9*screen.width)),n=Math.floor(Math.min(450,.9*screen.height));return{w:t,h:n,x:Math.floor((screen.width-t)/2),y:Math.floor((screen.height-n)/2)}},n.openPopupOrRedirect=function(){var n=-1!==this.ampdoc.win.location.href.indexOf("?")?"&":"?",i=this.ampdoc.win.location.href+n+t.PERMISSION_POPUP_URL_FRAGMENT,e=-1!==this.ek["permission-dialog-url"].indexOf("?")?"&":"?",r=this.ek["permission-dialog-url"]+e+"return=".concat(encodeURIComponent(i)),o=t.Kvt(),u="height=".concat(o.h,",width=").concat(o.w,",left=").concat(o.x,",top=").concat(o.y),s="".concat(u,",resizable=yes,scrollbars=yes");return function(t,n,i,e){var r,o,u;try{r=t.open(n,i,e)}catch(t){I().error("DOM","Failed to open url on target: ",i,t)}return!r&&("number"!=typeof u&&(u=0),u+"noopener".length>(o=e||"").length||-1===o.indexOf("noopener",u))&&(r=t.open(n,"_top")),r}(this.ampdoc.win,r,"_blank",s)},n._vt=function(){var t=this;this.ampdoc.win.history.replaceState(null,"",this.removePermissionPopupUrlFragmentFromUrl(this.ampdoc.win.location.href)),this.queryNotificationPermission().then((function(n){switch(n){case T:case M:return t.updateWidgetVisibilities();case A:t.Vvt();break;default:throw new Error("Unexpected permission value",n)}}))},n.environmentSupportsWebPus},n.Hvt=function(){return void 0!==this.ampdoc.win.Notification&&void 0!==this.ampdoc.win.navigator.serviceWorker&&void 0!==this.ampdoc.win.PushManager},n.qvt=function(){return"https:"===this.ampdoc.win.location.protocol||"localhost"===this.ampdoc.win.location.hostname||"127.0.0.1"===this.ampdoc.win.location.hostname||w().development||!1},C(t,null,[{key:"PERMISSION_POPUP_URL_FRAGMENT",get:function(){return"amp-web-push-subscribing=yes"}},{key:"AMP_VERSION_INITIAL",ge}}]),t}(),rt={HELPER_FRAME_URL:"helper-iframe-url",PERMISSION_DIALOG_URL:"permission-dialog-url",SERVICE_WORKER_URL:"service-worker-url",SERVICE_WORKER_SCOPE:"service-worker-scope"},ot=function(t){i(e,t);var n=u(e}var r=e.prototype;return r.validate=function(){this.zvt(),this.Bvt();var t,n,i={"helper-iframe-url":null,"permission-dialog-url":null,"service-worker-url":null,"service-worker-scope":null};for(var e in rt){var r=rt[e];t=this.element.getAttribute(r)||"service-worker-scope"===r,n="The ".concat(r," attribute is required for <").concat(k,">"),void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,R().assert(t,n,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined),i[r]=this.element.getAttribute(r)}if(!this.Qvt(i["helper-iframe-url"]))throw R().createError("<".concat(k,"> must have a valid ")+"helper-iframe-url attribute. It should begin with the https:// protocol and point to the provided lightweight template page provided for AMP messaging.");if(!this.Qvt(i["permission-dialog-url"]))throw R().createError("<".concat(k,"> must have a valid ")+"permission-dialog-url attribute. It should begin with the https:// protocol and point to the provided template page for showing the permission prompt.");if("https:"!==Z(i["service-worker-url"]).protocol)throw R().createError("<".concat(k,"> must have a valid ")+"service-worker-url attribute. It should begin with the https:// protocol and point to the service worker JavaScript file to be installed.");if(Z(i["service-worker-url"]).origin!==Z(i["permission-dialog-url"]).origin||Z(i["permission-dialog-url"]).origin!==Z(i["helper-iframe-url"]).origin)throw R().createError("<".concat(k,"> URL attributes ")+"service-worker-url, permission-dialog-url, and helper-iframe-url must all share the same origin.")},r.parseConfig=function(){var t={};for(var n in rt){var i=rt[n];t[i]=this.element.getAttribute(i)}return t},r.buildCallback=function(){this.validate();var t=this.parseConfig();it(this.element).then})),this.registerAction("subscribe",this.Yvt.bind(this)),this.registerAction("unsubscribe",this.Jvt.bind(this))},r.zvt=function(){if(this.element.getAttribute("id")!==P)throw R().createError("<".concat(k,"> must have an id ")+"attribute with value '"+P+"'.")},r.Bvt=function(){if(this.getAmpDoc().getRootNode().querySelectorAll("#".concat(h(k))).length>1)throw R().createError("Only one <".concat(k,"> element may exist on a page."))},r.Yvt=function(t){var n=this,i=t.event.target;this.Zvt(i,!0),it(this.element).then((function(t){t.subscribe((function(){n.Zvt(i,!1)})).then((function(){n.Zvt(i,!1)}))}))},r.Zv},r.Jvt=function(t){var n=this,i=t.event.target;this.Zvt(i,!0),it(this.element).then((function(t){t.unsubscribe().then}))}))},r.Qvt=function(t){try{var n=Z(t),i=n.pathname.length>1;return"https:"===n.protocol&&i}catch(t){return!1}},e}(t.BaseElement);t.registerServiceForDoc(_,et),t.registerElement(k,ot),t.registerElement(x,F,X)}();
/*! https://mths.be/cssescape v1.5.1 by @mathias | MIT license */}});
//# sourceMappingURL=amp-web-push-0.1.js.map