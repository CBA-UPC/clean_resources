import{delegate as i,forceRepaintSVG as o,lockScroll as t,objDataset as u,resolve}from"./croco.js";import{getLocalData as l,mediaQuery as h,POPIN_REFIT_TYPES as m}from"./config.js";import{loader as p}from"./loader.js";import{tplPopin as $,tplHeader as v,tplAlert as g,tplAlertFooter as L}from"../templates/popin.tpl.js";import{render as C}from"../vendors/lit-html/lit-html.js";import{PopinContentView as P,POPIN_VIEW_DATASET as k,POPIN_VIEW_ID_DATASET as S}from"./popin-content.js";import{lazyloader as V}from"../modules/lazyload.js";const T="popin";const j="data-popin-id";const F=".js-popin-wrapper";const q=".js-popin-close";const M="js-ada-loop-start";const O="js-ada-loop-stop";const B="is-hidden";const I="is-active";const A="is-opened";const N="is-loading";const R="popin-with-keyboard";const H="hides-page";const G=m.medium;const K={};const Y=1500;let _={};let D;let J="";export class PopinRefit{constructor(t){const i=document.createElement("div");C($(),i);this.$container=i.querySelector(F);this.isRefitted=true;this.opened=false;this.instanceId=t.instanceId;this.$container.setAttribute(j,this.instanceId);this.$adaStart=this.$container.querySelector("."+M);this.$adaStop=this.$container.querySelector("."+O);this.$loader=this.$container.querySelector(".js-popin-loader");this.$content=this.$container.querySelector(".js-popin-content");this.$footer=this.$container.querySelector(".js-popin-footer");this.$header=this.$container.querySelector(".js-popin-header");this.contentViews=[];this.onMouseEnter=this.onMouseEnter.bind(this);this.onMouseLeave=this.onMouseLeave.bind(this);if(J===""){l("wordings.ada.POPIN.CLOSE_GENERIC").then(}this.setParams(t);this.insertPopinInPage();p.setContainer(this.$loader)}setParams({adaClose:t="",type=G,options=K,classname:i="",animation=""}){this.$adaClose=this.$container.querySelector(q+" .visually-hidden");if(t!==""){this.$adaClose.innerHTML=t}this.timer=null;this.type=type;this.options=options;this.classname=i;this.animation=animation;this.setCloseOnLeave();this.toggleCloseButton(options.isNotClosable)}setCloseOnLeave(){clearTimeout(this.leaveTimer);const t=this.$content.closest(".js-popin");if(t){if(this.options.closeOnLeave){t.addEventListener("mouseenter",this.onMouseEnter);t.addEventListener("mouseleave",this.onMouseLeave)}else{t.removeEventListener("mouseenter",this.onMouseEnter);t.removeEventListener("mouseleave",this.onMouseLeave)}}}nMouseLeave(){clearTimeout(this.leaveTimer);this.leaveTimer=setTimeout(this.close.bind(this),Y)}getPopinClass({type=G,options=K,animation="",classname:t=""}){let i=["js-popin-wrapper","popin-wrapper","popin-refit",t,type,animation];[I,A,B].forEach(c=>{this.$container.classList.contains(c)&&i.push(c)});options.isNotClosable&&i.push("popin--not-closable");options.noPadding&&i.push("popin--no-padding");options.noBackButton&&i.push("popin--no-back-button");if(options.hasKeyboard){i.push(R);h.mobileAndTablet.matches&&i.push(H)}return i.join(" ")}insertPopinInPage(){document.querySelector(".js-popin-container").appendChild(this.$container);this.$container.className=this.getPopinClass({type:this.type,options:this.options,classname:this.classname,animation:this.animation});this.$adaStart.addEventListener("focus",this.onFocusAda.bind(this));this.$adaStop.addEventListener("focus",this.onFocusAda.bind(this));u(this.$container,T,this)}addContentView(t){t.popin=this;if(this.contentViews.indexOf(t)===-1){this.contentViews.push(t);this.$content.appendChild(t.$viewContent)}}setLoading(t){if(t){this.$container.classList.add(N);p.begin(this.$loader)}else{this.$container.classList.remove(N);p.done(this.$loader)}}async open(){clearTimeout(this.timer);clearTimeout(this.leaveTimer);this.$container.classList.remove(B);if(!this.opened||this.background){requestAnimationFrame(()=>{if(h.mobileAndTablet.matches&&this.type!==m.alert){this.previousScrollPosition=window.scrollY;window.scrollTo(0,0);document.documentElement.classList.add("popin-hides-page")}else{t.lock()}this.$container.classList.add(A);this.$container.classList.add(I)})}this.opened=true;this.background=false}toggleCloseButton(t){if(t){this.$container.removeEventListener("pointerdown",this.onOverlayClick.bind(this))}else{i(this.$container,q,"click",this.close.bind(this));this.$container.addEventListener("pointerdown",this.onOverlayClick.bind(this))}}async showContentView(t,i,o){let l=false;if(!t){t=this.contentViews[this.contentViews.length-1];l=true}if(t){await this.displayHeader({title:" "});this.displayFooter();await t.refreshContents(i,o);this.$container.className=this.getPopinClass(t.params);this.displayHeader(t);this.displayFooter(t);this.setParams(t.params);for(let view of this.contentViews){view!==t&&view.$viewContent.classList.add(B)}t.$viewContent.classList.remove(B);t.openCallback(this,t,l);V.update()}}async updateContentView(t){const i=this.contentViews[this.contentViews.length-1];if(i){await i.refreshContents(true,t);this.displayHeader(i);this.displayFooter(i)}}displayHeader(t={}){t.closeLabel=J;t.back=this.contentViews.length>1?this.back.bind(this):null;C(v(t),this.$header);o(this.$header)}displayFooter(t){if(t&&t.$viewFooter){this.$footer.replaceChildren(t.$viewFooter);o(this.$footer);this.$footer.classList.remove(B)}else{this.$footer.classList.add(B)}}sendToBackground(){this.background=true;this.$container.classList.remove(I)}close(i){let opened=this.opened;clearTimeout(this.timer);clearTimeout(this.leaveTimer);this.setLoading(false);this.$container.classList.remove(A,I);this.opened=false;this.timer=setTimeout(400);t.unlock();document.documentElement.classList.remove("popin-hides-page");if(this.previousScrollPosition){window.scrollTo(0,this.previousScrollPosition);this.previousScrollPosition=null}if(opened){for(let t=this.contentViews.length-1;t>=0;t--){const view=this.contentViews[t];view.closeCallback({callbackOption:i,popin:this,contentView:view});view.$viewContent.classList.add(B)}if(this.contentViews[0].$btnSource){this.contentViews[0].$btnSource.focus()}}this.contentViews=[];if(this.previousForegroundPopin&&this.previousForegroundPopin.opened){this.previousForegroundPopin.open()}}back(t){if(this.contentViews.length>1){const i=this.contentViews.pop();i.$viewContent.classList.add(B);this.showContentView();i.closeCallback({callbackOption:t,popin:this,contentView:i,isBackPanel:true});if(i.$btnSource){i.$btnSource.focus()}i.popin=null}}onOverlayClick(e){if(e.target===e.currentTarget){const t=e=>{if(e.target===e.currentTarget){this.close()}this.$container.removeEventListener("pointerup",t,false)};this.$container.addEventListener("pointerup",t,false)}}onFocusAda(e){if(e.target.classList.contains(M)){this.$lastButton.focus()}if(e.target.classList.contains(O)){this.$firstButton.focus()}}}export const getPopinByInstanceId=export const openPopin=(options={})=>{const i=options.instanceId;let t;let o;if(i){const l=resolve("options.noStack",options);if(_[i]){o=_[i]}else if(!D||l){o=new PopinRefit(options)}else{o=D}const h=o.$content.querySelector(`.js-popin-view-content[${S}=${i}]`);h&&(t=u(h,k));if(t){t.setParams(options);t.$viewContent.classList.remove(B)}else{t=new P(options)}o.addContentView(t);o.showContentView(t,options.forceReload,options.forceRender);if(l&&o.type!==m.alert){for(let t in _){if(t!==i){const p=_[t];if(p.opened||!p.background){p.sendToBackground();o.previousForegroundPopin=p}}}}if(!o.opened){o.open()}_[i]=o;if(!l){D=o}}return{popin:o,contentView:t}};export const openAlert=({title,icon,text,buttons=[],...options}={})=>{return openPopin({type:m.alert,options:{noStack:true,noPadding:true,isNotClosable:true},loadContents:t=>({title:title,icon:icon,contents:g(text),footer:L(buttons,t),footerClass:"flex flex--centered flex-mt--col"}),...options})};