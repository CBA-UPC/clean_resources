/*! For license information please see pmuser.min.js.LICENSE.txt */
!self,(()=>(()=>{"use strict";var e={d:o:r:,t={};d(t,{default:);const h=function(){function e(t){var r=t.identitySource,n=t.disableCache,o=t.apiOriginUsun,a=t.apiOriginArc,i=t.fallBackRt;!this,e),u(this,"identitySource",void 0),u(this,"disableCache",void 0),u(this,"apiOriginUsun",void 0),u(this,"apiOriginArc",void 0),u(this,"fallBackRt",void 0),this.identitySource=r,this.disableCache="boolean"!=typeof n||n,this.apiOriginUsun=o||"http://services.regdes.elpais.com",this.apiOriginArc=a||"https://publicapi.elpais.com",this.fallBackRt="boolean"!=typeof i||i,this.validate()}var t,r,n,i,l,h,f,p,g,d,y,v,b;return t=e,r=[{key:"validate",value:function(){var e=!1;if(["arc","usun"].includes(this.identitySource)&&(e=!0),"boolean"==typeof this.disableCache&&(e=!0),this.apiOriginUsun.match(/^(http|https):\/\/[^ "]+$/)&&(e=!0),this.apiOriginArc.match(/^(http|https):\/\/[^ "]+$/)&&(e=!0),"boolean"==typeof this.fallBackRt&&(e=!0),!e)throw new Error("Invalid configuration")}},{key:"isLoggedIn",value:(b=s(a().mark((function e(){var t,r,n,o=arguments;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=(o.length>0&&void 0!==o[0]?o[0]:{}).disableCache,e.prev=1,"boolean"==typeof(r="boolean"!=typeof t?this.disableCache:t)){e.next=5;break}throw new Error("Invalid configuration");case 5:if(!0!==r){e.next=11;break}return e.next=8,this.isUserLoggedInRealTime();case 8:n=e.sent,e.next=12;break;case 11:n=this.isUserLoggedInLocal();case 12:if(2!==n){e.next=14;break}return e.abrupt("return",!1);case 14:return e.abrupt("return",!0);case 17:throw e.prev=17,e.t0=e.catch(1),console.log(e.t0),new Error("Not implemented");case 21:case"end":return e.stop()}}),e,this,[[1,17]])}))),function(){return b.apply(this,arguments)})},{key:"isSubscriber",value:(v=s(a().mark((function e(){var t,r,n,o,i,s,c=arguments;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=(t=c.length>0&&void 0!==c[0]?c[0]:{}).disableCache,n=t.apiOriginArc,e.prev=1,"boolean"==typeof(o="boolean"!=typeof r?this.disableCache:r)){e.next=5;break}throw new Error("Invalid configuration");case 5:if(s=1,!1!==o){e.next=14;break}return e.next=9,this._getUserInfoLocal();case 9:i=e.sent,console.log("isSubscriber: respuesta de _getUserInfoLocal: ----\x3e",i),0===JSON.parse(i).code&&(s=0),e.next=19;break;case 14:return e.next=16,this.getSkusAndEntitlements({disableCache:r,apiOriginArc:n});case 16:((i=e.sent).skus.length>0||i.entitlements.length>0)&&(s=0),console.log("isSuscriber: respuesta de getSkusAndEntitlements: ----\x3e",i);case 19:if(0!==s){e.next=21;break}return e.abrupt("return",!0);case 21:return e.abrupt("return",!1);case 24:throw e.prev=24,e.t0=e.catch(1),console.log(e.t0),new Error("Not implemented");case 28:case"end":return e.stop()}}),e,this,[[1,24]])}))),function(){return v.apply(this,arguments)})},{key:"getSessionType",value:(y=s(a().mark((function e(){var t,r,n,o,i,s,c,u=arguments;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=(t=u.length>0&&void 0!==u[0]?u[0]:{}).disableCache,n=t.apiOriginArc,e.prev=1,"boolean"==typeof(o="boolean"!=typeof r?this.disableCache:r)){e.next=5;break}throw new Error("Invalid configuration");case 5:if(!1!==o){e.next=13;break}return e.next=8,this._getUserInfoLocal();case 8:i=e.sent,console.log("getUserType: respuesta de _getUserInfoLocal: ----\x3e",i),0===JSON.parse(i).code?s="SUBSCRIBER":1===JSON.parse(i).code?s="REGISTERED":2===JSON.parse(i).code&&(s="ANONYMOUS"),e.next=37;break;case 13:return e.next=15,this.isUserLoggedInRealTime();case 15:if(c=e.sent,console.log("getSessionType: respuesta de isUserLoggedInRealTime: ----\x3e",c),"arc"!==this.identitySource){e.next=29;break}if(1!==c){e.next=26;break}return e.next=21,this.getSkusAndEntitlements({disableCache:r,apiOriginArc:n});case 21:i=e.sent,console.log("getSessionType: respuesta de getSkusAndEntitlements: ----\x3e",i),s=i.skus.length>0||i.entitlements.length>0?"SUBSCRIBER":"REGISTERED",e.next=27;break;case 26:s="ANONYMOUS";case 27:e.next=37;break;case 29:e.t0=c,e.next=0===e.t0?32:1===e.t0?34:36;break;case 32:return s="SUBSCRIBER",e.abrupt("break",37);case 34:return s="REGISTERED",e.abrupt("break",37);case 36:s="ANONYMOUS";case 37:return e.abrupt("return",s);case 40:throw e.prev=40,e.t1=e.catch(1),console.log(e.t1),new Error("Not implemented");case 44:case"end":return e.stop()}}),e,this,[[1,40]])}))),function(){return y.apply(this,arguments)})},{key:"getSkusAndEntitlements",value:(d=s(a().mark((function e(){var t,r,n,o,i,s=arguments;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=(t=s.length>0&&void 0!==s[0]?s[0]:{}).disableCache,n=t.apiOriginArc,e.prev=1,"boolean"==typeof("boolean"!=typeof r?this.disableCache:r)){e.next=5;break}throw new Error("Invalid configuration");case 5:if(!n||n.match(/^(http|https):\/\/[^ "]+$/)){e.next=7;break}throw new Error("Invalid configuration");case 7:return e.next=9,this.getSkus({disableCache:r,apiOriginArc:n});case 9:return o=e.sent,console.log("getSkusAndEntitlements: respuesta de getSkus: ----\x3e",o),e.next=13,this.getEntitlements({disableCache:r,apiOriginArc:n});case 13:return i=e.sent,console.log("getSkusAndEntitlements: respuesta de getEntitlements: ----\x3e",i),e.abrupt("return",{skus:o,entitlements:i});case 18:throw e.prev=18,e.t0=e.catch(1),console.log(e.t0),new Error("Not implemented");case 22:case"end":return e.stop()}}),e,this,[[1,18]])}))),function(){return d.apply(this,arguments)})},{key:"getSkus",value:(g=s(a().mark((function e(){var t,r,n,o,i,s,c,u,l=arguments;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=(t=l.length>0&&void 0!==l[0]?l[0]:{}).disableCache,n=t.apiOriginArc,e.prev=1,"boolean"==typeof(o="boolean"!=typeof r?this.disableCache:r)){e.next=5;break}throw new Error("Invalid configuration");case 5:if(!n||n.match(/^(http|https):\/\/[^ "]+$/)){e.next=7;break}throw new Error("Invalid configuration");case 7:if(s=[],c=[],!1!==o){e.next=17;break}return e.next=12,this._getUserInfoLocal();case 12:i=e.sent,console.log("getSkus: respuesta de _getUserInfoLocal: ----\x3e",i),0===JSON.parse(i).code&&(c=JSON.parse(i).data.skus),e.next=21;break;case 17:return e.next=19,this._getUserInfo("arcSkus",n);case 19:if(s=e.sent,Array.isArray(s.skus))for(u=0;u<s.skus.length;u++)c[u]=s.skus[u].sku;case 21:return e.abrupt("return",c);case 24:throw e.prev=24,e.t0=e.catch(1),console.log(e.t0),new Error("Not implemented");case 28:case"end":return e.stop()}}),e,this,[[1,24]])}))),function(){return g.apply(this,arguments)})},{key:"getEntitlements",value:(p=s(a().mark((function e(){var t,r,n,o,i,s,c,u,l=arguments;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=(t=l.length>0&&void 0!==l[0]?l[0]:{}).disableCache,n=t.apiOriginArc,e.prev=1,"boolean"==typeof(o="boolean"!=typeof r?this.disableCache:r)){e.next=5;break}throw new Error("Invalid configuration");case 5:if(!n||n.match(/^(http|https):\/\/[^ "]+$/)){e.next=7;break}throw new Error("Invalid configuration");case 7:if(s=[],c=[],!1!==o){e.next=17;break}return e.next=12,this._getUserInfoLocal();case 12:i=e.sent,console.log("getEntitlements: respuesta de _getUserInfoLocal: ----\x3e",i),0===JSON.parse(i).code&&(c=JSON.parse(i).data.entitlements),e.next=21;break;case 17:return e.next=19,this._getUserInfo("arcEnts",n);case 19:if(s=e.sent,Array.isArray(s.zones))for(u=0;u<s.zones.length;u++)c[u]=s.zones[u];case 21:return e.abrupt("return",c);case 24:throw e.prev=24,e.t0=e.catch(1),console.log(e.t0),new Error("Not implemented");case 28:case"end":return e.stop()}}),e,this,[[1,24]])}))),function(){return p.apply(this,arguments)})},{key:"isUserLoggedInLocal",value:function(){try{var e,t,r,n,o=2;return"arc"===this.identitySource?this._checkInfoLocal()&&(e=localStorage.getItem("ArcId.USER_INFO"),t=JSON.parse(e).accessToken,r=JSON.parse(e).refreshToken,t&&r&&this._checkAccessToken(r)&&(o=1)):(n=this._getCookieByName("uid_ns"))&&n.split("#").filter((function(e){return""!==e.trim()})).length>1&&(o=1),o}catch(e){throw console.log(e),new Error("Not implemented")}}},{key:"isUserLoggedInRealTime",value:(f=s(a().mark((function e(){var t,r,n,o,i,s,c,u;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,t=2,e.t0=this.identitySource,e.next="arc"===e.t0?5:22;break;case 5:if(!0!==this._checkInfoLocal()){e.next=21;break}if(r=localStorage.getItem("ArcId.USER_INFO"),n=JSON.parse(r).accessToken,o=JSON.parse(r).refreshToken,!n||!o){e.next=21;break}if(s=this._checkAccessToken(n),!(c=this._checkAccessToken(o))||!s){e.next=17;break}t=1,e.next=21;break;case 17:if(!c||s){e.next=21;break}return e.next=20,this._getAccessToken();case 20:t=1;case 21:return e.abrupt("break",31);case 22:if(!((i=this._getCookieByName("uid_ns"))&&i.split("#").filter((function(e){return""!==e.trim()})).length>1)){e.next=30;break}return u=JSON.stringify({uid_ns:i}),e.next=27,this._APIrequest("usun","","POST",u);case 27:t=e.sent,e.next=31;break;case 30:t=1;case 31:return e.abrupt("return",t);case 34:throw e.prev=34,e.t1=e.catch(0),console.log(e.t1),new Error("Not implemented");case 38:case"end":return e.stop()}}),e,this,[[0,34]])}))),function(){return f.apply(this,arguments)})},{key:"getUserDataUID",value:function(){try{var e,t,r,n,o,a=this._getCookieByName("uid_ns");if(a&&a.split("#").filter(().length>1){if((t=a.split("#"))[3]){for(var i=[],s=t[3].match(/:[^|]+|[^:]+/g),c=0;c<s.length;c+=2)i[s[c].substring(1)]=s[c+1].substring(1);r=i.NOM?this._base64ToUtf8(i.NOM):"",n=i.AP1?this._base64ToUtf8(i.AP1):"",o=i.NB?this._base64ToUtf8(i.NB):""}e=JSON.stringify({uid:t[0],nickname:t[1],nombre:r,apellido1:n,nombre_bonito:o})}else e=JSON.stringify({uid:a});return e}catch(e){throw console.log(e),new Error("Not implemented")}}},{key:"_base64ToUtf8",value:function(e){for(var t=atob(e),r=new Uint8Array(t.length),n=0;n<t.length;n++)r[n]=t.charCodeAt(n);return new TextDecoder("utf-8").decode(r)}},{key:"_getUserInfo",value:(h=s(a().mark((function e(t){var r,n,o,i,s,c,u,l=arguments;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=l.length>1&&void 0!==l[1]?l[1]:null,e.prev=1,!1!==this._checkInfoLocal()){e.next=11;break}return e.next=6,this._APIrequest(t,"","GET",null,null,r);case 6:return n=e.sent,e.next=9,n.json();case 9:return o=e.sent,e.abrupt("return",o);case 11:return i=localStorage.getItem("ArcId.USER_INFO"),s=JSON.parse(i),c=s.accessToken,console.log("_getUserInfo: pedir ".concat(t," con el token ----\x3e "),c),e.next=16,this._APIrequest(t,"","GET",null,c,r);case 16:if(401!==(n=e.sent).status){e.next=27;break}return e.next=20,this._getAccessToken();case 20:if(200!==e.sent.status){e.next=27;break}return i=localStorage.getItem("ArcId.USER_INFO"),c=JSON.parse(i).accessToken,e.next=26,this._APIrequest(t,"","GET",null,c,r);case 26:n=e.sent;case 27:return e.next=29,n.json();case 29:return u=e.sent,e.abrupt("return",u);case 33:throw e.prev=33,e.t0=e.catch(1),console.log(e.t0),new Error("Not implemented");case 37:case"end":return e.stop()}}),e,this,[[1,33]])}))),},{key:"_checkInfoLocal",value:function(){try{var e,t,r=localStorage.getItem("ArcId.USER_INFO");return!!(r&&(e=JSON.parse(r).accessToken,t=JSON.parse(r).refreshToken,e&&t&&this._checkAccessToken(t)))}catch(e){throw console.log(e),new Error("Not implemented")}}},{key:"_getUserInfoLocal",value:(l=s(a().mark((function e(){var t,r,n,o,i,s,c,u,l,h,f,p;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,c=[],u=[],l=[],!0!==this._checkInfoLocal()){e.next=18;break}if(t=localStorage.getItem("ArcId.USER_INFO"),i=JSON.parse(t).uuid,n=localStorage.getItem("ArcP"),console.log("ArcP:",n),n&&i?(o=JSON.parse(n),r=1,c=null!==(h=o[i])&&void 0!==h&&h.sub?o[i].sub.p:[],console.log("skus en ArcP:",c),c.length>0&&(r=0),u=null!==(f=o[i])&&void 0!==f&&f.ent?o[i].ent.e:[],console.log("entitls en ArcP:",u),u.length>0&&(r=0),l=1===r?null:{skus:c,entitlements:u}):(r=1,s="Usuario no tiene SKUs",l=null),!this.fallBackRt||1!==r){e.next=16;break}return e.next=14,this.getSkusAndEntitlements();case 14:((p=e.sent).skus.length>0||p.entitlements.length>0)&&(l={skus:p.skus,entitlements:p.entitlements},r=0);case 16:e.next=21;break;case 18:r=2,s="Usuario no está logado",l=null;case 21:return e.abrupt("return",JSON.stringify({code:r,msg:s,data:l}));case 24:throw e.prev=24,e.t0=e.catch(0),console.log(e.t0),new Error("Not implemented");case 28:case"end":return e.stop()}}),e,this,[[0,24]])}))),function(){return l.apply(this,arguments)})},{key:"_checkAccessToken",value:function(e){try{var t=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/");return 1e3*JSON.parse(window.atob(t)).exp>=Date.now()}catch(e){throw console.log(e),new Error("Not implemented")}}},{key:"_getAccessToken",value:(i=s(a().mark((function e(){var t,r,n,o,i,s;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=localStorage.getItem("ArcId.USER_INFO"),r=JSON.parse(t),n=r.refreshToken,i=JSON.stringify({token:n,grantType:"refresh-token"}),e.next=6,this._APIrequest("token","","POST",i);case 6:if(200!==(s=e.sent).status){e.next=13;break}return e.next=10,s.json();case 10:o=e.sent,console.log(o.accessToken),localStorage.setItem("ArcId.USER_INFO",JSON.stringify(o));case 13:return e.abrupt("return",s);case 16:throw e.prev=16,e.t0=e.catch(0),console.log(e.t0),new Error("Not implemented");case 20:case"end":return e.stop()}}),e,this,[[0,16]])}))))},{key:"_getCookieByName",value:function(e){var t=document.cookie.match(new RegExp("(^| )".concat(e,"=([^;]+)")));return t?t[2]:void 0}},{key:"_APIrequest",value:(n=s(a().mark((function e(t,r,n){var i,s,c,u,l,h,f,p,g,d=arguments;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=d.length>3&&void 0!==d[3]?d[3]:{},s=d.length>4&&void 0!==d[4]?d[4]:null,c=d.length>5&&void 0!==d[5]?d[5]:null,u={usun:"/pmuser.html",arcSkus:"/sales/public/v1/entitlements",arcEnts:"/sales/public/v2/subscriptions/entitlements",token:"/identity/public/v1/auth/token"},l="usun"===t?this.apiOriginUsun:null!==c?c:this.apiOriginArc,h=l+u[t]+(r&&"/".concat(r)||""),console.log("url:".concat(h)),{},f=null!==s?{"Content-Type":"application/json",Authorization:"Bearer ".concat(s)}:{"Content-Type":"application/json"},p={mode:"cors",cache:"no-cache",credentials:"same-origin",headers:f,redirect:"follow",referrerPolicy:"no-referrer"},e.prev=10,e.next=13,fetch(h,o(o({},p),{},{method:n,body:i}));case 13:return g=e.sent,e.abrupt("return",g);case 17:throw e.prev=17,e.t0=e.catch(10),console.error("ERROR:".concat(e.t0)),e.t0;case 21:case"end":return e.stop()}}),e,this,[[10,17]])}))))}],r&&c(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();return t})()));