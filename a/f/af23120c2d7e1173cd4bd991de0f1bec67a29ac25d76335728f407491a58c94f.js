import{debounced as t,debug,forceRepaintSVG as o,getTypedDataset as l,objDataset as h,throttled as i,resolve}from"../base/croco.js";import{LOGGERS as p,mediaQuery as u}from"../base/config.js";import{AbstractVideo as m}from"./abstract-video.js";const g=p.VIDEO;const $=u.mobileOnly.matches?4:7;const v=75;const C=5;const S="staticvideo";const F=new IntersectionObserver(entries=>{for(let t=0,i=entries.length;t<i;t++){const o=entries[t];const l=h(o.target,S);l.onObserveIntersection(o.intersectionRatio)}},{rootMargin:"0px 0px 0px 0px",threshold:.01});let index=0;export class StaticVideo extends m{constructor(t){super();this.$wrapper=t;this.$video=this.$wrapper.querySelector(".js-static-video");this.$controls=this.$wrapper.querySelector(".js-video-controls");this.$playPause=this.$wrapper.querySelector(".js-video-play-pause");this.$shoppable=this.$wrapper.querySelector(".js-video-shoppable");this.$cartridge=this.$wrapper.querySelector(".js-cartridge");this.$poster=this.$wrapper.querySelector(".js-video-poster");this.hideDuration=3e3;this.timeoutHide=null;this.hasSource=false;this.pausedByClick=false;this.shoppables=[];this.hasRendered=false;this.controlsVisible=false;const i=l(this.$wrapper);this.options={type:i.type||"video/mp4",background:i.background,shoppables:i.shoppables,autoplay:this.$video.autoplay,autoplaySound:i.autoplaySound};if(!this.options.autoplay){this.$video.removeAttribute("autoplay")}this.bindEvents();h(this.$wrapper,S,this);F.observe(this.$wrapper)}getVideo(){return this.$video}firstRender(){this.options.shoppables&&[...this.options.shoppables].forEach(item=>{item.index=index;index++});this.$shoppable&&this.onResize();this.render();this.$cartridge&&o(this.$cartridge)}async render(){const{render:t}=await import("../vendors/lit-html/lit-html.js");const{tplControls:i}=await import("../templates/static-video.tpl.js");t(i({isBackground:this.options.background,isAutoplay:this.options.autoplay,isAutoplaySound:this.options.autoplaySound,onPlayClick:this.togglePlay.bind(this),onMuteClick:this.toggleMute.bind(this),onFullscreenClick:this.toggleFullscreen.bind(this),showFullScreenBtn:!this.options.shoppables}),this.$controls);if(!this.hasRendered){this.$playPause&&this.$playPause.addEventListener("click",this.togglePlay.bind(this));o(this.$controls);this.hasRendered=true}this.renderTimeline();this.renderShoppables()}async renderShoppables(){if(this.options.shoppables){const{render:t}=await import("../vendors/lit-html/lit-html.js");const{tplShoppable:i}=await import("../templates/shoppable-video.tpl.js");const currentTime=this.getCurrentTime();const o=this.getDuration();const l=[...this.shoppables];this.shoppables=[...this.options.shoppables].sort((a,b)=>a.startTime-b.startTime).filter(({startTime,endTime})=>currentTime>=startTime&&currentTime<=(endTime+1||o)).map(item=>({...item,className:currentTime>=(item.endTime||o-1)?"is-removing":""}));this.shoppables.splice(0,this.shoppables.length-$-1);const h=this.shoppables.filter(a=>!l.map(a=>a.index).includes(a.index));h.forEach(({index})=>{const current=this.options.shoppables.find(a=>a.index===index);this.options.shoppables[this.options.shoppables.indexOf(current)].displayed=true});t(i({shoppables:this.shoppables,onExpandClick:this.expandShoppableItem.bind(this)}),this.$shoppable)}}async renderTimeline(){const{render:t}=await import("../vendors/lit-html/lit-html.js");const{tplTimeline:i}=await import("../templates/static-video.tpl.js");const o=this.$controls.querySelector(".js-video-timeline");o&&t(i(this.getTimeFormatted(this.getCurrentTime(true)),this.getTimeFormatted(this.getDuration(true)),this.getCurrentTime()/this.getDuration(),this.gotoTime.bind(this)),o)}displayCartridge(){if(!this.cartridgeInitialized&&this.$cartridge){this.$cartridge.classList.remove("is-hidden");this.cartridgeInitialized=true;setTimeout(()=>{this.$cartridge.classList.add("opacity0")},2500)}}updateTimeline(){!this.options.background&&this.controlsVisible&&this.renderTimeline()}updateFullscreen(t){this.$wrapper.classList[t?"remove":"add"]("is-fullscreen")}getFullscreenElement(){return document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement||null}getTimeFormatted(time=0){const t=Math.floor(time/3600);const i=time-t*3600;const o=Math.floor(i/60);const l=i-o*60;const h=n=>`0${n}`.slice(-2);return`${this.getDuration()>=3600?`${t}:${h(o)}`:o}:${h(l)}`}setSource(){const[t,i]=resolve(["srcDesktop","srcMobile"],this.$wrapper.dataset);const o=i&&u.mobileOnly.matches?i:t;if(o&&!this.hasSource){let source=document.createElement("source");source.setAttribute("src",o);source.setAttribute("type",this.options.type);this.$video.load();this.$video.appendChild(source);this.hasSource=true;this.$wrapper.classList.add("is-loading")}}togglePlay(e){if(e.target?.classList.contains("static-video-btn")){e.preventDefault();e.stopPropagation()}this.showControls();super.togglePlay();this.pausedByClick=this.$video.paused}toggleMute(e){e.preventDefault();e.stopPropagation();this.showControls();super.toggleMute()}toggleFullscreen(e){e.preventDefault();const t=this.getFullscreenElement();if(t!==this.$wrapper&&t!==this.$video){if(this.$wrapper.requestFullscreen){if(u.desktopOnly.matches){this.$wrapper.requestFullscreen()}else{this.$video.requestFullscreen({navigationUI:"hide"})}}else if(this.$wrapper.mozRequestFullScreen){this.$video.mozRequestFullScreen()}else if(this.$wrapper.webkitRequestFullscreen){this.$video.webkitRequestFullscreen()}else if(this.$wrapper.msRequestFullscreen){this.$wrapper.msRequestFullscreen()}else if(this.$video.webkitEnterFullScreen){this.$video.webkitEnterFullScreen()}}else{if(document.exitFullscreen){document.exitFullscreen()}else if(document.msExitFullscreen){document.msExitFullscreen()}}}gotoTime(event){const rect=event.currentTarget.getBoundingClientRect();this.$video.currentTime=(event.clientX-rect.left)*this.getDuration()/rect.width;this.render()}showControls(){this.controlsVisible=true;this.$wrapper.classList.add("show-controls");this.bindHideDuration()}hideControls(){this.controlsVisible=false;this.$wrapper.classList.remove("show-controls")}expandShoppableItem(e){e.preventDefault();e.stopPropagation();const t=e.target.closest(".shoppable-item-wrapper");const i=t.classList.contains("is-expanded");if(e.type==="mouseover"&&i){return false}t.classList.toggle("is-expanded");this.$video[i&&!this.pausedByClick?"play":"pause"]();o(t)}bindHideDuration(){clearTimeout(this.timeoutHide);this.timeoutHide=setTimeout(()=>{if(!this.$video.paused){this.hideControls()}},this.hideDuration)}onCanPlay(){this.$wrapper.classList.add("is-ready");this.$wrapper.classList.remove("is-loading");if(!this.$wrapper.classList.contains("is-paused")){this.displayCartridge();if(this.options.autoplaySound){this.showControls()}}!this.hasRendered&&this.firstRender()}onPlay(){super.onPlay();if(this.$wrapper.classList.contains("is-ready")){this.displayCartridge();if(this.options.autoplaySound){this.showControls()}}}onPosterClick(e){e.preventDefault();e.stopPropagation();this.play();this.bindCallback("startCallback")}onObserveIntersection(intersectionRatio){if(intersectionRatio>.01){this.setSource();if(this.options.autoplay&&!this.pausedByClick){this.play()}}else{this.pause()}}onResize(){const items=Math.min(Math.floor((this.$video.getBoundingClientRect().height-this.$controls.getBoundingClientRect().height*2+C)/(v+C)),$);const height=items*v+(items-1)*C;this.$shoppable.style.maxHeight=`${height}px`}bindControls(){this.$video.addEventListener("click",this.togglePlay.bind(this),false);this.$wrapper.addEventListener("mousemove",i(300,this.showControls.bind(this)),false);this.$wrapper.addEventListener("mouseleave",this.bindHideDuration.bind(this),false);this.$wrapper.addEventListener("mouseenter",this.showControls.bind(this),false)}bindEvents(){this.$video.addEventListener("canplay",this.onCanPlay.bind(this),false);this.$video.addEventListener("play",this.onPlay.bind(this),false);this.$video.addEventListener("pause",this.onPause.bind(this),false);this.$video.addEventListener("ended",this.onEnded.bind(this),false);this.$poster.addEventListener("click",this.onPosterClick.bind(this),false);this.$shoppable&&window.addEventListener("resize",t(200,this.onResize.bind(this)));if(!this.options.background){["fullscreenchange","MSFullscreenChange"].forEach(event=>document.addEventListener(event,()=>this.updateFullscreen(!this.getFullscreenElement())))}this.bindControls()}}export function staticVideoInit(t){const i=t||document.querySelectorAll(".js-static-video-wrapper");if(i.length){[...i].forEach(t=>{let i=h(t,S);if(!i){new StaticVideo(t)}})}else{debug("warn",g,"[static-video]","missing element")}}