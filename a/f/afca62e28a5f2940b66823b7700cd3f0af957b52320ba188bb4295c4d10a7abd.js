/* cyrillic-ext */
@font-face {
  font-family: 'EB Garamond';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/ebgaramond/v27/SlGDmQSNjdsmc35JDF1K5E55YMjF_7DPuGi-6_RkCY9_S6w.woff2) format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
/* cyrillic */
@font-face {
  font-family: 'EB Garamond';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/ebgaramond/v27/SlGDmQSNjdsmc35JDF1K5E55YMjF_7DPuGi-6_RkAI9_S6w.woff2) format('woff2');
  unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
/* greek-ext */
@font-face {
  font-family: 'EB Garamond';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/ebgaramond/v27/SlGDmQSNjdsmc35JDF1K5E55YMjF_7DPuGi-6_RkCI9_S6w.woff2) format('woff2');
  unicode-range: U+1F00-1FFF;
}
/* greek */
@font-face {
  font-family: 'EB Garamond';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/ebgaramond/v27/SlGDmQSNjdsmc35JDF1K5E55YMjF_7DPuGi-6_RkB49_S6w.woff2) format('woff2');
  unicode-range: U+0370-03FF;
}
/* vietnamese */
@font-face {
  font-family: 'EB Garamond';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/ebgaramond/v27/SlGDmQSNjdsmc35JDF1K5E55YMjF_7DPuGi-6_RkC49_S6w.woff2) format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323, U+0329, U+1EA0-1EF9, U+20AB;
}
/* latin-ext */
@font-face {
  font-family: 'EB Garamond';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/ebgaramond/v27/SlGDmQSNjdsmc35JDF1K5E55YMjF_7DPuGi-6_RkCo9_S6w.woff2) format('woff2');
  unicode-range: U+0100-02AF, U+0304, U+0308, U+0329, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: 'EB Garamond';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/ebgaramond/v27/SlGDmQSNjdsmc35JDF1K5E55YMjF_7DPuGi-6_RkBI9_.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
/* cyrillic-ext */
@font-face {
  font-family: 'EB Garamond';
  font-style: normal;
  font-weight: 500;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/ebgaramond/v27/SlGDmQSNjdsmc35JDF1K5E55YMjF_7DPuGi-2fRkCY9_S6w.woff2) format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
/* cyrillic */
@font-face {
  font-family: 'EB Garamond';
  font-style: normal;
  font-weight: 500;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/ebgaramond/v27/SlGDmQSNjdsmc35JDF1K5E55YMjF_7DPuGi-2fRkAI9_S6w.woff2) format('woff2');
  unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
/* greek-ext */
@font-face {
  font-family: 'EB Garamond';
  font-style: normal;
  font-weight: 500;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/ebgaramond/v27/SlGDmQSNjdsmc35JDF1K5E55YMjF_7DPuGi-2fRkCI9_S6w.woff2) format('woff2');
  unicode-range: U+1F00-1FFF;
}
/* greek */
@font-face {
  font-family: 'EB Garamond';
  font-style: normal;
  font-weight: 500;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/ebgaramond/v27/SlGDmQSNjdsmc35JDF1K5E55YMjF_7DPuGi-2fRkB49_S6w.woff2) format('woff2');
  unicode-range: U+0370-03FF;
}
/* vietnamese */
@font-face {
  font-family: 'EB Garamond';
  font-style: normal;
  font-weight: 500;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/ebgaramond/v27/SlGDmQSNjdsmc35JDF1K5E55YMjF_7DPuGi-2fRkC49_S6w.woff2) format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323, U+0329, U+1EA0-1EF9, U+20AB;
}
/* latin-ext */
@font-face {
  font-family: 'EB Garamond';
  font-style: normal;
  font-weight: 500;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/ebgaramond/v27/SlGDmQSNjdsmc35JDF1K5E55YMjF_7DPuGi-2fRkCo9_S6w.woff2) format('woff2');
  unicode-range: U+0100-02AF, U+0304, U+0308, U+0329, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: 'EB Garamond';
  font-style: normal;
  font-weight: 500;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/ebgaramond/v27/SlGDmQSNjdsmc35JDF1K5E55YMjF_7DPuGi-2fRkBI9_.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
IiwiX2NzcmYiOiJ6MkZhSHQ4ZC1QY3ZUSUZpRmpXMElBR1hPdkZKTkwzVUZxNzAiLCJfaW50c3RhdGUiOiJkZXByZWNhdGVkIiwic3RhdGUiOiJoS0ZvMlNBemExSnZaMGg0TlhaUmVVdEVjV1JVYURSSlRWSjZabFp5ZVRFeGRreHVVS0Z1cFd4dloybHVvM1JwWk5rZ1dXOHdUR2haY2taUWFISXhkMlpIUkVoT2FtSnZkRGhRVWtGVmEyUlBaWFNqWTJsazJTQm9OMVkwVFdka2NsZE1ZbkF4YkhreVNYVnZPVGczYWtOeWN6QTFUMEZtVFEifSwid2lkZ2V0VXJsIjoiaHR0cHM6Ly9jZG4uYXV0aDAuY29tL3cyL2F1dGgwLXdpZGdldC01LjIubWluLmpzIiwiaXNUaGlyZFBhcnR5Q2xpZW50IjpmYWxzZSwiYXV0aG9yaXphdGlvblNlcnZlciI6eyJ1cmwiOiJodHRwczovL21uZy1wcm9kLmF1dGgwLmNvbSIsImlzc3VlciI6Imh0dHBzOi8vbW5nLXByb2QuYXV0aDAuY29tLyJ9LCJjb2xvcnMiOnt9fQ=='))));
  //console.log(config);

  if (config.dict && config.dict.signin && config.dict.signin.title) {
  //languageDictionary = { title: config.dict.signin.title };

  languageDictionary = { title: '', signUpTitle: '',  signUpTerms: 'By checking this box and creating an account, I affirm that I am 18 years of age or older. I understand that the information I provide willingly may be used to support my subscription, to offer additional products and services tied specifically to my subscription, and that this information may be shared with a trusted third party.I have read and accept the <a href="https://www.medianewsgroup.com/terms-of-use/">Terms of Service</a> and acknowledge the <a href="https://www.medianewsgroup.com/privacy-policy/">Privacy Policy</a> as stated in the links.' };
} else if (typeof config.dict === 'string') {

  language = config.dict;
}

  //check if we loaded the Auth0AssetManager.
  if(typeof Auth0SettingsManager == 'undefined'){
  console.log("NO Auth0SettingsManager");
  var auth0Settings = defaultAsset;
}else{
  console.log("has Auth0SettingsManager");
  var auth0Settings = Auth0SettingsManager.init(config.callbackURL);
  console.log("auth0Settings", auth0Settings);
}

  config.extraParams = config.extraParams || {};
  var connection = config.connection;
  var prompt = config.prompt;
  var languageDictionary;
  var language;

  var loginHint = config.extraParams.login_hint;
  var colors = config.colors || {};

  var initialScreen = config.extraParams.initialScreen;
  let allowLogin = true;
  // Available Lock configuration options: https://auth0.com/docs/libraries/lock/v11/configuration

  if(config.extraParams && config.extraParams.ampRegiWall == 'true'){
  allowLogin = false;
}
  var lock = new Auth0Lock(config.clientID, config.auth0Domain, {
  initialScreen: initialScreen,
  allowLogin: allowLogin,
  auth: {
  redirectUrl: config.callbackURL,
  responseType: (config.internalOptions || {}).response_type ||
  (config.callbackOnLocationHash ? 'token' : 'code'),
  params: config.internalOptions
},
  /* additional configuration needed for custom domains
  configurationBaseUrl: config.clientConfigurationBaseUrl,
  overrides: {
    __tenant: config.auth0Tenant,
    __token_issuer: 'YOUR_CUSTOM_DOMAIN'
  }, */
  assetsUrl:  config.assetsUrl,
  allowedConnections: connection ? [connection] : ['Username-Password-Authentication','apple','facebook','google-oauth2','Trib-Passthrough','Trib-Main','Trib-Apple', 'Trib-Facebook', 'Trib-Google'],
  rememberLastLogin: !prompt,
  language: language,
  languageDictionary: auth0Settings.languageDictionary,
  showTerms: auth0Settings.showTerms,
  mustAcceptTerms: auth0Settings.mustAcceptTerms,
  allowShowPassword: true,
  theme: {
  logo: auth0Settings.logo,
  primaryColor: auth0Settings.primaryColor,
  authButtons: {
  "Trib-Google": {
  displayName: "Google",
  primaryColor: "white",
  foregroundColor: "black",
  icon: "https://ui-static-assets-prod.s3.us-west-1.amazonaws.com/img/google-icon.svg"
},
  "Trib-Apple": {
  displayName: "Apple",
  primaryColor: "#000",
  foregroundColor: "white",
  icon: "https://upload.wikimedia.org/wikipedia/commons/3/31/Apple_logo_white.svg"
},
  "Trib-Facebook": {
  displayName: "Facebook",
  primaryColor: "#3b5998",
  foregroundColor: "white",
  icon: "https://upload.wikimedia.org/wikipedia/commons/4/4d/F_icon_reversed.svg"
}
}
},
  prefill: null,
  closable: auth0Settings.closable,
  defaultADUsernameFromEmailPrefix: false,
  forgotPasswordLink: setPassResetSource(new URL(config.callbackURL).origin, config.clientID)
});

  var lockPasswordless;

  function configurePasswordless(email){
  if(lockPasswordless) return lockPasswordless;

  lockPasswordless = new Auth0LockPasswordless(config.clientID, config.auth0Domain, {
  auth: {
  redirectUrl: config.callbackURL,
  responseType: (config.internalOptions || {}).response_type ||
  (config.callbackOnLocationHash ? 'token' : 'code'),
  params: {state: 'pswdls'}
},
  allowedConnections: ['email'],
  passwordlessMethod: 'link',
  configurationBaseUrl: config.clientConfigurationBaseUrl,
  // overrides: {
  //     __tenant: config.auth0Tenant,
  //     __token_issuer: config.authorizationServer.issuer
  // },
  prefill: { email: email, username: email },
  assetsUrl:  config.assetsUrl,
  rememberLastLogin: !prompt,
  language: language,
  languageBaseUrl: config.languageBaseUrl,
  languageDictionary: languageDictionary,
  theme: {
  logo: auth0Settings.logo,
  primaryColor: auth0Settings.primaryColor,

},
  closable: false
});
  return lockPasswordless;
}

  function initialDisplay(){

  let button;

  if(document.getElementById('email-submit')){
  button = document.getElementById('email-submit')
  button.style.display = "block";
} else{
  const div = document.createElement("div");
  div.className = "auth0-lock-widget";
  button = document.createElement("button");                 // Create a <li> node
  button.id = "email-submit";
  button.style.cssText = `
            width: 288px;
            background-color: ${auth0Settings.primaryColor};
            color: #fff;
            border: 0;
            padding: 14px;
            display: block;
            box-sizing: border-box;
            width: 100%;
            overflow: hidden;
            border-radius: 0 0 5px 5px;
            transition: 0.2s ease-in-out;
            color: #fff;
            letter-spacing: 1px;
            font-size: 14px;
            text-transform: uppercase;
            `
  const textnode = document.createTextNode("Next");         // Create a text node
  button.appendChild(textnode);                              // Append the text to <li>
  div.appendChild(button);
  const masterDiv = document.getElementById('auth0-lock-container-1').querySelector( '.auth0-lock-center' );
  masterDiv.appendChild(div);

  button.addEventListener('click', function(){
  userSubmit();
});
}

  document.querySelector('button.auth0-lock-submit').style.display = "none";
  document.querySelector('div.auth0-lock-input-show-password').style.display = "none";
  if(document.querySelector('p.auth0-lock-alternative')) document.querySelector('p.auth0-lock-alternative').style.display = "none";

  //disable passwordless UI when user clicks Sign Up, restore when Login is clicked
  function signupHandler(){
  document.querySelector('ul.auth0-lock-tabs').addEventListener('click', function (e){
  if(e.target.innerText === "Sign Up"){
  restoreLockModalToDefault();
} else{
  const loginButtonLoaded = setInterval( () => {
  if ( document.querySelector('.auth0-lock-input-show-password') !== null ) {
  clearInterval( loginButtonLoaded );
  initialDisplay();
}
}, 100 ); // check every 100ms
}

  const reAddEventListener = setInterval( () => {
  if (  document.querySelector('ul.auth0-lock-tabs') ) {
  signupHandler();
  clearInterval(reAddEventListener)
}
}, 100 ); // check every 100ms
});
}
  signupHandler();


  // allow user to press enter key to submit their email
  document.onkeypress = keyPress;
  function keyPress(e){
  var x = e || window.event;
  var key = (x.keyCode || x.which);
  if(key == 13){
  userSubmit();
}
}
}

  function setPassResetSource(origin, clientId){
  // exclude town news clients because they don't have reset pass pages
  const excludeArray = [
  "kvI7O7QjfyQF92AdOl0an0LLznFau00s",
  ];

  if(excludeArray.includes(clientId) ||
  (!origin.includes("www") && !origin.includes("preprod") && !origin.includes("myaccount.") && !origin.includes("checkout.") && !origin.includes("enewspaper."))
  ) {
  return null;
}

  return origin.replace('myaccount.','').replace('checkout.','').replace('enewspaper.') + "/reset-password/?client=" + clientId;
}

  lock.show();

  //using domain referrer to decide if passwordless should be used
  let referrerUrl = new URL(document.referrer)
  let passwordless = false;
  domainCheck = referrerUrl.hostname.replace('https://','').replace('www.','').replace('develop.','').replace('preprod.','').replace('.com','').replace('login','');
  console.log('domainCheck '+ domainCheck);

  if (domainCheck === 'twincities') {
  passwordless = true;

  // we need to wait for the login button to load to then manipulate the styling
  const loginButtonLoaded = setInterval( () => {
  if ( document.querySelector('.auth0-lock-input-show-password') !== null && document.getElementById('1-email') && document.querySelector('.auth0-lock-submit').style.cssText.includes('display: block') ) {
  clearInterval( loginButtonLoaded );
  initialDisplay();
}
}, 100 ); // check every 100ms

} else {
  userSubmit();
}

  closeButton = document.getElementById("undefined-close-button");
  closeButton.addEventListener("click", function () {
  returnPreviousPage();
});

  function getUserEmailFromInput(){
  return document.getElementById('1-email').value;
}

  function userSubmit() {
  //check the users connection and serve up the correct lock modal
  const getUserConnection = new Promise((resolve, reject) => {

  if (!passwordless) {
  resolve(["regular_flow"]);
  return;
}

  const getUsers = async () => {
  // Send a GET request with the authorization header set to
  // the string 'my secret token'
  const userEmail = getUserEmailFromInput();
  console.log('checking this users connection : ', userEmail);

  document.body.style.cursor='wait';

  const axiosConfig = {
  method: "post",
  url:
  "https://ya61e43yz0.execute-api.us-west-1.amazonaws.com/production/auth0/getDefaultUserConnection",
  headers: {
  "x-api-key": "DHL8Vs1UNo9u0WO52dVBzSuLi4kw2so25cXK1fy7"
},
  data: {
  "email": userEmail
}
};

  axios(axiosConfig)
  .then(function (response) {
  if (response.data && response.data.connection === 'Username-Password-Authentication'){
  resolve(['Username-Password-Authentication']);
} else {
  resolve(['email']);
}
})
  .catch(function (error) {
  console.error(error);
  reject('ManagmentAPI failed');
}).finally(() => {
  document.body.style.cursor='default';
});
}
  getUsers();
});

  getUserConnection.then((response) => {

  if (initialScreen === 'signUp') {
  if(passwordless) restoreLockModalToDefault();
  lock.show( { initialScreen } );
}else {
  if (response[0] === 'email') {
  lock.hide();
  showPasswordlessModal(getUserEmailFromInput());
} else {
  if(passwordless) restoreLockModalToDefault();
}
}
}).catch(error => {
  console.error(error);
  if(passwordless)restoreLockModalToDefault();
})
}

  function showPasswordlessModal(email){
  let lockPasswordless = configurePasswordless(email);
  lockPasswordless.show();

  // we need to wait for the login button to load to then manipulate the styling
  const waitForEmailHeadingToChangeText = setInterval( () => {
  if ( document.getElementById('auth0-lock-container-2').querySelector('.auth0-lock-form').querySelector('span') ) {
  clearInterval( waitForEmailHeadingToChangeText );
  let submitText = "Click “submit” to get a magic link sent to the email below, then click on the link to continue reading.";
  const passwordlessDiv = document.getElementById('auth0-lock-container-2');
  passwordlessDiv.querySelector('.auth0-lock-form').querySelector('span').textContent = submitText;
}
}, 100 ); // check every 100ms
}

  function restoreLockModalToDefault(){
  document.querySelector('button.auth0-lock-submit').style.display = "block";
  document.querySelector('div.auth0-lock-input-show-password').style.display = "block";
  document.querySelector('p.auth0-lock-alternative').style.display = "block";
  document.getElementById('email-submit').style.display = "none";
}
  function returnPreviousPage() {
  let previousURL = new URL(config.callbackURL);
  let params = previousURL.searchParams;
  window.location.assign(params.get("auth_redirect"));
}

</script>
<style>
  .auth0-lock.auth0-lock .auth0-lock-social-button[data-provider^=oauth2].auth0-lock-social-big-button:first-child {
  border: 1px solid #dee0e2;
}
  @media only screen and (max-width: 480px) {
  #email-submit {
  position: absolute;
  bottom: 0px;
}

  .auth0-lock-widget {
  position: relative !important;
}

  form.auth0-lock-widget {
  height: 500px !important;
}
}
</style>
</body>
</html>