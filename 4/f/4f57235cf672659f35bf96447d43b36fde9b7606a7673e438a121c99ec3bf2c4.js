(self.webpackChunkdouyin_web=self.webpackChunkdouyin_web||[]).push([[1545],{73770:function(I,x,C){"use strict";C.d(x,{vA:function(){return Y},yw:function(){return K},ZP:function(){return z}});var E=C(81476),M=C(93650);C(3156),C(19858);var S=C(19213),T=C(85049),R=C(23218),w=C.n(R),O=C(18480),A=C(88158),N=C(30027),P=C(13972),L=C(6351),D=C(91810),U=C(73058),B=C(81752),G=C(36397),V={container:"z_yslvRI",shareCode:"CXxmUQNA",defaultContainer:"tH07kOk9",columnContainer:"my9jhPXB",disabledContent:"HS0ux4bi"},F=C(19862);let H=(0,O.ZP)({ssr:!1}),W=(0,O.ZP)(()=>Promise.all([C.e(9901),C.e(1595),C.e(5466),C.e(5468),C.e(2320),C.e(1302),C.e(6759),C.e(6996),C.e(7792),C.e(5948),C.e(3638),C.e(5269)]).then(C.bind(C,99409)),{ssr:!1}),q=(0,O.ZP)({ssr:!1});var K={Video:"share_video",Live:"share_live",User:"share_user",Vs:"share_vs",Comment:"share_comment"},Y={VideoPage:"VideoPage",UserPage:"UserPage"},z=I=>{var x;let{className:C,awemeInfo:R,hidden:O,awemelogPb:K,handleClose:Y,toast:z,reportExtraParams:Z={},shareShowMethod:J,onMouseEnter:X,onMouseLeave:Q,handleClickCopy:ee,handleChooseFriend:et,handleShareToFriend:ei,handleShareSuccess:en,shareType:eo="share_video",uid:er,userInfo:ea,commentInfo:ed,inanyPage:el="VideoPage",loginDispatch:ec,hideShareContent:eu,shareeListHeight:ev,width:eh,onFriendSearching:e_,loginUserInfo:ep}=I,[eg,ef]=(0,T.useState)(!1),[em,ey]=(0,T.useState)(!1),[eI,ex]=(0,T.useState)(!1),[eC,eE]=(0,T.useState)(!1),eM=(0,T.useRef)(null),eb=(0,T.useRef)(null),eS=B,{EVENT:eT}=eS,[eR,ew]=(0,T.useState)(!O),eO=(0,T.useRef)(!O),ek=(null==ep?void 0:ep.isLogin)||!1,eA=(0,T.useMemo)(()=>(!em||!!eI)&&O,[O,em,eI]);return((0,T.useEffect)(()=>{O||(ex(!1),(0,F.removeLoginPanel)())},[O]),(0,T.useEffect)(()=>{O||(ew(!0),eS.emit(eT.videoStopPlayNext)),O&&eR&&eS.emit(eT.videoRemoveStopPlayNext),eO.current=!O},[O]),(0,T.useEffect)([]),(0,T.useEffect)(()=>{if(!O)switch(eo){case"share_vs":case"share_video":var I;G.Z.sendLog("shareMenuShow",(0,E._)({urlParamList:["previous_page"],author_id:null==R?void 0:null===(I=R.authorInfo)||void 0===I?void 0:I.uid,group_id:null==R?void 0:R.awemeId,enter_from:(0,L.mo)(),log_pb:K,is_full_screen:(0,D.r)()?"1":"0",tab_name:N.getTabName()||(0,U.Rs)("tab_name")||"",click_method:J,share_type:"video"},Z));break;case"share_user":G.Z.sendLog("shareMenuShow",{enter_from:(0,L.vM)(),share_type:"user",click_method:J});break;case"share_comment":G.Z.sendLog("shareMenuShow",{enter_from:(0,L.vM)(),share_type:"comment",click_method:J})}O||eg||ef(!0)},[O,J]),(0,T.useEffect)(()=>{var I;let x=I=>I.stopPropagation();return null===(I=eM.current)||void 0===I||I.addEventListener("wheel",x),,[]),(0,T.useEffect)(()=>{setTimeout(()=>{var I;if(!O&&(null==eb?void 0:null===(I=eb.current)||void 0===I?void 0:I.clientHeight)){let I=61,x=204;eE(eb.current.clientHeight-I<x)}},0)},[O,em]),(0,T.useEffect)([R]),(0,T.useEffect)(()=>{let I=I=>{var x,C;(null===(C=eM.current)||void 0===C?void 0:null===(x=C.contains)||void 0===x?void 0:x.call(C,I.target))||em||(null==Y||Y(),null==e_||e_(!1))};return document.addEventListener("click",I,!0),,[em]),(null==R?void 0:null===(x=R.status)||void 0===x?void 0:x.allowShare)===!1)?(0,S.jsx)("div",{ref:eM,"data-e2e":R?"video-share-container":"user-share-container",children:(0,S.jsx)("div",{className:w()(C,V.container,V.shareCode,V.columnContainer,V.disabledContent),onMouseEnter:()=>null==X?void 0:X(),onMouseLeave:()=>null==Q?void 0:Q(),style:{display:eA?"none":"flex"},"data-inuser":"UserPage"===el,ref:eb,children:"该作品已被限制分享"})}):(0,S.jsxs)("div",{ref:eM,"data-e2e":R?"video-share-container":"user-share-container",children:[(null==R?void 0:R.awemeType)===P.ed.XgVideo&&(0,S.jsxs)("div",{className:w()(C,V.container,V.shareCode,V.defaultContainer),onMouseEnter:()=>null==X?void 0:X(),onMouseLeave:()=>null==Q?void 0:Q(),style:{display:eA?"none":"flex",width:324},"data-inuser":"UserPage"===el,children:[(!O||eg)&&(0,S.jsx)(A.SV,{children:(0,S.jsx)("div",{style:{display:em||eI?"none":"block",width:"100%"},children:(0,S.jsx)(W,(0,M._)((0,E._)({},I),{shareType:eo}))})}),ek&&(!O||em)&&((null==R?void 0:R.awemeType)!==P.ed.XgVideo||er)&&"share_vs"!==eo&&(0,S.jsx)(H,{toast:z,close:()=>{ex(!0),ey(!1),null==Y||Y(),B.emit(B.EVENT.videoRemoveStopPlayNext)},awemeInfo:R,shareType:eo,shareUserInfo:ea,shareCommentInfo:ed,handleExpand:()=>ey(!0),handleCollapse:()=>{ey(!1)},handleHasFriends:I=>{},handleChooseFriend:et,handleShareToFriend:ei,handleShareSuccess:en,reportExtraParams:(0,M._)((0,E._)({},Z),{from_xigua:(null==R?void 0:R.awemeType)===P.ed.XgVideo?1:0}),shareeListHeight:ev,onFriendSearching:e_})]}),(null==R?void 0:R.awemeType)!==P.ed.XgVideo&&(0,S.jsxs)("div",{className:w()(C,V.container,V.shareCode,V.columnContainer),onMouseEnter:()=>null==X?void 0ull==Q?void 0:Q(),style:(0,E._)({display:eA?"none":"flex"},eh?{width:eh}:{}),"data-inuser":"UserPage"===el,ref:eb,children:[(!O||em)&&((null==R?void 0:R.awemeType)!==P.ed.XgVideo||er)&&"share_vs"!==eo&&(ek?(0,S.jsx)(H,{toast:z,close:()=>{ex(!0),ey(!1),null==Y||Y(),B.emit(B.EVENT.videoRemoveStopPlayNext)},awemeInfo:R,shareType:eo,shareUserInfo:ea,shareCommentInfExpand:()=>ey(!0),handleCollapse:()=>{ey(!1)}eHasFriends:I=>{},handleChooseFriend:et,handleShareToFriend:ei,handleShareSuccess:en,reportExtraParams:(0,M._)((0,E._)({},Z),{from_xigua:(null==R?void 0:R.awemeType)===P.ed.XgVideo?1:0}),shareeListHeight:ev,onFriendSearching:e_}):(0,S.jsx)(q,{change:()=>{null==ec||ec({type:"updateUserInfo"})}})),(!O||eg)&&!eu&&(0,S.jsx)(A.SV,{children:(0,S.jsx)("div",{style:{display:em||eI?"none":"block",width:"100%"},children:(0,S.jsx)(W,(0,M._)((0,E._)({},I),{shareType:eo,isMiniQrCode:eC}))})})]})]})}},36397:function(I,x,C){"use strict";C.d(x,{h:function(){return M}});var E=C(91865);let M="web_code_link",S={shareMenuShow:{eventName:"share_menu_show",params:{author_id:"",group_id:"",log_pb:"",enter_from:"",previous_page:"",is_full_screen:"0",tab_name:"",click_method:"",share_type:""}},shareVideo:{eventName:"share_video",params:{author_id:"",group_id:"",log_pb:"",enter_from:"",previous_page:"",type:"",is_full_screen:"0",click_method:"",tab_name:"",from_follow_list:"0",from_xigua:0,aweme_type:"",personal_relation:"",relation:"",show_type:""}},shareUser:{eventName:"share_user",params:{chat_type:"",type:"",author_id:"",personal_relation:"",relation:""}},clickFavoriteVideo:{eventName:"click_favorite_video",params:{click_from:"share_board",previous_page:"",author_id:"",group_id:"",log_pb:"",enter_from:"",is_full_screen:"0",click_method:""}},clickCancelFavoriteVideo:{eventName:"click_cancel_favorite_video",params:{click_from:"share_board",previous_page:"",author_id:"",group_id:"",log_pb:"",enter_from:"",is_full_screen:"0"}},favoriteVideo:{eventName:"favorite_video",params:{click_from:"share_board",previous_page:"",author_id:"",group_id:"",log_pb:"",enter_from:"",is_full_screen:"0",click_method:"",clarity:"",aweme_type:"",item_duration_ms:0}},favoriteVideoFailed:{eventName:"favorite_video_failed",params:{click_from:"share_board",err_code:1,previous_page:"",author_id:"",group_id:"",log_pb:"",enter_from:"",is_full_screen:"0"}},cancelFavoriteVideo:{eventName:"cancel_favorite_video",params:{click_from:"share_board",previous_page:"",author_id:"",group_id:"",log_pb:"",enter_from:"",is_full_screen:"0",click_method:"",item_duration_ms:0}},download:{eventName:"download",params:{enter_from:"",enter_from_merge:"",group_id:"",click_from:""}},unsupportDownloadShow:{eventName:"unsupport_download_show",params:{enter_from:"",enter_from_merge:"",group_id:""}},livesdkShareCardShow:{eventName:"livesdk_share_card_show",params:{share_from:"",user_id:"",anchor_id:"",room_id:"",enter_from_merge:"",enter_method:"",action_type:"",request_id:""}},livesdkShareSuccess:{eventName:"livesdk_share_success",params:{share_from:"",share_type:"message",user_id:"",anchor_id:"",room_id:"",enter_from_merge:"",enter_method:"",action_type:"",request_id:""}},report:{eventName:"report",params:{author_id:"",group_id:"",log_pb:"",enter_from:"",previous_page:"",enter_method:"",is_full_screen:"",click_from:"share_card"}}};x.Z=new E.hD(S)},41614:function(I,x,C){"use strict";C.d(x,{E9:function(){return R},FO:function(){return O},Nk:function(){return T},S6:function(){return S},r9:function(){return M},sP:function(){return w}});var E=C(36915);let M={LOVE:{key:"e:love",value:'{"emoji_data":{"icon_url":"https://p6.douyinpic.com/aweme-client-static-resource/single_msg_emoji_love_1588747335.png~tplv-obj.image","me_text":"","text":"❤️"},"type":1}'}},S={RECALL_ROLE:"s:recall_role",RECALL_UID:"s:recall_uid"},T={KEY_CREATE_GROUP_TYPE:"a:s_group_create_type"},R={[E.Hv.REGULAR_USER]:[E.DK.DELETE_CONVERSATION,E.DK.STICK_ON_TOP,E.DK.REPORT,E.DK.SET_MUTED,E.DK.BLOCK_USER],[E.Hv.REGULAR_GROUP]:[E.DK.DELETE_CONVERSATION,E.DK.STICK_ON_TOP,E.DK.REPORT,E.DK.SET_MUTED,E.DK.QUIT_GROUP],[E.Hv.REGULAR_SELF]:[E.DK.DELETE_CONVERSATION,E.DK.STICK_ON_TOP,E.DK.SET_MUTED],[E.Hv.STARNGER_ITEM]:[E.DK.DELETE_CONVERSATION,E.DK.REPORT,E.DK.BLOCK_USER],[E.Hv.STRANGER_BOX]:[E.DK.DELETE_CONVERSATION],[E.Hv.REGULAR_DAREN_USER]:[E.DK.DELETE_CONVERSATION,E.DK.STICK_ON_TOP,E.DK.ENABLE_PIGEON_SYNC,E.DK.REPORT,E.DK.SET_MUTED,E.DK.BLOCK_USER]},w={[E.DK.INIT_VALUE]:"",[E.DK.DELETE_CONVERSATION]:"删除后将清除本会话的聊天记录",[E.DK.QUIT_GROUP]:"确认退出此群聊?",[E.DK.DISSOLVE_GROUP]:"确认解散此群聊，所有成员将退出群聊，无法接收消息"},O={CONVETSAION_DETAIL_CONENT:"conversaton-detail-content",CONVERSAION_DETAIL_INPUT_CONTENT:"conversaton-detail-input-content"}},36915:function(I,x,C){"use strict";C.d(x,{$u:function(){return M},DK:function(){return F},GB:function(){return R},Hv:function(){return V},IM:function(){return B},Lo:function(){return A},XJ:function(){return O},dF:function(){return D},de:function(){return H},dx:function(){return w},eD:function(){return P},eY:function(){return N},flightType:function(){return S},pt:function(){return U},gStatus",I[I.FollowEachOtherStatus=2]="FollowEachOtherStatus",I[I.FollowRequestStatus=4]="FollowRequestStatus"}(M||(M={})),function(I){I[I.Created=0]="Created",I[I.Preparing=1]="Preparing",I[I.Inflight=2]="Inflight",I[I.Succeeded=3]="Succeeded",I[I.Received=4]="Received",I[I.Failed=-1]="Failed",I[I.Rejected=-2]="Rejected",I[I.SelfVisible=-3]="SelfVisible"}(S||(S={}));var M,S,T={light:"light",dark:"dark"},R={MEMBER:0,0:"MEMBER",OWNER:1,1:"OWNER",ADMIN:2,2:"ADMIN"},w={SCENE_TYPE_DEFAULT:0,0:"SCENE_TYPE_DEFAULT",SCENE_TYPE_REPLY_OTHER:1,1:"SCENE_TYPE_REPLY_OTHER",SCENE_TYPE_REPLY_SELF:2,2:"SCENE_TYPE_REPLY_SELF",SCENE_TYPE_AWEME_MENTION:3,3:"SCENE_TYPE_AWEME_MENTION",SCENE_TYPE_COMMENT_MENTION:4,4:"SCENE_TYPE_COMMENT_MENTION",SCENE_TYPE_SHARE:5,5:"SCENE_TYPE_SHARE",SCENE_TYPE_REPLY_INPUT:6,6:"SCENE_TYPE_REPLY_INPUT",SCENE_TYPE_NOTICE_REPLY_DIGG:7,7:"SCENE_TYPE_NOTICE_REPLY_DIGG",SCENE_TYPE_NOTICE_REPLY_COMMENT:8,8:"SCENE_TYPE_NOTICE_REPLY_COMMENT",SCENE_TYPE_NOTICE_REPLY_ATME:9,9:"SCENE_TYPE_NOTICE_REPLY_ATME"},O={AVAILABLE:0,0:"AVAILABLE",NOT_EXTST:1,1:"NOT_EXTST",INVISIBLE:2,2:"INVISIBLE",RECALLED:3,3:"RECALLED",DELETED:4,4:"DELETED"},A={AUDIT_NOT_PASS:1,1:"AUDIT_NOT_PASS",AUDIT_ONLY_SELF:2,2:"AUDIT_ONLY_SELF",REVIEWING:3,3:"REVIEWING",ONLY_FRIEND:4,4:"ONLY_FRIEND",ONLY_SELF:5,5:"ONLY_SELF",AUTHOR_SECRET:6,6:"AUTHOR_SECRET",DELETE:7,7:"DELETE",UNKNOWN:8,8:"UNKNOWN",STORY:9,9:"STORY",PART_SEE:10,10:"PART_SEE"},N={CHAT_NOTIFY:"chat_notif",CHAT_PANEL:"chat_panel",PUSH:"push",CLIENT_PUSH:"client_push"},P={GROUP:"group",PRIVATE:"private"},L={SYSTEM:"system",RECOMMAND:"recommend",INTERACTION:"interaction",FAVORITE:"favorite"},D={CHAT:"chat",CHAT_HEAD:"chat_head",CHAT_LIST:"chat_list"},U={CHAT:"chat"},B={ISME:"1",NOISME:"0"},G={REGULAR:0,0:"REGULAR",STRANGER:1,1:"STRANGER"},V={REGULAR:0,0:"REGULAR",REGULAR_USER:1,1:"REGULAR_USER",REGULAR_GROUP:2,2:"REGULAR_GROUP",REGULAR_SELF:3,3:"REGULAR_SELF",STARNGER_ITEM:4,4:"STARNGER_ITEM",STRANGER_BOX:5,5:"STRANGER_BOX",REGULAR_DAREN_USER:6,6:"REGULAR_DAREN_USER"},F={INIT_VALUE:0,0:"INIT_VALUE",DELETE_CONVERSATION:1,1:"DELETE_CONVERSATION",STICK_ON_TOP:2,2:"STICK_ON_TOP",REPORT:3,3:"REPORT",SET_MUTED:4,4:"SET_MUTED",BLOCK_USER:5,5:"BLOCK_USER",QUIT_GROUP:6,6:"QUIT_GROUP",ENABLE_PIGEON_SYNC:7,7:"ENABLE_PIGEON_SYNC",DISSOLVE_GROUP:8,8:"DISSOLVE_GROUP"},H={TEXT:1,1:"TEXT",PIC:2,2:"PIC",BIG_EMOJI:3,3:"BIG_EMOJI",VIDEO:4,4:"VIDEO"}},82388:function(I,x,C){"use strict";C.d(x,{c6:function(){return S},ds:function(){return T},pp:function(){return M}});let{ConversationType:E}=C(73217).im_proto,M={NONE:-1,SYSTEM:1,ONLY_PICTURE:2,BIG_EMOJI:5,TEXT:7,SHARE_AWEME:8,LOAD_MORE:9,SHARE_PICTURE:12,COMMAND_SHARE:13,UPDATE_TIPS:14,SAY_HELLO:15,COMMENT:16,VOICE:17,SHARE_RANK_LIST:18,SHARE_CHALLENGE:19,SHARRE_POI:20,SHARE_LIVE:21,SHARE_MUSIC:22,SHARE_HARMONY_RANK_LIST:23,SHARE_MINI_APP:24,SHARE_USER:25,SHARE_WEB:26,STORY_PICTURE:27,SHARE_COUPON:28,STORY_VIDEO:30,AT_FRIEND_INTERACT:31,STORY_REPLY:32,COMMON_RED_ENVELOPE:35,VIDEO_RED_ENVELOPE:36,VIDEO_RED_ENVELOPE_NEW_YEAR:38,XPLAN_STICKER_EMOJI:51,XPLAN_HEART_EMOJI:52,SELF_STORY_REPLY:53,GROUP_INVITE_MESSAGE:58,SHARE_WEB_FROM_THIRD_MESSAGE:60,SHARE_GOOD:61,SHARE_GOOD_WINDOW:62,SHARE_POI_RANK:63,SHARE_GOOD_WINDOW_V3:64,ENTERPRISE_CUSTOMIZED_CARD:65,ENTERPRISE_CUSTOMIZED_CARD_WITH_FIXED_HEIGHT:66,ENTERPRISE_PRODUCT_LIST_CARD:67,E_PLATFORM_MESSAGE:70,SHARE_COMPILATION:71,SHARE_STICKER:72,CHAT_CALL:73,RED_PACKET:74,FRIEND_VIDEO_DM_COMMENT:75,SHARE_VS_LIVE:76,SHARE_PHOTOS:77,DIRECT_INVITE:78,GAME_INVITE:79,COUPON_FANS_GROUP:80,SUBSCRIBE_MESSAGE:81,GAME_INVITE_V2:82,REF_MSG:83,LIVE_ADVANCED_NOTICE_MESSAGE:84,URGE_LEAVE_MESSAGE:85,SHARE_PLAYLET:86,SHARE_DSP_MUSIC:87,ONE_CARD:88,ENTER_CHAT_FROM_VIDEO_COMMENT_LINK_MESSAGE:89,FEED_VOIP_SHARE_INVITE_MESSAGE:90,STORY_PICTURE_ONCE_VIEW:91,STORY_VIDEO_ONCE_VIEW:92,ENTERPRISE_CUSTOMER_SERVICE_CARD:93,COUPON_ENTERPRISE:94,CLOUD_GAME_INVITE:96,TEXT_PUSH_GUIDE:97,BULLET:110,SHARE_COMMENT:105,IM_ENCRYPT_VOICE:109,ENCRYPT_VOICE:501,SHARE_LOCATION:502,XRTC_CHATROOM_INVITE:507,X_GROUP_HOLDER:1e3,GROUP_NOTICE_MESSAGE:1001,GROUP_GREET_MESSAGE:1002,GROUP_ANNOUNCEMENT_MESSAGE:1004,PUSH_NOTIFICATION_GUIDE_MESSAGE:1005,SYSTEM_COMPAT:1006,DENGER_WARNING_TOP_MESSAGE:1007,GROUP_MASTER_SHARE_TOKEN:1008,DOUBLE_LIKE_GUIDE:1009,STRANGER_GREET_MESSAGE:1010,ACTIVE_FRIEND_GREET_MESSAGE:1011,MUTE_GUIDE_CARD:1012,FEED_LIVE_SHARE_INVITE_MESSAGE:1013,CHAT_CALL_D_ONLY:1017,SHARE_MT_LIVE:1021,ACTION_MESSAGE:2e3,WELCOME_WORDS_CARD:9990,FANS_GROUP_MILE_STONE_CARD:9992,CREATOR_FAN_GROUP_PASSWORD_INVITE:9995,CREATOR_FAN_GROUP_CARD_INVITE_MESSAGE:9996,BIRTHDAY_WISHES_MESSAGE:9997,LIVE_FANS_GROUP_OWNER_INVITE_CARD:9998},S={DEFAULT:0,LIVE:23,AWEME_SYSTEM:100,SYSTEM_USER_ACTIVE_STATUS:101,SYSTEM_CREATE_GROUP_REWARD:102,SYSTEM_GROUP_MEMBER_ONLINE:103,SYSTEM_GROUP_SILENT_NOTICE:106,SYSTEM_GROUP_UN_SILENT_NOTICE:107,SYSTEM_MEMBER_SILENT_NOTICE:108,SYSTEM_MEMBER_UN_SILENT_NOTICE:109,AWEME_COMMENT:200,AWEME_BIG_EMOJI:500,AWEME_EMOJI_SELF:501,AWEME_NET_SEARCH_GIF:502,AWEME_TYPE_GIPHY:503,AWEME_GREET_EMOJI:504,AWEME_LITE_MSG_EMOJI:505,AWEME_LITE_MSG_EMOJI_NEW:506,AWEME_INTERACTIVE_EMOJI:507,AWEME_STORE_EMOJI:508,AWEME_SINGLE_HEYCAN_EMOJI:510,AWEME_TEXT:700,AWEME_SAY_HELLO_TEXT:701,AWEME_TEXT_GREETING:702,TEXT_REF_MSG:703,AWEME_TEXT_POSTSCRIPT:704,AWEME_TEXT_ASK:705,AWEME_TEXT_WELCOME_WORDS:706,AWEME_TEXT_REPORT_WORDS:708,AWEME_PERSONAL_INFO_REQUEST:770,AWEME_PERSONAL_INFO_RESPONSE:771,AWEME_TEXT_UNKNOWN_MSG_TYPE:799,AWEME_CARD:800,PICTURE_CARD:900,RANKING_LIST_WORD:1801,RANKING_LIST_VIDEO:1802,RANKING_LIST_MUSIC:1803,LIVE_KTV:2101,LIVE_VOICE:2102,IM_ENCRYPT_VOICE_AWE_TYPE:10900,RANKING_LIST_HARMONY:2301,MINI_GAME:2401,MINI_APP:2402,MINI_GENERALIZE:2403,ENCRYPT_PICTURE:2700,ENCRYPT_PICTURE_SHARE_FROM_THIRD:2701,ENCRYPT_PICTURE_OUT_CHECK:2702,ENCRYPT_PICTYRE_GIF:2703,WEB_SHARE_FROM_THIRD:6001,WEB_SHARE_FROM_RED_PACKET:2601,GOOD_WINDOW_V3:6400,AWEME_XEMOJI:5101,DIRECT_INVITE_VOICE_CHAT:7801,DIRECT_INVITE_KTV:7802,DIRECT_INVITE_VIDEO_CHAT:7803,DIRECT_INVITE_SHORT_VIDEO:7804,DIRECT_INVITE_FAMILIAR_KTV:7805,DIRECT_INVITE_AUDIENCE:7806,GAME_INVITE_IN_CHAT:7900,GAME_INVITE_IN_GAME:7901,GAME_INVITE_V2:8200,REF_MSG:8300,GROUP_VOTE:8800,COMMODITY_SHARE:8801,GROUP_NOTICE_ADD:100100,GROUP_NOTICE_COMMAND_ADD:100101,GROUP_NOTICE_QRCODE_ADD:100102,GROUP_NOTICE_SAFETY_WARNING:100103,GROUP_NOTICE_REMOVE:100104,GROUP_NOTICE_EXIT:100105,GROUP_NOTICE_GROUP_NAME_CHANGE:100106,GROUP_NOTICE_FROM_DUO_SHAN:100107,GROUP_NOTICE_APPLY_ADD:100109,GROUP_NOTICE_ADMIN_ADD:100110,GROUP_NOTICE_SEARCH_JOIN_GROUP:100111,GROUP_NOTICE_ACTIVITY_JOIN_GROUP:100112,GROUP_NOTICE_ACTIVITY_JOIN_GROUP_BY_FTF:100113,GROUP_NOTICE_ACTIVITY_JOIN_GROUP_BY_CIRCLE:100114,GROUP_NOTICE_WARNING_TIPS:100120,GROUP_NOTICE_GROUP_NAME_EDIT_TIPS:100121,GROUP_NOTICE_LIVE_FANS_MANAGER:100122,GROUP_NOTICE_LIVE_FANS_ANNOUNCE:100123,GROUO_NOTICE_DISABLE_SHARE:100124,GROUP_NOTICE_OPEN_DISABLES_SHARE:100125,GROUP_GREET_MESSAGE_FROM_SERVER:100200,GROUP_GREET_MESSAGE_FROM_CLIENT:100201,GROUP_OWNER_ACTIVE_GUIDE_EMOJI:100202,GROUP_MEMBER_ONLINE_GREET_EMOJI:100203,GROUP_MESSAGE_FOR_AVCALL:100300,GROUP_NOTICE_MUTE_NOTICE:9994,GROUP_NOTICE_FANS_GROUP_WELCOME_NOTICE:9995,FEED_VOIP_SHARE_FOR_AVCALL:9e3},T=[M.SHARE_AWEME,M.REF_MSG,M.SHARE_PHOTOS,M.SHARE_COMMENT,M.BULLET]},12788:function(I,x,C){"use strict";C.d(x,{v:function(){return A}});var E=C(73217),M=C(31545),S=C(15529);let{ConversationType:T}=E.im_proto,{GROUP_CHAT:R,ONE_TO_ONE_CHAT:w}=T,O="";function A(I){var x;let{id:C,type:E,toParticipantUserId:T,lastMessage:w,coreInfo:A={},ext:N}=I||{},P=E===R,{userInfoFromServerMap:L}=M.default,{createdAt:D,content:U}=w||{},{name:B,icon:G}=A,V=(null==L?void 0:L[T])||{};V||M.default.getPatchUserInfoAsync(T);let F=(P?(null==N?void 0:N["a:ab_avatar"])||G:null==V?void 0:null===(x=V.avatar_thumb)||void 0===x?void 0:x.url_list)||O,H=(null==V?void 0:V.remark_name)||(null==V?void 0:V.nickname)||T||"";return{headIcon:F,title:P?B||C:H,timeStr:(0,S.xS)(D)}}},84177:function(I,x,C){"use strict";C.d(x,{AD:function(){return el},FG:function(){return z},FH:function(){return eo},Jo:function(){return Z},KI:function(){return ea},MZ:function(){return J},NC:function(){return H},V5:function(){return ed},Ww:function(){return ei},gP:function(){return et},gc:function(){return Q},iN:function(){return en},jt:function(){return ee},lR:function(){return F},np:function(){return X},s9:function(){return q},t$:function(){return Y},ur:function(){return W},zt:function(){return K}});var E=C(81476),M=C(93650);C(6418),C(92101),C(87928),C(31538),C(56551),C(19232),C(3481),C(85248),C(41224);var S=C(73217),T=C(76040),R=C.n(T),w=C(9176),O=C.n(w),A=C(96196),N=C.n(A),P=C(53251),L=C.n(P),D=C(31545),U=C(82388),B=C(36915);let{ConversationType:G}=S.im_proto;function V(I){let{text:x,textExtra:C=[],content:E,type:M,referenceHint:S,referenceMessage:T}=I,w=[];R()(C,I=>{var x;let C=null==I?void 0:null===(x=I.info)||void 0===x?void 0:x.uid;if(C)try{w.push(parseInt(C))}catch(I){}});let O={mention_users:w,aweType:U.c6.AWEME_TEXT,richTextInfos:C};T&&(O.aweType=U.c6.TEXT_REF_MSG),x&&(O.text=x);let A={type:M||U.pp.TEXT,mentionedUsers:w,content:E||JSON.stringify(O)};return T&&(A.referenceHint=JSON.stringify(S),A.referenceMessage=T),A}function F(I){let{height:x,id:C,width:E,sticker_type:M,animate_type:S,animate_url:T,id_str:R}=I,w={aweType:U.c6.AWEME_SINGLE_HEYCAN_EMOJI,createdAt:0,display_name:"",height:x,width:E,image_id:R||C,image_type:"gif",is_card:!1,may_show_special_effect:!1,msgHint:"",package_id:0,updateConversationTime:!0,url:{height:0,uri:null==T?void 0:T.uri,url_list:null==T?void 0:T.url_list,width:0}};return{type:U.pp.BIG_EMOJI,content:JSON.stringify(w)}}function H(I){let{height:x,id:C,width:E,display_name:M,animate_url:S,id_str:T}=I,R=BigInt(T),w={aweType:U.c6.AWEME_EMOJI_SELF,createdAt:0,display_name:M||"",height:x,width:E,image_id:R,image_type:"gif",is_card:!1,may_show_special_effect:!1,msgHint:"",package_id:0,updateConversationTime:!0,url:{height:0,uri:null==S?void 0:S.uri,url_list:null==S?void 0:S.url_list,width:0}};return{type:U.pp.BIG_EMOJI,content:N().stringify(w)}}function W(I){let{origin:x,id:C}=I,{width:E,height:M,uri:S,url_list:T}=x||{},R={aweType:U.c6.AWEME_SINGLE_HEYCAN_EMOJI,createdAt:0,display_name:"",height:M,width:E,image_id:C,image_type:"gif",is_card:!1,may_show_special_effect:!1,msgHint:"",package_id:0,updateConversationTime:!0,url:{height:0,uri:S,url_list:T,width:0}};return{type:U.pp.BIG_EMOJI,content:JSON.stringify(R)}}function q(I){let{height:x,id:C,width:E,animate_url:M,display_name:S,resource_type:T,static_url_list:R}=I,w=M;if(5===T){let I=Math.floor(Math.random()*R.length);w=R[I].static_url}let O={aweType:U.c6.AWEME_INTERACTIVE_EMOJI,createdAt:0,display_name:S,height:x,width:E,image_id:C,image_type:"gif",is_card:!1,may_show_special_effect:!1,msgHint:"",package_id:0,updateConversationTime:!0,url:{height:x,uri:w,url_list:[w],width:E}};return{type:U.pp.BIG_EMOJI,content:JSON.stringify(O)}}function K(I){let{height:x,id:C,width:E,animate_url:M,display_name:S}=I,T={aweType:U.c6.AWEME_SINGLE_HEYCAN_EMOJI,createdAt:0,display_name:S,height:x,width:E,image_id:C,image_type:"gif",is_card:!1,may_show_special_effect:!1,msgHint:"",package_id:0,updateConversationTime:!0,url:{height:0,uri:null==M?void 0:M.uri,url_list:null==M?void 0:M.url_list,width:0}};return{type:U.pp.BIG_EMOJI,content:JSON.stringify(T)}}function Y(I){let x=arguments.length>1&&void 0!==arguments[1]&&arguments[1],{content:C}=I,E={};try{E=(x?N():JSON).parse(C)}catch(I){E={}}return E}function z(I,x){let C=I,E=x;return(null==I?void 0:I.includes("未成年充值"))&&(C="如遇未成年充值打赏问题，可在 {{1}} 内申请退款",E=[{key:1,action:4,name:"抖音App",link:"https://www.douyin.com/downloadpage/app"}]),{newTips:(I){let{referenceInfo:x}=I,C={};if(x){let{hint:I}=x;try{let{refmsg_content:x}=JSON.parse(I);x&&(C=JSON.parse(x))}catch(I){C={}}}return C}function J(I){return V(I)}function X(I){var x;let{active_users:C,passive_users:E,locale_resources:M,template:S}=I||{},T=(null==M?void 0:null===(x=M[0])||void 0===x?void 0:x.text)||"",{curUserInfo:w}=D.default,O=[];R()(C,I=>{let x=(null==I?void 0:I.nickname)||"";(null==w?void 0:w.uid)&&(null==w?void 0:w.uid)===(null==I?void 0:I.uid)&&(x="你"),O.oid 0:I.nickname)||"";(null==w?void 0:w.uid)&&(null==w?void 0:w.uid)===(null==I?void 0:I.uid)&&(x="你"),A.push(x)});let N=I=>I.replace("<","&lt;").replace(">","&gt;");return T=N(T=T.replace("{0}",O.join("、")).replace("{1}",A.join("、"))),null==S||S.forEach(I=>{if((null==I?void 0:I.action)===4){var x;if((null==I?void 0:null===(x=I.extra)||void 0===x?void 0:x.is_full_text_match)&&I.key){let x=N(I.key),C=N(I.link);T=T.replace(x,`<a href="${C}" target="_blank" style="color: #5886d9;">${x}</a>`)}}}),T}function Q(I){let x="";if(!I)return x;let{type:C,visible:E,isFromMe:M,content:S,sender:T,conversationId:R,conversationType:w,isRecalled:O}=I;if(O)return`${M?"你":""}撤回了一条消息`;let A={};try{A=JSON.parse(S)}catch(I){}switch(C){case U.pp.SYSTEM:x=ed(null==A?void 0:A.tips,null==A?void 0:A.template)||"";break;case U.pp.BIG_EMOJI:x=`[${(null==A?void 0:A.display_name)||"表情"}]`;break;case U.pp.TEXT:x=(null==A?void 0:A.text)||"";break;case U.pp.SHARE_AWEME:x="分享[视频]";break;case U.pp.SAY_HELLO:let N=`我是${null==A?void 0:A.nickname}，`||"";x=`嗨～ ${N}聊聊天吧`;break;case U.pp.VOICE:case U.pp.IM_ENCRYPT_VOICE:x="[语音]";break;case U.pp.SHARE_LIVE:x="分享[直播]",(null==A?void 0:A.push_detail)&&(x+=`：${null==A?void 0:A.push_detail}`);break;case U.pp.STORY_PICTURE:x="[图片]";break;case U.pp.XPLAN_STICKER_EMOJI:x=`[${(null==A?void 0:A.display_name)||"表情"}]`;break;case U.pp.SHARE_PHOTOS:x="分享[图集]";break;case U.pp.REF_MSG:x=`${(null==A?void 0:A.shareMsgType)===U.pp.SHARE_PHOTOS?"分享[图集]":"分享[视频]"}`;break;case U.pp.GROUP_NOTICE_MESSAGE:x=X(A);break;case U.pp.GROUP_GREET_MESSAGE:x="和朋友打个招呼吧";break;case U.pp.GROUP_ANNOUNCEMENT_MESSAGE:x=`[群公告]${(null==A?void 0:A.notice_content)||""}`;break;case U.pp.SHARE_USER:x="[分享用户]";break;case U.pp.SHARE_COMMENT:x="分享[评论]";break;case U.pp.BULLET:x=String((null==A?void 0:A.push_detail)||"消息卡片");break;default:x="暂不支持该消息类型"}return x}function ee(I){var x;let C="";if(!I)return C;let{type:E,visible:M,isFromMe:S,content:T,sender:R,conversationId:w,isRecalled:O,conversationType:A}=I,{unSendMsgConversationMap:N,userInfoFromSdkMap:P,userInfoFromServerMap:L,abTestData:U}=D.default,B="",G="";G=Q(I);let V=null==P?void 0:null===(x=P[w])||void 0===x?void 0:x[R],F=null==L?void 0:L[R];return(B=(null==F?void 0:F.remark_name)||(null==V?void 0:V.alias)||(null==F?void 0:F.nickname)||"")&&(C+=`${B}:`),G&&(C+=G),C||""}function et(I){try{switch(L().fromValue(I).toNumber()){case U.pp.SHARE_AWEME:return"[分享视频]";case U.pp.SHARE_PHOTOS:return"[分享图集]";default:return""}}catch(I){return""}}function ei(I,x){let C;let{type:S,content:T,sender:R}=I,{unSendMsgConversationMap:w,curUserInfo:O,abTestData:A,curConversation:N,userInfoFromSdkMap:P,userInfoFromServerMap:L}=D.default,{uid:G,sec_uid:V,nickname:F,remark_name:H}=L[R];N.type;let W=O.uid,q={};try{q=JSON.parse(T)}catch(I){}let K={},Y="",z=0;switch(S){case U.pp.BIG_EMOJI:K={content:"[表情]",refmsg_content:T};break;case U.pp.TEXT:K={content:q.text,refmsg_content:T};break;case U.pp.SHARE_AWEME:z=1,K={content:`${et(S)}${q.content_title}`,refmsg_content:T};break;case U.pp.STORY_PICTURE:K={content:"[图片]",refmsg_content:T},Y=q.itemId;break;case U.pp.XPLAN_STICKER_EMOJI:K={content:"[表情]",refmsg_content:T};break;case U.pp.SHARE_PHOTOS:K={content:`${et(S)}${q.content_title}`,refmsg_content:T};break;case U.pp.BULLET:Y=q.item_id,K={content:`${q.description||"消息卡片"}`,refmsg_content:T};break;case U.pp.REF_MSG:K={content:q.text,refmsg_content:T};break;default:return!1}return C=W!==G?B.dx.SCENE_TYPE_REPLY_OTHER:B.dx.SCENE_TYPE_REPLY_SELF,(0,M._)((0,E._)({refmsg_uid:G,itemId:Y,nickname:H||F,refmsg_sec_uid:V,refmsg_type:S},K),{scene_type:C,version:z})}let en=I=>Date.now()-new Date(I).getTime()<=2592e5,eo=I=>(!(I>=0)||!(I<=1999))&&(!(I>5e4)||60001===I),er=(I,x,C)=>{let E=[];return R()(I,I=>{if(O()(I)){let M=I.split(x),S=M.length,T=[];S>1?(R()(M,(I,x)=>{x===S-1?T.push(I):(T.push(I),T.push(C))}),E=E.concat(T)):E.push(I)}else E.push(I)}),E},ea=(I,x)=>{if(!I)return[];if(!(null==x?void 0:x.length))return[I];let C={};R()(x,I=>{C[`{{${null==I?void 0:I.key}}}`]=I});let E=I.match(/{{\d+}}/g),M=[I];return R()(E,I=>{M=er(M,I,C[I])}),M};function ed(I,x){let C=String(I);return Array.isArray(x)&&x.forEach(I=>{C=null==C?void 0:C.replace(`{{${null==I?void 0:I.key}}}`,null==I?void 0:I.name)}),C}function el(I,x,C){let E;let{content:M,sender:S}=I;try{E=JSON.parse(M)}catch(I){E={}}let{content_title:T,cover_height:R,cover_url:w,cover_width:O,is_card:A,itemId:N,msgHint:P,push_detail:L,uid:D,secUID:G}=E,V={aweType:U.c6.REF_MSG,scene_type:B.dx.SCENE_TYPE_REPLY_INPUT,content_title:T,cover_height:R,cover_width:O,cover_url:w,is_card:A,itemId:N,msgHint:P,push_detail:L,createdAt:0,text:x,richTextInfos:C,ref_uid:S,uid:D,sec_uid:G};return{type:U.pp.REF_MSG,content:JSON.stringify(V)}}},15529:function(I,x,C){"use strict";C.d(x,{lD:function(){return O},v1:function(){return A},xS:function(){return w}});var E=C(14239),M=C.n(E),S=C(5123),T=C.n(S);M().extend(T());let R={0:"星期日",1:"星期一",2:"星期二",3:"星期三",4:"星期四",5:"星期五",6:"星期六"};function w(I){if(Date.now()-new Date(I).getTime()<=3e5)return"刚刚";let x=M()(I),C=M()(),E=x.format("HH:mm")||"";return I>C.startOf("day").valueOf()?E:I>C.subtract(1,"day").startOf("day").valueOf()?"昨天":I>=C.subtract(3,"day").startOf("day").valueOf()?R[x.day()]:I>=C.startOf("year").valueOf()?x.format("MM-DD")||"":x.format("YYYY-MM-DD")||""}function O(I){if(Date.now()-new Date(I).getTime()<=3e5)return"刚刚";let x=M()(I),C=M()(),E=x.format("HH:mm")||"";if(I>C.startOf("day").valueOf())return E;if(I>C.subtract(1,"day").startOf("day").valueOf())return`昨天 ${E}`;if(I>=C.subtract(3,"day").startOf("day").valueOf()){let I=x.day();return`${R[I]} ${E}`}return x.format("YYYY-MM-DD HH:mm")||""}function A(I){return Date.now()-new Date(I).getTime()<=3e5}},31545:function(I,x,C){"use strict";C.r(x),C.d(x,{default:function(){return el}});var E=C(81476),M=C(93650);C(6418),C(19858),C(31538),C(64200),C(3156);var S=C(76423),T=C(76040),R=C.n(T),w=C(19919),O=C.n(w),A=C(50739),N=C.n(A),P=C(32985),L=C.n(P),D=C(88617),U=C.n(D),B=C(73217),G=C(50282),V=C(28510),F=C(89339),H=C(22855),W=C(81752),q=C(6414),K=C(14023),Y=C(36915),z=C(38879);let Z=(I,x)=>(null==I?void 0:I.updatedAt)>(null==x?void 0:x.updatedAt),J=function(I,x){let C=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,E=arguments.length>3&&void 0!==arguments[3]?arguments[3]:(null==I?void 0:I.length)||0;if(E<=C)return C;let M=Math.floor((C+E)/2);return Z(I[M],x)?C=M+1:E=M,J(I,x,C,E)};var X=J,Q=C(82388),ee=C(84177),et=C(55221),ei=C(73770);function en(I,x,C){return x in I?Object.defineProperty(I,x,{value:C,enumerable:!0,configurable:!0,writable:!0}):I[x]=C,I}let{ConversationType:eo}=B.im_proto,{GROUP_CHAT:er,ONE_TO_ONE_CHAT:ea}=eo;class ed{get conversationListFilter(){let I=this.converSationListOrigin||[],x=[];return R()(I,I=>{I&&(I.type!==er||I.type===er&&I.lastMessage)&&x.push(I)}),q.Z.warn("conversationListFilter",x),x}get stickOnTopCount(){let I=this.conversationListFilter||[],x=0;for(let C of I)if(null==C?void 0:C.isStickOnTop)x++;else break;return x}get converListWithStrangerBox(){var I,x,C;let E=(null===(I=this.conversationListFilter)||void 0===I?void 0:I.slice())||[],M=this.stickOnTopCount||0,S=(null===(x=this.conversationListFilter)||void 0===x?void 0:x.length)||0;if(this.strangerBoxCover){let I=X(E,null===(C=this.strangerBoxCover)||void 0===C?void 0:C.conversation,M,S);null==E||E.splice(I,0,this.strangerBoxCover)}return E}get allUnReadCount(){let I=N()(this.conversationListFilter,I=>{let{isMuted:x,unreadCount:C}=InreadCount)||0}),x=H.Le.getConfig(H.gI.UnReadCount)||{},C=x.im||0,M=I;return H.Le.setConfig(H.gI.UnReadCount,(0,E._)({},x,{im:I})),C!==M&&W.emit(W.EVENT.updateUnReadCount,!0),I}get allGroupList(){let I=[];return R()(this.conversationListFilter,x=>{let{id:C,type:E}=x;E===er&&I.push(x)}),U()(I,I=>null==I?void 0:I.id)}get conversationInfoMap(){let I={};return R()(this.converSationListOrigin,x=>{let{id:C,type:E}=x;I[C]=x}),I}get usersInConversationList(){let I=[];return R()(this.converSationListOrigin,x=>{let{id:C,type:E,toParticipantUserId:M}=x;M&&E===ea&&I.push({uid:M,conversationId:C})}),U()(I,I=>null==I?void 0:I.uid)}get strongNoticeList(){let I=[];return R()(this.messageList,x=>{var C;let E=(0,ee.t$)(x);!(null==x?void 0:x.isFromMe)&&(null==E?void 0:null===(C=E.ext)||void 0===C?void 0:C.strong_tips)&&I.push({contentObj:E,msg:x})}),I}get allFriendInfoList(){let I=[],x=this.allFriendsList||[],C=this.userInfoFromServerMap||{};return R()(x,x=>{let E=null==C?void 0:C[x];E&&I.push(E)}),U()(I,I=>null==I?void 0:I.uid)}get videoMsgList(){let I=[];return R()(this.messageList,x=>{let{type:C,clientId:E,isRecalled:M}=x||{};if(!M&&(null===Q.ds||void 0===Q.ds?void 0:Q.ds.includes(C))){let{itemId:C,item_id:M}=(0,ee.t$)(x)||{},S=null!=C?C:M;S&&I.push({awemeId:S,msgClientId:E})}}),I}setTheme(I){this.theme=I}setCurUserInfo(I){this.curUserInfo=I}setIsLogin(){let I=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.isLogin=I}setDlgShow(){let I=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.showDlg=I}setAbTestData(){let I=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.abTestData=I}setShareCollapse(){let I=!(arguments.length>0)||void 0===arguments[0]||arguments[0],{handleCollapse:x=()=>{},handleExpand:C=()=>{}}=this.shareStatusHandler;this.isShareCollapse=I,I?null==x||x():null==C||C()}setCurShareType(){let I=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ei.yw.Video;this.shareType=I}setCurAwemeInfo(){let I=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.awemeInfo=I}setCurShareUserInfo(){let I=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.shareUserInfo=I}hareCommentInfo=I}setCurShareLiveInfo(){let I=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.shareLiveInfo=I}setShareeListHeight(I){this.shareeListHeight=I}setShareStatunts.length>0&&void 0!==arguments[0]?arguments[0]:{handleCollapse:()=>{},handleExpand:()=>{}};this.shareStatusHandler=I}setShareMap(){let I=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.shareMap=I}resetData(){}setAudioMd5(I){this.audioMd5=I}setConverSationList(){let I=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];this.setIsShowGetConversaionListLoading(!0);let x=U()(I,I=>null==I?void 0:I.id),C=0,E=x.length;for(let I=0;I<E;I++){let E=x[I];if(!(null==E?void 0:E.isStickOnTop)){C=I;break}}let M=[];C>0&&(M=x.splice(0,C)).sort((I,x)=>{var C,E;let M=(null==I?void 0:null===(C=I.lastMessage)||void 0===C?void 0:C.createdAt)||0;return((null==x?void 0:null===(E=x.lastMessage)||void 0===E?void 0:E.createdAt)||0)-M}),this.converSationListOrigin=M.concat(x)}setCurConverSation(){let I=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.curConversation=I,this.serverIdMessageMap={},this.setIsStrangerConversation((null==I?void 0:I.isStrangerConversation)||!1)}setEnterConversation(){let I=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Y.eY.CHAT_NOTIFY;this.enterConversation=I}setCurMessageList(){let I=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];this.serverIdMessageMap={},this.messageList=U()(I,I=>{let{serverId:x,clientId:C}=I||{};return x&&(this.serverIdMenversationPullUp(){let I=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.conversationPullUpPriority=(0,M._)((0,E._)({},this.conversationPullUpPriority),{[null==I?void 0:I.shortId]:Date.now()})}setStrangerConverListObj(I){this.strangerConverListObj=I}setConversationMap(){let I=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],x=this.conversationMap||{};null==I||I.forEach(I=>{let{id:C}=I;x[C]=I}),this.conversationMap=x}setIsInStrangerConversationList(){let I=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.isInStrangerConversationList=I}setIsStrangerConversation(){let I=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.isStrangerConversation=I}setStrangerBoxCover(I){let x=I?{conversation:I,converCellType:Y.tQ.STRANGER}:null;this.strangerBoxCover=x}setStrangerMessageUnreadCount(I){this.strangerMessageUnreadCount=I}setCurMsgOptPopId(){let I=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";this.curMsgOptPopId=I}setCurGroupUserIdList(){let I=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];this.curGroupUserIdList=L()(I)}setConversationUserids(I){let x=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],C=arguments.length>2&&void 0!==arguments[2]&&arguments[2];C?this.conversationUserids[I]=L()(x):this.conversationUserids[I]=L()([...this.conversationUserids[I]||[],...x])}setUserInfoFromSdkMap(I,x,C){this.userInfoFromSdkMap||(this.userInfoFromSdkMap={}),this.userInfoFromSdkMap[I]||(this.userInfoFromSdkMap[I]={}),this.userInfoFromSdkMap[I][x]||(this.userInfoFromSdkMap[I][x]=C,this.uidSecUidMap[x]=C.sec_uid)}setUserInfoFromServerMap(){let I=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];I&&R()(I,I=>{let{uid:x}=I;x&&"0"!==x&&(this.userInfoFromServerMap[x]=I)is.userInfoForShareMap||{},R()(I,I=>{let{uid:x}=I;x&&"0"!==x&&(this.userInfoForShareMap[x]=I)}))}setUserInfoBlockStatus(I){var x;let C=arguments.length>1&&void 0!==arguments[1]&&==x?void 0:x[I])&&(this.userInfoFromServerMap[I].is_block=C)}setReplayMessageServerId(){let I=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.replayMessageServerId=I}setClientTrayGuidClientId(){let I=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,x=arguments.length>1?arguments[1]:void 0;this.clientTrayGuidInfo={clientId:I,type:x}}clearClientTrayGuidClientId(){this.clientTrayGuidInfo=null}setUnSendMsgConversation(I){let x=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;I&&(x?this.unSendMsgConversationMap[I]=x:delete this.unSendMsgConversationMap[arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];I.forEach(I=>{let{conversationId:x,text:C,textExtra:E,replyMsgServerId:M}=I;x&&(this.unSendMsgConversationMap[x]={text:C,textExtra:E,replyMsgServerId:M})})}clearOldMsgListToPush(){var I,x;let C=(null===(I=this.msgListToPush)||void 0===I?voif(!(null===(x=this.msgListToPush)||void 0===x?void 0:x.length))return;let E=0;R()(this.msgListToPush,(x,C)=>{(null==x?void 0:x.conversationId)===I&&(E=C)}),null===(C=this.msgListToPush)||void 0===C||C.splice(E,1)}setHasJoinGroup(I){this.hasJoinGroupObj=I}setCanShowImPush(){let I=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.canShowImPush=I}setUserFollowStatusMap(I,x){I&&(this.userFollowStatusMap[I]=x)}async getUserInfoMapAsync(){let I=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return Promise.all(O()(I,async I=>{if(I){let[x,C]=await (0,z.Z)((0,V.RK)(I));C&&this.setUserInfoFromServerMap([C])}}))}async getPatchUserInfoAsync(I){var x;let C=nu|void 0===x?void 0:x[I];return this.getUserInfoMapAsync([C])}async getShareUserListAsync(){}async getEmojiMaps(){if(!(Object.keys(this.emojiMap).length>0)){let[I,x]=await (0,z.Z)((0,G.zk)());I||0!==x.statusCode||(this.emojiMap=x.data)}}async getEmojiList(){if(this.emojiList.length>0)return this.emojiList;{await (0,z.Z)(this.getEmojiMaps());let I=[];return Object.values(this.emojiMap).forEach(x=>{1!==x.hide&&I.push(x)}),this.emojiList=I,I}}async getEmojiGifListAsync(){var I,x;if(null===(I=this.emojiGifList)||void 0===I?void 0:I.length)return this.emojiGifList;let[C,E]=await (0,z.Z)((0,F.xD)({}));return C?[]:(this.emojiGifList=(null==E?void 0:null===(x=E.emoticon_data)||void 0===x?void 0:x.stickers)||[],this.emojiGifList)}async getInteractiveEmojiListAsync(){var I;if(null===(I=this.interactiveEmojiList)||void 0===I?void 0:I.length)return this.interactiveEmojiList;let{statusCode:x,stickerList:C}=await (0,G.YX)();return 0!==x?[]:(this.interactiveEmojiList=C,this.interactiveEmojiList)}async getCustomEmojiListAsync(){var I,x,C;if(null===(I=this.customEmojiList)||void 0===I?void 0:I.length)return this.customEmojiList;let E=await (0,G.Ol)();return 0!==E.status_code?[]:(this.customEmojiList=(null===(C=E.custom_sticker_page_list)||void 0===C?void 0:null===(x=C.resources)||void 0===x?void 0:x[0].stickers)||[],this.customEmojiList)}async getRecentEmojiAsync(){var I;let x=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if((null===(I=this.recentEmojiList)||void 0===I?void 0:I.length)&&!x)return this.recentEmojiList;let C=await (0,G.iT)(!1);return 0!==C.status_code?this.recentEmojiList=[]:(this.recentEmojiList=C.sticker_list,this.recentEmojiList)}async getRecentGifAsync(){var I;let x=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if((null===(I=this.recentGifList)||void 0===I?void 0:I.length)&&!x)return this.recentGifList;let C=await (0,G.iT)(!0);return 0!==C.status_code?this.recentGifList=[]:(this.recentGifList=C.sticker_list,this.recentGifList)}async getShowSugEmoji(){let{enable_rec_emoticon:I,status_code:x}=await (0,G.nb)();0===x&&(t)||[]).sort((I,x)=>(null==I?void 0:I.follow_status)?(null==x?void 0:x.follow_status)?x.follow_status-I.follow_status:-1:1);this.setUserInfoForShareMap(C);let E=[];return R()(C,I=>{let x=null==I?void 0:I.uid;"0"!==x&&E.push(x)}),this.allFriendsList=E,C}async setFollowUserAsync(I){let x=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return(0,V.P_)(I,x)}async setUserBlockAsync(I,x,C,E){return(0,V.Ox)(I,x,C,E)}async pushNewMsgInList(I,x){var C,E,M;if(!I||!this.isLogin||this.showDlg||!this.canShowImPush)return;let{conversationId:S,type:T,createdAt:R}=I;if((0,ee.FH)(T)||new Date(R).getTime()+6e4<Date.now())return;let{conversationInfoMap:w}=this,O=null==w?void 0:w[S];if(O||(await (0,K.Z)(1500),O=x(S)),null==O?void 0:null===(C=O.settingInfo)||void 0===C?void 0:C.mute)return;let A=((null===(E=this.msgListToPush)||void 0===E?void 0:E.length)||0)-1,N=null===(M=this.msgListToPush)||void 0===M?void 0:M[A],P=null==N?void 0:N.conversationId;P&&P===S?this.msgListToPush.splice(A,1,I):(this.msgListToPush=this.msgListToPush||[],this.msgListToPush.push(I))}setDownloadInfo(I){this.downloadInfo=I}constructor(){var I=this;en(this,"theme",Y.rS.light),en(this,"curUserInfo",{}),en(this,"abTestData",{}),en(this,"isLogin",!1),en(this,"showDlg",!1),en(this,"isShareCollapse",!0),en(this,"audioMd5",""),en(this,"converSationListOrigin",[]),en(this,"conversationPullUpPriority",{}),en(this,"conversationMap",{}),en(this,"isInStrangerConversationList",!1),en(this,"curConversation",null),en(this,"strangerBoxCover",null),en(this,"enterConversation",Y.eY.CHAT_NOTIFY),en(this,"messageList",[]),en(this,"curMsgOptPopId",""),en(this,"curGroupUserIdList",[]),en(this,"conversationUserids",{}),en(this,"uidSecUidMap",{}),en(this,"userInfoFromSdkMap",{}),en(this,"userInfoFromServerMap",{}),en(this,"unSendMsgConversationMap",{}),en(this,"serverIdMessageMap",{}),en(this,"emojiMap",{}),en(this,"emojiList",[]),en(this,"emojiGifList",[]),en(this,"customEmojiList",[]),en(this,"recentEmojiList",[]),en(this,"recentGifList",[]),en(this,"showSugEmoji",!0),en(this,"interactiveEmojiList",[]),en(this,"allFriendsList",[]),en(this,"userInfoForShareMap",{}),en(this,"msgListToPush",[]),en(this,"awemeInfo",{}),en(this,"shareType",ei.yw.Video),en(this,"shareUserInfo",{}),en(this,"shareCommentInfo",{}),en(this,"shareLiveInfo",{}),en(this,"shareeListHeight",0),en(this,"shareMap",{}),en(this,"replayMessageServerId",null),en(this,"clientTrayGuidInfo",null),en(this,"strangerMessageUnreadCount",0),en(this,"isStrangerConversation",!1),en(this,"shareStatusHandler",{handleCollapse:()=>{},handleExpand:()=>{}}),en(this,"hasJoinGroupObj",{conversation:[],cursor:"0",hasMore:!0,loading:!1}),en(this,"strangerConverListObj",{conversation:[],cursor:"0",hasMore:!0,loading:!1,unreadCount:0}),en(this,"canShowImPush",!0),en(this,"userFollowStatusMap",{}),en(this,"selectChatUserShortId",""),en(this,"isOpenMessageListn(this,"maskIsExitConversation",!1),en(this,"changeConversationItemStatus",!1),en(this,"saveStrageConversaionInfo",{list:[],index:-1}),en(this,"isShowGetConversaionListLoading",!0),en(this,"isReportOpen",!1),en(this,"selectedMessage",new Set),en(this,"downloadInfo",{showDownload:!1}),en(this,"setSelectChatUserShortId",function(){let x=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";I.selectCMessageList",I=>{(0,et.Gb)("click_fold_im",{is_fold:Number(!I)}),this.isOpenMessageList=I}),en(this,"setMaskIsTestGroupClickConversionListItem",I=>{this.maskIsTestGroupClickConversionListItem=I}),en(this,"setMaskConversaionAnimationEnd",function(){let[0]||arguments[0];I.maskConversaionAnimationEnd=!!x}),en(this,"setMaskIsExitConversation",()=>{this.maskIsExitConversation=!0}),en(this,"setChangeConversationItemStatus",I=>{this.changeConversationItemStatus=I}),en(this,"setSaveStrageConversaionInfo",I=>{this.saveStrageConversaionInfo=(0,E._)({},this.saveStrageConversaionInfo,I)}),en(this,"setIsShowGetConversaionListLoading",I=>{this.isShowGetConversaionListLoading=I}),en(this,"updateSelectedMessage",(I,x)=>{x?this.selectedMessage.add(I):this.selectedMessage.delete(I)}),(0,S.ky)(this,{theme:S.LO,curUserInfo:S.LO,abTestData:S.LO.shallow,isLogin:S.LO,showDlg:S.LO,isShareCollapse:S.LO,audioMd5:S.LO,converSationListOrigin:S.LO,conversationPullUpPriority:S.LO,curConversation:S.LO,enterConversation:S.LO,messageList:S.LO,curMsgOptPopId:S.LO,curGroupUserIdList:S.LO,conversationUserids:S.LO,uidSecUidMap:S.LO,userInfoFromSdkMap:S.LO,userInfoFromServerMap:S.LO,userInfoForShareMap:S.LO,unSendMsgConversationMap:S.LO,serverIdMessageMap:S.LO,emojiMap:S.LO,emojiList:S.LO,emojiGifList:S.LO,allFriendsList:S.LO,msgListToPush:S.LO,awemeInfo:S.LO,shareMap:S.LO,replayMessageServerId:S.LO,shareStatusHandler:S.LO,hasJoinGroupObj:S.LO,isInStrangerConversationList:S.LO,strangerBoxCover:S.LO,strangerMessageUnreadCount:S.LO,conversationMap:S.LO,strangerConverListObj:S.LO,isStrangerConversation:S.LO,canShowImPush:S.LO,userFollowStatusMap:S.LO,selectChatUserShortId:S.LO,isOpenMessageList:S.LO,maskIsTestGroupClickConversionListItem:S.LO,maskConversaionAnimationEnd:S.LO,maskIsExitConversation:S.LO,changeConversationItemStatus:S.LO,saveStrageConversaionInfo:S.LO,isShowGetConversaionListLoading:S.LO,isReportOpen:S.LO,selectedMessage:S.LO,conversationListFilter:S.Fl,allUnReadCount:S.Fl,allGroupList:S.Fl,conversationInfoMap:S.Fl,allFriendInfoList:S.Fl,usersInConversationList:S.Fl,strongNoticeList:S.Fl,converListWithStrangerBox:S.Fl,stickOnTopCount:S.Fl,videoMsgList:S.Fl,setIsLogin:S.aD,setDlgShow:S.aD,setShareCollapse:S.aD,setCurShareType:S.aD,setCurAwemeInfo:S.aD,setCurShareUserInfo:S.aD,setCurShareCommentInfo:S.aD,setCurShareLiveInfo:S.aD,setShareeListHeight:S.aD,setShareMap:S.aD,setShareStatusHandler:S.aD,resetData:S.aD,setAudioMd5:S.aD,setConverSationList:S.aD,setCurConverSation:S.aD,setCurMessageList:S.aD,setConversationPullUp:S.aD,setCurMsgOptPopId:S.aD,setCurGroupUserIdList:S.aD,setConversationUserids:S.aD,setUserInfoFromSdkMap:S.aD,setUserInfoFromServerMap:S.aD,setUserInfoForShareMap:S.aD,setUnSendMsgConversation:S.aD,clearOldMsgListToPush:S.aD,closeMsgPushPop:S.aD,setUserInfoBlockStatus:S.aD,setReplayMessageServerId:S.aD,setClientTrayGuidClientId:S.aD,clearClientTrayGuidClientId:S.aD,setHasJoinGroup:S.aD,setIsInStrangerConversationList:S.aD,setStrangerBoxCover:S.aD,setStrangerMessageUnreadCount:S.aD,setConversationMap:S.aD,setStrangerConverListObj:S.aD,setIsStrangerConversation:S.aD,setCanShowImPush:S.aD,setUserFollowStatusMap:S.aD,setSelectChatUserShortId:S.aD,setIsOpenMessageList:S.aD,setMaskIsTestGroupClickConversionListItem:S.aD,setMaskConversaionAnimationEnd:S.aD,setMaskIsExitCo.aD,setChangeConversationItemStatus:S.aD,setSaveStrageConversaionInfo:S.aD,setIsShowGetConversaionListLoading:S.aD,setDownloadInfo:S.aD,getUserInfoMapAsync:S.aD,getShareUserListAsync:S.aD,getEmojiGifListAsync:S.aD,pushNewMsgInList:S.aD})}}var el=new ed},38879:function(I,x,C){"use strict";C.d(x,{F:function(){return E}}),C(31500);let E=I=>{let x="function"==typeof I?I():I;return(null==x?void 0:x.then)?x.then(I=>[null,I]).catch(I=>[I||Error("err"),void 0]):[Error("not promise or function"),void 0]};x.Z=E},44001:function(I,x,C){"use strict";C.d(x,{p:function(){return R}}),C(19858);var E=C(28510),M=C(38879),S=C(31545),T=C(36915);let R=async I=>{if(!I)return T.$u.FollowRelationUnknown;let{uidSecUidMap:x,userFollowStatusMap:C}=S.default;if((null==C?void 0:C[I])||(null==C?void 0:C[I])===0)return null==C?void 0:C[I];let R=(null==x?void 0:x[I])||"";if(R){let[x,C]=await (0,M.Z)((0,E.RK)(R));if(x)return T.$u.FollowRelationUnknown;if(C){var w,O;let x=null!==(O=null==C?void 0:C.follow_status)&&void 0!==O?O:T.$u.FollowRelationUnknown;return null===(w=S.default.setUserFollowStatusMap)||void 0===w||w.call(S.default,I,x),x}}return T.$u.FollowRelationUnknown}},20881:function(I,x,C){"use strict";C.r(x),C.d(x,{IM_EVENT_NAMES:function(){return nX},ImSdk:function(){return n2}});var E,M,S,T,R,w,O,A,N,P,L,D,U,B,G,V,F,H,W=C(81476),q=C(93650);C(31500),C(19858),C(6418),C(57664),C(2071),C(31538),C(3156),C(66964),C(19232),C(99928),C(25511),C(5914);var K=C(73217),Y=C(53251),z=C.n(Y),Z=C(46986);let J={appId:0,token:"",deviceId:"",userId:"",biz:"",apiUrl:"",frontierUrl:"",fpId:89,appKey:"e0f82475ab9dbf5717d18b4a9c0d7fd0",service:2,method:1,authType:K.im_proto.AuthType.TOKEN_AUTH,inboxType:[0],headers:{},httpHeaders:{},devicePlatform:"web",timeout:2e3,pullInterval:3e4,throttle:100,triggerStrategy:{[Z.c5.ConversationChange]:Z.zn.Debounce,[Z.c5.MessageUpsert]:Z.zn.Debounce,[Z.c5.ConversationUpsert]:Z.zn.ThrottleWithArgs},maxMessageCount:1e3,enableServerConfig:!1};function X(I,x,C){for(let E of Object.keys(C))"string"!=typeof C[E]&&e_.ctxError(I,`${x}[${E}] is not a string!`)}function Q(I,x){"number"!=typeof x.appId&&e_.ctxError(I,"opt.appId is not a number! did you pass a string?"),"string"!=typeof x.deviceId&&e_.ctxError(I,"opt.deviceId is not a string! did you pass a number?"),"string"!=typeof x.userId&&e_.ctxError(I,"opt.userId is not a string! did you pass a number?"),("string"!=typeof x.apiUrl||0===x.length)&&e_.ctxError(I,"opt.apiUrl invalid"),("string"!=typeof x.frontierUrl||0===x.frontierUrl.length)&&e_.ctxError(I,"opt.frontierUrl invalid"),"object"==typeof x.headers&&X(I,"opt.headers",x.headers),"object"==typeof x.httpHeaders&&X(I,"opt.httpHeaders",x.httpHeaders),"object"==typeof x.monitorTagKv&&X(I,"opt.monitorTagKv",x.monitorTagKv),(Array.isArray(x.inboxType)&&(0===x.inboxType.length||x.inboxType.some(I=>I<0))||"number"==typeof x.inboxType&&x.inboxType<0)&&e_.ctxError(I,"opt.inboxType invalid"),"number"==typerval",I.conversationMsgRepairStart="conversationMsgRepairStart",I.conversationMsgRepairCount="conversationMsgRepairCount",I.conversationMsgRepairRatio="conversationMsgRepairRatio",I.UnreadCountReport="UnreadCountReport",I.autoPollingMsgEnabled="autoPollingMsgEnabled",I.triggerPollingMsgEnabled="triggerPollingMsgEnabled",I.defaultPollingMsgInterval="defaultPollingMsgInterval",I.unmuteWhiteUidsLen="unmuteWhiteUidsLen"}(E||(E={}));let ei=[[E.conversationMsgRepairCount,100],[E.conversationMsgRepairInterval,864e5]],en=[];for(let I=0;I<256;++I)en[I]=(I+256).toString(16).substr(1);fu"hybridLink",I.Exten,I.BroaimediaApi",I.SharkPlugin="sharkPlugin",I.StoragePlugin="storagePlugin",I.StorageApi="storageApi",I.StrangerPlugin="strangerPlugin",I.StrangerApi="strangerApi"}(M||(M={}));class el{constructor(){this.services=new Map,this.plugins=new Map}register(I,x,C){this.seervices.get(I).set(x,C)}resolve(I,x){var C;return null===(C=this.services.get(I))||void 0===C?void 0:size}}el.Instance=new el;class ec{constructor(="",this.id="",this.config=new Map(ei),this.id=ed()}get plugin(){var I;returhis.id,I)}register(I,x){let C=x;return"function"==typeof x&&(C=new x(this)),el.Instance.register(this.id,I,C),C}resolve(I){return el.Instance.resolve(this.id,I)}}class eu{constructor(I){this.__internal_ctx=I}get ctx(){return this.getContext()}bindContext(I){this.__internal_ctx=I}getContentext().resolve(I)}register(I,x){return this.getContext().register(I,x)}}!function(I){I[I.debug=0]="debug",I[I.info=1]="info",I[I.warn=2]="warn",I[I.error=3]="error",I[I.none=4]="none"}(S||(S={}));let ev={[S.info]:"#1890ff",[S.debug]:"#19be6b",[S.warn]:"#ff9900",[S.error]:"#ed4014"},eh={debug:S.debug,info:S.info,warn:S.warn,error:S.error,none:S.none};class e_{static get isBrowser(){return"undefined"!=typeof navigator}static log(I,x,...C){x&&x.resolve(M.Monitor).emitLog(eh[I],C),(null==x?void 0:x.option.debug)&&"none"!==I&&this.level<=S[I]&&(x&&el.Instance.instanceCount>1?e_.isBrowser?console[I](`%c [Byted IM SDK][${x.id}] [${I}]:`,`color: ${ev[S[I]]}; font-weight: 700`,...C):console[I](`[Byted IM SDK][${x.id}] [${I}]:`,...C):e_.isBrowser?console[I](`%c [Byted IM SDK] [${I}]:`,`e[I](`[Byted IM SDK] [${I}]:`,...C))}static debug(...I){this.log("debug",void 0,...I)}static info(...I){this.log("info",void 0,...I)}static warn(...I){this.log("warn",void 0,...I)}static error(...I){this.log("error",void 0,...I)}static ctxDebug(I,...x){this.log("debug",I,...x)}static ctxInfo(I,...x){this.log("info",I,...x)}static ctxWarn(I,...x){this.log("warn",I,...x)}static ctxError(I,...x){this.log("error",I,...x)}}e_.level=S.debug;var ep=C(54),eg=C(6770),ef=C.n(eg);class em{constructor(I){this.errorTypeBlacklist=[Z.NI.NetworkError],this.slardar=I}emitError(I,x){"function"==typeof this.slardar.captureException&&(this.errorTypeBlacklist.includes(I.type)||this.slardar.capObject.assign(Object.assign({},x),{type:`${I.type}:${Z.NI[I.type]}`,msg:I.msg,logid:I.logid,a&&this.slardar.sendLog({levConnectFirst="ws.connect.first",I.WebSocketConnectnnect.noheartbeat",I.BizApiInvoke="api.invoke",I.MessageAck="message.ack",I.SuccessSuffix=".success",I.ErrorSuffix=".error",In="refresh.token",I.BizSdkError="error",I.GetMessagesByConversation="message.get.byconversation",I.GetMessagesByTicker="message.get.ticker"}(T||(T={}));class ey extends eu{static get avgDelta(){return 0===this.putDeltaTimes?0:this.totalDelta/this.putDeltaTimes}static putTimeDelta(I,x,C,E){if(void 0===C||void 0===E)return;let M=(x-I-(C-E))/2+I,S=E-M;ey.putDeltaTimes++,ey.totalDelta+=S}get avgDelta(){return ey.avgDelta}static performanceNow(){return"object"==typeof performance&&"function"==typeof performance.now&&"number"==typeof performance.timeOrigin?performance.now()+performance.timeOrigin:Date.now()}invoke(I,...x){if(void 0===this.ctx.option.monitor)return!1;let C=this.ctx.option.monitor;Array.isArray(C)||(C=[C]),C.forEach(C=>{let E=C[I];return"function"==typeof E&&setTimeout(()=>{E.apply(C,x)},0)})}fillKv(I){let x=Object.assign(Object.assign(Object.assign({},I),this.ctx.option.monitorTagKv),{sdk_version:Z.HF.sdkVersion,sdk_type:this.ctx.option.sdkType||"im-web-sdk",build_number:Z.HF.buildNumber,app_id:this.ctx.option.appId.toString(),user_id:this.ctx.option.userId});return this.ctx.option.versionCode&&(x.version_code=this.ctx.option.versionCode),x}emitMetrics(I,x={},C={}){let E=`imsdk.${I}`;this.invoke("emitMetrics",E,x,this.fillKv(C))}emitCounter(I,x=1,C={}){if(0===x)return;let E=`imsdk.${I}`;this.invoke("emitMetrics",E,{count:x},this.fillKv(C))}emitDumsdk.${I}`;return this.invoke("emitMetrics",M,{duration:let E=this.ctx.option.timeCalibration?this.avgDelta:0,M=ey.performanceNow()+E-x;M<0||this.invoke("emitMetrics",I,{duration:M},this.fillKv(C))}emitError(I){this.invoke("emitError",I,this.fillKv({}))}emitNetwork(I,x,C={}){this.invoke("emitNetwork",I,x,this.fillKv(C))}emitEvent(I,x,C){this.invoke("emitEvent",I,x,C)}emitLog(I,...x){this.invoke("emitLog",I,x[0])}emitTracker(I,x){this.invoke("emitTracker",I,this.fillKv(x))}}ey.putDeltaTimes=0,ey.totalDelta=0;class eI{constructor(I=[],x){this.metricsToReport=[],this.sampleRate={},this.call=I=>{if(!icsToReport.includes(I))return!1;let x=this.sampleRate[I],C=this.sampleRate[eI.globalSampleRate],E=Math.random(n void 0!==x?E<x:void 0===C||E<C},this.metricsToReport=I,x&&(this.sampleRate=x)}}function ex(I){return(I.startsWith("imsdk")?I:`imsdk_${I}`).replace(/\./g,"_")}eI.globalSampleRate="__globalSampleRate";let eC=[T.CreateConversation,T.SendMessage,T.ReceiveMessage,T.WsConnect,T.Netw(I=>ex(I)),eE={[ex(.05,[eI.globass eM{constructor(I,x){var C,E;this.sampleCallback=()=>!0,this.collector=I,(null==x?void 0:x.sampleCallback)?this.sampleCallback=x.sampleCallback:this.sampleCallback=new eI(null!==(C=null==x?void 0:x.metricsToReport)&&void 0!==C?C:eC,null!==(E=null==x?void 0:x.sampleRate)&&void 0!==E?E:eE).call}emitCounter(I,x,C){}emitDuration(I,x,C){}emitError(I){}emitNetwork(I,x,C){}emitEvent(I,x,C){}emitLog(I,x){}emitTracker(I,x){}emitMetrics(I,x,C){var E;let M=ex(I);(null===(E=this.sampleCallback)||void 0===E?void 0:E.call(this,M))&&this.collector.event(M,Object.assign(Object.assign({},x),C))}}eM.globalSampleRate=eI.globalSampleRate;var eb=C(18154);class eS extends Error{constructor(I){var x,C,E,S;super(`${I&&I.logid?`[${I.logid}] `:""}${I&&I.msg?'message: "'+I.msg+'"':""}${I&&I.innerError?`, inner error: "${I.innerError}"`:""}`),this.ctx=I.ctx,Object.assign(this,I),Object.setPrototypeOf(this,eS.prototype),(null===(x=this.innerError)||void 0===x?void 0:x.logid)&&(this.logid=this.innerError.logid);try{"string"==typeof(null===(C=this.innerError)||void 0===C?void 0:C.stack)&&(this.stack=this.innerError.stack+"\n"+(null===(E=this.stack)||void 0===E?void 0:E.split("\n").slice(2).join("\n")))}catch(I){e_.ctxWarn(this.ctx,`concat trace fail=${I}, current stack=${this.stack}, inner stack=${null===(S=this.innerError)||void 0===S?void 0:S.stack}`)}if(!this.ctx)return;I.ignoreEvent||this.resolve(M.EventBus).emit(Z.c5.Error,I.sender,this),this.resolve(M.Monitor).emitError(this),this.resolve(M.Monitor).emitCounter(T.BizSdkError,1,{type:I.type?`${I.type}:${Z.NI[I.type]}`:"unknown"})}getContext(){return this.ctx}resolve(I){return this.ctx.resolve(I)}}class eT extends eu{constructor(I,x){var C,E;super(I.ctx),this.version=Y.ZERO,this.parent=I,void 0!==x&&(this.desc=x.desc,this.ext=x.ext,this.icon=x.icon,this.name=x.name,this.notice=x.notice,this.owner=null!==(E=null===(C=x.owner)||void 0===C?void 0:C.toString())&&void 0!==E?E:"",this.version=x.info_version,this.secOwner=x.sec_owner,this.inboxType=x.inbox_type),void 0===this.inboxType&&(this.inboxType=this.resolve(M.InboxType).getDefaultInboxWithoutCheck())}get conversationId(){return this.parent.id}get ext(){return this.innerExt||(this.innerExt={}),this.innerExt}set ext(I){this.innerExt=null!=I?I:{}}mergeCore(I){return I.version.lt(this.version)?e_.ctxDebug(this.ctx,"core info version local > online, local: ",this.version.toString(),"new: ",I.version.toString()):I.conversationId!==this.conversationId?e_.ctxDebug(this.ctx,"core info conversation not match, local:",this.conversationId.toString(),"new: ",I.conversationId.toString()):(this.version=I.version,this.name=I.name,this.desc=I.desc,this.icon=I.icon,this.notice=I.notice,this.owner=I.owner,this.secOwner=I.owner,this.innerExt=Object.assign(Object.assign({},this.innerExt),I.innerExt),this.inboxType=I.inboxType),this}}class eR extends eu{constructor(I,x){var C,E;super(I.ctx),this.version=Y.ZERO,this._pushStatus=Z.Bs.Allow,this.minIndex=Y.ZERO,this._readIndex=Y.ZERO,this._readIndexV2=Y.ZERO,this._readBadgeCount=0,this.muteReadBadgeCountInfos=[],this.parent=I,void 0!==x&&(this.ext=x.ext,this.favor=x.favorite,this.mute=x.mute,this.stickTop=x.stick_on_top,this.version=Y.fromValue(null!==(C=x.setting_version)&&void 0!==C?C:Y.ZERO),this.readIndex=x.read_index,this.readIndexV2=x.read_index_v2,this.minIndex=x.min_index,this.setFavoriteTime=x.set_favorite_time,this.setTopTime=x.set_top_time,this.pushStatus=x.push_status,this.readBadgeCount=x.read_badge_count,this.mergeMuteReadBadgeCountInfos(null!==(E=x.mute_read_badge_count_infos)&&void 0!==E?E:[]))}get conversationId(){return this.parent.id}get pushStatus(){return this._pushStatus}set pushStatus(I){[Z.Bs.Allow,Z.Bs.PartAllow,Z.Bs.Disable].includes(I)?this._pushStatus=I:this._pushStatus=Z.Bs.Unknown}get readIndex(){return this._readIndex}set readIndex(I){if(void 0===I)return;let x=Y.fromValue(I);if(void 0===this._readIndex){this._readIndex=x;return}x.gt(this._readIndex)&&(this._readIndex=x)}get readIndexV2(){return this._readIndexV2}set readIndexV2(I){if(void 0===I)return;let x=Y.fromValue(I);if(void 0===this._readIndexV2){this._readIndexV2=x;return}x.gt(this._readIndex)&&(this._readIndexV2=x)}get readBadgeCount(){return this._readBadgeCount}set readBadgeCount(I){if(void 0!==I){if(this.parent.badgeCount&&I>this.parent.badgeCount&&(I=this.parent.badgeCount),void 0===this._readBadgeCount){this._readBadgeCount=I;return}I>this._readBadgeCount&&(this._readBadgeCount=I)}}mergeMuteReadBadgeCountInfos(I){I&&I.forEach(I=>{let x=this.muteReadBadgeCountInfos.fadgeCountInfos.push(I)})}get partMuteReadBadgeCount(){var I,x,C,E;return null!==(E=null===(C=null===(x=null===(I=this.muteReadBadgeCountInfos)||void 0===I?void 0:I.find)||void 0===x?void 0:x.call(I,I=>I.message_type===K.im_proto.MuteMessageType.TYPE_PART_MUTE))||void 0===C?void 0:C.read_badge_count)&&void 0!==E?E:0}get ext(){return this.innerExt||(this.innerExt={}),this.innerExt}set ext(I){this.innerExt=null!=I?I:{}}mergeSetting(I){return I.version.lt(this.version)?e_.ctxDebug(this.ctx,"setting info version local > online, local: ",this.version.toString(),"new: ",I.version.toString()):I.conversationId!==this.conversationId?e_.ctxDebug(this.ctx,"setting info conversation not match, local:",this.conversationId.toString(),"new: ",I.conversationId.toString()):(this.stickTop=I.stickTop,this.setTopTime=I.setTopTime,this.mute=I.mute,this.favor=I.favor,this.setFavoriteTime=I.setFavoriteTime,this.innerExt=Object.assign(Object.assign({},this.innerExt),I.ext),this.readIndex=I.readIndex,this.readIndexV2=I.readIndexV2,this.minIndex=I.minIndex,this.version=I.version,this.pushStatus=I.pushStatus,this.readBadgeCount=I.readBadgeCount,this.mergeMuteReadBadgeCountInfos(I.muteReadBadgeCountInfos)),this}get weakMuteInfo(){var I,x,C;let E={whiteUids:[],whiteMsgTypes:[]};if(!this.innerExt[Z.v9.PushPartDisableConfig])return E;try{let E=ep.parse(this.innerExt[Z.v9.PushPartDisableConfig]),M=null==E?void 0:E[Z.O9],S=null!==(x=null===(I=null==M?void 0:M.white_uids)||void 0===I?void 0:I.map(Y.fromValue))&&void 0!==x?x:[],T=null!==(C=null==M?void 0:M.white_msg_types)&&void 0!==C?C:[];return{whiteUids:S,whiteMsgTypes:T}}catch(I){return e_.ctxWarn(this.ctx,"conversation setting weak mute info parse error: ",I),E}}}var ew=C(6748),eO=C.n(ew);function ek(I,x){return I.length>x?[I.slice(0,x),...ek(I.slice(x),x)]:[I]}function eA(I,x){let C={};for(let E of I){let I=x(E);void 0===C[I]&&(C[I]=[]),C[I].push(E)}return C}function eN(I,x){return Array.isArray(I)?I:void 0!==I?[I]:void 0!==x?[x]:[]}function eP(I){return Y.fromNumber(I.charCodeAt(0)).add(Y.fromNumber(I.charCodeAt(1)).shiftLeft(8)).add(Y.fromNumber(I.charCodeAt(2)).shiftLeft(16)).add(Y.fromNumber(I.charCodeAt(3)).shiftLeft(24)).add(Y.fromNumber(I.charCodeAt(4)).shiftLeft(32)).add(Y.fromNumber(I.charCodeAt(5)).shid(Y.fromNumber(I.charCodeAt(7)).shiftLeft(56))}function eL(I,x){return void 0!==I&&void 0!==x&&("true"===I[x]||"1"===I[x])}class eD extends eu{constructor(){super(...arguments),this.isMember=!0,this._badgeCount=0,this.muteBadgeCountInfos=[],this.__internal_pullCursor=Y.MAX_VALUE,this.cacheUnreadCountCalc=void 0,this.cacheUnreadCountWithWhiteListCalc=void 0}get type(){return 15&this.bizType}set type(I){this.bizType=I}get inboxType(){return this.coreInfo.inboxType}mergeMuteBadgeCountInfos(I){I&&I.forEach(I=>{let x=this.muteBadgeCountInfos.findIndex(x=>x.message_type===IgeCountInfos.push(I)})}get badgeCount(){return this._badgeCount}set badgnt){this._badgeCount=I;return}I>this._badgeCount&&(this._badgeCount=I)}}get partMuteBadgeCount(){var I,x,C,E;return null!==(E=null===(C=null===(x=null===(I=>I.message_type===K.im_proto.MuteMessageType.TYPE_PART_MUTE))||void 0===C?void 0:C.badge_count)&&void 0!==E?E:0}get mode(){return 0}get isStrangerConversation(){return 0!==this.mode}get isMuted(){return this.pushStatus!==Z.Bs.Unknown?this.pushStatus===Z.Bs.Disable:void 0!==this.settingInfo&&this.settingInfo.mute===Z.I7.On}get pushStatus(){var I;return null!==(I=this.settingInfo.pushStatus)&&void 0!==I?I:Z.Bs.Unknown}get weakMuteInfo(){return this.settingInfo.weakMuteInfo}get isStickOnTop(){return void 0!==this.settingInfo&&this.settingInfo.stickTop===Z.uX.On}get isFavorite(){return void 0!==this.settingInfo&&this.settingInfo.favor===Z.Lk.On}get ext(){let I={};return this.coreInfo&&this.coreInfo.ext&&(I=Object.assign(I,this.coreInfo.ext)),this.settingInfo&&this.sett(){var I,x,C,E,M;return this.isStickOnTop?(null!==(I=this.setTopTime)&&void 0!==I?I:Y.ZERO).add(8e15).toNumber():null!==(M=null===(E=null===(C=null===(x=this.lastPopVisibleMessage)||void 0===x?void 0:x.createdAt)||void 0===C?void 0:C.getTime)||void 0===E?void 0:E.call(C))&&void 0!==M?M:-1}get lastMessage(){return this.filterLastMessage()}get lastVisibleMessage(){return this.filterLastMessage(I=>I.visible)}get lastPopVisibleMessage(){return this.filterLastMessage(I=>!I.unpop)}get firstMessage(){return this.filterFirstMessage()}get readIndex(){return this.settingInfo.readIndex}get readIndexV2(){return this.settingInfo.readIndexV2}get minIndex(){return this.settingInfo.minIndex}get version(){return this.coreInfo.version}get unreadCount(){return this.ctx.option.useBadgeCountForUnread&&this.settingInfo.readBadgeCount?this.unreadCountFromReadBadge:this.unreadCountFromReadIndex}get unreadCountFromReadBadge(){return Math.max(this.badgeCount-this.settingInfo.readBadgeCount,0)}get unreadCountFromReadIndex(){var I,x,C;return void 0===this.cacheUnreadCountCalc&&(this.cacheUnreadCountCalc=eO()(I=>this.unreadMessageList.length,{maxSize:1})),this.cacheUnreadCountCalc(`${null===(x=null===(I=this.updatedAt)||void 0===I?void 0:I.getTime)||void 0===x?void 0:x.call(I)}:${null===(C=this.readIndex)||void 0===C?void 0:C.toString()}`)}get unreadCountWithWhiteList(){return this.ctx.option.useBadgeCogeCount?this.unreadCountWithWhiteListFromReadBadge:this.unreadCountWithWhiteListFromReadIndex}get unreadCountWithWhiteListFromReadBadge(){return Math.max(this.partMuteBadgeCount-this.settingInfo.partMuteReadBadgeCount,0)}get unreadCountWithWhiteListFromReadIndex(){var I,x,C;return void 0===this.cacheUnreadCountWithWhiteListCalc&&(this.cacheUnreadCountWithWhiteListCalc=eO()(I=>this.unreadMessageListWithWhiteList.length,{maxSize:1})),this.cacheUnreadCountWithWhiteListCalc(`${null===(x=null===(I=this.updatedAt)||void 0===I?void 0:I.getTime)||void 0===x?void 0:x.call(I)}:${null===(C=this.readIndex)||void 0===C?void 0:C.toString()}`)}forceRefreshUnreadCount(){var I;let x=this.unreadMessageList.length;x!==this.unreadCount&&vo unread count: ${this.id}, value: ${x}`),null===(I=this.cacheUnreadCountCalc)||void 0===I||I.clear())}get unreadMessageList(){return this.readIndex?this.resolve(M.MessageManager).I.indexInConversation.gt(this.readIndex)&&I.indexInConversation.gt(this.minIndex)&&I.):[]}get unreadMessageListWithWhiteList(){return this.unreadMessageList.filter(I=>this.isMsgInWeakMuteWhiteList(I))}isMsgInWeakMuteWhiteList(I){var x,C,E;return(null===(x=I.ext)||void 0===x?void 0:x[Z.v9.MustNotify])||(null===(C=this.settingInfo.weakMuteInfo.whiteUids)||void 0===C?void 0:C.find(x=>x.toString()===I.sender))||(null===(E=this.settingInfo.weakMuteInfo.whiteMsgTypes)||void 0===E?void 0:E.find(x=>x===I.type))}getLocalMessageRangeList(I,x){return this.resolve(M.MessageManager).getList(this.id).filter(C=>C.indexInConversation.lte(x)&&C.indexInConversation.gt(I)&&C.indexInConversation.gt(this.minIndex)&&C.increaseUnread)}get updatedAt(){return this.lastMessage?this.lastMessage.createdAt:new Date(0)}get firstMessageIndex(){var I,x;return null!==(x=null===(I=this.filterFirstMessage(I=>I.indexInConversation&&I.indexInConversation.gt(0)))||void 0===I?void 0:I.indexInConversation)&&void 0!==x?x:Y.ZERO}get lastMessageIndex(){var I,x;return null!==(x=null===(I=this.onversation.gt(0)))||void 0===I?void 0:I.indexInConversation)&&void 0!==x?x:Y.ZERO}get lastMessageIndexV2(){var I,x;return null!==(x=null===(I=this.filterLastMessage(I=>I.indexInConversation&&I.indexInConversation.gt(0)))||void 0===I?void 0:I.indexInConversationV2)&&void 0!==x?x:Y.ZERO}get lastMessageOrder(){var I,x;return null!==(x=null===(I=this.filterLastMessage(I=>I.orderInConversation&&I.orderInConversation.gt(0)))||void 0===I?void 0:I.orderInConversation)&&void 0!==x?x:Y.ZERO}getMessageList(I=I=>I.visible){return this.resolve(M.MessageManager).getList(this.id).filter(I)}getParticipantList(){return this.resolve(M.ParticipantManager).get(this.id)}get toParticipantUserId(){if(this.type===K.im_proto.ConversationType.GROUP_CHAT)return;let I=this.id.split(":");return I[2]===this.ctx.option.userId?I[3]:I[2]}get isBlocked(){return eL(this.ext,Z.v9.RelationIsMuted)}get isServerBlocked(){return eL(this.ext,Z.v9.RelationIsMutedServer)}get isBlockNormalOnly(){return this.isBlocked&&eL(this.ext,Z.v9.RelationNormalOnly)}get tagIds(){let I=this.ext[Z.v9.ConversationTags]||"";return""===I?[]:I.split(",")}get userTagIds(){let I=this.ext[Z.v9.UserCustomConversationTags]||"";return""===I?[]:I.split(",")}static fromServerConversation(I,x,C){var E;let M=new eD(I);M.id=x.conversation_id,M.shortId=x.conversation_short_id.toString(),M.type=x.conversation_type,M.ticket=x.ticket,M.participantCount=x.participants_count,M.isMember=x.is_participant,M.isOffline=!1,M.firstPageParticipant=x.first_page_participants,M.badgeCount=x.badge_count,M.muteBadgeCountInfos=null!==(E=x.mute_badge_count_infos)&&void 0!==E?E:[],M.coreInfo=new eT(M,x.conversation_core_info),M.settingInfo=new eR(M,x.conversation_setting_info);let S=Object.keys(M.coreInfo.ext);for(let I of Object.keys(M.settingInfo.ext))S.includes(I)&&e_.ctxDebug(M.ctx,`conversation: ${M.shortId} ext duplicate key: ${I}`);return void 0!==C&&M.ctx.option.debug&&(M.coreInfo.ext[Z.v9.LocalLogId]=C),M}filterLastMessage(I){let x=this.getMessageList(()=>!0),C=null;if(0===x.length)return null;if(void 0===I)return x[x.length-1];for(let E=x.length-1;E>=0;E--)if(I(x[E])){C=x[E];break}return C}filterFirstMessage(I){let x=this.getMessageList(()=>!0),C=null;if(0===x.length)return null;if(void 0===I)return x[0];for(let E of x)if(I(E)){C=E;break}return C}}!function(I){I[I.Sending=0]="Sending",I[I.Success=1]="Success",I[I.Failed=2]="Failed"}(R||(R={}));class eU extends eu{constructor(){super(...arguments),this.indexInConversation=Y.ZERO,this.indexInConversationV2=Y.ZERO,this.orderInConversation=Y.ZERO,this.property={},this.source=Z.v$.Unknown}get conversationType(){return 15&this.conversationBizType}set conversationType(I){this.conversationBizType=I}get clientId(){var I;return this.ext&&null!==(I=this.ext[Z.v9.ClientMessageId])&&void 0!==I?I:""}set clientId(I){this.ext||(this.ext={}),this.ext[Z.v9.ClientMessageId]=I}static createClientMessage(I,x){var C;let E=new eU(I);E.conversationId=x.conversationId,E.type=x.type,E.conversationType=x.conversationType,E.conversationShortId=x.conversationShortId,E.sender=I.option.userId,E.content=x.content,E.createdAt=new Date(Date.now());let M=Object.assign({},x.ext);for(let I of Object.keys(M))I.startsWith("s:")&&(e_.ctxDebug(E.ctx,`delete s: prefix ext key: '${I}: ${M[I]}'`),delete M[I]);if(E.ext=M,E.mentionedUsers=x.mentionedUsers,E.clientId=x.id,E.version=Y.ZERO,E.serverStatus=Z.P6.Enable,E.isOffline=!0,x.referenceMessage){let I=K.im_proto.MessageStatus.AVAILABLE;x.referenceMessage.isRecalled?I=K.im_proto.MessageStatus.RECALLED:x.referenceMessage.visible||(I=K.im_proto.MessageStatus.INVISIBLE),E.referenceInfo={referenced_message_id:Y.fromValue(x.referenceMessage.serverId),hint:null!==(C=x.referenceHint)&&void 0!==C?C:"",ref_message_type:Y.fromValue(x.referenceMessage.type),referenced_message_status:I,ext:{[Z.v9.RefContent]:x.referenceMessage.content,[Z.v9.RefIsEdited]:String(x.referenceMessage.isEdited)}},void 0!==x.referenceMessage.referenceInfo?(E.referenceInfo.root_message_id=x.referenceMessage.referenceInfo.root_message_id,E.referenceInfo.root_message_conv_index=x.referenceMessage.referenceInfo.root_message_conv_index):(E.referenceInfo.root_message_id=Y.fromValue(x.referenceMessage.serverId),E.referenceInfo.root_message_conv_index=x.referenceMessage.indexInConversation)}return E.ctx.option.secUid&&(E.secSender=E.ctx.option.secUid),E}static fromServerMessage(I,x,C){var E;let M=new eU(I);return M.serverId=x.server_message_id.toString(),M.type=x.message_type,M.ext=Object.assign({},x.ext),M.conversationId=x.conversation_id,M.content=x.content,M.sender=x.sender.toString(),M.createdAt=new Date(x.create_time.toNumber()),M.indexInConversation=x.index_in_conversation,M.indexInConversationV2=null!==(E=x.index_in_conversation_v2)&&void 0!==E?E:Y.ZERO,M.orderInConversation=x.order_in_conversation,M.serverStatus=x.status,M.conversationShortId=x.conversation_short_id.toString(),M.conversationType=x.conversation_type,M.version=x.version,M.secSender=x.sec_sender,M.isOffline=!1,M.property=eU.fromServerProperty(x),x.reference_info&&(M.referenceInfo=x.reference_info),void 0!==C&&M.ctx.option.debug&&(M.ext[Z.v9.LocalLogId]=C),M}static fromServerProperty(I){let x={};if(!I.property_list)return x;for(let C of Object.keys(I.property_list)){let E=I.property_list[C];E&&E.Items&&(x[C]=E.Items.map(x=>{var E,M,S,T,w;return{messageId:null!==(E=I.ext[Z.v9.ClientMessageId])&&void 0!==E?E:"",conversationId:I.conversation_id,key:C,userId:null===(M=x.uid)||void 0===M?void 0:M.toString(),secUid:null!==(S=x.sec_uid)&&void 0!==S?S:"",createTime:new Date((null!==(w=null===(T=x.create_time)||void 0===T?void 0:T.toNumber())&&void 0!==w?w:0)*1e3),idempotentId:x.idempotent_id,value:x.value,version:I.version,status:R.Success}}))}return x}merge(I){if(I&&this.type===I.type){if(I.ext=Object.assign(this.versation.lt(this.indexInConversation))return this.indexInConversation=I.indexInConversation,this;if(I.indexInConversationV2.lt(this.indexInConversationV2))return this.indexInConversationV2=I.indexInConversationV2,this}Object.assign(this,I)}return this}get isNormalMsg(){return this.type<5e4}get isCommandMsg(){return this.type===K.im_proto.MessageType.MESSAGE_TYPE_COMMAND}get isSpecialMessage(){return this.type>=5e4}get visible(){return this.serverStatus!==Z.P6.Disable&&!this.isSpecialMessage&&(!this.ctx.option.userId||!this.ext||(this.ext[Z.v9.MessageVisible]&&this.ext[Z.v9.MessageVisible].length>0?-1!==this.ext[Z.v9.MessageVisible].split(",").indexOf(this.ctx.option.userId):!this.ext[Z.v9.MessageInvisible]||!(this.ext[Z.v9.MessageInvisible].length>0)||-1===this.ext[Z.v9.MessageInvisible].split(",").indexOf(this.ctx.option.userId)))}get unpop(){return!!this.ext&&!!(!this.visible||eL(this.ext,Z.v9.DoNotPopConversation))}get increaseUnread(){return!(this.isFromMe||!this.visible||this.isSpecialMessage||eL(this.ext,Z.v9.DoNotIncreaseUnread))}get isFromMe(){return this.sender===this.ctx.option.userId}get isRecalled(){return this.ext&&!!this.ext[Z.v9.IsRecalled]}get isMentioned(){return this.visible&&(this.mentionedUsers.includes(this.ctx.option.userId)||this.mentionedUsers.includes("0")&&!this.isFromMe)}get mentionedUsers(){return this.ext&&this.ext[Z.v9.MentionedUser]?this.ext[Z.v9.MentionedUser].split(","):[]}set mentionedUsers(I){this.ext||(this.ext={}),this.ext[Z.v9.MentionedUser]=I.join(",")}get isStrangerMessage(){return!this.ext||["1","2","3"].includes(this.ext[Z.v9.MessageMode])}get isRootReference(){return!!this.ext&&eL(this.ext,Z.v9.IsRootReference)}get moveReadIndex(){return!this.ext||!(!this.visible||this.isFromMe||this.isSpecialMessage||eL(this.ext,Z.v9.DoNotMoveReadIndex))}get updateLastMessage(){return!(!this.visible||this.isSpecialMessage||eL(this.ext,Z.v9.DoNotUpdateLastMessage))}getReadReceipt(){return this.resolve(M..v9.EditInfo])return null;try{let x=ep.parse(this.ext[Z.v9.EditInfo]),C=(null==x?void 0:x.content_edit_time)?new Date(null==x?void 0:x.content_edit_time):void 0;return{isEdited:!!(null==x?void 0:x.content_is_edited),editTime:C,editorUid:null===(I=null==x?void 0:x.content_editor)||void 0===I?void 0:I.toString()}}catch(I){return null}}get isEdited(){var I;return!!(null===(I=this.editInfo)||void 0===I?vor(){super(...arguments),this.minIndex=Y.ZERO,this._readIndex=Y.ZERO,this._readOrder=Y.ZERO}get isServerBlocked(){return eL(this.ext,Z.v9.RelationIsMutedServer)}get readIndex(){return this._readIndex}set readIndex(I){I&&I.gt(this._readIndex)&&(this._readIndex=I)}get readOrder(){return this._readOrder}set readOrder(I){I&&I.gt(this._readOrder)&&(this._readOrder=I)}get isSelf(){return this.userId===this.ctx.option.userId}get ext(){return this.innerExt||(this.innerExt={}),this.innerExt}set ext(I){this.innerExt=I}static featLocalParticipant(I,x){var C,E,M,S,T,R,w,O;return I.userId!==x.userId||(I.secUid=null!==(C=x.secUid)&&void 0!==C?C:I.secUid,I.role=null!==(E=x.role)&&void 0!==E?E:I.role,I.alias=null!==(M=x.alias)&&void 0!==M?M:I.alias,I.sortOrder=null!==(S=x.sortOrder)&&void 0!==S?S:I.sortOrder,I.blocked=null!==(T=x.blocked)&&void 0!==T?T:I.blocked,I.leftBlockTime=null!==(R=x.leftBlockTime)&&void 0!==R?R:I.leftBlockTime,I.readIndex=null!==(w=x.readIndex)&&void 0!==w?w:I.readIndex,I.readOrder=null!==(O=x.readOrder)&&void 0!==O?O:I.readOrder,I.ext=Object.assign(I.ext,x.ext)),I}static fromServerParticipant(I,x,C,E){var M,S,T,R,w;let O=new eB(I);return O.userId=x.user_id.toString(),O.secUid=x.sec_uid,O.role=null!==(M=x.role)&&void 0!==M?M:void 0,O.alias=null!==(S=x.alias)&&void 0!==S?S:void 0,O.sortOrder=null!==(T=x.sort_order)&&void 0!==T?T:void 0,O.blocked=x.blocme=null!==(R=x.left_block_time)&&void 0!==R?R:void 0,O.ext=null!==(w=x.ext)&&void 0!==w?w:{},O.conversationId=C.id,O.conversationType=C.type,void 0!==E&&O.ctx.option.debug&&(O.ext[Z.v9.LocalLogId]=E),O}static fakeParticipant(I,x,C){let E=new eB(I);return E.conversationId=C.id,E.conversationType=C.type,E.readIndex=Y.ZERO,E.minIndex=return this.resolve(M.CoreInstance)}init(){return(0,eb.__awaiter)(this,void 0,void 0,function*(){})}sendPacket(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return I})}receivePacket(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){})}ticker(){return(0,eb.__awaiter)(this,void 0,void 0,function*(){})}extendFunc(I){return I.bind(this)}dispose(){return(0,eb.__awaiter)(this,void 0,void 0,function*(){})}}class eV{static fromOp(I,x){var C;let E=new eV;return E.conversationId=I.conversationId,E.messageId=I.clientId,E.key=x.key,E.userId=I.ctx.option.userId,E.secUid=I.ctx.option.secUid,E.createTime=new Date(Date.now()),E.idempotentId=x.idempotentId,E.value=null!==(C=x.value)&&void 0!==C?C:"",E.version=I.version,E.status=R.Sending,E}static mergeOperationToCurrent(I,x){var C;let E=eA(x,I=>I.key);for(let x of Object.keys(E))for(let M of E[x]){I.property[x]||(I.property[x]=[]);let E=null===(C=I.property[x])||void 0===C?void 0:C.findIndex(I=>I.idempotentId===M.idempotentId);switch(M.operation){case K.im_proto.OPERATION_TYPE.ADD_PROPERTY_ITEM:-1===E&&I.property[x].push(eV.fromOp(I,M));break;case K.im_proto.OPERATION_TYPE.REMOVE_PROPERTY_ITEM:-1!==E&&I.property[x].splice(E,1),0===I.property[x].length&&delete I.property[x];break;case K.im_proto.OPERATION_TYPE.SET_PROPERTY:I.property[x]=[eV.fromOp(I,M)];break;case K.im_proto.OPERATION_TYPE.DEL_PROPERTY:delete I.property[x]}}}}let eF="v1/message/send",eH="v1/message/get_by_user",eW="v2/message/get_by_user_init",ej="v1/message/get_user_message",e$="v1/conversation/get_list",eq="v1/message/get_by_conversation",eK="v1/account/online",eY="v1/account/offline",ez="v1/conversation/delete",eZ="v3/conversation/mark_read",eJ="v2/conversation/get_info",eX="v2/conversation/create",eQ="v2/conversation/get_info_list",e0="v2/conversation/get_by_favorite",e1="v2/conversation/get_by_top",e2="v1/conversation/participants_list",e5="v1/conversation/add_participants",e3="v1/conversation/remove_participants",e6="v1/conversation/leave",e9="v1/conversation/update_participant",e4="v1/conversation/dissolve",e8="v1/message/delete",e7="v1/message/recall",te="v1/message/set_property",tt="v1/conversation/set_core_info",ti="v1/conversation/upsert_core_ext_info",tn="v1/conversation/set_setting_info",to="v1/conversation/upsert_settings_ext",ts="v3/conversation/get_read_index",tr="v3/conversation/get_min_index",ta="v1/stranger/get_conversation_list",td="v1/stranger/get_messages",tl="v1/stranger/delete_message",tc="v1/stranger/delete_conversation",tu="v1/stranger/delete_all_conversations",tv="v1/stranger/mark_read_conversation",th="v1/stranger/mark_read_all_conversations",t_="v1/client/user_action",tp="v1/client/input_status",tg="v1/media/get_upload_token",tf="v1/media/get_urls",tm="v1/conversation/list",ty="v1/broadcast/send_message",tI="v1/broadcast/recv_message",tx="v1/broadcast/user_counter",tC="v1/client/ack",tE="v1/voip/create",tM="v1/voip/call",tb="v1/voip/update",tS="v1/channel/heartbeat",tT="v1/profile/get_info",tR="v1/client/report_metrics",tw="v1/config/get",tO="v1/message/get_message_by_init",tk="v1/message/modify_ext",tA={[K.im_proto.IMCMD.SEND_MESSAGE]:eF,200:eH,203:eW,300:e$,301:eq,400:eK,401:eY,410:t_,411:tp,603:ez,608:eJ,609:eX,610:eQ,611:e0,612:e1,614:e4,605:e2,650:e5,651:e3,652:e6,655:e9,701:e8,702:e7,705:te,902:tt,904:ti,921:tn,922:to,1001:ta,1002:td,1003:tl,1004:tc,1005:tu,1006:tv,1007:th,2e3:ts,2001:tr,2002:eZ,2003:tg,2004:tf,2006:tm,2007:ty,2008:tI,2009:tx,2010:tC,2011:tE,2012:tM,2013:tb,2014:tS,2015:tT,2016:tR,2017:tw,[K.im_proto.IMCMD.GET_MESSAGE_BY_INIT]:tO,[K.im_proto.IMCMD.MODIFY_MESSAGE_EXT]:tk,[K.im_proto.IMCMD.UNREAD_COUNT_REPORT]:"v1/client/unread_count",[K.im_proto.IMCMD.SEND_MESSAGE_P2P]:"v1/send_message/p2p",[K.im_proto.IMCMD.BATCH_GAT_CONVERSATION_PARTICIPANTS_READINDEX]:"v1/conversation/batch_get_conversation_participants_readindex",[K.im_proto.IMCMD.GET_CONVERSATIONS_CHECKINFO]:"v1/conversation/get_checkinfo",[K.im_proto.IMCMD.GET_MESSAGES_CHECKINFO_IN_CONVERSATION]:"v1/message/get_checkinfo",[K.im_proto.IMCMD.MARK_MESSAGE]:"v1/message/mark",[K.im_proto.IMCMD.PULL_MARK_MESSAGE]:"v1/message/pull_mark",[K.im_proto.IMCMD.GET_CONVERSATION_CORE_INFO]:"v1/conversation/get_core_info",[K.im_proto.IMCMD.GET_UNREAD_COUNT]:"v1/client/get_unread_count",[K.im_proto.IMCMD.BLOCK_MEMBERS]:"v1/conversation/block_member",[K.im_proto.IMCMD.BLOCK_CONVERSATION]:"v1/conversation/block_conversation",[K.im_proto.IMCMD.CHECK_IN_BLOCKLIST]:"v1/blocklist/check",[K.im_proto.IMCMD.SET_BLOCKLIST]:"v1/blocklist/set",[K.im_proto.IMCMD.GET_BLOCKLIST]:"v1/blocklist/get",[K.im_proto.IMCMD.BATCH_UNMARK_MESSAGE]:"v1/message/batch_unmark",[K.im_proto.IMCMD.MARK_MSG_UNREAD_COUNT_REPORT]:"v1/message/report_mark_count",[K.im_proto.IMCMD.MARK_MSG_GET_UNREAD_COUNT]:"v1/message/get_mark_count",[K.im_proto.IMCMD.GET_MESSAGE_INFO_BY_SERVER_ID]:"v1/message/get_by_id",[K.im_proto.IMCMD.CLIENT_BATCH_ACK]:"v1/client/batch_ack",[K.im_proto.IMCMD.AUDIO_RECOGNITION]:"v1/message/audio_recognition",[K.im_proto.IMCMD.BATCH_MARK_CONVERSATION_READ_V3]:"v3/conversation/batch_mark_read",[K.im_proto.IMCMD.GET_USEmeta_info",[K.im_proto.IMCMD.SET_CONVERSATION_TAG]:"v1/conversation/set_tag",[K.im_proto.IMCMD.MANAGE_TAG_META_INFO]:"v1/tag/manage_meta_info",[K.im_proto.IMCMD.GET_CONVERSATIONS_BY_TAG]:"v1/conversation/get_by_tag",[K.im_proto.IMCMD.ADD_CONVERSATION_BOTS]:"v1/conversation/add_bots",[K.im_proto.IMCMD.REMOVE_CONVERSATION_BOTS]:"v1/conversation/remove_bots"};function tN(I){var x;returnx=tA[I])&&void 0!==x?x:""}!function(I){I[I.RequestCreate=0]="RequestCreate",I[I.RequestSerialize=1]="RequestSerialize",I[I.BeforeSend=2]="BeforeSend",I[I.BeforeSendSingleFlight=3]="BeforeSendSingleFlight",I[I.AfterSendSingleFlight=4]="AfterSendSingleFlight",I[I.AfterSend=5]="AfterSend",I[I.ResponseDeserialize=6]="ResponseDeserialize",I[I.SendMethod=7]="SendMethod"}(w||(w={}));let tP=function(){let I=1e4;return()=>I+=1}();class tL extends eu{constructorctx.option.apiUrl;S.endsWith("/")||(S=`${S}/`),this.url=S+M}get retryTimes(){return this._retryTimes}set retryTimes(I){this._retryTimes=I,this.request&&(this.request.headers=Object.assign(Object.assign({},this.request.headers),this.isRetryHeader))}get isRetryHeader(){return{"is-retry":this.retryTimes>1?"1":"0"}}get logid(){var I,x;return null!==(x=null===(I=this.response)||void 0===I?void 0:I.log_id)&&void 0!==x?x:""}prepareRequest(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.Request.create({body:this.reqBody,cmd:this.cmd,sequence_id:Y.fromNumber(this.seqId),refer:Z.HF.refer,token:this.ctx.cachedToken,headers:this.ctx.option.headers,device_id:this.ctx.option.deviceId,sdk_version:Z.HF.sdkVersion,build_number:Z.HF.buildNumber,inbox_type:I,device_platform:this.ctx.option.devicePlatform,channel:this.ctx.option.channel,device_type:this.ctx.option.deviceType,os_version:this.ctx.option.osVersion,version_code:this.ctx.option.versionCode,auth_type:this.ctx.option.authType,biz:this.ctx.option.biz,access:Z.HF.requestAccessName});for(let I of this.ctx.plugin)x=yield I.sendPacket(x);this.request=x})}}class tD extends eu{constructor(I){super(I)}send(I,x,C={}){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return(yield this.sendWithRawBody(I,x,C)).body})}sendWithRawBody(I,x,C={}){var E,S,R,w,O,A,N,P,L,D,U,B,G,V,F,H,W,q,Y,z,J,X,Q,ee,et,ei,en,eo;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let er;let ea=ey.performanceNow(),ed=this.getReqTrackerContext(I);try{if(void 0===C.inboxType&&(C.inboxType=this.resolve(M.InboxType).getDefaultInboxWithoutCheck()),this.ctx.option.webSocketLevel===Z._.PushOnly&&(C.forceHttp=!0),this.ctx.option.webSocketLevel===Z._.All&&(C.forceHttp=!1),er=new tL(this.ctx,x,I),yield er.prepareRequest(C.inboxType),yield this.resolve(M.NetworkManager).send(er,{maxHttpRetryTimes:!0===C.forceHttp?C.maxRetryTimes:void 0,maxWsRetryTimes:!0===C.forceHttp?0:C.maxRetryTimes,useBeacon:C.useBeacon}),C.useBeacon||void 0===er.response)return K.im_proto.Response.create({});let q=er.response;if(0!==q.status_code){let G=q.status_code;switch(G){case Z.NI.Degradation:throw new eS({ctx:this.ctx,msg:"server degradation",type:Z.NI.Degradation,sender:this,logid:null==q?void 0:q.log_id,args:{req:I,resp:q}});case Z.NI.InvalidTicket:if(x===K.im_proto.IMCMD.SEND_MESSAGE){let E=I.send_message_body.conversation_id,S=this.resolve(M.ConversationManager).get(E),T=S.ticket;yield this.resolve(M.ConversationManager).refreshTicket(S.id);let R=S.ticket;if(T!==R&&!C.isRetryReq)return e_.ctxDebug(this.ctx,"refresh ticket due to invalid"),this.sendWithRawBody(I,x,Object.assign(Object.assign({},C),{isRetryReq:!0}));throw new eS({ctx:this.ctx,msg:`invalid ticket for conv: ${E}`,type:Z.NI.InvalidTicket,sender:this,logid:null==q?void 0:q.log_id,args:{req:I,resp:q}})}break;case Z.NI.InvalidToken:case Z.NI.ExpiredToken:let V=this.ctx.cachedToken;try{if(this.resolve(M.NetworkManager).closeWs(!0),""===V||this.ctx.option.authType===K.im_proto.AuthType.SESSION_AUTH){if(!C.isRetryReq)return e_.ctxDebug(this.ctx,"http retry due to invalid session"),this.sendWithRawBody(I,x,Object.assign(Object.assign({},C),{isRetryReq:!0,forceHttp:!0}));throw new eS({ctx:this.ctx,msg:"invalid session",type:Z.NI.TokenFuncError,sender:this,logid:null==q?void 0:q.log_id,args:{req:I,resp:q}})}{yield this.ctx.resolve(M.AuthManager).refreshToken();let E=this.ctx.cachedToken;if(V!==E&&!C.isRetryReq)return e_.ctxDebug(this.ctx,"refresh token due to invalid"),this.sendWithRawBody(I,x,Object.assign(Object.assign({},C),{isRetryReq:!0}));throw new eS({ctx:this.ctx,msg:`token refresh fail: ${E}`,type:Z.NI.TokenFuncError,sender:this,logid:null==q?void 0:q.log_id,args:{req:I,resp:q}})}}catch(x){if(void 0!==x.type)throw x.args=Object.assign(Object.assign({},x.args),{req:I,resp:q}),x;throw new eS({ctx:this.ctx,msg:"token refresh func error",type:Z.NI.TokenFuncError,innerError:x,sender:this,logid:null==q?void 0:q.log_id,args:{req:I,resp:q}})}default:if(C.ignoreBizError)return this.resolve(M.Monitor).emitMetrics(T.NetworkRequest,{duration:Math.round(ey.performanceNow()-ea),retry_times:null!==(E=null==er?void 0:er.retryTimes)&&void 0!==E?E:0},{imsdk_cmd:x.toString(),imsdk_result:"0",seq_id:null!==(S=null==er?void 0:er.seqId.toString())&&void 0!==S?S:"",conversation_id:ed.conversationId,uuid:ed.uuid,error_msg:null!==(w=null===(R=null==er?void 0:er.response)||void 0===R?void 0:R.error_desc)&&void 0!==w?w:"",error_code:null!==(N=null===(A=null===(O=null==er?void 0:er.response)||void 0===O?void 0:O.status_code)||void 0===A?void 0:A.toString())&&void 0!==N?N:"",url_path:null!==(P=null==er?void 0:er.url)&&void 0!==P?P:"",net_type:null!==(D=null===(L=null==er?void 0:er.method)||void 0===L?void 0:L.toString())&&void 0!==D?D:"",logid:null!==(U=null==er?void 0:er.logid)&&void 0!==U?U:"",is_retry_req:C.isRetryReq?"1":"0"}),q;throw new eS({ctx:this.ctx,msg:`${null!==(B=Z.NI[G])&&void 0!==B?B:"unknown"}:${q.error_desc}`,type:G,sender:this,logid:null==q?void 0:q.log_id,args:{req:I,resp:q}})}}if(q.body)return this.resolve(M.Monitor).emitMetrics(T.NetworkRequest,{duration:Math.round(ey.performanceNow()-ea),retry_times:null!==(G=er.retryTimes)&&void 0!==G?G:0},{imsdk_cmd:x.toString(),imsdk_result:"1",seq_id:er.seqId.toString(),conversation_id:ed.conversationId,uuid:ed.uuid,error_msg:"",error_code:"0",url_path:null!==(V=er.url)&&void 0!==V?V:"",net_type:null!==(H=null===(F=er.method)||void 0===F?void 0:F.toString())&&void 0!==H?H:"",logid:null!==(W=q.log_id)&&void 0!==W?W:"",is_retry_req:C.isRetryReq?"1":"0"}),q;throw new eS({ctx:this.ctx,msg:"no response body",type:Z.NI.Unknown,sender:this,logid:null==q?void 0:q.log_id,args:{req:I,resp:q}})}catch(E){if(this.resolve(M.Monitor).emitMetrics(T.NetworkRequest,{duration:Math.round(ey.performanceNow()-ea),retry_times:null!==(q=null==er?void 0:er.retryTimes)&&void 0!==q?q:0},{imsdk_cmd:x.toString(),imsdk_result:"0",seq_id:null!==(Y=null==er?void 0:er.seqId.toString())&&void 0!==Y?Y:"",conversation_id:ed.conversationId,uuid:ed.uuid,error_msg:null!==(J=null===(z=null==er?void 0:er.response)||void 0===z?void 0:z.error_desc)&&void 0!==J?J:"",error_code:null!==(ee=null===(Q=null===(X=null==er?void 0:er.response)||void 0===X?void 0:X.status_code)||void 0===Q?void 0:Q.toString())&&void 0!==ee?ee:"",url_path:null!==(et=null==er?void 0:er.url)&&void 0!==et?et:"",net_type:null!==(en=null===(ei=null==er?void 0:er.method)||void 0===ei?void 0:ei.toString())&&void 0!==en?en:"",logid:null!==(eo=null==er?void 0:er.logid)&&void 0!==eo?eo:"",is_retry_req:C.isRetryReq?"1":"0"}),void 0===E)throw new eS({ctx:this.ctx,msg:"unknown error",type:Z.NI.Unknown,sender:this,args:{req:I}});if(void 0!==E.type)throw E.args=Object.assign(Object.assign({},E.args),{req:I}),E;throw new eS({ctx:this.ctx,msg:"request unknown error",type:Z.NI.Unknown,innerError:E,sender:this,args:{req:I}})}})}getReqTrackerContext(I){var x,C,E,M;for(let S of Object.keys(I)){let T=I[S];if(void 0!==T)return{conversationId:null!==(C=null===(x=T.conversation_id)||void 0===x?void 0:x.toString())&&void 0!==C?C:"",uuid:null!==(M=null===(E=T.client_message_id)||void 0===E?void 0:E.toString())&&void 0!==M?M:""}}return{conversationId:"",uuid:""}}}class tU extends tD{LeaveConversation(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({leave_conversation_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType}});return this.send(x,K.im_proto.IMCMD.LEAVE_CONVERSATION,{inboxType:I.inboxType})})}DeleteMessage(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({delete_message_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,message_id:I.serverId}});return this.send(x,K.im_proto.IMCMD.DELETE_MESSAGE,{inboxType:I.inboxType})})}GetMessageByServerId(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({get_message_by_id_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,server_message_id:I.serverId}});return this.sendWithRawBody(x,K.im_proto.IMCMD.GET_MESSAGE_INFO_BY_SERVER_ID,{inboxType:I.inboxType})})}MarkConversationDelete(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({delete_conversation_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,last_message_index:I.lastPullIndex,badge_count:I.badgeCount,mute_badge_count_infos:I.muteBadgeCountInfos}});return this.send(x,K.im_proto.IMCMD.MARK_CONVERSATION_DELETE,{inboxType:I.inboxType})})}AddConversationParticipants(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({conversation_add_participants_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,participants:I.participants,biz_ext:I.bizExt}});return(yield this.send(x,K.im_proto.IMCMD.ADD_CONVERSATION_PARTICIPANTS,{inboxType:I.inboxType})).conversation_add_participants_body})}GetConversationInfoListByFavoriteV2(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({get_conversation_info_list_by_favorite_v2_body:{cursor:I.cursor,limit:I.limit}});return this.sendWithRawBody(x,K.im_proto.IMCMD.GET_CONVERSATION_INFO_LIST_BY_FAVORITE_V2,{inboxType:I.inboxType})})}GetConversationInfoListByTopV2(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({get_conversation_info_list_by_top_v2_body:{cursor:I.cursor,limit:I.limit}});return this.sendWithRawBody(x,K.im_proto.IMCMD.GET_CONVERSATION_INFO_LIST_BY_TOP_V2,{inboxType:I.inboxType})})}GetConversationInfoListByTag(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({get_conversations_by_tag_body:{cursor:I.cursor,limit:I.limit,tag_id:I.tagIds,user_custom_tag_id:I.userCustomTagIds,inbox_type:I.inboxType}});return this.sendWithRawBody(x,K.im_proto.IMCMD.GET_CONVERSATIONS_BY_TAG,{inboxType:I.inboxType})})}UpdateConversationParticipant(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({update_conversation_participant_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,user_id:I.userId,role:I.role,alias:I.alias,biz_ext:I.bizExt,is_alias_set:!!I.alias}});return this.sendWithRawBody(x,K.im_proto.IMCMD.UPDATE_CONVERSATION_PARTICIPANT,{inboxType:I.inboxType})})}SetConversationCoreInfo(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({set_conversation_core_info_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,name:I.name,desc:I.desc,icon:I.icon,notice:I.notice,ext:I.ext,biz_ext:I.bizExt}});return(yield this.send(x,K.im_proto.IMCMD.SET_CONVERSATION_CORE_INFO,{inboxType:I.inboxType})).set_conversation_core_info_body})}RemoveConversationParticipants(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({conversation_remove_participants_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,participants:I.participants,biz_ext:I.bizExt}});return(yield this.send(x,K.im_proto.IMCMD.REMOVE_CONVERSATION_PARTICIPANTS,{inboxType:I.inboxType})).conversation_remove_participants_body})}UpsertConversationCoreExtInfo(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({upsert_conversation_core_ext_info_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,ext:I.ext}});return(yield this.send(x,K.im_proto.IMCMD.UPSERT_CONVERSATION_CORE_EXT_INFO,{inboxType:I.inboxType})).upsert_conversation_core_ext_info_body})}SetConversationSettingInfo(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({set_conversation_setting_info_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,set_stick_on_top:I.stickOnTop,set_mute:I.mute,set_favorite:I.favorite,push_status:I.pushStatus}});return(yield this.send(x,K.im_proto.IMCMD.SET_CONVERSATION_SETTING_INFO,{inboxType:I.inboxType})).set_conversation_setting_info_body})}UpsertConversationSettingExtInfo(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({upsert_conversation_setting_ext_info_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,ext:I.ext}});return(yield this.send(x,K.im_proto.IMCMD.UPSERT_CONVERSATION_SETTING_EXT_INFO,{inboxType:I.inboxType})).upsert_conversation_setting_ext_info_body})}GetConversationParticipantsList(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({conversation_participants_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,cursor:I.cursor,limit:I.limit}});return this.sendWithRawBody(x,K.im_proto.IMCMD.CONVERSATION_PARTICIPANTS_LIST,{inboxType:I.inboxType})})}SendUserAction(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({send_user_action_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,action_type:I.actionType,extra:I.extra}});return this.send(x,K.im_proto.IMCMD.SEND_USER_ACTION,{inboxType:I.inboxType})})}SendInputStatus(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({send_input_status_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,status:I.status,extra:I.extra}});return this.send(x,K.im_proto.IMCMD.SEND_INPUT_STATUS,{inboxType:I.inboxType})})}DissolveConversation(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({dissolve_conversation_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType}});return this.send(x,K.im_proto.IMCMD.DISSOLVE_CONVERSATION,{inboxType:I.inboxType})})}ModifyMessageExt(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({modify_message_ext_body:{conversation_short_id:I.conversationShortId,message_id:I.messageId,ticket:I.ticket,ext:I.ext,is_edited:I.isEdit,content:I.content,conversation_type:I.conversationType,message_type:I.messageType,conversation_id:I.conversationId}});return this.send(x,K.im_proto.IMCMD.MODIFY_MESSAGE_EXT,{inboxType:I.inboxType})})}GetUserConversationList(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({get_conversation_list_body:{con_type:I.type,cursor:I.cursor,limit:I.limit,sort_type:I.sortType,include_role:I.includeRole,exclude_role:I.excludeRole,with_cold:I.withCold,push_status:I.pushStatus}});return this.sendWithRawBody(x,K.im_proto.IMCMD.GET_USER_CONVERSATION_LIST,{inboxType:I.inboxType})})}UnreadCountReport(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({unread_count_report_body:{conv_unread_count:I.conv.map(I=>({conv_short_id:I.shortId,conversation_type:I.type,unread_count:I.count})),total_unread_count:I.total}});return this.send(x,K.im_proto.IMCMD.UNREAD_COUNT_REPORT,{inboxType:I.inboxType})})}BlockConversation(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({block_conversation_body:{conversation_id:I.conversationId,conv_short_id:I.conversationShortId,conversation_type:I.conversationType,block_status:I.status,block_normal_only:I.normalOnly}});return this.send(x,K.im_proto.IMCMD.BLOCK_CONVERSATION,{inboxType:I.inboxType})})}BlockMember(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({block_members_body:{conversation_id:I.conversationId,conv_short_id:I.conversationShortId,conversation_type:I.conversationType,block_time:I.time,block_status:I.status,biz_ext:I.bizExt}});return(yield this.send(x,K.im_proto.IMCMD.BLOCK_MEMBERS,{inboxType:I.inboxType})).block_members_body})}GetBlockList(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({get_blocklist_body:{cursor:I.cursor,limit:I.limit}});return(yield this.send(x,K.im_proto.IMCMD.GET_BLOCKLIST,{inboxType:I.inboxType})).get_blocklist_body})}SetBlockList(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({set_blocklist_body:{set_block_list:I.applySet,blocklist:I.blocklist}});return this.send(x,K.im_proto.IMCMD.SET_BLOCKLIST,{inboxType:I.inboxType})})}CheckInBlockList(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({check_in_blocklist_body:{user_to_check:I.userToCheck}});return(yield this.send(x,K.im_proto.IMCMD.CHECK_IN_BLOCKLIST,{inboxType:I.inboxType})).check_in_blocklist_body})}BroadcastSendMessage(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({broadcast_send_message_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,ticket:I.ticket,message_type:I.type,content:I.content,client_message_id:I.clientId,mentioned_users:I.mentionedUsers,ext:I.ext}});return this.sendWithRawBody(x,K.im_proto.IMCMD.BROADCAST_SEND_MESSAGE,{inboxType:I.inboxType})})}BroadcastReceiveMessage(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({broadcast_recv_message_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,cursor:I.cursor,limit:I.limit,reverse:I.reverse,pull_type:I.pullType}});return this.sendWithRawBody(x,K.im_proto.IMCMD.BROADCAST_RECV_MESSAGE,{inboxType:I.inboxType})})}BroadcastUserCounter(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({broadcast_user_counter_body:{conversations:I.conversations.map(I=>({conversation_short_id:I.shortId,conversation_type:I.type}))}});return(yield this.send(x,K.im_proto.IMCMD.BROADCAST_USER_COUNTER)).broadcast_user_counter_body})}SendP2PMessage(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({send_message_p2p_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,send_type:I.sendType,message_type:I.msgType,content:I.content,client_message_id:I.clientId,ext:I.ext,visible_user:I.visibleUser,invisible_user:I.invisibleUser}});return this.send(x,K.im_proto.IMCMD.SEND_M__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({modify_message_property_body:{property_list:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,server_message_id:I.serverId,client_message_id:I.clientId,modify_property_content:I.modifyContent.map(I=>({operation:I.operation,key:I.key,value:I.value,idempotent_id:I.idempotentId}))},ticket:I.ticket}});return(yield this.send(x,K.im_proto.IMCMD.SET_MESSAGE_PROPERTY,{inboxType:I.inboxType})).modify_message_property_body})}GetUnreadCount(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({get_unread_count_body:{get_total:I.total,conv_short_id:I.shortIds}});return(yield this.send(x,K.im_proto.IMCMD.GET_UNREAD_COUNT,{inboxType:I.inboxType})).get_unread_count_body})}MarkMessage(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({mark_message_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,server_message_id:I.serverMessageId,do_action:I.doAction,action_type:I.actionType,sort_time:I.sortTime,tag:I.tag}});return this.send(x,K.im_proto.IMCMD.MARK_MESSAGE,{inboxType:I.inboxType})})}PullMarkMessage(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({pull_mark_message_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,cursor:I.cursor,limit:I.limit,asc:I.asc,action_type:I.actionType,tag:I.tag}});return this.sendWithRawBody(x,K.im_proto.IMCMD.PULL_MARK_MESSAGE,{inboxType:I.inboxType})})}GetConversationCoreInfo(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({get_conversation_core_info_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType}});return this.send(x,K.im_proto.IMCMD.GET_CONVERSATION_CORE_INFO,{inboxType:I.inboxType})})}BatchUnmarkMessage(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({batch_unmark_message:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,server_message_ids:I.serverMessageIds,action_type:I.actionType,tag:I.tag}});return(yield this.send(x,K.im_proto.IMCMD.BATCH_UNMARK_MESSAGE)).batch_unmark_message})}MarkMsgUnreadCountReport(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({mark_msg_unread_count_report:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,total_unread_count:I.totalUnreadCount,tag_unread_count:I.tagUnreadCount}});return(yield this.send(x,K.im_proto.IMCMD.MARK_MSG_UNREAD_COUNT_REPORT)).mark_msg_unread_count_report})}MarkMsgGetUnreadCount(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({mark_msg_get_unread_count:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,get_total:I.getTotal,tags:I.tags}});return(yield this.send(x,K.im_proto.IMCMD.MARK_MSG_GET_UNREAD_COUNT)).mark_msg_get_unread_count})}ConvertVoiceToText(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({audio_recognition_body:{audio:{content:I.content,uid:I.uid,server_message_id:I.server_message_id,audio_option:I.audioOptions,conv_short_id:I.conv_short_id}}});return this.send(x,K.im_proto.IMCMD.AUDIO_RECOGNITION)})}GetTagMetaInfo(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let{filterDeletedTag:x}=I,C=K.im_proto.RequestBody.create({get_tag_meta_info_body:{filter_deleted_tag:x}});return this.send(C,K.im_proto.IMCMD.GET_TAG_META_INFO)})}SetConversationTag(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let{tagIds:x,shortIds:C,isRemove:E,userCustomTagIds:M}=I,S=K.im_proto.RequestBody.create({set_conversation_tag_body:{tag_ids:x,conv_short_ids:C,is_unset:E,user_custom_tag_ids:M,inbox_type:I.inboxType}});return this.send(S,K.im_proto.IMCMD.SET_CONVERSATION_TAG,{})})}ManageTagMetaInfo(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({manage_tag_meta_info_body:{add_tag_meta_infos:I.addTagMetaInfos,delete_tag_ids:I.deleteTagIds,update_tag_meta_infos:I.updateTagMetaInfos,inbox_type:I.inboxType}});return this.send(x,K.im_proto.IMCMD.MANAGE_TAG_META_INFO,{inboxType:I.inboxType,maxRetryTimes:1})})}ConversationAddBots(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({conversation_add_bots_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,bots:I.bots,biz_ext:I.bizExt}});return this.send(x,K.im_Bots(I){return(0,eb.__awaiter)(this,void 0,void 0,o.RequestBody.create({conversation_remove_bots_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,bots:I.bots,biz_ext:I.bizExt}});return this.send(x,K.im_proto.IMCMD.REMOVE_CONVERSATION_BOTS,{})})}}class tB extends eD{constructor(){super(...arguments),this.localIndex=Y.ZERO}get isMuted(){return!1}get isStickOnTop(){return!1}get isFavorite(){return!1}get toParticipantUserId(){}static fromServerConversation(I,x,C){let E=new tB(I);return E.id=x.conversation_id,E.shortId=x.conversation_short_id.toString(),E.type=x.conversation_type,E.isOffline=!1,E.coreInfo=new eT(E,x),E}setConversationCursor(I){I>this.localIndex&&(this.localIndex=I),this.localIndex=I}getMessageList(I=I=>I.visible){return this.resolve(M.BroadcastManager).getList(this.id).filter(I)}get unreadCount(){return 0}}class tG extends eu{constructor(I){super(I),this.messages=new Map,this.conversation=new Map}upsertOnline(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=(yield this.resolve(M.ExtensionApi).GetConversationCoreInfo({conversationId:I.id,conversationShortId:Y.fromString(I.shortId),conversationType:I.type,inboxType:I.inboxType})).get_conversation_core_info_body;if(!x||!x.conversation_core_info)throw new eS({ctx:this.ctx,type:Z.NI.ConversationNotExist,msg:`local conversation: ${I.id} not found online`,sender:this,args:{conversationId:I.id}});let C=tB.fromServerConversation(this.ctx,x.conversation_core_info);return this.conversation.set(I.id,C),C})}getWithOnline(I,x,C){return(0,eb.__awaiter)(this,void 0,void 0,funon.get(I);if(!E||E.isOffline){if(!x||!C)throw new eS({ctx:this.ctx,type:Z.NI.InvalidParam,msg:"no shortId and type provided",sender:this});E||((E=new tB(this.ctx)).id=I,E.shortId=x,E.type=K.im_proto.ConversationType.BROADCAST_CHAT,E.isOffline=!0,E.coreInfo=new eT(E)),E=yield this.upsertOnline(E)}return E})}upsert(I){let x;let C=this.getConversationMsgs(I.conversationId),E=C.msgs.findIndex(x=>x&&x.clientId===I.clientId);E>=0&&(x=C.msgs[E]),x?(x.type===I.type?I=x.merge(I):e_.ctxWarn(this.ctx,"try to merge different msg:",x,I),C.msgs[E]=I):this.insertMsg(C,I),this.resolve(M.EventBus).emit(Z.c5.MessageUpsert,this,I)}getList(I){let x=this.getConversationMsgs(I),C=x.tail;if(x.front<C)return x.msgs.slice(x.front,C);let E=x.msgs.slice(0,C);return x.msgs.slice(x.front,tG.MaxMsgSize).concat(E)}insertMsg(I,x){let C=I.tail;I.tail=(I.tail+1)%tG.MaxMsgSize,I.tail===I.front&&(I.front=(I.front+1)%tG.MaxMsgSize),I.msgs[C]=x}get(I,x){let C=this.getRaw(I,x);if(!C)throw new eS({ctx:this.ctx,type:Z.NI.MessageNotExist,msg:`message ${x} @ ${I} not exist in local`,sender:thersation(I){let x=this.conversation.get(I);if(!x)throw new eS({ctx:this.ctx,msg:`broadcast conversation ${I} not exist in local`,type:Z.NI.ConversationNotExist,sender:this,args:{conversationId:I}});return x}getRaw(I,x){let C;let E=this.getConversationMsgs(I),M=E.msgs.findIndex(I=>I&&I.clientId===x);return M>=0&&(C=E.msgs[M]),C}getByServerId(I,x){let C=this.getConversationMsgs(I),E=C.msgs.findIndex(I=>I&&I.serverId===x);if(E<0)throw new eS({ctx:this.ctx,type:Z.NI.MessageNotExist,msg:`message ${x} @ ${I} not exist in local`,sender:this});return C.msgs[E]}getConversationMsgs(I){let x=this.messages.get(I);return x||(x={msgs:Array(tG.MaxMsgSize),front:0,tail:0},this.messages.set(I,x)),x}processNewMessagesFrction*(){for(let C of I)C.ext||(C.ext={}),yield this.processNewMessage(C,x)})}processNewMessage(I,x){return(0,eb.__awaiter)(this,void 0,void 0,function*(){if(I.ext||(I.ext={}),I.source=x,I.type>=0)return this.processTextMessage(I);throw new eS({ctx:this.ctx,type:Z.NI.UnknownMessageType,msg:`unknown message type: ${I.type} for msg:${I.clientId}`,sender:this})})}dispose(){this.conversation.clear(),this.messages.clear()}processTextMessage(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){if(!I.isNormalMsg)return I;let x=void 0!==I.source&&(I.source===Z.v$.Online||I.source===Z.v$.BroadcastLoadMore),C=this.getRaw(I.conversationId,I.clientId),E=(null==C?void 0:C.flightStatus)!==void 0&&x;this.upsert(I);let S=this.getRaw(I.conversationId,I.clientId);return C?E&&S.flightStatus!==Z.b3.Received&&(S.flightStatus=Z.b3.Received,this.resolve(M.EventBus).emit(Z.c5.ReceiveBroadcastSelfMessage,this,S),this.upsert(S)):x&&(I.sender!==this.ctx.option.userId?this.resolve(M.EventBus).emit(Z.c5.ReceiveBroadcastNewMessage,this,I):this.resolve(M.EventBus).emit(Z.c5.ReceiveBroadcastSelfMessage,this,I)),I})}}tG.MaxMsgSize=1001;class tV extends eu{execute(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=I;return x=yield this.before(x),x=yield this.process(x),x=yield this.after(x)})}before(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return I})}after(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return I})}}class tF extends tV{process(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return I.data.type===K.im_proto.MessageType.MESSAGE_TYPE_UPDATE_MESSAGE_PROPERTY&&(I.needContinue=!1,yield this.handlePropertyCmd(I.data)),I})}handlePropertyCmd(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=this.resolve(M.MessageManager).getRaw(I.conversationId,I.clientId);x?(x.version=I.version,e_.ctxDebug(this.ctx,"merge property, local:",x.property,"server:",I.property),x.property=I.property,this.resolve(M.MessageManager).upsert(x),this.resolve(M.EventBus).emit(Z.c5.MessagePropertyUpsert,this,x)):e_.ctxDebug(this.ctx,"modify property cmd msg not exist in local",I)})}}!function(I){I[I.BlockUser=1]="BlockUser",I[I.BlockConvNormalOnly=2]="BlockConvNormalOnly",I[I.BlockConvAll=3]="BlockConvAll"}(O||(O={}));class tH extends tV{process(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return I.data.type===K.im_proto.MessageType.MESSAGE_TYPE_BLOCK_COMMAND&&(I.needContinue=!1,this.handleBlockCmd(I.data,I.conv)),I})}handleBlockCmd(I,x){let C=ep.parse(I.content),E=C.block_status;if(C.type===O.BlockUser){let{userID:S}=C;if(null==S||0===S.length)return;let T=this.resolve(M.ParticipantManager).getMapRaw(x.id);if(!T)return;for(let R of S){let S=null==R?void 0:R.toString();if(!T.has(S))continue;let w=T.get(S);w.blocked=!!E;let O=C.blockTime[S];w.leftBlockTime=O?Y.fromValue(O):void 0,this.resolve(M.ParticipantManager).upsert(x.id,w),this.resolve(M.EventBus).emit(Z.c5.ParticipantBlock,this,{participant:w,message:I})}}else this.resolve(M.ConversationManager).refreshAsync(x).then(x=>{x.map(x=>this.resolve(M.EventBus).emit(Z.c5.ConversationBlock,this,{conversation:x,message:I}))})}}class tW extends tV{process(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return I.data.type===K.im_proto.MessageType.MESSAGE_TYPE_MARK_COMMAND?(I.needContinue=!1,this.handlePinCmd(I.data,I.conv)):I.data.type===K.im_proto.MessageType.MESSAGE_TYPE_BATCH_UNMARK_COMMAND&&(I.needContinue=!1,this.handleBatchUnmarkCmd(I.data,I.conv)),I})}handlePinCmd(I,x){let C=ep.parse(I.content).server_message_id.toString(),E=this.resolve(M.MessageManager).getByServerIdRaw(x.id,C);if(!E){e_.ctxWarn(this.ctx,"local message not exist, serverMsg=",I);return}if(E.version.gt(I.version)){e_.ctxWarn(this.ctx,"server message is older, localMsg=",E,"serverMsg=",I);return}E.ext=I.ext,E.version=I.version,this.resolve(M.MessageManager).upsert(E)}handleBatvoid 0:C[Z.",I.ImgThumbEncryptUrl="s:file_ext_key_thumb_encrypt_url",I.ImgUseImageX="s:file_ext_key_use_imagex",I.ImgSuffix="s:file_ext_key_img_suffix",I.VideoCoverUri="s:file_ext_key_video_cover_uri",I.VideoCoverUrl="s:file_eey_video_duration",I.VideoWidth="s:file_ext_key_video_width",I.VideoHeight="s:file_ext_key_video_height",I.AudioDuration="s:file_ext_key_audio_duration"}(N||(N={})),function(I){I.Image="file_ext_value_type_image",I.Video="file_ext_value_type_video",I.Audio="file_ext_value_type_audio",I.Object="file_ext_value_type_object",I.File="file_ext_value_type_file"}(P||(P={})),function(I){I.Obj="tplv-obj",I.Resize="tplv-resize"}(L||(L={}));class t${static fromServerTag(I){var x;let C=new t$;return C.id=I.tag_id.toString(),C.name=I.tag_name,C.ext=null!==(x=I.ext)&&void 0!==x?x:{},C.isDeleted=!!I.status,C}}class tq extends tV{process(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return I.data.type===K.im_proto.MessageType.MESSAGE_TYPE_NOTIFY_USER_CUSTOM_CONVERSATION_TAG_UPDATE_COMMAND&&(I.needContinue=!1,this.handle(I)),I})}handle(I){var x,C;let E=ep.parse(I.data.content);this.resolve(M.EventBus).emit(Z.c5.TagListUpdate,this,null!==(C=null===(x=E.user_custom_tag)||void 0===x?void 0:x.map(I=>t$.fromServerTag(I)))&&void 0!==C?C:[])}}class tK extends tV{process(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return I.data.type===K.im_proto.MessageType.MESSAGE_TYPE_VISIBLE_MESSAGE_COMMAND&&(I.needContinue=!1,yield this.handle(I)),I})}handle(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=ep.parse(I.data.content),C=z().fromValue(x.message_id).toString(),E=yield this.resolve(M.ExtensionPlugin).getMessageByServerId({conversation:{id:x.conversation_id,shortId:z().fromValue(x.conversation_short_id).toString(),type:x.conversation_type,inboxType:x.inbox_type},serverMessageId:C});E&&this.resolve(M.MessageManager).upsert(E)})}}class tY extends eG{constructor(){super(...arguments),this.name="ExtensionPlugin"}leaveConversation(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){yield this.api.LeaveConversation({conversationId:I.conversation.id,conversationShortId:Y.fromString(I.conversation.shortId),conversationType:I.conversation.type,inboxType:I.conversation.inboxType}),this.resolve(M.ParticipantManager).delete(I.conversation.id,[this.ctx.option.userId])})}deleteMessage(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){if(!I.message.serverId)throw new eS({ctx:this.ctx,type:Z.NI.MessageNotReady,msg:`message ${I.message} is not ready`,reachServer:!1,sender:this});try{if(this.resolve(M.MessageManager).delete(I.message.conversationId,I.message.serverId),I.localOnly)return;let x=this.resolve(M.ConversationManager).get(I.message.conversationId);yield this.api.DeleteMessage({conversationId:I.message.conversationId,conversationShortId:Y.fromString(I.message.conversationShortId),conversationType:I.message.conversationType,serverId:Y.fromString(I.message.serverId),inboxType:x.inboxType})}catch(I){e_.ctxWarn(this.ctx,"delete message error, may lost server operation",I)}})}deleteConversation(I){var x;return(0,eb.__awaiter)(this,void 0,void 0,function*(){try{let C=I.conversation.lastMessageIndex;if(this.resolve(M.ConversationManager).delete(I.conversation.id),I.localOnly)return;yield this.api.MarkConversationDelete({conversationId:I.conversation.id,conversationShortId:Y.fromString(I.conversation.shortId),conversationType:I.conversation.type,lastPullIndex:C,inboxType:I.conversation.inboxType,badgeCount:I.conversation.badgeCount,muteBadgeCountInfos:null===(x=I.conversation.muteBadgeCountInfos)||void 0===x?void 0:x.map(I=>({message_type:I.message_type,badge_count:I.badge_count}))})}catch(I){e_.ctxWarn(this.ctx,"delete conversation error, may lost server operation",I)}})}getConversationListByTop(I={}){var x,C,E;return(0,eb.__awaiter)(this,void 0,void 0,function*(){void 0===I.inboxType&&(I.inboxType=this.resolve(M.InboxType).getDefaultInbox());let S=[],T=yield this.api.GetConversationInfoListByTopV2({cursor:Y.fromValue(null!==(x=I.cursor)&&void 0!==x?x:"0"),limit:null!==(C=I.limit)&&void 0!==C?C:10,inboxType:I.inboxType}),R=null===(E=T.body)||void 0===E?void 0:E.get_conversation_info_list_by_top_v2_body,w=R.conversation_info_list.map(I=>eD.fromServerConversation(this.ctx,I,T.log_id)).map(I=>this.resolve(M.ConversationManager).upsert(I));return{conversation:S=S.concat(w),hasMore:null==R?void 0:R.has_more,cursor:null==R?void 0:R.next_cursor}})}getConversationListByFavorite(I={}){var x,C,E;return(0,eb.__awaiter)(this,void 0,void 0,function*(){void 0===I.inboxType&&(I.inboxType=this.resolve(M.InboxType).getDefaultInbox());let S=[],T=yield this.api.GetConversationInfoListByFavoriteV2({cursor:Y.fromValue(null!==(x=I.cursor)&&void 0!==x?x:"0"),limit:null!==(C=I.limit)&&void 0!==C?C:10,inboxType:I.inboxType}),R=null===(E=T.body)||void 0===E?void 0:E.get_conversation_info_list_by_favorite_v2_body,w=(null==R?void 0:R.conversation_info_list).map(I=>eD.fromServerConversation(this.ctx,I,T.log_id)).map(I=>this.resolve(M.ConversationManager).upsert(I));return{conversation:S=S.concat(w),hasMore:null==R?void 0:R.has_more,cursor:null==R?void 0:R.next_cursor}})}getConversationListByTag(I={}){var x,C,E,S;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let T=[],{tagIds:R}=I,{userCustomTagIds:w}=I,O=Array.isArray(R)?R:R?[R]:[],A=Array.isArray(w)?w:w?[w]:[],N=yield this.api.GetConversationInfoListByTag({cursor:Y.fromValue(null!==(x=I.cursor)&&void 0!==x?x:"0"),limit:Y.fromValue(null!==(C=I.limit)&&void 0!==C?C:10),inboxType:null!==(E=I.inboxType)&&void 0!==E?E:this.resolve(M.InboxType).getDefaultInbox(),tagIds:O.map(I=>Y.fromString(I)),userCustomTagIds:A.map(I=>Y.fromString(I))}),P=null===(S=N.body)||void 0===S?void 0:S.get_conversations_by_tag_body,L=(null==P?void 0:P.conversation_info_list).map(I=>eD.fromServerConversation(this.ctx,I,N.log_id)).map(I=>this.resolve(M.ConversationManager).upsert(I));return{conversation:T=T.concat(L),hasMore:null==P?void 0:P.has_more,cursor:null==P?void 0:P.next_cursor}})}addParticipants(I){var x,C;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let E=Array.isArray(I.participant)?I.participant:[I.participant],M=yield this.api.AddConversationParticipants({conversationId:I.conversation.id,conversationShortId:Y.fromString(I.conversation.shortId),conversationType:I.conversation.type,participants:E.map(I=>Y.fromValue(I)),bizExt:I.bizExt,inboxType:I.conversation.inboxType});return(null==M?void 0:M.status)!==0?{success:!1,failedParticipant:E,payload:I.conversation,checkCode:M.check_code,checkMsg:M.check_message,statusCode:M.status,statusMsg:M.extra_info}:{success:!0,failedParticipant:null!==(C=null===(x=M.failed_participants)||void 0===x?void 0:x.map(I=>I.toString()))&&void 0!==C?C:[],payload:I.conversation,checkCode:M.check_code,checkMsg:M.check_message,statusCode:M.status,statusMsg:M.extra_info}})}removeParticipants(I){var x,C;return(0,eb.__awaiter)(this,void 0,void 0,function*(){Array.isArray(I.participant)||(I.participant=[I.participant]);let E=I.participant.map(I=>Y.fromString("string"==typeof I?I:I.userId)),M=yield this.api.RemoveConversationParticipants({conversationId:I.conversation.id,conversationShortId:Y.fromString(I.conversation.shortId),conversationType:I.conversation.type,participants:E,bizExt:I.bizExt,inboxType:I.conversation.inboxType});if((null==M?void 0:M.status)!==0)return{success:!1,failedParticipant:E.map(I=>I.toString()),body:M,payload:I.conversation,checkCode:M.check_code,checkMsg:M.check_message,statusCode:M.status,statusMsg:M.extra_info};let S=[],T=null!==(C=null===(x=M.failed_participants)||void 0===x?void 0:x.map(I=>I.toString()))&&void 0!==C?C:[];return E.forEach(I=>{T.includes(I.toString())||S.push(I.toString())}),{success:!0,body:M,failedParticipant:T,payload:I.conversation,checkCode:M.check_code,checkMsg:M.check_message,statusCode:M.status,statusMsg:M.extra_info}})}updateParticipant(I){var x,C;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let E=yield this.api.UpdateConversationParticipant({conversationId:I.conversation.id,conversationShortId:Y.fromString(I.conversation.shortId),conversationType:I.conversation.type,role:I.role,alias:I.alias,bizExt:I.bizExt,inboxType:I.conversation.inboxType,userId:Y.fromValue(I.userId)}),M=null===(x=null==E?void 0:E.body)||void 0===x?void 0:x.update_conversation_participant_body;return(null==E?void 0:E.status_code)===0&&(null===(C=null==M?void 0:M.participant)||void 0===C?void 0:C.user_id)&&(null==E?void 0:E.log_id)?{success:!0,payload:eB.fromServerParticipant(this.ctx,M.participant,I.conversation,E.log_id),checkCode:M.check_code,checkMsg:M.check_message,statusCode:E.status_code,statusMsg:M.extra_info,body:M}:{success:!1,payload:null,checkCode:M.check_code,checkMsg:M.check_message,statusCode:E.status_code,statusMsg:M.extra_info,body:M}})}setConversationSettingInfo(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=yield this.api.SetConversationSettingInfo({conversationId:I.conversation.id,conversationShortId:Y.fromString(I.conversation.shortId),conversationType:I.conversation.type,stickOnTop:I.stickOnTop,mute:I.mute,favorite:I.favorite,inboxType:I.conversation.inboxType,pushStatus:I.pushStatus});return(null==x?void 0:x.status)!==0?{success:!1,payload:I.conversation,checkCode:x.check_code,checkMsg:x.check_message,statusCode:x.status,statusMsg:x.extra_info}:(yield this.resolve(M.ConversationManager).refreshAsync(I.conversation),{success:!0,payload:I.conversation,checkCode:x.check_code,checkMsg:x.check_message,statusCode:x.status,statusMsg:x.extra_info})})}setConversationCoreInfo(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=yield this.api.SetConversationCoreInfo({conversationId:I.conversation.id,conversationShortId:Y.fromString(I.conversation.shortId),conversationType:I.conversation.type,name:I.name,desc:I.desc,icon:I.icon,notice:I.notice,ext:I.ext,bizExt:I.bizExt,inboxType:I.conversation.inboxType});return(null==x?void 0:x.status)!==0?{success:!1,payload:I.conversation,checkCode:x.check_code,checkMsg:x.check_message,statusCode:x.status,statusMsg:x.extra_info}:(yield this.resolve(M.ConversationManager).refreshAsync(I.conversation),{success:!0,payload:I.conversation,checkCode:x.check_code,checkMsg:x.check_message,statusCode:x.status,statusMsg:x.extra_info})})}upsertConversationSettingExtInfo(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=yield this.api.UpsertConversationSettingExtInfo({conversationId:I.conversation.id,conversationShortId:Y.fromString(I.conversation.shortId),conversationType:I.conversation.type,ext:I.ext,inboxType:I.conversation.inboxType});return(null==x?void 0:x.status)!==0?{success:!1,payload:I.conversation,checkCode:x.check_code,checkMsg:x.check_message,statusCode:x.status,statusMsg:x.extra_info}:(yield this.resolve(M.ConversationManager).refreshAsync(I.conversation),{success:!0,payload:I.conversation,checkCode:x.check_code,checkMsg:x.check_message,statusCode:x.status,statusMsg:x.extra_info})})}setConversationWeakMuteConfig(I){var x,C;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let E=ep.stringify({[Z.O9]:{white_uids:null!==(x=I.config.whiteUids)&&void 0!==x?x:[],white_msg_types:null!==(C=I.config.whiteMsgTypes)&&void 0!==C?C:[]}});return this.upsertConversationSettingExtInfo({conversation:I.conversation,ext:{[Z.v9.PushPartDisableConfig]:E}})})}upsertConversationCoreExtInfo(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=yield this.api.UpsertConversationCoreExtInfo({conversationId:I.conversation.id,conversationShortId:Y.fromString(I.conversation.shortId),conversationType:I.conversation.type,ext:I.ext,inboxType:I.conversation.inboxType});return(null==x?void 0:x.status)!==0?{success:!1,payload:I.conversation,checkCode:x.check_code,checkMsg:x.check_message,statusCode:x.status,statusMsg:x.extra_info}:(yield this.resolve(M.ConversationManager).refreshAsync(I.conversation),{success:!0,payload:I.conversation,checkCode:x.check_code,checkMsg:x.check_message,statusCode:x.status,statusMsg:x.extra_info})})}getConversationParticipants(I){return this.resolve(M.ParticipantManager).getParticipants(I.conversation)}getConversationParticipantsAsync(I){var x,C;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let E=!0,S=Y.ZERO,T=50;for(;E;){let M=yield this.getConversationParticipantsByPage({cursor:S,limit:T,conversation:I.conversation});E=null!==(x=null==M?void 0:M.hasMore)&&void 0!==x&&x,S=null!==(C=null==M?void 0:M.cursor)&&void 0!==C?C:Y.ZERO}return this.resolve(M.ParticipantManager).get(I.conversation.id)})}getConversationParticipantsByPage(I){var x,C,E,S,T,R;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let w=null!==(x=I.cursor)&&void 0!==x?x:Y.ZERO,O=null!==(C=I.limit)&&void 0!==C?C:50,A=yield this.api.GetConversationParticipantsList({conversationId:I.conversation.id,conversationShortId:Y.fromString(I.conversation.shortId),conversationType:I.conversation.type,cursor:w?Y.fromValue(w):Y.ZERO,limit:O,inboxType:I.conversation.inboxType}),N=null===(S=null===(E=A.body)||void 0===E?void 0:E.conversation_participants_body)||void 0===S?void 0:S.participants_page,P=null!==(T=null==N?void 0:N.has_more)&&void 0!==T&&T;w=null!==(R=null==N?void 0:N.cursor)&&void 0!==R?R:Y.ZERO;let L=[];return null==N||N.participants.forEach(x=>{L.push(eB.fromServerParticipant(this.ctx,x,I.conversation,A.log_id))}),this.resolve(M.ParticipantManager).upsertBatch(I.conversation.id,L),this.resolve(M.ConversationManager).upsert(I.conversation),{participants:L,hasMore:P,cursor:w}})}sendUserAction(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){yield this.api.SendUserAction({conversationId:I.conversation.id,conversationShortId:Y.fromString(I.conversation.shortId),conversationType:I.conversation.type,extra:I.ext,actionType:I.actionType,inboxType:I.conversation.inboxType})})}sendInputStatus(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){yield this.api.SendInputStatus({conversationId:I.conversation.id,conversationShortId:Y.fromString(I.conversation.shortId),conversationType:I.conversation.type,extra:I.ext,status:I.status,inboxType:I.conversation.inboxType})})}sendP2PMessage(I){var x,C,E,M,S;return(0,eb.__awaiter)(this,void 0,void 0,function*(){yield this.api.SendP2PMessage({conversationId:I.conversation.id,conversationShortId:Y.fromValue(I.conversation.shortId),conversationType:I.conversation.type,sendType:I.sendType,msgType:I.msgType,content:I.content,clientId:ed(),ext:null!==(x=I.ext)&&void 0!==x?x:{},visibleUser:null!==(E=null===(C=I.visibleUser)||void 0===C?void 0:C.map(I=>Y.fromValue(I)))&&void 0!==E?E:[],invisibleUser:null!==(S=null===(M=I.invisibleUser)||void 0===M?void 0:M.map(I=>Y.fromValue(I)))&&void 0!==S?S:[],inboxType:I.conversation.inboxType})})}dissolveConversation(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){yield this.api.DissolveConversation({conversationId:I.conversation.id,conversationShortId:Y.fromString(I.conversation.shortId),conversationType:I.conversation.type,inboxType:I.conversation.inboxType}),this.resolve(M.ConversationManager).delete(I.conversation.id),this.resolve(M.EventBus).emit(Z.c5.ConversationDissolve,this,I.conversation),this.resolve(M.EventBus).emitEmpty(Z.c5.ConversationChange,this)})}upsertMessageExt(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){if(!I.message.serverId)throw new eS({ctx:this.ctx,type:Z.NI.MessageOffline,msg:"message is offline",reachServer:!1,sender:this});for(let x of Object.keys(I.ext))x.startsWith("s:")&&delete I.ext[x];let x=this.resolve(M.ConversationManager).get(I.message.conversationId);return yield this.api.ModifyMessageExt({conversationShortId:Y.fromValue(I.message.conversationShortId),messageId:Y.fromValue(I.message.serverId),ext:I.ext,ticket:x.ticket,inboxType:x.inboxType,isEdit:!1}),I.message.ext=Object.assign(I.message.ext,I.ext),this.resolve(M.MessageManager).upsert(I.message),I.message})}modifyMessageContent(I){var x,C;return(0,eb.__awaiter)(this,void 0,void 0,function*(){if(!I.message.serverId)throw new eS({ctx:this.ctx,type:Z.NI.MessageOffline,msg:"message is offline",reachServer:!1,sender:this});let E=this.resolve(M.ConversationManager).get(I.message.conversationId),S=yield this.api.ModifyMessageExt({conversationShortId:Y.fromValue(I.message.conversationShortId),messageId:Y.fromValue(I.message.serverId),ticket:E.ticket,inboxType:E.inboxType,content:I.content,isEdit:!0,conversationType:E.type,messageType:I.message.type,conversationId:E.id});return(null===(x=null==S?void 0:S.modify_message_ext_body)||void 0===x?void 0:x.ext)&&(I.message.ext=Object.assign(I.message.ext,null===(C=null==S?void 0:S.modify_message_ext_body)||void 0===C?void 0:C.ext)),I.message.content=I.content,this.resolve(M.MessageManager).upsert(I.message),{message:I.message}})}modifyMessage(I){var x,C,E;return(0,eb.__awaiter)(this,void 0,void 0,function*(){if(!I.message.serverId)throw new eS({ctx:this.ctx,type:Z.NI.MessageOffline,msg:"message is offline",reachServer:!1,sender:this});let S=null!==(x=I.ext)&&void 0!==x?x:{};for(let I of Object.keys(S))I.startsWith("s:")&&delete S[I];I.mentionedUsers&&(S[Z.v9.MentionedUser]=I.mentionedUsers.join(","));let T=this.resolve(M.ConversationManager).get(I.message.conversationId),R=yield this.api.ModifyMessageExt(Object.assign({conversationShortId:Y.fromValue(I.message.conversationShortId),conversationType:T.type,messageType:I.message.type,conversationId:T.id,messageId:Y.fromValue(I.message.serverId),ticket:T.ticket,inboxType:T.inboxType,ext:S},I.content?{content:I.content,isEdit:!0}:{isEdit:!1}));return(null===(C=null==R?void 0:R.modify_message_ext_body)||void 0===C?void 0:C.ext)&&(I.message.ext=Object.assign(I.message.ext,null===(E=null==R?void 0:R.modify_message_ext_body)||void 0===E?void 0:E.ext)),I.content&&(I.message.content=I.content),this.resolve(M.MessageManager).upsert(I.message),{message:I.message}})}getUserConversationList(I){var x,C;return(0,eb.__awaiter)(this,void 0,void 0,function*(){if(void 0===I.inboxType&&(I.inboxType=this.resolve(M.InboxType).getDefaultInbox()),I.type!==K.im_proto.ConversationType.GROUP_CHAT&&(void 0!==I.includeRole||void 0!==I.excludeRole))throw new eS({ctx:this.ctx,type:Z.NI.InvalidParam,msg:"role filter only available in group chat",sender:this,reachServer:!1});if(void 0!==I.includeRole&&void 0!==I.excludeRole)throw new eS({ctx:this.ctx,type:Z.NI.InvalidParam,msg:"conflict include and exclude",sender:this,reachServer:!1});let E=yield this.api.GetUserConversationList({type:I.type,cursor:I.cursor?Y.fromValue(I.cursor):Y.ZERO,limit:I.limit?Y.fromValue(I.limit):Y.fromNumber(20),sortType:null!==(x=I.sortType)&&void 0!==x?x:K.im_proto.SortType.JOIN_TIME,includeRole:I.includeRole,excludeRole:I.excludeRole,withCold:I.withCold,inboxType:I.inboxType}),S=null===(C=E.body)||void 0===C?void 0:C.get_conversation_list_body,T=S.list.map(I=>eD.fromServerConversation(this.ctx,I,E.log_id));return T.forEach(I=>this.resolve(M.ConversationManager).upsert(I)),{conversation:T,hasMore:null==S?void 0:S.has_more,cursor:null==S?void 0:S.next_cursor}})}unreadCountReport(){return(0,eb.__awaiter)(this,void 0,void 0,function*(){if(!this.ctx.option.unreadCountReport)throw new eS({ctx:this.ctx,msg:"unread count report not enabled",sender:this,type:Z.NI.InvalidParam,reachServer:!1});let I=this.resolve(M.ConversationManager).getConversationArray(),x=eA(I,I=>I.inboxType.toString());for(let I of Object.keys(x)){let C=x[I],E=[],M=0;for(let x of(C.forEach(I=>{let x=this.getNormalMsgUnreadCount(I);M+=x,E.push({shortId:Y.fromString(I.shortId),count:Y.fromNumber(x),type:I.type})}),ek(E,30)))try{yield this.api.UnreadCountReport({total:Y.fromValue(M),conv:x,inboxType:Number.parseInt(I,10)})}catch(I){e_.ctxWarn(this.ctx,"report unread error:",I,"conv:",C)}}0===I.length&&(yield this.api.UnreadCountReport({total:Y.fromValue(0),conv:[],inboxType:this.resolve(M.InboxType).getDefaultInbox()}))})}getServerUnreadCountByUser(I){var x,C;return(0,eb.__awaiter)(this,void 0,void 0,function*(){void 0===I.inboxType&&(I.inboxType=this.resolve(M.InboxType).getDefaultInbox());let E=yield this.ap{total:!0,inboxType:I.inboxType,shortIds:[]});return null!==(C=null===(x=null==E?void 0:E.total_unread_count)||void 0===x?void 0:x.toNumber())&&void 0!==C?C:0})}getServerUnreadCountByConversation(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=new Map,C=eA(I.conversation,I=>I.inboxType.toString());for(let I of Object.keys(C)){let E=C[I].map(I=>Y.fromString(I.shortId)),M=new Map(C[I].map(I=>[I.shortId,I]));for(let[C,S]of Object.entries((yield this.api.GetUnreadCount({total:!1,shortIds:E,inboxType:Number.parseInt(I,10)})).conv_unread_count)){let I=eP(C).toString();M.has(I)&&x.set(M.get(I),S.toNumber())}}return x})}blockConversation(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return void 0===I.normalOnly&&(I.normalOnly=!1),yield this.api.BlockConversation({conversationId:I.conversation.id,conversationShortId:Y.fromValue(I.conversationtype,status:I.block?K.im_proto.BlockStatus.BLOCK:K.im_proto.BlockStatus.UNBLOCK,normalOnly:I.normalOnly,inboxType:I.conversation.inboxType}),yield this.resolve(M.ConversationManager).refreshAsync(I.conversation),I.conversation})}blockMember(I){var x,C,E;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let S={};void 0!==I.blockDuration&&Object.keys(I.blockDuration).forEach(x=>{S[x]=Y.fromValue(I.blockDuration[x])});let T=yield this.api.BlockMember({conversationId:I.conversation.id,conversationShortId:Y.fromValue(I.conversionType:I.conversation.type,status:I.block?K.im_proto.BlockStatus.BLOCK:K.im_proto.BlockStatus.UNBLOCK,time:S,bizExt:null!==(x=I.bizExt)&&void 0!==x?x:{},inboxType:I.conversation.inboxType}),R=this.resolve(M.ParticipantManager).getMap(I.conversation.id);for(let x of Object.keys(null!==(C=I.blockDuration)&&void 0!==C?C:{}))if(!(null===(E=null==T?void 0:T.failed_members)||void 0===E?void 0:E.find(I=>Y.fromValue(x).eq(I)))&&R.has(x)){let C=R.get(x);C.blocked=I.block,thinversation})}getBlockList(I={}){var x;return(0,eb.__awaiter)(this,void 0,void 0,function*(){void 0===I.inboxType&&(I.inboxType=this.resolve(M.InboxType).getDefaultInbox());let C=yield this.api.GetBlockList({cursor:I.cursor?Y.fromValue(I.cursor):Y.ZERO,limit:null!==(x=I.limit)&&void 0!==x?x:20,inboxType:I.inboxType});return{blockList:C.user_info.map(I=>({userId:I.user_id.toString(),createTime:I.create_time.toString()})),hasMore:null==C?void 0:C.has_more,cursor:null==C?void 0:C.next_cursor}})}setBlockList(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){void 0===I.inboxType&&(I.inboxType=this.resolve(M.InboxType).getDefaultInbox()),yield this.api.SetBlockList({applySet:I.value,blocklist:I.userId.map(I=>Y.fromValue(I)),inboxType:I.inboxType})})}checkInBlockList(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return void 0===I.inboxType&&(I.inboxType=this.resolve(M.InboxType).getDefaultInbox()),(yield this.api.CheckInBlockList({userToCheck:Y.fromValue(I.userId),inboxType:I.inboxType})).in_blocklist})}broadcastCreateMessage(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=Object.assign({},I.ext),C=eU.createClientMessage(this.ctx,{type:I.type,content:I.content,ext:x,id:ed(),conversationId:I.conversation.id,mentionedUsers:I.mentionedUsers||[],conversationShortId:I.conversation.shortId,conversationType:I.conversation.type});return C.flightStatus=Z.b3.Created,C.indexInConversation=I.conversation.lastMessageIndex.add(1),C.orderInConversation=I.conversation.lastMessageOrder.add(1),(void 0===I.insert||I.insertewMessage(C,Z.v$.Offline)),C.sendFunc=this.broadcastSendMessage.bind(this),C})}broadcastReceiveMessage(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=yield this.broadcastReceiveMessageWithType(I);return{msgs:x.msgs,hasMore:x.hasMore,cursor:x.cursor}})}broadcastUserCounter(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=I.conversation.map(I=>({shortId:Y.fromString(I.shortId),type:I.type})),C=yield this.api.BroadcastUserCounter({conversations:x}),E={};for(let I of C.infos)E[I.conversation_short_id.toString()]=I.counter;return E})}broadcastGetConversationOnline(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return this.resolve(M.BroadcastManager).getWithOnline(I.conversationId,I.conversationId,K.im_proto.ConversationType.BROADCAST_CHAT)})}broadcastGetConversation(I){return this.resolve(M.BroadcastManager).getConversation(I.conversationId)}modifyMessageProperty(I){var x,C,E,S;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let T;let w={success:!1,payload:I.message},O=this.resolve(M.ConversationManager).getRaw(I.message.conversationId);if(!O)return w;for(let E of I.modifyContent){let M=null!==(C=null===(x=I.message.property[E.key])||void 0===x?void 0:x.findIndex(I=>{var x;return I.idempotentId===(null!==(x=E.idempotentId)&&void 0!==x?x:this.ctx.option.userId)}))&&void 0!==C?C:-1;E.operation||(-1===M?E.operation=K.im_proto.OPERATION_TYPE.ADD_PROPERTY_ITEM:E.operation=K.im_proto.OPERATION_TYPE.REMOVE_PROPERTY_ITEM)}let A=I.modifyContent.map(I=>{var x;return Object.assign(Object.assign({},I),{idempotentId:null!==(x=I.idempotentId)&&void 0!==x?x:this.ctx.option.userId,operation:I.operation})});eV.mergeOperationToCurrent(I.message,A),this.resolve(M.MessageManager).upsert(I.message),this.resolve(M.EventBus).emit(Z.c5.MessagePropertyUpsert,this,I.message);try{T=yield this.api.ModifyMessageProperty({conversationId:O.id,conversationShortId:Y.fromValue(O.shortId),conversationType:O.type,serverId:Y.fromValue(I.message.serverId),clientId:I.message.clientId,ticket:O.ticket,modifyContent:A,inboxType:O.inboxType})}catch(x){for(let C of(w.success=!1,w.statusCode=null==T?void 0:T.status,w.statusMsg=x.msg,w.body=T,I.modifyContent)){let x=null!==(S=null===(E=I.message.property[C.key])||void 0===E?void 0:E.findIndex(I=>{var x;return I.idempotentId===(null!==(x=C.idempotentId)&&void 0!==x?x:this.ctx.option.userId)}))&&void 0!==S?S:-1;-1!==x&&(I.message.property[C.key][x].status=R.Failed)}return this.resolve(M.MessageManager).upsert(I.message),this.resolve(M.EventBus).emit(Z.c5.MessagePropertyUpsert,this,I.message),w}return[K.im_proto.ModifyMessagePropertyStatus.MODIFY_PROPERTY_SUCCESS,K.im_proto.ModifyMessagePropertyStatus.MODIFY_PROPERTY_REPEAT_REQUEST].includes(null==T?void 0:T.status)&&(w.success=!0),I.message.version=null==T?void 0:T.version,this.resolve(M.MessageManager).upsert(I.message),this.resolve(M.EventBus).emit(Z.c5.MessagePropertyUpsert,this,I.message),w.checkCode=Y.ZERO,w.checkMsg="",w.statusCode=T.status,w.statusMsg="",w.body=T,w})}markMessage(I){var x,C;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let E=this.resolve(M.ConversationManager).get(I.message.conversationId);if(I.message.isOffline)throw new eS({ctx:this.ctx,type:Z.NI.InvalidParam,sender:this,msg:"offline message cant be marked",reachServer:!1});yield this.api.MarkMessage({conversationId:I.message.conversationId,conversationShortId:Y.fromValue(I.message.conversationShortId),conversationType:I.message.conversationType,serverMessageId:Y.fromValue(I.message.serverId),actionType:I.actionType,doAction:null===(x=I.doAction)||void 0===x||x,sortTime:Y.fromValue(null!==(C=I.sortTime)&&void 0!==C?C:Y.ZERO),tag:void 0!==I.tag?Y.fromValue(I.tag):void 0,inboxType:E.inboxType})})}pullMarkMessage(I){var x,C,E,M,S,T,R,w;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let O=yield this.api.PullMarkMessage({conversationId:null===(x=I.conversation)||void 0===x?void 0:x.id,conversationShortId:(null===(C=I.conversation)||void 0===C?void 0:C.shortId)===void 0?void 0:Y.fromValue(I.conversation.shortId),conversationType:null===(E=I.conversation)||void 0===E?void 0:E.type,cursor:Y.fromValue(null!==(M=I.cursor)&&void 0!==M?M:Y.ZERO),asc:null!==(S=I.ascending)&&void 0!==S&&S,limit:Y.fromValue(null!==(T=I.limit)&&void 0!==T?T:50),actionType:I.actionType,tag:void 0!==I.tag?Y.fromValue(I.tag):void 0,inboxType:null!==(w=null===(R=I.conversation)||void 0===R?void 0:R.inboxType)&&void 0!==w?w:0}),A=O.body.pull_mark_message_body,N=[];return A.messages.forEach(I=>{let x=eU.fromServerMessage(this.ctx,I,O.log_id);N.push(x)}),{message:N,msgExtras:A.msg_extras,hasMore:A.has_more,cursor:A.next_cursor}})}batchUnmarkMessage(I){var x;rvoid 0,void 0,function*(){if(void 0===I.messages||0===I.messages.length)throw new eS({ctx:this.ctx,type:Z.NI.InvalidParam,msg:"invalid message list",sender:this});let C=yield this.api.BatchUnmarkMessage({conversationId:I.messages[0].conversationId,conversationShortId:Y.fromValue(I.messages[0].conversationShortId),conversationType:I.messages[0].conversationType,serverMessageIds:I.messages.map(I=>Y.fromValue(I.serverId)),actionType:I.actionType,tag:void 0!==I.tag?Y.fromValue(I.tag):void 0});return{success:0===C.status,checkCode:C.check_code,checkMsg:C.check_message,statusCode:null!==(x=C.status)&&void 0!==x?x:-1,body:C,payload:I.messages}})}markMessageUnreadCountReport(I){var x,C,E;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let M={};if(void 0!==I.tagUnreadCount)for(let x of Object.keys(I.tagUnreadCount))M[x]=Y.fromNumber(I.tagUnreadCount[x]);let S=yield this.api.MarkMsgUnreadCountReport({conversationId:null===(x=null==I?void 0:I.conversation)||void 0===x?void 0:x.id,conversationShortId:(null===(C=null==I?void 0:I.conversation)||void 0===C?void 0:C.shortId)===void 0?void 0:Y.fromValue(null==I?void 0:I.conversation.shortId),conversationType:null===(E=null==I?void 0:I.conversation)||void 0===E?void 0:E.type,totalUnreadCount:void 0!==I.totalUnreadCount?Y.fromNumber(I.totalUnreadCount):void 0,tagUnreadCount:M});return{setTotalStatus:S.set_total_status,failedTagList:S.failed_tag_list}})}markMessageGetUnreadCount(I){var x,C,E,M,S,T;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let R=yield this.api.MarkMsgGetUnreadCount({conversationId:null===(x=null==I?void 0:I.conversation)||void 0===x?void 0:x.id,conversationShortId:(null===(C=null==I?void 0:I.conversation)||void 0===C?void 0:C.shortId)===void 0?void 0:Y.fromValue(null==I?void 0:I.conversation.shortId),conversationType:null===(E=null==I?void 0:I.conversation)||void 0===E?void 0:E.type,getTotal:null!==(M=I.getTotal)&&void 0!==M&&M,tags:null===(S=I.tags)||void 0===S?void 0:S.map(I=>Y.fromValue(I))}),w=null!==(T=R.tag_unread_count)&&void 0!==T?T:{},O={};for(let I of Object.keys(w))O[eP(I).toString()]=w[I].toNumber();return{tagUnreadCount:O,totalCount:R.total_count,failedTagList:R.failed_tag_list}})}getMessageByServerId(I){var x,C;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let E=this.resolve(M.MessageManager).getByServerIdRaw(I.conversation.id,I.serverMessageId);if(E)return E;try{let E=yield this.api.GetMessageByServerId({conversationId:I.conversation.id,conversationShortId:Y.fromString(I.conversation.shortId),conversationType:I.conversation.type,serverId:Y.fromString(I.serverMessageId),inboxType:I.conversation.inboxType}),M=null===(C=null===(x=E.body)||void 0===x?void 0:x.get_message_by_id_body)||void 0===C?void 0:C.msg_info;if(!M.body)return null;return eU.fromServerMessage(this.ctx,M.body,E.log_id)}catch(I){return null}})}getMessageReferenceList(I){var x,C;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let E;if(I.message.isRootReference)E=I.message;else{let S=this.resolve(M.ConversationManager).get(I.message.conversationId),T=null===(C=null===(x=I.message.referenceInfo)||void 0===x?void 0:x.root_message_id)||void 0===C?void 0:C.toString();if(void 0===T)return[];let R=yield this.getMessageByServerId({conversation:S,serverMessageId:T});if(!R)return[];E=R}let S=[E];return S.push(...this.resolve(M.MessageManager).getList(E.conversationId).filter(I=>{var x,C;return(null===(C=null===(x=I.referenceInfo)||void 0===x?void 0:x.root_message_id)||void 0===C?void 0:C.toString())===E.serverId})),S})}convertVoiceToText(I){var x;return(0,eb.__awaiter)(this,void 0,void 0,function*(){if(!(null==I?void 0:I.serverId))throw new eS({ctx:this.ctx,type:Z.NI.MPInvalidArgument,msg:"message is offline",reachServer:!1,sender:this});if((null==I?void 0:I.type)!==K.im_proto.MessageType.MESSAGE_TYPE_AUDIO)throw new eS({ctx:this.ctx,type:Z.NI.InvalidParam,msg:"message is not audio",reachServer:!1,sender:this});let C=null===(x=JSON.parse(null==I?void 0:I.content))||void 0===x?void 0:x.__files,E=Object.keys(C),{type:S,ext:T}=C[E[0]];if("wav"!==S)throw new eS({ctx:this.ctx,type:Z.NI.InvalidParam,msg:"audio content is not wav",reachServer:!1,sender:this});if(T[Z.v9.FileExtKeyAudioAsrText])return I;try{let x=yield this.api.ConvertVoiceToText({content:null==I?void 0:I.content,uid:Y.fromValue(this.ctx.option.userId),server_message_id:Y.fromValue(null==I?void 0:I.serverId),audioOptions:{vid:T[N.Vid]},conv_short_id:Y.fromValue(null==I?void 0:I.conversationShortId)}),{audio:C,check_code:E,check_message:S}=null==x?void 0:x.audio_recognition_body;return E&&S&&(I.ext[Z.v9.RecognitionResponseCheckCode]=null==E?void 0:E.toString(),I.ext[Z.v9.RecognitionResponseCheckMsg]=null==S?void 0:S.toString()),I.content=null==C?void 0:C.content,this.resolve(M.MessageManager).upsert(I),I}catch(I){throw new eS({ctx:this.ctx,type:Z.NI.ServerError,msg:"Voice conversion failed",reachServer:!1,sender:this})}})}getTagList(I={}){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let{filterDeletedTag:x=!0}=I,{tag_meta_info_list:C,user_conv_tag_limit:E,user_custom_tag_meta_info_list:M,user_conv_custom_tag_limit:S,user_custom_tag_meta_info_limit:T}=(yield this.api.GetTagMetaInfo({filterDeletedTag:x})).get_tag_meta_info_body,R=(C||[]).map(I=>t$.fromServerTag(I)),w=E.toNumber();return{tagList:R,tagLimit:w,userCustomTagList:(M||[]).map(I=>t$.fromServerTag(I)),userCustomTagLimit:S.toNumber(),userCustomTagCreateLimit:T.toNumber()}})}setConversationTag(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let{shortIds:x,tagIds:C,isRemove:E=!1,userCustomTagIds:S}=I,T=Array.isArray(x)?x:[x],R=Array.isArray(C)?C:C?[C]:[],w=Array.isArray(S)?S:S?[S]:[],O=(yield this.api.SetConversationTag({shortIds:T.map(I=>Y.fromString(I)),tagIds:R.map(I=>Y.fromString(I)),isRemove:E,userCustomTagIds:w.map(I=>Y.fromString(I)),inboxType:this.resolve(M.InboxType).getDefaultInbox()})).set_conversation_tag_body,A=O.failed_conv_short_ids||[],N=[];for(let I of T)if(!A.includes(Y.fromString(I))){let x=this.resolve(M.ConversationManager).getWithShortIdRaw(I);x&&N.push(x)}return yield this.resolve(M.ConversationManager).refreshAsync(N),{success:!0,payload:null,body:O,failedConversationShortIds:A.map(I=>String(I))}})}manageTagMetaInfo(I){var x,C,E,S,T,R,w,O,A,N;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let P=(yield this.api.ManageTagMetaInfo({addTagMetaInfos:null===(x=I.add)||void 0===x?void 0:x.map(I=>{var x;return{tag_name:I.name,ext:I.ext,init_conv_short_ids:null===(x=I.initConvShortIds)||void 0===x?void 0:x.map(I=>Y.fromValue(I))}}),updateTagMetaInfos:null===(C=I.update)||void 0===C?void 0:C.map(I=>({tag_id:Y.fromString(I.id),tag_name:I.name,upsert_ext:I.upsertExt,delete_ext:I.deleteExt})),deleteTagIds:null===(E=I.delete)||void 0===E?void 0:E.map(I=>Y.fromValue(I)),inboxType:null!==(S=I.inboxType)&&void 0!==S?S:this.resolve(M.InboxType).getDefaultInbox()})).manage_tag_meta_info_body;return{success:!0,payload:null,body:P,addResults:null!==(R=null===(T=P.add_results)||void 0===T?void 0:T.map(I=>{var x,C;return{tagId:I.tag_id.toString(),createSuccess:I.tag_id.neq(Y.NEG_ONE),failedConversationShortIds:null!==(C=null===(x=I.failed_conversation_ids)||void 0===x?void 0:x.map(I=>I.toString()))&&void 0!==C?C:[]}}))&&void 0!==R?R:[],deleteFailed:null!==(O=null===(w=P.delete_failed_tag_ids)||void 0===w?void 0:w.map(I=>I.toString()))&&void 0!==O?O:[],updateFailed:null!==(N=null===(A=P.update_failed_tag_ids)||void 0===A?void 0:A.map(I=>I.toString()))&&void 0!==N?N:[]}})}install(){this.api=new tU(this.getContext()),this.ctx.register(M.BroadcastManager,new tG(this.ctx)),this.ctx.register(M.ExtensionApi,this.api),this.ctx.register(M.ExtensionPlugin,this),this.instance.deleteConversation=this.extendFunc(this.deleteConversation),this.instance.deleteMessage=this.extendFunc(this.deleteMessage),this.instance.leaveConversation=this.extendFunc(this.leaveConversation),this.instance.getConversationListByTop=this.extendFunc(this.getConversationListByTop),this.instance.getConversationListByFavorite=this.extendFunc(this.getConversationListByFavorite),this.instance.getConversationListByTag=this.extendFunc(this.getConversationListByTag),this.instance.addParticipants=this.extendFunc(this.addParticipants),this.instance.removeParticipants=this.extendFunc(this.removeParticipants),this.instance.updateParticipant=this.extendFunc(this.updateParticipant),this.instance.setConversationSettingInfo=this.extendFunc(this.setConversationSettingInfo),this.instance.setConversationCoreInfo=this.extendFunc(this.setConversationCoreInfo),this.instance.upsertConversationSettingExtInfo=this.extendFunc(this.upsertConversationSettingExtInfo),this.instance.upsertConversationCoreExtInfo=this.extendFunc(this.upsertConversationCoreExtInfo),this.instance.setConversationWeakMuteConfig=this.extendFunc(this.setConversationWeakMuteConfig),this.instance.getConversationParticipants=this.extendFunc(this.getConversationParticipants),this.instance.getConversationParticipantsAsync=this.extendFunc(this.getConversationParticipantsAsync),this.instance.getConversationParticipantsByPage=this.extendFunc(this.getConversationParticipantsByPage),this.instance.sendUserAction=this.extendFunc(this.sendUserAction),this.instance.sendInputStatus=this.extendFunc(this.sendInputStatus),this.instance.upsertMessageExt=this.extendFunc(this.upsertMessageExt),this.instance.modifyMessageContent=this.extendFunc(this.modifyMessageContent),this.instance.modifyMessage=this.extendFunc(this.modifyMessage),this.instance.dissolveConversation=this.extendFunc(this.dissolveConversation),this.instance.modifyMessageProperty=this.extendFunc(this.modifyMessageProperty),this.instance.unreadCountReport=this.extendFunc(this.unreadCountReport),this.instance.getServerUnreadCountByConversation=this.extendFunc(this.getServerUnreadCountByConversation),this.instance.getServerUnreadCountByUser=this.extendFunc(this.getServerUnreadCountByUser),this.instance.getUserConversationList=this.extendFunc(this.getUserConversationList),this.instance.blockConversation=this.extendFunc(this.blockConversation),this.instance.blockMember=this.extendFunc(this.blockMember),this.instance.sendP2PMessage=this.extendFunc(this.sendP2PMessage),this.instance.setBlockList=this.extendFunc(this.setBlockList),this.instance.getBlockList=this.extendFunc(this.getBlockList),this.instance.checkInBlockList=this.extendFunc(this.checkInBlockList),this.instance.broadcastCreateMessage=this.extendFunc(this.broadcastCreateMessage),this.instance.broadcastReceiveMessage=this.extendFunc(this.broadcastReceiveMessage),this.instance.broadcastUserCounter=this.extendFunc(this.broadcastUserCounter),this.instance.broadcastGetConversationOnline=this.extendFunc(this.broadcastGetConversationOnline),this.instance.broadcastGetConversation=this.extendFunc(this.broadcastGetConversation),this.instance.markMessage=this.extendFunc(this.markMessage),this.instance.pullMarkMessage=this.extendFunc(this.pullMarkMessage),this.instance.getMessageByServerId=this.extendFunc(this.getMessageByServerId),this.instance.batchUnmarkMessage=this.extendFunc(this.batchUnmarkMessage),this.instance.markMessageUnreadCountReport=this.extendFunc(this.markMessageUnreadCountReport),this.instance.markMessageGetUnreadCount=this.extendFunc(this.markMessageGetUnreadCount),this.instance.getMessageReferenceList=this.extendFunc(this.getMessageReferenceList),this.instance.convertVoiceToText=this.extendFunc(this.convertVoiceToText),this.instance.getTagList=this.extendFunc(this.getTagList),this.instance.setConversationTag=this.extendFunc(this.setConversationTag),this.instance.manageTagMetaInfo=this.extendFunc(this.manageTagMetaInfo),this.instance.addConversationBots=this.extendFunc(this.addConversationBots),this.instance.removeConversationBots=this.extendFunc(this.removeConversationBots),this.instance.getConversationBots=this.extendFunc(this.getConversationBots),this.addEventHandler(),this.resolve(M.MessageManager).injectProcessor(new tF(this.ctx)),this.resolve(M.MessageManager).injectProcessor(new tH(this.ctx)),this.resolve(M.MessageManager).injectProcessor(new tW(this.ctx)),this.resolve(M.MessageManager).injectProcessorBefore(new tq(this.ctx)),this.resolve(M.MessageManager).injectProcessor(new tK(this.ctx))}receivePacket(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){I.cmd===K.im_proto.IMCMD.NEW_BROADCAST_MSG_NOTIFY&&(yield this.receiveBroadcastPacket(I)),I.cmd===K.im_proto.IMCMD.NEW_P2P_MSG_NOTIFY&&(yield this.receiveP2PMessage(I))})}receiveP2PMessage(I){var x;return(0,eb.__awaiter)(this,void 0,void 0,function*(){if(null===(x=I.body)||void 0===x?void 0:x.has_new_p2p_message_notify){let x=I.body.has_new_p2p_message_notify,C=new tj;C.sendType=x.send_type,C.sender=x.sender.toString(),C.secSender=x.sec_sender,C.conversationId=x.conversation_id,C.conversationShortId=x.conversation_short_id.toString(),C.conversationType=x.conversation_type,C.type=x.message_type,C.content=x.content,C.ext=x.ext,C.createTime=new Date(x.create_time.toNumber()),this.resolve(M.EventBus).emit(Z.c5.ReceiveNewP2PMessage,this,C)}})}receiveBroadcastPacket(I){var x;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let C=I.body.has_new_message_notify,E=C.message,S=eU.fromServerMessage(this.ctx,E,I.log_id);S.ext||(S.ext={}),yield this.resolve(M.BroadcastManager).processNewMessage(S,Z.v$.Online);let T=this.resolve(M.BroadcastManager).getConversation(S.conversationId),R=T.localIndex;if(T.setConversationCursor(C.next_cursor),R.gt(Y.ZERO)&&(null===(x=C.previous_cursor)||void 0===x?void 0:x.gt(R))){let I=!0,x=R,C=0,E=5;for(;I&&C<E;){let E=yield this.broadcastReceiveMessageWithType({conversation:T,cursor:x,limit:50,reverse:!1,pullType:1});I=E.hasMore,x=E.cursor,yield this.resolve(M.BroadcastManager).processNewMessagesFromPull(E.msgs,Z.v$.BroadcastLoadMore,E.log_id),C++}}})}dispose(){return(0,eb.__awaiter)(this,void 0,void 0,function*(){this.resolve(M.ParticipantManager).dispose(),this.resolve(M.BroadcastManager).dispose()})}addEventHandler(){this.ctx.option.autoReadIndex&&this.resolve(M.EventBus).subscribe(Z.c5.MessageUpsert,I=>(0,eb.__awaiter)(this,void 0,void 0,function*(){if(I.flightStatus===Z.b3.Inflight)return;let x=this.resolve(M.ConversationManager).getRaw(I.conversationId);if(!x||0===this.resolve(M.ParticipantManager).getRaw(x.id).length)return;let C=this.resolve(M.ParticipantManager).getByUserIdRaw(x.id,I.sender);C&&I.moveReadIndex&&(C.readIndex=I.indexInConversation,C.readOrder=I.orderInConversation,this.resolve(M.ParticipantManager).upsert(x.id,C),e_.ctxDebug(this.ctx,`auto readindex with read:${C.readIndex.toString()} & order:${C.readOrder.toString()}`))})),this.resolve(M.EventBus).subscribe(Z.c5.ReceiveNewP2PMessage,I=>(0,eb.__awaiter)(this,void 0,void 0,function*(){if(I.type===K.im_proto.MessageType.MESSAGE_TYPE_READ_COMMAND){let x=this.resolve(M.ConversationManager).getWithShortIdRaw(I.conversationShortId);if(!x)return;let C=ep.parse(I.content),E=Y.fromValue(C.P2PSender).toString(),S=this.resolve(M.ParticipantManager).getByUserIdRaw(x.id,E);if(!S)return;let T=S.readIndex,R=Y.fromValue(C.P2PSenderReadIndex);T.gte(R)||(S.readIndex=R,this.resolve(M.ParticipantManager).upsert(x.id,S),this.resolve(M.EventBus).emit(Z.c5.ConversationUpsert,this,x),this.resolve(M.EventBus).emitEmpty(Z.c5.ConversationChange,this),e_.ctxDebug(this.ctx,`p2p update ${S.userId} readindex: ${T.toString()} to ${R.toString()}`))}}))}broadcastReceiveMessageWithType(I){var x,C,E,S,T;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let R=yield this.api.BroadcastReceiveMessage({conversationId:I.conversation.id,conversationShortId:Y.fromString(I.conversation.shortId),conversationType:I.conversation.type,cursor:I.cursor?Y.fromValue(I.cursor):I.conversation.localIndex,limit:I.limit?Y.fromValue(I.limit):Y.fromNumber(20),reverse:null!==(x=I.reverse)&&void 0!==x&&x,pullType:null!==(C=I.pullType)&&void 0!==C?C:0,inboxType:I.conversation.inboxType}),w=null===(E=R.body)||void 0===E?void 0:E.broadcast_recv_message_body,O=null!==(T=null===(S=w.messages)||void 0===S?void 0:S.map(I=>eU.fromServerMessage(this.ctx,I,R.log_id)))&&void 0!==T?T:[];return yield this.resolve(M.BroadcastManager).processNewMessagesFromPull(O,Z.v$.BroadcastLoadMore,R.log_id),w.next_cursor&&I.conversation.setConversationCursor(w.next_cursor),{msgs:O,hasMore:w.has_more,cursor:w.next_cursor,log_id:R.log_id}})}broadcastSendMessage(I){var x;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let C=this.resolve(M.BroadcastManager).getConversation(I.conversationId),E={success:!1,payload:I};I.flightStatus=Z.b3.Inflight;try{let M=yield this.api.BroadcastSendMessage({conversationId:I.conversationId,conversationShortId:Y.fromString(I.conversationShortId),conversationType:I.conversationType,clientId:I.clientId,content:I.content,ticket:C.ticket,ext:I.ext,type:I.type,mentionedUsers:I.mentionedUsers.map(I=>Y.fromString(I)),inboxType:C.inboxType}),S=null===(x=M.body)||void 0===x?void 0:x.broadcast_send_message_body;if(E.body=S,E.checkCode=S.check_code,E.checkMsg=S.check_message,E.statusCode=S.status,E.statusMsg=S.extra_info,this.ctx.option.debug&&(I.ext[Z.v9.LocalLogId]=M.log_id),0===S.status){let x=S.server_message_id.toString();I.serverId=x,I.flightStatus=Z.b3.Succeeded,E.success=!0,I.isOffline=!1}else I.flightStatus=Z.b3.Rejected,S.status===K.im_proto.SendMessageStatus.CHECK_MSG_NOT_PASS_BUT_SELF_VISIBLE&&(I.flightStatus=Z.b3.SelfVisible)}catch(x){I.flightStatus=Z.b3.Failed}return E})}getNormalMsgUnreadCount(I){return I.isMuted?0:I.pushStatus===Z.Bs.PartAllow?I.unreadCountWithWhiteList:I.unreadCount}addConversationBots(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=yield this.api.ConversationAddBots({conversationId:I.conversation.id,conversationShortId:Y.fromString(I.conversation.shortId),conversationType:I.conversation.type,bots:I.botIds.map(I=>Y.fromValue(I)),bizExt:I.bizExt});return null==x?void 0:x.conversation_add_bots_body})}removeConversationBots(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=yield this.api.ConversationRemoveBots({conversationId:I.conversation.id,conversationShortId:Y.fromString(I.conversation.shortId),conversationType:I.conversation.type,bots:I.botIds.map(I=>Y.fromValue(I)),bizExt:I.bizExt});return null==x?void 0:x.conversation_remove_bots_body})}getConversationBots(I){var x,C,E,S;return(0,eb.__awaiter)(this,void 0,void 0,function*(){return null!==(S=null===(E=null===(C=null===(x=(yield this.resolve(M.CoreApi).GetConversationInfoListV2({conversations:[I.conversation].map(I=>({conversationId:I.id,conversationShortId:Y.fromString(I.shortId),conversationType:I.type})),inboxType:I.conversation.inboxType})).body)||void 0===x?void 0:x.get_conversation_info_list_v2_body)||void 0===C?void 0:C.conversation_info_list)||void 0===E?void 0:E[0].bots)&&void 0!==S?S:[]})}}class tz extends tD{GetStrangerConversationList(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({get_stranger_conversation_body:{cursor:I.cursor,count:Y.fromValue(I.limit),show_total_unread:!0}});return this.sendWithRawBody(x,K.im_proto.IMCMD.GET_STRANGER_CONVERSATION_LIST)})}GetStrangerConversationMessage(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({get_stranger_messages_body:{conversation_short_id:I.shortId,reset_unread_count:I.resetUnreadCount}});return this.sendWithRawBody(x,K.im_proto.IMCMD.GET_STRANGER_MESSAGES_IN_CONVERSATION)})}DeleteStrangerMessage(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({delete_stranger_message_body:{conversation_short_id:I.shortId,server_message_id:I.serverId}});return this.send(x,K.im_proto.IMCMD.DELETE_STRANGER_MESSAGE)})}DeleteStrangerConversation(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({delete_stranger_conversation_body:{conversation_short_id:I.shortId}});return this.send(x,K.im_proto.IMCMD.DELETE_STRANGER_CONVERSATION)})}MarkStrangerConversationRead(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({mark_stranger_conversation_read_body:{conversation_short_id:I.shortId}});return this.send(x,K.im_proto.IMCMD.MARK_STRANGER_CONVERSATION_READ)})}MarkAllStrangerConversationRead(){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let I=K.im_proto.RequestBody.create({mark_stranger_all_conversation_read_body:{}});return this.send(I,K.im_proto.IMCMD.MARK_ALL_STRANGER_CONVERSATIONS_READ)})}DeleteAllStrangerConversation(){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let I=K.im_proto.RequestBody.create({delete_stranger_all_conversation_body:{}});return this.send(I,K.im_proto.IMCMD.DELETE_ALL_STRANGER_CONVERSATIONS)})}}class tZ extends eD{get unreadCount(){return this.internalUnreadCount}set unreadCount(I){this.internalUnreadCount=I}get mode(){let I=this.toParticipantUserId,x=this.id.split(":");return x[2]===I?1:x[3]===I?2:3}get ext(){return this.coreInfo.ext}set ext(I){this.coreInfo.ext=I}}class tJ extends tV{process(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){if(I.data.type===K.im_proto.MessageType.MESSAGE_TYPE_MODE_CHANGE){let x=this.resolve(M.ConversationManager).getRaw(I.data.conversationId);if(!x)return e_.ctxDebug(this.ctx,`conversation ${I.data.conversationId} not exist, ignore upgrade`),I;if(!x.isStrangerConversation)return e_.ctxDebug(this.ctx,`conversation ${I.data.conversationId} not stranger, ignore upgrade`),I;this.resolve(M.Convager).getWithOnline(I.data.conversationId,I.data.conversationShortId,I.data.conversationType);this.resolve(M.ConversationManager).markRead(C.id,C.lastMessageIndex,C.badgeCount,[]),e_.ctxDebug(this.ctx,"stranger upgrade,",C),this.resolve(M.EventBus).emit(Z.c5.StrangerUpgrade,this,C),I.needContinue=!1}return I})}}class tX extends eG{constructor(){super(...arguments),this.name="StrangerPlugin",this.internalUnreadCount=0}getStrangerConversationList(I={}){var x,C,E,S,T,R,w;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let O=yield this.api.GetStrangerConversationList({cursor:I.cursor?Y.fromValue(I.cursor):Y.ZERO,limit:null!==(x=I.limit)&&void 0!==x?x:10}),A=null===(C=O.body)||void 0===C?void 0:C.get_stranger_conversation_body,N=A.conversation_list;this.internalUnreadCount=A.total_unread;let P=!1;if((null===(E=I.cursor)||void 0===E?void 0:E.toString())==="0"&&1===I.limit){let I=yield this.getStrangerPreview({sync:!1});N&&1===N.length&&(null===(S=null==I?void 0:I.conversation)||void 0===S?void 0:S.id)===N[0].conversation_id&&(null===(T=null==I?void 0:I.message)||void 0===T?void 0:T.serverId)===(null===(w=null===(R=N[0].last_message)||void 0===R?void 0:R.server_message_id)||void 0===w?void 0:w.toString())&&(null==I?void 0:I.unreadCount)===(null==A?void 0:A.total_unread)&&(P=!0)}return{conversation:N.map(I=>{var x;let C=new tZ(this.ctx);if(C.coreInfo=new eT(C),C.settingInfo=new eR(C),C.id=I.conversation_id,C.shortId=I.conversation_short_id.toString(),C.type=K.im_proto.ConversationType.ONE_TO_ONE_CHAT,C.unreadCount=I.unread,C.isOffline=!1,C.firstPageParticipant=K.im_proto.ParticipantsPage.create({participants:I.participants}),C.ext=null!==(x=I.ext)&&void 0!==x?x:{},!P){this.resolve(M.ConversationManager).upsert(C);let x=eU.fromServerMessage(this.ctx,I.last_message,O.log_id);this.resolve(M.MessageManager).upsert(x)}return C}),unreadCount:null==A?void 0:A.total_unread,hasMore:null==A?void 0:A.has_more,cursor:null==A?void 0:A.next_cursor}})}getStrangerConversationMessage(I){var x,C;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let E=yield this.api.GetStrangerConversationMessage({shortId:Y.fromString(I.conversation.shortId),resetUnreadCount:null!==(x=I.resetUnreadCount)&&void 0!==x&&x});return(null===(C=E.body)||void 0===C?void 0:C.get_stranger_messages_body).messages.forEach(I=>this.resolve(M.MessageManager).upsert(eU.fromServerMessage(this.ctx,I,E.log_id))),this.resolve(M.MessageManager).getList(I.conversation.id)})}deleteStrangerMessage(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){yield this.api.DeleteStrangerMessage({serverId:Y.fromString(I.message.serverId),shortId:Y.fromString(I.conversation.shortId)}),this.resolve(M.MessageManager).delete(I.conversation.id,I.message.serverId)})}deleteStrangerConversation(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){yield this.api.DeleteStrangerConversation({shortId:Y.fromString(I.conversation.shortId)}),this.resolve(M.ConversationManager).delete(I.conversation.id)})}deleteAllStrangerConversation(){return(0,eb.__awaiter)(this,void 0,void 0,function*(){yield this.api.DeleteAllStrangerConversation(),this.resolve(M.ConversationManager).getConversationArray(I=>0!==I.mode).forEach(I=>this.resolve(M.ConversationManager).delete(I.id)),this.internalUnreadCount=0})}markStrangerConversationRead(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){yield this.api.MarkStrangerConversationRead({shortId:Y.fromString(I.conversation.shortId)}),this.internalUnreadCount-=I.conversation.unreadCount,I.conversation.unreadCount=0,this.resolve(M.ConversationManager).upsert(I.conversation)})}markAllStrangerConversationRead(){return(0,eb.__awaiter)(this,void 0,void 0,function*(){yield this.api.MarkAllStrangerConversationRead(),this.resolve(M.ConversationManager).getConversationArray(I=>0!==I.mode).forEach(I=>{I.unreadCount=0,this.resolve(M.ConversationManager).upsert(I)}),this.internalUnreadCount=0})}getStrangerTotalUnread(){return this.internalUnreadCount}getStrangerPreview(I={}){var x;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let C=yield this.refreshStrangerPreviewConversation(null!==(x=null==I?void 0:I.sync)&&void 0!==x&&x);return C?{conversation:C,message:C.lastVisibleMessage,unreadCount:this.internalUnreadCount}:null})}getLocalStrangerConversation(){return this.resolve(M.ConversationManager).getConversationArray(I=>0!==I.mode)}install(){this.api=this.register(M.StrangerApi,tz),this.register(M.StrangerPlugin,this),this.instance.getStrangerConversationList=this.extendFunc(this.getStrangerConversationList),this.instance.getStrangerConversationMessage=this.extendFunc(this.getStrangerConversationMessage),this.instance.deleteStrangerMessage=this.extendFunc(this.deleteStrangerMessage),this.instance.deleteStrangerConversation=this.extendFunc(this.deleteStrangerConversation),this.instance.deleteAllStrangerConversation=this.extendFunc(this.deleteAllStrangerConversation),this.instance.markStrangerConversationRead=this.extendFunc(this.markStrangerConversationRead),this.instance.markAllStrangerConversationRead=this.extendFunc(this.markAllStrangerConversationRead),this.instance.getStrangerTotalUnread=this.extendFunc(this.getStrangerTotalUnread),this.instance.getStrangerPreview=this.extendFunc(this.getStrangerPreview),this.instance.getLocalStrangerConversation=this.extendFunc(this.getLocalStrangerConversation),this.resolve(M.MessageManager).injectProcessor(new tJ(this.ctx)),this.resolve(M.EventBus).subscribe(Z.c5.StrangerUpgrade,I=>(0,eb.__awaiter)(this,void 0,void 0,function*(){yield this.resolve(M.CoreInstance).getMessagesByUser({inboxType:I.inboxType})}))}init(){return(0,eb.__awaiter)(this,void 0,void 0,function*(){try{yield this.getStrangerPreview({sync:!0})}catch(I){e_.ctxWarn(this.ctx,"stranger plugin init error:",I)}})}receivePacket(I){var x;return(0,eb.__awaiter)(this,void 0,void 0,function*(){if(I.cmd===K.im_proto.IMCMD.STRANGER_NEW_MSG_NOTIFY){let C=null===(x=I.body)||void 0===x?void 0:x.has_new_message_notify.message;if(!this.resolve(M.ConversationManager).getRaw(C.conversation_id))return;let E=eU.fromServerMessage(this.ctx,C,I.log_id);this.resolve(M.MessageManager).upsert(E),this.internalUnreadCount++,this.resolve(M.EventBus).emit(ZStrangerMessage,this,E)}})}ticker(){return(0,eb.__awaiter)(this,void 0erPreviewConversation(!0))})}refreshStrangerPreviewConversation(I=!1){return(0,eb.__awaiter)(this,void 0,void 0,function*(){for(let x of(I&&(yield this.getStrangerConversationList({cursor:Y.ZERO,limit:1})),this.resolve(M.ConversationManager).getConversationArray(I=>0!==I.mode)))if(x.lastVisibleMessage)return x;return null})}}class tQ extends eG{constructor(){super(...arguments),this.name="SharkPlugin",this.enabled=!0}install(){this.register(M.SharkPlugin,this);try{(void 0===this.ctx.option.sharkAppName||void 0===this.ctx.option.sharkPriorityRegion)&&(e_.ctxWarn(this.ctx,"shark required field not provided, ignore shark params"),this.enabled=!1),"undefined"==typeof navigator&&e_.ctxWarn(this.ctx,"window.navigator not available, may missing param"),"undefined"==typeof screen&&e_.ctxWarn(this.ctx,"window.screen not available, may missing param"),"undefined"==typeof document&&e_.ctxWarn(this.ctx,"window.document not available, may missing param"),"undefined"!=typeof Intl&&"undefined"!=typeof Intl&&"function"==typeof Intl.DateTimeFormat&&"function"==typeof Intl.DateTimeFormat().resolvedOptions||e_.ctxWarn(this.ctx,"window.Intl not available, may missing param")}catch(I){e_.ctxError(this.ctx,"shark init error:",I),this.enabled=!1}}sendPacket(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return this.enabled&&this.fillSharkParam(I),I})}fillSharkParam(I){var x,C,E,M,S,T,R,w,O,A,N,P,L,D,U,B,G;let V={};try{V.session_aid=null!==(x=this.ctx.option.appId.toString())&&void 0!==x?x:"",V.session_did=null!==(C=this.ctx.option.deviceId.toString())&&void 0!==C?C:"",V.app_name=this.ctx.option.sharkAppName,V.priority_region=this.ctx.option.sharkPriorityRegion,"undefined"!=typeof navigator&&(V.user_agent=null!==(E=navigator.userAgent)&&void 0!==E?E:"",V.cookie_enabled=null!==(S=null===(M=navigator.cookieEnabled)||void 0===M?void 0:M.toString())&&void 0!==S?S:"",V.browser_language=null!==(T=navigator.language)&&void 0!==T?T:"",V.browser_platform=null!==(R=navigator.platform)&&void 0!==R?R:"",V.browser_name=null!==(w=navigator.appCodeName)&&void 0!==w?w:"",V.browser_version=null!==(O=navigator.appVersion)&&void 0!==O?O:"",V.browser_online=null!==(N=null===(A=navigator.onLine)||void 0===A?void 0:A.toString())&&void 0!==N?N:""),"undefined"!=typeof screen&&(V.screen_width=null!==(L=null===(P=screen.width)||void 0===P?void 0:P.toString())&&void 0!==L?L:"",V.screen_height=null!==(U=null===(D=screen.height)||void 0===D?void 0:D.toString())&&void 0!==U?U:""),"undefined"!=typeoimezone_name=null!==(G=Intl.DateTimeFormat().resolvedOptions().timeZone)&&void 0!==G?G:"")}catch(I){e_.ctxWarn(this.ctx,"load shark param error, may missing param",I)}I.headers=Object.assign(Object.assign({},I.headers),V)}}!function(I){I.MultimediaMessageUpload="imsdk_upload_msg",I.InitHandler="imsdk_init_handler",I.Exception="imsdk_exception",I.SaveMessageError="imsdk_save_msg_error",I.MessageAck="imsdk_message_ack"}(D||(D={}));class t0 extends eG{constructor(){super(...arguments),this.name="MetricsPlugin",this.ignoreMethods=["getStrangerTotalUnread","getLocalStrangerConversation","checkRtcRequirements","parseContent","unreadCountReport","getMessageReferencedInfo","initAdapter","getConversationParticipants","broadcastGetConversation","getConversationMessages","createMessage","createTextMessage","createFileMessage","sendMessage","getMessageReadReceipt","createConversation","getConversationOnline","getConversationListOnline","getStrangerPreview","emojify","randomEmoji","getAllEmoji","constructor","getUserCursor","setUserCursor","init","getConversation","getConversationList","dispose","intervalFunc","receivePacket","messageFilter","sendMessageObject","tickerUpdate","prepareHistoryForInbox","prepareToken","clearCache","resolve","getContext","processInitMessage","processInitConversation","patchMessage","clientAck","handleBadgeCount","calcBadgeCount","processPushMessage"]}beforeHook(I,x){if(this.ctx.option.aspectBefore)return this.ctx.option.aspectBefore({name:I,params:x})}afterHook(I,x,C,E){let S=this.resolve(M.Monitor).emitDuration(T.BizApiInvoke+T.SuccessSuffix,C,{name:I});this.ctx.option.aspectAfter&&this.ctx.option.aspectAfter({name:I,params:x,duration:S,result:E})}errorHook(I,x,C,E){let S=this.resolve(M.Monitor).emitDuration(T.BizApiInvoke+T.ErrorSuffix,E,{name:I,error:C.type?`${C.type}:${Z.NI[C.type]}`:"unknown"});if(this.ctx.option.aspectError){let E=this.ctx.option.aspectError({name:I,params:x,duration:S,error:C});if(void 0!==E)return!!E}return!0}wrapMetricsAsync(I,x){let C=0;return E=>(0,eb.__awaiter)(this,void 0,void 0,function*(){try{let M=this.beforeHook(I,E);if(!1===M)return;C=ey.performanceNow();let S=yield x.call(this.instance,E);return this.afterHook(I,E,C,S),S}catch(x){if(this.errorHook(I,E,x,C))throw x}})}getFuncs(){let I=[],{instance:x}=this,C=Object.getOwnPropertyNames(x);I=I.concat(C);let E=Object.getPrototypeOf(x),M=Object.getOwnPropertyNames(E);I=I.concat(M);let S=Object.getOwnPropertyNames(Object.getPrototypeOf(E));return(I=I.concat(S)).filter(I=>"function"==typeof this.instance[I]&&!this.ignoreMethods.includes(I)&&!I.startsWith("__internal"))}install(){this.register(M.MetricsPlugin,this),this.ctx.option.monitor=this.unifyMonitorConfig();let I=this.instance;for(let x of this.getFuncs()){let C=I[x];e_.ctxDebug(thi{x}`),I[pMetricsAsync(x,C)}this.subscribeTrackerEvent()}receivePacket(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){})}subscribeTrackerEvent(){this.resolve(M.EventBus).subscribe(Z.c5.Error,I=>{this.resolve(M.Monitor).emitTracker(D.Exception,{error_stack:I.stack})}),this.resolve(M.EventBus).subscribe(Z.c5.InitFinish,I=>{let x=this.instance.getConversationList(),C=x.map(I=>I.getMessageList().length).reduce((I,x)=>I+x,0);this.resolve(M.Monitor).emitTracker(D.InitHandler,{conv_count:x.length,total_msg_count:C,is_success:"1"})})}unifyMonitorConfig(){let I=this.ctx.option.monitor;return Array.isArray(I)?I:(void 0!==I?this.ctx.option.monitor=[I]:this.ctx.option.monitor=[],this.ctx.option.monitor)}}class t1 extends eu{}class t2 extends t1{constructor(){super(...arguments),this.hasHybridLinkFunction=!0,this.name="AwemeHybridLinkPlugin",this.innerConvListVersion=[],this.innerNextCmdIndex=[],this.innerReadConvListVersion=[],this.lastPullPromise=null}get coreApi(){return this.resolve(M.CoreApi)}get inboxType(){return this.resolve(M.InboxType)}get instance(){return this.resolve(M.CoreInstance)}getConvListVersion(I){var x;return null!==(x=this.innerConvListVersion[null!=I?I:this.inboxType.getDefaultInbox()])&&void 0!==x?x:Y.ZERO}setConvListVersion(I,x){var C;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let E=null!=x?x:this.inboxType.getDefaultInbox(),S=this.innerConvListVersion[E];(!S||S.lt(I))&&(e_.ctxDebug(this.ctx,`update conv list version for inbox:${E} from ${null==S?void 0:S.toString()} to ${I.toString()}`),this.innerConvListVersion[E]=I,yield null===(C=this.resolve(M.DbProxy))||void 0===C?void 0:C.saveUserCursor(E,I))})}getNextCmdIndex(I){var x;return null!==(x=this.innerNextCmdIndex[null!=I?I:this.inboxType.getDefaultInbox()])&&void 0!==x?x:Y.ZERO}setNextCmdIndex(I,x){var C;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let E=null!=x?x:this.inboxType.getDefaultInbox(),S=this.innerNextCmdIndex[E];(!S||S.lt(I))&&(e_.ctxDebug(this.ctx,`update cmd index for inbox:${E} from ${null==S?void 0:S.toString()} to ${I.toString()}`),this.innerNextCmdIndex[E]=I,yield null===(C=this.resolve(M.DbProxy))||void 0===C?void 0:C.saveUserCursor(E,I))})}getReadConvListVersion(I){var x;return null!==(x=this.innerReadConvListVersion[null!=I?I:this.inboxType.getDefaultInbox()])&&void 0!==x?x:Y.ZERO}setReadConvListVersion(I,x){var C;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let E=null!=x?x:this.inboxType.getDefaultInbox(),S=this.innerReadConvListVersion[E];(!S||S.lt(I))&&(e_.ctxDebug(this.ctx,`update read conv list version for inbox:${E} from ${null==S?void 0:S.toString()} to ${I.toString()}`),this.innerReadConvListVersion[E]=I,yield null===(C=this.resolve(M.DbProxy))||void 0===C?void 0:C.saveUserCursor(E,I))})}getMessagesByUserInit(I={}){var x,C,E,S,T;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let R=null!==(x=I.inboxType)&&void 0!==x?x:this.inboxType.getDefaultInbox(),w=I.page;if(!this.inboxType.isValidInbox(R))throw new eS({ctx:this.ctx,msg:"invalid inbox",type:Z.NI.InvalidInboxType,sender:this});let O=yield this.coreApi.GetMessagesByInit({inboxType:R,convLimit:I.convLimit,msgLimit:I.msgLimit,page:w,version:I.versionForNextQuery}),A=null===(C=O.body)||void 0===C?void 0:C.message_by_init,N=null===(E=A.messages)||void 0===E?void 0:E.map(I=>I.conversations),P=[];null===(S=A.messages)||void 0===S||S.forEach(I=>I.messages&&(null==P?void 0:P.push(...I.messages)));let L=A.has_more,D=A.next_init_version,U=O.log_id;return this.instance.processInitConversation(N,U),yield this.instance.processInitMessage(P,U),I.versionForNextQuery||(yield this.setConvListVersion(A.version,R),yield this.setNextCmdIndex(null!==(T=A.cmd_index)&&void 0!==T?T:Y.ZERO,R),yield this.setReadConvListVersion(A.readconv_version,R)),this.resolve(M.EventBus).emitEmpty(Z.c5.InitLoadPage,this),{hasMore:L,page:(null!=w?w:0)+1,versionForNextQuery:D}})}getMessagesByUser({inboxType:I,source:x,convVersion:C,cmdIndex:E,readVersion:S}={}){var T,R,w;return(0,eb.__awaiter)(this,void 0,void 0,function*(){if(void 0===I&&(I=this.inboxType.getDefaultInbox()),!this.inboxType.isValidInbox(I))throw new eS({ctx:this.ctx,msg:"invalid inbox",type:Z.NI.InvalidInboxType,sender:this});if(!0===this.ctx.option.disableInitPull&&0===this.instance.getConversationList().length&&this.getConvListVersion(I).eq(Y.ZERO)){e_.ctxWarn(this.ctx,"try to pull history from 0, preventing");return}let O=void 0!==C?Y.fromValue(C):this.getConvListVersion(I),A=void 0!==E?Y.fromValue(E):this.getNextCmdIndex(I),N=void 0!==S?Y.fromValue(S):this.getReadConvListVersion(I);for(;O||A||N;){let C=yield this.coreApi.GetUserMessage({inboxType:I,version:O,cmdIndex:A,readVersion:N,source:null!=x?x:""}),E=null===(T=C.body)||void 0===T?void 0:T.get_user_message,S=E.messages,P=E.cmd_messages,L=E.read_info;if(S){if(O=S.has_more?S.next_conversation_version:void 0,S.messages)for(let I of S.messages){yield this.resolve(M.MessageManager).processNewMessagesFromPull(I.messages,Z.v$.UserInbox,C.log_id);let x=this.resolve(M.ConversationManager).getRaw(I.conversation_id.toString());this.instance.handleBadgeCount({badge_count:I.badge_count,mute_badge_count_info:I.mute_badge_count_infos},x)}yield this.setConvListVersion(S.next_conversation_version,I)}else O=void 0;if(P?(A=P.has_more&&P.next_cmd_index?P.next_cmd_index:void 0,(null===(R=P.messages)||void 0===R?void 0:R.length)&&(yield this.instance.processInitMessage(P.messages,C.log_id),P.next_cmd_index&&(yield this.setNextCmdIndex(P.next_cmd_index,I)))):A=void 0,L){if(N=L.has_more?L.next_version:void 0,L.read_info)for(let I of L.read_info)this.resolve(M.ConversationManager).markRead(I.ConversationShortId.toString(),I.read_index,I.read_badge_count.toNumber(),null!==(w=I.mute_read_badge_count_infos)&&void 0!==w?w:[]);yield this.setReadConvListVersion(L.next_version,I)}else N=void 0;this.instance.initResult===Z.rb.Start&&this.resolve(M.EventBus).emitEmpty(Z.c5.InitLoadPage,this)}this.resolve(M.ConversationManager).refreshLocal()})}prepareHistoryForInbox({inboxType:I,convLimit:x,msgLimit:C,convTotal:E}){var S,T;return(0,eb.__awaiter)(this,void 0,void 0,function*(){try{if(this.ctx.option.disableInitPull){e_.ctxDebug(this.ctx,`load history for inbox ${I} by disable init`);let E=yield this.coreApi.GetMessagesByInit({inboxType:I,convLimit:x,msgLimit:C}),M=null===(S=E.body)||void 0===S?void 0:S.message_by_init;return yield this.setConvListVersion(M.version,I),yield this.setNextCmdIndex(null!==(T=M.cmd_index)&&void 0!==T?T:Y.ZERO,I),yield this.setReadConvListVersion(M.readconv_version,I),!0}e_.ctxDebug(this.ctx,`load history for inbox ${I} by full init`);let R={hasMore:!0,page:0,versionForNextQuery:void 0};for(;R.hasMore&&(R=yield this.getMessagesByUserInit(Object.assign({inboxType:I,convLimit:x,msgLimit:C},R)),!E||!(this.resolve(M.ConversationManager).getConversationArray().length>=E)););return yield this.getMessagesByUser({inboxType:I,source:"init"}),!0}catch(x){return e_.ctxError(this.ctx,`load history failed for inbox:${I}`,x),!1}})}receivePacket(I){var x,C,E,S;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let T=I,R=!1,w=I.inbox_type,O=null===(x=T.body)||void 0===x?void 0:x.has_new_message_notify;if(!this.resolve(M.InboxType).getInboxTypeArray().includes(w)){e_.ctxDebug(this.ctx,`inbox type ${w} mismatch, drop, logid:${T.log_id}`);return}if(this.ctx.option.checkLastPullFinished&&this.lastPullPromise)try{yield this.lastPullPromise}catch(I){e_.ctxWarn(this.ctx,`lastPullPromise error, continue, current packet logid:${T.log_id}`)}O?(null===(C=null==O?void 0:O.conversation_version)||void 0===C?void 0:C.neq(Y.ZERO))?R||(R=yield this.parseConvVersion(O,w,T)):(null===(E=null==O?void 0:O.cmd_message_index)||void 0===E?void 0:E.neq(Y.ZERO))?R||(R=yield this.parseCmdIndex(O,w,T)):(null===(S=null==O?void 0:O.readconv_version)||void 0===S?void 0:S.neq(Y.ZERO))?R||(R=yield this.parseReadConvVersion(O,w,T)):e_.ctxWarn(this.ctx,`push body doesn't match any link, skip, logid:${T.log_id}`):(R=!0,e_.ctxWarn(this.ctx,`push body is missing, logid:${T.log_id}`)),R&&(this.lastPullPromise=this.getMessagesByUser({inboxType:T.inbox_type,source:"cursor"}),yield this.lastPullPromise)})}parseConvVersion(I,x,C){var E,M,S,T,R,w;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let O=null!==(E=null==I?void 0:I.conversation_version)&&void 0!==E?E:Y.ZERO,A=null!==(M=null==I?void 0:I.previous_conversation_version)&&void 0!==M?M:Y.ZERO,N=this.getConvListVersion(x),P=!1;return(null==N?void 0:N.lt(A))||(null==A?void 0:A.eq(Y.ZERO))?(P=!0,e_.ctxWarn(this.ctx,`inbox ${x} push previousConvVersion is greater than local clientConvVersion, push:${A}, local:${N}, msgid:${null===(S=I.message)||void 0===S?void 0:S.server_message_id}, logid:${C.log_id}`)):!this.ctx.option.triggerPullWhenReceiveEmptyContent||(null===(T=I.message)||void 0===T?void 0:T.content)?((null==N?void 0:N.gt(A))&&e_.ctxWarn(this.ctx,`inbox ${x} push previousConvVersion is lower than local clientConvVersion, push:${A}, local:${N}, msgid:${null===(w=I.message)||void 0===w?void 0:w.server_message_id}, logid:${C.log_id}`),yield this.instance.processPushMessage(I,C),yield this.setConvListVersion(O,x)):(P=!0,e_.ctxWarn(this.ctx,`receive empty content push, msgid:${null===(R=I.message)||void 0===R?void 0:R.server_message_id}, logid:${C.log_id}`)),P})}parseCmdIndex(I,x,C){var E,M;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let S=I.cmd_message_index;if(!S)return!1;let T=this.getNextCmdIndex(x),R=!1;return S&&S.gt(T)?(R=!0,e_.ctxWarn(this.ctx,`inbox ${x} push serverCmdIndex is greater than expected , push:${S}, expect:${T}, msgid:${null===(E=I.message)||void 0===E?void 0:E.server_message_id}, logid:${C.log_id}`)):(null==T?void 0:T.eq(S))?(yield this.instance.processPushMessage(I,C),yield this.setNextCmdIndex(S.add(1),x)):e_.ctxWarn(this.ctx,`inbox ${x} push serverCmdIndex is lower than expected , push:${S}, local:${T}, msgid:${null===(M=I.message)||void 0===M?void 0:M.server_message_id}, logid:${C.log_id}`),R})}parseReadConvVersion(I,x,C){var E;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let M=I.readconv_version,S=I.pre_readconv_version;if(!M||!S)return!1;let T=this.getReadConvListVersion(x),R=!1;return S.eq(T)||(e_.ctxWarn(this.ctx,`inbox ${x} push serverPreReadConvVersion is not equal clientReadConvVersion , push:${S}, local:${T}, msgid:${null===(E=I.message)||void 0===E?void 0:E.server_message_id}, logid:${C.log_id}`),R=!0),yield this.setReadConvListVersion(M,x),R})}getReportParams(I){return Object.assign({hybrid_type:"aweme"},void 0!==I?{conv_list_version:this.getConvListVersion(I).toString(),cmd_index:this.getNextCmdIndex(I).toString(),read_conv_list_version:this.getReadConvListVersion(I).toString()}:{})}}class t5 extends eG{constructor(){super(...arguments),this.name="AwemeHybridLinkPlugin"}install(){this.hybridLinkInstance=new t2(this.ctx),this.register(M.HybridLink,this.hybridLinkInstance)}}class t3 extends eu{}var t6=C(85354);class t9 extends t3{constructor(I){super(I)}init(){let{appId:I,securityStoreType:x="local",securitySignVersion:C,securityCertType:E="request",securityScene:M=""}=this.ctx.option;this.ctx.option.authType===K.im_proto.AuthType.CERT_AUTH?(this.sdk=(0,t6.createSecureInstance)(),this.sdk.setDisableCrossStorage(!0),this.sdk.setNamespace("token")):this.sdk=t6.SecureSDK,this.sdk.setStorageType(x),this.sdk.setConfig({aid:I,scene:M,certType:E,signVersion:C}),this.sdk.start(),this.securityCertType=E,this.securityScene=M}sign(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=yield this.sdk.cryptoSDK.sign({sign_data:I,certType:this.securityCertType,scene:this.securityScene});return JSON.parse(this.sdk.convertBase64ToString(x))})}getCert(){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return this.sdk.cryptoSDK.getCertificate({certType:this.securityCertType,scene:this.securityScene})})}getTsSign(){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return this.sdk.cryptoSDK.getTSSign({certType:this.securityCertType,scene:this.securityScene})})}getTicket(){return(0,eb.__awaiter)(this,void 0,void 0,funcpe:this.securityCertType,scene:this.securityScene})})}setSignValue(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){this.sdk.cryptoSDK.setSignValue({sign:I,scene:this.securityScene})})}getCertSignRequest(){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return this.sdk.cryptoSDK.getCertSignRequest()})}getPubKey(){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return this.sdk.cryptoSDK.getPubKey()})}}let t4=new Map([[K.im_proto.IMCMD.SEND_MESSAGE,["send_message_body","content","conversation_id","conversation_short_id"]],[K.im_proto.IMCMD.CREATE_CONVERSATION_V2,["create_conversation_v2_body","avatar_url","idempotent_id","name","participants"]],[K.im_proto.IMCMD.ADD_CONVERSATION_PARTICIPANTS,["conversation_add_participants_body","conversation_id","conversation_short_id","participants"]]]);class t8 extends eG{install(){this.isCertAuth&&this.register(M.SecurityProxy,new t9(this.ctx))}sendPacket(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){if(this.isCertAuth){let{cert:x,tsSign:C}=this.ctx.option;I.sdk_cert=x||"",I.ts_sign=C||"";let E=Math.round(Date.now()/1e3);if(this.ctx.option.certAuthZeroTrustUsePubKey&&(I.iter_version="1",I.timestamp=Y.fromValue(E)),t4.has(I.cmd)){let x=t4.get(I.cmd),C=x[0],S=[...x.slice(1),...this.ctx.option.certAuthZeroTrustUsePubKey?["timestamp"]:[]];S.sort();let T=[];S.forEach(x=>{var M,S;if("timestamp"===x)return T.push(`timestamp=${E}`);let R=null===(M=I.body)||void 0===M?void 0:M[C],w=null!==(S=null==R?void 0:R[x])&&void 0!==S?S:"",O=Array.isArray(w)?w.map(String).join(","):Y.isLong(w)?String(w):w;T.push(`${x}=${O}`)});try{let{req_sign:x}=yield this.resolve(M.SecurityProxy).sign(T.join("&"));I.reuqest_sign=x}catch(I){e_.ctxWarn(this.ctx,"request sign fail",I)}}}return I})}get isCertAuth(){return this.ctx.option.authType&&[K.im_proto.AuthType.CERT_AUTH,K.im_proto.AuthType.PASSPORT_CERT_AUTH].includes(this.ctx.option.authType)}}class t7 extends tD{SendMessage(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({send_message_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,content:I.content,mentioned_users:I.mentionedUsers,client_message_id:I.clientId,ticket:I.ticket,message_type:I.messageType,ext:I.ext,ref_msg_info:I.referenceInfo}});return this.sendWithRawBody(x,K.im_proto.IMCMD.SEND_MESSAGE,{inboxType:I.inboxType,maxRetryTimes:this.ctx.option.maxSendMsgRetryTimes})})}GetMessagesByUser(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({messages_per_user_body:{cursor:I.cursor,limit:I.limit}});try{return yield this.sendWithRawBody(x,K.im_proto.IMCMD.GET_MESSAGES_BY_USER,{inboxType:I.inboxType,maxRetryTimes:1})}catch(x){return e_.ctxWarn(this.ctx,`pull user error:${x}, ignore`),K.im_proto.Response.create({body:K.im_proto.ResponseBody.create({messages_per_user_body:K.im_proto.MessagesPerUserResponseBody.create({next_cursor:I.cursor,has_more:!1,messages:[]})})})}})}GetMessagesByUserInitV2(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({messages_per_user_init_v2_body:{cursor:I.cursor,init_sub_type:I.initSubType,conv_limit:I.convLimit,msg_limit:I.msgLimit,biz_tag_ids:I.tagIds,user_custom_tag_ids:I.userCustomTagIds}});return this.sendWithRawBody(x,K.im_proto.IMCMD.GET_MESSAGES_BY_USER_INIT_V2,{inboxType:I.inboxType,forceHttp:!0,maxRetryTimes:10})})}GetMessagesByInit(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({message_by_init:{version:I.version,page:I.page,conv_limit:I.convLimit,msg_limit:I.msgLimit}});return this.sendWithRawBody(x,K.im_proto.IMCMD.GET_MESSAGE_BY_INIT,{inboxType:I.inboxType,forceHttp:!0,maxRetryTimes:10})})}GetMessagesByConversation(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({messages_in_conversation_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,anchor_index:I.anchorIndex,limit:I.limit,direction:I.direction}});return this.sendWithRawBody(x,K.im_proto.IMCMD.GET_MESSAGES_BY_CONVERSATION,{inboxType:I.inboxType,forceHttp:!0})})}CreateConversationV2(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({create_conversation_v2_body:{conversation_type:I.type,participants:I.participants,pt}});return this.sendWithRawBody(x,K.im_proto.IMCMD.CREATE_CONVERSATION_V2,{inboxType:I.inboxType})})}GetConversationInfoListV2(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({get_conversation_info_list_v2_body:{conversation_info_list:I.conversations.map(I=>({conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType}))}});return this.sendWithRawBody(x,K.im_proto.IMCMD.GET_CONVERSATION_INFO_LIST_V2,{inboxType:I.inboxType})})}MarkConversationReadV3(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({mark_conversation_read_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,read_message_index:I.readIndex,conv_unread_count:I.unreadCount,total_unread_to.RequestBody.create({batch_mark_read_body:{mark_read_requests:I.batch.map(I=>({conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,read_message_index:I.readIndex,conv_unread_count:I.unreadCount,total_unread_count:I.totalUnreadCount,read_message_index_v2:I.readIndexV2,mute_read_badge_count_infos:I.muteReadBadgeCountInfos,read_badge_count:I.readBadgeCount}))}});return this.send(x,K.im_proto.IMCMD.BATCH_MARK_CONVERSATION_READ_V3,{inboxType:I.batch[0].inboxType,maxRetryTimes:1})})}RecallMessage(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({recall_message_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,server_message_id:I.serverId}});return this.sendWithRawBody(x,K.im_proto.IMCMD.RECALL_MESSAGE,{inboxType:I.inboxType})})}GetTicket(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({get_ticket_body:{ticket_type:Z.HF.ticketType,conversation_type:I.conversationType,conversation_short_id:I.shortId,to_id:I.toId,ext:I.ext}});return(yield this.send(x,K.im_proto.IMCMD.GET_TICKET,{inboxType:I.inboxType})).get_ticket_body})}GetConversationParticipantsList(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({conversation_participants_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,cursor:I.cursor,limit:I.limit}});return this.sendWithRawBody(x,K.im_proto.IMCMD.CONVERSATION_PARTICIPANTS_LIST,{inboxType:I.inboxType})})}GetConversationParticipantByUserId(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({mget_conversation_participants_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType,participants:I.participants}});return this.sendWithRawBody(x,K.im_proto.IMCMD.MGET_CONVERSATION_PARTICIPANTS,{inboxType:I.inboxType})})}ClientAck(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){try{let x=K.im_proto.RequestBody.create({client_ack_body:{start_time_stamp:I.startTimeStamp,cmd:I.c,{useBeacon:!0,inboxType:I.inboxType})}catch(I){e_.ctxWarn(this.ctx,`send ack error: ${I}, ignore`)}})}ClientBatchAck(I){var x,C;return(0,eb.__awaiter)(this,void 0,void 0,function*(){try{let E=null===(x=null==I?void 0:I.map)||void 0===x?void 0:x.call(I,I=>({start_time_stamp:I.startTimeStamp,cmd:I.cmd,network_type:I.NetworkType,logid:I.logid,client_time_stamp:I.clientTimeStamp,server_message_id:I.serverId,type:I.type})),M=K.im_proto.RequestBody.create({client_batch_ack_body:{ack_list:E}});yield this.send(M,K.im_proto.IMCMD.CLIENT_BATCH_ACK,{useBeacon:!0,inboxType:null===(C=null==I?void 0:I[0])||void 0===C?void 0:C.inboxType})}catch(I){e_.ctxWarn(this.ctx,`send batch ack error: ${I}, ignore`)}})}BatchGetConversationParticipantsReadIndex(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({batch_get_conversation_participants_readindex:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,request_from:I.request_from,min_index_required:I.min_index_required}});return(yield this.send(x,K.im_proto.IMCMD.BATCH_GAT_CONVERSATION_PARTICIPANTS_READINDEX)).batch_get_conversation_participants_readindex})}GetConversationParticipantsReadIndexV3(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({participants_read_index_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType}});return(yield this.send(x,K.im_proto.IMCMD.GET_CONVERSATION_PARTICIPANTS_READ_INDEX_V3,{inboxType:I.inboxType})).participants_read_index_body})}GetConversationParticipantsMinIndexV3(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({participants_min_index_body:{conversation_id:I.conversationId,conversation_short_id:I.conversationShortId,conversation_type:I.conversationType}});return(yield this.send(x,K.im_proto.IMCMD.GET_CONVERSATION_PARTICIPANTS_MIN_INDEX_V3,{inboxType:I.inboxType})).participants_min_index_body})}GetConfigs(){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let I=K.im_proto.RequestBody.create();return(yield this.send(I,K.im_proto.IMCMD.GET_CONFIGS)).get_configs_body})}GetUserMessage(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=K.im_proto.RequestBody.create({get_user_message:{versionawBody(x,K.im_proto!0})}catch(I){return e_.ctxWarn(this.ctx,`pull user error:${I}, ignore`),K.im_proto.Response.create({body:K.im_proto.ResponseBody.create({get_user_message:K.im_proto.GetUserMessageResponseBody.create({})})})}})}}class ie{constructor(I,x,C){this.index=I,this.subject=x,this.handler=C}unsubscribe(){this.subject.unsubscribe(this)}}class it extends eu{constructor(){super(...arguments),this.subscriptions=new Map,this.idx=0}subscribe(I){for(let x of this.subscriptions.values())if(I===x.handler)return e_.ctxDebug(this.ctx,"e(this.idx,this,I);return this.subscriptions.set(this.idx,x),this.idx++,x}nextEmpty(I){for(let x of this.subscriptions.values())if(x&&x.handler)try{x.handler({},I)}catch(I){e_.ctxWarn(thist handler:",I)}}next(I,x){for(let C of this.sury{C.handler(I,x)}catch(I){e_.ctxWarn(this.ctx,"error in event handler:",I)}}unsubscribe(I){I&&this.subscriptions.delete(I.index)}unsubscribeAll(){this.subscriptions.clear()}}function ii(I,x,C){let E,M;return function(){let S=this,T=+new Date,R=arguments;clearTimeout(E),M||(M=T),T-M>=C?(I.apply(S,R),M=T):E=setTimeout(()=>{I.apply(S,R)},x)}}function io(I,x,C=!1){let E,M,S;let T=0,R=function(){I.apply(M,S),T=Date.now()};return function(){let I=Date.now();if(M=this,S=arguments,E&&(clearTimeout(E),E=null),C&&0===T)return E=setTimeout(()=>{R()},x),R();let w=x-(I-T);if(w>0)E=setTimeout(()=>{R()},w);else{if(C)return R();E=setTimeout(()=>{R()},x)}}}function is(I,x,C){let E={},M={},S=new Map,T=0;return function(){let R=this,w=+new Date,O=arguments,A=O[0],N=S.get(A);S.has(A)||(N=T++,S.set(A,N)),clearTimeout(E[N]),M[N]||(M[N]=w),w-M[N]>=C?(M[N]=w,O)):E[N]=setTimeout(()=on ir(I,x){let C=new Map,E={},M={},S=0;return function(){let T=Date.now(),R=arguments,w=R[0],O=C.get(w);C.has(w)||(O=S++,C.set(w,O));let A=()=>{I.apply(this,R),delete M[O],delete E[O],C.delete(w)};void 0===M[O]&&(M[O]=0),E[O]&&(clearTimeout(E[O]),delete E[O]);let N=x-(T-M[O]);N>0?E[O]=setTimeout(()=>{A()},N):E[O]=setTimeout(()=>{A()},x)}}class ia extends eu{constructor(){super(...arguments),this.subscriptions=new Map}subscribe(I,x){var C;if(!Object.values(Z.c5).includes(I))throw new eS({ctx:this.ctx,type:Z.NI.InvalidParam,msg:`unknown event: ${I}`,sender:this});this.subscriptions.has(I)||this.subscriptions.set(I,new it(this.ctx));let E=this.subscriptions.get(I),M="number"==typeof this.ctx.option.throttle?this.ctx.option.throttle:100,S=null!==(C=this.ctx.option.triggerStrategy)&&void 0!==C?C:{};h(e_.ctxDebug(this.ctx,`apply strategy: ${Z.zn[S[I]]} to event: ${I}`),S[I]){case Z.zn.Throttle:return E.subscribe(ii(x,M,M));case Z.zn.Debounce:return E.subscribe(io(x,M));case Z.zn.ThrottleWithArgs:return E.subscribe(is(x,M,M));case Z.zn.DebounceWithArgs:return E.subscribe(ir(x,M));case Z.zn.Immediate:default:return E.subscribe(x)}}unsubscribe(I,x){this.subscriptions.has(I)&&this.subscriptions.get(I).unsubscribe(x)}unsubscribeAll(){for(let I of Object.values(this.subscriptions))I.unsubscribeAll();this.subscriptions.clear()}emitEmpty(I,x){return this.emit(I,x,void 0)}emit(I,x,C){this.resolve(M.Monitor).emitEvent(I,x,C);let E=this.subscriptions.get(I);E&&(C?e_.ctxDebug(this.ctx,`emit event "${I}" with sender:`,x,", eventArgs:",C):e_.ctxDebug(this.ctx,`emit event "${I}" with sender:`,x),E.next(C,x))}}function il(I,x,C,E){C=C||0,E=E||I.length-C;let M=C,S=E,T=0;for(M=C,S=E;M<S;){let C=I[M++],E=C>>4;if(E>0){let C=E+240;for(;255===C;)E+=C=I[M++];let R=M+E;for(;M<R;)x[T++]=I[M++];if(M===S)break}let R=I[M++]|I[M++]<<8;if(0===R||R>T)return-(M-2);let w=15&C,O=w+240;for(;255===O;)w+=O=I[M++];let A=T-R,N=T+w+4;for(;T<N;)x[T++]=x[A++]}return T}Math.imul||(Math.imul=function(I,x){let C=I>>>16,E=65535&I,M=x>>>16,S=65535&x;return E*S+(C*S+E*M<<16)|0});let ic=K.im_proto.Request,iu=K.im_proto.Response,iv=K.im_proto.Frame;function ih(I){return"undefined"!=typeof btoa?btoa(String.fromCharCode.apply(null,new Uint8Array(I))):""}function i_(I){let x=ic.encode(I).finish();return new Uint8Array(x)}function ip(I,x){let C=new Uint8Array(x);try{return iu.decode(C)}catch(E){let x=ih(C);throw e_.ctxWarn(I,"decode response error: ",E),e_.ctxDebug(I,"hex dump: ",x),x}}function ig(I){let x=iv.encode(I).finish();return new Uint8Array(x)}function im(I,x){let C=new Uint8Array(x);try{return iv.decode(C)}catch(E){let x=ih(C);throw e_.ctxWarn(I,"decode frame error: ",E),e_.ctxDebug(I,"hex dump: ",x),x}}class iy extends eu{constructor(I){super(I),this.wsLastReceiveTime=0,this.reqMap=new Map,this.manuallyClosed=!1;let{webSocketLevel:x,heartbeatInterval:C,maxHeartbeatEmptyWindow:E}=this.ctx.option;this.heartbeatInterval=null!=C?C:Z.HF.heartbeatInterval,this.maxEmptyWindow=null!=E?E:Z.HF.maxHeartbeatEmptyWindow,this.net=this.ctx.resolve(M.CoreInstance).net,this.http=this.ctx.resolve(M.CoreInstance).http,x!==Z._.Disable&&(this.ws=this.ctx.resolve(M.CoreInstance).websocket,this.prepareWs()),this.onMessage=new it(I)}inSignCommandList(I){return[K.im_proto.IMCMD.SEND_MESSAGE,K.im_proto.IMCMD.CREATE_CONVERSATION_V2,K.im_proto.IMCMD.CALL_VOIP,K.im_proto.IMCMD.ADD_CONVERSATION_PARTICIPANTS,K.im_proto.IMCMD.REMOVE_CONVERSATION_PARTICIPANTS,K.im_proto.IMCMD.UPDATE_CONVERSATION_PARTICIPANT,K.im_proto.IMCMD.SET_CONVERSATION_SETTING_INFO,K.im_proto.IMCMD.SET_CONVERSATION_CORE_INFO,K.im_proto.IMCMD.UPSERT_CONVERSATION_CORE_EXT_INFO,K.im_proto.IMCMD.UPSERT_CONVERSATION_SETTING_EXT_INFO,K.im_proto.IMCMD.DISSOLVE_CONVERSATION,K.im_proto.IMCMD.MARK_MESSAGE,K.im_proto.IMCMD.BATCH_UNMARK_MESSAGE,K.im_proto.IMCMD.SET_MESSAGE_PROPERTY,K.im_proto.IMCMD.MODIFY_MESSAGE_EXT].includes(I)}frontierSign(I){let x={"X-MS-STUB":ef()(I)};if("undefined"!=typeof window&&void 0!==window.byted_acrawler&&"function"==typeof window.byted_acrawler.frontierSign){let I=window.byted_acrawler.frontierSign(x);return null!=I?I:{}}return{}}sendByBeacon(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return I.method="beacon",e_.ctxDebug(this.ctx,`Beacon Request SeqId -> ${I.seqId}`,I.request),this.http.sendBeacon(I.url,I.request),I})}sendByHttp(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){I.method="http",e_.ctxDebug(this.ctx,`Http Request SeqId -> ${I.seqId}`,I.request);try{this.reqMap.set(I.seqId,I);let x=yield this.http.sendRequest(I.url,I.request);return I.response=x,0!==x.status_code?e_.ctxError(this.ctx,`Http Response SeqId -> ${I.seqId}`,I.response):e_.ctxDebug(this.ctx,`Http Response SeqId -> ${I.seqId}`,I.response),I}catch(I){throw new eS({ctx:this.ctx,msg:"network error",type:Z.NI.NetworkError,innerr:this,ignoreEvent:!0})}finally{this.reqMap.delete(I.seqId)}})}sendByWs(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){I.method="ws";let x=i_(I.request),C=Object.assign(Object.assign({},this.inSignCommandList(I.cmd)?this.frontierSign(x):{}),this.ctx.option.headers),E=K.im_proto.Frame.create({service:this.ctx.option.service,method:this.ctx.option.method,headers:Object.entqid:Y.fromNumber(I.seqId),logid:Y.fromNumber(Date.now()),payload_type:"pb",payload:x});I.frame=E;try{this.reqMap.set(I.seqId,I),e_.ctxDebug(this.ctx,`WS Request SeqId -> ${I.seqId}`,I.request),this.ws.send(ig(E))}catch(x){throw this.reqMap.delete(I.seqId),new eS({ctx:this.ctx,msg:"network error",type:Z.NI.NetworkError,innerError:x,allowRetry:!0,sender:this})}return new Promise((x,C)=>{I.wsPromise={resolve:x,reject:C}})})}receiveRaw(I){var x,C,E;if(this.resetWsHeartbeat(),"hi"!==I.toString())try{let S=im(this.ctx,I);if(S.service!==this.ctx.option.service&&!this.ctx.option.acceptIncorrectFrame){e_.ctxDebug(this.ctx,`WS Response dropped, local serviceId=${this.ctx.option.service}, message=${S.service}`),this.resolve(M.EventBus).emit(Z.c5.WebSocketReceiveUnexpectedFrame,this,S);return}let{payload:T}=S;if(null==T){e_.ctxWarn(this.ctx,"payload undefined or null");return}let R=S.payload_encoding;if("__lz4"===R){let I=new Uint8Array(10*T.length),x=0;if(((x=il(T,I))<0||x>I.length||x<T.length)&&(e_.ctxDebug(this.ctx,"WS response with lz4 compress, but first time decompressed failed, try second time"),I=new Uint8Array(1024e3),(x=il(T,I))<0||x>I.length||x<T.length)){e_.ctxWarn(this.ctx,"WS response with lz4 compress, try second time fail.");return}T=I.slice(0,x)}try{let I=ip(this.ctx,T),R=K.im_proto.Response.create(I);if(!this.resolve(M.InboxType).isValidInbox(R.inbox_type)&&R.sequence_id.eq(0)){e_.ctxWarn(this.ctx,`WS Push dropped, local inboxType=${this.ctx.option.inboxType}, message=${R.inbox_type}`,"resp:",R);return}let w=R.sequence_id.toNumber(),O=this.reqMap.get(w);O?(0!==R.status_code?e_.ctxError(this.ctx,`WS Response SeqId -> ${R.sequence_id}`,R):e_.ctxDebug(this.ctx,`WS Response SeqId -> ${R.sequence_id}`,R),O.response=R,O.wsPromise.resolve(O),this.reqMap.delete(w)):R.sequence_id.eq(0)?(e_.ctxDebug(this.ctx,"WS Push",null===(E=null===(C=null===(x=R.body)||void 0===x?void 0:x.has_new_message_notify)||void 0===C?void 0:C.message)||void 0===E?void 0:E.message_type,R),(O=new tL(this.ctx,R.cmd)).frame=S,O.response=R,O.seqId=R.sequence_id.toNumber(),this.receive(O)):e_.ctxWarn(this.ctx,"WS Response dropped, no handler",R)}catch(I){e_.ctxWarn(this.ctx,"WS Response dropped, IM Response deserialize fail, hex dump:",I,"frame:",S)}}catch(I){e_.ctxWarn(this.ctx,"WS Response dropped, Frame deserialize fail, hex dump: ",I)}}send(I,x){var C,E,S,T,R,w,O,A,N,P;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let L;if(x.useBeacon)return yield this.sendByBeacon(I),I.response=K.im_proto.Response.create({}),I;let D=null!==(C=x.maxWsRetryTimes)&&void 0!==C?C:3,U=0===D?null!==(E=x.maxHttpRetryTimes)&&void 0!==E?E:3:(null!==(S=x.maxHttpRetryTimes)&&void 0!==S?S:null===(T=this.ws)||void 0===T?void 0:T.isOpen())?1:3;0===U&&(U=1),ey.performanceNow()-this.wsLastReceiveTime-1.5*this.heartbeatInterval>this.maxEmptyWindow&&(null===(R=this.ws)||void 0===R?void 0:R.isOpen())&&(D=0,U=null!==(w=x.maxHttpRetryTimes)&&void 0!==w?w:3,e_.ctxWarn(this.ctx,"ws idle too long, fallback to http"));let B=0,G=0,V=()=>{let x=!1;return Promise.race([new Promise((C,E)=>{setTimeout(()=>{x||(this.reqMap.delete(I.seqId),E(new eS({ctx:this.ctx,msg:"request timeout",type:Z.NI.NetworkError,allowRetry:!0,ignoreEvent:!0,sender:this})))},this.ctx.option.timeout)}),(0,eb.__awaiter)(this,void 0,void 0,function*(){var C;let E;let S=!1;if(B<D&&(null===(C=this.ws)||void 0===C?void 0:C.isOpen())&&(S=!0),0!==D&&B>=D&&0===G&&void 0!==this.ws&&(e_.ctxWarn(this.ctx,`Request ${I.seqId} fallback to http (wsRetryTimes)`),S=!1),G>=U)throw new eS({ctx:this.ctx,msg:"http retry times limit exceeded",type:Z.NI.NetworkError,sender:this,args:{cmd:I.cmd,seqId:I.seqId}});S?(B++,E=this.sendByWs(I)):(G++,E=this.sendByHttp(I));try{let C=yield E;x=!0,this.reqMap.delete(I.seqId);let{request:S,response:T}=C;if(this.resolve(M.Monitor).emitNetwork(S,T),T.status_code===Z.NI.ResourceExhausted)throw new eS({ctx:this.ctx,msg:"demotion enabled",type:Z.NI.ResourceExhausted,allowRetry:!1,sender:this,logid:null==T?void 0:T.log_id});if(T.status_code===Z.NI.InternalError&&(T.error_desc.includes("i/o timeout")||T.error_desc.includes("rpc timeout")||T.error_desc.includes("RPC timeout"))||T.error_desc.includes("connection timeout")||T.error_desc.includes("request timeout"))throw new eS({ctx:this.ctx,msg:"request timeout",type:Z.NI.NetworkError,allowRetry:!0,ignoreEvent:!0,sender:this,logid:null==T?void 0:T.log_id});return C.retryTimes=B+G,C}catch(I){if(I.type)throw I;throw new eS({ctx:this.ctx,msg:"request error",type:Z.NI.NetworkError,allowRetry:I.allowRetry,innerError:I,sender:this})}finally{this.reqMap.delete(I.seqId)}})])};for(;;){if(I.retryTimes++,I.retryTimes>=10){I.error=new eS({ctx:this.ctx,msg:"too much retry",type:Z.NI.NetworkError,sender:this});break}try{if(I.startTime=Date.now(),L=yield V(),I.endTime=Date.now(),"function"==typeof(null===(A=null===(O=null==L?void 0:L.response)||void 0===O?void 0:O.server_execution_end_time)||void 0===A?void 0:A.toNumber)&&"function"==typeof(null===(P=null===(N=null==L?void 0:L.response)||void 0===N?void 0:N.request_arr==P?void 0:P.toNumber)&&ey.putTimeDelta(I.startTime,I.endTime,L.response.server_execution_end_time.toNumber(),L.response.request_arrived_time.toNumber()),void 0!==L)break}catch(x){if(I.error=x,(null==x?void 0:x.allowRetry)===!0){let C=500+100*I.retryTimes+100*Math.random();C>2e3&&(C=2e3),e_.ctxDebug(this.ctx,`req ${I.seqId} failed, retrying @ attempt ${I.retryTimes}, inner err:`,x),yield new Promise(I=>setTimeout(I,C));continue}break}}if(void 0===L)throw void 0===I.error&&(I.error=new eS({ctx:this.ctx,msg:"unknown error",type:Z.NI.NetworkError,sender:this})),I.error;return L})}get isWsOnline(){var I;return null!==(I=this.ws)&&void 0!==I&&!!I.isOpen()&&ey.performanceNow()-this.wsLastReceiveTime-1.5*this.heartbeatInterval<=this.maxEmptyWindow}sendByHttpTo(I,x,C){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return"undefined"!=typeof .arrayBuffer():this.http.send(I,x,C)})}receive(I){this.resolve(M.Monitor).eponse),this.onMessage.next(I.response,this)}onWsClose(){return(0,eb.__awaiter)(this,void 0,void 0,function*(){e_.ctxDebug(this.ctx,"ws closed"),this.resolve(M.EventBus).emit(Z.c5.WebSocketDisconnected,this,this.ws)})}prepareWs(){this.ctx.option.webSocketLevel!==Z._.Disable&&(this.ws.onMessage.subscribe(I=>this.receiveRaw(I)),this.ws.onClose.subscribe(()=>this.onWsClose()),this.ws.onError.subscribe(()=>this.onWsClose()),this.ws.onOpen.subscribe(()=>{e_.ctxDebug(this.ctx,"ws connected"),this.resolve(M.EventBus).emit(Z.c5.WebSocketConnected,this,this.ws),this.manuallyClosed=!1}),this.wsCheckTicker=this.ctx.resolve(M.CoreInstance).createTicker(this.ctx,this.heartbeatInterval),this.wsCheckTicker.onTick.subscribe(()=>{var I,x,C,E,S;let R=ey.performanceNow()-this.wsLastReceiveTime+this.heartbeatInterval/1.5;(null===(I=this.ws)||void 0===I?void 0:I.isOpen())?R>this.maxEmptyWindow?(e_.ctxDebug(this.ctx,"not receive any packet in window, ws close connection"),this.resolve(M.Monitor).emitMetrics(T.WebSocketConnectNoHeartbeat,{count:1},{url:null!==(S=null===(E=this.ws)||void 0===E?void 0:E.url)&&void 0!==S?S:"unknown"}),this.connectWs(!0)):R>this.heartbeatInterval&&this.sendWsHeartbeat():(e_.ctxDebug(this.ctx,"ws try connect if closed"),this.resolve(M.Monitor).emitMetrics(T.WebSocketConnectAfterClose,{count:1},{url:null!==(C=null===(x=this.ws)||void 0===x?void 0:x.url)&&void 0!==C?C:"unknown"}),this.connectWs(!0))}))}closeWs(I){var x,C;this.ctx.option.webSocketLevel!==Z._.Disable&&(null===(x=this.ws)||void 0===x||x.close(),this.manuallyClosed=!I,this.manuallyClosed&&(null===(C=this.wsCheckTicker)||void 0===C||C.stop()))}connectWs(I){var x,C,E;return(0,eb.__awaiter)(this,void 0,void 0,function*(){if(this.ctx.option.webSocketLevel===Z._.Disable)return;if(this.manuallyClosed&&I){e_.ctxDebug(this.ctx,"ignore connect since manually closed");return}this.closeWs(!0);let S=ey.performanceNow();try{yield this.ws.performOpen(),this.resolve(M.Monitor).emitMetrics(T.WsConnect,{ws_cost:Math.round(ey.performanceNow()-S)},{error_code:"0",url:null!==(x=this.ws.option.frontierUrl)&&void 0!==x?x:"unknown"}),tC||C.start()}catch(I){this.resolve(M.Monitor).emitMetrics(T.WsConnect,{ws_cost:Math.round(ey.performanceNow()-S)},{error_code:"1",url:null!==(E=this.ws.option.frontierUrl)&&voideat(){var I;(null===(I=this.ws)||void 0===I?void 0:I.isOpen())?this.ws.send("hi"):e_.ctxWarn(this.ctx,"ws not connect but try to send heartbeat")}resetWsHeartbeat(){this.wsLastReceiveTime=ey.performanceNow()}}class iI extends eu{constructor(I){super(I),this.refreshBuffer=[],this.refreshDebounce=io(()=>{this.triggerRefresh()},1e3,!0),this.conversations=new Map}applyLocal(I){I.forEach(I=>{this.conversations.set(I.id,I)})}clearAll(){this.conversations.clear()}getWithCreateLocal(I,x,C,E){let M=this.getRaw(I);if(!M){let S=new eD(this.ctx);S.coreInfo=new eT(S),S.settingInfo=new eR(S),S.id=I,S.shortId=x,S.type=C,S.isOffline=!0,M=S,void 0!==E?S.coreInfo.inboxType=E:void 0===E&&C===K.im_proto.ConversationType.ONE_TO_ONE_CHAT&&4===I.split(":").length&&(S.coreInfo.inboxType=Number.parseInt(I.split(":")[0],10)),e_.ctxDebug(this.ctx,"create local conv:",S),this.upsert(M)}return M}upsert(I){var x;if(void 0===I)throw new eS({ctx:this.ctx,msg:"upsert undefined conv",type:Z.NI.InvalidParam,sender:this});if(!this.resolve(M.InboxType).isValidInbox(I.inboxType))throw new eS({ctx:this.ctx,msg:`invalid inbox: ${I.inboxType}`,type:Z.NI.InvalidParam,sender:this});let C=this.conversations.get(I.id);if(C&&I.isOffline&&(e_.ctxDebug(this.ctx,`local exist, try to use offline upsert, ignore, short id: ${C.shortId} with offline:${I.shortId}`),!C.isOffline))return e_.ctxDebug(this.ctx,"local is online, ignore update"),C;if(C){e_.ctxDebug(this.ctx,`merge conversation local=${C.version.toString()}:`,C,`new=${I.version.toString()}:`,I);let x=C.coreInfo||new eT(C),E=C.settingInfo||new eR(C);(C=Object.assign(C,I)).coreInfo=x.mergeCore(I.coreInfo),C.settingInfo=E.mergeSetting(I.settingInfo),C.forceRefreshUnreadCount()}return this.conversations.set(I.id,null!=C?C:I),null===(x=this.resolve(M.DbProxy))||void 0===x||x.upsertConversation(null!=C?C:I),this.ctx.initResult===Z.rb.Succeeded&&(this.resolve(M.EventBus).emit(Z.c5.ConversationUpsert,this,null!=C?C:I),this.resolve(M.EventBus).emitEmpty(Z.c5.ConversationChange,this)),I}refreshLocalAsync(){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let I=this.getConversationArray().filter(I=>I.isOffline);if(0!==I.length)return this.refreshAsync(I)})}refreshLocal(){let I=Array.from(this.calues()).filter(iI.conversationFilter).filter(I=>I.isOffline);0!==I.length&&this.refresh(I)}triggerRefresh(){if(0===this.refreshBuffer.length)return;e_.ctxDebug(this.ctx,"clear refresh buffer:",this.refreshBuffer);let I=[...this.refreshBuffer];this.refreshBuffer=[],this.refreshAsync(I)}refresh(I){var x;let C=eN(I),E=[];if(0===this.refreshBuffer.length)E.push(...C);else{let I={};this.refreshBuffer.forEach(x=>I[x.id]=!0),C.forEach(x=>{I[x.id]||E.push(x)})}E.length>0&&th);let M=null!==(x=this.ctx.option.conversationRefreshCount)&&void 0!==x?x:Z.HF.conversationRefreshCount;this.refreshBuffer.length>=M?this.triggerRefresh():this.refreshDebounce()}refreshAsync(I){var x,C,E;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let S=null!==(x=eN(I))&&void 0!==x?x:this.refreshBuffer;if(0===S.length)return[];e_.ctxDebug(this.ctx,"refresh conv: ",S);let T=[],R=eA(S,I=>I.inboxType.tot.keys(R))for(let x of ek(R[I],5))try{let E=yield this.resolve(M.CoreApi).GetConversationInfoListV2({conversations:x.map(I=>({conversationId:I.id,conversationShortId:Y.fromString(I.shortId),conversationType:I.type})),inboxType:Number.parseInt(I,10)}),S=(null===(C=null==E?void 0:E.body)||void 0===C?void 0:C.get_conversation_info_list_v2_body).conversation_info_list;x.forEach(I=>{0===S.filter(x=>x.conversation_id===I.id).length&&(e_.ctxDebug(this.ctx,"delete local conv, may not exist online: ",I),this.delete(I.id))}),S.forEach(I=>{let x=this.upsert(eD.fromServerConversation(this.ctx,I,null==E?void 0:E.log_id));T.push(x)})}catch(I){I&&(null==I?void 0:I.type)===Z.NI.InternalError&&(null===(E=null==I?void 0:I.message)||void 0=ocal conv, may not exist online: ",I),this.delete(I.id)}):e_.ctxError(this.ctx,"unknown refresh error:",I)}return T})}get(I){let x=this.getRaw(I);if(x||(x=this.getWithShortIdRaw(I)),!x)throw new eS({ctx:this.ctx,msg:`conversation ${I} not exist in local`,type:Z.NI.ConversationNotExist,sender:this,args:{conversationId:I}});return x}getWithShortIdRaw(I){for(let x of this.conversations.values())if(x.shortId===I)return x}getWithOnline(I,x,C){return(0,eb.__aw){let E=this.getRaw(I);if(!E||E.isOffline){if(x&&C)E=this.getWithCreateLocaw new eS({ctx:this.ctx,type:Z.NI.InvalidParam,msg:"no shortId and type provided",sender:this})}return yield this.refreshAsync(E),this.get(I)})}getRaw(I){return this.conversations.get(I)}getConversationArray(I=iI.conversationFilter){return Array.from(this.conversations.values()).filter(I).map(I=>({conv:I,rankScore:I.rankScore})).sort(iI.conversationComparator).map(I=>I.conv)}withConversation(I){return x=>x(this.get(I))}delete(I,x=!1){var C;let E=this.getRaw(I);E&&(x||this.getContext().resolve(M.MessageManager).clearConversation(I),this.conversations.delete(I),null===(C=this.resolve(M.DbProxy))||void 0===C||C.deleteConversation(E),this.resolve(M.EventBus).emitEmpty(Z.c5.ConversationChange,this),this.resolve(M.EventBus).emit(Z.c5.ConversationDelete,this,E))}markRead(I,x,C,E){let M=this.get(I);return M.settingInfo.readIndex=x,C&&(M.settingInfo.readBadgeCount=C),(null==E?void 0:E.length)&&M.settingInfo.mergeMuteReadBadgeCountInfos(E),this.upsert(M)}join(I){var x;let C=this.get(I);C&&(C.isMember=!0,null===(x=this.resolve(M.DbProxy))||void 0===x||x.upsertConversation(C),this.resolve(M.EventBus).emitEmpty(Z.c5.ConversationChange,this),this.resolve(M.EventBus).emit(Z.c5.ConversationJoin,this,C))}leave(I){var x;let C=this.get(I);C&&(C.isMember=!1,null===(x=this.resolve(M.DbProxy))||void 0===x||x.upsertConversation(C),this.resolve(M.EventBus).emitEmpty(Z.c5.ConversationChange,this),this.resolve(M.EventBus).emit(Z.c5.ConversationLeave,thisd 0,function*(){let x=this.get(I),C=yield this.resolsationType:x.type,shortId:Y.fromString(x.shortId),toId:Y.fromString(x.type===K.im_proto.ConversationType.ONE_TO_ONE_CHAT?x.toParticipantUserId:x.shortId),inboxType:x.inboxType});x.ticket=null==C?void 0:C.ticket,this.upsert(x),e_.ctxDebug(this.ctx,"refresh ticket for conv:",x)})}static conversationFilter(I){return 0===I.mode&&I.isMember}dispose(){this.clearAll()}}iI.conversationComparator=(I,x)=>x.rankScore-I.rankScore,function(I){I[I.MarkConversationRead=1]="MarkConversationRead",I[I.DeleteMessage=2]="DeleteMessage",I[I.DeleteConversation=3]="DeleteConversation",I[I.SettingInfoUpdate=4]="SettingInfoUpdate",I[I.CoreInfoUpdate=6]="CoreInfoUpdate",I[I.ParticipantUpdate=7]="ParticipantUpdate",I[I.FirstMessage=8]="FirstMessage",I[I.NewMarkConversationRead=14]="NewMarkConversationRead"}(U||(U={}));class ix extends eU{static fromMessage(I){let x=I;return x.contentObj=ep.parse(I.content),x.commandSubType=x.contentObj.command_type,x}}class iC extends tV{process(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return I.data.isCommandMsg&&(I.needContinue=!1,yield this.parseCommand(I.data)),I})}parseCommand(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=ix.fromMessage(I);switch(x.contentObj.command_type){case U.DeleteConversation:this.handleDeleteConversationCMD(x);break;case U.DeleteMessage:this.handleDeleteMessageCMD(x);break;case U.MarkConversationRead:case U.NewMarkConversationRead:this.handleMarkConversationRead(x);break;case U.SettingInfoUpdate:yield this.handleUpdateSettingInfo(x);break;case U.CoreInfoUpdate:yield this.handleUpdateCoreInfo(x);break;case U.ParticipantUpdate:yield this.handleUpdateParticipant(x)}this.resolve(M.EventBus).emit(Z.c5.ReceiveCommandMessage,this,x)})}handleDeleteConversationCMD(I){let{conversation_id:x}=I.contentObj;this.resolve(M.Conversion_id:x,message_id:C}=I.contentObj;this.resolve(M.MessageManager).delete(x,C.toString())}handleMarkConversationRead(I){var x;if(this.ctx.initResult===Z.rb.Succeeded){let{conversation_id:C,read_index:E,read_badge_count:S,mute_read_badge_count_info:T}=I.contentObj;this.resolve(M.ConversationManager).markRead(C,Y.fromValue(E),S,null!==(x=null==T?void 0:T.map(I=>({message_type:I.type,read_badge_count:I.read_badge_count})))&&void 0!==x?x:[])}}handleUpdateSettingInfo(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){if(this.ctx.initResult===Z.rb.Succeeded){let{conversation_version:x}=I.contentObj,C=Y.fromValue(null!=x?x:Y.MAX_VALUE),E=this.resolve(M.ConversationManager).getWithCreateLocal(I.conversationId,I.conversationShortId.toString(),I.conversationType);E.settingInfo.version.lte(C)?this.resolve(M.ConversationManager).refresh(E):e_.ctxWarn(this.ctx,"ignore online update setting info cmd, local version: ",E.settingInfo.version.toString(),"online: ",C.toString())}})}handleUpdateCoreInfo(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){if(this.ctx.initResult===Z.rb.Succeeded){let{group_version:x}=I.contentObj,C=Y.fromValue(x),E=this.resolve(M.ConversationManager).getWithCreateLocal(I.conversationId,I.conversationShortId.toString(),I.conversationType);E.coreInfo.version.lte(C)?this.resolve(M.ConversationManager).refresh(E):e_.ctxWarn(this.ctx,"ignore online update core info cmd, local version: ",E.coreInfo.version.toString(),"online: ",x.toString())}})}handleUpdateParticipant(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){if(this.ctx.initResult===Z.rb.Succeeded){let{added_participant:x,modified_participant:C,removed_participant:E}=I.contentObj;if((null==x?void 0:x.length)>0){let C=x.map(String),E=[];C.forEach(x=>{let C=eB.fakeParticipant(this.ctx,x,{type:I.conversationType,id:I.conversationId});E.push(C)}),C.includes(this.ctx.option.userId)&&this.resolve(M.ConversationManager).join(I.conversationId),this.resolve(M.ParticipantManager).upsertBatch(I.conversationId,E)}if((null==C?void 0:C.length)>0){let x=this.resolve(M.ConversationManager).get(I.conversationId),E=C.map(String);this.resolve(M.ParticipantManager).updateWithUserIdAsync(x,E)}if((null==E?void 0:E.length)>0){let x=E.map(String);x.includes(this.ctx.option.userId)&&this.resolve(M.ConversationManager).leave(I.conversationId),this.resolve(M.ParticipantManager).delete(I.conversationId,x)}}})}}class iE extends tV{process(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=I.data.conversationId;if(!x)return e_.ctxWarn(this.ctx,"no conversation provided in message, ignore",I.data),I.needContinue=!1,I;let C=this.resolve(M.ConversationManager).getRaw(x);if(I.data.type===K.im_proto.MessageType.MESSAGE_TYPE_CONVERSATION_DESTROY&&C)return this.resolve(M.ConversationManager).delete(x),this.resolve(M.EventBus).emit(Z.c5.ConversationDissolve,this,C),this.resolve(M.EventBus).emitEmpty(Z.c5.ConversationChange,this),I.needContinue=!1,I;if(!I.data.isNormalMsg&&void 0===C)return I.needContinue=!1,this.ctx.initResult===Z.rb.Succeeded&&e_.ctxDebug(this.ctx,`ignore process, conv: ${I.data.conversationId} not exist for cmd msg`,I.data),I;let E=I.data,S=this.resolve(M.ConversationManager).getWithCreateLocal(E.conversationId,E.conversationShortId,E.conversationType);return I.conv=S,I})}}class iM extends tV{process(I){var x;return(0,eb.__awaiter)(this,void 0,void 0,function*(){if(!I.data.isNormalMsg)return I;let C=this.resolve(M.MessageManager).getRaw(null===(x=I.conv)||void 0===x?void 0:x.id,I.data.clientId),E=void 0!==I.data.source&&(I.data.source===Z.v$.Online||I.data.source===Z.v$.UserInbox),S=(null==C?void 0:C.flightStatus)!==void 0&&E;this.resolve(M.MessageManager).upsert(I.data);let T=this.resolve(M.MessageManager).getRaw(I.data.conversationId,I.data.clientId);return C?S&&T.flightStatus!==Z.b3.Received&&(T.flightStatus=Z.b3.Received,this.ctx.initResult===Z.rb.Succeeded&&this.resolve(M.EventBus).emit(Z.c5.ReceiveSelfMessage,this,T),this.resolve(M.MessageManager).upsert(T)):E&&!I.data.isStrangerMessage&&(I.data.sender!==this.ctx.option.userId?this.ctx.initResult===Z.rb.Succeeded&&this.resolve(M.EventBus).emit(Z.c5.ReceiveNewMessage,this,T):this.ctx.initResult===Z.rb.Succeeded&&this.resolve(M.EventBus).emit(Z.c5.ReceiveSelfMessage,this,T)),I})}}class ib extends tV{process(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return I.data.type===K.im_proto.MessageType.MESSAGE_TYPE_UPDATE_MESSAGE_EXT&&(I.needContinue=!1,this.handleUpdateExt(I)),I})}handleUpdateExt(I){var x,C,E,S,T,R,w;let O=null===(x=I.data)||void 0===x?void 0:x.ext[Z.v9.ServerMessageId];if(!O)throw new eS({ctx:this.ctx,type:Z.NI.InvalidServerId,msg:`message ${I.data} has no s:server_message_id`,sender:this});let A=this.resolve(M.MessageManager).getByServerIdRaw(null===(C=I.conv)||void 0===C?void 0:C.id,O);if(A){if(A.version.gt(I.data.version)){e_.ctxWarn(this.ctx,`local msg version: ${A.version.toString()} > online msg version: ${I.data.version.toString()}, ignore, local msg:`,A,"online msg:",I.data);return}if(A.ext=I.data.ext,A.version=I.data.version,I.data.content&&(A.content=I.data.content),this.resolve(M.MessageManager).upsert(A),!A.visible)for(let x of this.resolve(M.MessageManager).getList(I.conv.id))(null===(S=null===(E=x.referenceInfo)||void 0===E?void 0:E.referenced_message_id)||void 0===S?void 0:S.toString())===A.serverId&&(x.referenceInfo.referenced_message_status=K.im_proto.MessageStatus.INVISIBLE,this.resolve(M.MessageManager).upsert(x));if(A.isEdited)for(let x of this.resolve(M.MessageManager).getList(I.conv.id))(null===(R=null===(T=x.referenceInfo)||void 0===T?void 0:T.referenced_message_id)||void 0===R?void 0:R.toString())===A.serverId&&(x.referenceInfo=Object.assign(Object.assign({},x.referenceInfo),{ext:Object.assign(Object.assign({},null!==(w=x.referenceInfo.ext)&&void 0!==w?w:{}),{[Z.v9.RefIsEdited]:"true",[Z.v9.RefContent]:A.content})}),this.resolve(M.MessageManager).upsert(x));this.resolve(M.EventBus).emit(Z.c5.ReceiveNewUpdateExtMessage,this,I.data),"true"===I.data.ext[Z.v9.IsRecalled]&&this.resolve(M.MessageManager).markRecalled(I.conv.id,A.serverId)}}}class iS extends eu{constructor(I){super(I),this.messages=new Map,this.processors=[new this.ctx)]}applyLocal(I){I.forEach(I=>{this.messages.has(I.conversationId)||this.messages.set(I.conversationId,new Map),this.messages.get(I.conversationId).set(I.clientId,I)})}clearAll(){this.messages.clear()}get(I,x){let C=this.getRaw(I,x);if(!C)throw new eS({ctx:this.ctx,type:Z.NI.MessageNotExist,msg:`message ${x} @ ${I} not exist in local`,sender:this});return C}getRaw(I,x){return this.getConversationMap(I).get(x)}getRawMap(){return this.messages}getByServerIdRaw(I,x){let C=Array.from(this.getConversationMap(I).values()).filter(I=>I.serverId===x);if(0!==C.length)return this.get(I,C[0].clientId)}getByServerId(I,x){let C=Array.from(this.getConversationMap(I).values()).filter(I=>I.serverId===x);if(0===C.length)throw new eS({ctx:this.ctx,type:Z.NI.MessageNotExist,msg:`message ${x} @ ${I} not exist in local`,sender:this});return this.get(I,C[0].clientId)}getList(I){return Array.from(this.getConversationMap(I).values()).sort(iS.messageComparator)}upsert(I){var x;if(I.isSpecialMessage){e_.ctxWarn(this.co upsert:",I);return}if(!I.clientId){e_.ctxDebug(this.ctx,"not found message clientId:",I);return}let C=this.getConversationMap(I.conversationId);if(this.ctx.option.maxMessageCount){let I=Math.max(200,this.ctx.option.maxMessageCount);if(C.size>=I){let x=~~(I/5);for(let I of C.keys()){if(x<=0)break;C.delete(I),x--}}}let E=C.get(I.clientId);if(E&&E.type===I.type?(["referenceInfo"].forEach(x=>{void 0===I[x]&&delete E[x]}),I=E.merge(I)):E&&E.type!==I.type&&e_.ctxWarn(this.ctx,"try to merge different msg:",E,I),C.set(I.clientId,I)(Z.c5.MessageUpsert,this,I),this.ctx.initResult===Z.rb.Succeeded){this.resolve(M.EventBus).emitEmpty(Z.c5.ConversationChange,this);let x=this.getContext().resolve(M.ConversationManager).getRaw(I.conversationId);this.resolve(M.EventBus).emit(Z.c5.ConversationUpsert,this,x),void 0!==E&&(null==x||x.forceRefreshUnreadCount())}}getConversationMap(I){let x=this.messages.get(I);return x||(xcessNewMessage(I,x){return(0,eb.__awaiter)(this,void 0,void 0,function*(){if(I.ext||(I.ext={}),I.source=x,I.type>=0)return this.processMessage(I);throw new eS({ctx:this.ctx,type:Z.NI.UnknownMessageType,msg:`unknown message type: ${I.type} for msg:${I.clientId}`,sender:this})})}processNewMessagesFromPull(I,x,C){var E;return(0,eb.__awaiter)(thisction*(){let M=I.map(I=>eU.fromServerMessage(this.ctx,I,C)),S=new Map;for(let I of M){I.ext||(I.ext={});let C=null===(E=S.get(I.conversationShortId))||void 0===E?void 0:E.indexInConversation;(!C||I.indexInConversation.lt(C))&&S.set(I.conversationShortId,I),yield this.processNewMessage(I,x)}return{msgs:M,conMap:S}})}delete(I,x){var C,E,S;let T=this.getConversationMap(I),R=Array.from(T.values()).filter(I=>I.serverId===x);if(0===R.length){e_.ctxDebug(this.ctx,`delete not exist msg: ${I}::${x}`);return}for(let w of(T.delete(R[0].clientId),null===(C=this.resolve(M.DbProxy))||void 0===C||C.deleteMessage(R[0]),this.getList(I)))(null===(S=null===(E=w.referenceInfo)||void 0===E?void 0:E.referenced_message_id)||void 0===S?void 0:S.toString())===x&&(w.referenceInfo.referenced_message_status=K.im_proto.MessageStatus.DELETED,this.upsert(w));this.getContext().resolve(M.ConversationManager).get(I),this.resolve(M.EventBus).emit(Z.c5.MessageUpsert,this,R[0]),this.resolve(M.EventBus).emit(Z.c5.MessageDelete,this,R[0])}markRecalled(I,x,C){var E,S;let T=this.getByServerId(I,x);for(let M of(T.ext||(T.ext={}),T.ext[Z.v9.IsRecalled]="true",C&&this.ctx.option.debug&&(T.ext[Z.v9.LocalLogId]=C),this.upsert(T),this.getList(I)))(null===(S=null===(E=M.referenceInfo)||void 0===E?void 0:E.referenced_message_id)||void 0===S?void 0:S.toString())===x&&(M.referenceInfo.referenced_message_status=K.im_proto.MessageStatus.RECALLED,this.upsert(M));this.getContext().resolve(M.ConversationManager).get(I),thil,this,T)}clearConversation(I){var x;let C=this.getContext().resolve(M.ConversationManager).get(I);this.messages.set(I,new Map),null===(x=this.resolve(M.DbProxy))||void 0===x||x.clearConversatisationChange,this),thinjectProcessorBeforthis.processors.push(I)}processMessage(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x={needContinue:!0,data:I};for(let I of this.processors)if(!(x=yield I.process(x)).nese(){this.messages.clear(),this.processors=[]}}iS.messageComparator=(I,x)=>I.orderInConversation.gt(x.orderInConversation)?1:-1;class iT extends eu{constructor(I){super(I),this.participants=new Map}applyLocal(I){I.forEach(I=>{this.participants.has(I.conversationId)||this.participants.set(I.conversationId,new Map),this.participants.get(I.conversationId).set(I.userId.toString(),I)})}clearAll(){this.participants.clear()}updateWithUserIdAsync(I,x){var C,E,S,T;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let R=x.map(I=>Y.fromValue(I)),w=yield this.resolve(M.CoreApi).GetConversationParticipantByUserId({conversationId:I.id,conversationShortId:Y.fromString(I.shortId),conversationType:I.type,inboxType:I.inboxType,participants:R}),O=null!==(T=null===(S=null===(E=null===(C=null==w?void 0:w.body)||void 0===C?void 0:C.mget_conversation_participants_body)||void 0===E?void 0:E.participants)||void 0===S?void 0:S.map(x=>eB.fromServerParticipant(this.ctx,x,I,w.log_id)))&&void 0!==T?T:[];this.upsertBatch(I.id,O)})}upsert(I,x,C=!1){var E;let S=this.participants.get(I.toString());S||(S=new Map);let T=x;return T.userId=T.u(x.userId.toString())&&(T=eB.featLocalParticipant(S.get(x.userId.toString()),T)),S.set(x.userId.toString(),T),this.participants.set(I,S),C||(this.resolve(M.EventBus).emit(Z.c5.ParticipantUpsert,this,T),this.resolve(M.EventBus).emitEmpty(Z.c5.ParticipantChange,this)),null===(E=this.resolve(M.DbProxy))||void 0===E||E.upsertParticipant(T),Array.from(S.values())}upsertBatch(I,x,C=!1){return x.forEach(x=>this.upsert(I,x,C)),this.get(I)}delete(I,x){let C=this.participants.get(I);C&&x.forEach(I=>{var x;let E=C.get(I.toString());void 0!==E&&(C.delete(I.toString()),this.resolve(M.EventBus).emit(Z.c5.ParticipantLeave,this,E),this.resolve(M.EventBus).emitEmpty(Z.c5.ParticipantChange,this),null===(x=this.resolve(M.DbProxy))||void 0===x||x.deleteParticipant(E))})}get(I){let x=this.participants.get(I);if(x)return Array.from(x.values());{let x=this.resolve(M.ConversationManager).get(I);return this.getParticipants(x)}}getParticipants(I){var x,C,E;let S=[],T=this.getRaw(I.id);return(null==T?void 0:T.length)>0?T:(Number(null===(C=null===(x=null==I?void 0:I.firstPageParticipant)||void 0===x?void 0:x.participants)||void 0===C?void 0:C.length)>0?((null===(E=null==I?void 0:I.firstPageParticipant)||void 0===E?void 0:E.participants)||[]).forEach(x=>{S.push(eB.fromServerParticipant(this.ctx,x,I,I.ext[Z.v9.LocalLogId]))}):I.type===K.im_proto.ConversationType.ONE_TO_ONE_CHAT&&(e_.ctxDebug(this.ctx,"no first page participant found, fallback to local"),[I.toParticipantUserId,this.ctx.option.userId].forEach(x=>{if(x){let C=eB.fakeParticipant(this.ctx,x,I);S.push(C)}})),this.upsertBatch(I.id,S,!0),this.resolve(M.EventBus).emit(Z.c5.InitParticiet x=this.participants.get(I);if(x)return x;throw new eS({ctx:this.ctx,type:Z.NI.ConversationNotExist,msg:`conversation ${I} participants is not loaded`,sender:this,args:{conversationId:I}})}getMapRaw(I){return this.participants.get(I)}getRaw(I){let x=this.participants.get(I);rerticipants.get(I);if(C)return C.get(x.toString())}dispose(){this.clearAll()}}class iR extends eu{isValidInbox(I){return void 0!==I&&(!!this.getContext().option.acceptIncorrectInboxType||this.getInboxTypeArray().includes(I))}needSpecifyInbox(){let I=this.ctx.option.inboxType;return void 0!==I&&s.getInboxT{let I=this="Cellular_4G",I[I.Cellular_5G==5]="Wifi",I[I.Other=6]="Other",I[I.None=7]="None"}(G||(G={}));class iw extends eu{}!function(I){I.SdkVersion="sdk.version",I.DbVersion="sdk.db.version",I.DbLastOpen="sdk.db.last_open",I.DbEncyption="sdk.db.encryption",I.UserToken="user.token",I.ConversationCheckTime="sdk.db.conversation.check.time",I.ConversationMsgCheckTime="sdk.db.conversation.msg.check.time"}(V||(V={}));class iO extends eu{constructor(I){super(I)}prepareToken(){var I,x;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let C=yield null===(I=this.resolve(M.DbProxy))||void 0===I?void 0:I.loadConfig(V.UserToken);C?this.isCertAuth&&!1===(yield null===(x=this.resolve(M.SecurityProxy))||void 0===x?void 0:x.getCert())?yield this.refreshToken():this.ctx.cachedToken=C:yield this.refreshToken()})}refreshToken(){var I,x,C;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let{token:E,authType:S}=this.ctx.option;if(S===K.im_proto.AuthType.PASSPORT_CERT_AUTH){let x="";try{x=(yield null===(I=this.resolve(M.SecurityProxy))||void 0===I?void 0:I.getTicket())||"",this.ctx.cachedToken=x}catch(I){throw new eS({ctx:this.ctx,msg:"failed to get ticket",type:Z.NI.TokenFuncError,sender:this})}return x}if("function"!=typeof E)return this.ctx.cachedToken=E,e_.ctxDebug(this.ctx,"token cached from const: ",this.ctx.cachedToken),yield null===(C=this.resolve(M.DbProxy))||void 0===C?void 0:C.saveConfig(V.UserToken,this.ctx.cachedToken),E;{let I;let C=ey.performanceNow(),R=null;if(null!==(R=S===K.im_proto.AuthType.CERT_AUTH?yield this.handleCertAuthToken(E):(I=E())instanceof Promise?yield I:I))return this.ctx.cachedToken=R,yield null===(x=this.resolve(M.DbProxy))||void 0===x?void 0:x.saveConfig(V.UserToken,R),this.resolve(M.Monitor).emitDuration(T.BizRefreshToken,C),e_.ctxDebug(this.ctx,"token cached from function: ",this.ctx.cachedToken),R;throw new eS({ctx:this.ctx,msg:"token is null",type:Z.NI.TokenFuncError,sender:this})}})}handleCertAuthToken(I){var x,C,E;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let S="";S=this.ctx.option.certAuthZeroTrustUsePubKey?yield null===(x=this.resolve(M.SecurityProxy))||void 0===x?void 0:x.getPubKey():yield null===(C=this.resolve(M.SecurityProxy))||void 0===C?void 0:C.getCertSignRequ=yield I(S),O={ts_sign:T,ticket:R,client_cert:w};return yield null===(E=this.resolve(M.SecurityProxy))||void 0===E?void 0:E.setSignValue(O),this.ctx.option.cert=w,this.ctx.option.tsSign=T,R})}get iype.CERT_AUTH,K.im_proto.AuthType.PASSPORT_CERT_AUTH].includes(this.ctx.option.authType)}}function ik(I,x){return I.gt(x)?I:x}function iA(I,x){return I.lt(x)?I:x}function iN(I,x,C){var E,M;let S=iA(x.readIndex,null!==(E=x.readOrder)&&void 0!==E?E:x.readIndex),T=ik(C.readIndex,null!==(M=C.readOrder)&&void 0!==M?M:C.readIndex);return I.getMessageList().filter(I=>I.indexInConversation.gte(S)&&I.indexInConversation.lte(T))}function iP(I,x){let C=[],E=iD(I.minIndex,x.minIndex),M=iDvoid 0!==M&&C.push(M),C}function iL(I){let x=[];for(let C of(I.sort((I,x)=>I.minIndex.sub(x.minIndex).toNumber()),I)){let I=0!==x.length?x[x.length-1]:void 0;0===x.length||(null==I?void 0:I.readIndex.lt(C.minIndex))?x.push(C):I.readIndex=ik(I.readIndex,C.readIndex)}return x}function iD(I,x){if(I.neq(x))return{minIndex:iA(I,x),readIndex:ik(I,x)}}class iU extends t1{constructor(){super(...arguments),this.innerCursor=[]}get coreApi(){return this.resolve(M.CoreApi)}get inboxType(){return this.resolve(M.InboxType)}get instance(){return this.resolve(M.CoreInstance)}getUserCursor(I){var x;return null!==(x=this.innerCursor[null!=I?I:this.inboxType.getDefaultInbox()])&&void 0!==x?x:Y.ZERO}setUserCursor(I,x){var C;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let E=null!=x?x:this.inboxType.getDefaultInbox(),S=this.innerCursor[E];(!S||S.lt(I))&&(e_.ctxDebug(this.ctx,`update cursor for inbox:${E} from ${null==S?void 0:S.toString()} to ${I.toString()}`),this.innerCursor[E]=I,yield null===(C=this.resolve(M.DbProxy))||void 0===C?void 0:C.saveUserCursor(E,I))})}getMessagesByUserInit(I={}){var x,C,E,S,T,R,w,O,A,N;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let P,L,D,U,B;let G=null!==(x=I.inboxType)&&void 0!==x?x:this.inboxType.getDefaultInbox(),V=null!==(C=I.cursor)&&void 0!==C?f(!this.inboxType.isValidInbox(G))throw new eS({ctx:this.ctx,msg:"invalid inbox",type:Z.NI.InvalidInboxType,sender:this});let H=Y.ZERO,W=Y.ZERO;if(I.mode===Z.k5.AwemeMode){let x=yield this.coreApi.GetMessagesByInit({inboxType:G,convLimit:I.convLimit,msgLimit:I.msgLimit,page:F,version:I.version}),C=null===(E=x.body)||void 0===E?void 0:E.message_by_init;P=null===(S=C.messages)||void 0===S?void 0:S.map(I=>I.conversations),L=[],null===(T=C.messages)||void 0===T||T.forEach(I=>I.messages&&(null==L?void 0:L.push(...I.messages))),D=null==C?void 0:C.user_cursor,U=C.has_more,W=C.next_init_version,B=x.log_id}else{let x=yield this.coreApi.GetMessagesByUserInitV2({cursor:Y.fromValue(V),inboxType:G,initSubType:I.initSubType,convLimit:I.convLimit,msgLimit:I.msgLimit,tagIds:null===(R=I.tagIds)||void 0===R?void 0:R.map(I=>Y.fromValue(I)),userCustomTagIds:null===(w=I.userCustomTagIds)||void 0===w?void 0:w.map(I=>Y.fromValue(I))}),C=null===(O=x.body)||void 0===O?void 0:O.messages_per_user_init_v2_body;P=C.conversations,L=C.messages,D=null==C?void 0:C.per_user_cursor,U=C.has_more,H=C.next_cursor,B=x.log_id}return this.instance.processInitConversation(P,B),yield this.instance.processInitMessage(L,B),this.getUserCursor(G).neq(Y.ZERO)&&(null==D?void 0:D.neq(Y.ZERO))&&(null===(A=this.getUserCursor(G))||void 0===A?void 0:A.neq(D))&&(e_.ctxWarn(this.ctx,`cursor not match: before:${null===(N=this.getUserCursor(G))||void 0===N?void 0:N.toString()}, after:${null==D?void 0:D.toString()}, pull user, logid:${B}`),yield this.getMessagesByUser({inboxType:G})),D&&(yield this.setUserCursor(D,G)),this.resolve(M.EventBus).emitEmpty(Z.c5.InitLoadPage,this),{hasMore:U,cursor:H,page:(null!=F?F:0)+1,version:W}})}getMessagesByUser(I={}){var x,C,E,S,T;return(0,eb.__awaiter)(this,void 0,void 0,function*(){if(I.cursor instanceof Date&&(I.cursor=`${I.cursor.getTime()}000`),void 0===I.inboxType&&(I.inboxType=this.inboxType.getDefaultInbox()),!this.inboxType.isValidInbox(I.inboxType))throw new eS({ctx:this.ctx,msg:"invalid inbox",type:Z.NI.InvalidInboxType,sender:this});if(!0===this.ctx.option.disableInitPull&&0===this.instance.getConversationList().length&&this.getUserCursor(I.inboxType).eq(Y.ZERO)&&void 0===I.cursor){e_.ctxWarn(this.ctx,"try to pull history from 0, preventing");return}let R=!0,w=void 0!==I.cursor?Y.fromValue(I.cursor):this.getUserCursor(I.inboxType);for(;R;){let O=yield this.coreApi.GetMessagesByUser({cursor:w,limit:null!==(x=I.limit)&&void 0!==x?x:50,inboxType:I.inboxType}),A=null===(C=O.body)||void 0===C?void 0:C.messages_per_user_body;R=A.has_more,w=A.next_cursor;let N=new Map;null===(E=A.hasmore_message_conv_list)||void 0===E||E.forEach(I=>{let x=I.toString(),C=this.resolve(M.ConversationManager).getWithShortIdRaw(x);N.set(x,null==C?void 0:C.lastMessageIndex)});let{conMap:P}=yield this.resolve(M.MessageManager).processNewMessagesFromPull(A.messages,Z.v$.UserInbox,O.log_id);null===(S=A.hasmore_message_conv_list)||void 0===S||S.forEach(I=>{let x=I.toString(),C=P.get(x);if(C){let I=this.resolve(M.ConversationManager).getRaw(C.conversationId);this.patchMessage({cursor:C,conversation:I,limitindex:N.get(x)})}else e_.ctxWarn(this.ctx,`not found message of conversation in hasmore_message_conv_list, conversationid:${x}, logid:${O.log_id}`)}),null===(T=A.conversation_badge_count)||void 0===T||T.map(I=>{let x=this.resolve(M.ConversationManager).getRaw(I.conversation_id.toString());x&&this.instance.handleBadgeCount(I,x)}),this.instance.initResult===Z.rb.Start&&this.resolve(M.EventBus).emitEmpty(Z.c5.InitLoadPage,this)}yield this.setUserCursor(w,I.inboxType),this.resolve(M.ConversationManager).refreshLocal()})}prepareHistoryForInbox({inboxType:I,convLimit:x,msgLimit:C,mode:E,convTotal:S,tagIds:T,userCustomTagIds:R}){var w,O,A;return(0,eb.__awaiter)(this,void 0,void 0,function*(){try{let N=yield null===(w=this.resolve(M.DbProxy))||void 0===w?void 0:w.loadUserCursor(I);if(void 0!==N)return e_.ctxDebug(this.ctx,`load history for inbox ${I} by db`),yield this.setUserCursor(N,I),yield this.getMessagesByUser({inboxType:I,cursor:N}),!0;if(this.ctx.option.disableInitPull){let M;if(e_.ctxDebug(this.ctx,`load history for inbox ${I} by disable init`),E===Z.k5.AwemeMode){let E=yield this.coreApi.GetMessagesByInit({inboxType:I,convLimit:x,msgLimit:C});M=(null===(O=E.body)||void 0===O?void 0:O.message_by_init).user_cursor}else{let E=yield this.coreApi.GetMessagesByUserInitV2({inboxType:I,convLimit:x,msgLimit:C,cursor:Y.ZERO});M=(null===(A=E.body)||void 0===A?void 0:A.messages_per_user_init_v2_body).per_user_cursor}return yield this.setUserCursor(M,I),!0}e_.ctxDebug(this.ctx,`load history for inbox ${I} by full init`);let P={hasMore:!0,cursor:Y.ZERO,page:0,version:void 0};for(;P.hasMore&&(P=yield this.getMessagesByUserInit(Object.assign({inboxType:I,initSubType:this.ctx.option.initSubType,convLimit:x,msgLimit:C,mode:E,tagIds:T,userCustomTagIds:R},P)),!S||!(this.resolve(M.ConversationManager).getConversationArray().length>=S)););return!0}catch(x){return e_.ctxError(this.ctx,`load history failed for inbox:${I}`,x),!1}})}patchMessage(I){var x,C;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let{cursor:E}=I,S=20;if(!I.limitindex)return;E instanceof eU&&(E=E.indexInConversation),void 0===E&&(E=I.conversation.firstMessageIndex);let R=yield this.coreApi.GetMessagesByConversation({conversationId:I.conversation.id,conversationShortId:Y.fromString(I.conversation.shortId),conversationType:I.conversation.type,anchorIndex:Y.fromValue(E),direction:K.im_proto.MessageDirection.OLDER,limit:null!==(x=I.limit)&&void 0!==x?x:S,inboxType:I.conversation.inboxType});this.resolve(M.Monitor).emitMetrics(T.GetMessagesByConversation,{count:1},{log_id:R.log_id,from:"patch",conversationId:I.conversation.shortId,cursor:Y.fromValue(E).toString()});let w=null===(C=R.body)||void 0===C?void 0:C.messages_in_conversation_body,{conMap:O}=yield this.resolve(M.MessageManager).processNewMessagesFromPull(w.messages,Z.v$.UserInbox,R.log_id),A=O.get(I.conversation.shortId);if(!(null==w?void 0:w.has_more)||!A||I.limitindex.gt((null==A?void 0:A.indexInConversation)||Y.ZERO)){I.conversation.forceRefreshUnreadCount();return}this.patchMessage({conversation:I.conversation,limit:I.limit||S,cursor:null==w?void 0:w.next_cursor,limitindex:I.limitindex})})}receivePacket(I){var x,C,E,M,S,T,R;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let w=I,O=!1,A=this.getUserCursor(w.inbox_type),N=null===(x=w.body)||void 0===x?void 0:x.has_new_message_notify;N?A.lt(null!==(C=N.previous_cursor)&&void 0!==C?C:Y.ZERO)||(null===(E=N.previous_cursor)||void 0===E?void 0:E.eq(Y.ZERO))?(O=!0,e_.ctxWarn(this.ctx,`push cursour is greater than local cursor, push:${null!==(M=N.previous_cursor)&&void 0!==M?M:Y.ZERO}, local:${A.toString()}, msgid:${null===(S=N.message)||void 0===S?void 0:S.server_message_id}, logid:${w.log_id}`)):(null===(T=N.previous_cursor)||void 0===T?void 0:T.eq(A))?yield this.instance.processPushMessage(N,w):(O=!0,e_.ctxWarn(this.ctx,`push cursour is less than localsage)||void 0===R?void 0:R.server_message_id}, logid:${w.log_id}`)):(O=!0,e_.ctxWarn(this.ctx,`push body is missing, logid:${w.log_id}`)),O&&(yield this.getMessagesByUser({inboxType:w.inbox_type,cursor:A}))})}getReportParams(I){return Object.assign({hybrid_type:"imcloud"},void 0!==I?{cursor:this.getUserCursor(I).toString()}:{})}}class iB extends eG{constructor(){super(...arguments),this.name="IMCloudHybridLinkPlugin"}install(){this.hybridLinkInstance=new iU(this.ctx),this.register(M.HybridLink,this.hybridLinkInstance)}}class iG{constructor(I,x){this.disposed=!1,this.plugins=[],this.isProcessing=!1;let C=new ec;this.ctx=C,C.register(M.Monitor,ey),C.register(M.CoreInstance,this),I.headers||(I.headers={}),I.httpHeaders||(I.httpHeaders={}),I.extended||(I.extended={}),I.boe?("string"==typeof(I=et(I)).boe&&(I.headers[Z.HF.envKey]=I.boe,I.headers[Z.HF.boeHeaderKey]="1",I.httpHeaders[Z.HF.envKey]=I.boe,I.httpHeaders[Z.HF.boeHeaderKey]="1"),"boolean"==typeof I.boe&&(I.headers[Z.HF.boeHeaderKey]="1",I.httpHeaders[Z.HF.boeHeaderKey]="1")):"string"==typeof(I=ee(I)).ppe?(I.headers[Z.HF.envKey]=I.ppe,I.headers[Z.HF.ppeHeaderKey]="1",I.httpHeaders[Z.HF.envKey]=I.ppe,I.httpHeaders[Z.HF.ppeHeaderKey]="1"):I.canary&&(I.headers[Z.HF.envKey]="canary",I.httpHeaders[Z.HF.envKey]="canary"),void 0===I.timeCalibration&&(I.timeCalibration=!0),this.initPlatformOptions(I),C.option=I,Q(this.ctx,I),this.net=I.network(C),this.http=I.http(C),this.websocket=I.webSocket(C);let E=!1===this.ctx.option.pullInterval||void 0===this.ctx.option.pullInterval?3e4:this.ctx.option.pullInterval;if(e_.ctxDebug(this.ctx,"use ticker interval:",E),this.ticker=this.createTicker(this.ctx,E),C.register(M.AuthManager,iO),C.register(M.ConversationManager,iI),C.register(M.MessageManager,iS),C.register(M.ParticipantManager,iT),C.register(M.EventBus,ia),C.register(M.NetworkManager,iy),C.register(M.CoreApi,t7),C.register(M.InboxType,iR),I.dundefined"!=typeof window?window:I.injectContext,E=`__imsdk_context_${this.ctx.id.split("-")[0]}`;if("object"==typeof I.injectContext&&(x=I.injectContext,I.injectContext=!0),"string"==typeof I.injectContext&&(E=I.injectContext,I.injectContext=!0),void 0===I.injectContext&&(I.injectContext=!0),"boolean"==typeof I.injectContext&&I.injectContext)try{Object.defineProperty(x,E,{enumerable:!1,configurable:!0,get(){return C}})}catch(I){e_.ctxDebug(C,"inject ctx:",C,`with name: ${E} to`,x,"failed: ",I)}}if(Array.isArray(x)&&(x.forEach(I=>{let x=new I(C);x.install(),this.plugins.push(x)}),this.ctx.plugin=this.plugins),!this.ctx.resogistered, load internal IMCloudHybridLinkPplugins.push(I)}e_.ctxDebug(this.ctx,"loaded plugin:",this.plugins),I.boe?e_.ctxDebug(this.ctx,`using boe env: ${!0===I.boe?"default":I. ${I.ppe}`),this.initEventHis),Object.seal(C))}getContext(){return this.ctx}resolve(I){return this.ctx.resolve(I)}get initResult(){return this.ctx.initResult}set initResult(I){this.ctx.initResult=I}get event(){return this.resolve(M.EventBus)}get api(){return this.resolve(M.CoreApi)}get network(){return this.resolve(M.NetworkManager)}get inboxType(){return this.resolve(M.InboxType)}get id(){return this.ctx.id}get option(){return this.ctx.option}init(I){var x,C,E,S,R,w,O,A,N,P,L;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let{userId:D,enableServerConfig:U,authType:B,webSocketLevel:G}=this.ctx.option;if(B&&[K.im_proto.AuthType.CERT_AUTH,K.im_proto.AuthType.PASSPORT_CERT_AUTH].includes(B))try{null===(x=this.resolve(M.SecurityProxy))||void 0===x||x.init(),this.ctx.option.cert=yield null===(C=this.resolve(M.SecurityProxy))||void 0===C?void 0:C.getCert(),this.ctx.option.tsSign=yield null===(E=this.resolve(M.SecurityProxy))||void 0===E?void 0:E.getTsSign()}catch(I){e_.ctxWarn(this.ctx,"get cert and tsSign error")}let V=ey.performanceNow();this.initResult=Z.rb.Start;let F=null!==(R=yield null===(S=this.resolve(M.DbProxy))||void 0===S?void 0:S.init(D))&&void 0!==R&&R;try{yield this.resolve(M.AuthManager).prepareToken()}catch(I){return this.initResult=Z.rb.Error,e_.ctxError(this.ctx,"prepare token error:",I),this.resolve(M.Monitor).emitDuration(T.BizSdkInit+T.ErrorSuffix,V,Object.assign(Object.assign({use_db:null!==(w=F.toString())&&void 0!==w?w:"unknown"},this.resolve(M.HybridLink).getReportParams()),{reason:"token"})),this.initResult}if(U)try{yield this.initConfig()}catch(I){e_.ctxWarn(this.ctx,"init server config error:",I)}for(let x of this.inboxType.getInboxTypeArray())if(!(yield this.prepareHistoryForInbox({inboxType:x,convLimit:null==I?void 0:I.convLimit,msgLimit:null==I?void 0:I.msgLimit,mode:null==I?void 0:I.mode,convTotal:null==I?void 0:I.convTotal,tagIds:null==I?void 0:I.tagIds,userCustomTagIds:null==I?void 0:I.userCustomTagIds})))return this.initResult=Z.rb.Error,e_.ctxError(this.ctx,"init history error for inbox",x),this.resolve(M.Monitor).emitDuration(T.BizSdkInit+T.ErrorSuffix,V,Object.assign(Object.assign({use_db:null!==(O=F.toString())&&void 0!==O?O:"unknown"},this.resolve(M.HybridLink).getReportParams(x)),{reason:"history"})),this.initResult;yield this.resolve(M.ConversationManager).refreshLocalAsync(),this.resolve(M.EventBus).emitEmpty(Z.c5.ConversationChange,this);try{for(let I of this.plugins)yield I.init()}catch(I){return this.initResult=Z.rb.Error,e_.ctxError(this.ctx,"init plugin error:",I),this.resolve(M.Monitor).emitDuration(T.BizSdkInit+T.ErrorSuffix,V,Object.assign(Object.assign({use_db:null!==(A=F.toString())this.resolve(M.HybridLink).getReportParams()),{reason:"plugin"})),this.initResult}if(G!==Z._.Disable)try{this.resolve(M.Monitor).emitCounter(T.WebSocketConnectFirst,1,{url:null!==(P=null===(N=this.network.ws)||void 0===N?void 0:N.url)&&void 0!==P?P:"unknown"}),yield this.network.connectWs(!0)}catch(I){e_.ctxWarn(this.ctx,"skip websocket, init open fail:",I)}return this.ticker.onTick.subscribe(()=>{this.tickerUpdate()}),this.ticker.restart(),this.initResult=Z.rb.Succeeded,this.resolve(M.Monitor).emitDuration(T.BizSdkInit+T.SuccessSuffix,V,Object.assign({use_db:null!==(L=F.toString())&&void 0!==L?L:"unknown"},this.resolve(M.HybridLink).getReportParams())),this.resolve(M.EventBus).emit(Z.c5.InitFinish,this,this.initResult),this.initResult})}getMessagesByUser(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return this.resolve(M.HybridLink).getMessagesByUser(I)})}getMessagesByConversation(I){var x,C,E,S;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let{cursor:R}=I,{direction:w}=I;R instanceof eU&&(R=R.indexInConversation),void 0===R&&(R=I.conversation.firstMessageIndex,I.conversation.firstMessageIndex.gt(null!==(x=I.conversation.__internal_pullCursor)&&void 0!==x?x:Y.ZERO)&&(R=I.conversation.__internal_pullCursor,e_.ctxDebug(this.ctx,`using internal cursor: ${R.toString()} < ${I.conversation.firstMessageIndex.toString()} for conversation:`,I.conversation)));let O=yield this.api.GetMessagesByConversation({conversationId:I.conversation.id,conversationShortId:Y.fromString(I.conversation.shortId),conversationType:I.conversation.type,anchorIndex:Y.fromValue(R),direction:w||K.im_proto.MessageDirection.OLDER,limit:null!==(C=I.limit)&&void 0!==C?C:20,inboxType:I.conversation.inboxType});this.resolve(M.Monitor).emitMetrics(T.GetMessagesByConversation,{count:1},{log_id:O.log_id,from:"user",conversation_id:I.conversation.shortId,cursor:Y.fromValue(R).toString()});let A=null===(E=O.body)||void 0===E?void 0:E.messages_in_conversation_body;I.conversation.__internal_pullCursor=null!==(S=A.next_cursor)&&void 0!==S?S:I.conversation.__internal_pullCursor;let{msgs:N}=yield this.resolve(M.MessageManager).processNewMessagesFromPull(A.messages,Z.v$.LoadMore,O.log_id);return{messages:N,hasMore:null==A?void 0:A.has_more,cursor:null==A?void 0:A.next_cursor}})}markConversationRead(I){var x,C;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let E,S,{readIndex:T,readIndexV2:R}=I,{conversation:w}=I;void 0===T?T=w.lastMessageIndex:T instanceof eU&&(T=T.indexInConversation),void 0===R?R=w.lastMessageIndexV2:R instanceof eU&&(R=R.indexInConversationV2);let O=Y.fromValue(T),A=Y.fromValue(R),N=w.readIndex;if(!I.force&&O.lt(N))return;let{newReadBadgeCount:P,newMuteReadBadgeCount:L}=this.calcBadgeCount(w,O,N),D=[{message_type:K.im_proto.MuteMessageType.TYPE_PART_MUTE,read_badge_count:L}];if(this.resolve(M.ConversationManager).markRead(w.id,O,P,D),this.ctx.option.unreadCountReport){let M=this.getConversationList({filter:I=>I.inboxType===w.inboxType&&I.isMember&&0===I.mode}).reduce((I,x)=>I+x.unreadCount,0);S=null!==(x=I.totalUnreadCount)&&void 0!==x?x:M,E=null!==(C=I.convUnreadCount)&&void 0!==C?C:w.unreadCount}yield this.api.MarkConversationReadV3({conversationId:w.id,conversationShortId:Y.fromString(w.shortId),conversationType:w.type,readIndex:O,readIndexV2:A.gt(0)?A:Y.ONE,inboxType:w.inboxType,unreadCount:void 0!==E?Yount:void 0!==S?Y.fromValue(S):void 0,readBadgeCount:P,muteReadBadgeCountInfos:D})})}calcBadgeCount(I,x,C){let E,M;return I.lastMessageIndex.eq(x)?(E=I.badgeCount,M=I.partMuteBadgeCount):(E=Math.min(I.badgeCount,I.settingInfo.readBadgeCount+I.getLocalMessageRangeList(C,x).length),M=Math.min(I.partMuteBadgeCount,I.settingInfo.partMuteReadBadgeCount+I.getLocalMessageRangeList(C,x).filter(x=>I.isMsgInWeakMuteWhiteList(x)).length)),{newReadBadgeCount:E,newMuteReadBadgeCount:M}}batchClearConversationRead(I){var x;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let C=null!==(x=I.messageTypes)&&void 0!==x?x:[K.im_proto.MuteMessageType.TYPE_PART_MUTE,0],E=I.conversations.map(I=>{let x=C.includes(K.im_proto.MuteMessageType.TYPE_PART_MUTE),E=C.includes(0),M={muteReadBadgeCountInfos:x?[{message_type:K.im_proto.MuteMessageType.TYPE_PART_MUTE,read_badge_count:I.partMuteBadgeCount}]:[{message_type:K.im_proto.MuteMessageType.TYPE_PART_MUTE,read_badge_count:I.settingInfo.partMuteReadBadgeCount}],readBadgeCount:E?x?I.badgeCount:Math.max(I.badgeCount-I.unreadCountWithWhiteList,0):x?Math.min(I.settingInfo.readBadgeCount+I.unreadCountWithWhiteList,I.badgeCount):I.settingInfo.readBadgeCount},S=0,T=0,R=Y.fromValuationId:I.id,conversationShortId:Y.fromString(I.shortId),conversationType:I.type,readIndex:Y.fromValue(I.settingInfo.readIndex),readIndexV2:R.gt(0)?R:Y.ONE,inboxType:I.inboxType,unreadCount:Y.fromValue(S),totalUnreadCount:Y.fromValue(T)},M)});yield thationReadV3({batch:E})})}get noticeUnsationList().filter(I=>I.pushStatus===Z.Bs.Allow||I.pushStatus===Z.Bs.Unknown).reduce((I,x)=>I+x.unreadCount,0)+this.getConversationList().filter(I=>I.pushStatus===Z.Bs.PartAllow).reduce((I,x)=>I+x.unreadCountWithWhiteList,0)}get mutedUnreadCount(){return this.getConversationList().filter(I=>I.pushStatus===Z.Bs.Disable).reduce((I,x)=>I+x.unreadCount,0)+this.getConversationList().filter(I=>I.pushStatus===Z.Bs.PartAllow).reduce((I,x)=>I+Math.max(0,x.unreadCount-x.unreadCountWithWhiteList),0)}recallMessage(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){if(!I.message.serverId)throw new eS({ctx:this.ctx,type:Z.NI.MessageNotReady,msg:`message ${I.message} is not ready`,sender:this});let x=this.resolve(M.ConversationManager).get(I.message.conversationId),C=yield this.api.RecallMessage({conversationId:I.message.conversationId,conversationShortId:Y.fromString(I.message.conversationShortId),conversationType:I.message.conversationType,serverId:Y.fromString(I.message.serverId),inboxType:x.inboxType});this.resolve(M.MessageManager).markRecalled(I.message.conversationId,I.message.serverId,C.log_id)})}createConversation(I){var x,C,E,S,R;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let w=ey.performanceNow(),O=[],A={success:!1,payload:null};if(void 0===I.inboxType&&(I.inboxType=this.inboxType.getDefaultInbox()),!this.inboxType.isValidInbox(I.inboxType))throw new eS({ctx:this.ctx,msg:"invalid inbox",type:Z.NI.InvalidInboxType,sender:this});if(void 0===I.type&&(Array.isArray(I.participants)?I.participants.length<=1?I.type=K.im_proto.ConversationType.ONE_TO_ONE_CHAT:I.type=K.im_proto.ConversationType.GROUP_CHAT:I.type=K.im_proto.ConversationType.ONE_TO_ONE_CHAT),(O=Array.isArray(I.participants)?-1===I.participants.indexOf(this.ctx.option.userId)?I.participants.concat(this.ctx.option.userId):I.participants:[I.participants,this.ctx.option.userId]).length>2&&I.type===K.im_proto.ConversationType.ONE_TO_ONE_CHAT)return A.statusCode=Z.NI.InvalidParam,A.statusMsg="one to one chat can only has 2 participants",A;void 0===I.persistent&&void 0!==I.idempotentId&&I.idempotentId.length>0&&(I.persistent=!0);try{let x=yield this.api.CreateConversationV2({type:I.type,participants:O.map(I=>Y.fromValue(I)),persistent:I.persistent,idempotentId:I.idempotentId,name:I.name,avatarUrl:I.avatarUrl,desc:I.desc,bizExt:I.bizExt,inboxType:I.inboxType}),C=x.body.create_conversation_v2_body;if(A.checkCode=C.check_code,A.checkMsg=C.check_message,A.statusCode=C.status,A.statusMsg=C.extra_info,A.body=C,(null==C?void 0:C.status)===0){let I=eD.fromServerConversation(this.ctx,null==C?void 0:C.conversation,x.log_id);this.resolve(M.ConversationManager).upsert(I),yield this.resolve(M.ConversationManager).refreshAsync(I);let E=this.resolve(M.ConversationManager).get(I.id);A.success=!0,A.payload=E,this.resolve(M.EventBus).emit(Z.c5.ConvtworkError,A.innerError=I}return this.resolve(M.Monitor).emitMetrics(T.CreateConversation,{create_cost:Math.round(ey.performanceNow()-w)},{type:null!==(E=null===(C=I.type)||void 0===C?void 0:C.toString())&&void 0!==E?E:"unknown",error_code:null!==(R=null===(S=A.statusCode)||void 0===S?void 0:S.toString())&&void 0!==R?R:"unknown"}),A})}getConversation(I){return this.resolve(M.ConversationManager).get(I.conversationId)}getConversationOnline(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return this.resolve(M.ConversationManager).getWithOnline(I.conversationId,I.shortId,I.type)})}getConversationList(I={}){let{filter:x,tagIds:C,userCustomTagIds:E}=I,S=this.resolve(M.ConversationManager).getConversationArray(x);if(C||E){let I=Array.isArray(C)?C:[C].filter(Boolean),x=Array.isArray(E)?E:[E].filter(Boolean);if(I.length>0||x.length>0){let C=new Set(I),E=new Set(x);S=S.filter(I=>I.tagIds.find(I=>C.has(I))||I.userTagIds.find(I=>E.has(I)))}}return S}getConversationListOnline(I={}){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return yield this.resolve(M.ConversationManager).refreshLocalAsync(),this.getConversationList(I)})}getConversationMessages(I){var x;let{conversation:C}=I;if(I.isCheckMsg)try{null===(x=this.resolve(M.DbProxy))||void 0===x||x.checkMessages(C)}catch(I){e_.ctxWarn(this.ctx,`check msgs error, conv id: ${C.id}`)}return I.filter||(I.filter=I=>I.visible),this.resolve(M.MessageManager).getList(C.id).filter(I.filter)}createMessage(I){var x;return(0,eb.__awaiter)(this,void 0,void 0,function*(){void 0===I.insert&&(I.insert=!0);let C=Object.assign({},I.ext),E=eU.createClientMessage(this.ctx,{type:I.type,content:I.content,ext:C,id:null!==(x=I.clientId)&&void 0!==x?x:ed(),conversationId:I.conversation.id,mentionedUsers:I.mentionedUsers||[],conversationShortId:I.conversation.shortId,conversationType:I.conversation.type,referenceMessage:I.referenceMessage,referenceHint:I.referenceHint});return E.flightStatus=Z.b3.Created,E.sendFunc=this.__internal_sendMessageObject.bind(this),E.indexInConversation=I.conversation.lastMessageIndex.add(1),E.orderInConversation=I.conversation.lastMessageOrder.add(1),I.insert&&(yield this.resolve(M.MessageManager).processNewMessage(E,Z.v$.Offline)),E})}sendMessage(I){var x,C,E,S;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let{message:R}=I,w=Date.now(),O=yield R.sendFunc(R);this.resolve(M.EventBus).emit(Z.c5.MessageSend,this,R);try{let I=Date.now(),A=this.resolve(M.ConversationManager).get(R.conversationId);this.resolve(M.Monitor).emitMetrics(T.SendMessage,{con_member_count:A.participantCount-1,send_cost_time:I-w},{con_type:R.conversationType.toString(),conversation_id:R.conversationId,msg_uuid:R.serverId,msg_type:R.type.toString(),send_start_time:w.toString(),send_end_time:I.toString(),error_code:null!==(C=null===(x=O.statusCode)||void 0===x?void 0:x.toString())&&void 0!==C?C:"unknown",is_ws:(null===(E=this.network.ws)||void 0===E?void 0:E.isOpen())?"1":"0",logid:null!==(S=O.logid)&&void 0!==S?S:""})}catch(I){e_.ctxWarn(this.ctx,"Fail to report data after send message",I)}return O})}fetchConversation(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let x=null;if(void 0!==I.shortId){let x=this.resolve(M.ConversationManager).getWithShortIdRaw(I.shortId);if(void 0!==x&&!x.isOffline)return x}if(void 0===I.inboxType&&(I.inboxType=this.inboxType.getDefaultInbox()),!this.inboxType.isValidInbox(I.inboxType))throw new eS({ctx:this.ctx,msg:"invalid inbox",type:Z.NI.InvalidInboxType,sender:this});if(void 0!==I.idempotentId&&void 0===I.participantId){let C=yield this.createConversation({type:K.im_proto.ConversationType.GROUP_CHAT,participants:[],inboxType:I.inboxType,idempotentId:I.idempotentId});C.success&&null!==(x=C.payload)&&(yield this.getConversationOnline({conversationId:x.id,shortId:x.shortId,type:K.im_proto.ConversationType.ONE_TO_ONE_CHAT}))}else if(void 0!==I.participantId){let C=yield this.createConversation({type:K.im_proto.ConversationType.ONE_TO_ONE_CHAT,participants:I.participantId,inboxType:I.inboxType});C.success&&null!==(x=C.payload)&&(yield this.resolve(M.ConversationManager).refreshAsync(x))}else if(void 0!==I.shortId)x=yield this.getConversationOnline({conversationId:I.shortId,shortId:I.shortId,type:K.im_proto.ConversationType.GROUP_CHAT});else throw new eS({ctx:this.ctx,type:Z.NI.InvalidParam,msg:"no valid param provided",reachServer:!1,sender:this});if(null!==x&&!x.isOffline)return yield this.getMessagesByConversation({conversation:x}),x;throw new eS({ctx:this.ctx,type:Z.NI.ConversationNotExist,msg:"fetch failed, conv is null or offline",reachServer:!1,sender:this})})}getMessageReadReceipt(I){if(!I.message.isFromMe||I.message.isOffline)return{finishedParticipants:[],expectedParticipants:[]};let x=this.resolve(M.ConversationManager).get(I.message.conversationId);if(0===x.getParticipantList().length)return{finishedParticipants:[],expectedParticipants:[]};let C=I.message.__internal_cachedReadReceipt,E=!0;if(void 0!==C&&(0!==C.expectedParticipants.length&&C.expectedParticipants.length===C.finishedParticipants.length&&(E=!1),I.message.__internal_receiptClean&&(E=!1)),E){let C=[],E=[],M=x.getParticipantList();0!==M.length&&M.forEach(x=>{!x.minIndex.gt(I.message.indexInConversation)&&x.userId!==this.ctx.option.userId&&(E.push(x),(x.readOrder.gte(I.message.orderInConversation)||x.readIndex.gte(I.message.indexInConversation))&&C.push(x))}),I.message.__internal_cachedReadReceipt={finishedParticipants:C,expectedParticipants:E},I.message.__internal_receiptClean=!0}return I.message.__internal_cachedReadReceipt}updateConversationReadReceipt(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let{conversation:x}=I,C=this.resolve(M.ParticipantManager).getRaw(x.id);if(!C.length){this.resolve(M.ParticipantManager).getParticipants(x);return}let E={},{readIndexs:S,minIndexs:T}=yield this.getParticipantsReadAndMinIndex({conversation:I.conversation,batchFetch:I.batchFetch});T.forEach(I=>{E[I.user_id.toString()]={minIndex:I.index,readIndex:I.index}}),S.forEach(I=>{void 0!==E[I.user_id.toString()]?E[I.user_id.toString()].readIndex=I.index:E[I.user_id.toString()]={readIndex:I.index,minIndex:Y.ZERO}});let R=[];for(let I of Object.keys(E)){let S=E[I],T=C.find(x=>x.userId===I),w=iP(T?{readIndex:T.readIndex:Y.ZERO,minIndex:Y.ZERO},S);R.push(...w),void 0!==T&&(T.readIndex.neq(S.readIndex)||T.readOrder.neq(S.readIndex)||T.minIndex.neq(S.minIndex))&&(T.readIndex=S.readIndex,T.readOrder=S.readIndex,T.minIndex=S.minIndex,this.resolve(M.ParticipantManager).upsert(x.id,T))}let w=iL(R),O=[];for(let I of w)O.push(...iN(x,{readIndex:I.minex:I.readIndex}));0!==O.length&&(O.forEach(I=>I.__internal_receiptClean=!1),this.resolve(M.EventBus).emit(Z.c5.ReadReceiptChange,this,{conversation:x,messages:O}))})}dispose(){var I,x;this.resolve(M.EventBus).unsubscribeAll(),null===(I=this.ticker)||void 0===I||I.stop(),this.network.closeWs(),null===(x=this.network.ws)||void 0===x||x.dispose(),this.network.onMessage.unsubscribeAll(),this.plugins.forEach(I=>I.dispose()),this.plugins.length=0,this.resolve(M.ConversationManager).dispose(),this.resolve(M.MessageManager).dispose(),this.resolve(M.ParticipantManager).dispose(),this.ctx.option.monitor=void 0,this.ctx.option.aspectBefore=()=>(e_.ctxError(this.ctx,"do not invoke a disposed instance"),!1),this.disposed=!0,e_.ctxDebug(this.ctx,"sdk unloaded, do not invoke this instance")}prepareHistoryForInbox(I){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return this.resolve(M.HybridLink).prepareHistoryForInbox(I)})}tickerUpdate(){return(0,eb.__awaiter)(this,void 0,void 0,function*(){if((yield this.network.net.getConnectionStatus())!==B.Disconnected&&this.initResult===Z.rb.Succeeded){if(this.ctx.option.pullInterval&&!this.isProcessing&&!(this.ctx.option.disablePullIntervalWhenWsIsOnline&&this.network.isWsOnline))for(let I of this.inboxType.getInboxTypeArray())try{yield this.getMessagesByUser({inboxType:I}),this.resolve(M.Monitor).emitMetrics(T.GetMessagesByTicker,{count:1},Object.assign({tick_timer:this.ticker.getTickTimer(),time:Math.round(Date.now()/1e3).toString(),inbox:I.toString()},this.resolve(M.HybridLink).getReportParams(I)))}catch(I){e_.ctxWarn(this.ctx,"ticker running in pull user err:",I)}for(let I of this.plugins)try{yield I.ticker()}catch(I){e_.ctxWarn(this.ctx,"ticker running in plugin err:",I)}}})}__internal_sendMessageObject(I){var x,C,E,S,T;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let R={success:!1,payload:I};if(I.serverId)return R.statusCode=0,R;let w=this.resolve(M.ConversationManager).getRaw(I.conversationId);if(void 0===w)return R.statusCode=Z.NI.ConversationNotExist,R.statusMsg=`conversation ${I.conversationId} not exist in local`,R;I.flightStatus=Z.b3.Inflight,yield this.resolve(M.MessageManager).processNewMessage(I,Z.v$.Offline);try{w.ticket||(yield this.resolve(M.ConversationManager).refreshTicket(w.id))}catch(C){return I.flightStatus=Z.b3.Failed,R.statusCode=null!==(x=C.type)&&void 0!==x?x:Z.NI.InvalidTicket,R.innerError=C,this.resolve(M.MessageManager).upsert(I),R}try{if(this.ctx.option.timeCalibration){let x=this.ctx.resolve(M.Monitor).avgDelta,C=Date.now();I.ext[Z.v9.SendTime]=(C+x).toString()}let x=yield this.api.SendMessage({conversationType:w.type,conversationId:w.id,conversationShortId:Y.fromString(w.shortId),content:I.content,ticket:w.ticket,ext:I.ext,messageType:I.type,clientId:I.clientId,mentionedUsers:I.mentionedUsers.map(I=>Y.fromString(I)),inboxType:w.inboxType,referenceInfo:I.referenceInfo}),T=null===(C=x.body)||void 0===C?void 0:C.send_message_body;if(I.ext[Z.v9.SendResponseCheckCode]=null!==(E=null==T?void 0:T.check_code.toString())&&void 0!==E?E:"",I.ext[Z.v9.SendResponseCheckMessage]=null==T?void 0:T.check_message,I.ext[Z.v9.SendResponseExtraInfo]=null==T?void 0:T.extra_info,I.ext[Z.v9.SendResponseStatus]=null!==(S=null==T?void 0:T.status.toString())&&void 0!==S?S:"",this.ctx.option.debug&&(I.ext[Z.v9.LocalLogId]=x.log_id),R.body=T,R.checkCode=T.check_code,R.checkMsg=T.check_message,R.statusCode=T.status,R.statusMsg=T.extra_info,R.logid=x.log_id,0===T.status){let x=T.server_message_id.toString();I.serverId=x,I.flightStatus=Z.b3.Succeeded,I.isOffline=!1,yield this.resolve(M.MessageManager).processNewMessage(I,Z.v$.Offline),R.success=!0}else I.flightStatus!==Z.b3.Received?(I.flightStatus=Z.b3.Rejected,T.status===K.im_proto.SendMessageStatus.CHECK_MSG_NOT_PASS_BUT_SELF_VISIBLE&&(I.flightStatus=Z.b3.SelfVisible)):R.success=!0}catch(x){I.flightStatus!==Z.b3.Received&&(I.flightStatus=Z.b3.Failed),R.innerError=x,R.statusCode=null!==(T=x.type)&&void 0!==T?T:Z.NI.NetworkError}return this.resolve(M.MessageManager).upsert(I),R})}receivePacket(I){var x,C;return(0,eb.__awaiter)(this,void 0,void 0,function*(){if(this.initResult===Z.rb.Succeeded){this.isProcessing=!0;try{if(I.cmd===K.im_proto.IMCMD.NEW_MSG_NOTIFY){let E=null===(x=I.body)||void 0===x?void 0:x.has_new_message_notify;if(E){let x=this.resolve(M.ConversationManager).getRaw(E.conversation_id);yield this.clientAck({packet:I,inboxType:null!==(C=null==x?void 0:x.inboxType)&&void 0!==C?C:null==I?void 0:I.inbox_type,type:K.im_proto.MsgReportType.MSG_RECEIVE_BY_WS}),this.handleBadgeCount(E,x)}for(let x of(yield this.resolve(M.HybridLink).receivePacket(I),this.resolve(M.ConversationManager).refreshLocal(),this.plugins))yield x.receivePacket(I)}}catch(I){throw I}finally{this.isProcessing=!1}}})}handleBadgeCount(I,x){try{x&&(I.badge_count&&(x.badgeCount=I.badge_count),Array.isArray(I.mute_badge_count_info)?x.mergeMuteBadgeCountInfos(I.mute_badge_count_info):I.mute_badge_count_info&&x.mergeMuteBadgeCountInfos([I.mute_badge_count_info]),this.resolve(M.ConversationManager).upsert(x))}catch(I){e_.ctxWarn(this.ctx,"handle badge count data error",I)}}clientAck({packet:I,inboxType:x,type:C}){var E,S,R,w,O,A;return(0,eb.__awaiter)(this,void 0,void 0,function*(){let N;if(!(!(null===(E=I.body)||void 0===E?void 0:E.has_new_message_notify)||!I.start_time_stamp||I.start_time_stamp.lte(0))){switch(yield this.network.net.getNetworkType()){case G.Cellular_2G:N=K.im_proto.NetworkType.MOBILE_2G;break;case G.Cellular_3G:N=K.im_proto.NetworkType.MOBILE_3G;break;case G.Cellular_4G:N=K.im_proto.NetworkType.MOBILE_4G;break;case G.Cellular_5G:N=K.im_proto.NetworkType.MOBILE_5G;break;case G.Wifi:N=K.im_proto.NetworkType.WIFI;break;default:N=K.im_proto.NetworkType.UNKNOWN}this.resolve(M.Monitor).emitMetrics(T.MessageAck,{count:1},{start_timestamp:I.start_time_stamp.toString(),cmd:I.cmd.toString(),network_type:N.toString(),logid:I.log_id,client_timestamp:new Date().getTime().toString(),server_message_id:null!==(w=null===(R=null===(S=I.body.has_new_message_notify.message)||void 0===S?void 0:S.server_message_id)||void 0===R?void 0:R.toString())&&void 0!==w?w:"0",report_net_type:C.toString()}),yield this.api.ClientAck({startTimeStamp:I.start_time_stamp,cmd:I.cmd,NetworkType:N,logid:I.log_id,clientTimeStamp:Y.fromNumber(new Date().getTime()),serverId:null!==(A=null===(O=I.body.has_new_message_notify.message)||void 0===O?void 0:O.server_message_id)&&void 0!==A?A:Y.ZERO,inboxType:x,type:C})}})}reportMessageDelayTime(I,x){var C,E,S,R,w,O,A,N,P;let L;let D=null===(C=I.create_time)||void 0===C?void 0:C.toNumber();if(!D)return;let U=this.ctx.option.timeCalibration?this.resolve(M.Monitor).avgDelta:0,B=Date.now(),G=Math.round(B+U-D);if(G<=0){e_.ctxDebug(this.ctx,`message reception delay is less than 0, serverId:${I.server_message_id}, current:${B}, createTime:${D}, timeDelta:${U}`);return}let V=Number(null===(E=I.ext)||void 0===E?void 0:E[Z.v9.SendTime]);if(Number.isFinite(V)){let x=Math.round(B+U-V);x>0?L=x:e_.ctxDebug(this.ctx,`end_end_cost is less than 0, serverId:${I.server_message_id}, current:${B}, sendTimeFromClient:${V}, timeDelta:${U}`)}this.resolve(M.Monitor).emitMetrics(T.ReceiveMessage,Object.assign({receive_cost_time:G},L?{end_end_cost:L}:{}),Object.assign({con_type:null!==(R=null===(S=I.conversation_type)||void 0===S?void 0:S.toString())&&void 0!==R?R:"",conversation_id:null!==(w=I.conversation_id)&&void 0!==w?w:"",msg_uuid:null!==(A=null===(O=I.server_message_id)||void 0===O?void 0:O.toString())&&void 0!==A?A:"",receive_end_time:B.toString(),receive_start_time:D.toString(),time_delta:U.toString(),msg_type:null!==(P=null===(N=I.message_type)||void 0===N?v0",ntp_ready:this.ctx.option.timeCalibration?"1":"0",is_ws:"1",logid:x},this.resolve(M.HybridLink).getReportParams()))}processInitMessage(I,x){return(0,eb.__awaiter)(this,void 0,void 0,function*(){I&&(yield this.resolve(M.MessageManager).processNewMessagesFromPull(I,Z.v$.Init,x))})}processInitConversation(I,x){I&&I.map(I=>eD.fromServerConversation(this.ctx,I,x)).forEach(I=>this.resolve(M.ConversationManager).upsert(I))}processPushMessage(I,x){return(0,eb.__awaiter)(this,void 0,void 0,function*(){let C=I.message;if(C){this.reportMessageDelayTime(C,x.log_id);let I=eU.fromServerMessage(this.ctx,C,x.log_id);I.ext||(I.ext={}),this.ctx.option.debug&&(I.ext[Z.v9.LocalLogId]=x.log_id),yield this.resolve(M.MessageManager).processNewMessage(I,Z.v$.Online)}else e_.ctxWarn(this.ctx,"msg body is empty:",I)})}getParticipantsReadAndMinIndex(I){var x;return(0,eb.__awaiter)(this,void 0,void 0,function*(){if(I.batchFetch){let{conversation:C}=I,E=(yield this.api.BatchGetConversationParticipantsReadIndex({conversationId:[C.id],conversationShortId:[Y.fromString(C.shortId)],min_index_required:!0})).conversationParticipantsReadIndex,M=(null===(x=null==E?void 0:E[0])||void 0===x?void 0:x.participantReadIndex)||[],S=[],T=[];return M.forEach(I=>{I.index&&S.push({user_id:Y.fromString(I.user_id.toString()),index:Y.fromString(I.index.toString())}),T.push({user_id:Y.fromString(I.user_id.toString()),index:Y.fromString(I.index_min.toString())})}),{readIndexs:S,minIndexs:T}}{let x=yield this.api.GetConversationParticipantsReadIndexV3({conversationId:I.conversation.id,conversationShortId:Y.fromString(I.conversation.shortId),conversationType:I.conversation.type,inboxType:I.conversation.inboxType}),C=yield ttion.id,conversationShortId:Y.fromString(I.conversation.shortId),conversationType:I.conversation.type,inboxType:I.conversation.inboxType});return{readIndexs:(null==x?void 0:x.indexes)||[],minIndexs:C.indexes||[]}}})}initEventHandler(){this.network.onMessage.subscribe(I=>this.receivePacket(I)),this.resolve(M.EventBus).subscribe(Z.c5.InitParticipant,I=>{this.updateConversationReadReceipt({conversation:I,batchFetch:!0})})}initConfig(){var I;return(0,eb.__awaiter)(this,void 0,void 0,function*(){try{let x=yield this.api.GetConfigs();null===(I=null==x?void 0:x.configs)||void 0===I||I.forEach(I=>{let x=I.conf_value;null!=x&&("true"===I.conf_value?x=!0:"false"===I.conf_value?x=!1:isNaN(Number(I.conf_value))||(x=Number(I.conf_value)),this.ctx.config.set(I.conf_name,x))}),e_.ctxDebug(this.ctx,"load server config",this.ctx.config)}catch(I){e_.ctxWarn(this.ctx,"fail to load server config")}})}}class iV extends iw{getConnectionStatus(){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return"undefined"==typeof navigator||void 0===navigator.onLine?B.Unknown:navigator.onLine?B.Connected:B.Disconnected})}getNetworkType(){return(0,eb.__awaiter)(this,void 0,void 0,function*(){if((yield this.getConnectionStatus())===B.Disconnected)return G.None;if("undefined"==typeof navigator||!navigator.connection||!navigator.connection.type)return G.Unknown;switch(navigator.connection.type){casenavigator.connection.effectiveType){case"2g":case"slow-2g":return G.Cellular_2G;case"3g":return G.Cellular_3G;case"4g":return G.Cellular_4G;case"5g":return G.Cellular_5G;default:return G.Unknown}case"wifi":return G.Wifi;case"o:return G.None;default:return G.Unknown}})}}var iF=C(23297),iH=C.n(iF);class iW extends eu{constructor(I){super(I),this.option=I.option}sendByBeacon(I,x){return!1}sendBeacon(I,x){setTimeout(()=>{this.sendByBeacon(I,i_(x))||this.sendRequest(eturn(0,eb.__awaiter)(this,void 0,void 0,function*(){let C=yield this.send(I,"POST",this.encode(x));return this.decode(C)})}encode(I){return i_(I).buffer}decode(I){return K.im_proto.Response.create(ip(this.ctx,I))}get headers(){return Object.assign({Accept:this.mime,"Content-Type":this.mime},this.option.httpHeaders)}get mime(){return"application/x-protobuf"}get dataType(){return"arraybuffer"}get method(){return"POST"}}class ij extends iW{constructor(I){super(I),this.instance=iH().create({timeout:this.option.timeout,withCredentials:!!this.option.withCredentials,headers:this.headers,responseType:this.dataType,method:this.method})}send(I,x,C){return(0,eb.__awaiter)(this,void 0,void 0,function*(){return(yield this.instance.request({url:I,data:C,method:x})).data})}sendByBeacon(I,x){return void 0!==navigator.sendBeacon&&navigator.sendBeacon(I,x)}}function i$(I){let x=[];for(let C of Object.keys(I))void 0!==I[C]&&""!==I[C]&&x.push(`${C}=${I[C]}`);return x.join("&")}class iq extends eu{constructor(I){super(I),this.openTime=0,this.createTime=0,this.option=I.option,this.url=this.option.frontierUrl,this.onClose=new it(I),this.onOpen=new it(I),this.onError=new it(I),this.onMessage=new it(I),this.onOpen.subscribe(()=>{var I;this.openTime=ey.performanceNow(),this.resolve(M.Monitor).emitMetrics(T.FrontierOpen,{duration:this.openTime-this.createTime},{url:null!==(I=this.url)&&void 0!==I?I:"unknown"})}),this.onClose.subscribe(I=>{var x,C,E,S;"undefined"!=typeof CloseEvent&&I instanceof CloseEvent?this.resolve(M.Monitor).emitMetrics(T.FrontierClose,{count:1},{url:null!==(x=this.url)&&void 0!==x?x:"unknown",code:null===(C=I.code)||void 0===C?void 0:C.toString(),reason:I.reason}):this.resolve(M.Monitor).emitMetrics(T.FrontierClose,{count:1},{url:null!==(E=this.url)&&void 0!==E?E:"unknown"}),0===this.openTime||Number.isNaN(this.openTime)||this.resolve(M.Monitor).emitMetrics(T.FrontierLive,{duration:ey.performanceNow()-this.openTime},{url:null!==(S=this.url)&&void 0!==S?S:"unknown"}),this.openTime=0}),this.onMessage.subscribe(I=>{var x;"hi"!==I.toString()&&this.resolve(M.Monitor).emitMetrics(T.FrontierReceive,{count:1},{url:null!==(x=this.url)&&void 0!==x?x:"unknown"})}),this.onError.subscribe(()=>{var I;this.resolve(M.Monitor).emitMetrics(T.FrontierError,{count:1},{url:null!==(I=this.url)&&void 0!==I?I:"unknown"})})}get paramUrl(){let{headers:I,authType:x,cert:C,tsSign:E}=this.option,M={};(null==I?void 0:I[Z.HF.envKey])!==void 0&&(M[Z.HF.envKey]=I[Z.HF.envKey]),(null==I?void 0:I[Z.HF.boeHeaderKey])!==void 0&&(M[Z.HF.boeHeaderKey]=I[Z.HF.boeHeaderKey]),(null==I?void 0:I[Z.HF.ppeHeaderKey])!==void 0&&(M[Z.HF.ppeHeaderKey]=I[Z.HF.ppeHeaderKey]);let S=Object.assign(Object.assign({token:this.option.disableWsUrlToken?"":this.ctx.cachedToken,sid:this.option.sessionId,aid:this.option.appId,fpid:this.option.fpId,device_id:this.option.deviceId,access_key:ef()(`${this.option.fpId+this.option.appKey+this.option.deviceId}f8a69f1719916z`),device_platform:this.option.devicePlatform,version_code:this.option.versionCode},this.option.extended),M);return K.im_proto.AuthType.CERT_AUTH===x&&(S.sdk_cert=encodeURIComponent(null!=C?C:""),S.ts_sign=encodeURIComponent(null!=E?E:"")),`${this.url}?${i$(S)}`}performOpen(){"frontier connect timeout",type:Z.NI.NetworkError,sender:this}))},this.ctx.option.timeout)}),(0,eb.tion*(){try{yield this.open()}catch(I){throw new eS({ctx:this.ctx,msg:"ws connect error",innerError:I,sender:this,type:Z.NI.NetworkError})}finally{I=!0}})])}dispose(){this.onOpen.unsubscribeAll(),this.onClose.unsubscribeAll(),this.onError.unsubscribeAll(),this.onMessage.unsubscribeAll()}}class iK extends iq{registerEvents(){this.ws.onclose=I=>{this.onClose.next(I,this)},this.ws.onopen=()=>{this.onOpen.nextEmpty(tsage.next(I.data,thior=I=>{this.onError.next(I,this)}}open(){let I,x;if(this.isOpen())return e_.ctxWarn(this.ctx,"ws already open, close first"),Promise.resolve(!0);this.ws=new WebSocket(this.paramUrl,Z.HF.wsProtocols),this.ws.binaryType="arraybuffer",this.registerEvents();let C=this.onOpen.subscribe(()=>{I(!0),this.onOpen.unsubscribe(C)}),E=this.onError.subscribe(I=>{x(I),this.onError.unsubscribe(E)});return new Promise((C,E)=>{I=C,x=E})}close(){this.ws&&(this.ws.onmessage=null,this.ws.close()),this.ws=void 0}send(I){this.ws.send(I)}isOpen(){return void 0!==this.ws&&this.ws.readyState===WebSocket.OPEN}}var iY=C(10346);!function(I){I[I.Stopped=0]="Stopped",I[I.Running=1]="Rutructor(I,x,C){return super(I),this.state=F.Stopped,this.refreshRate=0,thneDuration=C,this.onTick=new it(this.ctx),this.onDone=new it(this.ctx),this.onStop=new it(this.ctx),this}get duration(){return this.state===F.Stopped&&0!==this.lastStopTime?this.lastStopTime-this.startTime:this.state===F.Running?Date.now()-this.startTime:0}start(){this.state!==F.Running&&this.restart()}getTickTimer(){return this.tickTimer}update(){this.onTick.nextEmpty(this)}done(){this.stop(),this.onDone.nextEmpty()}}let{setIntervalWarp:iZ,clearIntervalWarp:iJ,setTimeoutWarp:iX,clearTimeoutWarp:iQ}=iY.default;class i0 extends iz{restart(){this.tickTimer&&this.stop(),this.state=F.Running;let{enableHackTimer:I}=this.ctx.option,x=I?iZ:setInterval,C=I?iX:setTimeout;this.tickTimer=x(()=>{this.update()},this.refre0!==this.doneDuration&&(this.doneTimer=C(()=>{this.done()},this.doneDuration)),this.startTime=Date.now(),this.lastStopTime=0,this.update()}stop(){iHackTimer:I}=this.ctx.option,x=I?iJ:clearInterval,C=I?iQ:clearTimeout;x(this.tickTimer),C(this.doneTimer),this.state=F.Stopped,this.lastStopTime=Date.now(),this.onStop.nextEmpty()}}let i1=I=>new iV(I),i2=I=>new ij(I),i5=I=>new iK(I);class i3 extends iG{initPlatformOptions(I){I.network=I.network||i1,I.http=I.http||i2,I.webSocket=I.webSocket||i5,I.sdkType=I.sdkType||"im-web-sdk"}createTicker(I,x,C){return new i0(I,x,C)}}var i6=C(15868),i9=C.n(i6),i4=C(76040),i8=C.n(i4),i7=C(30373),ne=C.n(i7),nt=C(49911),ni=C(32835),nn=C(10624),no=C(34287),ns=C(9631),nr=C(22855),na=C(81752),nd=C(31481),nl=C(23018),nc=C(58164),nu=C(9689);let nv="imapi-boe";var nh={disableInitPull:!1,appId:6383,userId:"",deviceId:"",boe:!0,debug:!0,apiUrl:`http://${nv}.douyin.com`,frontierUrl:"ws://frontier-boe.douyin.com/ws/v2",token:"",authType:K.im_proto.AuthType.SESSION_AUTH,devicePlatform:"douyin_pc",appKey:"e1bd,inboxType:0,timeout:6e3,acceptIncorrectInboxType:!0,biz:"douyin_web",disablePullIntervalWhenWsIsOnline:!0,triggerPullWhenReceiveEmptyContent:!0},n_=C(84177);class np extends tV{async process(I){var x;let C=null==I?void 0:null===(x=I.data)||void 0===x?void 0:x.type;return(0,n_.FH)(C)&&(I.needContinue=!1,I.data=null),I}}var ng=C(62994);class nf extends eG{install(){}async sendPacket(I){return this.fillTtWidParam(I),I}fillTtWidParam(I){let x={};try{let I=(0,ng.getSharkCommonParams)({});x.deviceId="0",x.session_did="0",x.webid=I.webid,x.fp=I.fp}catch(I){}I.device_id="0",I.headers=(0,W._)({},I.headers,x)}}var nm=C(22918),ny=C(41614),nI=C(82388),nx=C(36915),nC=C(44001),nE=C(38879),nM=C(14023),nb=C(31545),nS=C(55221),nTC.p)(S);T.personal_relation=String(I)}return T};function nA(I,x){if(x.has(I))thrror("Cannot initialize the same private elements")}function nN(I,x){return x.get?x.get.call(I):x.value}function nP(I,x,C){if(!x.has(I))throw TypeError("attempted to "+C+" private field on non-instance");returnull==I||I(x)})}constructor(){nD(this,nU,{writable:!0,value:[]})}}var nG=C(6414),nV=C(12788);let nF=()=>{let{host:I}=location;return/live.douyin.com/.test(I)};var nH=C(15138);function nW(I,x,C){return x in I?Object.defineProperty(I,x,{value:C,enumerable:!0,configurable:!0,writable:!0}):I[x]=C,I}function nj(I,x,C){return n$(I,x),C}function n$(I,x){if(I!==x)throw TypeError("Private static access of wrong provenance")}let nq=/(https?:\/\/[A-Z0-9+&@#\/%?=~_|!:,.;]+)/i,nK=/http[s]?:\/\/live\.douyin\.com\/[\w\d]+/gi,{ConversationType:nY}=K.im_proto,{GROUP_CHAT:nz,ONE_TO_ONE_CHAT:nZ}=nY,nJ=new nu.Z;var nX={IM_SEND_MSG:"IM_SEND_MSG",IM_DELETE_CONVERSATION:"IM_DELETE_CONVERSATION",IM_VIDEO_MSG_RECALLED:"IM_VIDEO_MSG_RECALLED"};let nQ={event(I,x){var C,E;null===(C=(E=window).collectEvent)||void 0===C||C.call(E,I,x)}},n0={disableInitPull:!1,appId:6383,appKey:"e1bd35ec9db7b8d846de66ed140b1ad9",userId:"",deviceId:"",service:5,debug:!!(0,nn.$o)(nd.LocalStorageKeys.ImOptionDebug),apiUrl:"https://imapi.douyin.com",frontierUrl:"wss://frontier-im.douyin.com/ws/v2",authType:K.im_proto.AuthType.SESSION_AUTH,token:"",fpId:9,withCredentials:!0,inboxType:1,devicePlatform:"douyin_pc",timeout:6e3,acceptIncorrectInboxType:!0,sharkAppName:"douyin_pc",sharkPriorityRegion:"cn",biz:"douyin_web",monitor:[...no.oe.getSlardarInstance()?[new em(no.oe.getSlardarInstance())]:[],new eM(nQ,{metricsToReport:[...eC,ex(T.BizSdkInit+T.SuccessSuffix)]})],ppe:null!==(H=(0,nn.$o)(nd.LocalStorageKeys.ImOptionPPE))&&void 0!==H?H:void 0,webSocketLevel:(0,nn.$o)(nd.LocalStorageKeys.ImOptionDisableWS)?Z._.Disable:Z._.PushOnly,useBadgeCountForUnread:!0,unreadCountReport:!0,disablePullIntervalWhenWsIsOnline:!0,triggerPullWhenReceiveEmptyContent:!0},n1=[tY,tX,tQ,nf,t0,t5];class n2{static tryStart(I,x,C){nG.Z.warn("登录用户信息",x);let{uid:E}=x||{},{bytedIMInstance:M}=n2;return nb.default.setIsLogin(I),I?M||n2.init({userId:E,deviceId:E,pullInterval:C.pullIntervarguments.length>1&&void 0!==arguments[1]&&arguments[1],C=x?(0,W._)({},nh,I):(0,W._)({},n0,I);nG.Z.warn("IM 初始化参数",C),nF()||(C.authType=K.im_proto.AuthType.PASSPORT_CERT_AUTH,C.securityScene="web_protect",C.securityCertType="cookie",n1.push(t8));let E=new i3(C,n1);n2.bytedIMInstance=E,E.resolve(M.MessageManager).processors.unshift(new np(E.ctx)),E.init().then(()=>{n2.getStrangerConversationPreview(),n2.getAllUserConversation(!0)}),nG.Z.warn("IM 实例",E),n2.listenEvents(),nb.defGifListAsync();ult.getRecentEmojiAsync(),nb.default.getRecentGifAsync(),nb.default.getInteractiveEmojiListAsync()),nb.default.getUserSpotlightRelationAsync(),E}static destroy(){var I;n2.imEvents(),null===(I=n2.bytedIMInstance)||void 0===I||I.dispose(),n2.bytedIMInstance=null}static onEvent(I,x){return nJ.on(I,x)}static emitEvent(I){for(var x=arguments.length,C=Array(x>1?x-1:0),E=1;E<x;E++)C[E-1]=arguments[E];nJ.emit(I,...C)}static offEvent(I,x){nJ.off(I,x)}static checkAndReportReadIndexGreater(I){for(let x of I){let I=x.readIndex,C=x.lastMessageIndex;if(I&&(null==C?void 0:C.greaterThan(0))&&I.sub(C).greaterThanOrEqual(1e4)){let{shortId:E}=x;if(n2.reportedReadIndexGreater.has(E))continue;(0,nS.Gb)("imsdk_debug_read_index_greater",{conversation_type:x.type,index_distance:I.sub(C).toNumber(),conversation_id:x.id,conversation_short_id:E,conversation_read_index:I.toString(),message_index_in_conversation:C.toString(),user_id:x.ctx.option.userId,debug_version:"2"}),n2.reportedReadIndexGreater.add(E)}}}static updateIsStrangerConver(){var I;let{id:x}=(null===nb.default||void 0===nb.default?void 0:nb.default.curConversation)||{},C=null===nb.default||void 0===nb.default?void 0:null===(I=nb.default.conversationMap)||void 0===I?void 0:I[x],E=null==C?void 0:C.isStra(E)}static setCurConversation(){let I=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(nb.default.setCurConverSation(I),I){let{isStrangerConversation:I=!1}=nb.default;I?n2.strangerMessageUpsert():n2.messageUpsert()}else nb.default.setCurMessageList([])}static listenEvents(){let{bytedIMInstance:I}=n2;if(!I)return;let x=null==I?void 0:I.event,C=x.subscribe(Z.c5.ConversationChange,()=>{n2.conversationChange(),n2.unreadCountReport()}),E=x.subscribe(Z.c5.MessageUpsert,I=>{if(I){let{type:x}=I;if(x===nI.pp.GROUP_NOTICE_MESSAGE){let{curConversation:I}=nb.default;I&&n2.getMoreParticipants({conversation:I})}}n2.messageU5.ReceiveNewMessage,I=>{nG.Z.warn("ReceiveNewMessage",I),nb.default.pushNewMsgInList(I,I=>n2.getConversationById(I)),this.syncToTray()}),S=x.subscribe(Z.c5.MessageRecall,I=>{nG.Z.warn("MessageRecall",I);let{curConversation:x}=nb.default,{conversationId:C,type:E}=I;(null==x?void 0:x.id)===C&&(null===nI.ds||void 0===nI.ds?void 0:nI.ds.includes(E))&&n2.emitEvent("IM_VIDEO_MSG_RECALLED",I)}),T=x.subscribe(Z.c5.InitFinish,()=>{n2.checkClientPush()});n2.imEvents=()=>{x.unsubscribe(Z.c5.MessageUpsert,E),x.unsubscribe(Z.c5.ConversationChange,C),x.unsubscribe(Z.c5.ReceiveNewMessage,M),x.unsubscribe(Z.c5.InitFinish,T),x.unsubscribe(Z.c5.MessageRecall,S)}}static syncToTray(){(0,ns.DT)()&&ne().app.isTopWebview().then(I=>{var x;I.data&&nt.a.setImConvUnreadData({message:((null===(x=nb.default.conversationListFilter)||void 0===x?void 0:x.slice())||[]).map(I=>{var x;let C=I;if(!C.unreadCount||C.isMuted||!C.lastMessage)return nul=(0,nV.v)(C);return{conversation_name:E.title,unread_count:C.unreadCount,conversation_id:C.shortId,last_message_time:C.lastMessage.createdAt?Number(C.lastMessage.createdAt):0,last_message_id:C.lastMessage.serverId,avatar_url:null!==(x=Array.isArray(E.headIcon)?E.headIcon[0]:E.headIcon)&&void 0!==xype:C.type,open_url:`sslocal://chat/center?conv_short_id=${C.shortId}&conversation_id=${C.id}`,is_stick_on_top:C.isStickOnTop}}).filter(I=>!!I)})})}static setConversationSettingInfo(I,x){let{bytedIMInstance:C}=n2;null==C||C.setConversationSettingInfo((0,W._)({conversation:I},x))}static async handleDeleteConversation(I){let x=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,C=arguments.length>2&&void 0!==arguments[2]?arguments[2]:()=>{};n2.emitEvent("IM_DELETE_CONVERSATION",I),x&&await (0,nM.Z)(x),null==C||C()}static deleteConversation(I){if(!I)return;let{bytedIMInstance:x}=n2;null==x||x.deleteConversation({conversation:I}),null===nb.default||void 0===nb.default||nb.default.setCurConverSation()}static async deleteStrangerConversation(I,x){if(!I)return;let{bytedIMInstance:C}=n2,[E,M]=await (0,nE.F)(null==C?void 0:C.deleteStrangerConversation({conversation:I}));E||(null==x||x(),null===nb.default||void 0===nb.default||nb.default.setCurConverSation())}static deleteAllStrangerConversation(){let{bytedIMInstance:I}=n2;null==I||I.deleteAllStrangerConversation(),null===nb.default||void 0===nb.default||nb.default.setCurConverSation(),null===nb.default||void 0===nb.default||nb.default.setIsInStrangerConversationList(!1)}static async getConversationWithUid(I){if(!I)return;let{bytedIMInstance:x}=n2;if(!x)return;let C=x.getConversationList(),E={};i8()(C,I=>{let{id:x,type:C,toParticipantUserId:M}=I;C===nZ&&M&&(E[M]=I)});let M=null==E?void 0:E[I];if(!M){var S;let[C,E]=await (0,nE.F)(x.createConversation({type:nZ,participants:I,inboxType:0}));if(C)return;let{statusCode:T,body:R}=E,w=null==R?void 0:null===(S=R.conversation)||void 0===S?void 0:S.conversation_id;0===T&&w&&(M=x.getConversation({conversationId:w}))}return M}static async getAllUserConversation(){let I=arguments.length>0&&void 0!==arguments[0]&&arguments[0],{hasJoinGroupObj:x}=nb.default,C=x;if(C.loading)return;if(I){let I={conversation:[],cursor:"0",hasMore:!0,loading:!1};nb.default.setHasJoinGroup(I),C=I}nb.default.setHasJoinGroup((0,q._)((0,W._)({},C),{loading:!0}));let{cursor:E,hasMore:M}=C;if(M){var S;let{bytedIMInstance:I}=n2,[x,M]=await (0,nE.F)(null==I?void 0:I.getUserConversationList({type:nz,inboxType:0,limit:10,sortType:1,cursor:E}));if(nG.Z.warn("getAllUserConversation",x,M),x){nb.default.setHasJoinGroup((0,q._)((0,W._)({},C),{loading:!1}));return}let{conversation:T,cursor:R,hasMore:w}=M||{},O=null===(S=C.conversation)||void 0===S?void 0:S.concat(T);nb.default.setHasJoinGroup({conversation:O,cursor:z().fromValue(R).toString(tatic async sendMessage(I,x){let{bytedIMInstance:C}=n2,E=null===nb.default||void 0===nb.default?void 0:nb.default.curConversation;if(!C||!E)return;let[M,S]=await (0,nE.F)(nj(n2,n2,n9).call(n2,E,I));return await nj(this,n2,n6).call(n2,S,x),S}static resendMessage(I,x){return nj(this,n2,n6).call(n2,I,x)}static getConversationById(I){var x,C,E;let{bytedIMInstance:M}=n2,S=null;try{S=null===(x=M.getConversationList({filter:x=>x.id===I||x.shortId===I}))||void 0===x?void 0:x[0]}catch(x){no.oe.captureException("IM",x,{conversationId:I,userId:M.option.userId,conversationCount:String(null===(C=null!==(E=M.getConversationList())&&void 0!==E?E:[])||void 0===C?void 0:C.length)})}return S}static async sendUserMsg(I,x,C){let E=null==I?void 0:I.length;if(!E)return;let{bytedIMInstance:M}=n2,S=M.getConversationList(),T={};i8()(S,I=>{let{id:x,type:C,toParticipantUserId:E}=I;C===nZ&&E&&(T[E]=I)});let R=new nB,w=new nB;for(let S=0;S<E;S++){let E=I[S],A=null==T?void 0:T[E];if(!A&&E){var O;let[I,x]=await (0,nE.F)(M.createConversation({type:nZ,participants:E,inboxType:0}));if(I)continue;let{statusCode:C,body:S}=x,T=null==S?void 0:null===(O=S.conversation)||void 0===O?void 0:O.conversation_id;0===C&&T&&(A=M.getConversation({conversationId:T}))}if(A){let[I,E]=await (0,nE.F)(nj(n2,n2,n9).call(n2,A,x));if(!E)continue;let M=R.add(),S=function(){for(var I=arguments.length,x=Array(I),C=0;C<I;C++)x[C]=arguments[C];M(x)},T=w.add(),O=function(){for(var I=arguments.length,x=Array(I),C=0;C<I;C++)x[C]=arguments[C];T(x)};await nj(this,n2,n6).call(n2,E,(0,q._)((0,W._)({},C),{beforeSend:S,afterSend:O}))}}R.run(null==C?void 0:C.beforeSend),w.run(null==C?void 0:C.afterSend)}static async sendGroupMsg(I,x,C){let E=null==I?void 0:I.length;if(!E)return;let M=null===nb.default||void 0===nb.default?void 0:nb.default.conversationInfoMap,S=new nB,T=new nB,{bytedIMInstance:R}=n2;for(let w=0;w<E;w++){let E=I[w],O=null==M?void 0:M[E];if(!O){let I={conversationId:E,shortId:E,type:nz},[x,C]=await (0,nE.F)(R.getConversationOnline(I));!x&&C&&(O=C)}if(O){let[I,E]=await (0,nE.F)(nj(n2,n2,n9).call(n2,O,x));if(E){let I=S.add(),x=function(){for(var x=arguments.length,C=Array(x),E=0;E<x;E++)C[E]=arguments[E];I(C)},M=T.add(),R=function(){for(var I=arguments.length,x=Array(I),C=0;C<I;C++)x[C]=arguments[C];M(x)};await nj(this,n2,n6).call(n2,E,(0,q._)((0,W._)({},C),{beforeSend:x,afterSend:R}))}}}S.run(null==C?void 0:C.beforeSend),T.run(null==C?void 0:C.afterSend)}static async getIdConverMap(I){let{bytedIMInstance:x}=n2,C=x.getConversationList(),E={},M={};i8()(C,I=>{let{id:x,type:C,toParticipantUserId:S}=I;C===nZ&&S?E[S]=I:C===nz&&(M[x]=I)});let S=I.length;for(let C=0;C<S;C++){let{uid:M,type:S}=I[C];if(S===nZ&&M&&!E[M]){var T;let[I,C]=await (0,nE.F)(x.createConversation({type:nZ,participants:M,inboxType:0}));if(I)continue;let{statusCode:S,body:R}=C,w=null==R?void 0:null===(T=R.conversation)||void 0===T?void 0:T.conversation_id;0===S&&w&&(E[M]=x.getConversation({conversationId:w}))}}return{converPrevOne2OneMap:E,converPrevGroupMap:M}}static async sendUserAndGroupMsg(I,x,C){let E=null==I?void 0:I.length;if(!E)return;let[M,S]=await (0,nE.F)(n2.getIdConverMap(I));if(M)return;let{converPrevOne2OneMap:T,converPrevGroupMap:R}=S,w=new nB,O=new nB;for(let M=0;M<E;M++){let{uid:E,type:S}=I[M],A=S===nZ?T[E]:R[E];if(A){let[I,E]=await (0,nE.F)(nj(n2,n2,n9).call(n2,A,x));if(!E)continue;let M=w.add(),S=function(){for(var I=arguments.length,x=Array(I),C=0;C<I;C++)x[C]=arguments[C];M(x)},T=O.add(),R=function(){for(var I=arguments.length,x=Array(I),C=0;C<I;C++)x[C]=arguments[C];T(x)};await nj(this,n2,n6).call(n2,E,(0,q._)((0,W._)({},C),{beforeSend:S,afterSend:R}))}}w.run(null==C?void 0:C.beforeSend),O.run(null==C?void 0:C.afterSend)}static async recallMessage(I){let{bytedIMInstance:x}=n2;return null==x?void 0:x.recallMessage({message:I})}static deleteMessage(I){let{bytedIMInstance:x}=n2;return null==x?void 0:x.deleteMessage({message:I})}static async setLikeMsg(I,urn E.action=C?"cancel":"like",(0,nS.Gb)("like_message",E),nj(this,n2,n4).call(n2,I,(0,W._)((0,q._)((0,W._)({},ny.r9.LOVE),{operation:K.im_proto.OPERATION_TYPE.ADD_PROPERTY_ITEM}),x))}static getMoreMessage(I){let x=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50,{bytedIMInstance:C}=n2,{messageList:E}=nb.default,M=null==E?void 0:E[0];return M?C.getMessagesByConversation({conversation:I,cursor:M,lithen(I=>(n2.messageUpsert(),I)):Promise.resolve({messages:[],hasMore:!1,cursor:0})}static getConversationParticipants(I){let{bytedIMInstanc,C=x.getConversationParticipants({conversation:I});return nj(this,n2,n8).call(n2,null==I?void 0:I.id,C,!0),C}static getMoreParticipants(I){let{bytedIMInstance:x}=n2;return Promise.all([x.getConversationParticipantsAsync((0,W._)({},I)),x.getConversationBots({conversation:I.conversation}).catch(I=>null)]).then(x=>{var C;let[E,M]=x,S=[...E,...M];return nj(this,n2,n8).call(n2,null===(C=I.conversation)||void 0===C?void 0:C.id,S,!0),S}).catch(()=>[])}static async leaveConversation(I){let{bytedIMInstance:x}=n2;await x.leaveConversation({conversation:I}),await x.deleteConversation({conversation:I}),null===nb.default||void 0===nb.default||nb.default.setCurConverSation()}static async dissolveConversation(I){let{bytedIMInstance:x}=n2;await x.dissolveConversation({conversation:I}),await x.deleteConversation({conversation:I}),null===nb.default||void 0===nb.default||nb.default.setCurConverSation()}static getAllUserFromServer(){let I=nj(this,n2,n7).call(n2);return nb.default.getUserInfoMapAsync(I)}static getAllStrangerFromServer(){let I=nj(this,n2,oe).call(n2);return nb.default.getUserInfoMapAsync(I)}static getStrangerFromServerWithConver(I){let{userInfoFromServerMap:x,curUserInfo:C}=nb.default,E=C.uid,{id:M="",firstPageParticipant:S=[],participants:T}=I||{},R=null==x?void 0:x[M],w=T||(null==S?void 0:S.participants)||[];if(nj(this,n2,n8).call(n2,M,w,!0),!R){let I=[];w.forEach(x=>{let{userId:C,secUid:M,user_id:S,sec_uid:T}=x;(C||z().fromValue(S).toString())!==E&&I.push(M||T)}),nb.default.getUserInfoMapAsync(I)}}static async markConversationRead(I){let x=arguments.length>1&&void 0!==arguments[1]&&arguments[1],C=arguments.length>2&&void 0!==arguments[2]&&arguments[2],{indexInConversation:E="",conversationId:M}=I||{},{bytedIMInstance:S}=n2,T=null;try{T=S.getConversation({conversationId:M})}catch(I){return}if(T){if(C)return T.settingInfo._readIndex=z().ZERO,S.markConversationRead({conversation:T});if(E&&T){if(x)S.markStrangerConversationRead({conversation:T});else{var R;(null===(R=T.lastMessageIndex)||void 0===R?void 0:R.eq(E))?S.markConversationRead({conversation:T,force:!0}):S.markConversationRead({conversation:T,readIndex:E})}}}}static async markAllStrangerConversationRead(){let{bytedIMInstance:I}=n2;return I.markAllStrangerConversationRead()}static async getMessgeByServerId(I){let{conversation:x,serverMessageId:C}=I,{bytedIMInstance:E}=n2;return E.getMessageByServerId({conversation:x,serverMessageId:C})}static checkClientPush(){let{conversationId:I,userId:x,enterMethod:C}=nr.Le.getConfig(nr.gI.IMStatusStore)||{};I&&na.emit(na.EVENT.openImConversation,{conversationId:I,enterMethod:C||nx.eY.CLIENT_PUSH}),x&&na.emit(na.EVENT.sendImUserMsg,{uid:x,enterMethod:C||nx.eY.CLIENT_PUSH}),I||x||!C||na.emit(na.EVENT.openImConversation,{enterMethod:C||nx.eY.CLIENT_PUSH})}static async isFromGroupOwner(I){if(!I)return!1;let{bytedIMInstance:x}=n2,{conversationId:C,sender:E}=I;if(!E)return!1;let M=x.getConversation({conversationId:C});if(!M)return!1;let{type:S,coreInfo:T}=M;return S===nz&&(null==T?void 0:T.owner)===E}static async getMoreVideoInMsg(){let{curConversation:I}=nb.default;(null===nb.default||void 0===nb.default?void 0:nb.default.curMsgOptPopId)&&nb.default.setCurMsgOptPopId();let x=[],C=[];if(I){let[E,M]=await (0,nE.F)(n2.getMoreMessage(I));if(E)return{hasMore:!0,awemeIds:x,videoMsgList:C};let{hasMore:S=!0,messages:T=[]}=M||{};return i8()(T,I=>{let{type:E,isRecalled:M,clientId:S}=I;if(!M&&(null===nI.ds||void 0===nI.ds?void 0:nI.ds.includes(E))){let{itemId:E,item_id:M}=(0,n_.t$)(I)||{},T=null!=E?E:M;T&&(x.push(T),C.push({awemeId:T,msgClientId:S}))}}),{hasMore:S,awemeIds:x,videoMsgList:C}}return{hasMore:!0,awemeIds:x,videoMsgList:C}}static upsertConversationSettingExtInfo(I,x){let{bytedIMInstance:C}=n2;null==C||C.upsertConversationSettingExtInfo((0,W._)({conversation:I},x))}}async function n5(I,x,C){var E,M,S;let T=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",{conversationId:R,conversationType:w,referenceInfo:O,mentionedUsers:A,type:N}=x,{isOpenMessageList:P}=nb.default;if(!I)return;let{toParticipantUserId:L}=I,D=w===nZ?await (0,nC.p)(L):nx.$u.FollowRelationUnknown;if(O){let I={conversation_id:R,chat_type:nT.n0[w],message_type:C};w===nZ&&(I.personal_relation=String(D)),(0,nS.Gb)("quote_message",I)}A&&A.length>0&&A.forEach(I=>{var x;let C=nb.default.userInfoFromServerMap[I];(0,nS.Gb)("send_at_message",{conversation_id:R,at_user_id:I,at_type:(null==C?void 0:null===(x=C.im_role_ids)||void 0===x?void 0:x.includes(nH.L.AiChatBotRole))?"ai_role":"user",at_ai_name:null==C?void 0:C.nickname})});let U={conversation_id:R,chat_type:nT.n0[w],to_user_id:L||"",message_type:C,real_message_type:N,enter_method:nT.QX[T],online_status:null===(E=nc.m.statusStore[nb.default.uidSecUidMap[L]])||void 0===E?void 0:E.lastActiveLogValue};U.is_fold=Number(!P),w===nZ&&(U.personal_relation=String(D),(null===(S=nb.default.userInfoFromServerMap[L])||void 0===S?void 0:null===(M=S.im_role_ids)||void 0===M?void 0:M.includes(nH.L.AiChatBotRole))&&(U.chat_type="ai_role")),(0,nS.Gb)("send_message",U);let{text:B=""}=(0,n_.t$)(x);if(nq.test(B)){let I=nK.test(B);(0,nS.Gb)("send_link",{enter_from:nT.QX[T],chat_type:nT.n0[w],conversation_id:R,to_user_id:L||"",link_type:I?"live_share_link":"other"})}}function n3(I,x,C,E){var M,S;let T=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"",{conversationId:R,conversationType:w,type:O,serverId:A,mentionedUsers:N}=x;if(!I||!E)return;let{toParticipantUserId:P}=I,{statusCode:L,success:D}=E;N&&N.length>0&&N.forEach(I=>{var x;let C=nb.default.userInfoFromServerMap[I];(0,nS.Gb)("send_at_message_response",{conversation_id:R,at_user_id:I,at_type:(null==C?void 0:null===(x=C.im_role_ids)||void 0===x?void 0:x.includes(nH.L.AiChatBotRole))?"ai_role":"user",at_ai_name:null==C?void 0:C.nickname})});let U=w===nZ&&(null===(S=nb.default.userInfoFromServerMap[P])||void 0===S?void 0:null===(M=S.im_role_ids)||void 0===M?void 0:M.includes(nH.L.AiChatBotRole));(0,nS.Gb)("send_message_response",{conversation_id:R,chat_type:U?"ai_role":nT.n0[w],to_user_id:P||"",message_type:C,real_message_type:O,send_status:D?"success":"failure",status_code:`${L}`,messgae_id:A||"",enter_method:nT.Qction n6(I,x){let{beforeSend:C=()=>{},afterSend:E=()=>{},enter_method:M="",retrying:S=!1}=x;if(I){let{conversationId:x}=I,{bytedIMInstance:T}=n2,R=T.getConversation({conversationId:x}),w=(0,nT.GM)(I);nj(n2,n2,n5).call(n2,R,I,w,M),null==C||C(I);let O=await T.sendMessage({message:I});if(S)return O;if(3===O.body.status)try{let x=JSON.parse(O.checkMsg);if(7396===x.status_code){nm.F.info("行为存在异常，需要完成二次验证");try{await (0,ni.d)({request(){return null}},{headers:{"x-vc-bdturing-parameters":btoa(x.decision_conf)},config:{url:""}}),O=await n2.resendMessage(I,{enter_method:M,retrying:!0})}catch(I){}}}catch(I){}return n2.emitEvent("IM_SEND_MSG",{message:I,res:O}),nj(this,n2,n3).call(n2,R,I,w,O,M),null==E||E({conversation:R,message:I,res:O}),O}}function n9(I,x){let{bytedIMInstance:C}=n2,E=(0,n_.MZ)(x);return null==C?void 0:C.createMessage((0,W._)({conversation:I},E))}function n4(I,x){let{bytedIMInstance:C}=n2;return null==C?void 0:C.modifyMessageProperty({message:I,modifyContent:[x]})}function n8(I){let x=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],C=arguments.length>2&&void 0!==arguments[2]&&arguments[2],{curUserInfo:E}=nb.default,M=E.uid,S=[];i8()(x,x=>{let{userId:C,role:E,secUid:T,user_id:R,sec_uid:w,alias:O=""}=x,A=C||z().fromValue(R).toString();A!==M&&S.push(A),A&&nb.default.setUserInfoFromSdkMap(I,A,{alias:O,uid:A,role:E,sec_uid:T||w})}),nb.default.setConversationUserids(I,S,C)}function n7(){let{converSationListOrigin:I,uidSecUidMap:x,userInfoFromSdkMap:C,userInfoFromServerMap:E}=nb.default;i8()(I,I=>{let{id:x,type:E,toParticipantUserId:M,firstPageParticipant:S,participants:T}=I;null==C||C[x],nj(this,n2,n8).call(n2,x,T||(null==S?void 0:S.participants),!1)});let M=[];return i8()(x,(I,x)=>{let C=E[x];I&&!C&&M.push(I)}),M}function oe(){let{strangerConverListObj:I,uidSecUidMap:x,userInfoFromSdkMap:C,userInfoFromServerMap:E}=nb.default,M=(null==I?void 0:I.conversation)||[],S=[];return i8()(M,I=>{let{id:x="",firstPageParticipant:E=[],participants:M}=I;null==C||C[x],nj(this,n2,n8).call(n2,x,M||(null==E?void 0:E.participants),!0)}),i8()(x,(I,x)=>{let C=E[x];I&&!C&&S.push(I)}),S}nW(n2,"bytedIMInstance",null),nW(n2,"imEvents",()=>{}),nW(n2,"conversationChange",i9()(()=>{var I,x;let C=null!==(x=null===(I=n2.bytedIMInstance)||void 0===I?void 0:I.getConversationList())&&void 0!==x?x:[];return nb.default.setConverSationList(C),nb.default.setConversationMap(C),n2.checkAndReportReadIndexGreater(C),Promise.all([n2.getAllUserFromServer(),n2.getStrangerConversationPreview()]).then(()=>{n2.syncToTray()}),n2.updateIsStrangerConver(),C},200)),nW(n2,"reportedReadIndexGreater",new Set),nW(n2,"messageUpsert",i9()(()=>{var I;let x=null===nb.default||void 0===nb.default?void 0:nb.default.curConversation,C=null!==(I=null==x?void 0:x.getMessageList())&&void 0!==I?I:[];nb.default.setCurMessageList(C),nG.Z.warn("messageUpsert",C)},200)),nW(n2,"strangerMessageUpsert",i9()(async()=>{var I;let x=null===nb.default||void 0===nb.default?void 0:nb.default.curConversation;null===(I=n2.bytedIMInstance)||void 0===I||I.getStrangerConversationMessage({conversation:x}).then(I=>{nb.default.setCurMessageList(null!=I?I:[])})},200)),nW(n2,"getStrangerConversationList",async function(){var I,x;let C=arguments.length>0&&void 0!==arguments[0]&&arguments[0],{strangerConverListObj:E,setIsShowGetConversaionListLoading:M}=nb.default;M(!0);let S=E;if(null==S?void 0:S.loading)return;nb.default.setStrangerConverListObj((0,q._)((0,W._)({},S),{loading:!0})),C&&(S={conversation:[],cursor:"0",hasMore:!0,loading:!1,unreadCount:0});let{cursor:T="0",hasMore:R=!0}=S;if(!R){nb.default.setStrangerConverListObj((0,q._)((0,W._)({},S),{loading:!1}));return}let[w,O]=await (0,nE.F)(null===(I=n2.bytedIMInstance)||void 0===I?void 0:I.getStrangerConversationList({limit:10,cursor:T}));w&&nb.default.setStrangerConverListObj((0,q._)((0,W._)({},S),{loading:!1}));let{conversation:A,cursor:N,hasMore:P,unreadCount:L}=O||{},D=(null==S?void 0:null===(x=S.conversation)||void 0===x?void 0:x.concat(A))||[];nb.default.setStrangerConverListObj({conversation:D,cursor:z().fromValue(N).toString(),hasMore:P,unreadCount:L,loading:!1}),M(!1),nb.default.setConversationMap(D),n2.getAllStrangerFromServer(),n2.updateIsStrangerConver()}),nW(n2,"getStrangerConversationPreview",i9()(()=>{var I;return null===(I=n2.bytedIMInstance)||void 0===I?void 0:I.getStrangerPreview({}).then(I=>{if(nG.Z.warn("new-preview",I),I){let{conversation:x={},unreadCoungetStrangerFromServerWithConver(x),nb.default.setStrangerMessageUnreadCount(C),nb.default.setStrangerBoxCover(x)}else nb.default.setStrangerBoxCover(null),nb.default.setStrangerMessageUnreadCount(0)})},200)),nW(n2,"unreadCountReport",i9()(()=>{let{bytedIMInstance:I}=n2;null==I||I.unreadCountReport()},200))},14023:function(I,x,C){"use strict";C(3156);let E=function(){let I=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return new Promise(x=>{setTimeout(()=>{x(!0)},I||0)})};x.Z=E},34162:function(I,x,C){"use strict";C.d(x,{GM:function(){return L},QX:function(){return U},iL:function(){return P},n0:function(){return D}});var E=C(73217),M=C(91865),S=C(82388),T=C(84177),R=C(20881);let{ConversationType:w}=E.im_proto,{GROUP_CHAT:O,ONE_TO_ONE_CHAT:A}=w,N={chat_notif_show:{eventName:"chat_notif_show",params:{}},chat_notif_hover:{eventName:"chat_notif_hover",params:{}},uc_login_notify:{eventName:"uc_login_notify",params:{}},uc_login_submit:{eventName:"uc_login_submit",params:{}},uc_login_result:{eventName:"uc_login_result",params:{}},chat_cell_show:{eventName:"chat_cell_show",params:{}},chat_cell_click:{eventName:"chat_cell_click",params:{}},enter_chat:{eventName:"enter_chat",params:{}},click_enter_chat_page:{eventName:"click_enter_chat_page",params:{}},chat_setting_show:{eventName:"chat_setting_show",params:{}},chat_setting_click:{eventName:"chat_setting_click",params:{}},chat_block_popup_show:{eventName:"chat_block_popup_show",params:{}},chat_block_popup_click:{eventName:"chat_block_popup_click",params:{}},send_message:{eventName:"send_message",params:{}},send_message_response:{eventName:"send_message_response",params:{}},follow:{eventName:"follow",params:{}},follow_cancel:{eventName:"follow_cancel",params:{}},emoji_tab_show:{eventName:"emoji_tab_show",params:{}},at_panel_show:{eventName:"at_panel_show",params:{}},send_at_message:{eventName:"send_at_message",params:{}},send_at_message_response:{eventName:"send_at_message_response",params:{}},message_function_show:{eventName:"message_function_show",params:{}},message_function_click:{eventName:"message_function_click",params:{}},like_message:{eventName:"like_message",params:{}},forward_message:{eventName:"forward_message",params:{}},quote_message:{eventName:"quote_message",params:{}},recall_message:{eventName:"recall_message",params:{}},delete_message:{eventName:"delete_message",params:{}},unsupported_message_show:{eventName:"unsupported_message_show",params:{}},video_cover_show:{eventName:"video_cover_show",params:{}},video_cover_click:{eventName:"video_cover_click",params:{}},click_comment_button:{eventName:"click_comment_button",params:{}},share_menu_show:{eventName:"share_menu_show",params:{}},share_video_click_head:{eventName:"share_video_click_head",params:{}},share_video_click_more_friend:{eventName:"share_video_click_more_friend",params:{}},share_video:{eventName:"share_video",params:{}},share_user:{eventName:"share_user",params:{}},share_comment:{eventName:"share_comment",params:{}},share_search:{eventName:"share_search",params:{enter_from:"others_homepage"}},click_send_message:{eventName:"click_send_message",params:{}},im_push_show:{eventName:"im_push_show",params:{}},im_push_click:{eventName:"im_push_click",params:{}},im_push_close:{eventName:"im_push_close",params:{}},im_login_notify:{eventName:"im_login_notify",params:{}},new_im_show:{eventName:"new_im_show",params:{}},share_video_click_more_group:{eventName:"share_video_click_more_group",params:{}},unknown_notif_show:{eventName:"unknown_notif_show",params:{}},unknown_notif_click:{eventName:"unknown_notif_click",params:{}},unknown_notif_hover:{eventName:"unknown_notif_hover",params:{}},unknown_notif_delete:{eventName:"unknown_notif_delete",params:{}},unknown_cell_show:{eventName:"unknown_cell_show",params:{}},chat_cell_click_all:{eventName:"chat_cell_click_all",params:{}},click_author_head:{eventName:"click_author_head",params:{click_from:"im",is_full_webscreen:"0",clarity:""}},click_fold_im:{eventName:"click_fold_im",params:{}},click_exit_chat:{eventName:"click_exit_chat",params:{}},imsdk_debug_read_index_greater:{eventName:"imsdk_debug_read_index_greater",params:{}},im_customer_group_notify:{eventName:"im_customer_group_notify",params:{}},im_customer_notify:{eventName:"im_customer_notify",params:{}},im_customer_click:{eventName:"im_customer_click",params:{action:"1"}},livesdk_share_success:{eventName:"livesdk_share_success",params:{share_from:"",share_type:"message",user_id:"",anchor_id:"",room_id:"",enter_from_merge:"",enter_method:"",action_type:"",request_id:""}},send_link:{eventName:"send_link",params:{enter_from:"",chat_type:"private",conversation_id:"",to_user_id:"",link_type:""}}},P=new M.hD(N),L=I=>{let{type:x,ext:C}=I,E=(0,T.t$)(I),M=null==E?void 0:E.type,w="";switch(x){case S.pp.TEXT:w="text";break;case S.pp.SHARE_WEB:0!==(null==E?void 0:E.aweType)&&(w=(null==E?void 0:E.msgTrack)||"");break;case S.pp.SHARE_WEB_FROM_THIRD_MESSAGE:w="share_from_third";break;case S.pp.XPLAN_STICKER_EMOJI:w=M===S.c6.AWEME_XEMOJI?"xmoji":"emoji";break;case S.pp.BIG_EMOJI:w=M===S.c6.AWEME_EMOJI_SELF?"emoji":M===S.c6.AWEME_NET_SEARCH_GIF?"giphy":M===S.c6.AWEME_GREET_EMOJI?"emoji":M===S.c6.AWEME_LITE_MSG_EMOJI?"lite_emoji":M===S.c6.AWEME_LITE_MSG_EMOJI_NEW?"lite_emoji":M===S.c6.AWEME_INTERACTIVE_EMOJI?"lite_emoji":"emoji";break;case S.pp.ONE_CARD:M===S.c6.GROUP_VOTE&&(w="poll");break;case S.pp.VOICE:case S.pp.ENCRYPT_VOICE:case S.pp.IM_ENCRYPT_VOICE:w="audio";break;case S.pp.ONLY_PICTURE:case S.pp.STORY_PICTURE:w="pic";break;case S.pp.STORY_VIDEO:w="video";break;case S.pp.SHARE_AWEME:w="share_video";break;case S.pp.SHARE_PHOTOS:w="share_photos";break;case S.pp.SHARE_COMPILATION:w="share";break;case S.pp.SHARE_USER:case S.pp.SHARE_MUSIC:case S.pp.SHARE_CHALLENGE:case S.pp.SHARE_STICKER:w="page";break;case S.pp.RED_PACKET:w="redpacket";break;case S.pp.SHARE_MINI_APP:w="mini_app";break;case S.pp.REF_MSG:w="ref_message";break;case S.pp.FRIEND_VIDEO_DM_COMMENT:w="friend_video_card";break;case S.pp.GROUP_INVITE_MESSAGE:let O=null==C?void 0:C["a:group_invite"];if("1"==`${O}`)w="group_card";else{let I=null==E?void 0:E.aweme_invite_card;w=(null==I?void 0:I.card_type)===1?"group_card":"unknown"}break;case S.pp.COMMAND_SHARE:w="token_video_card";break;case S.pp.SHARE_LIVE:w=M===S.c6.LIVE_KTV?"familiar_invitation_ktv":M===S.c6.LIVE_VOICE?"familiar_invitation_chatting_room":"live_card";break;case S.pp.FEED_LIVE_SHARE_INVITE_MESSAGE:w="co_play_invitation";break;case S.pp.DIRECT_INVITE:w="invite";break;case S.pp.GAME_INVITE:case S.pp.GAME_INVITE_V2:w="chat_game";break;case S.pp.CLOUD_GAME_INVITE:w="cloud_game_card";break;case S.pp.COUPON_ENTERPRISE:case S.pp.COUPON_FANS_GROUP:w="fansgroup_coupon";break;case S.pp.CHAT_CALL:w="chat_call";break;case S.pp.SHARE_PICTURE:w="share_picture";break;case S.pp.AT_FRIEND_INTERACT:w="publish_at";break;case S.pp.URGE_LEAVE_MESSAGE:w=R.ImSdk.isFromGroupOwner(I)?"reply_to_update":"ask_for_update";break;case S.pp.SHARE_LOCATION:w="location";break;case S.pp.STORY_PICTURE_ONCE_VIEW:w="only_once_pic";break;case S.pp.STORY_VIDEO_ONCE_VIEW:w="only_ak;case S.pp.SHARE_COMMENT:w="share_comment";break;case S.pp.BULLET:w="bullet";break;default:w="unknown"}return w},D={[O]:"group",[A]:"private"},U={chat_page:"chat_page",chat_panel:"chat_panel",share_board:"share_board",share_message:"share_message",chat_notif:"chat_notif",push:"push",hover_icon:"hover_icon",im_private:"im_private"}},55221:function(I,x,C){"use strict";C.d(x,{Gb:function(){return w}});var E=C(81476),M=C(6351),S=C(34162);let T=()=>(0,M.yW)(),R=()=>(0,M.vM)(),w=(I,x)=>{try{let C=x||{};S.iL.sendLog(I,(0,E._)({enter_from:T(),previous_page:R()},C))}catch(I){}}},89339:function(I,x,C){"use strict";C.d(x,{n5:function(){return H},xD:function(){return G}});var E=C(81476),M=C(93650);C(3156),C(6418);var S=C(62994),T=C(16605),R=C(85209),w=C(41968),O=C(76040),A=C.n(O),N=C(32985),P=C.n(N);let{COMMON_SEARCH_PARAMS:L,DISABLE_SECRET_VIDEO_PARAMS:D,CHANNEL_PC_WEB:U}=S||{},{ERROR_CODE:B}=T||{};async function G(I){let{cursor:x=0,count:C=50,groupId:S="1"}=I;return arguments.length>1&&void 0!==arguments[1]&&arguments[1],await (0,R.U2)("/aweme/v1/web/im/resources/emoticon/trending",(0,M._)((0,E._)({},L),{cursor:x,count:C,groupId:S}))}async function V(I){return await (0,R.v_)("/aweme/v1/web/multi/aweme/detail/",(0,E._)({},L),{aweme_ids:`[${I.join(",")}]`,request_source:3,origin_type:"chat"})}let F=new w.n({max:40,timeWait:300,runOperation:I=>{let x=[];A()(I,I=>{let{param:C}=I;C&&x.push(C)})>{iflet C=(null==x?void 0:x.aweme_details)||[],E=(null==x?void 0:x.filter_list)||[],M={};A()(C,(I,x)=>{let{aweme_id:C,external_video_type:E}=I;if(C){let x=C;E&&(x+=`:${E}`),M[x]=I}});let S={};A()(E,(I,x)=>{let{aweme_id:C,external_video_type:E}=I;if(C){let x=C;E&&(x+=`:${E}`),S[x]=I}}),A()(I,I=>{let{param:x,reject:C,resolve:E}=I;E({aweme_details:M[x]?[M[x]]:null,filter_list:S[x]?[S[x]]:null})})}else(0,w.h)(I,"")}).catch(x=>{(0,w.h)(I,x)})}});async function H(I){return F.add(I)}},46986:function(I,x,C){"use strict";C.d(x,{NI:function(){return U},Lk:function(){return N},b3:function(){return B},c5:function(){return D},v9:function(){return M},k5:function(){return H},rb:function(){return P},v$:function(){return L},I7:function(){return O},O9:function(){return Y},Bs:function(){return A},HF:function(){return K},P6:function(){return S},uX:function(){return w},zn:function(){return F},_:function(){return E}});var E,M,S,T,R,w,O,A,N,P,L,D,U,B,G,V,F,H,W=C(73217);let q={version:"1.1.3",branch:"Detached: eb6eafbbc87e9b943d0d70a71ec1871eaa7910cf",commit:"eb6eileExtKeyAudioAsrText="s:file_ext_key_audio_asr_text",I.RecognitionResponseCheckCode="s:recognition_response_check_code",I.RecognitionResponseCheckMsg="s:recognition_response_check_msg",I.PushPartDisableConfig="s:push_part_disable_config",I.MustNotify="s:must_notify",I.SendTime="s:stime",I.ConversationTags="s:conversation_tag",I.UserCustomConversationTags="s:user_custom_conversation_tag",I.EditInfo="s:edit_info",I.RefContent="s:ref_content",I.RefIsEdited="s:ref_is_edited"}(M||(M={}));let Y="mute_wl";!function(I){I[I.Enable=0]="Enable",I[I.Disable=1]="Disable"}(S||(S={})),fI){I[I.Norm[I.Allow=1]rsationDelete="conversation-delete",I.ConversationLeave="conversation-leave",I.ConversationCreate="conversation-create",I.ConversationJoin="conversation-join",I.ReadReceiptChange="read-receipt-Change",I.ReceiveNewStrangerMessage="receive-new-stranger-message",I.StrangerUpgrade="stranger-upgrade",I.MessagePropertyUpsert="message-property-upsert",I.InitLoadPage="init-load-page",I.InitFinish="init-finish",I.InitParticipant="init-participant",I.TagListUpdate="tag-list-update"}(D||(D={})),function(I){I[I.Unknown=-1]="Unknown",I[I.Success=0]="Success",I[I.InvalidToken=1]="InvalidToken",I[I.InvalidTicket=2]="InvalidTicket",I[I.InvalidRequest=4]="InvalidRequest",I[I.InvalidCommand=5]="InvalidCommand",I[I.ServerError=6]="ServerError",I[I.UserForbidden=11]="UserForbidden",I[I.MessageTargetConversationNotExist=15]="MessageTargetConversationNotExist",I[I.Degradation=16]="Degradation",I[I.RecallTimeout=17]="RecallTimeout",I[I.CallbackDeny=19]="CallbackDeny",I[I.ExpiredToken=100]="ExpiredToken",I[I.InvalidParam=400]="InvalidParam",I[I.ResourceExhausted=429]="ResourceExhausted",I[I.InternalError=500]="InternalError",I[I.InvalidInboxType=1e3]="InvalidInboxType",I[I.ConversationNotExist=1001]="ConversationNotExist",I[I.MessageNotExist=1002]="MessageNotExist",I[I.MessageOffline=1003]="MessageOffline",I[I.UnknownMessageType=1004]="UnknownMessageType",I[I.InvalidServerId=1005]="InvalidServerId",I[I.MessageNotReady=1006]="MessageNotReady",I[I.TokenFuncError=1007]="TokenFuncError",I[I.NetworkError=1008]="NetworkError",I[I.AlreadyDispose=1009]="AlreadyDispose",I[I.NoAdapter=1010]="NoAdapter",I[I.ComponentNotFound=1011]="ComponentNotFound",I[I.NotImplemented=1012]="NotImplemented",I[I.MPInvalidArgument=10001]="MPInvalidArgument",I[I.MPServerUrlError=10002]="MPServerUrlError",I[I.MPNotFileMsg=10003]="MPNotFileM,I[I.Succeeded=3]="Succeeded",I[I.Received=4]="Received",I[I.Failed=-1]="Failed",I[I.Rejected=-2]="Rejected",I[I.SelfVisible=-3]="SeeckMessageNle=4]="CheckMessageNotPassButSelfVisible",I[I.UserHasBeenBlock=5]="UserHasBeenBlock"}(G||(G={})),function(I){I[I.Succeeded=0]="Succeeded",I[I.Rejected=1]="Rejected",I[I.PartialRejected=2]="PartialRejected"}(V||(V={})),function(I){I[I.Immediate=0]="Immediate",I[I.Throttle=1]="Throttle",I[I.Debounce=2]="Debounce",I[I.ThrottleWithArgs=3]="ThrottleWithArgs",I[I.DebounceWithArgs=4]="DebounceWithArgs"}(F||(F={})),function(I){I[I.Default=0]="Default",I[I.AwemeMode=1]="AwemeMode"}(H||(H={}))},5123:function,fe4Y{}|e60-]*this.as("minutes")},B.hours=function(){return this.get(("hours")},B.days=function(){return this.get("days")},B.asDays=function(){return this.as("days")},B.weeks=function(){return this.get("weeks")},B.asWeeks=function(){re,B.asMonths=function(){re")},B.years=function(){return this.get("years")},B.asYears=function(){return this.as("years")},D}();return functiond=function(I,x){return N(I)&&(I=I.asMilliseconds()),S.bind(this)(I,x)},E.prototype.subtract=function(I,x){return N(I)&&(I=I.asMilliseconds()),T.bind(this)(I,x)}}})},91284:function(I,x){!function(I,C){C(x)}(0,function(I){"use strict";var x="function"==typeof WeakMap,C=Object.keys;function E(I,x){return I===x||I!=I&&x!=x}function M(I){return I.constructor===Object||null==I.constructor}function S(I){return!!I&&"function"==typeof I.then}function T(I){return!!(I&&I.$$typeof)}function R(){var I=[];return{delete:function(x){for(var C=0;C<I.length;++C)if(I[C][0]===x){I.splice(C,1);return}},get:function(x){for(var C=0;C<I.length;++C)if(I[C][0]===x)returnI){return I?function(){return new WeakMap}:R}(x);function O(I){return function(x){var C=I||x;return function(I,x,E,M,S,T,R){void 0===R&&(R=w());var O=!!I&&"object"==typeof I,A=!!x&&"object"==typeof x;if(O!==A)return!1;if(!O&&!A)return C(I,x,R);var N=R.get(I);if(N&&R.get(x))return N===x;R.set(I,x),R.set(x,I);var P=C(I,x,R);return R.delete(I),R.delete(x),P}}}function A(I,x,C,E){var M=I.length;if(x.length!==M)return!1;for(;M-- >0;)if(!C(I[M],x[M],M,M,I,x,E))return!1;return!0}function N(I,x,C,E){var M=I.size===x.size;if(M&&I.size){var S={},T=0;I.forEach(function(R,w){if(M){var O=!R=S.length;if(C(x).length!==R)return!1;if(R)for(var w=void 0;R-- >0;){if((w=S[R])===P){var O=T(I),A=T(x);if((O||A)&&O!==A)return!1}if(!L(x,w)||!E(I[w],x[w],w,w,I,x,M))return!1}return!0}var U=function(){return"g"===/foo/g.flags?function(I,x){return I.source===x.source&&I.flags===x.flags}:function(I,x){return I.source===x.sourcignoreCase&&I.multiline===x.multiline&&I.unicode===x.unicode&&I.sticky===x.sticky&&I.lastIndex===x.lastIndex}}();function B(I,x,C,E){var M=I.size===x.size;if(M&&I.size){var S={};I.forEach(function(T,R){if(M){var w=!1,O=0;x.forEach(function(M,A){!w&&!S[O]&&(w=C(T,M,R,A,I,x,E))&&(S[O]=!0),O++}),M=w}})}return M}var G="function"==typeof Map,V="function"==typeof Set,F=Object.prototype.valueOf;function H(I){var x="function"==typeof I?I(C):function(I,x,E,M,S,T,R){return C(I,x,R)};function C(I,C,T){if(I===C)return!0;if(I&&C&&"object"==typeof I&&"object"==typeof C){if(M(I)&&M(C))return D(I,C,x,T);var R=Array.isArray(I),w=Array.isArray(C);return R||w?R===w&&A(I,C,x,T):(R=I instanceof Date,w=C instanceof Date,R||w)?R===w&&E(I.getTime(),C.getTime()):(R=I instanceof RegExp,w=C instanceof RegExp,R||w)?R===w&&U(I,C):S(I)||S(C)?I===C:G&&(R=I instanceof Map,w=C instanceof Map,R||w)?R===w&&N(I,C,x,T):V&&(R=I instanceof Set,w=C instanceof Set,R||w)?R===w&&B(I,C,x,T):I.valueOf!==F||C.valueOf!==F?E(I.valueOf(),C.valueOf()):D(I,C,x,T)}return I!=I&&C!=C}return C}var W=H(),q=H(function(){return E}),K=H(O()),Y=H(O(E));I.circularDeepEqual=K,I.circularShallowEqual=Y,I.createCustomEqual=H,I.deepEqual=W,I.sameValueZeroEqual=E,I.shallowEqual=q,Object.defineProperty(I,"__esModule",{value:!0})})},6770:function(module,exports,__webpack_require__){var __WEBPACK_AMD_DEFINE_RESULT__,process=__webpack_require__(58467);!function(){"use strict";var ERROR="input is invalid type",WINDOW="object"==typeof window,root=WINDOW?window:{};root.JS_MD5_NO_WINDOW&&(WINDOW=!1);var WEB_WORKER=!WINDOW&&"object"==typeof self,NODE_JS=!root.JS_MD5_NO_NODE_JS&&"object"==typeof process&&process.versions&&process.versions.node;NODE_JS?root=window:WEB_WORKER&&(root=self);var buffer8,COMMON_JS=!root.JS_MD5_NO_COMMON_JS&&module.exports,AMD=__webpack_require__.amdO,ARRAY_BUFFER=!root.JS_MD5_NO_ARRAY_it(""),EXTRA=[128,32768,8388608,-2147483648],SHIFT=[0,8,16,24],OUTPUT_TYPES=["hex","array","digabcdefghijklmnopqrstuvwx ArrayBuffer(ayBuffer.16]=blocks[1]=blocks[2]=blocks[3]=blocks[4]=blocks[5]=blocks[6]=blocks[7]=blocks[8]=blocks[9]=blocks[10]=blocks[11]=blocks[12]=blocks[13]=blocks[14]=blocks[15]=0,this.blocks=blocks,this.buffer8=buffer8;else if(ARRAY_BUFFER){var x=new ArrayBuffer(68);this.buffer8=new Uint8Array(x),this.blocks=new Uint32Array(x)}else this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];this.h0=this.h1=this.h2=this.h3=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}Md5.prototype.update=function(I){if(!this.finalized){var x,C=typeof I;if("string"!==C){if("object"===C){if(null===I)throw ERROR;if(ARRAY_BUFFER&&I.constructor===ArrayBuffer)I=new Uint8Array(I);else if(!Array.isArray(I)&&(!ARRAY_BUFFER||!ArrayBuffer.isView(I)))throw ERROR}else throw ERROR;x=!0}for(var E,M,S=0,T=I.length,R=this.blocks,w=this.buffer8;S<T;){if(this.hashed&&(this.hashed=!1,R[0]=R[16],R[16]=R[1]=R[2]=R[3]=R[4]=R[5]=R[6]=R[7]=R[8]=R[9]=R[10]=R[11]=R[12]=R[13]=R[14]=R[15]=0),x){if(ARRAY_BUFFER)for(M=this.start;S<T&&M<64;++S)w[M++]=I[S];else for(M=this.start;S<T&&M<64;++S)R[M>>2]|=I[S]<<SHIFT[3&M++]}else if(ARRAY_BUFFER)for(M=this.start;S<T&&M<64;++S)(E=I.charCodeAt(S))<128?w[M++]=E:(E<2048?w[M++]=192|E>>6:(E<55296||E>=57344?w[M++]=224|E>>12:(E=65536+((1023&E)<<10|1023&I.charCodeAt(++S)),w[M++]=240|E>>18,w[M++]=128|E>>12&63),w[M++]=128|E>>6&63),w[M++]=128|63&E);else for(M=this.start;S<T&&M<64;++S)(E=I.charCodeAt(S))<128?R[M>>2]|=E<<SHIFT[3&M++]:(E<2048?R[M>>2]|=(192|E>>6)<<SHIFT[3&M++]:(E<55296||E>=(),this.hashed=!0):this.start=M}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},Md5.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var I=this.blocks,x=this.lastByteIndex;I[x>>2]|=EXTRA[3&x],x>=56&&(this.hashed||this.hash(),I[0]=I[16],I[16]=I[1]=I[2]=I[3]=I[4]=I[5]=I[6]=I[7]=I[8]=I[9]=I[10]=I[11]=I[12]=I[13]=I[14]=I[15]=0),I[14]=this.bytes<<3,I[15]=this.hBytes<<3|this.bytes>>>29,this.hash()}},Md5.prototype.hash=function(){var I,x,C,E,M,S,T=this.blocks;this.first?(C=((C=(-271733879^(E=((E=(-1732584194^2004318071&(I=((I=T[0]-680876937)<<7|I>>>25)-271733879<<0))+T[1]-117830708)<<12|E>>>20)+I<<0)&(-271733879^I))+T[2]-1126478375)<<17|C>>>15)+E<<0,x=((x=(I^C&(E^I))+T[3]-1316259209)<<22|x>>>10)+C<<0):(I=this.h0,x=this.h1,C=this.h2,I+=((E=this.h3)^x&(C^E))+T[0]-680876936,E+=(C^(I=(I<<7|I>>>25)+x<<0)&(x^C))+T[1]-389564586,C+=(x^(E=(E<<12|E>>>20)+I<<0)&(I^x))+T[2]+606105819,x+=(I^(C=(C<<17|C>>>15)+E<<0)&(E^I))+T[3]-1044525330,x=(x<<22|x>>>10)+C<<0),I+=(E^x&(C^E))+T[4]-176418897,E+=(C^(I=(I<<7|I>>>25)+x<<0)&(x^C))+T[5]+1200080426,C+=(x^(E=(E<<12|E>>>20)+I<<0)&(I^x))+T[6]-1473231341,x+=(I^(C=(C<<17|C>>>15)+E<<0)&(E^I))+T[7]-45705983,I+=(E^(x=(x<<22|x>>>10)+C<<0)&(C^E))+T[8]+1770035416,E+=(C^(I=(I<<7|I>>>25)+x<<0)&(x^C))+T[9]-1958414417,C+=(x^(E=(E<<12|E>>>20)+I<<0)&(I^x))+T[10]-42063,x+=(I^(C=(C<<17|C>>>15)+E<<0)&(E^I))+T[11]-1990404162,I+=(E^(x=(x<<22|x>>>10)+C<<0)&(C^E))+T[12]+1804603682,E+=(C^(I=(I<<7|I>>>25)+x<<0)&(x^C))+T[13]-40341101,C+=(x^(E=(E<<12|E>>>20)+I<<0)&(I^x))+T[14]-1502002290,x+=(I^(C=(C<<17|C>>>15)+E<<0)&(E^I))+T[15]+1236535329,x=(x<<22|x>>>10)+C<<0,I+=(C^E&(x^C))+T[1]-165796510,I=(I<<5|I>>>27)+x<<0,E+=(x^C&(I^x))+T[6]-1069501632,E=(E<<9|E>>>23)+I<<0,C+=(I^x&(E^I))+T[11]+643717713,C=(C<<14|C>>>18)+E<<0,x+=(E^I&(C^E))+T[0]-373897302,x=(x<<20|x>>>12)+C<<0,I+=(C^E&(x^C))+T[5]-701558691,I=(I<<5|I>>>27)+x<<0,E+=(x^C&(I^x))+T[10]+38016083,E=(E<<9|E>>>23)+I<<0,C+=(I^x&(E^I))+T[15]-660478335,C=(C<<14|C>>>18)+E<<0,x+=(E^I&(C^E))+T[4]-405537848,x=(x<<20|x>>>12)+C<<0,I+=(C^E&(x^C))+T[9]+568446438,I=(I<<5|I>>>27)+x<<0,E+=(x^C&(I^x))+T[14]-1019803690,E=(E<<9|E>>>23)+I<<0,C+=(I^x&(E^I))+T[3]-187363961,C=(C<<14|C>>>18)+E<<0,x+=(E^I&(C^E))+T[8]+1163531501,x=(x<<20|x>>>12)+C<<0,I+=(C^E&(x^C))+T[13]-1444681467,I=(I<<5|I>>>27)+x<<0,E+=(x^C&(I^x))+T[2]-51403784,E=(E<<9|E>>>23)+I<<0,C+=(I^x&(E^I))+T[7]+1735328473,C=(C<<14|C>>>18)+E<<0,x+=(E^I&(C^E))+T[12]-1926607734,I+=((M=(x=(x<<20|x>>>12)+C<<0)^C)^E)+T[5]-378558,E+=(M^(I=(I<<4|I>>>28)+x<<0))+T[8]-2022574463,C+=((S=(E=(E<<11|E>>>21)+I<<0)^I)^x)+T[11]+1839030562,x+=(S^(C=(C<<16|C>>>16)+E<<0))+T[14]-35309556,I+=((M=(x=(x<<23|x>>>9)+C<<0)^C)^E)+T[1]-1530992060,E+=(M^(I=(I<<4|I>>>28)+x<<0))+T[4]+1272893353,C+=((S=(E=(E<<11|E>>>21)+I<<0)^I)^x)+T[7]-155497632,x+=(S^(C=(C<<16|C>>>16)+E<<0))+T[10]-1094730640,I+=((M=(x=(x<<23|x>>>9)+C<<0)^C)^E)+T[13]+681279174,E+=(M^(I=(I<<4|I>>>28)+x<<0))+T[0]-358537222,C+=((S=(E=(E<<11|E>>>21)+I<<0)^I)^x)+T[3]-722521979,x+=(S^(C=(C<<16|C>>>16)+E<<0))+T[6]+76029189,I+=((M=(x=(x<<23|x>>>9)+C<<0)^C)^E)+T[9]-640364487,E+=(M^(I=(I<<4|I>>>28)+x<<0))+T[12]-421815835,C+=((S=(E=(E<<11|E>>>21)+I<<0)^I)^x)+T[15]+530742520,x+=(S^(C=(C<<16|C>>>16)+E<<0))+T[2]-995338651,x=(x<<23|x>>>9)+C<<0,I+=(C^(x|~E))+T[0]-198630844,I=(I<<6|I>>>26)+x<<0,E+=(x^(I|~C))+T[7]+1126891415,E=(E<<10|E>>>22)+I<<0,C+=(I^(E|~x))+T[14]-1416354905,C=(C<<15|C>>>17)+E<<0,x+=(E^(C|~I))+T[5]-57434055,x=(x<<21|x>>>11)+C<<0,I+=(C^(x|~E))+T[12]+1700485571,I=(I<<6|I>>>26)+x<<0,E+=(x^(I|~C))+T[3]-1894986606,E=(E<<10|E>>>22)+I<<0,C+=(I^(E|~x))+T[10]-1051523,C=(C<<15|C>>>17)+E<<0,x+=(E^(C|~I))+T[1]-2054922799,x=(x<<21|x>>>11)+C<<0,I+=(C^(x|~E))+T[8]+1873313359,I=(I<<6|I>>>26)+x<<0,E+=(x^(I|~C))+T[15]-30611744,E=(E<<10|E>>>22)+I<<0,C+=(I^(E|~x))+T[6]-1560198380,C=(C<<15|C>>>17)+E<<0,x+=(E^HARS[I>>24&15]+HEX_CHARS[x>>4&15]+HEX_CHARS[15&x]+HEX_CHARS[x>+HEX_CHARS[C>>28&15]+HEX_CHARS[C>>24&15]+HEX_CHARS[E>>4&15]+HEX_CHAtotype.toString=Md5.prototype.hex,Md5.prototype.digest=function(){this.finalize();var I=this.h0,x=this.h1,C=this.h2,E=this.h3;return[255&I,I>>8&255,I>>16&255,I>>24&255,255&x,x>>8&255,x>>16&255,x>>24&255,255&C,C>>8&255,C>>16&255,C>>24&255,255&E,E>>8&255,E>>16&255,E>>24&255]},Md5.prototype.array=Md5.prototype.digest,Md5.prototype.arrayBuffer=function(){this.finalize();var I=new ArrayBuffer(16),x=new Uint32Array(I);return x[0]=this.h0,x[1]=this.h1,x[2]=this.h2,x[3]=this.h3,I},Md5.prototype.buffer=Md5.prototype.arrayBuffer,Md5.prototype.base64=function(){for(var I,x,C,E="",M=this.array(),S=0;S<15;)I=M[S++],x=E+(BASE64_ENCODE_CHAR[(I=M[S])>>>2]+BASE64_ENCODE_CHAR[I<<4&63]+"==")};var exports=createMethod();COMMON_JS?module.exports=exports:(root.mtiEBPACK_AMD_DEFINE_RESULT__))}()},54:function(I,x,C){var E=C(13430).stringify,M=C(18550);I.exports=function(I){return{parse:M(I),stringify:E}},I.exports.parse=M(),I.exports.stringify=E},18550:function(I,x,C){var E=null,M=function(I){"use strict";var x,M,S,T,R={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"	"},w=function(I){throw{na;)0, IriO("l"),O(),x[I]=T(),P(),"}"===M)return O("}"),x;O(","),P()}}w("Bad object")};return T=function(){switch(P(),M){case"{":return U();case"[":return D();case'"':return N();case"-":return A();default:return M>="0"&&M<="9"?A():L()}},function(I,C){var E;return S=I+"",x=0,M=" ",E=T(),P(),M&&w("Syntax error"),"function"rts=M},13430:function(I,x,C){var E=C(53251),M=I.exports;!function(){"use strict";var I,x,C,S=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,T={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};function R(I){return S.lastIndex=0,S.test(I)?'"'+I.replace(S,function(I){var x=T[I];return"string"==typeof x?x:"\\u"+("0000"+I.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+I+'"'}function w(M,S){var T,O,A,N,P,L=I,D=S[M],U=null!=D&&(D instanceof E||E.isLong(D));switch(D&&"object"==typeof D&&"function"==typeof D.toJSON&&(D=D.toJSON(M)),"function"==typeof C&&(D=C.call(S,M,D)),typeof D){case"string":return R(D);case"number":return isFintring(D);case"object":if(!D)return"null";if(U)return D.toString();if(I+=x,P=[],"[object Array]"===Object.prototype.toString.apply(D)){for(T=0,N=D.length;T<N;T+=1)P[T]=w(T,D)||"null";return A=0===P.length?"[]":I?"[\n"+I+P.join(",\n"+I)+"\n"+L+"]":"["+P.join(",")+"]",I=L,A}if(C&&"object"==typeof C)for(T=0,N=C.length;T<N;T+=1)"string"==typeof C[T]&&(A=w(O=C[T],D))&&P.push(R(O)+(I?": ":":}":"{"T<S;T+throw Error("JSON.stringify");return w("",{"":E}7899);function S(I,x){var C=-1,urn E(I,function(I,E,M){S[++C]=x(I,E,M)}),S}I.exports=S},96713:function(I){function x(I,x){for(var C,E=-1,M=I.length;++E<M;){var S=x(I[E]);void 0!==S&&(C=void 0===C?S:C+S) E=C(82457),M=C(96713);function S(I,x){return I&&I.leatchingKey:!0,ioptions=I;var x="function"==typeof I.isMatchingKey;x?this.getKeyIndex=this._getKeyIndexFromMatchingKey:I.maxSize>1?this.getKeyIndex=this._getKeyIndexForMany:this.getKeyInansformKey,this.shouldCloneArguments=this.canTransformKey||x,this.shouldUpdateOnAdd="function"==typeof I.onCacheAdd,this.shouldUpdateOnChange="function"==typeof I.onCacheChange,this.shouldUpdateOnHit="function"==typeof I.onCacheHit}return Object.defineProperty(I.prototype,"size",{get:function(){return this.keys.length},enumerable:!1,configurable:!0}),Object.defineProperty(I.prototype,"snapshot",{get:function(){return{keys:C(this.keys),size:this.size,values:C(this.values)}},enumerable:!1,configurable:!0}),I.prototype._getKeyIndexFromMatchingKey=function(I){var x=this.options,C=x.isMatchingKey,E=x.maxSize,M=this.keys,S=M.length;if(!S)return -his._getKeyIndexForSingeturn -1},I.prototype._getKey;)E[T+1]=E[T],M[T+1]=M[T];E[0]=I,M[0]=x;var R=this.options.maxSize;S===R&&C===S?(E.pop(),M.pop()):C>=R&&(E.length=M.length=R)},I.prototype.updateAsyncCache=function(I){var x=this,C=this.options,E=C.onCacheChange,M=C.onCacheHit,S=this.keys[0],T=this.values[0];this.values[0]=T.then(function(C){return x.shouldUpdateOnHit&&M(x,x.options,I),x.shouldUpdateOnChange&&E(x,x.options,I),C},function(I){var C=x.getKeyIndex(S);throw -1!==C&&(x.keys.splice(C,1),x.values.splice(C,1)),I})},I}();function w(I,x){if(void 0===x&&(x={}),M(I))return w(I.fn,T(I.options,x));if("function"!=typeof I)throw TypeError("YoacheHit:V,transformKey:F},E(x)),W=new R(H),q=W.keys,K=W.values,Y=W.canTransformKey,z=W.sshouldUpdateOnChange,X=W.shouldUpda=q.84))}(0,function(I,x){"use strict";var C=function(I){return I&&"object"==typeof I&&"default"in I?I:{default:I}}(I);function E(){return(E=Object.assign?Object.assign.bind():function(I){for(var x=1;x<arguments.length;x++){var C=arguments[x];for(var E in C)Object.prototype.hasOwnProperty.call(C,E)&&(I[E]=C[E])}return I}).apply(this,arguments)}function M(I,x){if(null==I)return{};var C,E,M={},S=Object.keys(I);for(E=0;E<S.length;EpEqual:!1,isPromise:!1,isReact:!1,isSerialized:!1,isShallowEqual:!1,matchesArg:void 0,matchesKey:void 0,maxAge:void 0,maxArgs:void 0,maxSize:1,onExpire:void 0,profileName:void 0,serializer:void 0,updateExpire:!1};function T(){fuce(function(I,x){return"function"==typeof I?"function"==typeof x?function(){I.apply(this,arguments),x.apply(this,arguments)}:I:"function"==typeof x?x:void 0})}function R(){for(var I=arguments.length,x=Array(I),C=0;C<I;C++)x[C]=arguments[C];return x.reduce(function(I,x){return"function"==typeof I?"function"==typeof x?function(){return I(x.apply(this,arguments))}:I:"function"==typeof x?x:void 0})}function w(I,x){for(var C=0;C<I.length;C++)if(I[C].tion"==typeof x?x:function(x,C){for(var E=0;E<C.length;E++)if(!I(x[E],C[E]))return!1;return!0};return function(I,x){for(var E=0;E<I.length;E++)if(I[E].length===x.length&&C(I[E],x))return E;return -1}}function A(I,x){return x&&x!==S?E({},I,x,{onCacheAdd:T(I.onCacheAdd,x.onCacheAdd),onCacheChange:T(I.onCacheChange,x.onCacheChange),onCacheHit:T(I.onCacheHit,x.onCacheHit),transformArgs:R(I.transformArgs,x.transformArgs)}):I}function N(I){return"function"==typeof I&&I.isMoized}function P(I,x,C){try{var E=C||x||"anonymous";Object.defineProperty(I,"name",{configurable:!0,enumerable:!1,value:"moized("+E+")",writable:!0})}catch(I){}}function L(I,x,C){var E=w(I,x);-1!==E&&(clearTimeout(I[E].timeoutId),C&&I.splice(E,1))}function D(I,x){var C=setTimeout(I,x);return"function"==typeof C.unref&&C.unref(),C}function U(I,x,C,E){var M=x.maxAge;return function S(T,R,A){var N=T.keys[0];if(-1===w(I,N)){var P=function(){var M=O(C,E)(T.keys,N),w=T.values[M];~M&&(T.keys.splice(M,1),T.values.splice(M,1),"function"==typeof x.onCacheChange&&x.onCacheChange(T,R,A)),L(I,N,!0),"function"==typeof x.onExpire&&!1===x.onExpire(N)&&(T.keys.unshift(N),T.values.unshift(w),S(T,R,A),"function"==typeof x.onCacheChange&&x.onCacheChange(T,R,A))};I.push({expirationMethod:P,key:N,timeoutId:D(P,M)})}}}function B(I,x){return function(C){var E=C.keys[0],M=w(I,E);~M&&(L(I,E,!1),I[M].timeoutId=D(I[M].expirationMethod,x.maxAge))}}function G(I,x,C,E){var M="number"==typeof x.maxAge&&isFinite(x.maxAge)?U(I,x,C,E):void 0;return{onCacheAdd:M,onCacheHit:M&&x.updateExpire?B(I,x):void 0}}var V={anonymousProfileNameCounter:1,isCollectingStats:!1,profiles:{}},F=!1;function H(I){I?delete V.profiles[I]:V.profiles={}}function W(I){void 0===I&&(I=!0),V.isCollectingStats=I}function q(I){var x=I.profileName;return function(){x&&!V.profiles[x]&&(V.profiles[x]={calls:0,hits:0}),V.profiles[x].calls++}}function K(I){return function(){var x=V.profiles,C=I.profileName;x[C]||(x[C]={calls:0,hits:0}),x[C].calls++,x[C].hits++}}fuI.name||"Anonymous "+V.anonymousProfileNameCounter++}function z(I,x){return I?(x/I*100).toFixed(4)+"%":"0.0000%"}function Z(I){V.isCollectingStats||F||(F=!0);var x=V.profiles;if(I){if(!x[I])return{calls:0,hits:0,usage:"0.0000%"};var C=x[I];return E({},C,{usage:z(C.calls,C.hits)})}var M=Object.keys(V.profiles).reduce(function(I,C){return I.calls+=x[C].calls,I.hits+=x[C].hits,I},{calls:0,hits:0});return E({},M,{profiles:Object.keys(x).reduce(function(I,x){return I[x]=Z(x),I},{}),usage:z(M.calls,M.hits)})}function J(I){return V.isCollectingStats?{onCacheAdd:q(I),onCacheHit:K(I)}:{}}var X={arguments:!0,callee:!0,caller:!0,constructor:!0,len Q(I,x,C){void 0===C&&(C=[]),Object.getOwnPropertyNames(I).forEach(function(E){if(!X[E]&&-1===C.indexOf(E)){var M=Object.getOwnPropertyDescty(x,E,M):x[E]=I[E]}})}function ee(I,x){var C=x.expirations,E=I.options,M=O(E.isEqual,E.isMatchingKey),S=I;S.clear=function(){var I=S._microMemoizeOptions.onCacheChange,x=S.cache;return x.keys.length=0,x.values.length=0,I&&I(x,S.options,S),!0},S.clearStats=function(){H(S.options.profileName)},S.get=function(I){var x=S._microMemoizeOptions.transformKey,C=S.cache,E=x?x(I):I;return -1!==M(C.keys,E)?S.apply(this,I):void 0},S.getStats=function(){return Z(S.options.profileName)},S.has=function(I){var x=S._microMemoizeOptions.transformKey,C=x?x(I):I;return -1!==M(S.cache.keys,C)},S.keys=function(){return S.cacheSnapshot.keys},S.remove=function(I){var x=S._microMemoizeOptions,E=x.onCacheChange,T=x.transformKey,R=S.cache,w=M(R.keys,T?T(I):I);if(-1===w)return!1;var O=R.keys[w];return R.keys.splice(w,1),R.values.splice(w,1),E&&E(R,S.op{var C=S._microMemoizeOptions,E=S.cache,T=S.options,R=C.onCacheAdd,w=C.onCacheChange,O=C.transformKey,A=O?O(I):I,N=M(E.keys,A);if(-1===N){var P=T.maxSize-1;E.size>P&&(E.keys.length=P,E.values.length=P),E.keys.unshift(A),E.values.unshift(x),T.isPromise&&E.updateAsyncCache(S),R&&R(E,T,S),w&&w(E,T,S)}else{var L=E.keys[N];E.values[N]=x,N>0&&E.orderByLru(L,x,N),T.isPromise&&E.updateAsyncCache(S),"fuS.values=function(){return S.caunction et(I,x){var C=x.expirations,E=x.options,M=x.originalFunction,S=I.options;Object.defineProperties(I,{_microMemoizeurn S}},cacheSnapshot:{configurable:!0,get:function(){var x=I.cache;return{keys:x.keys.slice(0),size:x.size,values:x.values.slice(0)}}},expirations:{configurable:!0,get:function(){return C}},expirationsSnapshot:{configurable:!0,get:function(){return C.slice(0)}},isMoized:{configurable:!0,get:function(){return!0}},options:{configurable:!0,get:function(){return E}},originalFunction:{configurable:!0,get:function(){return M}}}),Q(M,I)}function ei(I,x){return ee(I,x),et(I,x),I}var en="function"==typeof Symbol&&Symbol.for?Symbol.for("react.element"):60103;function eo(I,x,C){var M=I(E({maxArgs:2,isShallowEqual:!0},C,{isReact:!1}));function S(I,C,E){this.props=I,this.context=C,this.updater=E,this.MoizedComponent=M(x)}return x.displayName||(x.displayName=x.name||"Component"),S.prototype.isReactComponent={},S.prototype.render=function(){return{$$typeof:en,type:this.MoizedComponent,props:this.props,ref:null,key:null,_owner:null}},Q(x,S,["contextType","contextTypes"]),S.displayName="Moized("+(x.displayName||x.name||"Component")+")",P(S,x.name,C.profileName),S}function er(I){return function(x){if(I>=x.length)return x;if(0===I)return[];if(1===I)return[x[0]];if(2===I)return[x[0],x[1]];if(3===I)return[x[0],x[1],x[2]];for(var C=[],E=0;E<I;E++)C[E]=x[E];return C}}function ea(I,x){for(var C=I.length,E=0;E<C;++E)if(I[E]===x)return E+1;return 0}function ed(){var I=[],x=[];return I.length){var S=ea(I,this);0===S?I[I.length]ar T=ea(I,E);if(0!==T)return"[ref="+(x.slice(0,T).join(".")||".")+"]"}else I[0]=E,x[0]=C;return E}return""+E}}function el(I){var x=typeof I;return I&&("object"===x||"function"===x)?JSON.stringify(I,ed()):I}function ec(I){for(var x="|",C=0;C<I.length;C++)x+=el(I[C])+"|";return[x]}function eu(I){return"function"==typeof I.serializer?I.serializer:ec}function ev(I,x){return I[0]===x[0]}function eh(I){if("function"==typeof I)return function(x,C,E){return I(E.cache,E.options,E)}}function e_(I){return I.matchesArg||I.isDeepEqual&&x.deepEqual||I.isShallowEqual&&x.shallowEqual||x.sameValueZeroEqual}function ep(I){return I.matchesKey||I.isSerialized&&ev||void 0}function eg(I){return R(I.isSerialized&&eu(I),"function"==typeof I.transformArgs&&I.transformArgs,"number"==typeof I.maxArgs&&er(I.maxArgs))}function ef(I){var x=I.options.updateCacheForKey,C=function(){for(var C=arguments.length,E=Array(C),M=0;M<C;M++)E[M]=arguments[M];if(!x(E))return I.apply(this,E);var S=I.fn.apply(this,E);return I.set(E,S),S};return Q(I,C),C}var em=["matchesArg","isDeepEqual","isPromise","isReact","isSerialized","isShallowEqual","matchesKey","maxAge","maxArgs","maxSize","onCacheAdd","onCacheChange","onCacheHit","onExpire","profileName","serializer","updateCacheForKey","transformArgs","updateExpire"],ey=function I(x,R){var w=R||S;if(N(x))return I(x.originalFunction,A(x.options,w));if("object"==typeof x)return function(C,E){return"function"==typeof C?I(C,A(x,E)):I(A(x,C))};if(w.isReact)return eo(I,x,w);var O=E({},S,w,{maxAge:"number"==typeof w.maxAge&&w.maxAge>=0?w.maxAge:S.maxAge,maxArgs:"number"==typeof w.maxArgs&&w.maxArgs>=0?w.maxArgs:S.maxArgs,maxSize:"number"==typeof w.maxSize&&w.maxSize>=0?w.maxSize:S.maxSize,profileName:w.profileName||Y(x)}),L=[];O.matchesArg,O.isDeepEqual;var D=O.isPromise;O.isReact,O.isSerialized,O.isShallowEqual,O.matchesKey,O.maxAge,O.maxArgs;var U=O.maxSize,B=O.onCacheAdd,V=O.onCacheChange,F=O.onCacheHit;O.onExpire,O.profileName,O.serializer;var H=O.updateCacheForKey;O.transformArgs,O.updateExpire;var W=M(O,em),q=e_(O),K=ep(O),z=G(L,O,q,K),Z=J(O),X=eg(O),Q=E({},W,{isEqual:q,isMatchingKey:K,isPromise:D,maxSize:U,onCacheAdd:eh(T(B,z.onCacheAdd,Z.onCacheAdd)),onCacheChange:eh(V),onCacheHit:eh(T(F,z.onCacheHit,Z.onCacheHit)),transformKey:X}),ee=ei(C.default(x,Q),{expirations:L,options:O,originalFunname,w.profi,updateExpire:x}):"object"==typeof x?ey({maxAge:I,onExpire:x.onExpire,updateExpire:x.updateExpire}):"function"==typeof x?ey({maxAge:I,onExpire:x,updateExpire:!0}):ey({maxAge:I})}return ey.clearStats=H,ey.collectStats=W,ey.compose=function(){return R.apply(void 0,arguments)||ey},ey.deep=ey({isDeepEqual:!0}),ey.getStats=Z,ey.infinite=ey({maxSize:1/0}),ey.isCollectingStats=function(){retufunction"==typeof I&&!!I.isMoized},ey.matchesArg=function(I){return ey({matchesArg:I})},ey.matchesKey=function(I){rrgs=function(I){return ey({maxArgs:I})},ey.maxSize=function(I){return ey({maxSize:I})},ey.profile=function(I){return ey({profileName:I})},ey.promise=ey({isPromise:!0,updateExpire:!0}),ey.react=ey({isReact:!0}),ey.serialize=ey({isSerialized:!0}),ey.serializeWith=function(I){return ey({isSerialized:!0,serializer:I})},ey.shallow=ey({isShallowEqual:!0}),ey.transformArgs=function(I){return ey({transformArgs:I})},ey.updateCacheForKey=function(I){return ey({updateCacheForKey:I})},Object.defineProperty(ey,"default",{configurable:!1,enumerable:!1,value:ey,writable:!1}),ey})}}]);