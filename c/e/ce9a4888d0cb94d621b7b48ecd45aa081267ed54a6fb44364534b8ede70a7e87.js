"use strict";var config,VERSION="4.0.0",displayed=!1,channel=(self.addEventListener("push",function(e){var n,l=e.data?JSON.parse(e.data.text()):null;l?(n=getFromDB("siteconfig").then(function(e){log("config data:",e),config=e;var e=l.title||null,n=l.content||"",t=l.icon||"",i=l.image||"",o=l.badge||"",a=l.url||null,s=l.id||"",r=l.collapse_key,c=void 0===l.renotify||l.renotify,a=a||l.link||"";if(!e)throw new Error("Invalid Payload");var d=track("NOTI_DELIVERED",l,!0),n=(displayed=!0,setTimeout(2e3),{lang:"en",body:n,icon:t,data:{url:a,link:a,id:s,payload:l,flag:"grx"},image:i,badge:o}),t=(r&&(n.tag=r,n.renotify=c),self.registration.showNotification(e,n));return Promise.all([d,t])}),e.waitUntil(n)):send_msg_to_client("log","Invalid notification received",e.data.text())}),self.addEventListener("install",function(e){log("install"),e.waitUntil(self.skipWaiting())}),self.addEventListener("activate",function(e){log("activated",self.clients),e.waitUntil(self.clients.claim())}),self.addEventListener("notificationclick",function(n){var t,e;n.notification.data&&"grx"!==n.notification.data.flag||(displayed=!1,n.notification.close(),e=getFromDB("siteconfig").then(function(e){log("config data:",e),config=e,t=n.notification.data&&n.notification.data.url&&0<n.notification.data.url.length?openWindow(n,n.notification.data.url):n.notification.data&&n.notification.data.link&&0<n.notification.data.link.length?openWindow(n,n.notification.data.link):openWindow(n,self.location.protocol+"//"+self.location.hostname);e=track("NOTI_OPENED",n.notification.data.payload,!1);return Promise.all([e,t])}),n.waitUntil(e))}),self.addEventListener("notificationclose",function(e){var n;e.notification.close(),displayed&&(n=track("NOTI_CLOSED",e.notification.data.payload,!1),e.waitUntil(n)),displayed=!1}),{}),WorkerMessengerCommand={AMP_SUBSCRIPTION_STATE:"amp-web-push-subscription-state",AMP_SUBSCRIBE:"amp-web-push-subscribe",AMP_UNSUBSCRIBE:"amp-web-push-unsubscribe"};function onMessageReceivedSubscriptionState(){var n=null;self.registration.pushManager.getSubscription().then(.then(function(e){null==e?broadcastReply(WorkerMessengerCommand.AMP_SUBSCRIPTION_STATE,!1):(e=!!n&&"granted"===e,broadcastReply(WorkerMessengerCommand.AMP_SUBSCRIPTION_STATE,e))})}function onMessageReceivedUnsubscribe(){self.registration.pushManager.getSubscription().then(.then(}unction openWindow(e,i){return e.waitUntil(clients.matchAll({type:"window"}).then(function(e){i=addNotificationParams(i);for(var n=0;n<e.length;n++){var t=e[n];if(t.url===i&&"focus"in t)return t.focus()}if(clients.openWindow)return clients.openWindow(i)}))}function addNotificationParams(e){if(!e||0===e.length||!config||!config.notification_params)return e;var n,t,i=config&&config.notification_params,o=null;if(-1<e.indexOf("#")&&(e=(n=e.split("#"))[0],o=n[1]),!i)return e;for(t in-1===e.indexOf("?")&&(e+="?"),i)-1===e.indexOf(t)&&(e+="&"+t+"="+i[t]);return(e=e.replace("?&","?"))+(o?"#"+o:"")}function addInDB(n,t){self.indexedDB||log("IndexedDB is NOT supported");var i=self.indexedDB.open("growthrx",1);i.onsuccess=function(e){log("indexedDB open success",i.result);e=e.target.result.transaction(n,"readwrite"),e.onsuccess=function(e){log("indexedDB transaction success")},e=e.objectStore(n);e&&e.put(t)},i.onerror=function(e){log("indexedDB open error",i.error)},i.onupgradeneeded=function(e){e.target.result.createObjectStore(n,{keyPath:"key"}).transaction.oncomplete=function(e){}}}function getFromDB(i){return new Promise(function(n,e){self.indexedDB||(log("IndexedDB is NOT supported"),e());var t=self.indexedDB.open("growthrx",1);t.onsuccess=function(e){log("indexedDB open success",t.result);e=e.target.result.transaction(i,"readwrite"),e.onsuccess=e=e.objectStore(i);e&&(e.get("config").onsuccess=},t.onerror=t.onupgradeneeded=function(e){e.target.result.createObjectStore(i,{keyPath:"key"}).transaction.oncomplete=})}function send_msg_to_client(){var e;self.dispatchEvent&&arguments&&0<arguments.length&&"dispatch"===arguments[0]&&(e=new CustomEvent(arguments[1],{detail:arguments[2]}),self.dispatchEvent(e)),channel&&channel.send_message_to_client&&channel.send_message_to_client.apply(this,[].slice.call(arguments))}function track(n,t,i){switch((t=t||{}).grx_notificationType="PUSH",n){case"NOTI_DELIVERED":t.grx_notificationEventNameId=50,send_msg_to_client("dispatch","notification_received",t);break;case"NOTI_OPENED":t.grx_notificationEventNameId=60,send_msg_to_client("dispatch","notification_opened",t);break;case"NOTI_CLOSED":t.grx_notificationEventNameId=70,send_msg_to_client("dispatch","notification_closed",t)}return getFromDB("siteconfig").then(function(e){if(log("config data:",e),config=e){if(void 0!==config.projectCode)return e=getEventObject(n,"event",t=t||{},i),post(getUrl(),e,;log("please call grx.init() with projectCode before sending trackevent")}else log("config not available")})}function post(e,n,t){return fetch(e,{method:"post",headers:{"Content-type":"application/json;",sentAt:(new Date).getTime()},body:JSON.stringify(n)}).then(.then(.catch(}self.addEventListener("message",function(e){var n=e.data&&e.data.command;if(n)switch(n){case WorkerMessengerCommand.AMP_SUBSCRIPTION_STATE:onMessageReceivedSubscriptionState();break;case WorkerMessengerCommand.AMP_UNSUBSCRIBE:onMessageReceivedUnsubscribe()}else e.data&&"config"===e.data.key&&"growthrx"===e.data.sdk&&(config=e.data,log("Got config:"+JSON.stringify(config)),addInDB("siteconfig",config),channel.send_message_to_client=function(){e.ports&&0<e.ports.length&&e.ports[0]&&e.ports[0].postMessage&&e.ports[0].postMessage([].slice.call(arguments))},send_msg_to_client("log","Service worker messaging channel established",e.data),send_msg_to_client("dispatch","sw_ready")),e.data&&e.data.payload&&onMessageReceivedSubscriptionState()}),self.addEventListener("pushsubscriptionchange",;var getUrl=unction deviceCategory(){var e=navigator.userAgent;return-1<e.indexOf("iPad")||-1<e.indexOf("Android")&&-1===e.indexOf("Mobi")?"tablet":-1<e.indexOf("Phone")||-1<e.indexOf("Mobi")?"mobile":"desktop"}function getEventObject(e,n,t,i){return config?((t=t||{}).deviceCategory=deviceCategory(),t.subDomain=config.subDomain,t.timezone=Intl.DateTimeFormat().resolvedOptions().timeZone,{name:e,type:n,properties:t,nonInteraction:i,createdAt:(new Date).getTime(),insertId:generateUUID(),projectCode:config.projectCode,gid:config.anonymous_id,platform:config.platform,sdkVersion:config.sdkVersion,sdkBuild:config.sdkBuild,userId:config.userId}):{}}