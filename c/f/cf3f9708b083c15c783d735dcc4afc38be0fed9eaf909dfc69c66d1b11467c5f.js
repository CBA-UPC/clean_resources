(function(b,g){var h=Brid.Util;b.$bp.Chromecast=Brid.Abstract.extend({playerState:"IDLE",init:function a(c,d){a.base.call(this,c,d);b.__onGCastApiAvailable=this.$f(this.onApiAvailable);Brid.Loader.scriptLoad({isStyle:!1,url:"https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"})},onApiAvailable:function(a){Brid.log("Brid Chromecast onApiAvailable",a,"player.isReady",this.player.isReady);a&&chrome.cast&&(this.player.controls.addChild(new b.$bp.ChromecastButton(this.player)),
this.overlay=new b.$bp.ChromecastOverlay(this.player),this.player.playerHolder.addChild(this.overlay),this.monetize=this.player.config.monetize,a={},a.receiverApplicationId=chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,a.autoJoinPolicy=chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED,cast.framework.CastContext.getInstance().setOptions(a),this.remotePlayer=new cast.framework.RemotePlayer,this.remotePlayerController=new cast.framework.RemotePlayerController(this.remotePlayer),this.remotePlayerController.addEventListener(cast.framework.RemotePlayerEventType.IS_CONNECTED_CHANGED,
this.switchPlayer.bind(this)),this.remotePlayerController.addEventListener(cast.framework.RemotePlayerEventType.PLAYER_STATE_CHANGED,this.onRemotePlayerStateChanged.bind(this)),this.remotePlayerController.addEventListener(cast.framework.RemotePlayerEventType.IS_MUTED_CHANGED,this.onRemotePlayerMutedChanged.bind(this)),this.remotePlayerController.addEventListener(cast.framework.RemotePlayerEventType.VOLUME_LEVEL_CHANGED,this.onRemotePlayerVolumeChanged.bind(this)),this.remotePlayerController.addEventListener(cast.framework.RemotePlayerEventType.CURRENT_TIME_CHANGED,
this.onRemotePlayerCurrentTimeChanged.bind(this)),this.player.controls.playToggle.add("click",this.$f(this.onPlayToggleClick)),this.player.add("volumechange",this.$f(this.onVolumeChange)),this.player.add("seeked",this.$f(this.onSeeked)),this.player.add("newContent",this.$f(this.onNewContent)),b.addEventListener("beforeunload",this.$f(this.onPlayerClose)),Brid.log("Brid Chromecast remotePlayer",this.remotePlayer,"remotePlayerController",this.remotePlayerController))},switchPlayer:function(){Brid.log("Brid Chromecast switching player");
if(cast&&cast.framework){if(this.remotePlayer.isConnected){this.paused=this.player.paused();this.localPlayerTime=this.player.currentTime()||0;this.player.techCall("pause");this.castSession=cast.framework.CastContext.getInstance().getCurrentSession();this.load();return}Brid.log("Brid Chromecast disconnected")}Brid.log("Brid Chromecast setting current time to ",this.currentTime,this.playerState);this.castSession=!1;this.player.currentTime(this.currentTime||0);this.updateDisplayMessage();"PLAYING"==
this.playerState&&this.player.play();this.playerState="IDLE"},load:function(){var a=this.player.currentSource,c=new chrome.cast.media.MediaInfo(a.src,Brid.Util.getTypeFromFile(a.src));c.metadata=new chrome.cast.media.GenericMediaMetadata;c.metadata.metadataType=chrome.cast.media.MetadataType.GENERIC;c.metadata.title=a.title;c.metadata.images=[{url:a.poster||a.thumbnail}];var d=new chrome.cast.media.LoadRequest(c);Brid.log("Brid Chromecast load currentsource",a,"mediaInfo",c,"request",d);this.player.posterImage.posterEl&&
(this.player.posterImage.posterEl.src=a.poster||a.thumbnail);this.castSession.loadMedia(d).then(this.loaded.bind(this),function(a){this.playerState="ERROR";Brid.log("Brid Chromecast media load error: "+this.getErrorMessage(a))}.bind(this))},loaded:function(){Brid.log("Brid Chromecast media loaded");if(this.localPlayerTime||0===this.localPlayerTime)this.remotePlayer.currentTime=this.localPlayerTime,this.remotePlayerController.seek(),this.onRemotePlayerCurrentTimeChanged();(!this.paused&&this.remotePlayer.isPaused||
this.paused&&!this.remotePlayer.isPaused)&&this.remotePlayerController.playOrPause();this.lastSeekedPos=0;this.updateDisplayMessage()},onPlayToggleClick:function(){this.castSession&&("PLAYING"!==this.playerState&&"PAUSED"!==this.playerState&&"LOADED"!==this.playerState?this.load():this.remotePlayerController.playOrPause())},onVolumeChange:function(a){if(this.castSession){a=Brid.Util.round(this.remotePlayer.volumeLevel,1);var c=Brid.Util.round(this.player.volume(),1),d=this.player.muted();(d&&!this.remotePlayer.isMuted||
!d&&this.remotePlayer.isMuted)&&this.remotePlayerController.muteOrUnmute();Brid.Util.isMobilePlatform()||c==a||(this.remotePlayer.volumeLevel=c,this.remotePlayerController.setVolumeLevel())}},onSeeked:function(a){this.castSession&&(a=this.lastSeekedPos=this.player.currentTime()||0,this.remotePlayer.currentTime=a,this.remotePlayerController.seek())},onNewContent:onPlayerClose:
updateDisplayMessage:function(){if(this.castSession){this.player.addClass("brid-casting");var a=this.player.config.translate,c=a&&a.video?a.video.charAt(0).toUpperCase()+a.video.slice(1):"Video",d=a&&a.on?a.on:"on",a=a&&a[this.playerState.toLowerCase()]?a[this.playerState.toLowerCase()].toUpperCase():this.playerState;this.overlay.setMessage(c+" "+a+" "+d+" "+this.castSession.getCastDevice().friendlyName);this.player.posterImage.liveImageEl&&(this.player.posterImage.liveImageEl.style.opacity=0);this.player.posterImage.show();
this.player.config.monetize=!1}else this.player.removeClass("brid-casting"),this.player.posterImage.hide(),this.overlay.setMessage(""),this.player.config.monetize=this.monetize},getErrorMessage:function(a){switch(a){case chrome.cast.ErrorCode.API_NOT_INITIALIZED:return"The API is not initialized.";case chrome.cast.ErrorCode.CANCEL:return"The operation was canceled by the user";case chrome.cast.ErrorCode.CHANNEL_ERROR:return"A channel to the receiver is not available.";case chrome.cast.ErrorCode.EXTENSION_MISSING:return"The Cast extension is not available.";
case chrome.cast.ErrorCode.INVALID_PARAMETER:return"The parameters to the operation were not valid.";case chrome.cast.ErrorCode.RECEIVER_UNAVAILABLE:return"No receiver was compatible with the session request.";case chrome.cast.ErrorCode.SESSION_ERROR:return"A session could not be created, or a session was invalid.";case chrome.cast.ErrorCode.TIMEOUT:return"The operation timed out.";default:return"Other ("+a+")."}},onRemotePlayerStateChanged:function(){this.castSession&&(Brid.log("Brid Chromecast onRemotePlayerStateChanged",
this.remotePlayer.playerState),this.playerState=this.remotePlayer.playerState,this.updateDisplayMessage(),"IDLE"==this.remotePlayer.playerState&&0==this.remotePlayer.currentTime&&0==this.remotePlayer.duration&&1>Math.abs(this.currentTime-this.duration)?(Brid.log("Brid Chromecast video ended, isNextQueued",this.player.isNextQueued()),this.player.isNextQueued()?this.player.next():(this.localPlayerTime=0,this.player.controls.playToggle.toggleSkin("repeat"))):this.remotePlayer.isPaused?this.player.controls.playToggle.toggleSkin("play"):
this.player.controls.playToggle.toggleSkin("pause"))},onRemotePlayerMutedChanged:function(){if(this.castSession){var a=this.player.muted();this.remotePlayer.isMuted&&!a?this.player.muted(!0):!this.remotePlayer.isMuted&&a&&this.player.muted(!1)}},onRemotePlayerVolumeChanged:function(){if(this.castSession){var a=Brid.Util.round(this.remotePlayer.volumeLevel,1);Brid.Util.round(this.player.volume(),1)!=a&&this.player.volume(a)}},onRemotePlayerCurrentTimeChanged:function(){if(this.castSession&&!this.player.scrubbing&&
!this.player.values.isLive){this.remotePlayer.currentTime&&(this.currentTime=this.remotePlayer.currentTime);this.remotePlayer.duration&&(this.duration=this.remotePlayer.duration);var a=this.remotePlayer.currentTime==this.remotePlayer.duration?1:this.remotePlayer.currentTime/this.remotePlayer.duration,c=0==this.remotePlayer.duration?0:(this.lastSeekedPos||0)/this.remotePlayer.duration;Brid.Util.css(this.player.progressControl.seekBar.bar,{width:Brid.Util.round(100*(a-c),2)+"%",left:Brid.Util.round(100*
c,2)+"%"});this.player.progressControl.seekBar.scrubber&&Brid.Util.css(this.player.progressControl.seekBar.scrubber,{left:Brid.Util.round(100*a,2)+"%"});this.player.controls.currentTimeDisplay.content.innerHTML=Brid.Util.formatTime(Math.round(this.remotePlayer.currentTime))}}});Brid.ChromecastButton=Brid.Sprite.extend({init:createElement:);
Brid.ChromecastOverlay=Brid.Sprite.extend({init:function k(e,b){k.base.call(this,e,b);this.hide()},createElement:function e(){var b=e.base.call(this,"div",{className:"brid-chromecast-layer"});this.msg=h.createElement("div",{className:"brid-chromecast-status"});b.appendChild(this.msg);return b},setMessage:function(b){(this.msg.innerHTML=b)&&""!=b?this.show():this.hide()}});b.$bp.plugin("bridchromecast",function(e,f){e=e||this;f=f||{};e.isReady?e.addChild(new b.$bp.Chromecast(e,f)):b.$bp.Util.merge(e.config.children,
{Chromecast:{}})});Brid.event.trigger(g,"bridpluginloaded")})(window,document);
