var rudderanalytics=function(e){"use strict";function t(e){return null!=e&&"object"==typeof e&&!0===e["@@functional/placeholder"]}function n(e){return function n(r){return 0===arguments.length||t(r)?n:e.apply(this,arguments)}}function r(e){return function r(s,i){switch(arguments.length){case 0:return r;case 1:return t(s)?r:n((function(t){return e(s,t)}));default:return t(s)&&t(i)?r:t(s)?n((function(t){return e(t,i)})):t(i)?n((function(t){return e(s,t)})):e(s,i)}}}function s(e){return function s(i,o,a){switch(arguments.length){case 0:return s;case 1:return t(i)?s:r((function(t,n){return e(i,t,n)}));case 2:return t(i)&&t(o)?s:t(i)?r((function(t,n){return e(t,o,n)})):t(o)?r((function(t,n){return e(i,t,n)})):n((function(t){return e(i,o,t)}));default:return t(i)&&t(o)&&t(a)?s:t(i)&&t(o)?r((function(t,n){return e(t,n,a)})):t(i)&&t(a)?r((function(t,n){return e(t,o,n)})):t(o)&&t(a)?r((function(t,n){return e(i,t,n)})):t(i)?n((function(t){return e(t,o,a)})):t(o)?n((function(t){return e(i,t,a)})):t(a)?n((function(t){return e(i,o,t)})):e(i,o,a)}}}function i(e,t){return Object.prototype.hasOwnProperty.call(t,e)}var o=n((function(e){return null===e?"Null":void 0===e?"Undefined":Object.prototype.toString.call(e).slice(8,-1)}));function a(e){return"[object Object]"===Object.prototype.toString.call(e)}const l=Number.isInteger||function(e){return e<<0===e};var u=r((function(e,t){var n=e<0?t.length+e:e;return function(e){return"[object String]"===Object.prototype.toString.call(e)}(t)?t.charAt(n):t[n]}));function c(e,t,n){if(n||(n=new d),function(e){var t=typeof e;return null==e||"object"!=t&&"function"!=t}(e))return e;var r,s=function(r){var s=n.get(e);if(s)return s;for(var i in n.set(e,r),e)Object.prototype.hasOwnProperty.call(e,i)&&(r[i]=t?c(e[i],!0,n):e[i]);return r};switch(o(e)){case"Object":return s(Object.create(Object.getPrototypeOf(e)));case"Array":return s([]);case"Date":return new Date(e.valueOf());case"RegExp":return r=e,new RegExp(r.source,r.flags?r.flags:(r.global?"g":"")+(r.ignoreCase?"i":"")+(r.multiline?"m":"")+(r.sticky?"y":"")+(r.unicode?"u":"")+(r.dotAll?"s":""));case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"BigInt64Array":case"BigUint64Array":return e.slice();default:return e}}var d=function(){function e(){this.map={},this.length=0}return e.prototype.set=function(e,t){const n=this.hash(e);let r=this.map[n];r||(this.map[n]=r=[]),r.push([e,t]),this.length+=1},e.prototype.hash=function(e){let t=[];for(var n in e)t.push(Object.prototype.toString.call(e[n]));return t.join()},e.prototype.get=function(e){if(this.length<=180){for(const t in this.map){const n=this.map[t];for(let t=0;t<n.length;t+=1){const r=n[t];if(r[0]===e)return r[1]}}return}const t=this.hash(e),n=this.map[t];if(n)for(let t=0;t<n.length;t+=1){const r=n[t];if(r[0]===e)return r[1]}},e}(),g=n((function(e){return null!=e&&"function"==typeof e.clone?e.clone():c(e,!0)})),h=r((function(e,t){return e.map((function(e){for(var n,r=t,s=0;s<e.length;){if(null==r)return;n=e[s],r=l(n)?u(n,r):r[n],s+=1}return r}))})),p=r((function(e,t){return h([e],t)[0]})),f=s((function(e,t,n){var r,s={};for(r in n=n||{},t=t||{})i(r,t)&&(s[r]=i(r,n)?e(r,t[r],n[r]):t[r]);for(r in n)i(r,n)&&!i(r,s)&&(s[r]=n[r]);return s})),v=s((function e(t,n,r){return f((function(n,r,s){return a(r)&&a(s)?e(t,r,s):t(n,r,s)}),n,r)})),y=s((function(e,t,n){return v((function(t,n,r){return e(n,r)}),t,n)})),m=r((function(e,t){var n={};for(var r in t)e(t[r],r,t)&&(n[r]=t[r]);return n}));const b=e=>"function"==typeof e&&Boolean(e.constructor&&e.call&&e.apply),E=e=>"string"==typeof e,I=e=>null===e,S=e=>void 0===e,k=e=>I(e)||S(e),T=e=>!S(e),w=e=>!k(e),A=e=>e instanceof Error,P=(e,t)=>{const n=t.split(".");return p(n,e)},R=e=>!I(e)&&"object"==typeof e&&!Array.isArray(e),C=e=>!I(e)&&"[object Object]"===Object.prototype.toString.call(e),$=(e,t)=>{if(!Array.isArray(e)||!Array.isArray(t))return g(t);const n=g(e);return t.forEach(((e,t)=>{n[t]=Array.isArray(e)||R(e)?O(n[t],e):e})),n},O=(e,t)=>y($,e,t),D=e=>C(e)&&Object.keys(e).length>0,B=e=>{const t=m(T,e);return Object.keys(t).forEach((e=>{const n=t[e];C(n)&&(t[e]=B(n))})),t},M=e=>{const t=m(w,e);return Object.keys(t).forEach((e=>{const n=t[e];C(n)&&(t[e]=M(n))})),t},L=e=>{let t=e;if(!E(e)&&!k(e))try{t=JSON.stringify(e)}catch(e){t=null}return t},U=e=>(e=>{const t=Array.from(e,(e=>String.fromCodePoint(e))).join("");return globalThis.btoa(t)})((new TextEncoder).encode(e)),j=(e,t,n,r,s)=>{const i={category:e,name:t,properties:n,options:r};return b(s)&&(i.callback=s),b(r)&&(i.category=e,i.name=t,i.properties=n,delete i.options,i.callback=r),b(n)&&(i.category=e,i.name=t,delete i.properties,delete i.options,i.callback=n),b(t)&&(i.category=e,delete i.name,delete i.properties,delete i.options,i.callback=t),b(e)&&(delete i.category,delete i.name,delete i.properties,delete i.options,i.callback=e),C(e)?(delete i.name,delete i.category,i.properties=e,i.options=t):C(t)&&(delete i.name,i.properties=t,i.options=b(n)?null:n),E(e)&&!E(t)&&(delete i.category,i.name=e),T(i.category)||delete i.category,T(i.name)||delete i.name,i.properties=i.properties?g(i.properties):{},T(i.options)?i.options=g(i.options):delete i.options,i.properties=O(C(i.properties)?i.properties:{},{name:E(i.name)?i.name:null,category:E(i.category)?i.category:null}),i},N=(e,t,n,r)=>{const s={name:e,properties:t,options:n};return b(r)&&(s.callback=r),b(n)&&(s.properties=t,delete s.options,s.callback=n),b(t)&&(delete s.properties,delete s.options,s.callback=t),s.properties=w(s.properties)?g(s.properties):{},T(s.options)?s.options=g(s.options):delete s.options,s},H=(e,t,n,r)=>{const s={userId:e,traits:t,options:n};return b(r)&&(s.callback=r),b(n)&&(s.userId=e,s.traits=t,delete s.options,s.callback=n),b(t)&&(s.userId=e,delete s.traits,delete s.options,s.callback=t),(C(e)||I(e))&&(s.userId=null,s.traits=e,s.options=t),T(s.userId)?s.userId=L(s.userId):delete s.userId,C(s.traits)?s.traits=g(s.traits):delete s.traits,T(s.options)?s.options=g(s.options):delete s.options,s},x=(e,t,n,r)=>{const s={to:e,from:t,options:n};return b(r)&&(s.callback=r),b(n)&&(s.to=e,s.from=t,delete s.options,s.callback=n),b(t)?(s.to=e,delete s.from,delete s.options,s.callback=t):(C(t)||I(t))&&(s.to=e,delete s.from,s.options=t),b(e)?(delete s.to,delete s.from,delete s.options,s.callback=e):(C(e)||I(e))&&(delete s.to,delete s.from,s.options=e),T(s.to)?s.to=L(s.to):delete s.to,T(s.from)?s.from=L(s.from):delete s.from,T(s.options)?s.options=g(s.options):delete s.options,s},_=(e,t,n,r)=>{const s={groupId:e,traits:t,options:n};return b(r)&&(s.callback=r),b(n)&&(s.groupId=e,s.traits=t,delete s.options,s.callback=n),b(t)&&(s.groupId=e,delete s.traits,delete s.options,s.callback=t),b(e)?(s.groupId=null,delete s.traits,delete s.options,s.callback=e):(C(e)||I(e))&&(s.groupId=null,s.traits=e,s.options=b(t)?null:t),T(s.groupId)?s.groupId=L(s.groupId):delete s.groupId,s.traits=C(s.traits)?g(s.traits):{},T(s.options)?s.options=g(s.options):delete s.options,s},F="CapabilitiesManager",Q="ConfigManager",K="EventManager",G="PluginsManager",z="UserSessionManager",V="ErrorHandler",q="PluginEngine",W="StoreManager",J="RudderStackApplication",X="AnalyticsCore",Z="RudderLabs JavaScript SDK",Y="3.0.0-beta.20",ee="RudderJS-Initiated",te="preloadedEventsBuffer",ne="ajs_aid",re="ajs_uid",se="ajs_event",ie=18e5,oe=(e="app")=>{globalThis.RudderStackGlobals||(globalThis.RudderStackGlobals={}),globalThis.RudderStackGlobals[e]||(globalThis.RudderStackGlobals[e]={})},ae=(e,t,n="app")=>{oe(n),globalThis.RudderStackGlobals[n][e]=t};const le=(e,t)=>{const n={};return e.forEach(((r,s)=>{if(s.startsWith(t)){const r=s.substring(t.length);n[r]=e.get(s)}})),n},ue=e=>{const t=((e,t="app")=>(oe(t),globalThis.RudderStackGlobals[t][e]))(te)||[];((e=[])=>{const t="ajs_trait_",n="ajs_prop_",r=new URLSearchParams(globalThis.location.search);r.get(se)&&e.unshift(["track",r.get(se),le(r,n)]),r.get(re)&&e.unshift(["identify",r.get(re),le(r,t)]),r.get(ne)&&e.unshift(["setAnonymousId",r.get(ne)])})(t),t.length>0&&(e.enqueuePreloadBufferEvents(t),ae(te,[]))},ce=(e,t)=>{const n=e.shift();let r;if(b(t[n])){switch(n){case"page":r=j(...e);break;case"track":r=N(...e);break;case"identify":r=H(...e);break;case"alias":r=x(...e);break;case"group":r=_(...e);break;default:t[n](...e)}r&&t[n](r)}},de=":: ",ge=(e,t)=>`Failed to load the script with the id "${e}" from URL "${t}".`,he=(e,t,n)=>{const r=[];return function(s,i){if(!(t?.includes(s)||e&&k(i))){if("object"!=typeof i||I(i))return i;for(;r.length>0&&r[r.length-1]!==this;)r.pop();return r.includes(i)?(n?.warn(((e,t)=>`${e}${de}A circular reference has been detected in the object and the property "${t}" has been dropped from the output.`)("JSONStringify",s)),"[Circular Reference]"):(r.push(i),i)}}},pe=(e,t,n,r)=>{try{return JSON.stringify(e,he(t,n,r))}catch(e){return r?.warn("Failed to convert the value to a JSON string.",e),null}},fe=(e,t)=>{let n=e;return A(e)?n.message=`${t}: ${e.message}`:n=new Error(`${t}: ${pe(e)}`),n},ve=(e,t,n,r=!0,s)=>new Promise(((i,o)=>{document.getElementById(t)&&o(new Error((e=>`A script with the id "${e}" is already loaded. Skipping the loading of this script to prevent conflicts.`)(t)));try{let a;(e=>{const t=document.getElementsByTagName("head");if(t.length>0)return void t[0]?.insertBefore(e,t[0]?.firstChild);const n=document.getElementsByTagName("script");if(n.length>0&&n[0]?.parentNode)return void n[0]?.parentNode.insertBefore(e,n[0]);const r=document.createElement("head");r.appendChild(e);const s=document.getElementsByTagName("html")[0];s?.insertBefore(r,s.firstChild)})(((e,t,n=!0,r=null,s=null,i={})=>{const o=document.createElement("script");return o.type="text/javascript",o.onload=r,o.onerror=s,o.src=e,o.id=t,o.async=n,o.setAttribute("data-append-origin","RS_JS_SDK"),Object.keys(i).forEach((e=>{o.setAttribute(e,i[e])})),o})(e,t,r,(()=>{globalThis.clearTimeout(a),i(t)}),(()=>{globalThis.clearTimeout(a),o(new Error(ge(t,e)))}),s)),a=globalThis.setTimeout((()=>{o(new Error(((e,t,n)=>`A timeout of ${n} ms occurred while trying to load the script with id "${e}" from URL "${t}".`)(t,e,n)))}),n)}catch(n){o(fe(n,ge(t,e)))}}));class ye{hasErrorHandler=!1;constructor(e,t,n=1e4){this.errorHandler=e,this.logger=t,this.timeout=n,this.hasErrorHandler=Boolean(this.errorHandler),this.onError=this.onError.bind(this)}loadJSFile(e){const{url:t,id:n,timeout:r,async:s,callback:i,extraAttributes:o}=e,a=!b(i);ve(t,n,r||this.timeout,s,o).then((e=>{a||i(e)})).catch((e=>{this.onError(e),a||i()}))}onError(e){if(!this.hasErrorHandler)throw e;this.errorHandler?.onError(e,"ExternalSrcLoader")}}function me(){throw new Error("Cycle detected")}var be=Symbol.for("preact-signals");function Ee(){if(Te>1)Te--;else{for(var e,t=!1;void 0!==ke;){var n=ke;for(ke=void 0,we++;void 0!==n;){var r=n.o;if(n.o=void 0,n.f&=-3,!(8&n.f)&&$e(n))try{n.c()}catch(n){t||(e=n,t=!0)}n=r}}if(we=0,Te--,t)throw e}}function Ie(e){if(Te>0)return e();Te++;try{return e()}finally{Ee()}}var Se=void 0,ke=void 0,Te=0,we=0,Ae=0;function Pe(e){if(void 0!==Se){var t=e.n;if(void 0===t||t.t!==Se)return t={i:0,S:e,p:Se.s,n:void 0,t:Se,e:void 0,x:void 0,r:t},void 0!==Se.s&&(Se.s.n=t),Se.s=t,e.n=t,32&Se.f&&e.S(t),t;if(-1===t.i)return t.i=0,void 0!==t.n&&(t.n.p=t.p,void 0!==t.p&&(t.p.n=t.n),t.p=Se.s,t.n=void 0,Se.s.n=t,Se.s=t),t}}function Re(e){this.v=e,this.i=0,this.n=void 0,this.t=void 0}function Ce(e){return new Re(e)}function $e(e){for(var t=e.s;void 0!==t;t=t.n)if(t.S.i!==t.i||!t.S.h()||t.S.i!==t.i)return!0;return!1}function Oe(e){for(var t=e.s;void 0!==t;t=t.n){var n=t.S.n;if(void 0!==n&&(t.r=n),t.S.n=t,t.i=-1,void 0===t.n){e.s=t;break}}}function De(e){for(var t=e.s,n=void 0;void 0!==t;){var r=t.p;-1===t.i?(t.S.U(t),void 0!==r&&(r.n=t.n),void 0!==t.n&&(t.n.p=r)):n=t,t.S.n=t.r,void 0!==t.r&&(t.r=void 0),t=r}e.s=n}function Be(e){Re.call(this,void 0),this.x=e,this.s=void 0,this.g=Ae-1,this.f=4}function Me(e){var t=e.u;if(e.u=void 0,"function"==typeof t){Te++;var n=Se;Se=void 0;try{t()}catch(t){throw e.f&=-2,e.f|=8,Le(e),t}finally{Se=n,Ee()}}}function Le(e){for(var t=e.s;void 0!==t;t=t.n)t.S.U(t);e.x=void 0,e.s=void 0,Me(e)}function Ue(e){if(Se!==this)throw new Error("Out-of-order effect");De(this),Se=e,this.f&=-2,8&this.f&&Le(this),Ee()}function je(e){this.x=e,this.u=void 0,this.s=void 0,this.o=void 0,this.f=32}function Ne(e){var t=new je(e);try{t.c()}catch(e){throw t.d(),e}return t.d.bind(t)}Re.prototype.brand=be,Re.prototype.h=function(){return!0},Re.prototype.S=function(e){this.t!==e&&void 0===e.e&&(e.x=this.t,void 0!==this.t&&(this.t.e=e),this.t=e)},Re.prototype.U=function(e){if(void 0!==this.t){var t=e.e,n=e.x;void 0!==t&&(t.x=n,e.e=void 0),void 0!==n&&(n.e=t,e.x=void 0),e===this.t&&(this.t=n)}},Re.prototype.subscribe=function(e){var t=this;return Ne((function(){var n=t.value,r=32&this.f;this.f&=-33;try{e(n)}finally{this.f|=r}}))},Re.prototype.valueOf=function(){return this.value},Re.prototype.toString=function(){return this.value+""},Re.prototype.toJSON=function(){return this.value},Re.prototype.peek=function(){return this.v},Object.defineProperty(Re.prototype,"value",{get:function(){var e=Pe(this);return void 0!==e&&(e.i=this.i),this.v},set:function(e){if(Se instanceof Be&&function(){throw new Error("Computed cannot have side-effects")}(),e!==this.v){we>100&&me(),this.v=e,this.i++,Ae++,Te++;try{for(var t=this.t;void 0!==t;t=t.x)t.t.N()}finally{Ee()}}}}),(Be.prototype=new Re).h=function(){if(this.f&=-3,1&this.f)return!1;if(32==(36&this.f))return!0;if(this.f&=-5,this.g===Ae)return!0;if(this.g=Ae,this.f|=1,this.i>0&&!$e(this))return this.f&=-2,!0;var e=Se;try{Oe(this),Se=this;var t=this.x();(16&this.f||this.v!==t||0===this.i)&&(this.v=t,this.f&=-17,this.i++)}catch(e){this.v=e,this.f|=16,this.i++}return Se=e,De(this),this.f&=-2,!0},Be.prototype.S=function(e){if(void 0===this.t){this.f|=36;for(var t=this.s;void 0!==t;t=t.n)t.S.S(t)}Re.prototype.S.call(this,e)},Be.prototype.U=function(e){if(void 0!==this.t&&(Re.prototype.U.call(this,e),void 0===this.t)){this.f&=-33;for(var t=this.s;void 0!==t;t=t.n)t.S.U(t)}},Be.prototype.N=function(){if(!(2&this.f)){this.f|=6;for(var e=this.t;void 0!==e;e=e.x)e.t.N()}},Be.prototype.peek=function(){if(this.h()||me(),16&this.f)throw this.v;return this.v},Object.defineProperty(Be.prototype,"value",{get:function(){1&this.f&&me();var e=Pe(this);if(this.h(),void 0!==e&&(e.i=this.i),16&this.f)throw this.v;return this.v}}),je.prototype.c=function(){var e=this.S();try{if(8&this.f)return;if(void 0===this.x)return;var t=this.x();"function"==typeof t&&(this.u=t)}finally{e()}},je.prototype.S=function(){1&this.f&&me(),this.f|=1,this.f&=-9,Me(this),Oe(this),Te++;var e=Se;return Se=this,Ue.bind(this,e)},je.prototype.N=function(){2&this.f||(this.f|=2,this.o=ke,ke=this)},je.prototype.d=function(){this.f|=8,1&this.f||Le(this)};class He{constructor(){this.items=[]}enqueue(e){this.items.push(e)}dequeue(){return 0===this.items.length?null:this.items.shift()}isEmpty(){return 0===this.items.length}size(){return this.items.length}clear(){this.items=[]}}const xe={LOG:0,INFO:1,DEBUG:2,WARN:3,ERROR:4,NONE:5},_e="ERROR";const Fe=new class{constructor(e=_e,t="",n=console){this.minLogLevel=xe[e],this.scope=t,this.logProvider=n}log(...e){this.outputLog("LOG",e)}info(...e){this.outputLog("INFO",e)}debug(...e){this.outputLog("DEBUG",e)}warn(...e){this.outputLog("WARN",e)}error(...e){this.outputLog("ERROR",e)}outputLog(e,t){this.minLogLevel<=xe[e]&&this.logProvider[e.toLowerCase()]?.(...this.formatLogData(t))}setScope(e){this.scope=e||this.scope}setMinLogLevel(e){this.minLogLevel=xe[e],S(this.minLogLevel)&&(this.minLogLevel=xe[_e])}formatLogData(e){if(Array.isArray(e)&&e.length>0){let t="%c RS SDK";this.scope&&(t=`${t} - ${this.scope}`);t=`${t} %c ${E(e[0])?e[0].trim():""}`;const n=[t,"font-weight: bold; background: black; color: white;","font-weight: normal;"];return E(e[0])||n.push(e[0]),n.push(...e.slice(1)),n}return e}},Qe=["localStorage","memoryStorage","cookieStorage","sessionStorage","none"],Ke="cookieStorage",Ge="Unable to process/parse source configuration response.",ze=(e,t,n)=>`${e} due to timeout or no connection (${t?t.type:""}) for URL: ${n}.`,Ve="Failed to invoke the ready callback",qe="js-integrations",We="plugins",Je="modern",Xe="https://cdn.rudderlabs.com",Ze=`${Xe}/beta/3.0.0-beta/${Je}/${qe}`,Ye=`${Xe}/beta/3.0.0-beta/${Je}/${We}`,et="https://api.rudderstack.com",tt="bugsnag",nt="v3",rt={oneTrust:"OneTrustConsentManager",ketch:"KetchConsentManager",custom:"CustomConsentManager"},st={[tt]:"Bugsnag"},it={[nt]:"StorageEncryption",legacy:"StorageEncryptionLegacy"},ot=Ce(g({logLevel:"ERROR",configUrl:et,loadIntegration:!0,sessions:{autoTrack:!0,timeout:ie},sameSiteCookie:"Lax",polyfillIfRequired:!0,integrations:{All:!0},useBeacon:!1,beaconQueueOptions:{},destinationsQueueOptions:{},queueOptions:{},lockIntegrationsVersion:!1,uaChTrackLevel:"none",plugins:[],useGlobalIntegrationsConfigInEvents:!1,bufferDataPlaneEventsUntilReady:!1,dataPlaneEventsBufferTimeout:1e4,storage:{encryption:{version:nt},migrate:!1},sendAdblockPageOptions:{}})),at={userId:"rl_user_id",userTraits:"rl_trait",anonymousId:"rl_anonymous_id",groupId:"rl_group_id",groupTraits:"rl_group_trait",initialReferrer:"rl_page_init_referrer",initialReferringDomain:"rl_page_init_referring_domain",sessionInfo:"rl_session",authToken:"rl_auth_token"},lt={userId:"",userTraits:{},anonymousId:"",groupId:"",groupTraits:{},initialReferrer:"",initialReferringDomain:"",sessionInfo:{},authToken:null},ut={autoTrack:!0,timeout:ie},ct={userId:Ce(lt.userId),userTraits:Ce(lt.userTraits),anonymousId:Ce(lt.anonymousId),groupId:Ce(lt.groupId),groupTraits:Ce(lt.groupTraits),initialReferrer:Ce(lt.initialReferrer),initialReferringDomain:Ce(lt.initialReferringDomain),sessionInfo:Ce(lt.sessionInfo),authToken:Ce(lt.authToken)},dt={isOnline:Ce(!0),storage:{isLocalStorageAvailable:Ce(!1),isCookieStorageAvailable:Ce(!1),isSessionStorageAvailable:Ce(!1)},isBeaconAvailable:Ce(!1),isLegacyDOM:Ce(!1),isUaCHAvailable:Ce(!1),isCryptoAvailable:Ce(!1),isIE11:Ce(!1),isAdBlocked:Ce(!1)},gt={isErrorReportingEnabled:Ce(!1),isMetricsReportingEnabled:Ce(!1),errorReportingProviderPluginName:Ce(void 0),isErrorReportingPluginLoaded:Ce(!1)},ht=Ce(void 0),pt={activeDataplaneUrl:Ce(void 0),integrationsCDNPath:Ce(Ze),pluginsCDNPath:Ce(Ye),sourceConfigUrl:Ce(void 0),status:Ce(void 0),initialized:Ce(!1),logLevel:Ce("ERROR"),loaded:Ce(!1),readyCallbacks:Ce([]),writeKey:Ce(void 0),dataPlaneUrl:Ce(void 0)},ft={enabled:Ce(!1),initialized:Ce(!1),data:Ce({}),activeConsentManagerPluginName:Ce(void 0),preConsent:Ce({enabled:!1}),postConsent:Ce({}),resolutionStrategy:Ce("and"),provider:Ce(void 0),metadata:Ce(void 0)},vt={retries:Ce(0),dropped:Ce(0),sent:Ce(0),queued:Ce(0),triggered:Ce(0)},yt={app:Ce({name:Z,namespace:"com.rudderlabs.javascript",version:Y}),traits:Ce(null),library:Ce({name:Z,version:Y,snippetVersion:globalThis.RudderSnippetVersion}),userAgent:Ce(""),device:Ce(null),network:Ce(null),os:Ce({name:"",version:""}),locale:Ce(null),screen:Ce({density:0,width:0,height:0,innerWidth:0,innerHeight:0}),"ua-ch":Ce(void 0),timezone:Ce(void 0)},mt={configuredDestinations:Ce([]),activeDestinations:Ce([]),loadOnlyIntegrations:Ce({}),failedDestinations:Ce([]),loadIntegration:Ce(!0),initializedDestinations:Ce([]),clientDestinationsReady:Ce(!1),integrationsConfig:Ce({})},bt={toBeProcessedArray:Ce([]),readyCallbacksArray:Ce([])},Et={ready:Ce(!1),loadedPlugins:Ce([]),failedPlugins:Ce([]),pluginsToLoadFromConfig:Ce([]),activePlugins:Ce([]),totalPluginsToLoad:Ce(0)},It={encryptionPluginName:Ce(void 0),migrate:Ce(!1),type:Ce(void 0),cookie:Ce(void 0),entries:Ce({}),trulyAnonymousTracking:Ce(!1)},St={...g({capabilities:dt,consents:ft,context:yt,eventBuffer:bt,lifecycle:pt,loadOptions:ot,metrics:vt,nativeDestinations:mt,plugins:Et,reporting:gt,session:ct,source:ht,storage:It})};const kt=new class{plugins=[];byName={};cache={};config={throws:!0};constructor(e={},t){this.config={throws:!0,...e},this.logger=t}register(e,t){if(!e.name){const t=`${q}${de}Plugin name is missing.`;if(this.config.throws)throw new Error(t);this.logger?.error(t,e)}if(this.byName[e.name]){const t=((e,t)=>`${e}${de}Plugin "${t}" already exists.`)(q,e.name);if(this.config.throws)throw new Error(t);this.logger?.error(t)}this.cache={},this.plugins=this.plugins.slice();let n=this.plugins.length;this.plugins.forEach(((t,r)=>{t.deps?.includes(e.name)&&(n=Math.min(n,r))})),this.plugins.splice(n,0,e),this.byName[e.name]=e,b(e.initialize)&&e.initialize(t)}unregister(e){const t=this.byName[e];if(!t){const t=`${q}${de}Plugin "${e}" not found.`;if(this.config.throws)throw new Error(t);this.logger?.error(t)}const n=this.plugins.indexOf(t);if(-1===n){const t=((e,t)=>`${e}${de}Plugin "${t}" not found in plugins but found in byName. This indicates a bug in the plugin engine. Please report this issue to the development team.`)(q,e);if(this.config.throws)throw new Error(t);this.logger?.error(t)}this.cache={},delete this.byName[e],this.plugins=this.plugins.slice(),this.plugins.splice(n,1)}getPlugin(e){return this.byName[e]}getPlugins(e){const t=e??".";return this.cache[t]||(this.cache[t]=this.plugins.filter((e=>{if(e.deps?.some((e=>!this.byName[e]))){const t=e.deps.filter((e=>!this.byName[e]));return this.logger?.error(((e,t,n)=>`${e}${de}Plugin "${t}" could not be loaded because some of its dependencies "${n}" do not exist.`)(q,e.name,t)),!1}return"."===t||((e,t)=>Boolean(P(e,t)))(e,t)}))),this.cache[t]}processRawPlugins(e){e(this.plugins),this.cache={}}invoke(e,t=!0,...n){let r=e;if(!r)throw new Error("Failed to invoke plugin because the extension point name is missing.");const s=r.startsWith("!"),i=this.config.throws??r.endsWith("!");if(r=r.replace(/(^!|!$)/g,""),!r)throw new Error("Failed to invoke plugin because the extension point name is invalid.");const o=r.split(".");o.pop();const a=o.join(".");return(t?this.getPlugins(r):[this.getPlugins(r)[0]]).map((e=>{const t=P(e,r);if(!b(t)||s)return t;try{return t.apply(P(e,a),n)}catch(t){if(i)throw t;this.logger?.error(((e,t,n)=>`${e}${de}Failed to invoke the "${t}" extension point of plugin "${n}".`)(q,r,e.name),t)}return null}))}invokeSingle(e,...t){return this.invoke(e,!1,...t)[0]}invokeMultiple(e,...t){return this.invoke(e,!0,...t)}}({throws:!0},Fe),Tt="The request failed",wt=[Tt];const At=new class{constructor(e,t){this.logger=e,this.pluginEngine=t,this.errorBuffer=new He,this.attachEffect()}attachEffect(){if(!0===St.reporting.isErrorReportingPluginLoaded.value)for(;this.errorBuffer.size()>0;)this.errorBuffer.dequeue()}attachErrorListeners(){"addEventListener"in globalThis?(globalThis.addEventListener("error",(e=>{this.onError(e,void 0,void 0,void 0,"unhandledException")})),globalThis.addEventListener("unhandledrejection",(e=>{this.onError(e,void 0,void 0,void 0,"unhandledPromiseRejection")}))):this.logger?.debug("Failed to attach global error listeners.")}init(e){if(this.pluginEngine)try{const t="errorReporting.init",n=this.pluginEngine.invokeSingle(t,St,this.pluginEngine,e,this.logger);n instanceof Promise&&n.then((e=>{this.errReportingClient=e})).catch((e=>{this.logger?.error(`${V}${de}Failed to initialize the error reporting plugin.`,e)}))}catch(e){this.onError(e,V)}}onError(e,t="",n="",r=!1,s="handled"){let i=(e=>{let t;try{if(E(e))t=e;else if(e instanceof Error)t=e.message;else if(e instanceof ErrorEvent)t=e.message;else if(e instanceof Event){const n=e.target;if(n&&"script"!==n.localName)return"";if(n?.dataset&&("RS_JS_SDK"!==n.dataset.loader||"true"!==n.dataset.isnonnativesdk))return"";t=`Error in loading a third-party script from URL ${n?.src} with ID ${n?.id}.`}else t=e.message?e.message:pe(e)}catch(e){t=`Unknown error: ${e.message}`}return t})(e);if(!i)return;i=`${t}${de}${n} ${i}`.replace(/ {2,}/g," ");let o=new Error(i);if(A(e)&&(o=Object.create(e,{message:{value:i}})),"handled"===s){if(this.notifyError(o),!this.logger)throw o;if(this.logger.error(i),r)throw o}St.reporting.isErrorReportingEnabled.value&&St.reporting.isErrorReportingPluginLoaded.value}leaveBreadcrumb(e){if(this.pluginEngine)try{this.pluginEngine.invokeSingle("errorReporting.breadcrumb",this.pluginEngine,this.errReportingClient,e,this.logger)}catch(e){this.onError(e,V,"errorReporting.breadcrumb")}}notifyError(e){if(this.pluginEngine&&(e=>!e.message||!wt.some((t=>e.message.includes(t))))(e))try{this.pluginEngine.invokeSingle("errorReporting.notify",this.pluginEngine,this.errReportingClient,e,St,this.logger)}catch(e){this.logger?.error(`${V}${de}Failed to notify the error.`,e)}}}(Fe,kt),Pt=e=>Boolean("cloud"!==e.config.connectionMode||!0===e.config.useNativeSDKToSend||!0===e.config.useNativeSDK),Rt=["BeaconQueue","Bugsnag","CustomConsentManager","DeviceModeDestinations","DeviceModeTransformation","ErrorReporting","ExternalAnonymousId","GoogleLinker","KetchConsentManager","NativeDestinationQueue","OneTrustConsentManager","StorageEncryption","StorageEncryptionLegacy","StorageMigrator","XhrQueue"],Ct={rudderAnalyticsRemotePlugins:{url:()=>Promise.resolve(window.RudderStackGlobals&&window.RudderStackGlobals.app&&window.RudderStackGlobals.app.pluginsCDNPath?window.RudderStackGlobals.app.pluginsCDNPath+"/rsa-plugins.js":"https://cdn.rudderlabs.com/beta/3.0.0-beta/modern/plugins/rsa-plugins.js"),format:"esm",from:"vite"}},$t=async(e,t)=>{const n="function"==typeof e?await e():e,r=document.createElement("script");r.type="text/javascript",r.onload=t,r.src=n,document.getElementsByTagName("head")[0].appendChild(r)},Ot=e=>({});function Dt(e,t){if(!e?.default&&t){let t=Object.create(null);return t.default=e,t.__esModule=!0,t}return e}function Bt(e,t){return async function(e){const t=Ct[e];return t.inited?t.lib:"var"===t.format?new Promise((n=>$t(t.url,(()=>{t.inited||(t.lib=window[e],t.lib.init(Ot(t.from)),t.inited=!0),n(t.lib)})))):["esm","systemjs"].includes(t.format)?new Promise(((e,n)=>{("function"==typeof t.url?t.url:()=>Promise.resolve(t.url))().then((r=>{import(r).then((n=>{if(!t.inited){const e=Ot(t.from);n.init(e),t.lib=n,t.lib.init(e),t.inited=!0}e(t.lib)})).catch(n)}))})):void 0}(e).then((e=>e.get(t).then((e=>e()))))}const Mt=e=>{const t={};return e.forEach((e=>{if(Rt.includes(e)){const n=(e=>{switch(e){case"BeaconQueue":return()=>Bt("rudderAnalyticsRemotePlugins","./BeaconQueue").then((e=>Dt(e,!0)));case"Bugsnag":return()=>Bt("rudderAnalyticsRemotePlugins","./Bugsnag").then((e=>Dt(e,!0)));case"CustomConsentManager":return()=>Bt("rudderAnalyticsRemotePlugins","./CustomConsentManager").then((e=>Dt(e,!0)));case"DeviceModeDestinations":return()=>Bt("rudderAnalyticsRemotePlugins","./DeviceModeDestinations").then((e=>Dt(e,!0)));case"DeviceModeTransformation":return()=>Bt("rudderAnalyticsRemotePlugins","./DeviceModeTransformation").then((e=>Dt(e,!0)));case"ErrorReporting":return()=>Bt("rudderAnalyticsRemotePlugins","./ErrorReporting").then((e=>Dt(e,!0)));case"ExternalAnonymousId":return()=>Bt("rudderAnalyticsRemotePlugins","./ExternalAnonymousId").then((e=>Dt(e,!0)));case"GoogleLinker":return()=>Bt("rudderAnalyticsRemotePlugins","./GoogleLinker").then((e=>Dt(e,!0)));case"KetchConsentManager":return()=>Bt("rudderAnalyticsRemotePlugins","./KetchConsentManager").then((e=>Dt(e,!0)));case"NativeDestinationQueue":return()=>Bt("rudderAnalyticsRemotePlugins","./NativeDestinationQueue").then((e=>Dt(e,!0)));case"OneTrustConsentManager":return()=>Bt("rudderAnalyticsRemotePlugins","./OneTrustConsentManager").then((e=>Dt(e,!0)));case"StorageEncryption":return()=>Bt("rudderAnalyticsRemotePlugins","./StorageEncryption").then((e=>Dt(e,!0)));case"StorageEncryptionLegacy":return()=>Bt("rudderAnalyticsRemotePlugins","./StorageEncryptionLegacy").then((e=>Dt(e,!0)));case"StorageMigrator":return()=>Bt("rudderAnalyticsRemotePlugins","./StorageMigrator").then((e=>Dt(e,!0)));case"XhrQueue":return()=>Bt("rudderAnalyticsRemotePlugins","./XhrQueue").then((e=>Dt(e,!0)));default:return}})(e);n&&(t[e]=n)}})),t},Lt=e=>Mt?.(e)||{},Ut={};class jt{constructor(e,t,n){this.engine=e,this.errorHandler=t,this.logger=n,this.onError=this.onError.bind(this)}init(){St.lifecycle.status.value="pluginsLoading",ae("pluginsCDNPath",St.lifecycle.pluginsCDNPath.value),this.setActivePlugins(),this.registerLocalPlugins(),this.registerRemotePlugins(),this.attachEffects()}attachEffects(){Ne((()=>{(0===St.plugins.activePlugins.value.length||St.plugins.loadedPlugins.value.length+St.plugins.failedPlugins.value.length===St.plugins.totalPluginsToLoad.value)&&Ie((()=>{St.plugins.ready.value=!0,St.lifecycle.status.value="pluginsReady"}))}))}getPluginsToLoadBasedOnConfig(){let e=St.plugins.pluginsToLoadFromConfig.value;if(!e)return[];const t=Object.values(st);var n;e=St.reporting.errorReportingProviderPluginName.value?e.filter((e=>!(e!==St.reporting.errorReportingProviderPluginName.value&&t.includes(e)))):e.filter((e=>!("ErrorReporting"===e||t.includes(e)))),!0===St.loadOptions.value.useBeacon&&St.capabilities.isBeaconAvailable.value?e=e.filter((e=>"XhrQueue"!==e)):(!0===St.loadOptions.value.useBeacon&&this.logger?.warn(`${G}${de}The Beacon API is not supported by your browser. The events will be sent using XHR instead.`),e=e.filter((e=>"BeaconQueue"!==e))),e.includes("XhrQueue")||e.includes("BeaconQueue")||e.push("XhrQueue"),0===(n=St.nativeDestinations.configuredDestinations.value??[],n.filter(Pt)).length&&(e=e.filter((e=>!["DeviceModeDestinations","DeviceModeTransformation","NativeDestinationQueue"].includes(e))));const r=Object.values(rt);let s=e=>!(e!==St.consents.activeConsentManagerPluginName.value&&r.includes(e));St.consents.enabled.value||(s=e=>!r.includes(e)),e=e.filter(s);const i=Object.values(it);return e=e.filter((e=>!(e!==St.storage.encryptionPluginName.value&&i.includes(e)))),St.storage.migrate.value||(e=e.filter((e=>"StorageMigrator"!==e))),[...Object.keys({}),...e]}setActivePlugins(){const e=this.getPluginsToLoadBasedOnConfig(),t=[...Object.keys(Ut),...Rt],n=[],r=[];e.forEach((e=>{t.includes(e)?n.push(e):r.push(e)})),r.length>0&&this.onError(new Error(`Ignoring loading of unknown plugins: ${r.join(",")}. Mandatory plugins: ${Object.keys({}).join(",")}. Load option plugins: ${St.plugins.pluginsToLoadFromConfig.value.join(",")}`)),Ie((()=>{St.plugins.totalPluginsToLoad.value=e.length,St.plugins.activePlugins.value=n,St.plugins.failedPlugins.value=r}))}registerLocalPlugins(){Object.values(Ut).forEach((e=>{b(e)&&St.plugins.activePlugins.value.includes(e().name)&&this.register([e()])}))}registerRemotePlugins(){const e=(t=St.plugins.activePlugins.value,{...Lt(t)});var t;Promise.all(Object.keys(e).map((async t=>{await e[t]().then((e=>this.register([e.default()]))).catch((e=>{St.plugins.failedPlugins.value=[...St.plugins.failedPlugins.value,t],this.onError(e,t)}))}))).catch((e=>{this.onError(e)}))}invokeMultiple(e,...t){try{return this.engine.invokeMultiple(e,...t)}catch(t){return this.onError(t,e),[]}}invokeSingle(e,...t){try{return this.engine.invokeSingle(e,...t)}catch(t){return this.onError(t,e),null}}register(e){e.forEach((e=>{try{this.engine.register(e,St)}catch(t){St.plugins.failedPlugins.value=[...St.plugins.failedPlugins.value,e.name],this.onError(t)}}))}unregisterLocalPlugins(){Object.values(Ut).forEach((e=>{try{this.engine.unregister(e().name)}catch(e){this.onError(e)}}))}onError(e,t){if(!this.errorHandler)throw e;this.errorHandler.onError(e,G,t)}}const Nt=(e,t)=>{try{return JSON.parse(e||"")}catch(e){const n=fe(e,"Failed to parse response data");if(!b(t))throw n;t(n)}},Ht={headers:{Accept:"application/json","Content-Type":"application/json;charset=UTF-8"},method:"GET"},xt=(e,t,n)=>{const r=O(Ht,t||{});return n&&(r.headers=O(r.headers,{Authorization:n})),r.url=e,r},_t=(e,t=1e4,n)=>new Promise(((r,s)=>{let i;if(!0===e.sendRawData)i=e.data;else if(i=pe(e.data,!1,[],n),I(i))return void s({error:new Error("Failed to prepare data for the request."),undefined:void 0,options:e});const o=new XMLHttpRequest,a=t=>{s({error:new Error(ze(Tt,t,e.url)),xhr:o,options:e})};o.ontimeout=a,o.onerror=a,o.onload=()=>{var t,n,i,a;o.status>=200&&o.status<400?r({response:o.responseText,xhr:o,options:e}):s({error:new Error((t=Tt,n=o.status,i=o.statusText,a=e.url,`${t} with status: ${n}, ${i} for URL: ${a}.`)),xhr:o,options:e})},o.open(e.method,e.url),o.timeout=t,Object.keys(e.headers).forEach((t=>{e.headers[t]&&o.setRequestHeader(t,e.headers[t])}));try{o.send(i)}catch(t){s({error:fe(t,(l=Tt,u=e.url,`${l} for URL: ${u}`)),xhr:o,options:e})}var l,u}));class Ft{hasErrorHandler=!1;constructor(e,t){this.errorHandler=e,this.logger=t,this.hasErrorHandler=Boolean(this.errorHandler),this.onError=this.onError.bind(this)}async getData(e){const{url:t,options:n,timeout:r,isRawResponse:s}=e;try{const e=await _t(xt(t,n,this.basicAuthHeader),r,this.logger);return{data:s?e.response:Nt(e.response,this.onError),details:e}}catch(e){return this.onError(e.error??e),{data:void 0,details:e}}}getAsyncData(e){const{callback:t,url:n,options:r,timeout:s,isRawResponse:i}=e,o=!b(t);_t(xt(n,r,this.basicAuthHeader),s,this.logger).then((e=>{o||t(i?e.response:Nt(e.response,this.onError),e)})).catch((e=>{this.onError(e.error??e),o||t(void 0,e)}))}onError(e){if(!this.hasErrorHandler)throw e;this.errorHandler?.onError(e,"HttpClient")}setAuthHeader(e,t=!1){const n=t?e:U(`${e}:`);this.basicAuthHeader=`Basic ${n}`}resetAuthHeader(){this.basicAuthHeader=void 0}}const Qt=new Ft(At,Fe),Kt="cookieStorage",Gt="localStorage",zt="sessionStorage",Vt="memoryStorage",qt="none",Wt="clientDataInCookie",Jt="clientDataInLocalStorage",Xt="clientDataInSessionStorage",Zt=["userId","userTraits","anonymousId","groupId","groupTraits","initialReferrer","initialReferringDomain","sessionInfo","authToken"],Yt={[Kt]:Wt,[Gt]:Jt,[Vt]:"clientDataInMemory",[zt]:Xt},en=()=>!k(globalThis.navigator.userAgentData),tn={URL:()=>!b(globalThis.URL)||!globalThis.URLSearchParams,MutationObserver:()=>S(MutationObserver),Promise:()=>S(Promise),"Number.isNaN":()=>!Number.isNaN,"Number.isInteger":()=>!Number.isInteger,"Array.from":()=>!Array.from,"Array.prototype.find":()=>!Array.prototype.find,"Array.prototype.includes":()=>!Array.prototype.includes,"String.prototype.endsWith":()=>!String.prototype.endsWith,"String.prototype.startsWith":()=>!String.prototype.startsWith,"String.prototype.includes":()=>!String.prototype.includes,"Object.entries":()=>!Object.entries,"Object.values":()=>!Object.values,"Object.assign":()=>"function"!=typeof Object.assign,"Element.prototype.dataset":()=>!(()=>{const e=document.createElement("div");return e.setAttribute("data-a-b","c"),!!e.dataset&&"c"===e.dataset.aB})(),"String.prototype.replaceAll":()=>!String.prototype.replaceAll,TextEncoder:()=>S(TextEncoder)||S(TextDecoder),"String.fromCodePoint":()=>!String.fromCodePoint,requestAnimationFrame:()=>!b(globalThis.requestAnimationFrame)||!b(globalThis.cancelAnimationFrame),CustomEvent:()=>!b(globalThis.CustomEvent),"navigator.sendBeacon":()=>!b(navigator.sendBeacon),ArrayBuffer:()=>!b(Uint8Array)},nn=()=>{let e={density:0,width:0,height:0,innerWidth:0,innerHeight:0};return e={width:globalThis.screen.width,height:globalThis.screen.height,density:globalThis.devicePixelRatio,innerWidth:globalThis.innerWidth,innerHeight:globalThis.innerHeight},e},rn=e=>{const t=["QuotaExceededError","NS_ERROR_DOM_QUOTA_REACHED"].includes(e.name)||[22,1014].includes(e.code);return e instanceof DOMException&&t},sn=(e=Gt,t,n)=>{let r,s;try{switch(e){case Vt:return!0;case Kt:r=t,s="test_rudder_cookie";break;case Gt:r=t??globalThis.localStorage,s="test_rudder_ls";break;case zt:r=t??globalThis.sessionStorage,s="test_rudder_ss";break;default:return!1}return!!r&&(r.setItem(s,"true"),!!r.getItem(s)&&(r.removeItem(s),!0))}catch(t){const r=`${F}${de}The "${e}" storage type is `;let s="unavailable";return rn(t)&&(s="full"),n?.error(`${r}${s}.`,t),!1}},on=(e,t)=>{try{return encodeURIComponent(e)}catch(e){return void t?.error("Failed to encode the cookie data.",e)}},an=e=>{try{return decodeURIComponent(e)}catch(e){return}},ln=()=>(e=>{const t={},n=e.split(/\s*;\s*/);let r;return n[0]?(n.forEach((e=>{r=e.split("=");const n=r[0]?an(r[0]):void 0;n&&(t[n]=r[1]?an(r[1]):void 0)})),t):t})(globalThis.document.cookie),un=function(e,t,n,r){switch(arguments.length){case 4:case 3:case 2:return((e,t,n,r)=>{const s={...n}||{};let i=`${on(e,r)}=${on(t,r)}`;I(t)&&(s.maxage=-1),s.maxage&&(s.expires=new Date(+new Date+s.maxage)),s.path&&(i+=`; path=${s.path}`),s.domain&&(i+=`; domain=${s.domain}`),s.expires&&(i+=`; expires=${s.expires.toUTCString()}`),s.samesite&&(i+=`; samesite=${s.samesite}`),s.secure&&(i+="; secure"),globalThis.document.cookie=i})(e,t,n,r);case 1:return e?(e=>ln()[e])(e):ln();default:return ln()}},cn=e=>{const t="function"!=typeof globalThis.URL?(e=>{const t=document.createElement("a");return t.href=e,t.hostname})(e):new URL(e).hostname,n=t?.split(".")??[],r=n[n.length-1],s=[];if(4===n.length&&r&&r===parseInt(r,10).toString())return s;if(n.length<=1)return n[0]&&-1!==n[0].indexOf("localhost")?["localhost"]:s;for(let e=n.length-2;e>=0;e-=1)s.push(n.slice(e).join("."));return s},dn=()=>{const e=(e=>{const t=cn(e);for(let e=0;e<t.length;e+=1){const n=t[e],r="__tld__",s={domain:`${-1!==n.indexOf("localhost")?"":"."}${n}`};if(un(r,1,s),un(r))return un(r,null,s),n}return""})(globalThis.location.href);return{maxage:31536e6,path:"/",domain:e&&"."!==e?e:void 0,samesite:"Lax",enabled:!0}};class gn{static globalSingleton=null;isSupportAvailable=!0;isEnabled=!0;length=0;constructor(e={},t){if(gn.globalSingleton)return gn.globalSingleton;this.options=dn(),this.logger=t,this.configure(e),gn.globalSingleton=this}configure(e){return this.options=O(this.options??{},e),e.sameDomainCookiesOnly&&delete this.options.domain,this.isSupportAvailable=sn(Kt,this,this.logger),this.isEnabled=Boolean(this.options.enabled&&this.isSupportAvailable),this.options}setItem(e,t){return un(e,t,this.options,this.logger),this.length=Object.keys(un()).length,!0}getItem(e){const t=un(e);return S(t)?null:t}removeItem(e){const t=this.setItem(e,null);return this.length=Object.keys(un()).length,t}clear(){}key(e){const t=un(),n=Object.keys(t);return S(n[e])?null:n[e]}}const hn=new class{isEnabled=!0;length=0;data={};constructor(e,t){this.options={enabled:!0},this.logger=t,this.configure(e??{})}configure(e){return this.options=O(this.options,e),this.isEnabled=Boolean(this.options.enabled),this.options}setItem(e,t){return this.data[e]=t,this.length=Object.keys(this.data).length,t}getItem(e){return e in this.data?this.data[e]:null}removeItem(e){return e in this.data&&delete this.data[e],this.length=Object.keys(this.data).length,null}clear(){this.data={},this.length=0}key(e){return Object.keys(this.data)[e]?Object.keys(this.data)[e]:null}}({},Fe);"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function pn(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var fn={exports:{}};fn.exports=function(){function e(e){return e=JSON.stringify(e),!!/^\{[\s\S]*\}$/.test(e)}function t(e){return void 0===e||"function"==typeof e?e+"":JSON.stringify(e)}function n(e){if("string"==typeof e)try{return JSON.parse(e)}catch(t){return e}}function r(e){return"[object Function]"==={}.toString.call(e)}function s(e){return"[object Array]"===Object.prototype.toString.call(e)}function i(e){var t="_Is_Incognit",n="yes";try{e||(e=window.localStorage),e.setItem(t,n),e.removeItem(t)}catch(t){var r={_data:{},setItem:function(e,t){return r._data[e]=String(t)},getItem:function(e){return r._data.hasOwnProperty(e)?r._data[e]:void 0},removeItem:function(e){return delete r._data[e]},clear:function(){return r._data={}}};e=r}finally{e.getItem(t)===n&&e.removeItem(t)}return e}var o=i();function a(){if(!(this instanceof a))return new a}a.prototype={set:function(n,r){if(n&&!e(n))o.setItem(n,t(r));else if(e(n))for(var s in n)this.set(s,n[s]);return this},get:function(e){if(void 0===e){var t={};return this.forEach((function(e,n){return t[e]=n})),t}if("?"===e.charAt(0))return this.has(e.substr(1));var r=arguments;if(r.length>1){for(var s={},i=0,a=r.length;i<a;i++){var l=n(o.getItem(r[i]));this.has(r[i])&&(s[r[i]]=l)}return s}return n(o.getItem(e))},clear:function(){return o.clear(),this},remove:function(e){var t=this.get(e);return o.removeItem(e),t},has:function(e){return{}.hasOwnProperty.call(this.get(),e)},keys:function(){var e=[];return this.forEach((function(t){e.push(t)})),e},forEach:function(e){for(var t=0,n=o.length;t<n;t++){var r=o.key(t);e(r,this.get(r))}return this},search:function(e){for(var t=this.keys(),n={},r=0,s=t.length;r<s;r++)t[r].indexOf(e)>-1&&(n[t[r]]=this.get(t[r]));return n}};var l=null;function u(t,n){var i=arguments,o=null;if(l||(l=a()),0===i.length)return l.get();if(1===i.length){if("string"==typeof t)return l.get(t);if(e(t))return l.set(t)}if(2===i.length&&"string"==typeof t){if(!n)return l.remove(t);if(n&&"string"==typeof n)return l.set(t,n);n&&r(n)&&(o=null,o=n(t,l.get(t)),u.set(t,o))}if(2===i.length&&s(t)&&r(n))for(var c=0,d=t.length;c<d;c++)o=n(t[c],l.get(t[c])),u.set(t[c],o);return u}for(var c in a.prototype)u[c]=a.prototype[c];return u}();const vn=pn(fn.exports);const yn=new class{isSupportAvailable=!0;isEnabled=!0;length=0;constructor(e={},t){this.options={enabled:!0},this.logger=t,this.configure(e)}configure(e){return this.options=O(this.options,e),this.isSupportAvailable=sn(Gt,this,this.logger),this.isEnabled=Boolean(this.options.enabled&&this.isSupportAvailable),this.options}setItem(e,t){vn.set(e,t),this.length=vn.keys().length}getItem(e){const t=vn.get(e);return S(t)?null:t}removeItem(e){vn.remove(e),this.length=vn.keys().length}clear(){vn.clear(),this.length=0}key(e){return vn.keys()[e]?vn.keys()[e]:null}}({},Fe);const mn=new class{isSupportAvailable=!0;isEnabled=!0;length=0;store=globalThis.sessionStorage;constructor(e={},t){this.options={enabled:!0},this.logger=t,this.configure(e)}configure(e){return this.options=O(this.options,e),this.isSupportAvailable=sn(zt,this,this.logger),this.isEnabled=Boolean(this.options.enabled&&this.isSupportAvailable),this.options}setItem(e,t){this.store.setItem(e,t),this.length=this.store.length}getItem(e){const t=this.store.getItem(e);return S(t)?null:t}removeItem(e){this.store.removeItem(e),this.length=this.store.length}clear(){this.store.clear(),this.length=0}key(e){return this.store.key(e)}}({},Fe),bn=e=>{switch(e){case Gt:return yn;case zt:return mn;case Vt:return hn;case Kt:return new gn({},Fe);default:return hn}},En=(e={},t={},n={},r={})=>{var s;s=e,new gn({},Fe).configure(s),(e=>{yn.configure(e)})(t),(e=>{hn.configure(e)})(n),(e=>{mn.configure(e)})(r)};class In{hasErrorHandler=!1;constructor(e,t,n){this.id=e.id,this.name=e.name,this.isEncrypted=e.isEncrypted??!1,this.validKeys=e.validKeys??{},this.engine=t??bn(Gt),this.noKeyValidation=0===Object.keys(this.validKeys).length,this.noCompoundKey=e.noCompoundKey,this.originalEngine=this.engine,this.errorHandler=e.errorHandler??At,this.hasErrorHandler=Boolean(this.errorHandler),this.logger=e.logger??Fe,this.pluginsManager=n}createValidKey(e){const{name:t,id:n,validKeys:r,noKeyValidation:s,noCompoundKey:i}=this;if(s)return i?e:[t,n,e].join(".");let o;return Object.values(r).forEach((r=>{r===e&&(o=i?e:[t,n,e].join("."))})),o}swapQueueStoreToInMemoryEngine(){const{name:e,id:t,validKeys:n,noCompoundKey:r}=this,s=bn(Vt);Object.keys(n).forEach((i=>{const o=this.get(n[i]),a=r?i:[e,t,i].join(".");s.setItem(a,o),this.remove(i)})),this.engine=s}set(e,t){const n=this.createValidKey(e);if(n)try{this.engine.setItem(n,this.encrypt(pe(t,!1,[],this.logger)))}catch(n){rn(n)?(this.logger?.warn(`${`Store ${this.id}`}${de}The storage is either full or unavailable, so the data will not be persisted. Switching to in-memory storage.`),this.swapQueueStoreToInMemoryEngine(),this.set(e,t)):this.onError(fe(n,(e=>`Failed to save the value for "${e}" to storage`)(e)))}}get(e){const t=this.createValidKey(e);try{if(!t)return null;const e=this.decrypt(this.engine.getItem(t));return k(e)?null:JSON.parse(e)}catch(t){return this.onError(new Error(`${(e=>`Failed to retrieve or parse data for "${e}" from storage`)(e)}: ${t.message}`)),null}}remove(e){const t=this.createValidKey(e);t&&this.engine.removeItem(t)}getOriginalEngine(){return this.originalEngine}decrypt(e){return k(e)?null:this.crypto(e,"decrypt")}encrypt(e){return this.crypto(e,"encrypt")}crypto(e,t){const n=!this.isEncrypted||!e||"string"!=typeof e||""===(e=>e.replace(/^\s+|\s+$/gm,""))(e);if(n)return e;const r=`storage.${t}`,s=this.pluginsManager?this.pluginsManager.invokeSingle(r,e):e;return void 0===s?e:s??""}onError(e){if(!this.hasErrorHandler)throw e;this.errorHandler?.onError(e,`Store ${this.id}`)}}class Sn{stores={};isInitialized=!1;hasErrorHandler=!1;constructor(e,t,n){this.errorHandler=t,this.logger=n,this.hasErrorHandler=Boolean(this.errorHandler),this.pluginsManager=e,this.onError=this.onError.bind(this)}init(){if(this.isInitialized)return;const e=St.loadOptions.value,t={cookieStorageOptions:{samesite:e.sameSiteCookie,secure:e.secureCookie,domain:e.setCookieDomain,sameDomainCookiesOnly:e.sameDomainCookiesOnly,enabled:!0},localStorageOptions:{enabled:!0},inMemoryStorageOptions:{enabled:!0},sessionStorageOptions:{enabled:!0}};En(B(O(t.cookieStorageOptions??{},St.storage.cookie?.value??{})),B(t.localStorageOptions),B(t.inMemoryStorageOptions),B(t.sessionStorageOptions)),this.initClientDataStores(),this.isInitialized=!0}initClientDataStores(){this.initializeStorageState();[Vt,Gt,Kt,zt].forEach((e=>{bn(e)?.isEnabled&&this.setStore({id:Yt[e],name:Yt[e],isEncrypted:!0,noCompoundKey:!0,type:e})}))}initializeStorageState(){let e=St.storage.type.value,t=St.loadOptions.value.storage?.entries;const n=St.consents.postConsent.value.storage;(T(n?.type)||T(n?.entries))&&(e=n?.type,t=n?.entries);let r=!0,s={};Zt.forEach((n=>{const i=n,o=n,a=t?.[i]?.type,l=((e,t)=>{let n;if(e.consents.preConsent.value.enabled)switch(e.consents.preConsent.value.storage?.strategy){case"none":n=qt;break;case"session":"sessionInfo"!==t&&(n=qt);break;case"anonymousId":"anonymousId"!==t&&(n=qt)}return n})(St,n),u=l??a??e??Ke,c=this.getResolvedStorageTypeForEntry(u,n);c!==qt&&(r=!1),s={...s,[n]:{type:c,key:at[o]}}})),Ie((()=>{St.storage.type.value=e,St.storage.entries.value=s,St.storage.trulyAnonymousTracking.value=r}))}getResolvedStorageTypeForEntry(e,t){let n=e;switch(e){case Gt:bn(Gt)?.isEnabled||(n=Vt);break;case zt:bn(zt)?.isEnabled||(n=Vt);break;case Vt:case qt:break;default:n=bn(Kt)?.isEnabled?Kt:bn(Gt)?.isEnabled?Gt:bn(zt)?.isEnabled?zt:Vt}return n!==e&&this.logger?.warn(((e,t,n,r)=>`${e}${de}The storage type "${n}" is not available for entry "${t}". The SDK will initialize the entry with "${r}" storage type instead.`)(W,t,e,n)),n}setStore(e){const t=bn(e.type);return this.stores[e.id]=new In(e,t,this.pluginsManager),this.stores[e.id]}getStore(e){return this.stores[e]}onError(e){if(!this.hasErrorHandler)throw e;this.errorHandler?.onError(e,W)}}const kn=e=>e&&e.endsWith("/")?kn(e.substring(0,e.length-1)):e,Tn=e=>{try{const t=new URL(e);return Boolean(t)}catch(e){return!1}},wn=e=>{let t="";try{t=new URL(e).host}catch(e){}return t},An=e=>{const t={};try{const n=new URL(e),r="utm_";n.searchParams.forEach(((e,n)=>{if(n.startsWith(r)){let s=n.substring(r.length);"campaign"===s&&(s="name"),t[s]=e}}))}catch(e){}return t},Pn=(e,t)=>{(e=>{if(!E(e)||0===e.trim().length)throw new Error((e=>`The write key "${e}" is invalid. It must be a non-empty string. Please check that the write key is correct and try again.`)(e))})(e),(e=>{if(e&&!Tn(e))throw new Error((e=>`The data plane URL "${e}" is invalid. It must be a valid URL string. Please check that the data plane URL is correct and try again.`)(e))})(t)},Rn=["BeaconQueue","Bugsnag","CustomConsentManager","DeviceModeDestinations","DeviceModeTransformation","ErrorReporting","ExternalAnonymousId","GoogleLinker","KetchConsentManager","NativeDestinationQueue","OneTrustConsentManager","StorageEncryption","StorageEncryptionLegacy","StorageMigrator","XhrQueue"],Cn=e=>"number"==typeof e&&!Number.isNaN(e),$n=e=>Cn(e)&&e>=0&&Number.isInteger(e),On=(e,t,n,r)=>{const s=new URLSearchParams({p:"cdn",v:Y,build:Je,writeKey:t,lockIntegrationsVersion:n.toString()});let i=et,o=s,a="/sourceConfig/",l="";if(e)try{const t=new URL(e);kn(t.pathname).endsWith("/sourceConfig")||(t.pathname=`${kn(t.pathname)}/sourceConfig/`),t.pathname=t.pathname.replace(/\/{2,}/g,"/"),s.forEach(((e,n)=>{null===t.searchParams.get(n)&&t.searchParams.set(n,e)})),i=t.origin,a=t.pathname,o=t.searchParams,l=t.hash}catch(t){r?.warn(((e,t)=>`${e}${de}The provided config URL "${t}" is invalid. Using the default value instead.`)(Q,e))}return`${i}${a}?${o}${l}`},Dn="US",Bn=(e,t)=>{if(!e||["US","EU"].includes(e))return e;t?.warn(`${Q}${de}The residency server region "${e}" is not supported. Please choose one of the following supported regions: "US, EU". The default region "${Dn}" will be used instead.`)},Mn=(e,t,n,r)=>{if(e&&Object.keys(e).length>0){const t=(e=>{if(Array.isArray(e)&&e.length>0){const t=e.find((e=>!0===e.default));if(t&&Tn(t.url))return t.url}})(e[Bn(n,r)??Dn]||e[Dn]);if(t)return t}if(t)return t},Ln="none",Un="immediate",jn={All:!0},Nn=e=>D(e)||Array.isArray(e),Hn=(e,t)=>{let{provider:n}=e;const r=rt[n];var s;return n&&!r&&(t?.error((s=rt,`${Q}${de}The consent manager "${n}" is not supported. Please choose one of the following supported consent managers: "${Object.keys(s)}".`)),n=void 0),{provider:n,consentManagerPluginName:r}},xn=(e,t)=>{let n,r,s=[],i=[],o=!1,a=!0===e?.enabled;D(e)&&a&&(({provider:r,consentManagerPluginName:n}=Hn(e,t)),Nn(e.allowedConsentIds)&&(s=e.allowedConsentIds,o=!0),Nn(e.deniedConsentIds)&&(i=e.deniedConsentIds,o=!0));const l={allowedConsentIds:s,deniedConsentIds:i};return a=a&&Boolean(n),{provider:r,consentManagerPluginName:n,initialized:o,enabled:a,consentsData:l}},_n=()=>{const e=document.getElementsByTagName("script");let t;return Array.prototype.slice.call(e).some((e=>{const n=kn(e.getAttribute("src"));if(n){if(n.match(/^.*rsa?(\.min)?\.js$/))return t=n,!0}return!1})),t},Fn=(e,t)=>{var n,r,s;if(St.reporting.isErrorReportingEnabled.value=!(n=e.source.config,!0!==n?.statsCollection?.errors?.enabled||window.chrome&&window.chrome.runtime&&window.chrome.runtime.id),St.reporting.isMetricsReportingEnabled.value=(e=>!0===e?.statsCollection?.metrics?.enabled)(e.source.config),St.reporting.isErrorReportingEnabled.value){const n=(e=>e?.statsCollection?.errors?.provider)(e.source.config),i=n?st[n]:void 0;S(n)||i||t?.warn((r=st,s=tt,`${Q}${de}The error reporting provider "${n}" is not supported. Please choose one of the following supported providers: "${Object.keys(r)}". The default provider "${s}" will be used instead.`)),St.reporting.errorReportingProviderPluginName.value=i??st[tt]}},Qn=e=>{const t=St.loadOptions.value.storage;let n=t?.type;T(n)&&!(e=>"string"==typeof e&&Qe.includes(e))(n)&&(e?.warn(((e,t,n)=>`${e}${de}The storage type "${t}" is not supported. Please choose one of the following supported types: "${Qe}". The default type "${n}" will be used instead.`)(Q,n,Ke)),n=Ke);let r=t?.encryption?.version;const s=r&&it[r];var i,o;!S(r)&&S(s)?(e?.warn((i=it,o=nt,`${Q}${de}The storage encryption version "${r}" is not supported. Please choose one of the following supported versions: "${Object.keys(i)}". The default version "${o}" will be used instead.`)),r=nt):S(r)&&(r=nt);const a=t?.migrate,l=a&&r===nt;!0===a&&l!==a&&e?.warn(((e,t,n)=>`${e}${de}The storage data migration has been disabled because the configured storage encryption version (${t}) is not the latest (${n}). To enable storage data migration, please update the storage encryption version to the latest version.`)(Q,r,nt)),Ie((()=>{St.storage.type.value=n,St.storage.cookie.value=t?.cookie,St.storage.encryptionPluginName.value=it[r],St.storage.migrate.value=l}))},Kn=e=>{const{provider:t,consentManagerPluginName:n,initialized:r,enabled:s,consentsData:i}=xn(St.loadOptions.value.consentManagement,e),o=St.loadOptions.value.preConsent;let a=o?.storage?.strategy??Ln;var l,u;T(a)&&!["none","session","anonymousId"].includes(a)&&(a=Ln,e?.warn((l=Q,u=o?.storage?.strategy,`${l}${de}The pre-consent storage strategy "${u}" is not supported. Please choose one of the following supported strategies: "none, session, anonymousId". The default strategy "${Ln}" will be used instead.`)));let c=o?.events?.delivery??Un;T(c)&&!["immediate","buffer"].includes(c)&&(c=Un,e?.warn(((e,t,n)=>`${e}${de}The pre-consent events delivery type "${t}" is not supported. Please choose one of the following supported types: "immediate, buffer". The default type "${n}" will be used instead.`)(Q,o?.events?.delivery,Un))),Ie((()=>{St.consents.activeConsentManagerPluginName.value=n,St.consents.initialized.value=r,St.consents.enabled.value=s,St.consents.data.value=i,St.consents.provider.value=t,St.consents.preConsent.value={enabled:!0===St.loadOptions.value.preConsent?.enabled&&!1===r&&!0===s,storage:{strategy:a},events:{delivery:c}}}))};class Gn{hasErrorHandler=!1;constructor(e,t,n){this.errorHandler=t,this.logger=n,this.httpClient=e,this.hasErrorHandler=Boolean(this.errorHandler),this.onError=this.onError.bind(this),this.processConfig=this.processConfig.bind(this)}attachEffects(){Ne((()=>{this.logger?.setMinLogLevel(St.lifecycle.logLevel.value)}))}init(){this.attachEffects(),Pn(St.lifecycle.writeKey.value,St.lifecycle.dataPlaneUrl.value);const e=St.loadOptions.value.lockIntegrationsVersion,t=((e,t,n)=>{let r="";if(n){if(r=kn(n),!r||r&&!Tn(r))throw new Error("Failed to load the SDK as the CDN base URL for integrations is not valid.");return r}const s=_n();return r=s&&E(s)?s.split("/").slice(0,-1).concat(qe).join("/"):Ze,t&&(r=r.replace("v3",e)),r})(Y,e,St.loadOptions.value.destSDKBaseURL),n=(e=>{let t="";if(e){if(t=kn(e),!t||t&&!Tn(t))throw new Error("Failed to load the SDK as the CDN base URL for plugins is not valid.");return t}const n=_n();return t=n&&E(n)?n.split("/").slice(0,-1).concat(We).join("/"):Ye,t})(St.loadOptions.value.pluginsSDKBaseURL);Qn(this.logger),Kn(this.logger),Ie((()=>{St.lifecycle.integrationsCDNPath.value=t,St.lifecycle.pluginsCDNPath.value=n,St.loadOptions.value.logLevel&&(St.lifecycle.logLevel.value=St.loadOptions.value.logLevel),St.lifecycle.sourceConfigUrl.value=On(St.loadOptions.value.configUrl,St.lifecycle.writeKey.value,e,this.logger)})),this.getConfig()}onError(e,t,n){if(!this.hasErrorHandler)throw e;this.errorHandler?.onError(e,Q,t,n)}processConfig(e,t){if(!e)return void this.onError((n=t?.error,`Failed to fetch the source config. Reason: ${n}`));var n;let r;try{r=E(e)?JSON.parse(e):e}catch(e){return void this.onError(e,Ge,!0)}if(!(e=>C(e)&&C(e.source)&&!k(e.source.id)&&C(e.source.config)&&Array.isArray(e.source.destinations))(r))return void this.onError(new Error(Ge),void 0,!0);Fn(r,this.logger);const s=Mn(r.source.dataplanes,St.lifecycle.dataPlaneUrl.value,St.loadOptions.value.residencyServer,this.logger);if(!s)return void this.onError(new Error("Failed to load the SDK as the data plane URL could not be determined. Please check that the data plane URL is set correctly and try again."),void 0,!0);const i=r.source.destinations.length>0?(e=>{const t=[];return e.forEach((e=>{e.enabled&&!e.deleted&&t.push({id:e.id,displayName:e.destinationDefinition.displayName,config:e.config,shouldApplyDeviceModeTransformation:e.shouldApplyDeviceModeTransformation||!1,propagateEventsUntransformedOnError:e.propagateEventsUntransformedOnError||!1,userFriendlyId:`${e.destinationDefinition.displayName.replaceAll(" ","-")}___${e.id}`})})),t})(r.source.destinations):[];Ie((()=>{St.source.value={config:r.source.config,id:r.source.id},St.nativeDestinations.configuredDestinations.value=i,St.plugins.pluginsToLoadFromConfig.value=St.loadOptions.value.plugins??[],(e=>{let t,n=St.consents.resolutionStrategy.value;C(e.consentManagementMetadata)&&(St.consents.provider.value&&(n=e.consentManagementMetadata.providers.find((e=>e.provider===St.consents.provider.value))?.resolutionStrategy??St.consents.resolutionStrategy.value),t=e.consentManagementMetadata),"custom"===St.consents.provider.value&&(n=void 0),Ie((()=>{St.consents.metadata.value=g(t),St.consents.resolutionStrategy.value=n}))})(r),St.lifecycle.activeDataplaneUrl.value=kn(s),St.lifecycle.status.value="configured"}))}getConfig(){const e=St.loadOptions.value.getSourceConfig;if(e){if(!b(e))throw new Error('"getSourceConfig" must be a function. Please make sure that it is defined and returns a valid source configuration object.');const t=e();t instanceof Promise?t.then((e=>this.processConfig(e))).catch((e=>{this.onError(e,"SourceConfig")})):this.processConfig(t)}else this.httpClient.getAsyncData({url:St.lifecycle.sourceConfigUrl.value,options:{headers:{"Content-Type":void 0}},callback:this.processConfig})}}const zn=()=>document?.referrer||"$direct",Vn=()=>{const e=(()=>{const e=document.getElementsByTagName("link");let t="";for(let n=0;e[n];n+=1){const r=e[n];if("canonical"===r.getAttribute("rel")&&!t){t=r.getAttribute("href")??"";break}}return t})();let t=globalThis.location.pathname;const{href:n}=globalThis.location;let r=n;const{search:s}=globalThis.location;if(e)try{const n=new URL(e);r=""===n.search?e+s:e,t=n.pathname}catch(e){}const i=(e=>{let t=e;try{const n=new URL(e);t=n.origin+n.pathname+n.search}catch(e){}return t})(r),{title:o}=document,a=zn();return{path:t,referrer:a,referring_domain:wn(a),search:s,title:o,url:i,tab_url:n}},qn=`https://polyfill.io/v3/polyfill.min.js?version=3.111.0&features=${Object.keys(tn).join("%2C")}`,Wn="rudderstackPolyfill";class Jn{constructor(e,t){this.logger=t,this.errorHandler=e,this.externalSrcLoader=new ye(this.errorHandler,this.logger),this.onError=this.onError.bind(this),this.onReady=this.onReady.bind(this)}init(){try{this.prepareBrowserCapabilities(),this.attachWindowListeners()}catch(e){this.onError(e)}}detectBrowserCapabilities(){Ie((()=>{St.capabilities.storage.isCookieStorageAvailable.value=sn(Kt,bn(Kt),this.logger),St.capabilities.storage.isLocalStorageAvailable.value=sn(Gt,void 0,this.logger),St.capabilities.storage.isSessionStorageAvailable.value=sn(zt,void 0,this.logger),St.capabilities.isBeaconAvailable.value=!k(globalThis.navigator.sendBeacon)&&b(globalThis.navigator.sendBeacon),St.capabilities.isUaCHAvailable.value=en(),St.capabilities.isCryptoAvailable.value=!k(globalThis.crypto)&&b(globalThis.crypto.getRandomValues),St.capabilities.isIE11.value=Boolean(globalThis.navigator.userAgent.match(/Trident.*rv:11\./)),St.capabilities.isOnline.value=globalThis.navigator.onLine,St.context.userAgent.value=(()=>{if(S(globalThis.navigator))return null;let{userAgent:e}=globalThis.navigator;const{brave:t}=globalThis.navigator;if(t&&Object.getPrototypeOf(t).isBrave){const t=e.match(/(chrome)\/([\w.]+)/i);t&&(e=`${e} Brave/${t[2]}`)}return e})(),St.context.locale.value=S(globalThis.navigator)?null:globalThis.navigator.language??globalThis.navigator.browserLanguage,St.context.screen.value=nn(),St.context.timezone.value=(()=>{const e=(new Date).toString().match(/([A-Z]+[+-]\d+)/);return e&&e[1]?e[1]:"NA"})(),en()&&((e,t="none")=>{"none"===t&&e(void 0),"default"===t&&e(navigator.userAgentData),"full"===t&&navigator.userAgentData?.getHighEntropyValues(["architecture","bitness","brands","mobile","model","platform","platformVersion","uaFullVersion","fullVersionList","wow64"]).then((t=>{e(t)})).catch((()=>{e()}))})((e=>{St.context["ua-ch"].value=e}),St.loadOptions.value.uaChTrackLevel)})),Ne((()=>{!0===St.loadOptions.value.sendAdblockPage&&void 0!==St.lifecycle.sourceConfigUrl.value&&((e,t)=>{const n=new URL(St.lifecycle.sourceConfigUrl.value),r=`${n.origin}${n.pathname}?view=ad`,s=new Ft(e,t);s.setAuthHeader(St.lifecycle.writeKey.value),s.getAsyncData({url:r,options:{method:"HEAD",headers:{"Content-Type":void 0}},isRawResponse:!0,callback:(e,t)=>{St.capabilities.isAdBlocked.value=void 0!==t?.error||t?.xhr?.responseURL!==r}})})(this.errorHandler,this.logger)}))}prepareBrowserCapabilities(){St.capabilities.isLegacyDOM.value=(()=>{const e=Object.keys(tn);let t=!1;for(let n=0;n<e.length;n++){const r=tn[e[n]];if(b(r)&&r()){t=!0;break}}return t})();let e=St.loadOptions.value.polyfillURL??qn;if(St.loadOptions.value.polyfillIfRequired&&St.capabilities.isLegacyDOM.value&&Boolean(e)){const t=e!==St.loadOptions.value.polyfillURL;if(t){const t=`RS_polyfillCallback_${St.lifecycle.writeKey.value}`,n=()=>{this.onReady(),delete globalThis[t]};globalThis[t]=n,e=`${e}&callback=${t}`}this.externalSrcLoader?.loadJSFile({url:e,id:Wn,async:!0,timeout:1e4,callback:n=>{n?t||this.onReady():this.onError(new Error(((e,t)=>`Failed to load the polyfill script with ID "${e}" from URL ${t}.`)(Wn,e)))}})}else this.onReady()}attachWindowListeners(){globalThis.addEventListener("offline",(()=>{St.capabilities.isOnline.value=!1})),globalThis.addEventListener("online",(()=>{St.capabilities.isOnline.value=!0})),globalThis.addEventListener("resize",function(e,t,n=250){let r;return(...s)=>{globalThis.clearTimeout(r),r=globalThis.setTimeout((()=>{e.apply(t,s)}),n)}}((()=>{St.context.screen.value=nn()}),this))}onReady(){this.detectBrowserCapabilities(),St.lifecycle.status.value="browserCapabilitiesReady"}onError(e){if(!this.errorHandler)throw e;this.errorHandler.onError(e,F)}}for(var Xn,Zn=[],Yn=0;Yn<256;Yn++)Zn[Yn]=(Yn+256).toString(16).substring(1);function er(){var e;(!Xn||Yn+16>4096)&&(e=4096,Xn=crypto.getRandomValues(new Uint8Array(e)),Yn=0);for(var t,n=0,r="";n<16;n++)t=Xn[Yn+n],r+=6==n?Zn[15&t|64]:8==n?Zn[63&t|128]:Zn[t],1&n&&n>1&&n<11&&(r+="-");return Yn+=16,r}for(var tr,nr=256,rr=[];nr--;)rr[nr]=(nr+256).toString(16).substring(1);const sr=()=>!k(globalThis.crypto)&&b(globalThis.crypto.getRandomValues)?er():function(){var e,t=0,n="";if(!tr||nr+16>256){for(tr=Array(t=256);t--;)tr[t]=256*Math.random()|0;t=nr=0}for(;t<16;t++)e=tr[nr+t],n+=6==t?rr[15&e|64]:8==t?rr[63&e|128]:rr[e],1&t&&t>1&&t<11&&(n+="-");return nr++,n}(),ir=["integrations","anonymousId","originalTimestamp"],or=["library","consentManagement","userAgent","ua-ch","screen"],ar=["anonymousId","sentAt","receivedAt","timestamp","originalTimestamp","event","messageId","channel"],lr=e=>{const t=Date.now();return Boolean(!e||t>e)},ur=(e,t)=>{return!!(e&&$n(e)&&(n=10,r=e,r.toString().length>=n))||(t?.warn(((e,t,n)=>`${e}${de}The provided session ID (${t}) is either invalid, not a positive integer, or not at least "${n}" digits long. A new session ID will be auto-generated instead.`)(z,e,10)),!1);var n,r},cr=(e,t)=>({id:ur(e,t)?e:Date.now(),sessionStart:void 0,manualTrack:!0}),dr=e=>Boolean(e===Kt||e===Gt||e===zt||e===Vt),gr=()=>sr(),hr=e=>{const t=Vn(),n={};return Object.keys(t).forEach((r=>{n[r]=e?.[r]||t[r]})),n.initial_referrer=e?.initial_referrer||St.session.initialReferrer.value,n.initial_referring_domain=e?.initial_referring_domain||St.session.initialReferringDomain.value,n},pr=(e,t,n)=>{C(e)&&Object.keys(e).forEach((e=>{(ar.includes(e)||ar.includes(e.toLowerCase()))&&n?.warn(((e,t,n,r)=>`${e}${de}The "${t}" property defined under "${n}" is a reserved keyword. Please choose a different property name to avoid conflicts with reserved keywords (${r}).`)(K,e,t,ar))}))},fr=(e,t,n)=>{let r=e;return Object.keys(t).forEach((e=>{if(!ir.includes(e)&&!or.includes(e))if("context"!==e)r=O(r,{[e]:t[e]});else if(!S(t[e])&&C(t[e])){const n={};Object.keys(t[e]).forEach((r=>{or.includes(r)||(n[r]=t[e][r])})),r=O(r,{...n})}else n?.warn(`${K}${de}Please make sure that the "context" property in the event API's "options" argument is a valid object literal with key-value pairs.`)})),r},vr=(e,t)=>{C(t)&&(((e,t)=>{t.anonymousId&&E(t.anonymousId)&&(e.anonymousId=t.anonymousId),C(t.integrations)&&(e.integrations=t.integrations),t.originalTimestamp&&E(t.originalTimestamp)&&(e.originalTimestamp=t.originalTimestamp)})(e,t),e.context=fr(e.context,t))},yr=e=>{let t;return t=St.loadOptions.value.useGlobalIntegrationsConfigInEvents&&(C(St.consents.postConsent.value?.integrations)||C(St.nativeDestinations.loadOnlyIntegrations.value))?g(St.consents.postConsent.value?.integrations??St.nativeDestinations.loadOnlyIntegrations.value):C(e)?e:jn,t},mr=(e,t,n,r)=>{const s={channel:"web",context:{traits:g(St.session.userTraits.value),sessionId:St.session.sessionInfo.value.id||void 0,sessionStart:St.session.sessionInfo.value.sessionStart||void 0,...St.consents.enabled.value&&{consentManagement:{deniedConsentIds:g(St.consents.data.value.deniedConsentIds),allowedConsentIds:g(St.consents.data.value.allowedConsentIds),provider:St.consents.provider.value,resolutionStrategy:St.consents.resolutionStrategy.value}},"ua-ch":St.context["ua-ch"].value,app:St.context.app.value,library:St.context.library.value,userAgent:St.context.userAgent.value,os:St.context.os.value,locale:St.context.locale.value,screen:St.context.screen.value,campaign:An(globalThis.location.href),page:hr(n),timezone:St.context.timezone.value},originalTimestamp:(new Date).toISOString(),integrations:jn,messageId:sr(),userId:e.userId||St.session.userId.value};dr(St.storage.entries.value.anonymousId?.type)?s.anonymousId=St.session.anonymousId.value:s.anonymousId=gr(),St.storage.trulyAnonymousTracking.value&&(s.context.trulyAnonymousTracking=!0),"identify"===e.type&&(s.context.traits=St.storage.entries.value.userTraits?.type!==qt?g(St.session.userTraits.value):e.context.traits),"group"===e.type&&((e.groupId||St.session.groupId.value)&&(s.groupId=e.groupId||St.session.groupId.value),(e.traits||St.session.groupTraits.value)&&(s.traits=St.storage.entries.value.groupTraits?.type!==qt?g(St.session.groupTraits.value):e.traits));const i=O(e,s);return void 0===i.event&&(i.event=null),void 0===i.properties&&(i.properties=null),vr(i,t),((e,t)=>{const{properties:n,traits:r,context:s}=e,{traits:i}=s;pr(n,"properties",t),pr(r,"traits",t),pr(i,"context.traits",t)})(i,r),i.integrations=yr(i.integrations),i};class br{constructor(e){this.logger=e}generatePageEvent(e,t,n,r){let s=n??{};s.name=t,s.category=e,s=((e,t)=>{const n=t?.page||{},r=e,s=Vn();return Object.keys(s).forEach((e=>{S(r[e])&&(r[e]=n[e]||s[e])})),S(r.initial_referrer)&&(r.initial_referrer=n.initial_referrer||St.session.initialReferrer.value),S(r.initial_referring_domain)&&(r.initial_referring_domain=n.initial_referring_domain||St.session.initialReferringDomain.value),r})(s,r);return mr({properties:s,name:t,category:e,type:"page"},r,s,this.logger)}generateTrackEvent(e,t,n){return mr({properties:t,event:e,type:"track"},n,void 0,this.logger)}generateIdentifyEvent(e,t,n){return mr({userId:e,type:"identify",context:{traits:t}},n,void 0,this.logger)}generateAliasEvent(e,t,n){const r=mr({previousId:t,type:"alias"},n,void 0,this.logger);return r.userId=e??r.userId,r}generateGroupEvent(e,t,n){const r={type:"group"};return e&&(r.groupId=e),t&&(r.traits=t),mr(r,n,void 0,this.logger)}create(e){let t;switch(e.type){case"page":t=this.generatePageEvent(e.category,e.name,e.properties,e.options);break;case"track":t=this.generateTrackEvent(e.name,e.properties,e.options);break;case"identify":t=this.generateIdentifyEvent(e.userId,e.traits,e.options);break;case"alias":t=this.generateAliasEvent(e.to,e.from,e.options);break;case"group":t=this.generateGroupEvent(e.groupId,e.traits,e.options)}return t}}class Er{constructor(e,t,n,r){this.eventRepository=e,this.userSessionManager=t,this.errorHandler=n,this.logger=r,this.eventFactory=new br(this.logger),this.onError=this.onError.bind(this)}init(){this.eventRepository.init()}resume(){this.eventRepository.resume()}addEvent(e){this.userSessionManager.refreshSession();const t=this.eventFactory.create(e);t?this.eventRepository.enqueue(t,e.callback):this.onError(new Error("Failed to generate the event object."))}onError(e,t,n){if(!this.errorHandler)throw e;this.errorHandler.onError(e,K,t,n)}}class Ir{constructor(e,t,n,r){this.storeManager=r,this.pluginsManager=n,this.logger=t,this.errorHandler=e,this.onError=this.onError.bind(this)}init(){this.syncStorageDataToState(),this.registerEffects()}syncStorageDataToState(){this.migrateStorageIfNeeded(),this.migrateDataFromPreviousStorage(),this.setUserId(this.getUserId()),this.setUserTraits(this.getUserTraits()),this.setGroupId(this.getGroupId()),this.setGroupTraits(this.getGroupTraits()),this.setAnonymousId(this.getAnonymousId(St.loadOptions.value.anonymousIdOptions)),this.setAuthToken(this.getAuthToken()),this.setInitialReferrerInfo(),this.configureSessionTracking()}configureSessionTracking(){let e=this.getSessionInfo();if(this.isPersistenceEnabledForStorageEntry("sessionInfo")){const t=this.getConfiguredSessionTrackingInfo(),n=this.getSessionInfo()??ut;e={...n,...t,autoTrack:t.autoTrack&&!0!==n.manualTrack}}this.setSessionInfo(e)}setInitialReferrerInfo(){const e=this.getInitialReferrer(),t=this.getInitialReferringDomain();if(e&&t)this.setInitialReferrer(e),this.setInitialReferringDomain(t);else{const t=e||zn();this.setInitialReferrer(t),this.setInitialReferringDomain(wn(t))}}isPersistenceEnabledForStorageEntry(e){return dr(St.storage.entries.value[e]?.type)}migrateDataFromPreviousStorage(){const e=St.storage.entries.value,t=[Kt,Gt,zt];Object.keys(e).forEach((n=>{const r=n,s=e[r]?.type,i=this.storeManager?.getStore(Yt[s]);i&&t.forEach((e=>{const t=this.storeManager?.getStore(Yt[e]);if(t&&e!==s){const e=t.get(at[r]);(e=>w(e)&&""!==e)(e)&&i.set(at[r],e),t.remove(at[r])}}))}))}migrateStorageIfNeeded(){if(!St.storage.migrate.value)return;const e=[];[Wt,Jt,Xt].forEach((t=>{const n=this.storeManager?.getStore(t);n&&e.push(n)})),Object.keys(at).forEach((t=>{const n=at[t];e.forEach((e=>{const t=this.pluginsManager?.invokeSingle("storage.migrate",n,e.engine,this.errorHandler,this.logger);k(t)||e.set(n,t)}))}))}getConfiguredSessionTrackingInfo(){let e,t=!1!==St.loadOptions.value.sessions?.autoTrack;if(!t)return{autoTrack:t};const n=St.loadOptions.value.sessions?.timeout;return $n(n)?e=n:(this.logger?.warn(((e,t,n)=>`${e}${de}The session timeout value "${t}" is not a number. The default timeout of ${n} ms will be used instead.`)(z,n,ie)),e=ie),0===e&&(this.logger?.warn(`${z}${de}The session timeout value is 0, which disables the automatic session tracking feature. If you want to enable session tracking, please provide a positive integer value for the timeout.`),t=!1),e>0&&e<1e4&&this.logger?.warn(((e,t,n)=>`${e}${de}The session timeout value ${t} ms is less than the recommended minimum of ${n} ms. Please consider increasing the timeout value to ensure optimal performance and reliability.`)(z,e,1e4)),{timeout:e,autoTrack:t}}onError(e){if(!this.errorHandler)throw e;this.errorHandler.onError(e,z)}syncValueToStorage(e,t){const n=St.storage.entries.value,r=n[e]?.type,s=n[e]?.key;if(dr(r)){const e=this.storeManager?.getStore(Yt[r]);t&&E(t)||D(t)?e?.set(s,t):e?.remove(s)}}registerEffects(){Zt.forEach((e=>{Ne((()=>{this.syncValueToStorage(e,St.session[e].value)}))}))}setAnonymousId(e,t){let n=e;if(this.isPersistenceEnabledForStorageEntry("anonymousId")){if(!n&&t){const e=this.pluginsManager?.invokeSingle("userSession.anonymousIdGoogleLinker",t);n=e}n=n||gr()}else n=lt.anonymousId;St.session.anonymousId.value=n}getAnonymousId(e){const t=St.storage.entries.value.anonymousId?.type;if(dr(t)){let t=this.getEntryValue("anonymousId");if(!t&&e){const n=this.pluginsManager?.invokeSingle("storage.getAnonymousId",bn,e);t=n}St.session.anonymousId.value=t||gr()}return St.session.anonymousId.value}getEntryValue(e){const t=St.storage.entries.value,n=t[e]?.type;if(dr(n)){const r=this.storeManager?.getStore(Yt[n]),s=t[e]?.key;return r?.get(s)??null}return null}getUserId(){return this.getEntryValue("userId")}getUserTraits(){return this.getEntryValue("userTraits")}getGroupId(){return this.getEntryValue("groupId")}getGroupTraits(){return this.getEntryValue("groupTraits")}getInitialReferrer(){return this.getEntryValue("initialReferrer")}getInitialReferringDomain(){return this.getEntryValue("initialReferringDomain")}getSessionInfo(){return this.getEntryValue("sessionInfo")}getAuthToken(){return this.getEntryValue("authToken")}getSessionId(){const e=St.session.sessionInfo.value;return e.autoTrack&&!lr(e.expiresAt)||e.manualTrack?e.id??null:null}refreshSession(){let e=St.session.sessionInfo.value;(e.autoTrack||e.manualTrack)&&(e.autoTrack&&this.startOrRenewAutoTracking(),e=St.session.sessionInfo.value,void 0===e.sessionStart?St.session.sessionInfo.value={...e,sessionStart:!0}:e.sessionStart&&(St.session.sessionInfo.value={...e,sessionStart:!1}))}reset(e,t){const{session:n}=St,{manualTrack:r,autoTrack:s}=n.sessionInfo.value;Ie((()=>{n.userId.value=lt.userId,n.userTraits.value=lt.userTraits,n.groupId.value=lt.groupId,n.groupTraits.value=lt.groupTraits,n.authToken.value=lt.authToken,e&&this.setAnonymousId(),t||(s?(n.sessionInfo.value=lt.sessionInfo,this.startOrRenewAutoTracking()):r&&this.startManualTrackingInternal())}))}setSessionInfo(e){St.session.sessionInfo.value=this.isPersistenceEnabledForStorageEntry("sessionInfo")?e:lt.sessionInfo,St.session.sessionInfo.value.autoTrack&&this.startOrRenewAutoTracking()}setUserId(e){St.session.userId.value=this.isPersistenceEnabledForStorageEntry("userId")&&e?e:lt.userId}setUserTraits(e){St.session.userTraits.value=this.isPersistenceEnabledForStorageEntry("userTraits")&&e?O(St.session.userTraits.value??{},e):lt.userTraits}setGroupId(e){St.session.groupId.value=this.isPersistenceEnabledForStorageEntry("groupId")&&e?e:lt.groupId}setGroupTraits(e){St.session.groupTraits.value=this.isPersistenceEnabledForStorageEntry("groupTraits")&&e?O(St.session.groupTraits.value??{},e):lt.groupTraits}setInitialReferrer(e){St.session.initialReferrer.value=this.isPersistenceEnabledForStorageEntry("initialReferrer")&&e?e:lt.initialReferrer}setInitialReferringDomain(e){St.session.initialReferringDomain.value=this.isPersistenceEnabledForStorageEntry("initialReferringDomain")&&e?e:lt.initialReferringDomain}startOrRenewAutoTracking(){const e=St.session.sessionInfo.value;if(lr(e.expiresAt))St.session.sessionInfo.value=(e=>{const t=Date.now(),n=e||ie;return{id:t,expiresAt:t+n,timeout:n,sessionStart:void 0,autoTrack:!0}})(e.timeout);else{const t=Date.now(),n=e.timeout;St.session.sessionInfo.value=O(e,{expiresAt:t+n})}}start(e){St.session.sessionInfo.value=cr(e,this.logger)}startManualTrackingInternal(){this.start(Date.now())}end(){St.session.sessionInfo.value={}}setAuthToken(e){St.session.authToken.value=this.isPersistenceEnabledForStorageEntry("authToken")&&e?e:lt.authToken}}const Sr="dataplaneEventsQueue",kr="destinationsEventsQueue",Tr=(e,t)=>{const n=g(e),r=e.integrations??jn,s=t.nativeDestinations.integrationsConfig.value,i=((e,t)=>Object.keys(e).filter((n=>!0!==e[n]||!t[n])).reduce(((t,n)=>{const r=g(t);return r[n]=e[n],r}),{}))(r,s);return n.integrations=O(s,i),n};class wr{constructor(e,t,n,r){this.pluginsManager=e,this.errorHandler=n,this.logger=r,this.httpClient=new Ft(n,r),this.storeManager=t,this.onError=this.onError.bind(this)}init(){try{this.dataplaneEventsQueue=this.pluginsManager.invokeSingle(`${Sr}.init`,St,this.httpClient,this.storeManager,this.errorHandler,this.logger)}catch(e){this.onError(e,"XhrQueuePlugin initialization failed")}try{this.dmtEventsQueue=this.pluginsManager.invokeSingle("transformEvent.init",St,this.pluginsManager,this.httpClient,this.storeManager,this.errorHandler,this.logger)}catch(e){this.onError(e,"DeviceModeTransformationPlugin initialization failed")}try{this.destinationsEventsQueue=this.pluginsManager.invokeSingle(`${kr}.init`,St,this.pluginsManager,this.storeManager,this.dmtEventsQueue,this.errorHandler,this.logger)}catch(e){this.onError(e,"NativeDestinationQueuePlugin initialization failed")}Ne((()=>{!0===St.nativeDestinations.clientDestinationsReady.value&&(this.destinationsEventsQueue?.start(),this.dmtEventsQueue?.start())}));const e=(e=>e.consents.preConsent.value.enabled&&"buffer"===e.consents.preConsent.value.events?.delivery&&("session"===e.consents.preConsent.value.storage?.strategy||"none"===e.consents.preConsent.value.storage?.strategy))(St);let t;Ne((()=>{const n=!0===St.loadOptions.value.bufferDataPlaneEventsUntilReady&&!1===St.nativeDestinations.clientDestinationsReady.value;!1!==St.nativeDestinations.activeDestinations.value.some((e=>{return t=e,Boolean("hybrid"===t.config.connectionMode||!0===t.config.useNativeSDKToSend);var t}))&&!1!==n||e||!0===this.dataplaneEventsQueue?.scheduleTimeoutActive||(globalThis.clearTimeout(t),this.dataplaneEventsQueue?.start())})),!0===St.loadOptions.value.bufferDataPlaneEventsUntilReady&&(t=globalThis.setTimeout((()=>{!0!==this.dataplaneEventsQueue?.scheduleTimeoutActive&&this.dataplaneEventsQueue?.start()}),St.loadOptions.value.dataPlaneEventsBufferTimeout))}resume(){!0!==this.dataplaneEventsQueue?.scheduleTimeoutActive&&(St.consents.postConsent.value.discardPreConsentEvents&&(this.dataplaneEventsQueue?.clear(),this.destinationsEventsQueue?.clear()),this.dataplaneEventsQueue?.start())}enqueue(e,t){let n;try{n=Tr(e,St),this.pluginsManager.invokeSingle(`${Sr}.enqueue`,St,this.dataplaneEventsQueue,n,this.errorHandler,this.logger)}catch(e){this.onError(e,"XhrQueuePlugin event enqueue failed")}try{const t=g(e);this.pluginsManager.invokeSingle(`${kr}.enqueue`,St,this.destinationsEventsQueue,t,this.errorHandler,this.logger)}catch(e){this.onError(e,"NativeDestinationQueuePlugin event enqueue failed")}try{t?.(n)}catch(e){this.onError(e,"API Callback Invocation Failed")}}onError(e,t,n){if(!this.errorHandler)throw e;this.errorHandler.onError(e,"EventRepository",t,n)}}const Ar=e=>{const t=new CustomEvent(e,{detail:{analyticsInstance:globalThis.rudderanalytics},bubbles:!0,cancelable:!0,composed:!0});globalThis.document.dispatchEvent(t)};class Pr{constructor(){this.preloadBuffer=new He,this.initialized=!1,this.errorHandler=At,this.logger=Fe,this.externalSrcLoader=new ye(this.errorHandler,this.logger),this.capabilitiesManager=new Jn(this.errorHandler,this.logger),this.httpClient=Qt}load(e,t,n={}){if(St.lifecycle.status.value)return;let r=g(t),s=g(n);R(t)&&(s=t,r=void 0),Ie((()=>{St.lifecycle.writeKey.value=e,St.lifecycle.dataPlaneUrl.value=r,St.loadOptions.value=((e,t)=>{const n=g(t);return E(n.setCookieDomain)||delete n.setCookieDomain,["Strict","Lax","None"].includes(n.sameSiteCookie)||delete n.sameSiteCookie,n.secureCookie=!0===n.secureCookie,["none","default","full"].includes(n.uaChTrackLevel)||delete n.uaChTrackLevel,C(n.integrations)||delete n.integrations,n.plugins=n.plugins??Rn,n.useGlobalIntegrationsConfigInEvents=!0===n.useGlobalIntegrationsConfigInEvents,n.bufferDataPlaneEventsUntilReady=!0===n.bufferDataPlaneEventsUntilReady,n.sendAdblockPage=!0===n.sendAdblockPage,C(n.sendAdblockPageOptions)||delete n.sendAdblockPageOptions,T(n.loadIntegration)?n.loadIntegration=!0===n.loadIntegration:delete n.loadIntegration,C(n.storage)?(n.storage=M(n.storage),n.storage.migrate=!0===n.storage?.migrate):delete n.storage,C(n.beaconQueueOptions)?n.beaconQueueOptions=M(n.beaconQueueOptions):delete n.beaconQueueOptions,C(n.destinationsQueueOptions)?n.destinationsQueueOptions=M(n.destinationsQueueOptions):delete n.destinationsQueueOptions,C(n.queueOptions)?n.queueOptions=M(n.queueOptions):delete n.queueOptions,n.lockIntegrationsVersion=!0===n.lockIntegrationsVersion,Cn(n.dataPlaneEventsBufferTimeout)||delete n.dataPlaneEventsBufferTimeout,C(n.storage?.cookie)?n.storage.cookie=M(n.storage?.cookie):delete n.storage?.cookie,C(n.preConsent)?n.preConsent=M(n.preConsent):delete n.preConsent,O(e,n)})(St.loadOptions.value,s),St.lifecycle.status.value="mounted"})),St.loadOptions.value.logLevel&&this.logger?.setMinLogLevel(St.loadOptions.value.logLevel),ae("state",St,e),this.startLifecycle()}startLifecycle(){Ne((()=>{try{switch(St.lifecycle.status.value){case"mounted":this.onMounted();break;case"browserCapabilitiesReady":this.onBrowserCapabilitiesReady();break;case"configured":this.onConfigured();break;case"pluginsLoading":case"destinationsLoading":case"readyExecuted":default:break;case"pluginsReady":this.onPluginsReady();break;case"initialized":this.onInitialized();break;case"loaded":this.onLoaded();break;case"destinationsReady":this.onDestinationsReady();break;case"ready":this.onReady()}}catch(e){const t="Failed to load the SDK";this.errorHandler.onError(fe(e,t),X)}}))}onBrowserCapabilitiesReady(){ue(this),this.prepareInternalServices(),this.loadConfig()}onLoaded(){this.processBufferedEvents(),!0===St.consents.preConsent.value.enabled?St.lifecycle.status.value="ready":this.loadDestinations()}onMounted(){this.capabilitiesManager.init()}enqueuePreloadBufferEvents(e){Array.isArray(e)&&e.forEach((e=>this.preloadBuffer.enqueue(g(e))))}processDataInPreloadBuffer(){for(;this.preloadBuffer.size()>0;){const e=this.preloadBuffer.dequeue();e&&ce([...e],this)}}prepareInternalServices(){this.pluginsManager=new jt(kt,this.errorHandler,this.logger),this.storeManager=new Sn(this.pluginsManager,this.errorHandler,this.logger),this.configManager=new Gn(this.httpClient,this.errorHandler,this.logger),this.userSessionManager=new Ir(this.errorHandler,this.logger,this.pluginsManager,this.storeManager),this.eventRepository=new wr(this.pluginsManager,this.storeManager,this.errorHandler,this.logger),this.eventManager=new Er(this.eventRepository,this.userSessionManager,this.errorHandler,this.logger)}loadConfig(){St.lifecycle.writeKey.value&&this.httpClient.setAuthHeader(St.lifecycle.writeKey.value),this.configManager?.init()}onPluginsReady(){this.errorHandler.init(this.externalSrcLoader),this.storeManager?.init(),this.userSessionManager?.init(),St.consents.enabled.value&&!St.consents.initialized.value&&(this.pluginsManager?.invokeSingle("consentManager.init",St,this.logger),!1===St.consents.preConsent.value.enabled&&this.pluginsManager?.invokeSingle("consentManager.updateConsentsInfo",St,this.storeManager,this.logger)),this.eventManager?.init(),St.lifecycle.status.value="initialized"}onConfigured(){this.pluginsManager?.init()}onInitialized(){this.processDataInPreloadBuffer(),b(St.loadOptions.value.onLoaded)&&St.loadOptions.value.onLoaded(globalThis.rudderanalytics),Ie((()=>{St.lifecycle.loaded.value=!0,St.lifecycle.status.value="loaded"})),this.initialized=!0,Ar("RSA_Initialised")}onReady(){St.lifecycle.status.value="readyExecuted",St.eventBuffer.readyCallbacksArray.value.forEach((e=>{try{e()}catch(e){this.errorHandler.onError(e,X,Ve)}})),Ar("RSA_Ready")}processBufferedEvents(){let e=St.eventBuffer.toBeProcessedArray.value;for(;e.length>0;){const t=e.shift();if(St.eventBuffer.toBeProcessedArray.value=e,t){const e=t[0];b(this[e])&&this[e](...t.slice(1),!0)}e=St.eventBuffer.toBeProcessedArray.value}}loadDestinations(){if(St.nativeDestinations.clientDestinationsReady.value)return;this.pluginsManager?.invokeSingle("nativeDestinations.setActiveDestinations",St,this.pluginsManager,this.errorHandler,this.logger);const e=St.nativeDestinations.activeDestinations.value.length;0!==e?(St.lifecycle.status.value="destinationsLoading",this.pluginsManager?.invokeSingle("nativeDestinations.load",St,this.externalSrcLoader,this.errorHandler,this.logger),Ne((()=>{(0===e||St.nativeDestinations.initializedDestinations.value.length+St.nativeDestinations.failedDestinations.value.length===e)&&Ie((()=>{St.lifecycle.status.value="destinationsReady",St.nativeDestinations.clientDestinationsReady.value=!0}))}))):St.lifecycle.status.value="destinationsReady"}onDestinationsReady(){"ready"!==St.lifecycle.status.value&&(St.lifecycle.status.value="ready")}ready(e,t=!1){const n="ready";if(St.lifecycle.loaded.value)if(this.errorHandler.leaveBreadcrumb(`New ${n} invocation`),b(e))if("readyExecuted"===St.lifecycle.status.value)try{e()}catch(e){this.errorHandler.onError(e,X,Ve)}else St.eventBuffer.readyCallbacksArray.value=[...St.eventBuffer.readyCallbacksArray.value,e];else this.logger.error(`${"readyApi"}${de}The callback is not a function.`);else St.eventBuffer.toBeProcessedArray.value=[...St.eventBuffer.toBeProcessedArray.value,[n,e]]}page(e,t=!1){const n="page";St.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${n} event`),St.metrics.triggered.value+=1,this.eventManager?.addEvent({type:"page",category:e.category,name:e.name,properties:e.properties,options:e.options,callback:e.callback}),!0===St.capabilities.isAdBlocked.value&&e.category!==ee&&this.page(j(ee,"ad-block page request",{path:"/ad-blocked"},St.loadOptions.value.sendAdblockPageOptions))):St.eventBuffer.toBeProcessedArray.value=[...St.eventBuffer.toBeProcessedArray.value,[n,e]]}track(e,t=!1){const n="track";St.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${n} event`),St.metrics.triggered.value+=1,this.eventManager?.addEvent({type:n,name:e.name||void 0,properties:e.properties,options:e.options,callback:e.callback})):St.eventBuffer.toBeProcessedArray.value=[...St.eventBuffer.toBeProcessedArray.value,[n,e]]}identify(e,t=!1){const n="identify";if(!St.lifecycle.loaded.value)return void(St.eventBuffer.toBeProcessedArray.value=[...St.eventBuffer.toBeProcessedArray.value,[n,e]]);this.errorHandler.leaveBreadcrumb(`New ${n} event`),St.metrics.triggered.value+=1;Boolean(e.userId&&St.session.userId.value&&e.userId!==St.session.userId.value)&&this.reset(),I(e.userId)||this.userSessionManager?.setUserId(e.userId),this.userSessionManager?.setUserTraits(e.traits),this.eventManager?.addEvent({type:n,userId:e.userId,traits:e.traits,options:e.options,callback:e.callback})}alias(e,t=!1){const n="alias";if(!St.lifecycle.loaded.value)return void(St.eventBuffer.toBeProcessedArray.value=[...St.eventBuffer.toBeProcessedArray.value,[n,e]]);this.errorHandler.leaveBreadcrumb(`New ${n} event`),St.metrics.triggered.value+=1;const r=e.from??this.userSessionManager?.getUserId()??this.userSessionManager?.getAnonymousId();this.eventManager?.addEvent({type:n,to:e.to,from:r,options:e.options,callback:e.callback})}group(e,t=!1){const n="group";St.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${n} event`),St.metrics.triggered.value+=1,I(e.groupId)||this.userSessionManager?.setGroupId(e.groupId),this.userSessionManager?.setGroupTraits(e.traits),this.eventManager?.addEvent({type:n,groupId:e.groupId,traits:e.traits,options:e.options,callback:e.callback})):St.eventBuffer.toBeProcessedArray.value=[...St.eventBuffer.toBeProcessedArray.value,[n,e]]}reset(e,t=!1){const n="reset";St.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${n} invocation, resetAnonymousId: ${e}`),this.userSessionManager?.reset(e)):St.eventBuffer.toBeProcessedArray.value=[...St.eventBuffer.toBeProcessedArray.value,[n,e]]}getAnonymousId(e){return this.userSessionManager?.getAnonymousId(e)}setAnonymousId(e,t,n=!1){const r="setAnonymousId";St.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${r} invocation`),this.userSessionManager?.setAnonymousId(e,t)):St.eventBuffer.toBeProcessedArray.value=[...St.eventBuffer.toBeProcessedArray.value,[r,e,t]]}getUserId(){return St.session.userId.value}getUserTraits(){return St.session.userTraits.value}getGroupId(){return St.session.groupId.value}getGroupTraits(){return St.session.groupTraits.value}startSession(e,t=!1){const n="startSession";St.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${n} invocation`),this.userSessionManager?.start(e)):St.eventBuffer.toBeProcessedArray.value=[...St.eventBuffer.toBeProcessedArray.value,[n,e]]}endSession(e=!1){const t="endSession";St.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${t} invocation`),this.userSessionManager?.end()):St.eventBuffer.toBeProcessedArray.value=[...St.eventBuffer.toBeProcessedArray.value,[t]]}getSessionId(){const e=this.userSessionManager?.getSessionId();return e??null}consent(e,t=!1){St.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb("New consent invocation"),Ie((()=>{St.consents.preConsent.value={...St.consents.preConsent.value,enabled:!1},St.consents.postConsent.value=(e=>{const t={sendPageEvent:!1,trackConsent:!1,discardPreConsentEvents:!1};if(C(e)){const n=g(e);t.storage=n.storage,T(n.integrations)&&(t.integrations=C(n.integrations)?n.integrations:jn),t.discardPreConsentEvents=!0===n.discardPreConsentEvents,t.sendPageEvent=!0===n.sendPageEvent,t.trackConsent=!0===n.trackConsent,D(n.consentManagement)&&(t.consentManagement=O(n.consentManagement,{enabled:St.consents.enabled.value}))}return t})(e);const{initialized:t,consentsData:n}=xn(St.consents.postConsent.value.consentManagement,this.logger);St.consents.initialized.value=t||St.consents.initialized.value,St.consents.data.value=n})),St.consents.enabled.value&&!St.consents.initialized.value&&this.pluginsManager?.invokeSingle("consentManager.updateConsentsInfo",St,this.storeManager,this.logger),this.storeManager?.initializeStorageState(),this.userSessionManager?.syncStorageDataToState(),this.eventManager?.resume(),this.loadDestinations(),this.sendTrackingEvents(t)):St.eventBuffer.toBeProcessedArray.value=[...St.eventBuffer.toBeProcessedArray.value,["consent",e]]}sendTrackingEvents(e){if(St.consents.postConsent.value.trackConsent){const t=N("Consent Management Interaction");e?St.eventBuffer.toBeProcessedArray.value=[...St.eventBuffer.toBeProcessedArray.value,["track",t]]:this.track(t)}if(St.consents.postConsent.value.sendPageEvent){const t=j();e?St.eventBuffer.toBeProcessedArray.value=[...St.eventBuffer.toBeProcessedArray.value,["page",t]]:this.page(t)}}setAuthToken(e){this.userSessionManager?.setAuthToken(e)}}class Rr{static globalSingleton=null;analyticsInstances={};defaultAnalyticsKey="";logger=Fe;constructor(){if(Rr.globalSingleton)return Rr.globalSingleton;At.attachErrorListeners(),this.setDefaultInstanceKey=this.setDefaultInstanceKey.bind(this),this.getAnalyticsInstance=this.getAnalyticsInstance.bind(this),this.load=this.load.bind(this),this.ready=this.ready.bind(this),this.triggerBufferedLoadEvent=this.triggerBufferedLoadEvent.bind(this),this.page=this.page.bind(this),this.track=this.track.bind(this),this.identify=this.identify.bind(this),this.alias=this.alias.bind(this),this.group=this.group.bind(this),this.reset=this.reset.bind(this),this.getAnonymousId=this.getAnonymousId.bind(this),this.setAnonymousId=this.setAnonymousId.bind(this),this.getUserId=this.getUserId.bind(this),this.getUserTraits=this.getUserTraits.bind(this),this.getGroupId=this.getGroupId.bind(this),this.getGroupTraits=this.getGroupTraits.bind(this),this.startSession=this.startSession.bind(this),this.endSession=this.endSession.bind(this),this.getSessionId=this.getSessionId.bind(this),this.setAuthToken=this.setAuthToken.bind(this),this.consent=this.consent.bind(this),Rr.globalSingleton=this,this.triggerBufferedLoadEvent()}setDefaultInstanceKey(e){e&&(this.defaultAnalyticsKey=e)}getAnalyticsInstance(e){const t=e??this.defaultAnalyticsKey;return Boolean(this.analyticsInstances[t])||(this.analyticsInstances[t]=new Pr),this.analyticsInstances[t]}load(e,t,n){E(e)?this.analyticsInstances[e]||(this.setDefaultInstanceKey(e),this.analyticsInstances[e]=new Pr,this.getAnalyticsInstance(e).load(e,t,n)):this.logger.error(((e,t)=>`${e}${de}The write key "${t}" is not a string. Please check that the write key is correct and try again.`)(J,e))}triggerBufferedLoadEvent(){const e=Array.isArray(globalThis.rudderanalytics)?globalThis.rudderanalytics:[];(e=>{const t="consent",n=e.filter((e=>e[0]===t)),r=e.filter((e=>e[0]!==t));e.splice(0,e.length,...n,...r)})(e);const t=(e=>{let t=[],n=0;for(;n<e.length;){if(e[n]&&"load"===e[n][0]){t=g(e[n]),e.splice(n,1);break}n+=1}return t})(e);ae(te,g(e)),t.length>0&&(t.shift(),this.load.apply(null,t))}ready(e){this.getAnalyticsInstance().ready(e)}page(e,t,n,r,s){this.getAnalyticsInstance().page(j(e,t,n,r,s))}track(e,t,n,r){this.getAnalyticsInstance().track(N(e,t,n,r))}identify(e,t,n,r){this.getAnalyticsInstance().identify(H(e,t,n,r))}alias(e,t,n,r){this.getAnalyticsInstance().alias(x(e,t,n,r))}group(e,t,n,r){0!==arguments.length?this.getAnalyticsInstance().group(_(e,t,n,r)):this.logger.error(`${J}${de}The group() method must be called with at least one argument.`)}reset(e){this.getAnalyticsInstance().reset(e)}getAnonymousId(e){return this.getAnalyticsInstance().getAnonymousId(e)}setAnonymousId(e,t){this.getAnalyticsInstance().setAnonymousId(e,t)}getUserId(){return this.getAnalyticsInstance().getUserId()}getUserTraits(){return this.getAnalyticsInstance().getUserTraits()}getGroupId(){return this.getAnalyticsInstance().getGroupId()}getGroupTraits(){return this.getAnalyticsInstance().getGroupTraits()}startSession(e){return this.getAnalyticsInstance().startSession(e)}endSession(){return this.getAnalyticsInstance().endSession()}getSessionId(){return this.getAnalyticsInstance().getSessionId()}setAuthToken(e){return this.getAnalyticsInstance().setAuthToken(e)}consent(e){return this.getAnalyticsInstance().consent(e)}}const{setDefaultInstanceKey:Cr,getAnalyticsInstance:$r,load:Or,ready:Dr,page:Br,track:Mr,identify:Lr,alias:Ur,group:jr,reset:Nr,getAnonymousId:Hr,setAnonymousId:xr,getUserId:_r,getUserTraits:Fr,getGroupId:Qr,getGroupTraits:Kr,startSession:Gr,endSession:zr,getSessionId:Vr,consent:qr,setAuthToken:Wr}=new Rr;return e.alias=Ur,e.consent=qr,e.endSession=zr,e.getAnalyticsInstance=$r,e.getAnonymousId=Hr,e.getGroupId=Qr,e.getGroupTraits=Kr,e.getSessionId=Vr,e.getUserId=_r,e.getUserTraits=Fr,e.group=jr,e.identify=Lr,e.load=Or,e.page=Br,e.ready=Dr,e.reset=Nr,e.setAnonymousId=xr,e.setAuthToken=Wr,e.setDefaultInstanceKey=Cr,e.startSession=Gr,e.track=Mr,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),e}({});
//# sourceMappingURL=rsa.min.js.map
