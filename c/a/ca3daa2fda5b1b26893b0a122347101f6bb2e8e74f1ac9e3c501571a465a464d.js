"use strict";(self.webpackChunkregistration=self.webpackChunkregistration||[]).push([[219,130],{4326:(e,t,r)=>{r.d(t,{Z:()=>d});var n=r(5861),o=r(4687),c=r.n(o),a=r(1890),s=r.n(a),i=r(417),u=r(3929);const d=(0,n.Z)(c().mark((function e(){var t,r,n,o,a;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,s().getAsyncToken();case 2:return t=e.sent,r=t.networkId,e.next=6,(0,i.default)("me/network-token/".concat(r),{method:"POST",body:JSON.stringify({spot_id:u.D5})});case 6:return n=e.sent,o=n.network_id,a=n.token,s().setToken(a,o),e.abrupt("return",{token:a});case 11:case"end":return e.stop()}}),e)})))},2161:(e,t,r)=>{r.d(t,{Z:()=>s});var n=r(5861),o=r(4687),c=r.n(o),a=r(417);const s=function(){var e=(0,n.Z)(c().mark((function e(t){var r,n,o,s,i;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.codeB,e.next=3,(0,a.default)("authentication/handshake/complete",{method:"POST",body:JSON.stringify({code_b:r})});case 3:return n=e.sent,o=n.error,s=n.success,i=s?void 0:o,e.abrupt("return",{error:i,isSuccess:s});case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},3329:(e,t,r)=>{r.r(t),r.d(t,{LoginMethod:()=>n,default:()=>h});var n,o=r(5861),c=r(4687),a=r.n(c),s=r(1890),i=r.n(s),u=r(4543),d=r.n(u),p=r(248),l=r(417),f=r(2832),g=r(3929),v=r(6276),m=r(3527);!function(e){e.SSO="sso",e.LOGIN="login",e.SIGNUP="signup"}(n||(n={}));const h=function(){var e=(0,o.Z)(a().mark((function e(t,r){var n,o,c,u,h;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i().getAsyncUser();case 2:if(n=e.sent,e.prev=3,!g.or&&!g.s1){e.next=10;break}return e.next=7,d()("v1.0.0/authentication/current-user",{method:"POST",headers:{"x-spot-id":g.D5,"x-real-user-mode":"true"}},{overrideRecoveryMode:!0});case 7:o=e.sent,e.next=13;break;case 10:return e.next=12,(0,l.default)("me/login",{method:"POST",body:JSON.stringify({spot_id:g.D5})});case 12:o=e.sent;case 13:return(c=(0,s.parseUser)(o)).isRegistered&&r&&(v.Z.send("login_success"),(0,p.dispatchSpotimEvent)("spot-im-post-login",{currentUser:{email:c.email||"",username:c.username||""}}),(0,f.trackEvent)({source:"conversation",spot_id:g.D5,post_id:g.F,type:"user-identified",native:r,target_type:n.id,is_registered:!0,segment:(0,p.getLocation)().origin,user_id:c.id}),t&&(u={userId:c.id,displayName:c.displayName,imageId:c.imageId,social:t},g.Nv||(u.email=c.email),h=(0,m.oF)(JSON.stringify(u)),localStorage.setItem(g.nc,h))),e.abrupt("return",c);case 18:throw e.prev=18,e.t0=e.catch(3),v.Z.error("login",e.t0),new Error("Login failed due to with error: ".concat(e.t0));case 22:case"end":return e.stop()}}),e,null,[[3,18]])})));return function(t,r){return e.apply(this,arguments)}}()},2741:(e,t,r)=>{r.r(t),r.d(t,{default:()=>x});var n=r(4942),o=r(5861),c=r(4687),a=r.n(c),s=r(1890),i=r.n(s),u=r(4543),d=r.n(u),p=r(417),l=r(2832),f=r(248),g=r(3929),v=r(6276),m=r(2e3),h=r(4326),w=r(3329),b=r(5945);r y=(0,r(4233).D)("Registration");const x=function(){var e=(0,o.Z)(a().mark((function e(t){var r,n,o,c,u,T,x,S;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.source,n=t.tokenRecoveryMode,o=t.isLogoutFlow,c=void 0!==o&&o,e.prev=1,y("Logout started"),e.next=5,i().getAsyncUser();case 5:if((u=e.sent).isRegistered){e.next=9;break}return e.abrupt("return",u);case 9:if(!g.or){e.next=16;break}return e.next=12,d()("v1.0.0/authentication/logout",{method:"POST",headers:{"x-spot-id":g.D5}});case 12:T=e.sent,u=(0,s.parseUser)(T),e.next=26;break;case 16:return e.next=18,(0,p.default)("me/logout",{method:"POST",body:JSON.stringify({spot_id:g.D5})});case 18:return e.next=20,(0,h.Z)();case 20:return x=e.sent,S=x.token,i().setToken(S),e.next=25,(0,w.default)();case 25:u=e.sent;case 26:if(g.c&&c&&(0,f.dispatchSpotimEvent)("spot-im-sso-complete",{type:"logout"}),n){e.next=31;break}return(0,b.MP)(),e.next=31,(0,m.l)(k(k({},u),{},{isSuperAdmin:!1}));case 31:return y("Logout succeed, new current user is: ",u),(0,l.trackEvent)({source:r,spot_id:g.D5,post_id:g.F,type:"logout-clicked",item_type:"logout",segment:"success"}),e.abrupt("return",u);case 36:return e.prev=36,e.t0=e.catch(1),v.Z.error("logout",e.t0),y("Logout failed with: ",e.t0),(0,l.trackEvent)({source:r,spot_id:g.D5,post_id:g.F,type:"logout-clicked",item_type:"logout",segment:"error"}),e.abrupt("return",new Error("Logout failed due to with error: ".concat(e.t0)));case 42:case"end":return e.stop()}}),e,null,[[1,36]])})));return function(t){return e.apply(this,arguments)}}()},2678:(e,t,r)=>{r.r(t),r.d(t,{startTTH:()=>S});var n=r(5861),o=r(4687),c=r.n(o),a=r(1890),s=r.n(a),i=r(9099),u=r.n(i),d=r(248),p=r(6276),l=r(2e3),f=r(3329),g=r(417),v=r(3929);const m=(0,n.Z)(c().mark((function e(){var t,r,n,o,a,s;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,g.default)("authentication/handshake/start",{method:"POST",body:JSON.stringify({spot_id:v.D5})});case 2:return t=e.sent,r=t.code_a,n=t.success,o=t.status,a=n?void 0:o,s=n?r:void 0,e.abrupt("return",{error:a,codeA:s});case 9:case"end":return e.stop()}}),e)})));var h,w=r(2161),b=r(4326),T=r(4233),k=r(2741),y=r(5945),x=(0,T.D)("TTH");!h||(h={}));var S=function(){var e=(0,n.Z)(c().mark((function e(t){var r,o,a,i,d,l;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.callback,o=t.onError,a=t.userId,i=t.forceLogin,d=void 0!==i&&i,l=t.source,e.abrupt("return",new Promise(function(){var e=(0,n.Z)(c().mark((function e(t,n){var i,g,v,m;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(g=null!==(i=u().flags.tokenRecoveryMode)&&void 0!==i&&i,x("Start TTH with arguments",r,o,a,d),"function"==typeof r){e.next=5;break}return P((function(){return n(new Error("Callback must be provided to start TTH process"))})),e.abrupt("return");case 5:return e.prev=5,x("Starting process ".concat(h.TTH)),e.next=9,s().getAsyncToken();case 9:if(e.sent.token){e.next=14;break}return e.next=14,(0,b.Z)();case 14:if(!g){e.next=20;break}return x("Token Recovery mode, starting logout"),e.next=18,(0,k.default)({source:l,tokenRecoveryMode:g});case 18:e.next=46;break;case 20:return x("Calling login"),e.prev=21,e.next=24,(0,f.default)(void 0,f.LoginMethod.SSO);case 24:v=e.sent,e.next=35;break;case 27:return e.prev=27,e.t0=e.catch(21),x("Login failed, trying again ".concat(e.t0)),e.next=32,(0,b.Z)();case 32:return e.next=34,(0,f.default)();case 34:v=e.sent;case 35:if(x("Login call finished with currentUser",v),null===(m=v)||void 0===m||!m.isRegistered){e.next=46;break}if(!(d||a&&(0,y.fR)(a))){e.next=43;break}return x("Trying to log in with different user, perform logout"),e.next=41,(0,k.default)({source:l});case 41:e.next=46;break;case 43:return x("Current User is already registered"),O((function(){return t(v)})),e.abrupt("return");case 46:return e.next=48,Z({callback:r,userId:a,resolve:t,reject:n});case 48:e.next=58;break;case 50:return e.prev=50,e.t1=e.catch(5),e.next=54,(0,b.Z)();case 54:p.Z.error("startTTH",e.t1),x("TTH error ".concat(e.t1.toString())),null==o||o(e.t1),P(();case 58:case"end":return e.stop()}}),e,null,[[5,50],[21,27]])})));return function(t,r){return e.apply(this,arguments)}}()));case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),O=function(e){(0,d.dispatchSpotimEvent)("spot-im-sso-complete",{type:"login"}),e()},P=function(e){(0,d.dispatchSpotimEvent)("spot-im-sso-error"),e()},Z=function(){var e=(0,n.Z)(c().mark((function e(t){var r,o,a,s,i,u,d,p;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.resolve,o=t.reject,a=t.callback,s=t.userId,x("Calling TTH endpoint"),e.next=4,m();case 4:if(i=e.sent,u=i.error,d=i.codeA,x("TTH endpoint finished with codeA or error",d,u),!u&&d){e.next=12;break}return p=u||"received empty codeA",P((function(){return o(new Error("Error receiving code A (".concat(p,")")))})),e.abrupt("return");case 12:x("Calling user callback with codeA ".concat(d)),a(d,function(){var e=(0,n.Z)(c().mark((function e(t,n){var a,i,u,d,p;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(x("Running complete callback with codeB ".concat(t)),t&&!n){e.next=5;break}return a=n?"Can't complete TTH due to partner error, ".concat(n):"Can't complete TTH process since codeB is empty or missing",P((),e.abrupt("return");case 5:return x("Calling complete endpoint with codeB ".concat(t)),e.next=8,(0,w.Z)({codeB:t});case 8:if(i=e.sent,u=i.error,d=i.isSuccess,x("Complete endpoint finished with success: ".concat(d)),d){e.next=15;break}return P((),e.abrupt("return");case 15:return x("Calling login"),e.next=18,(0,f.default)(void 0,f.LoginMethod.SSO);case 18:if(!(p=e.sent)){e.next=26;break}return e.next=22,(0,l.l)(p);case 22:s&&(0,y.BR)(s),O((),e.next=29;break;case 26:x("TTH error"),x("Complete process ".concat(h.TTH)),P(();case 29:case"end":return e.stop()}}),e)})));return ());case 14:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},4233:(e,t,r)=>{r.d(t,{D:()=>s});var n=r(248),o="SPOTIM_DEBUG_API",c=null;function a(e){for(var t,r=arguments.length,n=new Array(r>1?r-1:0),o=1;o<r;o++)n[o-1]=arguments[o];(t=console).log.apply(t,["%cSpot.IM ".concat(e),"background: #307fe2; color: white;"].concat(n))}function s(e){var t=function(){try{if(null===c){var e=new URLSearchParams((0,n.getLocation)().search);if((c=e.get(o.toLowerCase()))||(c=window.SPOTIM_DEBUG_API),!c)try{c=window.localStorage.getItem(o)}catch(e){}c||(c=""),c=c.split(",").map(()}return c}catch(e){return[]}}();return t.indexOf("*")>-1||t.indexOf(e.toLowerCase())>-1?a.bind(null,e):},5945:(e,t,r)=>{r.d(t,{BR:()=>i,MP:()=>u,fR:()=>s});var n=r(6276),o=r(4233),c="OWֹֹ_EXTERNAL_USER_ID",a=(0,o.D)("TTH"),s=function(e){var t;try{t=localStorage.getItem(c)||""}catch(e){var r="TTH - cannot get ".concat(c," from local storage: ").concat(e);a(r),n.Z.error("startTTH",r)}return String(e)!==String(t)},i=function(e){try{localStorage.setItem(c,e)}catch(e){var t="TTH - cannot set ".concat(c," in local storage: ").concat(e);a(t),n.Z.error("startTTH",t)}},u=function(){try{localStorage.removeItem(c)}catch(t){var e="TTH - cannot set ".concat(c," in local storage: ").concat(t);a(e),n.Z.error("startTTH",e)}}},3527:(e,t,r)=>{r.d(t,{FB:()=>a,NV:()=>u,TD:()=>s,fm:()=>d,lZ:()=>c,oF:()=>i,tq:()=>o});var n=r(1002}var c=o(),a=("object"===("undefined"==typeof window?"undefined":(0,n.Z)(window))&&/(iPhone|iPod|iPad).*AppleWebKit(?!.*Safari)/i.test(navigator.userAgent}}var },},}},2e3:(e,t,r)=>{r.d(t,{u});var n=r(5861),o=r(4687),c=r.n(o),a=r(1890),s=r.n(a),i=r(3929),u=function(){var e=(0,n.Z)(c().mark((function e(t){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise((function(e){return setTimeout}),i.NK)}));case 2:case"end":return e.stop()}}),e)})));retur}}()}}]);
//# sourceMappingURL=registration-start-tth-bundle.js.map