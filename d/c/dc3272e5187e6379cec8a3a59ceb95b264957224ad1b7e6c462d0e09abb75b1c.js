import{getTypedDataset,objDataset,fetchJson,debounced,throttled,resolve,fetchHtml,addParams,domRemove,domReplaceWith}from"../framework/base/croco.js";import{mediaQuery,POPIN_REFIT_TYPES,POPIN_ANIMATION,getLocalData,getPathUrl}from"../framework/base/config.js";import{lazyloader}from"../framework/modules/lazyload.js";import{sendEventOnEnterViewport,sendEvent,EVENTS}from"../framework/base/event-tracker.js";import{render}from"../framework/vendors/lit-html/lit-html.js";import{IMPOLICY_PRODUCT,tplPicture}from"../framework/templates/picture.tpl.js";const RECOMMENDATION_SELECTOR=".js-page-designer-recommendations";function modularVideoOverlayInit(t){t.forEach(t=>{if(t&&!getTypedDataset(t).autoplay){const o=t.closest(".js-modular-push");const i=o?o.querySelector(".js-video-overlay"):null;if(i){objDataset(t,"startCallback",()=>{i.classList.add("is-hidden")});objDataset(t,"endCallback",()=>{i.classList.remove("is-hidden")})}}})}const initCustomCursor=()=>{if(mediaQuery.desktopOnly.matches){const t=document.querySelector(".js-custom-cursor");if(t){const o=e=>{if(e&&e.pageX&&e.pageY){t.style.transform=`translate3d(${e.pageX}px, ${e.pageY-Number(window.scrollY)}px, 0px)`}};const i=debounced(200,o);const l=throttled(100,o);document.addEventListener("mousemove",l);document.addEventListener("mousemove",i);document.addEventListener("mouseleave",()=>t.classList.add("opacity0"));document.addEventListener("mouseenter",()=>t.classList.remove("opacity0"));t.classList.remove("opacity0");const{moveCursor:m,clickCursor:u}=t.dataset;if(m&&u){document.addEventListener("mousedown",()=>t.setAttribute("src",u));document.addEventListener("mouseup",()=>setTimeout(()=>{t.setAttribute("src",m)},100))}}}};const initLazyloadProducts=localData=>{const intersectionObserver=new IntersectionObserver((entries,observer)=>{for(let entry of entries){if(entry.intersectionRatio>0){const $productsLayer=entry.target;const $productTiles=[...$productsLayer.querySelectorAll(".js-product-tile")];const productIds=$productTiles.map(t=>t.dataset.productId);if(productIds.length){const productApiUrl=$productsLayer.dataset.productApiUrl;productIds.sort();fetchHtml(addParams(productApiUrl,{productIds:productIds})).then(async $html=>{const $fetchedTiles=[...$html.querySelectorAll(".js-product-tile-api")];$productTiles.forEach($productTile=>{const $fetchedTile=$fetchedTiles.find(t=>t.dataset.id===$productTile.dataset.productId);if($fetchedTile&&$fetchedTile.children.length>0){const $clonedTile=$fetchedTile.cloneNode(true);const $image=$clonedTile.querySelector(".js-product-tile-image");const{imageDesktop,imageMobile}=$productTile.dataset;if($image){const ratioClass=$productTile.dataset.ratio||"";if(imageDesktop){$image.className=ratioClass;render(tplPicture({src:[imageMobile||imageDesktop,imageDesktop],cells:[11,6,6],policy:IMPOLICY_PRODUCT,className:"l-overlay img-cover",preventLazyload:true}),$image)}else{let $lqip=$image.querySelector(".lqip");if($lqip){$lqip.classList.remove("l-ratio-td--1","l-ratio--1");$lqip.classList.add(...ratioClass.trim().split(" "))}}}const title=$productTile.dataset.title;const $title=$clonedTile.querySelector(".js-product-tile-title");if($title&&title){$title.textContent=title}const $flags=$clonedTile.querySelector(".js-product-tile-flags");if($productTile.classList.contains("js-flag-disabled")&&$flags){domRemove($flags)}const $quickView=$clonedTile.querySelector(".js-quick-pdp-eye");$quickView&&$quickView.remove();if($productTile.classList.contains("is-expired")){$clonedTile.classList.add("opacity--medium","pointer-none")}const $countdown=$productTile.querySelector(".js-product-countdown");const $tileLink=$clonedTile.querySelector(".js-product-tile-link");if($countdown&&$tileLink){$countdown.classList.add("l-overlay");$clonedTile.classList.add("js-countdown-wrapper","countdown-wrapper");$image.classList.add("countdown-blur");$tileLink.append($countdown);const $wishlist=$clonedTile.querySelector(".js-wishlist-add-item");$wishlist&&$wishlist.remove();const $tileContent=$clonedTile.querySelector(".js-product-tile-content");const countdownVisibleClass=$countdown.dataset.countdownVisible;if(countdownVisibleClass&&$tileContent){$tileContent.classList.add(...countdownVisibleClass.split(" "))}}[...$clonedTile.querySelectorAll(".js-anim-enterview")].forEach(t=>{t.classList.add("animate")});domReplaceWith($clonedTile,$productTile);const tracking=$clonedTile.querySelector(".js-product-tile-tracking");tracking&&eval(tracking.textContent)}else{const $tileWrapper=$productTile.closest(".js-grid-tile")||$productTile;$tileWrapper.remove()}});const $slider=$productsLayer.querySelector(".js-snap-slider-wrapper");if($slider){const slider=objDataset($slider,"snapslider");requestAnimationFrame(()=>{slider.init(true)})}const{productTileInit}=await import("../framework/components/product-tile.js");productTileInit();const $countdowns=$productsLayer.querySelectorAll(".js-product-countdown");$countdowns.length&&import("../framework/components/countdown.js").then(({initCountdown:t})=>t($countdowns));const wishlist=resolve("wishlist",localData);if(wishlist){const{toggleWishlistProducts}=await import("../framework/modules/wishlist.js");toggleWishlistProducts(resolve("refColors",wishlist)||[])}})}observer.unobserve($productsLayer)}}},{rootMargin:"0px",threshold:0});document.querySelectorAll(".js-layer-with-products").forEach(t=>{intersectionObserver.observe(t)})};export const getTrackingAttribute=(context,key,t)=>{return resolve(`${context}.${key}`,t)||resolve(`modularTracking.${context}.${key}`,window)};export const addTrackingAttribute=(t,o,i,key,l)=>{!t.ecommerce&&(t.ecommerce={});let value=null;if(!l){value=getTrackingAttribute("page",key);if(i){value=getTrackingAttribute(i.dataset.id,key)||value}}if(o){value=getTrackingAttribute(o.dataset.id,key,l)||value}if(value){t.ecommerce[key]=value}};export async function sendPromotionEvent(t,o,i,l){const m={};["creative_name","creative_slot","promotion_id","promotion_name"].forEach(key=>{addTrackingAttribute(m,t,o,key,l)});switch(i){case EVENTS.VIEW_PROMOTION:sendEventOnEnterViewport(t,EVENTS.VIEW_PROMOTION,m,true);break;case EVENTS.SELECT_PROMOTION:if(l?.event){sendEvent(l.event.name,l.event.data,t)}else{sendEvent(EVENTS.SELECT_PROMOTION,m,t)}break}}export const addSelectPromotionEvent=(i,l,m,u)=>{[...i.querySelectorAll(".js-select-promotion")].forEach(o=>{if(!o.parentElement.closest(".js-select-promotion")){o.addEventListener("click",async()=>{let t=o.dataset.event;if(t){if(!u){u={}}switch(t){case"signin":u.event={name:"start_sign_in",data:{event_data:{method:"regular"}}};break;case"signup":u.event={name:"start_sign_up",data:{event_data:{method:"regular"}}};break}}sendPromotionEvent(i,l,m,u)},true)}})};export const bindModularTracking=t=>{[...t.querySelectorAll(".js-modular-layer")].forEach(o=>{const t=o.querySelectorAll(".js-modular-push");if(t.length&&!o.classList.contains("js-modular-partial-pages")&&!o.classList.contains("js-modular-content-push")){[...t].forEach(t=>{if(!t.classList.contains("js-fader-slide")){sendPromotionEvent(t,o,EVENTS.VIEW_PROMOTION)}if(!o.parentElement.closest(".js-modular-layer")){addSelectPromotionEvent(t,o,EVENTS.SELECT_PROMOTION)}})}else{sendPromotionEvent(o,null,EVENTS.VIEW_PROMOTION);addSelectPromotionEvent(o,null,EVENTS.SELECT_PROMOTION)}})};export async function modularInit(o=document){const t=o.querySelector(".js-modular-full-page");const i=o.querySelectorAll(".js-fader");const l=o.querySelector(".js-anim-enterview-enabled");const m=o.querySelector(".js-bg-transition-enabled");const u=o.querySelectorAll(".js-parallax-wrapper");const p=o.querySelectorAll(".js-pin-wrapper");const g=o.querySelectorAll(".js-snap-slider-wrapper");const h=o.querySelectorAll(".js-countdown");const $=o.querySelectorAll(".js-zoom-wrapper");const j=o.querySelectorAll(".js-layer-form");const T=o.querySelectorAll(".js-modular--starter");const v=o.querySelectorAll(".js-modular--productlist");const k=o.querySelectorAll(".js-static-video-wrapper");const S=o.querySelectorAll(".js-story-group-btn");const I=o.querySelectorAll(".js-legal-layer");const L=o.querySelector(".js-modular-partial-pages");const q=o.querySelectorAll(".js-image-tabs");const O=o.querySelectorAll(".js-loop");const A=o.querySelector(RECOMMENDATION_SELECTOR);if(l){const{animEnterViewInit:_}=await import("../framework/components/anim-enterview.js");_();mediaQuery.desktopOnly.matches&&u.length&&import("../framework/modules/parallax.js").then(({parallaxInit:t})=>t())}if(m){import("../framework/components/background-transition.js").then(({backgroundTransitionInit:t})=>t())}if(k.length){import("../framework/modules/abstract-video.js").then(({videosInit:t})=>{t(k)});modularVideoOverlayInit(k)}const P=await getLocalData();i.length&&import("../framework/modules/fader.js").then(({faderInit:t})=>t());p.length&&import("../framework/modules/pin.js").then(({pinInit:t})=>t());g.length&&import("../framework/components/slider-preconfigured.js").then(({sliderInit:t})=>t(g));h.length&&import("../framework/components/countdown.js").then(({initCountdown:t})=>t(h));$.length&&import("../framework/components/zoom-image.js").then(({zoomImageInit:t})=>t({}));j.length&&import("../framework/components/modular-form.js").then(({formLayerInit:t})=>t(j,P));T.length&&import("../framework/components/modular-starter.js").then(({modularStarterInit:t})=>t(T));v.length&&import("../framework/components/product-tile.js").then(({productTileInit:t})=>t(o,{context:resolve("pageViewData.page_data.category",window)}));S.length&&import("../framework/modules/stories.js").then(({storiesInit:t})=>t(S));q.length&&import("../framework/modules/image-tabs.js").then(({imageTabsInit:t})=>t());O.length&&import("../framework/modules/image-loop.js").then(({imageLoopInit:t})=>t());if(I.length){const V=getPathUrl(true);import("../framework/modules/asset-load.js").then(({cssLoad:t})=>t(`${V}css/critical/legal-critical.css`));import("../framework/modules/accordion.js").then(({accordionInit:t})=>t())}if(t&&t.dataset.viewPageUrl){const M=()=>{window.removeEventListener("scroll",M);fetchJson(t.dataset.viewPageUrl).then(data=>{if(data&&data.notification){import("../framework/base/notifications.js").then(({initNotification:t})=>t(data.notification))}})};window.addEventListener("scroll",M)}if(L){const{initModularTabs:D}=await import("./modular-partial-pages-non-critical.js");D(L)}[...o.querySelectorAll(".js-btn-popin")].forEach(i=>{const t=resolve("dataset.contentId",i);const l=t?`popin-${t}`:"popin-modular";i.addEventListener("click",async e=>{e.preventDefault();if(i.href){const t=resolve("dataset.type",i)==="panel";const{openPopin:o}=await import("../framework/base/popin-refit.js");o({instanceId:l,type:t?POPIN_REFIT_TYPES.medium:POPIN_REFIT_TYPES.fill,animation:t?null:POPIN_ANIMATION.openFromBottom,classname:t?"modular-popin-panel":"modular-popin",options:{noPadding:true,hasKeyboard:true},loadContents:async()=>{const t=await fetchHtml(i.href);return{htmlContents:t}},openCallback:(t,o)=>{modularInit(o.$viewContent);lazyloader.update()}})}});i.classList.remove("loading-skeleton")});initLazyloadProducts(P);bindModularTracking(o);const C=document.querySelector(".js-iframe-layer");if(C){const{initModularIframe:R}=await import("../framework/modules/modular-iframe.js");R(C)}initCustomCursor();if(A){const{recommendationInit:W}=await import("../framework/components/recommendation.js");W(RECOMMENDATION_SELECTOR)}[...document.querySelectorAll(".js-modular-push")].forEach(o=>{const t=new Date(o.dataset.expirationDate);if(t&&t<new Date){o.classList.add("is-expired","opacity--medium","pointer-none");[...o.querySelectorAll(".js-push-cta")].forEach(t=>{t.classList.add("is-disabled");t.classList.remove("pointer-auto");const label=o.dataset.expirationLabel;if(label){t.textContent=label}})}});const N=!!document.querySelector(".js-logged");[...document.querySelectorAll(".js-cta-with-login")].forEach(t=>{if(!N){const o=resolve("dataset.urlWithLogin",t);if(o){t.href=o;t.removeAttribute("onclick")}}t.classList.remove("loading-skeleton")})}modularInit();