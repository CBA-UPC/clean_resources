/*
 * Internet explorer generates pointer events by default for all input types like mouse, pen or touch (finger).
 * Touchr is generating touch events only for touch type by default but it can be overwritten by
 * window.Touchr_ALLOWED_POINTER_TYPE bitmask property. It can have values:
 * 1 for touch
 * 2 for mouse
 * 4 for pen
 * and their combinations.
 */

(function(window) {
	var IE_10		= !!window.navigator.msPointerEnabled,
		// Check below can mark as IE11+ also other browsers which implements pointer events in future
		// that is not issue, because touch capability is tested in IF statement bellow.
		IE_11_PLUS	= !!window.navigator.pointerEnabled || !!window.PointerEvent;

	// Only pointer enabled browsers without touch capability.
	if ((navigator.userAgent.indexOf("MSIE 10.0") != -1 || navigator.userAgent.indexOf("rv:11.0") != -1) && (IE_10 || (IE_11_PLUS && !('ontouchstart' in window)))) {
		var document = window.document,
			POINTER_DOWN		= IE_11_PLUS ? "pointerdown"	: "MSPointerDown",
			POINTER_UP 			= IE_11_PLUS ? "pointerup"		: "MSPointerUp",
			POINTER_MOVE		= IE_11_PLUS ? "pointermove"	: "MSPointerMove",
			POINTER_TYPE_TOUCH 	= IE_11_PLUS ? "touch"	: MSPointerEvent.MSPOINTER_TYPE_TOUCH,
			POINTER_TYPE_MOUSE 	= IE_11_PLUS ? "mouse"	: MSPointerEvent.MSPOINTER_TYPE_MOUSE,
			POINTER_TYPE_PEN 	= IE_11_PLUS ? "pen"	: MSPointerEvent.MSPOINTER_TYPE_PEN, //IE11+ has also unknown type which Touchr doesn't support
			GESTURE_START		= "MSGestureStart",
			GESTURE_CHANGE		= "MSGestureChange",
			GESTURE_END			= "MSGestureEnd",
			TOUCH_ACTION		= IE_11_PLUS ? "touchAction" : "msTouchAction",
			_180_OVER_PI		= 180/Math.PI,
			// Which pointer types will be used for generating touch events: 1 - touch, 2 - mouse, 4 - pen or their combination
			ALLOWED_POINTER_TYPE = window.Touchr_ALLOWED_POINTER_TYPE || 1,
			createEvent = function (eventName, target, params) {
				var k,
					event = document.createEvent("Event");

				event.initEvent(eventName, true, true);
				for (k in params) {
					event[k] = params[k];
				}
				target.dispatchEvent(event);
			},
			/**
			 * ECMAScript 5 accessors to the rescue
			 * @see http://perfectionkills.com/how-ecmascript-5-still-does-not-allow-to-subclass-an-array/
			 */
			makeSubArray = (function() {
				var MAX_SIGNED_INT_VALUE = Math.pow(2, 32) - 1,
					hasOwnProperty = Object.prototype.hasOwnProperty;

				
				function getMaxIndexProperty(object) {
					var maxIndex = -1,
						isValidProperty,
						prop;

					for (prop in object) {

						isValidProperty = (
							String(ToUint32(prop)) === prop &&
								ToUint32(prop) !== MAX_SIGNED_INT_VALUE &&
								hasOwnProperty.call(object, prop));

						if (isValidProperty && prop > maxIndex) {
							maxIndex = prop;
						}
					}
					return maxIndex;
				}

				return function(methods) {
					var length = 0;
					methods = methods || { };

					methods.length = {
						get: function() {
							var maxIndexProperty = +getMaxIndexProperty(this);
							return Math.max(length, maxIndexProperty + 1);
						},
						set: function(value) {
							var constrainedValue = ToUint32(value);
							if (constrainedValue !== +value) {
								throw new RangeError();
							}
							for (var i = constrainedValue, len = this.length; i < len; i++) {
								delete this[i];
							}
							length = constrainedValue;
						}
					};
					methods.toString = {
						value: Array.prototype.join
					};
					return Object.create(Array.prototype, methods);
				};
			})(),
			// methods passed to TouchList closure method to extend Array
			touchListMethods = {
				/**
				 * Returns touch by id. This method fulfill the TouchList interface.
				 * @param {Number} id
				 * @returns {Touch}
				 */
				identifiedTouch: {
					value: function (id) {
						var length = this.length;
						while (length--) {
							if (this[length].identifier === id) return this[length];
						}
						return undefined;
					}
				},
				/**
				 * Returns touch by index. This method fulfill the TouchList interface.
				 * @param {Number} index
				 * @returns {Touch}
				 */
				item: {
					value: 				},
				/**
				 * Returns touch index
				 * @param {Touch} touch
				 * @returns {Number}
				 */
				_touchIndex: {
					value: function (touch) {
						var length = this.length;
						while (length--) {
							if (this[length].pointerId == touch.pointerId) return length;
						}
						return -1;
					}
				},

				/**
				 * Add all events and convert them to touches
				 * @param {Event[]} events
				 */
				_addAll: {
					value: function(events) {
						var i = 0,
							length = events.length;

						for (; i < length; i++) {
							this._add(events[i]);
						}
					}
				},

				/**
				 * Add and MSPointer event and convert it to Touch like object
				 * @param {Event} event
				 */
				_add: {
					value: function(event) {
						var index = this._touchIndex(event);

						index = index < 0 ? this.length : index;

						//normalizing Pointer to Touch
						event.type = POINTER_MOVE;
						event.identifier = event.pointerId;
						//in DOC is mentioned that it is 0..255 but actually it returns 0..1 value
						//returns 0.5 for mouse down buttons in IE11, should it be issue?
						event.force = event.pressure;
						//default values for Touch which we cannot obtain from Pointer
						event.radiusX = event.radiusY = 1;
						event.rotationAngle = 0;

						this[index] = event;
					}
				},

				/**
				 * Removes an event from this touch list.
				 * @param {Event} event
				 */
				_remove: {
					value: function(event) {
						var index = this._touchIndex(event);

						if (index >= 0) {
							this.splice(index,1);
						}
					}
				}
			},

			/**
			 * This class store touches in an list which can be also accessible as array which is
			 * little bit bad because TouchList have to extend Array. Because we are aiming on
			 * IE10+ we can use ECMAScript5 solution.
			 * @extends Array
			 * @see http://www.w3.org/TR/2011/WD-touch-events-20110913/#touchlist-interface
			 * @see https://developer.mozilla.org/en-US/docs/DOM/TouchList
			 */
			TouchList = (function(methods) {
				return function() {
					var arr = makeSubArray(methods);
					if (arguments.length === 1) {
						arr.length = arguments[0];
					}
					else {
						arr.push.apply(arr, arguments);
					}
					return arr;
				};
			})(touchListMethods),

			/**
			 * list of all touches running during life cycle
			 * @type TouchList
			 */
			generalTouchesHolder,

			/**
			 * Storage of link between pointer {id} and original target
			 * @type Object
			 */
			pointerToTarget = {},

			/**
			 * General gesture object which fires MSGesture events whenever any associated MSPointer event changed.
			 */
			gesture = window.MSGesture ? new MSGesture() : null,

			gestureScale = 1,
			gestureRotation = 0,

			/**
			 * Storage of targets and anonymous MSPointerStart handlers for later
			 * unregistering
			 * @type Array
			 */
			attachedPointerStartMethods = [],

			/**
			 * Checks if node is some of parent children or sub-children
			 * @param {HTMLElement|Document} parent
			 * @param {HTMLElement} node
			 * @returns {Boolean}
			 */
			checkSameTarget = function (parent, node) {
				if (node) {
					if (parent === node) {
						return true;
					} else {
						return checkSameTarget(parent, node.parentNode);
					}
				} else {
					return false;
				}
			},

			/**
			 * Returns bitmask type of pointer to compare with allowed pointer types
			 * @param {Number|String} pointerType
			 * @returns {Number}
			 */
			pointerTypeToBitmask = function (pointerType) {
				if (pointerType == POINTER_TYPE_TOUCH) {
					return 1;
				} else if (pointerType == POINTER_TYPE_MOUSE) {
					return 2;
				} else {
					return 4;
				}
			},

			/**
			 * Main function which is rewriting the MSPointer event to touch event
			 * and preparing all the necessary lists of touches.
			 * @param {Event} evt
			 */
			pointerListener = function (evt) {
				var type,
					i,
					target = evt.target,
					originalTarget,
					changedTouches,
					targetTouches;

				// Skip pointers which are not allowed by users:
				if (!(pointerTypeToBitmask(evt.pointerType) & ALLOWED_POINTER_TYPE)) {
					return;
				}

				if (evt.type === POINTER_DOWN) {
					generalTouchesHolder._add(evt);
					pointerToTarget[evt.pointerId] = evt.target;

					type = "touchstart";

					// Fires MSGesture event when we have at least two pointers in our holder
					// (adding pointers to gesture object immediately fires Gesture event)
					if (generalTouchesHolder.length > 1) {
						gesture.target = evt.target;
						for (i = 0; i < generalTouchesHolder.length; i++) {
							// Adds to gesture only touches
							// It is not necessary to create separate gesture for mouse or pen pointers
							// because they cannot be present more than by 1 pointer.
							if (generalTouchesHolder[i].pointerType === POINTER_TYPE_TOUCH) {
								gesture.addPointer(generalTouchesHolder[i].pointerId);
							}
						}
					}
				}

				if (evt.type === POINTER_MOVE && generalTouchesHolder.identifiedTouch(evt.pointerId)) {
					generalTouchesHolder._add(evt);

					type = "touchmove";
				}

				//Preparation of touch lists have to be done before pointerup/MSPointerUp where we delete some information

				//Which touch fired this event, because we know that MSPointer event is fired for every
				//changed pointer than we create a list only with actual pointer
				changedTouches = document.createTouchList(evt);
				//Target touches is list of touches which started on (touchstart) on target element, they
				//are in this array even if these touches have coordinates outside target elements
				targetTouches = document.createTouchList();
				for (i = 0; i < generalTouchesHolder.length; i++) {
					//targetTouches._add(generalTouchesHolder[i]);
					//check if the pointerTarget is in the target
					if (checkSameTarget(target, pointerToTarget[generalTouchesHolder[i].identifier])) {
						targetTouches._add(generalTouchesHolder[i]);
					}
				}
				originalTarget = pointerToTarget[evt.pointerId];

				if (evt.type === POINTER_UP) {
					generalTouchesHolder._remove(evt);
					pointerToTarget[evt.pointerId] = null;

					delete pointerToTarget[evt.pointerId];
					type = "touchend";

					// Fires MSGestureEnd event when there is only one ore zero touches:
					if (generalTouchesHolder.length <= 1) {
						gesture.stop();
					}
				}

				//console.log("+", evt.type, evt.pointerType, generalTouchesHolder.length, evt.target.nodeName+"#"+evt.target.id);
				if (type && originalTarget) {
					createEvent(type, originalTarget, {touches: generalTouchesHolder, changedTouches: changedTouches, targetTouches: targetTouches});
				}
			},

			/**
			 * Main function which is rewriting the MSGesture event to gesture event.
			 * @param {Event} evt
			 */
			gestureListener = function (evt) {
				//TODO: check first, other than IE (FF?), browser which implements pointer events how to make gestures from pointers. Maybe it would be mix of pointer/gesture events.
				var type, scale, rotation;
				if (evt.type === GESTURE_START) {type = "gesturestart"}
				else if (evt.type === GESTURE_CHANGE) {type = "gesturechange"}
				else if (evt.type === GESTURE_END) {type = "gestureend"}

				// -------- SCALE ---------
				//MSGesture:
				//Scale values represent the difference in scale from the last MSGestureEvent that was fired.
				//Apple:
				//The distance between two fingers since the start of an event, as a multiplier of the initial distance. The initial value is 1.0.

				// ------- ROTATION -------
				//MSGesture:
				//Clockwise rotation of the cursor around its own major axis expressed as a value in radians from the last MSGestureEvent of the interaction.
				//Apple:
				//The delta rotation since the start of an event, in degrees, where clockwise is positive and counter-clockwise is negative. The initial value is 0.0
				if (evt.type === GESTURE_START) {
					scale = gestureScale = 1;
					rotation = gestureRotation = 0;
				} else {
					scale = gestureScale = gestureScale + (evt.scale - 1); //* evt.scale;
					rotation = gestureRotation = gestureRotation + evt.rotation * _180_OVER_PI;
				}

				createEvent(type, evt.target, {scale: scale, rotation: rotation, screenX: evt.screenX, screenY: evt.screenY});
			},

			/**
			 * This method augments event listener methods on given class to call
			 * our own method which attach/detach the MSPointer events handlers
			 * when user tries to attach touch events.
			 * @param {Function} elementClass Element class like HTMLElement or Document
			 */
			augmentEventListener = function(elementClass) {
				var customAddEventListener = attachTouchEvents,
					customRemoveEventListener = removeTouchEvents,
					oldAddEventListener = elementClass.prototype.addEventListener,
					oldRemoveEventListener = elementClass.prototype.removeEventListener;

				elementClass.prototype.addEventListener = function(type, listener, useCapture) {
					//"this" is HTML element
					if ((type.indexOf("gesture") === 0 || type.indexOf("touch") === 0)) {
						customAddEventListener.call(this, type, listener, useCapture);
					}
					oldAddEventListener.call(this, type, listener, useCapture);
				};

				elementClass.prototype.removeEventListener = function(type, listener, useCapture) {
					if ((type.indexOf("gesture") === 0 || type.indexOf("touch") === 0)) {
						customRemoveEventListener.call(this, type, listener, useCapture);
					}
					oldRemoveEventListener.call(this, type, listener, useCapture);
				};
			},
			/**
			 * This method attach event handler for MSPointer / MSGesture events when user
			 * tries to attach touch / gesture events.
			 * @param {String} type
			 * @param {Function} listener
			 * @param {Boolean} useCapture
			 */
			attachTouchEvents = function (type, listener, useCapture) {
				//element owner document or document itself
				var doc = this.nodeType == 9 ?  this : this.ownerDocument;

				// Because we are listening only on document, it is not necessary to
				// attach events on one document more times
				if (attachedPointerStartMethods.indexOf(doc) < 0) {
					//TODO: reference on node, listen on DOM removal to clean the ref?
					attachedPointerStartMethods.push(doc);
					doc.addEventListener(POINTER_DOWN, pointerListener, useCapture);
					doc.addEventListener(POINTER_MOVE, pointerListener, useCapture);
					doc.addEventListener(POINTER_UP, pointerListener, useCapture);
					doc.addEventListener(GESTURE_START, gestureListener, useCapture);
					doc.addEventListener(GESTURE_CHANGE, gestureListener, useCapture);
					doc.addEventListener(GESTURE_END, gestureListener, useCapture);
				}

				// e.g. Document has no style
				if (this.style && (typeof this.style[TOUCH_ACTION] == "undefined" || !this.style[TOUCH_ACTION])) {
					this.style[TOUCH_ACTION] = "none";
				}
			},
			/**
			 * This method detach event handler for MSPointer / MSGesture events when user
			 * tries to detach touch / gesture events.
			 * @param {String} type
			 * @param {Function} listener
			 * @param {Boolean} useCapture
			 */
			removeTouchEvents = function (type, listener, useCapture) {
				//todo: are we able to understand when all listeners are unregistered and shall be removed?
			};


		/*
		 * Adding DocumentTouch interface
		 * @see http://www.w3.org/TR/2011/WD-touch-events-20110505/#idl-def-DocumentTouch
		 */

		/**
		 * Create touches list from array or touches or given touch
		 * @param {Touch[]|Touch} touches
		 * @returns {TouchList}
		 */
		document.createTouchList = function(touches) {
			var touchList = new TouchList();
			if (touches) {
				if (touches.length) {
					touchList._addAll(touches);
				} else {
					touchList._add(touches);
				}
			}
			return touchList;
		};

		/*******  Fakes which persuade other code to use touch events ********/

		/**
		 * AbstractView is class for document.defaultView === window
		 * @param {AbstractView} view
		 * @param {EventTarget} target
		 * @param {Number} identifier
		 * @param {Number} pageX
		 * @param {Number} pageY
		 * @param {Number} screenX
		 * @param {Number} screenY
		 * @return {Touch}
		 */
		document.createTouch = 
		//Fake Modernizer touch test
		//http://modernizr.github.com/Modernizr/touch.html
		if (!window.ontouchstart) window.ontouchstart = 1;

		/*******  End of fakes ***********************************/

		generalTouchesHolder = document.createTouchList();

		// Overriding HTMLElement and HTMLDocument to hand over touch handler to MSPointer event handler
		augmentEventListener(HTMLElement);
		augmentEventListener(Document);
	}
}(window));
var JAK={NAME:"JAK",_idCnt:0};JAK.idGenerator=function(){this._idCnt=this._idCnt<1e7?this._idCnt:0;var id="m"+(new Date).getTime().toString(16)+"m"+this._idCnt.toString(16);this._idCnt++;return id};String.prototype.lpad=function(character,count){var ch=character||"0";var cnt=count||2;var s="";while(s.length<cnt-this.length){s+=ch}s=s.substring(0,cnt-this.length);return s+this.toString()};String.prototype.rpad=function(character,count){var ch=character||"0";var cnt=count||2;var s="";while(s.length<cnt-this.length){s+=ch}s=s.substring(0,cnt-this.length);return this.toString()+s};String.prototype.CS_ALPHABET="0123456789AÁBCČDĎEĚÉFGHCHIÍJKLMNŇOÓPQRŘSŠTŤUÚŮVWXYÝZŽaábcčdďeěéfghchiíjklmnňoópqrřsštťuúůvwxyýzž";String.prototype.localeCSCompare=function(value){value+="";if(this+""===value){return 0}if(this.length<value.length){return-value.localeCSCompare(this)}var i=0;var j=0;var length=value.length;var charValue="";var charThis="";var indexValue=0;var indexThis=0;while(i<length){charValue=value.charAt(i);charThis=this.charAt(j);if(charThis.toLowerCase()=="c"){var tempString=this.substring(j,j+2);if(tempString=="ch"||tempString=="CH"){j++;charThis=tempString}}if(charValue.toLowerCase()=="c"){var tempString=value.substring(i,i+2);if(tempString=="ch"||tempString=="CH"){i++;charValue=tempString}}indexValue=this.CS_ALPHABET.indexOf(charValue);indexThis=this.CS_ALPHABET.indexOf(charThis);if(charValue!=charThis){break}i++;j++}if(i==length){return 1}if(indexValue==indexThis){return charThis.localeCompare(charValue)}else if(indexThis==-1){return-1}else if(indexValue==-1){return 1}else{return indexThis-indexValue}};if(.toFixed(3)).slice(2,5)+"Z"}})()}Date.prototype._dayNames=["Pondělí","Úterý","Středa","Čtvrtek","Pátek","Sobota","Neděle"];Date.prototype._dayNamesShort=["Po","Út","St","Čt","Pá","So","Ne"];Date.prototype._monthNames=["Leden","Únor","Březen","Duben","Květen","Červen","Červenec","Srpen","Září","Říjen","Listopad","Prosinec"];Date.prototype._monthNamesShort=["Led","Úno","Bře","Dub","Kvě","Čer","Črc","Srp","Zář","Říj","Lis","Pro"];Date.prototype.format=function(str){var suffixes={1:"st",2:"nd",3:"rd",21:"st",22:"nd",23:"rd",31:"st"};var result="";var escape=false;for(var i=0;i<str.length;i++){var ch=str.charAt(i);if(escape){escape=false;result+=ch;continue}switch(ch){case"\\":if(escape){escape=false;result+=ch}else{escape=true}break;case"d":result+=this.getDate().toString().lpad();break;case"j":result+=this.getDate();break;case"w":result+=this.getDay();break;case"N":result+=this.getDay()||7;break;case"S":var d=this.getDate();result+=suffixes[d]||"th";break;case"D":result+=this._dayNamesShort[(this.getDay()||7)-1];break;case"l":result+=this._dayNames[(this.getDay()||7)-1];break;case"z":var t=this.getTime();var d=new Date(t);d.setDate(1);d.setMonth(0);var diff=t-d.getTime();result+=diff/(1e3*60*60*24);break;case"W":var d=new Date(this.getFullYear(),this.getMonth(),this.getDate());var day=d.getDay()||7;d.setDate(d.getDate()+(4-day));var year=d.getFullYear();var day=Math.floor((d.getTime()-new Date(year,0,1,-6).getTime())/(1e3*60*60*24));result+=(1+Math.floor(day/7)).toString().lpad();break;case"m":result+=(this.getMonth()+1).toString().lpad();break;case"n":result+=this.getMonth()+1;break;case"M":result+=this._monthNamesShort[this.getMonth()];break;case"F":result+=this._monthNames[this.getMonth()];break;case"t":var t=this.getTime();var m=this.getMonth();var d=new Date(t);var day=0;do{day=d.getDate();t+=1e3*60*60*24;d=new Date(t)}while(m==d.getMonth());result+=day;break;case"L":var d=new Date(this.getTime());d.setDate(1);d.setMonth(1);d.setDate(29);result+=d.getMonth()==1?"1":"0";break;case"Y":result+=this.getFullYear().toString().lpad();break;case"y":result+=this.getFullYear().toString().lpad().substring(2);break;case"a":result+=this.getHours()<12?"am":"pm";break;case"A":result+=this.getHours()<12?"AM":"PM";break;case"G":result+=this.getHours();break;case"H":result+=this.getHours().toString().lpad();break;case"g":result+=this.getHours()%12;break;case"h":result+=(this.getHours()%12).toString().lpad();break;case"i":result+=this.getMinutes().toString().lpad();break;case"s":result+=this.getSeconds().toString().lpad();break;case"Z":result+=-60*this.getTimezoneOffset();break;case"O":case"P":var base=this.getTimezoneOffset()/-60;var o=Math.abs(base).toString().lpad();if(ch=="P"){o+=":"}o+="00";result+=(base>=0?"+":"-")+o;break;case"U":result+=this.getTime()/1e3;break;case"u":result+="0";break;case"c":result+=arguments.callee.call(this,"Y-m-d")+"T"+arguments.callee.call(this,"H:i:sP");break;case"r":result+=arguments.callee.call(this,"D, j M Y H:i:s O");break;default:result+=ch;break}}return risObj,args.concat(Arraynts)))}}}if(!Date.now){Date.n.trim=function(obj){return String.prototype.trim.call(obj)}}if(!Object.create){Object.create=function(){function Temp(){}var hasOwn=Object.prototype.hasOwnProperty;return function(O){if(typeof O!="object"){throw TypeError("Object prototype may only be an Object or null")}Temp.prototype=O;var obj=new Temp;Temp.prototype=null;if(arguments.length>1){var Properties=Object(arguments[1]);for(var prop in Properties){if(hasOwn.call(Properties,prop)){obj[prop]=Properties[prop]}}}return obj}}()}if(!Object.keys){Object.keys=function(){"use strict";var hasOwnProperty=Object.prototype.hasOwnProperty,hasDontEnumBug=!{toString:null}.propertyIsEnumerable("toString"),dontEnums=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],dontEnumsLength=dontEnums.length;return function(obj){if(typeof obj!=="object"&&(typeof obj!=="function"||obj===null)){throw new TypeError("Object.keys called on non-object")}var result=[],prop,i;for(prop in obj){if(hasOwnProperty.call(obj,prop)){result.push(prop)}}if(hasDontEnumBug){for(var i=0;i<dontEnumsLength;i++){if(hasOwnProperty.call(obj,dontEnums[i])){result.push(dontEnurn Object.prototype.toString.call(vArg)==="[object Array]"}}if("function"!==typeof Array.prototype.reduce){Array.prototype.reduce=function(callback,opt_initialValue){"use strict";if(null===this||"undefined"===typeof this){throw new TypeError("Array.prototype.reduce called on null or undefined")}if("function"!==typeof callback){throw new TypeError(callback+" is not a function")}var index,value,length=this.length>>>0,isValueSet=false;if(1<arguments.length){value=opt_initialValue;isValueSet=true}for(index=0;length>index;++index){if(this.hasOwnProperty(index)){if(isValueSet){value=callback(value,this[index],index,this)}else{value=this[index];isValueSet=true}}}if(!isValueSet){throw new TypeError("Reduce of empty array with no initial value")}return value}}if("function"!==typeof Array.prototype.reduceRight){Array.prototype.reduceRight=function(callback,opt_initialValue){"use strict";if(null===this||"undefined"===typeof this){throw new TypeError("Array.prototype.reduceRight called on null or undefined")}if("function"!==typeof callback){throw new TypeError(callback+" is not a function")}var index,value,length=this.length>>>0,isValueSet=false;if(1<arguments.length){value=opt_initialValue;isValueSet=true}for(index=length-1;-1<index;--index){if(!this.hasOwnProperty(index)){if(isValueSet){value=callback(value,this[index],index,this)}else{value=this[index];isValueSet=true}}}if(!isValueSet){throw new TypeError("Reduce of empty array with no initial value")}return value}}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(item,from){var len=this.length;var i=from||0;if(i<0){i+=len}for(;i<len;i++){if(i in this&&this[i]===item){return i}}return-1}}if(!Array.indexOf){Array.indexOf=function(obj,item,from){return Array.prototype.indexOf.call(obj,item,from)}}if(!Array.prototype.lastIndexOf){Array.prototype.lastIndexOf=function(item,from){var len=this.length;var i=from===undefined?len-1:from;if(i<0){i+=len}for(;i>-1;i--){if(i in this&&this[i]===item){return i}}return-1}}if(!Array.lastIndexOf){Array.lastIndexOf=function(obj,item,from){if(arguments.length>2){return Array.prototype.lastIndexOf.call(obj,item,from)}else{return Array.prototype.lastIndexOf.call(obj,item)}}}if(!Array.prototype.forEach){Array.prototype.forEach=function(cb,_this){var len=this.length;for(var i=0;i<len;i++){if(i in this){cb.caln(obj,cb,_this){Array.prototype.forEach.call(obj,cb,_this)}}if(!Array.prototype.every){Array.prototype.every=function(cb,_this){var len=this.length;for(var i=0;i<len;i++){if(i in this&&!cb.call(_this,this[i],i,this)){return false}}return true}}if(!Array.every){Array.every=function(obj,cb,_this){return Array.prototype.every.call(ob&&cb.call(_this,this[i],i,this)){return true}}return false}}if(!Array.some){Array.some=function(obj,cb,_this){return Array.prototype.some.call( in this){res[i]=cb.call(_this,this[i],i,this)}}return res}}if(!Array.map){Array.map=function(obj,cb,_this){return Array.prototype.map.call(obj,cb,_this)}}if(!Array.prototype.filter){Array.prototype.filter=function(cb,_this){var len=this.length;var res=[];for(var i=0;i<len;i++){if(i in this){var val=this[i];if(cb.call(_this,val,i,this))cb,_this){return Array.prototype.filter.call(obj,cb,_this)}}if("document"in self){if(!("classList"in document.createElement("_"))||document.createElementNS&&!("classList"in document.createElementNS("http://www.w3.org/2000/svg","g"))){(function(view){"use strict";if(!("Element"in view))return;var classListProp="classList",protoProp="prototype",elemCtrProto=view.Elemerop].trim||function(){return this.rep<len;iame=type;this.code=DOMnvalid chaame=function(){elem.setAttribute("class",this.toString(]=[],classListGetter=function(){return new ClassList(tProp];classListProto.iten){token+="";returned=true}}while(++i<l);,token)}}while(++i<l);ce===true||force===false};classListProto.toString=function(){return this.join(" ")};if(objCtr.defineProperty){var classListPropDesc={get:classListGetter,enumerable:true,configurable:true};try{objCtr.defineProperty(elemCtrProto,classListProp,classListPropDesc)}catch(ex){if(ex.number===undefined||ex.number===-2146823252){classListPropDesc.enumerable=false;objCtr.defineProperty(elemCtrProto,classListProp,classListPropDesc)}}}else if(objCtr[protoProp].__defineGetter__){elemCtrProtce}else{return _toggle.call(this,token)}}}testElement=null})()}JAK.ClassMaker={};JAK.ClassMaker.VERSION="5.1";JAK.ClassMaker.NAME="JAK.ClassMaker";JAK.ClassMaker.makeClass=function(params){var p=this._makeDefaultParams(params);var constructor=function(){if(this.$constructor){return this.$constructor.apply(this,arguments)}};return this._addConstructorProperties(constructor,p)};JAK.ClassMaker.makeSingleton=function(params){var p=this._makeDefaultParams(params);var constructor=function(){throw new Error("Cannot instantiate singleton class")};constructor._instance=null;constructor.getInstance=this._getInstance;return this._addConstructorProperties(constructor,p)};JAK.ClassMaker.makeInterface=function(pafunction(){throw new Error("Cannot instantiate interface")};return this._addConstructorProperties(constructor,p)};JAK.ClassMaker.makeStatic=function(params){var p=this._makeDefaultParams(params);var obj={};obj.VERSION=p.VERSION;obj.NAME=p.NAME;return obj};JAK.ClassMaker._makeDefaultParams=function(params){if("EXTEND"in params){if(!params.EXTEND){throw new Error("Cannot extend non-exist class")}if(typeof params.EXTEND!="function"){throw new Error("Cannot extend non-function")}if(!("NAME"in params.EXTEND)){throw new Error("Cannot extend non-JAK class")}}params.NAME=params.NAME||false;params.VERSION=params.VERSION||"1.0";params.EXTEND=params.EXTEND||false;params.IMPLEMENT=params.IMPLEMENT||[];params.DEPEND=params.DEPEND||[];if(!(params.IMPLEMENT instanceof Array)){params.IMPLEMENT=[params.IMPLEMENT]}this._preMakeTests(params);return params};JAK.ClassMaker._preMakeTests=function(params){if(!params.NAME){throw new Error("No NAME passed to JAK.ClassMaker.makeClass()")}var result=false;if(result=this._testDepend(params.DEPEND)){throw new Error("Dependency error in class "+params.NAME+" ("+result+")")}};JAK.ClassMaker._addConstructorProperties=function(constructor,params){for(var p in params){constructor[p]=params[p]}this._setInheritance(constructor);constructor.prototype.constructor=constructor;constructor.prototype.$super=this._$super;return constructor};JAK.ClassMaker._getInstance=function(){if(!this._instance){this._instance=Object.create(this.prototype);if("$constructor"in this.prototype){this._instance.$constructor()}}return this._instance};JAK.ClassMaker._setInheritance=function(constructor){if(constructor.EXTEND){this._makeInheritance(constructor,constructor.EXTEND)}for(var i=0;i<constructor.IMPLEMENT.length;i++){this._makeInheritance(constructor,constructor.IMPLEMENT[i],true)}};JAK.ClassMaker._makeInheritance=function(constructor,parent,noSuper){for(var p in parent.prototype){var item=parent.prototype[p];if(typeof item!="function"){continue}if(!item.owner){item.owner=parent}}if(!noSuper){constructor.prototype=Object.create(parent.prototype);for(var p in parent.prototype){if(typeof parent.prototype[p]!="object"){continue}constructor.prototype[p]=JSON.parse(JSON.stringify(parent.prototype[p]))}return}for(var p in parent.prototype){if(typeof parent.prototype[p]=="object"){constructor.prototype[p]=JSON.parse(JSON.stringify(parent.prototype[p]))}else{constructor.prototype[p]=parent.prototype[p]}}};JAK.ClassMaker._testDepend=function(depend){for(var i=0;i<depend.length;i++){var item=depend[i];if(!item.sClass){return"Unsatisfied dependency"}if(!item.ver){return"Version not specified in dependency"}var depMajor=item.sClass.VERSION.split(".")[0];var claMajor=item.ver.split(".")[0];if(depMajor!=claMajor){return"Version conflict in "+item.sClass.NAME}}return false};JAK.ClassMaker._$super=function(){var caller=arguments.callee.caller;if(!caller){throw new Error("Function.prototype.caller not supported")}var owner=caller.owner||this.constructor;var callerName=false;for(var name in owner.prototype){if(owner.prototype[name]==caller){callerName=name;break}}if(!callerName){throw new Error("Cannot find supplied method in constructor")}var parent=owner.EXTEND;if(!parent){throw new Error("No super-class available")}if(!parent.prototype[callerName]){throw new Error("Super-class doesn't have method '"+callerName+"'")}var func=parent.prototype[callerName];return func.apply(this,arguments)};JAK.Events=JAK.ClassMaker.makeStatic({NAME:"JAK.Events",VERSION:"3.3"});JAK.Events._events={};JAK.Events._domReadyCallbacks=[];JAK.Events.onDomReady=function(obj,func){var f=typeof func=="function"?func:obj[func];if(obj){f=f.bind(obj)}if(document.readyState=="complete"){return setTimeout(f,0)}if(!this._domReadyCallbacks.length){var process=function(){while(this._domReadyCallbacks.length){this._domReadyCallbacks.shift()()}};document.addEventListener("DOMContentLoaded",process.bind(this),false)}this._domReadyCallbacks.push(f)};JAK.Events.addListener=function(elm,type,obj,func,capture){obj=obj||window;capture=capture||false;var id=JAK.idGenerator();var action=obj;if(func){if(typeof func=="string"){if(typeof obj[func]!="function"){throw new Error("Events.addLisd of argumene,elm,id)}}else{action=function(e){func.f(typeof obj=="function"){action=function(e{action=function(e){e.currentTarget=elm;obj.handleEvent(e)}}this._addListener(elm,type,action,capture);this._events[id]={elm:elm,type:type,action:action,capture:capture};return id};JAK.Events._addListener=function(elm,type,action,capture){var types=type.split(" ");for(var i=0;i<types.length;i++){var t=types[i];if(elm.addEventListener){elm.addEventListener(t,action,capture)}else{elm.attachEvent("on"+t,action)}}};JAK.Events.removeListener=function(id){if(!(id in this._events)){throw new Error("Cannot remove non-existent event ID '"+id+"'")}var obj=this._events[id];this._removeListener(obj.elm,obj.type,obj.action,obj.capture);delete this._events[id]};JAK.Events._removeListener=function(elm,type,action,capture){var types=type.split(" ");for(var i=0;i<types.length;i++){var t=types[i];if(elm.removeEventListener){elm.removeEventListener(t,action,capture)}else{elm.detachEvent("on"+t,action)}}};JAK.Events.removeListeners=function(array){while(array.length){this.reion(){for(var id in this._events){this.removeListener(id)}};JAK.Events.stopEvent=function(e){var e=e||window.event;if(e.stopPropagation){e.stopPropagation()}else{e.cancelBubble=true}};JAK.Events.cancelDef=function(e){var e=e||window.event;if(e.preventDefault){e.preventDefault()}else{e.returnValue=false}};JAK.Events.getTarget=function(e){var e=e||window.event;return e.target||e.srcElement};JAK.Browser=JAK.ClassMaker.makeStatic({NAME:"JAK.Browser",VERSION:"3.0"});JAK.Browser.platform="";JAK.Browser.client="";JAK.Browser.version=0;JAK.Browser.agent="";JAK.Browser.mouse={};this.ieCompatibilityView=false;JAK.Browser._getPlatform=function(){if(this._agent.indexOf("Windows Phone")!=-1){return"wph"}else if(this._agent.indexOf("iPhone")!=-1||this._agent.indexOf("iPod")!=-1||this._agent.indexOf("iPad")!=-1){return"ios"}else if(this._agent.indexOf("Android")!=-1){return"and"}else if(this._agent.indexOf("X11")!=-1||this._agent.indexOf("Linux")!=-1){return"nix"}else if(this._agent.indexOf("Mac")!=-1){return"mac"}else if(this._agent.indexOf("Win")!=-1){return"win"}else{return"oth"}};JAK.Browser._getClient=function(){if(window.opera){return"opera"}else if(this._agent.indexOf("Edge")!=-1){return"edge"}else if(window.chrome){return"chrome"}else if("all"in document&&"systemLanguage"in navigator){return"ie"}else if(document.getAnonymousElementByAttribute||"mozPaintCount"in window){return"gecko"}else if(this._agent.indexOf("KHTML")!=-1){if(this._vendor=="KDE"){return"konqueror"}else if(this._vendor.indexOf("Apple")!=-1){return"safari"}else{return"oth"}}else{return"oth"}};JAK.Browser._getMouse=function(){if(JAK.Browser.client=="ie"&&parseFloat(JAK.Browser.version)<9){return{left:1,middle:4,right:2}}else{return{left:0,middle:1,right:2}}};JAK.Browser._getVersion=function(){var out=0;var fncName="_get_"+this.client+"_ver";if(typeof this[fncName]=="function"){return this[fncName]()}else{return"0"}};JAK.Browser._get_ie_ver=function(){if(!Function.prototype.call){return"5.0"}if(!window.ActiveXObject&&"ActiveXObject"in window){return"11"}else if("draggable"in document.createElement("div")){return"10"}else if(document.addEventListener){return"9"}else if(Object.prototype.toString.call(window.JSON)==="[object JSON]"){return"8"}else if(window.XMLHttpRequest){return"7"}else if(typeof document.doctype=="object"){return"6"}else{return"5.5"}};JAK.Browser._get_opera_ver=function(){if(window.opera.version){return window.opera.version()}else{if(document.createComment){return"7"}else{return"6"}}};JAK.Browser._get_gecko_ver=function(){if("textOverflow"in document.createElement("div").style){return"7"}else if(window.EventSource){return"6"}else if("onloadend"in new XMLHttpRequest){return"5"}else if(history.pushState){return"4"}else if(document.getBoxObjectFor===undefined){return"3.6"}else if(navigator.geolocation){return"3.5"}else if(document.getElementsByClassName){return"3"}else if(window.external){return"2"}else{return"1.5"}};JAK.Browser._get_konqueror_ver=function(){var num=this._agent.indexOf("KHTML")+6;var part=this._agent.substring(num);var end=part.indexOf(" ");var x=part.substring(0,end-2);return x};JAK.Browser._get_safari_ver=function(){var ver=this._agent.match(/version\/([0s._agent.match(/Chrome\/([0-9]+)/i);return ver?ver[1]:null};JAK.Browser.isOld=function(){if(this.client=="ie"&&parseFloat(this.version)<=7){return true}if(this.client=="opera"&&parseFloat(this.version)<9.5){return true}if(this.client=="gecko"&&parseFloat(this.version)<2){return true}if(this.client=="konqueror"&&parseFloat(this.version)<3.5){return true}if(!document.documentElement){return true}if(!document.documentElement.addEventListener&&!document.documentElement.attachEvent){return true}var f=function(){};if(!f.call||!f.apply){return true}return false};JAK.Browser._testIeCompatibilityView=function(client,agent){if(client!="ie"){return false}var test=agent.match(/Trident\/([4-9])/);if(!test){return false}return agent.indexOf("MSIE 7.0")>-1};JAK.Browser.getBrowser=function(){this._agent=this.agent=navigator.userAgent;this._platform=navigator.platform;this._vendor=navigator.vendor;this.platform=this._getPlatform();this.client=this._getClient();this.version=this._getVersion();this.mouse=this._getMouse();this.ieCompatibilityView=this._testIeCompatibilityView(this.client,this._agent)};JAK.Browser.getBrowser();JAK.DOM=JAK.ClassMaker.makeStatic({NAME:"JAK.DOM",VERSION:"5.0"});JAK.cel=function(tagName,className,id,doc){var d=doc||document;var node=d.createElement(tagName);if(className){node.className=className}if(id){node.id=id}return node};JAK.mel=function(tagName,properties,styles,doc){var d=doc||document;var node=d.createElement(tagName);if(properties){for(var p in properties){node[p]=properties[p]}}if(styles){JAK.DOM.setStyle(node,styles)}return node};JAK.ctext=function(str,doc){var d=doc||document;return d.createTextNode(str)};JAK.gel=function(id,doc){var d=doc||document;if(typeof id=="string"){return d.getElementById(id)}else{return id}};JAK.query=function(query,root){var results=(root||document).querySelectorAll(query);var array=new Array(results.length);for(var i=0;i<results.length;i++){array[i]=results[i]}return array};JAK.DOM.append=function(){for(var i=0;i<arguments.length;i++){var arr=arguments[i];var head=arr[0];for(var j=1;j<ant,className){retplit(" ").forEach(fuion(element,clement.firstChild){element.removeChild(element.firstChild)}};JAK.DOM.getDocSize=function(){var x=0;var y=0;if(document.compatMode!="BackCompat"){if(document.documentElement.clientWidth&&JAK.Browser.client!="opera"){x=document.documentElement.clientWidth;y=document.documentElement.clientHeight}else if(JAK.Browser.client=="opera"){if(parseFloat(JAK.Browser.version)<9.5){x=document.body.clientWidth;y=document.body.clientHeight}else{x=document.documentElement.clientWidth;y=document.documentElement.clientHeight}}if(JAK.Browser.client=="safari"||JAK.Browser.client=="konqueror"){y=window.innerHeight}}else{x=document.body.clientWidth;y=document.body.clientHeight}return{width:x,height:y}};JAK.DOM.getBoxPosition=function(obj,ref){var top=0;var left=0;var refBox=ref||obj.ownerDocument.body;if(obj.getBoundingClientRect&&!ref){var de=document.documentElement;var box=obj.getBoundingClientRect();var scroll=JAK.DOM.getBoxScroll(obj);return{left:box.left+scroll.x-de.clientLeft,top:box.top+scroll.y-de.clientTop}}while(obj&&obj!=refBox){top+=obj.offsetTop;left+=obj.offsetLeft;if(JAK.Browser.client=="gecko"&&JAK.Browser.version<3||JAK.Browser.client=="safari"){if(JAK.DOM.getStyle(obj,"position")=="fixed"){var scroll=JAK.DOM.getScrollPos();top+=scroll.y;left+=scroll.x;break}}obj=obj.offsetParent}return{top:top,left:left}};JAK.DOM.getPosition=function(obj,ref){var refBox=ref||obj.ownerDocument.documentElement;var coordsObj=obj.getBoundingClientRect();var coordsRef=refBox.getBoundingClientRect();return{top:coordsObj.top-coordsRef.top,left:coordsObj.left-coordsRef.left}};JAK.DOM.getPortBoxPosition=function(obj,parent,fixed){var pos=JAK.DOM.getBoxPosition(obj,parent);var scroll=JAK.DOM.getBoxScroll(obj,parent,fixed);pos.left-=scroll.x;pos.top-=scroll.y;return{left:pos.left,top:pos.top}};JAK.DOM.getPortPosition=function(obj){var pos=JAK.DOM.getPosition(obj);var scroll=JAK.DOM.getScrollPos();return{left:pos.left-scroll.x,top:pos.top-scroll.y}};JAK.DOM.getBoxScroll=function(obj,ref,fixed){var x=0;var y=0;var cur=obj.parentNode;var limit=ref||obj.ownerDocument.documentElement;var fix=false;while(1){if(JAK.Browser.client=="opera"&&cur.parentNode&&JAK.DOM.getStyle(cur,"display")!="block"){cur=cur.parentNode;continue}if(cur==document.body&&cur.scrollLeft==cur.parentNode.scrollLeft&&cur.scrollTop==cur.parentNode.scrollTop){cur=cur.parentNode;continue}if(fixed&&JAK.DOM.getStyle(cur,"position")=="fixed"){fix=true}if(!fix){x+=cur.scrollLeft;y+=cur.scrollTop}if(cur==limit){break}cur=cur.parentNode;if(!cur){break}}return{x:x,y:y}};JAK.DOM.getScrollPos=function(){if(document.documentElement.scrollTop||document.documentElement.scrollLeft){var ox=document.documentElement.scrollLeft;var oy=document.documentElement.scrollTop}else if(document.body.scrollTop||document.body.scrollLeft){var ox=document.body.scrollLeft;var oy=document.body.scrollTop}else{var ox=0;var oy=0}return{x:ox,y:oy}};JAK.DOM.getStyle=function(elm,property){if(document.defaultView&&document.defaultView.getComputedStyle){var cs=elm.ownerDocument.defaultView.getComputedStyle(elm,"");if(!cs){return false}return cs[propertystyle){for(var name in style){elm.style[name]=style[name]}};JAK.DOM.writeStyle=function(css){var node=JAK.mel("style",{type:"text/css"});if(node.styleSheet){node.styleSheet.cssText=css}else{node.appendChild(JAK.ctext(css))}var head=document.getElementsByTagName("head");if(head.length){head=head[0]}else{head=JAK.cel("head");document.documentElement.appendChild(head)}head.appendChild(node);return node};JAK.DOM.elementsHider=function(obj,elements,action){var elems=elements;if(!elems){elems=["select","object","embed","iframe"]}var hidden=arguments.callee.hidden;if(hidden){hidden.forEach(function(node){node.style.visibility="visible"});arguments.callee.hidden=[]}function verifyParent(node){var ok=false;var cur=node;while(cur.parentNode&&cur!=document){if(cur==obj){ok=true}cur=cur.parentNode}return ok}if(action=="hide"){if(typeof obj=="string"){obj=JAK.gel(obj)}var hidden=[];var box=this.getBoxPosition(obj);box.width=obj.offsetWidth+box.left;box.height=obj.offsetHeight+box.top;for(var e=0;e<elems.length;++e){var elm=document.getElementsByTagName(elems[e]);for(var f=0;f<elm.length;++f){var node=this.getBoxPosition(elm[f]);if(verifyParent(elm[f])){continue}node.width=elm[f].offsetWidth+node.left;node.height=elm[f].offsetHeight+node.top;if(!(box.left>node.width||box.width<node.left||box.top>node.height||box.height<node.top)){elm[f].style.visibility="hidden";hidden.push(elm[f])}}}arguments.callee.hidden=hidden}};JAK.DOM.getElementsByClass=function(searchClass,node,tag){var nodeName=tag||"";var parent=node||document;var selector=nodeName+"."+searchClass;return this.arrayFromCollection(parent.querySelectorAll(selector))};JAK.DOM.arrayFromCollection=function(col){var result=[];try{result=Array.prototype.slice.call(col)}catch(e){for(var i=0;i<col.length;i++){result.push(col[i])}}finally{return result}};JAK.DOM.separateCode=function(str){var js=[];var ]*?)<\/script>/g,function(tag,code){js.push(code);return""});return[s,js.join("\n")]};JAK.DOM.shiftBox=function(box){var dx=0;var dy=0;var pos=JAK.DOM.getBoxPosition(box);var scroll=JAK.DOM.getScrollPos();pos.left-=scroll.x;pos.top-=scroll.y;var port=JAK.DOM.getDocSize();var w=box.offsetWidth;var h=box.offsetHeight;var diff=pos.top+h-port.height;if(diff>0){pos.top-=diff;dy-=diff}var diff=pos.left+w-port.width;if(diff>0){pos.left-=diff;dx-=diff}var diff=pos.top;if(diff<0){pos.top-=diff;dy-=diff}var diff=pos.left;if(diff<0){pos.left-=diff;dx-=diff}return[dx,dy]};JAK.DOM.scrollbarWidth=function(){var div=JAK.mel("div",null,{width:"50px",height:"50px",overflow:"hidden",position:"absolute",left:"-200px"});var innerDiv=JAK.mel("div",null,{height:"100px"});div.appendChild(innerDiv);document.body.insertBefore(div,document.body.firstChild);var w1=div.clientWidth+parseInt(JAK.DOM.getStyle(div,"paddingLeft"))+parseInt(JAK.DOM.getStyle(div,"paddingRight"));JAK.DOM.setStyle(div,{overflowY:"scroll"});var w2=div.clientWidth+parseInt(JAK.DOM.getStyle(div,"paddingLeft"))+parseInt(JAK.DOM.getStyle(div,"paddingRight"));document.body.removeChild(div);return w1-w2};JAK.DOM.findParent=function(node,selector){var parts=(selector||"").match(/[#.]?[a-z0-9_-]+/gi)||[];var n=node.parentNode;while(n&&n!=document){var ok=true;for(var i=0;i<parts.length;i++){var part=parts[i];switch(part.charAt(0)){case"#":if(n.id!=part.substring(1)){ok=false}break;case".":if(!JAK.DOM.hasClass(n,part.substring(1))){ok=false}break;default:if(n.nodeName.toLowerCase()!=part.toLowerCase()){ok=false}break}}if(ok){return n}n=n.parentNode}return null};JAK.ObjLib=JAK.ClassMaker.makeClass({NAME:"ObjLib",VERSION:"3.1"});JAK.ObjLib.prototype.reSetOptions=function(){};JAK.ObjLib.prototype.pretty=function(str){return str};JAK.ObjLib.prototype.serialize=function(objToSource){return JSON.stringify(objToSource)};JAK.ObjLib.prototype.unserialize=function(serializedString){retuj){return JSON.stringify(ron(objToCopy){return JSON.parse(JSON.stringify(objToCopy))};JAK.ObjLib.prototype.arrayCopy=function(arrayToCopy){return this.copy(arrayToCopy)};JAK.Request=JAK.ClassMaker.makeClass({NAME:"JAK.Request",VERSION:"2.0"});JAK.Request.XML=0;JAK.Request.TEXT=1;JAK.Request.JSONP=2;JAK.Request.BINARY=3;JAK.Request.supportsCrossOrigin=function(){if(JAK.Browser.client=="opera"&&parseFloat(JAK.Browser.version)<12){return false}if(JAK.Browser.client=="ie"&&JAK.Browser.version<8){return false}if(JAK.Browser.client=="gecko"&&parseFloat(JAK.Browser.version)<3.5){return false}return true};JAK.Request.supportsUpload=function(){return window.XMLHttpRequest&&!!(new XMLHttpRequest).upload};JAK.Request.prototype.$constructor=function(type,options){this._NEW=0;this._SENT=1;this._DONE=2;this._ABORTED=3;this._TIMEOUT=4;this._PROGRESS=5;this._xhr=null;this._callback="";this._script=null;this._type=type;this._headers={};this._callbacks={};this._state=this._NEW;this._xdomain=false;this._promise=new JAK.Promise;this._handleProgress=false;this._options={async:true,timeout:0,method:"get"};for(var p in options){this._options[p]=options[p]}if(this._type==JAK.Request.JSONP){if(this._options.method.toLowerCase()=="post"){throw new Error("POST not supported in JSONP mode")}if(!this._options.async){throw new Error("Sync not supported in JSONP mode")}}};JAK.Request.prototype.$destructor=function(){if(this._state==this._SENT){this.abort()}this._xhr=null};JAK.Request.prototype.setHeaders=function(headers){if(this._type==JAK.Request.JSONP){throw new Error("Request headers not supported in JSONP mode")}for(var p in headers){this._headers[p]=headers[p]}};JAK.Request.prototype.getHeaders=function(){if(this._state!=this._DONE){throw new Error("Response headers not available")}if(this._type==JAK.Request.JSONP){throw new Error("Response headers not supported in JSONP mode")}var headers={};var h=this._xhr.getAllResponseHeaders();if(h){h=h.split(/[\r\n]/);for(var i=0;i<h.length;i++)if(h[i]){var v=h[i].match(/^([^:]+): *(.*)$/);headers[v[1]]=v[2]}}return headers};JAK.Request.prototype.send=function(url,data){if(this._state!=this._NEW){throw new Error("Request already sent")}this._state=this._SENT;this._userCallback(this);switch(this._type){case JAK.Request.XML:case JAK.Request.TEXT:case JAK.Request.BINARY:this._sendXHR(url,data);break;case JAK.Request.JSONP:this._sendScript(url,data);break;default:throw new Error("Unknown request type");break}return this._promise};JAK.Request.prototype.abort=function(){if(this._state!=this._SENT){return false}this._state=this._ABORTED;if(this._xhr){this._xhr.abort()}this._userCallback(this);this._promise.reject({type:"abort",request:this});return true};JAK.Request.prototype.setCallback=function(obj,method){this._setCallback(obj,method,this._DONE);return this};JAK.Request.prototype.setSendCallback=function(obj,method){this._setCallback(obj,method,this._SENT);return this};JAK.Request.prototype.setAbortCallback=function(obj,method){this._setCallback(obj,method,this._ABORTED);return this};JAK.Request.prototype.setTimeoutCallback=function(obj,method){this._setCallback(obj,method,this._TIMEOUT);return this};JAK.Request.prototype.setProgressCallback=function(obj,method){this._handleProgress=true;this._setCallback(obj,method,thistion(obj,method,state){this._callbacks[state]=[obj,method]};JAK.Request.prototype._sendXHR=function(url,data){if(window.XMLHttpRequest){this._xhr=new XMLHttpRequest;var r=url.match(/^(https?\:)?\/\/(.*?)\//);if(r&&r[2]!=location.host&&window.XDomainRequest&&!this._xhr.upload){if(this._type==JAK.Request.BINARY){throw new Error("XDomainRequest does not support BINARY mode")}if(this._type==JAK.Request.XML){throw new Error("XDomainRequest does not support XML mode")}this._xdomain=true;this._xhr=new XDomainRequest}}else if(window.ActiveXObject){this._xhr=new ActiveXObject("Microsoft.XMLHTTP")}else{throw new Error("No XHR available")}if(this._xdomain){this._xhr.onload=this._onXDomainRequestLoad.bind(this);this._xhr.onerror=this._onXDomainRequestError.bind(this)}else{this._xhr.onreadystatechange=this._onReadyStateChange.bind(this)}var u,d;if(this._options.method.toLowerCase()=="get"){u=this._buildURL(url,data);d=null}else{u=url;d=this._serializeData(data);var ctSet=false;for(var p in this._headers){if(p.toLowerCase()=="content-type"){ctSet=true;break}}if(!ctSet){this.setHeaders({"Content-Type":"application/x-www-form-urlencoded"})}}if(this._type==JAK.Request.BINARY){if(this._xhr.overrideMimeType){this._xhr.overrideMimeType("text/plain; charset=x-user-defined")}else if(JAK.Browser.client=="ie"){this._buildVBS()}else{throw new Error("This browser does not support binary transfer")}}if(this._handleProgress&&this._xhr.upload){JAK.Events.addListener(this._xhr.upload,"progress",this,"_progressCallback")}this._xhr.open(this._options.method,u,this._options.async);if(this._options.async){this._xhr.withCredentials=this._options.withCredentials}for(var p in this._headers){this._xhr.setRequestHeader(p,this._headers[p])}this._xhr.send(d);if(this._options.timeout){setTimeout(this._timeout.bind(this),this._options.timeout)}if(!this._options.async){this._onReadyStateChange()}};JAK.Request.prototype._sendScript=function(url,data){var o=data||{};this._callback="callback"+JAK.idGenerator();o.callback=this._callback;var url=this._buildURL(url,o);window[this._callback]=this._scriptCallback.bind(this);this._script=JAK.mel("script",{type:"text/javascript",src:url});document.body.insertBefore(this._script,document.body.firstChild)};JAK.Request.prototype._buildURL=function(url,data){var s=this._serializeData(data);if(!s.length){return url}if(url.indexOf("?")==-1){return url+"?"+s}else{return url+"&"+s}};JAK.Request.prototype._serializeData=function(data){if(typeof data=="string"){return data}if(window.File&&data instanceof File){return data}if(!data){return""}var arr=[];for(var p in data){var value=data[p];if(!(value instanceof Array)){value=[value]}for(var i=0;i<value.length;i++){arr.push(encodeURIComponent(p)+"="+encodeURIComponent(value[i]))}}return arr.join("&")};JAK.Request.prototype._onReadyStateChange=function(){if(this._state==this._ABORTED){return}if(this._state==this._TIMEOUT){return}if(this._xhr.readyState!=4){return}this._xhr.onreadystatechange=null;var status=this._xhr.status;var data;if(this._type==JAK.Request.BINARY){data=[];if(this._xhr.overrideMimeType){var text=this._xhr.responseText;var length=text.length;for(var i=0;i<length;i++){data.push(text.charCodeAt(i)&255)}}else{var length=VBS_getLength(this._xhr.responseBody);for(var i=0;i<length;i++){data.push(VBS_getByte(this._xhr.responseBody,i))}}}else{data=this._type==JAK.Request.XML?this._xhr.responseXML:this._xhr.responseText}this._done(data,status)};JAK.Request.prototype._onXDomainRequestLoad=function(){if(this._state==this._ABORTED){return}var data=this._xhr.responseText;if(this._type==JAK.Request.XML){var xml=new ActiveXObject("Microsoft.XMLDOM");xml.async=false;xml.loadXML(data);data=xml}this._done(data,200)};JAK.Request.prototype._onXDomainRequestError=function(){if(this._state==this._ABORTED){return}this._state=this._ABORTED;this._userCallback(this);this._promise.reject({type:"error",request:this})};JAK.Request.prototype._progressCallback=function(data){var num=data.loaded/data.total;var state=this._state;this._state=this._PROGRESS;this._userCallback(num);this._state=state};JAK.Request.prototype._scriptCallback=function(data){this._script.parentNode.removeChild(this._script);this._script=null;try{delete window[this._callback]}catch(e){}if(this._state!=this._ABORTED){this._done(data,200)}};JAK.Request.prototype._done=function(data,status){if(this._state==this._DONE){return}this._state=this._DONE;this._userCallback(data,status,this);if(status){this._promise.fulfill({data:data,status:status,request:this})}else{this._promise.reject({type:"abort",request:this})}};JAK.Request.prototype._timeout=function(){if(this._state!=this._SENT){return}this._state=this._TIMEOUT;if(this._xhr){this._xhr.abort()}this._userCallback(this);this._promise.reject({type:"timeout",request:this})};JAK.Request.prototype._userCallback=function(args){var data=this._callbacks[this._state];if(!data){return}var obj=data[0]||window;var method=data[1];if(obj&&typeof method=="string"){method=obj[method]}if(!method){method=obj;obj=window}method.apply(obj,arguments)};JAK.Request.prototype._buildVBS=function(){var s=JAK.mel("script",{type:"text/vbscript"});s.text="Function VBS_getByte(data, pos)\n"+"VBS_getByte = AscB(MidB(data, pos+1,1))\n"+"End Function\n"+"Function VBS_getLength(data)\n"+"VBS_getLength = LenB(data)\n"+"End Function";document.getElementsByTagName("head")[0].appendChild(s)};JAK.Signals=JAK.ClassMaker.makeClass({NAME:"JAK.tor=function(){this._myHandleFolder={};this._myIdFolder={}};JAK.Signals.prototype.addListener=function(owner,type,funcOrString,sender){var newId=JAK.idGenerator();var typeFolders=[];var data={eOwner:owner,eFunction:funcOrString,eSender:sender};var types=type.split(" ");for(var i=0;i<types.length;i++){var t=types[i];if(!(t in this._myHandleFolder)){this._myHandleFolder[t]={}}var typeFolder=this._myHandleFolder[t];var ok=true;for(var id in typeFolder){var item=typeFolder[id];if(item.eFunction==funcOrString&&item.eOwner==owner&&item.eSender==sender){ok=false}}if(!ok){continue}typeFolder[newId]=data;typeFolders.push(typeFolder)}if(typeFolders.length){this._myIdFolder[newId]=typeFolders;return newId}else{return null}};JAK.Signals.prototype.removeListener=function(id){var typeFolders=this._myIdFolder[id];if(!typeFolders){console.error("Cannot remove non-existent signal ID '"+id+"'")}while(typeFolders.length){var typeFolder=typeFolders.pop();delete typeFolder[id]}delete this._myIdFolder[id]};JAK.Signals.prototype.removeListeners=function(array){while(array.length){this.removeListener(array.shift())}};JAK.Signals.prototype.makeEvent=function(type,trg,data){var event={type:type,target:trg,timeStamp:(new Date).getTime(),data:data&&typeof data=="object"?data:null};this._myEventHandler(event)};JAK.Signals.prototype._myEventHandler=function(myEvent){var functionCache=[];for(var type in this._myHandleFolder){if(type==myEvent.type||type=="*"){for(var p in this._myHandleFolder[type]){var item=this._myHandleFolder[type][p];if(!item.eSender||item.eSender==myEvent.target){functionCache.push(item)}}}}for(var i=0;i<functionCache.length;i++){var item=functionCache[i];var owner=item.eOwner;var fnc=item.eFunction;if(typeof fnc=="string"){owner[fnc](myEvent)}else if(typeof fnc=="function"){fnc(myEvent)}}};JAK.signals=new JAK.Signals;JAK.ISignals=JAK.ClassMaker.makeInterface({NAME:"JAK.ISignals",VERSION:"2.1"});JAK.ISignals.prototype.setInterface=function(interfaceName){if(typeof this[interfaceName]=="object"){return this[interfaceName]}var owner=this._owner;while(typeof owner[interfaceName]=="undefined"){if(typeof owner.TOP_LEVEL!="undefined"){throw new Error("SetInterface:Interface not found")}else{owner=owner._owner}}return owner[interfaceName]};JAK.ISignals.prototype.addListener=function(type,handleFunction,sender){return this.getInterface().addListener(this,type,hafunction(id){return this.getInterface()function(array){this.getInterface().removeListeners(array)};JAK.ISignals.prototype.makeEvent=function(type,data){this.getInterface().makeEvent(type,this,data)};JAK.ISignals.prototype.getInterface=function(){return typeof this.signals=="object"?this.signals:JAK.signals};JAK.AbstractDecorator=JAK.ClassMaker.makeSingleton({NAME:"JAK.AbstractDecorator",VERSION:"2.0"});JAK.AbstractDecorator.prototype.decorate=function(instance){instance.$super=this._$super;if(!instance.__decorators){instance.__decorators=[]}instance.__decorators.push(this);return instance};JAK.AbstractDecorator.prototype._$super=function(){var caller=arguments.callee.caller;if(!caller){throw new Error("Function.prototype.caller not supported")}var decorators=this.__decorators||[];var obj=null;var name=null;var i=decorators.length;while(i--){var d=decorators[i];if(!obj&&name&&name in d){obj=d;break}for(var p in d){if(!name&&caller==d[p]){name=p;break}}}if(!name){var owner=caller.owner||this.constructor;var callerName=false;for(var name in owner.prototype){if(owner.prototype[name]==caller){callerName=name}}if(!callerName){throw new Error("Cannot find supplied method in constructor")}var parent=owner.EXTEND;if(!parent){throw new Error("No super-class available")}if(!parent.prototype[callerName]){throw new Error("Super-class doesn't have method '"+callerName+"'")}var func=parent.prototype[callerName];return func.apply(this,arguments)}else if(!obj){obj=this.constructor.prototype;if(!(name in obj)){throw new Error("Function '"+name+"' has no undecorated parent")}}return obj[name].apply(this,arguments)};JAK.AutoDecorator=JAK.ClassMaker.makeSingleton({NAME:"JAK.AutoDecorator",VERSION:"1.0",EXTEND:JAK.AbstractDecorator});JAK.AutoDecorator.prototype.decorate=function(instance){this.$super(instance);var exclude=["constructor","$super","_$super","decorate"];for(var p in this){if(exclude.indexOf(p)!=-1){continue}instance[p]=this[p]}};JAK.IDecorable=JAK.ClassMaker.makeClass({NAME:"JAK.IDecorable",VERSION:"2.0",CLASS:"class"});JAK.IDecorable.prototype.decorate=function(decorator){var args=[this];for(var i=1;i<arguments.length;i++){args.push(arguments[i])}var dec=decorator.getInstance();return dec.decorate.apply(dec,args)};JAK.Timekeeper=JAK.ClassMaker.makeSingleton({NAME:"JAK.Timekeeper",VERSION:"1.1"});JAK.Timekeeper.prototype.$constructor=function(){this._listeners=[];this._running=0;this._tick=this._tick.bind(this);this._scheduler=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback,element){setTimeout(callback,1e3/60)}};JAK.Timekeeper.prototype.addListener=function(what,method,count){var index=this._findListener(what);if(index!=-1){throw new Error("This listener is already attached")}var obj={what:what,method:method,count:count||1,bucket:0};obj.bucket=obj.count;this._listeners.push(obj);if(this._running!=2){if(this._running==0){this._schedule()}this._running=2}return this};JAK.Timekeeper.prototype.removeListener=function(what){var index=this._findListener(what);if(index==-1){throw new Error("Cannot find listener to be removed")}this._listeners.splice(index,1);if(!this._listeners.length){this._ru;i++){if(this._listeners[i].what==what){return i}}return-1};JAK.Timekeeper.prototype._tick=function(){if(this._running==1){this._running=0}if(this._running==0){return}this._schedule();for(var i=0;i<this._listeners.length;i++){var item=this._listeners[i];item.bucket--;if(item.bucket){continue}item.bucket=item.count;var obj=item.what;var method=typeof item.method=="string"?obj[item.method]:item.method;method.call(obj)}};JAK.Timekeeper.prototype._schedule=function(){var s=this._scheduler;s(this._tick,null)};JAK.C=JAK.ClassMaker.makeClass({NAME:"JAK.C",VERSION:"1.0",IMPLEMENT:JAK.ISignals});JAK.C.prototype.$constructor=function(){this.LIMIT=1e3;this.DEBUG=false;this.REMOTE={active:false,limit:10,what:["error"]};this._native=window.console;this._data=[];this._lost=0;this._defineLogMethod("log");this._defineLogMethod("info");this._defineLogMethod("warn");this._defineLogMethod("debug");this._defineLogMethod("tion(){this._lost=0;this._data=[];this.makeEvent("change")};JAK.C.prototype.getLost=function(){return this._lost};JAK.C.prototype.getData=function(){return this._data};JAK.C.prototyhis;this[type]=function(){return self._log(type,arguments)}};JAK.C.prototype._log=function(type,args){this._data.push({type:type,args:args,ts:(new Date).getTime()});while(this._data.length>this.LIMIT){this._data.shift();this._lost++}if(this.REMOTE.active&&window.DOT&&this.REMOTE.what.indexOf(type)>-1&&this.REMOTE.limit){this.REMOTE.limit--;DOT.hit("error",{d:{type:type,args:args}})}if(this.DEBUG&&this._native){var nativeMethod=this._native[type];if(!nativeMethod){nativeMethod=this._native.log;if(!nativeMethod){return}}return Function.prototype.apply.call(nativeMethod,this._native,args)}this.makeEvent("change")};!window.console&&(window.console=new JAK.C);JAK.Promise=JAK.ClassMaker.makeClass({NAME:"JAK.Promise",VERSION:"1.0"});JAK.Promise.prototype.$constructor=function(resolver){this._state=0;this._value=null;this._cb={fulfilled:[],rejected:[]};this._thenPromises=[];if(resolver){this._invokeResolver(resolver)}};JAK.Promise.all=JAK.Promise.when=function(all){var promise=new this;var counter=0;var results=[];for(var i=0;i<all.length;i++){counter++;all[i].then(function(index,result){results[index]=result;counter--;if(!counter){promise.fulfill(results)}}.bind(null,i),function(reason){counter=1/0;promise.reject(reason)})}return promise};JAK.Promise.prototype.then=function(onFulfilled,onRejected){this._cb.fulfilled.push(onFulfilled);this._cb.rejected.push(onRejected);var thenPromise=new JAK.Promise;this._thenPromises.push(thenPromise);if(this._state>0){setTimeout(this._processQueue.bind(h"]=function(onRejected){return this.then(null,onRejected)};JAK.Promise.prototype.fulfill=function(value){if(this._state!=0){return this}this._state=1;this._value=value;this._processQueue();return this};JAK.Promise.prototype.reject=function(value){if(this._state!=0){return this}this._state=2;this._value=value;this._processQueue();return this};JAK.Promise.prototype.chain=function(promise){return this.then(promise.fulfill.bind(promise),promise.reject.bind(promise))};JAK.Promise.prototype._processQueue=function(){while(this._thenPromises.length){var onFulfilled=this._cb.fulfilled.shift();var onRejected=this._cb.rejected.shift();this._executeCallback(this._state==1?onFulfilled:onRejected)}};JAK.Promise.prototype._executeCallback=function(cb){var thenPromise=this._thenPromises.shift();if(typeof cb!="function"){if(this._state==1){thenPromise.fulfill(this._value)}else{thenPromise.reject(this._value)}return}try{var returned=cb(this._value);if(returned&&typeof returned.then=="function"){var fulfillThenPromise=function(value){thenPromise.fulfill(value)};var rejectThenPromise=function(value){thenPromise.reject(value)};returned.then(fulfillThenPromise,rejectThenPromise)}else{thenPromise.fulfill(returned)}}catch(e){if(window.console&&window.console.error){console.error(e)}thenPromise.reject(e)}};JAK.Promise.prototype._invokeResolver=function(resolver){try{resolver(this.fulfill.bind(this),this.reject.bind(this))}catch(e){this.reject(e)}};(function(){var buildDOM=function(){var nodes=Array.prototype.slice.call(arguments),frag=document.createDocumentFragment(),div,node;while(node=nodes.shift()){if(typeof node=="string"){div=document.createElement("div");div.innerHTML=node;while(div.firstChild){frag.appendChild(div.firstChild)}}else{frag.appendChild(node)}}return frag};var proto={before:function(){var frag=buildDOM.apply(this,arguments);this.parentNode.insertBefore(frag,this)},after:function(){var frag=buildDOM.apply(this,arguments);this.parentNode.insertBefore(frag,this.nextSibling)},replaceWith:function(){if(this.parentNode){var frag=buildDOM.apply(this,n(){if(this.parentNode){this.parentNode.removeChild(this)}}};var a=["Element","DocumentType","CharacterData"];var b=["before","after","replaceWith","remove"];a.forEach(function(v){b.forEach(function(func){if(window[v]){if(window[v].prototype[func]){return}window[v].prototype[func]=proto[func]}})})})();(function(){if(document.addEventListener||!window.Element||!window.Event){return}var expando="__events";var flag="__immediateStopped";Event.prototype.NONE=Event.NONE=0;Event.prototype.CAPTURING_PHASE=Event.CAPTURING_PHASE=1;Event.prototype.AT_TARGET=Event.AT_TARGET=2;Event.prototype.BUBBLING_PHASE=Event.BUBBLING_PHASE=3;Event.prototype.preventDefault=function(){if(this.cancelable!==false){this.returnValue=false}};Event.prototype.stopPropagation=function(){this.tePropagation=function(){this[flag]=this.cancelBubble=true};var decorate=function(e,listenerNode){e.timeStamp=+new Date;if(!e.target){e.target=e.srcElement||listenerNode}e.pageX=e.clientX+document.documentElement.scrollLeft;e.pageY=e.clientY+document.documentElement.scrollTop;if(e.type=="mouseover"){e.relatedTarget=e.fromElement}else if(e.type=="mouseout"){e.relatedTarget=e.toElement}else{e.relatedTarget=null}return e};var indexOf=function(data,listener,useCapture){for(var i=0;i<data.length;i++){var item=data[i];if(item.useCapture==useCapture&&item.listener==listener){return i}}return-1};var fire=function(event,listener,currentTarget){event.currentTarget=currentTarget;if(typeof listener=="function"){listener.call(currentTarget,event)}else{listener.handleEvent(event)}};var getAncestors=function(node){var result=[];while(node.parentNode){result.unshift(node.parentNode);node=node.parentNode}return result};var runListeners=function(event,nodes,phase){event.eventPhase=phase;for(var i=0;i<nodes.length;i++){var node=nodes[i];var listeners=[];var data=(node[expando]||{})[event.type]||[];for(var j=0;j<data.length;j++){var item=data[j];if(item.useCapture&&phase==Event.BUBBLING_PHASE){continue}if(!item.useCapture&&phase==Event.CAPTURING_PHASE){continue}listeners.push(item.listener)}j=0;while(j<listeners.length){try{while(j<listeners.length){var listener=listeners[j++];fire(event,listelag]){return true}}}catch(e){setTimeout(function(){throw e},0)}}if(event.cancelBubble){return true}}return false};var handler=function(event){decorate(event,this);var ancestors=getAncestors(event.target);if(ancestors.length){if(runListeners(event,ancestors,Event.CAPTURING_PHASE)){return event.returnValue}}if(runListeners(event,[event.target],Event.AT_TARGET)){return event.returnValue}if(ancestors.length&&event.bubbles!==false){ancestors.reverse();if(runListeners(event,ancestors,Event.BUBBLING_PHASE)){return event.returnValue}}event.stopPropagation();return event.returnValue};var proto={addEventListener:function(type,listener,useCapture){var data=(this[expando]||{})[type]||[];var count=data.length;if(indexOf(data,listener,useCapture)>-1){return}if(expando in this){var storage=this[expando]}else{var storage={_handler:handler.bind(this)};this[expando]=storage}if(!(type in storage)){storage[type]=[]}storage[type].push({listener:listener,useCapture:useCapture});if(!count){this.attachEvent("on"+type,storage._handler)}},removeEventListener:function(type,listener,useCapture){var data=(this[expando]||{})[type]||[];var index=indexOf(data,listener,useCapture);if(index==-1){return}data.splice(index,1);if(!data.length){this.detachEvent("on"+type,this[expando]._handler)}},dispatchEvent:function(event){event.returnValue=true;return handler.call(this,event)}};var todo=[Element,window.constructor,document.constructor];while(todo.length){var parent=todo.pop();for(var p in proto){parent.prototype[p]=proto[p]}}})();(function(){if(!window.MouseEvent){window.MouseEvent=function(type,props){if(!arguments.length){throw new Error("Not enough arguments")}var def={type:type,cancelable:false,bubbles:false};var event=document.createEventObject();for(var p in def){event[p]=def[p]}for(var p in props){event[p]=props[p]}return event};return}try{new MouseEvent("click")}catch(e){var ME=function(type,props){if(!arguments.length){throw new Error("Not enough arguments")}var def={type:type,bubbles:false,cancelable:false,view:window,detail:1,screenX:0,screenY:0,clientX:0,clientY:0,ctrlKey:false,altLey:false,shiftKey:false,metaKey:false,button:0,relatedTarget:null};for(var p in props){def[p]=props[p]}var event=document.createEvent("MouseEvent");event.initMouseEvent(def.type,def.bubbles,def.cancelable,def.view,def.detail,def.screenX,def.screenY,def.clientX,def.clientY,def.ctrlKey,def.altKey,def.shiftKey,def.metaKey,def.button,def.relatedTarget);return event};ME.prototype=window.MouseEvent.prototype;window.MouseEvent=ME}})();(function(){if(!window.CustomEvent&&document.createEventObject){window.CustomEvent=function(type,props){if(!arguments.length){throw new Error("Not enough arguments")}var def={type:type,bubbles:false,cancelable:false,detail:null};var event=document.createEventObject();for(var p in def){event[p]=def[p]}for(var p in props){event[p]=props[p]}return event};return}try{new CustomEvent("test")}catch(e){var CE=function(type,props){if(!arguments.length){throw new Error("Not enough arguments")}var def={bubbles:false,cancelable:false,detail:null};for(var p in props){def[p]=props[p]}var event=document.createEvent("CustomEvent");event.initCustomEvent(type,def.bubbles,def.cancelable,def.detail);return event};CE.prototype=(window.CustomEvent||window.Event).prototype;window.CustomEvent=CE}})();(function(){if(window.getSelection){return}document.addEventListener("readystatechange",function(e){if(document.readyState=="complete"){var event=new CustomEvent("DOMContentLoaded");document.dispatchEvent(event)}})})();window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||wintAnimationFrame||function(cb){return setTimeout(cb,1e3/60)};window.cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame||function(id){return clearTimeout(id)};(function(){if("ongesturechange"in window||!"ontouchstart"in window){return}varget){setTimeout(function(){target.dispatchEvent(event)},0)};document.addEventListener("touchstart",function(e){if(e.touches.length!=2){return}var t1=e.touches[0];var t2=e.touches[1];var dx=t1.clientX-t2.clientX;var dy=t1.clientY-t2.clientY;dist1=Math.sqrt(dx*dx+dy*dy);angle1=Math.atan2(dy,dx);gestureStarted=true;var event=new CustomEvent("gesturestart",{bubbles:true});dispatch(event,e.target)},false);document.addEventListener("touchmove",function(e){if(e.touches.length!=2){return}var t1=e.touches[0];var t2=e.touches[1];var dx=t1.clientX-t2.clientX;var dy=t1.clientY-t2.clientY;var dist2=Math.sqrt(dx*dx+dy*dy);var angle2=Math.atan2(dy,dx);var event=new CustomEvent("gesturechange",{bubbles:true});event.altKey=e.altKey;event.ctrlKey=e.ctrlKey;event.metaKey=e.metaKey;event.shiftKey=e.shiftKey;event.rotation=(angle2-angle1)*(180/Math.PI)%360;event.altKey=e.altKey;event.scale=dist2/dist1;dispatch(event,e.target)},false);document.addEventListener("touchend",function(e){if(!gestureStarted){return}gestureStarted=false;var event=new CustomEvent("gestureend",{bubbles:true});dispatch(event,e.target)},false)})();
(function(){if(typeof Element.prototype.matches!=="function"){Element.prototype.matches=Element.prototype.msMatchesSelector||Element.prototype.m[index]!==element){++index}return Boolean(elements[index])}}if(typeof Elemenor)){return element}element=element.parentNode}return null}}var testObject={};if(!(Object.setPrototypeOf||testObject.__proto__)){var nativeGetPrototypeOf=Object.getPrototypeOf;Object.getPrototypeOf=function(object){if(object.__proto__){return object.__proto__}else{return nativeGetPsc.enumerable){to[nextKey]=nextSource[nextKey]}}}return to};try{Object.defineProperty(Object,"assign",{enumerable:false,configurable:true,writable:true,value:if(!Math.sign){Math.sign=function(x){return(x>0)-(x<0)||+x}}if(!String.prototype.padStart){String.prototype.padStart=function padStart(targetLength,padString){targetLength=targetLength>>0;padString=String(typeof padString!=="undefined"?padString:" ");if(this.length>=targetLength){return String(this)}else{targetLength=targetLength-this.length;if(targetLength>padString.length){padString+=padString.repeat(targetLength/padString.length)}return padString.slice(0,targetLength)+String(this)}}}})();JAK.VecNd=JAK.ClassMaker.makeClass({NAME:"JAK.VecNd",VERSION:"2.0"});JAK.VecNd.prototype.$constructor=function(n){this.n=n;this.data=[];for(var i=0;i<n;i++){var val=arguments.length>i+1?arguments[i+1]:0;this.data.push(val)}};JAK.VecNd.prototype.setN=function(n,val){this.data[n]=val};JAK.VecNd.prototype.getN=function(n){return this.data[n]};JAK.VecNd.prototype.norm=function(degree){var d=degree||2;var sum=0;for(var i=0;i<this.n;i++){sum+=Math.pow(this.getN(i),d)}return Math.pow(sum,1/d)};JAK.VecNd.prototype._plus=function(t){for(var i=0;i<this.n;i++){this.setN(i,this.getN(i)+t.getN(i))}return this};JAK.VecNd.prototype.plus=function(t){var result=this.clone();return result._plus(t)};JAK.VecNd.prototype._minus=function(t){for(var i=0;i<this.n;i++){this.setN(i,this.getN(i)-t.getN(i))}return this};JAK.VecNd.prototype.minus=function(t){var result=this.clone();return result._minus(t)};JAK.VecNd.prototype._multiply=function(num){for(var i=0;i<this.n;i++){this.setN(i,this.getN(i)*num)}return this};JAK.VecNd.prototype.multiply=function(num){var result=this.clone();return result._multiply(num)};JAK.VecNd.prototype.dot=function(t){var result=0;for(var i=0;i<this.n;i++){result+=this.getN(i)*t.getN(i)}return result};JAK.VecNd.prototype._unit=function(degree){var n=this.norm(degree);for(var i=0;i<this.n;i++){this.setN(i,this.getN(i)/n)}return this};JAK.VecNd.prototype.unit=function(degree){var result=this.clone();return result._unit(degree)};JAK.VecNd.prototype.clone=function(){var result=new this.constructor(this.n);for(var i=0;i<this.n;i++){result.setN(i,this.getN(i))}return result};JAK.VecNd.prototype.join=function(separator,round){var s=separator||",";var arr=[];for(var i=0;i<this.n;i++){var val=this.getN(i);if(round){val=Math.round(val)}arrrototype.toString=function(){return"["+this.join(", ")+"]"};JAK.Vec2d=JAK.ClassMaker.makeClass({NAME:"Vec2d",VERSION:"2.0",EXTEND:JAK.VecNd});JAK.Vec2d.prototype.$constructor=function(x,y){JAK.VecNd.prototype.$constructor.call(this,2,x,y)};JAK.Vec2d.prototyp[0]=x};JAK.Vec2d.prototype.setY=function(y){this.data[1]=y};JAK.Vec2d.prototype.ge]};JAK.Vec2d.prototype.getY=function(){return this.data[1]};JAK.Vec2d.prototype.normal=function(){return new this.constructor(this.getY(),-this.getX())};JAK.Vec2d.prototype._symmetry=function(axis){var norm=axis.normal()._unit();var coef=this.dot(norm);return this._xis){var result=this.clone();return result._symmetry(axis)};JAK.Vec2d.prototype.distance=function(p1,p2){var vec=p2.minus(p1);var n=vec.normal().unit();var a1=p1.getX();var a2=p1.getY();var c1=this.getX();var c2=this.getY();var v1=vec.getX();var v2=vec.getY();var w1=n.getX();var w2=n.getY();var dist=(v1*c2-v2*c1+a1*v2-a2*v1)/(w1*v2-v1*w2);return-dist};JAK.Vector=JAK.ClassMaker.makeStatic({NAME:"JAK.Vector",VERSION:"2.0",DEPEND:[{sClass:JAK.Vec2d,ver:"2.0"}]});JAK.Vector.STYLE_SOLID=0;JAK.Vector.STYLE_DASH=1;JAK.Vector.STYLE_DOT=2;JAK.Vector.STYLE_DASHDOT=3;JAK.Vector.END_STYLE_ROUND=0;JAK.Vector.END_STYLE_SQUARE=1;JAK.Vector.getCanvas=function(w,h){if(JAK.SVG.isSupported()){return new JAK.SVG(w,h)}else if(JAK.VML.isSupported(w,h)){return new JAK.VML(w,h)}else{return new JAK.Vector.Canvas(w,h)}};JAK.Vector.Canvas=JAK.ClassMaker.makeClass({NAME:"JAK.Vector.Canvactor=function(width,height){this._container=JAK.mel("div")};JAK.Vector.Canvas.prototype.clear=function(){};JAK.Vector.Canvas.prototype.resize=function(width,height){};JAK.Vector.Canvas.prototype.setScale=function(scale){};JAK.Vector.Canvas.prototype.getContainer=function(){return this._container};JAK.Vector.Canvas.prototype.getContent=function(){return this._container};JAK.Vector.Canvas.prototype.setContent=function(content){};JAK.Vector.Canvas.prototype.circle=function(){};JAK.Vector.Canvas.prototype.ellipse=function(){};JAK.Vector.Canvas.prototype.polyline=function(){};JAK.Vector.Canvas.prototype.polygon=function(){};JAK.Vector.Canvas.pror.Canvas.prototype.group=function(){return JAK.mel("div")};JAK.Vector.Canvas.prototype.setStroke=function(element,options){};JAK.Vector.Canvas.prototype.setFill=function(element,options){};JAK.Vector.Canvas.prototype.setCenterRadius=function(eleanvas.prototype.setPoints=function(element,points,closed){};JAK.Vector.Canvas.prototype.setFormat=funcunction(element,title){element.setAttribute("title",title)};JAK.Vector.Canvas.prototype.computeControlPointsSymmetric=function(points,options){var o={flat:true,curvature:20,join:false};for(var p in options){o[p]=options[p]}if(points.length<2||points.length==2&&!o.join){return false}var result=[];var X=false;var Y=false;var limit=o.join?points.length:points.length-1;for(var i=0;i<limit;i++){var A=points[i];if(o.join){var B=i+1==points.length?points[0]:points[i+1];var C=i+2>=points.length?points[i+2-points.length]:points[i+2]}else{var B=points[i+1];var C=i+2==points.length?false:points[i+2]}if(!C){var AB=B.minus(A);if(o.flat){Y=A.plus(AB.multiply(.5))}else{var vAX=X.minus(A);var vYB=vAX.symmetry(AB);Y=B.minus(vYB)}}else{var vAC=C.minus(A);var l=vAC.norm();var frac=l/o.curvature;if(!frac){frac=Infinity}var vYB=vAC.multiply(1/frac);Y=B.minus(vYB)}if(!X){var AB=B.minus(A);if(o.join){var D=points[points.length-1];var vBD=D.minus(B);var l=vBD.norm();var frac=l/o.curvature;if(!frac){frac=Infinity}var vXA=vBD.multiply(1/frac);X=A.minus(vXA)}else if(o.flat){X=A.plus(AB.multiply(.5))}else{var vAX=vYB.symmetry(AB);X=A.plus(vAX)}}result.push([X,Y]);X=B.plus(vYB)}return result};JAK.Vector.Canvas.prototype.computeControlPoints=function(points,options){var o={flat:true,curvature:20,join:false};for(var p in options){o[p]=options[p]}o.curvature=o.curvature/100;if(points.length<2||points.length==2&&!o.join){return false}var result=[];var X=false;var Y=false;var limit=o.join?points.length:points.length-1;for(var i=0;i<limit;i++){var A=points[i];if(o.join){var B=i+1==points.length?points[0]:points[i+1];var C=i+2>=points.length?points[i+2-points.length]:points[i+2];var D=i?points[i-1]:points[points.length-1]}else{var B=points[i+1];var C=i+2==points.length?false:points[i+2];var D=i?points[i-1]:false}var AB=B.minus(A);if(!C){if(o.flat){Y=A.plus(AB.multiply(.5))}else{var vAX=X.minus(A);var vYB=vAX.symmetry(AB);Y=B.minus(vYB)}}else{var vAC=C.minus(A);var dist=AB.norm()*o.curvature;var norm=vAC.norm();var vYB=vAC.multiply(dist/norm||0);Y=B.minus(vYB)}if(D){var vBD=D.minus(B);var vBA=B.minus(A);var dist=vBA.norm()*o.curvature;var norm=vBD.norm();var vXA=vBD.multiply(dist/norm||0);X=A.minus(vXA)}else if(o.flat){X=A.plus(AB.multiply(.5))}else{var vAX=vYB.symmetry(AB);X=A.plus(vAX)}result.push([X,Y])}return result};JAK.Vector.Primitive=JAK.ClassMaker.makeClass({NAME:"JAK.Vector.Primitive",on(canvas){this.canvas=canvas;this.elm=null;this.elm2=null};JAK.Vector.Primitive.prototype.getNodes=function(){var arr=[this.elm];if(this.elm2){arr.push(this.elm2)}return arr};JAK.Vector.Primitive.prototype.$destructor=function(){if(this.elm&&this.elm.parentNode&&this.elm.parentNode.nodeType==1){this.elm.parentNode.removeChild(this.elm)}if(this.elm2&&this.elm2.parentNode&&this.elm2.parentNode.nodeType==1){this.elm2.parentNode.removeChild(this.elm2)}};JAK.Vector.Line=JAK.ClassMaker.makeClass({NAME:"JAK.Vector.Line",VERSION:"1.0",EXTEND:JAK.Vector.Primitive});JAK.Vector.Line.prototype.$constructor=function(canvas,points,options){this.canvas=canvas;this.elm2=null;this.options={color:"#000",width:1,curvature:0,opacity:1,style:JAK.Vector.STYLE_SOLID,outlineColor:"#fff",outlineOpacity:1,outlineWidth:0,outlineStyle:JAK.Vector.STYLE_SOLID,title:"",symmetricCP:true};for(var p in options){this.options[p]=options[p]}this._build(points)};JAK.Vector.Line.prototype._build=function(points){if(this.elm){this.elm.parentNode.removeChild(this.elm)}if(this.elm2){this.elm2.parentNode.removeChild(this.elm2)}if(this.options.curvature){this.elm=this.canvas.path();if(this.options.outlineWidth){this.elm2=this.canvas.path()}}else{this.elm=this.canvas.polyline();if(this.options.outlineWidth){this.elm2=this.canvas.polyline()}}this.canvas.setTitle(this.elm,this.options.title);if(this.options.outlineWidth){this.canvas.setTitle(this.elm2,this.options.title);this.canvas.getContent().appendChild(this.elm2)}this.canvas.getContent().appendChild(this.elm);this.setPoints(points);this.setOptions(this.options)};JAK.Vector.Line.prototype.setCurvature=function(c){if(!!this.options.curvature!=!!c){this.options.curvature=c;this._build(this.points)}else{this.options.curvature=c;this.setPoints(this.points)}};JAK.Vector.Line.prototype.$destructor=function(){if(this.elm.parentNode&&this.elm.parentNode.nodeType==1){this.elm.parentNode.removeChild(this.elm)}if(this.elm2&&this.elm2.parentNode&&this.elm2.parentNode.nodeType==1){this.elm2.parentNode.removeChild(this.elm2)}};JAK.Vector.Line.prototype.setPoints=function(points){this.points=points;if(this.options.curvature){var d="M "+this.points[0].join(" ");var len=this.points.length;if(len>2){if(this.options.symmetricCP){var control=this.canvas.computeControlPointsSymmetric(this.points,{join:false,curvature:this.options.curvature})}else{var control=this.canvas.computeControlPoints(this.points,{join:false,curvature:this.options.curvature})}for(var i=1;i<len;i++){var c=control[i-1];var x=c[0];var y=c[1];var point=this.points[i];d+="C "+x.join(" ")+", "+y.join(" ")+", "+point.join(" ")+" "}}else{for(var i=1;i<len;i++){var point=this.points[i];d+="L  "+point.join(" ")+" "}}this.canvas.setFormat(this.elm,d);if(this.elm2){this.canvas.setFormat(this.elm2,d)}}else{this.canvas.setPoints(this.elm,points);if(this.elm2){this.canvas.setPoints(this.elm2,points)}}};JAK.Vector.Line.prototype.setOptions=function(options){var o={};if("width"in options){o.width=options.width;this.options.width=options.width}if("opacity"in options){o.opacity=options.opacity}if("color"in options){o.color=options.color}if("style"in options){o.style=options.style}if("endCap"in options){o.endCap=options.endCap}if("exactStyle"in options){o.exactStyle=options.exactStyle}this.canvas.setStroke(this.elm,o);if(this.elm2){o={};if("outlineWidth"in options){o.width=2*options.outlineWidth+this.options.width}if("outlineOpacity"in options){o.opacity=options.outlineOpacity}if("outlineColor"in options){o.color=options.outlineColor}if("outlineStyle"in options){o.style=options.outlineStyle}if("outlineEndCap"in options){o.endCap=options.outlineEndCap}if("outlineExactStyle"in options){o.exactStyle=options.outlineExactStyle}this.canvas.setStroke(this.elm2,o)}};JAK.Vector.Polygon=JAK.ClassMaker.makeClass({NAME:"JAK.Vector.Polygon",VERSION:"1.0",EXTEND:JAK.Vector.Primitive});JAK.Vector.Polygon.prototype.$constructor=function(canvas,points,options){this.canvas=canvas;this.options={color:"#000",curvature:0,opacity:1,outlineColor:"#fff",outlineOpacity:1,outlineWidth:0,outlineStyle:JAK.Vector.STYLE_SOLID,title:"",symmetricCP:true};for(var p in options){this.options[p]=options[p]}this._build(points)};JAK.Vector.Polygon.prototype._build=function(points){if(this.elm){this.elm.parentNode.removeChild(this.elm)}if(this.options.curvature){this.elm=this.canvas.path()}else{this.elm=this.canvas.polygon()}this.canvas.setTitle(this.elm,this.options.title);this.canvas.getContent().appendChild(this.elm);this.setPoints(points);this.setOptions(this.options)};JAK.Vector.Polygon.prototype.setPoints=function(points){this.points=points;if(this.options.curvature){if(this.options.symmetricCP){var control=this.canvas.computeControlPointsSymmetric(this.points,{join:true,curvature:this.options.curvature})}else{var control=this.canvas.computeControlPoints(this.points,{join:true,curvature:this.options.curvature})}var d="M "+this.points[0].join(" ");var len=this.points.length;for(var i=1;i<len+1;i++){var c=control[i-1];var x=c[0];var y=c[1];var point=i>=len?this.points[0]:this.points[i];d+="C "+x.join(" ")+", "+y.join(" ")+", "+point.join(" ")+" "}d+="Z";this.canvas.setFormat(this.elm,d)}else{this.canvas.setPoints(this.elm,points,true)}};JAK.Vector.Polygon.prototype.setOptions=function(options){var stroke={};if("outlineColor"in options){stroke.color=options.outlineColor}if("outlineWidth"in options){stroke.width=options.outlineWidth}if("outlineOpacity"in options){stroke.opacity=options.outlineOpacity}if("outlineStyle"in options){stroke.style=options.outlineStyle}if("outlineEndCap"in options){stroke.endCap=options.outlineEndCap}if("outlineExactStyle"in options){stroke.exactStyle=options.outlineExactStyle}var fill={};if("color"in options){fill.color=options.color}if("opacity"in options){fill.opacity=options.opacity}if("fillRule"in options){fill.fillRule=options.fillRule}this.canvas.setStroke(this.elm,stroke);this.canvas.setFill(this.elm,fill)};JAK.Vector.Polygon.prototype.setCurvature=function(c){if(!!this.options.curvature!=!!c){this.options.curvature=c;this._build(this.points)}else{this.options.curvature=c;this.setPoints(this.points)}};JAK.Vector.Circle=JAK.ClassMaker.makeClass({NAME:"JAK.Vector.Circle",VERSION:"1.0",EXTEND:JAK.Vector.Primitive});JAK.Vector.Circle.prototype._method="circle";JAK.Vector.Circle.prototype.$constructor=function(canvas,center,radius,options){this.canvas=canvas;this.center=new JAK.Vec2d(0,0);this.radius=0;this.options={color:"",opacity:1,outlineColor:"#000",outlineOpacity:1,outlineWidth:1,outlineStyle:JAK.Vector.STYLE_SOLID,title:""};for(var p in options){this.options[p]=options[p]}var stroke={color:this.options.outlineColor,width:this.options.outlineWidth,opacity:this.options.outlineOpacity,style:this.options.outlineStyle};var fill={color:this.options.color,opacity:this.options.opacity};this.elm=this.canvas[this._method]();this.setCenter(center);this.setRadius(radius);this.canvas.setTitle(this.elm,this.options.title);this.canvas.getContent().appendChild(this.elm);this.setOptions(this.options)};JAK.Vector.Circle.prototype.setCenter=function(center){this.center=center;this.canvas.setCenterRadius(this.elm,this.center,this.radius)};JAK.Vector.Circle.prototype.setOptions=function(options){var stroke={};if("outlineColor"in options){stroke.color=options.outlineColor}if("outlineWidth"in options){stroke.width=options.outlineWidth}if("outlineOpacity"in options){stroke.opacity=options.outlineOpacity}if("outlineStyle"in options){stroke.style=options.outlineStyle}if("outlineEndCap"in options){stroke.endCap=options.outlineEndCap}if("outlineExactStyle"in options){stroke.exactStyle=options.outlineExactStyle}var fill={};if("color"in options){fill.color=options.color}if("opacity"in options){fill.opacity=options.opacity}this.canvas.setStroke(this.elm,stroke);this.canvas.setFill(this.elm,fill)};JAK.Vector.Circle.prototype.setRadius=function(radius){this.radius=radius;this.canvas.setCenterRadius(this.elm,this.center,this.radius)};JAK.Vector.Ellipse=JAK.ClassMaker.makeClass({NAME:"JAK.Vector.Ellipse",VERSION:"1.0",EXTEND:JAK.Vector.Circle});JAK.Vector.Ellipse.prototype._method="ellipse";JAK.Vector.Path=JAK.ClassMaker.makeClass({NAME:"JAK.Vector.Path",VERSION:"1.0",EXTEND:JAK.Vector.Primitive});JAK.Vector.Path.prototype.$constructor=function(canvas,format,options){this.canvas=canvas;this.elm2=null;this.options={color:"none",opacity:1,width:0,style:JAK.Vector.STYLE_SOLID,outlineColor:"#fff",outlineOpacity:1,outlineWidth:1,outlineStyle:JAK.Vector.STYLE_SOLID,title:""};for(var p in options){this.options[p]=options[p]}var stroke={color:this.options.outlineColor,width:this.options.outlineWidth,opacity:this.options.outlineOpacity,style:this.options.outlineStyle};var fill={width:this.options.width,color:this.options.color,opacity:this.options.opacity,style:this.options.style};var two=this.options.width&&!format.match(/z/i);this.elm=this.canvas.path();this.setFormat(format);if(two){this.elm2=this.canvas.path();this.setFormat(format);this.canvas.setTitle(this.elm2,this.options.title)}this.canvas.setTitle(this.elm,this.options.title);if(this.elm2){this.canvas.getContent().appendChild(this.elm2)}this.canvas.getContent().appendChild(this.elm);this.setOptions(this.options)};JAK.Vector.Path.prototype.$destructor=function(){if(this.elm.parentNode&&this.elm.parentNode.nodeType==1){this.elm.parentNode.removeChild(this.elm)}if(this.elm2&&this.elm2.parentNode&&this.elm2.parentNode.nodeType==1){this.elm2.parentNode.removeChild(this.elm2)}};JAK.Vector.Path.prototype.setFormat=function(format){this.canvas.setFormat(this.elm,format);if(this.elm2){this.canvas.setFormat(this.elm2,format)}};JAK.Vector.Path.prototype.setOptions=function(options){var stroke={};if("outlineColor"in options){stroke.color=options.outlineColor}if("outlineWidth"in options){stroke.width=options.outlineWidth}if("outlineOpacity"in options){stroke.opacity=options.outlineOpacity}if("outlineStyle"in options){stroke.style=options.outlineStyle}if("outlineEndCap"in options){stroke.endCap=options.outlineEndCap}if("outlineExactStyle"in options){stroke.exactStyle=options.outlineExactStyle}var fill={};if("color"in options){fill.color=options.color}if("opacity"in options){fill.opacity=options.opacity}if("width"in options){fill.width=options.width}if("style"in options){fill.style=options.style}if("endCap"in options){fill.endCap=options.endCap}if("exactStyle"in options){fill.exactStyle=options.exactStyle}if("fillRule"in options){fill.fillRule=options.fillRule}if(this.elm2){if(stroke.width){stroke.width=fill.width+2*stroke.width}this.canvas.setStroke(this.elm,fill);this.canvas.setStroke(this.elm2,stroke)}else{this.canvas.setStroke(this.elm,stroke);this.canvas.setFill(this.elm,fill)}};JAK.SVG=JAK.ClassMaker.makeClass({NAME:"SVG",VERSION:"3.0",EXTEND:JAK.Vector.Canvas});JAK.SVG.isSupported=function(){if(!document.createElementNS){return false}var svg=document.createElementNS(this.prototype.ns,"svg");if(!svg.style){return false}return true};JAK.SVG.prototype.ns="http://www.w3.org/2000/svg";JAK.SVG.prototype.xlinkns="http://www.w3.org/1999/xlink";JAK.SVG.prototype._styles=[[],[4,3],[1,2],[4,2,1,2]];JAK.SVG.prototype._lineEnds=["round","square"];JAK.SVG.prototype.$constructor=function(width,height){var svg=document.createElementNS(this.ns,"svg");svg.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink",this.xlinkns);var g=document.createElementNS(this.ns,"g");svg.appendChild(g);this.ec=[];this.ec.push(JAK.Events.addListener(svg,"mousemove",JAK.Events.cancelDef));this.ec.push(JAK.Events.addListener(svg,"mousedown",JAK.Events.cancelDef));this.ec.push(JAK.Events.addListener(svg,"mouseup",JAK.Events.cancelDef));this.canvas=svg;this.g=g;this.resize(width,height)};JAK.SVG.prototype.$destructor=function(){for(var i=0;i<this.ec.length;i++){JAK.Events.removeListener(this.ec[i])}this.ec=[];if(this.canvas.parentNode&&this.canvas.parentNode.nodeType==1){this.canvas.parentNode.removeChild(this.canvas)}this.canvas=null};JAK.SVG.prototype.getContainer=function(){return this.canvas};JAK.SVG.prototype.getContent=function(){return this.g};JAK.SVG.prototype.setConten};JAK.SVG.prototype.cleare("width",width);this.canvascale){this.g.setAttribute("transform","scale("+scale+")")};JAK.SVG.prototype.polyline=function(){var el=document.createElementNS(this.ns,"polyline");el.setAttribute("fill","none");el.setAttribute("stroke","none");el.setAttribute("stroke-linejoin","round");el.setAttribute("stroke-linecap","round");return el};JAK.SVG.prototype.circle=function(){var el=document.createElementNS(this.ns,"circle");el.setAttribute("fill","none");el.setAttribute("stroke","none");return el};JAK.SVG.prototype.ellipse=function(){var el=document.createElementNS(this.ns,"ellipse");el.setAttribute("fill","none");el.setAttribute("stroke","none");return el};JAK.SVG.prototype.polygon=function(){var el=document.createElementNS(this.ns,"polygon");el.setAttribute("fill","none");el.setAttribute("stroke","none");el.setAttribute("stroke-linejoin","round");el.setAttribute("stroke-linecap","round");return el};JAK.SVG.prototype.path=function(){var el=document.createElementNS(this.ns,"path");el.setAttribute("fill","none");el.setAttribute("stroke","none");el.setAttribute("stroke-linejoin","round");el.setAttribute("up=function(){return document.createElementNS(this.ns,"g")};JAK.SVG.prototype.setStroke=function(element,options){if("color"in options){element.setAttribute("stroke",options.color)}if("opacity"in options){element.setAttribute("stroke-opacity",options.opacity)}if("width"in options){element.setAttribute("stroke-width",options.width)}if("style"in options){var width=parseFloat(element.getAttribute("stroke-width"));var arr=this._styles[options.style];var i=arr.length;var dashes=[];while(i--){dashes[i]=Math.max(1,arr[i]*width+(i%2?1:-1)*width)}element.setAttribute("stroke-dasharray",dashes.join(" "))}if("endCap"in options){element.setAttribute("stroke-linecap",this._lineEnds[options.endCap])}if("exactStyle"in options){element.setAttribute("stroke-dasharray",options.exactStyle)}};JAK.SVG.prototype.setFill=function(element,options){if("color"in options){element.setAttribute("fill",options.color)}if("opacity"in options){element.setAttribute("fill-opacity",options.opacity)}if("fillRule"in options){element.setAttribute("fill-rule",options.fillRule)}};JAK.SVG.prototype.setCenterRadius=function(element,center,radius){element.setAttribute("cx",center.getX());element.setAttribute("cy",center.getY());if(radius instanceof Array){element.setAttribute("rx",radius[0]);element.setAttribute("ry",radius[1])}else{element.setAttribute("r",radius)}};JAK.SVG.prototype.sd){var arr=points.map(function(item){return item.join(" ")});element.setAttribute("points",arr.join(", "))};JAK.SVG.prototype.setFormat=function(element,format){element.setAttribute("d",format)};JAK.SVG.prototype.setTitle=function(element,title){var t=element.getElementsByTagName("title");if(t.length){t=t[0]}else{t=document.createElementNS(this.ns,"title");element.appendChild(t)}JAK.DOM.clear(t);t.appendChild(document.createTextNode(title))};JAK.VML=JAK.ClassMaker.makeClass({NAME:"VML",VVML.isSupported=function(){return JAK.Browser.client=="ie"};JAK.VML.prototype._styles=["","dash","dot","dashdot"];JAK.VML.prototype._lineEnds=["round","square"];JAK.VML.prototype.$constructor=function(width,height){if(JAK.Browser.client=="ie"&&!document.namespaces["vml"]){if(document.documentMode&&document.documentMode>=8){document.namespaces.add("vml","urn:schemas-microsoft-com:vml","#default#VML")}else{document.namespaces.add("vml","urn:schemas-microsoft-com:vml")}var s=document.createStyleSheet();s.cssText="vml\\:*{behavior:url(#default#VML);"}var storage=JAK.mel("div",null,{display:"none"});var tmp=JAK.mel("div",null,{display:"none"});document.body.insertBefore(storage,document.body.firstChild);document.body.insertBefore(tmp,document.body.firstChild);this.constructor.storage=storage;this.constructor.tmp=tmp;this.canvas=JAK.mel("div",null,{position:"absolute",overflow:"hidden"});this.resize(width,height);this.clear()};JAK.VML.prototype.$destructor=function(){if(this.canvas.parentNode&&this.canvas.parentNode.nodeType==1){this.canvas.parentNode.removeChiltype.setScale=function(scale){this.canvas.style.zoom=scale};JAK.VML.prototype.clear=function(){JAK.DOM.clear(this.canvas);var xxx=this._build("<vml:shape tyle.width=width+"px";this.canvas.style.height=height+"px"};JAK.VML.prototype.getContainer=function(){return this.canvas};JAK.VML.prototype.getContent=function(){return this.canvas};JAK.VML.prototype.setContent=function(content){this.canvas=content};JAK.VML.prototype.path=function(){var el=this._build("<vml:shape><vml:fill></vml:fill><vml:stroke endcap='round' joinstyle='round'></vml:stroke></vml:shape>");el.filled=false;el.stroked=false;el.style.position="absolute";el.style.width="1px";el.style.height="1px";el.coordsize="1,1";return el};JAK.VML.prototype.polyline=function(){var el=this._build("<vml:polyline><vml:fill></vml:fill><vml:stroke endcap='round' joinstyle='round'></vml:stroke></vml:polyline>");el.filled=false;el.stroked=false;return el};JAK.VML.prototype.polygon=function(){return this.polyline()};JAK.VML.prototype.circle=function(){var el=this._build("<vml:oval><vml:fill></vml:fill><vml:stroke></vml:stroke></vml:oval>");el.style.position="absolute";el.filled=false;el.stroked=false;return el};JAK.VML.prototype.ellipse=JAK.VML.prototype.circle;JAK.VML.prototype.group=function(){return JAK.mel("div")};JAK.VML.prototype.setStroke=function(element,options){if("color"in options){element.strokecolor=options.color}if("width"in options&&options.width){element.stroked=true;element.strokeweight=options.width+"px"}if("opacity"in options){element.getElementsByTagName("stroke")[0].opacity=options.opacity}if("style"in options){element.getElementsByTagName("stroke")[0].dashstyle=this._styles[options.style]}if("endCap"in options){element.getElementsByTagName("stroke")[0].endcap=this._lineEnds[options.endCap]}};JAK.VML.prototype.setFill=function(element,options){if("color"in options){element.filled=true;element.fillcolor=options.color}if("opacity"in options){element.getElementsByTagName("fill")[0].opacity=options.opacity}if("endCap"in options){element.getElementsByTagName("fill")[0].endcap=this._lineEnds[options.endCap]}};JAK.VML.prototype.setCenterRadius=function(element,center,radius){if(radius instanceof Array){element.style.left=center.getX()-radius[0]+"px";element.style.top=center.getY()-radius[1]+"px";element.style.width=radius[0]*2+"px";element.style.height=radius[1]*2+"px"}else{element.style.left=center.getX()-radius+"px";element.style.top=center.getY()-radius+"px";element.style.width=radius*2+"px";element.style.height=radius*2+"px"}};JAK.VML.prototype.setPoints=function(element,points,closed){var arr=[];for(var i=0;i<points.length;i++){arr.push(points[i].join(" "))}if(closed&&points.length){arr.push(points[0].join(" "))}if(!element.points){element.points=arr.join(" ")}else{element.points.value=arr.join(" ")}};JAK.VML.prototype._analyzeFormat=function(format){var data=[];var ptr=0;var current="";var obj=false;while(ptr<format.length){var ch=format.charAt(ptr);if(ch.match(/[a-z]/i)){if(current){obj.parameters.push(parseFloat(current))}if(obj){data.push(obj)}obj={command:ch,parameters:[]};current=""}else if(ch.match(/[ ,]/)){if(current){obj.parameters.push(parseFloat(current))}current=""}else{current+=ch}ptr++}if(current){obj.parameters.push(parseFloat(current))}if(obj){data.push(obj)}return data};JAK.VML.prototype._serializeFormat=function(data){var s="";for(var i=0;i<data=cmd.parameters.map(function(item){return Math.round(item)});s+=cmd.command+" "+numbers.join(" ")+" "}return s};JAK.VML.prototype._generateArc=function(parameters,coords){function calcAngle(ux,uy,vx,vy){var ta=Math.atan2(uy,ux);var tb=Math.atan2(vy,vx);if(tb>=ta){return tb-ta}return 2*Math.PI-(ta-tb)}function fixAngle(angle){var a=angle;a=360*a/(2*Math.PI);return a*(2<<15)}var r1=parameters[0];var r2=parameters[1];var x=parameters[5];var y=parameters[6];var cx=coords.getX();var cy=coords.getY();var largeArcFlag=parameters[3];var sweepFlag=parameters[4];var xp,yp,cxp,cyp;var angle=parameters[2];angle=angle*Math.PI/180;xp=Math.cos(angle)*(cx-x)/2+Math.sin(angle)*(cy-y)/2;yp=-Math.sin(angle)*(cx-x)/2+Math.cos(angle)*(cy-y)/2;var root=0;var numerator=r1*r1*r2*r2-r1*r1*yp*yp-r2*r2*xp*xp;if(numerator<0){var s=Math.sqrt(1-numerator/(r1*r1*r2*r2));r1*=s;r2*=s;root=0}else{root=Math.sqrt(numerator/(r1*r1*yp*yp+r2*r2*xp*xp));if(largeArcFlag==sweepFlag){root=-root}}cxp=root*r1*yp/r2;cyp=-root*r2*xp/r1;var centerX=Math.cos(angle)*cxp-Math.sin(angle)*cyp+(cx+x)/2;var centerY=Math.sin(angle)*cxp+Math.cos(angle)*cyp+(cy+y)/2;var theta=calcAngle(1,0,(xp-cxp)/r1,(yp-cyp)/r2);var delta=calcAngle((xp-cxp)/r1,(yp-cyp)/r2,(-xp-cxp)/r1,(-yp-cyp)/r2);if(!sweepFlag&&delta>0){delta-=2*Math.PI}else if(sweepFlag&&delta<0){delta+=2*Math.PI}coords.setX(x);coords.setY(y);return[centerX,centerY,r1,r2,-fixAngle(theta),-fixAngle(delta)]};JAK.VML.prototype._fixFormat=function(format){var coords=new JAK.Vec2d(0,0);var data=this._analyzeFormat(format);for(var i=0;i<data.length;i++){var cmd=data[i];switch(cmd.command){case"M":case"L":coords.setX(cmd.parameters[0]);coords.setY(cmd.parameters[1]);break;case"C":coords.setX(cmd.parameters[4]);coords.setY(cmd.parameters[5]);break;case"z":case"Z":cmd.command="X";break;case"A":cmd.command="AE";cmd.parameters=this._generateArc(cmd.parameters,coords);break}}data.push({command:"E",parameters:[]});return this._serializeFormat(data)};JAK.VML.prototype._build=function(str){this.constructor.tmp.innerHTML=str;var elm=this.constructor.tmp.firstChild;this.constructor.storage.appendChild(elm);return elm};JAK.VML.prototype.setFormat=function(element,format){var f=this._fixFormat(format);element.path=f};JAK.XML=JAK.ClassMaker.maktent=function(node){return node.textContent||node.text||""};JAK.XML.childElements=function(node,name){var arr=[];var ch=node.childNodes;for(var i=0;i<ch.length;i++){var x=ch[i];if(x.nodeType!=1){continue}if(name&&name.toLowerCase()!=x.nodeName.toLowerCase()){continue}arr.push(x)}return arr};JAK.XML.createDocument=function(xmlStr){if(!arguments.length){if(document.implementation&&document.implementation.createDocument){return document.implementation.createDocument("","",null)}else if(window.ActiveXObject){return new ActiveXObject("Microsoft.XMLDOM")}else{throw new Error("Can't create XML Document")}return}if(window.DOMParser){return(new DOMParser).parseFromString(xmlStr,"text/xml")}else if(window.ActiveXObject){var xml=new ActiveXObject("Microsoft.XMLDOM");xml.loadXML(xmlStr);return xml}else{throw new Error("No XML parser available")}};JAK.XML.serializeDocument=function(xmlDoc){if(window.XMLSerializer){var s=new XMLSerializer;return s.serializeToString(xmlDoc)}else if(xmlDoc.xml){return xmlDoc.xml}else{throw new Error("XML document serialization available")}};JAK.XML.RPC=JAK.ClassMaker.makeSXML.RPC.parse=function(node){return JAK.XMLRPC.parse(node)};JAK.Interpolator=JAK.ClassMaker.makeClass({NAME:"JAK.Interpolator",VERSION:"2.1",DEPEND:[{sClass:JAK.Timekeeper,ver:"1.0"}]});JAK.Interpolator.LINEAR=1;JAK.Interpolator.QUADRATIC=2;JAK.Interpolator.SQRT=3;JAK.Interpolator.SIN=4;JAK.Interpolator.ASIN=5;JAK.Interpolator.prototype.$constructor=function(startVal,endVal,interval,callback,options){this.startVal=startVal;this.endVal=endVal;this.interval=interval;this.callback=callback;this.options={interpolation:JAK.Interpolator.LINEAR,count:1,endCallback:false};this.running=false;for(var p in options){this.options[p]=options[p]}};JAK.Interpolator.prototype._call=function(frac){var result=this._interpolate(frac);var delta=this.endVal-this.startVal;this.callback(this.startVal+delta*result)};JAK.Interpolator.prototype._interpolate=function(val){if(typeof this.options.interpolation=="function"){return this.options.interpolation(val)}switch(this.options.interpolation){case JAK.Interpolator.QUADRATIC:return val*val;case JAK.Interpolator.SQRT:return Math.sqrt(val);case JAK.Interpolator.SIN:return(Math.sin(Math.PI*(val-.5))+1)/2;case JAK.Interpolator.ASIN:return(Math.asin(2*(val-.5))+Math.PI/2)/Math.PI;default:return val}};JAK.Interpolator.prototype.start=function(){if(this.running){return}this.running=true;this.startTime=(new Date).getTime();this._call(0);JAK.Timekeeper.getInstance().addListener(this,"_tick",this.options.count)};JAK.Interpolator.prototype.stop=function(){if(!this.running){return}this.running=false;JAK.Timekeeper.getInstance().removeListener(this)};JAK.Interpolator.prototype._tick=function(){var now=(new Date).getTime();var elapsed=now-this.startTime;if(elapsed>=this.interval){this.stop();this._call(1);if(this.options.endCallback){this.options.endCallback()}}else{this._call(elapsed/this.interval)}};JAK.CSSInterpolator=JAK.ClassMaker.makeClass({NAME:"CSSInterpolator",VERSION:"2.0"});JAK.CSSInterpolator.prototype.$constructor=function(elm,interval,options){this.elm=elm;this.properties=[];this.colors=[];this._tick=this._tick.bind(this);this.interpolator=new JAK.Interpolator(0,1,interval,this._tick,options)};JAK.CSSInterpolator.prototype.addProperty=function(property,startVal,endVal,suffix){var o={property:property,startVal:startVal,endVal:endVal,suffix:suffix||""};this.properties.push(o)};JAK.CSSInterpolator.prototype.addColorProperty=function(property,startVal,endVal){var o={startVal:JAK.Parser.color(startVal),endVal:JAK.Parser.color(endVal),property:property};this.colors.push(o)};JAK.CSSInterpolator.prototype.start=function(){thpolator.prototype.stop=function(){this.interpolator.stop()};JAK.CSSInterpolator.prototype._setOpacity=function(obj,prop,frac){var property="";var val=prop.startVal+frac*(prop.endVal-prop.startVal);if(JAK.Browser.client=="ie"&&JAK.Browser.version<9){property="filter";val=Math.round(100*val);val="progid:DXImageTransform.Microsoft.Alpha(opacity="+val+");"}else{property="opacity"}obj[property]=val};JAK.CSSInterpolator.prototype._tick=function(frac){for(var i=0;i<this.properties.length;i++){var prop=this.properties[i];switch(prop.property){case"opacity":this._setOpacity(this.elm.style,prop,frac);break;default:var val=prop.startVal+frac*(prop.endVal-prop.startVal);val+=prop.suffix;this.elm.style[prop.property]=val;break}}var names=["r","g","b"];for(var i=0;i<this.colors.length;i++){var c=this.colors[i];var out=[0,0,0];for(var j=0;j<names.length;j++){var name=names[j];out[j]=c.startVal[name]+Math.round(frac*(c.endVal[name]-c.startVal[name]))}var result="rgb("+out.join(",")+")";this.elm.style[c.property]=result}};JAK.RPC=JAK.ClassMaker.makeClass({NAME:"JAK.RPC",VERSION:"1.0",EXTEND:JAK.Request});JAK.RPC.AUTO=0;JAK.RPC.JSON=1;JAK.RPC.XMLRPC=2;JAK.RPC.FRPC=3;JAK.RPC.FRPC_B64=4;JAK.RPC.ACCEPT={};JAK.RPC.ACCEPT[JAK.RPC.JSON]="application/json";JAK.RPC.ACCEPT[JAK.RPC.XMLRPC]="text/xml";JAK.RPC.ACCEPT[JAK.RPC.FRPC]="application/x-frpc";JAK.RPC.ACCEPT[JAK.RPC.FRPC_B64]="application/x-base64-frpc";JAK.RPC.prototype.$constructor=function(type,options){this._ERROR=6;this._rpcType=type;if(this._rpcType==JAK.RPC.AUTO){this._rpcType=JAK.RPC.FRPC_B64}var requestType=null;switch(this._rpcType){case JAK.RPC.JSON:case JAK.RPC.FRPC_B64:requestType=JAK.Request.TEXT;break;case JAK.RPC.FRPC:requestType=JAK.Request.BINARY;break;case JAK.RPC.XMLRPC:requestType=JAK.Request.XML;break;default:throw new Error("Unsupported RPC type "+this._rpcType);break}this._rpcOptions={timeout:0,async:true,endpoint:"/"};for(var p in options){this._rpcOptions[p]=options[p]}var requestOptions={timeout:this._rpcOptions.timeout,async:this._rpcOptions.async,method:"post"};this.$super(requestType,requestOptions)};JAK.RPC.prototype.send=function(method,data,hints){if(!(data instanceof Array)){throw new Error("RPC needs an array of data to be sent")}if(this._rpcType==JAK.RPC.XMLRPC){this.setHeaders({Accept:JAK.RPC.ACCEPT[this._rpcType],"Content-Type":"text/xml"});var d=JAK.XMLRPC.serializeCall(method,data,hints);return this.$super(this._rpcOptions.endpoint,d)}else{this.setHeaders({Accept:JAK.RPC.ACCEPT[this._rpcType],"Content-Type":"application/x-base64-frpc"});var d=JAK.FRPC.serializeCall(method,data,hints);return this.$super(this._rpcOptions.endpoint,JAK.Base64.btoa(d))}};JAK.RPC.prototype.setErrorCallback=function(obj,method){this._setCallback(obj,method,this._ERROR);return this};JAK.RPC.prototype._done=function(data,status){try{var d=this._rpcParse(data,status)}catch(e){this._state=this._ERROR;this._userCallback(e,status,this);this._promise.reject({type:"frpc",request:this});return}this.$super(d,status)};JAK.RPC.prototype._rpcEscape=function(str){var re=new RegExp('"',"g");return str.split(/\\/g).join("\\\\").split(re).join('\\"')};JAK.RPC.prototype._rpcSerialize=function(data,hints,method){if(!data){return""}var arr=[];for(var p in data){var name=p;var value=data[p];var floatFlag=false;if(value instanceof Array){name+="[]";if(!value.length){arr.push(encodeURIComponent(name)+"=")}else{for(var i=0;i<value.length;i++){var v=value[i];v=this._rpcSerializeValue(v,floatFlag);arr.push(encodeURIComponent(name)+"="+encodeURIComponent(v))}}}else{value=this._rpcSerializeValue(value,floatFlag);arr.push(encodeURIComponent(name)+"="+encodeURIComponent(value))}}return arr.join("&")};JAK.RPC.prototype._rpcSerializeValue=function(value,floatFlag){if(value===null){return"null"}switch(typeof value){case"boolean":return value;break;case"string":return'"'+this._rpcEscape(value)+'"';break;case"number":if(!floatFlag){return value>0?Math.floor(value):Math.ceil(value)}var str=value.toString();if(str.indexOf(".")==-1){str+=".0"}return str;break;case"object":if(!(value instanceof Date)){throw new Error("Unserializable object "+value)}return value.format("Y-m-d\\TH:i:sO");break;default:throw new Error("Unserializable value "+value);break}};JAK.RPC.prototype._rpcParse=function(data){switch(this._rpcType){case JAK.RPC.JSON:var result=JSON.parse(data);if(!result.status&&result.failure){throw new Error("JSON/"+result.failure+": "+result.failureMessage)}return result;break;case JAK.RPC.FRPC:return JAK.FRPC.parse(data);break;case JAK.RPC.FRPC_B64:var bytes=JAK.Base64.atob(data);return JAK.FRPC.parse(bytes);break;case JAK.RPC.XMLRPC:return this._rpcParseXML(data);break;default:throw new Error("Unimplemented RPC type "+this._rpcType);break}};JAK.RPC.prototype._rpcParseXML=function(xmlDoc){if(!xmlDoc){return null}var de=xmlDoc.documentElement;if(de.nodeName!="methodResponse"){throw new Error("Only XMLRPC method responses supported")}var type=JAK.XML.childElements(de)[0];var node=null;if(type.nodeName=="fault"){var node=JAK.XML.childElements(type,"value")[0];throw new Error(JSON.stringify(JAK.XML.RPC.parse(node)))}var node=JAK.XML.childElements(type,"param")[0];node=JAK.XML.childElements(node,"value")[0];return JAK.XML.RPC.parse(node)};JAK.FRPC=JAK.ClassMaker.makeStatic({NAME:"JAK.FRPC",VERSION:"1.2"});JAK.FRPC.TYPE_MAGIC=25;JAK.FRPC.TYPE_CALL=13;JAK.FRPC.TYPE_RESPONSE=14;JAK.FRPC.TYPE_FAULT=15;JAK.FRPC.TYPE_INT=1;JAK.FRPC.TYPE_BOOL=2;JAK.FRPC.TYPE_DOUBLE=3;JAK.FRPC.TYPE_STRING=4;JAK.FRPC.TYPE_DATETIME=5;JAK.FRPC.TYPE_BINARY=6;JAK.FRPC.TYPE_INT8P=7;JAK.FRPC.TYPE_INT8N=8;JAK.FRPC.TYPE_STRUCT=10;JAK.FRPC.TYPE_ARRAY=11;JAK.FRPC.TYPE_NULL=12;JAK.FRPC._hints=null;JAK.FRPC._path=[];JAK.FRPC._data=[];JAK.FRPC._pointer=0;JAK.FRPC.parse=function(data){this._pointer=0;this._data=data;var magic1=this._getByte();var magic2=this._getByte();if(magic1!=202||magic2!=17){this._data=[];throw new Error("Missing FRPC magic")}this._getByte();this._getByte();var first=this._getInt(1);var type=first>>3;if(type==JAK.FRPC.TYPE_FAULT){var num=this._parseValue();var msg=this._parseValue();this._data=[];throw new Error("FRPC/"+num+": "+msg)}var result=null;switch(type){case JAK.FRPC.TYPE_RESPONSE:result=this._parseValue();if(this._pointer<this._data.length){this._data=[];throw new Error("Garbage after FRPC data")}break;case JAK.FRPC.TYPE_CALL:var nameLength=this._getInt(1);var name=this._decodeUTF8(nameLength);var params=[];while(this._pointer<this._data.length){params.push(this._parseValue())}this._data=[];return{method:name,params:params};break;default:this._data=[];throw new Error("Unsupported FRPC type "+type);break}this._data=[];return result};JAK.FRPC.serializeCall=function(method,data,hints){var result=this.serialize(data,hints);result.shift();result.shift();var encodedMethod=this._encodeUTF8(method);result.unshift.apply(result,encodedMethod);result.unshift(encodedMethod.length);result.unshift(JAK.FRPC.TYPE_CALL<<3);result.unshift(202,17,2,1);return result};JAK.FRPC.serialize=function(data,hints){var result=[];this._path=[];this._hints=hints;this._serializeValue(result,data);this._hints=null;return result};JAK.FRPC._parseValue=function(){var first=this._getInt(1);var type=first>>3;switch(type){case this.TYPE_STRING:var lengthBytes=(first&7)+1;var length=this._getInt(lengthBytes);return this._decodeUTF8(length);break;case this.TYPE_STRUCT:var result={};var lengthBytes=(first&7)+1;var members=this._getInt(lengthBytes);while(members--){this._parseMember(result)}return result;break;case this.TYPE_ARRAY:var result=[];var lengthBytes=(first&7)+1;var members=this._getInt(lengthBytes);while(members--){result.push(this._parseValue())}return result;break;case this.TYPE_BOOL:return first&1?true:false;break;case this.TYPE_INT:var length=first&7;var max=Math.pow(2,8*length);var result=this._getInt(length);if(result>=max/2){result-=max}return result;break;case this.TYPE_DATETIME:this._getByte();var ts=this._getInt(4);for(var i=0;i<5;i++){this._getByte()}return new Date(1e3*ts);break;case this.TYPE_DOUBLE:return this._getDouble();break;case this.TYPE_BINARY:var lengthBytes=(first&7)+1;var length=this._getInt(lengthBytes);var result=[];while(length--){result.push(this._getByte())}return result;break;case this.TYPE_INT8P:var length=(first&7)+1;return this._getInt(length);break;case this.TYPE_INT8N:var length=(first&7)+1;return-this._getInt(length);break;case this.TYPE_NULL:return null;break;default:throw new Error("Unkown FRPC type "+type);break}};JAK.FRPC._append=function(arr1,arr2){var len=arr2.length;for(var i=0;i<len;i++){arr1.push(arr2[i])}};JAK.FRPC._parseMember=function(result){var nameLength=this._getInt(1);var name=this._decodeUTF8(nameLength);result[name]=this._parseValue()};JAK.FRPC._getInt=function(bytes){var result=0;var factor=1;for(var i=0;i<bytes;i++){result+=factor*this._getByte();factor*=256}return result};JAK.FRPC._getByte=function(){if(this._pointer+1>this._data.length){throw new Error("Cannot read byte from buffer")}return this._data[this._pointer++]};JAK.FRPC._decodeUTF8=function(length){var remain=length;var result="";if(!length){return result}var c=0,c1=0,c2=0;var SfCC=String.fromCharCode;var data=this._data;var pointer=this._pointer;while(1){remain--;c=data[pointer];pointer+=1;if(c<128){result+=SfCC(c)}else if(c>191&&c<224){c1=data[pointer];pointer+=1;result+=SfCC((c&31)<<6|c1&63);remain-=1}else if(c<240){c1=data[pointer++];c2=data[pointer++];result+=SfCC((c&15)<<12|(c1&63)<<6|c2&63);remain-=2}else if(c<248){c1=data[pointer++]&63;c2=data[pointer++]&63;c3=data[pointer++]&63;var cp=(c&7)<<18|c1<<12|c2<<6|c3;if(cp>65535){cp-=65536;result+=SfCC(cp>>>10&1023|55296);cp=cp&1023|56320}result+=SfCC(cp);remain-=3}else if(c<252){pointer+=4;remain-=4}else{pointer+=5;remain-=5}if(remain<=0){break}}this._pointer=pointer+remain;return result};JAK.FRPC._encodeUTF8=function(str){var result=[];for(var i=0;i<str.length;i++){var c=str.charCodeAt(i);if(c>=55296&&c<=56319){var c2=str.charCodeAt(++i);c=((c&1023)<<10)+(c2&1023)+65536}if(c<128){result.push(c)}else if(c<2048){result.push(c>>6|192);result.push(c&63|128)}else if(c<65536){result.push(c>>12|224);result.push(c>>6&63|128);result.push(c&63|128)}else{result.push(c>>18|240);result.push(c>>12&63|128);result.push(c>>6&63|128);result.push(c&63|128)}}return result};JAK.FRPC._getDouble=function(){var bytes=[];var index=8;while(index--){bytes[index]=this._getByte()}var sign=bytes[0]&128?1:0;var exponent=(bytes[0]&127)<<4;exponent+=bytes[1]>>4;if(exponent==0){return Math.pow(-1,sign)*0}var mantissa=0;var byteIndex=1;var bitIndex=3;var index=1;do{var bitValue=bytes[byteIndex]&1<<bitIndex?1:0;mantissa+=bitValue*Math.pow(2,-index);index++;bitIndex--;if(bitIndex<0){bitIndex=7;byteIndex++}}while(byteIndex<bytes.length);if(exponent==2047){if(mantissa){return NaN}else{return Math.pow(-1,sign)*Infinity}}exponent-=(1<<10)-1;return Math.pow(-1,sign)*Math.pow(2,exponent)*(1+mantissa)};JAK.FRPC._serializeValue=function(result,value){if(value===null){result.push(JAK.FRPC.TYPE_NULL<<3);return}switch(typeof value){case"string":var strData=this._encodeUTF8(value);var intData=this._encodeInt(strData.length);var first=JAK.FRPC.TYPE_STRING<<3;first+=intData.length-1;result.push(first);this._append(result,intData);this._append(result,strData);break;case"number":if(this._getHint()=="float"){var first=JAK.FRPC.TYPE_DOUBLE<<3;var floatData=this._encodeDouble(value);result.push(first);this._append(result,floatData)}else{var first=value>=0?JAK.FRPC.TYPE_INT8P:JAK.FRPC.TYPE_INT8N;first=first<<3;var data=this._encodeInt(Math.abs(value));first+=data.length-1;result.push(first);this._append(result,data)}break;case"boolean":var data=JAK.FRPC.TYPE_BOOL<<3;if(value){data+=1}result.push(data);break;case"object":if(value instanceof Date){this._serializeDate(result,value)}else if(value instanceof Array){this._serializeArray(result,value)}else{this._serializeStruct(result,value)}break;default:throw new Error("FRPC does not allow value "+value);break}};JAK.FRPC._serializeArray=function(result,data){if(this._getHint()=="binary"){var first=JAK.FRPC.TYPE_BINARY<<3;var intData=this._encodeInt(data.length);first+=intData.length-1;result.push(first);this._append(result,intData);this._append(result,data);return}var first=JAK.FRPC.TYPE_ARRAY<<3;var intData=this._encodeInt(data.length);first+=intData.length-1;result.push(first);this._append(result,intData);for(var i=0;i<data.length;i++){this._path.push(i);this._serializeValue(result,data[i]);this._path.pop()}};JAK.FRPC._serializeStruct=function(result,data){var numMembers=0;for(var p in data){numMembers++}var first=JAK.FRPC.TYPE_STRUCT<<3;var intData=this._encodeInt(numMembers);first+=intData.length-1;result.push(first);this._append(result,intData);for(var p in data){var strData=this._encodeUTF8(p);result.push(strData.length);this._append(result,strData);this._path.push(p);this._serializeValue(result,data[p]);this._path.pop()}};JAK.FRPC._serializeDate=function(result,date){result.push(JAK.FRPC.TYPE_DATETIME<<3);var zone=date.getTimezoneOffset()/15;if(zone<0){zone+=256}result.push(zone);var ts=Math.round(date.getTime()/1e3);if(ts<0||ts>=Math.pow(2,31)){ts=-1}if(ts<0){ts+=Math.pow(2,32)}var tsData=this._encodeInt(ts);while(tsData.length<4){tsData.push(0)}this._append(result,tsData);var year=date.getFullYear()-1600;year=Math.max(year,0);year=Math.min(year,2047);var month=date.getMonth()+1;var day=date.getDate();var dow=date.getDay();var hours=date.getHours();var minutes=date.getMinutes();var seconds=date.getSeconds();result.push((seconds&31)<<3|dow&7);result.push((minutes&63)<<1|(seconds&32)>>5|(hours&1)<<7);result.push((hours&30)>>1|(day&15)<<4);result.push((day&31)>>4|(month&15)<<1|(year&7)<<5);result.push((year&2040)>>3)};JAK.FRPC._encodeInt=function(data){if(!data){return[0]}var result=[];var remain=data;while(remain){var value=remain%256;remain=(remain-value)/256;result.push(value)}return result};JAK.FRPC._encodeDouble=function(num){var result=[];var expBits=11;var fracBits=52;var bias=(1<<expBits-1)-1;var sign,exponent,fraction;if(isNaN(num)){exponent=(1<<expBits)-1;fraction=1;sign=0}else if(num===Infinity||num===-Infinity){exponent=(1<<expBits)-1;fraction=0;sign=num<0?1:0}else if(num===0){exponent=0;fraction=0;sign=1/num===-Infinity?1:0}else{sign=num<0;var abs=Math.abs(num);if(abs>=Math.pow(2,1-bias)){var ln=Math.min(Math.floor(Math.log(abs)/Math.LN2),bias);exponent=ln+bias;fraction=abs*Math.pow(2,fracBits-ln)-Math.pow(2,fracBits)}else{exponent=0;fraction=abs/Math.pow(2,1-bias-fracBits)}}var bits=[];for(var i=fracBits;i>0;i--){bits.push(fraction%2?1:0);fraction=Math.floor(fraction/2)}for(var i=expBits;i>0;i--){bits.push(exponent%2?1:0);exponent=Math.floor(exponent/2)}bits.push(sign?1:0);var num=0;var index=0;while(bits.length){num+=(1<<index)*bits.shift();index++;if(index==8){result.push(num);num=0;index=0}}return result};JAK.FRPC._getHint=function(){if(!this._hints){return null}if(typeof this._hints!="object"){return this._hints}return this._hints[this._path.join(".")]||null};JAK.Base64=JAK.ClassMaker.makeStatic({NAME:"JAK.Base64",VERSION:"1.0"});JAK.Base64.ALPHABET="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";JAK.Base64.INDEXED_ALPHABET=JAK.Base64.ALPHABET.split("");JAK.Base64.ASSOCIATED_ALPHABET={};(function(){for(var i=0;i<JAK.Base64.ALPHABET.length;i++){JAK.Base64.ASSOCIATED_ALPHABET[JAK.Base64.ALPHABET.charAt(i)]=i}})();JAK.Base64.atob=function(data){var output=[];var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var input=data.replace(/\s/g,"").split("");for(var i=0,len=input.length;i<len;i+=4){enc1=JAK.Base64.ASSOCIATED_ALPHABET[input[i]];enc2=JAK.Base64.ASSOCIATED_ALPHABET[input[i+1]];enc3=JAK.Base64.ASSOCIATED_ALPHABET[input[i+2]];enc4=JAK.Base64.ASSOCIATED_ALPHABET[input[i+3]];chr1=enc1<<2|enc2>>4;chr2=(enc2&15)<<4|enc3>>2;chr3=(enc3&3)<<6|enc4;output.push(chr1);if(enc3!=64){output.push(chr2)}if(enc4!=64){output.push(chr3)}}return output};JAK.Base64.btoa=function(data){var output=[];var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var i=0;var len=data.length;do{chr1=i<data.length?data[i++]:NaN;chr2=i<data.length?data[i++]:NaN;chr3=i<data.length?data[i++]:NaN;enc1=chr1>>2;enc2=(chr1&3)<<4|chr2>>4;enc3=(chr2&15)<<2|chr3>>6;enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64}else if(isNaN(chr3)){enc4=64}output.push(JAK.Base64.INDEXED_ALPHABET[enc1]);output.push(JAK.Base64.INDEXED_ALPHABET[enc2]);output.push(JAK.Base64.INDEXED_ALPHABET[enc3]);output.push(JAK.Base64.INDEXED_ALPHABET[enc4])}while(i<len);return output.join("")};JAK.CSS3=JAK.ClassMaker.makeStatic({NAME:"JAK.CSS3",VERSION:"1.0"});JAK.CSS3._node=JAK.mel("div");JAK.CSS3.PREFIXES=["","ms","Webkit","O","Moz"];JAK.CSS3.getProperty=function(property){var prefix=this.getPrefix(this._normalize(property));if(prefix===null){return null}return(prefix?"-"+prefix.toLowerCase()+"-":"")+property};JAK.CSS3.set=function(node,prop,value){prop=this._normalize(prop);var prefix=this.getPrefix(prop);if(prefix===null){return false}var p=prefix?prefix+prop.charAt(0).toUpperCase()+prop.substring(1):prop;node.style[p]=value;return true};JAK.CSS3.getPrefix=function(property){for(var i=0;i<this.PREFIXES.length;i++){var p=this.PREFIXES[i];var prop=p?p+property.charAt(0).toUpperCase()+property.substring(1):property;if(prop in tz])/g,function(match,letter){return letter.toUpperCase()})};JAK.XMLRPC=JAK.ClassMaker.makeStatic({NAME:"JAK.XMLRPC",VERSION:"1.0"});JAK.XMLRPC.serializeCall=function(method,data,hints){this._method=method;this._data=data;this._path=[];this._doc=JAK.XML.createDocument();var root=this._doc.createElement("methodCall");var methodName=this._doc.createElement("methodName");methodName.appendChild(this._doc.createTextNode(this._method));root.appendChild(methodName);this._doc.appendChild(root);this._params=this._doc.createElement("params");root.appendChild(this._params);this._serialize(data,hints);var out=JAK.XMLRPC.parse=function(data){return this._valueToObject(data)};JAK.XMLRPC._serialize=function(data,hints){this._path=[];this._hints=hints;for(var i=0;i<data.length;i++){this._path.push(i);var param=this._doc.createElement("param");this._serializeValue(param,data[i]);this._path.pop();this._params.appendChild(param)}this._hints=null};JAK.XMLRPC._serializeValue=function(result,value){var valueNode=this._doc.createElement("value");if(value===null){valueNode.appendChild(this._doc.createElement("nil"));result.appendChild(param);return}var node;var content;switch(typeof value){case"string":content=this._doc.createTextNode(value);node=this._doc.createElement("string");node.appendChild(content);break;case"number":content=this._doc.createTextNode(value);if(this._getHint()=="float"){node=this._doc.createElement("double")}else{node=this._doc.createElement("int")}node.appendChild(content);break;case"boolean":value=value?1:0;content=this._doc.createTextNode(value);node=this._doc.createElement("boolean");node.appendChild(content);break;case"object":if(value instanceof Date){value=value.toISOString();content=this._doc.createTextNode(value);node=this._doc.createElement("dateTime.iso8601");node.appendChild(content)}else if(value instanceof Array){node=this._serializeArray(content,value)}else{node=this._doc.createElement("struct");this._serializeObject(node,value)}break;default:throw new Error("XMLRPC does not allow value "+value);break}valueNode.appendChild(node);result.appendChild(valueNode)};JAK.XMLRPC._serializeArray=function(result,value){if(this._getHint()=="binary"){var node=this._doc.createElement("base64");var value=this._doc.createElement("value");var content=this._doc.createTextNode(JAK.Base64.btoa(value));value.appendChild(content);node.appendChild(value);return node}else{var node=this._doc.createElement("array");var data=this._doc.createElement("data");node.appendChild(data);for(var i=0;i<value.length;i++){this._path.push(i);this._serializeValue(data,value[i]);this._path.pop()}return node}};JAK.XMLRPC._serializeObject=function(result,value){for(var i in value){var item=this._doc.createElement("member");var nameNode=this._doc.createElement("name");var name=this._doc.createTextNode(i);nameNode.appendChild(name);item.appendChild(nameNode);this._path.push(i);this._serializeValue(item,value[i]);this._path.pop();result.appendChild(item)}};JAK.XMLRPC._valueToObject=function(node){node=JAK.XML.childElements(node)[0];switch(node.nodeName){case"string":return JAK.XML.textContent(node);break;case"base64":return JAK.Base64.atob(JAK.XML.textContent(node).trim());break;case"i4":case"i8":case"int":return parseInt(node.firstChild.nodeValue);break;case"double":return parseFloat(node.firstChild.nodeValue);break;case"boolean":return node.firstChild.nodeValue=="1";break;case"array":return this._arrayToObject(node);break;case"struct":return this._structToObject(node);break;case"nil":return null;break;case"dateTime.iso8601":var val=JAK.XML.textContent(node).trim();var r=val.match(/(\d{4})(\d{2})(\d{2})T(\d{2}):(\d{2}):(\d{2})(.)(\d{2})(\d{2})/);r[7]=r[7]=="+"?"1":"-1";for(var i=1;i<r.length;i++){r[i]=parseInt(r[i],10)}var date=new Date(r[1],r[2]-1,r[3],r[4],r[5],r[6],0);var offset=r[7]*(r[8]*60+r[9]);offset+=date.getTimezoneOffset();var ts=date.getTime();ts-=offset*60*1e3;return new Date(ts);break;default:throw new Error("Unknown XMLRPC node "+node.nodeName);break}};JAK.XMLRPC._arrayToObject=function(node){var arr=[];var data=JAK.XML.childElements(node)[0];var values=JAK.XML.childElements(data);for(var i=0;i<values.length;i++){arr.push(this._valueToObject(values[i]))}return arr};JAK.XMLRPC._structToObject=function(node){var obj={};var members=JAK.XML.childElements(node);for(var i=0;i<members.length;i++){var member=members[i];var name=JAK.XML.childElements(member,"name")[0];name=JAK.XML.textContent(name);var value=JAK.XML.childElements(member,"value")[0];obj[name]=this._valueToObject(value)}return obj};JAK.XMLRPC._getHint=function(){if(!this._hints){return null}if(typeof this._hints!="object"){return this._hints}return this._hints[this._path.join(".")]||null};var SMap=JAK.ClassMaker.makeClass({NAME:"SMap",VERSION:"1.0"});SMap.apiKey=Loader.apiKey;SMap.lang=Loader.lang;SMap.MOUSE_PAN=1<<0;SMap.MOUSE_WHEEL=1<<1;SMap.MOUSE_ZOOM_IN=1<<2;SMap.MOUSE_ZOOM_OUT=1<<3;SMap.MOUSE_ZOOM=SMap.MOUSE_ZOOM_IN+SMap.MOUSE_ZOOM_OUT;SMap.KB_PAN=1<<0;SMap.KB_ZOOM=1<<1;SMap.LAYER_TILE=0;SMap.LAYER_SHADOW=1;SMap.LAYER_GEOMETRY=2;SMap.LAYER_MARKER=3;SMap.LAYER_ACTIVE=4;SMap.LAYER_HUD=5;SMap.NORTH=0;SMap.WEST=1;SMap.SOUTH=2;SMap.EAST=3;SMap.DEF_BASE=1;SMap.DEF_TURIST=2;SMap.DEF_OPHOTO=3;SMap.DEF_HYBRID=4;SMap.DEF_HISTORIC=5;SMap.DEF_BIKE=6;SMap.DEF_TRAIL=7;SMap.DEF_OPHOTO0203=8;SMap.DEF_OPHOTO0406=9;SMap.DEF_OBLIQUE=12;SMap.DEF_SMART_BASE=14;SMap.DEF_SMART_OPHOTO=15;SMap.DEF_SMART_TURIST=16;SMap.DEF_RELIEF=17;SMap.DEF_PANO=18;SMap.DEF_TURIST_WINTER=19;SMap.DEF_SMART_WINTER=20;SMap.DEF_SUMMER=21;SMap.DEF_SMART_SUMMER=22;SMap.DEF_GEOGRAPHY=23;SMap.DEF_OPHOTO1012=24;SMap.DEF_HYBRID_SPARSE=25;SMap.DEF_OPHOTO1415=26;SMap.DEF_OPHOTO1618=29;SMap.DEF_BASE_NEW=27;SMap.DEF_TURIST_NEW=28;SMap.GEOMETRY_POLYLINE=0;SMap.GEOMETRY_POLYGON=1;SMap.GEOMETRY_CIRCLE=2;SMap.GEOMETRY_ELLIPSE=3;SMap.GEOMETRY_PATH=4;SMap.MAPSET_BASE=1;SMap.MAPSET_TURIST=3;SMap.TRANSFORM="";SMap.prototype.$constructor=function(container,center,zoom,options){if(JAK.Browser.isOld()){container.style.textAlign="center";container.innerHTML=SMap._("map.unsupported");return}if(!SMap.apiKey){SMap.CONFIG[SMap.DEF_BASE].url=SMap.CONFIG.mapServer+"/base-m/";SMap.CONFIG[SMap.DEF_BASE].retinaUrl=SMap.CONFIG.mapServer+"/base-m/retina/";SMap.CONFIG[SMap.DEF_BASE].langs={en:{url:SMap.CONFIG.mapServer+"/base-en/",retinaUrl:SMap.CONFIG.mapServer+"/base-en/retina/"}};delete SMap.CONFIG[SMap.DEF_BASE].options;SMap.CONFIG[SMap.DEF_OPHOTO].url=SMap.CONFIG.mapServer+"/ophoto-m/";delete SMap.CONFIG[SMap.DEF_OPHOTO].options;SMap.CONFIG[SMap.DEF_TURIST].url=SMap.CONFIG.mapServer+"/turist-m/";SMap.CONFIG[SMap.DEF_TURIST].retinaUrl=SMap.CONFIG.mapServer+"/turist-m/retina/";SMap.CONFIG[SMap.DEF_TURIST].langs={en:{url:SMap.CONFIG.mapServer+"/turist-en/",retinaUrl:SMap.CONFIG.mapServer+"/turist-en/retina/"}};delete SMap.CONFIG[SMap.DEF_TURIST].options}this._ec=[];this._options={minZoom:2,maxZoom:18,animTime:500,zoomTime:300,rotationTime:300,orientation:SMap.NORTH,projection:new SMap.Projection.Mercator,ophotoDate:true};for(var p in options){this._options[p]=options[p]}this._dom={container:container};this._layers=[];this._cursor=[];this.controlLayer=false;this.controls=[];this._card=null;this._lock=0;this._eventCoords=null;this._projection=this._options.projection;this._availability={oblique:{},ophoto:{}};this._zoomAnimation={sourceZoom:null,targetZoom:null,fixedPoint:null,ts:null,disabledLayers:[],enabledLayers:[]};this._rotationAnimation={sourceAngle:null,targetAngle:null,targetOrientation:null,ts:null,disabledLayers:[],enabledLayers:[]};this._panAnimation={ts:null,sourceCoords:null,targetCoords:null};this._rafCallbacks=[];this._rafTick=this._rafTick.bind(this);this._padding={left:0,right:0,top:0,bottom:0};this._signals=new JAK.Signals;this._size=null;this._offset=new SMap.Pixel(0,0);this._zoom=arguments.length>2?Number(zoom):8;this._center=center||SMap.Coords.fromPP(135118848,134987776);this._orientation=this._options.orientation;this._build();this._projection.setOwner(this);this.syncPort();this.addControl(new SMap.Control.MapyLogo,{right:"0px",bottom:"0px"});var props=["msTransform","transform","WebkitTransform","MozTransform","OTransform"];for(var i=0;i<props.length;i++){if(props[i]in document.body.style){this.constructor.TRANSFORM=props[i]}}if(this._options.ophotoDate){new SMap.OphotoDate(this)}var hit=new XMLHttpRequest;hit.open("POST",SMap.CONFIG.base+"/mapload");hit.setRequestHeader("X-SZN-Sdk",SMap.nigena());SMap.apiKey&&hit.setRequestHeader(SMap.CONFIG.apiKeyHeader,SMap.apiKey);hit.send()};SMap.prototype.$destructor=function(){while(this.controls.length){var c=this.controls[0];this.removeControl(c);c.$destructor()}this.controlLayer.$destructor();this.controlLayer=null;if(this._card){this._card.$destructor();this._card=null}JAK.Events.removeListeners(this._ec);JAK.DOM.clear(this._dom.container);this._dom={};this._layers=[]};SMap.prototype.createDefaultDataProvider=function(lang){var names=["poiagg"];var dataProvider=new SMap.DataProvider;dataProvider.setOwner(this);var cors=window.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest;var prefix=(cors?SMap.CONFIG.base:"")+"/";var opts={zoomCorrection:0};if(Array.isArray(lang)){opts.lang=lang}names.forEach(function(name){var poiserver=new SMap.POIServer.FRPC(prefix+name,opts);poiserver.setOwner(this);poiserver.getPOIParams();dataProvider.addPOIServer(poiserver)},this);return dataProvider};SMap.prototype.lock=function(){if(!this._lock){this._signals.makeEvent("map-lock",this)}this._lock++};SMap.prototype.unlock=function(){if(!this._lock){throw new Error("Cannot unlock unlocked map")}this._lock--;if(!this._lock){this._signals.makeEvent("map-unlock",this);this._redraw(false)}};SMap.prototype.getSignals=ftion(){return[this._options.minZoom,this._options.maxZoom]};SMap.prototype.setZoomRange=function(min,max){this._options.minZoom=min;this._options.maxZoom=max;var z=Math.max(min,this._zoom);z=Math.min(max,z);if(z!=this._zoom){this.setZoom(z)}this._signalshis)};SMap.prototype.redraw=function(){this._redraw(false)};SMap.prototype.getOrientation=function(){return this._orientation};SMap.prototype.setOrientation=function(o,animate){if(this._zoomAnimation.ts){return}if(!this._rotationAnimation.ts&&o==this._orientation){return}if(this._options.rotationTime&&animate!==false&&SMap.TRANSFORM){if(this._rotationAnimation.ts){this._rotationAnimationTarget(o)}else{this._rotationAnimationStart(o)}}else{this._orientation=o;this._redraw(true)}return this};SMap.prototype.setProjection=function(projection){if(this._projection){this._projection.setOwner(null)}this._projection=projection;this._projection.setOwner(this);this._redraw(true);return this};SMap.prototype.getContainer=function(){return this._dom.container};SMap.prototype.getContent=function(){return this._dom.content};SMap.prototype.getSize=function(){return this._size};SMap.prototype.getProjection=function(){return this._projection};SMap.prototype.getOffset=function(){return this._offset};SMap.prototype.getGeometryCanvas=function(){return this._geometryCanvas};SMap.prototype.setCursor=function(cursor,x,y){if(cursor){if(JAK.Browser.client=="chrome"&&arguments.length>2){cursor=cursor.replace(/,/," "+x+" "+y+",")}this._cursor.push(cursor)}else if(this._cursor.length){this._cursor.pop()}this._dom.content.style.cursor=this._cursor.length?this._cursor[this._cursor.length-1]:""};SMap.prototype.setCenter=function(center,animate){if(this._panAnimation.ts||animate&&this._options.animTime){if(center instanceof SMap.Pixel){center=center.clone().scale(-1).toCoords(this)}if(!this._panAnimation.ts){this._signals.makeEvent("center-start",this);this.lock();this._rafAdd("_panAnimationStep")}this._panAnimation.ts=(new Date).getTime();this._panAnimation.sourceCoords=this._center;this._panAnimation.targetCoords=center;this._signals.makeEvent("map-pan",this);return this}else{this._signals.makeEvent("center-start",this);this.setCenterZoom(center,this._zoom,false);this._signals.makeEvent("map-pan",this);this._signals.makeEvent("center-stop",this);return this}};SMap.prototype.zoomChange=function(zoom){var newZoom=this._newZoom(this._zoom,zoom);return newZoom!=this._zoom};SMap.prototype.setZoom=function(zoom,fixedPoint,animate){if(this._rotationAnimation.ts){return this}if(this._card&&this._card.isVisible()){fixedPoint=this._card.getAnchor()}else if(!fixedPoint){fixedPoint=new SMap.Pixel(0,0)}if(fixedPoint instanceof SMap.Coords){fixedPoint=fixedPoint.toPixel(this)}if(this._zoomAnimation.ts||animate&&this._options.zoomTime){if(this._zoomAnimation.ts){zoom=this._newZoom(this._zoomAnimation.targetZoom,zoom);this.zoomAnimationTarget(zoom)}else{zoom=this._newZoom(this._zoom,zoom);this.zoomAnimationStart(fixedPoint);this.zoomAnimationTarget(zoom)}return this}else{zoom=this._newZoom(this._zoom,zoom);if(zoom==this._zoom){return this}var center=this._newCenter(zoom,fixedPoint);return this.setCenterZoom(center,zoom,false)}};SMap.prototype.setCenterZoom=function(center,zoom,animate){zoom=this._newZoom(this._zoom,zoom);if(animate){if(zoom==this._zoom){return this.setCenter(center,true)}else{var fixedPoint=this._fixedPoint(center,zoom);return this.setZoom(zoom,fixedPoint,true)}}if(center instanceof SMap.Pixel){center=center.clone().scale(-1).toCoords(this)}center=this._adjustCenter(center,zoom);if(zoom==this._zoom){var delta=center.toPixel(this).scale(-1);this._center=center;var offset=this._offset.plus(delta);var redrawOccured=this._setOffset(offset);if(!redrawOccured&&!this._lock){this._redraw(false)}}else{var oldZoom=this._zoom;this._zoom=zoom;this._center=center;if(oldZoom==21){if(this._orientation!=SMap.NORTH){this.setOrientation(SMap.NORTH)}this.setProjection(new SMap.Projection.Mercator)}else{this._redraw(true)}}return this};SMap.prototype.getCenter=function(){return this._center};SMap.prototype.getZoom=function(){return this._zoom};SMap.prototype.computeCenterZoom=function(arr,usePadding){var minX=Infinity;var minY=Infinity;var maxX=-Infinity;var maxY=-Infinity;for(var i=0;i<arr.length;i++){var item=arr[i].toWGS84();minX=Math.min(minX,item[0]);minY=Math.min(minY,item[1]);maxX=Math.max(maxX,item[0]);maxY=Math.max(maxY,item[1])}var x=(minX+maxX)/2;var y=(minY+maxY)/2;var diffX=maxX-minX;var diffY=maxY-minY;var w=this._size.x;var h=this._size.y;if(usePadding){w-=this._padding.left;w-=this._padding.right;h-=this._padding.top;h-=this._padding.bottom}var ws=this._projection.getWorldSize(0);var fracX=360*w/(ws.x*diffX);var fracY=180*h/(ws.y*diffY);var frac=Math.min(fracX,fracY);var zoom=Math.floor(Math.log(frac)/Math.LN2);zoom=Math.min(zoom,this._options.maxZoom);var center=SMap.Coords.fromWGS84(x,y);if(usePadding&&zoom<1/0){var dx=-(this._padding.left-this._padding.right)/2;var dy=-(this._padding.top-this._padding.bottom)/2;var px=center.toPixel(this,zoom);px.plus(new SMap.Pixel(dx,dy));center=px.toCoords(this,zoom)}return[center,zoom]};SMap.prototype.addLayer=function(l,before){var index=this._layers.indexOf(l);if(index!=-1){throw new Error("Layer "+l+" is already added")}this._layers.push(l);var c=l.getContainer();for(var p in c){if(!(p in this._dom.layers)){throw new Error("Cannot append layer component to map")}var parent=p==SMap.LAYER_GEOMETRY?this._geometryCanvas.getContent():this._dom.layers[p];var containers=[].concat(c[p]);if(before){containers.reverse()}for(var i=0;i<containers.length;i++){var container=containers[i];if(before){parent.insertBefore(container,parent.firstChild)}else{parent.appendChild(container)}}}l.setOwner(this);return l};SMap.prototype.removeLayer=function(l){var index=this._layers.indexOf(l);if(index==-1){throw new Error("Cannot find layer to be removed")}l.setOwner(null);this._layers.splice(index,1);var c=l.getContainer();for(var p in c){var containers=[].concat(c[p]);for(var i=0;i<containers.length;i++){containers[i].parentNode.removeChild(containers[i])}}return l};SMap.prototype.getLayer=function(id){for(var i=0;i<this._layers.length;i++){var l=this._layers[i];if(l.getId()==ayerContainer=function(type){return this._dom.layers[type]};SMap.prototype.addControl=function(c,placement){this.controls.push(c);var cont=c.getContainer();if(cont){var prepend=c instanceof SMap.Control.Pointer;if(placement&&(placement.left||placement.right||placement.top||placement.bottom)){placement.left=placement.left||"auto";placement.right=placement.right||"auto";placement.top=placement.top||"auto";placement.bottom=placement.bottom||"auto"}this.controlLayer.addItem(cont,placement,prepend)}c.setOwner(this)};SMap.prototype.getControls=function(){return this.controls};SMap.prototype.removeControl=function(c){var index=this.controls.indexOf(c);if(index==-1){return}var cont=c.getContainer();if(cont){this.controlLayer.removeItem(cont)}c.setOwner(null);this.controls.splice(index,1)};SMap.prototype.addCard=function(card,coords,noPan){this.removeCard();this._card=card;var c=card.getContainer();c.style.visibility="hidden";this._dom.content.appendChild(c);card.setOwner(this);card.anchorTo(coords);c.style.visibility="visible";this._signals.makeEvent("card-open",this._card);if(!noPan){card.makeVisible()}};SMap.prototype.removeCard=function(){if(!this._card){return}var c=this._card.getContainer();c.parentNode.removeChild(c);this._signals.makeEvent("card-close",this._card);this._card=null};SMap.prototype.getCard=function(){return this._card};SMap.prototype.syncPort=function(){if(!this._dom.container)return;var newSize=new SMap.Pixel(this._dom.container.clientWidth,this._dom.container.clientHeight);if(this._size&&this._size.x==newSize.x&&this._size.y==newSize.y){return}this._size=newSize;this._geometryCanvas.resize(this._size.x,this._size.y);if(this._lock){this._setOffset(this._offset)}else{this._setOffset(new SMap.Pixel(0,0));this._center=this._adjustCenter(this._center,this._zoom);this._redraw(true)}this._signals.makeEvent(etPadding=function(which,vype.getPadding=function(which){return this._padding[which]};SMap.prototype.getMap=function(){return this};SMap.prototype.addDefaultLayer=function(id){var conf=SMap.CONFIG;var layer=null;switch(id){case SMap.DEF_OBLIQUE:var item=conf[id];layer=new SMap.Layer.Tile.Oblique(id,item.url,item.options);layer.setCopyright(item.copyright);break;case SMap.DEF_SMART_BASE:layer=new SMap.Layer.Smart(id,this);break;case SMap.DEF_SMART_OPHOTO:layer=new SMap.Layer.Smart(id,this,{base:SMap.DEF_OPHOTO});break;case SMap.DEF_TURIST_WINTER:layer=new SMap.Layer.Winter(id);break;case SMap.DEF_SMART_WINTER:layer=new SMap.Layer.Smart(id,this,{base:SMap.DEF_TURIST_WINTER});break;case SMap.DEF_SMART_TURIST:layer=new SMap.Layer.Smart.Turist(id,this);break;case SMap.DEF_SMART_SUMMER:layer=new SMap.Layer.Smart(id,this,{base:SMap.DEF_SUMMER});break;default:if(!(id in conf)){throw new Error("Invalid default layer id "+id)}var item=conf[id];var ctor=SMap.Layer.Tile;var lang=SMap.lang;if(item.langs){var tileLang="";if(lang in item.langs&&lang!="cs"&&lang!="sk"){tileLang=lang}else if(lang!="cs"&&lang!="sk"&&"en"in item.langs){tileLang="en"}if(tileLang){item.url=item.langs[tileLang].url||item.url;item.retinaUrl=item.langs[tileLang].retinaUrl||item.retinaUrl}}if(item.retinaUrl&&(!item.options||item.options&&!item.options.retinaUrl)){if(!item.options){item.options={}}item.options.retinaUrl=item.retinaUrl}if(id==SMap.DEF_PANO){ctor=SMap.Pano.Layer}if(id==SMap.DEF_TURIST||id==SMap.DEF_TURIST_NEW){ctor=SMap.Layer.Turist}layer=new ctor(id,item.url,item.options);layer.setCopyright(item.copyright);break}this.addLayer(layer);return layer};SMap.prototype.addDefaultContextMenu=function(){var cm=new SMap.Control.ContextMenu;this.addControl(cm);cm.addItem(new SMap.Control.ContextMenu.Coords);cm.addItem(new SMap.Control.ContextMenu.Separator);cm.addItem(new SMap.Control.ContextMenu.Zoom(SMap._("map.zoomIn"),1));cm.addItem(new SMap.Control.ContextMenu.Zoom(SMap._("map.zoomp-contextmenu",function(signal){cm.open(signal.data.event)});return cm};SMap.prototype.addDefaultControls=function(options){var o={};for(var type in options){var value=options[type];if(!(type in o)){o[type]={}}for(var p in value){o[type][p]=value[p]}}this.addControl(new SMap.Control.Mouse(SMap.MOUSE_PAN|SMap.MOUSE_WHEEL|SMap.MOUSE_ZOOM,o.Mouse));this.addControl(new SMap.Control.Keyboard(SMap.KB_PAN|SMap.KB_ZOOM,o.Keyboard));this.addControl(new SMap.Control.Selection(2));this.addControl(new SMap.Control.ZoomNotification);var c=new SMap.Control.Compass({title:SMap._("map.move")});this.addControl(c);var labels={2:SMap._("map.zooms.world"),5:SMap._("map.zooms.states"),8:SMap._("map.zooms.districts"),11:SMap._("map.zooms.cities"),14:SMap._("map.zooms.municipalities"),17:SMap._("map.zooms.streets"),20:SMap._("map.zooms.houses"),21:SMap._("map.zooms.birdEye")};var z=new SMap.Control.Zoom(labels,{titles:[SMap._("map.zoomIn"),SMap._("map.zoomOut")]});this.addControl(z);this.setPadding("right",this.getPadding("right")+73+8+2);var c=new SMap.Control.Scale;this.addControl(c);this.setCursor("move");JAK.DOM.addClass(this._dom.container,"smap-defaults")};SMap.prototype.formatString=function(template,customValues){var c=this._center.toWGS84();var m=20;var half=this._size.clone().scale(.5);var lb=new SMap.Pixel(-half.x-m,half.y+m).toCoords(this).toWGS84();var lt=new SMap.Pixel(-half.x-m,-half.y-m).toCoords(this).toWGS84();var rb=new SMap.Pixel(half.x+m,half.y+m).toCoords(this).toWGS84();var rt=new SMap.Pixel(half.x+m,-half.y-m).toCoords(this).toWGS84();var by=Math.min(lb[1],rb[1]);var ty=Math.max(lt[1],rt[1]);if(this._size.x<this._projection.getWorldSize(this._zoom).x){var lx=Math.min(lt[0],lb[0]);var rx=Math.max(rt[0],rb[0])}else{var lx=-180;var rx=180}var values={cx:c[0].toFixed(6),cy:c[1].toFixed(6),lbx:lb[0].toFixed(6),lby:lb[1].toFixed(6),rtx:rt[0].toFixed(6),rty:rt[1].toFixed(6),lx:lx.toFixed(6),rx:rx.toFixed(6),by:by.toFixed(6),ty:ty.toFixed(6),zoom:this._zoom,"zoom+1":this._zoom+1,"zoom+2":this._zoom+2,"zoom-1":this._zoom-1,"zoom-2":this._zoom-2,orientation:this._orientation};return template.replace(/{(.+?)}/g,function(tag,name){if(name in values){return values[name]}if(customValues&&name in customValues){return customValues[name]}return tag})};SMap.prototype.isObliqueAvailable=function(coords){var c=(coords||this._center).toUTM33();var key=c.join("-");if(!(key in this._availability.oblique)){this._availability.oblique[key]=false;var extents=SMap.CONFIG.obliqueExtents||[];for(var i=0;i<extents.length;i++){if(SMap.Util.pointInPolygon(c,extents[i])){this._availability.oblique[key]=true;break}}}return this._availability.oblique[key]};SMap.prototype.isOphotoAvailable=function(coords){if(this.isObliqueAvailable(coords)){return true}var c=(coords||this._center).toUTM33();var key=c.join("-");if(!(key in this._availability.ophoto)){this._availability.ophoto[key]=false;var extents=SMap.CONFIG.ophotoExtents||[];for(var i=0;i<extents.length;i++){if(SMap.Util.pointInPolygon(c,extents[i])){this._availability.ophoto[key]=true;break}}}return this._availability.ophoto[key]};SMap.prototype.adjustCoordsByPadding=function(coords,zoom,projection){if(arguments.length<3){projection=this._projection}if(arguments.length<2){zoom=this._zoom}var dx=this._padding.right-this._padding.left;var dy=this._padding.bottom-this._padding.top;var diff=new SMap.Pixel(dx/2,dy/2);var abs=projection.project(coords,zoom).plus(diff);return projection.unproject(abs,zoom)};SMap.prototype.zoomAnimationStart=function(fixedPoint,touch){var za=this._zoomAnimation;za.fixedPoint=fixedPoint;for(var i=0;i<this._layers.length;i++){var l=this._layers[i];if(!l.isActive()){continue}if(l instanceof SMap.Layer.HUD){continue}if(l.supportsAnimation()){za.enabledLayers.push(l)}else{za.disabledLayers.push(l);var c=l.getContainer();for(var p in c){var layerset=[].concat(c[p]);layerset.forEach(function($){$.style.display="none"})}}}this._signals.makeEvent("zoom-start",this,{fixedPoint:fixedPoint,touch:touch})};SMap.prototype.zoomAnimationStep=function(fracZoom){if(fracZoom<this._options.minZoom||fracZoom>this._options.maxZoom){return}var za=this._zoomAnimation;for(var i=0;i<za.enabledLayers.length;i++){za.enabledLayers[i].zoomTo(fracZoom,za.fixedPoint)}this._signals.makeEvent("zoom-step",this,{currentZoom:fracZoom})};SMap.prototype.zoomAnimationTarget=function(targetZoom,sourceZoom){if(arguments.length<2){sourceZoom=this._zoom}targetZoom=this._newZoom(sourceZoom,targetZoom);var za=this._zoomAnimation;if(za.ts){if(targetZoom==za.targetZoom){return}za.targetZoom=targetZoom;return}za.ts=(new Date).getTime();za.targetZoom=targetZoom;za.sourceZoom=sourceZoom;this._rafAdd("_zoomAnimationStep")};SMap.prototype.zoomAnimationStop=function(){var za=this._zoomAnimation;za.ts=null;this._rafRemove("_zoomAnimationStep");for(var i=0;i<za.enabledLayers.length;i++){za.enabledLayers[i].zoomTo(za.targetZoom,za.fixedPoint)}var newCenter=this._newCenter(za.targetZoom,za.fixedPoint);this.setCenterZoom(newCenter,za.targetZoom);za.disabledLayers.forEach(function(l){var c=l.getContainer();for(var p in c){var layerset=[].concat(c[p]);layerset.forEach(function($){$.style.display=""})}});za.disabledLayers=[];za.enabledLayers=[];this._signals.makeEvent("zoom-stop",this)};SMap.prototype.getCopyrightControl=function(){for(var i=0;i<this.controls.length;i++){if(this.controls[i]instanceof SMap.Control.Copyright){return this.controls[i]}}return null};SMap.prototype.getViewport=function(){var size=this.getSize();var w=Math.round(size.x/2);var h=Math.round(size.y/2);var lb=new SMap.Pixel(-w,h).toCoords(this).toWGS84();var rt=new SMap.Pixel(w,-h).toCoords(this).toWGS84();return{lbx:lb[0],lby:lb[1],rtx:rt[0],rty:rt[1]}};SMap.prototype._zoomAnimationStep=function(now){var za=this._zoomAnimation;var diff=now-za.ts;var limit=this._options.zoomTime;if(diff>=limit){this.zoomAnimationStop();return}var frac=diff/limit;var currentZoom=za.sourceZoom+frac*(za.targetZoom-za.sourceZoom);this.zoomAnimationStep(currentZoom)};SMap.prototype._newZoom=function(oldZoom,expression){var newZoom=typeof expression=="number"?expression:oldZoom+parseInt(expression);newZoom=Math.min(this._options.maxZoom,newZoom);newZoom=Math.max(newZoom,this._options.minZoom);return newZoom};SMap.prototype._setOffset=function(offset){if(!this._dom.content)return;var redrawOccured=false;this._offset=offset;var threshold=15e3;var size=this._projection.getWorldSize(this._zoom);var x=this._offset.x%size.x;if(x!=this._offset.x){this._offset.x=x;redrawOccured=true}if(Math.abs(this._offset.x)>threshold||Math.abs(this._offset.y)>threshold){this._offset=new SMap.Pixel(0,0);redrawOccured=true}var position=this._size.clone().scale(.5).plus(this._offset);this._dom.content.style.left=position.x+"px";this._dom.content.style.top=position.y+"px";if(redrawOccured){this._redraw(true)}return redrawOccured};SMap.prototype._redraw=function(full){var cont=this._geometryCanvas.getContainer();var position=this._size.clone().scale(-.5).minus(this._offset);cont.style.left=position.x+"px";cont.style.top=position.y+"px";this._layers.forEach(function(layer){layer.redraw(full)});if(this._card){this._card.anchorTo(this._card.getAnchor())}this._signals.makeEvent("map-redraw",this,{full:full})};SMap.prototype._buildLayers=function(){JAK.DOM.addClass(this._dom.container,"smap");this._dom.content=JAK.mel("div",{},{position:"absolute",width:"0",height:"0",margin:"0",padding:"0"});JAK.DOM.append([this._dom.container,this._dom.content]);this._dom.layers=[];var lastLayer=SMap.LAYER_HUD;for(var i=0;i<=lastLayer;i++){if(i==SMap.LAYER_GEOMETRY){var d=this._geometryCanvas.getContainer()}else{var d=JAK.mel("div");if(i==SMap.LAYER_HUD){d.classList.add("hud")}}this._dom.layers[i]=d;var parent=i<lastLayer?this._dom.content:this._dom.container;parent.appendChild(d)}this._ec.push(JAK.Events.addListener(this._dom.content,"mousedown",JAK.Events.cancelDef));if(JAK.Browser.client=="ie"){this._ec.push(JAK.Events.addListener(this._dom.content,"mousemove",JAK.Events.cancelDef))}this._ec.push(JAK.Events.addListener(this._dom.content,"contextmenu",JAK.Events.cancelDef));this._ec.push(JAK.Events.addListener(this._dom.content,"mousedown",this,"_mousedown"));this._ec.push(JAK.Events.addListener(this._dom.content,"click",this,"_click"));this._ec.push(JAK.Events.addListener(this._dom.container,"mousedown",this,"_focus"));this._ec.push(JAK.Events.addListener(document,"mousedown",this,"_blur"))};SMap.prototype._buildControls=function(){this.controlLayer=new SMap.Layer.HUD;var container=this.controlLayer.getContainer();JAK.DOM.addClass(container[SMap.LAYER_HUD],"noprint");this.addLayer(this.controlLayer);this.controlLayer.enable();this.addControl(new SMap.Control.Copyright,{left:"5px",bottom:"3px"})};SMap.prototype._buildGeometryCanvas=function(){this._geometryCanvas=JAK.Vector.getCanvas(1,1);this._geometryCanvas.getCGeometryCanvas();this._buildLayers();this._buildControls()};SMap.prototype._rotationAnimationStart=function(targetOrientation){var ra=this._rotationAnimation;this._rotationAnimationTarget(targetOrientation);for(var i=0;i<this._layers.length;i++){var l=this._layers[i];if(!l.isActive()){continue}if(l instanceof SMap.Layer.HUD){continue}if(l.supportsAnimation()){ra.enabledLayers.push(l)}else{ra.disabledLayers.push(l);var c=l.getContainer();for(var p in c){var layerset=[].concat(c[p]);layerset.forEach(function($){$.style.display="none"})}}}this._signals.makeEvent("rotation-start",this,{targetOrientation:targetOrientation});ra.ts=(new Date).getTime();this._rafAdd("_rotationAnimationStep")};SMap.prototype._rotationAnimationTarget=function(targetOrientation){var ra=this._rotationAnimation;ra.targetOrientation=targetOrientation;ra.sourceAngle=ra.ts?ra.targetAngle:0;var diff=targetOrientation-this._orientation;if(Math.abs(diff)>2){diff=-diff/3}ra.targetAngle=diff*90;if(ra.targetAngle-ra.sourceAngle>=180){ra.targetAngle-=360}if(ra.sourceAngle-ra.targetAngle>=180){ra.targetAngle+=360}};SMap.prototype._rotationAnimationStep=function(now){var ra=this._rotationAnimation;var diff=now-ra.ts;var limit=this._options.rotationTime;if(diff>=limit){this._rotationAnimationStop();return}var frac=diff/limit;var dangle=ra.targetAngle-ra.sourceAngle;var angle=frac*dangle+ra.sourceAngle;for(var i=0;i<ra.enabledLayers.length;i++){ra.enabledLayers[i].rotateTo(angle)}this._signals.makeEvent("rotation-step",this,{angle:angle})};SMap.prototype._rotationAnimationStop=function(){var ra=this._rotationAnimation;ra.ts=null;this._rafRemove("_rotationAnimationStep");for(var i=0;i<ra.enabledLayers.length;i++){ra.enabledLayers[i].rotateTo(ra.targetAngle)}this._orientation=ra.targetOrientation;this._redraw(true);ra.disabledLayers.forEach(function(l){var c=l.getContainer();foncat(c[p]);layerset.forEach(function($){$.style.display=""})}});ra.disabledLayers=[];ra.enabledLayers=[];this._signals.makeEvent("rotation-stop",this)};SMap.prototype._mousedown=function(e,elm){this._eventCoords=new SMap.Pixel(e.clientX,e.clientY)};SMap.prototype._click=function(e,elm){if(!this._eventCoords){return}var coords=new SMap.Pixel(e.clientX,e.clientY);if(coords.distance(this._eventCoords)>1.5){return}this._eventCoords=null;this._signals.makeEvent("map-click",this,{event:e})};SMap.prototype._focus=function(e,elm){this._signals.makeEvent("map-focus",this);JAK.DOM.addClass(this._dom.container,"focus")};SMap.prototype._blur=function(e,elm){var node=JAK.Events.getTarget(e);while(node){if(node==this._dom.container){return}node=node.parentNode}JAK.DOM.removeClass(this._dom.container,"focus");this._signals.makeEvent("map-blur",this)};SMap.prototype._panAnimationStep=function(now){var pa=this._panAnimation;var diff=now-pa.ts;var frac=diff/this._options.animTime;if(frac>=1){pa.ts=null;this._rafRemove("_panAnimationStep");this.setCenter(pa.targetCoords,false);this.unlock()}else{var sourcePixel=pa.sourceCoords.toPixel(this);var targetPixel=pa.targetCoords.toPixel(this);var currentPixel=sourcePixel.plus(targetPixel.minus(sourcePixel).scale(frac));this.setCenterZoom(currentPixel.toCoords(this),this._zoom,false)}};SMap.prototype._adjustCenter=function(center,zoom){if(this._orientation!=SMap.NORTH){return center}if(!(this._projection instanceof SMap.Projection.Mercator)){return center}var px=center.toPixel(this,zoom);var top=SMap.Coords.fromWGS84(0,85);var bottom=SMap.Coords.fromWGS84(0,-85);var topPx=top.toPixel(this,zoom).minus(px).y;var bottomPx=bottom.toPixel(this,zoom).minus(px).y;var avail=this._size.y/2;var topOk=topPx<-avail;var bottomOk=bottomPx>avail;if(topOk^bottomOk){if(!topOk){px.plus(new SMap.Pixel(0,topPx+avail));return px.toCoords(this,zoom)}if(!bottomOk){px.minus(new SMap.Pixel(0,avail-bottomPx));return px.toCoords(this,zoom)}}else{return center}};SMap.prototype._rafAdd=function(methodName){var index=this._rafCallbacks.indexOf(methodName);if(index>-1){console.warn("RAF listener",methodName,"already added");return}if(!this._rafCallbacks.length){requestAnimationFrame(this._rafTick)}this._rafCallbacks.push(methodName)};SMap.prototype._rafRemove=function(methodName){var index=this._rafCallbacks.indexOf(methodName);if(index==-1){console.warn("RAF listener",methodName,"does not exist");return}this._rafCallbacks.splice(index,1)};SMap.prototype._rafTick=function(){var now=Date.now();var callbacks=this._rafCallbacks.slice();for(var i=0;i<callbacks.length;i++){this[callbacks[i]](now)}if(this._rafCallbacks.length){requestAnimationFrame(this._rafTick)}};SMap.prototype._newCenter=function(newZoom,fixedPoint){return fixedPoint.toCoords(this).toPixel(this,newZoom).minus(fixedPoint).toCoords(this,newZoom)};SMap.prototype._fixedPoint=function(newCenter,newZoom){var distanceScale=Math.pow(2,newZoom-this._zoom);return newCenter.toPixel(this,newZoom).scale(1/(distanceScale-1))};SMap.LAYER_VECTOR=SMap.LAYER_GEOMETRY;SMap.DEF_SMART=SMap.DEF_SMART_BASE;SMap.DEF_RELIEF_L=SMap.DEF_RELIrototype.animate=function(c){return this.setCenter(c,true)};SMap.IOwned=JAK.ClassMaker.makeInterface({NAME:"SMap.IOwned",VERSION:"1.0"});SMap.IOwned.prototype.getMap=function(){if(!this._owner){return null}return this._owner.getMap()};SMap.IOwned.prototype.setOwner=function(owner){this._owner=owner;return this};(function(root,factob"],function(b){return root.returnExportsGlobal=factory(b)})}else if(typeof module==="object"&&module.exports){module.exports=factory(require("b"))}else{root.OpenLocationCode=factory()}})(this,function(){var OpenLocationCode={};var SEPARATOR_="+";var SEPARATOR_POSITION_=8;var PADDING_CHARACTER_="0";var CODE_ALPHABET_="23456789CFGHJMPQRVWX";var ENCODING_BASE_=CODE_ALPHABET_.length;var LATITUDE_MAX_=90;var LONGITUDE_MAX_=180;var PAIR_CODE_LENGTH_=10;var PAIR_RESOLUTIONS_=[20,1,.05,.0025,125e-6];var GRID_COLUMNS_=4;var GRID_ROWS_=5;var GRID_SIZE_DEGREES_=125e-6;var MIN_TRIMMABnLocationCode.getAlphabet=function(){return CODE_ALPHABET_};var isValid=OpenLocationCode.isValid=function(code){if(!code){return false}if(code.indexOf(SEPARATOR_)==-1){return false}if(code.indexOf(SEPARATOR_)!=code.lastIndexOf(SEPARATOR_)){return false}if(code.length==1){return false}if(code.indexOf(SEPARATOR_)>SEPARATOR_POSITION_||code.indexOf(SEPARATOR_)%2==1){return false}if(code.indexOf(PADDING_CHARACTER_)>-1){if(code.indexOf(PADDING_CHARACTER_)==0){return false}var padMatch=code.match(new RegExp("("+PADDING_CHARACTER_+"+)","g"));if(padMatch.length>1||padMatch[0].length%2==1||padMatch[0].length>SEPARATOR_POSITION_-2){return false}if(code.charAt(code.length-1)!=SEPARATOR_){return false}}if(code.length-code.indexOf(SEPARATOR_)-1==1){return false}code=code.replace(new RegExp("\\"+SEPARATOR_+"+"),"").replace(new RegExp(PADDING_CHARACTER_+"+"),"");for(var i=0,len=code.length;i<len;i++){var character=code.charAt(i).toUpperCase();if(character!=SEPARATOR_&&CODE_ALPHABET_.indexOf(character)==-1){return false}}return true};var isShort=OpenLocationCode.isShort=function(code){if(!isValid(code)){return false}if(code.indexOf(SEPARATOR_)>=0&&code.indexOf(SEPARATOR_)<SEPARATOR_POSITION_){return true}return false};var isFull=OpenLocationCode.isFull=function(code){if(!isValid(code)){return false}if(isShort(code)){return false}var firstLatValue=CODE_ALPHABET_.indexOf(code.charAt(0).toUpperCase())*ENCODING_BASE_;if(firstLatValue>=LATITUDE_MAX_*2){return false}if(code.length>1){var firstLngValue=CODE_ALPHABET_.indexOf(code.charAt(1).toUpperCase())*ENCODING_BASE_;if(firstLngValue>=LONGITUDE_MAX_*2){return false}}return true};var encode=OpenLocationCode.encode=function(latitude,longitude,codeLength){if(typeof codeLength=="undefined"){codeLength=PAIR_CODE_LENGTH_}if(codeLength<2||codeLength<SEPARATOR_POSITION_&&codeLength%2==1){throw"IllegalArgumentException: Invalid Open Location Code length"}latitude=clipLatitude(latitude);longitude=normalizeLongitude(longitude);if(latitude==90){latitude=latitude-computeLatitudePrecision(codeLength)}var code=encodePairs(latitude,longitude,Math.min(codeLength,PAIR_CODE_LENGTH_));if(codeLength>PAIR_CODE_LENGTH_){code+=encodeGrid(latitude,longitude,codeLength-PAIR_CODE_LENGTH_)}return code};var decode=OpenLocationCode.decode=function(code){if(!isFull(code)){throw"IllegalArgumentException: "+"Passed Open Location Code is not a valid full code: "+code}code=code.replace(SEPARATOR_,"");code=code.replace(new RegExp(PADDING_CHARACTER_+"+"),"");code=code.toUpperCase();var codeArea=decodePairs(code.substring(0,PAIR_CODE_LENGTH_));if(code.length<=PAIR_CODE_LENGTH_){return codeArea}var gridArea=decodeGrid(code.substring(PAIR_CODE_LENGTH_));return CodeArea(codeArea.latitudeLo+gridArea.latitudeLo,codeArea.longitudeLo+gridArea.longitudeLo,codeArea.latitudeLo+gridArea.latitudeHi,codeArea.longitudeLo+gridArea.longitudeHi,codeArea.codeLength+gridArea.codeLength)};var recoverNearest=OpenLocationCode.recoverNearest=function(shortCode,referenceLatitude,referenceLongitude){if(!isShort(shortCode)){if(isFull(shortCode)){return shortCode}else{throw"ValueError: Passed short code is not valid: "+shortCode}}referenceLatitude=clipLatitude(referenceLatitude);referenceLongitude=normalizeLongitude(referenceLongitude);shortCode=shortCode.toUpperCase();var paddingLength=SEPARATOR_POSITION_-shortCode.indexOf(SEPARATOR_);var resolution=Math.pow(20,2-paddingLength/2);var areaToEdge=resolution/2;var roundedLatitude=Math.floor(referenceLatitude/resolution)*resolution;var roundedLongitude=Math.floor(referenceLongitude/resolution)*resolution;var codeArea=decode(encode(roundedLatitude,roundedLongitude).substr(0,paddingLength)+shortCode);var degreesDifference=codeArea.latitudeCenter-referenceLatitude;if(degreesDifference>areaToEdge){codeArea.latitudeCenter-=resolution}else if(degreesDifference<-areaToEdge){codeArea.latitudeCenter+=resolution}degreesDifference=codeArea.longitudeCenter-referenceLongitude;if(degreesDifference>areaToEdge){codeArea.longitudeCenter-=resolution}else if(degreesDifference<-areaToEdge){codeArea.longitudeCenter+=resolution}return encode(codeArea.latitudeCenter,codeArea.longitudeCenter,codeArea.codeLength)};var shorten=OpenLocationCode.shorten=function(code,latitude,longitude){if(!isFull(code)){throw"ValueError: Passed code is not valid and full: "+code}if(code.indexOf(PADDING_CHARACTER_)!=-1){throw"ValueError: Cannot shorten padded codes: "+code}var code=code.toUpperCase();var codeArea=decode(code);if(codeArea.codeLength<MIN_TRIMMABLE_CODE_LEN_){throw"ValueError: Code length must be at least "+MIN_TRIMMABLE_CODE_LEN_}latitude=clipLatitude(latitude);longitude=normalizeLongitude(longitude);var range=Math.max(Math.abs(codeArea.latitudeCenter-latitude),Math.abs(codeArea.longitudeCenter-longitude));for(var i=PAIR_RESOLUTIONS_.length-2;i>=1;i--){if(range<PAIR_RESOLUTIONS_[i]*.3){return code.substring((i+1)*2)}}return code};var clipLatitude=function(latitude){return Math.min(90,Math.max(-90,latitude))};var computeLatitudePrecision=function(codeLength){if(codeLength<=10){return Math.pow(20,Math.floor(codeLength/-2+2))}return Math.pow(20,-3)/Math.pow(GRID_ROWS_,codeLength-10)};var normalizeLongitude=function(longitude){while(longitude<-180){longitude=longitude+360}while(longitude>=180){longitude=longitude-360}return longitude};var encodePairs=function(latitude,longitude,codeLength){var code="";var adjustedLatitude=latitude+LATITUDE_MAX_;var adjustedLongitude=longitude+LONGITUDE_MAX_;var digitCount=0;while(digitCount<codeLength){var placeValue=PAIR_RESOLUTIONS_[Math.floor(digitCount/2)];var digitValue=Math.floor(adjustedLatitude/placeValue);adjustedLatitude-=digitValue*placeValue;code+=CODE_ALPHABET_.charAt(digitValue);digitCount+=1;digitValue=Math.floor(adjustedLongitude/placeValue);adjustedLongitude-=digitValue*placeValue;code+=CODE_ALPHABET_.charAt(digitValue);digitCount+=1;if(digitCount==SEPARATOR_POSITION_&&digitCount<codeLength){code+=SEPARATOR_}}if(code.length<SEPARATOR_POSITION_){code=code+Array(SEPARATOR_POSITION_-code.length+1).join(PADDING_CHARACTER_)}if(code.length==SEPARATOR_POSITION_){code=code+SEPARATOR_}return code};var encodeGrid=function(latitude,longitude,codeLength){var code="";var latPlaceValue=GRID_SIZE_DEGREES_;var lngPlaceValue=GRID_SIZE_DEGREES_;var adjustedLatitude=(latitude+LATITUDE_MAX_)%latPlaceValue;var adjustedLongitude=(longitude+LONGITUDE_MAX_)%lngPlaceValue;for(var i=0;i<codeLength;i++){var row=Math.floor(adjustedLatitude/(latPlaceValue/GRID_ROWS_));var col=Math.floor(adjustedLongitude/(lngPlaceValue/GRID_COLUMNS_));latPlaceValue/=GRID_ROWS_;lngPlaceValue/=GRID_COLUMNS_;adjustedLatitude-=row*latPlaceValue;adjustedLongitude-=col*lngPlaceValue;code+=CODE_ALPHABET_.charAt(row*GRID_COLUMNS_+col)}return code};var decodePairs=function(code){var latitude=decodePairsSequence(code,0);var longitude=decodePairsSequence(code,1);return new CodeArea(latitude[0]-LATITUDE_MAX_,longitude[0]-LONGITUDE_MAX_,latitude[1]-LATITUDE_MAX_,longitude[1]-LONGITUDE_MAX_,code.length)};var decodePairsSequence=function(code,offset){var i=0;var value=0;while(i*2+offset<code.length){value+=CODE_ALPHABET_.indexOf(code.charAt(i*2+offset))*PAIR_RESOLUTIONS_[i];i+=1}return[value,value+PAIR_RESOLUTIONS_[i-1]]};var decodeGrid=function(code){var latitudeLo=0;var longitudeLo=0;var latPlaceValue=GRID_SIZE_DEGREES_;var lngPlaceValue=GRID_SIZE_DEGREES_;var i=0;while(i<code.length){var codeIndex=CODE_ALPHABET_.indexOf(code.charAt(i));var row=Math.floor(codeIndex/GRID_COLUMNS_);var col=codeIndex%GRID_COLUMNS_;latPlaceValue/=GRID_ROWS_;lngPlaceValue/=GRID_COLUMNS_;latitudeLo+=row*latPlaceValue;longitudeLo+=col*lngPlaceValue;i+=1}return CodeArea(latitudeLo,longitudeLo,latitudeLo+latPlaceValue,longitudeLo+lngPlaceValue,code.length)};var CodeArea=OpenLocationCode.CodeArea=function(latitudeLo,longitudeLo,latitudeHi,longitudeHi,codeLength){return new OpenLocationCode.CodeArea.fn.init(latitudeLo,longitudeLo,latitudeHi,longitudeHi,codeLength)};CodeArea.fn=CodeArea.prototype={init:function(latitudeLo,longitudeLo,latitudeHi,longitudeHi,codeLength){this.latitudeLo=latitudeLo;this.longitudeLo=longitudeLo;this.latitudeHi=latitudeHi;this.longitudeHi=longitudeHi;this.codeLength=codeLength;this.latitudeCenter=Math.min(latitudeLo+(latitudeHi-latitudeLo)/2,LATITUDE_MAX_);this.longitudeCenter=Math.min(longitudeLo+(longitudeHi-longitudeLo)/2,LONGITUDE_MAX_)}};CodeAr);(function(global,factory){window.SMap.LibProj4=factory()})(this,function(){"use strict";var globals=function(defs){defs("EPSG:4326","+title=WGS 84 (long/lat) +proj=longlat +ellps=WGS84 +datum=WGS84 +units=degrees");defs("EPSG:4269","+title=NAD83 (long/lat) +proj=longlat +a=6378137.0 +b=6356752.31414036 +ellps=GRS80 +datum=NAD83 +units=degrees");defs("EPSG:3857","+title=WGS 84 / Pseudo-Mercator +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs");defs.WGS84=defs["EPSG:4326"];defs["EPSG:3785"]=defs["EPSG:3857"];defs.GOOGLE=defs["EPSG:3857"];defs["EPSG:900913"]=defs["EPSG:3857"];defs["EPSG:102113"]=defs["EPSG:3857"]};var PJD_3PARAM=1;var PJD_7PARAM=2;var PJD_WGS84=4;var PJD_NODATUM=5;var SEC_TO_RAD=484813681109536e-20;var HALF_PI=Math.PI/2;var SIXTH=.16666666666666666;var RA4=.04722222222222222;var RA6=.022156084656084655;var EPSLN=1e-10;var D2R=.017453292519943295;var R2D=57.29577951308232;var FORTPI=Math.PI/4;var TWO_PI=Math.PI*2;var SPI=3.14159265359;var exports$1={};exports$1.greenwich=0;exports$1.lisbon=-9.131906111111;exports$1.paris=2.337229166667;exports$1.bogota=-74.080916666667;exports$1.madrid=-3.687938888889;exports$1.rome=12.452333333333;exports$1.bern=7.439583333333;exports$1.jakarta=106.807719444444;exports$1.ferro=-17.666666666667;exports$1.brussels=4.367975;exports$1.stockholm=18.058277777778;exports$1.athens=23.7163375;exports$1.oslo=10.722916666667;var units={ft:{to_meter:.3048},"us-ft":{to_meter:1200/3937}};var ignoredChar=/[\s_\-\/\(\)]/g;function match(obj,key){if(obj[key]){return obj[key]}var keys=Object.keys(obj);var lkey=key.toLowerCase().replace(ignoredChar,"");var i=-1;var testkey,processedKey;while(++i<keys.length){testkey=keys[i];processedKey=testkey.toLowerCase().replace(ignoredChar,"");if(processedKey===lkey){return obj[testkey]}}}var parseProj=function(defData){var self={};var paramObj=defData.split("+").map(function(v){return v.trim()}).filter(function(a){return a}).reduce(function(p,a){var split=a.split("=");split.push(true);p[split[0].toLowerCase()]=split[1];return p},{});var paramName,paramVal,paramOutname;var params={proj:"projName",datum:"datumCode",rf:function(v){self.rf=parseFloat(v)},lat_0:function(v){self.lat0=v*D2R},lat_1:function(v){self.lat1=v*D2R},lat_2:function(v){self.lat2=v*D2R},lat_ts:function(v){self.lat_ts=v*D2R},lon_0:function(v){self.long0=v*D2R},lon_1:function(v){ong2=v*D2R},alpha:function(v){self.alpha=parseFloat(v)*D2R},lonc:function(v){self.longc=v*D2R},x_0:function(v){self.x0=parseFloat(v)},y_0:function(v){self.y0=parseFloat(v)},k_0:function(v){self.k0=parseFloat(v)},k:function(v){self.k0=parseFloat(v)},a:function(v){self.a=parseFloat(v)},b:function(){selff.zone=pparams=v.oat(a)})},to_meter:function(v){self.to_meter=parseFloat(v)},units:function(v){self.units=v;var unit=match(uniter}},from_greenwich:function(v){self.from_greenwich=v*D2R},pm:function(v){var pm=match(exports$1,v);self.from_greenwich=(pm?pm:parseFloat(v))*D2R},nadgrids:function(v){if(v==="@null"){self.datumCode="none"}else{self.nadgrids=v}},axis:function(v){var legalAxis="ewnsud";if(v.length===3&&legalAxis.indexOf(v.substr(0,1))!==-1&&legalAxis.indexOf(v.substr(1,1))!==-1&&legalAxis.indexOf(v.substr(2,1))!==-1){self.axis=v}}};for(paramName in paramObj){paramVal=paramObj[paramName];if(paramName in params){paramOutname=params[paramName];if(typeof paramOutname==="function"){paramOutname(paramVal)}else{self[paramOutname]=paramVal}}else{self[paramName]=paramVal}}if(typeof self.datumCode==="string"&&self.datumCode!=="WGS84"){self.datumCode=self.datumCode.toLowerCase()}return self};var NEUTRAL=1;var KEYWORD=2;var NUMBER=3;var QUOTED=4;var AFTERQUOTE=5;var ENDED=-1;var whitespace=/\s/;var latin=/[A-Za-z]/;var keyword=/[A-Za-z84]/;var endThings=/[,\]]/;var digets=/[\d\.E\-\+]/;function Parser(text){if(typeof text!=="string"){throw new Error("not a string")}this.text=text.trim();this.level=0;this.place=0;this.root=null;this.stack=[];this.currentObject=null;this.state=NEUTRAL}Parser.prototype.readCharicter=function(){var char=this.text[this.place++];if(this.state!==QUOTED){while(whitespace.test(char)){if(this.place>=this.text.length){return}char=this.text[this.place++]}}switch(this.state){case NEUTRAL:return this.neutral(char);case KEYWORD:return this.keyword(char);case QUOTED:return this.quoted(char);case AFTERQUOTE:return this.afterquote(char);case NUMBER:return this.number(char);case ENDED:return}};Parser.prototype.afterquote=function(char){if(char==='"'){this.word+='"';this.state=QUOTED;return}if(endThings.test(char)){this.word=this.word.trim();this.afterItem(char);return}throw new Error("havn't handled \""+char+'" in afterquote yet, index '+this.place)};Parser.prototype.afterItem=function(char){if(char===","){if(this.word!==null){this.currentObject.push(this.word)}this.word=null;this.state=NEUTRAL;return}if(char==="]"){this.level--;if(this.word!==null){this.currentObject.push(this.word);this.word=null}this.state=NEUTRAL;this.currentObject=this.stack.pop();if(!this.currentObject){this.state=ENDED}return}};Parser.prototype.number=function(char){if(digets.test(char)){this.word+=char;return}if(endThings.test(char)){this.word=parseFloat(this.word);this.afterItem(char);return}throw new Error("havn't handled \""+char+'" in number yet, index '+this.place)};Parser.prototype.quoted=function(char){if(char==='"'){this.state=AFTERQUOTE;return}this.word+=char;return};Parser.prototype.keyword=function(char){if(keyword.test(char)){this.word+=char;return}if(char==="["){var newObjects=[];newObjects.push(this.word);this.level++;if(this.root===null){this.root=newObjects}else{this.currentObject.push(newObjects)}this.stack.push(this.currentObject);this.currentObject=newObjects;this.state=NEUTRAL;return}if(endThings.test(char)){this.afterItem(char);return}throw new Error("havn't handled \""+char+'" in keyword yet, index '+this.place)};Parser.prototype.neutral=function(char){if(latin.test(char)){this.word=char;this.state=KEYWORD;return}if(char==='"'){this.word="";this.state=QUOTED;return}if(digets.test(char)){this.word=char;this.state=NUMBER;return}if(endThings.test(char)){this.afterItem(char);return}throw new Error("havn't handled \""+char+'" in neutral yet, index '+this.place)};Parser.prototype.output=function(){while(this.place<this.text.length){this.readCharicter()}if(this.state===ENDED){return this.root}throw new Error('unable to parse string "'+this.text+'". State is '+this.state)};function parseString(txt){var parser=new Parser(txt);return parser.output()}function mapit(obj,key,value){if(Array.isArray(key)){value.unshuce(function(newObj,item){sExpr(item,newObj);return newObj},thing);if(key){obj[key]=out}}function sExpr(v,obj){if(!Array.isArray(v)){obj[v]=true;return}var key=v.shift();if(key==="PARAMETER"){key=v.shift()}if(v.length===1){if(Array.isArray(v[0])){obj[key]={};sExpr(v[0],obj[key]);return}obj[key]=v[0];return}if(!v.length){obj[key]=true;return}if(key==="TOWGS84"){obj[key]=v;return}if(!Array.isArray(key)){obj[key]={}}var i;switch(key){case"UNIT":case"PRIMEM":case"VERT_DATUM":obj[key]={name:v[0].toLowerCase(),convert:v[1]};if(v.length===3){sExpr(v[2],obj[key])}return;case"SPHEROID":case"ELLIPSOID":obj[key]={name:v[0],a:v[1],rf:v[2]};if(v.length===4){sExpr(v[3],obj[key])}return;case"PROJECTEDCRS":case"PROJCRS":case"GEOGCS":case"GEOCCS":case"PROJCS":case"LOCAL_CS":case"GEODCRS":case"GEODETICCRS":case"GEODETICDATUM":case"EDATUM":case"ENGINEERINGDATUM":case"VERT_CS":case"VERTCRS":case"VERTICALCRS":case"COMPD_CS":case"COMPOUNDCRS":case"ENGINEERINGCRS":case"ENGCRS":case"FITTED_CS":case"LOCAL_DATUM":case"DATUM":v[0]=["name",v[0]];mapit(obj,key,v);return;default:i=-1;while(++i<v.length){if(!Array.isArray(v[i])){return sExpr(v,obj[key])}}return mapit(obj,key,v)}}var D2R$1=.017453292519943295;function rename(obj,params){var outName=params[0];var inName=params[1];if(!(outName in obj)&&inName in obj){obj[outName]=obj[inName];i[2](obj[outName])}}}function d2r(input){return input*D2R$1}function cleanWKT(wkt){if(wkt.type==="GEOGCS"){wkt.projName="longlat"}else if(wkt.type==="LOCAL_CS"){wkt.projName="identity";wkt.local=true}else{if(typeof wkt.PROJECTION==="object"){wkt.projName=Object.keys(wkt.PROJECTION)[0]}else{wkt.projName=wkt.PROJECTION}}if(wkt.UNIT){wkt.units=wkt.UNIT.name.toLowerCase();if(wkt.units==="metre"){wkt.units="meter"}if(wkt.UNIT.convert){if(wkt.type==="GEOGCS"){if(wkt.DATUM&&wkt.DATUM.SPHEROID){wkt.to_meter=wkt.UNIT.convert*wkt.DATUM.SPHEROID.a}}else{wkt.to_meter=wkt.UNIT.convert}}}var geogcs=wkt.GEOGCS;if(wkt.type==="GEOGCS"){geogcs=wkt}if(geogcs){if(geogcs.DATUM){wkt.datumCode=geogcs.DATUM.name.toLowerCase()}else{wkt.datumCode=geogcs.name.toLowerCase()}if(wkt.datumCode.slice(0,2)==="d_"){wkt.datumCode=wkt.datumCode.slice(2)}if(wkt.datumCode==="new_zealand_geodetic_datum_1949"||wkt.datumCode==="new_zealand_1949"){wkt.datumCode="nzgd49"}if(wkt.datumCode==="wgs_1984"){if(wkt.PROJECTION==="Mercator_Auxiliary_Sphere"){wkt.sphere=true}wkt.datumCode="wgs84"}if(wkt.datumCode.slice(-6)==="_ferro"){wkt.datumCode=wkt.datumCode.slice(0,-6)}if(wkt.datumCode.slice(-8)==="_jakarta"){wkt.datumCode=wkt.datumCode.slice(0,-8)}if(~wkt.datumCode.indexOf("belge")){wkt.datumCode="rnb72"}if(geogcs.DATUM&&geogcs.DATUM.SPHEROID){wkt.ellps=geogcs.DATUM.SPHEROID.name.replace("_19","").replace(/[Cc]larke\_18/,"clrk");if(wkt.ellps.toLowerCase().slice(0,13)==="international"){wkt.ellps="intl"}wkt.a=geogcs.DATUM.SPHEROID.a;wkt.rf=parseFloat(geogcs.DATUM.SPHEROID.rf,10)}if(geogcs.DATUM&&geogcs.DATUM.TOWGS84){wkt.datum_params=geogcs.DATUM.TOWGS84}if(~wkt.datumCode.indexOf("osgb_1936")){wkt.datumCode="osgb36"}if(~wkt.datumCode.indexOf("osni_1952")){wkt.datumCode="osni52"}if(~wkt.datumCode.indexOf("tm65")||~wkt.datumCode.indexOf("geodetic_datum_of_1965")){wkt.datumCode="ire65"}if(wkt.datumCode==="ch1903+"){wkt.datumCode="ch1903"}if(~wkt.datumCode.indexOf("israel")){wkt.datumCode="isr93"}}if(wkt.b&&!isFinite(wkt.b)){wkt.b=wkt.a}function toMeter(inpun input*ratio}var renamer=function(a){return rename(wkt,a)};var list=[["standard_parallel_1","Standard_Parallel_1"],["standard_parallel_2","Standard_Parallel_2"],["false_easting","False_Easting"],["false_northing","False_Northing"],["central_meridian","Central_Meridian"],["latitude_of_origin","Latitude_Of_Origin"],["latitude_of_origin","Central_Parallel"],["scale_factor","Scale_Factor"],["k0","scale_factor"],["latitude_of_center","Latitude_Of_Center"],["latitude_of_center","Latitude_of_center"],["lat0","latitude_of_center",d2r],["longitude_of_center","Longitude_Of_Center"],["longitude_of_center","Longitude_of_center"],["longc","longitude_of_center",d2r],["x0","false_easting",toMeter],["y0","false_northing",toMeter],["long0","central_meridian",d2r],["lat0","latitude_of_origin",d2r],["lat0","standard_parallel_1",d2r],["lat1","standard_parallel_1",d2r],["lat2","standard_parallel_2",d2r],["azimuth","Azimuth"],["alpha","azimuth",d2r],["srsCode","name"]];list.forEach(renamer);if(!wkt.long0&&wkt.longc&&(wkt.projName==="Albers_Conic_Equal_Area"||wkt.projName==="Lambert_Azimuthal_Equal_Area")){wkt.long0=wkt.longc}if(!wkt.lat_ts&&wkt.lat1&&(wkt.projName==="Stereographic_South_Pole"||wkt.projName==="Polar Stereographic (variant B)")){wkt.lat0=d2r(wkt.lat1>0?90:-90);wkt.lat_ts=wkt.lat1}}var wkt=function(wkt){var lisp=parseString(wkt);var type=lisp.shift();var name=lisp.shift();lisp.unshift(["name",name]);lisp.unshift(["type",type]);var obj={};sExpr(lisp,obj);cleanWKT(obj);return obj};function defs(name){var that=this;if(arguments.length===2){var def=arguments[1];if(typeof def==="string"){if(def.charAt(0)==="+"){defs[name]=parseProj(arguments[1])}else{defs[name]=wkt(arguments[1])}}else{defs[name]=def}}else if(arguments.length===1){if(Array.isArray(name)){return name.map(function(v){if(Array.isArray(v)){defs.apply(that,v)}else{defs(v)}})}else if(typeof name==="string"){if(name in defs){return defs[name]}}else if("EPSG"in name){defs["EPSG:"+name.EPSG]=name}else if("ESRI"in name){defs["ESRI:"+name.ESRI]=name}else if("IAU2000"in name){defs["IAU2000:"+nameode==="string"}function testDef(code){return code in defs}var codeWords=["PROJECTEDCRS","PROJCRS","GEOGCS","GEOCCS","PROJCS","LOCAL_CS","GEODCRdeWords.some(function(word){return code.indexOf(word)>-1})}var codes=["3857","900913","3785","102113"];function checkMercator(item){var auth=match(item,"authority");if(!auth){return}var code=match(auth,"epsg");return code&&codes.indexOf(code)>-1}function checkProjStr(item){var ext=match((ext,"proj4")}function testProj(code){return code[0]==="+"}function parse(code){if(testObj(code)){if(testDef(code)){return defs[code]}if(testWKT(code)){var out=wkt(code);if(checkMercator(out)){return defs["EPSG:3857"]}var maybeProjStr=checkProjStr(out);if(maybeProjStr){return parseProj(maybeProjStr)}return out}if(testProj(code)){return parseProj(code)}}else{return code}}var extend=function(destination,source){destination=destination||{};var value,property;if(!source){return destination}for(property in source){value=source[property];if(value!==undefined)){var conMath.sqrt(1-conlon=function(x){return Math.abs(x)<=SPI?x:x-sign(x)*TWO_PI};var tsfnz=function(eccent,phi,sinphi){var con=eccent*sinphi;var com=.5*eccent;con=Math.pow((1-con)/(1+con),com);return Math.tan(.5*(HALF_PI-phi))/con};var phi2z=function(eccent,ts){var eccnth=.5*eccent;var con,dphi;var phi=HALF_PI-2*Math.atan(ts);for(var i=0;i<=15;i++){con=eccent*Math.sin(phi);dphi=HALF_PI-2*Math.atan(ts*Math.pow((1-con)/(1+con),eccnth))-phi;phi+=dphi;if(Math.abs(dphi)<=1e-10){return phi}}return-9999};function init(){var con=this.b/this.a;this.es=1-con*con;if(!("x0"in this)){this.x0=0}if(!("y0"in this)){this.y0=0}this.e=Math.sqrt(this.es);if(this.lat_ts){if(this.sphere){this.k0=Math.cos(this.lat_ts)}else{this.k0=msfnz(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts))}}else{if(!this.k0){if(this.k){this.k0=this.k}else{this.k0=1}}}}function forward(p){var lon=p.x;var lat=p.y;if(lat*R2D>90&&lat*R2D<-90&&lon*R2D>180&&lon*R2D<-180){return null}var x,y;if(Math.abs(Math.abs(lat)-HALF_PI)<=EPSLN){return null}else{if(this.sphere){x=this.x0+this.a*this.k0*adjust_lon(lon-this.long0);y=this.y0+this.a*this.k0*Math.log(Math.tan(FORTPI+.5*lat))}else{var sinphi=Math.sin(lat);var ts=tsfnz(this.e,lat,sinphi);x=this.x0+this.a*this.k0*adjust_lon(lon-this.long0);y=this.y0-this.a*this.k0*Math.log(ts)}p.x=x;p.y=y;return p}}function inverse(p){var x=p.x-this.x0;var y=p.y-this.y0;var lon,lat;if(this.sphere){lat=HALF_PI-2*Math.atan(Math.exp(-y/(this.a*this.k0)))}else{var ts=Math.exp(-y/(this.a*this.k0));lat=phi2z(this.e,ts);if(lat===-9999){return null}}lon=adjust_lon(this.long0+x/(this.a*this.k0));p.x=lon;p.y=lat;return p}var names$1=["Mercator","Popular Visualisation Pseudo Mercator","Mercator_1SP","Mercator_Auxiliary_Sphere","merc"];var mermes$1};function init$1(){}function identity(pt){return pt}var names$2=["longlat","identity"];var longlat={init:init$1,forward:identity,inverse:identity,names:names$2};var projs=[merc,longlat];var names={};var projStore=[];function add(proj,i){var len=projStore.length;if(!proj.names){consol;proj.names.forEach(function(n){names[n.toLowerCase()]=len});return this}function get(name){if(!name){return false}var n=name.toLowerCase();if(typeof names[n]!=="un projStore[names[n]]}}function start(){projs.forEach(add)}var projections={start:start,add:add,get:get};var exports$2={};exports$2.MERIT={a:6378137,rf:298.257,ellipseName:"MERIT 1983"};exports$2.SGS85={a:6378136,rf:298.257,ellipseName:"Soviet Geodetic System 85"};exports$2.GRS80={a:6378137,rf:298.257222101,ellipseName:"GRS 1980(IUGG, 1980)"};exports$2.IAU76={a:6378140,rf:298.257,ellipseName:"IAU 1976"};exports$2.airy={a:6377563.396,b:6356256.91,ellipseName:"Airy 1830"};exports$2.APL4={a:6378137,rf:298.25,ellipseName:"Appl. Physics. 1965"};exports$2.NWL9D={a:6378145,rf:298.25,ellipseName:"Naval Weapons Lab., 1965"};exports$2.mod_airy={a:6377340.189,b:6356034.446,ellipseName:"Modified Airy"};exports$2.andrae={a:6377104.43,rf:300,ellipseName:"Andrae 1876 (Den., Iclnd.)"};exports$2.aust_SA={a:6378160,rf:298.25,ellipseName:"Australian Natl & S. Amer. 1969"};exports$2.GRS67={a:6378160,rf:298.247167427,ellipseName:"GRS 67(IUGG 1967)"};exports$2.bessel={a:6377397.155,rf:299.1528128,ellipseName:"Bessel 1841"};exports$2.bess_nam={a:6377483.865,rf:299.1528128,ellipseName:"Bessel 1841 (Namibia)"};exports$2.clrk66={a:6378206.4,b:6356583.8,ellipseName:"Clarke 1866"};exports$2.clrk80={a:6378249.145,rf:293.4663,ellipseName:"Clarke 1880 mod."};exports$2.clrk58={a:6378293.645208759,rf:294.2606763692654,ellipseName:"Clarke 1858"};exports$2.CPM={a:6375738.7,rf:334.29,ellipseName:"Comm. des Poids et Mesures 1799"};exports$2.delmbr={a:6376428,rf:311.5,ellipseName:"Delambre 1810 (Belgium)"};exports$2.engelis={a:6378136.05,rf:298.2566,ellipseName:"Engelis 1985"};exports$2.evrst30={a:6377276.345,rf:300.8017,ellipseName:"Everest 1830"};exports$2.evrst48={a:6377304.063,rf:300.8017,ellipseName:"Everest 1948"};exports$2.evrst56={a:6377301.243,rf:300.8017,ellipseName:"Everest 1956"};exports$2.evrst69={a:6377295.664,rf:300.8017,ellipseName:"Everest 1969"};exports$2.evrstSS={a:6377298.556,rf:300.8017,ellipseName:"Everest (Sabah & Sarawak)"};exports$2.fschr60={a:6378166,rf:298.3,ellipseName:"Fischer (Mercury Datum) 1960"};exports$2.fschr60m={a:6378155,rf:298.3,ellipseName:"Fischer 1960"};exports$2.fschr68={a:6378150,rf:298.3,ellipseName:"Fischer 1968"};exports$2.helmert={a:6378200,rf:298.3,ellipseName:"Helmert 1906"};exports$2.hough={a:6378270,rf:297,ellipseName:"Hough"};exports$2.intl={a:6378388,rf:297,ellipseName:"International 1909 (Hayford)"};exports$2.kaula={a:6378163,rf:298.24,ellipseName:"Kaula 1961"};exports$2.lerch={a:6378139,rf:298.257,ellipseName:"Lerch 1979"};exports$2.mprts={a:6397300,rf:191,ellipseName:"Maupertius 1738"};exports$2.new_intl={a:6378157.5,b:6356772.2,ellipseName:"New International 1967"};exports$2.plessis={a:6376523,rf:6355863,ellipseName:"Plessis 1817 (France)"};exports$2.krass={a:6378245,rf:298.3,ellipseName:"Krassovsky, 1942"};exports$2.SEasia={a:6378155,b:6356773.3205,ellipseName:"Southeast Asia"};exports$2.walbeck={a:6376896,b:6355834.8467,ellipseName:"Walbeck"};exports$2.WGS60={a:6378165,rf:298.3,ellipseName:"WGS 60"};exports$2.WGS66={a:6378145,rf:298.25,ellipseName:"WGS 66"};exports$2.WGS7={a:6378135,rf:298.26,ellipseName:"WGS 72"};var WGS84=exports$2.WGS84={a:6378137,rf:298.257223563,ellipseName:"WGS 84"};exports$2.sphere={a:6370997,b:6370997,ellipseName:"Normal Sphere (r=6370997)"};function eccentricity(a,b,rf,R_A){var a2=a*a;var b2=b*b;var es=(a2-b2)/a2;var e=0;if(R_A){a*=1-es*(SIXTH+es*(RA4+es*RA6));a2=a*a;es=0}else{e=Math.sqrt(es)}var ep2=(a2-b2)/b2;return{es:es,e:e,ep2:ep2}}function sphere(a,b,rf,ellps,sphere){if(!a){var ellipse=match(exports$2,ellps);if(!ellipse){ellipse=WGS84}a=ellipse.a;b=ellipse.b;rf=ellipse.rf}if(rf&&!b){b=(1-1/rf)*a}if(rf===0||Math.abs(a-b)<EPSLN){sphere=true;b=a}return{a:a,b:b,rf:rf,sphere:sphere}}var exports$3={};exports$3.wgs84={towgs84:"0,0,0",ellipse:"WGS84",datumName:"WGS84"};exports$3.ch1903={towgs84:"674.374,15.056,405.346",ellipse:"bessel",datumName:"swiss"};exports$3.ggrs87={towgs84:"-199.87,74.79,246.62",ellipse:"GRS80",datumName:"Greek_Geodetic_Reference_System_1987"};exports$3.nad83={towgs84:"0,0,0",ellipse:"GRS80",datumName:"North_American_Datum_1983"};exports$3.nad27={nadgrids:"@conus,@alaska,@ntv2_0.gsb,@ntv1_can.dat",ellipse:"clrk66",datumName:"North_American_Datum_1927"};exports$3.potsdam={towgs84:"606.0,23.0,413.0",ellipse:"bessel",datumName:"Potsdam Rauenberg 1950 DHDN"};exports$3.carthage={towgs84:"-263.0,6.0,431.0",ellipse:"clark80",datumName:"Carthage 1934 Tunisia"};exports$3.hermannskogel={towgs84:"653.0,-212.0,449.0",ellipse:"bessel",datumName:"Hermannskogel"};exports$3.osni52={towgs84:"482.530,-130.596,564.557,-1.042,-0.214,-0.631,8.15",ellipse:"airy",datumName:"Irish National"};exports$3.ire65={towgs84:"482.530,-130.596,564.557,-1.042,-0.214,-0.631,8.15",ellipse:"mod_airy",datumName:"Ireland 1965"};exports$3.rassadiran={towgs84:"-133.63,-157.5,-158.62",ellipse:"intl",datumName:"Rassadiran"};exports$3.nzgd49={towgs84:"59.47,-5.04,187.44,0.47,-0.1,1.024,-4.5993",ellipse:"intl",datumName:"New Zealand Geodetic Datum 1949"};exports$3.osgb36={towgs84:"446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894",ellipse:"airy",datumName:"Airy 1830"};exports$3.s_jtsk={towgs84:"589,76,480",ellipse:"bessel",datumName:"S-JTSK (Ferro)"};exports$3.beduaram={towgs84:"-106,-87,188",ellipse:"clrk80",datumName:"Beduaram"};exports$3.gunung_segara={towgs84:"-403,684,41",ellipse:"bessel",datumName:"Gunung Segara Jakarta"};exports$3.rnb72={towgs84:"106.869,-52.2978,103.724,-0.33657,0.456955,-1.84218,1",ellipse:"intl",datumName:"Reseau National Belge 1972"};function datum(datumCode,datum_params,a,b,es,ep2){var out={};if(datumCode===undefined||datumCode==="none"){out.datum_type=PJD_NODATUM}else{out.datum_type=PJD_WGS84}if(datum_params){out.datum_params=datum_params.map(parseFloat);if(out.datum_params[0]!==0||out.datum_params[1]!==0||out.datum_params[2]!==0){out.datum_type=PJD_3PARAM}if(out.datum_params.length>3){if(out.datum_params[3]!==0||out.datum_params[4]!==0||out.datum_params[5]!==0||out.datum_params[6]!==0){out.datum_type=PJD_7PARAM;out.datum_params[3]*=SEC_TO_RAD;out.datum_params[4]*=SEC_TO_RAD;out.datum_params[5]*=SEC_TO_RAD;out.datum_params[6]=out.datum_params[6]/1e6+1}}}out.a=a;out.b=b;out.es=es;out.ep2=ep2;return out}function Projection(srsCode,callback){if(!(this instanceof Pro}callback=callback||function(error){if(error){throw error}};var json=parse(srsCode);if(typeof json!=="object"){callback(srsCode);return}var ourProj=Projection.projections.get(json.projName);if(!ourProj){callback(srsCode);return}if(json.datumCode&&json.datumCode!=="none"){var datumDef=match(exports$3,json.datumCode);if(datumDef){json.datum_params=datumDef.towgs84?datumDef.towgs84.split(","):null;json.ellps=datumDef.ellipse;json.datumName=datumDef.datumName?datumDef.datumName:json.datumCode}}json.k0=json.k0||1;json.axis=json.axis||"enu";json.ellps=json.ellps||"wgs84";var sphere_=sphere(json.a,json.b,json.rf,json.ellps,json.sphere);var ecc=eccentricity(sphere_.a,sphere_.b,sphere_.rf,json.R_A);var datumObj=json.datum||datum(json.datumCode,json.datum_params,sphere_.a,sphere_.b,ecc.es,ecc.ep2);extend(this,json);extend(this,ourProj);this.a=sphere_.a;this.b=sphere_.b;this.rf=sphere_.rf;this.sphere=sphere_.sphere;this.es=ecc.es;this.e=ecc.e;this.ep2=ecc.ep2;this.datum=datumObj;this.init();callback(null,this)}Projection.projections=projections;Projection.projections.start();"use strict";function compareDatums(source,dest){if(source.datum_type!==dest.datum_type){return false}else if(source.a!==dest.a||Math.abs(source.es-dest.es)>5e-11){return false}else if(source.datum_type===PJD_3PARAM){return source.datum_params[0]===dest.datum_params[0]&&source.datum_params[1]===dest.datum_params[1]&&source.datum_params[2]===dest.datum_params[2]}else if(source.datum_type===PJD_7PARAM){return source.datum_params[0]===dest.datum_params[0]&&source.datum_params[1]===dest.datum_params[1]&&source.datum_params[2]===dest.datum_params[2]&&source.datum_params[3]===dest.datum_params[3]&&source.datum_params[4]===dest.datum_params[4]&&source.datum_params[5]===dest.datum_params[5]&&source.datum_params[6]===dest.datum_params[6]}else{return true}}function geodeticToGeocentric(p,es,a){var Longitude=p.x;var Latitude=p.y;var Height=p.z?p.z:0;var Rn;var Sin_Lat;var Sin2_Lat;var Cos_Lat;if(Latitude<-HALF_PI&&Latitude>-1.001*HALF_PI){Latitude=-HALF_PI}else if(Latitude>HALF_PI&&Latitude<1.001*HALF_PI){Latitude=HALF_PI}else if(Latitude<-HALF_PI){return{x:-Infinity,y:-Infinity,z:p.z}}else if(Latitude>HALF_PI){return{x:Infinity,y:Infinity,z:p.z}}if(Longitude>Math.PI){Longitude-=2*Math.PI}Sin_Lat=Math.sin(Latitude);Cos_Lat=Math.cos(Latitude);Sin2_Lat=Sin_Lat*Sin_Lat;Rn=a/Math.sqrt(1-es*Sin2_Lat);return{x:(Rn+Height)*Cos_Lat*Math.cos(Longitude),y:(Rn+Height)*Cos_Lat*Math.sin(Longitude),z:(Rn*(1-es)+Height)*Sin_Lat}}function geocentricToGeodetic(p,es,a,b){var genau=1e-12;var genau2=genau*genau;var maxiter=30;var P;var RR;var CT;var ST;var RX;var RK;var RN;var CPHI0;var SPHI0;var CPHI;var SPHI;var SDPHI;var iter;var X=p.x;var Y=p.y;var Z=p.z?p.z:0;var Longitude;var Latitude;var Height;P=Math.sqrt(X*X+Y*Y);RR=Math.sqrt(X*X+Y*Y+Z*Z);if(P/a<genau){Longitude=0;if(RR/a<genau){Latitude=HALF_PI;Height=-b;return{x:p.x,y:p.y,z:p.z}}}else{Longitude=Math.atan2(Y,X)}CT=Z/RR;ST=P/RR;RX=1/Math.sqrt(1-es*(2-es)*ST*ST);CPHI0=ST*(1-es)*RX;SPHI0=CT*RX;iter=0;do{iter++;RN=a/Math.sqrt(1-es*SPHI0*SPHI0);Height=P*CPHI0+Z*SPHI0-RN*(1-es*SPHI0*SPHI0);RK=es*RN/(RN+Height);RX=1/Math.sqrt(1-RK*(2-RK)*ST*ST);CPHI=ST*(1-RK)*RX;SPHI=CT*RX;SDPHI=SPHI*CPHI0-CPHI*SPHI0;CPHI0=CPHI;SPHI0=SPHI}while(SDPHI*SDPHI>genau2&&iter<maxiter);Latitude=Math.atan(SPHI/Math.abs(CPHI));return{x:Longitude,y:Latitude,z:Height}}function geocentricToWgs84(p,datum_type,datum_params){if(datum_type===PJD_3PARAM){return{x:p.x+datum_params[0],y:p.y+datum_params[1],z:p.z+datum_params[2]}}else if(datum_type===PJD_7PARAM){var Dx_BF=datum_params[0];var Dy_BF=datum_params[1];var Dz_BF=datum_params[2];var Rx_BF=datum_params[3];var Ry_BF=datum_params[4];var Rz_BF=datum_params[5];var M_BF=datum_params[6];return{x:M_BF*(p.x-Rz_BF*p.y+Ry_BF*p.z)+Dx_BF,y:M_BF*(Rz_BF*p.x+p.y-Rx_BF*p.z)+Dy_BF,z:M_BF*(-Ry_BF*p.x+Rx_BF*p.y+p.z)+Dz_BF}}}function geocentricFromWgs84(p,datum_type,datum_params){if(datum_type===PJD_3PARAM){return{x:p.x-datum_params[0],y:p.y-datum_params[1],z:p.z-datum_params[2]}}else if(datum_type===PJD_7PARAM){var Dx_BF=datum_params[0];var Dy_BF=datum_params[1];var Dz_BF=datum_params[2];var Rx_BF=datum_params[3];var Ry_BF=datum_params[4];var Rz_BF=datum_params[5];var M_BF=datum_params[6];var x_tmp=(p.x-Dx_BF)/M_BF;var y_tmp=(p.y-Dy_BF)/M_BF;var z_tmp=(p.z-Dz_BF)/M_BF;return{x:x_tmp+Rz_BF*y_tmp-Ry_BF*z_tmp,y:-Rz_BckParams(type){return type===PJD_3PARAM||type===PJD_7PARAM}var datum_transform=function(source,dest,point){if(compareDatums(source,dest)){return point}if(source.datum_type===PJD_NODATUM||dest.datum_type===PJD_NODATUM){return point}if(source.es===dest.es&&source.a===dest.a&&!checkParams(source.datum_type)&&!checkParams(dest.datum_type)){return point}point=geodeticToGeocentric(point,source.es,source.a);if(checkParams(source.datum_type)){point=geocentricToWgs84(point,source.datum_type,source.datum_params)}if(checkParams(dest.datum_type)){point=geocentricFromWgs84(point,dest.datum_type,dest.datum_params)}return geocentricToGeodetic(point,dest.es,dest.a,dest.b)};var adjust_axis=function(crs,denorm,point){var xin=point.x,yin=point.y,zin=point.z||0;var v,t,i;var out={};for(i=0;i<3;i++){if(denorm&&i===2&&point.z===undefined){continue}if(i===0){v=xin;t="x"}else if(i===1){v=yin;t="y"}else{v=zin;t="z"}switch(crs.axis[i]){case"e":out[t]=v;break;case"w":out[t]=-v;break;case"n":out[t]=v;break;case"s":out[t]=-v;break;case"u":if(point[t]!==undefined){out.z=v}break;case"d":if(point[t]!==undefined){out.z=-v}break;default:return null}}return out};var toPoint=function(array){var out={x:array[0],y:array[1]};if(array.length>2){out.z=array[2]}ifty=function(point){checkCoord(point.x);checkCoord(point.y)};function checkCoord(num){if(typeof Number.isFinite==="function"){if(Number.isFinite(num)){return}throw new TypeError("coordinates must be finite numbers")}if(typeof num!=="number"||num!==num||!isFinite(num)){throw new TypeError("coordinates must be finite numbers")}}function checkNotWGS(source,dest){return(source.datum.datum_type===PJD_3PARAM||source.datum.datum_type===PJD_7PARAM)&&dest.datumCode!=="WGS84"||(dest.datum.datum_type===PJD_3PARAM||dest.datum.datum_type===PJD_7PARAM)&&source.datumCode!=="WGS84"}function transform(source,dest,point){var wgs84;if(Array.isArray(point)){point=toPoint(point)}checkSanity(point);if(source.datum&&dest.datum&&checkNotWGS(source,dest)){wgs84=new Projection("WGS84");point=transform(source,wgs84,point);source=wgs84}if(source.axis!=="enu"){point=adjust_axis(source,false,point)}if(source.projName==="longlat"){point={x:point.x*D2R,y:point.y*D2R}}else{if(source.to_meter){point={x:point.x*source.to_meter,y:point.y*source.to_meter}}point=source.inverse(point)}if(source.from_greenwich){point.x+=source.from_greenwich}point=datum_transform(source.datum,dest.datum,point);if(dest.from_greenwich){point={x:point.x-dest.from_greenwich,y:point.y}}if(dest.projName==="longlat"){point={x:point.x*R2D,y:point.y*R2D}}else{point=dest.forward(point);if(dest.to_meter){point={x:point.x/dest.to_meter,y:point.y/dest.to_meter}}}if(dest.axis!=="enu"){return adjust_axis(dest,true,point)}return point}var wgs84=Projection("WGS84");function transformer(from,to,coords){var transformedArray,out,keys;if(Array.isArray(coords)){transformedArray=transform(from,to,coords);if(coords.length===3){return[transformedArray.x,transformedArray.y,transformedArray.z]}else{return[transformedArray.x,transformedArray.y]}}else{out=transform(from,to,coords);keys=Object.keys(coords);if(keys.length===2){return out}keys.forEach(function(key){if(key==="x"||key==="y"){return}out[key]=coords[key]});return out}}function checkProj(item){if(item instanceof Projection){return item}if(item.oProj){return item.oProj}return Projection(item)}function proj4$1(fromProj,toProj,coord){fromProj=checkProj(fromProj);var single=false;var obj;if(typeof toProj==="undefined"){toProj=fromProj;fromProj=wgs84;single=true}else if(typeof toProj.x!=="undefined"||Array.isArray(toProj)){coord=toProj;toProj=fromProj;fromProj=wgs84;single=true}toProj=checkProj(toProj);if(coord){return transformer(fromProj,toProj,coord)}else{obj={forward:function(unction(coords){return transformer(toProj,fromProj,coords)}};if(single){obj.oProj=toProj}return obj}}var NUM_100K_SETS=6;var SET_ORIGIN_COLUMN_LETTERS="AJSAJS";var SET_ORIGIN_ROW_LETTERS="AFAFAF";var A=65;var I=73;var O=79;var V=86;var Z=90;var mgrs={forward:forward$1,inverse:inverse$1,toPoint:toPoint$1};function forward$1(ll,accuracy){accuracy=accuracy||5;return encode(LLtoUTM({lat:ll[1],lon:ll[0]}),accuracy)}function inverse$1(mgrs){var bbox=UTMtoLL(decode(mgrs.toUpperCase()));if(bbox.lat&&bbox.lon){return[bbox.lon,bbox.lat,bbox.lon,bbox.lat]}return[bbox.left,bbox.bottom,bbox.right,bbox.top]}function toPoint$1(mgrs){var bbox=UTMtoLL(decode(mgrs.toUpperCase()));if(bbox.lat&&bbox.lon){return[bbox.lon,bbox.lath.PI/180)}function radToDeg(rad){return 180*(rad/Math.PI)}function LLtoUTM(ll){var Lat=ll.lat;var Long=ll.lon;var a=6378137;var eccSquared=.00669438;var k0=.9996;var LongOrigin;var eccPrimeSquared;var N,T,C,A,M;var LatRad=degToRad(Lat);var LongRad=degToRad(Long);var LongOriginRad;var ZoneNumber;ZoneNumber=Math.floor((Long+180)/6)+1;if(Long===180){ZoneNumber=60}if(Lat>=56&&Lat<64&&Long>=3&&Long<12){ZoneNumber=32}if(Lat>=72&&Lat<84){if(Long>=0&&Long<9){ZoneNumber=31}else if(Long>=9&&Long<21){ZoneNumber=33}else if(Long>=21&&Long<33){ZoneNumber=35}else if(Long>=33&&Long<42){ZoneNumber=37}}LongOrigin=(ZoneNumber-1)*6-180+3;LongOriginRad=degToRad(LongOrigin);eccPrimeSquared=eccSquared/(1-eccSquared);N=a/Math.sqrt(1-eccSquared*Math.sin(LatRad)*Math.sin(LatRad));T=Math.tan(LatRad)*Math.tan(LatRad);C=eccPrimeSquared*Math.cos(LatRad)*Math.cos(LatRad);A=Math.cos(LatRad)*(LongRad-LongOriginRad);M=a*((1-eccSquared/4-3*eccSquared*eccSquared/64-5*eccSquared*eccSquared*eccSquared/256)*LatRad-(3*eccSquared/8+3*eccSquared*eccSquared/32+45*eccSquared*eccSquared*eccSquared/1024)*Math.sin(2*LatRad)+(15*eccSquared*eccSquared/256+45*eccSquared*eccSquared*eccSquared/1024)*Math.sin(4*LatRad)-35*eccSquared*eccSquared*eccSquared/3072*Math.sin(6*LatRad));var UTMEasting=k0*N*(A+(1-T+C)*A*A*A/6+(5-18*T+T*T+72*C-58*eccPrimeSquared)*A*A*A*A*A/120)+5e5;var UTMNorthing=k0*(M+N*Math.tan(LatRad)*(A*A/2+(5-T+9*C+4*C*C)*A*A*A*A/24+(61-58*T+T*T+600*C-330*eccPrimeSquared)*A*A*A*A*A*A/720));if(Lat<0){UTMNorthing+=1e7}return{northing:Math.round(UTMNorthing),easting:Math.round(UTMEasting),zoneNumber:ZoneNumber,zoneLetter:getLetterDesignator(Lat)}}function UTMtoLL(utm){var UTMNorthing=utm.northing;var UTMEasting=utm.easting;var zoneLetter=utm.zoneLetter;var zoneNumber=utm.zoneNumber;if(zoneNumber<0||zoneNumber>60){return null}var k0=.9996;var a=6378137;var eccSquared=.00669438;var eccPrimeSquared;var e1=(1-Math.sqrt(1-eccSquared))/(1+Math.sqrt(1-eccSquared));var N1,T1,C1,R1,D,M;var LongOrigin;var mu,phi1Rad;var x=UTMEasting-5e5;var y=UTMNorthing;if(zoneLetter<"N"){y-=1e7}LongOrigin=(zoneNumber-1)*6-180+3;eccPrimeSquared=eccSquared/(1-eccSquared);M=y/k0;mu=M/(a*(1-eccSquared/4-3*eccSquared*eccSquared/64-5*eccSquared*eccSquared*eccSquared/256));phi1Rad=mu+(3*e1/2-27*e1*e1*e1/32)*Math.sin(2*mu)+(21*e1*e1/16-55*e1*e1*e1*e1/32)*Math.sin(4*mu)+151*e1*e1*e1/96*Math.sin(6*mu);N1=a/Math.sqrt(1-eccSquared*Math.sin(phi1Rad)*Math.sin(phi1Rad));T1=Math.tan(phi1Rad)*Math.tan(phi1Rad);C1=eccPrimeSquared*Math.cos(phi1Rad)*Math.cos(phi1Rad);R1=a*(1-eccSquared)/Math.pow(1-eccSquared*Math.sin(phi1Rad)*Math.sin(phi1Rad),1.5);D=x/(N1*k0);var lat=phi1Rad-N1*Math.tan(phi1Rad)/R1*(D*D/2-(5+3*T1+10*C1-4*C1*C1-9*eccPrimeSquared)*D*D*D*D/24+(61+90*T1+298*C1+45*T1*T1-252*eccPrimeSquared-3*C1*C1)*D*D*D*D*D*D/720);lat=radToDeg(lat);var lon=(D-(1+2*T1+C1)*D*D*D/6+(5-2*C1+28*T1-3*C1*C1+8*eccPrimeSquared+24*T1*T1)*D*D*D*D*D/120)/Math.cos(phi1Rad);lon=LongOrigin+radToDeg(lon);var result;if(utm.accuracy){var topRight=UTMtoLL({northing:utm.northing+utm.accuracy,easting:utm.easting+utm.accuracy,zoneLetter:utm.zoneLetter,zoneNumber:utm.zoneNumber});result={top:topRight.lat,right:topRight.lon,bottom:lat,left:lon}}else{result={lat:lat,lon:lon}}return result}function getLetterDesignator(lat){var LetterDesignator="Z";if(84>=lat&&lat>=72){LetterDesignator="X"}else if(72>lat&&lat>=64){LetterDesignator="W"}else if(64>lat&&lat>=56){LetterDesignator="V"}else if(56>lat&&lat>=48){LetterDesignator="U"}else if(48>lat&&lat>=40){LetterDesignator="T"}else if(40>lat&&lat>=32){LetterDesignator="S"}else if(32>lat&&lat>=24){LetterDesignator="R"}else if(24>lat&&lat>=16){LetterDesignator="Q"}else if(16>lat&&lat>=8){LetterDesignator="P"}else if(8>lat&&lat>=0){LetterDesignator="N"}else if(0>lat&&lat>=-8){LetterDesignator="M"}else if(-8>lat&&lat>=-16){LetterDesignator="L"}else if(-16>lat&&lat>=-24){LetterDesignator="K"}else if(-24>lat&&lat>=-32){LetterDesignator="J"}else if(-32>lat&&lat>=-40){LetterDesignator="H"}else if(-40>lat&&lat>=-48){LetterDesignator="G"}else if(-48>lat&&lat>=-56){LetterDesignator="F"}else if(-56>lat&&lat>=-64){LetterDesignator="E"}else if(-64>lat&&lat>=-72){LetterDesignator="D"}else if(-72>-5,accuracy)+snorthing.substr(snorthing.length-5,accuracy)}function get100kID(easting,northing,zoneNumber){var setParm=get100kSetForZone(zoneNumber);var setColumn=Math.floor(easting/1e5);var setRow=Math.floor(northing/1e5)%20;return getLetter100kID(setColumn,setRow,setParm)}function get100kSetForZone(i){var setParm=i%NUM_100K_SETS;if(setParm===0){setParm=NUM_100K_SETS}return setParm}function getLetter100kID(column,row,parm){var index=parm-1;var colOrigin=SET_ORIGIN_COLUMN_LETTERS.charCodeAt(index);var rowOrigin=SET_ORIGIN_ROW_LETTERS.charCodeAt(index);var colInt=colOrigin+column-1;var rowInt=rowOrigin+row;var rollover=false;if(colInt>Z){colInt=colInt-Z+A-1;rollover=true}if(colInt===I||colOrigin<I&&colInt>I||(colInt>I||colOrigin<I)&&rollover){colInt++}if(colInt===O||colOrigin<O&&colInt>O||(colInt>O||colOrigin<O)&&rollover){colInt++;if(colInt===I){colInt++}}if(colInt>Z){colInt=colInt-Z+A-1}if(rowInt>V){rowInt=rowInt-V+A-1;rollover=true}else{rollover=false}if(rowInt===I||rowOrigin<I&&rowInt>I||(rowInt>I||rowOrigin<I)&&rollover){rowInt++}if(rowInt===O||rowOrigin<O&&rowInt>O||(rowInt>O||rowOrigin<O)&&rollover){rowInt++;if(rowInt===I){rowInt++}}if(rowInt>V){rowInt=rowInt-V+A-1}var twoLetter=String.fromCharCode(colInt)+String.fromCharCode(rowInt);return twoLetter}function decode(mgrsString){if(mgrsString&&mgrsString.length===0){throw"MGRSPoint coverting from nothing"}var length=mgrsString.length;var hunK=null;var sb="";var testChar;var i=0;while(!/[A-Z]/.test(testChar=mgrsString.charAt(i))){if(i>=2){throw"MGRSPoint bad conversion from: "+mgrsString}sb+=testChar;i++}var zoneNumber=parseInt(sb,10);if(i===0||i+3>length){throw"MGRSPoint bad conversion from: "+mgrsString}var zoneLetter=mgrsString.charAt(i++);if(zoneLetter<="A"||zoneLetter==="B"||zoneLetter==="Y"||zoneLetter>="Z"||zoneLetter==="I"||zoneLetter==="O"){throw"MGRSPoint zone letter "+zoneLetter+" not handled: "+mgrsString}hunK=mgrsString.substring(i,i+=2);var set=get100kSetForZone(zoneNumber);var east100k=getEastingFromChar(hunK.charAt(0),set);var north100k=getNorthingFromChar(hunK.charAt(1),set);while(north100k<getMinNorthing(zoneLetter)){north100k+=2e6}var remainder=length-i;if(remainder%2!==0){throw"MGRSPoint has to have an even number \nof digits after the zone letter and two 100km letters - front \nhalf for easting meters, second half for \nnorthing meters"+mgrsString}var sep=remainder/2;var sepEasting=0;var sepNorthing=0;var accuracyBonus,sepEastingString,sepNorthingString,easting,northing;if(sep>0){accuracyBonus=1e5/Math.pow(10,sep);sepEastingString=mgrsString.substring(i,i+sep);sepEasting=parseFloat(sepEastingString)*accuracyBonus;sepNorthingString=mgrsString.substring(i+sep);sepNorthing=parseFloat(sepNorthingString)*accuracyBonus}easting=sepEasting+east100k;northing=sepNorthing+north100k;return{easting:easting,northing:northing,zoneLetter:zoneLetter,zoneNumber:zoneNumber,accuracy:accuracyBonus}}function getEastingFromChar(e,set){var curCol=SET_ORIGIN_COLUMN_LETTERS.charCodeAt(set-1);var eastingValue=1e5;var rewindMarker=false;while(curCol!==e.charCodeAt(0)){curCol++;if(curCol===I){curCol++}if(curCol===O){curCol++}if(curCol>Z){if(rewindMarker){throw"Bad character: "+e}curCol=A;rewindMarker=true}eastingValue+=1e5}return eastingValue}function getNorthingFromChar(n,set){if(n>"V"){throw"MGRSPoint given invalid Northing "+n}var curRow=SET_ORIGIN_ROW_LETTERS.charCodeAt(set-1);var northingValue=0;var rewindMarker=false;while(curRow!==n.charCodeAt(0)){curRow++;if(curRow===I){curRow++}if(curRow===O){curRow++}if(curRow>V){if(rewindMarker){throw"Bad character: "+n}curRow=A;rewindMarker=true}northingValue+=1e5}return northingValue}function getMinNorthing(zoneLetter){var northing;switch(zoneLetter){case"C":northing=11e5;break;case"D":northing=2e6;break;case"E":northing=28e5;break;case"F":northing=37e5;break;case"G":northing=46e5;break;case"H":northing=55e5;break;case"J":northing=64e5;break;case"K":northing=73e5;break;case"L":northing=82e5;break;case"M":northing=91e5;break;case"N":northing=0;break;case"P":northing=8e5;break;case"Q":northing=17e5;break;case"R":northing=26e5;break;case"S":northing=35e5;break;case"T":northing=44e5;break;case"U":northing=53e5;break;case"V":northing=62e5;break;case"W":northing=7e6;break;case"X":northing=79e5;break;default:northing=-1}if(northing>=0){return northing}else{throw"Invalid zone letter: "+zoneLetter}}function Point(x,y,z){if(!(this instanceof Point)){return new Point(x,y,z)}if(Array.isArray(x)){this.x=x[0];this.y=x[1];this.z=x[2]||0}else if(typeof x==="object"){this.x=x.x;this.y=x.y;this.z=x.z||0}else if(typeof x==="string"&&typeof y==="undefined"){var coords=x.split(",");this.x=parseFloat(coords[0],10);this.y=parseFloat(coords[1],10);this.z=parseFloat(coords[2],10)||0}else{this.x=x;this.y=y;this.z=z||0}console.warn("proj4.Point will GRS=function(mgrsStr){rction(accuracy){return forward$1([this.x,this.y],accuracy)};var version="2.5.1-alpha";function init$2(){this.a=6377397.155;this.es=.006674372230614;this.e=Math.sqrt(this.es);if(!this.lat0){this.lat0=.863937979737193}if(!this.long0){this.long0=.7417649320975901-.308341501185665}if(!this.k0){this.k0=.9999}this.s45=.785398163397448;this.s90=2*this.s45;this.fi0=this.lat0;this.e2=this.es;this.e=Math.sqrt(this.e2);this.alfa=Math.sqrt(1+this.e2*Math.pow(Math.cos(this.fi0),4)/(1-this.e2));this.uq=1.04216856380474;this.u0=Math.asin(Math.sin(this.fi0)/this.alfa);this.g=Math.pow((1+this.e*Math.sin(this.fi0))/(1-this.e*Math.sin(this.fi0)),this.alfa*this.e/2);this.k=Math.tan(this.u0/2+this.s45)/Math.pow(Math.tan(this.fi0/2+this.s45),this.alfa)*this.g;this.k1=this.k0;this.n0=this.a*Math.sqrt(1-this.e2)/(1-this.e2*Math.pow(Math.sin(this.fi0),2));this.s0=1.37008346281555;this.n=Math.sin(this.s0);this.ro0=this.k1*this.n0/Math.tan(this.s0);this.ad=this.s90-this.uq}function forward$2(p){var gfi,u,deltav,s,d,eps,ro;var lon=p.x;var lat=p.y;var delta_lon=adjust_lon(lon-this.long0);gfi=Math.pow((1+this.e*Math.sin(lat))/(1-this.e*Math.sin(lat)),this.alfa*this.e/2);u=2*(Math.atan(this.k*Math.pow(Math.tan(lat/2+this.s45),this.alfa)/gfi)-this.s45);deltav=-delta_lon*this.alfa;s=Math.asin(Math.cos(this.ad)*Math.sin(u)+Math.sin(this.ad)*Math.cos(u)*Math.cos(deltav));d=Math.asin(Math.cos(u)*Math.sin(deltav)/Math.cos(s));eps=this.n*d;ro=this.ro0*Math.pow(Math.tan(this.s0/2+this.s45),this.n)/Math.pow(Math.tan(s/2+this.s45),this.n);p.y=ro*Math.cos(eps)/1;p.x=ro*Math.sin(eps)/1;if(!this.czech){p.y*=-1;p.x*=-1}return p}function inverse$2(p){var u,deltav,s,d,eps,ro,fi1;var ok;var tmp=p.x;p.x=p.y;p.y=tmp;if(!this.czech){p.y*=-1;p.x*=-1}ro=Math.sqrt(p.x*p.x+p.y*p.y);eps=Math.atan2(p.y,p.x);d=eps/Math.sin(this.s0);s=2*(Math.atan(Math.pow(this.ro0/ro,1/this.n)*Math.tan(this.s0/2+this.s45))-this.s45);u=Math.asin(Math.cos(this.ad)*Math.sin(s)-Math.sin(this.ad)*Math.cos(s)*Math.cos(d));deltav=Math.asin(Math.cos(s)*Math.sin(d)/Math.cos(u));p.x=this.long0-deltav/this.alfa;fi1=u;ok=0;var iter=0;do{p.y=2*(Math.atan(Math.pow(this.k,-1/this.alfa)*Math.pow(Math.tan(u/2+this.s45),1/this.alfa)*Math.pow((1+this.e*Math.sin(fi1))/(1-this.e*Math.sin(fi1)),this.e/2))-this.s45);if(Math.abs(fi1-p.y)<1e-10){ok=1}fi1=p.y;iter+=1}while(ok===0&&iter<15);if(iter>=15){return null}return p}var names$3=["Krovak","krovak"];var krovak={init:init$2,forward:forward$2,inverse:inverse$2,names:names$3};var adjust_zone=function(zone,lon){if(zone===undefined){zone=Math.floor((adjust_lon(lon)+Math.PI)*30/Math.PI)+1;if(zone<0){return 0}else if(zone>60){return 60}}return zone};var sinh=function(x){var r=Math.exp(x);r=(r-1/r)/2;return r};var hypot=function(x,y){x=Math.abs(x);y=Math.abs(y);var a=Math.max(x,y);var b=Math.min(x,y)/(a?a:1);return a*Math.sqrt(1+Math.pow(b,2))};var log1py=function(x){var y=1+x;var z=y-1;return z===0?x:x*Math.log(y)/z};var asinhy=function(x){var y=Math.abs(x);y=log1py(y*(1+y/(hypot(1,y)+1)));return x<0?-y:y};var gatg=function(pp,B){var cos_2B=2*Math.cos(2*B);var i=pp.length-1;var h1=pp[i];var h2=0;var h;while(--i>=0){h=-h2+cos_2B*h1+pp[i];h2=h1;h1=h}return B+h*Math.sin(2*B)};var clens=function(pp,arg_r){var r=2*Math.cos(arg_r);var i=pp.length-1;var hr1=pp[i];var hr2=0;var hr;while(--i>=0){hr=-hr2+r*hr1+pp[i];hr2=hr1;hr1=hr}return Math.sin(arg_r)*hr};var cosh=function(x){var r=Math.exp(x);r=(r+1/r)/2;return r};var clens_cmplx=function(pp,arg_r,arg_i){var sin_arg_r=Math.sin(arg_r);var cos_arg_r=Math.cos(arg_r);var sinh_arg_i=sinh(arg_i);var cosh_arg_i=cosh(arg_i);var r=2*cos_arg_r*cosh_arg_i;var i=-2*sin_arg_r*sinh_arg_i;var j=pp.length-1;var hr=pp[j];var hi1=0;var hr1=0;var hi=0;var hr2;var hi2;while(--j>=0){hr2=hr1;hi2=hi1;hr1=hr;hi1=hi;hr=-hr2+r*hr1-i*hi1+pp[j];hi=-hi2+i*hr1+r*hi1}r=sin_arg_r*cosh_arg_i;i=cos_arg_r*sinh_arg_i;return[r*hr-i*hi,r*hi+i*hr]};function init$4(){if(this.es===undefined||this.es<=0){throw new Error("incorrect elliptical usage")}this.x0=this.x0!==undefined?this.x0:0;this.y0=this.y0!==undefined?this.y0:0;this.long0=this.long0!==undefined?this.long0:0;this.lat0=this.lat0!==undefined?this.lat0:0;this.cgb=[];this.cbg=[];this.utg=[];this.gtu=[];var f=this.es/(1+Math.sqrt(1-this.es));var n=f/(2-f);var np=n;this.cgb[0]=n*(2+n*(-2/3+n*(-2+n*(116/45+n*(26/45+n*(-2854/675))))));this.cbg[0]=n*(-2+n*(2/3+n*(4/3+n*(-82/45+n*(32/45+n*(4642/4725))))));np=np*n;this.cgb[1]=np*(7/3+n*(-8/5+n*(-227/45+n*(2704/315+n*(2323/945)))));this.cbg[1]=np*(5/3+n*(-16/15+n*(-13/9+n*(904/315+n*(-1522/945)))));np=np*n;this.cgb[2]=np*(56/15+n*(-136/35+n*(-1262/105+n*(73814/2835))));this.cbg[2]=np*(-26/15+n*(34/21+n*(8/5+n*(-12686/2835))));np=np*n;this.cgb[3]=np*(4279/630+n*(-332/35+n*(-399572/14175)));this.cbg[3]=np*(1237/630+n*(-12/5+n*(-24832/14175)));np=np*n;this.cgb[4]=np*(4174/315+n*(-144838/6237));this.cbg[4]=np*(-734/315+n*(109598/31185));np=np*n;this.cgb[5]=np*(601676/22275);this.cbg[5]=np*(444337/155925);np=Math.pow(n,2);this.Qn=this.k0/(1+n)*(1+np*(1/4+np*(1/64+np/256)));this.utg[0]=n*(-.5+n*(2/3+n*(-37/96+n*(1/360+n*(81/512+n*(-96199/604800))))));this.gtu[0]=n*(.5+n*(-2/3+n*(5/16+n*(41/180+n*(-127/288+n*(7891/37800))))));this.utg[1]=np*(-1/48+n*(-1/15+n*(437/1440+n*(-46/105+n*(1118711/3870720)))));this.gtu[1]=np*(13/48+n*(-3/5+n*(557/1440+n*(281/630+n*(-1983433/1935360)))));np=np*n;this.utg[2]=np*(-17/480+n*(37/840+n*(209/4480+n*(-5569/90720))));this.gtu[2]=np*(61/240+n*(-103/140+n*(15061/26880+n*(167603/181440))));np=np*n;this.utg[3]=np*(-4397/161280+n*(11/504+n*(830251/7257600)));this.gtu[3]=np*(49561/161280+n*(-179/168+n*(6601661/7257600)));np=np*n;this.utg[4]=np*(-4583/161280+n*(108847/3991680));this.gtu[4]=np*(34729/80640+n*(-3418889/1995840));np=np*n;this.utg[5]=np*(-20648693/638668800);this.gtu[5]=np*(212378941/319334400);var Z=gatg(this.cbg,this.lat0);this.Zb=-this.Qn*(Z+clens(this.gtu,2*Z))}function forward$3(p){var Ce=adjust_lon(p.x-this.long0);var Cn=p.y;Cn=gatg(this.cbg,Cn);var sin_Cn=Math.sin(Cn);var cos_Cn=Math.cos(Cn);var sin_Ce=Math.sin(Ce);var cos_Ce=Math.cos(Ce);Cn=Math.atan2(sin_Cn,cos_Ce*cos_Cn);Ce=Math.atan2(sin_Ce*cos_Cn,hypot(sin_Cn,cos_Cn*cos_Ce));Ce=asinhy(Math.tan(Ce));var tmp=clens_cmplx(this.gtu,2*Cn,2*Ce);Cn=Cn+tmp[0];Ce=Ce+tmp[1];var x;var y;if(Math.abs(Ce)<=2.623395162778){x=this.a*(this.Qn*Ce)+this.x0;y=this.a*(this.Qn*Cn+this.Zb)+this.y0}else{x=Infinity;y=Infinity}p.x=x;p.y=y;return p}function inverse$3(p){var Ce=(p.x-this.x0)*(1/this.a);var Cn=(p.y-this.y0)*(1/this.a);Cn=(Cn-this.Zb)/this.Qn;Ce=Ce/this.Qn;var lon;var lat;if(Math.abs(Ce)<=2.623395162778){var tmp=clens_cmplx(this.utg,2*Cn,2*Ce);Cn=Cn+tmp[0];Ce=Ce+tmp[1];Ce=Math.atan(sinh(Ce));var sin_Cn=Math.sin(Cn);var cos_Cn=Math.cos(Cn);var sin_Ce=Math.sin(Ce);var cos_Ce=Math.cos(Ce);Cn=Math.atan2(sin_Cn*cos_Ce,hypot(sin_Ce,cos_Ce*cos_Cn));Ce=Math.atan2(sin_Ce,cos_Ce*cos_Cn);lon=adjust_lon(Ce+this.long0);lat=gatg(this.cgb,Cn)}else{lon=Infinity;lat=Infinity}p.x=lon;p.y=lat;return p}var names$5=["Extended_Transverse_Mercator","Extended Transverse Mercator","etmerc"];var etmerc={init:init$4,forward:forward$3,inverse:inverse$3,names:names$5};var dependsOn="etmerc";function init$3(){var zone=adjust_zone(this.zone,this.long0);if(zone===undefined){throw new Error("unknown utm zone")}this.lat0=0;this.long0=(6*Math.abs(zone)-183)*D2R;this.x0=5e5;this.y0=this.utmSouth?1e7:0;this.k0=.9996;etmerc.init.apply(this);this.forward=etmerc.forward;this.inverse=etmerc.inverse}var names$4=["Universal Transverse Mercator System","utm"];var utm={init:init$3,names:names$4,dependsOn:dependsOn};var includedProjections=function(proj4){proj4.Proj.projections.add(merc);proj4.Proj.projections.add(longlat);proj4.Proj.projections.add(krovak);proj4.Proj.projections.add(utm)};proj4$1.defaultDatum="WGS84";proj4$1.Proj=Projection;proj4$1.WGS84=new proj4$1.Proj("WGS84");proj4$1.Point=Point;proj4$1.toPoint=toPoint;proj4$1.defs=defs;proj4$1.transform=transform;proj4$1.mgrs=mgrs;proj4$1.version=version;includedProjections(proj4$1);return proj4$1});(function(){var LIMIT=Math.PI+1e-12;var MGRSGRID="ABCDEFGHJKLMNPQRSTUVWXYZ";var PROJECTIONS_NAMES={MERCATOR:"+proj=merc",WGS84:"+proj=longlat",JTSK:"+proj=krovak",UTM:"+proj=utm",OLC:"+proj=olc",PP:"+proj=pp",MGRS:"+proj=mgrs"};var PROJECTIONS={};PROJECTIONS.MERCATOR=function(){return PROJECTIONS_NAMES.MERCATOR+" +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs"};PROJECTIONS.WGS84=function(){return PROJECT+no_defs +towgs84=542.5,89.2,456.9,5.517,2.275,5.516,6.96"};PROJECTIONS.UTM=function(){var zone=arguments.length>0&&arguments[0]!==undefined?arguments[0]:33;var isSouth=arguments[1];return PROJECTIONS_NAMES.UTM+" +datum=WGS84 +units=m +no_defs +zone="+zone+(isSouth?" +south":"")};PROJECTIONS.OLC=function(){var codeLength=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;return""+PROJECTIONS_NAMES.OLC+()};PROJECTIONS.PP=function(){return""+PROJECTIONS_NAMES.PP};PROJECTIONS.MGRS=function(){var precision=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;return""+PROJECTIONS_NAMES.MGRS+(precision>0?" +precision="+precision:"")};var MGRS2int=function MGRS2int(c){c=c.charCodeAt(0);if(c>="A".charCodeAt(0)&&c<="H".charCodeAt(0))return c-"A".charCodeAt(0);if(c>="J".charCodeAt(0)&&c<="N".charCodeAt(0))return c-"A".charCodeAt(0)-1;if(c>="P".charCodeAt(0)&&c<="Z".charCodeAt(0))return c-"A".charCodeAt(0)-2;if(c>="a".charCodeAt(0)&&c<="h".charCodeAt(0))return c-"a".charCodeAt(0);if(c>="j".charCodeAt(0)&&c<="n".charCodeAt(0))return c-"a".charCodeAt(0)-1;if(c>="p".charCodeAt(0)&&c<="z".charCodeAt(0))return c-"a".charCodeAt(0)-2;return-1};var adjustLon=function adjustLon(lon){if(lon<-LIMIT||lon>LIMIT){lon-=2*Math.PI*Math.floor((lon+Math.PI)/(2*Math.PI))}return lon};var zoneForLongitude=function zoneForLongitude(lon){var zone=Math.floor((adjustLon(lon/180*Math.PI)+Math.PI)*30/Math.PI)+1;if(zone<1){zone=1}else if(zone>60){zone=60}return zone};var WGS84toMGRS=function WGS84toMGRS(coords,precision){var zone=zoneForLongitude(coords[0]);var band=Math.floor((coords[1]+80)/8);if(band<0||band>=20)return"";var ret=""+zone+MGRSGRID[band+2];if(precision<=-1)return ret;var xy=SMap.proj4.transform(PROJECTIONS.WGS84,PROJECTIONS.UTM(zone,band<10),coords);var gridx=(Math.floor(xy[0]/1e5)>>>0)-1;var gridy=Math.floor(xy[1]/1e5)>>>0;--zone;ret+=MGRSGRID[zone%3*8+gridx];ret+=MGRSGRID[((zone&1)*5+gridy)%20];if(precision<=0){return ret}if(precision>5){precision=5}var scale=Math.pow(.1,5-precision);var px=Math.floor(xy[0]%1e5*scale);var py=Math.floor(xy[1]%1e5*scale);ret+=""+px.toString().padStart(precision,"0")+py.toString().padStart(precision,"0");return ret};var MGRStoWGS84=function MGRStoWGS84(query){var zone=parseInt(query,10);var ptr=zone.toString().length;if(zone<1||zone>60)return null;var band=MGRS2int(query[ptr++])-2;if(band<0||band>=20){return null}var gridCenter=[(zone-1)*6+(3-180),band*8+(4-80)];while(query[ptr]==" "){++ptr}if(!query[ptr]){return gridCenter}var gridx=MGRS2int(query[ptr++]);var gridy=MGRS2int(query[ptr++]);if(gridx==-1||gridy==-1){return null}var utm33proj=PROJECTIONS.UTM(zone,band<10);--zone;gridx=(gridx-zone%3*8+24)%24;gridy=gridy-(zone&1)*5+20;var utmy=SMap.proj4.transform(PROJECTIONS.WGS84,utm33proj,gridCenter)[1];gridy+=(Math.round((utmy/1e5-gridy)/20)>>>0)*20;var rest=query.substr(ptr);var matches=rest.match(/\s*(\d*)\s*(\d*)/);var part1="";var part2="";var precision=0;if(matches.length>=3&&matches[1]&&matches[2]){part1=matches[1];part2=matches[2];precision=part1.length;if(part1.length!=part2.length||Math.max(part1.length,part2.length)>5)return null}else if(matches.length>=2&&matches[1]){var middle=matches[1].length/2;part1=rest.substr(0,middle);part2=rest.substr(middle);precision=middle;if(matches[1].length>10)return null}var scale=1e5;var xy=[(gridx+1)*scale,gridy*scale];var posx=0,posy=0;if(precision){posx=parseInt(part1);posy=parseInt(part2);scale=Math.pow(10,5-precision)}xy[0]+=(posx+.5)*scale;xy[1]+=(posy+.5)*scale;return SMap.proj4.transform(utm33proj,PROJECTIONS.WGS84,xy)};SMap.proj4={};SMap.proj4.transform=function(sourceProj,destProj,coords){if(typeof sourceProj==="function"){sourceProj=sourceProj()}if(typeof destProj==="function"){destProj=destProj()}var inputCoords=Array.isArray(coords)?[coords[0],coords[1]]:coords;if(sourceProj==destProj)return inputCoords;if(sourceProj.indexOf(PROJECTIONS_NAMES.JTSK)!=-1){inputCoords=[-inputCoords[1],-inputCoords[0]]}else if(sourceProj.indexOf(PROJECTIONS_NAMES.OLC)!=-1){var olc=OpenLocationCode.decode(inputCoords);inputCoords=[olc.longitudeCenter,olc.latitudeCenter];sourceProj=PROJECTIONS.WGS84()}else if(sourceProj.indexOf(PROJECTIONS_NAMES.PP)!=-1){inputCoords=[inputCoords[0]/32+-37e5,inputCoords[1]/32+13e5];sourceProj=PROJECTIONS.UTM(33)}else if(sourceProj.indexOf(PROJECTIONS_NAMES.MGRS)!=-1){inputCoords=MGRStoWGS84(inputCoords);sourceProj=PROJECTIONS.WGS84()}if(destProj.indexOf(PROJECTIONS_NAMES.JTSK)!=-1){var jtsk=SMap.LibProj4(sourceProj,destProj,inputCoords);return[-jtsk[1],-jtsk[0]]}else if(destProj.indexOf(PROJECTIONS_NAMES.OLC)!=-1){var wgs84=SMap.LibProj4(sourceProj,PROJECTIONS.WGS84(),inputCoords);var codeLength=destProj.match(/codelength=([0-9]+)/);if(codeLength&&codeLength.length>=1){codeLength=parseInt(codeLength[1])}else{codeLength=undefined}return OpenLocationCode.encode(wgs84[1],wgs84[0],codeLength)}else if(destProj.indexOf(PROJECTIONS_NAMES.PP)!=-1){var utm33=SMap.LibProj4(sourceProj,PROJECTIONS.UTM(33),inputCoords);return[Math.round(utm33[0]- -37e5)*32,Math.round(utm33[1]-13e5)*32]}else if(destProj.indexOf(PROJECTIONS_NAMES.MGRS)!=-1){var _wgs=SMap.LibProj4(sourceProj,PROJECTIONS.WGS84(),inputCoords);var precision=destProj.match(/precision=([0-9]+)/);if(precision&&precision.length>=1){precision=parseInt(precision[1])}else{precision=0}return WGS84toMGRS(_wgs,precision)}else{return SMap.LibProj4(sourceProj,destProj,inputCoords)}};SMap.proj4.PROJECTIONS=PROJECTIONS})();SMap.OphotoDate=JAK.ClassMaker.makeClass({NAME:"SMap.OphotoDate",VERSION:"1.0"});SMap.OphotoDate.prototype.$constructor=function(map){this._const={OPHOTO:{},URL:SMap.CONFIG.base+"/date",FOR_ZOOM:9};this._const.OPHOTO["bing"]="";this._const.OPHOTO[this._getLayerName(SMap.CONFIG[SMap.DEF_OPHOTO].url)]="";this._const.OPHOTO[this._getLayerName(SMap.CONFIG[SMap.DEF_OPHOTO0203].url)]="2003";this._const.OPHOTO[this._getLayerName(SMap.CONFIG[SMap.DEF_OPHOTO0406].url)]="2006";this._const.OPHOTO[this._getLayerName(SMap.CONFIG[SMap.DEF_OPHOTO1012].url)]="2012";this._const.OPHOTO[this._getLayerName(SMap.CONFIG[SMap.DEF_OPHOTO1415].url)]="2015";this._const.OPHOTO[this._getLayerName(SMap.CONFIG[SMap.DEF_OPHOTO1618].url)]="2018";this._map=map;this._isOphoto=false;this._ophotoYear="";this._getTimeout={id:null,timeout:500};this._data={};this._copyrightControl=this._map.getCopyrightControl();this._map.getSignals().addListener(this,"layer-enable","_layerEnable");this._map.getSignals().addListener(this,"layer-disable","_layerDisable");this._map.getSignals().addListener(this,"map-redraw","_mapRedraw")};SMap.OphotoDate.prototype._getLayerName=function(url){var test=url.match(/\/\/[^/]+\/([^/]+)\//);var maptilesTest=url.indexOf("/maptiles/")>-1&&url.match(/\/maptiles\/([^/]+)\/([^/]+)\//);if(maptilesTest&&maptilesTest.length>=1){return maptilesTest[1]}else if(test&&test.length>=1){return test[1]}else{return""}};SMap.OphotoDate.prototype._layerEnable=function(layerEvent){var layer=layerEvent.target;if(layer instanceof SMap.Layer.Tile){var name=this._getLayerName(layer.getURL());if(name in this._const.OPHOTO){this._isOphoto=true;this._ophotoYear=this._const.OPHOTO[name];this._getDate()}}};SMap.OphotoDate.prototype._layerDisable=function(layerEvent){var layer=layerEvent.target;if(layer instanceof SMap.Layer.Tile){var name=this._getLayerName(layer.getURL());if(name in this._const.OPHOTO){this._isOphoto=false;this._ophotoYear=._mapRedraw=function(){if(this._isOphoto){this._getDate()}};SMap.OphotoDate.prototype._getDate=function(){var zoom=this._map.getZoom();if(zoom<this._const.FOR_ZOOM){this._hideDate();return}var center=this._map.getCenter().toWGS84();var pt=this._polygonTest(center);if(pt){this._setDate(pt);return}if(this._getTimeout.id){clearTimeout(this._getTimeout.id);this._getTimeout.id=null}this._getTimeout.id=setTimeout(function(){this._getTimeout.id=null;var args=[center[0],center[1]];if(this._ophotoYear){args.push(this._ophotoYear)}var request=new JAK.RPC(JAK.RPC.AUTO,{endpoint:this._const.URL});request.setCallback(function(data,status){if(status==200&&data.status==200){this._dateResponseOk(data)}else{this._hideDate()}}.bind(this));request.setHeaders({"X-SZN-Sdk":SMap.nigena()});if(SMap.apiKey){var obj={};obj[SMap.CONFIG.apiKeyHeader]=SMap.apiKey;request.setHeaders(obj)}request.send("getOrtophotoDate",args,{0:"float",1:"float"})}.bind(this),this._getTimeout.timeout)};SMap.OphotoDate.prototype._dateResponseOk=function(data){var date=data.date;var multiPolygon=[];var geom=data.geom.data||[];geom.forEach(function(ids.stringToCoords(item).map(function(i){return i.toWGS84()}))});this._data[date]={year:this._ophotoYear,multiPolygon:multiPolygon};this._setDate(date)};SMap.OphotoDate.prototype._pointInMultiPolygon=function(point,multiPolygon){for(var i=0;i<multiPolygon.length;i++){if(SMap.Util.pointInPolygon(point,multiPolygon[i])){return true}}return false};SMap.OphotoDate.prototype._polygonTest=function(point){var test=null;var allDates=Object.keys(this._data);allDates.every(function(date){var dateItem=this._data[date];if(dateItem.year!=this._ophotoYear)return true;if(this._pointInMultiPolygon(point,dateItem.multiPolygon)){test=date;return false}else{return tpyrightControl)return;this._copyrightControl.setDate(date)};SMap.OphotoDate.prototype._hideDate=function(){if(!this._copyrightControl)return;this._copyrightControl.setDate("")};SMap.fecoji=function(paramName){var CONFIG={key:atob("c2Rr"),api:atob("bWFweWFwaQ=="),version:atob("QXJtc3Ryb25n")};return CONFIG[paramName]||""};SMap.nigena=function(){var date=new Date;date.setHours(0);date.setMinutes(0);date.setSeconds(1);date.setMilliseconds(0);var data=[SMap.fecoji("api"),SMap.fecoji("version"),date/1e3>>>0].join(",");var key=SMap.fecoji("key");var xor_hodnota=[];for(var i=0,max=data.length,keyMax=key.length,ptr=0;i<max;i++){var znakDat=data[i].charCodeAt(0);var znakKlice=key[ptr].charCodeAt(0);xor_hodnota.push(String.fromCharCode(znakDat^znakKlice));ptr++;if(ptr==keyMax){ptr=0}}return btoa(xor_hodnota.join(""))};SMap.zitafa=function(url){if(typeof window.URL==="function"){var urlTest=url.match(/^\/\/?/);if(urlTest){if(urlTest[0]=="//"){url=location.protocol+url}else{url=location.origin+url}}var tileUrl=new URL(url);tileUrl.searchParams.append(SMap.fecoji("key"),SMap.nigena());SMap.apiKey&&tileUrl.searchParams.append(SMap.CONFIG.apiKeyParam,SMap.apiKey);return tileUrl.toString()}else{return url+(url.indexOf("?")==-1?"?":"&")+SMap.fecoji("key")+"="+encodeURIComponent(SMap.nigena())+(SMap.apiKey?"&"+SMap.CONFIG.apiKeyParam+"="+encodeURIComponent(SMap.apiKey):"")}};Number.prototype.mod=function(modulus){var remainder=this%modulus;return remainder<0?re;SMap.Util={};SMap.Util.getSDKUrl=function(url){return url};SMap.Util.stringToObject=function(str){var arr=str.split(".");var obj=window;while(arr.length){obj=obj[arr.shift()];if(!obj){throw new Error("Undefined object '"+str+"'")}}return obj};SMap.Util.mergeObject=function(from,to){for(var p in from){if(p in to){if(from[p].constructor==Object&&to[p].constructor==Object){arguments.callee(from[p],to[p])}else{to[p]=from[p]}}else{to[p]=from[p]}}};SMap.Util.linkToNewWindow=function(e){if(!e)return false;var leftCtrlClick=(e.ctrlKey||e.metaKey)&&(e.which==1||e.button==1);var middleClick=e.which==2||e.button==4;if(middleClick||leftCtrlClick){if(leftCtrlClick){e.stopPropagation()}return true}else{return false}};SMap.Util.standardDistanceFormat=function(distance,longDecimal){var d=parseFloat(distance);var output={distance:"",distanceNumber:0,unit:"",string:""};if(typeof d!="number"||isNaN(d)){return output}if(d<1e3){output={distance:Math.round(d).toString(),distanceNumber:Math.round(d),unit:"m",string:Math.round(d).toString()+String.fromCharCode(160)+"m"}}else{var km=d/1e3;km=km.toFixed(!!longDecimal?3:1);output={distance:SMap.Util.formatLocaleNumber(km),distanceNumber:parseFloat(km),unit:"km",string:SMap.Util.formatLocaleNumber(km)+String.fromCharCode(160)+"km"}}return output};SMap.Util.formatLocaleNumber=function(num){var number=new Number(num);var out=number.toString();out=out.replace(".",SMap._("separators.decimal")).replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1"+SMap._("separators.thousand"));return out};SMap.Util.pointInPolygon=function(point,polygon){var crossings=0;for(var i=0;i<polygon.length;i++){var p1=polygon[i?i-1:polygon.length-1];var p2=polygon[i];if(p1[1]<=point[1]&&p2[1]>point[1]||p1[1]>point[1]&&p2[1]<=point[1]){var vt=(point[1]-p1[1])/(p2[1]-p1[1]);if(point[0]<p1[0]+vt*(p2[0]-p1[0])){crossings++}}}return crossings&1};SMap.Util.viewportToBounds=function(viewport){return viewport.lby.toFixed(5)+","+viewport.lbx.toFixed(5)+"|"+viewport.rty.toFixed(5)+","+viewport.rtx.toFixed(5)};SMap.Pixel=JAK.ClassMaker.makeClass({NAME:"SMap.Pixel",VERSION:"1.0"});SMap.Pixel.prototype.$constructor=function(x,y){this.x=parseFloat(x)||0;this.y=parseFloat(y)||0};SMap.Pixel.fromEvent=function(e,map){var c=map.getContainer();var size=map.getSize().clone().scale(.5);var rect=c.getBoundingClientRect();var pos={left:rect.left,top:rect.top};pos.left+=size.x+(c.clientLeft||0);pos.top+=size.y+(c.clientTop||0);var x=parseFloat(e.clientX-pos.left)||0;var y=parseFloat(e.clientY-pos.top)||0;return new this(x,y)};SMap.Pixel.prototype.toCoords=function(map,zoom){if(!map){return SMap.Coords.fromWGS84(0,0)}if(arguments.length<2){zoom=map.getZoom()}var proj=map.getProjection();return proj.pixelToCoords(this,map.getCenter(),zoom,map.getOrientation())};SMap.Pixel.prototype.plus=function(pixel){this.x+=parseFloat(pixel.x)||0;this.y+=parseFloat(pixel.y)||0;return this};SMap.Pixel.prototype.minus=function(pixel){this.x-=parseFloat(pixel.x)||0;this.y-=parseFloat(pixel.y)||0;return this};SMap.Pixel.prototype.clone=function(){retum=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};SMap.Pixel.prototype.scale=function(sx,sy){if(arguments.length<2){sy=sx}this.x*=parseFloat(sx)||0;this.y*=parseFloat(sy)||0;return this};SMap.Pixel.prototype.distance=function(other){var dx=this.x-other.x;var dy=this.y-other.y;return Math.sqrt(dx*dx+dy*dy)};SMap.Pixel.prototype.toString=function(){return"["+this.x+","+this.y+"]"};SMap.Pixel.prototype.toTile=function(map,tileSize){var proj=map.getProjection();return proj.pixelToTile(this,map.getCenter(),map.getZoom(),map.getOrientation(),tileSize)};SMap.Coords=JAK.ClassMaker.makeClass({NAME:"SMapototype.$constructor=function(x,y){this.x=x||0;this.y=y||0};SMap.Coords._alphabet="0ABCD2EFGH4IJKLMN6OPQRST8UVW,map){return SMap.Pixel.fromEvent(event,map).toCoords(map)};SMap.Coords.fromPP=function(PPx,PPy){var coords=SMap.proj4.transform(SMap.proj4.PROJECTIONS.PP,SMap.proj4.PROJECTIONS.WGS84,[PPx,PPy]);return new this(coords[0],coords[1])};SMap.Coords.fromUTM33=function(x,y){var coords=SMap.proj4.transform(SMap.proj4.PROJECTIONS.UTM(33),SMap.proj4.PROJECTIONS.WGS84,[x,y]);return new this(coords[0],coords[1])};SMap.Coords.fromWGS84=function(lonD,latD){if(arguments.length==1){var pair=this._splitWGS84(arguments[0]);lonD=pair[0];latD=pair[1]}if(typeof lonD=="string"){lonD=this._fromWGS84str(lonD)}if(typeof latD=="string"){latD=this._fromWGS84str(latD)}return new this(lonD,latD)};SMap.Coords.fromJTSK=function(x,y){if(!(x&&y)){return new this(0,0)}var coords=SMap.proj4.transform(SMap.proj4.PROJECTIONS.JTSK,SMap.proj4.PROJECTIONS.WGS84,[x,y]);return new this(coords[0],coords[1])};SMap.Coords.fromEXIF=function(exif){var tags=exif.getTags();var lon=tags.GPSLongitude;var lat=tags.GPSLatitude;if(!lat||!lon){throw new Error("No GPS data in EXIF")}var x=0;var y=0;var divisor=1;for(var i=0;i<3;i++){x+=lon[i]/divisor;y+=lat[i]/divisor;divisor*=60}if(tags.GPSLongitudeRef&&tags.GPSLongitudeRef.toUpperCase()=="W"){x=-x}if(tags.GPSLatitudeRef&&tags.GPSLatitudeRef.toUpperCase()=="S"){y=-y}return this.fromWGS84(x,y)};SMap.Coords._splitWGS84=function(str){var parts=str.match(/[nsew]|[^nsew]+/gi);if(parts.length!=4){throw new Error("Not a valid WGS84 string.")}var two=[parts.slice(0,2).join(""),parts.slice(2).join("")];if(two[0].match(/[ns]/i)){two.reverse()}return two};SMap.Coords._fromWGS84str=function(str){var result=0;var wgs_re=/-?\d+([.,]\d*)?/g;var lo_re=/[ws] *$/gi;var parts=str.match(wgs_re);if(!parts){return result}var exp=1;for(var i=0;i<parts.length;i++){var num=parts[i].replace(/,/g,".");result+=parseFloat(num)/exp;exp*=60}if(str.match(lo_re)){result*=-1}return result};SMap.Coords.stringToCoords=function(str){var FIVE_CHARS=1+2<<4;var THREE_CHARS=1<<5;var results=[];var coords=[0,0];var coordIndex=0;var arr=str.trim().split("").reverse();while(arr.length){var num=this._parseNumber(arr,1);if((num&FIVE_CHARS)==FIVE_CHARS){num-=FIVE_CHARS;num=((num&15)<<24)+this._parseNumber(arr,4);coords[coordIndex]=num}else if((num&THREE_CHARS)==THREE_CHARS){num=((num&15)<<12)+this._parseNumber(arr,2);num-=1<<15;coords[coordIndex]+=num}else{num=((num&31)<<6)+this._parseNumber(arr,1);num-=1<<10;coords[coordIndex]+=num}if(coordIndex){var x=coords[0]*360/(1<<28)-180;var y=coords[1]*180/(1<<28)-90;results.push(this.fromWGS84(x,y))}coordIndex=(coordIndex+1)%2}return results};SMap.Coords._parseNumber=function(arr,count){var result=0;var i=count;while(i){if(!arr.length){throw new Error("No data!")}var ch=arr.pop();var index=this._alphabet.indexOf(ch);if(index==-1){continue}result<<=6;result+=index;i--}return result};SMap.Coords.coordsToString=function(arr){var ox=0;var oy=0;var result="";for(var i=0;i<arr.length;i++){var coords=arr[i].toWGS84();var x=Math.round((coords[0]+180)*(1<<28)/360);var y=Math.round((coords[1]+90)*(1<<28)/180);var dx=x-ox;var dy=y-oy;result+=this._serializeNumber(dx,x);result+=this._serializeNumber(dy,y);ox=x;oy=y}return result};SMap.Coords._serializeNumber=function(delta,orig){var code="";if(delta>=-1024&&delta<1024){code+=this._alphabet.charAt(delta+1024>>6);code+=this._alphabet.charAt(delta+1024&63)}else if(delta>=-32768&&delta<32768){var value=131072|delta+32768;code+=this._alphabet.charAt(value>>12&63);code+=this._alphabet.charAt(value>>6&63);code+=this._alphabet.charAt(value&63)}else{var value=805306368|orig&268435455;code+=this._alphabet.charAt(value>>24&63);code+=this._alphabet.charAt(value>>18&63);code+=this._alphabet.charAt(value>>12&63);code+=this._alphabet.charAt(value>>6&63);code+=this._alphabet.charAt(value&63)}return code};SMap.Coords.stringToAltitude=function(str){var results=[];var e0=0;var arr=str.trim().split("").reverse();var c1,c2,c3;var d1,d2,d3;var decNonZeroDelta=function(c,m){return c-m+(c>=m?1:0)};while(arr.length){c1=this._parseNumber(arr,1);if((c1&32)==0){var n=1+((c1&24)>>3);d1=(c1&7)-3;for(var i=0;i<n;i++){results.push(e0)}if(d1!=4){e0+=d1;results.push(e0)}}else if((c1&48)==32){d1=decNonZeroDelta(c1&15,8);e0+=d1;results.push(e0)}else if((c1&56)==48){c2=this._parseNumber(arr,1);d1=decNonZeroDelta(c1&7,4);d2=decNonZeroDelta(c2>>3,4);d3=(c2&7)-(d2<0?4:3);e0+=d1;results.push(e0);e0+=d2;results.push(e0);e0+=d3;results.push(e0)}else if((c1&60)==56){c2=this._parseNumber(arr,1);d1=(c1&3)<<6;d2=(c2&63)-128;e0+=d1+d2;results.push(e0)}else{c2=this._parseNumber(arr,1);c3=this._parseNumber(arr,1);d1=(c1&3)<<12;d2=(c2&63)<<6;d3=(c3&63)-8192;e0+=d1+d2+d3;results.push(e0)}}return results};SMap.Coords.prototype.toPixel=function(map,zoom){if(arguments.length<2){zoom=map.getZoom()}return map.getProjection().coordsToPixel(this,map.getCenteype.clone=function(){return nfunction(coords){return this.x==coords.x&&this.y==coords.y};SMap.Coords.prototype.azimuth=function(target){var D2R=Math.PI/180;var R2D=1/D2R;var dLon=(target.x-this.x)*D2R;var lat1=this.y*D2R;var lat2=target.y*D2R;var PI4=Math.PI/4;var dPhi=Math.log(Math.tan(lat2/2+PI4)/Math.tan(lat1/2+PI4));if(Math.abs(dLon)>Math.PI){dLon=dLon>0?-(2*Math.PI-dLon):2*Math.PI+dLon}var az=Math.atan2(dLon,dPhi)*R2D;return az.mod(360)};SMap.Coords.prototype.distance=function(target,altitude){var alt=6371009+(altitude||0);var dx=Math.abs(this.x-target.x);var dy=Math.abs(this.y-target.y);dx=dx*Math.PI/180;dy=dy*Math.PI/180;var y1=this.y*Math.PI/180;var y2=target.y*Math.PI/180;var a=Math.sin(dy/2)*Math.sin(dy/2)+Math.cos(y1)*Math.cos(y2)*Math.sin(dx/2)*Math.sin(dx/2);var c=2*Math.atan2(Math.sqrt(a),Math.ion(target,altitude){return thitotype.toString=function(){return"("+this.x+","+this.y+")"};SMap.Coords.prototype.toWGS84=function(format){var result=[this.x,this.y];return typeof format=="number"?this._formatWGS84(result,format):result};SMap.Coords.prototype._formatWGS84=function(input,format){var output=[];var precision=1e3;var chars=["°","'",'"'];var suffixes=[["E","W"],["N","S"]];var max=Math.min(format,2);for(var i=0;i<input.length;i++){var divisor=3600*precision;var value=Math.round(divisor*Math.abs(input[i]));var str="";for(var j=0;j<=max;j++){var part=value/divisor;if(j<max){part=Math.floor(part);value=value%divisor}else{part=part.toFixed(7-2*max)}divisor/=60;str+=part;str+=chars[j]}str+=input[i]>0?suffixes[i][0]:suffixes[i][1];output.push(str)}return output};SMap.Coords.prototype.toPP=function(){return SMap.proj4.transform(SMap.proj4.PROJECTIONS.WGS84,SMap.proj4.PROJECTIONS.PP,[this.x,this.y])};SMap.Coords.prototype.toUTM33=function(){return SMap.proj4.transform(SMap.proj4.PROJECTIONS.WGS84,SMap.proj4.PROJECTIONS.UTM(33),[this.x,this.y])};SMap.Coords.prototype.toJTSK=function(){return SMap.proj4.transform(SMap.proj4.PROJECTIONS.WGS84,SMap.proj4.PROJECTIONS.JTSK,[this.x,this.y])};SMap.Coords.prototype.isValid=function(){var wgs=this.toWGS84();return Math.abs(wgs[1])<=85};SMap.Coords.prototype.inMap=function(map,usePadding){var rb=map.getSize().clone().scale(.5);var lt=rb.clone().scale(-1);if(usePadding){lt.x+=map.getPadding("left");lt.y+=map.getPadding("top");rb.y-=map.getPadding("bottom");rb.x-=map.getPadding("right")}var px=this.toPixel(map);return px.x>=lt.x&&px.x<=rb.x&&px.y>=lt.y&&px.y<=rb.y};SMap.Coords.prototype.getAltitude=function(){var rpc=new JAK.RPC(JAK.RPC.AUTO,{endpoint:SMap.CONFIG.altitude});var hints={0:"float",1:"float"};rpc.setHeaders({"X-SZN-Sdk":SMap.nigena()});if(Loader.apiKey){var obj={};obj[SMap.CONFIG.apiKeyHeader]=Loader.apiKey;rpc.setHeaders(obj)}rpc.send("getAltitudeAt",this.toWGS84(),hints);return new JAK.Promise(function(resolve,reject){var cb=function(data,status){if(status==200&&typeof data.altitude==="number"){resolve(data.altitude)}else{reject({data:data,status:status})}};rpc.setCallback(cb);rpc.setErrorCallback(reject)})};SMap.Coords.fromOLC=function(olc){var coords=SMap.proj4.transform(SMap.proj4.PROJECTIONS.OLC,SMap.proj4.PROJECTIONS.WGS84,olc);return new this(coords[0],coords[1])};SMap.Coords.prototype.toOLC=function(codeLength){return SMap.proj4.transform(SMap.proj4.PROJECTIONS.WGS84,SMap.proj4.PROJECTIONS.OLC(codeLength),[this.x,this.y])};SMap.Coords.fromMGRS=function(mgrs){var coords=SMap.proj4.transform(SMap.proj4.PROJECTIONS.MGRS,SMap.proj4.PROJECTIONS.WGS84,mgrs);return new this(coords[0],coords[1])};SMap.Coords.prototype.toMGRS=function(precision){return SMap.proj4.transform(SMap.proj4.PROJECTIONS.WGS84,SMap.proj4.PROJECTIONS.MGRS(precision),[this.x,this.y])};SMap.Coords.fromMercator=function(x,y){var coords=SMap.proj4.transform(SMap.proj4.PROJECTIONS.MERCATOR,SMap.proj4.PROJECTIONS.WGS84,[x,y]);return new this(coords[0],coords[1])};SMap.Coords.prototype.toMercator=function(){return SMap.proj4.transform(SMap.proj4.PROJECTIONS.WGS84,SMap.proj4.PROJECTIONS.MERCATOR,[this.x,this.y])};SMap.Tile=JAK.ClassMaker.makeClass({NAME:,y){this.tileSize=tileSize;th.toString=function(){returreturn new SMap.Tile(this.zoom,this.tileSize,this.x,this.y)};SMap.Tile.prototype.toPixel=function(map){var proj=map.getProjection();return proj.tileToPixel(this,map.getCenter(),this.zoom,map.getOrientation())};SMap.Coords.prototype.fixedPoint=function(map,newZoom){return map._fixedPoint(p,newZoom){return map._newCel(map))};SMap.Coords.prototype.wrap=function(){return this};SMap.Projection=JAK.ClassMaker.makeClass({NAME:"SMap.Projection",VERSION:"1.0",IMunction(){this._owner=null;this._code="";this._matrixSet=""};SMap.Projection.prototype.getCode=function.getMatrixSet=function(){return this._matrixSet||this._code};SMap.Projection.prototype.getWorldSize=function(zoom){var size=Math.pow(2,zoom+8);return new SMap.Pixel(size,size)};SMap.Projection.prototype.project=function(coords,zoom){};SMap.Projection.prototype.unproject=function(absPixel,zoom){};SMap.Projection.prototype.pixelToCoords=function(pixel,center,zoom,orientation){var abs=this._pixelToAbsolutePixel(pixel,center,zoom,orientation);var world=this.getWorldSize(zoom);abs.x=abs.x.mod(world.x);return this.urn this._absolutePixelToPixel(abs,center,zoom,orientation)};SMap.Projection.prototype.pixelToTile=function(pixel,center,zoom,orientation,tileSize){var abs=this._pixelToAbsolutePixel(pixel,center,zoom,orientation);var world=this.getWorldSize(zoom);if(abs.y<0||abs.y>=world.y){return null}return new SMap.Tile(zoom,tileSize,Math.floor(abs.x/tileSize),Math.floor(abs.y/tileSize))};SMap.Projection.prototype.tileToPixel=function(tile,center,zoom,orientation){var ts=tile.tileSize;var x=tile.x*tile.tileSize;var y=tile.y*tile.tileSize;var coef=this._screenCoefficients;var center=this.project(center,zoom);switch(orientation){case SMap.NORTH:var px=new SMap.Pixel(x-center.x,y-center.y);if(coef.x==-1){px.x=-px.x-ts}if(coef.y==-1){px.y=-px.y-ts}break;case SMap.WEST:var px=new SMap.Pixel(y-center.y,x-center.x);if(coef.y==1){px.x=-px.x-ts}if(coef.x==-1){px.y=-px.y-ts}break;case SMap.SOUTH:var px=new SMap.Pixel(x-center.x,y-center.y);if(coef.x==1){px.x=-px.x-ts}if(coef.y==1){px.y=-px.y-ts}break;case SMap.EAST:var px=new SMap.Pixel(y-center.y,x-center.x);if(coef.y==-1){px.x=-px.x-ts}if(coef.x==1){px.y=-px.y-ts}break}return px};SMap.Projection.prototype._pixelToAbsolutePixel=function(pixel,center,zoom,orientation){var abs=this.project(center,zoom);var coef=this._screenCoefficients;switch(orientation){case SMap.NORTH:abs.x+=coef.x*pixel.x;abs.y+=coef.y*pixel.y;break;case SMap.WEST:abs.x+=coef.x*pixel.y;abs.y-=coef.y*pixel.x;break;case SMap.SOUTH:abs.x-=coef.x*pixel.x;abs.y-=coef.y*pixel.y;break;case SMap.EAST:abs.x-=coef.x*pixel.y;abs.y+=coef.y*pixel.x;break}return abs};SMap.Projection.prototype._absolutePixelToPixel=function(abs,center,zoom,orientation){var abscenter=this.project(center,zoom);var coef=this._screenCoefficients;switch(orientation){case SMap.NORTH:return new SMap.Pixel(coef.x*(abs.x-abscenter.x),coef.y*(abs.y-abscenter.y));break;case SMap.WEST:return new SMap.Pixel(coef.y*(abscenter.y-abs.y),coef.x*(abs.x-abscenter.x));break;case SMap.SOUTH:return new SMap.Pixel(coef.x*(abscenter.x-abs.x),coef.y*(abscenter.y-abs.y));break;case SMap.EAST:return new SMap.Pixel(coef.y*(abs.y-abscenter.y),coef.x*(abscenter.x-abs.x));break}};SMap.Projection.prototype._screenCoefficients={x:1,y:1};SMap.Projection.Mercator=JAK.ClassMaker.makeClass({NAME:"SMap.Projection.Mercator",VERSION:"1.0",EXTEND:SMap.Projection});SMap.Projection.Mercator.prototype.$constructor=function(){this.$super();this._code="EPSG:3857";this._matrixSet="wgs84:pseudomercator:epsg:3857"};SMap.Projection.Mercator.prototype.project=function(coords,zoom){var wgs=coords.toWGS84();var world=this.getWorldSize(zoom);var x=(wgs[0]+180)/360*world.x;var y=wgs[1]*Math.PI/180;var f=Math.min(Math.max(Math.sin(y),-.9999),.9999);y=(1-.5*Math.log((1+f)/(1-f))/Math.PI)/2*world.y;return new SMap.Pixel(x,y)};SMap.Projection.Mercator.prototype.unproject=function(pixel,zoom){var world=this.getWorldSize(zoom);var lon=pixel.x*360/world.x-180;var lat=2*Math.atan(Math.exp(Math.PI*(1-2*pixel.y/world.y)))-Math.PI/2;lat=lat*180/Math.PI;return SMap.Coords.fromWGS84(lon,lat)};SMap.Projection.UTM33=JAK.ClassMaker.makeClass({NAME:"SMap.Projection.UTM33",VERSION:"1.0",EXTEND:SMap.Projection});SMap.Projection.UTM33.prototype._screenCoefficients={x:1,y:-1};SMap.Projection.UTM33.prototype.$constructor=function(){this.$super();this._code="EPSG:32633";this._matrixSet="wgs84:utm33n:epsg:32633"};SMap.Projection.UTM33.prototype.project=function(coords,zoom){var pp=coords.toPP();var pow=Math.pow(2,20-zoom);return new SMap.Pixel(pp[0]/pow,pp[1]/pow)};SMap.Projection.UTM33.prototype.unproject=function(pixel,zoom){var pow=Math.pow(2,20-zoom);return SMap.Coords.fromPP(pixel.x*pow,pixel.y*pow)};SMap.Projection.Krovak=JAK.ClassMaker.makeClass({NAME:"SMap.Projection.Krovak",VERSION:"1.0",EXTEND:SMap.Projection});SMap.Projection.Krovak.prototype._screenCoefficiethis._code="EPSG:102067";this._matrixSet="jtsk:epsg:102067"};SMap.Projection.Krovak.prototype.project=function(coords,zoom){var jtsk=coords.toJTSK();var pow=Math.pow(2,15-zoom);return new SMap.Pixel(jtsk[1]/pow,jtsk[0]/pow)};SMap.Projection.Krovak.prototype.unproject=function(pixel,zoom){var pow=Math.pow(2,15-zoom);return SMap.Coords.fromJTSK(pixel.y*pow,pixel.x*pow)};SMap.Projection.Oblique=JAK.ClassMaker.makeClass({NAME:"SMap.Projection.Oblique",VERSION:"1.0",EXTEND:SMap.Projection});SMap.Projection.Oblique.CORS=JAK.Request.supportsCrossOrigin();SMap.Projection.Oblique.create=function(center,orientation,callback,errorCallback){var rq=new JAK.Request(JAK.Request.XML);rq.setCallback(function(xmlDoc,status){var proj=SMap.Projection.Oblique.fromXML(xmlDoc,orientation,center);if(proj){callback(proj)}else if(errorCallback){errorCallback()}});var data={loc:center.toWGS84().join(","),direct:orientation};rq.setHeaders({"X-SZN-Sdk":SMap.nigena()});if(SMap.apiKey){var obj={};obj[SMap.CONFIG.apiKeyHeader]=SMap.apiKey;rq.setHeaders(obj)}var url=(SMap.Projection.Oblique.CORS?SMap.CONFIG.base:"")+"/oblique/";rq.send(url,data);return rq};SMap.Projection.Oblique.fromXML=function(xmlDoc,orientation,coords){if(!xmlDoc){return null}var status=xmlDoc.getElementsByTagName("status")[0];if(status.getAttribute("status")!=200){return null}var st.split(",");return arr.map(function($){return parseFloat($)})};var id=xmlDoc.getElementsByTagName("name")[0].getAttribute("name");var points=["a","b","c","d"];for(var i=0;i<points.length;i++){var str=xmlDoc.getElementsByTagName(points[i])[0].getAttribute("point");points[i]=str2floats(str)}var center=str2floats(xmlDoc.getElementsByTagName("center")[0].getAttribute("point"));var best=str2floats(xmlDoc.getElementsByTagName("best")[0].getAttribute("point"));var angles=str2floats(xmlDoc.getElementsByTagName("angles")[0].getAttribute("angle"));var multiplier=parseFloat(xmlDoc.getElementsByTagName("multiplier")[0].getAttribute("multiplier"));var focalLength=.0497696;var pixelSize=68e-7;var imageSize=new SMap.Pixel(5412,7216);var originalImageSize=new SMap.Pixel(5412,7216);var imageOffset=new SMap.Pixel(0,0);var image=xmlDoc.getElementsByTagName("image");if(image.length){image=image[0];focalLength=parseFloat(image.getAttribute("focalLength"));pixelSize=parseFloat(image.getAttribute("pixelSize"));imageSize.x=parseInt(image.getAttribute("width"));imageSize.y=parseInt(image.getAttribute("height"));originalImageSize.x=parseInt(image.getAttribute("originalWidth"))||imageSize.x;originalImageSize.y=parseInt(image.getAttribute("originalHeight"))||imageSize.y;imageOffset.x=parseInt(image.getAttribute("offsetX"))||0;imageOffset.y=parseInt(image.getAttribute("offsetY"))||0}var provider=xmlDoc.getElementsByTagName("provider")[0].getAttribute("provider");var dateEl=xmlDoc.getElementsByTagName("date");var date=dateEl&&dateEl.length>0?dateEl[0].getAttribute("date"):"";var config={points:points,center:center,best:best,angles:angles,focalLength:focalLength,pixelSize:pixelSize/multiplier,imageSize:imageSize,originalImageSize:originalImageSize,imageOffset:imageOffset,provider:provider,date:date};return new this(id,config,orientation,coords)};SMap.Projection.Oblique.prototype._screenCoefficients={x:1,y:1};SMap.Projection.Oblique.prototype.$constructor=function(id,config,orientation,coords){this.$super();this._code="oblique";this._response=this._response.bind(this);this._fail=this._fail.bind(this);this._sc=[];this._nextProjection=null;this._rotating=false;this._id=id;this._coords=coords;this._a=config.points[0];this._b=config.points[1];this._c=config.points[2];this._d=config.points[3];this._best=config.best;this._omega=config.angles[0];this._phi=config.angles[1];this._kappa=config.angles[2];this._center=config.center;this._imageSize=config.imageSize;this._focalLength=config.focalLength;this._pixelSize=config.pixelSize;this._orientation=orientation;this._originalImageSize=config.originalImageSize;this._imageOffset=config.imageOffset;this._provider=config.provider;this._date=config.date;this._triangles=[new SMap.Projection.Oblique.Triangle(this._a,this._b,config.best),new SMap.Projection.Oblique.Triangle(this._b,this._c,config.best),new SMap.Projection.Oblique.Triangle(this._c,this._d,config.best),new SMap.Projection.Oblique.Triangle(this._d,this._a,config.best)];var c_phi=Math.cos(this._phi);var c_kappa=Math.cos(this._kappa);var c_omega=Math.cos(this._omega);var s_phi=Math.sin(this._phi);var s_kappa=Math.sin(this._kappa);var s_omega=Math.sin(this._omega);this._rotMatrix=new SMap.Projection.Oblique.Matrix([[c_phi*c_kappa,c_omega*s_kappa+s_omega*s_phi*c_kappa,s_omega*s_kappa-c_omega*s_phi*c_kappa],[-c_phi*s_kappa,-s_omega*s_phi*s_kappa+c_omega*c_kappa,c_omega*s_phi*s_kappa+s_omega*c_kappa],[s_phi,-s_omega*c_phi,c_omega*c_phi]]);this._rotMatrixTr=this._rotMatrix.transpose()};SMap.Projection.Oblique.prototype.setOwner=function(owner){if(this._owner){this._owner.getSignals().removeListeners(this._sc)}this.$super(owner);if(!owner){return}if(this._date){var copyrightControl=owner.getCopyrightControl();if(copyrightControl){copyrightControl.setDate(this._date)}}var s=owner.getSignals();this._sc.push(s.addListener(this,"map-redraw","_mapRedraw"));this._sc.push(s.addListener(this,"rotation-start","_rotationStart"));this._sc.push(s.addListener(this,"rotation-stop","_rotationStop"))};SMap.Projection.Oblique.prototype.getId=function(){return this._id};SMap.Projection.Oblique.prototype.isValid=function(){if(this.getMap().getOrientation()!=this._orientation){return false}var center=this._owner.getCenter();if(center.distance(this._coords)<10){return true}var c=this.project(center);if(c.x<0||c.y<0||c.x>this._imageSize.x||c.y>this._imageSize.y){return false}var distX=Math.min(c.x,this._imageSize.x-c.x);var distY=Math.min(c.y,this._imageSize.y-c.y);var size=this.getMap().getSize();var tol=100;if(distX<size.x/2+tol||distY<size.y/2+tol){return false}return true};SMap.Projection.Oblique.prototype._getElevation=function(utm33Point){for(var i=0,len=this._triangles.length;i<len;++i){if(this._triangles[i].containsPoint(utm33Point)){return this._triangles[i].interpolatePoint(utm33Point)}}return null};SMap.Projection.Oblique.prototype.unproject=function(pixel){var fw=this._originalImageSize.x*this._pixelSize;var fh=this._originalImageSize.y*this._pixelSize;pixel.x=this._imageOffset.x+pixel.x;pixel.y=this._imageOffset.y+pixel.y;var px=[0,0,-this._focalLength];px[0]=pixel.x*this._pixelSize-fw/2;px[1]=fh/2-pixel.y*this._pixelSize;var p=new SMap.Projection.Oblique.Vector(px);var center=new SMap.Projection.Oblique.Vector(this._center);var p1=this._rotMatrixTr.mulByVector(p).plus(center).getPoint();for(var i=0,len=this._triangles.length;i<len;++i){var utm33Point=this._triangles[i].rayIntersection(this._center,p1);if(utm33Point){return SMap.Coords.fromUTM33(utm33Point[0],utm33Point[1])}}return null};SMap.Projection.Oblique.prototype.project=function(coords){var fw=this._originalImageSize.x*this._pixelSize;var fh=this._originalImageSize.y*this._pixelSize;var utm=coords.toUTM33();utm.push(0);var ele=this._getElevation(utm);if(ele==null){return null}utm[2]=ele;var v=new SMap.Projection.Oblique.Vector(this._center,utm);var I=this._rotMatrix.mulByVector(v).getPoint();var u=-this._focalLength/I[2];var A=[I[0]*u,I[1]*u];var px=new SMap.Pixel(0,0);px.x=Math.round((I[0]*u+fw/2)/this._pixelSize);px.y=Math.round((fh/2-I[1]*u)/this._pixelSize);px.x=px.x-this._imageOffset.x;px.y=px.y-this._imageOffset.y;return px};SMap.Projection.Oblique.prototype.pixelToTile=function(pixel,center,zoom,orientation,tileSize){var abs=this._pixelToAbsolutePixel(pixel,center,zoom,SMap.NORTH);abs.y=this._imageSize.y-abs.y;return new SMap.Tile(zoom,tileSize,Math.floor(abs.x/tileSize),Math.floor(abs.y/tileSize))};SMap.Projection.Oblique.prototype.tileToPixel=function(tile,center,zoom,orientation){var ts=tile.tileSize;var x=tile.x*tile.tileSize;var y=this._imageSize.y-tile.y*tile.tileSize;var center=this.project(center);var px=new SMap.Pixel(x-center.x,y-center.y);px.y-=ts;return px};SMap.Projection.Oblique.prototype.pixelToCoords=function(pixel,center,zoom,orientation){var abs=this._pixelToAbsolutePixel(pixel,center,zoom,SMap.NORTH);return this.unproject(abs,zoom)};SMap.Projection.Oblique.prototype.coordsToPixel=function(coords,center,zoom,orientation){var abs=this.project(coords,zoom);var rel=this._absolutePixelToPixel(abs,center,zoom,SMap.NORTH);return rel};SMap.Projection.Oblique.prototype._mapRedraw=function(e){if(this._rotating){return}if(this.isValid()){return}if(this._rq){return}var map=this.getMap();this._rq=this.constructor.create(map.getCenter(),map.getOrientation(),this._rProjection.Oblique.prototype._fail=function(){this._rq=null};SMap.Projection.Oblique.prototype._rotationStart=function(e){this._nextProjection=null;this._rotating=true;var map=this.getMap();var old=map.getOrientation();var response=function(proj){this._rq=null;var map=this.getMap();if(this._rotating){this._nextProjection=proj}else if(map){map.setProjection(proj)}};var fail=function(){this._rq=null;var map=this.getMap();if(this._rotating){this._nextProjection=old}else if(map){map.setOrientation(old,false)}};this._rq=this.constructor.create(map.getCenter(),e.data.targetOrientation,response.bind(this),fail.bind(this))};SMap.Projection.Oblique.prototype._rotationStop=function(e){this._rotating=false;var map=this.getMap();if(map&&this._nextProjection!==null){if(this._nextProjection instanceof SMap.Projection){map.setProjection(this._nextProjection)}else{map.setOrientation(this._nextProjection,false)}}};SMap.Projection.Oblique.prototype._response=function(proj){this._rq=null;this.getMap().setProjection(proj)};SMap.Projection.Oblique.Vector=JAK.ClassMaker.makeClass({NAME:"SMap.Projection.Oblique.Vector",VERSION:"1.0"});SMap.Projection.Oblique.Vector.prototype.$constructor=function(point1,point2){if(arguments.length==1){this._x=point1[0];this._y=point1[1];this._z=point1[2]}else if(arguments.length==2){this._x=point2[0]-point1[0];this._y=point2[1]-point1[1];this._z=point2[2]-point1[2]}else{this._x=0;this._y=0;tototype.getPoint=function(){return[this._x,thi Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z)};SMap.Projection.Oblique.Vector.prototype.normalize=function(){var size=this.norm();this._x=this._x/size;this._y=this._y/size;this._eturn this._x*vector._x+this._y*vector._y+this._z*vector._z};SMap.Projection.Oblique.Vector.prototype.cross=function(vector){return new SMap.Projection.Oblique.Vector([this._y*vector._z-this._z*vector._y,this._z*vector._x-this._x*vector._z,this._x*vector._y-this._y*vector._x])};SMap.Projection.Oblique.Vector.prototype.plus=function(vector){return new SMap.Projection.Oblique.Vector([this._x+vector._x,this._y+vector._y,this._z+vector._z])};SMap.Projection.Oblique.Vector.prototype.mul=function(t){return new SMap.Projection.Oblique.Vector([this._x*t,this._y*t,this._z*t])};SMap.Projection.Oblique.Vector.prototype.minus=function(vector){return new SMap.Projection.Oblique.Vector([this._x-vector._x,this._y-vector._y,this._z-vector._z])};SMap.Projection.Oblique.Matrix=JAK.ClassMaker.makeClass({NAME:"SMap.Projection.Oblique.Matrix",VERSION:"1.0"});SMap.Projection.Oblique.Matrix.prototype.$constructor=function(data){if(arguments.length==1){this._data=data}else{this._data=[[0,0,0],[0,0,0],[0,0,0]]}};SMap.Projection.Oblique.Matrix.prototype.mulByVector=function(vect){return new SMap.Projection.Oblique.Vector([this._data[0][0]*vect._x+this._data[0][1]*vect._y+this._data[0][2]*vect._z,this._data[1][0]*vect._x+this._data[1][1]*vect._y+this._data[1][2]*vect._z,this._data[2][0]*vect._x+this._data[2][1]*vect._y+this._data[2][2]*vect._z])};SMap.Projection.Oblique.Matrix.prototype.transpose=function(){return new SMap.Projection.Oblique.Matrix([[this._data[0][0],this._data[1][0],this._data[2][0]],[this._data[0][1],this._data[1][1],this._data[2][1]],[this._data[0][2],this._data[1][2],this._data[2][2]]])};SMap.Projection.Oblique.Triangle=JAK.ClassMaker.makeClass({NAME:"SMap.Projection.Oblique.Triangle",VERSION:"1.0"});SMap.Projection.Oblique.Triangle.prototype.$constructor=function(a,b,c){if(arguments.length==3){this._a=a;this._b=b;this._c=c;this._computeABC()}else{this._a=[0,0,0];this._b=[0,0,0];this._c=[0,0,0]}};SMap.Projection.Oblique.Triangle.prototype._sameSide=function(p1,p2,a,b){var v1=new SMap.Projection.Oblique.Vector(a,b);var v2=new SMap.Projection.Oblique.Vector(a,p1);var v3=new SMap.Projection.Oblique.Vector(a,p2);var cp1=v1.cross(v2);var cp2=v1.cross(v3);if(cp1.dot(cp2)>=0){return true}else{return false}};SMap.Projection.Oblique.Triangle.prototype.containsPoint=function(p0){var p=[p0[0],p0[1],0];var a=[this._a[0],this._a[1],0];var b=[this._b[0],this._b[1],0];var c=[this._c[0],this._c[1],0];return this._sameSide(p,a,b,c)&&this._sameSide(p,b,a,c)};SMap.Projection.Oblique.Triangle.prototype._computeABC=function(){var P=this._a[0]-this._b[0];var Q=this._a[1]-this._b[1];var R=this._a[0]-this._c[0];var S=this._a[1]-this._c[1];var T=this._a[2]-this._b[2];var U=this._a[2]-this._c[2];var det=P*S-R*Q;this._A=(T*S-U*Q)/det;this._B=(P*U-R*T)/det;this._C=this._a[2]-this._A*this._a[0]-this._B*this._a[1]};SMap.Projection.Oblique.Triangle.prototype.rayIntersection=function(p0,p1){var V=new SMap.Projection.Oblique.Vector(p0,p1);var N=new SMap.Projection.Oblique.Vector([this._A,this._B,-1]);var P0=new SMap.Projection.Oblique.Vector(p0);var t=-(P0.dot(N)+this._C)/V.dot(N);var p=P0.plus(V.mul(t)).getPoint();if(this.containsPoint(p)){return p}else{return null}};SMap.Projection.Oblique.Triangle.prototype.interpolatePoint=function(p){return this._A*p[0]+this._B*p[1]+this._C};SMap.Projection.Oblique.prototype.getProvider=function(){return this._provider};SMap.Projection.Robinson=JAK.ClassMaker.makeClass({NAME:"SMap.Projection.Robinson",VERSION:"1.0",EXTEND:SMap.Projection});SMap.Projection.Robinson.K=[[.9986,-.062],[1,0],[.9986,.062],[.9954,.124],[.99,.186],[.9822,.248],[.973,.31],[.96,.372],[.9427,.434],[.9216,.4958],[.8962,.5571],[.8679,.6176],[.835,.6769],[.7986,.7346],[.7597,.7903],[.7186,.8435],[.6732,.8936],[.6213,.9394],[.5722,.9761],[.5322,1]].map(function(pair){pair[1]*=1.0144;ronstructor=function(){this.$super();this._code="EPSG:54030"};SMap.Projection.Robinson.prototype.getWorldSize=function(zoom){var scale=Math.pow(2,zoom);return new SMap.Pixel(scale*256,scale*256)};SMap.Projection.Robinson.prototype.project=function(coords,zoom){var radians=Math.PI/180;var wgs=coords.toWGS84();var phi=wgs[1]*radians;var lambda=wgs[0]*radians;var K=this.constructor.K;var i=Math.min(18,Math.abs(phi)*36/Math.PI),i0=Math.floor(i),di=i-i0,ax=(k=K[i0])[0],ay=k[1],bx=(k=K[++i0])[0],by=k[1],cx=(k=K[Math.min(19,++i0)])[0],cy=k[1],k;var x=lambda*(bx+di*(cx-ax)/2+di*di*(cx-2*bx+ax)/2);var y=(phi>0?Math.PI/2:-Math.PI/2)*(by+di*(cy-ay)/2+di*di*(cy-2*by+ay)/2);var world=this.getWorldSize(zoom);x=world.x*(1+x/Math.PI)/2;y=world.y*(1+y/-Math.PI)/2;return new SMap.Pixel(x,y)};SMap.Projection.Robinson.prototype.unproject=function(pixel,zoom){var world=this.getWorldSize(zoom);var x=Math.PI*(2*pixel.x/world.x-1);var y=-Math.PI*(2*pixel.y/world.y-1);var K=this.constructor.K;var halfPi=Math.PI/2;var degrees=180/Math.PI;var epsilon2=1e-12;var yy=y/halfPi,phi=yy*90,i=Math.min(18,Math.abs(phi/5)),i0=Math.max(0,Math.floor(i));do{var ay=K[i0][1],by=K[i0+1][1],cy=K[Math.min(19,i0+2)][1],u=cy-ay,v=cy-2*by+ay,t=2*(Math.abs(yy)-by)/u,c=v/u,di=t*(1-c*t*(1-2*c*t));if(di>=0||i0===1){phi=(y>=0?5:-5)*(di+i);var j=50,delta;do{i=Math.min(18,Math.abs(phi)/5);i0=Math.floor(i);di=i-i0;ay=K[i0][1];by=K[i0+1][1];cy=K[Math.min(19,i0+2)][1];phi-=(delta=(y>=0?halfPi:-halfPi)*(by+di*(cy-ay)/2+di*di*(cy-2*by+ay)/2)-y)*degrees}while(Math.abs(delta)>epsilon2&&--j>0);break}}while(--i0>=0);var ax=K[i0][0],bx=K[i0+1][0],cx=K[Math.min(19,i0+2)][0];var lon=x/(bx+di*(cx-ax)/2+di*di*(cx-2*bx+ax)/2);lon=lon*degrees;var lat=phi;return SMap.Coords.fromWGS84(lon,lat)};SMap.Layer=JAK.ClassMaker.makeClass({NAME:"SMap.Layer",VERSION:"1.0",IMPLEMENT:SMap.IOwned});SMap.Layer.prototype.$constructor=function(id){this._id=id||Math.random();this._owner=null;this._dom={container:{}};this._active=false;this._copyright={};this._build()};SMap.Layer.prototype.$destructor=function(){};SMap.Layer.prototype.setCopyright=function(copyright){this._copyright=copyright;return this};SMap.Layer.prototype.getCopyright=function(zoom){var results=[];for(var p in this._copyright){var val=this._copyright[p];var r=p.match(/([0-9]*)(-?)([0-9]*)/);if(!r[2]){if(zoom==r[1]){return val}}else{var ok1=true;var ok2=true;if(r[1]&&zoom<r[1]){ok1=false}if(r[3]&&zoom>r[3]){ok2=false}if(ok1&&ok2){results=results.concat(val)}}}return results.length?results:null};SMap.Layer.prototype.getId=function(){return this._id};SMap.Layer.prototype.enable=function(){if(this._active){return this}this._active=true;this.redraw(true);this.getMap().getSignals().makeEvent("layer-enable",this);return this};SMap.Layer.prototype.disable=function(){if(!this._active){return this}this._active=false;this.clear();this.getMap().getSignals().makeEvent("layer-disable",this);return this};SMap.Layer.prototype.redraw=function(full){if(!this._active){return}};SMap.Layer.prototype.clear=function(){};SMap.Layer.prototype.getContainer=function(){return this._dom.container};SMap.Layer.prototype.isActive=function(){return this._active};SMap.Layer.prototype.removeAll=function(){};SMap.Layer.prototype.supportsAnlse};SMap.Layer.prototype.zoomTo=function(zoom,fixedPoint){};SMap.Layer.proto=function(angle){};SMap.Layer.prototype._build=function(){};SMap.Layer.HUD=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.HUD",VERSION:"1.0",EXTEND:SMap.Layer});SMap.Layer.HUD.prototype.clear=function(){this._dom.container[SMap.LAYER_HUD].style.display="none"};SMap.Layer.HUD.prototype.enable=function(){this._dom.container[SMap.LAYER_HUD].style.display="";this.$super()};SMap.Layer.HUD.prototype.addItem=function(node,placement,prepend){node.style.position="absolute";for(var p in placement){node.style[p]=placement[p]}var hudEl=this._dom.container[SMap.LAYER_HUD];if(prepend){hudEl.insertBefore(node,hudEl.firstChild)}else{hudEl.appendChild(node)}};SMap.Layer.HUD.prototype.removeItem=function(node){node.parentNode.removeChild(node)};SMap.Layer.HUD.prototype._build=function(){this._dom.container[SMap.LAYER_HUD]=JAK.mel("div")};SMap.Layer.Multi=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.Multi",VERSION:"1.0",EXTEND:SMap.Layer});SMap.Layer.Multi.prototype.$destructor=function(){this.$super();for(var i=0;i<this._layers.length;i++){this.=0;i<this._layers.length;i++){this._layers[i].redraw(full)}};SMap.Layer.Multi.prototype.clear=function(){for(var i=0;i<this._layers.length;i++){this._layers[i].clear()}};SMap.Layer.Multi.prototype.removeAll=function(){for(var i=0;i<this._layers.length;i++){this._layers[i].removeAll()}};SMap.Layer.Multi.prototype.enable=function(){if(this._active){return}this._active=true;for(var i=0;i<this._layers.length;i++){this._layers[i].enable()}this.getMap().getSignals().makeEvent("layer-enable",this)};SMap.Layer.Multi.prototype.disable=function(){if(!this._active){return}this._active=false;for(var i=0;i<this._layers.length;i++){this._layers[i].disable()}this.getMap().getSignals().makeEvent("layer-disable",this)};SMap.Layer.Multi.prototype.setOwner=function(owner){this.$super(owner);for(var i=0;i<this._layers.length;i++){this._layers[i].setOwner(owner)}};SMap.Layer.Multi.prototype.getContainer=function(){return this._container};SMap.Layer.Multi.prototype.addLayer=function(l){this._layers.push(l);var container=l.getContainer();for(var id inorEach(function(item){this._container[id].appendChild(item)},this)}if(this.getMap()){l.setOwner(this)}if(this._active){l.enable()}};SMap.Layer.Multi.prototype.removeLayer=function(l){var index=this._layers.indexOf(l);if(index==-1){return}l.$destructor();this._layers.splice(index,1);var container=l.getContainer();for(var id inms.forEach(function(item){item.parentNode.removeChild(item)},this)}};SMap.Layer.Multi.prototype.getLayers=function(){return this._layers};SMap.Layer.Multi.prototype._build=function(){this._layers=[];this._container={};this._container[SMap.LAYER_TILE]=JAK.mel("div");this._container[SMap.LAYER_SHADOW]=JAK.mel("div");this._container[SMap.LAYER_MARKER]=JAK.mel("div");this._container[SMap.LAYER_ACTIVE]=JAK.mel("div");this._container[SMap.LAYER_HUD]=JAK.mel("div");var tmp=JAK.Vector.getCanvas(1,1);this._container[SMap.LAYER_GEOMETRY]=tmp.group()};SMap.Layer.Canvas=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.Canvas",VERSION:"1.0",EXTEND:SMap.Layer});SMap.Layer.Canvas.prototype.$constructor=function(id,layerId){this._layerId=layerId;this._context=nprototype.$destructor=function(){this.clear();this.$super()};SMap.Layer.Canvas.prototype.clear=function(){if(this._context){this._context.clearRect(0,0,this._context.canvas.width,this._context.canvas.height)}};SMap.Layer.Canvas.prototype.getContext=function(){return this._context};SMap.Layer.Canvas.prototype._build=function(){var c=JAK.mel("canvas",{},{position:"absolute"});this._dom.container[this._layerId]=c;if(c.getContext){this._context=c.getContext("2d")}};SMap.Layer.Canvas.prototype.redraw=function(full){if(!this._active){return}var c=this._dom.container[this._layerId];var size=this.getMap().getSize();c.width=size.x;c.height=size.y;var offset=this.getMap().getOffset();var position=size.clone().scale(-.5).minus(offset);c.style.left=position.x+"px";c.style.top=position.y+"px"};SMap.TileSet=JAK.ClassMaker.makeClass({NAME:"SMap.TileSet",VERSION:"1.0"});SMap.TileSet.img=JAK.mel("img",{alt:""},{position:"absolute"});SMap.TileSet.prototype.$constructor=function(map,options){this._map=map;this._options=options;this.onload=null;this._zoom=map.getZoom();this._container=document.createElement("div");this._container.style.webkitTransform="translateZ(0px)";this._container.style.transform="translateZ(0px)";this._tiles={};this._stats={total:0,loaded:0}};SMap.TileSet.prototype.$destructor=function(){for(var p in this._tiles){this._tiles[p].node.onload=null;this._tiles[p].node.onerror=null}};SMap.TileSet.prototype.getContainer=function(){return this._container};SMap.TileSet.prototype.addTiles=function(tiles){var map=this._map;var o=map.getOrientation();var newTiles=[];for(var id in tiles){if(id in this._tiles){continue}newTiles.push(tiles[id])}this._stats.total+=newTiles.length;var offset=map.getOffset();newTiles.forEach(function(item){var node=this._createTileNode(item.url,o,item.retinaUrl);var px=item.tile.toPixel(this._map).minus(offset);node.style.left=px.x+"px";node.style.top=px.y+"px";node.style.width=node.style.height=item.tile.tileSize+"px";item.node=node;this._tiles[item.tile]=item;this._container.appendChild(node)},this)};SMap.TileSet.prototype.zoomTo=function(zoom,fixedPoint){var map=this._map;var scaleSize=Math.pow(2,zoom-this._zoom);var scalePosition=Math.pow(2,zoom-map.getZoom());var offset=map.getOffset();var shift=fixedPoint.clone().scale(1-scalePosition).minus(offset);if(0&&SMap.TRANSFORM&&scaleSize<1){var t="translate("+shift.x+"px, "+shift.y+"px) scale("+scaleSize+","+scaleSize+")";this._container.style[SMap.TRANSFORM]=t}else{var size=Math.ceil(this._options.tileSize*scaleSize);for(var id in this._tiles){var item=this._tiles[id];var node=item.node;node.style.width=size+"px";node.style.height=size+"px";var px=item.tile.toPixel(map).scale(scaleSize).plus(shift);node.style.left=Math.round(px.x)+"px";node.style.top=Math.round(px.y)+"px"}}};SMap.TileSet.prototype.rotateTo=function(angle){if(!SMap.TRANSFORM){return}var offset=this._map.getOffset();if(angle){var str="translate("+-offset.x+"px, "+-offset.y+"px) rotate("+angle+"deg) translate("+offset.x+"px,"+offset.y+"px)"}else{var str=""}this._container.style[SMap.TRANSFORM]=str};SMap.TileSet.prototype._createTileNode=function(url,orientation,retinaUrl){url=SMap.zitafa(url);if(SMap.lang==="en"&&SMap.apiKey&&url.indexOf("/v1/maptiles")!==-1){url+="&lang=en"}var node=SMap.TileSet.img.cloneNode(false);node.style.opacity=0;if(retinaUrl){node.srcset=url+", "+SMap.zitafa(retinaUrl)+" 2x"}node.src=url;if(SMap.TRANSFORM&&orientation!=SMap.NORTH){var value="";switch(this._map.getOrientation()){case SMap.SOUTH:value="rotate(180deg)";break;case SMap.EAST:value="rotate(270deg)";break;case SMap.WEST:value="rotate(90deg)";break}node.style[SMap.TRANSFORM]=value}if(this._options.fadeTime){node.style.transition="opacity "+this._options.fadeTime+"ms"}node.onload=function(e){node.style.opacity=1;this._stats.loaded++;if(this.onload&&this._stats.loaded/this._stats.total>.6){setTimeout(this.onload,this._d=null}}.bind(this);node.onerror=function(e){node.onload(e)};return node};SMap.Layer.Tile=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.Tile",VERSION:"1.0",EXTEND:SMap.Layer});SMap.Layer.Tile.DEFAULT_OPTIONS={tileSize:256,alpha:false,fadeTime:600,query:"{zoom}-{x}-{y}"};SMap.Layer.Tile.prototype.$constructor=function(id,url,options){this.$super(id);this._options={};var def=SMap.Layer.Tile.DEFAULT_OPTIONS;for(var p in def){this._options[p]=def[p]}for(var p in options){this._options[p]=options[p]}this._url=url;this._tileSetCtor=SMap.TileSet;this._tileSets=[]};SMap.Layer.Tile.prototype.setOptions=function(options){for(var p in options){this._options[p]=options[p]}thype.supportsAnimation=function(){return!this._options.alpha};SMap.Layer.Tile.prototype.redraw=function(full){if(!this._active){return}var tileSet=null;if(full){if(this._tileSets.length>1||!this.supportsAnimation()&&this._tileSets.length>0){this._destroyTileSet(0)}tileSet=this._createTileSet()}else{tileSet=this._tileSets[0]}var tiles=this._createTiles();tileSet.addTiles(tiles)};SMap.Layer.Tile.prototype.setURL=function(url){if(url==this._url){return}this._url=url;this.redraw(true)};SMap.Layer.Tile.prototype.clear=function(){while(this._tileSets.length){this._destroyTileSet(0)}};SMap.Layer.Tile.prototype.zoomTo=function(zoom,fixedPoint){if(!this._active){return}if(!this._tileSets.length){return}var tileSet=this._tileSets[this._tileSets.length-1];tileSet.zoomTo(zoom,fixedPoint)};SMap.Layer.Tile.prototype.rotateTo=function(angle){if(!this._tileSets.length){return}var tileSet=this._tileSets[this._tileSets.length-1];tileSet.rotateTo(angle)};SMap.Layer.Tile.prototype._createTiles=function(){var map=this.getMap();var ts=this._options.tileSize;var half=map.getSize().clone().scale(.5);var w=half.x;var h=half.y;var tiles={};for(var i=-w;i<w+ts;i+=ts){for(var j=-h;j<h+ts;j+=ts){var tile=new SMap.Pixel(i,j).toTile(map,ts);if(!tile){continue}var obj={node:null,url:this._buildURL(tile),tile:tile};if(this._options.retinaUrl){obj.retinaUrl=this._buildURL(tile,this._options.retinaUrl)}tiles[tile]=obj}}var tmp=[];for(var p in tiles)tmp.push(tiles[p]);this.n tiles};SMap.Layer.Tile.prototype._render=function(tiles){};SMap.Layer.Tile.prototype._createTileSet=function(){var options={tileSize:this._options.tileSize,fadeTime:this._options.fadeTime};var tileSet=new this._tileSetCtor(this.getMap(),options);tileSet.onload=this._tileSetLoaded.bind(this);this._tileSets.unshift(tileSet);this._dom.container[SMap.LAYER_TILE].appendChild(tileSet.getContainer());return tileSet};SMap.Layer.Tile.prototype._destroyTileSet=function(index){var oldTileSet=this._tileSets.splice(index,1)[0];oldTileSet.onload=null;oldTileSet.$destructor();var node=oldTileSet.getContainer();node.parentNode.removeChild(node)};SMap.Layer.Tile.prototype._tileSetLoaded=function(){var map=this.getMap();if(map){map.getSignals().makeEvent("tileset-load",this)}if(this._tileSets.length<2){return}this._destroyTileSet(1)};SMap.Layer.Tile.prototype._build=function(){var id=this._id+"-"+SMap.LAYER_TILE+"-"+Math.random();this._dom.container[SMap.LAYER_TILE]=JAK.mel("div",{id:id})};SMap.Layer.Tile.prototype._buildURL=function(tile,ownUrl){var url=(ownUrl||this._url)+this._buildQuery(tile);var mapServerNumber=1+(tile.x+tile.y&3);return url.replace(/#/,mapServerNumber)};SMap.Layer.Tile.prototype._buildQuery=function(tile){var ppx=(tile.x<<28-tile.zoom).toString(16);var ppy=(tile.y<<28-tile.zoom).toString(16);var world=this._owner.getProjection().getWorldSize(tile.zoom);var count=world.x/tile.tileSize;return this.getMap().formatString(this._options.query,{ppx:ppx,ppy:ppy,x:tiLayer.Tile.prototype.getURL=function(){return this._url||""};SMap.TileSetOblique=JAK.ClassMaker.makeClass({NAME:"SMap.TileSetOblique",VERSION:"1.0",EXTEND:unction(url,orientation){return this.$super(url,SMap.NORTH)};SMap.Layer.Tile.Oblique=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.Tile.Oblique",VERSION:"1.0",EXTEND:SMap.Layer.Tile});SMap.Layer.Tile.Oblique.prototype.$constructor=function(id,url,options){this.$super(id,url,options);this._tileSetCtor=SMap.TileSetOblique};SMap.Layer.Tile.Oblique.prototype.redraw=function(full){if(!this._active){return}var proj=this.getMap().getProjection();if(!(proj instanceof SMap.Projection.Oblique)){return}if(!proj.isValid()){return}this.$super(full)};SMap.Layer.Tile.Oblique.prototype._buildURL=function(tile){var proj=this.getMap().getProjection();var url=this._url+proj.getId();var mapServerNumber=1+(tile.x+tile.y&3);url=url.replace(/#/,mapServerNumber);var x=tile.x.toString(16).lpad("0",2);var y=tile.y.toString(16).lpad("0",2);return this.getMap().formatString(url,{x:x,y:y})};SMap.Layer.Tile.Oblique.prototype.getCopyright=function(){var projection=this.getMap().getProjection();if(projection instanceof SMap.Projection.Oblique){return this._copyright[projection.getProvider()]}else{return null}};SMap.Layer.Image=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.Image",VERSION:"1.0",EXTEND:SMap.Layer});SMap.Layer.Image.prototype.$constructor=function(id){this.$super(id);this.clear();this._images={}};SMap.Layer.Image.prototype.supportsAnimation=function(){return true};SMap.Layer.Image.prototype.addImage=function(url,leftTop,rightBottom,opacity){var id=JAK.idGenerator();var img=JAK.mel("img",{src:url},{position:"absolute",opacity:opacity||1});this._images[id]={img:img,leftTop:leftTop,rightBottom:rightBottom,loaded:false,size:[0,0]};img.onload=this._load.bind(this);return id};SMap.Layer.Image.prototype.removeImage=function(id){var data=this._images[id];if(!data){return this}if(data.loaded){data.img.parentNode.removeChild(data.img)}delete this._images[id];return this};SMap.Layer.Image.prototype.removeAll=function(){this._images={};this._dom.container[SMap.LAYER_TILE].innerHTML="";return this};SMap.Layer.Image.prototype.redraw=function(full){if(!this._active||!full){return}for(var id in this._images){this._draw(id)}};SMap.Layer.Image.prototype.clear=function(){this._dom.container[SMap.LAYER_TILE].style.display="none"};SMap.Layer.Image.prototype.enable=function(){this._dom.container[SMap.LAYER_TILE].style.display="";this.$super()};SMap.Layer.Image.prototype.zoomTo=function(zoom,fixedPoint){if(!this._active){return}for(var id in this._images){this._draw(id,zoom,fixedPoint)}};SMap.Layer.Image.prototype._build=function(){this._dom.container[SMap.LAYER_TILE]=JAK.mel("div",{id:this._id+"-"+SMap.LAYER_TILE+"-"+Math.random()})};SMap.Layer.Image.prototype._load=function(e){var img=e.target;img.onload=null;for(var id in this._images){var data=this._images[id];if(data.img!=img){continue}data.loaded=true;this._draw(id);this._dom.container[SMap.LAYER_TILE].appendChild(img)}};SMap.Layer.Image.prototype._draw=function(id,zoom,fixedPoint){var map=this.getMap();var offset=map.getOffset();if(!fixedPoint){zoom=map.getZoom()}var data=this._images[id];var img=data.img;var lt=data.leftTop.toPixel(map,zoom);var rb=data.rightBottom.toPixel(map,zoom);img.style.width=rb.x-lt.x+"px";img.style.height=rb.y-lt.y+"px";if(fixedPoint){var scale=Math.pow(2,zoom-map.getZoom());var shift=fixedPoint.clone().scale(1-scale);lt.plus(shift)}lt.minus(offset);img.style.left=lt.x+"px";img.style.top=lt.y+"px"};SMap.Layer.WMS=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.WMS",EXTEND:SMap.Layer.Image});SMap.Layer.WMS.prototype.$constructor=function(id,url,params){this.$super(id);this._url=url;this._params={format:"image/jpeg",service:"WMS",version:"1.3.0",styles:""};for(var p in params){this._params[p]=params[p]}};SMap.Layer.WMS.prototype.redraw=function(full){if(!this._active){return}if(full){this.removeAll()}var map=this.getMap();var size=map.getSize();var leftTop=size.clone().scale(-.5).toCoords(map);var rightBottom=size.clone().scale(.5).toCoords(map);var url=this._getURL(size);var id=this.addImage(url,leftTop,rightBottom)};SMap.Layer.WMS.prototype._getURL=function(size){var map=this.getMap();var data={width:size.x,height:size.y,request:"GetMap",crs:map.getProjection().getCode()};for(var p in this._params){data[p]=this._params[p]}var half=size.clone().scale(.5);var w=half.x;var h=half.y;var leftBottom=new SMap.Pixel(-w,h).toCoords(map);var rightTop=new SMap.Pixel(w,-h).toCoords(map);var bbox=[];switch(data.crs){case"EPSG:3857":bbox.push(leftBottom.toMercator());bbox.push(rightTop.toMercator());break;case"EPSG:32633":bbox.push(leftBottom.toUTM33());bbo3());break;case"EPSG:102067":var minus=function(x){return-x};bbox.push(leftBottom.toJTSK().map(minus).reverse());bbox.push(rightTop.toJTSK().map(minus).reverse());break;default:bbox.push(leftBottom.toWGS84().reverse());bbox.push(rightTop.toWGS84().reverse());break}data.bbox=bbox[0].concat(bbox[1]).join(",");var arr=[];for(var p in data){arr.push(encodeURIComponent(p)+"="+encodeURIComponent(data[p]))}return this._url+"?"+arr.join("&")};SMap.Layer.WMS.prototype._load=function(e){var img=e.target;for(var id in this._images){var data=this._images[id];if(data.img==img){continue}this.removeImage(id)}this.$super(e)};SMap.Layer.WMTS=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.WMTS",EXTEND:SMap.Layer.Tile});SMap.Layer.WMTS.prototype.$constructor=function(id,url,params,options){this._params={format:"image/png",service:"WMTS",version:"1.0.0"};for(var p in params){this._params[p]=params[p]}this.$super(id,url,options)};SMap.Layer.WMTS.prototype._buildURL=function(tile){var map=this.getMap();var x=tile.x;var y=tile.y;var z=tile.zoom;var projection=map.getProjection();var data={request:"GetTile",tileMatrixSet:projection.getMatrixSet(),tileMatrix:z,tileRow:y,tileCol:x};for(var p in this._params){data[p]=this._params[p]}var arr=[];for(var p in data){arr.push(encodeURIComponent(p)+"="+encodeURIComponent(data[p]))}return this._url+"?"+arr.join("&")};SMap.Layer.Smart=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.Smart",VERSION:"1.0",EXTEND:SMap.Layer.Tile});SMap.Layer.Smart.prototype.$constructor=function(id,map,options){this.$super(id);this._options={base:SMap.DEF_BASE};for(var p in options){this._options[p]=options[p]}this._layers={base:this._options.base==SMap.DEF_OPHOTO?null:map.removeLayer(map.addDefaultLayer(this._options.base)),ophoto:map.removeLayer(map.addDefaultLayer(SMap.DEF_OPHOTO)),oblique:map.removeLayer(map.addDefaultLayer(SMap.DEF_OBLIQUE)),hybrid:map.removeLayer(map.addDefaultLayer(SMap.DEF_HYBRID))};if(this._layers.base==null){this._layers.base=this._layers.ophoto}this._hybridMode=false;this._currentLayer=null;this._currentHybrid=null};SMap.Layer.Smart.prototype.getLayers=function(){return this._layers};SMap.Layer.Smart.prototype.setHybrid=function(mode){if(mode==this._hybridMode){return}this._hybridMode=mode;if(!this._currentHybrid){return}if(mode){this._currentHybrid.enable()}else{this._currentHybrid.disable()}return this};SMap.Layer.Smart.prototype.redraw=function(full){if(!this._active){return}var map=this.getMap();var zoom=map.getZoom();var availOblique=map.isObliqueAvailable();var availOphoto=map.isOphotoAvailable();var maxZoom=19;if(availOphoto){maxZoom=20}if(availOblique){maxZoom=21}if(map.getZoom()<20){availOphoto=true}if(zoom==21){var changed=this._tryOblique(availOblique)}else if(zoom>18){var changed=this._tryOphoto(availOphoto)}else{var changed=this._tryBase()}map.setZoomRange(2,maxZoom);if(!changed){if(this._currentLayer.isActive()){this._currentLayer.redraw(full)}else{this._currentLayer.enable()}if(this._currentHybrid&&this._hybridMode){if(this._currentHybrid.isActive()){this._currentHybrid.redraw(full)}else{this._currentHybrid.enable()}}}};SMap.Layer.Smart.prototype.getSimpleLayerId=function(){if(!this._currentLayer){return null}var id=this._currentLayer.getId();if(id==SMap.DEF_OBLIQUE){return SMap.lear()}if(this._currentHybrid){this._currentHybrid.clear()}};SMap.Layer.Smart.prototype.zoomTo=function(zoom,fixedPoint){if(!this._active){return}if(this._currentLayer){this._currentLayer.zoomTo(zoom,fixedPoint)}if(this._currentHybrid){this._currentHybrid.zoomTo(zoom,fixedPoint)}};SMap.Layer.Smart.prototype.rotateTo=function(angle){if(this._currentLayer){this._currentLayer.rotateTo(angle)}if(this._currentHybrid){this._currentHybrid.ro){return true}return this._currentLayer.supportsAnimation()};SMap.Layer.Smart.prototype.getCopyright=function(z){if(!this._currentLayer){return null}var copy=this._currentLayer.getCopyright(z);if(this._currentHybrid&&this._currentHybrid.isActive()){if(!(copy instanceof Array)){copy=[copy]}copy=copy.concat(this._currentHybrid.getCopyright(z))}return copy};SMap.Layer.Smart.prototype.setOwner=function(owner){this.$super(owner);for(var p in this._layers){this._layer.Smart.prototype.enable=function(){return this.$super()};SMap.Layer.Smart.prototype.disable=function(){if(!this._active){return}this.$super();this._currentLayer.disable();if(this._currentHybrid){this._currentHybrid.disable()}this._currentLayer=null;return this};SMap.Layer.Smart.prototype.getContainer=function(){var result={};for(var p in this._layers){var c=this._layers[p].getContainer();for(var id in c){if(!(id in result)){result[id]=[]}if(result[id].indexOf(c[id])>-1){continue}result[id]=result[id].concat(c[id])}}return result};SMap.Layer.Smart.prototype._tryOblique=function(availOblique){if(availOblique){if(this._currentLayer==this._layers.oblique){return false}if(this._currentLayer){this._currentLayer.disable()}if(this._currentHybrid){this._currentHybrid.disable()}this._currentLayer=null;this._currentHybrid=null;var map=this.getMap();var cb=function(proj){this._currentLayer=this._layers.oblique;this._currentHybridmap.setProjection(proj)};var err=function(){map.setZoom(20)};SMap.Projection.Oblique.create(map.getCenter(),map.getOrientation(),cb.bind(this),err.bind(this));return true}else{return this._tryOphoto()}};SMap.Layer.Smart.prototype._tryOphoto=function(availOphoto){if(availOphoto){if(this._currentLayer==this._layers.ophoto){return false}if(this._currentLayer){this._currentLayer.disable()}if(this._currentHybrid){this._currentHybrid.disable()}var old=this._currentLayer;this._currentLayer=this._layers.ophoto;this._currentHybrid=this._layers.hybrid;if(old==this._layers.oblique){this._switchToMercator()}else{this._currentLayer.enable();if(this._hybridMode){this._currentHybrid.enable()}}return true}else{return this._tryBase()}};SMap.Layer.Smart.prototype._tryBase=function(){if(this._currentLayer==this._layers.base){return false}if(this._currentLayer){this._currentLayer.disable()}if(this._currentHybrid){this._currentHybrid.disable()}var old=this._currentLayer;this._currentLayer=this._layers.base;this._currentHybrid=null;if(this._layers.base==this._layers.ophoto){this._currentHybrid=this._layers.hybrid}if(old==this._layers.oblique){this._switchToMercator()}else{this._currentLayer.enable();if(this._currentHybrid&&this._hybridMode){this._currentHybrid.enable()}}return true};SMap.Layer.Smart.prototype._switchToMercator=function(){var map=this.getMap();map.setOrientation(SMap.NORTH);map.setProjection(new SMap.Projection.Mercator)};SMap.Layer.Smart.Turist=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.Smart.Turist",VERSION:"1.0",EXTEND:SMap.Layer.Smart});SMap.Layer.Smart.Turist.prototype.$constructor=function(id,map){this.$super(id,map,{base:SMap.DEF_TURIST});this._bike=false;this._trail=false};SMap.Layer.Smart.Turist.prototype.setTrail=function(trail){this._trail=trail;return this};SMap.Layer.Smart.Turist.prototype.setBike=function(bike){this._bike=bike;return this};SMap.Layer.Smart.Turist.prototype.getTrail=function(){return this._trail};SMap.Layer.Smart.Turist.prototype.getBike=function(){return this._bike};SMap.Layer.Turist=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.Turist",VERSION:"1.0",EXTEND:SMap.Layer.Tile});SMap.Layer.Turist.prototype.$constructor=function(id,url,options){this.$super(id,url,options);this._trail=false;this._bike=false};SMap.Layer.Turist.prototype.setTrail=function(trail){this._rototype.setBike=function(bike){this._bike=bike;return this};SMap.Layer.Turist.prototype.getTrail=function(){return this._trail};SMap.Layer.Turist.prototype.getBike=function(){return this._bike};SMap.Layer.Marker=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.Marker",VERSION:"1.0",EXTEND:SMap.Layer});SMap.Layer.Marker.prototype.$constructor=function(id,options){this._ec=[];this.$super(id);this._repositionOptions=null;this._clusterer=null;this._eventCoords=null;this._markers={};this._options={prefetch:100,supportsAnimation:false,poiTooltip:false};for(var p in options){this._options[p]=options[p]}};SMap.Layer.Marker.prototype.$destructor=function(){for(var p in this._dom.container){JAK.DOM.clear(this._dom.container[p])}this._dom={};for(var id in this._markers){this._markers[id].marker.setOwner(null);this._markers[id].marker.$destructor()}this._markers={};JAK.Events.removeListeners(this._ec);this.$super()};SMap.Layer.Marker.prototype.setClusterer=function(clusterer){var oldClusterer=this._clusterer;this._clusterer=clusterer;if(!clusterer&&oldClusterer){this.clear();this._markers={};this._addMarker(oldClusterer.getAllMarkers())}if(clusterer){for(var id in this._markers){var marker=this._markers[id].marker;this._clusterer.addMarker(marker)}}this.redraw(true)};SMap.Layer.Marker.prototype.addMarker=function(marker,noRedraw){var redrawType=false;if(this._clusterer){this._clusterer.addMarker(marker);redrawType=true}else{this._addMarker(marker)}if(!noRedraw){this.redraw(redrawType)}};SMap.Layer.Marker.prototype.removeMarker=function(marker,noRedraw){var redrawType=false;if(this._clusterer){this._clusterer.removeMarker(marker);redrawType=true}else{this._removeMarker(marker)}if(!noRedraw){this.redraw(redrawType)}};SMap.Layer.Marker.prototype.removeAll=function(){if(this._clusterer){this._clusterer.clear();this.clear();this._markers={}}else{var all=[];for(var id in this._markers){all.push(this._markers[id].marker)}while(all.length){this._removeMarker(all.shift())}}};SMap.Layer.Marker.prototype.getMarkers=function(){if(this._clusterer){return this._clusterer.getAllMarkers()}else{var result=[];for(var id in this._markers){result.push(this._markers[id].marker)}return result}};SMap.Layer.Marker.prototype.supportsAnimation=function(){return SMap.TRANSFORM&&this._options.supportsAnimation};SMap.Layer.Marker.prototype.zoomTo=function(zoom,fixedPoint){if(!this._active){return}var map=this.getMap();var diff=zoom-this.getMap().getZoom();var scale=Math.pow(2,diff);var offset=map.getOffset();var shift=fixedPoint.clone().minus(offset).scale(1-scale);var t="translate("+shift.x+"px, "+shift.y+"px) scale("+scale+","+scale+")";this._dom.container[SMap.LAYER_MARKER].style[SMap.TRANSFORM]=t};SMap.Layer.Marker.prototype.fillFromData=function(dataSets){var newArr=[];var reuse={};if(!(dataSets instanceof Array)){dataSets=[dataSets]}for(var i=0;i<dataSets.length;i++){var dataSet=dataSets[i];if(dataSet.nodeType){this._fillFromXML(dataSet,newArr,reuse)}else{this._fillFromData(dataSet,newArr,reuse)}}var unusedMarkers=[];if(this._clusterer){var clustererMarkers=this._clusterer.getAllMarkers();for(var i=0;i<clustererMarkers.length;i++){var marker=clustererMarkers[i];if(!(marker.getId()in reuse)){unusedMarkers.push(marker)}}this._clusterer.removeMarker(unusedMarkers)}else{for(var id in this._markers){if(!(id in reuse)){unusedMarkers.push(this._markers[id].marker)}}this._removeMarker(unusedMarkers)}while(unusedMarkers.length){unusedMarkers.pop().$destructor()}this.addMarker(newArr)};SMap.Layer.Marker.prototype._fillFromXML=function(xmlDoc,newArr,reuse){var idToMarker={};if(this._clusterer){var all=this._clusterer.getAllMarkers();for(var i=0;i<all.length;i++){var marker=all[i];idToMarker[marker.getId()]=marker}}else{idToMarker=this._markers}var pois=xmlDoc.getElementsByTagName("poi");for(var j=0;j<pois.length;j++){var node=pois[j];var id=node.getAttribute("source")+node.getAttribute("id");if(id in idToMarker){reuse[id]=true}else{var ctor=SMap.LOOKUP_MARKER[node.getAttribute("source")]||SMap.Marker;newArr.push(ctor.fromXML(node))}}};SMap.Layer.Marker.prototype._fillFromData=function(data,newArr,reuse){var idToMarker={};if(this._clusterer){var all=this._clusterer.getAllMarkers();for(var i=0;i<all.length;i++){var marker=all[i];idToMarker[marker.getId()]=marker}}else{idToMarker=this._markers}var pois=data.poi||[];for(var j=0;j<pois.length;j++){var poi=pois[j];if(poi.geom){continue}var id=poi.source+poi.id;if(id in idToMarker){reuse[id]=true}else{var marker;if(poi.url2x){marker=SMap.WMMarker.fromPOI(poi,null,{type:poi.paid?SMap.WMMarker.TYPES.PAID:SMap.WMMarker.TYPES.POI})}else{var ctor=SMap.LOOKUP_MARKER[poi.source]||SMap.Marker;marker=ctor.fromData(poi)}if(this._options.poiTooltip){var cont=marker.getContainer()[SMap.LAYER_MARKER];cont.title=poi.title}newAoptions){this._repositionOptions=options;this._reposition()};SMap.Layer.Marker.prototype._reposition=function(){var options=this._repositionOptions;if(!options){return}var m={};for(var id in this._markers){if(!this._markers[id].appended){continue}m[id]=this._markers[id].pos}SMap.Marker.Repositioner.getInstance().go(m,this._markers,options);for(var id in m){var marker=this._markers[id];var pos=m[id];if(pos.x===null){this._unlink(marker);continue}marker.pos=pos;var c=marker.marker.getContainer();for(var p in c){c[p].style.left=pos.x+"px";c[p].style.top=pos.y+"px"}}};SMap.Layer.Marker.prototype.redraw=function(full){if(!this._active){return}if(SMap.TRANSFORM){this._dom.container[SMap.LAYER_MARKER].style[SMap.TRANSFORM]="none"}if(full&&this._clusterer){this.clear();this._markers={};this._clusterer.compute();this._addMarker(this._clusterer.getClusters());this._addMarker(this._clusterer.getMarkers())}var half=this.getMap().getSize().clone().scale(.5);var offset=this.getMap().getOffset();var w=half.x;var h=half.y;for(var id in this._markers){var obj=this._markers[id];var pos=obj.marker.getCoords().toPixel(this.getMap());var dx=Math.abs(pos.x);var dy=Math.abs(pos.y);var visible=!(dx>w+this._options.prefetch||dy>h+this._options.prefetch);if(visible&&(!obj.appended||full)){this.positionMarker(obj.marker)}if(!visible&&obj.appended){this._unlink(obj)}else if(visible&&!obj.appended){this._append(obj)}}this._reposition()};SMap.Layer.Marker.prototype.positionMarker=function(marker){if(!this._active){return}var map=this.getMap();if(!map){return}var pos=marker.getCoords().toPixel(map);pos.minus(this.getMap().getOffset());var a=marker.getAnchor();if("left"in a&&(typeof a.left=="number"||a.left)){var propx="left";pos.x=pos.x-parseFloat(a.left)}else{var propx="right";pos.x=-pos.x-parseFloat(a.right)}if("top"in a&&(typeof a.top=="number"||a.top)){var propy="top";pos.y=pos.y-parseFloat(a.top)}else{var propy="bottom";pos.y=-pos.y-parseFloat(a.bottom)}var obj=this._markers[marker.getId()];obj.pos=pos;if(!obj.appended){this._append(obj)}var c=marker.getContainer();for(var p in c){c[p].style["left"]="";c[p].style["right"]="";c[p].style["top"]="";c[p].style["bottom"]="";c[p].style[propx]=pos.x+"px";c[p].style[propy]=pos.y+"px"}};SMap.Layer.Marker.prototype.clear=function(){for(var p in this._dom.container){JAK.DOM.clear(this._dom.container[p])}for(var id in this._markers){this._markers[id].appended=false}};SMap.Layer.Marker.prototype._addMarker=function(marker){var m=marker instanceof Array?marker:[marker];for(var j=0;j<m.length;j++){var item=m[j];var obj={appended:false,marker:item,pos:null};this._markers[item.getId()]=obj;item.setOwner(this)}};SMap.Layer.Marker.prototype._removeMarker=function(marker){var m=marker instanceof Array?marker:[marker];for(var i=0;i<m.length;i++){var item=m[i];var id=item.getId();if(!(id in this._markers)){return}if(this._markers[id].appended){this._unlink(this._markers[id])}item.setOwner(null);delete this._markers[id]}};SMap.Layer.Marker.prototype._append=function(obj){var marker=obj.marker;var c=marker.getContainer();for(var p in c){if(!(p in this._dom.container)){throw new Error("Cannot append marker component to layer")}var node=c[p];node.style.position="absolute";this._dom.container[p].appendChild(node)}obj.appended=true};SMap.Layer.Marker.prototype._unlink=function(obj){var c=obj.marker.getContainer();for(var p in c){var elm=c[p];elm.parentNode.removeChild(elm)}obj.appended=false};SMap.Layer.Marker.prototype._build=function(){this._dom.container[SMap.LAYER_SHADOW]=JAK.mel("div",{id:this._id+"-"+SMap.LAYER_SHADOW});this._dom.container[SMap.LAYER_MARKER]=JAK.mel("div",{id:this._id+"-"+SMap.LAYER_MARKER});this._dom.container[SMap.LAYER_ACTIVE]=JAK.mel("div",{id:this._id+"-"+SMap.LAYER_ACTIVE});this._ec.push(JAK.Events.addListener(this._dom.container[SMap.LAYER_ACTIVE],"click",this,"_click"));this._ec.push(JAK.Events.addListener(this._dom.container[SMap.LAYER_MARKER],"click",this,"_click"));this._ec.push(JAK.Events.addListener(this._dom.container[SMap.LAYER_ACTIVE],"mousedown",this,"_mouseDown"));this._ec.push(JAK.Events.addListener(this._dom.container[SMap.LAYER_MARKER],"mousedown",this,"_mouseDown"))};SMap.Layer.Marker.prototype._mouseDown=function(e,elm){this._eventCoords=new SMap.Pixel(e.clientX,e.clientY)};SMap.Layer.Marker.prototype._click=function(e,elm){if(!this._eventCoords){return}var coords=new SMap.Pixel(e.clientX,e.clientY);if(coords.distance(this._eventCoords)>1.5){e.preventDefault();return}var t=JAK.Events.getTarget(e);var tops=[];for(var p in this._dom.container){tops.push(this._dom.container[p])}for(var id in this._markers){var m=this._markers[id].marker;var node=t;var a=m.getActive();do{if(node==a){m.click(e,elm);return}node=node.parentNode}while(tops.indexOf(node)==-1)}};SMap.Layer.Geometry=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.Geometry",VERSION:"1.0",EXTEND:SMap.Layer});SMap.Layer.Geometry.prototype.$constructor=function(id,options){this._ec=[];this._canvas=null;this.$super(id);this._options={supportsAnimation:false};for(var p in options){this._options[p]=options[p]}this._eventCoords=null;this._geometries={}};SMap.Layer.Geometry.prototype.$destructor=function(){this.clear();this._geometries={};this._canvas.$destructor();thon(){return SMap.TRANSFORM&&this._options.supportsAnimation};SMap.Layer.Geometry.prototype.zoomTo=function(zoom,fixedPoint){if(!this._active){return}var map=this.getMap();var diff=zoom-this.getMap().getZoom();var scale=Math.pow(2,diff);var size=map.getSize().clone().scale(.5);var shift=fixedPoint.clone().plus(size).scale(1-scale);var t="translate("+shift.x+"px, "+shift.y+"px) scale("+scale+","+scale+")";this._dom.container[SMap.LAYER_GEOMETRY].style[SMap.TRANSFORM]=t};SMap.Layer.Geometry.prototype.addGeometry=function(geometry){this._addGeometry(geometry);if(this._active){var size=this.getMap().getSize().clone().scale(.5);geometry.draw(this._canvas,size)}return geometry};SMap.Layer.Geometry.prototype.removeGeometry=function(geometry){if(!(geometry.getId()in this._geometries)){throw new Error("Cannot remove geometry "+geometry.getId())}geometry.clear();geometry.setOwner(null);delete this._geometries[geometry.getId()]};SMap.Layer.Geometry.prototype.getGeometries=function(){r(var id in this._geometries){this._geometries[id].clear()}};SMap.Layer.Geometry.prototype.removeAll=function(){var list=[];for(var id in this._geometries){list.push(this._geometries[id])}while(list.length){this.removeGeometry(list.shift())}};SMap.Layer.Geometry.prototype.fillFromData=function(dataSets){var newArr=[];if(!(dataSets instanceof Array)){dataSets=[dataSets]}for(var i=0;i<dataSets.length;i++){var dataSet=dataSets[i];if(dataSet.nodeType){this._fillFromXML(dataSet,newArr)}else{this._fillFromData(dataSet,newArr)}}newArr.sort(function(a,b){var ap=a.isPoint();var bp=b.isPoint();if(ap==bp){return 0}return ap?-1:1});this.removeAll();while(newArr.length){this._addGeometry(newArr.pop())}this.redraw()};SMap.Layer.Geometry.prototype._fillFromXML=function(xmlDoc,newArr){var geometries=xmlDoc.getElementsByTagName("geometry");for(var j=0;j<geometries.length;j++){var node=geometries[j];var ctor=SMap.LOOKUP_GEOMETRY[node.getAttribute("source")]||SMap.Geometry.Multi;newArr.push(ctor.fromXML(node))}};SMap.Layer.Geometry.prototype._fillFromData=function(data,newArr){var pois=data.poi||[];for(var j=0;j<pois.length;j++){var poi=pois[j];if(!poi.geom){continue}var ctor=SMap.LOOKUP_GEOMETRY[poi.source]||SMap.Geometry.Multi;newArr.push(ctor.fromData(poi))}};SMap.Layer.Geometry.prototype.redraw=function(full){if(!this._active){return}this.clear();if(SMap.TRANSFORM){this._dom.container[SMap.LAYER_GEOMETRY].style[SMap.TRANSFORM]="scale(1)"}var size=this.getMap().getSize();var half=new SMap.Pixel(Math.round(size.x/2),Math.round(size.y/2));for(var id in this._geometries){this._geometries[id].draw(this._canvas,half)}};SMap.Layer.Geometry.prototype.redrawGeometry=function(g){if(!this._active){return}var size=this.getMap().getSize();var half=new SMap.Pixel(Math.round(size.x/2),Math.round(size.y/2));g.clear();g.draw(this._canvas,half)};SMap.Layer.Geometry.prototype._addGeometry=function(geometry){var id=geometry.getId();if(this._geometries[id]){this.removeGeometry(this._geometries[id])}this._geometries[geometry.getId()]=geometry;geometry.setOwner(this)};SMap.Layer.Geometry.prototype._build=function(){this._canvas=JAK.Vector.getCanvas(1,1);var group=this._canvas.group();group.id=this._id+"-"+SMap.LAYER_GEOMETRY;this._ec.push(JAK.Events.addListener(group,"click",this,"_click"));this._ec.push(JAK.Events.addListener(group,"mousedown",this,"_mouseDown"));this._dom.container[SMap.LAYER_GEOMETRY]=group;this._canvas.setContent(group)};SMap.Layer.Geometry.prototype._mouseDown=function(e,elm){this._eventCoords=new SMap.Pixel(e.clientX,e.clientY)};SMap.Layer.Geometry.prototype._click=function(e,elm){if(!this._eventCoords){return}var coords=new SMap.Pixel(e.clientX,e.clientY);if(coords.distance(this._eventCoords)>1.5){return}var t=JAK.Events.getTarget(e);for(var id in this._geometries){var nodes=this._geometries[id].getNodes();if(nodes.indexOf(t)!=-1){this._geometries[id].click(e,elm);return}}};SMap.Layer.Vector=SMap.Layer.Geometry;SMap.Layer.Vector.prototype.addCircle=function(center,point,options){return this._addItem(SMap.GEOMETRY_CIRCLE,[center,point],options)};SMap.Layer.Vector.prototype.addPath=function(data,options){return this._addItem(SMap.GEOMETRY_PATH,data,options)};SMap.Layer.Vector.prototype.removePolyline=function(item){this.removeGeometry(item)};SMap.Layer.Vector.prototype.removePolygon=function(item){this.removeGeometry(item)};SMap.Layer.Vector.prototype.removeCircle=function(item){this.ototype.removePath=function(item){this.removeGeometry(item)};SMap.Layer.Vector.prototype.addPolyline=function(coords,options){return this._addItem(SMap.GEOMETRY_POLY{return this._addItem(SMap.GEOMETRY_POLYGON,coords,options)};SMap.Layer.Vector.prototype.addVector=function(){return this.addGeometry.appfunction(){return this.removeGeometry.apply(this,arguments)};SMap.Layer.Vector.prototype._addItem=function(type,coords,options){var v=new SMap.Geometry(type,null,coords,options);return this.addGeometry(v)};SMap.Layer.Winter=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.Winter",VERSION:"1.0",EXTEND:SMap.Layer.Multi});SMap.Layer.Winter.prototype.$constructor=function(id){this.$super(id);this._winterConfig=SMap.CONFIG[SMap.DEF_TURIST_WINTER];var lang=SMap.lang;var downOptions={};var upOptions={};if(this._winterConfig.langs){var tileLang="";if(lang in this._winterConfig.langs&&lang!="cs"&&lang!="sk"){tileLang=lang}else if(lang!="cs"&&lang!="sk"&&"en"in this._winterConfig.langs){tileLang="en"}if(tileLang){this._winterConfig.downUrl=this._winterConfig.langs[tileLang].downUrl||this._winterConfig.downUrl;this._winterConfig.upUrl=this._winterConfig.langs[tileLang].upUrl||this._winterConfig.upUrl}}this._addTileLayer("down",this._winterConfig.downUrl,downOptions);this._addTileLayer("up",this._winterConfig.upUrl,upOptions)};SMap.Layer.Winter.prototype._addTileLayer=function(id,url,options){var layer=new SMap.Layer.Tile("winter-"+id,url,options);layer.setCopyright(this._winterConfig.copyright);this.adr.Winter.prototype.supportsAnimation=function(){return true};SMap.Layer.Winter.prototype.zoomTo=function(zoom,fixedPoint){for(var i=0,max=this._layers.length;i<max;i++){this._layers[i].zoomTo(zoom,fixedPoint)}};SMap.Geometry=JAK.ClassMaker.makeClass({NAME:"SMap.Geometry",VERSION:"1.0",IMPLEMENT:[SMap.IOwned,JAK.IDecorable]});SMap.Geometry.prototype.DEFAULT_OPTIONS={};SMap.Geometry.prototype.DEFAULT_OPTIONS[SMap.GEOMETRY_POLYLINE]={color:"red",opacity:.65,width:5,outlineColor:"white",outlineWidth:3,outlineOpacity:.6};SMap.Geometry.prototype.DEFAULT_OPTIONS[SMap.GEOMETRY_PATH]=SMap.Geometry.prototype.DEFAULT_OPTIONS[SMap.GEOMETRY_POLYLINE];SMap.Geometry.prototype.DEFAULT_OPTIONS[SMap.GEOMETRY_POLYGON]={color:"red",opacity:.2,outlineColor:"red",outlineWidth:2,outlineOpacity:.55};SMap.Geometry.prototype.DEFAULT_OPTIONS[SMap.GEOMETRY_CIRCLE]={color:"red",opacity:.65,width:8,outlineColor:"white",outlineWidth:2,outlineOpacity:.6};SMap.Geometry.prototype.DEFAULT_OPTIONS[SMap.GEOMETRY_ELLIPSE]=SMap.Geometry.prototype.DEFAULT_OPTIONS[SMap.GEOMETRY_CIRCLE];SMap.Geometry.WKTToGeometries=function(wkt,options){var shape=wkt.match(/^[\s]*([\w]+)[\s]*\((.+)\)[\s]*$/);if(!shape){return[]}function getCoords(str){var rgx=str.match(/(([\d]+[\.]*[\d]*)[\s]+([\d]+[\.]*[\d]*))/gi);return rgx?rgx.map(function(coord){var tmp=coord.match(/(([\d]+[\.]*[\d]*)[\s]+([\d]+[\.]*[\d]*))/);if(tmp&&tmp.length==4){try{var coords=new SMap.Coords(parseFloat(tmp[2]),parseF){return null}}}).filter(function(coord){return coord!=null}):[]}function poly(params,geom){var parts=params.match(/(\([^\(\)]+\))/gi);if(!parts){return[]}return parts.map(function(part){var coords=getCoords(part);return new SMap.Geometry(geom,null,coords,options)})}switch(shape[1].toLowerCase()){case"point":case"multipoint":var coords=getCoords(shape[2]);return coords.map(function(coord){return new SMap.Geometry(SMap.GEOMETRY_CIRCLE,null,[coord,4],options)});break;case"multilinestring":case"linestring":return poly(wkt,SMap.GEOMETRY_POLYLINE);break;case"polygon":case"multipolygon":return poly(wkt,SMap.GEOMETRY_POLYGON);break}return[]};SMap.Geometry.prototype.$constructor=function(type,id,coords,options){this._owner=null;this._type=type;this._id=id||Math.random();this._coords=coords;this._pixels=[];this._bbox={min:null,max:null};this._options={minDist:3};for(var p in this.DEFAULT_OPTIONS[type]){this._options[p]=this.DEFAULT_OPTIONS[type][p]}for(var p in options){this._options[p]=optionsototype.$destructor=function(){this.clear();this._coords=[]};SMap.Geometry.prototype.getId=function(){return this._id};SMap.Geometry.prototype.getType=function(){return this._type};SMap.Geometry.prototype.getCoords=function(){return this._coords};SMap.Geometry.prototype.getPixels=function(){return this._pixels};SMap.Geometry.prototype.getOptions=function(){return this._options};SMap.Geometry.prototype.setOptions=function(options){for(var p in options){this._options[p]=options[p]}if(this._instance){this._instance.nction(){return this._instance?this._instance.getNodes():[]};SMap.Geometry.prototype.click=function(e,elm){this.getMap().getSignals().makeEvent("geometry-click",this,{event:e})};SMap.Geometry.prototype.clear=function(){if(this._instance){this._instance.$destructor();this._instance=null}this._bbox={min:null,max:null}};SMap.Geometry.prototype.draw=function(canvas,offset){var data=this._convertCoords(this._coords,offset);switch(this._type){case SMap.GEOMETRY_POLYLINE:case SMap.GEOMETRY_POLYGON:var constructors={};constructors[SMap.GEOMETRY_POLYLINE]=JAK.Vector.Line;constructors[SMap.GEOMETRY_POLYGON]=JAK.Vector.Polygon;var ctor=constructors[this._type];var coords=[];for(var j=0;j<data.length;j++){coords.push(new JAK.Vec2d(data[j].x,data[j].y))}this._instance=new ctor(canvas,coords,this._options);break;case SMap.GEOMETRY_CIRCLE:var center=new JAK.Vec2d(data[0].x,data[0].y);var radius=null;if(data[1]instanceof SMap.Pixel){radius=data[0].clone().minus(data[1]);radius=Math.sqrt(radius.x*radius.x+radius.y*radius.y)}else{radius=data[1]}this._instance=new JAK.Vector.Circle(canvas,center,radius,this._options);break;case SMap.GEOMETRY_ELLIPSE:var center=new JAK.Vec2d(data[0].x,data[0].y);var radius=[];for(var i=1;i<3;i++){if(data[i]instanceof SMap.Pixel){var r=data[0].clone().minus(data[i]);radius.push(Math.sqrt(r.x*r.x+r.y*r.y))}else{radius.push(data[i])}}this._instance=new JAK.Vector.Ellipse(canvas,center,radius,this._options);break;case SMap.GEOMETRY_PATH:var arr=[];for(var j=0;j<data.length;j++){var part=data[j];if(part instanceof SMap.Pixel){var x=Math.round(part.x);var y=Math.round(part.y);arr.push(x+" "+y)}else if(part instanceof Array){part[0].minus(part[1]);var tmp=part[0].x*part[0].x+part[0].y*part[0].y;arr.push(Math.sqrt(tmp))}else{arr.push(part)}}var format=arr.join(" ");this._instance=new JAK.Vector.Path(canvas,format,this._options);break}};SMap.Geometry.prototype.setCoords=function(coords){this._coords=coords;if(this._owner){this._owner.redrawGeometry(this)}};SMap.Geometry.prototype.computeCenterZoom=function(map,usePadding){var coords=[];for(var i=0;i<this._coords.length;i++){var item=this._coords[i];if(!(item instanceof Array)){item=[item]}for(var j=0;j<item.length;j++){var c=item[j];if(!(c instanceof SMap.Coords)){continue}coords.push(c)}}return map.computeCenterZoom(coords,usePadding)};SMap.Geometry.prototype.countBBox=function(){var minX=Infinity;var minY=Infinity;var maxX=-Infinity;var maxY=-Infinity;for(var i=0;i<this._coords.length;i++){var coor=this._coords[i];minX=Math.min(coor.x,minX);minY=Math.min(coor.y,minY);maxX=Math.max(coor.x,maxX);maxY=Math.max(coor.y,maxY)}this._bbox.min=SMap.Coords.fromWGS84(minX,minY);this._bbox.max=SMap.Coords.fromWGS84(maxX,maxY)};SMap.Geometry.prototype.getBBox=function(){var output={x:0,y:0,width:0,height:0};if(this._bbox.min&&this._bbox.max){var map=this.getMap();var minBB=this._bbox.min.toPixel(map);var maxBB=this._bbox.max.toPixel(map);var size=map.getSize();output.x=Math.round(Math.min(minBB.x,maxBB.x)+size.x/2);output.y=Math.round(Math.min(minBB.y,maxBB.y)+size.y/2);output.width=Math.round(Math.abs(maxBB.x-minBB.x));output.height=Math.round(Math.abs(maxBB.y-minBB.y))}return output};SMap.Geometry.prototype.isGeometryVisible=function(){var state=false;var map=this.getMap();var canvas=map.getGeometryCanvas().canvas;var mapSize=map.getSize();if(canvas&&"createSVGRect"in canvas&&"checkIntersection"in canvas){var rect=canvas.createSVGRect();rect.x=0;rect.y=0;rect.width=mapSize.x;rect.height=mapSize.y;var nodes=this.getNodes();for(var i=0;i<nodes.length;i++){if(canvas.checkIntersection(nodes[i],rect)){state=true;break}}}else{var bbox=this.getBBox();var mapArea={x:0,y:0,width:mapSize.x,height:mapSize.y};if(this._isIntersection(mapArea,bbox)){state=true}}return state};SMap.Geometry.prototype._isIntersection=function(bbox1,bbox2){var ltx=Math.max(bbox1.x,bbox2.x);var lty=Math.max(bbox1.y,bbox2.y);var rbx=Math.min(bbox1.x+bbox1.width,bbox2.x+bbox2.width);var rby=Math.min(bbox1.y+bbox1.height,bbox2.y+bbox2.height);var width=Math.abs(rbx-ltx);var height=Math.abs(rby-lty);if(ltx<=rbx&&lty<=rby&&width*height>0){return true}else{return false}};SMap.Geometry.prototype._convertCoords=function(coords,offset){var minDist=this._options.minDist;var map=this.getMap();this._pixels=[];var result=[];var last=null;for(var i=0;i<coords.length;i++){var item=coords[i];if(item instanceof SMap.Coords){item=item.toPixel(map);if(last&&last.distance(item)<=minDist&&this._type!=SMap.GEOMETRY_ELLIPSE&&this._type!=SMap.GEOMETRY_CIRCLE){if(this._type==SMap.GEOMETRY_PATH){var index=result.length-1;while(index&&typeof result[index]!="string"){index--}result.splice(index)}continue}last=item.clone();this._pixels.push(last);item.plus(offset)}else if(item instanceof Array){last=null;var arr=[];for(var j=0;j<item.length;j++){arr.push(item[j].toPixel(map).plus(offset))}item=arr}result.push(item)}return result};SMap.Vector=SMap.Geometry;SMap.Geometry.Feature=JAK.ClassMaker.makeStatic({NAME:"SMap.Geometry.Feature"});SMap.Geometry.Feature.Card=JAK.ClassMaker.makeSingleton({NAME:"SMap.Geometry.Feature.Card",VERSION:"1.0",EXTEND:JAK.AbstractDecorator});SMap.Geometry.Feature.Card.prototype.decorate=function(geometry,card){this.$super(geometry);geometry._card=card;geometry._setCursor=this._setCursor;geometry.click=this.click;geometry.draw=this.draw;geometry._setCursor();return geometry};SMap.Geometry.Feature.Card.prototype.click=function(e,elm){this.$super(e,elm);this.getMap().addCard(this._card,SMap.Coords.fromEvent(canvas,offset){this.$super(canvas,offset);this._setCursor()};SMap.Geometry.Feature.Card.prototype._setCursor=function(){var nodes=this.getNodes();for(var i=0;i<nodes.length;i++){nodes[i].style.cursor="pointer"}};SMap.Geometry.Multi=JAK.ClassMaker.makeClass({NAME:"SMap.Geometry.Multi",VERSION:"1.0",EXTEND:SMap.Geometry});SMap.Geometry.Multi.fromXML=function(node){var options=this._optionsFromXML(node);var result=new this(node.getAttribute("source")+node.getAttribute("id"),options);result.setSource(node.getAttribute("source"));result.setPlainId(node.getAttribute("id"));var children=JAK.XML.childElements(node);for(var i=0;i<children.length;i++){var child=children[i];var g=this._geometryFromXML(child,options);result.addGeometry(g)}return result};SMap.Geometry.Multi.fromData=function(data){var options=this._optionsFromData(data);var result=new this(data.source+data.id,options);result.setSource(data.source);result.setPlainId(data.id);var geometries=this._geometryFromData(data,options);if(!(geometries instanceof Array)){geometries=[geometries]}while(geometries.length){result.addGeometry(geometries.shift())}return result};SMap.Geometry.Multi._optionsFromXML=function(node){var options={};var title=node.getAttribute("title");if(title){options.title=title}var color=node.getAttribute("color");if(color){options.color=color}var opacity=node.getAttribute("opacity");if(opacity){options.opacity=parseFloat(opacity)}var width=node.getAttribute("width");if(width){options.width=parseFloat(width)}var style=node.getAttribute("style");if(style){options.style=parseInt(style)}var exactStyle=node.getAttribute("exactStyle");if(exactStyle){options.exactStyle=exactStyle}var outlineColor=node.getAttribute("outlineColor");if(outlineColor){options.outlineColor=outlineColor}var outlineOpacity=node.getAttribute("outlineOpacity");if(outlineOpacity){options.outlineOpacity=parseFloat(outlineOpacity)}var outlineWidth=node.getAttribute("outlineWidth");if(outlineWidth){options.outlineWidth=parseFloat(outlineWidth)}var outlineStyle=node.getAttribute("outlineStyle");if(outlineStyle){options.outlineStyle=parseInt(outlineStyle)}var outlineExactStyle=node.getAttribute("outlineExactStyle");if(outlineExactStyle){options.outlineExactStyle=outlineExactStyle}return options};SMap.Geometry.Multi._optionsFromData=function(data){var geom=data.geom;var result={title:data.title};for(var p in geom.style){if(p.match(/width|opacity/i)){result[p]=parseFloat(geom.style[p])}else{result[p]=geom.style[p]}}return result};SMap.Geometry.Multi._geometryFromXML=function(node,options){switch(node.nodeName.toLowerCase()){case"polygon":var coords=this._coordsFromXML(node);return new SMap.Geometry(SMap.GEOMETRY_POLYGON,null,coords,options);break;case"linestring":var coords=this._coordsFromXML(node);return new SMap.Geometry(SMap.GEOMETRY_POLYLINE,null,coords,options);break;case"circle":var point=node.getElementsByTagName("point")[0];var center=SMap.Coords.fromWGS84(point.getAttribute("x"),point.getAttribute("y"));return new SMap.Geometry(SMap.GEOMETRY_CIRCLE,null,[center,options.width||5],options);break;default:throw new Error("Unknown sub-geometry '"+node.nodeName+"'");break}};SMap.Geometry.Multi._geometryFromData=function(data,options){var geom=data.geom;switch(geom.type){case"linestring":case"multilinestring":var result=[];for(var i=0;i<geom.data.length;i++){var coords=SMap.Coords.stringToCoords(geom.data[i]);result.push(new SMap.Geometry(SMap.GEOMETRY_POLYLINE,null,coords,options))}return result;break;case"polygon":case"multipolygon":var result=[];for(var i=0;i<geom.data.length;i++){var coords=SMap.Coords.stringToCoords(geom.data[i]);result.push(new SMap.Geometry(SMap.GEOMETRY_POLYGON,null,coords,options))}return result;break;case"point":var center=SMap.Coords.stringToCoords(geom.data[0])[0];return new SMap.Geometry(SMap.GEOMETRY_CIRCLE,null,[center,options.width||5],options);break;default:throw new Error("Unknown geometry '"+geom.type+"'");break}};SMap.Geometry.Multi._coordsFromXML=function(node){var result=[];var points=node.getElementsByTagName("point");for(var i=0;i<points.length;i++){var point=points[i];var c=SMap.Coords.fromWGS84(point.getAttribute("x"),point.getAttribute("y"));result.push(c)}return result};SMap.Geometry.Multi.prototype.$constructor=function(id,options){this.$super(null,id,[],options);this._geometries=[];this._source=null;this._plainId=null};SMap.Geometry.Multi.prototype.$destructor=function(){while(this._geometries.length){this._geometries.popGeometry=function(geometry){this._geometries.push(geometry)};SMap.Geometry.Multi.prototype.getGeometries=function(){i<this._geometries.length;i++){thisetries.length;i++){this._geometries[i].draw(canvas,offset)}};SMap.Geometry.Multi.prototype.setOwner=function(owner){this.$super(owner);for(var i=0;i<this._geometries.length;i++){this._geometries[i].setOwner(owner)}};SMap.Geometry.Multi.prototype.computeCenterZoom=function(map,usePadding){var coords=[];for(var i=0;i<this._geometries.length;i++){var gc=this._geometries[i].getCoords();for(var j=0;j<gc.length;j++){var c=gc[j];if(!(c instanceof Array)){c=[c]}for(var k=0;k<c.length;k++){if(c[k]instanceof SMap.Coords){coords.push(c[k])}}}}return map.computeCenterZoom(coords,usePadding)};SMap.Geometry.Multi.prototype.isArea=function(){for(var i=0;i<this._geometries.length;i++){if(this._geometries[i].getType()==SMap.GEOMETRY_POLYGON){return true}}return false};SMap.Geometry.Multi.prototype.isPoint=function(){for(var i=0;i<this._geometries.length;i++){if(this._geometries[i].getType()!=SMap.GEOMETRY_CIRCLE){return false}}return true};SMap.Geometry.Multi.prototype.setSource=function(source){this._source=source};SMap.Geometry.Multi.prototype.getSource=function(){rrototype.setPlainId=function(plainId){this._plainId=plainId};SMap.Geometry.Multi.prototype.getPlainId=function(){return this._plainId};SMap.Geometry.Multi.prototype.getNodes=function(){var nodes=[];for(var i=0;i<this._geometries.length;i++){nodes=nodes.concat(this._geometries[i].getNodes())}return nodes};SMap.Geometry.Multi.prototype.click=function(e,elm){this.getMap().getSignals().makeEvent("geometry-multi-click",this,{event:e})};SMap.Geometry.Multi.prototype.countBBox=function(){var minX=Infinity;var minY=Infinity;var maxX=-Infinity;var maxY=-Infinity;var count=0;for(var i=0;i<this._geometries.length;i++){var geomCoords=this._geometries[i].getCoords();count+=geomCoords.length;for(var j=0;j<geomCoords.length;j++){minX=Math.min(geomCoords[j].x,minX);minY=Math.min(geomCoords[j].y,minY);maxX=Math.max(geomCoords[j].x,maxX);maxY=Math.max(geomCoords[j].y,maxY)}}if(count){this._bbox.min=SMap.Coords.fromWGS84(minX,minY);this._bbox.max=SMap.Coords.fromWGS84(maxX,maxY)}};SMap.Geometry.Smart=JAK.ClassMaker.makeClass({NAME:"SMap.Geometry.Smart",VERSION:"1.0",EXTEND:SMap.Geometry.Multi});SMap.Geometry.Smart.prototype.$constructor=function(type,id,coords,options){this._owner=null;this._type=type;this._source=null;this._plainId=null;this._id=id||Math.random();this._coords=coords;this._pixels=[];this._geometries=[];this._visibleInterval=[];this._pixelsData={pixels:[],zoom:0,sizeKey:"",fullPixels:[]};this._bbox={min:null,max:null};this._options={minDist:3};for(var p in this.DEFAULT_OPTIONS[type]){this._options[p]=this.DEFAULT_OPTIONS[type][p]}for(var p in options){this._options[p]=options[p]}};SMap.Geometry.Smart.prototype.draw=function(canvas,offset){this._convertCoords();for(var i=0;i<this._geometries.length;i++){this._geometries[i].draw(canvas,offset)}};SMap.Geometry.Smart.prototype.click=function(e,elm){this.getMap().getSignals().makeEvent("geometry-click",this,{event:e})};SMap.Geometry.Smart.prototype.getVisibleFracInterval=function(){return this._visibleInterval};SMap.Geometry.Smart.prototype._convertCoords=function(coords,offset){var map=this.getMap();if(!map){return}var size=map.getSize();var sizeKey=size.x+"|"+size.y;var center=map.getCenter();var zoom=map.getZoom();var posKey=center.x+"|"+center.y+"|"+zoom;var minDist=this._options.minDist;var offset=offset||size.clone().scale(.5);var rb=offset.clone();var lt=rb.clone().scale(-1);var result=[];var pixels=[];var coords=[];var fullPixels=[];var total=0;this._visibleInterval=[];var geometriesNum=-1;while(this._geometries.length){this._geometries.pop().$destructor()}var coordsArray=this._coords[0]instanceof SMap.Coords?[this._coords]:this._coords;coordsArray.forEach(function(c){var prev=null;var prevInMap=false;var nextInMap=false;var firstInMap=false;var lastInMap=false;if(geometriesNum<0||geometriesNum>=0&&pixels[geometriesNum].length){geometriesNum++;pixels[geometriesNum]=[];coords[geometriesNum]=[]}if(c.length>100){var startIndex=geometriesNum;var endIndex=geometriesNum;for(var i=0;i<c.length;i++){var itemC=c[i];var inMap=true;nextInMap=false;var item=itemC;if(itemC instanceof SMap.Coords){item=itemC.toPixel(map);var nextItem=i+1<=c.length-1?c[i+1].toPixel(map):null;var lastDistance=prev?prev.distance(item):0;if(!(item.x>=lt.x&&item.x<=rb.x&&item.y>=lt.y&&item.y<=rb.y)){inMap=prevInMap?true:false;prevInMap=false}else{prevInMap=true}if(!inMap&&nextItem&&nextItem.x>=lt.x&&nextItem.x<=rb.x&&nextItem.y>=lt.y&&nextItem.y<=rb.y){inMap=true;prevInMap=true;nextInMap=true;if(pixels[geometriesNum].length){geometriesNum++;pixels[geometriesNum]=[];coords[geometriesNum]=[]}}if(!(inMap&&!prevInMap)&&!nextInMap&&prev&&lastDistance<=minDist&&this._type!=SMap.GEOMETRY_ELLIPSE&&this._type!=SMap.GEOMETRY_CIRCLE){if(this._type==SMap.GEOMETRY_PATH){var index=result.length-1;while(index&&typeof result[index]!="string"){index--}result.splice(index)}continue}total+=lastDistance;prev=item.clone();if(inMap){pixels[geometriesNum].push(prev);coords[geometriesNum].push(itemC);if(i==0){firstInMap=true}else if(i==c.length-1){lastInMap=true}}fullPixels.push(prev);item.plus(offset)}if(inMap){result.push(item)}endIndex=geometriesNum}if(startIndex!=endIndex&&firstInMap&&lastInMap&&this._type==SMap.GEOMETRY_POLYGON){pixels[startIndex]=pixels.pop().concat(pixels[startIndex]);coords[startIndex]=coords.pop(metriesNum].push(i.toPixel());coords[geometriesNum].push(i)})}}.bind(this));if(!pixels[pixels.length-1].length){pixels.pop();coords.pop()}for(var i=0;i<coords.length;i++){if(pixels[i].length<2){continue}var simplified=SMap.Geometry.Smart.Simplify.simplify(pixels[i],coords[i],.6);var geom=new SMap.Geometry(SMap.GEOMETRY_POLYLINE,null,simplified.coords,this._options);if(this._owner){geom.setOwner(this._owner)}this._geometries.push(geom)}var part=0;for(var i=0;i<fullPixels.length;i++){if(fullPixels[i+1]){part+=fullPixels[i].distance(fullPixels[i+1])}if(pixels[0]==fullPixels[i]||pixels[pixels.length-1]==fullPixels[i]){this._visibleInterval.push(part/total)}}this._pixelsData.sizeKey=sizeKey;this._pixelsData.posKey=posKey;this._pixelsData.pixels=pixels;this._pixelsData.fullPixels=fullPixels};SMap.Geomeion(p1,p2){var dx=p1.x-p2.x,dy=p1.y-p2.y;return dx*dx+dy*dy};SMap.Geometry.Smart.Simplify.getSqSegDist=function(p,p1,p2){var x=p1.x,y=p1.y,dx=p2.x-x,dy=p2.y-y;if(dx!==0||dy!==0){var t=((p.x-x)*dx+(p.y-y)*dy)/(dx*dx+dy*dy);if(t>1){x=p2.x;y=p2.y}else if(t>0){x+=dx*t;y+=dy*t}}dx=p.x-x;dy=p.y-y;return dx*dx+dy*dy};SMap.Geometry.Smart.Simplify.simplifyRadialDist=function(points,coords,sqTolerance){var prevPoint=points[0],newPoints=[prevPoint],newCoords=[coords[0]],point,c;for(var i=1,len=points.length;i<len;i++){point=points[i];c=coords[i];if(SMap.Geometry.Smart.Simplify.getSqDist(point,prevPoint)>sqTolerance){newPoints.push(point);newCoords.push(c);prevPoint=point}}if(prevPoint!==point){newPoints.push(point);newCoords.push(c)}return{points:newPoints,coords:newCoords}};SMap.Geometry.Smart.Simplify.simplifyDPStep=function(points,coords,first,last,sqTolerance,simplified,simplifiedCoords){var maxSqDist=sqTolerance,index;for(var i=first+1;i<last;i++){var sqDist=SMap.Geometry.Smart.Simplify.getSqSegDist(points[i],points[first],points[last]);if(sqDist>maxSqDist){index=i;maxSqDist=sqDist}}if(maxSqDist>sqTolerance){if(index-first>1)SMap.Geometry.Smart.Simplify.simplifyDPStep(points,coords,first,index,sqTolerance,simplified,simplifiedCoords);simplified.push(points[index]);simplifiedCoords.push(coords[index]);if(last-index>1)SMap.Geometry.Smart.Simplify.simplifyDPStep(points,coords,index,last,sqTolerance,simplified,simplifiedCoords)}};SMap.Geometry.Smart.Simplify.simplifyDouglasPeucker=function(points,coords,sqTolerance){var last=points.length-1;var simplified=[points[0]];var simplifiedCoords=[coords[0]];SMap.Geometry.Smart.Simplify.simplifyDPStep(points,coords,0,last,sqTolerance,simplified,simplifiedCoords);simplified.push(points[last]);simplifiedCoords.push(coords[last]);return{points:simplified,coords:simplifiedCoords}};SMap.Geometry.Smart.Simplify.simplify=function(points,coords,tolerance,highestQuality){if(points.length<=2)return{points:points,coords:coords};var sqTolerance=tolerance!==undefined?tolerance*tolerance:1;points=highestQuality?{points:points,coords:coords}:SMap.Geometry.Smart.Simplify.simplifyRadialDist(points,coords,sqTolerance);points=SMap.Geometry.Smart.Simplify.simplifyDouglasPeucker(points.points,points.coords,sqTolerance);return points};SMap.Marker=JAK.ClassMaker.makeClass({NAME:"SMap.Marker",VERSION:"1.0",IMPLEMENT:[SMap.IOwned,JAK.IDecorable]});SMap.Marker._image=JAK.mel("img");SMap.Marker.fromXML=function(node){var options={title:node.getAttribute("title")};var url=node.getAttribute("url");if(url){options.url=url}var anchor=node.getElementsByTagName("anchor");if(anchor.length){anchor=anchor[0];var a={};for(var i=0;i<anchor.attributes.length;i++){var attr=anchor.attributes[i];a[attr.nodeName]=parseInt(attr.nodeValue)}options.anchor=a}var coords=SMap.Coords.fromWGS84(parseFloat(node.getAttribute("x")),parseFloat(node.getAttribute("y")));return new this(coords,node.getAttribute("source")+node.getAttribute("id"),options)};SMap.Marker.fromData=function(data){var options={title:data.title};if(data.paid){options.paid=data.paid}if(data.url){options.url=data.url}if(data.anchor){options.anchor=data.anchor}if(data.size){options.size=data.size}var coords=SMap.Coords.fromWGS84(data.mark.lon,data.mark.lat);return new this(coords,data.source+data.id,options)};SMap.Marker.prototype.$constructor=function(coords,id,options){this._options={title:"",url:SMap.CONFIG.img+"/marker/drop-red.png",size:null,anchor:{left:11,top:30}};for(var p in options){this._options[p]=options[p]}this._ec={};this._id=id||Math.random();this._owner=false;this._coords=coords;this._dom={container:{},active:null};this._build()};SMap.Marker.prototype.$destructor=function(){for(var p in this._ec){JAK.Events.removeListener(this._ec[p])}this._ec={}};SMap.Marker.prototype.getCoords=function(){return this._coords};SMap.Marker.prototype.getContainer=function(){return this._dom.container};SMap.Marker.prototype.getAnchor=function(){return this._options.anchor};SMap.Marker.prototype.getTitle=functitle};SMap.Marker.prototype.getId=function(){return this._id};SMap.Marker.prototype.getSize=function(){return this._options.size};SMap.Marker.prototype.setURL=function(url){this._dom.container[SMap.LAYER_MARKER].src=url};SMap.Marker.prototype.setCoords=function(coords){this._coords=coords;if(this._owner){this._rker.prototype.getActive=function(){return this._dom.active};SMap.Marker.prototype.click=function(e,elm){var node=this._dom.active;if(node&&node.nodeName.toLowerCase()=="a"&&SMap.Util.linkToNewWindow(e))return;this.getMap().getSignals().makeEvent("marker-click",this,{event:e})};SMap.Marker.prototype._build=function(){if(typeof this._options.url=="string"){var img=SMap.Marker._image.cloneNode(false);img.src=this._options.url;this._dom.container[SMap.LAYER_MARKER]=img}else{this._dom.container[SMap.LAYER_MARKER]=this._options.url}if(this._options.title){this._dom.container[SMap.LAYER_MARKER].title=this._options.title}this._dom.active=this._dom.container[SMap.LAYER_MARKER]};SMap.Marker.Feature=JAK.ClassMaker.makeStatic({NAME:"SMap.Marker.Feature"});SMap.Marker.Feature.ImageMap=JAK.ClassMaker.makeSingleton({NAME:"SMap.Marker.Feature.ImageMap",VERSION:"1.0",EXTEND:JAK.AbstractDecorator});SMap.Marker.Feature.ImageMap.prototype.decorate=function(marker,options){this.$super(marker);var opt={useMap:"",blank:"",width:0,height:0};for(var p in options){opt[p]=options[p]}marker._over=this._over;marker._out=this._out;marker._convertAreaCoords=this._convertAreaCoords;this._buildMap(marker,opt);return marker};SMap.Marker.Feature.ImageMap.prototype._convertAreaCoords=function(coords){var parts=coords.split(",");var min=[Infinity,Infinity];var max=[-Infinity,-Infinity];for(var i=0;i<parts.length;i++){var idx=i&1;var value=parts[i];min[idx]=Math.min(min[idx],value);max[idx]=Math.max(max[idx],value)}for(var i=0;i<parts.length;i++){var idx=i&1;var value=parts[i];value-=min[idx];parts[i]=value}return{parts:parts,min:min,max:max}};SMap.Marker.Feature.ImageMap.prototype._buildMap=function(marker,options){var parent=JAK.mel("div");marker._dom.container[SMap.LAYER_ACTIVE]=parent;if(options.width&&options.height){parent.style.width=options.width+"px";parent.style.height=options.height+"px"}var data=this._convertAreaCoords(options.useMap);var id="m"+marker.getId();var map=JAK.mel("map");if(JAK.Browser.client=="gecko"||JAK.Browser.client=="safari"||JAK.Browser.client=="chrome"){map.name=id}else{map.id=id}parent.appendChild(map);var area=JAK.mel("area",{href:"#",shape:"poly",coords:data.parts.join(","),title:marker._options.title},{cursor:"pointer"});map.appendChild(area);var blank=JAK.mel("img",{},{position:"absolute",left:data.min[0]+"px",top:data.min[1]+"px",border:"none"});blank.useMap="#"+id;blank.src=options.blank;blank.width=data.max[0]-data.min[0]+1;blank.height=data.max[1]-data.min[1]+1;parent.appendChild(blank);if(JAK.Browser.client=="ie"){marker._ec._im_ie_blur=JAK.Events.addListener(area,"click",this,"_blur");marker._ec._im_ie_over=JAK.Events.addListener(area,"mouseover",marker,"_over");marker._ec._im_ie_out=JAK.Events.addListener(area,"mouseout",marker,"_out")}marker._ec._im_click=JAK.Events.addListener(area,"click",JAK.Events.cancelDef);marker._dFeature.ImageMap.prototype._blur=function(e,elm){elm.blur()};SMap.Marker.Feature.ImageMap.prototype._over=function(e,elm){this._dom.container[SMap.LAYER_ACTIVE].style.cursor="pointer"};SMap.Marker.Feature.ImageMap.prototype._out=function(e,elm){this._dom.container[SMap.LAYER_ACTIVE].style.cursor="move"};SMap.Marker.Feature.RelativeAnchor=JAK.ClassMaker.makeSingleton({NAME:"SMap.Marker.Feature.RelativeAnchor",VERSION:"1.0",EXTEND:JAK.AbstractDecorator});SMap.Marker.Feature.RelativeAnchor.prototype.decorate=function(marker,options){this.$super(marker);marker._computeRelativeAnchor=this._computeRelativeAnchor;marker._loadedRelativeAnchor=this._loadedRelativeAnchor;var o=marker._options;o.relativeAnchor=options.anchor;var container=marker._dom.container;var img=container[SMap.LAYER_MARKER];if(options.size){o.size=options.size;marker._computeRelativeAnchor()}else if(img.width&&img.height){o.size=new SMap.Pixel(img.width,img.height);marker._computeRelativeAnchor()}else{for(var p in container){container[p].style.visibility="hidden"}marker._ec._ra_load=JAK.Events.addListener(img,"load",marker,"_loadedRelativeAnchor")}return marker};SMap.Marker.Feature.RelativeAnchor.prototype._computeRelativeAnchor=function(){var o=this._options;var a=o.relativeAnchor;if("left"in a){o.anchor.left=Math.round(o.size.x*a.left)}if("right"in a){o.anchor.right=Math.round(o.size.x*a.right)}if("top"in a){o.anchor.top=Math.round(o.size.y*a.top)}if("bottom"in a){o.anchor.bottom=Math.round(o.size.y*a.bottom)}};SMap.Marker.Feature.RelativeAnchor.prototype._loadedRelativeAnchor=function(e,elm){this._options.size=new SMap.Pixel(elm.width,elm.height);this._computeRelativeAnchor();var o=this._owner;if(o){o.positionMarker(this)}for(var p in this._dom.container){this._dom.container[p].style.visibility="visible"}};SMap.Marker.Feature.Card=JAK.ClassMaker.makeSingleton({NAME:"SMap.Marker.Feature.Card",VERSION:"1.0",EXTEND:JAK.AbstractDecorator});SMap.Marker.Feature.Card.prototype.decorate=function(marker,card){this.$super(marker);marker._card=card;marker.click=this.click;marker.getContainer()[SMap.LAYER_MARKER].style.cursor="pointer";return marker};SMap.Marker.Feature.Card.prototype.click=function(e,elm){this.$super(e,elm);this.getMap().addCard(this._card,this._coords)};SMap.Marker.Feature.Card.prototype.getCard=function(){return this._card};SMap.Marker.Feature.Draggable=JAK.ClassMaker.makeSingleton({NAME:"SMap.Marker.Feature.Draggable",VERSION:"1.0",EXTEND:JAK.AbstractDecorator});SMap.Marker.Feature.Draggable.prototype.decorate=function(marker){this.$super(marker);marker._ecDrag=[];marker._dragStart=this._dragStart;marker._dragMove=this._dragMove;marker._dragStop=this._dragStop;marker.setDrag=this.setDrag;marker._mapMoveChange=this._mapMoveChange;marker._dragCoords=[];marker._dragState=true;this._scMap=null;this._startCenter=null;var active=marker.getActive();active.setAttribute("touch-action","none");marker._ec._d_down=JAK.Events.addListener(active,"mousedown touchstart",marker,"_dragStart");return marker};SMap.Marker.Feature.Draggable.prototype.setDrag=function(state){this._dragState=state};SMap.Marker.Feature.Draggable.prototype._mapMoveChange=function(evnt){var map=this.getMap();if(!map)return;var diffPx=this._startCenter.toPixel(map);var markerPx=this._coords.toPixel(map);markerPx.minus(diffPx);this.setCoords(markerPx.toCoords(map));this._startCenter=map.getCenter();map.getSignals().makeEvent("marker-drag-move",this)};SMap.Marker.Feature.Draggable.prototype._dragStart=function(e,elm){var map=this.getMap();if(!this._dragState||!map){return}if(e.touches){e.clientX=e.touches[0].clientX;e.clientY=e.touches[0].clientY}else{if(e.button!=JAK.Browser.mouse.left){return}}var target=JAK.Events.getTarget(e);if(target.useMap){return}this._scMap=map.getSignals().addListener(this,"map-redraw","_mapMoveChange");this._startCenter=map.getCenter();JAK.Events.cancelDef(e);JAK.Events.stopEvent(e);map.getSignals().makeEvent("marker-drag-start",this,{event:e});this._ecDrag.push(JAK.Events.addListener(window,"mousemove touchmove",this,"_dragMove"));this._ecDrag.push(JAK.Events.addListener(window,"mouseup touchend",this,"_dragStop"));this._dragCoords=[e.clientX,e.clientY];this._wasDrag=false};SMap.Marker.Feature.Draggable.prototype._dragMove=function(e,elm){JAK.Events.cancelDef(e);if(e.touches){e.clientX=e.touches[0].clientX;e.clientY=e.touches[0].clientY}this._wasDrag=true;var map=this.getMap();if(!map)return;var dx=e.clientX-this._dragCoords[0];var dy=e.clientY-this._dragCoords[1];this._dragCoords=[e.clientX,e.clientY];var dpx=new SMap.Pixel(dx,dy);var px=this._coords.toPixel(map).plus(dpx);this.setCoords(px.toCoords(map));map.getSignals().makeEvent("marker-drag-move",this,{event:e})};SMap.Marker.Feature.Draggable.prototype._dragStop=function(e,elm){this._ecDrag.forEach(JAK.Events.removeListener,JAK.Events);this._ecDrag=[];var map=this.getMap();if(this._scMap&&map){map.getSignals().removeListener(this._scMap)}this._scMap=null;if(this._wasDrag){if(map){map.getSignals().makeEvent("marker-drag-stop",this,{event:e})}}else{this.click(e,elm)}};SMap.Marker.Feature.Shadow=JAK.ClassMaker.makeSingleton({NAME:"SMap.Marker.Feature.Shadow",VERSION:"1.0",EXTEND:JAK.AbstractDecorator});SMap.Marker.Feature.Shadow.prototype.decorate=function(marker,url){this.$super(marker);var src=url||SMap.CONFIG.img+"/marker/drop-shadow.png";marker._dom.container[SMap.LAYER_SHADOW]=JAK.mel("img",{src:src})};SMap.Marker.Repositioner=JAK.ClassMaker.makeSingleton({NAME:"SMap.Marker.Repositioner",VERSION:"1.0"});SMap.Marker.Repositioner.prototype.$constructor=function(options){this._options={};this._data={};this._grid={};this._todo=[];this._sizes={};this._directions=[[1,0],[0,1],[-1,0],[0,-1],[1,0]]};SMap.Marker.Repositioner.prototype.go=function(data,markers,options){this._options={itemSize:[18,18],tolerance:0,limit:Infinity,gridStep:6};for(var p in options){this._options[p]=options[p]}this._prepareData(data,markers);this._initialPlacement();this._mainLoop();this._finish()};SMap.Marker.Repositioner.prototype._prepareData=function(data,markers){this._todo=[];this._data=data;var gs=this._options.gridStep;for(var id in this._data){var item=this._data[id];var pixelSize=markers[id].marker.getSize()||this._options.itemSize;this._sizes[id]=[Math.floor(pixelSize[0]/gs),Math.floor(pixelSize[1]/gs)];item.x=Math.round(item.x/gs);item.y=Math.round(item.y/gs);this._todo.push(id)}};SMap.Marker.Repositioner.prototype._addItem=function(id){var result=0;var grid=this._grid;var item=this._data[id];var size=this._sizes[id];for(var x=0;x<size[0];x++){for(var y=0;y<size[1];y++){var key=item.x+x+","+(item.y+y);if(key in grid){result+=grid[key]}else{grid[key]=0}grid[key]++}}return result};SMap.Marker.Repositioner.prototype._removeItem=function(id){var grid=this._grid;var item=this._data[id];var size=this._sizes[id];for(var x=0;x<size[0];x++){for(var y=0;y<size[1];y++){var key=item.x+x+","+(item.y+y);grid[key]--}}};SMap.Marker.Repositioner.prototype._initialPlacement=function(markers){var tolerance=this._options.tolerance;var grid=this._grid;this._todo=this._todo.filter(function(id){var item=this._data[id];var size=this._sizes[id];var errors=0;var ok=true;for(var x=0;x<size[0];x++){for(var y=0;y<size[1];y++){var key=item.x+x+","+(item.y+y);if(key in grid){errors++}if(errors>tolerance){return true}}}this._addItem(id);return false},this)};SMap.Marker.Repositioner.prototype._advanceItem=function(id,direction,errors){var e=errors;var sx=0;var sy=0;var tx=0;var ty=0;var length=null;var item=this._data[id];var size=this._sizes[id];if(direction[1]==0){length=size[1];sx=item.x;tx=item.x;if(direction[0]==1){tx+=size[0]}else{sx+=size[0]-1;tx--}}else{length=size[0];sy=item.y;ty=item.y;if(direction[1]==1){ty+=size[1]}else{sy+=size[1]-1;ty--}}var grid=this._grid;for(var i=0;i<length;i++){if(direction[1]==0){sy=item.y+i;ty=item.y+i}else{sx=item.x+i;tx=item.x+i}var sourceKey=sx+","+sy;var targetKey=tx+","+ty;grid[sourceKey]--;if(grid[sourceKey]){e--}if(grid[targetKey]){e++}if(!(targetKey in grid)){grid[targetKey]=0}grid[targetKey]++}item.x+=direction[0];item.y+=direction[1];return e};SMap.Marker.Repositioner.prototype._rotateItem=function(id,distance){var item=this._data[id];if(distance>this._options.limit){item.x=item.y=null;return true}item.y--;var x=item.x;var y=item.y;var directionIndex=0;var remainingSteps=distance;var errors=this._addItem(id);while(errors>this._options.tolerance){var direction=this._directions[directionIndex];remainingSteps--;if(!remainingSteps){directionIndex++;remainingSteps=distance*2}errors=this._advanceItem(id,direction,errors);if(x==item.x&&y==item.y){this._removeItem(id);return false}}return true};SMap.Marker.Repositioner.prototype._mainLoop=function(){var dist=0;while(this._todo.length){dist++;this._todo=this._todo.filter(function(id){var result=this._rotateItem(id,dist);return!result},this)}};SMap.Marker.Repositioner.prototype._finish=function(){var gs=this._options.gridStep;for(var id in this._data){var item=this._data[id];if(item.x!==null){item.x*=gs;item.y*=gs}}this._grid={};this._data={}};SMap.Marker.Cluster=JAK.ClassMaker.makeClass({NAME:"SMap.Marker.Cluster",VERSION:"1.0",EXTEND:SMap.Marker});SMap.Marker.Cluster.prototype.$constructor=function(id,options){var markerOptions={url:JAK.mel("div",{className:"cluster"}),anchor:{left:0,top:0}};this.$super(null,id,markerOptions);this._clusterOptions={color:"#3d66cf",radius:function(count,min,max){return 25+10*(count-min+1)/(max-min+1)}};for(var p in options){this._clusterOptions[p]=options[p]}this._dom.content=JAK.mel("span");this._dom.circle=JAK.mel("div",{},{color:this._clusterOptions.color});this._dom.container[SMap.LAYER_MARKER].appendChild(this._dom.circle);this._dom.circle.appendChild(this._dom.content);this._dom.circle.appendChild(JAK.mel("img",{src:SMap.CONFIG.img+"/marker/cluster.png"},{backgroundColor:this._clusterOptions.color}));this._markers=[];this._markerCoords=[]};SMap.Marker.Cluster.prototype.addMarker=function(marker){this._markers.push(marker);this._markerCoords.push(marker.getCoords());this._update();return this};SMap.Marker.Cluster.prototype.getMarkers=function(){return this._markers};SMap.Marker.Cluster.prototype.click=function(e,elm){this.$super(e,elm);var map=this.getMap();var cz=map.computeCenterZoom(this._markerCoords);map.setCenterZoom(cz[0],cz[1])};SMap.Marker.Cluster.prototype.setSize=function(min,max){var radius=Math.round(this._clusterOptions.radius(this._markers.length,min,max));this._dom.circle.style.width=2*radius+"px";this._dom.circle.style.height=2*radius+"px";this._dom.circle.style.left=-radius+"px";this._dom.circle.style.top=-radius+"px";this._dom.content.style.lineHeight=2*radius+"px";return this};SMap.Marker.Cluster.prototype._update=function(){var minX=Infinity;var minY=Infinity;var maxX=-Infinity;var maxY=-Infinity;var count=this._markers.length;this._dom.content.innerHTML=count;this._dom.circle.title=count;for(var i=0;i<count;i++){var item=this._markerCoords[i];minX=Math.min(minX,item.x);minY=Math.min(minY,item.y);maxX=Math.max(maxX,item.x);maxY=Math.max(maxY,item.y)}var x=(minX+maxX)/2;var y=(minY+maxY)/2;this.setCoords(new SMap.Coords(x,y))};SMap.Marker.Clusterer=JAK.ClassMaker.makeClass({NAME:"SMap.Marker.Clusterer",VERSION:"1.0"});SMap.Marker.Clusterer.prototype.$constructor=function(map,maxDistance,clusterCtor){this._maxDistance=maxDistance||100;this._clusterCtor=clusterCtor||SMap.Marker.Cluster;this._markers=[];this._clusters=[];this._position(){this._markers=[];this._clusters=[];this._positions=[]};SMap.Marker.Clusterer.prototype.addMarker=function(marker){if(marker instanceof Array){this._markers=this._markers.concat(marker)}else{this._markers.push(marker)}};SMap.Marker.Clusterer.prototype.removeMarker=function(marker){if(marker instanceof Array){for(var i=0;i<marker.length;i++){this.removeMarker(marker[i])}return}var index=this._markers.indexOf(marker);if(index!=-1){this._markers.splice(index,1)}};SMap.Marker.Clusterer.prototype.getAllMarkers=function(){return this._markers};SMap.Marker.Clusterer.prototype.getMarkers=function(){var result=[];for(var i=0;i<this._clusters.length;i++){var c=this._clusters[i];if(c.getMarkers().length==1){result.push(c.getMarkers()[0])}}return result};SMap.Marker.Clusterer.prototype.getClusters=function(){var result=[];for(var i=0;i<this._clusters.length;i++){var c=this._clusters[i];if(c.getMarkers().length>1){result.push(c)}}return result};SMap.Marker.Clusterer.prototype.compute=function(){this._clusters=[];this._positions=[];for(var i=0;i<this._markers.length;i++){var marker=this._markers[i];this._process(marker)}var min=Infinity;var max=-Infinity;for(var i=0;i<this._clusters.length;i++){var len=this._clusters[i].getMarkers().length;min=Math.min(min,len);max=Math.max(max,len)}for(var i=0;i<this._clusters.length;i++){var c=this._clusters[i];c.setSize(min,max)}};SMap.Marker.Clusterer.prototype._process=function(marker){var distance=Infinity;var closestCluster=null;var pos=marker.getCoords().toPixel(this._map);var index=-1;for(var i=0;i<this._positions.length;i++){var dist=pos.distance(this._positions[i]);if(dist<distance){distance=dist;index=i}}if(index==-1||distance>this._maxDistance){index=this._clusters.length;var cluster=new this._clusterCtor;this._clusters.push(cluster)}else{var cluster=this._clusters[index]}cluster.addMarker(marker);this._positions[index]=cluster.getCoords().toPixel(this._map)};SMap.Card=JAK.ClassMaker.makeClass({NAME:"SMap.Card",VERSION:"1.0",IMPLEMENT:[SMap.IOwned]});SMap.Card.prototype.MIN_HEIGHT=368;SMap.Card.prototype.$constructor=function(width,options){this._ec=[];this._sc=[];this._options={close:true,anchor:{left:0,top:0}};for(var p in options){this._options[p]=options[p]}this._anchor=false;this._owner=null;this._size=[null,null];this._minHeight=null;this._dom={container:null,close:null,tail:null,header:JAK.mel("div",{className:"card-header"}),body:JAK.mel("div",{className:"card-body"}),footer:JAK.mel("div",{className:"card-footer"})};this._build();this._addEvents();this.setSize(width||312)};SMap.Card.prototype.$destructor=function(){this._ec.forEach(JAK.Events.removeListener,JAK.Events);this._ec=[];var s=this.getMap().getSignals();this._sc.forEach(function(e){s.removeListener(e)});this._sc=[]};SMap.Card.prototype.setOwner=function(owner){this._owner=owner;this.sync()};SMap.Card.prototype.getHeader=function(){return this._dom.header};SMap.Card.prototype.getBody=function(){return this._dom.body};SMap.Card.prototype.getFooter=function(){return this._dom.footer};SMap.Card.prototype.setSize=function(width,height){this._size=[width||this._size[0],height||null];this._dom.container.style.width=this._size[0]+"px";this.sync()};SMap.Card.prototype.getContainer=function(){return this._dom.container};SMap.Card.prototype.getAnchor=function(){return this._anchor};SMap.Card.prototype.anchorTo=function(coords){this._anchor=coords;var px=this._computePosition(coords);this._dom.container.style.left=Math.round(px.x)+"px";this._dom.container.style.bottom=Math.round(-px.y)+"px"};SMap.Card.prototype.isVisible=function(){var offset=this._getOffset();var port=this.getMap().getSize();var size=this._getOuterSize();var left=Math.max(0,offset.x);var top=Math.max(0,offset.y);var right=Math.min(port.x,offset.x+size.x);var bottom=Math.min(port.y,offset.y+size.y);return right>left&&bottom>top};SMap.Card.prototype.makeVisible=function(){var map=this.getMap();var dist=this._visibilityDistance();if(!dist.x&&!dist.y){return true}var d=Math.sqrt(dist.x*dist.x+dist.y+dist.y);var size=map.getSize();var diag=Math.sqrt(size.x*size.x+size.y*size.y);if(d<=.5*diag){map.animate(dist)}else{map.setCenter(dist)}return false};SMap.Card.prototype._visibilityDistance=function(){var map=this.getMap();var offset=this._getOffset();var port=map.getSize();var lt=new SMap.Pixel(map.getPadding("left"),map.getPadding("top"));var rb=new SMap.Pixel(port.x-map.getPadding("right"),port.y-map.getPadding("bottom"));var size=this._getOuterSize();var left=offset.x-lt.x;var top=offset.y-lt.y;var right=rb.x-(offset.x+size.x);var bottom=rb.y-(offset.y+size.y);var x=0;var y=0;if(left<0){x=-left}if(right<0){x=right}if(top<0){y=-top}if(bottom<0){y=bottom}return new SMap.Pixel(x,y)};SMap.Card.prototype.sync=function(){if(!this._owner){return}var map=this.getMap();this._dom.body.style.display="none";var baseHeight=this._getOuterSize().y;this._dom.body.style.display="";if(this._size[1]){var bodyHeight=this._size[1]-baseHeight;if(bodyHeight<0){bodyHeight=0}this._dom.body.style.height=bodyHeight+"px";return}var availHeight=map.getSize().y;availHeight-=map.getPadding("top");availHeight-=map.getPadding("bottom");availHeight=Math.min(availHeight,this.MIN_HEIGHT);this._dom.body.style.height="";var bodyHeight=this._dom.body.scrollHeight;var totalHeight=baseHeight+bodyHeight;if(totalHeight>availHeight){bodyHeight-=totalHeight-availHeight;if(bodyHeight<0){bodyHeight=0}this._dom.body.style.height=bodyHeight+"px"}};SMap.Card.prototype._getOuterSize=function(){var c=this._dom.container;var t=this._dom.tail;var p=new SMap.Pixel(c.offsetWidth,t.offsetTop+t.offsetHeight);return p};SMap.Card.prototype._computePosition=function(coords){var map=this.getMap();var px=coords.toPixel(map).minus(map.getOffset());var tail=this._dom.tail;px.x-=tail.offsetLeft+Math.floor(tail.offsetWidth/2)-this._options.anchor.left;var TOP_OFFSET=1;px.y+=this._dom.container.offsetHeight-tail.offsetTop-tail.offsetHeight+TOP_OFFSET+this._options.anchor.top;return px};SMap.Card.prototype._getOffset=function(){var node=this._dom.container;var top=this.getMap().getContainer();var offset=new SMap.Pixel(0,0);while(node!=top){offset.x+=node.offsetLeft;offset.y+=node.offsetTop;node=node.offsetParent}offset.x+=top.clientLeft||0;offset.y+=top.clientTop||0;return offset};SMap.Card.prototype._closeClick=function(e,elm){var map=this.getMap();map.removeCard();map.getSignals().makeEvent("card-close-click",this)};SMap.Card.prototype._addEvents=function(){this._ec.push(JAK.Events.addListener(this._dom.container,"DOMMouseScroll",JAK.Events.stopEvent));this._ec.push(JAK.Events.addListener(this._dom.container,"mousewheel",JAK.Events.stopEvent));this._ec.push(JAK.Events.addListener(this._dom.container,"mousedown",JAK.Events.stopEvent));this._ec.push(JAK.Events.addListener(this._dom.container,"dblclick",JAK.Events.stopEvent));this._ec.push(JAK.Events.addListener(this._dom.container,"contextmenu",JAK.Events.stopEvent));this._ec.push(JAK.Events.addListener(this._dom.container,"touchstart",JAK.Events.stopEvent))};SMap.Card.prototype._build=function(){this._dom.container=JAK.mel("div",{className:"card"});this._dom.container.appendChild(this._dom.header);this._dom.container.appendChild(this._dom.body);this._dom.container.appendChild(this._dom.footer);if(!this._options||this._options.close){this._dom.close=JAK.mel("div",{className:"close"});this._ec.push(JAK.Events.addListener(this._dom.close,"click",this,"_closeClick"));this._dom.container.appendChild(this._dom.close)}this._dom.tail=JAK.mel("div",{className:"tail"});this._dom.container.appendChild(this._dom.tail)};SMap.Control=JAK.ClassMaker.makeClass({NAME:"SMap.Control",VERSION:"1.0"tructor=function(){this._ec=[];this._sc=[];this._owner=null};SMap.Control.prototype.$destructor=function(){JAK.Events.removeListeners(this._ec);var map=this.getMap();if(map){map.getSignals().removeListeners(this._sc)}};SMap.Control.prototype.getContainer=function(){return false};SMap.Control.prototype.setOwner=function(owner){if(this._owner&&this._owner!=owner){JAK.Events.removeListeners(this._ec);this.getMap().getSignals().removeListeners(this._sc)}this._owner=owner};SMap.Control.Sync=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Sync",VERSION:"1.0",EXTEND:SMap.Control});SMap.Control.Sync.prototype.$constructor=function(options){this.$super();this._options={bottomSpace:null,resizeTimeout:100};for(var p in options){this._options[p]=options[p]}this._timeoutDone=this._timeoutDone.bind(this);this._timeout=null};SMap.Control.Sync.prototype.setOwner=function(owner){this.$super(owner);if(this._timeout){clearTimeout(this._timeout);this._timeout=null}if(!owner){return}this._ec.push(JAK.Events.addListener(window,"resize",this,"_resize"));this._sync()};SMap.Control.Sync.prototype.setBottomSpace=function(space){this._options.bottomSpace=space};SMap.Control.Sync.prototype._sync=function(){var map=this.getMap();var port=map.getContainer();var size=map.getSize();if(this._options.bottomSpace!==null){var top=JAK.DOM.getBoxPosition(port);var doc=JAK.DOM.getDocSize();var h=doc.height-top.top-this._options.bottomSpace;port.style.height=Math.round(h)+"px"}if(size.x!=port.offsetWidth||size.y!=port.offsetHeight){map.syncPort();map.getSignals().makeEvent("map-resize",this)}};SMap.Control.Sync.prototype._resize=function(e,elm){if(this._timeout){clearTimeout(this._timeout)}this._timeout=setTimeout(this._timeoutDone,this._optiype._timeoutDone=function(){this._timeout=null;this._sync()};SMap.Control.Visible=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Visible",VERSION:"1.0",EXTENrototype.$constructor=function(){this.$super();this._dom={}};SMap.Control.Visible.prototype.getContainer=function(){return this._dom.container};SMap.Control.Visible.prototype._build=function(){this._dom.container=JAK.mel("div")};SMap.Control.Image=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Image",VERSION:"1.0",EXTEND:SMap.Control.Visible});SMap.Control.Image.prototype.$constructor=function(url,href){this.$super();this._url=url;this._href=href;this._targetHref="";this._dom.container=JAK.mel("img");if(href){this._dom.container.style.cursor="pointer";this._ec.push(JAK.Events.addListener(this._dom.container,"click",this,"_click"))}};SMap.Control.Image.prototype.setOwner=function(owner){this.$super(owner);if(!owner){return}var s=this.getMap().getSignals();this._sc.push(s.addListener(this,"map-redraw","_re_redraw=function(){this._dom.container.src=this._buildURL()};SMap.Control.Image.prototype._buildURL=function(){if(this._href){this._targetHref=this.getMap().formatString(this._href)}return this.getMap().totype._click=function(e,elm){window.open(this._targetHref)};SMap.Control.MapyLogo=JAK.ClassMaker.makeClass({NAME:"SMap.Control.MapyLogo",VERSION:"1.0",EXTEND:SMap.Control.Visible});SMap.Control.MapyLogo.prototype.$constructor=function(){this.$super();this._linkURL=SMap.CONFIG.mapyczDomain+"/?x={cx}&y={cy}&z={zoom}";var link=JAK.mel("a",{className:"print",target:"_blank"});var img=JAK.mel("img",{src:SMap.CONFIG.img+"/logo.svg",alt:SMap._("controlLogo")});link.appendChild(img);this._dom.container=link};SMap.Control.MapyLogo.prototype.setOwner=function(owner){this.$super(owner);if(!owner){return}var s=this.getMap().getSignals();this._sc.push(s.addListener(this,"map-redraw","_redraw"));this._redraw()};SMap.Control.MapyLogo.prototype._redraw=function(){this._dom.container.href=this.getMap().formatString(this._linkURL)};SMap.Control.Compass=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Compass",VERSION:"1.0",EXTEND:SMap.Control.Visible});SMap.Control.Compass.prototype.$constructor=function(options){this.$super();this._options={panAmount:1,title:"",moveThreshold:300};for(var p in options){this._options[p]=options[p]}this._classNames={};this._classNames[SMap.NORTH]="north";this._classNames[SMap.EAST]="east";this._classNames[SMap.SOUTH]="south";this._classNames[SMap.WEST]="west";this._ec2=[];this._moving=false;this._totalMoved=null;this._step=this._step.bind(this);this._build()};SMap.Control.Compass.prototype.setOwner=function(owner){this.$super(owner);if(!owner){return}this._sc.push(this.getMap().getSignals().addListener(this,"map-redraw","_redraw"));this._ec.push(JAK.Events.addListener(this._dom.container,"mousedown",this,"_start"));this._redraw()};SMap.Control.Compass.prototype._redraw=function(){var cn=this._classNames[this.getMap().getOrientation()];cn="north";if(cn=="north"){var isIE8=JAK.Browser.client=="ie"&&JAK.Browser.version==8;if(isIE8){cn+="-ie8"}}JAK.DOM.removeClass(this._dom.container,"compass-"+cn);JAK.DOM.addClass(this._dom.container,"compass-"+cn)};SMap.Control.Compass.prototype._build=function(){this._dom.container=JAK.mel("div",{className:"compass"});this._dom.container.title=this._options.title};SMap.Control.Compass.prototype._start=function(e,elm){var ok=this._set(e,elm);if(!ok){return}this._totalMoved=new SMap.Pixel(0,0);this._ec2.push(JAK.Events.addListener(window,"mousemove",this,"_set"));this._ec2.push(JAK.Events.addListener(window,"mouseup",this,"_end"));this._moving=true;this.getMap().lock();this._step();JAK.Timekeeper.getInstance().addListener(this,"_step",2)};SMap.Control.Compass.prototype._step=function(){this._totalMoved.plus(this.step);var size=this.getMap().getSize();var diag=Math.sqrt(size.x*size.x+size.y*size.y);if(this._totalMoved.norm()>this._options.moveThreshold){this._totalMoved.x=0;this._totalMoved.y=0;this.getMap().redraw()}this.getMap().setCenter(this.step)};SMap.Control.Compass.prototype._set=function(e,elm){JAK.Events.cancelDef(e);var c=this._dom.container;var pos=JAK.DOM.getBoxPosition(c);var scroll=JAK.DOM.getScrollPos();pos.left-=scroll.x;pos.top-=scroll.y;var left=e.clientX-pos.left;var top=e.clientY-pos.top;var s=c.offsetWidth/2;var dx=s-left;var dy=s-top;if(dx*dx+dy*dy>s*s){if(this._moving){this._end()}return false}this.step=new SMap.Pixel(dx,dy).scale(this._options.panAmount);return true};SMap.Control.Compass.prototype._end=function(){JAK.Timekeeper.getInstance().removeListener(this);this._moving=false;this._ec2.forEach(JAK.Events.removeListener,JAK.Events);this._ec2=[];this.getMap().unlock()};SMap.Control.Selection=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Selection",VERSION:"1.0",EXTEND:SMap.Control.Visible});SMap.Control.Selection.prototype.$constructor=function(thickness){this.$super();this._ecTmp=[];this._thickness=thickness||0;this._build();this._lock=false;this._point1=null;this._point2=null;this._size=null};SMap.Control.Selection.prototype.setOwner=function(owner){this.$super(owner);if(!owner){return}var elm=owner.getContainer();this._ec.push(JAK.Events.addListener(elm,"mousedown",this,"_mousedown"));this._ec.push(JAK.Events.addListener(document,"keydown",this,"_keyDown"));this._ec.push(JAK.Events.addListener(document,"keyup",this,"_keyUp"))};SMap.Control.Selection.prototype._keyDown=function(e,elm){if(this._lock){return}if(e.keyCode!=17){return}if(!this._owner){return}this._lock=true;this.getMap().setCursor("pointer")};SMap.Control.Selection.prototype._keyUp=function(e,elm){if(!this._lock){return}if(e.keyCode!=17){return}if(!this._owner){return}this._lock=false;this.getMap().setCursor(null)};SMap.Control.Selection.prototype._build=function(){this._dom.container=JAK.mel("div",{className:"selection"},{borderWidth:this._thickness+"px"});this._hide()};SMap.Control.Selection.prototype._hide=function(){this._dom.container.style.visibility="hidden"};SMap.Control.Selection.prototype._show=function(){this._dom.container.style.visibility="visible"};SMap.Control.Selection.prototype._mousedown=function(e,elm){if(e.button!=JAK.Browser.mouse.left){return}if(!this._isModifyKeyPressed(e)){return}this._size=this.getMap().getSize().clone().scale(.5);this._point1=SMap.Pixel.fromEvent(e,this.getMap());this._point2=this._point1;this._redraw();this._ecTmp.push(JAK.Events.addListener(window,"mouseup",this,"_mouseup"));this._ecTmp.push(JAK.Events.addListener(window,"mousemove",this,"_mousemove"));this._ecTmp.push(JAK.Events.addListener(document,"keydown",this,"_keydown"))};SMap.Control.Selection.prototype._isModifyKeyPressed=function(e){if(JAK.Browser.platform=="mac"){return e.metaKey}else{lection.prototype._mouseup=function(e,elm){this._stop(true)};SMap.Control.Selection.prototype._mousemove=function(e,elm){var point=SMap.Pixel.fromEvent(e,this.getMap());if(this._point1==this._point2){if(this._point1.distance(point)<3){return}this._show()}this._point2=point;this._redraw()};SMap.Control.Selection.prototype._keydown=function(e,elm){if(e.keyCode!=27){return}this._stop(false)};SMap.Control.Selection.prototype._stop=function(success){this._ecTmp.forEach(JAK.Events.removeListener,JAK.Events);this._ecTmp=[];this._hide();if(success&&this._point1!=this._point2){var arr=[this._point1.toCoords(this.getMap()),this._point2.toCoords(this.getMap())];var cz=this.getMap().computeCenterZoom(arr);var center=cz[0];var zoom=cz[1];this.getMap().setCenterZoom(center,zoom);this.getMap().getSignals().makeEvent("control-selection-centerzoom")}};SMap.Control.Selection.prototype._redraw=function(){var w=Math.abs(this._point1.x-this._point2.x);var h=Math.abs(this._point1.y-this._point2.y);this._dom.container.style.width=w+"px";this._dom.container.style.height=h+"px";var left=Math.min(this._point1.x,this._point2.x);var top=Math.min(this._point1.y,this._point2.y);left+=this._size.x;top+=this._size.y;left-=this._thickness;top-=this._thickness;this._dom.container.style.left=left+"px";this._dom.container.style.top=top+"px"};SMap.Control.ZoomNotification=JAK.ClassMaker.makeClass({NAME:"SMap.Control.ZoomNotification",VERSION:"1.0",EXTEND:SMap.Control.Visible});SMap.Control.ZoomNotification.prototype.$constructor=function(){this.$super();this._zoom=null;this._fixedPoint=null;this._size=new SMap.Pixel(0,0);this._build()};SMap.Control.ZoomNotification.prototype.setOwner=function(owner){this.$super(owner);if(!owner){return}var signals=this.getMap().getSignals();this._sc.push(signals.addListener(this,"zoom-start","_zoomStart"));this._sc.push(signals.addListener(this,"zoom-step","_zoomStep"));this._sc.push(signals.addListener(this,"zoom-stop","_zoomStop"))};SMap.Control.ZoomNotification.prototype._build=function(){this._dom.container=JAK.mel("div",{className:"notification"},{display:"none"});var A=["top","bottom"];var B=["left","right"];for(var i=0;i<A.length;i++){for(var j=0;j<B.length;j++){var cn=A[i]+"-"+B[j];var div=JAK.mel("div",{className:cn},{position:"absolute"});div.style[A[i]]="0px";div.style[B[j]]="0px";this._dom.container.appendChild(div)}}};SMap.Control.ZoomNotification.prototype._zoomStart=function(e){if(e.data.touch){return}var map=this.getMap();this._zoom=map.getZoom();var size=map.getSize();this._fixedPoint=e.data.fixedPoint.clone();this._fixedPoint.plus(size.clone().scale(.5));this._dom.container.style.display="";this._dom.container.style.width="";var w=this._dom.container.offsetWidth;var h=w*size.y/size.x;this._size.x=w;this._size.y=h;this._updatePositionSize(w,h)};SMap.Control.ZoomNotification.prototype._zoomStep=function(e){if(this._dom.container.style.display!=""){return}var zoom=e.data.currentZoom;var diff=Math.pow(2,zoom-this._zoom);this._updatePositionSize(this._size.x*diff,this._sizomStop=function(e){this._dom.container.style.display="none"};SMap.Control.ZoomNotification.prototype._updatePositionSize=function(w,h){var s=this._dom.container.style;s.width=Math.round(w)+"px";s.height=Math.round(h)+"px";s.left=Math.round(this._fixedPoint.x-w/2)+"px";s.top=Math.round(this._fixedPoint.y-h/2)+"px"};SMap.Control.Keyboard=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Keyboard",VERSION:"1.0",EXTEND:SMap.Control});SMap.Control.Keyboard.prototype.$constructor=function(mode,options){this.$super();this._options={panAmount:10,focusedOnly:true};for(var p in options){this._options[p]=options[p]}this._options.panAmount=parseFloat(this._options.panAmount)||0;this._keyMap={37:new SMap.Pixel(this._options.panAmount,0),38:new SMap.Pixel(0,this._options.panAmount),39:new SMap.Pixel(-this._options.panAmount,0),40:new SMap.Pixel(0,-this._options.panAmount)};this._usedKeys={};for(var num in this._keyMap){this._usedKeys[num]=false}this._mapFocused=false;this._mode=mode;this._moving=false;this.step=new SMap.Pixel(0,0);this._step=this._step.bind(this)};SMap.Control.Keyboard.prototype.setOwner=function(owner){this.$super(owner);if(!owner){return}this._ec.push(JAK.Events.addListener(document,"keydown",this,"_down"));this._ec.push(JAK.Events.addListener(document,"keyup",this,"_up"));this._ec.push(JAK.Events.addListener(document,"keypress",this,"_press"));var s=this.getMap().getSignals();this._sc.push(s.addListener(this,"map-focus","_mapFocus"));this._sc.push(s.addListener(this,"map-blur","_mapBlur"))};SMap.Control.Keyboard.prototype.configure=function(mode){this._mode=mode};SMap.Control.Keyboard.prototype.getMode=functioototype._step=function(){this.getMap().setCenter(this.step)};SMap.Control.Keyboard.prototype._press=function(e,elm){if(this._options.focusedOnly&&!this._mapFocused){return}if(this._moving){JAK.Events.cancelDef(e)}};SMap.Control.Keyboard.prototype._up=function(e,elm){if(!this._moving){return}var kc=e.keyCode;if(kc in this._keyMap){this.step.minus(this._keyMap[kc]);this._usedKeys[kc]=false}if(!this.step.x&&!this.step.y){JAK.Timekeeper.getInstance().removeListener(this);this._moving=false;this.getMap().unlock();this.getMap().getSignals().makeEvent("control-keyboard-move")}};SMap.Control.Keyboard.prototype._down=function(e,elm){if(this._options.focusedOnly&&!this._mapFocused){return}var t=JAK.Events.getTarget(e).tagName.toLowerCase();if(["input","select","option","textarea"].indexOf(t)!=-1){return}if(e.ctrlKey||e.metaKey||e.shiftKey||e.altKey){return}var kc=e.keyCode;if(kc in this._keyMap&&!this._usedKeys[kc]&&this._mode&SMap.KB_PAN){this.step.plus(this._keyMap[kc]);this._usedKeys[kc]=true}else if(kc==109){if(this._mode&SMap.KB_ZOOM){this.getMap().setZoom("-1",null,true)}this.getMap().getSignals().makeEvent("control-keyboard-zoom")}else if(kc==107){if(this._mode&SMap.KB_ZOOM){this.getMap().setZoom("+1",null,true)}this.getMap().getSignals().makeEvent("control-keyboard-zoom")}if((this.step.x||this.step.y)&&!this._moving){JAK.Events.cancelDef(e);this.getMap().lock();this._moving=true;this._step();JAK.Timekeeper.getInstance().addListener(this,"_step")}};SMap.Control.Keyboard.prototype._mapFocus=function(e){thiboard.prototype._mapBlur=function(e){this._mapFocused=false};SMap.Control.Mouse=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Mouse",VERSION:"1.0",EXTEND:SMap.Control});SMap.Control.Mouse.prototype.$constructor=function(mode,options){this.$super();this._ecMove=[];this._ecGesture=[];this.options={scrollDelay:125,idleDelay:400,minDriftSpeed:30,maxDriftSpeed:80,driftSlowdown:.95,driftThreshold:300};this._mode=mode;this._gesture={scale:1,coords:null,running:false};this._drift={speed:0,direction:0,moved:0};this._context={timeout:null,event:null};this._doubleTouch={delay:300,threshold:48,lastTimestamp:null,lastEvent:null};this._lastEvents=[];this._lastTimestamp=null;this._scrollTimeout=false;this._idleTimeout=false;this._moved=false;this._speed=[];for(var p in options){this.options[p]=options[p]}this._scrollUnlock=this._scrollUnlock.bind(this);this._idle=this._idle.bind(this);this._driftStep=this._driftStep.bind(this);this._contextMenu=this._contextMenu.bind(this)};SMap.Control.Mouse.prototype.setOwner=function(owner){this.$super(owner);if(!owner){return}this.configure(this._mode)};SMap.Control.Mouse.prototype.getMode=function(){return this._mode};SMap.Control.Mouse.prototype.configure=function(mode){JAK.Events.removeListeners(this._ec);this._mode=mode;var content=this._owner.getContent();this._ec.push(JAK.Events.addListener(content,"touchstart",this,"_touchStart"));if(this._mode&SMap.MOUSE_PAN){this._ec.push(JAK.Events.addListener(content,"mousedown",this,"_mouseDown"))}if(this._mode&SMap.MOUSE_WHEEL){this._ec.push(JAK.Events.addListener(content,"mousewheel DOMMouseScroll",this,"_scroll"))}if(this._mode&SMap.MOUSE_ZOOM_IN){this._ec.push(JAK.Events.addListener(content,"dblclick",this,"_dblClick"))}if(this._mode&SMap.MOUSE_ZOOM_OUT){this._ec.push(JAK.Events.addListener(content,"mouseup",this,"_rightClick"))}if(this._mode&SMap.MOUSE_ZOOM){this._ec.push(JAK.Events.addListener(content,"gesturestart",this,"_gestureStart"))}};SMap.Control.Mouse.prototype._mouseDown=function(e,elm){if(e.button!=JAK.Browser.mouse.left){return}var target=JAK.Events.getTarget(e);if(this._isInActive(target)&&!target.useMap){return}if(e.ctrlKey||e.metaKey){var controls=this.getMap().getControls();for(var i=0;i<controls.length;i++){if(controls[i]instanceof SMap.Control.Selection){return}}}this._ecMove.push(JAK.Events.addListener(window,"mousemove",this,"_mouseMove"));this._ecMove.push(JAK.Events.addListener(window,"mouseup",this,"_mouseUp"));this._commonStart(e.clientX,e.clientY)};SMap.Control.Mouse.prototype._touchStart=function(e,elm){var map=this.getMap();var coords=[];for(var i=0;i<e.touches.length;i++){coords.push(SMap.Coords.fromEvent(e.touches[i],map))}this._gesture.coords=map.computeCenterZoom(coords)[0];var target=JAK.Events.getTarget(e);if(this._isInActive(target)&&!target.useMap){return}if(this._ecMove.length>0){return}var t=e.touches[0];if(this._mode&SMap.MOUSE_ZOOM_IN&&this._isDoubleTouch(t)){this._dblClick(e)}this._doubleTouch.lastEvent=new SMap.Pixel(t.clientX,t.clientY);if(!(this._mode&SMap.MOUSE_PAN)){return}this._commonStart(t.clientX,t.clientY);this._ecMove.push(JAK.Events.addListener(document,"touchmove",this,"_touchMove"));this._ecMove.push(JAK.Events.addListener(document,"touchend",this,"_touchEnd"))};SMap.Control.Mouse.prototype._isDoubleTouch=function(t){var now=(new Date).getTime();if(!this._doubleTouch.lastTimestamp){this._doubleTouch.lastTimestamp=now;return false}var deltaTest=now-this._doubleTouch.lastTimestamp<this._doubleTouch.delay;var distX=Math.abs(this._doubleTouch.lastEvent.x-t.clientX);var distY=Math.abs(this._doubleTouch.lastEvent.y-t.clientY);var areaTest=Math.sqrt(distX*distX+distY*distY)<=this._doubleTouch.threshold;this._doubleTouch.lastTimestamp=now;return deltaTest&&areaTest};SMap.Control.Mouse.prototype._isInActive=function(target){var active=this.getMap().getLayerContainer(SMap.LAYER_ACTIVE);var node=target;while(node){if(node==active){return true}node=node.parentNode}return false};SMap.Control.Mouse.prototype._commonStart=function(ex,ey){if(this._drift.speed){this._stopDrift()}this._lastEvents=[new SMap.Pixel(ex,ey)];this._lastTimestamp=(new Date).getTime();this._moved=feMove=function(e,elm){this._commonMove(e.clientX,e.clientY)};SMap.Control.Mouse.prototype._touchMove=function(e,elm){JAK.Events.cancelDef(e);var t=e.touches[0];this._commonMove(t.clientX,t.clientY)};SMap.Control.Mouse.prototype._commonMove=function(ex,ey){var lastEvent=this._lastEvents[this._lastEvents.length-1];if(lastEvent.x==ex&&lastEvent.y==ey){return}var ts=(new Date).getTime();if(this.options.idleDelay){if(this._idleTimeout){clearTimeout(this._idleTimeout)}this._idleTimeout=setTimeout(this._idle,this.options.idleDelay)}if(!this._moved){this._moved=true;this.getMap().lock()}var last=this._lastEvents[this._lastEvents.length-1];var dx=ex-last.x;var dy=ey-last.y;this.getMap().setCenter(new SMap.Pixel(dx,dy).scale(1/this._gesture.scale));this._lastEvents.push(new SMap.Pixel(ex,ey));if(this._lastEvents.length>3){this._lastEvents.shift()}var speed=Math.sqrt(dx*dx+dy*dy)/(ts-this._lastTimestamp);if(Math.abs(speed)!=Infinity&&!isNaN(speed)){this._speed.push(speed)}if(this._speed.length>2){this._speed.shift()}this._lastTimestamp=ts};SMap.Control.Mouse.prototype._touchEnd=function(e,elm){if(e.touches.length>1){return}this._commonEnd()};SMap.Control.Mouse.prototype._mouseUp=function(e,elm){this._commonEnd()};SMap.Control.Mouse.prototype._commonEnd=function(){JAK.Events.removeListeners(this._ecMove);if(this._idleTimeout){clearTimeout(this._idleTimeout);this._idleTimeout=false}if(this._speed.length&&!this._drift.speed){var drifting=this._startDrift();if(drifting){return}}if(this._moved){this._resyncMap()}};SMap.Control.Mouse.prototype._startDrift=function(){var total=0;if(this._speed.length<2){return}for(var i=0;i<this._speed.length;i++){total+=this._speed[i]}var speed=20*total/this._speed.length;this._speed=[];if(speed<this.options.minDriftSpeed){return false}this._drift.speed=Math.min(speed,this.options.maxDriftSpeed);this._drift.moved=0;var first=this._lastEvents.shift();var last=this._lastEvents.pop();var dx=last.x-first.x;var dy=last.y-first.y;this._drift.direction=Math.atan2(dy,dx);JAK.Timekeeper.getInstance().addListener(this,"_driftStep");return true};SMap.Control.Mouse.prototype._stopDrift=function(){JAK.Timekeeper.getInstance().removeListener(this);this._drift.speed=0;this._resyncMap()};SMap.Control.Mouse.prototype._driftStep=function(){this._drift.speed*=this.options.driftSlowdown;var dx=Math.round(this._drift.speed*Math.cos(this._drift.direction));var dy=Math.round(this._drift.speed*Math.sin(this._drift.direction));this._drift.moved+=Math.sqrt(dx*dx+dy*dy);if(this._drift.moved>this.options.driftThreshold){this._drift.moved-=this.options.driftThreshold;this.getMap().redraw()}this.getMap().setCenter(new SMap.Pixel(dx,dy));if(this._drift.speed<=.2){this._stopDrift()}};SMap.Control.Mouse.prototype._resyncMap=function(){this.getMap().unlock();this.getMap().getSignals().makeEvent("cnction(){this._moved=false;this._speed=[];this._resyncMap()};SMap.Control.Mouse.prototype._dblClick=function(e,elm){this._zoom("1",e.clientX,e.clientY)};SMap.Control.Mouse.prototype._rightClick=function(e,elm){if(e.button!=JAK.Browser.mouse.right){return}if(this._context.timeout){clearTimeout(this._context.timeout);this._context.timeout=null;this._context.event=null;if(this._mode&SMap.MOUSE_ZOOM_OUT){this._zoom("-1",e.clientX,e.clientY)}return}var active=this.getMap().getLayerContainer(SMap.LAYER_ACTIVE);var node=JAK.Events.getTarget(e);while(node){if(node==active){return}node=node.parentNode}this._context.event={};for(var p in e){try{this._context.event[p]=e[p]}catch(e){}}this._context.timeout=setTimeout(this._contextMenu,300)};SMap.Control.Mouse.prototype._gestureStart=function(e,elm){if(this._ecGesture.length){return}var content=this._owner.getContent();this._ecGesture.push(JAK.Events.addListener(content,"gesturechange",this,"_gestureChange"));this._ecGesture.push(JAK.Events.addListener(content,"gestureend",this,"_gestureEnd"))};SMap.Control.Mouse.prototype._gestureChange=function(e,elm){JAK.Events.cancelDef(e);if(!this._gesture.coords){return}this._gesture.scale=e.scale;var map=this.getMap();if(!this._gesture.running){this._gesture.running=true;map.zoomAnimationStart(this._gesture.coords.toPixel(map),true)}var zoom=map.getZoom()+Math.log(this._gesture.scale)/Math.LN2;map.zoomAnimationStep(zoom)};SMap.Control.Mouse.prototype._gestureEnd=function(e,elm){JAK.Events.removeListeners(this._ecGesture);var map=this.getMap();this._gesture.coords=null;this._gesture.running=false;var diff=Math.log(this._gesture.scale)/Math.LN2;if(Math.abs(diff)<.3){diff=0}var roundedDiff=diff>0?Math.ceil(diff):Math.floor(diff);map.zoomAnimationTarget(map.getZoom()+roundedDiff,map.getZoom()+diff);this._gesture.scale=1};SMap.Control.Mouse.prototype._scroll=function(e,elm){if(e.wheelDeltaX&&e.wheelDeltaY===0){return}JAK.Events.cancelDef(e);var delta=e.wheelDelta||-e.detail;if(!delta){return}if(!this._checkScrollFrequency()){return}var x=e.clientX;var y=e.clientY;this._zoom(delta>0?"1":"-1",x,y)};SMap.Control.Mouse.prototype._checkScrollFrequency=function(){if(this.options.scrollDelay){if(this._scrollTimeout){return false}this._scrollTimeout=setTimeout(this._scrollUnlock,this.options.scrollDelay)}return true};SMap.Control.Mouse.prototype._zoom=function(direction,clientX,clientY){var pixel=null;if(clientX!==null&&clientY!=null){pixel=SMap.Pixel.fromEvent({clientX:clientX,clientY:clientY},this.getMap())}this.getMap().setZoom(direction,pixel,true);this.getMap().getSignals().makeEvent("control-mouse-zoom")};SMap.Control.Mouse.prototype._scrollUnlock=function(){this._scrollTimeout=false};SMap.Control.Mouse.prototype._contextMenu=function(){this._context.timeout=null;this.getMap().getSignals().makeEvent("map-contextmenu",this,{event:this._context.event});this._context.event=null};SMap.Control.Orientation=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Orientation",VERSION:"1.0",EXTEND:SMap.Control.Visible});SMap.Control.Orientation.prototype.$constructor=function(options){this.$super();this._options={title:SMap._("controlOrientation"),mode:"cw"};for(var p in options){this._options[p]=options[p]}this._build()};SMap.Control.Orientation.prototype._build=function(){this._dom.container=JAK.mel("div",{className:this._options.mode,title:this._options.title});this._ec.push(JAK.Events.addListener(this._dom.container,"click",this,"_click"))};SMap.Control.Orientation.prototype._click=function(e,elm){var o=this.getMap().getOrientation();var dir=this._options.mode=="cw"?1:-1;o=(o+dir).mod(4);this.getMap().setOrientation(o)};SMap.Control.Overview=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Overview",VERSION:"1.0",EXTEND:SMap.Control.Image});SMap.Control.Overview.prototype.$constructor=function(){this.$super(SMap.CONFIG.protocol+"//mapserver.mapy.cz/nahled2/0_{x}_{y}?"+SMap.fecoji("key")+"="+SMap.nigena());JAK.DOM.addClass(this._dom.container,"overview-map");this._projection=new SMap.Projection.UTM33;this._pixel=new SMap.Pixel(0,0)};SMap.Control.Overview.prototype._buildURL=function(){var center=this.getMap().getCenter();if(SMap.Util.pointInPolygon(center.toUTM33(),SMap.CONFIG.statesArea.cs.polygon)){var pp=this._projection.pixelToCoords(this._pixel,center,1,SMap.NORTH).toPP();pp[0]&=268173312;pp[1]&=268173312;return this.getMap().formatString(this._url,{x:pp[0].toString(16),y:pp[1].toString(16)})}else{return""}};SMap.Control.Layer=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Layer",VERSION:"2.1",EXTEND:SMap.Control.Visible});SMap.Control.Layer.prototype.$constructor=function(options){this.$super();this._options={width:65,items:3,page:3};for(var p in options){this._options[p]=options[p]}this._page=0;this._layers={};this._opened=false;this._menuClose=this._menuClose.bind(this);this._timer=totype.$destructor=function(){this._layers={};this.$super()};SMap.Control.Layer.prototype.setOwner=function(owner){this.$super(owner);if(!owner){return}this._sc.push(this.getMap().getSignals().addListener(this,"layer-enable","_layerChange"));this._sc.push(this.getMap().getSignals().addListener(this,"layer-disable","_layerChange"));for(var id in this._layers){this._checkLayer(id)}};SMap.Control.Layer.prototype.addLayer=function(id,label,src,title){this._layers[id]=this._buildItem(label,src,title);this._checkLayer(id);this._setPage(0)};SMap.Control.Layer.prototype.addDefaultLayer=function(id){if(id in SMap.CONFIG){var def=SMap.CONFIG[id];this.addLayer(id,def.labelLocaleKey?SMap._("mapsetLabel."+def.labelLocaleKey):undefined,SMap.CONFIG.img+"/"+def.preview,def.titleLocaleKey?SMap._("mapsetTitle."+def.titleLocaleKey):undefined)}else{throw new Error("Invalid default layer id "+id)}};SMap.Control.Layer.prototype.getContent=function(){return this._dom.window};SMap.Control.Layer.prototype.getActiveId=function(){for(var id in this._layers){var l=this.getMap().getLayer(id);if(l&&l.isActive()){return l.getId()}}return null};SMap.Control.Layer.prototype._maxPage=function(){var count=0;for(var id in this._layers){count++}return Math.ceil((count-this._options.items)/this._options.page)};SMap.Control.Layer.prototype._pageToPixel=function(page){return-page*this._options.page*this._options.width};SMap.Control.Layer.prototype._setPage=function(page){var i=new JAK.CSSInterpolator(this._dom.content,200);i.addProperty("left",this._pageToPixel(this._page),this._pageToPixel(page),"px");this._page=page;i.start();this._dom.prev.style.display=this._page?"":"none";this._dom.next.style.display=this._page!=this._maxPage()?"":"none"};SMap.Control.Layer.prototype._checkLayer=function(id){if(!this._owner){return}if(!(id in this._layers)){return}if(!this.getMap().getLayer(id)){return}this._syncLayer(id)};SMap.Control.Layer.prototype._syncLayer=function(id){var l=this.getMap().getLayer(id);var node=this._layers[id];if(l.isActive()){JAK.DOM.addClass(node,"active");if(SMap.CONFIG[id]&&SMap.CONFIG[id].zoom){var z=SMap.CONFIG[id].zoom;this.getMap().setZoomRange(z[0],z[1])}}else{JAK.DOM.removeClass(node,"active")}};SMap.Control.Layer.prototype._build=function(){this._dom.container=JAK.mel("div",{className:"layer-switch"});this._ec.push(JAK.Events.addListener(this._dom.container,"mouseover",this,"_mouseOver"));var text=JAK.mel("button");text.setAttribute("type","button");var span=JAK.mel("span",{innerHTML:SMap._("controlLayer")});text.appendChild(span);this._dom.container.appendChild(text);this._buildWindow()};SMap.Control.Layer.prototype._buildWindow=function(){this._dom.window=JAK.mel("div",{className:"window"},{display:"none"});this._dom.container.appendChild(this._dom.window);var port=JAK.mel("div",{className:"port"},{position:"relative",overflow:"hidden",width:this._options.width*this._options.items+"px"});this._dom.window.appendChild(port);var content=JAK.mel("div",{},{position:"relative"});port.appendChild(content);this._dom.content=content;var leftParent=JAK.mel("div",{className:"left"});this._dom.prev=JAK.mel("div",{className:"arrow"});leftParent.appendChild(this._dom.prev);this._dom.window.appendChild(leftParent);this._ec.push(JAK.Events.addListener(leftParent,"click",this,"_prev"));var rightParent=JAK.mel("div",{className:"right"});this._dom.next=JAK.mel("div",{className:"arrow"});rightParent.appendChild(this._dom.next);this._dom.window.appendChild(rightParent);this._ec.push(JAK.Events.addListener(rightParent,"click",this,"_next"));this._ec.push(JAK.Events.addListener(this._dom.window,"mouseout",this,"_mouseOut"));this._ec.push(JAK.Events.addListener(this._dom.window,"mouseover",this,"_closeCancel"))};SMap.Control.Layer.prototype._buildItem=function(label,src,title){var count=1;for(var p in this._layers){count++}this._dom.content.style.width=count*this._options.width+"px";var item=JAK.mel("div",{className:"item"},{width:this._options.width+"px",overflow:"hidden"});item.innerHTML="<div><img src='"+src+"' alt='"+label+"' title='"+(title||label)+"' /><div class='border'></div></div>"+"<p>"+label+"</p>";this._dom.content.appendChild(item);this._ec.push(JAK.Events.addListener(item,"click",this,"_itemClick"));return item};SMap.Control.Layer.prototype._open=function(){if(this._opened){return}this._opened=true;this._switchActivePage();if(JAK.Browser.client!="ie"){var end=function(){this._dom.window.style.filter=""};var i=new JAK.CSSInterpolator(this._dom.window,150,{endCallback:end.bind(this)});i.addProperty("opacity",0,1);i.start()}this._dom.window.style.display=""};SMap.Control.Layer.prototype._switchActivePage=function(){var arr=[];var map=this.getMap();var nodes=this._dom.content.childNodes;for(var i=0;i<nodes.length;i++){arr.push(nodes[i])}var index=-1;for(var id in this._layers){var l=map.getLayer(id);if(!l.isActive()){continue}index=arr.indexOf(this._layers[id]);break}if(index==-1){return}var firstVisible=this._page*this._options.page;if(index>=firstVisible&&index<firstVisible+this._options.items){return}var page=Math.ceil((index-this._options.items+1)/this._options.page);page=Math.max(0,page);this._setPage(page)};SMap.Control.Layer.prototype._menuClose=function(){if(!this._opened){return}var end=function(){this._dom.window.style.display="none";this._opened=false};if(JAK.Browser.client!="ie"){var i=new JAK.CSSInterpolator(this._dom.window,150,{endCallback:end.bind(this)});i.addProperty("opacity",1,0);i.start()}els._timer){window.clearTimeout(this._timer);this._timer=null}};SMap.Control.Layer.prototype._layerChange=function(e){var l=e.target;var id=l.getId();this._checkLayer(id)};SMap.Control.Layer.prototype._itemClick=function(e,elm){var node=elm;for(var id in this._layers){var item=this._layers[id];var l=this.getMap().getLayer(id);if(!l){continue}if(item!=node){this._disable(id)}}for(var id in this._layers){var item=this._layers[id];var l=this.getMap().getLayer(id);if(!l){continue}if(item==node){this._enable(id)}}this.getMap().getSignals().makeEvent("control-layer-click",this)};SMap.Control.Layer.prototype._mouseOver=function(e,elm){this._open()};SMap.Control.Layer.prototype._mouseOut=function(e,elm){var node=e.relatedTarget||e.toElement;while(node&&node!=document.documentElement){if(node==this._dom.container){return}node=node.parentNode}if(this._timer){window.clearTimeout(this._timer)}this._timer=window.setTimeout(this._menuClose,200)};SMap.Control.Layer.prototype._enable=function(id){var l=this.getMap().getLayer(id);if(l){l.enable()}};SMap.Control.Layer.prototype._disable=function(id){var l=this.getMap().getLayer(id);if(l){l.disable()}};SMap.Control.Layer.prototype._prev=function(e,elm){if(!this._page){return}this._setPage(this._page-1)};SMap.Control.Layer.prototype._next=function(e,elm){if(this._page==this._maxPage()){return}this._setPage(this._page+1)};SMap.Control.Zoom=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Zoom",VERSION:"1.0",EXTEND:SMap.Control.Visible});SMap.Control.Zoom.prototype.$constructor=function(labels,options){this.$super();this._zm_ec=[];this._zm_sc=[];this._labels=labels;this._zoom=[0,0];this._lastRedrawZoom=0;this._options={step:9,titles:[],sliderHeight:16,showZoomMenu:true};this._drag={};this._ec2=[];this._opened=false;this._menuClose=this._menuClose.bind(this);this._timer=null;for(var p in options){this._options[p]=options[p]}this._build()};SMap.Control.Zoom.prototype.$destructor=function(){this._unbindZoomMenu();this.$super()};SMap.Control.Zoom.prototype.setZoom=function(from,to){this._zoom=[from,to];this._adjustLine()};SMap.Control.Zoom.prototype.setOwner=function(owner){if(this._owner&&!owner){this.removeZoomMenu()}this.$super(owner);if(!owner){return}var map=this.getMap();this._sc.push(map.getSignals().addListener(this,"zoom-range-change","_zoomRangeChange"));var list=["plus","minus"];for(var i=0;i<list.length;i++){var name=list[i];var node=this._dom[name];this._ec.push(JAK.Events.addListener(node,"click",this,"_"+name))}if(this._options.showZoomMenu){this.addZoomMenu()}this._zoomRangeChange()};SMap.Control.Zoom.prototype.addZoomMenu=function(){this.removeZoomMenu();this._buildZoomMenu();this._bindZoomMenu();this._redraw(this._lastRedrawZoom)};SMap.Control.Zoom.prototype.removeZoomMenu=function(){if(this._dom.large){this._dom.large.parentNode.removeChild(this._dom.large);this._dom.large=null}this._unbindZoomMenu();this._zm_ec=[];this._zm_sc=[]};SMap.Control.Zoom.prototype._bindZoomMenu=function(){var map=this.getMap();this._zm_sc.push(map.getSignals().addListener(this,"map-redraw","_mapRedraw"));this._zm_sc.push(map.getSignals().addListener(this,"zoom-step","_zoomStep"));this._zm_ec.push(JAK.Events.addListener(this._dom.large,"mouseover",this,"_mouseOver"));this._zm_ec.push(JAK.Events.addListener(this._dom.large,"mouseover",this,"_closeCancel"));this._zm_ec.push(JAK.Events.addListener(this._dom.large,"mouseout",this,"_mouseOut"));this._zm_ec.push(JAK.Events.addListener(this._dom.large,"click",this,"_largeClick"));this._zm_ec.push(JAK.Events.addListener(this._dom.slider,"mousedown",this,"_sliderDown"));this._zm_ec.push(JAK.Events.addListener(this._dom.slider,"click",JAK.Events.stopEvent));var nodes=[this._dom.plus,this._dom.minus];for(var i=0;i<nodes.length;i++){var node=nodes[i];this._zm_ec.push(JAK.Events.addListener(node,"mouseover",this,"_mouseOver"));this._zm_ec.push(JAK.Events.addListener(node,"mouseover",this,"_closeCancel"));this._zm_ec.push(JAK.Events.addListener(node,"mouseout",this,"_mouseOut"))}};SMap.Control.Zoom.prototype._unbindZoomMenu=function(){JAK.Events.removeListeners(this._zm_ec);var map=this.getMap();if(map){map.getSignals().removeListeners(this._zm_sc)}};SMap.Control.Zoom.prototype._build=function(){this._dom.container=JAK.mel("div",{className:"zoom"});this._buildButtons()};SMap.Control.Zoom.prototype._buildZoomMenu=function(){this._dom.large=JAK.mel("div",{className:"zoom-menu"},{display:"none"});var parent=this._dom.buttonGroup.parentNode;parent.insertBefore(this._dom.large,this._dom.buttonGroup);var bg=["top","middle","bottom"];for(var i=0;i<bg.length;i++){var name=bg[i];var node=JAK.mel("div",{className:name},{width:"100%"});this._dom[name]=node;this._dom.large.appendChild(node)}this._buildLine();this._buildSlider();this._buildSliderBg()};SMap.Control.Zoom.prototype._buildButtons=function(){var list=[{name:"minus",title:this._options.titles[1],text:"-"},{name:"plus",title:this._options.titles[0],text:"+"}];var size=this._options.buttonSize;var ofs=this._options.buttonOffset;var buttonGroup=JAK.mel("div",{className:"button-group"});for(var i=0;i<list.length;i++){var item=list[i];var name=item.name;var node=JAK.mel("button",{className:name});node.setAttribute("type","button");node.setAttribute("aria-label",item.title);node.title=item.title;node.innerHTML=item.text;buttonGroup.appendChild(node);this._dom[name]=node}this._dom.buttonGroup=buttonGroup;this._dom.container.appendChild(buttonGroup)};SMap.Control.Zoom.prototype._buildLine=function(){var ofs=this._options.lineOffset;this._dom.line=JAK.mel("div",{className:"line"},{position:"absolute",cursor:"pointer"});this._dom.large.appendChild(this._dom.line);this._dom.labels=JAK.mel("div");this._dom.line.appendChild(this._dom.labels);this._adjustLine()};SMap.Control.Zoom.prototype._buildSlider=function(){var borderLongerSide=Math.floor(this._options.sliderHeight*.75);var borderShorterSide=Math.floor(borderLongerSide/2);var borderWidth=[borderShorterSide,borderLongerSide,borderShorterSide,0].join("px ");var style={position:"absolute",cursor:"pointer","border-width":borderWidth};this._dom.slider=JAK.mel("div",{className:"slider"},style);this._dom.line.appendChild(this._dom.slider)};SMap.Control.Zoom.prototype._buildSliderBg=function(){this._dom.sliderBg=JAK.mel("div",{className:"slider-bg"});this._dom.line.appendChild(this._dom.sliderBg)};SMap.Control.Zoom.prototype._adjustLine=function(){if(!this._dom.large){return}var z=this._zoom;var length=z[1]-z[0];if(z[1]==21){length+=2}var h=this._options.step*length;this._dom.middle.style.height=h+"px";h=this._options.step*(length+1);this._dom.line.style.height=h+"px";var step=this._options.step;JAK.DOM.clear(this._dom.labels);for(var zoom in this._labels){zoom=parseInt(zoom);if(zoom>=z[0]&&zoom<=z[1]){var label=JAK.mel("div",{className:"label"},{position:"absolute",cursor:"pointer"});label.innerHTML=this._labels[zoom];if(zoom==21){zoom+=1.5}var top=(zoom-z[0])*step;label.style.top=Math.round(top-3)+"px";this._dom.labels.appendChild(label)}}};SMap.Control.Zoom.prototype._plus=function(){if(!this._owner){return}this.getMap().setZoom("+1",null,true);this.getMap().getSignals().makeEvent("control-zoom-zoom")};SMap.Control.Zoom.prototype._minus=function(){if(!this._owner){return}this.getMap().setZoom("-1",null,true);this.getMap().getSignals().makeEvent(trol.Zoom.prototype._mouseOver=function(e,elm){this._open()};SMap.Control.Zoom.prototype._open=function(){if(this._opened){rt!="ie"){var end=function(){this._dom.large.style.filter=""};var i=new JAK.CSSInterpolator(this._dom.large,150,{endCallback:end.bind(this)});i.addProperty("opacity",0,1);i.start()}this._dom.large.style.display=""};SMap.Control.Zoom.prototype._mouseOut=function(e,elm){if(!this._opened){return}var node=e.relatedTarget||e.toElement;while(node&&node!=document.documentElement){if(node==this._dom.container){return}node=node.parentNode}if(this._timer){clearTimeout(this._timer)}this._timer=setTimeout(this._menuClose,200)};SMap.Control.Zoom.prototype._menuClose=function(){this._timer=null;var end=function(){this._dom.large.style.display="none";this._opened=false};if(JAK.Browser.client!="ie"){var i=new JAK.CSSInterpolator(this._dom.large,150,{endCallback:end.bind(this)});i.addProperty("opacity",1,0);i.start()}elif(this._timer){clearTimeout(this._timer);this._timer=null}};SMap.Control.Zoom.prototype._sliderDown=function(e,elm){JAK.Events.cancelDef(e);this._drag.mouseY=e.clientY;this._drag.y=this._dom.slider.offsetTop;this._drag.min=this._zoomToY(this._zoom[0]);this._drag.max=this._zoomToY(this._zoom[1]);this._ec2.push(JAK.Events.addListener(window,"mousemove",this,"_sliderMove"));this._ec2.push(JAK.Events.addListener(window,"mouseup",this,"_sliderUp"))};SMap.Control.Zoom.prototype._sliderMove=function(e,elm){var dy=e.clientY-this._drag.mouseY;this._drag.mouseY=e.clientY;this._drag.y+=dy;var top=Math.max(this._drag.y,this._drag.min);top=Math.min(top,this._drag.max);this._dom.slider.style.top=top+"px"};SMap.Control.Zoom.prototype._sliderUp=function(e,elm){this._ec2.forEach(JAK.Events.removeListener,JAK.Events);this._ec2=[];var y=this._dom.slider.offsetTop+this._options.sliderHeight/2;var zoom=this._yToZoom(y);this.getMap().setZoom(zoom);this.getMap().getSignals().makeEvent("control-zoom-zoom");this._redraw(zoom)};SMap.Control.Zoom.prototype._redraw=function(zoom){this._lastRedrawZoom=zoom;if(this._dom.slider){this._dom.slider.style.top=this._zoomToY(zoom)+"px";this._dom.slider.title=zoom}};SMap.Control.Zoom.prototype._mapRedraw=function(e){this._redraw(this.getMap().getZoom())};SMap.Control.Zoom.prototype._zoomStep=function(e){this._redraw(e.data.currentZoom)};SMap.Control.Zoom.prototype._zoomRangeChange=function(e){var zooms=this.getMap().getZoomRange();this.setZoom(zooms[0],zooms[1]);this._redraw(this.getMap().getZoom())};SMap.Control.Zoom.prototype._zoomToY=function(zoom){var step=this._options.step;var diff=zoom-this._zoom[0];if(zoom==21){diff+=2}var y=(diff+.5)*step-this._options.sliderHeight/2;return Math.round(y)};SMap.Control.Zoom.prototype._yToZoom=function(y){var zoom=this._zoom[0]+Math.floor(y/this._options.step);return Math.min(zoom,this._zoom[1])};SMap.Control.Zoom.prototype._largeClick=function(e,elm){var lineTop=this._dom.line.offsetTop;var lineBottom=lineTop+this._dom.line.offsetHeight;var pos=JAK.DOM.getBoxPosition(elm);var scroll=JAK.DOM.getScrollPos();var top=e.clientY-pos.top+scroll.y;if(top<lineTop){top=0}else if(top>lineBottom){top=this._dom.line.offsetHeight}else{top=top-lineTop}var zoom=this._yToZoom(top);this.getMap().setZoom(zoom);this.getMap().getSignals().makeEvent("control-zoom-zoom")};SMap.Control.Zoom.prototype._switchToOblique=function(e,elm){var z=this.getMap().getZoom();if(21-z<=4){this.getMap().setZoom(21,null,true)}else{this.getMap().setZoom(21)}this.getMap().getSignals().makeEvent("control-zoom-zoom")};SMap.Control.Copyright=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Copyright",VERSION:"2.0",EXTEND:SMap.Control.Visible});SMap.Control.Copyright.prototype.$constructor=function(){this.$super();this._date="";this._dom.container=JAK.mel("div",{className:"copyright print"});this._parts=[];this._static=[]};SMap.Control.Copyright.prototype.setOwner=function(owner){this.$super(owner);if(!owner){return}this._sc.push(this.getMap().getSignals().addListener(this,"layer-enable","_enable"));this._sc.push(this.getMap().getSignals().addListener(this,"layer-disable","_disable"));this._sc.push(this.getMap().getSignals().addListener(this,"map-redraw","_redraw"))};SMap.Control.Copyright.prototype.addCopyright=function(text){this._static.push("&copy; "+tee.setDate=function(text){this._date=text|nable=function(e){this._parts.push(e.target);this._redraw()};SMap.Control.Copyright.prototype._disable=function(e){var idx=this._parts.indexOf(e.target);if(idx!=-1){this._parts.splice(idx,1);this._redraw()}};SMap.Control.Copyright.prototype._redraw=function(){var map=this.getMap();if(!map){return}var z=map.getZoom();var arr=[];var count=1;for(var i=0;i<this._static.length;i++){arr.push(this._static[i])}for(var i=0;i<this._parts.length;i++){var c=this._parts[i].getCopyright(z);if(!c){continue}if(!(c instanceof Array)){c=[c]}for(var j=0;j<c.length;j++){var item="&copy; "+c[j];if(arr.indexOf(item)==-1){arr.push(item)}}}var showMore=arr.length>count;var copyrightParts;this._dom.container.title=arr.join(" | ").replace(/<[^>]+>|&[^;]+;/g,"");if(showMore){copyrightParts=arr.splice(0,count);copyrightParts[count-1]+=SMap._("controlCopyright")}else{copyrightParts=arr}var copyrightTxt=copyrightParts.join(" | ");this._dom.container.innerHTML=copyrightTxt+(this._date?" | "+this._date:"");var link=this._dom.container.querySelector("a[data-others='1']");if(link){var lang=SMap.lang==="cs"?"":"&lang="+SMap.lang;link.setAttribute("target","_blank");link.setAttribute("rel","noopener");link.setAttribute("href","https://licence.mapy.cz/?doc=mapy_attr"+lang)}};SMap.Control.Minimap=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Minimap",VERSION:"1.0",EXTEND:SMap.Control.Visible});SMap.Control.Minimap.prototype.$constructor=function(width,height,options){this.$super();this._options={diff:-4,opacity:.5,layer:SMap.DEF_BASE,color:"gray"};var w=width||150;var h=height||150;this._map=null;this._layer=new SMap.Layer.Geometry;this._dom.container=JAK.mel("div",{className:"minimap"},{width:w+"px",height:h+"px"});this.setOptions(options)};SMap.Control.Minimap.prototype.setOwner=function(owner){this.$super(owner);if(!owner){return}var map=this.getMap();var signals=map.getSignals();this._sc.push(signals.addListener(this,"map-redraw","_mapRedraw"));this._map=new SMap(this._dom.container,map.getCenter(),14);while(1){var controls=this._map.getControls();if(!controls.length){break}this._map.removeControl(controls[0])}this._map.addDefaultLayer(this._options.layer).enable();this._map.addLayer(this._layer).enable();this._mapRedraw()};SMap.Control.Minimap.prototype.setOptions=function(options){if(this._map){var layer=this._map.getLayer(this._options.layer);layer.disable();this._map.removeLayer(layer);layer.$destructor()}for(var p in options){this._options[p]=options[p]}this._dom.container.borderColor=this._options.color;if(this._map){this._map.addDefaultLayer(this._options.layer).enable();this._mapRedraw()}};SMap.Control.Minimap.prototype._mapRedraw=function(){var map=this.getMap();var zoom=map.getZoom();if(zoom==19){zoom=18}zoom+=this._options.diff;this._map.setCenterZoom(map.getCenter(),zoom);this._layer.removeAll();var size=map.getSize();var w=Math.round(size.x/2);var h=Math.round(size.y/2);var lt=new SMap.Pixel(-w,-h).toCoords(map);var rt=new SMap.Pixel(w,-h).toCoords(map);var lb=new SMap.Pixel(-w,h).toCoords(map);var rb=new SMap.Pixel(w,h).toCoords(map);size=this._map.getSize();var w=Math.round(size.x/2);var h=Math.round(size.y/2);var LT=new SMap.Pixel(-w,-h).toCoords(this._map);var RT=new SMap.Pixel(w,-h).toCoords(this._map);var LB=new SMap.Pixel(-w,h).toCoords(this._map);var RB=new SMap.Pixel(w,h).toCoords(this._map);var g=new SMap.Geometry(SMap.GEOMETRY_POLYGON,null,[lt,rt,rb,lb,lt,LT,LB,RB,RT,LT],{outlineOpacity:0,color:this._options.color,opacity:this._options.opacity});this._layer.addGeometry(g);var g=new SMap.Geometry(SMap.GEOMETRY_POLYGON,null,[lt,rt,rb,lb],{outlineColor:this._options.color,outlineOpacity:.8,color:"transparent"});this._layer.addGeometry(g)};SMap.Control.Rosette=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Rosette",VERSION:"1.0",EXTEND:SMap.Control.Visible});SMap.Control.Rosette.prototype.$constructor=function(options){this.$super();this._options={title:"",mode:"cw"};for(var p in options){this._options[p]=options[p]}this._build()};SMap.Control.Rosette.prototype.$destructor=function(){this.getMap().getSignals().removeListeners(this._sc);this.$super()};SMap.Control.Rosette.prototype.setOwner=function(owner){this.$super(owner);if(!owner){return}var s=this.getMap().getSignals();this._sc.push(s.addListener(this,"map-redraw","_redraw"));this._sc.push(s.addListener(this,"rotation-step","_tempRotate"));this._redraw()};SMap.Control.Rosette.prototype._build=function(){this._dom.container=JAK.mel("div",{className:"control-rosette"});this._dom.rosette=JAK.mel("img",{src:SMap.CONFIG.img+"/rosette.png"});this._dom.north=JAK.mel("div",{innerHTML:"s"});JAK.DOM.append([this._dom.container,this._dom.rosette,this._dom.north])};SMap.Control.Rosette.prototype._redraw=function(){var map=this.getMap();var center=map.getCenter();var x=map.getSize().x/2;var y=0;var coordsTop=new SMap.Pixel(x,y).toCoords(map);var azimuth=center.azimuth(coordsTop);this._rotate(azimuth,true)};SMap.Control.Rosette.prototype._rotate=function(angle,finalStep){if(finalStep){angle=90-angle;this._angle=angle}var v="rotate("+angle+"deg)";this._dom.rosette.style[SMap.TRANSFORM]=v};SMap.Control.Rosette.prototype._tempRotate=function(e){this._rotate(this._angle+e.data.angle)};SMap.Control.Scale=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Scale",VERSION:"1.0",EXTEND:SMap.Control.Visible});SMap.Control.Scale.prototype.$constructor=function(conf){this.$super();this._conf={min:1,max:3,padding:{left:0,right:"75%"}};this._numOfParts=1;this._scaleable=true;this._partsList=[];this._numbersList=[];if(typeof conf==="number"){this._conf.min=conf;this._conf.max=conf}else if(typeof conf==="object"){for(var key in conf){this._conf[key]=conf[key]}}this._conf.min=Math.max(Math.min(this._conf.min,this._conf.max),1);this._conf.max=Math.max(Math.max(this._conf.min,this._conf.max),1);if(this._conf.min==this._conf.max){this._scaleable=false;this._numOfParts=this._conf.min}this._limits={partMin:50,partMax:110,totalMax:200};this._units={1:"m",1e3:"km"};this._steps=[[1.5,1],[3,1],[6,1],[12,1],[25,1],[50,1],[100,1],[200,1],[400,1],[800,1],[1500,1e3],[3e3,1e3],[6e3,1e3],[12e3,1e3],[25e3,1e3],[5e4,1e3],[1e5,1e3],[2e5,1e3],[4e5,1e3],[8e5,1e3],[15e5,1e3],[3e6,1e3],[6e6,1e3],[1e7,1e3]];this._dom.container=JAK.mel("div",{className:"scale print"});this._dom.unit=null};SMap.Control.Scale.prototype.setOwner=function(owner){this.$super(owner);if(!owner){return}this._sc.push(this.getMap().getSignals().addListener(this,"map-redraw","_redraw"));if(this._scaleable){this._sc.push(this.getMap().getSignals().addListener(this,"port-sync","_portSync"))}this._setCount();this._build();this._redraw()};SMap.Control.Scale.prototype._build=function(){var unit=JAK.mel("span",{className:"unit"});var partsList=[];var numbersList=[];for(var i=0;i<this._numOfParts+2;i++){numbersList.push(JAK.mel("span"));if(i){partsList.push(JAK.mel("span",{className:i%2?"odd":"even"}))}}var numbers=JAK.mel("div",{className:"numbers"});numbersList.forEach(numbers.appendChild,numbers);var parts=JAK.mel("div",{className:"parts"});partsList.forEach(parts.appendChild,parts);var frag=document.createDocumentFragment();frag.appendChild(numbers);frag.appendChild(parts);frag.appendChild(unit);JAK.DOM.clear(this._dom.container);this._dom.container.appendChild(frag);this._partsList=partsList;this._numbersList=numbersList;this._dom.unit=unit};SMap.Control.Scale.prototype._redraw=function(){var scaleInfo=this._getScaleInfo();if(!scaleInfo){this._dom.container.style.display="none";return}this._dom.unit.innerHTML=this._units[scaleInfo.unit];var totalWidth=0;var totalLength=0;for(var i=0;i<=this._numOfParts;i++){var number=this._numbersList[i];number.style.display="";number.style.left=Math.round(1+totalWidth)+"px";number.innerHTML=totalLength/scaleInfo.unit;if(i<this._numOfParts){var part=this._partsList[i];part.style.display="";part.style.width=Math.round(scaleInfo.width)+"px"}else{this._dom.unit.style.left=Math.round(totalWidth)+"px"}totalWidth+=scaleInfo.width;totalLength+=scaleInfo.step}for(var i=this._numOfParts+1;i<this._numbersList.length;i++){this._numbersList[i].style.display="none";this._partsList[i-1].style.display="none"}this._dom.container.style.display=""};SMap.Control.Scale.prototype._getScaleInfo=function(){var map=this.getMap();var zoom=map.getZoom();var lat=map.getCenter().toWGS84()[1];var equator=156543.034/Math.pow(2,zoom);var parallel=equator*Math.cos(lat*Math.PI/180);var limits=this._limits;var width=null,step=null;unit=null,stepId=0;for(var i=0;i<this._steps.length;i++){var def=this._steps[i];var width=def[0]/parallel;if(width>limits.partMin&&width<limits.partMax){return{width:width,step:def[0],unit:def[1]}}}return null};SMap.Control.Scale.prototype._portSync=function(event){this._setCount(event.data.x)};SMap.Control.Scale.prototype._setCount=function(width){if(!this._scaleable)return;var scaleInfo=this._getScaleInfo();if(!scaleInfo)return;width=width||this.getMap().getSize().x;var padding=this._getPadding(width);var availWidth=width-padding.left-padding.right;var stepWidth=Math.ceil(scaleInfo.width);for(var i=this._conf.max;i>=this._conf.min;i--){if(i*stepWidth<=availWidth){var change=i!=this._numOfParts;this._numOfParts=i;if(change){this._build();this._redraw()}break}}};SMap.Control.Scale.prototype._getPadding=function(width){var output={left:0,right:0};var padding=this._conf.padding;if(typeof padding.left==="number"){output.left=padding.left}else if(typeof padding.left==="string"&&padding.left.indexOf("%")!=-1){output.left=Math.round(width*parseFloat(padding.left.replace("%",""))/100)}if(typeof padding.right==="number"){output.right=padding.right}else if(typeof padding.right==="string"&&padding.right.indexOf("%")!=-1){output.right=Math.round(width*parseFloat(padding.right.replace("%",""))/100)}return output};SMap.Control.Pointer=JAK.ClassMaker.makeClass({NAME:"SMap.Control.Pointer",VERSION:"1.0",IMPLEMENT:[JAK.ISignals],EXTEND:SMap.Control.Visible});SMap.Control.Pointer.TYPES={BLUE:{dimensions:{width:88,height:88,padding:5,backWidth:27,backHeight:44},backUrl:"/pointer/blue-back.svg"},RED:{dimensions:{width:88,height:88,padding:5,backWidth:27,backHeight:44},backUrl:"/pointer/red-back.svg"}};SMap.Control.Pointer.prototype.$constructor=function(options){this.$super();this._options={type:SMap.Control.Pointer.TYPES.BLUE,testAreaInc:7,angleCorrection:90,snapHUDtoScreen:0,showDistance:false};for(var p in options)this._options[p]=options[p];this._oldBrowser=false;this._alwaysShow=false;if(!("createElementNS"in document)){this._oldBrowser=true}this._dom=this._create();this._dom.container=this._dom.container;this._centepe._onClick=function(){this.makeEvent("pointer-click",this)};SMap.Control.Pointer.prototype._show=function(){this._dom.containeride=function(){this._dom.container.classList.remove("show")};SMap.Control.Pointer.prototype._create=function(){if(this._oldBrowser){return{container:document.createElement("div"),cover:document.createElement("div"),caption:null}}var xmlns="http://www.w3.org/2000/svg";var xlink="http://www.w3.org/1999/xlink";var dim=this._options.type.dimensions;var cover=document.createElementNS(xmlns,"svg");cover.setAttributeNS(xmlns,"xlink",xlink);cover.setAttributeNS(null,"width",dim.width);cover.setAttributeNS(null,"height",dim.height);cover.setAttribute("class","pointer-svg");var back=document.createElementNS(xmlns,"g");back.addEventListener("click",this._onClick.bind(this));cover.appendChild(back);var backUrl=this._options.type.backUrl;if(typeof backUrl==="string"){var backImg=document.createElementNS(xmlns,"image");backImg.setAttributeNS(xlink,"href",SMap.CONFIG.img+backUrl);backImg.setAttributeNS(null,"width",dim.backWidth);backImg.setAttributeNS(null,"height",dim.backHeight);backImg.setAttributeNS(null,"x","0");backImg.setAttributeNS(null,"y","0");backImg.setAttribute("class","pointer-back");back.appendChild(backImg)}var cont=document.createElement("div");cont.classList.add("pointer-cover");var caption=null;if(this._options.showDistance){caption=document.createElement("p");caption.innerHTML="";caption.classList.add("caption");cont.appendChild(caption)}cont.appendChild(cover);return{container:cont,cover:cover,back:back,caption:caption}};SMap.Control.Pointer.prototype.setCoords=function(center,alwaysShow){if(this._oldBrowser){return}this._hide();this._center=center;this._alwaysShow=alwaysShow;if(center){this.redraw()}};SMap.Control.Pointer.prototype.redraw=function(){var map=this.getMap();if(!map||!this._center)return;var mapSize=map.getSize();var center=this._center.toPixel(map);var screenCenter={x:Math.round(mapSize.x/2),y:Math.round(mapSize.y/2)};var pointerCenter={x:screenCenter.x+center.x,y:screenCenter.y+center.y};var angle=Math.round(Math.atan2(center.y,center.x)/Math.PI*180)+this._options.angleCorrection;var showDistance=this._options.showDistance;var pos;if(!(pointerCenter.x>=-this._options.testAreaInc&&pointerCenter.x<=mapSize.x+this._options.testAreaInc&&pointerCenter.y>=-this._options.testAreaInc&&pointerCenter.y<=mapSize.y+this._options.testAreaInc)){pos=this._countPosition(mapSize,screenCenter,pointerCenter,angle)}if(!pos&&this._alwaysShow){pos=pointerCenter;showDistance=false}if(pos){this._setPosition(pos,angle);if(showDistance){var borderPoint=new SMap.Pixel(pos.x-screenCenter.x,pos.y-screenCenter.y).toCoords(map);var distance=Math.round(borderPoint.distance(this._center));this._setCaption(pos,angle,distance)}this._show()}else{this._hide()}};SMap.Control.Pointer.prototype._countPosition=function(mapSize,screenCenter,pointerCenter){var intersection=false;var x,y;var pointerLine={x1:screenCenter.x,y1:screenCenter.y,x2:pointerCenter.x,y2:pointerCenter.y};var lines=this._getLines(mapSize,screenCenter);var distance=Infinity;lines.forEach(function(line){var lpi=this._lineIntersection(pointerLine,line);if(lpi){var newDistance=Math.round(Math.sqrt(Math.pow(lpi.x-screenCenter.x,2)+Math.pow(lpi.y-screenCenter.y,2)));if(newDistance<distance){x=lpi.x;y=lpi.y;intersection=true;distance=newDistance}}},this);if(intersection){return{x:x,y:y}}else{return null}};SMap.Control.Pointer.prototype._setPosition=function(pos,angle){var dim=this._options.type.dimensions;var halfSvgW=Math.floor(dim.width/2);var halfSvgH=Math.floor(dim.height/2);var point={x:pos.x-halfSvgW,y:pos.y-halfSvgH};this._setPadding(point,angle);this._dom.cover.style.left=Math.round(point.x)+"px";this._dom.cover.style.top=Math.round(point.y)+"px";var halfBackW=dim.backWidth/2;var tran=("translate({0}, {1}) rotate("+angle+" {2} 0)").replace("{0}",halfSvgW-halfBackW).replace("{1}",halfSvgH).replace("{2}",halfBackW);this._dom.back.setAttribute("transform",tran)};SMap.Control.Pointer.prototype._setCaption=function(pos,angle,distance){var dim=this._options.type.dimensions;var caption="";if(distance>1e3){caption=(distance/1e3).toFixed(1)+" km"}else{caption=distance+" m"}var halfBackW=dim.backWidth/2;var circleY=Math.round(dim.backHeight-halfBackW)+dim.padding;var dropAnchor=this._movePointByAngle(0,circleY,angle);this._dom.caption.style.left=Math.round(pos.x+dropAnchor.x)+"px";this._dom.caption.style.top=Math.round(pos.y+dropAnchor.y)+"px";this._dom.caption.innerHTML=caption.replace(".",",");this._dom.caption.classList.remove("left");this._dom.caption.classList.remove("right");if(angle>=0&&angle<=180){this._dom.caption.classList.add("left")}else{this._dom.caption.classList.add("right")}};SMap.Control.Pointer.prototype._movePointByAngle=function(x,y,angle){var rad=angle/180*Math.PI;return{x:x*Math.cos(rad)-y*Math.sin(rad),y:x*Math.sin(rad)+y*Math.cos(rad)}};SMap.Control.Pointer.prototype._setPadding=function(point,angle){var dim=this._options.type.dimensions;var moveVector=this._movePointByAngle(0,dim.padding||0,angle);point.x+=moveVector.x;point.y+=moveVector.y;return moveVector};SMap.Control.Pointer.prototype._getLines=function(mapSize,screenCenter){var map=this.getMap();var mapOffsetLeft=map.getContainer().offsetLeft;var mapOffsetTop=map.getContainer().offsetTop;var mapWidth=mapSize.x-mapOffsetLeft;var mapHeight=mapSize.y-mapOffsetTop;var lines=[{x1:0,y1:0,x2:mapWidth,y2:0},{x1:mapWidth,y1:0,x2:mapWidth,y2:mapHeight},{x1:mapWidth,y1:mapHeight,x2:0,y2:mapHeight},{x1:0,y1:mapHeight,x2:0,y2:0}];var mapControls=map.getControls();mapControls.forEach(function(ctrl){var c=ctrl.getContainer();if(!c)return;var style;if("getComputedStyle"in window){style=getComputedStyle(c)}else{style=c.style}display=style.display;visibility=style.visibility;if(!(display=="none"||visibility=="hidden")){if(c.tagName.toLowerCase()!="svg"){var h=c.offsetHeight;if(c.offsetWidth&&!h){var count=c.children.length;for(var i=0;i<count;i++){h=Math.max(h,c.children[i].offsetHeight)}}var bbox=[0,0,0,0];if(c.offsetLeft<screenCenter.x){var left=c.offsetLeft;bbox[0]=left;bbox[2]=bbox[0]+c.offsetWidth}else if(c.offsetLeft>=screenCenter.x){var right=mapWidth-c.offsetLeft-c.offsetWidth;bbox[0]=mapWidth-right-c.offsetWidth;bbox[2]=bbox[0]+c.offsetWidth}if(c.offsetTop<screenCenter.y){var top=c.offsetTop;bbox[1]=top;bbox[3]=bbox[1]+h}else if(c.offsetTop>=screenCenter.y){var bottom=mapHeight-c.offsetTop-c.offsetHeight;bbox[1]=mapHeight-bottom-h;bbox[3]=bbox[1]+h}var snapping=this._options.snapHUDtoScreen;if(snapping){if(bbox[0]<=snapping){bbox[0]=0}if(mapWidth-bbox[2]<=snapping){bbox[2]=mapWidth}if(bbox[1]<=snapping){bbox[1]=0}if(mapHeight-bbox[3]<=snapping){bbox[3]=mapHeight}}lines.push({x1:bbox[0],y1:bbox[1],x2:bbox[2],y2:bbox[1]});lines.push({x1:bbox[2],y1:bbox[1],x2:bbox[2],y2:bbox[3]});lines.push({x1:bbox[2],y1:bbox[3],x2:bbox[0],y2:bbox[3]});lines.push({x1:bbox[0],y1:bbox[3],x2:bbox[0],y2:bbox[1]})}}},this);return lines};SMap.Control.Pointer.prototype._lineIntersection=function(firstLine,secondLine){var TOLERANCE=1e-6;var a=this._det2(firstLine.x1-firstLine.x2,firstLine.y1-firstLine.y2,secondLine.x1-secondLine.x2,secondLine.y1-secondLine.y2);if(Math.abs(a)<TOLERANCE)return null;var d1=this._det2(firstLine.x1,firstLine.y1,firstLine.x2,firstLine.y2);var d2=this._det2(secondLine.x1,secondLine.y1,secondLine.x2,secondLine.y2);var x=this._det2(d1,firstLine.x1-firstLine.x2,d2,secondLine.x1-secondLine.x2)/a;var y=this._det2(d1,firstLine.y1-firstLine.y2,d2,secondLine.y1-secondLine.y2)/a;if(x<Math.min(firstLine.x1,firstLine.x2)-TOLERANCE||x>Math.max(firstLine.x1,firstLine.x2)+TOLERANCE)return null;if(y<Math.min(firstLine.y1,firstLine.y2)-TOLERANCE||y>Math.max(firstLine.y1,firstLine.y2)+TOLERANCE)return null;if(x<Math.min(secondLine.x1,secondLine.x2)-TOLERANCE||x>Math.max(secondLine.x1,secondLine.x2)+TOLERANCE)return null;if(y<Math.min(secondLine.y1,secondLine.y2)-TOLERANCE||y>Math.max(secondLine.y1,secondLine.y2)+TOLERANCE)return null;return{x:Math.rouer.prototype._det2=function(x1,x2,y1,y2){return x1*y2-y1*x2};SMap.Control.Pointer.prototype.setOwner=function(owner){this.$super(owner);if(!owner){return}if(this._center){this.redraw()}var s=this.getMap().getSignals();this._sc.push(s.addListener(this,"map-pan","redraw"));this._sc.push(s.addListener(this,"port-sync","redraw"));this._sc.push(s.addListener(this,"zoom-step","redraw"));this._sc.push(s.addListener(this,"zoom-stop","redraw"))};SMap.Control.ContextMenu=JAK.ClassMaker.makeClass({NAME:"SMap.Control.ContextMenu",VERSION:"1.0",EXTEND:SMap.Control});SMap.Control.ContextMenu.prototype.$constructor=function(){this.$super();this._isOpen=false;this._items=[];this._signals={};this._dom={};tctor=function(){if(this._isOpen){this.close()}this.$super()};SMap.Control.ContextMenu.prototype.setOwner=function(owner){this.$super(owner);this._ec.push(JAK.Events.addListener(document,"mousedown",this,"_mousedown"));this._ec.push(JAK.Events.addListener(this._dom.container,"mousedown",JAK.Events.stopEvent));this._ec.push(JAK.Events.addListener(this._dom.container,"contextmenu",JAK.Events.cancelDef));this._ec.push(JAK.Events.addListener(window,"resize",this,"_syncBlank"));this._ec.push(JAK.Events.addListener(window,"scroll",this,"_syncBlank"))};SMap.Control.ContextMenu.prototype.open=function(event,coords){var map=this.getMap();var c=coords||SMap.Coords.fromEvent(event,map);var menupos=new SMap.Pixel(event.clientX,event.clientY);this._positionMenu(menupos);for(var i=0;i<this._items.length;i++){this._items[i].setCoords(c,this)}if(!this._isOpen){this._closeSignal=this.getMap().getSignals().addListener(this,"map-redraw","close");this._isOpen=true;this._syncBlank()}};SMap.Control.ContextMenu.prototype.close=function(){if(!this._isOpen){return}this._dom.blank.parentNode.removeChild(this._dom.blank);this._dom.container.parentNode.removeChild(this._dom.container);this.getMap().getSignals().removeListener(this._closeSignal);this._closeSignal=null;this._isOpen=false};SMap.Control.ContextMenu.prototype.addItem=function(item,pos){var index=this._items.indexOf(item);if(index>=0){throw new Error("Can't add existing item")}index=arguments.length>1?pos:this._items.length;var container=item.getContainer();var next=index>=this._items.length?null:this._items[index].getContainer();this._dom.container.insertBefore(container,next);this._items.splice(index,0,item)};SMap.Control.ContextMenu.prototype.removeItem=function(item){var index=this._items.indexOf(item);if(index==-1){throw new Error("Can't remove non-existent item")}this._items.splice(index,1);var container=item.getContainer();container.parentNode.removeChild(container)};SMap.Control.ContextMenu.prototype.getItems=function(){return this._items};SMap.Control.ContextMenu.prototype.clearItems=function(){JAK.DOM.clear(this._dom.container);this._items=[]};SMap.Control.ContextMenu.prototype.addSignal=function(name,callback){if(name in this._signals){throw new Error("Signal '"+name+"' already handled")}this._signals[name]=callback;var signals=this.getMap().getSignals();this._sc.push(signals.addListener(this,name,"_signal"))};SMap.Control.ContextMenu.prototype._positionMenu=function(menupos){document.body.appendChild(this._dom.blank);var cornerTB="Top";var cornerLR="Left";this._dom.container.style.visibility="hidden";document.body.appendChild(this._dom.container);var scroll=JAK.DOM.getScrollPos();menupos.x+=scroll.x;menupos.y+=scroll.y;var port=JAK.DOM.getDocSize();if(menupos.x>port.width/2){menupos.x-=this._dom.container.offsetWidth;cornerLR="Right"}if(menupos.y>port.height/2){menupos.y-=this._dom.container.offsetHeight;cornerTB="Bottom"}this._dom.container.style.left=menupos.x+"px";this._dom.container.style.top=menupos.y+"px";var shift=JAK.DOM.shiftBox(this._dom.container);menupos.x+=shift[0];menupos.y+=shift[1];this._dom.container.style.left=menupos.x+"px";this._dom.container.style.top=menupos.y+"px";var lr=["Left","Right"];var tb=["Top","Bottom"];lr.forEach(function(lr){tb.forEach(function(tb){var value=lr==cornerLR&&tb==cornerTB?"0":"";this._dom.container.style["border"+tb+lr+"Radius"]=value},this)},this);this._dom.container.style.visibility=""};SMap.Control.ContextMenu.prototype._mousedown=function(e,elm){if(this._isOpen){this.e._mapContextMenu=function(evnt){this.open(evnt.data.event)};SMap.Control.ContextMenu.prototype._build=function(){this._dom.blank=JAK.mel("div",{},{position:"absolute"});this._dom.container=JAK.mel("div",{className:"context-menu"});this._ec.push(JAK.Events.addListener(this._dom.container,"click",this,"_click"))};SMap.Control.ContextMenu.prototype._click=function(e,elm){JAK.Events.cancelDef(e);var containers=[];for(var i=0;i<this._items.length;i++){containers.push(this._items[i].getContainer())}var node=JAK.Events.getTarget(e);while(node!=this._dom.container){var index=containers.indexOf(node);if(index!=-1){this._items[index].click(e,this);return}node=node.parentNode}};SMap.Control.ContextMenu.prototype._signal=function(e){if(!(e.type in this._signals)){return}this._signals[e.type](this,e)};SMap.Control.ContextMenu.prototype._syncBlank=function(){if(!this._isOpen){return}var scroll=JAK.DOM.getScrollPos();this._dom.blank.style.left=scroll.x+"px";this._dom.blank.style.top=scroll.y+"px";var size=JAK.DOM.getDocSize();this._dom.blank.style.width=size.width+"px";this._dom.blank.style.height=size.height+"px"};SMap.Control.ContextMenu.Item=JAK.ClassMaker.makeClass({NAME:"SMap.Control.ContextMenu.Item",VERSION:"1.0"});SMap.Control.ContextMenu.Item.prototype.$constructor=function(label){this._label=label;this._disabled=false;this._coords=null;this._ec=[];this._dom={};this._build()};SMap.Control.ContextMenu.Item.prototype.$destructor=function(){while(this._ec.length){JAK.Events.removeListener(this._ec.shift())}};SMap.Control.ContextMenu.Item.prototype.click=function(e,menu){if(this._disabled){return}};SMap.Control.ContextMenu.Item.prototype.enable=function(){JAK.DOM.removeClass(this._dom.container,"disabled");this._disabled=false};SMap.Control.ContextMenu.Item.prototype.disable=function(){JAK.DOM.addClass(this._dom.container,"disabled");this._disabled=true};SMap.Control.ContextMenu.Item.prototype.setCoords=function(coords){this._coords=coords};SMap.Control.ContextMenu.Item.prototype.getContainer=function(){return this._dom.container};SMap.Control.ContextMenu.Item.prototype._build=function(){var node=JAK.mel("a",{href:"#",className:"item"});node.innerHTML=this._label;this._dom.container=node};SMap.Control.ContextMenu.Zoom=JAK.ClassMaker.makeClass({NAME:"SMap.Control.ContextMenu.Zoom",VERSION:"1.0",EXTEND:SMap.Control.ContextMenu(label,zoomDiff){this.$super(label);this._zoomDiff=zoomDiff};SMap.Control.ContextMenu.Zoom.prototype.setCoords=function(coords,menu){this.$super(coords);var zoom=menu.getMap().getZoom();var range=menu.getMap().getZoomRange();var newZoom=zoom+this._zoomDiff;if(newZoom>=range[0]&&newZoom<=range[1]){this.enable()}else{this.disable()}};SMap.Control.ContextMenu.Zoom.prototype.click=function(e,menu){if(this._disabled){return}menu.getMap().setZoom(this._zoomDiff==1?"+1":"-1",this._coords,true);menu.close()};SMap.Control.ContextMenu.Coords=JAK.ClassMaker.makeClass({NAME:"SMap.Control.ContextMenu.Coords",VERSION:"1.0",EXTEND:SMap.Control.ContextMenu.Item});SMap.Control.ContextMenu.Coords.prototype.$constructor=function(){this.$super("")};SMap.Control.ContextMenu.Coords.prototype._build=function(){var node=JAK.mel("span",{className:"item"});this._dom.container=node};SMap.Control.ContextMenu.Coords.prototype.setCoords=function(coords,menu){this.$super(coords);this._dom.container.innerHTML=coords.toWGS84(2).reverse().join(", ")};SMap.Control.ContextMenu.Separator=JAK.ClassMaker.makeClass({NAME:"SMap.Control.ContextMenu.Separator",VERSION:"1.0",EXTEND:SMap.Control.ContextMenu.Item});SMap.Control.ContextMenu.Separator.prototype.$constructor=function(){this.$super("")};SMap.Control.ContextMenu.Separator.prototype._build=function(){var node=JAK.mel("span",{className:"item separator"});this._dom.container=node};(function(){var _TYPES={UNIVERSALBIG:{name:"universalbig",size:[48,66],anchor:{left:24,top:66},icon:false,img:false},BIG:{name:"big",size:[48,66],anchor:{left:24,top:66},icon:true,img:true},MIDDLE:{name:"middle",size:[40,55],anchor:{left:20,top:55},icon:true,img:true},UNIVERSAL:{name:"universal",size:[32,44],anchor:{left:16,top:44},icon:false,img:false},SMALL:{name:"small",size:[32,44],anchor:{left:16,top:44},icon:true,img:false},LITTLE:{name:"little",size:[14,19],anchor:{left:7,top:19},icon:false,img:false},POI:{name:"poi",size:[20,20],anchor:{left:10,top:10},icon:true,img:false},PAID:{name:"paid",size:[42,50],anchor:{left:21,top:50},icon:true,img:false}};var Marker=function Marker(coords,id,opts){this._conf={type:_TYPES.UNIVERSAL,icon:"",img:"",elm:null,size:null,anchor:null,onlyElm:true};Object.assign(this._conf,opts);this._poi=null;this._active=true;this._isMouseEnter=false;this._lastSignal="";this._sc=[];this._userId=id;this._cardOpts={cb:null,showTimeout:500,hideTimeout:250,rqTimeout:0,anchor:{left:0,top:0},hidden:false};this._card={obj:null,hideID:null,showID:null,reqID:null,promiseStart:0,fill:false};this.$constructor(coords,id)};Marker.prototype=Object.create(SMap.Marker.prototype);Marker.prototype.$destructor=function(){this._clearTO("show");this._clearTO("hide");this._clearTO("req");SMap.Marker.prototype.$destructor.call(this)};Marker.prototype.setPOI=function(poi){this._poi=poi};Marker.prototype.getPOI=function(){return this._poi};Marker.prototype.getSource=function(){return this._poi.source};Marker.prototype.getPlainId=function(){return this._poi.id};Marker.prototype.getType=function(){return this._conf.type};Marker.prototype.getConf=function(){return this._conf};Marker.prototype.setActive=function(state){this._active=!!state;this._dom.active.classList[this._active?"remove":"add"]("non-active")};Marker.prototype.getActiveFlag=function(){return this._active};Marker.prototype.setPopupCallback=functiptions){for(var p in options){this._cardOpts[p]=options[p]}};Marker.prototype.moveCard=function(){if(this._dom.active.classList.contains("active")&&this._card&&this._card.obj){this.getMap().addCard(this._card.obj,this._getCardCoords(),true)}};Marker.prototype.click=function(e){var target=e.target&&e.target.closest("a");if(target&&SMap.Util.linkToNewWindow(e))return;e.preventDefault();this._makeSignal("marker-click")};Marker.prototype.handleEvent=function(e){switch(e.type){case"mouseenter":if(this._dom.active.contains(e.target)){this._isMouseEnter=true;if(!this._cardOpts.cb&&!this._card.obj||this._card.obj&&this._cardOpts.hidden){this._makeSignal("marker-enter");if(this._poi){this._makeSignal("marker-poi-enter")}return}if(!this._card.obj){this._createCard()}this._updateCard();this._clearTO("hide");if(!this._card.promiseStart){this.showCard()}}else if(this._dom.card.contains(e.target)){this._clearTO("hide")}break;case"mouseleave":if(this._dom.active.contains(e.target)){this._clearTO("req");if(this._card.obj){var relTar=e.relatedTarget||e.toElement;if(relTar){if(this._dom.card.contains(relTar)){return}}this._popupLeave()}else{this._makeSignal("marker-leave");if(this._poi){this._makeSignal("marker-poi-leave")}}}else if(this._dom.card.contains(e.tarrker.prototype.setPopupCb=function(cb){this._cardOpts.cb=cb};Marker.prototype.getCard=function(){return this._dom.card};Marker.prototype.showCard=function(timeout){var _this=this;timeout=typeof timeout==="number"?timeout:this._cardOpts.showTimeout;if(!this._card.obj){this._createCard();this._updateCard()}this._makeSignal("marker-enter");if(this._poi){this._makeSignal("marker-poi-enter")}this._clearTO("show");this._card.showID=setTimeout(function(){if(!_this._owner)return;_this._dom.active.classList.add("active");_this.getMap().addCard(_this._card.obj,_this._getCardCoords(),true)},timeout)};Marker.prototype.removeCard=function(){if(!this._owner)return;this._clearTO("show");this._clearTO("hide");this._clearTO("req");this._dom.active.classList.remove("active");if(this._card.obj&&this.getMap()&&this.getMap().getCard()==this._card.obj){this.getMap().removeCard()}};Marker.prototype._createCard=function(){this._card.obj=new SMap.Card(null,{close:false,anchor:this._cardOpts.anchor});var cardCont=this._card.obj.getContainer();cardCont.classList.add("marker-popup");cardCont.addEventListener("mouseenter",this,false);cardCont.addEventListener("mouseleave",this,false);var map=this.getMap();if(map){this._sc.push(map.getSignals().addListener(this,"zoom-start","_zoomStart"))}this._dom.card=cardCont};Marker.prototype._updateCard=function(){var _this2=this;if(this._cardOpts.cb&&!this._card.fill){this._clearTO("req");this._card.reqID=setTimeout(function(){var output=_this2._cardOpts.cb.apply(_this2,[_this2._card.obj]);if(output instanceof Promise){_this2._card.promiseStart=Date.now();output.then(function(){if(_this2._isMouseEnter){var diff=Date.now()-_this2._card.promiseStart;var timeout=diff<_this2._cardOpts.showTimeout?_this2._cardOpts.showTimeout-diff:0;_this2.showCard(timeout)}_this2._card.fill=true;_this2._card.promiseStart=0})}else{_this2._card.fill=true}_this2._card.reqID=null},this._cardOpts.rqTimeout)}};Marker.prototype._build=function(){var type=this._conf.type;this._options.size=this._conf.size||this._conf.type.size;this._options.anchor=this._conf.anchor||this._conf.type.anchor;var el=document.createElement("a");el.className="marker type-"+type.name;if(this._userId){el.id=this._userId}if(type.name=="poi"){el.style.width=this._options.size[0]+"px";el.style.height=this._options.size[1]+"px"}else{var bg=document.createElement("span");bg.className="marker-bg-wrapper";if(type==_TYPES.PAID){bg.innerHTML='<img src="'+SMap.CONFIG.img+"/marker/"+type.name+'.png" alt="" />'}else{var prefix=SMap.CONFIG.img+"/wmmarker/"+type.name;bg.innerHTML='<img src="'+prefix+'.png" srcset="'+prefix+".png 1x, "+prefix+"@2x.png 2x, "+prefix+'@3x.png 3x" />';var before=document.createElement("span");before.className="before";before.innerHTML='<img src="'+prefix+'.png" srcset="'+prefix+".png 1x, "+prefix+"@2x.png 2x, "+prefix+'@3x.png 3x" />';el.appendChild(before)}el.appendChild(bg)}if(this._conf.elm){el.appendChild(this._conf.elm)}if(!this._conf.elm||!this._conf.onlyElm){var img=type.img&&this._conf.img;var icon=type.icon&&this._conf.icon;if(img||icon){var imgCont=document.createElement("img");imgCont.className="img-cont "+(img?"imag);imgCont.onload=function(){imgCont.classList.add("loaded")};if(this._conf.srcset){imgCont.srcset=this._conf.srcset;imgCont.style.width=(this._conf.size||_TYPES.POI.size)[0]+"px";imgCont.style.height=(this._conf.size||_TYPES.POI.size)[1]+"px"}imgCont.src=img||icon;imgCont.alt="";if(imgCont.complete){imgCont.classList.add("loaded")}el.appendChild(imgCont)}}this._dom.container[SMap.LAYER_MARKER]=el;this._dom.active=el;el.addEventListener("mouseenter",this,false);el.addEventListener("mouseleave",this,false)};Marker.prototype._clearTO=function(name){name=name+"ID";if(this._card[name]){clearTimeout(this._card[name]);this._card[name]=null}};Marker.prototype._popupLeave=function(){var _this3=this;this._isMouseEnter=false;this._makeSignal("marker-leave");if(this._poi){this._makeSignal("marker-poi-leave")}this._clearTO("show");this._clearTO("hide");this._card.hideID=setTimeout(function(){if(_this3.getMap()){_this3.getMap().getSignals().removeListeners(_this3._sc);_this3._sc=[]}_this3.removeCard()},this._cardOpts.hideTimeout)};Marker.prototype._makeSignal=function(){var signalName=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";if(!this._owner||this._lastSignal==signalName)return;var map=this.getMap();if(map){map.getSignals().makeEvent(signalName,this)}this._lastSignal=signalName};Marker.prototype._zoomStart=function(){if(!this._card.obj)return;this.removeCard()};Marker.prototype._getCardCoords=function(){var map=this.getMap();var px=this.getCoords().toPixel(map);var offset=this.getMap().getOffset();var dY=0;switch(this._conf.type){case _TYPES.UNIVERSALBIG:case _TYPES.BIG:dY=-43;break;case _TYPES.MIDDLE:dY=-36;break;case _TYPES.UNIVERSAL:case _TYPES.SMALL:dY=-28;break;case _TYPES.LITTLE:dY=-13;break;case _TYPES.POI:dY=10-this._options.size[1]/2;break;case _TYPES.PAID:dY=-26;break}var left=parseFloat((this._dom.active.style.left||"0").replace("px",""))+this._options.anchor.left;var top=parseFloat((this._dom.active.style.top||"0").replace("px",""))+this._options.anchor.top;var diffX=left-(px.x+offset.x*-1);var diffY=top-(px.y+offset.y*-1)+dY;return px.plus(new SMap.Pixel(diffX,diffY)).toCoords(map)};SMap.WMMarker=Marker;SMap.WMMarker.TYPES=_TYPES;SMap.WMMarker.getFilterMultimarker=function(){var filter={};var keys=Object.keys(_TYPES);keys.forEach(function(key){var item=_TYPES[key];if(["poi","paid","universal","universalbig"].indexOf(item.name)!=-1)return;filter[item.name]={width:item.size[0],height:item.size[1]}});return filter};SMap.WMMarker.fromPOI=function(poi,id,opts){var markerCoords=SMap.Coords.fromWGS84(poi.mark.lon,poi.mark.lat);var typeId="universal";if(poi.markerId){typeId=poi.markerId}var params={type:_TYPES[typeId.toUpperCase()]};if(poi.url){params.icon=poi.url;if(poi.url2x&&poi.size){params.srcset=poi.url+" 1x, "+poi.url2x+" 2x"}}var marker=new Marker(markerCoords,id,Object.assign(params,opts));marker.setPOI(poi);return marker}})();SMap.Layer.GPX=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.GPX",VERSION:"1.0",EXTEND:SMap.Layer.Multi});SMap.Layer.GPX.parseCoords=function(node){var lat=node.getAttribute("lat");var lon=node.getAttribute("lon");var coords;if(lat==="0"&&lon==="0"){coords=null}else{lat=parseFloat(lat);lon=parseFloat(lon);coords=SMap.Coords.fromWGS84(lon,lat)}return coords};SMap.Layer.GPX.prototype.$constructor=function(xmlDoc,id,options){this.$super(id);this._options={maxPoints:100,colors:["#004c8c","#ff4911","#ffd625","#5ea221","#840026","#89cdff","#374705","#b3d200","#522476","#ff9b11","#c9000e","#008ad4"]};for(var p in options){this._options[p]=options[p]}this._routes=[];this._tracks=[];this._waypoints=[];this._bounds=null;this._largestCount=0;this._parse(xmlDoc)};SMap.Layer.GPX.prototype.fit=function(){var all=[];if(this._bounds){all=this._bounds}else{for(var i=0;i<this._waypoints.length;i++){all.push(this._waypoints[i].getCoords())}for(var i=0;i<this._routes.length;i++){all=all.concat(this._routes[i].getCoords())}for(var i=0;i<this._tracks.length;i++){all=all.concat(this._tracks[i].getCoords())}}var cz=this.getMap().computeCenterZoom(all);this.getMap().setCenterZoom(cz[0],cz[1])};SMap.Layer.GPX.prototype.filter=function(set,options){var maxPoints=this._options.maxPoints;if(options.adaptive){maxPoints=Math.round(maxPoints*set.length/this._largestCount)}if(maxPoints==0||maxPoints>=set.length){return set}var arr=[];var step=(set.length-1)/(maxPoints-1);var index=0;for(var i=0;i<maxPoints;i++){arr.push(set[Math.round(index)]);index+=step}return arr};SMap.Layer.GPX.prototype.createMarker=function(node){return new SMap.Marker.GPX(node,this._options.url)};SMap.Layer.GPX.prototype._parse=function(xmlDoc){this._computeLargestCount(xmlDoc);var wpts=xmlDoc.getElementsByTagName("wpt");wpts=this.filter(wpts,{adaptive:false});for(var i=0;i<wpts.length;i++){var wpt=this.createMarker(wpts[i]);if(wpt.getCoords()!=null){this._waypoints.push(wpt)}}var index=0;var colors=this._options.colors;var routes=xmlDoc.getElementsByTagName("rte");for(var i=0;i<routes.length;i++){var route=new SMap.Geometry.GPXRoute(this,routes[i],colors[index%colors.length]);this._routes.push(route);index++}var tracks=xmlDoc.getElementsByTagName("trk");for(var i=0;i<tracks.length;i++){var track=new SMap.Geometry.GPXTrack(this,tracks[i],colors[index%colors.length]);this._tracks.push(track);index++}this._buildLayers();var b=xmlDoc.getElementsByTagName("bounds");if(b.length){b=b[0];var minlat=parseFloat(b.getAttribute("minlat"));var minlon=parseFloat(b.getAttribute("minlon"));var maxlat=parseFloat(b.getAttribute("maxlat"));var maxlon=parseFloat(b.getAttribute("maxlon"));var c1=SMap.Coords.fromWGS84(minlon,minlat);var c2=SMap.Coords.fromWGS84(maxlon,maxlat);this._bounds=[c1,c2]}};SMap.Layer.GPX.prototype._computeLargestCount=function(xmlDoc){var count=0;var parents1=xmlDoc.getElementsByTagName("rte");var parents2=xmlDoc.getElementsByTagName("trkseg");for(var i=0;i<parents1.length;i++){count=Math.max(count,parents1[i].getElementsByTagName("rtept").length)}for(var i=0;i<parents2.length;i++){count=Math.max(count,parents2[i].getElementsByTagName("trkpt").length)}this._largestCount=count};SMap.Layer.GPX.prototype._buildLayers=function(){if(this._waypoints.length){var l=new SMap.Layer.Marker;this.addLayer(l);for(var i=0;i<this._waypoints.length;i++){l.addMarker(this._waypoints[i])}}if(this._routes.length+this._tracks.length){var l=new SMap.Layer.Geometry;this.addLayer(l);for(var i=0;i<this._routes.length;i++){l.addGeometry(this._routes[i])}for(var i=0;i<this._tracks.length;i++){l.addGeometry(this._tracks[i])}}};SMap.Marker.GPX=JAK.ClassMaker.makeClass({NAME:"SMap.Marker.GPX",EXTEND:SMap.Marker,VERSION:"2.0"});SMap.Marker.GPX.prototype.$constructor=function(node,url){var name=node.getElementsByTagName("name");name=name.length?JAK.XML.textContent(name[0]):"";var desc=node.getElementsByTagName("desc");desc=desc.length?JAK.XML.textContent(desc[0]):"";var options={};if(name){options.title=name}if(url){options.url=url}var coords=SMap.Layer.GPX.parseCoords(node);this.$super(coords,null,options);if(name||desc){var c=new SMap.Card;c.getHeader().innerHTML=name;c.getBody().innerHTML=desc;this.decorate(SMap.Marker.Feature.Card,c)}};SMap.Geometry.GPXRoute=JAK.ClassMaker.makeClass({NAME:"SMap.Geometry.GPXRoute",EXTEND:SMap.Geometry,VERSION:"2.0"});SMap.Geometry.GPXRoute.prototype.$constructor=function(gpx,node,color){var options={width:4,color:color,opacity:.7};var coords=[];var rtepts=node.getElementsByTagName("rtept");rtepts=gpx.filter(rtepts,{adaptive:true});for(var i=0;i<rtepts.length;i++){var c=SMap.Layer.GPX.parseCoords(rtepts[i]);if(c!=null){coords.push(c)}}var name=node.getElementsByTagName("name");if(name.length){options.title=JAK.XML.textContent(name[0])}this.$super(SMap.GEOMETRY_POLYLINE,null,coords,options)};SMap.Geometry.GPXTrack=JAK.ClassMaker.makeClass({NAME:"SMap.Geometry.GPXTrack",EXTEND:SMap.Geometry,VERSION:"2.0"});SMap.Geometry.GPXTrack.prototype.$constructor=function(gpx,node,color){var options={width:4,color:color,opacity:.7};var coords=[];var segments=node.getElementsByTagName("trkseg");for(var i=0;i<segments.length;i++){var c=[];var pts=segments[i].getElementsByTagName("trkpt");pts=gpx.filter(pts,{adaptive:true});for(var j=0;j<pts.length;j++){var cc=SMap.Layer.GPX.parseCoords(pts[j]);if(cc!=null){c.push(cc)}}coords=coords.concat(c)}var name=node.getElementsByTagName("name");if(name.length){options.title=JAK.XML.textContent(name[0])}this.$super(SMap.GEOMETRY_POLYLINE,null,coords,options)};SMap.Layer.KML=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.KML",VERSION:"1.0",EXTEND:SMap.Layer.Multi});SMap.Layer.KML.prototype.$constructor=function(xmlDoc,id,options){this.$super(id);this._xmlDoc=xmlDoc;this._ids={};this._options={maxPoints:100,url:""};for(var p in options){this._options[p]=options[p]}var all=xmlDoc.getElementsByTagName("*");for(var i=0;i<all.length;i++){var node=all[i];var id=node.getAttribute("id");if(id){this._ids[id]=node}}this._markers=[];this._geometries=[];this._parse()};SMap.Layer.KML.prototype._parse=function(){var nodes=this._xmlDoc.getElementsByTagName("Placemark");for(var i=0;i<nodes.length;i++){var placemark=nodes[i];var points=placemark.getElementsByTagName("Point");for(var j=0;j<points.length;j++){var marker=new SMap.Marker.KML(this,points[j],placemark);this._markers.push(marker)}var lines=placemark.getElementsByTagName("LineString");for(var j=0;j<lines.length;j++){var line=new SMap.Geometry.KMLLine(this,lines[j],placemark);this._geometries.push(line)}var polygons=placemark.getElementsByTagName("Polygon");for(var j=0;j<polygons.length;j++){var polygon=new SMap.Geometry.KMLPolygon(this,polygons[j],placemark);this._geometries.push(polygon)}var rings=placemark.getElementsByTagName("LinearRing");for(var j=0;j<rings.length;j++){var ring=rings[j];if(ring.parentNode.nodeName.toLowerCase()!="placemark"){continue}var line=new SMap.Geometry.KMLLine(this,ring,placemark);this._geometries.push(line)}}this._buildLayers()};SMap.Layer.KML.prototype._buildLayers=function(){if(this._markers.length){var l=new SMap.Layer.Marker;this.addLayer(l);for(var i=0;i<this._markers.length;i++){l.addMarker(this._markers[i])}}if(this._geometries.length){var l=new SMap.Layer.Geometry;this.addLayer(l);for(var i=0;i<this._geometries.length;i++){l.addGeometry(this._geometries[i])}}};SMap.Layer.KML.prototype.filter=function(set){if(this._options.maxPoints==0||this._options.maxPoints>=set.length){return set}var arr=[];var step=(set.length-1)/(this._options.maxPoints-1);var index=0;for(var i=0;i<this._options.maxPoints;i++){arr.push(set[Math.round(index)]);index+=step}return arr};SMap.Layer.KML.prototype.fit=function(){var all=[];for(var i=0;i<this._markers.length;i++){all.push(this._markers[i].getCoords())}for(var i=0;i<this._geometries.length;i++){all=all.concat(this._geometries[i].getCoords())}var cz=this.getMap().computeCenterZoom(all);this.getMap().setCenterZoom(cz[0],cz[1])};SMap.Layer.KML.prototype.getStyle=function(node,nodeName){var parent=node;var s=node.getElementsByTagName("styleUrl");if(s.length){var c=JAK.XML.textContent(s[0]);var id=c.match(/[^#]+/)[0];var snode=this._ids[id];if(snode){parent=snode}}var style=parent.getElementsByTagName(nodeName);return style.length?style[0]:null};SMap.Layer.KML.prototype.getColor=function(str){var r=str.match(/..(..)(..)(..)/);return"#"+r[3]+r[2]+r[1]};SMap.Layer.KML.prototype.getOpacity=function(str){var num=parseInt(str.substring(0,2),16);return num/255};SMap.Layer.KML.prototype.getURL=function(){return this._options.url};SMap.Marker.KML=JAK.ClassMaker.makeClass({NAME:"SMap.Marker.KML",EXTEND:SMap.Marker,VERSION:"2.0"});SMap.Marker.KML.prototype.$constructor=function(owner,pointNode,placemarkNode){var c=pointNode.getElementsByTagName("coordinates")[0];var arr=JAK.XML.textContent(c).split(",");var lon=parseFloat(arr[0]);var lat=parseFloat(arr[1]);var coords=SMap.Coords.fromWGS84(lon,lat);var name=placemarkNode.getElementsByTagName("name");name=name.length?JAK.XML.textContent(name[0]):"";var desc=placemarkNode.getElementsByTagName("description");desc=desc.length?JAK.XML.textContent(desc[0]):"";var options={};var rel={};var size=false;var style=owner.getStyle(placemarkNode,"IconStyle");if(style){var href=style.getElementsByTagName("href");if(href.length){options.url=this._buildImageUrl(JAK.XML.textContent(href[0]),owner);var hs=style.getElementsByTagName("hotSpot");if(hs.length){var abs={};hs=hs[0];var x=parseFloat(hs.getAttribute("x"));var y=parseFloat(hs.getAttribute("y"));var xu=hs.getAttribute("xunits");var yu=hs.getAttribute("yunits");if(xu=="fraction"){rel.left=x}else{abs.left=x}if(yu=="fraction"){rel.top=y}else{abs.top=y}if("left"in abs||"top"in abs){options.anchor=abs}}else{rel.left=.5;rel.bottom=0}}}if(name){options.title=name}this.$super(coords,null,options);if("left"in rel||"top"in rel){this.decorate(SMap.Marker.Feature.RelativeAnchor,{anchor:rel})}if(name||desc){var c=new SMap.Card;c.getHeader().innerHTML="<strong>"+name+"</strong>";c.getBody().innerHTML=desc;this.decorate(SMap.Marker.Feature.Card,c)}};SMap.Marker.KML.prototype._buildImageUrl=function(url,owner){if(url.match(/^http/i)){return url}var base=owner.getURL();var lastSlash=base.lastIndexOf("/");if(lastSlash!=-1){base=base.substring(0,lastSlash)}return base+"/"+url};SMap.Geometry.KMLLine=JAK.ClassMaker.makeClass({NAME:"SMap.Geometry.KMLLine",EXTEND:SMap.Geometry,VERSION:"2.0"});SMap.Geometry.KMLLine.prototype.$constructor=function(owner,lineNode,placemarkNode){var coords=[];var options={};var c=lineNode.getElementsByTagName("coordinates")[0];var str=JAK.XML.textContent(c);var parts=str.split(/\s+/);parts=owner.filter(parts);for(var i=0;i<parts.length;i++){var part=parts[i];if(!part){continue}var c=part.split(",");var lon=parseFloat(c[0]);var lat=parseFloat(c[1]);var c=SMap.Coords.fromWGS84(lon,lat);coords.push(c)}var style=owner.getStyle(placemarkNode,"LineStyle");if(style){var c=style.getElementsByTagName("color");if(c.length){var str=JAK.XML.textContent(c[0]);options.color=owner.getColor(str);options.opacity=owner.getOpacity(str)}var w=style.getElementsByTagName("width");if(w.length){options.width=parseFloat(JAK.XML.textContent(w[0]))}}var name=placemarkNode.getElementsByTagName("name");name=name.length?JAK.XML.textContent(name[0]):"";if(name){options.title=name}this.$super(SMap.GEOMETRY_POLYLINE,null,coords,options);var desc=placemarkNode.getElementsByTagName("description");desc=desc.length?JAK.XML.textContent(desc[0]):"";if(name||desc){var c=new SMap.Card;c.getHeader().innerHTML="<strong>"+name+"</strong>";c.getBody().innerHTML=desc;this.decorate(SMap.Geometry.Feature.Card,c)}};SMap.Geometry.KMLPolygon=JAK.ClassMaker.makeClass({NAME:"SMap.Geometry.KMLPolygon",EXTEND:SMap.Geometry,VERSION:"2.0"});SMap.Geometry.KMLPolygon.prototype.$constructor=function(owner,polygonNode,placemarkNode){var coords=[];var options={};var c=polygonNode.getElementsByTagName("outerBoundaryIs")[0].getElementsByTagName("coordinates")[0];var str=JAK.XML.textContent(c);var parts=str.split(/\s+/);parts=owner.filter(parts);for(var i=0;i<parts.length;i++){var part=parts[i];if(!part){continue}var c=part.split(",");var lon=parseFloat(c[0]);var lat=parseFloat(c[1]);var c=SMap.Coords.fromWGS84(lon,lat);coords.push(c)}var style=owner.getStyle(placemarkNode,"PolyStyle");if(style){var c=style.getElementsByTagName("color");if(c.length){var str=JAK.XML.textContent(c[0]);options.color=owner.getColor(str);options.opacity=owner.getOpacity(str)}var fill=style.getElementsByTagName("fill");if(fill.length&&JAK.XML.textContent(fill[0])=="0"){options.color="none"}var outline=style.getElementsByTagName("outline");if(outline.length&&JAK.XML.textContent(outline[0])=="0"){options.outlineColor="none"}var w=style.getElementsByTagName("width");if(w.length){options.width=parseFloat(JAK.XML.textContent(w))}}var style=owner.getStyle(placemarkNode,"LineStyle");if(style){var c=style.getElementsByTagName("color");if(c.length){var str=JAK.XML.textContent(c[0]);options.outlineColor=owner.getColor(str);options.outlineOpacity=owner.getOpacity(str)}var w=style.getElementsByTagName("width");if(w.length){options.outlineWidth=parseFloat(JAK.XML.textContent(w[0]))}}var name=placemarkNode.getElementsByTagName("name");name=name.length?JAK.XML.textContent(name[0]):"";if(name){options.title=name}this.$super(SMap.GEOMETRY_POLYGON,null,coords,options);var desc=placemarkNode.getElementsByTagName("description");desc=desc.length?JAK.XML.textContent(desc[0]):"";if(name||desc){var c=new SMap.Card;c.getHeader().innerHTML="<strong>"+name+"</strong>";c.getBody().innerHTML=desc;this.decorate(SMap.Geometry.Feature.Card,c)}};SMap.Geocoder=JAK.ClassMaker.makeClass({NAME:"SMap.Geocoder",VERSION:"2.0",IMPLEMENT:JAK.ISignals});SMap.Geocoder.METHOD="geocode";SMap.Geocoder.prototype.$constructor=function(query,callback,options,errorCallback){this._request=null;this._query=query;this._callback=callback;this._errorCallback=errorCallback;this._results=[];this._options={url:"/v0/geocode",count:0,zoom:undefined,locality:"",bbox:[],lang:""};for(var p in options){this._options[p]=options[p]}this._sendRequest()};SMap.Geocoder.prototype.$destructor=function(){this.abort()};SMap.Geocoder.prototype.abort=function(){if(this._request){this._request.abort();this.makeEvent("geocode-response")}};SMap.Geocoder.prototype.getResults=function(){return this._results};SMap.Geocoder.prototype._sendRequest=function(){this.makeEvent("geocode-request");this._request=new JAK.Request(JAK.Request.XML);this._request.setCallback(this,"_response");var data=this._buildData();var url=SMap.CONFIG[this.constructor.METHOD];if(url.indexOf("//")!=-1&&!JAK.Request.supportsCrossOrigin()){url=this._options.url}this._request.setHeaders({"X-SZN-Sdk":SMap.nigena()});if(SMap.apiKey){var obj={};obj[SMap.CONFIG.apiKeyHeader]=SMap.apiKey;this._request.setHeaders(obj)}this._request.send(url,data)};SMap.Geocoder.prototype._response=function(xmlDoc){this.makeEvent("geocode-response");this._request=null;if(xmlDoc){this._parseResponse(xmlDoc);this._callback(this)}else{if(this._errorCallback){this._errorCallback(this)}}};SMap.Geocoder.prototype._buildData=function(){var queries=this._query instanceof Array?this._query:[this._query];var data={query:queries};if(this._options.count){data.count=this._options.count}if(typeof this._options.zoom==="number"&&this._options.zoom>0){data.zoom=this._options.zoom}if(this._options.locality){data.locality=this._options.locality}if(Array.isArray(this._options.bbox)&&this._options.bbox.length==2){var minCoord=this._options.bbox[0].toWGS84();var maxCoord=this._options.bbox[1].toWGS84();data.bounds=SMap.Util.viewportToBounds({lbx:Math.min(minCoord[0],maxCoord[0]),lby:Math.min(minCoord[1],maxCoord[1]),rtx:Math.max(minCoord[0],maxCoord[0]),rty:Math.max(minCoord[1],maxCoord[1])})}if(this._options.lang!=""){data.lang=this._options.lang}return data};SMap.Geocoder.prototype._parseResponse=function(xmlDoc){this._results=[];var points=xmlDoc.getElementsByTagName("point");for(var i=0;i<points.length;i++){var point=points[i];var result={};this._results.push(result);result.query=point.getAttribute("query");result.results=[];var items=point.getElementsByTagName("item");for(var j=0;j<items.length;j++){var item=items[j];var coords=SMap.Coords.fromWGS84(item.getAttribute("x"),item.getAttribute("y"));result.results.push({coords:coords,label:item.getAttribute("title"),source:item.getAttribute("source"),id:item.getAttribute("id")})}}};SMap.Geocoder.Reverse=JAK.ClassMaker.makeClass({NAME:"SMap.Geocoder.Reverse",VERSION:"2.0",EXTEND:SMap.Geocoder});SMap.Geocoder.Reverse.METHOD="rgeocode";SMap.Geocoder.Reverse.prototype.$constructor=function(coords,callback,options,errorCallback){var roptions={url:"/v0/rgeocode",lang:""};for(var p in options){roptions[p]=options[p]}this.$super(coords,callback,roptions,errorCallback);this._results={items:[]}};SMap.Geocoder.Reverse.prototype._buildData=function(){var wgs=this._query.toWGS84();var data={lon:wgs[0].toFixed(6),lat:wgs[1].toFixed(6)};if(typeof this._options.dist==="number"){data.dist=this._options.dist}if(typeof this._options.count==="number"){data.count=this._options.count}if(this._options.lang!=""){data.lang=this._options.lang}if(this._options.type&&Array.isArray(this._options.type)){data.type=this._options.type}return data};SMap.Geocoder.Reverse.prototype._parseResponse=function(xmlDoc){this._results={items:[],label:xmlDoc.documentElement.getAttribute("label"),coords:this._query};var items=xmlDoc.getElementsByTagName("item");for(var i=0;i<items.length;i++){var item=items[i];var obj={};obj.coords=SMap.Coords.fromWGS84(item.getAttribute("x"),item.getAttribute("y"));obj.name=item.getAttribute("name");obj.type=item.getAttribute("type");obj.id=item.getAttribute("id");this._results.items.push(obj)}};SMap.Route=JAK.ClassMaker.makeClass({NAME:"SMap.Route",VERSION:"1.0",IMPLEMENT:JAK.ISignals});SMap.Route.ROUTE_TURIST_TYPES=["CE","MO","ZE","ZL","BK","FI","HN","OR","CE-M","MO-M","ZE-M","ZL-M","NAU","OTH"];SMap.Route.formatRouteDistance=function(distance){var out="";if(!distance){return""}if(distance<1e3){return Math.round(distance)+"&nbsp;m"}else if(distance>999&&distance<5e4){var km=distance/1e3;out=km.toFixed(1).toString()}else{out=Math.round(distance/1e3).toString()}var check=out.split(".");if(parseFloat(check[1])==0){out=check[0]}out=out.replace(".",",").replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1 ")+"&nbsp;km";return out};SMap.Route.prototype.$constructor=function(coords,callback,params){this._coords=coords;this._callback=callback;this._request=null;this._results={};this._promise=null;if(coords.length<2){throw new Error("At least two coordinates required")}this._params={criterion:"fast",autoSend:true,altitude:true,geometry:true,itinerary:true};for(var p in params){this._params[p]=params[p]}this._isBus=this._params.criterion&&this._params.criterion=="bus"&&this._coords.length==2;this._request=new JAK.RPC(JAK.RPC.AUTO,{endpoint:SMap.CONFIG.route});if(this._par}};SMap.Route.prototype.$destructor=function(){this.abort()};SMap.Route.prototype.send=function(){this.makeEvent("route-request");this._request.setCallback(this,"_response");this._request.setErrorCallback(this,"_response");this._promise=new JAK.Promise;this._request.setHeaders({"X-SZN-Sdk":SMap.nigena()});if(SMap.apiKey){var obj={};obj[SMap.CONFIG.apiKeyHeader]=SMap.apiKey;this._request.setHeaders(obj)}this._request.send("simpleRoute",[this._buildItemsData(),{altitude:this._params.altitude,geometry:this._params.geometry,itinerary:this._params.itinerary}])};SMap.Route.prototype.abort=function(){if(this._request){this._request.abort();this.makeEvent("route-response")}};SMap.Route.prototype.getCoords=function(){return this._coords};SMap.Route.prototype.getCriterion=function(){return this._params.criterion};SMap.Route.prototype.getResults=function(){return this._results};SMap.Route.prototype.getPromise=function(){return this._promise};SMap.Route.route=function(coords,paramsArgs){var params=Object.assign({criterion:"fast",geometry:false,itinerary:false,altitude:false},paramsArgs);var routeInst=new this(coords,function(){},{criterion:params.criterion,altitude:params.altitude,geometry:params.geometry,itinerary:params.itinerary});return routeInst.getPromise()};SMap.Route.prototype._buildItemsData=function(){var items=[];for(var i=0;i<this._coords.length;i++){var data={geometry:SMap.Coords.coordsToString([this._coords[i]]),source:"coor",id:null,tripindex:0,type:0};if(i<this._coords.length-1){data.routeParams=this._buildParams()}items.push(data)}return items};SMap.Route.prototype._buildParams=function(){var params={};params.criterion=this._convertTextParamsToId(this._params.criterion);return params};SMap.Route.prototype._convertTextParamsToId=function(criterion){var params=0;switch(criterion){case"fast":params=this._params.toll=="free"?112:111;break;case"short":params=this._params.toll=="free"?113:114;break;case"bike1":params=121;break;case"bike2":params=122;break;case"bike3":params=122;break;case"turist1":params=131;break;case"turist2":params=132;break;case"bus":params=191;break;default:params=111;break}return params};SMap.Route.prototype._convertIdToTextType=function(c){var text="";if([111,112,113,114].indexOf(c)>-1){text="car"}else if([121,122].indexOf(c)>-1){text="bike"}else if([131,132].indexOf(c)>-1){text="foot"}else if(c==200){text="bus"}return text};SMap.Route.prototype._response=function(result,status){this.makeEvent("route-response");this._request=null;if(status!=200||!result||!("status"in result)){this._results={error:"HTTP Error",status:0};this._promise.reject()}else{this._results=this._isBus?this._parseResponseBus(result):this._parseResponse(result);this._promise.fulfill(this)}this._callback(this)};SMap.Route.prototype._parseResponse=function(result){if("status"in result&&result.status.toString().charAt(0)!="2"){var status=result.status;var result={error:true,status:parseInt(status)};return result}var results={id:JAK.idGenerator(),url:this._buildUrl(result),geometry:[],altitude:[],ascent:0,descent:0,inEurope:false,length:result.totalLength,time:result.totalTime,points:[],routeType:""};if("altitude"in result&&result.altitude){if("altitude"in result.altitude){results.altitude=result.altitude.altitude}if("elevationGain"in result.altitude){results.ascent=result.altitude.elevationGain}if("elevationLoss"in result.altitude){results.descent=result.altitude.elevationLoss}}var routes=result.routes;if(routes&&routes.length){var geometry=[];var points=[];var altitude=[];var indexWP=[0];for(var i=0;i<routes.length;i++){var route="routes"in routes[i]&&routes[i].routes.length?routes[i].routes[0]:null;if(route&&"data"in route){var data=route.data;if(parseFloat(data.inEurope)==1){results.inEurope=true}results.routeType=this._convertIdToTextType(routes[0].routeParams.criterion);if("routePoint"in data&&data.routePoint.length){points=points.concat(data.routePoint)}if("geometry"in data){geometry=geometry.concat(SMap.Coords.stringToCoords(data.geometry))}if("indexWP"in data&&data.indexWP.length>1){iwp=indexWP[indexWP.length-1]+parseFloat(data.indexWP[data.indexWP.length-1]);indexWP.push(iwp)}if("altitude"in data){altitude=altitude.concat(data.altitude)}}}results.geometry=geometry;if(altitude.length){results.altitude=altitude}results.points=points;results.indexWP=indexWP.length>1?indexWP:[]}return results};SMap.Route.prototype._parseResponseBus=function(result){if("status"in result&&result.status.toString().charAt(0)!="2"){var status=result.status;var result={error:true,status:parseInt(status)};return result}var results={id:JAK.idGenerator(),url:"",geometry:result.routes.length&&result.routes[0].routes.length?SMap.Coords.stringToCoords(result.routes[0].routes[0].data.geometry):[],altitude:[],ascent:0,descent:0,inEurope:null,length:result.totalLength||0,time:result.totalTime||0,points:[],routeType:""};return results};SMap.Route.prototype._buildUrl=function(result){var _url=new SMap.URL.Route;for(var i=0;i<result.routes.length;i++){var item=result.routes[i];var params=item.routeParams;var coords=SMap.Coords.stringToCoords(item.geometry)[0];var opt={};if(item.source!="coor"){opt.poi=[item.source,item.id]}if(params){var c=params.criterion;if(params.toll=="free"){opt.carTypeNoToll=true}if("avoidtraffic"in params){opt.bikeAvoidTraffic=params.avoidtraffic?true:false}if(c==111){opt.type="car"}else if(c==112){opt.type="car";opt.carTypeShort=true}else if(c==121){opt.type="bike"}else if(c==122){opt.type="bike";opt.bikeRoad=true;opt.bikeTrials=true}else if(c==131){opt.type="trial"}else if(c==132){opt.type="trial";opt.trialTurist=true}else if(c==143){opt.type="water"}}if(i==0){_url.addStart(coords,opt)}else if(i==result.routes.length-1){_url.addDestination(coords,opt)}else{_url.addWaypoint(coords,opt)}}return _url.toString()};SMap.URL={};SMap.URL.Route=JAK.ClassMaker.makeClass({NAME:"SMap.URL.Route",VERSION:"1.0"});SMap.URL.Route.prototype.$constructor=function(){this._conf={points:[[],[]],params:[null,null],coords:[null,null]};this._url=SMap.CONFIG.mapyUrl.route;return this};SMap.URL.Route.prototype.$destructor=function(){this._conf={points:[],params:[],coords:[]};this._url=""};SMap.URL.Route.prototype.addStart=function(coords,options){this._conf.points.splice(0,1);this._conf.params.splice(0,1);this._conf.coords.splice(0,1);this._addPoint(coords,options,0);return this};SMap.URL.Route.prototype.addDestination=function(coords,options){this._conf.points.splice(this._conf.points.length-1,1);this._conf.params.splice(this._conf.params.length-1,1);this._conf.coords.splice(this._conf.coords.length-1,1);this._addPoint(coords,options,this._conf.points.length);return this};SMap.URL.Route.prototype.addWaypoint=function(coords,options){this._addPoint(coords,options,this._conf.points.length-1);return this};SMap.URL.Route.prototype.toString=function(){var url=this._url;if(this._conf.points.length){url+=this._buildUrlParams()}return url};SMap.URL.Route.prototype._addPoint=function(coords,options,index){if(options&&options.poi&&options.poi.length==2){this._conf.points.splice(index,0,{source:options.poi[0],id:options.poi[1]})}else{this._conf.points.splice(index,0,{source:"coor",id:null})}this._conf.coords.splice(index,0,coords);this._conf.params.splice(index,0,this._getParams(options))};SMap.URL.Route.prototype._getParams=function(params){var p={c:111};if(params&&params.type){switch(params.type){case"car":if(params.carTypeShort){p.c=114;if(params.carTypeNoToll){p.c=113}}if(params.carTypeNoToll){p.c=112}break;case"bike":p.c=121;if(params.bikeRoad&&!params.bikeTrials){p.c=122}break;case"trial":p.c=131;if(params.trialTurist){p.c=132}break;case"water":p.c=143;break;case"ski":p.c=141;break;case"pubt":p.c=200;break}}else if(params&&params.poi&&params.poi[0]){switch(params.poi[0]){case"car":if(params.carTypeShort){p.c=114;if(params.carTypeNoToll){p.c=113}}if(params.carTypeNoToll){p.c=112}break;case"bike":p.c=121;if(params.bikeRoad&&!params.bikeTrials){p.c=122}break;case"trial":p.c=131;if(params.trialTurist){p.c=132}break;case"water":p.c=143;break;case"ski":p.c=141;break;case"pubt":p.c=200;break}}return p};SMap.URL.Route.prototype._buildUrlParams=function(){var url="&";var coords=[];var rs=[];var ri=[];var mrp=[];for(var i=0;i<this._conf.points.length;i++){if(this._conf.coords[i]){coords.push(this._conf.coords[i])}rs.push(this._conf.points[i].source?this._conf.points[i].source:"");ri.push(this._conf.points[i].id?this._conf.points[i].id:"");mrp.push(this._conf.params[i]?JSON.stringify(this._conf.params[i]):"")}url+="rc="+SMap.Coords.coordsToString(coords);for(var i=0;i<rs.length;i++){url+="&rs="+rs[i]}for(var i=0;i<ri.length;i++){url+="&ri="+ri[i]}for(var i=0;i<mrp.length;i++){url+="&mrp="+mrp[i]}return url};
