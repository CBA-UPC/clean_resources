"use strict";(self.webpackChunklivecommerce_widgets=self.webpackChunklivecommerce_widgets||[]).push([[391],{6391:(t,e,i)=>{i.r(e),i.d(e,{default:()=>x});i(4078),i(8581);var n=i(9686),o=i(1892),a=i.n(o),s=i(8560),l={insert:"head",singleton:!1};a()(s.Z,l);s.Z.locals;var A=i(5175);const r=i.p+"27cf00f8a548649918a59037231567a2.svg";const c=i.p+"2e4ff163292c124fefed8f1e3fe08cd7.svg";const d=i.p+"aae01ce5e85559210f1db97609d411ea.svg";var h=i(9101),p=i(4662),C=i(5945);const g=1e4;class u extends n.default.PureComponent{constructor(){super(...arguments),this.state={presentCallToAction:!1,isPlaying:!1},this._playerRef=n.default.createRef(),this.onClickPlay=this.onClickPlay.bind(this),this.onClickClose=this.onClickClose.bind(this),this.onClickCondense=this.onClickCondense.bind(this),this.onKeyDownPlay=this.onKeyDownPlay.bind(this),this.onKeyDownCondense=this.onKeyDownCondense.bind(this),this.onKeyDownClose=this.onKeyDownClose.bind(this),this._playerTimeout=null}componentDidMount(){this.checkShouldPlay()}componentDidUpdate(t){this.checkShouldPlay(),this.props.isCondensed&&!t.isCondensed&&this.cleanupPlayer()}componentWillUnmount(){this.cleanupPlayer()}checkShouldPlay(){const{isLive:t,previewResourceUri:e,isCondensed:i,isVisible:n}=this.props;if(!n)return;const{isPlaying:o}=this.state;t&&e&&!i&&!o?(this.setState({...this.state,isPlaying:!0}),this.playBroadcast(e)):t&&this.setupFadeTimer()}cleanupPlayer(){this._player&&this._playerRef.current&&(delete this._player._listeners,this._player.pause(),this._currentResourceUri=null,this._player=null)}setupFadeTimer(){const{previewDuration:t=g}=this.props;this.clearPlaybackTimer(),0!==t&&(this._playerTimeout=setTimeout((()=>{this._player&&(this._player.pause(),this.setState({...this.state,isPlaying:!1})),this.setState({presentCallToAction:!0}),this.clearPlaybackTimer()}),t))}clearPlaybackTimersync playBroadcast(t){if(this._currentResourceUri!==t){await(0,A.ve)("https://cdn.bambuser.net/player/lib/bambuser-video-iframeapi/latest/bambuser-video-iframeapi.min.js","baas-sdk-player"),this.cleanupPlayer();const e=this._playerRef.current;this._currentResourceUri=t,this._player=BambuserPlayer.create(e,t,{noFullscreen:!0,usePreviewAsPoster:!1}),this._player.controls=!1,this._player.muted=!0,this._player.scaleMode="aspectFill",this._player.addEventListener("playing",(),this._player.addEventListener("pause",(()=>{e.style.opacity=0,this._playerTimeout&&(this.setState({presentCallToAction:!0}),this.clearPlaybackTimer())}));try{this._player.play();const{showId:t,widgetId:e,orgId:i}=this.props;h.N.track({actionOrigin:p.R4.ACTION_ORIGIN.FLOATING_ACTION_BUTTON,eventType:p.R4.ON_PLAY,orgId:i,widgetId:e,showId:t})}catch(t){console.log(t),this.setupFadeTimer()}}}onClickPlay(){const{onClickPlay:t,isCondensed:e,showId:i,widgetId:n,orgId:o}=this.props;h.N.track({actionOrigin:p.R4.ACTION_ORIGIN.FLOATING_ACTION_BUTTON,eventType:p.R4.ON_INTERACTION,interactionType:h.N.buildTrackingEventName(h.N.getModule(e,this._playerTimeout),p.R4.INTERACTION_TYPE.OPEN_PLAYER),orgId:o,widgetId:n,showId:i}),this.setState({presentCallToAction:!1}),"function"==typeof t&&(this.cleanupPlayer(),t())}onClickClose(t){t.stopPropagation();const{onClickClose:e,orgId:i,widgetId:n,showId:o,isCondensed:a}=this.props;h.N.track({actionOrigin:p.R4.ACTION_ORIGIN.FLOATING_ACTION_BUTTON,eventType:p.R4.ON_INTERACTION,interactionType:h.N.buildTrackingEventName(h.N.getModule(a,this._playerTimeout),p.R4.INTERACTION_TYPE.CLOSE),orgId:i,widgetId:n,showId:o}),"function"==typeof e&&(this.cleanupPlayer(),e())}onClickCondense(t){t.stopPropagation();const{onClickCondense:e,orgId:i,widgetId:n,showId:o,isCondensed:a}=this.props;h.N.track({actionOrigin:p.R4.ACTION_ORIGIN.FLOATING_ACTION_BUTTON,eventType:p.R4.ON_INTERACTION,interactionType:h.N.buildTrackingEventName(h.N.getModule(a,this._playerTimeout),p.R4.INTERACTION_TYPE.CONDENSE),orgId:i,widgetId:n,showId:o}),"function"==typeof e&&(this.cleanupPlayer(),e())}onKeyDownPlay(t){(0,C.Us)(t)&&this.onClickPlay()}onKeyDownCondense(t){(0,C.Us)(t)&&this.onClickCondense(t)}onKeyDownClose(t){(0,C.Us)(t)&&this.onClickClose(t)}render(){const{theme:t,image:e,isLive:i,isVisible:o,onClickClose:a,isCondensed:s,onClickCondense:l,previewOrientation:A,onKeyDownCondense:h,title:p}=this.props,{presentCallToAction:C}=this.state;let g="floating-block";if("LANDSCAPE"===A&&(g+=" landscape-orientation"),o&&(g+=" visible"),C&&(g+=" fader-active"),s){let e="floating-block-condensed";return o&&(e+=" visible"),n.default.createElement("div",{role:"button",tabIndex:"0",id:"floating-widget",className:e,onClick:this.onClickPlay,onKeyPress:this.onKeyDownPlay},n.default.createElement("div",{className:"floating-ball"},t.statusLabels.live))}return n.default.createElement("div",{id:"floating-widget",className:g},n.default.createElement("div",{role:"button",tabIndex:"0","aria-label":"Open player with show ".concat(p),className:"graphic",onClick:this.onClickPlay,onKeyPress:this.onKeyDownPlay},o&&n.default.createElement("img",{alt:"",src:e}),n.default.createElement("div",{ref:this._playerRef,className:"player",style:{visibility:i?"visible":"hidden"}}),n.default.createElement("div",{className:"fader"}),i&&n.default.createElement("div",{className:"live-indicator"},t.statusLabels.live),(l||h)&&n.default.createElement("div",{role:"button",tabIndex:"0",className:"condense",onClick:this.onClickCondense,onKeyDown:this.onKeyDownCondense},n.default.createElement("img",{alt:"Condense widget",src:d})),a&&n.default.createElement("div",{role:"button",tabIndex:"0","aria-label":"close",className:"close",onClick:this.onClickClose,onKeyDown:this.onKeyDownClose},n.default.createElement("img",{alt:"Close widget",src:c})),t.floatingWidget&&t.floatingWidget.continueWatchingLabel?n.default.createElement("div",{className:"cta-text"},t.floatingWidget.continueWatchingLabel):n.default.createElement("div",{className:"cta"},n.default.createElement("img",{alt:"Play show",src:r}))))}}const f=u;var b=i(1794),v=i(7857),y=i(5458);lass w extends n.Component{constructor(t){super(t),this.state={testGroup:t.bambuserLiveshoppingUid?(0,v.r3)(t.bambuserLiveshoppingUid):null,data:null,visible:!1,dismissed:!1,condensed:"true"===t.bambuserLiveshoppingFloatingCondensed},this._loadedLiveOnce=!1,this._loadFloatingData=this._loadFloatingData.bind(this),this._announceFloatingWidgetPositionUpdate=this._announceFloatingWidgetPositionUpdate.bind(this),this._getFloatingWidgetPosition=this._getFloatingWidgetPosition.bind(this),this._navigateTo=this._navigateTo.bind(this),this._getTestSettingState=this._getTestSettingState.bind(this),h.N.testingData=this._getTestSettingState(),(0,y.j6)()}_getTestSettingState(){const{testGroup:t,data:e}=this.state,{testingEnabled:i}=e||{};return{testGroup:t,testingEnabled:i}}getFloatingWidgetPosition(){const{position:t}=this.state.data||{};return t}_shouldPresentWidget(){const{visible:t,data:e={},dismissed:i,testGroup:n}=this.state,{enabled:o,show:{isLive:a}={},testingEnabled:s}=e;let l=o&&!!a&&!i;return s&&void 0!==n&&0===n&&(l=!1),l!==t&&setTimeout((,10),l}_loadFloatingData(){var t,e;const{backendBaseUrl:i,widgetId:n,themeId:o,channelLocale:a}=this.props,{dismissed:s}=this.state,l=null===(t=this.state)||void 0===t||null===(e=t.data)||void 0===e?void 0:e.backendBaseUrl,A=new URLSearchParams(window.location.search).get("debugBambuser");if(s)return;let r="".concat(l||i,"/floating/").concat(n);const c=[];o&&c.push("themeId=".concat(encodeURIComponent(o))),a&&c.push("locale=".concat(encodeURIComponent(a))),c.length&&(r+="?".concat(c.join("&")));fetch(r,{signal:(0,v.lU)(30).signal}).then((t=>{if(!t.ok){const e=new Error("Error fetching floating widget data, status: ".concat(t.status));throw(0,y.p8)(e),e}return t.json()})).then((t=>{(0,b._)(t.theme),this.setState({data:t},(()=>{const{position:t,show:e={}}=this.state.data||{};if(this._announceFloatingWidgetPositionUpdate(t),this._announceFloatingWidgetDisplay(this._shouldPresentWidget()),h.N.testingData=this._getTestSettingState(),e.isLive&&!this._loadedLiveOnce){this._loadedLiveOnce=!0;const{showId:t,orgId:i}=e;h.N.track({actionOrigin:p.R4.ACTION_ORIGIN.FLOATING_ACTION_BUTTON,eventType:p.R4.ON_LIVE_RESPONSE,orgId:i,widgetId:n,showId:t})}const i=new Date,o=e.scheduledStartAt?new Date(e.scheduledStartAt):null,a=o?(o-i)/p.rP:null;let s=-1;e.isArchived?(A&&console.log("Show is archived. Checking again in 10 minutes"),s=10*p.VK):e.isLive?(s=p.vj,A&&console.log("Show is live, checking again in a 30s")):null===a?(A&&console.log("No scheduled time to start, checking again in a minute"),s=p.VK):a>=-1?a<=1?(A&&console.log("Show scheduled to start in +/- an hour, checking again in 30s"),s=p.vj):(A&&console.log("Show scheduled to start in more than 1h, checking again in 10 minutes"),s=10*p.VK):(A&&console.log("Show scheduled to start in the past? Checking again in 10 minutes"),s=10*p.VK),s>0&&(A&&console.log("Waiting ".concat(s/1e3,"s...")),setTimeout(this._loadFloatingData,s))}))})).catch((t=>{A&&console.log(t,A),"AbortError"===t.name?(0,y.p8)(new Error("The request timed out after running ".concat(30,"s")),{url:r}):(0,y.p8)(t)}))}onClickPlay(){const{id:t}=this.props,{show:{embedBaseUrl:e,showId:i}={},destinationUrl:n}=this.state.data||{};if(n)return this._navigateTo();const o={showId:i,embedBaseUrl:e,id:t,hideWidget:!0};this.setState({visible:!1,dismissed:!0}),this._announcePostMessage("liveshopping-widget:play",o)}onClickClose(){const{id:t}=this.props,{show:{showId:e}={}}=this.state.data||{};this.setState({visible:!1,dismissed:!0}),this._announcePostMessage("liveshopping-widget:floating-dismiss",{id:t,showId:e})}onClickCondense(){const{id:t}=this.props;this.setState({condensed:!0}),this._announcePostMessage("liveshopping-widget:floating-condense",{id:t})}onKeydownCondenseavigateTo(){const{id:t}=this.props,{show:{showId:e}={},destinationUrl:i}=this.state.data||{},n={destinationUrl:i,showId:e};this._announcePostMessage("liveshopping-widget:floating-navigate",n)}_announceFloatingWidgetPositionUpdate(t){const{id:e}=this.props,i={position:t,id:e};this._announcePostMessage("liveshopping-widget:floating-reposition",i)}_announceFloatingWidgetDisplay(t){const{id:e}=this.props,{show:{showId:i}={}}=this.state.data||{},n={present:t,id:e,showId:i};this._announcePostMessage("liveshopping-widget:floating-present",n)}_announcePostMessage(t,e){const i=JSON.stringify({eventName:t,data:e});window.parent.postMessage(i,"*")}render(){const{widgetId:t}=this.props,{condensed:e}=this.state,i=this.state.data?this.state.data.show:null,o=this.state.data?this.state.data.previewDuration:null;return i?n.default.createElement(f,m({isCondensed:e,isVisible:this.state.visible,widgetId:t,previewDuration:o},i,{theme:b.Z,onClickPlay:e?this.onClickUncondense.bind(this):this.onClickPlay.bind(this),onKeyDownCondense:this.onKeydownCondense.bind(this),onClickCondense:this.onClickCondense.bind(this)})):null}}const x=w},8560:]);
//# sourceMappingURL=b1684578.bundle.js.map