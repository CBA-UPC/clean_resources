window._taboola = window._taboola || [];
const taboolaSiteName = [ 'Indian Express Malayalam', 'Indian Express Tamil', 'Indian Express Gujarati', 'Indian Express Bangla', 'Loksatta' ];

if ( 'undefined' !== typeof taboolaExports.infinite_scroll &&
    '' === taboolaExports.infinite_scroll ||
    ! taboolaSiteName.includes( ieNetworkThemeExports.siteName ) ) {
	_taboola.push( {flush: true} );
}
"+r.guid+"/swg/entitlements",a={Authorization:"Evolok evolok.api.service= evolok.api.sessionId="+r.mainSession.sessionId};if(n.raw&&""!==n.raw){var o=n.raw;return e({method:"POST",url:i,headers:a,data:o}).then(function(e){console.log(e)})["catch"](function(e){console.log(e)})}}}}])}function t(){angular.module("ev-widgets").service("pmSubscriptionService",["$http",function(e){var t=EV.PM.pmDomain,n=t+"/widget";this.addBeneficiary=function(t,r,i,a){var o=n+"/account/beneficiary/invite/",s={subscriptionId:r,email:i,description:a};return e({method:"POST",url:o,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")},data:s}).then(function(e){return e})}}])}function n(){"use strict";angular.module("ev-widgets").service("pm2Util",["$http","$q","$translate","$window",function(e,t,n,r){function i(e){var t=new URLSearchParams(r.location.search);return t.has(e)?t.get(e):null}function a(e,t,n,r){e=r?Number(Number(e)+Number(r)).toFixed(2):e;var i=0,a=0;if(t&&0!==t.value)switch(t.type){case"PERCENTAGE":i=Number(Number(e)*Number(t.value)/100).toFixed(2);break;case"AMOUNT":i=Number(t.value).toFixed(2);break;default:throw"Discount type '"+t.type+"' is unknown!"}var o=Number(e)-Number(i);if(n&&0!==n.value)switch(n.type){case"PERCENTAGE":a=Number(Number(o)*Number(n.value)/100).toFixed(2);break;case"AMOUNT":a=Number(n.value).toFixed(2);break;default:throw"Tax type '"+n.type+"' is unknown!"}var s=Number(o)+Number(a);return s<0?0:s}function o(e){function t(){return!!Array.isArray(e.data)&&("BEX0053"===e.data[0].appErrorCode?e.data[0].appErrorCode="duplicated_purchase":"BEX0020"===e.data[0].appErrorCode?e.data[0].appErrorCode="product_invalid":"BEX0004"===e.data[0].appErrorCode&&(e.data[0].appErrorCode="product_not_found"),!0)}function n(){"KLREX0005"===e.data.appErrorCode&&(e.data.appErrorCode="klarna_bad_value")}function r(){return e.data&&e.data.appErrorCode&&e.data.appErrorCode.includes("KLREX")}function i(){return e.data[0].message.indexOf("IDM Error: ")!==-1}function a(e){for(var t=[],n=0;n<e.args.length;n+=2)t.push(e.args[n]);return t}if(t()){if(i()){var o=JSON.parse(e.data[0].message.split("IDM Error: ")[1]);return o.args=a(o),EV.util.error(o.code,o.message,e.data[0].httpErrorCode,o.args)}return EV.util.error(e.data[0].appErrorCode,e.data[0].message,e.data[0].httpErrorCode)}return r()?(n(),EV.util.error(e.data.appErrorCode,e.data.message,e.data.httpErrorCode,e.data.args)):EV.util.error("technical_difficulties","Error",e.status)}function s(e,n){var r=t.defer();if(e.hasOwnProperty("guid")){var i=!1,a=null;e.hasOwnProperty("mainSession")&&(i=e.mainSession.hasOwnProperty("sessionCookie")?e.mainSession.sessionCookie:i,a=e.mainSession.hasOwnProperty("expiry")?e.mainSession.expiry:a),EV.util.saveEVSessionInStorage(e,i,a),EV.Event.publish(EV.Event.SESSION_REFRESH,e)}if(EV.settings.isSeamlessSignInEnabled()){var o=n?EV.util.getHeader("X-EV-SSO",n):void 0;o?EV.util.createSeamlessSession(e,o,!0).then(function(){r.resolve(e)}):r.resolve(e)}else r.resolve(e);return r.promise}var l=this,c=EV.PM.pmDomain,d=c+"/widget",u="basket",p="properties";this.getExpressPagoHtml=function(){var t=EV.PM.expressPagoCardUrl;return e({method:"GET",url:t,params:{Token:"",APIKey:EV.PM.expressPagoKey,Culture:"es"}})},this.getPaycometHtml=function(t){var n="https://rest.paycomet.com/v1/form";return e({method:"GET",url:n,params:{operationType:1,language:"en",payment:{terminal:57813,order:t.id,amount:"6499",currency:"EUR",secure:"1",productDescription:"Test Evolok",urlOk:"https://www.paycomet.com/url-ok",urlKo:"https://www.paycomet.com/url-ko",methods:[]}}})},this.isPropertyEnabled=function(t){var n=c+("/widget/"+t+"/isEnabled");return e({method:"GET",url:n})},this.verifyTaxCode=function(t){var n=JSON.parse(localStorage.getItem("evolok:ev_session")).mainSession.sessionId,r=c+"/widget/account/verifyTaxCode?ev_ss="+n,i=t.data;return e({method:"POST",url:r,data:i})},this.getPaymentPlanTotalPrice=function(t){var n=c+"/paymentplan/"+t+"/paymentPrice";return null!=this.getPromoCode()&&(n+="?promoCode="+this.getPromoCode()),e({method:"GET",url:n}).then(function(e){return e.data})["catch"](function(e){throw o(e)})},this.getCountries=function(){var t=d+"/countries";return e({method:"GET",url:t}).then(function(e){return e.data})["catch"](function(e){throw o(e)})},this.getRegion=function(t,n){var r=d+"/region/";return r+=t?"?countryId="+t:"?countryName="+n,e({method:"GET",url:r}).then(function(e){return e.data})["catch"](function(e){throw o(e)})},this.getPaymentPlansWithPromoCode=function(t,n){var r=d+"/product/promocode/"+t;return e({method:"GET",url:r,params:{promoCode:n}}).then(function(e){return e.data})["catch"](function(e){throw o(e)})},this.getPaymentPlanAndProductByPromoCode=function(t){var n=d+"/purchase-preset-from-promo-code";return e({method:"GET",url:n,params:{promoCode:t}}).then(function(e){return e.data})["catch"](function(e){throw o(e)})},this.ifPromoCodeExistsInProduct=function(t){var n=d+"/product/hasPromoCode/"+t;return e({method:"GET",url:n}).then(function(e){return e.data})["catch"](function(e){throw o(e)})},this.getProducts=function(t,n,r,i){var a=d+"/productgroup/"+t,s={};return n&&(s.showHidden=!0),r&&(s.deliveryCountry=r.name),i&&(s.ev_sid=i),e({method:"GET",url:a,params:s}).then(function(e){return e.data})["catch"](function(e){throw o(e)})},this.getProduct=function(t,n,r,i,a){var s=d+"/product/"+t,l={};return n&&(l.paymentPlan=n),r&&(l.showHidden=!0),i&&(l.deliveryCountry=i.name),a&&(l.ev_sid=a),e({method:"GET",url:s,params:l}).then(function(e){return e.data})["catch"](function(e){throw o(e)})},this.getProviderByPaymentType=function(t){var n=d+"/payment/provider/"+t;return e({method:"GET",url:n}).then(function(e){return e.data})["catch"](function(e){var t=Array.isArray(e.data)?e.data[0].appErrorCode:"retrieve_payment_provider_fail";throw EV.Event.publish(EV.Event.PM_ERROR,e),EV.util.error(t||"technical_difficulties","Error Retrieving Payment Provider Payment",400)})},this.revertCancellation=function(t){var n=d+"/account/"+t+"/cancel/revert";return e({method:"POST",url:n,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")}}).then(function(e){return e.data})["catch"](function(e){var t=Array.isArray(e.data)?e.data[0].appErrorCode:"revert_cancel_fail";throw EV.Event.publish(EV.Event.PM_ERROR,e),EV.util.error(t||"technical_difficulties","Error Reverting the cancellation",400)})},this.cancelPurchase=function(t,n,r){var i=d+"/account/"+t+"/cancel";return e({method:"GET",url:i,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss"),immediately:n,cancelReasonId:r}}).then(function(e){return e.data})["catch"](function(e){var t=Array.isArray(e.data)?e.data[0].appErrorCode:"cancel_purchase_fail";throw EV.Event.publish(EV.Event.PM_ERROR,e),EV.util.error(t||"technical_difficulties","Error Cancelling the Purchase",400)})},this.applyOffer=function(t,n){var r=d+"/account/"+t+"/applyOffer";return e({method:"GET",url:r,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss"),offerId:n}}).then(function(e){return e.data})["catch"](function(e){var t=Array.isArray(e.data)?e.data[0].appErrorCode:"apply_offer_fail";throw EV.Event.publish(EV.Event.PM_ERROR,e),EV.util.error(t||"technical_difficulties","Error applying the offer",400)})},this.retrieveCustomerCards=function(t){var n=void 0;return n=t?d+"/account/"+t+"/cards":d+"/account/cards",e({method:"GET",url:n,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")}}).then(function(e){return e.data})["catch"](function(e){var t=Array.isArray(e.data)?e.data[0].appErrorCode:"retrieve_card_fail";throw EV.Event.publish(EV.Event.PM_ERROR,e),EV.util.error(t||"technical_difficulties","Error Retrieving Card",400)})},this.retrieveCustomerDefaultCard=function(){var t=d+"/account/defaultCard";return e({method:"GET",url:t,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")}}).then(function(e){return e.data})["catch"](function(e){var t=Array.isArray(e.data)?e.data[0].appErrorCode:"retrieve_card_fail";throw EV.Event.publish(EV.Event.PM_ERROR,e),EV.util.error(t||"technical_difficulties","Error Retrieving Card",400)})},this.retrieveCustomerBankAccountDetails=function(){var t=d+"/account/bankAccount";return e({method:"GET",url:t,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")}}).then(function(e){return e.data})["catch"](function(e){var t=Array.isArray(e.data)?e.data[0].appErrorCode:"retrieve_bank_account_fail";throw EV.Event.publish(EV.Event.PM_ERROR,e),EV.util.error(t||"technical_difficulties","Error Retrieving Card",400)})},this.getChangeProductsAndPlans=function(t){var n=d+"/account/changeProductsPlans/"+t;return e({method:"GET",url:n,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")}}).then(function(e){return e.data})["catch"](function(e){var t=Array.isArray(e.data)?e.data[0].appErrorCode:"retrieve_change_products_fail";throw EV.Event.publish(EV.Event.PM_ERROR,e),EV.util.error(t||"technical_difficulties","Error Retrieving change products/plans",400)})},this.getRetentionDiscounts=function(t){var n=d+"/account/retentionOffers/"+t;return e({method:"GET",url:n,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")}}).then(function(e){return e.data})["catch"](function(e){var t=Array.isArray(e.data)?e.data[0].appErrorCode:"retrieve_offers_fail";throw EV.Event.publish(EV.Event.PM_ERROR,e),EV.util.error(t||"technical_difficulties","Error Retrieving offers",400)})},this.retrieveReferralOffers=function(){var t=d+"/account/referraloffers";return e({method:"GET",url:t,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")}}).then(function(e){return e.data})["catch"](function(e){if(404===e.status)throw EV.Event.publish(EV.Event.PM_ERROR,e),EV.util.error("referral_offers_unavailable","Referral offers not available",400);var t=Array.isArray(e.data)?e.data[0].appErrorCode:"retrieve_referral_offers_fail";throw EV.Event.publish(EV.Event.PM_ERROR,e),EV.util.error(t||"technical_difficulties","Error Retrieving Referral Offers",400)})},this.retrieveReferralCodeData=function(){var t=d+"/account/referralcode";return e({method:"GET",url:t,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")}}).then(function(e){return e.data})["catch"](function(e){if(404===e.status)throw EV.Event.publish(EV.Event.PM_ERROR,e),EV.util.error("referral_code_unavailable","Referral code not available",400);var t=Array.isArray(e.data)?e.data[0].appErrorCode:"retrieve_referral_code_fail";throw EV.Event.publish(EV.Event.PM_ERROR,e),EV.util.error(t||"technical_difficulties","Error Retrieving Referral Code",400)})},this.generateReferralCode=function(){var t=d+"/account/referralcode";return e({method:"POST",url:t,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")}})["catch"](function(e){var t=Array.isArray(e.data)?e.data[0].appErrorCode:"generate_referral_code_fail";throw EV.Event.publish(EV.Event.PM_ERROR,e),EV.util.error(t||"technical_difficulties","Error Retrieving Referral Code",400)})},this.generateQRAccessCode=function(t){var n=d+"/account/accesscode/"+t;return e({method:"GET",url:n,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")}})["catch"](function(e){var t=Array.isArray(e.data)?e.data[0].appErrorCode:"generate_access_code_fail";throw EV.Event.publish(EV.Event.PM_ERROR,e),EV.util.error(t||"technical_difficulties","Error Retrieving Generate Code",400)})},this.preChangeCard=function(t){var n=d+"/payment/"+t+"/preChangeCard";return e({method:"POST",url:n,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")}}).then(function(e){return e.data})["catch"](function(e){var t=Array.isArray(e.data)?e.data[0].appErrorCode:"pre_change_card_failed";throw EV.Event.publish(EV.Event.PM_ERROR,e),EV.util.error(t||"technical_difficulties","Error setting up change card charge",400)})},this.changeCardInfo=function(t,n){var r=d+"/payment/"+t+"/changeCard";return e({method:"POST",url:r,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")},data:n}).then(function(e){return e.data})["catch"](function(e){var t=Array.isArray(e.data)?e.data[0].appErrorCode:"change_card_failed";throw EV.Event.publish(EV.Event.PM_ERROR,e),EV.util.error(t||"technical_difficulties","Error updating the card details",400)})},this.changePurchaseAddressInfo=function(t,n,r){var i=d+"/payment/"+t+("BILLING"===r?"/changeBillingAddress":"/changeDeliveryAddress");return e({method:"POST",url:i,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")},data:n}).then(function(e){return e.data})["catch"](function(e){var t=Array.isArray(e.data)?e.data[0].appErrorCode:"change_address_failed";throw EV.Event.publish(EV.Event.PM_ERROR,e),EV.util.error(t||"technical_difficulties","Error updating the card details",400)})},this.changeProductPlan=function(t,n){var r=d+"/payment/"+t+"/changeProductPlan";return e({method:"POST",url:r,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")},data:n}).then(function(e){return e.data})["catch"](function(e){var t=Array.isArray(e.data)?e.data[0].appErrorCode:"change_product_plan_failed";throw EV.Event.publish(EV.Event.PM_ERROR,e),EV.util.error(t||"technical_difficulties","Error changing product/plan",400)})},this.createSubscription=function(t,r){var i,a,o=d+"/payment/"+t+"/subscription",s=null;return e({method:"POST",url:o,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")},data:r}).then(function(e){return e.data})["catch"](function(e){i=e,s=e.data.message||"Error Processing Payment",a=e.data&&e.data.message?"payment_fail":"technical_difficulties";var t=null;return e.data&&e.data.appErrorCode&&e.data.providerName&&(t="ev.widgets."+e.data.providerName+".pmError."+e.data.appErrorCode),n(t).then(function(e){s=e},function(){console.warn("No translation found for pm error message, will use default")})})["finally"](function(){if(i)throw EV.Event.publish(EV.Event.PM_ERROR,i),EV.util.error(a,s,400)})},this.completeSubscription=function(t,n){var r=d+"/payment/"+t+"/subscription/complete";return e({method:"POST",url:r,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")},data:n}).then(function(e){return e.data})["catch"](function(e){throw o(e)})},this.validateProfile=function(t){var n=d+"/profile/validate/"+t;return e({method:"GET",url:n,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")}}).then(function(e){return EV.Event.publish(EV.Event.PM_VALID_PROFILE,e.data),e.data})["catch"](function(e){throw EV.Event.publish(EV.Event.PM_INVALID_PROFILE,e.data),e.data})},this.getPromoCode=function(){var e=null;return null!=document.getElementById("promoInput")&&""!==document.getElementById("promoInput").value&&(e=document.getElementById("promoInput").value),e},this.getBasket=function(){return EV.util.Storage.session.get(u)||EV.util.Storage.local.get(u)},this.getBasketLocal=function(){return EV.util.Storage.local.get(u)},this.saveBasket=function(e){EV.util.Storage.session.set(u,e),EV.util.Storage.local.set(u,e),EV.Event.publish("pm.savedBasket",e)},this.removeBasket=function(e){EV.util.Storage.session.remove(u),EV.util.Storage.local.remove(u),EV.Event.publish(EV.Event.PM_CLEARED_BASKET,e)},this.removeBasketLocal=function(e){EV.util.Storage.local.remove(u),EV.Event.publish(EV.Event.PM_CLEARED_BASKET,e)},this.getExtraProperties=function(){return EV.util.Storage.session.get(p)||EV.util.Storage.session.set(p,{}),EV.util.Storage.local.get(p)||EV.util.Storage.local.set(p,{}),EV.util.Storage.session.get(p)||EV.util.Storage.local.get(p)},this.saveExtraProperties=function(e){EV.util.Storage.session.set(p,e),EV.util.Storage.local.set(p,e)},this.removeExtraProperties=function(){EV.util.Storage.session.remove(p),EV.util.Storage.local.remove(p)},this.getProfileGroups=function(t){var n=d+"/profile/attributeGroups/"+t;return e({method:"GET",url:n,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")}}).then(function(e){return e.data})["catch"](function(e){throw o(e)})},this.saveProfile=function(t,n){var r=null,i=null;EV.PM.validateGroup?(r=d+"/profile/"+n+"/v2",t.attributes=t.attributes.filter(function(e){return void 0!==e.value}),i=t):(r=d+"/profile/"+n,i=t.filter(function(e){return void 0!==e.value}));var a=EV.util.Storage.cookie.get("ev_ss"),s=!a,l=EV.PM.brand,c=EV.PM.realmName;return e({method:s?"POST":"PUT",url:r,data:i,params:{ev_ss:a,realm:c,brand:l,channel:"WEB"}}).then(function(e){return s?EV.Event.publish(EV.Event.REGISTRATION_SUCCESS):EV.Event.publish(EV.Event.EDIT_PROFILE_COMPLETE_SUCCESS),s})["catch"](function(e){throw o(e)})},this.login=function(t,n,r,a){var l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"default_realm",c=d+"/profile/login/"+r,u=a?a:"default",p=EV.PM.brand,f={authenticationSchemeName:u,identifiers:[t],validators:[n],realmName:l,brand:p,channel:"WEB"};return e({method:"POST",url:c,data:f}).then(function(e){var t=i("client_id"),n=i("return_url"),r=i("scope"),a=t&&n&&r;return EV.PM.skipSessionCreation?e.data:s(e.data,e.headers()).then(function(i){return a?EV.util.getAuthCode({client_id:t,return_url:n,scope:r}):EV.Event.publish(EV.Event.LOGIN_SUCCESS),e.data})})["catch"](function(e){throw EV.Event.publish(EV.Event.LOGIN_FAILED),o(e)})},this.validateTransformStartDate=function(e){return moment(e,"DDMMYYYY").isValid()?this.formatDate(e,"DDMMYYYY"):moment(e,"YYYY-MM-DD").isValid()?this.formatDate(e,"YYYY-MM-DD"):(!moment(e,"YYYY-MM-DD").isValid()||!moment(e,"DDMMYYYY").isValid())&&this.formatDate(new Date,"YYYY-MM-DD")},this.formatDate=function(e,t){var n=moment.utc(e,t);return n},this.createOrder=function(){var t=this,n=this.getBasket();if(!n){var r=EV.util.error("no_products_selected","No products selected",400);return void EV.Event.publish(EV.Event.PM_ERROR,r)}var i=null;1===document.querySelectorAll("ev-referral-code-entry").length&&(i=document.getElementById("ev-referral-code").value);var a=n.products,s=d+"/order",l=null,c=null,u=JSON.parse(JSON.stringify(a)),p=n.startDate,f=n.customStartDate;if(f&&(p=f),p&&!this.validateTransformStartDate(p))return Promise.reject(EV.util.error("invalid_start_date","Invalid start date",400));p=this.validateTransformStartDate(p);var g=this.getExtraProperties();if(g){var h=g.region||null;if(g.deliveryCountry)var m=g.deliveryCountry.code?g.deliveryCountry:{name:g.deliveryCountry}}var v=null,b=null;"GIFT"==n.orderType&&(v=g.beneficiary,g.beneficiaryMessage&&(b=g.beneficiaryMessage));var y=a.map(function(e){var t={productId:e.id,region:h,country:m,beneficiaryLimit:null!=e.beneficiaryLimit?e.beneficiaryLimit:null,startDate:p?p:null,endDate:null};if(console.log("beneficiaryLimit",n.beneficiaryLimit),n.beneficiaryLimit){var r=parseInt(n.beneficiaryLimit);r>0&&(console.log("beneficiaryLimit parsed:",r),t.beneficiaryLimit=r)}return"BUNDLE"===e.type?(e.bundlePlans.forEach(function(e){return delete e.price}),t.bundlePlanId=e.paymentPlan.id,delete e.paymentPlans):t.paymentPlanId=e.paymentPlan.id,delete e.paymentPlan,e.requiresDeliveryAddress&&(t.startDeliveryDate=moment().toISOString(),l=n.deliveryAddressGroup),e.requiresBillingAddress&&(c=n.billingAddressGroup),t}),E=n.paymentType,w=n.orderType,C=n.utmCampaign||void 0,S=this.getPromoCode();S=null==S?null:S.replace(/\s/g,"");var _=EV.PM.brand,P=EV.PM.channel||"WEB",A=n.itemId,k=n.pRenewal,T=n.customData,$={orderItems:y,paymentType:E,deliveryAddressGroup:l,billingAddressGroup:c,orderType:w,campaignCode:C,brand:_,channel:P,beneficiary:v,beneficiaryMessage:b,referralCode:i,promoCode:S,itemId:A,purchaseRenewal:k,customData:T};return e({method:"POST",url:s,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")},data:$}).then(function(e){var r={id:e.data.id,products:u,deliveryAddressGroup:n.deliveryAddressGroup,billingAddressGroup:n.billingAddressGroup,paymentType:n.paymentType,beneficiaryLimit:n.beneficiaryLimit,customData:n.customData};return t.saveBasket(r),$.id=e.data.id,EV.Event.publish(EV.Event.PM_CREATE_ORDER_SUCCESS,$),$})["catch"](function(e){throw o(e)})},this.getExistingOrder=function(t){var n=d+"/productsByOrderId/"+t;return e({method:"GET",url:n,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")}}).then(function(e){return e.data})["catch"](function(e){throw o(e)})},this.pmGetPaymentPageWithOrderInfo=function(t){var n=d+"/payment/"+t;return e({method:"GET",url:n,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")}}).then(function(e){return e.data})["catch"](function(e){throw o(e)})},this.isCheckoutButtonLoaded=function(){return document.getElementsByTagName("ev-checkout-button").length>0},EV.Event.on(EV.Event.PM_PROCESS_ORDER,function(e){if(!e){var t=l.getBasket();if(!t){var n=EV.util.error("no_products_selected","No products selected",400);return void EV.Event.publish(EV.Event.PM_ERROR,n)}e=t.products}l.createOrder(e).then(function(t){EV.Event.publish(EV.Event.PM_REDIRECT_TO_PAYMENT,e)})["catch"](function(e){return EV.Event.publish(EV.Event.PM_ERROR,EV.util.error("ERROR_PROCESSING_ORDER","Error processing order",500))})}),this.checkBankDetails=function(t,n){var r=d+"/payment/bankDetails/"+t;return e({method:"POST",url:r,data:n}).then(function(e){return e.data})},this.getCalculatedPrices=function(t,n,r){var i="?quantity="+n+"&beneficiaryLimit="+r,a=c+"/paymentplan/getCalculatedPrice"+i,o=JSON.stringify(t);return e({method:"POST",url:a,headers:{"Content-Type":"application/json"},data:o,timeout:500}).then(function(e){return e.data})["catch"](function(e){return console.log(e)})},this.verifyPaymentDetails=function(t,n){var r=d+"/payment/verify/"+t;return e({method:"POST",url:r,data:n}).then(function(e){return e.data})},this.processPayment=function(t,r){var i,a,o=d+"/payment/"+r,s=null;return e({method:"POST",url:o,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")},data:t}).then(function(e){return e.data})["catch"](function(e){i=e,s=e.data.message||"Error Processing Payment",a=e.data&&e.data.message?"payment_fail":"technical_difficulties";var t=null;return e.data&&e.data.appErrorCode&&e.data.providerName&&(t="ev.widgets."+e.data.providerName+".pmError."+e.data.appErrorCode),n(t).then(function(e){s=e},function(){console.warn("No translation found for pm error message, will use default")})})["finally"](function(){if(i)throw EV.Event.publish(EV.Event.PM_ERROR,i),EV.util.error(a,s,400)})},this.getTransactionByPurchaseId=function(t){var n=d+"/account/transactions/"+t;return e({method:"GET",url:n,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")}}).then(function(e){return e.data})["catch"](function(e){throw o(e)})},this.changeOrderInvoiceFormat=function(t,n){var r=EV.util.Storage.cookie.get("ex_ss");console.log("ex_ss",r);var i=EV.util.Storage.cookie.get("ev_ss");i||console.error('EV.util.Storage.cookie.get("ev_ss") should not be empty');var a=c+("/widget/account/"+t+"/orderInvoiceFormat/"+n+"?ev_ss="+i);return e({method:"PUT",url:a})},this.changePurchaseInvoiceFormat=function(t,n){var r=EV.util.Storage.cookie.get("ev_ss");r||console.error('EV.util.Storage.cookie.get("ev_ss") should not be empty');var i=d+("/account/"+t+"/purchaseInvoiceFormat/"+n+"?ev_ss="+r);return e({method:"PUT",url:i})},this.regenLastInvoice=function(t){var n=EV.util.Storage.cookie.get("ev_ss");n||console.error('EV.util.Storage.cookie.get("ev_ss") should not be empty');var r=d+("/invoice/regenerate/"+t+"?ev_ss="+n);return e({method:"GET",url:r}).then(function(e){return e.data})["catch"](function(e){throw o(e)})},this.getPurchase=function(t){var n=d+"/account/purchase/"+t;return e({method:"GET",url:n,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")}}).then(function(e){return e.data})["catch"](function(e){throw o(e)})},this.getPurchases=function(){var t=d+"/account/purchases/";return e({method:"GET",url:t,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")}}).then(function(e){return e.data})["catch"](function(e){throw o(e)})},this.updatePurchaseWithCustomData=function(t,n){var r=d+"/account/purchase/"+t;return e({method:"POST",url:r,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")},data:n}).then(function(e){return e.data})["catch"](function(e){throw o(e)})},this.getCancelReasons=function(){var t=d+"/account/cancelreasons/";return e({method:"GET",url:t,params:{ev_sid:EV.util.Storage.cookie.get("ev_sid")}}).then(function(e){return e.data})["catch"](function(e){throw o(e)})},this.getGrantInvitationsList=function(){var t=d+"/account/grant/received";return e({method:"GET",url:t,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")}}).then(function(e){return e.data})["catch"](function(e){throw o(e)})},this.getGrantInvitationKey=function(t){var n=d+"/account/grant/invitation/"+t;return e({method:"GET",url:n,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")}}).then(function(e){return e.data})["catch"](function(e){throw o(e)})},this.grantAction=function(t,n){var r=d+"/account/grant/action/"+t+"/"+n;return e({method:"POST",url:r,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss"),manual:!1}}).then(function(e){return e.data})["catch"](function(e){throw o(e)})},this.getActivePaymentTypes=function(t,n){var r=d+"/payment/types";return t?r+="?paymentPlanId="+t:n&&(r+="?bundlePlanId="+n),e({method:"GET",url:r}).then(function(e){return e.data})["catch"](function(e){throw o(e)})},this.requestDirectDebitMandate=function(t,n){var r=d+"/payment/"+t+"/directdebit";return e({method:"POST",url:r,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")},data:n}).then(function(e){return e.data})["catch"](function(e){throw o(e)})},this.completeDirectDebitMandate=function(t,n){var r=d+"/payment/"+t+"/directdebit";return e({method:"PUT",url:r,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")},data:n}).then(function(e){return e.data})["catch"](function(e){throw o(e)})},this.calculateTrialPrice=function(e,t){return!e.discount||e.discount&&0===e.discount.period.numberOfDays?0:a(e.price,e.discount,e.tax,t)},this.calculateFinalPrice=function(e,t){return a(e.price,e.discount&&e.discount.value>0&&0===e.discount.period.numberOfDays?e.discount:null,e.tax,t)},this.getCustomDataFields=function(){var t=d+"/account/purchase/customDataFields";return e({method:"GET",url:t,params:{ev_ss:EV.util.Storage.cookie.get("ev_ss")}}).then(function(e){return e.data})["catch"](function(e){throw o(e)})},EV.Event.on(EV.Event.PM_PRODUCTS_SELECTED,function(e){if(EV.util.Storage.cookie.get("ev_ss"))if(EV.PM.skipProfile){if(!EV.PM.skipValidation){var n=e.map(function(e){return l.validateProfile(e.serviceName)});t.all(n).then(function(){EV.PM.skipSummary?EV.Event.publish(EV.Event.PM_PROCESS_ORDER,e):(console.log("publish EV.Event.PM_REDIRECT_ORDER_SUMMARY 3 "),EV.Event.publish(EV.Event.PM_REDIRECT_ORDER_SUMMARY,e))})["catch"](function(){return EV.Event.publish(EV.Event.PM_REDIRECT_PRODUCT_PROFILE,e)})}}else EV.Event.publish(EV.Event.PM_REDIRECT_PRODUCT_PROFILE,e);else EV.Event.publish(EV.Event.PM_REDIRECT_TO_LOGIN,e)}),EV.Event.on(EV.Event.PM_VALIDATE_PROFILE,function(e){var t=e.serviceName,n=e.successCb,r=e.errorCb;l.validateProfile(t).then(n)["catch"](r)}),setTimeout(function(){EV.Event.publish("pm.util.loaded",{getBasketLocal:l.getBasketLocal,removeBasketLocal:l.removeBasketLocal})},0)}])}function r(){"use strict";angular.module("ev-widgets").service("wmUtil",["$http","$q","$translate",function(e,t,n){this.handleSelect=function(e,t){var n=this;if(this.resetChild(e,t),EV.WM.referenceData){var r=EV.WM.referenceData.filter(function(e){if(e.attributes.includes(t.name))return e}),i=r.map(function(e){return e.data.values}),a=!0;if(i.forEach(function(e){var r=e.find(function(e){return e.value===t.value});if(r&&r.linkedReferenceData){a=!1;var i=EV.WM.referenceData.find(function(e){return e.dataName===r.linkedReferenceData.name});i&&n.populateDisplay(i)}}),a&&t.value){var o=angular.copy(EV.WM.referenceData).filter(function(e){return e.attributes.includes(t.name)});if(!o)return;o.forEach(function(t){t.data.values.forEach(function(t){t.linkedReferenceData&&t.linkedReferenceData.attributes&&t.linkedReferenceData.attributes.forEach(function(t){n.populateDefaultByAttribute(e,t)})})})}else if(!t.value){var s=angular.copy(EV.WM.referenceData).filter(function(e){return e.attributes.includes(t.name)});if(!s)return;console.log("refData::",s);var l=!0,c=!1,d=void 0;try{for(var u,p=s[Symbol.iterator]();!(l=(u=p.next()).done);l=!0){var f=u.value,g=function(t){if(t.startsWith(e.config.selectedBillingAddress.name+"_")){var n=e.attributes.findIndex(function(e){return e.name===t});e.attributes[n].value=void 0}},h=!0,m=!1,v=void 0;try{for(var b,y=f.linkedToAttributes[Symbol.iterator]();!(h=(b=y.next()).done);h=!0){var E=b.value;g(E)}}catch(w){m=!0,v=w}finally{try{!h&&y["return"]&&y["return"]()}finally{if(m)throw v}}}}catch(w){c=!0,d=w}finally{try{!l&&p["return"]&&p["return"]()}finally{if(c)throw d}}}}},this.populateDefaultByAttribute=function(e,t){var n=angular.copy(EV.WM.referenceDataAttributeMap),r=n[t].find(function(e){return 0===e.linkedFromList.length});r=this.replaceNameWithCaption(r),EV.Widgets.Display[t]=r.data},this.replaceNameWithCaption=function(e){return e.data.values=e.data.values.map(function(e){return e.caption||(e.caption=e.name,delete e.name),e}),e},this.resetChild=function(e,t){var n=this;if(EV.WM.referenceData){var r=EV.WM.referenceData,i=r.filter(function(e){return e.attributes.includes(t.name)});i&&e.evAttrs&&e.evAttrs.attributes&&i.forEach(function(t){t.data.values.forEach(function(t){t.linkedReferenceData&&t.linkedReferenceData.attributes&&t.linkedReferenceData.attributes.forEach(function(t){e.evAttrs.attributes[t]&&(e.evAttrs.attributes[t]=null,n.resetChild(e,{name:t}))})})})}},this.populateDisplay=function(e){e.data.values=e.data.values.map(function(e){return e.caption||(e.caption=e.name,delete e.name),e}),e.attributes.forEach(function(t){EV.Widgets.Display[t]=e.data})},this.populateDefault=function(e){var t=new Set;e.forEach(function(e){e.attributes.forEach(function(e){return t.add(e)})}),t=Array.from(t),t.forEach(function(t){e.forEach(function(e){0==e.linkedFromList.length&&e.attributes.includes(t)&&(EV.Widgets.Display[t]=e.data)})})},this.populateBillingAddressDefault=function(e,t){var n=new Set;e.forEach(function(e){e.attributes.forEach(function(e){return n.add(e)})}),n=Array.from(n),n.forEach(function(n){e.forEach(function(e){0==e.linkedFromList.length&&e.attributes.includes(n)&&(t.attributes[n]=e.data.values)})})},this.createCheckedList=function(e){e.isChecked?e.options.forEach(function(t){t.value===e.option&&(t.isChecked=!0)}):e.options.forEach(function(t){t.value===e.option&&(t.isChecked=!1)});var t=e.options.filter(function(e){return e.isChecked});return t},this.populateWithCheckedList=function(e,t,n,r){var i=this,a=angular.copy(EV.WM.referenceData),o=angular.copy(e);e.attributes=e.attributes.filter(function(e){return t.some(function(t){return t.linkedReferenceData.attributes.includes(e.name)})}),e.attributes.forEach(function(e){r.attributes=r.attributes.map(function(n){return n.name===e.name&&(n.options=[],t.forEach(function(e){a.forEach(function(t){e.linkedReferenceData.attributes.includes(n.name)&&e.linkedReferenceData.name===t.dataName&&t.data.values.forEach(function(e){return n.options.push(e)})})})),n})}),o.attributes.forEach(function(e){r.attributes=r.attributes.map(function(n){return n.name===e.name&&0==t.length&&(n.options=[],angular.copy(EV.WM.referenceData).forEach(function(t){var r=angular.copy(t);0==r.linkedFromList.length&&r.attributes.includes(e.name)&&(r=i.replaceNameWithCaption(r),r.data.values.forEach(function(e){return n.options.push(e)}))})),n})})}}])}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(){"use strict";var e=angular.module("ev-widget.pm.2checkout",[]);e.config(["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}]),e.directive("ev2checkout",["pm2Util","EVExceptionHandler","EVENTS","$translate","$location",function(e,t,n,r,i){return{restrict:"E",scope:{},templateUrl:"pm-v2/ev-2checkout.tpl.html",link:function(i,a,o){function s(){return"ev-widget.pm.2checkout-"+EV.util.random_guid()}function l(e){var t="ev.widgets.twocheckout.error."+e.errorCode;r(t).then(function(e){i.twocheckoutErrorMessage=e;
})["catch"](function(e){r("ev.widgets.twocheckout.error.default").then(function(e){i.twocheckoutErrorMessage=e})})}function c(){var e=document.createElement("script");e.src="https://www.2checkout.com/checkout/api/2co.min.js",e.onload=function(){console.log("2Checkout ready!"),d()},document.body.appendChild(e)}function d(){t.removeError(i.errorWidgetGuid);var e=document.querySelectorAll(".twocheckout-payment .input");Array.prototype.forEach.call(e,function(e){e.addEventListener("focus",function(){e.classList.add("focused")}),e.addEventListener("blur",function(){e.classList.remove("focused")}),e.addEventListener("keyup",function(){0===e.value.length?e.classList.add("empty"):e.classList.remove("empty")})})}i.loggedIn=EV.util.Storage.cookie.get("ev_ss"),i.widgetGuid=o.id||s(),i.errorWidgetGuid="error-"+i.widgetGuid,i.widgetTitle=o.title||"PAYMENT DETAILS",a.attr("title",""),i.showHeader="false"!==o.showHeader,i.showErrorMsgs="false"!==o.showErrorMsgs,i.live="false"!==o.live,EV.Event.publish(EV.Event.PM_REGISTER_PROVIDER_WIDGET,{paymentType:"CARD",selector:"ev-2checkout"}),c(),i.submit=function(n,r){function a(a){var o=e.getBasket();if(o&&o.id){var s={token:a.response.token.token};return e.processPayment(s,o.id).then(function(t){EV.Event.publish(EV.Event.PM_PAYMENT_SUCCESS,t),i.success=!0,e.removeBasket(o),e.removeExtraProperties(),n&&n()})["catch"](function(e){console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(i.errorWidgetGuid,e),r&&r("payment")})["finally"](function(){return i.submitting=!1})}if(o)l=EV.util.error("undefined_order_id","Error",400);else var l=EV.util.error("no_products_selected","No products selected",400);EV.Event.publish(EV.Event.PM_ERROR,l),t.handleError(i.errorWidgetGuid,l),i.$apply(function(){return i.submitting=!1}),r&&r("payment")}function o(e){l(e),i.showError=!0,EV.Event.publish(EV.Event.PM_ERROR,e.errorMsg),r&&r("payment"),i.$apply(function(){return i.submitting=!1})}if(i.showError=!1,i.twocheckoutErrorMessage="",i.submitting=!0,t.removeError(i.errorWidgetGuid),!e.isCheckoutButtonLoaded()||n){if(!i.loggedIn){var s=EV.util.error("not_logged_in","Error",400);return EV.Event.publish(EV.Event.PM_ERROR,s),t.handleError(i.errorWidgetGuid,s),void(r&&r("payment"))}if(i.twocheckoutErrorMessage)return void(r&&r("payment"));if(!document.getElementById("sellerId")){var c=document.createElement("input");c.setAttribute("id","sellerId"),c.setAttribute("type","hidden"),c.setAttribute("value",EV.PM.twoCheckoutSellerId),document.querySelector("#pay-twocheckout").appendChild(c)}if(!document.getElementById("publishableKey")){var d=document.createElement("input");d.setAttribute("id","publishableKey"),d.setAttribute("type","hidden"),d.setAttribute("value",EV.PM.twoCheckoutKey),document.querySelector("#pay-twocheckout").appendChild(d)}TCO.loadPubKey(i.live?"production":"sandbox",function(){TCO.requestToken(a,o,"pay-twocheckout")})}},EV.Event.on(EV.Event.PM_CREATE_ORDER_SUCCESS,function(e){i.order=e}),EV.Event.on(EV.Event.PM_REDIRECT_TO_PAYMENT,function(e){e&&"TWOCHECKOUT"===e.providerName&&EV.Event.publish(EV.Event.PM_REDIRECT_TO_2CHECKOUT_PAYMENT,e)}),EV.Event.on(EV.Event.LOGIN_SUCCESS,function(){i.loggedIn=!0}),EV.Event.on(EV.Event.LOGOUT_ACTION,function(){i.loggedIn=!1}),i.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_PAYMENT,function(t,n){var r=e.getBasket();r&&r.paymentType&&"CARD"===r.paymentType&&i.submit(n.successCb,n.errorCb)}),i.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_PROFILE,function(e,n){t.removeError(i.errorWidgetGuid)})}}}])}function o(){"use strict";var e=angular.module("ev-widget.pm.applePay",[]);e.directive("evApplePay",["pm2Util","EVExceptionHandler","EVENTS","$translate","$http",function(e,t,n,r,i){return{restrict:"E",scope:{},templateUrl:"pm-v2/ev-apple-pay.tpl.html",link:function(r,i,a,o){function s(){return"ev-widget.pm.applePay-"+EV.util.random_guid()}function l(){t.removeError(r.errorWidgetGuid),window.ApplePaySession?ApplePaySession.canMakePaymentsWithActiveCard(EV.PM.appleMerchantId).then(function(e){if(e)i.ready(function(){r.$emit("ev-apple-pay:ready")}),console.info("Apple Pay ready! Can make apple pay purchases");else{i.ready(function(){r.$emit("ev-apple-pay:ready")}),console.info("Apple Pay ready! Is possible on this browser, but not activated.");var t=document.querySelector(".apple-pay-button-not-active");t.style.display="block"}}):console.warn("Apple Pay ready! But functionality unavailable on current browser")}function c(){return new Promise(function(e,t){d().then(function(){console.log("[onPaymentAuthorized] processPayment outfilled"),e({transactionState:"SUCCESS"})})["catch"](function(){console.log("[onPaymentAuthorized] processPayment rejected"),e({transactionState:"ERROR",error:{intent:"PAYMENT_AUTHORIZATION",message:"Insufficient funds",reason:"PAYMENT_DATA_INVALID"}})})})}function d(){return new Promise(function(t,i){e.isCheckoutButtonLoaded()?(console.log("[processPayment] isCheckoutButtonLoaded()"),EV.Event.publish(n.INTERNAL.PM_CHECKOUT.TRIGGER_CHECKOUT,{}),document.querySelector("ev-checkout-button").style.display="block"):(console.log("[processPayment] submit()"),r.submit()),console.log("[processPayment] resolve({})"),t({})})}r.loggedIn=EV.util.Storage.cookie.get("ev_ss"),r.widgetGuid=a.id||s(),r.errorWidgetGuid="error-"+r.widgetGuid,r.widgetTitle=a.title||"PAYMENT DETAILS",i.attr("title",""),r.showHeader="false"!==a.showHeader,r.showErrorMsgs="false"!==a.showErrorMsgs;"true"===a.live?"PRODUCTION":"TEST";r.appleTransactionInfo=null,r.applePaySession=null,l(),EV.Event.on(EV.Event.LOGIN_SUCCESS,function(){r.loggedIn=!0}),EV.Event.on(EV.Event.LOGOUT_ACTION,function(){r.loggedIn=!1}),EV.Event.on(EV.Event.PM_REDIRECT_TO_PAYMENT,function(e){console.log("EV.Event.PM_REDIRECT_TO_PAYMENT",e),e&&"APPLE_PAY"===e.paymentType&&EV.Event.publish(EV.Event.PM_REDIRECT_TO_APPLE_PAY_PAYMENT,e)}),r.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_PAYMENT,function(t,n){console.log("EVENTS.INTERNAL.PM_CHECKOUT.SUBMIT_PAYMENT",n);var i=e.getBasket();i&&i.paymentType&&"APPLE_PAY"===i.paymentType&&r.submit(n.successCb,n.errorCb)}),r.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_PROFILE,function(e,n){console.log("EVENTS.INTERNAL.PM_CHECKOUT.SUBMIT_PROFILE",n),t.removeError(r.errorWidgetGuid)}),EV.Event.publish(EV.Event.PM_REGISTER_PROVIDER_WIDGET,{paymentType:"APPLE_PAY",selector:"ev-apple-pay"});var u=void 0;r.submit=function(n,i){if(r.showError=!1,r.applePayErrorMessage="",r.submitting=!0,t.removeError(r.errorWidgetGuid),!r.loggedIn){var a=EV.util.error("not_logged_in","Error",400);return EV.Event.publish(EV.Event.PM_ERROR,a),t.handleError(r.errorWidgetGuid,a),void(i&&i("payment"))}if(r.applePayErrorMessage)return void(i&&i("payment"));var o=e.getBasket(),s={token:u};if(o&&o.id)return e.processPayment(s,o.id).then(function(t){EV.Event.publish(EV.Event.PM_PAYMENT_SUCCESS,t),r.success=!0,e.removeBasket(o),n&&n()})["catch"](function(e){console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(r.errorWidgetGuid,e),i&&i("payment")})["finally"](function(){return r.submitting=!1});var l;l=o?EV.util.error("undefined_order_id","Error",400):EV.util.error("no_products_selected","No products selected",400),EV.Event.publish(EV.Event.PM_ERROR,l),t.handleError(r.errorWidgetGuid,l),r.$apply(function(){return r.submitting=!1}),i&&i("payment")},r.$on("ev-apple-pay:ready",function(){var t=document.querySelector(".apple-pay-button");t.style.display="block",t.addEventListener("click",function(){console.log("Apple Pay clicked"),r.appleTransactionInfo?(console.log("########### Apple Payment Request ##############"),console.log(r.appleTransactionInfo),r.applePaySession=new ApplePaySession(1,r.appleTransactionInfo),r.applePaySession.onvalidatemerchant=function(e){console.log("starting applePaySession.onvalidatemerchant"),console.log(e);var t=e.validationURL;p(t,function(e){console.log("merchantSession retrieved"),console.log(e),r.applePaySession.completeMerchantValidation(e)})},r.applePaySession.onpaymentmethodselected=function(t){console.log("starting applePaySession.onpaymentmethodselected"),console.log(t);var n={type:"final",label:EV.PM.appleDisplayNameStore,amount:r.appleTransactionInfo.total.amount},i=[{type:"final",label:e.getBasket().products[0].paymentPlan.displayName,amount:r.appleTransactionInfo.total.amount}];r.applePaySession.completePaymentMethodSelection(n,i)},r.applePaySession.onpaymentauthorized=function(e){console.log("starting applePaySession.onpaymentauthorized"),console.log(e),console.log("############### payment token ###############"),console.log(e.payment.token),u=e.payment.token,c().then(function(e){e&&"SUCCESS"===e.transactionState?(console.log("Successful Transaction outcome"),console.log(e),r.applePaySession.completePayment(ApplePaySession.STATUS_SUCCESS)):(console.log("Failed Transaction outcome"),console.log(e),r.applePaySession.completePayment(ApplePaySession.STATUS_FAILURE))})},r.applePaySession.oncancel=function(e){console.log("starting session.cancel"),console.log(e)},r.applePaySession.begin()):console.warn("Try selecting a plan again and then retry Apple Pay")})}),EV.Event.on(EV.Event.PM_PRODUCTS_SELECTED,function(t){console.log("PM_PRODUCT_SELECTED",t[0].paymentPlan.id),e.getPaymentPlanTotalPrice(t[0].paymentPlan.id).then(function(e){console.log("[Apple Pay] Payment Plan final price",e),r.appleTransactionInfo={currencyCode:t[0].paymentPlan.currency.id,countryCode:t[0].paymentPlan.countryCode||"GB",total:{label:EV.PM.appleDisplayNameStore,amount:e.totalPrice},supportedNetworks:["masterCard","visa"],merchantCapabilities:["supports3DS","supportsEMV","supportsCredit","supportsDebit"]}})["catch"](function(e){console.error("Error in retrieving/processing totalPrice from paymentPlan",e)})});var p=function(t,n){var r={merchantIdentifier:EV.PM.appleMerchantId,displayName:EV.PM.appleDisplayNameStore,initiative:"web",initiativeContext:window.location.host,appleUrl:t,testEnvironment:!1};e.verifyPaymentDetails("APPLE_PAY",r).then(function(e){n(e)})["catch"](function(e){console.log("error in retrieving the merchantSession",e)})}}}}])}function s(){"use strict";var e=angular.module("ev-widget.pm.beneficiaryLimit",[]);e.directive("evBeneficiaryLimit",["pm2Util",function(e){return{restrict:"E",scope:{},templateUrl:"pm-v2/ev-beneficiary-limit.tpl.html",controller:["$scope",function(e){}],link:function(e,t,n,r){function i(){return"ev-widget.pm.beneficiaryLimit-"+EV.util.random_guid()}e.isBeneficiaryLimitVisible=!0,e.isLoading=!0,e.widgetGuid=n.id||i(),e.widgetTitle=n.title,t.attr("title",""),e.showHeader="false"!==n.showHeader,e.showErrorMsgs="false"!==n.showErrorMsgs,e.showLabels="false"!==n.showLabels,e.showDelivery="true"===n.showDelivery,e.showHidden="true"===n.showHidden,e.beneficiaryLimit=n.beneficiaryLimit,e.addBeneficiaryLimitToBasket=function(){EV.Event.publish(EV.Event.PM_BENEFICIARY_LIMIT_CHANGE,{beneficiaryLimit:e.beneficiaryLimit})}}}}])}function l(){"use strict";var e=angular.module("ev-widget.pm.checkoutDotCom",[]);e.directive("evCheckoutdotcom",["pm2Util","EVExceptionHandler","EVENTS","$translate",function(e,t,n,r){return{restrict:"E",scope:{},templateUrl:"pm-v2/ev-checkoutdotcom.tpl.html",link:function(r,i,a,o){function s(){return"ev-widget.pm.checkoutDotCom-"+EV.util.random_guid()}function l(){var e=document.createElement("script");e.src="https://cdn.checkout.com/js/frames.js",e.onload=function(){console.log("Checkout.com ready!"),c()},document.body.appendChild(e)}function c(){t.removeError(r.errorWidgetGuid),Frames.init({publicKey:EV.PM.checkoutDotComPublicKey,containerSelector:".frame-container"})}r.loggedIn=EV.util.Storage.cookie.get("ev_ss"),r.widgetGuid=a.id||s(),r.errorWidgetGuid="error-"+r.widgetGuid,r.widgetTitle=a.title||"PAYMENT DETAILS",i.attr("title",""),r.showHeader="false"!==a.showHeader,r.showErrorMsgs="false"!==a.showErrorMsgs,l(),EV.Event.publish(EV.Event.PM_REGISTER_PROVIDER_WIDGET,{paymentType:"CARD",selector:"ev-checkoutdotcom"}),r.submit=function(n,i){function a(a){var o=e.getBasket(),s={token:a.cardToken};if(o&&o.id)return e.processPayment(s,o.id).then(function(t){EV.Event.publish(EV.Event.PM_PAYMENT_SUCCESS,t),r.success=!0,e.removeBasket(o),n&&n()})["catch"](function(e){console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(r.errorWidgetGuid,e),Frames.unblockFields(),i&&i("payment")})["finally"](function(){return r.submitting=!1});var l;l=o?EV.util.error("undefined_order_id","Error",400):EV.util.error("no_products_selected","No products selected",400),EV.Event.publish(EV.Event.PM_ERROR,l),t.handleError(r.errorWidgetGuid,l),r.$apply(function(){return r.submitting=!1}),i&&i("payment")}if(r.showError=!1,r.checkoutDotComErrorMessage="",r.submitting=!0,t.removeError(r.errorWidgetGuid),!e.isCheckoutButtonLoaded()||n){if(!r.loggedIn){var o=EV.util.error("not_logged_in","Error",400);return EV.Event.publish(EV.Event.PM_ERROR,o),t.handleError(r.errorWidgetGuid,o),void(i&&i("payment"))}return r.checkoutDotComErrorMessage?void(i&&i("payment")):void Frames.submitCard().then(a)["catch"](function(){i("payment"),r.submitting=!1})}},EV.Event.on(EV.Event.LOGIN_SUCCESS,function(){r.loggedIn=!0}),EV.Event.on(EV.Event.LOGOUT_ACTION,function(){r.loggedIn=!1}),EV.Event.on(EV.Event.PM_REDIRECT_TO_PAYMENT,function(e){e&&"CHECKOTDOTCOM"===e.providerName&&EV.Event.publish(EV.Event.PM_REDIRECT_TO_CHECKOUTDOTCOM_PAYMENT,e)}),r.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_PAYMENT,function(t,n){var i=e.getBasket();i&&i.paymentType&&"CARD"===i.paymentType&&r.submit(n.successCb,n.errorCb)}),r.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_PROFILE,function(e,n){t.removeError(r.errorWidgetGuid)})}}}])}function c(){"use strict";var e=angular.module("ev-widget.pm.expressPago",[]);e.config(["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}]),e.directive("evExpressPago",["pm2Util","EVExceptionHandler","EVENTS","$translate","$location","$q",function(e,t,n,r,i,a){return{restrict:"E",scope:{},templateUrl:"pm-v2/ev-expressPago.tpl.html",link:function(a,o,s){function l(){var e=document.getElementsByClassName("card-ui-component-validation-error");return!(e.length>0)}function c(e,t){r("ev.widgets.expressPago.invalidForm").then(function(e){a.errorCb&&a.errorCb(e)})["catch"](function(e){console.log("error:",e)})}function d(){return"ev-widget.pm.expressPago-"+EV.util.random_guid()}function u(e){var t=document.getElementsByTagName("ev-checkout-button")[0];t.style.display=e}function p(e){var t=document.getElementById("card-ui-component-btn-confirm");t.style.display=e}function f(e){var t=document.getElementById("card-ui-component-btn-cancel");t.style.display=e}function g(){console.log(a.order,"SCOPE creating express pago session"),e.getExpressPagoHtml().then(function(e){$("#creditcard-container").html(e.data),p("none"),f("none")})["catch"](function(e){console.log("ERROR GETTING EXPRESSPAGO HTML ",e)})}function h(){return!a.session&&EV.util.getEVSession()&&(a.session=EV.util.getEVSession()),a.session}a.loggedIn=EV.util.Storage.cookie.get("ev_ss"),a.submitting=!1,a.widgetGuid=s.id||d(),a.errorWidgetGuid="error-"+a.widgetGuid,a.widgetTitle=s.title||"PAYMENT DETAILS",o.attr("title",""),a.showHeader="false"!==s.showHeader,a.showErrorMsgs="false"!==s.showErrorMsgs,a.paymentTypes=s.paymentTypes?s.paymentTypes.split(","):["CARD"],a.defaultPayment=s.defaultPayment||"CARD",a.isSubscription="false"!==s.subscription,a.enableExistingCards="true"===s.enableExistingCards,a.displayOnlyDefaultCard="true"===s.displayOnlyDefaultCard,a.enableGoogleApplePay="true"===s.enableGoogleApplePay,a.paymentTypeOrderCreated=!1,a.successCb=null,a.errorCb=null,a.order=null,a.token=null;var m=(i.$$protocol+"://"+i.$$host,["CARD","IDEAL","PAYMENT_GATEWAY"]);a.errors=[],g(),window.SaveCreditCard_FailureCallback=function(e){console.log("SaveCreditCard_FailureCallback",e)},window.SaveCreditCard_SuccessCallback=function(e){a.token=e.TokenDetails.AccountToken,a.submitPayment(a.successCb,a.errorCb)},window.SaveCreditCard_CancelCallback=function(){console.log("SaveCreditCard_CancelCallback")},a.submitPayment=function(t,n){var r={token:a.token};e.processPayment(r,a.order.id).then(function(e){u("block"),a.successCb&&(EV.Event.publish(EV.Event.PM_PAYMENT_SUCCESS,e),a.successCb())})},a.isUserLoggedIn=function(){return h()},EV.Event.publish(EV.Event.PM_REGISTER_PROVIDER_WIDGET,{paymentType:"CARD",selector:"ev-express-pago"}),EV.Event.on(EV.Event.PM_CREATE_ORDER_SUCCESS,function(e){console.log("EV.Event.PM_CREATE_ORDER_SUCCESS",e),a.order=e}),EV.Event.on(EV.Event.PM_PAYMENT_TYPE_CHANGED,function(e){if(e){var t=e.name||e;m.includes(t)&&(a.defaultPayment=t)}}),EV.Event.on(EV.Event.PM_PRODUCT_ACTION,function(e){a.isSubscription=e.isSubscription}),EV.Event.on(EV.Event.LOGIN_SUCCESS,function(){console.log("LOGIN_SUCCESS pago event"),a.loggedIn=!0}),EV.Event.on(EV.Event.LOGOUT_ACTION,function(){console.log("login action pago event"),a.loggedIn=!1}),a.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_PROFILE,function(e,n){t.removeError(a.errorWidgetGuid)}),a.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_SUMMARY,function(e,t){console.log("HELLO HERE")}),a.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_PAYMENT,function(n,r){e.getBasket();if(a.successCb=r.successCb,a.errorCb=r.errorCb,t.removeError(a.errorWidgetGuid),document.getElementById("card-ui-component-btn-confirm").click(),!l())return console.log("FORM IS INVALID"),void c(a.errorCb,"Invalid form")})}}}])}function d(){"use strict";var e=angular.module("ev-widget.pm.gocardless",[]);e.directive("evGocardless",["pm2Util","EVExceptionHandler","EVENTS","$translate","$http",function(e,t,n,r,i){return{restrict:"E",scope:{},templateUrl:"pm-v2/ev-gocardless.tpl.html",link:function(i,a,o){function s(){return"ev-widget.pm.gocardless-"+EV.util.random_guid()}function l(){var n={accountNumber:i.accountNumber,branchCode:i.sortCode,countryCode:i.countryCode};e.checkBankDetails("DIRECT_DEBIT",n).then(function(e){console.log(e.data),i.setDDSubmited=!0,i.bankName=e.bankName})["catch"](function(e){if(e.data){var n=EV.util.error("invalid_bank_details",e.data.message,400);EV.Event.publish(EV.Event.PM_ERROR,n),t.handleError(i.errorWidgetGuid,n),i.showError=!0,i.setDDSubmited=!1,i.bankName=null}})}function c(e){var n=e.errors[0].field.replace(/_([a-z])/g,function(e){return e[1].toUpperCase()}),a="ev.widgets.gocardless."+n;r(a).then(function(n){var r=EV.util.error("validation_failed",n+" "+e.errors[0].message,400);EV.Event.publish(EV.Event.PM_ERROR,r),t.handleError(i.errorWidgetGuid,r)})["catch"](function(e){EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(i.errorWidgetGuid,e)})}function d(e){var t=document.createElement("script");t.src=e?"https://pay.gocardless.com/js/beta":"https://pay-sandbox.gocardless.com/js/beta",t.onload=function(){console.log("Gocardless ready!")},document.body.appendChild(t)}function u(){i.loggedIn?e.retrieveCustomerBankAccountDetails().then(function(e){i.bankAccounts=e,i.newAccount=null==i.bankAccounts||0===i.bankAccounts.length}):(i.bankAccounts=null,i.newAccount=!0)}function p(){f();var e="ev.widgets.errors.field_required",t="ev.widgets.errors.field_length6",n="ev.widgets.errors.field_length8",r=!0;return i.accountHolderName||(i.accountHolderNameError=e,r=!1),i.sortCode?6!==i.sortCode.length&&(i.sortCodeError=t,r=!1):(i.sortCodeError=e,r=!1),i.accountNumber?8!==i.accountNumber.length&&(i.accountNumberError=n,r=!1):(i.accountNumberError=e,r=!1),i.authorizeMandate||(i.authorizeMandateError=e,r=!1),r}function f(){i.accountHolderNameError=i.sortCodeError=i.accountNumberError=i.authorizeMandateError=null}i.loggedIn=EV.util.Storage.cookie.get("ev_ss"),i.live="false"!==o.live,i.widgetGuid=o.id||s(),i.errorWidgetGuid="error-"+i.widgetGuid,i.widgetTitle=o.title||"Direct Debit Mandate",a.attr("title",""),i.showHeader="false"!==o.showHeader,i.showErrorMsgs="false"!==o.showErrorMsgs,i.countryCode="GB",i.privacyNotice=o.privacyNotice||"https://gocardless.com/legal/privacy/",i.directDebitGuarantee=o.directDebitGuarantee||"https://gocardless.com/direct-debit/guarantee/",i.addressLine1=o.addressLine1,i.addressLine2=o.addressLine2,i.addressLine3=o.addressLine3,i.city=o.city,i.postcode=o.postcode,i.email=o.email,i.phone=o.phone,EV.Event.publish(EV.Event.PM_REGISTER_PROVIDER_WIDGET,{paymentType:"DIRECT_DEBIT",selector:"ev-gocardless"}),d(i.live),u(),i.submitSetUpDirectDebit=function(){if(t.removeError(i.errorWidgetGuid),i.newAccount)if(p())l();else var e=EV.util.error("form_error","Please correct the errors below",400);else i.selectedBankAccount?i.setDDSubmited=!0:e=EV.util.error("form_error_bankAccount","Please select a bank account",400);e&&(EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(i.errorWidgetGuid,e),i.showError=!0)},i.createNewAccount=function(e){i.newAccount=e},i.changeSetUpDirectDebit=function(){i.setDDSubmited=!1,i.ddConfirmed=!1},i.confirmDirectDebit=function(){if(t.removeError(i.errorWidgetGuid),i.ddConfirmed=!0,i.newAccount){var e="GB",n=EV.PM.gocardlessKey;GoCardless.customerBankAccountTokens.create({publishable_access_token:n,customer_bank_account_tokens:{account_number:i.accountNumber,branch_code:i.sortCode,account_holder_name:i.accountHolderName,country_code:e}},function(t){t.error?(c(t.error),i.ddConfirmed=!1):i.purchasePayload={customer_bank_account_token:t.customer_bank_account_tokens.id,country_code:e,update_account:"true"}})}else i.purchasePayload={update_account:"true",customer_bank_account_id:i.selectedBankAccount.id}},i.submitDirectDebitConfirmation=function(n,r){if(!i.setDDSubmited||!i.ddConfirmed){var a=EV.util.error("set_direct_debit","Please set up the Direct Debit and confirm your details",400);return EV.Event.publish(EV.Event.PM_ERROR,a),t.handleError(i.errorWidgetGuid,a),i.showError=!0,void(r&&r("direct_debit"))}if(t.removeError(i.errorWidgetGuid),!e.isCheckoutButtonLoaded()||n){i.submitting=!0;var o=e.getBasket();return o&&o.id?e.processPayment(i.purchasePayload,o.id).then(function(t){EV.Event.publish(EV.Event.PM_PAYMENT_SUCCESS,t),i.success=!0,e.removeBasket(o),e.removeExtraProperties(),n&&n()})["catch"](function(e){console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(i.errorWidgetGuid,e),r&&r("payment")})["finally"](function(){return i.submitting=!1}):void 0}},EV.Event.on(EV.Event.PM_REDIRECT_TO_PAYMENT,function(e){e&&"GOCARDLESS"===e.providerName&&EV.Event.publish(EV.Event.PM_REDIRECT_TO_GOCARDLESS_PAYMENT,e)}),EV.Event.on(EV.Event.LOGIN_SUCCESS,function(){i.loggedIn=!0}),EV.Event.on(EV.Event.LOGOUT_ACTION,function(){i.loggedIn=!1,u()}),i.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_PAYMENT,function(t,n){var r=e.getBasket();r&&r.paymentType&&"DIRECT_DEBIT"===r.paymentType&&i.submitDirectDebitConfirmation(n.successCb,n.errorCb)}),i.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_PROFILE,function(e,n){t.removeError(i.errorWidgetGuid)})}}}])}function u(){"use strict";var e=angular.module("ev-widget.pm.googlePay",[]);e.directive("evGooglePay",["pm2Util","EVExceptionHandler","EVENTS","$translate",function(e,t,n,r){return{restrict:"E",scope:{},templateUrl:"pm-v2/ev-google-pay.tpl.html",link:function(r,i,a,o){function s(){return"ev-widget.pm.googlePay-"+EV.util.random_guid()}function l(t){e.getPaymentPlanTotalPrice(t.id).then(function(e){console.log("[Google Pay] Payment Plan final price",e),r.googleTransactionInfo={currencyCode:t.currency.id,totalPriceStatus:"FINAL",totalPrice:""+e.totalPrice}})["catch"](function(e){console.error("Error in retrieving/processing totalPrice from paymentPlan",e)})}function c(t){return new Promise(function(i,a){y=JSON.parse(t.paymentMethodData.tokenizationData.token),e.isCheckoutButtonLoaded()?(EV.Event.publish(n.INTERNAL.PM_CHECKOUT.TRIGGER_CHECKOUT,{}),document.querySelector("ev-checkout-button").style.display="block"):r.submit(),i({})})}function d(e){return new Promise(function(t,n){c(e).then(function(){t({transactionState:"SUCCESS"})})["catch"](function(){t({transactionState:"ERROR",error:{intent:"PAYMENT_AUTHORIZATION",message:"Insufficient funds",reason:"PAYMENT_DATA_INVALID"}})})})}function u(){if(r.googleTransactionInfo){var e=p();g().loadPaymentData(e)["catch"](function(e){console.log(e)})}else console.warn("Try selecting a plan again and then retry Google Pay")}function p(){var e=Object.assign({},w);return e.allowedPaymentMethods=[_],e.transactionInfo=r.googleTransactionInfo,e.merchantInfo={merchantId:EV.PM.googleMerchantId,merchantName:EV.PM.googleMerchantName},e.callbackIntents=["PAYMENT_AUTHORIZATION"],e}function f(){var e=document.createElement("script");e.src="https://pay.google.com/gp/p/js/pay.js",e.onload=function(){console.log("Google Pay ready!"),h()},document.body.appendChild(e)}function g(){return null===E&&(E=new google.payments.api.PaymentsClient({environment:b,paymentDataCallbacks:{onPaymentAuthorized:d}})),E}function h(){t.removeError(r.errorWidgetGuid),g().isReadyToPay(P).then(function(e){if(e.result){var t=E.createButton({onClick:u});document.getElementById("ev-google-pay-container").appendChild(t)}})["catch"](function(e){console.error(e)})}r.loggedIn=EV.util.Storage.cookie.get("ev_ss"),r.widgetGuid=a.id||s(),r.errorWidgetGuid="error-"+r.widgetGuid,r.widgetTitle=a.title||"PAYMENT DETAILS",i.attr("title",""),r.showHeader="false"!==a.showHeader,r.showErrorMsgs="false"!==a.showErrorMsgs;var m=["AMEX","MASTERCARD","VISA"],v=["PAN_ONLY","CRYPTOGRAM_3DS"],b="true"===a.live?"PRODUCTION":"TEST";r.googleTransactionInfo=null,f(),EV.Event.publish(EV.Event.PM_REGISTER_PROVIDER_WIDGET,{paymentType:"GOOGLE_PAY",selector:"ev-google-pay"});var y=void 0;r.submit=function(n,i){if(r.showError=!1,r.googlePayErrorMessage="",r.submitting=!0,t.removeError(r.errorWidgetGuid),!r.loggedIn){var a=EV.util.error("not_logged_in","Error",400);return EV.Event.publish(EV.Event.PM_ERROR,a),t.handleError(r.errorWidgetGuid,a),void(i&&i("payment"))}if(r.googlePayErrorMessage)return void(i&&i("payment"));var o=e.getBasket(),s={token:y};if(o&&o.id)return e.processPayment(s,o.id).then(function(t){EV.Event.publish(EV.Event.PM_PAYMENT_SUCCESS,t),r.success=!0,e.removeBasket(o),n&&n()})["catch"](function(e){console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(r.errorWidgetGuid,e),i&&i("payment")})["finally"](function(){return r.submitting=!1});var l;l=o?EV.util.error("undefined_order_id","Error",400):EV.util.error("no_products_selected","No products selected",400),EV.Event.publish(EV.Event.PM_ERROR,l),t.handleError(r.errorWidgetGuid,l),r.$apply(function(){return r.submitting=!1}),i&&i("payment")},EV.Event.on(EV.Event.LOGIN_SUCCESS,function(){r.loggedIn=!0}),EV.Event.on(EV.Event.LOGOUT_ACTION,function(){r.loggedIn=!1}),EV.Event.on(EV.Event.PM_REDIRECT_TO_PAYMENT,function(e){e&&"GOOGLE_PAY"===e.paymentType&&EV.Event.publish(EV.Event.PM_REDIRECT_TO_GOOGLE_PAY_PAYMENT,e)}),r.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_PAYMENT,function(t,n){var i=e.getBasket();i&&i.paymentType&&"GOOGLE_PAY"===i.paymentType&&r.submit(n.successCb,n.errorCb)}),r.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_PROFILE,function(e,n){t.removeError(r.errorWidgetGuid)}),EV.Event.on(EV.Event.PM_PRODUCTS_SELECTED,function(e){console.log("PM_PRODUCT_SELECTED",e[0].paymentPlan.id),l(e[0].paymentPlan)});var E=null,w={apiVersion:2,apiVersionMinor:0},C={type:"PAYMENT_GATEWAY",parameters:{gateway:EV.PM.googleGatewayProvider,gatewayMerchantId:EV.PM.googleMerchantPublicKey}},S={type:"CARD",parameters:{allowedAuthMethods:v,allowedCardNetworks:m}},_=Object.assign({tokenizationSpecification:C},S),P=Object.assign({},w);P.allowedPaymentMethods=[S]}}}])}function f(){"use strict";var e=angular.module("ev-widget.pm.grant",[]);e.config(["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}]),e.directive("evGrant",["$location","WidgetUtil","$translate","pm2Util",function(e,t,n,r){return{restrict:"E",scope:{invitationKey:"@"},templateUrl:"pm-v2/ev-grant-v2.tpl.html",controller:["WidgetUtil","EVExceptionHandler","$scope","$q","$attrs","$element",function(t,n,i,a,o,s){function l(){i.grantInvitationsList=r.getGrantInvitationsList().then(function(e){i.grantInvitationsList=e})}function c(){e.search().invitationKey?i.grantInvitationKey=r.getGrantInvitationKey(e.search().invitationKey).then(function(e){i.grantInvitationKey=e}):i.grantInvitationKey=""}function d(){if(n.removeError(i.errorWidgetGuid),i.loggedIn)a.all([l(),c()])["catch"](function(e){i.showErrorMsgs=!0,console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),n.handleError(i.errorWidgetGuid,e)})["finally"](function(){i.isLoading=!1,EV.Event.publish(EV.Event.PM_INVITATIONS_LOADED)});else{i.showErrorMsgs=!0,i.isLoading=!1;var e=EV.util.error("not_logged_in","Not Logged In",400);EV.Event.publish(EV.Event.PM_ERROR,e),n.handleError(i.errorWidgetGuid,e)}}i.getWidgetId=function(){return"ev-widget.pm.Grant-"+EV.util.random_guid()},i.loggedIn=EV.util.Storage.cookie.get("ev_ss"),i.widgetGuid=o.id||i.getWidgetId(),i.errorWidgetGuid="error-"+i.widgetGuid,i.widgetTitle=o.title||"GRANT INVITE",s.attr("title",""),i.showErrorMsgs="false"!==o.showErrorMsgs,i.showHeader="false"!==o.showHeader,i.isLoading=!0,d(),i.acceptInvitation=function(t){r.grantAction(t,"accept").then(function(){e.url(e.path()),EV.Event.publish(EV.Event.PM_INVITATION_KEY_ACCEPTED)})["catch"](function(e){i.showErrorMsgs=!0,console.error(e);var t=EV.util.error("action_accept_fail","This action can not be performed at the moment",400);EV.Event.publish(EV.Event.PM_ERROR,t),n.handleError(i.errorWidgetGuid,t)})},i.declineInvitation=function(t){r.grantAction(t,"decline").then(function(){e.url(e.path()),EV.Event.publish(EV.Event.PM_INVITATION_KEY_DECLINED)})["catch"](function(e){i.showErrorMsgs=!0,console.error(e);var t=EV.util.error("action_decline_fail","This action can not be performed at the moment",400);EV.Event.publish(EV.Event.PM_ERROR,t),n.handleError(i.errorWidgetGuid,t)})},EV.Event.on(EV.Event.PM_INVITATION_KEY_ACCEPTED,function(){d()}),EV.Event.on(EV.Event.PM_INVITATION_KEY_DECLINED,function(){d()}),EV.Event.on(EV.Event.LOGIN_SUCCESS,function(){i.loggedIn=!0,d()})}]}}])}function g(){"use strict";var e=angular.module("ev-widget.pm.klarna",[]);e.config(["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}]),e.directive("evKlarna",["pm2Util","EVExceptionHandler","EVENTS","$translate","$location","$window",function(e,t,n,r,i,a){return{restrict:"E",scope:{},templateUrl:"pm-v2/ev-klarna.tpl.html",link:function(a,o,s){function l(){return"ev-widget.pm.klarna-"+EV.util.random_guid()}function c(){var e=document.createElement("script");e.src="https://x.klarnacdn.net/kp/lib/v1/api.js",e.onload=function(){console.log("Klarna loaded!")},document.body.appendChild(e)}function d(e){console.log("Klarna session created",e),m=e.data.klarna_session_id;var t={client_token:e.data.klarna_client_token,klarna_payment_method_categories:e.data.klarna_payment_method_categories};p(t)}function u(t){e.completeSubscription(a.order.id,t).then(function(e){EV.Event.publish(EV.Event.PM_PAYMENT_SUCCESS,e),a.successCb&&a.successCb()})["catch"](function(e){console.error(e),a.errorCb&&a.errorCb(),h(e)}),f("block"),g(!1),a.displayKlarnaBtn=!1}function p(e){t.removeError(a.errorWidgetGuid),Klarna.Payments.init({client_token:e.client_token}),Klarna.Payments.load({container:"#klarna-payments-container",payment_method_category:"pay_now"},function(e){console.log("klarna load result",e),e.show_form&&console.log("re.show_form = true")}),f("none"),a.displayKlarnaBtn=!0}function f(e){var t=document.getElementsByTagName("ev-checkout-button")[0];t.style.display=e}function g(e){var t=document.getElementById("KlarnaAuthBtn");t.disabled=e}function h(e){var n=new RegExp("\\{0\\}","gi"),i="ev.widgets.klarna.error."+e.error.code;r(i).then(function(r){r=r.replace(n,e.error.args[0]);var i=EV.util.error(e.error.code,r,e.statusCode,e.error.args);EV.Event.publish(EV.Event.PM_ERROR,i),t.handleError(a.errorWidgetGuid,i)})}a.loggedIn=EV.util.Storage.cookie.get("ev_ss"),a.widgetGuid=s.id||l(),a.errorWidgetGuid="error-"+a.widgetGuid,a.widgetTitle=s.title||"PAYMENT DETAILS",o.attr("title",""),a.showHeader="false"!==s.showHeader,a.showErrorMsgs="false"!==s.showErrorMsgs,a.paymentTypes=s.paymentTypes?s.paymentTypes.split(","):["CARD"],
a.defaultPayment=s.defaultPayment||"CARD",a.klarnaTransactionInfo=null,a.order=null;var m;i.$$protocol+"://"+i.$$host;c(),a.getKlarnaAuthorization=function(){g(!0),Klarna.Payments.authorize({payment_method_category:"pay_now"},{},function(e){if(console.log("klarna authorize res:",e),e.approved){var t={klarna_authorization_token:e.authorization_token,klarna_session_id:m};u(t)}else g(!1)})},a.sendKlarnaPayment=function(){Klarna.Payments.finalize({payment_method_category:"pay_now"},{},function(e){console.log("klarna finalize:",e)})},a.createKlarnaSession=function(n,r){if(t.removeError(a.errorWidgetGuid),!e.isCheckoutButtonLoaded()||n){if(!a.order){var i=EV.util.error("order_not_created","An order hasn't been created.",400);return EV.Event.publish(EV.Event.PM_ERROR,i),void(r&&r("checkout"))}a.successCb=n,a.errorCb=r,a.processingKlarnaCheckout=!0,e.createSubscription(a.order.id,{}).then(d)["catch"](function(e){console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(a.errorWidgetGuid,e),r&&r("checkout")})["finally"](function(){a.processingKlarnaCheckout=!1})}},EV.Event.publish(EV.Event.PM_REGISTER_PROVIDER_WIDGET,{paymentType:"CARD",selector:"ev-klarna"}),EV.Event.on(EV.Event.PM_CREATE_ORDER_SUCCESS,function(e){a.order=e}),EV.Event.on(EV.Event.PM_REDIRECT_TO_PAYMENT,function(e){e&&"KLARNA"===e.providerName&&EV.Event.publish(EV.Event.PM_REDIRECT_TO_KLARNA_PAYMENT,e)}),a.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_PAYMENT,function(t,n){var r=e.getBasket();r&&r.paymentType&&"CARD"===r.paymentType&&a.createKlarnaSession(n.successCb,n.errorCb)})}}}])}function h(){"use strict";var e=angular.module("ev-widget.pm.manageReferralCode",[]);e.config(["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}]),e.directive("evManageReferralCode",["pm2Util","EVExceptionHandler","EVENTS","$translate","$window",function(e,t,n,r,i){return{restrict:"E",scope:{},templateUrl:"pm-v2/ev-manage-referral-code.tpl.html",controller:["$scope","$attrs","$element",function(n,r,i){function a(){return"ev-widget.pm.manageReferralCode-"+EV.util.random_guid()}function o(){if(t.removeError(n.errorWidgetGuid),n.loggedIn)e.retrieveReferralCodeData().then(function(e){e.referralCode?(n.hasReferralCode=!0,n.referralCode=e.referralCode,n.numberOfReferrals=e.numberOfReferrals,null!=n.subscribePagePath&&(n.referralLink=n.subscribePagePath+"?rf="+e.referralCode,n.showLink=!0)):n.allowCodeGeneration=!0})["catch"](function(e){console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(n.errorWidgetGuid,e)});else{var r=EV.util.error("not_logged_in","Not Logged In",400);EV.Event.publish(EV.Event.PM_ERROR,r),t.handleError(n.errorWidgetGuid,r)}}n.isLoading=!0,n.formErrors=[],n.translatedErrors=[],n.loggedIn=EV.util.Storage.cookie.get("ev_ss"),n.widgetGuid=r.id||a(),n.errorWidgetGuid="error-"+n.widgetGuid,n.widgetTitle=r.title||"REFERRAL CODE",i.attr("title",""),n.showHeader="false"!==r.showHeader,n.showErrorMsgs="false"!==r.showErrorMsgs,n.showLabels="false"!==r.showLabels,n.showHidden="true"===r.showHidden,n.subscribePagePath=r.subscribePagePath,n.showLink=!1,n.referralLink="",n.hasReferralCode=!1,n.allowCodeGeneration=!1,n.referralCode=null,n.numberOfReferrals=0,o(),n.generateReferralCode=function(){e.generateReferralCode().then(function(e){o()})["catch"](function(e){console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(n.errorWidgetGuid,e)})},EV.Event.on(EV.Event.LOGIN_SUCCESS,function(){n.loggedIn=!0,o()}),EV.Event.on(EV.Event.LOGOUT_ACTION,function(){n.loggedIn=!1,n.hasReferralCode=!1,n.allowCodeGeneration=!1,n.$apply(),o()})}]}}])}function m(){"use strict";var e=angular.module("ev-widget.pm.manual",[]);e.directive("evManual",["pm2Util","EVExceptionHandler","EVENTS",function(e,t,n){return{restrict:"E",scope:{},templateUrl:"pm-v2/ev-manual.tpl.html",link:function(r,i,a,o){function s(){return"ev-widget.pm.manual-"+EV.util.random_guid()}r.loggedIn=EV.util.Storage.cookie.get("ev_ss"),r.widgetGuid=a.id||s(),r.errorWidgetGuid="error-"+r.widgetGuid,r.widgetTitle=a.title||"PAYMENT DETAILS",i.attr("title",""),r.showHeader="false"!==a.showHeader,r.showErrorMsgs="false"!==a.showErrorMsgs;var l=["CASH","BANK_TRANSFER","CHEQUE","NO_CHARGE"];angular.element(function(){EV.Event.publish(EV.Event.PM_MANUAL_WIDGET_LOADED)}),r.submit=function(n,i){if(r.showError=!1,r.manualErrorMessage="",r.submitting=!0,t.removeError(r.errorWidgetGuid),!e.isCheckoutButtonLoaded()||n){if(!r.loggedIn){var a=EV.util.error("not_logged_in","Error",400);return EV.Event.publish(EV.Event.PM_ERROR,a),t.handleError(r.errorWidgetGuid,a),void(i&&i("payment"))}if(r.manualErrorMessage)return void(i&&i("payment"));var o=e.getBasket(),s={};if(o&&o.id)return e.processPayment(s,o.id).then(function(t){EV.Event.publish(EV.Event.PM_PAYMENT_SUCCESS,t),r.success=!0,e.removeBasket(o),n&&n()})["catch"](function(e){console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(r.errorWidgetGuid,e),i&&i("payment")})["finally"](function(){return r.submitting=!1});var l=void 0;l=o?EV.util.error("undefined_order_id","Error",400):EV.util.error("no_products_selected","No products selected",400),EV.Event.publish(EV.Event.PM_ERROR,l),t.handleError(r.errorWidgetGuid,l),r.$apply(function(){return r.submitting=!1}),i&&i("payment")}},EV.Event.on(EV.Event.LOGIN_SUCCESS,function(){r.loggedIn=!0}),EV.Event.on(EV.Event.LOGOUT_ACTION,function(){r.loggedIn=!1}),EV.Event.on(EV.Event.PM_REDIRECT_TO_PAYMENT,function(e){e&&"MANUAL"===e.providerName&&EV.Event.publish(EV.Event.PM_REDIRECT_TO_MANUAL_PAYMENT,e)}),r.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_PAYMENT,function(t,n){var i=e.getBasket();i&&i.paymentType&&l.includes(i.paymentType)&&r.submit(n.successCb,n.errorCb)}),r.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_PROFILE,function(e,n){t.removeError(r.errorWidgetGuid)})}}}])}function v(){"use strict";var e=angular.module("ev-widget.pm.mercado",[]);e.directive("evMercado",["pm2Util","EVExceptionHandler","EVENTS","$translate",function(e,t,n,r){return{restrict:"E",scope:{},templateUrl:"pm-v2/ev-mercado.tpl.html",link:function(i,a,o,s){function l(e){var t="ev.widgets.mercado.error."+e.code;r(t).then(function(e){i.mercadoErrorMessage=e})["catch"](function(e){r("ev.widgets.mercado.error.default").then(function(e){i.mercadoErrorMessage=e})})}function c(e,t){return e.length<=t}function d(e){return/^\d+$/.test(e)}function u(){return"ev-widget.pm.mercado-"+EV.util.random_guid()}function p(){var e=document.createElement("script");e.src="https://sdk.mercadopago.com/js/v2",e.onload=function(){console.log("Mercado ready!"),f()},document.body.appendChild(e),angular.element(function(){EV.Event.publish(EV.Event.PM_MERCADO_WIDGET_LOADED)})}function f(){function e(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{label:"name",value:"id"},r=n.label,i=n.value,a=document.createDocumentFragment();t.forEach(function(e){var t=e[i],n=e[r],o=document.createElement("option");o.value=t,o.textContent=n,a.appendChild(o)}),e.appendChild(a)}function n(e){var t=e.bin;g.getPaymentMethods({bin:t}).then(function(e){r(200,e.results)})}function r(e,t){if(t||(h=t),200==e&&t){var n=document.querySelector("#pay");if(null==document.querySelector("input[name=paymentMethodId]")){var r=document.createElement("input");r.setAttribute("name","paymentMethodId"),r.setAttribute("type","hidden"),r.setAttribute("value",t[0].id),n.appendChild(r)}else document.querySelector("input[name=paymentMethodId]").value=t[0].id;h=t[0].id}}t.removeError(i.errorWidgetGuid);var a=document.querySelectorAll(".mercado-payment .input");Array.prototype.forEach.call(a,function(e){e.addEventListener("focus",function(){e.classList.add("focused")}),e.addEventListener("blur",function(){e.classList.remove("focused")}),e.addEventListener("keyup",function(){0===e.value.length?e.classList.add("empty"):e.classList.remove("empty")})}),g=new MercadoPago(EV.PM.mercadoKey),g.getIdentificationTypes().then(function(t){var n=document.getElementById("docType");e(n,t)});var o=g.fields.create("cardNumber",{placeholder:"Card Number"}).mount("cardNumber");g.fields.create("expirationDate",{placeholder:"MM/YY"}).mount("expirationDate"),g.fields.create("securityCode",{placeholder:"Security Code"}).mount("securityCode");o.on("binChange",n)}i.loggedIn=EV.util.Storage.cookie.get("ev_ss"),i.widgetGuid=o.id||u(),i.errorWidgetGuid="error-"+i.widgetGuid,i.widgetTitle=o.title||"PAYMENT DETAILS",a.attr("title",""),i.showHeader="false"!==o.showHeader,i.showErrorMsgs="false"!==o.showErrorMsgs;var g,h;p(),EV.Event.publish(EV.Event.PM_REGISTER_PROVIDER_WIDGET,{paymentType:"CARD",selector:"ev-mercado"}),i.submit=function(n,r){if(i.showError=!1,i.mercadoErrorMessage="",i.submitting=!0,t.removeError(i.errorWidgetGuid),!e.isCheckoutButtonLoaded()||n){if(!i.loggedIn){var a=EV.util.error("not_logged_in","Error",400);return EV.Event.publish(EV.Event.PM_ERROR,a),t.handleError(i.errorWidgetGuid,a),void(r&&r("payment"))}if(i.mercadoErrorMessage)return void(r&&r("payment"));var o=document.querySelector("#pay"),s=o.elements.cardholderName.value,u=o.elements.docNumber.value,p=o.elements.docType.value;return d(u)||"Otro"!=p?("Otro"!==p||c(u,8))&&("Otro"===p||c(u,8))?void g.fields.createCardToken({cardholderName:s,identificationType:p,identificationNumber:u}).then(function(a){var o=document.querySelector("#pay"),s=document.createElement("input");s.setAttribute("name","token"),s.setAttribute("type","hidden"),s.setAttribute("value",a.id),o.appendChild(s);var l=e.getBasket(),c={token:{response:a,paymentMethodId:h}};if(l&&l.id)return e.processPayment(c,l.id).then(function(t){EV.Event.publish(EV.Event.PM_PAYMENT_SUCCESS,t),i.success=!0,e.removeBasket(l),n&&n()})["catch"](function(e){console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(i.errorWidgetGuid,e),r&&r("payment")})["finally"](function(){return i.submitting=!1});var d=void 0;d=l?EV.util.error("undefined_order_id","Error",400):EV.util.error("no_products_selected","No products selected",400),EV.Event.publish(EV.Event.PM_ERROR,d),t.handleError(i.errorWidgetGuid,d),i.$apply(function(){return i.submitting=!1}),r&&r("payment")},function(e){console.error("Got error from Mercado while creating Card Token",e);var n=void 0;if(Array.isArray(e))for(var a=0;a<e.length;a++)e[a].message&&(n+=e[a].message+"<br>");else n=e;var o=EV.util.error("mercado_card_form_error","Card form error",500,[n]);EV.Event.publish(EV.Event.PM_ERROR,o),t.handleError(i.errorWidgetGuid,o),i.$apply(function(){return i.submitting=!1}),r&&r("payment")})["catch"](function(e){console.error("Catched Mercado Error while creating Card Token",e);var n=void 0;if(Array.isArray(e))for(var a=0;a<e.length;a++)e[a].message&&(n+=e[a].message+"<br>");else n=e;var o=EV.util.error("mercado_card_form_error","Card form error",500,[n]);EV.Event.publish(EV.Event.PM_ERROR,o),t.handleError(i.errorWidgetGuid,o),i.$apply(function(){return i.submitting=!1}),r&&r("payment")}):(i.showError=!0,l({code:"docNumberLength"}),i.submitting=!1,EV.Event.publish(EV.Event.PM_ERROR,"invalid parameters"),void(r&&r("payment"))):(i.showError=!0,l({code:"docNumberAlphaNum"}),i.submitting=!1,EV.Event.publish(EV.Event.PM_ERROR,"invalid parameters"),void(r&&r("payment")))}},EV.Event.on(EV.Event.LOGIN_SUCCESS,function(){i.loggedIn=!0}),EV.Event.on(EV.Event.LOGOUT_ACTION,function(){i.loggedIn=!1}),EV.Event.on(EV.Event.PM_REDIRECT_TO_PAYMENT,function(e){e&&"MERCADO"===e.providerName&&EV.Event.publish(EV.Event.PM_REDIRECT_TO_MERCADO_PAYMENT,e)}),i.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_PAYMENT,function(t,n){var r=e.getBasket();r&&r.paymentType&&"CARD"===r.paymentType&&i.submit(n.successCb,n.errorCb)}),i.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_PROFILE,function(e,n){t.removeError(i.errorWidgetGuid)})}}}])}function b(){"use strict";var e=angular.module("ev-widget.pm.paycomet",[]);e.config(["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}]),e.directive("evPaycomet",["pm2Util","EVExceptionHandler","EVENTS","$translate","$location","$q","$sce",function(e,t,n,r,i,a,o){return{restrict:"E",scope:{},templateUrl:"pm-v2/ev-paycomet.tpl.html",link:function(i,a,s){function l(){var e=document.getElementsByClassName("card-ui-component-validation-error");return!(e.length>0)}function c(e,t){r("ev.widgets.expressPago.invalidForm").then(function(e){i.errorCb&&i.errorCb(e)})}function d(){return"ev-widget.pm.expressPago-"+EV.util.random_guid()}function u(){document.getElementById("paymentSelector").style.display="none"}function p(){console.log("creating");var t=e.getBasket();console.log("basket now???",t)}function f(){return!i.session&&EV.util.getEVSession()&&(i.session=EV.util.getEVSession()),i.session}console.log("IS PAYCOMET HERE"),i.loggedIn=EV.util.Storage.cookie.get("ev_ss"),i.submitting=!1,i.widgetGuid=s.id||d(),i.errorWidgetGuid="error-"+i.widgetGuid,i.widgetTitle=s.title||"PAYMENT DETAILS",a.attr("title",""),i.showHeader="false"!==s.showHeader,i.showErrorMsgs="false"!==s.showErrorMsgs,i.paymentTypes=s.paymentTypes?s.paymentTypes.split(","):["CARD"],i.defaultPayment=s.defaultPayment||"CARD",i.isSubscription="false"!==s.subscription,i.enableExistingCards="true"===s.enableExistingCards,i.displayOnlyDefaultCard="true"===s.displayOnlyDefaultCard,i.enableGoogleApplePay="true"===s.enableGoogleApplePay,i.paymentTypeOrderCreated=!1,i.successCb=null,i.errorCb=null,i.order=null,i.jetToken=null,i.iframeUrl=o.trustAsResourceUrl("https://api.paycomet.com/gateway/restgateway/Vystb3k6aUlAPEIrZyEhKiR7Li9UMC4xcmg3P19hXkRtXlE2PiYqQjccmYp/en");var g=["CARD","IDEAL","PAYMENT_GATEWAY"];i.errors=[],i.challengeUrl=null,p(),i.submitPayment=function(){var t={jetToken:i.jetToken};e.createSubscription(i.order.id,t).then(function(e){e.data||console.error("res.data is null");var t=e.data.externalData;console.log("externalData",t),console.log("externalData challengeUrl",t.challengeUrl);var n=t.challengeUrl;console.log("challengeUrl",n),i.challengeUrl=o.trustAsResourceUrl(n)})},i.submitCardForm=function(){console.log("submitting...!!!!...")},i.isUserLoggedIn=function(){return f()},EV.Event.publish(EV.Event.PM_REGISTER_PROVIDER_WIDGET,{paymentType:"CARD",selector:"ev-express-pago"}),u(),EV.Event.on(EV.Event.PM_CREATE_ORDER_SUCCESS,function(e){console.log("EV.Event.PM_CREATE_ORDER_SUCCESS",e),i.order=e}),EV.Event.on(EV.Event.PM_PAYMENT_TYPE_CHANGED,function(e){if(e){var t=e.name||e;g.includes(t)&&(i.defaultPayment=t)}}),EV.Event.on(EV.Event.PM_PRODUCT_ACTION,function(e){i.isSubscription=e.isSubscription}),EV.Event.on(EV.Event.LOGIN_SUCCESS,function(){console.log("LOGIN_SUCCESS pago event"),i.loggedIn=!0}),EV.Event.on(EV.Event.LOGOUT_ACTION,function(){console.log("login action pago event"),i.loggedIn=!1}),i.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_PROFILE,function(e,n){t.removeError(i.errorWidgetGuid)}),EV.Event.on(EV.Event.PM_CREATE_ORDER_SUCCESS,function(e){i.order=e,console.log("create order success",e)}),i.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_PAYMENT,function(n,r){e.getBasket();return i.successCb=r.successCb,i.errorCb=r.errorCb,t.removeError(i.errorWidgetGuid),l()?void i.submitPayment():void c(i.errorCb,"Invalid form")})}}}])}function y(){"use strict";var e=angular.module("ev-widget.pm.productProfile",[]);e.directive("evProductProfile",["pm2Util","EVExceptionHandler","EVENTS","$translate","$window","$timeout","$http","$uibModal",function(e,t,n,r,i,a,o,s){return{restrict:"E",scope:{socialNetworks:"=socialNetworks"},templateUrl:"pm-v2/ev-product-profile.tpl.html",controller:["$scope",function(e){e.inputBeneficiary=""}],link:function(o,l,c,d){function u(){console.log("checkAgainstmandatoryFields",o.mandatoryAttributes);var e=o.config.selectedBillingAddress.name,t=q(o.profileGroups,o.loggedIn),n=t.filter(function(e){return null!==e.value}).map(function(e){return{name:e.name,value:e.value}});if(console.log("scope to send =>",o),console.log("check ic  attrs",n),console.log("billingAddressGroup:",e),o.mandatoryAttributes){for(var r=0,i=!1,a=0;a<Object.keys(o.mandatoryAttributes).length;a++){var s=Object.keys(o.mandatoryAttributes)[a];if(s.includes("*"))for(var l=0;l<n.length;l++){var c=n[l].name,d=n[l].value,u=s.split("*")[0],p=s.split("*")[1];c.startsWith(u)&&c.endsWith(p)&&d&&(r+=1)}else for(var f=0;f<n.length;f++){var g=n[f].name,h=n[f].value;g==s&&h&&(r+=1)}}Object.keys(o.mandatoryAttributes).length===r&&(i=!0,o.passMandatoryCheck=!0),i||(o.passMandatoryCheck=!1)}}function p(e){e.forEach(function(e){o.referenceDataMap[e.dataName]=e})}function f(e){e.forEach(function(e){e.attributes.forEach(function(e){o.referenceDataAttributeMap[e]=[]})}),e.forEach(function(e){e.attributes.forEach(function(t){o.referenceDataAttributeMap[t].push(e)})})}function g(e){var t=angular.copy(EV.WM.referenceData),n=t.filter(function(t){return t.attributes.includes(e.name)});if(0!=n.length){var r=null,i=!(null==o.config.selectedBillingAddress||!o.config.selectedBillingAddress.attributes)&&o.config.selectedBillingAddress.attributes.filter(function(t){return t.name===e.name}).length>0,a=!(null==o.config.selectedDeliveryAddress||!o.config.selectedDeliveryAddress.attributes)&&o.config.selectedDeliveryAddress.attributes.filter(function(t){return t.name===e.name}).length>0;if(i){var s=angular.copy(o.config.selectedBillingAddress);r=s.attributes.findIndex(function(t){return t.name===e.name}),s.attributes=s.attributes.slice(r+1),s.attributes.forEach(function(t){return E(e,t.name,o)})}else if(a){var l=angular.copy(o.config.selectedDeliveryAddress);r=l.attributes.findIndex(function(t){return t.name===e.name}),l.attributes=l.attributes.slice(r+1),l.attributes.forEach(function(t){return E(e,t.name,o)})}}}function h(e){var t=!(null==o.config.selectedBillingAddress||!o.config.selectedBillingAddress.attributes)&&o.config.selectedBillingAddress.attributes.filter(function(t){return t.name===e.name}).length>0,n=!(null==o.config.selectedDeliveryAddress||!o.config.selectedDeliveryAddress.attributes)&&o.config.selectedDeliveryAddress.attributes.filter(function(t){return t.name===e.name}).length>0,r=EV.WM.referenceData.filter(function(t){if(t.attributes.includes(e.name))return t}),i=(r.map(function(e){return e.data.values}),[]);t?i=o.config.selectedBillingAddress.attributes.find(function(t){return t.name===e.name}):n&&(i=o.config.selectedDeliveryAddress.attributes.find(function(t){return t.name===e.name}));var a=!0;i.options&&i.options.forEach(function(r){if(r.value===e.value&&r&&r.linkedReferenceData){a=!1;var i=EV.WM.referenceData.find(function(e){return e.dataName===r.linkedReferenceData.name});i&&(t?o.config.selectedBillingAddress.attributes=o.config.selectedBillingAddress.attributes.map(function(e){return i.attributes.forEach(function(t){e.name===t&&(e.options=i.data.values)}),e}):n&&(o.config.selectedDeliveryAddress.attributes=o.config.selectedDeliveryAddress.attributes.map(function(e){return i.attributes.forEach(function(t){e.name===t&&(e.options=i.data.values)}),e})))}})}function m(e){e.isChecked?e.options.forEach(function(t){t.value===e.option&&(t.isChecked=!0)}):e.options.forEach(function(t){t.value===e.option&&(t.isChecked=!1)});var t=e.options.filter(function(e){return e.isChecked});return t}function v(e){return e.data.values=e.data.values.map(function(e){return e.caption||(e.caption=e.name,delete e.name),e}),e}function b(e,t,n,r){var i=this,a=angular.copy(EV.WM.referenceData),o=angular.copy(e);e.attributes=e.attributes.filter(function(e){return t.some(function(t){return t.linkedReferenceData.attributes.includes(e.name)})}),e.attributes.forEach(function(e){r.attributes=r.attributes.map(function(n){return n.name===e.name&&(n.options=[],t.forEach(function(e){a.forEach(function(t){e.linkedReferenceData.attributes.includes(n.name)&&e.linkedReferenceData.name===t.dataName&&t.data.values.forEach(function(e){return n.options.push(e)})})})),n})}),o.attributes.forEach(function(e){r.attributes=r.attributes.map(function(n){return n.name===e.name&&0==t.length&&(n.options=[],angular.copy(EV.WM.referenceData).forEach(function(t){var r=angular.copy(t);0==r.linkedFromList.length&&r.attributes.includes(e.name)&&(r=i.replaceNameWithCaption(r),r.data.values.forEach(function(e){return n.options.push(e)}))})),n})})}function y(e,t){var n=o.config.selectedBillingAddress.attributes.find(function(e){return e.name===t});if(n){var r=o.config.selectedBillingAddress.attributes.findIndex(function(e){return e.name===n.name}),i=v(e);o.config.selectedBillingAddress.attributes[r].options=i.data.values}}function E(e,t,n){var r=!(null==n.config.selectedBillingAddress||!n.config.selectedBillingAddress.attributes)&&n.config.selectedBillingAddress.attributes.filter(function(t){return t.name===e.name}).length>0,i=!(null==n.config.selectedDeliveryAddress||!n.config.selectedDeliveryAddress.attributes)&&n.config.selectedDeliveryAddress.attributes.filter(function(t){return t.name===e.name}).length>0;angular.copy(EV.WM.referenceData).forEach(function(e){var a=angular.copy(e);0==a.linkedFromList.length&&a.attributes.includes(t)&&(a=v(a),r?n.config.selectedBillingAddress.attributes=n.config.selectedBillingAddress.attributes.map(function(e){return e.name===t&&(e.options=a.data.values,e.value=null),e}):i&&(n.config.selectedDeliveryAddress.attributes=n.config.selectedDeliveryAddress.attributes.map(function(e){return e.name===t&&(e.options=a.data.values,e.value=null),e})))})}function w(){var e=angular.copy(EV.WM.referenceData),t={};return o.config.selectedBillingAddress.attributes.forEach(function(n){e.forEach(function(e){e.attributes.includes(n.name)&&!t[n.name]&&(t[n.name]=n)})}),t}function C(e){var t=angular.copy(o.referenceDataAttributeMap);S(e,t)}function S(e,t){Object.keys(t).forEach(function(e){o.config.selectedBillingAddress.attributes.forEach(function(n){if(n.name===e){var r=t[e].find(function(e){return 0==e.linkedFromList.length});r&&(r=v(r),n.options=r.data.values)}})})}function _(e){"false"!==o.existingAddressNonEditable?e.attributes.forEach(function(e){e.disabled=!0}):"false"==o.existingAddressNonEditable&&e.attributes.forEach(function(e){e.disabled=!1})}function u(){o.passMandatoryCheck=!0;var e=q(o.profileGroups,o.loggedIn),t=e.filter(function(e){return null!==e.value}).map(function(e){return{name:e.name,value:e.value}});if(o.mandatoryAttributes){for(var n=0,r=!1,i=0;i<Object.keys(o.mandatoryAttributes).length;i++){var a=Object.keys(o.mandatoryAttributes)[i];if(a.includes("*"))for(var s=0;s<t.length;s++){var l=t[s].name,c=t[s].value,d=a.split("*")[0],u=a.split("*")[1];l.startsWith(d)&&l.endsWith(u)&&c&&(n+=1)}else for(var p=0;p<t.length;p++){var f=t[p].name,g=t[p].value;f==a&&g&&(n+=1)}}Object.keys(o.mandatoryAttributes).length===n&&(r=!0),r||(o.passMandatoryCheck=!1)}}function P(){if(!o.verifyTaxCode)return Promise.resolve({verifyTaxCode:!1});var t=EV.util.getEVSession(),n=angular.copy(o.config.selectedBillingAddress),r={data:{billingAddressGroup:null==n?null:n.name,guid:t?t.guid:null}};return e.verifyTaxCode(r).then(function(e){var t=e.data.result.toUpperCase();if(t.startsWith("VALID")||t.startsWith("INFO_"))return o.taxIdValidationResult=!0,o.taxValidationResponse=e.data,Promise.resolve({isTaxIdValid:!0});if(t.startsWith("ERR_")){o.taxIdValidationResult=!1,o.taxValidationResponse=e.data;var n=s.open({templateUrl:"pm-v2/product-profile-fragments/customercare-tax-validation-reenter-continue.html",openedClass:"ev-modals modal-open",windowClass:"ev ev-open-modal-transactions",keyboard:!0,size:"lg",backdrop:!0,scope:o,controller:["$scope","$uibModalInstance",function(e,t){e.continueWithInvalidTaxId=!1,e.setContinueWithInvalidTaxId=function(n){e.continueWithInvalidTaxId=n;var r={continueWithInvalidTaxId:e.continueWithInvalidTaxId};t.close(r)},e.cancel=function(){var n={continueWithInvalidTaxId:e.continueWithInvalidTaxId};t.close(n)},e.confirm=function(){t.close()}}]});return n.result.then(function(e){return e},function(){return Promise.reject("Somthing goes wrong")})}})["catch"](function(e){throw e})}function A(n,i){t.removeError(o.errorWidgetGuid),o.config.deliveryAddressGroup=(o.config.selectedDeliveryAddress||{}).name,o.config.billingAddressGroup=(o.config.selectedBillingAddress||{}).name,o.config.useDeliveryAddress?o.config.billingAddressGroup=o.config.deliveryAddressGroup:o.config.useBillingAddress&&(o.config.deliveryAddressGroup=o.config.billingAddressGroup);var a=null;if(o.config.requiresDelivery){var s=o.config.useBillingAddress?o.config.selectedBillingAddress:o.config.selectedDeliveryAddress;if(s){var l=s.attributes.find(function(e){return e.name.endsWith(o.addressAttributesSuffix)});if(l)if(o.deliveryCountry)o.deliveryCountry.name!=l.value&&(a=EV.util.error("invalid_deliveryCountry","Invalid delivery country",400));else{var c=e.getExtraProperties()||{};if(c.deliveryCountry=l.value||null,c.regions){var d,u=!0,p=!1,f=void 0;try{for(var g,h=c.regions[Symbol.iterator]();!(u=(g=h.next()).done);u=!0){var m=g.value,v=m.countries.find(function(e){return e.name==l.value});if(v){d=m;break}}}catch(b){p=!0,f=b}finally{try{!u&&h["return"]&&h["return"]()}finally{if(p)throw f}}}d?(c.region=d,e.saveExtraProperties(c)):a=EV.util.error("invalid_deliveryCountry","Invalid delivery country",400)}}}if(M()&&!a){console.log("form is valid and no error");var y=q(o.profileGroups,o.loggedIn);o.submitting=!0;var E=y.filter(function(e){return null!==e.value}).map(function(e){return{name:e.name,value:e.value}}),w=o.selectedProducts[0].serviceName;e.saveProfile(k(E),w).then(function(e){return Promise.all([e,P()])}).then(function(t){var r=W(t,2),a=r[0],s=r[1];if(o.verifyTaxCode&&!s.continueWithInvalidTaxId&&!s.isTaxIdValid)return void i("INVALID_TAX_ID");if(Y(),a&&!EV.PM.skipLogin){var l=o.profileGroups.authDetails.attributes,c=E.find(function(e){return e.name==l[0].name}),d=E.find(function(e){return e.name==l[1].name});e.login(c,d,w,o.authSchemeName).then(function(){console.log("publish EV.Event.PM_REDIRECT_ORDER_SUMMARY 1"),EV.Event.publish(EV.Event.PM_REDIRECT_ORDER_SUMMARY,o.selectedProducts),n&&n()})}else console.log("publish EV.Event.PM_REDIRECT_ORDER_SUMMARY 2"),EV.Event.publish(EV.Event.PM_REDIRECT_ORDER_SUMMARY,o.selectedProducts),n&&n()})["catch"](function(e){e.error.code&&"ATTRIBUTE_VALIDATION_FAILED"===e.error.code&&B(e),t.handleError(o.errorWidgetGuid,e),EV.Event.publish(EV.Event.PM_ERROR,{code:"INVALID_FORM",attributes:y}),console.log("Publish Product profile error"),U(),i&&r("ev.widgets.errors.invalid_profile").then(function(e){i(e)})})["finally"](function(){return o.submitting=!1})}else console.log("FORM HAS ERROR!:::"),o.submitting=!1,a=a||EV.util.error("INVALID_FORM","Invalid profile",400),t.handleError(o.errorWidgetGuid,a),EV.Event.publish(EV.Event.PM_ERROR,{code:a.error.code,attributes:y}),U(),o.showMandatory=!0,i&&r("ev.widgets.errors.invalid_profile").then(function(e){i(e)});var C=/[_a-zA-Z0-9-']+([\+\.][_a-zA-Z0-9-']+)*@[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*\.(([0-9]{1,3})|([a-zA-Z]{2,20}))/;if(C.test(String(o.inputBeneficiary).toLowerCase())){var c=e.getExtraProperties()||{};c.beneficiary=o.inputBeneficiary||null,o.inputBeneficiaryMessage&&(c.beneficiaryMessage=o.inputBeneficiaryMessage),e.saveExtraProperties(c)}}function k(e){if(!EV.PM.validateGroup)return e;var t=o.config.billingAddressGroup,n=o.config.deliveryAddressGroup,r=[];for(var i in o.profileGroups){var a=o.profileGroups[i];if(Array.isArray(a))for(var s=0;s<a.length;s++){var l=a[s];if("address"!==l.category||l.name===t||l.name===n){var c=null===l.name||"undefined"==typeof l.name?"":l.name;r.push({groupName:c,categoryName:l.category})}}else if("object"===("undefined"==typeof a?"undefined":H(a))){var d=null===a.name||"undefined"==typeof a.name?"":a.name;r.push({groupName:d,categoryName:a.category})}}return{attributes:e,attributeGroupList:r}}function T(){e.isPropertyEnabled(Q).then(function(e){o.verifyTaxCode=e.data.isEnabled})}function $(){return"ev-widget.pm.productProfile-"+EV.util.random_guid()}function L(){function t(){if(null!=o.hiddenAttributes){var e=JSON.parse(c.hiddenAttributes.replace(/'/g,'"'));for(var t in e){var r=n(t);r&&(e[t]=r)}o.hiddenAttributes=JSON.stringify(e)}}function n(e){var t=new URLSearchParams(i.location.search);return t.has(e)?t.get(e):null}var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(e.getBasket()||{}).products;if(o.hiddenAttributes=c.hiddenAttributes,t(),o.isLoading=!0,r||(o.profileGroups=null,o.isLoading=!1),o.selectedProducts=r,o.selectedProducts&&o.selectedProducts.length>0){var s=e.getExtraProperties();o.deliveryCountry=null,s&&s.deliveryCountry&&(o.deliveryCountry=s.deliveryCountry),o.config.requiresDelivery=r[0].requiresDeliveryAddress,o.config.requiresBilling=r[0].requiresBillingAddress,e.getProfileGroups(r[0].serviceName).then(function(e){o.profileGroups=e,V(),e.authDetails.attributes[1]&&"NO_VALIDATOR"===e.authDetails.attributes[1].value&&(o.showAuthDetails=!0,e.authDetails.attributes[1].value=null),Z(),O(),K(),D(),N()})["finally"](function(){o.isLoading=!1,a(function(){EV.Event.publish(EV.Event.PM_PRODUCT_PROFILE_LOADED)},0)})}}function V(){for(var e=0;e<o.attrForInfoMsg.length;e++)for(var t=0;t<o.profileGroups.personalDetails.attributes.length;t++)if(o.profileGroups.personalDetails.attributes[t].name===o.attrForInfoMsg[e]){o.profileGroups.personalDetails.attributes[t].isWithInfoMsg=!0;break}}function D(){o.addressAttributes={};for(var e={},t=o.profileGroups.addresses,n=0;n<t.length;n++){for(var r=[],i=t[n].displayName,a=0;a<t[n].attributes.length;a++)r.push(t[n].attributes[a].value);e[i]=r.filter(Boolean).join(", ")}if(o.addressFilter&&"one"===o.addressLayout){if(document.getElementById("select_address_options"))for(var s=document.getElementById("select_address_options"),l=s.options,n=l.length;n>=1;n--)l[n]&&"undefined"===l[n].label&&l[n].remove();0==o.populatedAddresses.length&&o.newAddress("billing")}o.addressAttributes=e}function O(){var e=o.profileGroups.authDetails.attributes[1],t="ev.widgets.attr."+R(e.name)+".confirm.label",n="ev.widgets.attr."+R(e.name)+".confirm.placeholder";I([t,n]).then(function(r){var i={label:r[t]!==t?r[t]:"Confirm "+e.label,mandatory:e.mandatory,name:"confirm_"+e.name,placeholder:r[n]!==n?r[n]:e.placeholder,type:e.type,value:e.value};o.confirmValidatorAttribute=i})}function I(e){return r(e).then(function(e){return e},function(e){return null})}function N(){for(var e=0;e<o.profileGroups.otherDetails.length;e++)for(var t=0;t<o.profileGroups.otherDetails[e].attributes.length;t++)o.profileGroups.otherDetails[e].attributes[t].mandatory===!0&&o.profileGroups.otherDetails[e].attributes[t].value&&(o.profileGroups.otherDetails[e].attributes[t].value=null)}function R(e){return e.replace(/:/g,"").replace(/ \s*$/,"").replace(/ /g,"_").toLowerCase()}function M(){return G(),x()}function x(){function e(e){return e&&e.attributes.every(function(e){return!e.mandatory||e.value})}function t(e){return(""===e.attributes[1].value||""!==o.confirmValidatorAttribute.value)&&e.attributes[1].value===o.confirmValidatorAttribute.value}var n=o.profileGroups,r=o.config.requiresBilling,i=o.config.requiresDelivery,a=o.config.selectedBillingAddress,s=o.config.selectedDeliveryAddress,l=o.config.useDeliveryAddress,c=o.config.useBillingAddress;o.confirmValidatorAttribute.invalid=!o.loggedIn&&!t(n.authDetails);var d=!i||c||e(s),p=!r||l||e(a),f=o.loggedIn||e(n.authDetails)&&!o.confirmValidatorAttribute.invalid,g=e(n.personalDetails),h=n.otherDetails.every(function(t){return e(t)});return u(),o.passMandatoryCheck||F("Mandatory check not passed"),i&&!d&&F("delivery_address_required"),r&&!p&&F("billing_address_required"),o.loggedIn||!n||e(n.authDetails)?o.loggedIn||!n||o.loggedIn||t(n.authDetails)||F("validator_invalid",o.profileGroups.authDetails.attributes[1]):F("authentication_values_required",n.authDetails.attributes),n.personalDetails&&!g&&F("personal_details_required",n.personalDetails.attributes),o.loggedIn||!n.otherDetails||h?o.loggedIn&&n.otherDetails&&!h&&F("attributes_required",n.otherDetails[0].attributes):F("attributes_required",n.otherDetails.attributes),d&&p&&f&&g&&h&&o.passMandatoryCheck}function F(e,t){var n="ev.widgets.errors."+e,r="";if(t&&t.length>0)for(var i=0;i<t.length;i++)0===i&&t[i].mandatory?r+=t[i].label:i>0&&t[i].mandatory&&0===r.length?r+=t[i].label:i>0&&t[i].mandatory&&r.length>0&&(r+=", "+t[i].label);else t&&(r+=t.label);
o.formErrors.push({key:n,attributeList:r})}function U(){var e=new RegExp("\\{0\\}","gi");o.formErrors.forEach(function(t){r(t.key).then(function(n){n=n.replace(e,t.attributeList),o.translatedErrors.push(n),EV.Event.publish("product_profile_error",{error:n,showErrors:!0,widgetId:o.errorWidgetGuid})})})}function G(){o.formErrors=[],o.translatedErrors=[],EV.Event.publish("product_profile_error",{showErrors:!1})}function B(e){for(var t=0;t<e.error.args.length;t++)e.error.args[0]=j(e.error.args[t])}function j(e){var t;return o.profileGroups.authDetails.attributes.forEach(function(n){if(n.name===e)return void(t=n.label)}),o.profileGroups.personalDetails.attributes.forEach(function(n){if(n.name===e)return void(t=n.label)}),o.profileGroups.addresses.forEach(function(n){n.attributes.forEach(function(n){if(n.name===e)return void(t=n.label)})}),o.profileGroups.otherDetails.attributes.forEach(function(n){if(n.name===e)return void(t=n.label)}),t}function q(e,t){function n(e){return o.config.deliveryAddressGroup==e.name||o.config.billingAddressGroup==e.name}function r(e){return"address"==e.category}function i(e){return"authDetails"==e.category}return Object.keys(e).reduce(function(t,a){function o(e,t){return(i(e)||r(e)&&!n(e))&&!i(e)||(t=t.concat(e.attributes)),t}var s=e[a];return Array.isArray(s)?s.forEach(function(e){return t=o(e,t)}):t=o(s,t),t},[])}function Y(){var t=e.getBasket();t.deliveryAddressGroup=o.config.deliveryAddressGroup,t.billingAddressGroup=o.config.billingAddressGroup,e.saveBasket(t)}function z(e){o.populatedAddresses=e.addresses.filter(function(e){return e.attributes.some(function(e){return e.value})})}function K(){function t(){if(!o.config.selectedDeliveryAddress||!o.config.selectedBillingAddress){var t=e.getBasket();o.populatedAddresses.length>0&&o.config.requiresBilling&&!o.config.selectedBillingAddress&&t.billingAddressGroup&&angular.forEach(o.populatedAddresses,function(e){t.billingAddressGroup===e.name&&(o.config.selectedBillingAddress=e)}),o.populatedAddresses.length>0&&o.config.requiresDelivery&&!o.config.selectedDeliveryAddress&&t.deliveryAddressGroup&&angular.forEach(o.populatedAddresses,function(e){t.deliveryAddressGroup===e.name&&(o.config.selectedDeliveryAddress=e)})}var r=o.config.selectedDeliveryAddress,i=o.config.selectedBillingAddress,a=o.populatedAddresses;r&&n(r)?(o.config.selectedDeliveryAddress=a.find(function(e){return e.name==r.name}),_(o.config.selectedDeliveryAddress)):o.config.selectedDeliveryAddress=null,i&&n(i)?(o.config.selectedBillingAddress=a.find(function(e){return e.name==i.name}),_(o.config.selectedBillingAddress)):o.config.selectedBillingAddress=null}function n(e){return e.attributes.some(function(e){return e.value})}var r=e.getExtraProperties();if(r||(r={}),o.loggedIn)z(o.profileGroups),t();else{var i=o.config.requiresDelivery||o.showDelivery,a=o.config.requiresBilling||o.showBilling;i&&a?(o.config.selectedDeliveryAddress=o.profileGroups.addresses[0],o.config.selectedBillingAddress=o.profileGroups.addresses[1],o.config.selectedDeliveryAddress&&(r.deliveryGroup={groupName:o.config.selectedDeliveryAddress.name,attributes:o.config.selectedDeliveryAddress.attributes}),o.config.selectedBillingAddress&&(r.billingGroup={groupName:o.config.selectedBillingAddress.name,attributes:o.config.selectedBillingAddress.attributes}),e.saveExtraProperties(r)):i?(o.config.selectedDeliveryAddress=o.profileGroups.addresses[0],o.config.selectedDeliveryAddress&&(r.deliveryGroup={groupName:o.config.selectedDeliveryAddress.name,attributes:o.config.selectedDeliveryAddress.attributes},e.saveExtraProperties(r))):a&&(o.config.selectedBillingAddress=o.profileGroups.addresses[0],o.config.selectedBillingAddress&&(r.billingGroup={groupName:o.config.selectedBillingAddress.name,attributes:o.config.selectedBillingAddress.attributes},e.saveExtraProperties(r)))}}function Z(){o.loggedIn&&!o.showAuthDetails||Object.keys(o.profileGroups).forEach(function(e){if("authDetails"!==e){var t=o.profileGroups[e];t instanceof Array?t.forEach(function(t){null!=o.profileGroups[e]&&(o.profileGroups[e].attributes=J(t.attributes||[]))}):null!=o.profileGroups[e]&&(o.profileGroups[e].attributes=J(t&&t.attributes||[]))}})}function J(e){var t=[];return e.forEach(function(e){o.profileGroups.authDetails.attributes.find(function(t){return t.name===e.name})||t.push(e)}),t}o.isLoading=!0,o.isLoginRequest=!1,o.showBeneficaryAddition=!1;var X=e.getBasket();o.isProductSelected=X&&X.products,e.saveBasket(X),o.formErrors=[],o.translatedErrors=[],o.widgetGuid=c.id||$(),o.errorWidgetGuid="error-"+o.widgetGuid,o.widgetTitle=c.title||"PROFILE DETAILS",l.attr("title",""),o.showHeader="false"!==c.showHeader,o.showErrorMsgs="false"!==c.showErrorMsgs,o.showLabels="false"!==c.showLabels,o.useBillingOption="true"===c.useBillingOption,o.showDelivery="true"===c.showDelivery,o.showBilling="true"===c.showBilling,o.sortCountry="false"!==c.sortCountry,o.includeLogin="true"===c.includeLogin,o.showSocial="true"===c.showSocial,o.socialStyle=c.socialStyle||"text",o.autoRegister=c.autoRegister,o.autoPopulate=c.autoPopulate,o.nonEditable=c.nonEditable?JSON.parse(c.nonEditable.replace(/'/g,'"')):[],o.forgotPasswordService=c.forgotPasswordService||EV.settings.getEVService(),o.showDescription="true"===c.showDescription,o.hideShowValidator="true"===c.hideShowValidator,o.attrForInfoMsg=c.attrForInfoMsg?JSON.parse(c.attrForInfoMsg.replace(/'/g,'"')):[],o.appendHoursToBDate="true"===c.appendHoursToBDate,o.addressAttributesSuffix=c.addressAttributesSuffix||"_country",o.addressLayout=c.addressLayout||"one",o.existingAddressNonEditable="false"!==c.existingAddressNonEditable,o.addressFilter=c.addressFilter?JSON.parse(c.addressFilter.replace(/'/g,'"')):null,o.mandatoryAttributes=c.mandatoryAttributes?JSON.parse(c.mandatoryAttributes.replace(/'/g,'"')):null,o.uncheckedCheckboxReturnFalse="true"===c.uncheckedCheckboxReturnFalse,o.firstAddressTemplate="pm-v2/product-profile-fragments/"+(o.useBillingOption?"billing":"delivery")+"-address.html",o.secondAddressTemplate="pm-v2/product-profile-fragments/"+(o.useBillingOption?"delivery":"billing")+"-address.html",o.passMandatoryCheck=!0,o.loggedIn=EV.util.Storage.cookie.get("ev_ss"),o.config={},o.authSchemeName=c.authSchemeName||"default",o.skipEvValidationFields="true"===c.skipEvValidationFields,o.productSelectedName=null,o.checkboxes={},o.taxValidationResponse={},o.taxIdValidationResult=!0,o.verifyTaxCode=!1,o.countriesJson=[],o.taxProperties={},o.referenceDataMap={},o.referenceDataAttributeMap={},o.passMandatoryCheck=!0,"undefined"!=typeof c.showGoogleOneTap&&(o.showGoogleOneTap="string"==typeof c.showGoogleOneTap?"true"===c.showGoogleOneTap:c.showGoogleOneTap),o.googleBtnConf=c.googleBtnConf,o.googleGenericConf=c.googleGenericConf,o.showMandatory="true"===c.showMandatory;var Q="tax_checker";if(EV.Event.on("ev.finished.initing.reference.data",function(e){L(),T()}),EV.Event.on(EV.Event.PM_REDIRECT_PRODUCT_PROFILE,function(e){o.productSelectedName&&o.productSelectedName===e[0].name||(o.isProductSelected=!0,o.productSelectedName=e[0].name,L())}),EV.Event.on(EV.Event.PROFILE_ATTRIBUTE_CHANGED,function(e){var t=e.attribute;e.field;if(!e||"text"!==e.type){if(o.config&&o.config.selectedBillingAddress&&o.config.selectedBillingAddress.attributes&&!t&&e.value){p(angular.copy(EV.WM.referenceData)),f(angular.copy(EV.WM.referenceData));var n=w();Object.keys(n).forEach(function(e){var t=n[e];C(t)}),Object.keys(n).forEach(function(e){var t=o.referenceDataAttributeMap[e].map(function(t){var r=n[e].value,i=t.data.values.find(function(e){return e.value===r})?t.data.values.find(function(e){return e.value===r}).linkedReferenceData:null;return i}).filter(function(e){return e});t&&t.forEach(function(e){e?e.attributes.forEach(function(t){var n=o.referenceDataAttributeMap[t].find(function(t){return t.dataName===e.name});y(n,t)}):Object.keys(o.referenceDataAttributeMap).forEach(function(e){var t=o.referenceDataAttributeMap[e].find(function(e){return 0==e.linkedFromList.length});y(t,e)})})})}if(o.config&&o.config.selectedBillingAddress&&o.config.selectedBillingAddress.attributes&&EV.Event.publish("ev.widget.product.profile.address.config",o.config),t&&"dropdown"===t.type&&(g(t),h(t)),t&&"checkbox"===t.type){var r=null,i=!(null==o.config.selectedBillingAddress||!o.config.selectedBillingAddress.attributes)&&o.config.selectedBillingAddress.attributes.filter(function(e){return e.name===t.name}).length>0,a=!(null==o.config.selectedDeliveryAddress||!o.config.selectedDeliveryAddress.attributes)&&o.config.selectedDeliveryAddress.attributes.filter(function(e){return e.name===t.name}).length>0;if(i){var s=m(t),l=angular.copy(o.config.selectedBillingAddress);r=l.attributes.findIndex(function(e){return e.name===t.name}),l.attributes=l.attributes.slice(r+1),b(l,s,o,o.config.selectedBillingAddress)}else if(a){var c=m(t),d=angular.copy(o.config.selectedDeliveryAddress);r=d.attributes.findIndex(function(e){return e.name===t.name}),d.attributes=d.attributes.slice(r+1),b(d,c,o,o.config.selectedDeliveryAddress)}}}}),o.changeSelectedDeliveryAddress=function(t){var n=document.querySelector(".product-profile-form .select-address .selectedDeliveryAddressContainer select"),r=document.querySelector(".product-profile-form .select-address .selectedDeliveryAddressContainer");1==t||0==t?r.dataset.content=n.options[t+1].text:r.dataset.content=n.options[n.selectedIndex].text,_(o.config.selectedDeliveryAddress);var i=e.getExtraProperties();i.deliveryGroup=o.config.selectedDeliveryAddress,e.saveExtraProperties(i)},EV.Event.on(EV.Event.PM_ORDER_TYPE_ACTION,function(t){if("GIFT"==t.orderType){var n=e.getBasket();null!=n&&n.products.length>0&&"PHYSICAL"!==n.products[0].productType.toUpperCase()?o.showBeneficaryAddition=!0:o.showBeneficaryAddition=!1}else o.showBeneficaryAddition=!1}),o.addressFilter||EV.Event.on("ev.finished.initing.reference.data",function(t){EV.Event.on(EV.Event.PM_PRODUCT_PROFILE_LOADED,function(t){if(!o.addressFilter){if(o.loggedIn&&"two"==o.addressLayout){if(o.populatedAddresses.length>0&&o.config.requiresBilling&&null===o.config.selectedBillingAddress){var n=e.getBasket();n.billingAddressGroup?angular.forEach(o.populatedAddresses,function(e){n.billingAddressGroup===e.name&&(o.config.selectedBillingAddress=e)}):o.populatedAddresses&&o.populatedAddresses[1]?(o.config.selectedBillingAddress=o.populatedAddresses[1],o.changeSelectedBillingAddress(o.populatedAddresses.indexOf(o.populatedAddresses[1]))):o.populatedAddresses&&(o.config.selectedBillingAddress=o.populatedAddresses[0],o.changeSelectedBillingAddress(o.populatedAddresses.indexOf(o.populatedAddresses[0])))}if(0==o.populatedAddresses.length&&o.config.requiresBilling&&o.newAddress("billing"),o.populatedAddresses.length>0&&o.config.requiresDelivery&&null===o.config.selectedDeliveryAddress){var r=e.getBasket();r.deliveryAddressGroup?angular.forEach(o.populatedAddresses,function(e){r.deliveryAddressGroup===e.name&&(o.config.selectedDeliveryAddress=e)}):o.populatedAddresses&&o.populatedAddresses[1]?(o.config.selectedDeliveryAddress=o.populatedAddresses[1],o.changeSelectedDeliveryAddress(o.populatedAddresses.indexOf(o.populatedAddresses[1]))):o.populatedAddresses&&(o.config.selectedDeliveryAddress=o.populatedAddresses[0],o.changeSelectedDeliveryAddress(o.populatedAddresses.indexOf(o.populatedAddresses[0])))}0==o.populatedAddresses.length&&o.config.requiresDelivery&&o.newAddress("delivery")}var i=e.getBasket();o.config.selectedDeliveryAddress&&(i.deliveryAddressGroup=o.config.selectedDeliveryAddress.name),o.config.selectedBillingAddress&&(i.billingAddressGroup=o.config.selectedBillingAddress.name),e.saveBasket(i)}})}),o.addressFilter){var ee=Object.keys(o.addressFilter),te=Object.values(o.addressFilter);EV.Event.on("ev.finished.initing.reference.data",function(t){EV.Event.on(EV.Event.PM_PRODUCT_PROFILE_LOADED,function(t){if(o.addressFilter){o.populatedAddressesCopy||(o.populatedAddressesCopy=angular.copy(o.populatedAddresses)),o.populatedAddresses=o.populatedAddressesCopy;var n=[];o.populatedAddresses&&o.populatedAddresses.length>0&&o.config.requiresBilling&&(o.populatedAddresses.forEach(function(e){ee.forEach(function(t){if(t.includes("*")){t=t.replace("*",e.name.slice(-1));var r=e.attributes.find(function(e){return e.name===t});te.forEach(function(t){if(t.includes(r.value)){if(o.loggedIn&&"two"===o.addressLayout)return o.config.selectedBillingAddress=e;if(o.loggedIn&&"one"===o.addressLayout){var i=o.populatedAddresses.filter(function(t){return t.name===e.name});return n.push(i[0]),n}}})}})}),o.loggedIn&&"one"===o.addressLayout&&n&&(o.populatedAddresses=n,D()),o.config.selectedBillingAddress||o.newAddress("billing")),!o.config.selectedBillingAddress&&0==o.populatedAddresses.length&&o.config.requiresBilling&&o.newAddress("billing"),o.populatedAddresses&&o.populatedAddresses.length>0&&o.config.requiresDelivery&&(o.populatedAddresses.forEach(function(e){ee.forEach(function(t){if(t.includes("*")){t=t.replace("*",e.name.slice(-1));var r=e.attributes.find(function(e){return e.name===t});te.forEach(function(t){if(t.includes(r.value)){if(o.loggedIn&&"two"===o.addressLayout)return o.config.selectedDeliveryAddress=e,o.config.selectedDeliveryAddress;if(o.loggedIn&&"one"===o.addressLayout){var i=o.populatedAddresses.filter(function(t){return t.name===e.name});return n.push(i[0]),n}}})}})}),o.loggedIn&&"one"===o.addressLayout&&n&&(o.populatedAddresses=n,D()),o.config.selectedDeliveryAddress||o.newAddress("delivery")),!o.config.selectedDeliveryAddress&&0==o.populatedAddresses.length&&o.config.requiresDelivery&&o.newAddress("delivery");var r=e.getBasket();o.config.selectedDeliveryAddress&&(r.deliveryAddressGroup=o.config.selectedDeliveryAddress.name),o.config.selectedBillingAddress&&(r.billingAddressGroup=o.config.selectedBillingAddress.name),e.saveBasket(r)}})})}o.changeSelectedBillingAddress=function(t){_(o.config.selectedBillingAddress);var n=document.querySelector(".product-profile-form .select-address .selectedBillingAddressContainer select"),r=document.querySelector(".product-profile-form .select-address .selectedBillingAddressContainer");1==t||0==t?r.dataset.content=n.options[t+1].text:r.dataset.content=n.options[n.selectedIndex].text;var i=e.getBasket();o.config.selectedDeliveryAddress&&(i.deliveryAddressGroup=o.config.selectedDeliveryAddress.name),o.config.selectedBillingAddress&&(i.billingAddressGroup=o.config.selectedBillingAddress.name),e.saveBasket(i)},o.newAddress=function(t){if("delivery"==t){var n=e.getExtraProperties();n||(n={}),o.config.selectedDeliveryAddress=o.getNewAddress(t),n.deliveryGroup={groupName:o.config.selectedDeliveryAddress.name,attributes:o.config.selectedDeliveryAddress.attributes},e.saveExtraProperties(n)}else o.config.selectedBillingAddress=o.getNewAddress(t)},o.getNewAddress=function(e){if(o.profileGroups&&o.profileGroups.addresses)if("delivery"==e){if(o.config.requiresDelivery&&!o.config.selectedDeliveryAddress)for(var t=0;t<o.profileGroups.addresses.length;t++)for(var n=o.profileGroups.addresses[t],r=0;r<n.attributes.length;r++)for(var i=n.attributes[r],a=0;a<o.populatedAddresses.length;a++){var s=o.populatedAddresses[a];if(n.name!==s.name&&i.mandatory===!0&&null===i.value)return n}else if(o.populatedAddresses&&0==o.populatedAddresses.length)return o.profileGroups.addresses.find(function(e){return(!o.populatedAddresses||o.populatedAddresses.indexOf(e)==-1)&&o.config.selectedDeliveryAddress!==e});if(o.config.requiresDelivery&&o.config.selectedDeliveryAddress&&o.populatedAddresses&&o.populatedAddresses.length>0){var l=o.populatedAddresses.map(function(e){return e.name}),c=o.profileGroups.addresses.filter(function(e){return!l.includes(e.name)});return c[0]}}else{if(o.config.requiresBilling&&!o.config.selectedBillingAddress)if(o.populatedAddresses&&o.populatedAddresses.length>0)for(var d=0;d<o.profileGroups.addresses.length;d++)for(var u=o.profileGroups.addresses[d],p=0;p<u.attributes.length;p++)for(var f=u.attributes[p],g=0;g<o.populatedAddresses.length;g++){var h=o.populatedAddresses[g];if(u.name!==h.name&&f.mandatory===!0&&null===f.value)return u}else if(o.populatedAddresses&&0==o.populatedAddresses.length)return o.profileGroups.addresses.find(function(e){return(!o.populatedAddresses||o.populatedAddresses.indexOf(e)==-1)&&o.config.selectedBillingAddress!==e});if(o.config.requiresBilling&&o.config.selectedBillingAddress&&o.populatedAddresses&&o.populatedAddresses.length>0){var m=o.populatedAddresses.map(function(e){return e.name}),v=o.profileGroups.addresses.filter(function(e){return!m.includes(e.name)});return v[0]}}},o.allAddressesUsed=function(){if(o.populatedAddresses&&o.profileGroups.addresses)return o.populatedAddresses.length===o.profileGroups.addresses.length},o.getSocialNetworkAction=function(){return o.isLoginRequest?"login":"register"},o.submit=function(t,n){console.log("scope.submit(): ev-product-profile",o),e.isCheckoutButtonLoaded()&&!t||A(t,n)},o.changeIsLoginRequest=function(){o.isLoginRequest=!o.isLoginRequest},o.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_PROFILE,function(e,t){o.submit(t.successCb,t.errorCb)}),EV.Event.on(EV.Event.SOCIAL_REGISTER_SUCCESS,function(e,t){o.loggedIn=!0,L()}),EV.Event.on(EV.Event.SOCIAL_LOGIN_SUCCESS,function(e,t){o.loggedIn=!0,o.isLoginRequest=!1,L()}),EV.Event.on(EV.Event.LOGIN_SUCCESS,function(){o.loggedIn=!0,L()}),EV.Event.on(EV.Event.LOGOUT_ACTION,function(){o.loggedIn=!1,L()}),EV.Event.on(EV.Event.PM_PRODUCTS_SELECTED,function(e){o.productSelectedName&&o.productSelectedName===e[0].name||(o.isProductSelected=!0,o.productSelectedName=e[0].name,L())}),EV.Event.on(EV.Event.PM_CLEARED_BASKET,function(){o.isProductSelected=!1,o.productSelectedName=null,L()}),EV.Event.on(EV.Event.LOGIN_CANCELLED,function(){o.isLoginRequest=!1}),EV.Event.on(EV.Event.LOGIN_SUCCESS,function(){o.isLoginRequest=!1}),EV.Event.on(EV.Event.PM_PURCHASES_LIST_EDITED_ADDRESS_SUCCESS,function(e){console.log("response from event:",e)}),EV.Event.on("pm.verifyTaxCode",function(e){var t=e.successCb,n=e.errorCb;A(t,n)})}}}])}function E(){"use strict";var e=angular.module("ev-widget.pm.productPromo",[]);e.config(["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}]),e.directive("evProductPromo",["pm2Util","$location",function(e,t){return{restrict:"E",scope:{promoId:"=",productId:"="},templateUrl:"pm-v2/ev-product-promo.tpl.html",controller:["$scope",function(e){e.promoCode=""}],link:function(n,r,i,a){function o(){return"ev-widget.pm.productPromo-"+EV.util.random_guid()}function s(t){if(""!==t.product)return e.ifPromoCodeExistsInProduct(t.product).then(function(e){e.productHasPromoCode===!0?n.isPromoWidgetVisible=!0:n.enablePromoDefinePlan||(n.isPromoWidgetVisible=!1)})["catch"](function(e){console.log(e)})}function l(e){n.product=e.product,n.paymentPlan=e.paymentPlan,n.isSubscription=e.isSubscription,n.isSelected=e.selected,n.selectedCountry=e.selectedDeliveryAddress}function c(){var t=n.product,r=n.inputPromoCode;if(1!=u(r))return e.getPaymentPlansWithPromoCode(t,r).then(function(e){n.initLoadPromo=!1,1===e.length?(EV.Event.publish(EV.Event.PM_PROMO_ACTION,{paymentPlan:e[0],productSelected:n.product,isSubscribed:!0}),n.selectedPromoPlan=e[0].id):EV.Event.publish("pm.promoPlansAction",{paymentPlans:e,promoProduct:t}),g()})["catch"](function(e){if(e.error&&("product_not_found"===e.error.code||"BEX0057"===e.error.code))return void d();if(n.failureMessage="ev.widgets.promo_code.failure",f(),console.log(e),n.initLoadPromo){n.initLoadPromo=!1;var t=n.inputPromoCode===n.promoCode?n.queryPromoCode:n.promoCode;if(!t)return;n.inputPromoCode=t,c()}})}function d(){return e.getPaymentPlanAndProductByPromoCode(n.inputPromoCode).then(function(e){return n.initLoadPromo=!1,e.paymentPlan&&e.product?(EV.Event.publish(EV.Event.PM_PROMO_ACTION,{paymentPlan:e.paymentPlan,productSelected:e.product,isSubscribed:!0,isBundlePurchaseFromPromoCode:!0}),n.selectedPromoPlan=e.paymentPlan.id,void g()):void console.error("Something has gone wrong and there's not Payment Plan and/or Product found with the current Promo Code: ",n.inputPromoCode)})["catch"](function(e){if(n.failureMessage="ev.widgets.promo_code.failure",f(),console.log(e),n.initLoadPromo){n.initLoadPromo=!1;var t=n.inputPromoCode===n.promoCode?n.queryPromoCode:n.promoCode;if(!t)return;n.inputPromoCode=t,n.triedPromoDefinePlan=!1,c()}})}function u(e){n.failureMessage="";var t=/^[a-zA-Z0-9_.-]*$/;return void 0==e?(n.initLoadPromo=!1,!0):""==e||0==e.length?(n.failureMessage="ev.widgets.promo_code.empty",f(),!0):!t.test(e)&&(n.failureMessage="ev.widgets.promo_code.validInput",f(),!0)}function p(){n.isPromoCodeSuccess=!1,n.isPromoCodeFailed=!1,n.selectedPromoPlan=""}function f(){n.isPromoCodeSuccess=!1,n.isPromoCodeFailed=!0}function g(){n.isPromoCodeSuccess=!0,n.isPromoCodeFailed=!1}n.isLoading=!0,n.isLoginRequest=!1,n.formErrors=[],n.translatedErrors=[],n.widgetGuid=i.id||o(),n.errorWidgetGuid="error-"+n.widgetGuid,n.widgetTitle=i.title||"PROMO CODE",r.attr("title",""),n.showHeader="false"!==i.showHeader,n.showErrorMsgs="false"!==i.showErrorMsgs,n.showLabels="false"!==i.showLabels,n.showDelivery="true"===i.showDelivery,n.showHidden="true"===i.showHidden,n.inputPromoCode="",n.paymentPlan="",n.isSubscription=!1,n.isSelected=!1,n.product="",n.selectedPromoPlan="",n.queryParams=t.search(),n.initLoadPromo=!0,n.promoCode=i.promoCode,n.enablePromoDefinePlan="true"===i.enablePromoDefinePlan,n.isPromoWidgetVisible=n.enablePromoDefinePlan,n.queryPromoCode=n.queryParams.promoCode||EV.Widgets.Product&&EV.Widgets.Product.promoCode,EV.Event.on(EV.Event.PM_PRODUCT_ACTION,function(e){1==e.selected||n.selectedPromoPlan?(s(e),l(e),p()):(l(e),n.isPromoWidgetVisible=!1)}),EV.Event.on(EV.Event.PM_PRODUCTS_LOADED,function(e){(n.promoCode||n.queryPromoCode)&&1===e.length&&(n.product=e[0].name,n.inputPromoCode=n.queryPromoCode||n.promoCode,c())}),n.promoCodeSubmit=c,EV.Event.on(EV.Event.PM_RESET_PROMO,function(e){(e.paymentPlan.id===n.selectedPromoPlan||n.selectedPromoPlan)&&(p(),EV.Event.publish(EV.Event.PM_PRODUCT_ACTION,{product:e.name,selected:!1})),n.isPromoWidgetVisible=!1})}}}])}function w(){"use strict";var e=angular.module("ev-widget.pm.productSelection",[]);e.config(["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}]),e.directive("evProductSelection",["pm2Util","EVExceptionHandler","$timeout","$window","$q",function(e,t,n,r,i){function a(e,t,n,r,i){EV.Event.publish(EV.Event.PM_PRODUCT_ACTION,{product:e,productGiftEnabled:t,paymentPlan:n,isSubscription:r,selected:i})}return{restrict:"E",scope:{},templateUrl:"pm-v2/ev-product-selection-v3.tpl.html",controller:["$scope","$location","$attrs",function(t,r,i){function o(e){if(t.queryParams&&t.queryParams.paymentPlans){var n=t.queryParams.paymentPlans.split(",");return e.filter(function(e){for(var t=0;t<n.length;t++)if(n[t]===e.name)return!0;return!1})}return e}function s(e){for(var n=0,r=t.productList,i=t.productList.length,a=0;a<i;a++){if(r[a].name==e)return n;n+=1}return n}function l(e){for(var t=0;t<e.paymentPlans.length;t++)if(e.paymentPlans[t].id===e.autoSelectPlan){c={autoSelectPlanName:e.paymentPlans[t].name,productName:e.name};break}}t.queryParams=r.search(),t.selectedOrderTypeOption=null,t.itemId=t.queryParams.itemId||i.itemId,t.pRenewal=t.queryParams.pRenewal;var c;EV.Event.on(EV.Event.PM_SELECT_PAYMENT_PLAN,function(e){if("string"!=typeof e&&e.productName){var n=s(e.productName);t.changeStatus(n,e.paymentPlanName),t.productSubmitAction(t.productList[n],t.orderType,t.orderTypeOption)}else t.changeStatus(0,e),t.productSubmitAction(t.productList[0],t.orderType,t.orderTypeOption)}),EV.Event.on(EV.Event.PM_PRODUCT_ACTION,function(e){null!=t.selectedOrderTypeOption&&e.product!=t.selectedOrderTypeOption&&(t.selectedOrderTypeOption=null)}),EV.Event.on("pm.promoPlansAction",function(r){var i=void 0,a=[],l=s(r.promoProduct);t.finalProductSelection||t.changeStatus(l,t.selections[l]),t.finalProductSelection&&(i=e.getBasket()),e.removeBasket(e.getBasket());var c=r.paymentPlans.map(function(e){return e.promoPlanFromServer=!0,t.hideHiddenPromoPlans||(e.hidden=!1),e});if(c=o(c),t.productList[l].paymentPlans=t.productList[l].paymentPlans.filter(function(e){for(var t=0;t<r.paymentPlans.length;t++)if(r.paymentPlans[t].id===e.id)return!1;return!e.promoPlanFromServer}).concat(c),i){var d=t.productSelected.paymentPlans.map(function(e){return e.id}).indexOf(t.productSelected.paymentPlan.id);t.productSelected.paymentPlan=t.productSelected.paymentPlans[d],i.products=i.products.map(function(e){return[t.productSelected].find(function(t){return t.id===e.id})||e}),e.saveBasket(i),a.push(t.productSelected),EV.Event.publish(EV.Event.PM_PRODUCTS_SELECTED,a),t.isUseTogglePlan&&EV.Event.publish(EV.Event.PM_TOGGLE_PLAN_PRODUCT_SELECTED,a)}n(function(){EV.Event.publish(EV.Event.PM_PROMO_PLANS_LOADED,t.productList[l].paymentPlans)},0)}),EV.Event.on(EV.Event.PM_PRODUCTS_SELECTED,function(e){t.finalProductSelection=!0}),EV.Event.on(EV.Event.PM_RESET_PROMO,function(e){t.finalProductSelection=!1}),t.setProduct=function(n,r,i){t.autoSelect&&(l(t.productList[n]),c&&c.autoSelectPlanName&&(r=c.autoSelectPlanName)),t.displayOnly?t.selections[n]===r?(t.changeStatus(n,r,i),e.removeBasket(e.getBasket())):(t.changeStatus(n,r,i),t.productSubmitAction(t.productList[n],t.orderType,t.orderTypeOption)):t.changeStatus(n,r,i)},t.changeStatus=function(e,n,r){return t.selections[e]==n?(t.selections[e]=null,t.productSelected=null,void a(t.productList[e].name,t.productList[e].giftEnabled,n,r,!1)):(t.multiSelect||(t.selections=[]),t.selections[e]=n,t.productSelected=t.productList[e],void a(t.productList[e].name,t.productList[e].giftEnabled,n,r,!0))},t.isSelected=function(e,n,r){if(r.paymentPlan&&r.linkedPlanMapping&&r.linkedPlanMapping.length>0)for(var i=0;i<r.paymentPlans.length;i++)if(n===r.paymentPlans[i].name&&!r.paymentPlans[i].hidden)for(var a=0;a<r.linkedPlanMapping.length;a++)if((n===r.linkedPlanMapping[a].paymentPlanName||n===r.linkedPlanMapping[a].linkedPlanName)&&t.productSelected&&r.name===t.productSelected.name&&(r.paymentPlan.name===r.linkedPlanMapping[a].paymentPlanName||r.paymentPlan.name===r.linkedPlanMapping[a].linkedPlanName))return!0;return t.selections[e]==n},t.isRecommended=function(e){return e==t.recommendedProduct},t.selectOrderTypeOption=function(n,r){t.selectedOrderTypeOption==n?t.selectedOrderTypeOption=null:t.selectedOrderTypeOption=n;var i={orderTypeSelected:null!=t.selectedOrderTypeOption};i.orderTypeSelected&&(i.orderType=r),EV.Event.publish(EV.Event.PM_ORDER_TYPE_ACTION,i);var a=e.getBasket();null==a&&(a={}),a.orderType=null===t.selectedOrderTypeOption?"STANDARD":r,e.saveBasket(a)},t.isOrderTypeSelected=function(e){return null!=t.selectedOrderTypeOption&&t.selectedOrderTypeOption==e},t.productSubmitAction=function(n,r,i){console.log("productSubmitAction");var a=[];if(t.selections.forEach(function(e,n){if(e){var r=t.productList[n];r.paymentPlan=r.paymentPlans.find(function(t){return t.name==e}),a.push(r)}}),Object.keys(a).length){var o={products:a};i&&(o.orderType=null!=t.selectedOrderTypeOption&&null!=r?r:"STANDARD"),t.utmCampaign&&(o.utmCampaign=t.utmCampaign),t.itemId&&(o.itemId=t.itemId.split(",")),t.pRenewal&&(o.pRenewal=t.pRenewal),o.expire=(new Date).getTime()+36e5,e.saveBasket(o);var s=e.getExtraProperties()||{};if(a[0].paymentPlan){var l=a[0].paymentPlan.restrictBillingAddress;s.restrictBillingAddress=l,l&&(s.regions=a[0].paymentPlan.regions),e.saveExtraProperties(s)}if(a[0].requiresDeliveryAddress){if(s.deliveryCountry=t.selectedCountry||null,!s.deliveryCountry){var c=a[0].paymentPlan.regions;c&&c.length>0&&(s.regions=c)}s.region=t.region||null,e.saveExtraProperties(s)}t.isUseTogglePlan?EV.Event.publish(EV.Event.PM_TOGGLE_PLAN_PRODUCT_SELECTED,a):EV.Event.publish(EV.Event.PM_PRODUCTS_SELECTED,a),EV.Event.publish("pm.adapterTogglePaymentMethods",a)}else EV.Event.publish(EV.Event.PM_ERROR,{code:"NO_PRODUCT_SELECTED"}),e.removeBasket(e.getBasket())},t.isHiddenToDisplay=function(e,n){if(t.showHidden){if(1===e.paymentPlans.length)return!0;if(e.linkedPlanMapping.length>0){for(var r=0;r<e.linkedPlanMapping.length;r++){if(n.id===e.linkedPlanMapping[r].paymentPlanId)return!0;if(n.id===e.linkedPlanMapping[r].linkedPlanId)return!1}return!0}return!0}return!n.hidden}}],link:function(a,o,s,l){function c(){var e=!1;i.all([E()]).then(function(){if(a.showDeliveryCountry&&!a.selectedCountry){e=!0;var n=EV.util.error("INVALID_COUNTRY","Invalid delivery country",400);EV.Event.publish(EV.Event.PM_ERROR,n),t.handleError(a.errorWidgetGuid,n)}})["catch"](function(n){e=!0,console.error(n),EV.Event.publish(EV.Event.PM_ERROR,n),t.handleError(a.errorWidgetGuid,n)})["finally"](function(){a.isLoading=!1,e||d()})}function d(){if(a.productName||a.groupName){var e=a.productName?v:y,n=!0;!s.productName&&a.productName&&s.groupName?v().then(function(){t.removeError(a.errorWidgetGuid)})["catch"](function(e){e.error&&("BEX0018"===e.error.code||"product_not_found"===e.error.code||"product_invalid"===e.error.code)&&n?(n=!1,u(e,y).then(function(){},function(e){a.productList=null,console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(a.errorWidgetGuid,e)})):(a.productList=null,console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(a.errorWidgetGuid,e))})["finally"](function(){a.isLoading=!1}):s.productName&&a.productName!==s.productName||s.paymentPlans&&D!==s.paymentPlans?v().then(function(){t.removeError(a.errorWidgetGuid)})["catch"](function(e){e.error&&("BEX0018"===e.error.code||"product_not_found"===e.error.code||"product_invalid"===e.error.code)&&n?(n=!1,u(e).then(function(){},function(e){a.productList=null,console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(a.errorWidgetGuid,e)})):(a.productList=null,console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(a.errorWidgetGuid,e))})["finally"](function(){a.isLoading=!1}):e().then(function(){t.removeError(a.errorWidgetGuid)})["catch"](function(e){e.error&&("BEX0018"===e.error.code||"product_not_found"===e.error.code||"product_invalid"===e.error.code)&&n?(n=!1,u(e,a.productName?null:y).then(function(){console.log("hola")},function(e){a.productList=null,console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(a.errorWidgetGuid,e)})):(a.productList=null,console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(a.errorWidgetGuid,e))})["finally"](function(){a.isLoading=!1})}else{var r=EV.util.error("INVALID_WIDGET_CONFIG","Invalid widget config: No groupName or productName defined",300);EV.Event.publish(EV.Event.PM_ERROR,r),t.handleError(a.errorWidgetGuid,r),a.isLoading=!1}}function u(e,t){a.groupName=s.groupName,a.productName=s.productName;var n=s.paymentPlans;return a.paymentPlans=n?n.split(","):null,t?t().then(function(){return Promise.resolve()})["catch"](function(e){return Promise.reject(e)}):a.productName?v().then(function(){return Promise.resolve()})["catch"](function(e){return Promise.reject(e)}):y().then(function(){return Promise.resolve()})["catch"](function(e){return Promise.reject(e)})}function p(e){for(var t=0,n=a.productList,r=a.productList.length,i=0;i<r;i++){if(n[i].name==e)return t;t+=1}return t}function f(e){var t=Math.floor(12/e);t<O&&(t=O),a.productStyle="col-sm-"+I+" col-md-"+t,a.productStyleForThirdTemplate="col-sm-12 col-md-12"}function g(){n(function(){EV.Event.publish(EV.Event.PM_SELECT_PAYMENT_PLAN,{paymentPlanName:N.autoSelectPlanName,productName:N.productName})},0)}function h(e){for(var t=0;t<e.paymentPlans.length;t++)if(e.paymentPlans[t].id===e.autoSelectPlan){N={autoSelectPlanName:e.paymentPlans[t].name,productName:e.name};break}}function m(e){if(a.recommendedProduct){for(var t=0;t<e.length;t++)if(e[t].id===a.recommendedProduct&&e[t].autoSelectPlan)return void h(e[t])}else for(var n=0;n<e.length;n++)if(e[n].autoSelectPlan){h(e[n]);break}}function v(){var n=EV.util.Storage.cookie.get("ev_sid");return e.getProduct(a.productName,a.paymentPlans,a.showHidden,a.selectedCountry,n).then(function(e){t.removeError(a.errorWidgetGuid),a.productList=[e],
a.recommendedProduct=null,a.showBoosted=!1,b(e),k(!1)},function(e){throw e})}function b(e){e.requiresDeliveryAddress||(a.showDeliveryCountry=!1)}function y(){var n=EV.util.Storage.cookie.get("ev_sid");return e.getProducts(a.groupName,a.showHidden,a.selectedCountry,n).then(function(e){t.removeError(a.errorWidgetGuid),a.productList=e.products,a.recommendedProduct=e.recommended,a.showBoosted=e.recommended,k(!0)},function(e){throw e})}function E(){if(a.showDeliveryCountry)return e.getCountries().then(function(e){a.countries=e,a.selectedCountry=a.countries.find(function(e){return a.queryParams&&a.queryParams.country?e.id==a.queryParams.country?e.name:void 0:e.name===a.defaultCountry}),a.selectedCountry&&S()})}function w(e){var t=new URLSearchParams(window.location.search);t.set("country",e.id),window.location.search=t}function C(e){var t=new URLSearchParams(window.location.search);return t.has(e)?t.get(e):null}function S(){return e.getRegion(a.selectedCountry.id).then(function(e){a.region=e})}function _(){return"ev-widget.pm.productSelection-"+EV.util.random_guid()}function P(){a.productList.forEach(function(e){"BUNDLE"===e.type&&(e.paymentPlans=e.bundlePlans,e.paymentPlans.forEach(function(e){return e.isBundle=!0}))})}function A(){if(2===a.productList.length){for(var e=0,t=0;t<a.productList[0].paymentPlans.length;t++)for(var n=0;n<a.productList[0].linkedPlanMapping.length;n++)if(a.productList[0].paymentPlans[t].id===a.productList[0].linkedPlanMapping[n].paymentPlanId||a.productList[0].paymentPlans[t].id===a.productList[0].linkedPlanMapping[n].linkedPlanId){e+=1;break}return 2===e}}function k(e){n(function(){P(),f(a.productList.length),a.paymentPlans&&1===a.paymentPlans.length||1===a.productList.length&&2===a.productList[0].paymentPlans.length&&A()?(a.singlePaymentPlan=!0,a.autoSelect&&(a.isAutoSelected=!0,a.paymentPlans?a.changeStatus(0,a.paymentPlans[0]):(a.productList[0].autoSelectPlan&&h(a.productList[0]),N||a.changeStatus(0,a.productList[0].paymentPlans[0])),a.productSubmitAction())):e?m(a.productList):a.productList[0].autoSelectPlan&&h(a.productList[0]),T()},0),$()}function T(){o.ready(function(){a.$apply(function(){EV.Event.publish(EV.Event.PM_PRODUCTS_LOADED,a.productList)})})}function $(){a.imagesToLoad=a.productList.reduce(function(e,t){return t.imageUrl&&e++,e},0),a.imagesLoaded=0,n(function(){a.isRendered=!0})}function L(){var e=o[0].getElementsByClassName("product-header");return Array.from(e).reduce(function(e,t){return t.offsetHeight>e&&(e=t.offsetHeight),e},0)}function V(){var e=o[0].getElementsByClassName("product-body");return Array.from(e).reduce(function(e,t){return t.offsetHeight>e&&(e=t.offsetHeight),e},0)}a.isLoading=!0,a.singlePaymentPlan=!1,a.widgetGuid=s.id||_(),a.errorWidgetGuid="error-"+a.widgetGuid,a.widgetTitle=s.title||"PRODUCT SELECTION",o.attr("title",""),a.showHeader="false"!==s.showHeader,a.showErrorMsgs="false"!==s.showErrorMsgs,a.showBoosted="true"===s.showBoosted,C("shd")?a.showHidden="true"===C("shd"):a.showHidden="true"===s.showHidden,a.multiSelect="true"===s.multiSelect,a.autoSelect="true"===s.autoSelect,a.displayOnly="true"===s.displayOnly,a.orderTypeOption=null!=s.orderTypeOption&&""!=s.orderTypeOption.trim(),a.orderType=s.orderTypeOption,a.showGiftOption="false"!==s.showGiftOption,a.template=s.template||"first",a.horizontalProducts="true"===s.horizontalProducts,a.showProductDescription="true"===s.showProductDescription,a.showProductDisplayName="true"===s.showProductDisplayName,a.selectButtonPlacement=s.selectButtonPlacement||"middle",a.showCustomButton="true"===s.showCustomButton,a.customButtonText=s.customButtonText||"Custom Button Text",a.showDeliveryCountry=a.queryParams&&"true"===a.queryParams.showDeliveryCountry||"true"===s.showDeliveryCountry,a.defaultCountry=a.queryParams&&a.queryParams.defaultCountry||s.defaultCountry,a.groupName=a.queryParams&&a.queryParams.groupName||a.queryParams&&a.queryParams.productGroup||EV.Widgets.Product&&EV.Widgets.Product.groupName||s.groupName,a.productName=a.queryParams&&a.queryParams.productName||EV.Widgets.Product&&EV.Widgets.Product.productName||s.productName;var D=a.queryParams&&a.queryParams.paymentPlans||EV.Widgets.Product&&EV.Widgets.Product.paymentPlans||s.paymentPlans;a.paymentPlans=D?D.split(","):null,a.hideProductDisplayName="false"===s.showProductDisplayName,a.hidePlanDescription="false"===s.showPlanDescription,a.showPlanDisplayName="true"===s.showPlanDisplayName,a.utmCampaign=a.queryParams&&a.queryParams.utm_campaign,a.isUseTogglePlan="true"===s.isUseTogglePlan,a.itemId=C("itemId")||s.itemId,a.pRenewal=C("pRenewal"),a.discountDisplayName="false"!==s.discountDisplayName,a.discountOfferDescription="false"!==s.discountOfferDescription,a.discountOfferText="false"!==s.discountOfferText,a.hideHiddenPromoPlans="true"===s.hideHiddenPromoPlans;var O=s.minColSize||3,I=s.smColSize||6;"1"===s.layout?(a.headerDown=!1,a.titleDown=!1,a.featureDown=!1,a.imageDown=!1,a.boostedDown=!1,a.descriptionDown=!1):"2"===s.layout?(a.headerDown=!0,a.titleDown=!1,a.featureDown=!0,a.imageDown=!0,a.boostedDown=!0,a.descriptionDown=!0):"3"===s.layout?(a.headerDown=!0,a.titleDown=!1,a.featureDown=!0,a.imageDown=!0,a.boostedDown=!0,a.descriptionDown=!1):(a.headerDown=!1,a.titleDown=!1,a.featureDown=!1,a.imageDown=!1,a.boostedDown=!0,a.descriptionDown=!1);var N;a.selections=[],a.productSelected=null,e.removeExtraProperties(),c(),angular.element(r).bind("resize",function(){a.$digest()}),EV.Event.on(EV.Event.PM_PRODUCTS_LOADED,function(e){N&&g()}),EV.Event.on(EV.Event.PM_REMOVE_ITEM_FROM_BASKET,function(e){e.paymentPlan.trialPrice&&c()}),EV.Event.on(EV.Event.PM_PROMO_ACTION,function(t){var n;if(t.isBundlePurchaseFromPromoCode)a.productList=[],a.productList.push(t.productSelected),n=0,a.selections=[t.paymentPlan.name];else{n=p(t.productSelected);for(var r=0;r<a.productList[n].paymentPlans.length;r++)a.productList[n].paymentPlans[r].id===t.paymentPlan.id&&(a.productList[n].paymentPlans[r]=t.paymentPlan)}a.changeStatus(n,t.paymentPlan,!0);var i=[],o="GIFT",s=!0;a.selections.forEach(function(e,n){if(e){var r=a.productList[n];r.paymentPlan=t.paymentPlan,i.push(r)}});var l={products:i};if(o&&(l.orderType=null!=a.selectedOrderTypeOption&&null!=s?s:"STANDARD"),a.utmCampaign&&(l.utmCampaign=a.utmCampaign),a.itemId&&(l.itemId=a.itemId.split(",")),a.pRenewal&&(l.pRenewal=a.pRenewal),e.saveBasket(l),i[0].requiresDeliveryAddress){var c=e.getExtraProperties()||{};if(c.deliveryCountry=a.selectedCountry||null,!c.deliveryCountry){var d=i[0].paymentPlan.regions;d&&d.length>0&&(c.regions=d)}c.region=a.region||null,e.saveExtraProperties(c)}a.isUseTogglePlan?EV.Event.publish(EV.Event.PM_TOGGLE_PLAN_PRODUCT_SELECTED,i):EV.Event.publish(EV.Event.PM_PRODUCTS_SELECTED,i)}),a.changeCountry=function(e){a.selectedCountry=e,S(),w(e),d()},a.getPlanPrice=function(t){if(t.regions&&t.regions.length>0&&a.region){var n=a.region.deliveryItems.find(function(e){return e.currency.id===t.currency.id});n&&(a.planPrice=t.trialPrice?e.calculateTrialPrice(t,n.deliveryCost):e.calculateFinalPrice(t,n.deliveryCost))}else a.planPrice=t.trialPrice?t.trialPrice:t.finalPrice;return a.planPrice},a.isReadyToStyle=function(){return a.isRendered&&a.imagesLoaded==a.imagesToLoad},a.getExtraHeaderPadding=function(e){if(o[0].getElementsByClassName("product-header")[e]){var t=o[0].getElementsByClassName("product-header")[e].offsetHeight;return L()-t}},a.getExtraBodyPadding=function(e){if(o[0].getElementsByClassName("product-body")[e]){var t=o[0].getElementsByClassName("product-body")[e].offsetHeight;return V()-t}},a.imageLoaded=function(){a.imagesLoaded++},a.minHeightImgIndex=null,a.getMinImageHeight=function(e){var t,n=o[0].getElementsByClassName("product-"+e+"-image")[0];return null!==a.minHeightImgIndex?(t=o[0].getElementsByClassName("product-"+a.minHeightImgIndex+"-image")[0].scrollHeight,n.naturalHeight<t&&(t=n.naturalHeight,a.minHeightImgIndex=e)):t=a.productList.reduce(function(e,t,n){if(t.imageUrl){var r=o[0].getElementsByClassName("product-"+n+"-image")[0];r.offsetHeight<e&&(e=r.offsetHeight,a.minHeightImgIndex=n)}return e},12345),t},a.getMaxPaymentPlanHeight=function(e,t){if(a.horizontalProducts){var n=0,r=document.querySelectorAll('[id^="payment-plan-'+e.replace(/ /g,"")+'"][id$="-col"]');r&&r.length===t||setTimeout(function(){a.getMaxPaymentPlanHeight(e,t)},200),r.forEach(function(e){e.clientHeight>n&&(console.log("new maxHeight",n),n=e.clientHeight)}),r.forEach(function(e){e.clientHeight<n&&(e.style.height=n+"px")})}}}}}])}function C(){"use strict";var e=angular.module("ev-widget.pm.productSummary",[]);e.config(["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}]),e.directive("evProductSummary",["pm2Util","EVExceptionHandler","EVENTS",function(e,t,n){return{restrict:"E",scope:{},templateUrl:"pm-v2/ev-product-summary-v2.tpl.html",controller:["$scope","$location",function(e,t){e.queryParams=t.search()}],link:function(r,i,a,o){function s(){if(r.queryParams.orderId){var t=[];e.getExistingOrder(r.queryParams.orderId).then(function(n){console.log("response from existing order",n),angular.forEach(n.orderItems,function(e){var n=e.product;n.paymentPlan=e.paymentPlan,t.push(n)}),r.order=n;var i={id:r.queryParams.orderId,products:t,deliveryAddressGroup:r.order.deliveryAddressGroup,billingAddressGroup:r.order.billingAddressGroup,paymentType:r.order.paymentType};e.saveBasket(i),EV.Event.publish(EV.Event.PM_PRODUCTS_SELECTED,t),EV.Event.publish(EV.Event.PM_CREATE_ORDER_SUCCESS,r.order),console.log("getting paymentpage with order info")})["catch"](function(e){console.log("error retrieving products",e)})}}function l(){if(r.products){var t=[];angular.forEach(r.products,function(n){var i=void 0;e.getCalculatedPrices(n.paymentPlan,1,r.beneficiaryLimit&&r.beneficiaryLimit>0?r.beneficiaryLimit:0).then(function(e){i=e,i&&(n.paymentPlan.finalPrice=i.finalPrice,n.paymentPlan.trialPrice=i.trialPrice,n.paymentPlan.taxAmount=i.taxAmount),t.push(n)})}),r.products=t}}function c(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t="";if(e)return void(r.startDate=moment(e).format("DDMMYYYY"));if(!r.startDate)return void c(new Date);t=r.startDate;var n=parseInt(t.substr(0,2)),i=parseInt(t.substr(2,2))-1,a=parseInt(t.substr(4,4)),o=new Date(a,i,n,0,0,0,0);return null===t||n>31||n<0||i>11||i<0||isNaN(o.getTime())||new Date>o?void c(new Date):void(r.startDate=moment(o).format("DDMMYYYY"))}function d(){return"ev-widget.pm.productSummary-"+EV.util.random_guid()}function u(n){if(t.removeError(r.errorWidgetGuid),console.log("initSummary called. 'products' passed to this function are ",n),n)r.products=n;else{var i=e.getBasket();i?r.products=i.products||[]:r.products=void 0}var a=e.getExtraProperties();r.region=null,a&&a.region&&(r.region=a.region),r.displayVertical&&p(),r.products&&f(),console.log("scope.products",r.products)}function p(){if(r.products&&r.products.length>=1)for(var e=0;e<r.products.length;e++)if(r.products[e].paymentPlan&&"NONE"===r.products[e].paymentPlan.frequency.id)return void(r.showContractLength=!0);r.showContractLength=!1}function f(){for(var e=0;e<r.products.length;e++)if(r.products[e].paymentPlan&&"NONE"!==r.products[e].paymentPlan.frequency.id)return void(r.showFrequencyHorizontalTableHeader=!0);r.showFrequencyHorizontalTableHeader=!1}r.isLoading=!0,r.loggedIn=EV.util.Storage.cookie.get("ev_ss"),r.widgetGuid=a.id||d(),r.errorWidgetGuid="error-"+r.widgetGuid,r.widgetTitle=a.title||"PRODUCT SUMMARY",i.attr("title",""),r.showHeader="false"!==a.showHeader,r.showErrorMsgs="false"!==a.showErrorMsgs,r.displayOnly="true"===a.displayOnly,r.showRemoveBtn="false"!==a.showRemoveBtn,r.showDeliveryCost="true"===a.showDeliveryCost,r.displayVertical="true"===a.displayVertical,r.showFrequency="false"!==a.showFrequency,r.startDate=r.queryParams.startDate||a.startDate,r.showContractLength="true"===a.showContractLength,s(),u(),c(),r.isLoading=!1,EV.Event.on(EV.Event.PM_PRODUCTS_SELECTED,function(t){console.log("product selected - here are the products",t),u(t);var n=e.getBasket();n&&(n.startDate=r.startDate,e.saveBasket(n)),l()}),EV.Event.on(EV.Event.PM_BENEFICIARY_LIMIT_CHANGE,function(t){var n=e.getBasket();r.beneficiaryLimit=parseInt(t.beneficiaryLimit),n&&(n.beneficiaryLimit=t.beneficiaryLimit,e.saveBasket(n)),l()}),r.submit=function(n,i){if(t.removeError(r.errorWidgetGuid),EV.Event.publish(EV.Event.PM_CREATE_ORDER_SUCCESS,r.order),!r.loggedIn){var a=EV.util.error("not_logged_in","Error",400);return EV.Event.publish(EV.Event.PM_ERROR,a),t.handleError(r.errorWidgetGuid,a),void(i&&i("Error processing the order"))}r.processingCheckout=!0,console.log("pm2util.getBasket",e.getBasket()),r.queryParams.orderId?e.pmGetPaymentPageWithOrderInfo(r.queryParams.orderId).then(function(e){console.log("paymentPageDTO",e);var t={products:r.products,providerName:e.providerName,paymentType:e.order?e.order.paymentType:null};EV.Event.publish(EV.Event.PM_REDIRECT_TO_PAYMENT,t),console.log("data ",t),n&&n()})["catch"](function(e){console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(r.errorWidgetGuid,e)})["finally"](function(){return r.isLoading=!1}):e.createOrder().then(function(a){a&&(a.paymentType||(r.processingCheckout=!1,i&&i("Error processing the order")),e.pmGetPaymentPageWithOrderInfo(a.id).then(function(e){var t={products:r.products,providerName:e.providerName,paymentType:e.order?e.order.paymentType:null};EV.Event.publish(EV.Event.PM_REDIRECT_TO_PAYMENT,t),console.log("data ",t),n&&n()})["catch"](function(e){console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(r.errorWidgetGuid,e)}))})["catch"](function(e){r.processingCheckout=!1,console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(r.errorWidgetGuid,e),i&&i(e.error.code||"order")})["finally"](function(){return r.isLoading=!1})},r.remove=function(t){var n=r.products.splice(t,1);e.saveBasket({products:r.products}),EV.Event.publish(EV.Event.PM_REMOVE_ITEM_FROM_BASKET,n[0]),EV.Event.publish(EV.Event.PM_RESET_PROMO,n[0])},r.getPlanPrice=function(t){if(!r.region){var n=e.getExtraProperties();r.region=n&&n.region||null}return r.region?(r.deliveryItem=r.region.deliveryItems.find(function(e){return e.currency.id===t.currency.id}),r.deliveryCost=r.deliveryItem?Number(r.deliveryItem.deliveryCost):0,r.planPrice=t.trialPrice?e.calculateTrialPrice(t,r.deliveryItem.deliveryCost):e.calculateFinalPrice(t,r.deliveryItem.deliveryCost)):r.planPrice=t.trialPrice?t.trialPrice:t.finalPrice,r.planPrice},r.getPrices=function(t){var n=e.getCalculatedPrices(t,1,0);return console.log("prices",n),r.beneficiaryLimit&&r.beneficiaryLimit>0&&(n=e.getCalculatedPrices(t,1,r.beneficiaryLimit)),n.finalPrice},EV.Event.on(EV.Event.SOCIAL_REGISTER_SUCCESS,function(e,t){r.loggedIn=!0,u()}),EV.Event.on(EV.Event.SOCIAL_LOGIN_SUCCESS,function(e,t){r.loggedIn=!0,u()}),EV.Event.on(EV.Event.LOGIN_SUCCESS,function(){r.loggedIn=!0,u()}),EV.Event.on(EV.Event.LOGOUT_ACTION,function(){r.loggedIn=!1,u()}),EV.Event.on(EV.Event.PM_CLEARED_BASKET,function(){u()}),r.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_SUMMARY,function(e,t){r.submit(t.successCb,t.errorCb)}),r.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_PROFILE,function(e,n){t.removeError(r.errorWidgetGuid)})}}}])}function S(){"use strict";var e=angular.module("ev-widget.pm.purchaseCustomData",[]);e.config(["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}]),e.directive("evPurchaseCustomData",["pm2Util","EVExceptionHandler","EVENTS","$window","$translate","$timeout",function(e,t,n,r,i,a){return{restrict:"E",scope:{},templateUrl:"pm-v2/ev-purchase-custom-data.tpl.html",controller:["$scope","$location",function(e,t){e.queryParams=t.search()}],link:function(o,s,l,c){function d(){for(var e=[],t=0;t<o.formAttributes.length;t++)null!=o.formAttributes[t].value&&e.push({name:o.formAttributes[t].name,value:o.formAttributes[t].value,displayOrder:o.formAttributes[t].displayOrder});return console.log("custom data",e),e}function u(){var t=e.getBasket(),n=d();n&&(t.customData=n),e.saveBasket(t)}function p(e){for(var t in e)if(Object.prototype.hasOwnProperty.call(e,t)){var n=e[t];b(n)}o.isLoading=!1,a(function(){EV.Event.publish(EV.Event.PM_PURCHASE_CUSTOM_DATA_LOADED,{widgetId:o.widgetGuid})},0)}function f(e){v(e)}function g(e){var t=new URLSearchParams(r.location.search);return t.has(e)?t.get(e):null}function h(){return"ev-widget.pm.purchaseCustomData-"+EV.util.random_guid()}function m(){e.getPurchase(o.purchaseId).then(function(e){if(e.customData&&e.customData.length>0)for(var t=0;t<e.customData.length;t++)for(var n=0;n<o.formAttributes.length;n++)if(o.formAttributes[n].name===e.customData[t].name){"checkbox"===o.formAttributes[n].type?(o.formAttributes[n].options[0].value="true"===e.customData[t].value,o.formAttributes[n].value="true"===e.customData[t].value):"radiobutton"===o.formAttributes[n].type?(o.formAttributes[n].options[0].value=e.customData[t].value,o.formAttributes[n].value=e.customData[t].value):o.formAttributes[n].value=e.customData[t].value;break}},function(e){console.error("Error retrieving purchase",e)})}function v(t){e.getPurchase(o.purchaseId).then(function(n){if(n.customData&&n.customData.length>0){for(var r in t)if(Object.prototype.hasOwnProperty.call(t,r)){for(var i=t[r],s={isTrue:!1,index:-1},l=0;l<n.customData.length;l++)if(n.customData[l].name===r){s.isTrue=!0,s.index=l;break}s.isTrue?b(i,n.customData[s.index].value):b(i)}o.isLoading=!1,a(function(){EV.Event.publish(EV.Event.PM_PURCHASE_CUSTOM_DATA_LOADED,{widgetId:o.widgetGuid})},0)}else e.getCustomDataFields().then(function(e){p(e),o.isLoading=!1,a(function(){EV.Event.publish(EV.Event.PM_PURCHASE_CUSTOM_DATA_LOADED,{widgetId:o.widgetGuid})},0)},function(e){console.log("[getCustomDataFields] error",e)})},function(e){console.error("Error retrieving purchase",e)})}function b(e,t){"CHECKBOX"===e.typeInput?o.formAttributes.push({description:e.description,label:e.displayName,mandatory:e.mandatory||!1,name:e.id,type:e.typeInput.toLowerCase(),options:[{value:t?t:"false",caption:e.description}],displayOrder:e.displayOrder,value:"true"===t}):"RADIO"===e.typeInput?o.formAttributes.push({description:e.description,label:e.displayName,mandatory:e.mandatory||!1,name:e.id,type:"radiobutton",options:e.options,displayOrder:e.displayOrder,value:t}):"DROPDOWN"===e.typeInput?o.formAttributes.push({description:e.description,label:e.displayName,mandatory:e.mandatory||!1,name:e.id,type:e.typeInput.toLowerCase(),options:e.options,displayOrder:e.displayOrder,value:t}):o.formAttributes.push({description:e.description,label:e.displayName,mandatory:e.mandatory||!1,name:e.id,type:e.typeInput.toLowerCase(),minLength:e.minLength,maxLength:e.maxLength,displayOrder:e.displayOrder,value:t})}function y(e,n,r,a,s){var l="ev.widgets.errors."+e;if(i(l).then(function(i){var a=void 0;a="string"==typeof r?EV.util.error(e,i,n,[r]):EV.util.error(e,i,n,r),t.handleError(o.errorWidgetGuid,a)}),a)throw new Error(s)}o.loggedIn=EV.util.Storage.cookie.get("ev_ss"),o.widgetGuid=l.id||h(),o.errorWidgetGuid="error-"+o.widgetGuid,o.showErrorMsgs="false"!==l.showErrorMsgs,o.widgetTitle=l.title||"PURCHASE CUSTOM DATA",s.attr("title",""),o.showHeader="false"!==l.showHeader,o.showLabels="false"!==l.showLabels,o.usedByPurchaseList="true"===l.usedByPurchaseList,o.formAttributes=[],o.isLoading=!0,o.purchase=null,o.purchaseId=l.purchaseId||g("purchaseId"),EV.Event.on(EV.Event.PM_PURCHASE_CUSTOM_DATA_UPDATE_PURCHASE_ID,function(e){o.usedByPurchaseList||(o.purchaseId=e,m())}),o.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_PROFILE,function(){u()}),EV.Event.on(EV.Event.PM_PURCHASE_CUSTOM_DATA_SUBMIT,function(e){u()}),EV.Event.on(EV.Event.PM_PURCHASE_CUSTOM_DATA_SUBMIT,function(e){o.usedByPurchaseList||(o.purchaseId=e,o.submitForm())});var E="ev.widgets.purchaseCustomData.buttons.submit";i(E).then(function(e){o.submitbtnCaption=e},function(){o.submitbtnCaption=l.submitbtnCaption||"Submit"});var w="ev.widgets.purchaseCustomData.buttons.cancel";i(w).then(function(e){o.cancelbtnCaption=e},function(){o.cancelbtnCaption=l.cancelbtnCaption||"Cancel"}),e.getCustomDataFields().then(function(e){o.usedByPurchaseList?f(e):p(e)},function(e){console.log("[getCustomDataFields] error",e)}),o.submitForm=function(n){if(console.log("submit purchase data, form = :",n),t.removeError(o.errorWidgetGuid),!o.evPurchaseCustomDataForm.$valid)return void(o.showMandatory=!0);EV.Event.publish(EV.Event.PM_PURCHASE_CUSTOM_DATA_SUBMITTING_FORM);var r=d();if(o.purchaseId)e.updatePurchaseWithCustomData(o.purchaseId,r).then(function(e){t.removeError(o.errorWidgetGuid),EV.Event.publish(EV.Event.PM_PURCHASE_CUSTOM_DATA_PURCHASE_UPDATED,e)})["catch"](function(e){if(e.error&&"BEX0001"===e.error.code){var n=e.error.message.match('(?<=\\")(.*?)(?=\\")');y("custom_data_required_field",e.statusCode,n[0],!1)}else{var r=EV.util.error(e.error.code,e.error.message,e.statusCode);o.isLoading=!1,t.handleError(o.errorWidgetGuid,r)}EV.Event.publish(EV.Event.PM_ERROR,error),EV.Event.publish(EV.Event.PM_PURCHASE_CUSTOM_DATA_PURCHASE_UPDATE_ERROR,e)});else{var i=e.getBasket(),a=d();a&&(i.customData=a),e.saveBasket(i)}},EV.Event.on(EV.Event.PM_PURCHASE_CUSTOM_DATA_LOADED,function(e){o.usedByPurchaseList||e.widgetId===o.widgetGuid&&o.purchaseId&&a(function(){m()},0)})}}}])}function _(){"use strict";var e=angular.module("ev-widget.pm.purchases",[]);e.directive("evPurchasesList",["pm2Util","subscriptionsUtil","EVExceptionHandler",function(e,t,n){return{restrict:"E",scope:{},templateUrl:"pm-v2/ev-purchases-list.tpl.html",controller:["EVExceptionHandler","$scope","$uibModal","$q","$translate","$attrs","$element","$http",function(n,r,i,a,o,s,l,c){function d(){if(n.removeError(r.errorWidgetGuid),r.loggedIn)a.all([g(),f(),h()])["catch"](function(e){e.error&&e.error.code&&e.error.code.includes("product_not_found")||(console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),n.handleError(r.errorWidgetGuid,e))})["finally"](function(){r.isLoading=!1,EV.Event.publish(EV.Event.PM_PURCHASES_LOADED,r.purchases)});else{r.isLoading=!1;var e=EV.util.error("not_logged_in","Not Logged In",400);EV.Event.publish(EV.Event.PM_ERROR,e),n.handleError(r.errorWidgetGuid,e)}}function u(){return"ev-widget.pm.purchases-"+EV.util.random_guid()}function p(){return r&&r.session?r.session:EV.util.getEVSession()}function f(){return null!=p()&&p().guid?t.getAllBeneficiaries(p().guid).then(function(e){r.listBeneficiaries=e,r.$apply()}):(p()||EV.Core.refreshSSOSession(),void EV.Event.on(EV.Event.SESSION_REFRESH,function(e){if(null!=p()&&p().guid)return t.getAllBeneficiaries(p().guid).then(function(e){r.listBeneficiaries=e,r.$apply()})}))}function g(){return e.getPurchases().then(function(e){e.forEach(function(e){e.tmpOrderDate=new Date(e.createdDate);var t=e.order.orderItems.find(function(t){return t.orderItemId==e.orderItemId});e.paymentPlan=t.paymentPlan||t.bundlePlan,r.giftPurchases||(r.giftPurchases=r.isGift(e))}),e=e.filter(function(e){return r.statusesToDisplay.includes(e.status)}),"All"!==r.orderTypesToDisplay[0]&&(e=e.filter(function(e){return r.orderTypesToDisplay.includes(e.orderType)})),"All"!==r.channelsToDisplay[0]&&(e=e.filter(function(e){return r.channelsToDisplay.includes(e.channel)})),"All"!==r.brands[0]&&(e=e.filter(function(e){return r.brands.includes(e.brand)})),r.purchases=e,S()})}function h(){return r.showCancelReasons?e.getCancelReasons().then(function(e){r.cancelReasons=e}):void(r.cancelReasons=[])}function m(e,t){console.log("opening change address modal");var n=r.$new(!0);n.scope=n,n.purchase=e,n.addressType=t,n.errorMessage="",n.addressAttributesSuffix=r.addressAttributesSuffix,n.deliveryAddressHiddenAttributes=r.deliveryAddressHiddenAttributes,n.billingAddressHiddenAttributes=r.billingAddressHiddenAttributes,console.log("$scope.mandatoryAttributes in purchase-list",r),n.mandatoryAttributes=r.mandatoryAttributes,i.open({templateUrl:"pm-v2/purchases-list-fragments/ev-change-address.tpl.html",openedClass:"ev-modals modal-open",windowClass:"ev ev-open-modal-change-address",size:"lg",keyboard:!0,backdrop:!1,scope:n,controller:"ChangeAddressCtrl"})}function v(e,t){console.log("opening edit billing address modal");var n=r.$new(!0);n.scope=n,n.purchase=e,n.addressType=t,n.errorMessage="",n.addressAttributesSuffix=r.addressAttributesSuffix,n.deliveryAddressHiddenAttributes=r.deliveryAddressHiddenAttributes,n.billingAddressHiddenAttributes=r.billingAddressHiddenAttributesForEditing,n.mandatoryAttributes=r.mandatoryAttributesForEditing,i.open({templateUrl:"pm-v2/purchases-list-fragments/ev-edit-billing-address.tpl.html",openedClass:"ev-modals modal-open",windowClass:"ev ev-open-modal-change-address",size:"lg",keyboard:!0,backdrop:!1,scope:n,controller:"EditBillingAddressCtrl"})}function b(e,t){var n=r.subscribePagePath+"?pRenewal=true&";t&&(n+="startDate="+t.toLocaleDateString("en-GB").replaceAll("/","")+"&"),r.renewalProduct&&(n+="productName="+e.orderItem.product.name+"&"),r.renewalPlan&&(n+="paymentPlans="+e.paymentPlan.name+"&"),window.location.href=n}function y(e){console.log("Display Latest Invoice",e);var t=e.id,n=e.invoiceHistory[e.invoiceHistory.length-1].id,r=EV.util.Storage.cookie.get("ev_ss"),i=EV.PM.pmDomain+"/widget",a=i+"/account/transactions/"+t+"/"+n+"?ev_ss="+r;c.get(a,{responseType:"arraybuffer"}).then(function(e){var t=new Blob([e.data],{type:"application/pdf"}),n=URL.createObjectURL(t);window.open(n,"_blank")})["catch"](function(e){return console.log("error",e)})}function E(e){console.log("display invoice",e);var t=(e.invoice.filePath,e.invoice.id),n=e.id,r=EV.util.Storage.cookie.get("ev_ss"),i=EV.PM.pmDomain,a=i+"/widget",o=a+"/account/transactions/"+n+"/"+t+"?ev_ss="+r;c.get(o,{responseType:"arraybuffer"}).then(function(e){var t=new Blob([e.data],{type:"application/pdf"}),n=URL.createObjectURL(t);window.open(n,"_blank")})["catch"](function(e){return console.log("error",e)})}function w(e,t){var n=r.$new(!0);n.beneficiary=e,n.filteredListBeneficiaries=t,i.open({templateUrl:"pm-v2/purchases-list-fragments/ev-confirm-dialog.tpl.html",openedClass:"ev-modals modal-open",windowClass:"ev ev-open-modal-confirm-dialog",keyboard:!0,backdrop:!0,scope:n,controller:["$scope","$uibModalInstance",function(n,r){n.cancel=function(){r.close()},n.confirm=function(){P(e,t,n),r.close()}}]})}function C(){return window.matchMedia("(max-width: 767.98px)").matches}function S(){for(var e=0;e<r.purchases.length;e++)"NONE"!==r.purchases[e].paymentPlan.frequency.id&&"CANCELLED"!==r.purchases[e].status&&"CANCEL_PENDING"!==r.purchases[e].status||(r.showEndDateHorizontalTableHeader=!0),r.showNextPaymentDate&&"NONE"!==r.purchases[e].paymentPlan.frequency.id&&"CANCELLED"!==r.purchases[e].status&&"CANCEL_PENDING"!==r.purchases[e].status&&(r.showNextPaymentDateHorizontalTableHeader=!0)}function _(e,r,i,a){t.inviteBeneficiary(p().guid,i,e,r).then(function(e){a.showErrorMsgs=!1,a.notificationSuccess=!0,f(),EV.Event.publish(EV.Event.PM_BENEFICIARY_INVITED)})["catch"](function(e){a.showErrorMsgs=!0,console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),n.handleError(a.widgetGuid,e)})}function P(e,r,i){t.deleteBeneficiary(p().guid,e.key).then(function(t){var n=r.indexOf(e),i=r[n];r.splice(n,1),f(),EV.Event.publish(EV.Event.PM_BENEFICIARY_DELETED,i)},function(e){i.showErrorMsgs=!0,console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),n.handleError(i.widgetGuid,e)})}r.session=EV.util.getEVSession()||p(),r.loggedIn=EV.util.Storage.cookie.get("ev_ss"),r.widgetGuid=s.id||u(),r.errorWidgetGuid="error-"+r.widgetGuid,r.widgetTitle=s.title||"PURCHASES LIST",l.attr("title",""),r.showErrorMsgs="false"!==s.showErrorMsgs,r.showHeader="false"!==s.showHeader,r.showActions="true"===s.showActions,r.showBeneficiaries=s.showBeneficiaries?s.showBeneficiaries:"false",r.showTransactions=s.showTransactions?s.showTransactions:"false",r.showInvoiceFormat=s.showInvoiceFormat?s.showInvoiceFormat:"false",r.showNumberBeneficiaries="true"===s.showNumberBeneficiaries,r.showChangeCard="true"===s.showChangeCard,r.showGenerateQrCode="true"===s.showGenerateQrCode,r.showCancelPurchase="true"===s.showCancelPurchase,r.showRevertCancellation="true"===s.showRevertCancellation,r.hideRevertCancelMigrated="true"===s.hideRevertCancelMigrated,r.showCancelReasons="true"===s.showCancelReasons,r.showProductPlanChanges="true"===s.showProductPlanChanges,r.showAddCard="true"===s.showAddCard,r.hideProductDisplayName="false"===s.showProductDisplayName,r.hidePlanDisplayName="false"===s.showPlanDisplayName,r.showPlanDescription="true"===s.showPlanDescription,r.showStartDate="false"!==s.showStartDate,r.showEndDate="false"!==s.showEndDate,r.showRollingSubEndDate=null!=s.hideRollingsubEndDate&&"false"===s.hideRollingsubEndDate,r.showFrequency="false"!==s.showFrequency,r.showOrderType="true"===s.showOrderType,r.showNextPaymentDate="true"===s.showNextPaymentDate,r.subscribePagePath=s.subscribePagePath,r.showRenewPurchase=null!=r.subscribePagePath,r.statusesToDisplay=s.statusesToDisplay?s.statusesToDisplay.split(","):["ACTIVE","ACTIVE_PENDING","PENDING","CANCEL_PENDING"],r.orderTypesToDisplay=s.orderTypesToDisplay?s.orderTypesToDisplay.split(","):EV.PM.orderType?[EV.PM.orderType]:["All"],r.channelsToDisplay=s.channelsToDisplay?s.channelsToDisplay.split(","):EV.PM.channel?[EV.PM.channel]:["All"],r.showCustomData="true"===s.showCustomData,r.customDataShowHeader="false"!==s.customDataShowHeader,r.customDataShowLabels="false"!==s.customDataShowLabels,r.displayVertical="true"===s.displayVertical,r.showBillingChangeAddress="true"===s.showBillingChangeAddress,r.showDeliveryChangeAddress="true"===s.showDeliveryChangeAddress,console.log("$attrs",s),r.deliveryAddressHiddenAttributes=s.deliveryAddressHiddenAttributes?JSON.parse(s.deliveryAddressHiddenAttributes.replace(/'/g,'"')):null,r.billingAddressHiddenAttributes=s.billingAddressHiddenAttributes?JSON.parse(s.billingAddressHiddenAttributes.replace(/'/g,'"')):null,r.addressAttributesSuffix=s.addressAttributesSuffix||"_country",r.brands=s.showBrands?s.showBrands.split(","):EV.PM.brand?[EV.PM.brand]:["All"],r.giftPurchases=!1,r.isLoading=!0,r.renewalProduct="true"===s.renewalProduct,r.renewalPlan="true"===s.renewalPlan,r.showDiscount="true"===s.showDiscount,r.showPaymentSchema="true"===s.showPaymentSchema,r.showPromoCodeGroup="true"===s.showPromoCodeGroup,r.showPromoCode="true"===s.showPromoCode,r.mandatoryAttributes=s.mandatoryAttributes?JSON.parse(s.mandatoryAttributes.replace(/'/g,'"')):null,r.passMandatoryCheck=!0,r.actionBtnCustomAction="true"===s.actionBtnCustomAction,r.showEmptyWidget="false"!==s.showEmptyWidget,d(),r.showSubscriptionEndDate=function(e){return e.subscription&&r.showRollingSubEndDate&&"CANCEL_PENDING"!==e.status},r.showSubscriptionEndDateCancelPending=function(e){return e.subscription&&"CANCEL_PENDING"===e.status},r.showSubscriptionEndDateCancel=function(e){return e.subscription&&"CANCELLED"===e.status},r.disableActionBtn=function(e){return!(r.actionBtnCustomAction||r.actionBtnViewTransactions(e)||r.actionBtnShowInvoiceFormat(e)||r.actionBtnDisplayBeneficiaries(e)||r.actionBtnAddBeneficiaries(e)||r.actionBtnChangeCard(e)||r.actionBtnChangeBillingAddress(e)||r.actionBtnChangeDeliveryAddress(e)||r.actionBtnCancelPurchase(e)||r.actionBtnRevertCancellation(e)||r.actionBtnChangeProductPlan(e)||r.actionBtnRenewPurchase(e)||r.actionBtnBuyAgain(e)||r.actionGenerateQRAccessCode(e))},r.actionBtnViewTransactions=function(e){return!r.isExternal(e)&&"true"===r.showTransactions},r.actionBtnShowInvoiceFormat=function(e){return"true"===r.showInvoiceFormat},r.actionBtnDisplayBeneficiaries=function(e){return!r.isExternal(e)&&(r.isGift(e)&&("gift"===r.showBeneficiaries||"true"===r.showBeneficiaries)||r.isMultiUser(e)&&("multi-user"===r.showBeneficiaries||"true"===r.showBeneficiaries))&&r.isCancellableStatus(e)},r.actionBtnAddBeneficiaries=function(e){return!r.isExternal(e)&&(r.isGift(e)&&("gift"===r.showBeneficiaries||"true"===r.showBeneficiaries)||r.isMultiUser(e)&&("multi-user"===r.showBeneficiaries||"true"===r.showBeneficiaries))&&r.isCancellableStatus(e)},r.actionBtnChangeCard=function(e){
return!r.isExternal(e)&&(r.isCardSubscription(e)||r.isPaymentGatewaySubscription(e))&&r.showChangeCard&&!r.isCompletedPurchase(e)&&!r.isCancelledPurchase(e)},r.actionBtnChangeBillingAddress=function(e){return!r.isExternal(e)&&e.billingAddressGroup&&r.showBillingChangeAddress&&!r.isCompletedPurchase(e)&&!r.isCancelledPurchase(e)},r.actionBtnChangeDeliveryAddress=function(e){return!r.isExternal(e)&&e.deliveryAddressGroup&&r.showDeliveryChangeAddress&&!r.isCompletedPurchase(e)&&!r.isCancelledPurchase(e)},r.actionBtnCancelPurchase=function(e){return!r.isExternal(e)&&r.isCancellableStatus(e)&&e.subscription&&r.showCancelPurchase},r.actionBtnRevertCancellation=function(e){return!r.isExternal(e)&&r.isCancelPendingPurchase(e)&&e.subscription&&r.showRevertCancellation&&!hideMigratedRevertCancel(e)},r.actionBtnChangeProductPlan=function(e){return!r.isExternal(e)&&r.isCancellableStatus(e)&&r.hasAlternativeProductPlans(e)&&r.showProductPlanChanges&&!r.isPayPalSubscription(e)},r.actionBtnRenewPurchase=function(e){return!r.isExternal(e)&&r.isCancellableStatus(e)&&r.showRenewPurchase&&r.isSinglePurchaseWithEndDate(e)},r.actionBtnBuyAgain=function(e){return!r.isExternal(e)&&(r.isCompletedPurchase(e)||r.isCancelledPurchase(e))&&r.showRenewPurchase||r.isCancelPendingPurchase(e)&&r.hideMigratedRevertCancel(e)&&r.showRenewPurchase},r.actionGenerateQRAccessCode=function(e){return!r.isExternal(e)&&r.showGenerateQrCode&&!r.isCompletedPurchase(e)&&!r.isCancelledPurchase(e)},r.isGift=function(e){return"GIFT"===e.order.orderType},r.isMultiUser=function(e){return"MULTI_USER"===e.order.orderType},r.isExternal=function(e){return"EXTERNAL"===e.order.orderType},r.isCardSubscription=function(e){return"CARD"===e.paymentType&&e.subscription},r.isPaymentGatewaySubscription=function(e){return"PAYMENT_GATEWAY"===e.paymentType&&e.subscription},r.isPayPalSubscription=function(e){return"PAYPAL"===e.paymentType&&e.subscription},r.isCancellableStatus=function(e){return"ACTIVE"===e.status||"ACTIVE_PENDING"===e.status},r.isCompletedPurchase=function(e){return"COMPLETED"===e.status},r.isCancelledPurchase=function(e){return"CANCELLED"===e.status},r.isCancelPendingPurchase=function(e){return"CANCEL_PENDING"===e.status},r.hideMigratedRevertCancel=function(e){return r.hideRevertCancelMigrated&&"MIGRATION"==e.channel},r.hasAlternativeProductPlans=function(e){var t=e.orderItem.product.changeProducts,n=e.orderItem.product.changePlans;return t&&t.length>0||n&&n.length>0},r.toggleInvoiceFormat=function(e){var t=r.$new(!0);t.purchase=e,i.open({templateUrl:"pm-v2/purchases-list-fragments/ev-toggle-invoice-format.tpl.html",openedClass:"ev-modals modal-open",windowClass:"ev ev-open-modal-transactions",keyboard:!0,size:"lg",backdrop:!0,scope:t,controller:["$scope","$uibModalInstance",function(t,n){t.cancel=function(){n.close()},t.confirm=function(){EV.Event.publish(EV.Event.PM_TOGGLE_INVOICE_FORMAT,e),n.close()}}]})},r.displayTransactions=function(t){e.getTransactionByPurchaseId(t.id).then(function(e){console.log("transactions:",e),e=e.map(function(e){return e.createdDate&&(e.createdDate=moment(e.createdDate).format("YYYY-MM-DD")),e.subscriptionPeriod&&e.subscriptionPeriod.startDate&&e.subscriptionPeriod.endDate&&(e.subscriptionPeriod.startDate=moment(e.subscriptionPeriod.startDate).format("YYYY-MM-DD"),e.subscriptionPeriod.endDate=moment(e.subscriptionPeriod.endDate).format("YYYY-MM-DD")),e});var t=r.$new(!0);t.transactions=e,t.loadInvoiceInNewTab=E,t.loadLatestInvoiceInNewTab=y,i.open({templateUrl:"pm-v2/purchases-list-fragments/ev-transactions.tpl.html",openedClass:"ev-modals modal-open",windowClass:"ev ev-open-modal-transactions",keyboard:!0,size:"lg",backdrop:!0,scope:t,controller:["$scope","$uibModalInstance",function(e,t){e.cancel=function(){t.close()}}]})})},r.displayBeneficiaries=function(e){f();var t=r.$new(!0);t.confirmDeleteBeneficiary=P,t.displayConfirmDialog=w,t.widgetGuid="ev-widget.pm.notification-"+EV.util.random_guid(),t.subscriptionItem=e,t.filteredListBeneficiaries=r.listBeneficiaries.filter(function(t){return t.subscriptionId==e.id}),i.open({templateUrl:"pm-v2/purchases-list-fragments/ev-beneficiaries.tpl.html",openedClass:"ev-modals modal-open",windowClass:"ev ev-open-modal-beneficiaries",keyboard:!0,backdrop:!0,scope:t,controller:["$scope","$uibModalInstance",function(e,t){e.cancel=function(){t.close()}}]})},r.displayNotification=function(e){var t=r.$new(!0);t.subscriptionId=e,t.addBeneficiary=_,t.widgetGuid="ev-widget.pm.notification-"+EV.util.random_guid(),t.scope=t,i.open({templateUrl:"pm-v2/purchases-list-fragments/ev-notification-v2.tpl.html",openedClass:"ev-modals modal-open",windowClass:"ev ev-open-modal-notification",keyboard:!0,backdrop:!0,scope:t,controller:["$scope","$uibModalInstance",function(e,t){e.activeNotification=!0,e.cancel=function(){e.activeNotification=!1,t.close()}}]})},r.changeCardDetails=function(e){EV.Event.publish("pm.changeCard",e)},r.changeBillingAddressDetails=function(e){m(e,"BILLING")},r.changeDeliveryAddressDetails=function(e){m(e,"DELIVERY")},EV.Event.on("pm.purchasesList.editBillingAddress",function(e){console.log("$scope",r),console.log(r.purchases),r.billingAddressHiddenAttributesForEditing=e.hiddenAttributes,r.mandatoryAttributesForEditing=e.mandatoryAttributes,r.purchases.forEach(function(t){if(t.id===e.purchaseId){console.log("Found the purchase",t),v(t,"BILLING");var n=!1;n||(EV.Event.on(EV.Event.PM_PURCHASES_CHANGE_ADDRESS_OPENED,function(e){document.querySelector(".edit-billing-address #address-in-use-text")&&document.querySelector(".edit-billing-address #address-in-use-text").previousElementSibling.firstElementChild.click()}),n=!0)}})}),r.generateQRAccessCode=function(e){EV.Event.publish("pm.generateQRAccessCode",e)},r.changeProductPlan=function(e){EV.Event.publish("pm.changeProductPlan",e)},r.isSinglePurchaseWithEndDate=function(e){return e.singlePurchase&&e.endDate},r.buyAgain=function(e){b(e)},r.renewPurchase=function(e){var t=new Date(e.endDate);t.setDate(t.getDate()+1),b(e,t)},r.revertCancellation=function(e){EV.Event.publish("pm.revertCancellation",e)},EV.Event.on("pm.initPurchasesList",function(){d()}),EV.Event.on(EV.Event.PM_TOGGLE_INVOICE_FORMAT,function(t){console.log("triggered the event"),console.log(t);var n=t.invoiceFormat,r=(t.order.id,t.id),i="STANDARD";i="STANDARD"===n?"COMPLETE":"STANDARD",e.changePurchaseInvoiceFormat(r,i).then(function(e){t.invoiceFormat=i})["catch"](function(e){return console.log(e)})}),EV.Event.on(EV.Event.PM_PURCHASE_REGEN_LAST_INVOICE,function(t){e.regenLastInvoice(t.purchaseId).then(function(e){console.log("Successful Invoice Regeneration")})["catch"](function(e){console.log("Error regenerating last invoice:",e)})}),r.cancelPurchase=function(e){EV.Event.publish("pm.cancelPurchase",{purchases:r.purchases,purchase:e,cancelReasons:r.cancelReasons})},r.isShowEndDate=function(e){return r.showEndDate?C()||r.displayVertical?"CANCELLED"===e.status||"CANCEL_PENDING"===e.status||"NONE"===e.paymentPlan.frequency.id:!!r.showEndDateHorizontalTableHeader:!C()&&!r.displayVertical&&!!r.showEndDateHorizontalTableHeader},r.isShowNextPaymentDate=function(e){return r.showNextPaymentDate?C()||r.displayVertical?"CANCELLED"!==e.status&&"CANCEL_PENDING"!==e.status&&"NONE"!==e.paymentPlan.frequency.id:!!r.showNextPaymentDateHorizontalTableHeader:!C()&&!r.displayVertical&&!!r.showNextPaymentDateHorizontalTableHeader},r.numberBenefPerSubscription=function(e){var t=0;return angular.forEach(r.listBeneficiaries,function(n){n.subscriptionId==e&&t++}),t},EV.Event.on(EV.Event.LOGIN_SUCCESS,function(){r.loggedIn=!0,d()}),EV.Event.on(EV.Event.LOGOUT_ACTION,function(){r.loggedIn=!1,r.purchases=null,r.$apply(),d()}),EV.Event.on(EV.Event.PM_ADD_BENEFICIARY_OPEN,function(e){r.displayNotification(e)}),EV.Event.on(EV.Event.PM_OPEN_CHANGE_CARD,function(e){r.changeCardDetails(e)}),EV.Event.on(EV.Event.PM_PURCHASES_LIST_REFRESH,function(){g()}),EV.Event.on(EV.Event.PM_OPEN_BENEFICIARY_LIST,function(e){r.displayBeneficiaries(e)}),EV.Event.on(EV.Event.PM_OPEN_ADD_BENEFICIARY,function(e){r.displayNotification(e)}),EV.Event.on(EV.Event.PM_OPEN_CANCEL_PURCHASE,function(e){r.cancelPurchase(e,r.cancelReasons)}),EV.Event.on(EV.Event.PM_OPEN_CHANGE_PURCHASE,function(e){r.changePurchase(e)}),EV.Event.on(EV.Event.PM_OPEN_PURCHASES_CHANGE_BILLING_ADDRESS,function(e){m(e,"BILLING")}),EV.Event.on(EV.Event.PM_OPEN_PURCHASES_CHANGE_DELIVERY_ADDRESS,function(e){m(e,"DELIVERY")})}]}}])}function P(){"use strict";var e=angular.module("ev-widget.pm.referralCodeEntry",[]);e.config(["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}]),e.directive("evReferralCodeEntry",[function(){return{restrict:"E",scope:{},templateUrl:"pm-v2/ev-referral-code-entry.tpl.html",controller:["$scope","$attrs","$location","$element",function(e,t,n,r){function i(){return"ev-widget.pm.referralCodeEntry-"+EV.util.random_guid()}e.queryParams=n.search(),e.queryParams.rf&&(e.referralCode=e.queryParams.rf,e.hideReferralInput=!0),e.isLoading=!0,e.formErrors=[],e.translatedErrors=[],e.widgetGuid=t.id||i(),e.errorWidgetGuid="error-"+e.widgetGuid,e.widgetTitle=t.title||"REFERRAL CODE",r.attr("title",""),e.showHeader="false"!==t.showHeader,e.showErrorMsgs="false"!==t.showErrorMsgs,e.showLabels="false"!==t.showLabels}]}}])}function A(){"use strict";var e=angular.module("ev-widget.pm.startDateSelector",[]);e.config(["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}]),e.directive("evStartDateSelector",["pm2Util","EVExceptionHandler","EVENTS","$translate","$window",function(e,t,n,r,i){return{restrict:"E",scope:{productId:"="},templateUrl:"pm-v2/ev-startdate-selector.tpl.html",controller:["$scope","$location",function(t,n){function r(){if(t.queryParams.startDate){i();var e=moment(t.dt).format("DDMMYYYY");a(e)}}function i(){var e=t.queryParams.startDate,n=parseInt(e.substr(0,2)),r=parseInt(e.substr(2,2))-1,i=parseInt(e.substr(4,4)),a=new Date(i,r,n,0,0,0,0);n>31||n<0||r>11||r<0||isNaN(a.getTime())||t.dt>a||(t.dt=a)}function a(t){var n=e.getBasket();n&&t&&(n.customStartDate=t,e.saveBasket(n))}var o=new Date;t.pmStartDate=!0,t.queryParams=n.search(),t.dt=o,t.dateOptions={minDate:o},t.format="dd-MMMM-yyyy",t.minDate=o,r(),EV.Event.on(EV.Event.PM_PRODUCTS_SELECTED,function(){var e=moment(t.dt).format("DDMMYYYY");a(e)}),EV.Event.on(EV.Event.PM_ERROR,function(){var e=moment(t.dt).format("DDMMYYYY");a(e)}),t.dateChange=function(){var e=moment(t.dt).format("DDMMYYYY");return t.dt<=o?(t.dt=new Date,e=moment(new Date).format("DDMMYYYY"),void a(e)):void a(e)}}],link:function(e,t,n,r){function i(){return"ev-widget.pm.startDateSelector-"+EV.util.random_guid()}e.isLoading=!0,e.isLoginRequest=!1,e.formErrors=[],e.translatedErrors=[],e.widgetGuid=n.id||i(),e.errorWidgetGuid="error-"+e.widgetGuid,e.widgetTitle=n.title||"Start Date",t.attr("title",""),e.showErrorMsgs="false"!==n.showErrorMsgs,e.showLabels="false"!==n.showLabels,e.showDelivery="true"===n.showDelivery,e.showHidden="true"===n.showHidden,e.showHeader="false"!==n.showHeader,e.paymentPlan="",e.isSubscription=!1,e.isSelected=!1,e.product="",e.startDate=e.queryParams&&e.queryParams.startDate||n.startDate}}}])}function k(){"use strict";var e=angular.module("ev-widget.pm.stripe",[]);e.config(["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}]),e.directive("evStripe",["pm2Util","EVExceptionHandler","EVENTS","$translate","$location","$q",function(e,t,n,r,i,a){return{restrict:"E",scope:{},templateUrl:"pm-v2/ev-stripe.tpl.html",link:function(r,o,s){function l(){return"ev-widget.pm.stripe-"+EV.util.random_guid()}function c(){r.showError=!1,r.stripeErrorMessage="",EV.Event.publish("widgets.removeError",r.errorWidgetGuid)}function d(n,i,a){if(n.error)console.error("Error creating Stripe Payment Method",n.error),EV.Event.publish(EV.Event.PM_ERROR,n.error),n.error&&!n.error.error?t.handleError(r.errorWidgetGuid,{error:n.error}):t.handleError(r.errorWidgetGuid,n.error),r.$apply(function(){r.submitting=!1,r.processingText="ev.widgets.stripe.submitPayment";var e=document.querySelector("ev-stripe .full-screen-loader-overlay"),t=document.querySelector("ev-stripe .full-screen-loader-container");r.fullScreenLoader&&(e.classList.remove("open"),t.classList.remove("open"))}),a&&a("checkout");else if(n.createPaymentIntent){if(n.createPaymentIntent){var o=e.getBasket();if(o&&o.id){var s={create_payment_intent:n.createPaymentIntent};return e.createSubscription(o.id,s).then(function(e){if(e.data&&(e.data.payment_intent_secret||e.data.clientSecret))f(o.id,e.data.payment_intent_secret||e.data.clientSecret,i,a);else{console.error("No Payment Intent Client Secret found."),EV.Event.publish(EV.Event.PM_ERROR,err),t.handleError(r.errorWidgetGuid,err),r.submitting=!1,r.processingText="ev.widgets.stripe.submitPayment";var n=document.querySelector("ev-stripe .full-screen-loader-overlay"),s=document.querySelector("ev-stripe .full-screen-loader-container");r.fullScreenLoader&&(n.classList.remove("open"),s.classList.remove("open")),a&&a("payment")}})["catch"](function(e){console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(r.errorWidgetGuid,e),r.submitting=!1,r.processingText="ev.widgets.stripe.submitPayment";var n=document.querySelector("ev-stripe .full-screen-loader-overlay"),i=document.querySelector("ev-stripe .full-screen-loader-container");r.fullScreenLoader&&(n.classList.remove("open"),i.classList.remove("open")),a&&a("payment")})}}}else{var l=e.getBasket(),c=n.paymentMethod.id;if(l&&l.id){var d={payment_method_id:c};return e.createSubscription(l.id,d).then(function(e){if(e.appErrorCode)throw e;e.data.requires_action||"requires_confirmation"===e.data.status?e.data.payment_intent_secret||e.data.clientSecret?u(l.id,e.data.payment_intent_secret||e.data.clientSecret,c,i,a):e.data.setup_intent_secret&&p(l.id,e.data.setup_intent_secret,c,i,a):h(l.id,{},i,a)})["catch"](function(e){console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(r.errorWidgetGuid,e),r.submitting=!1,r.processingText="ev.widgets.stripe.submitPayment";var n=document.querySelector("ev-stripe .full-screen-loader-overlay"),i=document.querySelector("ev-stripe .full-screen-loader-container");r.fullScreenLoader&&(n.classList.remove("open"),i.classList.remove("open")),a&&a("payment")})}}}function u(e,t,n,r,i){var a={payment_method:n};_.confirmCardPayment(t,a).then(function(t){if(t.paymentIntent){var n={payment_intent_id:t.paymentIntent.id};h(e,n,r,i)}else g(i,t)})}function p(e,t,n,r,i){var a={payment_method:n};_.confirmCardSetup(t,a).then(function(t){if(t.setupIntent){var n={setup_intent_id:t.setupIntent.id};h(e,n,r,i)}else g(i,t)})}function f(e,t,n,i){P=n,A=i,k=e;var a={clientSecret:t};$=_.elements(a);var o=$.create("payment");o.mount("#payment-element"),r.submitting=!1,r.processingText="ev.widgets.stripe.submitPayment";var s=document.querySelector("ev-stripe .full-screen-loader-overlay"),l=document.querySelector("ev-stripe .full-screen-loader-container");r.fullScreenLoader&&(s.classList.remove("open"),l.classList.remove("open"))}function g(e,n){console.error(n),EV.Event.publish(EV.Event.PM_ERROR,n.error),t.handleError(r.errorWidgetGuid,n.error),r.$apply(function(){r.submitting=!1,r.processingText="ev.widgets.stripe.submitPayment";var e=document.querySelector("ev-stripe .full-screen-loader-overlay"),t=document.querySelector("ev-stripe .full-screen-loader-container");r.fullScreenLoader&&(e.classList.remove("open"),t.classList.remove("open"))}),e&&e("payment")}function h(n,i,a,o){e.completeSubscription(n,i).then(function(e){EV.Event.publish(EV.Event.PM_PAYMENT_SUCCESS,e),r.success=!0,a&&a()})["catch"](function(e){console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(r.errorWidgetGuid,e),o&&o("payment")})["finally"](function(){r.submitting=!1,r.processingText="ev.widgets.stripe.submitPayment";var e=document.querySelector("ev-stripe .full-screen-loader-overlay"),t=document.querySelector("ev-stripe .full-screen-loader-container");r.fullScreenLoader&&(e.classList.remove("open"),t.classList.remove("open"))})}function m(){var e=document.createElement("script");e.src="https://js.stripe.com/v3/",e.onload=function(){console.log("Stripe ready!"),v()},document.body.appendChild(e),r.enableExistingCards&&S()&&E()}function v(){t.removeError(r.errorWidgetGuid),_=Stripe(EV.PM.stripeKey),$=_.elements({fonts:[{cssSrc:"https://fonts.googleapis.com/css?family=Source+Code+Pro"}],locale:"auto"});var e=document.querySelectorAll(".stripe-payment .input");Array.prototype.forEach.call(e,function(e){e.addEventListener("focus",function(){e.classList.add("focused")}),e.addEventListener("blur",function(){e.classList.remove("focused")}),e.addEventListener("keyup",function(){0===e.value.length?e.classList.add("empty"):e.classList.remove("empty")})});var n={base:{color:"#32325D",fontWeight:500,fontSize:"16px",fontSmoothing:"antialiased","::placeholder":{color:"#CFD7DF"},":-webkit-autofill":{color:"#e39f48"}},invalid:{color:"#E25950","::placeholder":{color:"#FFCCA5"}}},i={focus:"focused",empty:"empty",invalid:"invalid"},a=[];!r.paymentTypes.includes("CARD")&&!r.paymentTypes.includes("PAYMENT_GATEWAY")||r.enableGoogleApplePay||(b(n,i,a),$=a,C(_,$)),r.paymentTypes.includes("IDEAL")&&(y(n,i,a),$=a,C(_,$))}function b(e,t,n){var i=$.create("cardNumber",{style:e,classes:t});i.mount("#card-number"),r.cardNumber=i;var a=$.create("cardExpiry",{style:e,classes:t});a.mount("#card-expiry"),r.cardExpiry=a;var o=$.create("cardCvc",{style:e,classes:t});o.mount("#card-cvc"),r.cardCvc=o,n.push(i,a,o),r.stripeElements=n}function y(e,t,n){e.base.padding="10px 12px";var i=$.create("idealBank",{style:e,classes:t});i.mount("#ideal-bank-element"),i.on("change",function(e){r.idealBank=e.value}),$=Array.isArray($)||[],n.push(i)}function E(){r.isLoadingCards=!0,r.displayOnlyDefaultCard?e.retrieveCustomerDefaultCard().then(function(e){r.cards=e?[e]:[],r.cards.length>0?EV.Event.publish(EV.Event.PM_STRIPE_PURCHASE_CARD_EXISTS,{cardExists:!0,cardList:r.cards}):(r.isNewCard=!0,EV.Event.publish(EV.Event.PM_STRIPE_PURCHASE_CARD_EXISTS,{cardExists:!1}))})["catch"](function(e){r.isNewCard=!0,console.warn(e),EV.Event.publish(EV.Event.PM_ERROR,e)})["finally"](function(){r.isLoadingCards=!1}):e.retrieveCustomerCards().then(function(e){r.cards=e,r.cards.length>0?EV.Event.publish(EV.Event.PM_STRIPE_PURCHASE_CARD_EXISTS,{cardExists:!0,cardList:r.cards}):(r.isNewCard=!0,EV.Event.publish(EV.Event.PM_STRIPE_PURCHASE_CARD_EXISTS,{cardExists:!1}))})["catch"](function(e){r.isNewCard=!0,console.warn(e),EV.Event.publish(EV.Event.PM_ERROR,e)})["finally"](function(){r.isLoadingCards=!1})}function w(){r.cards&&delete r.cards,r.session&&delete r.session,r.isLoadingCards=!1,r.isNewCard=!0}function C(e,t){var n={};t.forEach(function(e,t){e.on("change",function(e){if(e.error)r.showError=!0,n[t]=e.error.message,r.stripeErrorMessage=e.error.message,r.submitting=!1;else{n[t]=null;var i=Object.keys(n).sort().reduce(function(e,t){return e||n[t]},null);i?r.stripeErrorMessage=i:r.$apply(function(){r.showError=!1,r.stripeErrorMessage=""})}})})}function S(){return!r.session&&EV.util.getEVSession()&&(r.session=EV.util.getEVSession()),r.session}r.loggedIn=EV.util.Storage.cookie.get("ev_ss"),r.widgetGuid=s.id||l(),r.errorWidgetGuid="error-"+r.widgetGuid,r.widgetTitle=s.title||"PAYMENT DETAILS",o.attr("title",""),r.showHeader="false"!==s.showHeader,r.showErrorMsgs="false"!==s.showErrorMsgs,r.paymentTypes=s.paymentTypes?s.paymentTypes.split(","):["CARD"],r.defaultPayment=s.defaultPayment||"CARD",r.isSubscription="false"!==s.subscription,r.enableExistingCards="true"===s.enableExistingCards,r.displayOnlyDefaultCard="true"===s.displayOnlyDefaultCard,r.enableGoogleApplePay="true"===s.enableGoogleApplePay,r.fullScreenLoader="true"===s.fullScreenLoader,r.paymentTypeOrderCreated=!1,r.order=null,r.cardNumber=null,r.cardExpiry=null,r.cardCvc=null;var _,P,A,k,T=i.$$protocol+"://"+i.$$host,$=[],L=["CARD","IDEAL","PAYMENT_GATEWAY"];m(),r.submit=function(n,i){if(t.removeError(r.errorWidgetGuid),!e.isCheckoutButtonLoaded()||n){if(!r.loggedIn){var a=EV.util.error("not_logged_in","Error",400);return EV.Event.publish(EV.Event.PM_ERROR,a),t.handleError(r.errorWidgetGuid,a),void(i&&i("payment"))}var o=document.querySelector("ev-stripe .full-screen-loader-overlay"),s=document.querySelector("ev-stripe .full-screen-loader-container");if(r.fullScreenLoader&&(r.processingText="ev.widgets.checkout.processingPayment",o.classList.add("open"),s.classList.add("open")),"CARD"!==r.defaultPayment&&"PAYMENT_GATEWAY"!==r.defaultPayment||r.enableGoogleApplePay){if("CARD"===r.defaultPayment&&r.enableGoogleApplePay){if(r.stripeErrorMessage)return void(i&&i("payment"));r.success=!1,r.submitting=!0,d({createPaymentIntent:!0},n,i)}}else{if(r.stripeErrorMessage)return void(i&&i("payment"));if(r.success=!1,r.submitting=!0,r.enableExistingCards&&!r.isNewCard)if(r.selectedPaymentMethod)d({paymentMethod:{id:r.selectedPaymentMethod}},n,i);else{var l={code:"no_card_selected",message:"Please select a card",type:"validation_error"};EV.Event.publish(EV.Event.PM_ERROR,l),t.handleError(r.errorWidgetGuid,{error:l}),r.submitting=!1,r.processingText="ev.widgets.stripe.submitPayment",r.fullScreenLoader&&(o.classList.remove("open"),s.classList.remove("open"))}else _.createPaymentMethod({type:"card",card:$[0],billing_details:{}}).then(function(e){d(e,n,i)})["catch"](function(e){console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(r.errorWidgetGuid,e),i("payment"),r.submitting=!1,r.processingText="ev.widgets.stripe.submitPayment",r.fullScreenLoader&&(o.classList.remove("open"),s.classList.remove("open"))})}}},r.isUserLoggedIn=function(){return S()},r.selectCard=function(e){r.selectedPaymentMethod&&e===r.selectedPaymentMethod?(document.getElementById("thumbnail-"+r.selectedPaymentMethod).classList.remove("selected-card"),r.selectedPaymentMethod=null):r.selectedPaymentMethod&&e!==r.selectedPaymentMethod?(document.getElementById("thumbnail-"+r.selectedPaymentMethod).classList.remove("selected-card"),r.selectedPaymentMethod=e,document.getElementById("thumbnail-"+e).classList.add("selected-card")):(r.selectedPaymentMethod=e,document.getElementById("thumbnail-"+e).classList.add("selected-card"))},r.switchPanel=function(){r.isNewCard=!r.isNewCard||!r.isNewCard,c(),r.isNewCard?(r.selectedPaymentMethod=null,EV.Event.publish(EV.Event.PM_STRIPE_PURCHASE_PANEL_NEW_CARD)):EV.Event.publish(EV.Event.PM_STRIPE_PURCHASE_PANEL_EXISTING_CARD)},r.displayExistingCards=function(){return r.enableExistingCards&&("CARD"===r.defaultPayment||"PAYMENT_GATEWAY"===r.defaultPayment)&&r.isUserLoggedIn()&&r.cards&&r.cards.length>0&&!r.isNewCard},r.submitStripeForm=function(e,t){_.confirmPayment({elements:$,confirmParams:{return_url:T},redirect:"if_required"}).then(function(n){if(console.log("Stripe Payment Confirmed!",n),n.error)return void g(t,n);var r={payment_intent_id:n.paymentIntent.id};h(k,r,e,t)},function(e){var n=document.querySelector("#error-message");n.textContent=e.message,g(t,e)})},r.paymentTypes.includes("PAYMENT_GATEWAY")?EV.Event.publish(EV.Event.PM_REGISTER_PROVIDER_WIDGET,{paymentType:"PAYMENT_GATEWAY",selector:"ev-stripe"}):EV.Event.publish(EV.Event.PM_REGISTER_PROVIDER_WIDGET,{paymentType:"CARD",selector:"ev-stripe"}),EV.Event.publish(EV.Event.PM_REGISTER_PROVIDER_WIDGET,{paymentType:"IDEAL",selector:"ev-stripe"}),EV.Event.on(EV.Event.PM_CREATE_ORDER_SUCCESS,function(e){r.order=e}),EV.Event.on(EV.Event.PM_REDIRECT_TO_PAYMENT,function(e){e&&"STRIPE"===e.providerName&&(r.defaultPayment=e.paymentType,EV.Event.publish(EV.Event.PM_REDIRECT_TO_STRIPE_PAYMENT,e))}),EV.Event.on(EV.Event.PM_PAYMENT_TYPE_CHANGED,function(e){if(e){var t=e.name||e;L.includes(t)&&(r.defaultPayment=t)}}),EV.Event.on(EV.Event.PM_PRODUCT_ACTION,function(e){r.isSubscription=e.isSubscription}),EV.Event.on(EV.Event.LOGIN_SUCCESS,function(){r.loggedIn=!0,r.enableExistingCards&&!r.cards&&E()}),EV.Event.on(EV.Event.LOGOUT_ACTION,function(){r.loggedIn=!1,r.enableExistingCards&&w()}),EV.Event.on("ev.widgets.paymentTypeSelector.orderCreated",function(){if(r.enableGoogleApplePay){r.paymentTypeOrderCreated=!0;var t=a.defer(),n={successCb:function(e){t.resolve(e)},errorCb:function(e){t.reject(e)}},i=e.getBasket();r.paymentTypes.includes("PAYMENT_GATEWAY")?i&&i.paymentType&&"PAYMENT_GATEWAY"===i.paymentType&&r.submit(n.successCb,n.errorCb):i&&i.paymentType&&("CARD"===i.paymentType||"IDEAL"===i.paymentType)&&r.submit(n.successCb,n.errorCb),t.promise.then(function(e){console.log("ev-stripe: Stripe Element Form ready with Google Pay/Apple Pay",e)},function(e){console.log("ev-stripe: Stripe Element Form not ready with Google Pay/Apple Pay",e)})}}),r.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_PAYMENT,function(t,n){if(r.paymentTypeOrderCreated&&r.enableGoogleApplePay)return void r.submitStripeForm(n.successCb,n.errorCb);var i=e.getBasket();r.paymentTypes.includes("PAYMENT_GATEWAY")?i&&i.paymentType&&"PAYMENT_GATEWAY"===i.paymentType&&r.submit(n.successCb,n.errorCb):i&&i.paymentType&&("CARD"===i.paymentType||"IDEAL"===i.paymentType)&&r.submit(n.successCb,n.errorCb)}),r.$on(n.INTERNAL.PM_CHECKOUT.SUBMIT_PROFILE,function(e,n){t.removeError(r.errorWidgetGuid)})}}}])}function T(){"use strict";var e=angular.module("ev-widget.pm.swg.article",[]);e.directive("evSwgArticle",["icUtil","EVENTS",function(e,t){return{restrict:"E",scope:{},templateUrl:"pm-v2/ev-swg-article.tpl.html",link:function(t,n,r){function i(){return"ev-widget.pm.swg-article-"+EV.util.random_guid()}function a(){if(!t.subscriptions){var e=document.createElement("script");e.src="https://news.google.com/swg/js/v1/swg.js",document.body.appendChild(e)}}function o(){var e=document.createElement("script");e.src="https://apis.google.com/js/platform.js?onload=initGoogleApi",e.onload=function(){s()},e.defer=!0,document.body.appendChild(e)}function s(){t.googleApiKey=EV.settings.ic_social_settings.social_services.google.id,gapi.load("auth2",function(){gapi.auth2.init({client_id:t.googleApiKey,fetch_basic_profile:!0,scope:"profile"}).then(function(){t.googleApi=gapi.auth2.getAuthInstance(),c()})})}function l(e){for(var t,n=JSON.parse(atob(e.raw.split(".")[1])),r=0;r<n.entitlements.length;r++)"google"==n.entitlements[r].source&&(t=JSON.parse(n.entitlements[r].subscriptionToken).orderId);return t}function c(){(self.SWG=self.SWG||[]).push(function(n){t.subscriptions=n,n.setOnEntitlementsResponse(function(r){r.then(function(r){if(r.enablesThis()&&!t.loggedIn&&t.googleApi.isSignedIn.get()){var i={googleId:t.googleApi.currentUser.get().getBasicProfile().getId(),email:t.googleApi.currentUser.get().getBasicProfile().getEmail(),client_id:t.googleApiKey},a=EV.settings.getEVRealm(),o=l(r);EV.Core.UI.checkIdentifierValidity(a,"swg_subId",o).then(function(t){n.showLoginPrompt().then(function(){n.showLoginNotification().then(function(){var t=EV.util.promise(),n=EV.settings.getEVService();EV.Social.swgSessionLogin(i,a,n,t).then(function(t){e.handleEntitlements(r),response.complete().then(function(){console.log("swg signin ok")})})["catch"](function(e){console.log("Swg signin error",e)})})})},function(t){"USER_PROFILE_IDENTIFIERS_NOT_FOUND"===t.error.code&&n.completeDeferredAccountCreation({entitlements:r,consent:!0}).then(function(t){var n=EV.util.promise(),r=EV.settings.getEVService(),i=!0,s=!0;EV.Social.swgSession(t,a,r,s,i,n,o).then(function(n){e.handleEntitlements(t.entitlements),t.complete().then(function(){console.log("deferred account creation finished")})["catch"](function(e){console.log("DAC",e)})})["catch"](function(e){console.log("DAC",e)})})["catch"](function(e){console.log("DAC",e)})})}})["catch"](function(e){console.log("DAC",e)})})})}t.loggedIn=EV.util.Storage.cookie.get("ev_ss"),t.widgetGuid=r.id||i(),t.publicationName=r.publicationName,t.productId=r.productId,o(),a()}}}])}function L(){"use strict";var e=angular.module("ev-widget.pm.swg",[]);e.directive("evSwg",["icUtil","EVENTS",function(e,t){return{restrict:"E",scope:{},templateUrl:"pm-v2/ev-swg.tpl.html",link:function(t,n,r){function i(){return"ev-widget.pm.swg-"+EV.util.random_guid()}function a(){if(!t.subscriptions){var e=document.createElement("script");e.src="https://news.google.com/swg/js/v1/swg.js",e.onload=function(){s()},document.body.appendChild(e)}}function o(e){var t=JSON.parse(e.purchaseData.data);return t.orderId}function s(){(self.SWG=self.SWG||[]).push(function(e){t.subscriptions=e,e.setOnEntitlementsResponse(function(e){e.then(function(e){l(e),e.ack()})}),e.setOnSubscribeResponse(function(e){e.then(function(e){var t=o(e),n=EV.util.promise(),r=EV.settings.getEVRealm(),i=EV.settings.getEVService(),a=!0,s=!0;EV.Social.swgSession(e,r,i,s,a,n,t).then(function(t){console.log("Account creation/update finished"),l(e.entitlements),e.complete().then(function(){})})["catch"](function(e){console.log("Account creation failed",e)})})});var n=document.getElementById("button-"+t.widgetGuid);e.attachButton(n,{theme:"light"},t.showOffers)})}function l(t){t&&e.handleEntitlements(t)}t.loggedIn=EV.util.Storage.cookie.get("ev_ss"),t.widgetGuid=r.id||i(),a(),t.showOffers=function(){t.subscriptions.showOffers({skus:r.skus?r.skus.split(","):null,isClosable:!0})},EV.Event.on("social-login.success",function(){t.subscriptions.getEntitlements().then(function(e){l(e)})})}}}])}function V(){"use strict";var e=angular.module("ev-widget.pm.viewReferralOffers",[]);e.config(["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}]),e.directive("evViewReferralOffers",["pm2Util","EVExceptionHandler","EVENTS","$translate","$window",function(e,t,n,r,i){return{restrict:"E",scope:{},templateUrl:"pm-v2/ev-view-referral-offers.tpl.html",controller:["$scope","$attrs","$element",function(n,r,i){function a(){return"ev-widget.pm.viewReferralOffers-"+EV.util.random_guid()}function o(){if(t.removeError(n.errorWidgetGuid),n.loggedIn)e.retrieveReferralOffers().then(function(e){n.offers=e,n.isLoading=!1})["catch"](function(e){console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(n.errorWidgetGuid,e)});else{n.isLoading=!1;var r=EV.util.error("not_logged_in","Not Logged In",400);EV.Event.publish(EV.Event.PM_ERROR,r),t.handleError(n.errorWidgetGuid,r)}}n.isLoading=!0,n.formErrors=[],n.translatedErrors=[],n.loggedIn=EV.util.Storage.cookie.get("ev_ss"),n.widgetGuid=r.id||a(),n.errorWidgetGuid="error-"+n.widgetGuid,n.widgetTitle=r.title||"REFERRAL OFFERS",i.attr("title",""),n.showHeader="false"!==r.showHeader,n.showErrorMsgs="false"!==r.showErrorMsgs,n.showLabels="false"!==r.showLabels,n.showHidden="true"===r.showHidden,n.offers=[],o(),EV.Event.on(EV.Event.LOGIN_SUCCESS,function(){n.loggedIn=!0,o()}),EV.Event.on(EV.Event.LOGOUT_ACTION,function(){n.loggedIn=!1,n.$apply(),o()})}]}}])}function D(){"use strict";var e=angular.module("ev-widget.pm.changePurchaseAddress",[]);e.controller("ChangeAddressCtrl",["$scope","$uibModalInstance","$translate","pm2Util","EVExceptionHandler","$timeout",function(e,t,n,r,i,a){function o(t){t.forEach(function(t){e.referenceDataMap[t.dataName]=t})}function s(t){t.forEach(function(t){t.attributes.forEach(function(t){e.referenceDataAttributeMap[t]=[]})}),t.forEach(function(t){t.attributes.forEach(function(n){e.referenceDataAttributeMap[n].push(t)})})}function l(){var t=angular.copy(EV.WM.referenceData),n={};return e.config.selectedBillingAddress.attributes.forEach(function(e){t.forEach(function(t){t.attributes.includes(e.name)&&!n[e.name]&&(n[e.name]=e)})}),n}function c(t){var n=angular.copy(e.referenceDataAttributeMap);d(t,n)}function d(t,n){Object.keys(n).forEach(function(t){e.config.selectedBillingAddress.attributes.forEach(function(e){if(e.name===t){var r=n[t].find(function(e){return 0==e.linkedFromList.length});r&&(r=u(r),e.options=r.data.values)}})})}function u(e){return e.data.values=e.data.values.map(function(e){return e.caption||(e.caption=e.name,delete e.name),e}),e}function p(t,n){var r=e.config.selectedBillingAddress.attributes.find(function(e){return e.name===n});if(r){var i=e.config.selectedBillingAddress.attributes.findIndex(function(e){
return e.name===r.name}),a=u(t);e.config.selectedBillingAddress.attributes[i].options=a.data.values}}function f(t){var n=angular.copy(EV.WM.referenceData),r=n.filter(function(e){return e.attributes.includes(t.name)});if(0!=r.length){var i=null,a=!(null==e.config.selectedBillingAddress||!e.config.selectedBillingAddress.attributes)&&e.config.selectedBillingAddress.attributes.filter(function(e){return e.name===t.name}).length>0,o=!(null==e.config.selectedDeliveryAddress||!e.config.selectedDeliveryAddress.attributes)&&e.config.selectedDeliveryAddress.attributes.filter(function(e){return e.name===t.name}).length>0;if(a){var s=angular.copy(e.config.selectedBillingAddress);i=s.attributes.findIndex(function(e){return e.name===t.name}),s.attributes=s.attributes.slice(i+1),s.attributes.forEach(function(n){return g(t,n.name,e)})}else if(o){var l=angular.copy(e.config.selectedDeliveryAddress);i=l.attributes.findIndex(function(e){return e.name===t.name}),l.attributes=l.attributes.slice(i+1),l.attributes.forEach(function(n){return g(t,n.name,e)})}}}function g(e,t,n){var r=!(null==n.config.selectedBillingAddress||!n.config.selectedBillingAddress.attributes)&&n.config.selectedBillingAddress.attributes.filter(function(t){return t.name===e.name}).length>0,i=!(null==n.config.selectedDeliveryAddress||!n.config.selectedDeliveryAddress.attributes)&&n.config.selectedDeliveryAddress.attributes.filter(function(t){return t.name===e.name}).length>0;angular.copy(EV.WM.referenceData).forEach(function(e){var a=angular.copy(e);0==a.linkedFromList.length&&a.attributes.includes(t)&&(a=u(a),r?n.config.selectedBillingAddress.attributes=n.config.selectedBillingAddress.attributes.map(function(e){return e.name===t&&(e.options=a.data.values,e.value=null),e}):i&&(n.config.selectedDeliveryAddress.attributes=n.config.selectedDeliveryAddress.attributes.map(function(e){return e.name===t&&(e.options=a.data.values,e.value=null),e})))})}function h(t){var n=!(null==e.config.selectedBillingAddress||!e.config.selectedBillingAddress.attributes)&&e.config.selectedBillingAddress.attributes.filter(function(e){return e.name===t.name}).length>0,r=!(null==e.config.selectedDeliveryAddress||!e.config.selectedDeliveryAddress.attributes)&&e.config.selectedDeliveryAddress.attributes.filter(function(e){return e.name===t.name}).length>0,i=EV.WM.referenceData.filter(function(e){if(e.attributes.includes(t.name))return e}),a=(i.map(function(e){return e.data.values}),[]);n?a=e.config.selectedBillingAddress.attributes.find(function(e){return e.name===t.name}):r&&(a=e.config.selectedDeliveryAddress.attributes.find(function(e){return e.name===t.name}));var o=!0;a.options&&a.options.forEach(function(i){if(i.value===t.value&&i&&i.linkedReferenceData){o=!1;var a=EV.WM.referenceData.find(function(e){return e.dataName===i.linkedReferenceData.name});a&&(n?e.config.selectedBillingAddress.attributes=e.config.selectedBillingAddress.attributes.map(function(e){return a.attributes.forEach(function(t){e.name===t&&(e.options=a.data.values)}),e}):r&&(e.config.selectedDeliveryAddress.attributes=e.config.selectedDeliveryAddress.attributes.map(function(e){return a.attributes.forEach(function(t){e.name===t&&(e.options=a.data.values)}),e})))}})}function m(e){e.isChecked?e.options.forEach(function(t){t.value===e.option&&(t.isChecked=!0)}):e.options.forEach(function(t){t.value===e.option&&(t.isChecked=!1)});var t=e.options.filter(function(e){return e.isChecked});return t}function v(e,t,n,r){var i=this,a=angular.copy(EV.WM.referenceData),o=angular.copy(e);e.attributes=e.attributes.filter(function(e){return t.some(function(t){return t.linkedReferenceData.attributes.includes(e.name)})}),e.attributes.forEach(function(e){r.attributes=r.attributes.map(function(n){return n.name===e.name&&(n.options=[],t.forEach(function(e){a.forEach(function(t){e.linkedReferenceData.attributes.includes(n.name)&&e.linkedReferenceData.name===t.dataName&&t.data.values.forEach(function(e){return n.options.push(e)})})})),n})}),o.attributes.forEach(function(e){r.attributes=r.attributes.map(function(n){return n.name===e.name&&0==t.length&&(n.options=[],angular.copy(EV.WM.referenceData).forEach(function(t){var r=angular.copy(t);0==r.linkedFromList.length&&r.attributes.includes(e.name)&&(r=i.replaceNameWithCaption(r),r.data.values.forEach(function(e){return n.options.push(e)}))})),n})})}function b(t){r.getProfileGroups(t.serviceName).then(function(t){e.profileGroups=t,C(),y(),P(),S()})["finally"](function(){e.isLoading=!1,a(function(){k(),EV.Event.publish(EV.Event.PM_PURCHASES_CHANGE_ADDRESS_OPENED,e.purchase.id)},0)})}function y(){if("BILLING"===e.addressType&&e.billingAddressHiddenAttributes){var t=E(e.billingAddressHiddenAttributes);w(t)}if("DELIVERY"===e.addressType&&e.$parent.deliveryAddressHiddenAttributes){var n=E(e.deliveryAddressHiddenAttributes);w(n)}}function E(t){var n=[];return e.profileGroups.addresses.forEach(function(e){e.attributes.forEach(function(e){Object.keys(t).forEach(function(t){if(t.includes("*")){var r=t.split("*")[0],i=t.split("*")[1];e.name&&e.name.startsWith(r)&&e.name.endsWith(i)&&n.push(e.name)}else t===e.name&&n.push(e.name)})})}),n}function w(t){t.forEach(function(t){e.profileGroups.addresses.forEach(function(e){e.attributes=e.attributes.filter(function(e){return e.name!=t})})})}function C(){e.config={},e.config.selectedBillingAddress=e.profileGroups.addresses.find(function(t){return t.name===e.$parent.purchase.billingAddressGroup}),e.config.billingAddressHiddenAttributes=JSON.parse(JSON.stringify(e.billingAddressHiddenAttributes)),e.config.selectedDeliveryAddress=e.profileGroups.addresses.find(function(t){return t.name!==e.$parent.purchase.billingAddressGroup}),e.config.deliveryAddressHiddenAttributes=JSON.parse(JSON.stringify(e.deliveryAddressHiddenAttributes)),console.log("$scope=",e)}function S(){EV.Event.on(EV.Event.PROFILE_ATTRIBUTE_CHANGED,function(t){var n=t.attribute,r=t.field;if(e.config&&e.config.selectedBillingAddress&&e.config.selectedBillingAddress.attributes&&!n&&t.value){o(angular.copy(EV.WM.referenceData)),s(angular.copy(EV.WM.referenceData));var i=l();Object.keys(i).forEach(function(e){var t=i[e];c(t)}),Object.keys(i).forEach(function(t){var n=e.referenceDataAttributeMap[t].map(function(e){var n=i[t].value,r=e.data.values.find(function(e){return e.value===n})?e.data.values.find(function(e){return e.value===n}).linkedReferenceData:null;return r}).filter(function(e){return e});n&&n.forEach(function(t){t?t.attributes.forEach(function(n){var r=e.referenceDataAttributeMap[n].find(function(e){return e.dataName===t.name});p(r,n)}):Object.keys(e.referenceDataAttributeMap).forEach(function(t){var n=e.referenceDataAttributeMap[t].find(function(e){return 0==e.linkedFromList.length});p(n,t)})})})}if(n&&"dropdown"===n.type&&(console.log("resetting....",n,r),f(n),h(n)),n&&"checkbox"===n.type){var a=null,d=!(null==e.config.selectedBillingAddress||!e.config.selectedBillingAddress.attributes)&&e.config.selectedBillingAddress.attributes.filter(function(e){return e.name===n.name}).length>0,u=!(null==e.config.selectedDeliveryAddress||!e.config.selectedDeliveryAddress.attributes)&&e.config.selectedDeliveryAddress.attributes.filter(function(e){return e.name===n.name}).length>0;if(d){var g=m(n),b=angular.copy(e.config.selectedBillingAddress);a=b.attributes.findIndex(function(e){return e.name===n.name}),b.attributes=b.attributes.slice(a+1),v(b,g,e,e.config.selectedBillingAddress)}else if(u){var y=m(n),E=angular.copy(e.config.selectedDeliveryAddress);a=E.attributes.findIndex(function(e){return e.name===n.name}),E.attributes=E.attributes.slice(a+1),v(E,y,e,e.config.selectedDeliveryAddress)}}})}function _(t){e.populatedAddresses=t.filter(function(e){return e.attributes.some(function(e){return e.value})})}function P(){e.loggedIn&&!e.showAuthDetails||Object.keys(e.profileGroups).forEach(function(t){if("authDetails"!==t){var n=e.profileGroups[t];n instanceof Array?n.forEach(function(n){e.profileGroups[t].attributes=A(n.attributes||[])}):e.profileGroups[t].attributes=A(n&&n.attributes||[])}})}function A(t){var n=[];return t.forEach(function(t){e.profileGroups.authDetails.attributes.find(function(e){return e.name===t.name})||n.push(t)}),n}function k(){var e=0,t=document.querySelectorAll('[id^="thumbnail-card-address-"]');Array.prototype.map.call(t,function(t){t.clientHeight>e&&(e=t.clientHeight)});for(var n=0;n<t.length;n++)t[n].style.minHeight=e+"px"}function T(t){e.errors=[];var n=$(e.profileGroups,t),r=n.filter(function(e){return null!==e.value}).map(function(e){return{name:e.name,value:e.value}}),i=angular.copy(r);if(i=r.filter(function(e){return!e.name.startsWith("address")||e.name.startsWith("address")&&e.name.startsWith(t)}),console.log("icAttributes after splice",r),e.mandatoryAttributes){var a=0;e.passMandatoryCheck=!1,e.missingAttributes=angular.copy(e.mandatoryAttributes);for(var o=0;o<Object.keys(e.mandatoryAttributes).length;o++){var s=Object.keys(e.mandatoryAttributes)[o];if(s.includes("*"))for(var l=0;l<i.length;l++){var c=i[l].name,d=i[l].value,u=s.split("*")[0],p=s.split("*")[1];c.startsWith(u)&&c.endsWith(p)&&d&&(a+=1,delete e.missingAttributes[s])}else for(var f=0;f<i.length;f++){var g=i[f].name,h=i[f].value;g==s&&h&&(a+=1,delete e.missingAttributes[s])}}Object.keys(e.mandatoryAttributes).length===a&&(e.passMandatoryCheck=!0)}}function $(e,t){function n(e){return t==e.name}function r(e){return"address"==e.category}function i(e){return"authDetails"==e.category}return Object.keys(e).reduce(function(a,o){function s(e,a){return(i(e)||r(e)&&!n(t,e))&&!i(e)||(a=a.concat(e.attributes)),a}var l=e[o];return Array.isArray(l)?l.forEach(function(e){return a=s(e,a)}):a=s(l,a),a},[])}function L(t,n){return console.log("changing address info"),e.passMandatoryCheck?r.changePurchaseAddressInfo(t,n,e.addressType).then(function(t){e.success=!0,e.submitting=!1,EV.Event.publish(EV.Event.PM_PURCHASES_CHANGE_ADDRESS_SUCCESS),EV.Event.publish(EV.Event.PM_PURCHASES_LIST_REFRESH)})["catch"](function(t){e.success=!1,e.submitting=!1,console.error(t),EV.Event.publish(EV.Event.PM_ERROR,t),i.handleError(e.errorWidgetGuid,t)}):(console.log("should throw error!",e.mandatoryAttributes),e.showError=!0,e.errors.push({attributes:Object.keys(e.missingAttributes),description:"Missing mandatory attribute(s)"}),void(e.submitting=!1))}function V(t){return e.profileGroups.addresses.find(function(e){return e===t})}function D(t){if(!EV.PM.validateGroup)return t;var n=e.config.billingAddressGroup,r=e.config.deliveryAddressGroup,i=[];for(var a in e.profileGroups){var o=e.profileGroups[a];if(Array.isArray(o))for(var s=0;s<o.length;s++){var l=o[s];if("address"!==l.category||l.name===n||l.name===r){var c=null===l.name||"undefined"==typeof l.name?"":l.name;i.push({groupName:c,categoryName:l.category})}}else if("object"===("undefined"==typeof o?"undefined":H(o))){var d=null===o.name||"undefined"==typeof o.name?"":o.name;i.push({groupName:d,categoryName:o.category})}}return{attributes:t,attributeGroupList:i}}function O(e){return I(e)}function I(e){return e&&e.attributes.every(function(e){return!e.mandatory||e.value})}function N(e){for(var t=0;t<e.error.args.length;t++)e.error.args[0]=R(e.error.args[t])}function R(t){var n=void 0;return e.profileGroups.authDetails.attributes.forEach(function(e){if(e.name===t)return void(n=e.label)}),e.profileGroups.personalDetails.attributes.forEach(function(e){if(e.name===t)return void(n=e.label)}),e.profileGroups.addresses.forEach(function(e){e.attributes.forEach(function(e){if(e.name===t)return void(n=e.label)})}),e.profileGroups.otherDetails.attributes.forEach(function(e){if(e.name===t)return void(n=e.label)}),n}function M(){var t=new RegExp("\\{0\\}","gi");e.formErrors.forEach(function(e){n(e.key).then(function(n){n=n.replace(t,e.attributeList),scope.translatedErrors.push(n),EV.Event.publish("product_profile_error",{error:n,showErrors:!0,widgetId:scope.errorWidgetGuid})})})}function $(e,t){function n(e){return"address"==e.category}function r(e){return"authDetails"==e.category}return Object.keys(e).reduce(function(t,i){function a(e,t){return(r(e)||n(e))&&(t=t.concat(e.attributes)),t}var o=e[i];return Array.isArray(o)?o.forEach(function(e){return t=a(e,t)}):t=a(o,t),t},[])}console.log("$scope in ChangeAddressCtrlss ",e),e.errorWidgetGuid="error-changePurchaseAddress",e.showErrorMsgs=!0,e.showHeader=!0,e.isLoading=!0,e.isAddAddress=!1,e.isEdtAddress=!1,e.loggedIn=EV.util.Storage.cookie.get("ev_ss"),e.formErrors=[],e.referenceDataMap={},e.referenceDataAttributeMap={},e.config={},e.passMandatoryCheck=!0,e.missingAttributes=[],e.errors=[],b(e.purchase.orderItem.product),e.selectCard=function(t){console.log("Selected Address",t),e.errors=[],"BILLING"===e.addressType?e.purchase.billingAddressGroup=t.name:"DELIVERY"===e.addressType&&(e.purchase.deliveryAddressGroup=t.name)},e.isEmptyAddress=function(e){for(var t=0;t<e.attributes.length;t++)if(e.attributes[t].value&&""!==e.attributes[t].value.trim())return!1;return!0},e.isUsedAddress=function(t){return"BILLING"===e.addressType?e.purchase.billingAddressGroup===t:"DELIVERY"===e.addressType?e.purchase.deliveryAddressGroup===t:void 0},e.cancel=function(){t.close(),EV.Event.publish(EV.Event.PM_PURCHASES_CHANGE_ADDRESS_CLOSED,e.purchase.id)},e.submit=function(){console.log("submiting?????"),e.showError=!1,e.stripeErrorMessage="",e.submitting=!0;var t={};"BILLING"===e.addressType?t.billingAddressGroup=e.purchase.billingAddressGroup:"DELIVERY"===e.addressType&&(t.deliveryAddressGroup=e.purchase.deliveryAddressGroup),T(t.billingAddressGroup),L(e.purchase.id,t)},e.editAddress=function(t){e.isEditAddress=!0,e.addressData=V(t),console.log("Updating address",e.addressData)},e.cancelEditAddress=function(){e.isEditAddress=!1,e.submitting=!1},e.addNewAddress=function(){e.isAddAddress=!0,e.newAddressData=e.getNewAddress(),console.log("Adding new address",e.newAddressData)},e.getNewAddress=function(){if(e.profileGroups&&e.profileGroups.addresses)return e.profileGroups.addresses.find(function(t){return!e.populatedAddresses||e.populatedAddresses.indexOf(t)===-1})},e.submitNewAddress=function(t){e.submitting=!0,console.log("Values",e.newAddressData);var n=t?e.addressData:e.newAddressData;if(O(n)){var a=$(e.profileGroups,e.loggedIn),o=a.filter(function(e){return null!==e.value}).map(function(e){return{name:e.name,value:e.value}}),s=e.purchase.orderItem.product.serviceName;r.saveProfile(D(o),s).then(function(){var e=t?EV.Event.PM_PURCHASES_LIST_EDITED_ADDRESS_SUCCESS:EV.Event.PM_PURCHASES_LIST_ADDED_NEW_ADDRESS_SUCCESS;EV.Event.publish(e)})["catch"](function(e){e.error.code&&"ATTRIBUTE_VALIDATION_FAILED"===e.error.code&&N(e),i.handleError(scope.errorWidgetGuid,e),EV.Event.publish(EV.Event.PM_ERROR,{code:"INVALID_FORM",attributes:a}),M()})["finally"](function(){e.submitting=!1,e.isAddAddress=!1,e.isEditAddress=!1,e.newAddressData={},e.addressData={},_(e.profileGroups.addresses)})}},e.cancelNewAddress=function(){e.isAddAddress=!1,e.submitting=!1}}])}function O(){"use strict";var e=angular.module("ev-widget.pm.checkoutDotCom.change-card",[]);e.controller("CheckoutDotComChangeCardCtrl",["$scope","$uibModalInstance","$translate","pm2Util","EVExceptionHandler",function(e,t,n,r,i){function a(t){var n={token:t.cardToken};o(e.purchase.id,n)}function o(t,n){return r.changeCardInfo(t,n).then(function(){e.success=!0,e.submitting=!1,EV.Event.publish(EV.Event.PM_CARD_UPDATED)})["catch"](function(t){e.success=!1,e.submitting=!1,console.error(t),EV.Event.publish(EV.Event.PM_ERROR,t),i.handleError(e.errorWidgetGuid,t),Frames.unblockFields()})}function s(){var e=document.createElement("script");e.src="https://cdn.checkout.com/js/frames.js",e.onload=function(){console.log("Checkout.com ready!"),l()},document.body.appendChild(e)}function l(){Frames.init({publicKey:EV.PM.checkoutDotComPublicKey,containerSelector:"#ev-checkoutdotcom-change-card-form"})}EV.Event.publish(EV.Event.PM_CHANGE_CARD_OPEN,e.purchase.id),e.errorWidgetGuid="error-checkoutdotcom",e.showErrorMsgs=!0,e.showHeader=!0,e.isLoading=!0,e.isAddCard=!1,e.showAddCard=e.$parent.showAddCard;var c=!1;s(),r.retrieveCustomerCards(e.purchase.id).then(function(t){e.cards=t})["catch"](function(t){console.error(t),EV.Event.publish(EV.Event.PM_ERROR,t),i.handleError(e.errorWidgetGuid,t)})["finally"](function(){e.isLoading=!1}),e.selectCard=function(t){e.selectedCard&&document.getElementById("thumbnail-"+e.selectedCard).classList.remove("selected-card"),null!==t&&e.selectedCard!==t?(e.selectedCard=t,document.getElementById("thumbnail-"+t).classList.add("selected-card")):e.selectedCard=null},e.cancel=function(){t.close(),EV.Event.publish(EV.Event.PM_CHANGE_CARD_CLOSE,e.purchase.id)},e.submit=function(){if(e.showError=!1,e.mercadoErrorMessage="",e.submitting=!0,e.selectedCard){var t={card:{id:e.selectedCard,object:"card"}};o(e.purchase.id,t)}else Frames.submitCard().then(a)["catch"](function(t){e.success=!1,e.submitting=!1,t&&(console.error(t),EV.Event.publish(EV.Event.PM_ERROR,t),i.handleError(e.errorWidgetGuid,t))})},e.addCard=function(){e.isAddCard=!0,e.selectCard(null)},e.focusedNewCard=function(t){e.$parent.showAddCard||!c&&t&&(c=!0,e.selectCard(null))}}])}function I(){"use strict";var e=angular.module("ev-widget.pm.editBillingAddress",[]);e.controller("EditBillingAddressCtrl",["$scope","$uibModalInstance","$translate","pm2Util","EVExceptionHandler","$timeout",function(e,t,n,r,i,a){function o(t){t.forEach(function(t){e.referenceDataMap[t.dataName]=t})}function s(t){t.forEach(function(t){t.attributes.forEach(function(t){e.referenceDataAttributeMap[t]=[]})}),t.forEach(function(t){t.attributes.forEach(function(n){e.referenceDataAttributeMap[n].push(t)})})}function l(){var t=angular.copy(EV.WM.referenceData),n={};return e.config.selectedBillingAddress.attributes.forEach(function(e){t.forEach(function(t){t.attributes.includes(e.name)&&!n[e.name]&&(n[e.name]=e)})}),n}function c(t){var n=angular.copy(e.referenceDataAttributeMap);d(t,n)}function d(t,n){Object.keys(n).forEach(function(t){e.config.selectedBillingAddress.attributes.forEach(function(e){if(e.name===t){var r=n[t].find(function(e){return 0==e.linkedFromList.length});r&&(r=u(r),e.options=r.data.values)}})})}function u(e){return e.data.values=e.data.values.map(function(e){return e.caption||(e.caption=e.name,delete e.name),e}),e}function p(t,n){var r=e.config.selectedBillingAddress.attributes.find(function(e){return e.name===n});if(r){var i=e.config.selectedBillingAddress.attributes.findIndex(function(e){return e.name===r.name}),a=u(t);e.config.selectedBillingAddress.attributes[i].options=a.data.values}}function f(t){var n=angular.copy(EV.WM.referenceData),r=n.filter(function(e){return e.attributes.includes(t.name)});if(0!=r.length){var i=null,a=!(null==e.config.selectedBillingAddress||!e.config.selectedBillingAddress.attributes)&&e.config.selectedBillingAddress.attributes.filter(function(e){return e.name===t.name}).length>0,o=!(null==e.config.selectedDeliveryAddress||!e.config.selectedDeliveryAddress.attributes)&&e.config.selectedDeliveryAddress.attributes.filter(function(e){return e.name===t.name}).length>0;if(a){var s=angular.copy(e.config.selectedBillingAddress);i=s.attributes.findIndex(function(e){return e.name===t.name}),s.attributes=s.attributes.slice(i+1),s.attributes.forEach(function(n){return g(t,n.name,e)})}else if(o){var l=angular.copy(e.config.selectedDeliveryAddress);i=l.attributes.findIndex(function(e){return e.name===t.name}),l.attributes=l.attributes.slice(i+1),l.attributes.forEach(function(n){return g(t,n.name,e)})}}}function g(e,t,n){var r=!(null==n.config.selectedBillingAddress||!n.config.selectedBillingAddress.attributes)&&n.config.selectedBillingAddress.attributes.filter(function(t){return t.name===e.name}).length>0,i=!(null==n.config.selectedDeliveryAddress||!n.config.selectedDeliveryAddress.attributes)&&n.config.selectedDeliveryAddress.attributes.filter(function(t){return t.name===e.name}).length>0;angular.copy(EV.WM.referenceData).forEach(function(e){var a=angular.copy(e);0==a.linkedFromList.length&&a.attributes.includes(t)&&(a=u(a),r?n.config.selectedBillingAddress.attributes=n.config.selectedBillingAddress.attributes.map(function(e){return e.name===t&&(e.options=a.data.values,e.value=null),e}):i&&(n.config.selectedDeliveryAddress.attributes=n.config.selectedDeliveryAddress.attributes.map(function(e){return e.name===t&&(e.options=a.data.values,e.value=null),e})))})}function h(t){var n=!(null==e.config.selectedBillingAddress||!e.config.selectedBillingAddress.attributes)&&e.config.selectedBillingAddress.attributes.filter(function(e){return e.name===t.name}).length>0,r=!(null==e.config.selectedDeliveryAddress||!e.config.selectedDeliveryAddress.attributes)&&e.config.selectedDeliveryAddress.attributes.filter(function(e){return e.name===t.name}).length>0,i=EV.WM.referenceData.filter(function(e){if(e.attributes.includes(t.name))return e}),a=(i.map(function(e){return e.data.values}),[]);n?a=e.config.selectedBillingAddress.attributes.find(function(e){return e.name===t.name}):r&&(a=e.config.selectedDeliveryAddress.attributes.find(function(e){return e.name===t.name}));var o=!0;a.options&&a.options.forEach(function(i){if(i.value===t.value&&i&&i.linkedReferenceData){o=!1;var a=EV.WM.referenceData.find(function(e){return e.dataName===i.linkedReferenceData.name});a&&(n?e.config.selectedBillingAddress.attributes=e.config.selectedBillingAddress.attributes.map(function(e){return a.attributes.forEach(function(t){e.name===t&&(e.options=a.data.values)}),e}):r&&(e.config.selectedDeliveryAddress.attributes=e.config.selectedDeliveryAddress.attributes.map(function(e){return a.attributes.forEach(function(t){e.name===t&&(e.options=a.data.values)}),e})))}})}function m(e){e.isChecked?e.options.forEach(function(t){t.value===e.option&&(t.isChecked=!0)}):e.options.forEach(function(t){t.value===e.option&&(t.isChecked=!1)});var t=e.options.filter(function(e){return e.isChecked});return t}function v(e,t,n,r){var i=this,a=angular.copy(EV.WM.referenceData),o=angular.copy(e);e.attributes=e.attributes.filter(function(e){return t.some(function(t){return t.linkedReferenceData.attributes.includes(e.name)})}),e.attributes.forEach(function(e){r.attributes=r.attributes.map(function(n){return n.name===e.name&&(n.options=[],t.forEach(function(e){a.forEach(function(t){e.linkedReferenceData.attributes.includes(n.name)&&e.linkedReferenceData.name===t.dataName&&t.data.values.forEach(function(e){return n.options.push(e)})})})),n})}),o.attributes.forEach(function(e){r.attributes=r.attributes.map(function(n){return n.name===e.name&&0==t.length&&(n.options=[],angular.copy(EV.WM.referenceData).forEach(function(t){var r=angular.copy(t);0==r.linkedFromList.length&&r.attributes.includes(e.name)&&(r=i.replaceNameWithCaption(r),r.data.values.forEach(function(e){return n.options.push(e)}))})),n})})}function b(t){r.getProfileGroups(t.serviceName).then(function(t){e.profileGroups=t,C(),y(),P(),S()})["finally"](function(){e.isLoading=!1,a(function(){k(),EV.Event.publish(EV.Event.PM_PURCHASES_CHANGE_ADDRESS_OPENED,e.purchase.id)},0)})}function y(){if("BILLING"===e.addressType&&e.billingAddressHiddenAttributes){var t=E(e.billingAddressHiddenAttributes);w(t)}if("DELIVERY"===e.addressType&&e.$parent.deliveryAddressHiddenAttributes){var n=E(e.deliveryAddressHiddenAttributes);w(n)}}function E(t){console.log(" Object,keys(attributesToHide)",t);var n=[];return e.profileGroups.addresses.forEach(function(e){e.attributes.forEach(function(e){Object.keys(t).forEach(function(t){if(t.includes("*")){var r=t.split("*")[0],i=t.split("*")[1];e.name&&e.name.startsWith(r)&&e.name.endsWith(i)&&n.push(e.name)}else t===e.name&&n.push(e.name)})})}),console.log("keysToBeRemoved,",n),n}function w(t){t.forEach(function(t){e.profileGroups.addresses.forEach(function(e){e.attributes=e.attributes.filter(function(e){return e.name!=t})})})}function C(){e.config={},e.config.selectedBillingAddress=e.profileGroups.addresses.find(function(t){return t.name===e.$parent.purchase.billingAddressGroup}),e.config.billingAddressHiddenAttributes=JSON.parse(JSON.stringify(e.billingAddressHiddenAttributes)),e.config.selectedDeliveryAddress=e.profileGroups.addresses.find(function(t){return t.name!==e.$parent.purchase.billingAddressGroup}),e.config.deliveryAddressHiddenAttributes=JSON.parse(JSON.stringify(e.deliveryAddressHiddenAttributes)),console.log("$scope=",e)}function S(){EV.Event.on(EV.Event.PROFILE_ATTRIBUTE_CHANGED,function(t){var n=t.attribute,r=t.field;if(e.config&&e.config.selectedBillingAddress&&e.config.selectedBillingAddress.attributes&&!n&&t.value){o(angular.copy(EV.WM.referenceData)),s(angular.copy(EV.WM.referenceData));var i=l();Object.keys(i).forEach(function(e){var t=i[e];c(t)}),Object.keys(i).forEach(function(t){var n=e.referenceDataAttributeMap[t].map(function(e){var n=i[t].value,r=e.data.values.find(function(e){return e.value===n})?e.data.values.find(function(e){return e.value===n}).linkedReferenceData:null;return r}).filter(function(e){return e});n&&n.forEach(function(t){t?t.attributes.forEach(function(n){var r=e.referenceDataAttributeMap[n].find(function(e){return e.dataName===t.name});p(r,n)}):Object.keys(e.referenceDataAttributeMap).forEach(function(t){var n=e.referenceDataAttributeMap[t].find(function(e){return 0==e.linkedFromList.length});p(n,t)})})})}if(n&&"dropdown"===n.type&&"address1_customer_type"!==n.name&&"address2_customer_type"!==n.name&&"customer_type"!==n.name&&(console.log("resetting....",n,r),f(n),h(n)),n&&"checkbox"===n.type){var a=null,d=!(null==e.config.selectedBillingAddress||!e.config.selectedBillingAddress.attributes)&&e.config.selectedBillingAddress.attributes.filter(function(e){return e.name===n.name}).length>0,u=!(null==e.config.selectedDeliveryAddress||!e.config.selectedDeliveryAddress.attributes)&&e.config.selectedDeliveryAddress.attributes.filter(function(e){return e.name===n.name}).length>0;if(d){var g=m(n),b=angular.copy(e.config.selectedBillingAddress);a=b.attributes.findIndex(function(e){return e.name===n.name}),b.attributes=b.attributes.slice(a+1),v(b,g,e,e.config.selectedBillingAddress)}else if(u){var y=m(n),E=angular.copy(e.config.selectedDeliveryAddress);a=E.attributes.findIndex(function(e){return e.name===n.name}),E.attributes=E.attributes.slice(a+1),v(E,y,e,e.config.selectedDeliveryAddress)}}})}function _(t){e.populatedAddresses=t.filter(function(e){return e.attributes.some(function(e){return e.value})})}function P(){e.loggedIn&&!e.showAuthDetails||Object.keys(e.profileGroups).forEach(function(t){if("authDetails"!==t){var n=e.profileGroups[t];n instanceof Array?n.forEach(function(n){e.profileGroups[t].attributes=A(n.attributes||[])}):e.profileGroups[t].attributes=A(n&&n.attributes||[])}})}function A(t){var n=[];return t.forEach(function(t){e.profileGroups.authDetails.attributes.find(function(e){return e.name===t.name})||n.push(t)}),n}function k(){var e=0,t=document.querySelectorAll('[id^="thumbnail-card-address-"]');Array.prototype.map.call(t,function(t){t.clientHeight>e&&(e=t.clientHeight)});for(var n=0;n<t.length;n++)t[n].style.minHeight=e+"px"}function T(t,n){return console.log("editing billing address"),r.changePurchaseAddressInfo(t,n,e.addressType).then(function(t){e.success=!0,e.submitting=!1,EV.Event.publish(EV.Event.PM_PURCHASES_CHANGE_ADDRESS_SUCCESS),EV.Event.publish(EV.Event.PM_PURCHASES_LIST_REFRESH),console.log("publish EV.Event.PM_PURCHASES_LIST_EDITED_ADDRESS_SUCCESS",t),EV.Event.publish(EV.Event.PM_PURCHASES_LIST_EDITED_ADDRESS_SUCCESS,t)})["catch"](function(t){e.success=!1,e.submitting=!1,console.error(t),EV.Event.publish(EV.Event.PM_ERROR,t),i.handleError(e.errorWidgetGuid,t)})}function $(t){return e.profileGroups.addresses.find(function(e){return e===t})}function L(){if(e.mandatoryAttributes)for(var t in e.mandatoryAttributes)t.includes("*")&&!function(){var n=t.replace("*",e.addressData.name.slice(-1));e.mandatoryAttributes[n]=e.mandatoryAttributes[t],delete e.mandatoryAttributes[t],e.addressData.attributes.forEach(function(e){e.name==n&&(e.mandatory=!0)})}()}function V(e){return D(e)}function D(e){return e&&e.attributes.every(function(e){return!e.mandatory||e.value})}function O(e){for(var t=0;t<e.error.args.length;t++)e.error.args[0]=I(e.error.args[t])}function I(t){var n=void 0;return e.profileGroups.authDetails.attributes.forEach(function(e){if(e.name===t)return void(n=e.label)}),e.profileGroups.personalDetails.attributes.forEach(function(e){if(e.name===t)return void(n=e.label)}),e.profileGroups.addresses.forEach(function(e){e.attributes.forEach(function(e){if(e.name===t)return void(n=e.label)})}),e.profileGroups.otherDetails.attributes.forEach(function(e){if(e.name===t)return void(n=e.label)}),n}function N(){var t=new RegExp("\\{0\\}","gi");e.formErrors.forEach(function(e){n(e.key).then(function(n){n=n.replace(t,e.attributeList),scope.translatedErrors.push(n),EV.Event.publish("product_profile_error",{error:n,showErrors:!0,widgetId:scope.errorWidgetGuid})})})}function R(e,t){function n(e){return"address"==e.category}function r(e){return"authDetails"==e.category}return Object.keys(e).reduce(function(t,i){function a(e,t){return(r(e)||n(e))&&(t=t.concat(e.attributes)),t}var o=e[i];return Array.isArray(o)?o.forEach(function(e){return t=a(e,t)}):t=a(o,t),t},[])}console.log("$scope in editBillingAddressss ",e),e.errorWidgetGuid="error-changePurchaseAddress",e.showErrorMsgs=!0,e.showHeader=!0,e.isLoading=!0,e.isAddAddress=!1,e.isEdtAddress=!1,e.loggedIn=EV.util.Storage.cookie.get("ev_ss"),e.formErrors=[],e.referenceDataMap={},e.referenceDataAttributeMap={},e.config={},e.errors=[],b(e.purchase.orderItem.product),e.selectCard=function(t){console.log("Selected Address",t),"BILLING"===e.addressType?e.purchase.billingAddressGroup=t.name:"DELIVERY"===e.addressType&&(e.purchase.deliveryAddressGroup=t.name),e.submit()},e.isEmptyAddress=function(e){for(var t=0;t<e.attributes.length;t++)if(e.attributes[t].value&&""!==e.attributes[t].value.trim())return!1;return!0},e.isUsedAddress=function(t){return"BILLING"===e.addressType?e.purchase.billingAddressGroup===t:"DELIVERY"===e.addressType?e.purchase.deliveryAddressGroup===t:void 0},e.cancel=function(){t.close(),EV.Event.publish(EV.Event.PM_PURCHASES_CHANGE_ADDRESS_CLOSED,e.purchase.id)},e.submit=function(){e.showError=!1,e.stripeErrorMessage="",e.submitting=!0;var t={};"BILLING"===e.addressType?t.billingAddressGroup=e.purchase.billingAddressGroup:"DELIVERY"===e.addressType&&(t.deliveryAddressGroup=e.purchase.deliveryAddressGroup),T(e.purchase.id,t)},e.editAddress=function(t){e.isEditAddress=!0,e.addressData=$(t),console.log("Updating address",e.addressData)},e.cancelEditAddress=function(){e.isEditAddress=!1,e.submitting=!1},e.addNewAddress=function(){e.isAddAddress=!0,e.newAddressData=e.getNewAddress(),console.log("Adding new address",e.newAddressData)},e.getNewAddress=function(){if(e.profileGroups&&e.profileGroups.addresses)return e.profileGroups.addresses.find(function(t){return!e.populatedAddresses||e.populatedAddresses.indexOf(t)===-1})},e.submitNewAddress=function(t){e.submitting=!0;var n=t?e.addressData:e.newAddressData;if(L(),console.log("Values",n),V(n)||(e.submitting=!1,e.showError=!0,e.showErrorMsgs=!0,e.errors.push({attributes:Object.keys(e.mandatoryAttributes),description:"Missing mandatory attribute(s)"})),V(n)){var a=R(e.profileGroups,e.loggedIn),o=a.filter(function(e){return null!==e.value}).map(function(e){return{name:e.name,value:e.value}}),s=e.purchase.orderItem.product.serviceName;r.saveProfile(o,s).then(function(){var e=t?EV.Event.PM_PURCHASES_LIST_EDITED_ADDRESS_SUCCESS:EV.Event.PM_PURCHASES_LIST_ADDED_NEW_ADDRESS_SUCCESS;EV.Event.publish(e)})["catch"](function(e){e.error.code&&"ATTRIBUTE_VALIDATION_FAILED"===e.error.code&&O(e),i.handleError(scope.errorWidgetGuid,e),EV.Event.publish(EV.Event.PM_ERROR,{code:"INVALID_FORM",attributes:a}),N()})["finally"](function(){e.submitting=!1,e.isAddAddress=!1,e.isEditAddress=!1,e.newAddressData={},e.addressData={},_(e.profileGroups.addresses),e.submit()})}},e.cancelNewAddress=function(){e.isAddAddress=!1,
e.submitting=!1}}])}function N(){"use strict";var e=angular.module("ev-widget.pm.cancelPurchase",[]);e.config(["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}]),e.directive("evCancelPurchase",[function(){return{restrict:"E",scope:{},template:"<!-- modal popup -->",controller:["$scope","EVExceptionHandler","$uibModal","pm2Util","$sce",function(e,t,n,r,i){function a(t){for(var n=0;n<e.purchases.length;n++)if(e.purchases[n].id===t)return e.purchases[n]}function o(){return"ev-widget.pm.cancelPurchase-"+EV.util.random_guid()}function s(o){o.paymentPlan||(o=a(o.id));var s=e.$new(!0);s.purchase=o,s.cancelReasons=e.cancelReasons,s.hasCancelReasons=s.cancelReasons&&s.cancelReasons.length>0,s.scope=s,n.open({templateUrl:"pm-v2/purchases-list-fragments/ev-cancel-purchase-confirm.tpl.html",openedClass:"ev-modals modal-open",windowClass:"ev ev-open-modal-cancel-purchase",keyboard:!0,backdrop:!0,scope:s,controller:["$scope","$uibModalInstance","$timeout",function(e,n,a){EV.Event.publish(EV.Event.PM_CANCEL_PURCHASE_OPEN,o.id),r.getRetentionDiscounts(o.paymentPlan.id).then(function(t){e.offers=t.retentionDiscounts||[],e.hasOffers=e.offers.length>0}),s.errorWidgetGuid="error-cancel-purchase",e.submitted=!1,e.cancelling=!1,e.selectedReason=null,e.showConfirmCancellationBtn=!s.hasCancelReasons,e.showCancelReasonActions=!1,e.selectedPurchase=o,e.showOffers=!1,e.showOfferPrice=!1,e.selectedOffer=null,e.selectOffer=function(t){if(e.selectedOffer){var n=document.getElementById("offer-"+e.selectedOffer.id);n.classList.remove("offer-selected")}e.selectedOffer=t;var r=document.getElementById("offer-"+t.id);r.classList.add("offer-selected")},e.applyOffer=function(){e.applyingOffer=!0,e.submitted=!0,r.applyOffer(o.id,e.selectedOffer.id).then(function(){e.offerSuccess=!0,EV.Event.publish(EV.Event.PM_OFFER_APPLY_SUCCESS,{}),EV.Event.publish("pm.initPurchasesList")})["catch"](function(e){console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(s.errorWidgetGuid,e)})["finally"](function(){e.applyingOffer=!1})},e.selectCancelReason=function(){null!=e.selectedReason?(e.showConfirmCancellationBtn=e.selectedReason.showConfirmCancelButton,e.showCancelReasonActions=!0,e.showOffers=e.selectedReason.showOffersEnabled,e.showOfferPrice=e.selectedReason.showOfferPrice,e.offers.length>0&&a(function(){e.selectOffer(e.offers[0])},0)):(e.showConfirmCancellationBtn=!s.hasCancelReasons,e.showCancelReasonActions=!1,e.showOffers=!1)},e.displayPrice=function(e){var t=o.orderItem.paymentPlan;t.discount=e;var n;return n=0===t.discount.period.numberOfDays?r.calculateFinalPrice(t,null):r.calculateTrialPrice(t,null)},e.renderHtml=function(e){return i.trustAsHtml(e)},e.close=function(){n.close(),EV.Event.publish(EV.Event.PM_CANCEL_PURCHASE_CLOSE,o.id)},e.confirm=function(n){e.cancelling=!0,e.submitted=!0;var i=e.selectedReason?e.selectedReason.id:null;r.cancelPurchase(o.id,n,i).then(function(){e.success=!0,EV.Event.publish(EV.Event.PM_PURCHASE_CANCELLED),EV.Event.publish("pm.initPurchasesList")})["catch"](function(e){console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(s.errorWidgetGuid,e)})["finally"](function(){e.cancelling=!1})}}]})}e.widgetGuid=o(),e.errorWidgetGuid="error-"+e.widgetGuid,EV.Event.on("pm.cancelPurchase",function(t){e.purchases=t.purchases,e.cancelReasons=t.cancelReasons,s(t.purchase,t.cancelReasons)})}]}}])}function R(){"use strict";var e=angular.module("ev-widget.pm.changeCard",[]);e.config(["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}]),e.directive("evChangeCard",[function(){return{restrict:"E",scope:{},template:"<!-- modal popup -->",controller:["$scope","$uibModal","pm2Util",function(e,t,n){function r(){return"ev-widget.pm.changeCard-"+EV.util.random_guid()}function i(r){function i(){t.open({templateUrl:"pm-v2/purchases-list-fragments/ev-change-paystack-card.tpl.html",openedClass:"ev-modals modal-open",windowClass:"ev ev-open-modal-change-card",size:"lg",keyboard:!0,backdrop:!0,scope:l,controller:"PaystackChangeCardCtrl"})}function a(){t.open({templateUrl:"pm-v2/purchases-list-fragments/ev-change-checkoutdotcom-card.tpl.html",openedClass:"ev-modals modal-open",windowClass:"ev ev-open-modal-change-card",size:"lg",keyboard:!0,backdrop:!0,scope:l,controller:"CheckoutDotComChangeCardCtrl"})}function o(){t.open({templateUrl:"pm-v2/purchases-list-fragments/ev-change-mercado-card.tpl.html",openedClass:"ev-modals modal-open",windowClass:"ev ev-open-modal-change-card",size:"lg",keyboard:!0,backdrop:!0,scope:l,controller:["$scope","$uibModalInstance",function(e,t){function i(){for(var e=["cardNumber","securityCode","cardExpirationMonth","cardExpirationYear","cardholderName","docType","docNumber"],t=0;t<e.length;t++)document.getElementById(e[t]).value=""}function a(e,t){if(200!=e&&201!=e&&t.error)l.showError=!0,t.cause.length>0?u(t.cause[0]):l.mercadoErrorMessage=t.message,l.submitting=!1,EV.Event.publish(EV.Event.PM_ERROR,t.message);else{var n={token:{response:t}};o(l.purchase.id,n)}}function o(e,t){return n.changeCardInfo(e,t).then(function(){l.success=!0,l.submitting=!1,EV.Event.publish(EV.Event.PM_CARD_UPDATED)})["catch"](function(e){l.success=!1,l.submitting=!1,console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),EVExceptionHandler.handleError(l.errorWidgetGuid,e)})}function s(e){return null!=e&&""!=e.trim()&&(3==e.length||4==e.length)&&d(e)}function c(e,t){return e.length<=t}function d(e){return/^\d+$/.test(e)}function u(e){var t="ev.widgets.mercado.error."+e.code;$translate(t).then(function(e){l.mercadoErrorMessage=e})["catch"](function(e){$translate("ev.widgets.mercado.error.default").then(function(e){l.mercadoErrorMessage=e})})}function p(){var e=document.createElement("script");e.src="https://secure.mlstatic.com/sdk/javascript/v1/mercadopago.js",e.onload=function(){console.log("Mercado ready!"),f()},document.body.appendChild(e)}function f(){var e=document.querySelectorAll(".mercado-payment .input");Array.prototype.forEach.call(e,function(e){e.addEventListener("focus",function(){e.classList.add("focused")}),e.addEventListener("blur",function(){e.classList.remove("focused")}),e.addEventListener("keyup",function(){0===e.value.length?e.classList.add("empty"):e.classList.remove("empty")})}),Mercadopago.setPublishableKey(EV.PM.mercadoKey),Mercadopago.getIdentificationTypes()}EV.Event.publish(EV.Event.PM_CHANGE_CARD_OPEN,r.id),l.errorWidgetGuid="error-mercado",l.showErrorMsgs=!0,l.showHeader=!0,l.isLoading=!0,l.isAddCard=!1,l.showAddCard=l.$parent.showAddCard;var g=!1;p(),n.retrieveCustomerCards(r.id).then(function(e){l.cards=e})["catch"](function(e){console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),EVExceptionHandler.handleError(l.errorWidgetGuid,e)})["finally"](function(){l.isLoading=!1}),e.selectedCard=function(e){l.selectedCard&&(g=!1,i(),document.getElementById("thumbnail-"+l.selectedCard).classList.remove("selected-card")),null!==e&&l.selectedCard!==e?(g=!1,i(),l.selectedCard=e,document.getElementById("thumbnail-"+e).classList.add("selected-card")):l.selectedCard=null},e.cancel=function(){t.close(),EV.Event.publish(EV.Event.PM_CHANGE_CARD_CLOSE,r.id)},e.submit=function(){l.showError=!1,l.mercadoErrorMessage="",l.submitting=!0;var e=document.querySelector("#pay");if(l.selectedCard){var t={card:{id:l.selectedCard,object:"card"}};o(l.purchase.id,t)}else{var n=e.elements.securityCode.value;if(!s(n)){l.showError=!0;var r="securityCode";return u({code:r}),l.submitting=!1,void EV.Event.publish(EV.Event.PM_ERROR,"invalid parameters")}var i=e.elements.docNumber.value,p=e.elements.docType.value;if(!d(i)&&"Otro"===p)return l.showError=!0,u({code:"docNumberAlphaNum"}),l.submitting=!1,void EV.Event.publish(EV.Event.PM_ERROR,"invalid parameters");if("Otro"===p&&!c(i,8))return l.showError=!0,u({code:"docNumberLength"}),l.submitting=!1,void EV.Event.publish(EV.Event.PM_ERROR,"invalid parameters");if("Otro"!==p&&!c(i,8))return l.showError=!0,u({code:"docNumberLength"}),l.submitting=!1,void EV.Event.publish(EV.Event.PM_ERROR,"invalid parameters");Mercadopago.createToken(e,a)}},e.addCard=function(){l.isAddCard=!0,e.selectedCard(null)},e.focusedNewCard=function(t){l.$parent.showAddCard||!g&&t&&(g=!0,e.selectedCard(null))}}]})}function s(){t.open({templateUrl:"pm-v2/purchases-list-fragments/ev-change-stripe-card.tpl.html",openedClass:"ev-modals modal-open",windowClass:"ev ev-open-modal-change-card",size:"lg",keyboard:!0,backdrop:!0,scope:l,controller:"StripeChangeCardCtrl"})}var l=e.$new(!0);l.scope=l,l.purchase=r,l.errorMessage="",n.getProviderByPaymentType(r.paymentType).then(function(e){switch(l.providerName=e.providerName,l.providerName){case"MERCADO":o();break;case"STRIPE":s();break;case"CHECKOUTDOTCOM":a();break;case"PAYSTACK":i()}})["catch"](function(e){console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),EVExceptionHandler.handleError(l.errorWidgetGuid,e)})}e.widgetGuid=r(),e.errorWidgetGuid="error-"+e.widgetGuid,EV.Event.on("pm.changeCard",function(e){i(e)})}]}}])}function M(){"use strict";var e=angular.module("ev-widget.pm.changeProductPlan",[]);e.config(["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}]),e.directive("evChangeProductPlan",[function(){return{restrict:"E",scope:{},template:"<!-- modal popup -->",controller:["$scope","EVExceptionHandler","$uibModal","pm2Util",function(e,t,n,r){function i(){return"ev-widget.pm.changeProductPlan-"+EV.util.random_guid()}function a(i){var a=e.$new(!0);a.purchase=i,a.scope=a,n.open({templateUrl:"pm-v2/purchases-list-fragments/ev-change-product-plan.tpl.html",openedClass:"ev-modals modal-open",windowClass:"ev ev-open-modal-change-product-plan",keyboard:!0,backdrop:!0,scope:a,controller:["$scope","$uibModalInstance",function(e,n){function o(t){if(e.selectedProduct){var n=document.getElementById("product-"+e.selectedProduct.id);n.classList.remove("change-product-plan-selected")}e.selectedProduct=t;var r=document.getElementById("product-"+t.id);r.classList.add("change-product-plan-selected"),s()}function s(){e.alternativePlans=[];var t=null!=e.selectedProduct.changePlans&&e.selectedProduct.changePlans.length>0?e.selectedProduct.changePlans:e.selectedProduct.paymentPlans;Array.prototype.push.apply(e.alternativePlans,t)}function l(){e.order={id:null,orderItems:[],paymentType:e.purchase.paymentType,deliveryAddressGroup:e.purchase.deliveryAddressGroup||null,billingAddressGroup:e.purchase.billingAddressGroup||null,createdDate:null,lastModifiedDate:null,version:null,orderType:e.purchase.orderType},e.order.orderItems.push({product:e.selectedProduct,paymentPlan:e.selectedPlan,quantity:e.purchase.orderItem.quantity,startDate:null,endDate:null,startDeliveryDate:null})}a.errorWidgetGuid="error-change-product-plan",e.submitted=!1,e.upgrading=!1,e.showConfirmChangeBtn=!0;var c=i.orderItem.product;e.alternativeProducts=[],r.getChangeProductsAndPlans(c.id).then(function(t){Array.prototype.push.apply(e.alternativeProducts,t.changeProducts);var n=c;n.changePlans=t.changePlans,e.alternativeProducts.push(n)}),e.selectProduct=o,e.selectPlan=function(t){if(e.selectedPlan){var n=document.getElementById("plan-"+e.selectedPlan.id);n.classList.remove("change-product-plan-selected")}e.selectedPlan=t;var r=document.getElementById("plan-"+t.id);r.classList.add("change-product-plan-selected")},e.close=function(){n.close()},e.confirm=function(){e.upgrading=!0,e.submitted=!0,e.showConfirmChangeBtn=!1,l(),r.changeProductPlan(e.purchase.id,e.order).then(function(){e.success=!0,_()})["catch"](function(e){console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(a.errorWidgetGuid,e)}).then(function(){e.upgrading=!1})}}]})}e.widgetGuid=i(),e.errorWidgetGuid="error-"+e.widgetGuid,EV.Event.on("pm.changeProductPlan",function(e){a(e)})}]}}])}function x(){"use strict";var e=angular.module("ev-widget.pm.generateQRAccessCode",[]);e.config(["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}]),e.directive("evGenerateQrCode",[function(){return{restrict:"E",scope:{},template:"<!-- modal popup -->",controller:["$scope","$uibModal","pm2Util",function(e,t,n){function r(){return"ev-widget.pm.generateQRAccessCode-"+EV.util.random_guid()}function i(r){t.open({templateUrl:"pm-v2/purchases-list-fragments/ev-generate-qr-code.tpl.html",openedClass:"ev-modals modal-open",windowClass:"ev ev-open-modal-qr-accesscode",keyboard:!0,backdrop:!0,scope:e,controller:["$scope","EVExceptionHandler","$uibModalInstance",function(t,i,a){t.close=function(){a.close()},t.showCode=!1,n.generateQRAccessCode(r.id).then(function(e){console.log(e),t.image=e.data,t.showCode=!0})["catch"](function(t){console.error(t),EV.Event.publish(EV.Event.PM_ERROR,t),i.handleError(e.errorWidgetGuid,t)})}]})}e.widgetGuid=r(),e.errorWidgetGuid="error-"+e.widgetGuid,EV.Event.on("pm.generateQRAccessCode",function(e){i(e)})}]}}])}function F(){"use strict";var e=angular.module("ev-widget.pm.revertCancellation",[]);e.config(["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}]),e.directive("evRevertCancellation",[function(){return{restrict:"E",scope:{},template:"<!-- modal popup -->",controller:["$scope","$uibModal","pm2Util",function(e,t,n){function r(){return"ev-widget.pm.revertCancel-"+EV.util.random_guid()}function i(r){t.open({templateUrl:"pm-v2/purchases-list-fragments/ev-revert-cancellation.tpl.html",openedClass:"ev-modals modal-open",windowClass:"ev ev-open-modal-cancel-purchase",keyboard:!0,backdrop:!0,scope:e,controller:["$scope","EVExceptionHandler","$uibModalInstance",function(e,t,i){e.submitted=!1,e.reverting=!1,e.close=function(){i.close()},e.confirm=function(){e.submitted=!0,e.reverting=!0,n.revertCancellation(r.id).then(function(){e.success=!0,EV.Event.publish("pm.initPurchasesList")})["catch"](function(e){console.error(e),EV.Event.publish(EV.Event.PM_ERROR,e),t.handleError(scope.errorWidgetGuid,e)})["finally"](function(){e.reverting=!1})}}]})}e.widgetGuid=r(),e.errorWidgetGuid="error-"+e.widgetGuid,EV.Event.on("pm.revertCancellation",function(e){i(e)})}]}}])}function U(){"use strict";var e=angular.module("ev-widget.pm.paystack.change-card",[]);e.controller("PaystackChangeCardCtrl",["$scope","$uibModalInstance","$translate","pm2Util","EVExceptionHandler",function(e,t,n,r,i){function a(t){var n={requiresRefund:!0,paystack_reference:t.reference};o(e.purchase.id,n)}function o(t,n){return r.changeCardInfo(t,n).then(function(){e.success=!0,e.submitting=!1,EV.Event.publish(EV.Event.PM_CARD_UPDATED)})["catch"](function(t){e.success=!1,e.submitting=!1,console.error(t),EV.Event.publish(EV.Event.PM_ERROR,t),i.handleError(e.errorWidgetGuid,t)})}function s(){var e=document.createElement("script");e.src="https://js.paystack.co/v1/inline.js",e.onload=function(){console.log("Paystack ready!")},document.body.appendChild(e)}EV.Event.publish(EV.Event.PM_CHANGE_CARD_OPEN,e.purchase.id),e.errorWidgetGuid="error-paystack",e.showErrorMsgs=!0,e.showHeader=!0,e.isLoading=!0,e.showAddCard=e.$parent.showAddCard;var l=!1;s(),r.retrieveCustomerCards(e.purchase.id).then(function(t){e.cards=t})["catch"](function(t){console.error(t),EV.Event.publish(EV.Event.PM_ERROR,t),i.handleError(e.errorWidgetGuid,t)})["finally"](function(){e.isLoading=!1}),e.selectCard=function(t){e.selectedCard&&document.getElementById("thumbnail-"+e.selectedCard).classList.remove("selected-card"),null!==t&&e.selectedCard!==t?(e.selectedCard=t,document.getElementById("thumbnail-"+t).classList.add("selected-card")):e.selectedCard=null},e.cancel=function(){t.close(),EV.Event.publish(EV.Event.PM_CHANGE_CARD_CLOSE,e.purchase.id)},e.submit=function(){if(e.showError=!1,e.mercadoErrorMessage="",e.submitting=!0,e.selectedCard){var t={card:{id:e.selectedCard,object:"card"}};o(e.purchase.id,t)}else r.preChangeCard(e.purchase.id).then(function(t){var n={key:EV.PM.paystackPublicKey,callback:a,onClose:function(){e.$apply(function(){console.log("Modal closed"),e.submitting=!1})}};n=Object.assign(n,t.data);var r=PaystackPop.setup(n);r.openIframe()})["catch"](function(t){e.success=!1,e.submitting=!1,t&&(console.error(t),EV.Event.publish(EV.Event.PM_ERROR,t),i.handleError(e.errorWidgetGuid,t))})},e.addCard=function(){e.selectCard(null),e.submit()},e.focusedNewCard=function(t){e.$parent.showAddCard||!l&&t&&(l=!0,e.selectCard(null))}}])}function G(){"use strict";var e=angular.module("ev-widget.pm.stripe.change-card",[]);e.controller("StripeChangeCardCtrl",["$scope","$uibModalInstance","$translate","pm2Util","EVExceptionHandler",function(e,t,n,r,i){function a(t,n){return r.changeCardInfo(t,n).then(function(){e.success=!0,e.submitting=!1,EV.Event.publish(EV.Event.PM_CARD_UPDATED),EV.Event.publish(EV.Event.PM_PURCHASES_LIST_REFRESH)})["catch"](function(t){e.success=!1,e.submitting=!1,console.error(t),EV.Event.publish(EV.Event.PM_ERROR,t),i.handleError(e.errorWidgetGuid,t)})}function o(){var e=document.createElement("script");e.src="https://js.stripe.com/v3/",e.onload=function(){console.log("Stripe ready!"),s()},document.body.appendChild(e)}function s(){i.removeError(e.errorWidgetGuid),c=Stripe(EV.PM.stripeKey),d=c.elements({fonts:[{cssSrc:"https://fonts.googleapis.com/css?family=Source+Code+Pro"}],l