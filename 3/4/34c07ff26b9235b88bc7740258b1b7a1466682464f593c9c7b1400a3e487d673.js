"use strict";window.isIE9=-1!==window.navigator.userAgent.indexOf("MSIE 9.0");var searchFormModule=angular.module("SearchFormServiceUI",[]);angular.module("SearchFormServiceUI").controller("SearchFormCtrl",["$scope","$window","$timeout","queryParamCollection","sfsDataModelProvider","userPreferences",function(e,t,n,a,r,i){function o(e){var t=e.metadata.form.dataFieldId;if(1===$("#sfsDataStorage").length){var n=l();return n&&n[t]?JSON.parse(n[t]):null}var a=$("#"+t).val();return a?JSON.parse(a):null}function l(){var e=$("#sfsDataStorage").val();return e?JSON.parse(e):null}function s(){!0===e.model.isExactAllEnabled&&e.$root.$broadcast("toggleMatchAllTermsExactly",e.model.isExactAllEnabled,e.domPrefix),e.$root.$broadcast("modelLoaded",e.model,e.domPrefix)}e.sfsData={},e.model=null,e.resetSearch=function(){},t.ancestry&&t.ancestry.search&&(t.ancestry.search.resetSearch=e.resetSearch),e.init=function(n){e.sfsData=t[n+"sfsData"],e.domPrefix=n,e.model=r.getDataModel(n),e.originalModel=$.extend(!0,{},r.getDataModel(n)),e.metadata=r.getMetadata(n),i.updateMetadataDefaults(n);if(!(o(e)||t.performance&&2===t.performance.navigation.type)){var l=a.getFormData(e.domPrefix);r.populateFromData(n,l,"onload",()}},e.loadFromPreviousState=function(){var t=o(e);t&&(r.resetData(e.domPrefix),e.model.types.photos=!1,e.model.types.records=!1,e.model.types.stories=!1,e.model.types.trees=!1,n((function(){$.extend(!0,e.model,t.dataModel),s()}),1))},e.saveFormState=function(){var t=$.extend(!0,{},e.model);t.showUnviewedRecordsOnly&&delete t.showUnviewedRecordsOnly;var n=JSON.stringify({dataModel:t,viewModel:{}}),a=e.metadata.form.dataFieldId;if(1===$("#sfsDataStorage").length){var r=l()||{};r[a]=n,$("#sfsDataStorage").val(JSON.stringify(r))}else $("#"+a).val(n)},e.$on("clearFormEvent",(),e.$on("personPickerUpdated",(function(t,n){if(e.domPrefix===n){var i=a.getPersonPickerParams();r.populateFromData(n,i,"personPicker")}})),e.$on("toggleMatchAllTermsExactly",(function(t,n,a){e.domPrefix===a&&r.matchAllTermsExactly(a,n)})),e.$on("toggleShowUnviewedRecordsOnly",(),e.$on("resetMatchAllTermsExactly",(function(t,n){n===e.domPrefix&&(e.model.isExactAllEnabled=!1)}))}]),angular.module("SearchFormServiceUI").directive("sfsHistoryBack",["$window","$parse",function(e,t){return{restrict:"A",link:function(n,a,r){var i=t(r.sfsHistoryBack),o=!1;.performance&&2===e.performance.navigation.type&&(i(n),o=!0),$(e).on("pageshow",(function(t){var a=t.originalEvent.persisted||e.performance&&2===e.performance.navigation.type;/^((?!chrome|android).)*safari/i.test(navigator.userAgent)&&a?e.setTimeout((function(){n.$apply((function(){i(n)})),o=!0}),10):!o&&a&&(n.$apply((function(){i(n)})),o=!0)})),$(e).on("beforeunload",l),$(e).on("pagehide",l)}}}]),angular.module("SearchFormServiceUI").directive("sfsBeforeUnload",["$window","$parse",function(e,t){return{restrict:"A",link:function(n,a,r){var i=t(r.sfsBeforeUnload),o=!1;function l(){o||(n.$apply((),o=!0)}$(e).on("beforeunload",l),$(e).on("pagehide",l),$(e).on("pageshow",(function(){o=!1}))}}}]),angular.module("SearchFormServiceUI").controller("AdvancedPanelCtrl",["$scope",function(e){e.switchView=]),angular.module("SearchFormServiceUI").controller("EventController",["$scope","sfsDataModelProvider",function(e,t){e.event=null,e.init=]),angular.module("SearchFormServiceUI").controller("MSAVController",["$scope",function(e){e.getMSAV=function(){return e.model.isExactAllEnabled&&e.model.isShowMoreOptionsExpanded?2:!e.model.isExactAllEnabled&&e.model.isShowMoreOptionsExpanded?1:e.model.isExactAllEnabled&&!e.model.isShowMoreOptionsExpanded?-1:0}}]),angular.module("SearchFormServiceUI").controller("MatchAllTermsExactlyModuleController",["$scope",function(e){e.checkBoxChanged=function(){e.$root.$broadcast("toggleMatchAllTermsExactly",!e.model.isExactAllEnabled,e.domPrefix)}}]),angular.module("SearchFormServiceUI").service("urlCanonicalizerProvider",[),angular.module("SearchFormServiceUI").service("nodeObjectHashProvider",[function(){return{getHasher:}]),angular.module("SearchFormServiceUI").controller("CategoryBucketCtrl",["$scope","sfsDataModelProvider",function(e,t){var n=e.sfsData.categoryBucket.alertMessage;e.getSubmitValue=e.categoryBucketChanged=function(t){""===e.getSubmitValue()&&(e.model.types[t]=!0,alert(n))}}]),angular.module("SearchFormServiceUI").controller("CollectionFocusModuleController",["$rootScope","$scope","$window","queryParamCollection",function(e,t,n,a){t.collectionFocusList=[{group:null,name:"All Collections",value:"0",groupName:null,gpids:null,location:null}],t.searchBlock="0";var r=n[t.domPrefix+"ScopeMetadata"];t.showsplitnew=!0;var i=r.collectionFocus.items,o=null!=window.splitExperiments?window.splitExperiments["international-optimization"]:"off";t.collectionFocusList=$.map(i,(function(e){return"1"!==e.id||"on"===o?{value:e.id,name:e.localizedName,group:e.group,groupName:e.weightGroupName,location:e.location,gpids:e.locationGpids}:void 0})),t.updateCollectionFocus=function(){var n=$.grep(t.collectionFocusList,(function(e){return e.value===t.searchBlock}))[0];t.model.location=[],t.model.location=n.gpids,t.model.priority=n.groupName||"",e.$broadcast("collectionFocusChanged",t.model)},t.$watch("model.priority",(function(){var e=t.model.priority;"object"==typeof t.model.priority&&(e=Object.values(e).join(""));var n=$.grep(t.collectionFocusList,()[0];n?t.searchBlock=n.value:(t.searchBlock="0",t.updateCollectionFocus())}))}]),angular.module("SearchFormServiceUI").controller("ContentBasedFormCtrl",["$scope","$window","sfsCookies","userPreferences",function(e,t,n,a){function r(){var e=n.get("VARSESSION")||"";if(-1===e.indexOf("NovaS=1")){e.length>0&&(e+="&"),e="VARSESSION="+e+"NovaS=1";var a,r,i=(a=t.location.hostname,(r=a.indexOf("."))>0?a.substring(r,a.length):"");i&&(e+=";domain="+i),n.set("VARSESSION",e,7300)}}e.showLicensePage=!1,e.initLicensePage=function(n){e.showLicensePage=!0;try{window.ancestry&&window.ancestry.search&&(window.ancestry.search.newSliderEditForm&&"on"==window.ancestry.search.newSliderEditForm||window.ancestry.search.facetData&&window.ancestry.search.facetData.isCollectionResults&&!0===window.ancestry.search.facetData.isCollectionResults)?e.showLicensePage=!1:e.showLicensePage=-1==$.inArray(n,t.Ancestry.SFS.Settings.AcceptedDbLicenses)}catch(e){}},e.hideLicensePage=e.$on("personPickerUpdated",(function(n,a){e.showUnviewedRecordsOnly=t&&t.ancestry&&t.ancestry.search&&t.ancestry.search.globalSearchformMetadata&&t.ancestry.search.globalSearchformMetadata.authorizedFeatures&&"allow"===t.ancestry.search.globalSearchformMetadata.authorizedFeatures.unviewedRecordsFilter})),e.showUnviewedRecordsOnly=t&&t.ancestry&&t.ancestry.search&&t.ancestry.search.globalSearchformMetadata&&t.ancestry.search.globalSearchformMetadata.authorizedFeatures&&"allow"===t.ancestry.search.globalSearchformMetadata.authorizedFeatures.unviewedRecordsFilter&&e.model.treePerson&&e.model.treePerson.treeId&&e.model.treePerson.personId,e.toggleShowUnviewedRecordsOnly=function(){e.$root.$broadcast("toggleShowUnviewedRecordsOnly",!e.model.showUnviewedRecordsOnly,e.domPrefix)}}]),angular.module("SearchFormServiceUI").controller("DayModuleCtrl",["$scope","sfsDataModelProvider",function(e,t){e.searchKey="",e.day="unselected",e.event=null,e.init=function(n,a,r){e.searchKey=r,e.event=t.getEvent(e.domPrefix,n)},e.updateDay=function(){var t="unselected"===e.day?null:parseInt(e.day);t=null!=t&&t>=1&&t<=31?t:null,e.event.date.day=t},e.$watch("event.date.day",(function(){e.day=null!=e.event.date.day?e.event.date.day.toString():"unselected"}))}]),angular.module("SearchFormServiceUI").controller("EstBirthYearExactCtrl",["$scope","sfsDataModelProvider","$rootScope",function(e,t,n){var a="SelfBirth";e.birthEventGroup=t.getEventGroup(e.domPrefix,a),e.birthEvent=null,e.$watchCollection("birthEventGroup.instances",(function(){e.birthEvent=e.birthEventGroup.instances.length>=1?e.birthEventGroup.instances[0]:null,e.year=null!=e.birthEvent?e.birthEvent.date.year:e.year})),e.$watch("birthEvent.date.year",(function(){e.year=null==e.birthEvent?null:e.birthEvent.date.year}));e.showerror=!1;var r=null;function i(){return null!=e.yeage&&e.yeage>0&&e.yeage<=120}function o(){return null!=e.yeyear&&e.yeyear>1e3}e.inputYearChanged=function(){null==e.year?(e.birthEvent.date.year=null,0===e.birthEvent.location.length&&(r=$.extend(!0,{},e.birthEvent),t.removeEvent(e.domPrefix,a,0),e.birthEvent=null)):(0===e.birthEventGroup.instances.length?(e.birthEvent=t.addEvent(e.domPrefix,a,0),r&&(e.birthEvent.dateProximity.year=r.dateProximity.year)):e.birthEvent=e.birthEventGroup.instances[0],e.birthEvent.date.year=e.year)},e.$on("clearFormEvent",(function(t,n){e.domPrefix==n&&(r=null)})),e.$on("personPickerUpdated",(function(t,n){e.domPrefix==n&&(r=null)})),e.$on("toggleMatchAllTermsExactly",(function(t,n,a){e.domPrefix==a&&(r=n?r:null)})),e.ageChange=function(){e.yeage&&!o()&&(e.showerror=!0),e.errorFix()},e.yearChange=e.errorFix=function(){(null==e.yeage&&null==e.yeyear||null!=e.yeage&&i()||null!=e.yeyear&&o())&&(e.showerror=!1)},e.calloutClose=function(){return null==e.yeage&&null==e.yeyear||(i()&&o()?(e.year=e.yeyear-e.yeage,e.inputYearChanged(),!0):(e.showerror=!0,!1))}}]),function(){var e=0;angular.module("SearchFormServiceUI").controller("EventSelectorCtrl",["$scope","$window","sfsDataModelProvider","sfsObjectCache",function(t,n,a,r){t.exactSearchEnabled=!1,t.eventTypesInHeaderRow=["SelfBirth","SelfMarriage","SelfDeath","SelfResidence","Self"],t.eventTypes=["SelfBirth","SelfMarriage","SelfDeath","SelfResidence","SelfArrival","SelfDeparture","SelfMilitary","Self"];var i={SelfBirth:"b",SelfMarriage:"g",SelfDeath:"d",SelfResidence:"r",SelfArrival:"a",SelfDeparture:"e",SelfMilitary:"i",Self:"y"};t.lastExactOption=null,t.lastExactFlag=null;var o={EXACTNESS:"_x"};function l(){t.allEvents=[],$.each(t.eventGroups,(function(n,a){var i=a.relation+a.eventName;$.each(a.instances,(function(n,a){var o=r.get("EventSelectorCtrl",a,i);o||(o={groupName:i,data:a,id:"event"+e++},r.set(o,"EventSelectorCtrl",a,o.groupName)),o.index=n,t.allEvents.push(o)}))}))}t.display=t.sfsData.eventDisplay,t.eventToFocus=null,t.arrivalButtonId=t.domPrefix+"arrivalButton",t.departureButtonId=t.domPrefix+"departureButton",t.militaryButtonId=t.domPrefix+"militaryButton",t.eventGroups=[],$.each(t.eventTypes,(function(e,n){t.eventGroups.push(a.getEventGroup(t.domPrefix,n))})),t.allEvents=[],$.each(t.eventTypes,(),t.getSelectorId=function(e){return t.domPrefix+"addEventLink_"+e},t.firstEventSelector="#"+t.getSelectorId("SelfBirth"),t.shouldFocus=function(e){return null!=t.eventToFocus&&t.eventToFocus===e&&(t.eventToFocus=null,!0)},t.addEvent=function(e){var n=a.addEvent(t.domPrefix,e);null!=n&&(t.eventToFocus=n),t.closeCallout()},t.hitLimit=function(e){var n=a.getEventGroup(t.domPrefix,e),r=a.getEventGroupMaxCount(t.domPrefix,e);return n.instances.length>=r},t.removeEvent=function(e,n){t.focusToNextRow&&t.focusToNextRow(n),a.removeEvent(t.domPrefix,e.groupName,e.index)},t.getDateParam=function(e,t,n){return"ms"+i[e.groupName]+"d"+t+(0==e.index?"":e.index)+(n?o[n]:"")},t.getPlaceParam=function(e){return"ms"+i[e.groupName]+"pn"+(e.index>0?e.index:"")}}])}(),function(){var e=0;angular.module("SearchFormServiceUI").controller("FamilySelectorCtrl",["$scope","queryParamCollection","sfsDataModelProvider","sfsObjectCache",function(t,n,a,r){var i;t.strings=t.sfsData.familyDisplay,t.memberTypes=["father","mother","sibling","spouse","child"],t.hasMemberWithGivenName=(i=!1,$.each(t.metadata.family,(function(e){i=i||t.metadata.family[e].hasGivenName})),i);var o,l=null,s=function(e,t,n,a){var r=0===t?"":t.toString(),i="g"===e[0]?n.givenNameParam:n.surnameParam;return 2===e.length&&(i+=e[1]),i+r+(a?"_x":"")};function c(){t.allMembers=[],t.memberTypes.forEach((function(n){var a=t.model.family[n],i=t.metadata.family[n];a.instances.forEach((function(a,o){if(i.hasGivenName||i.hasSurname){var c=r.get("FamilySelectorCtrl",a,n);c||(c={relationship:n,member:a,config:i,id:e++,focusOnce:l===a},r.set(c,"FamilySelectorCtrl",a,n)),c.index=o,c.givenNameParam=s("g",o,i),c.givenNameExactnessParam=s("g",o,i,!0),c.surnameParam=s("s",o,i),c.surnameExactnessParam=s("s",o,i,!0),t.metadata.name.usesParentSurnameFields&&(c.firstSurnameParam=s("sf",o,i),c.secondSurnameParam=s("ss",o,i)),t.allMembers.push(c)}}))})),l=null}t.allMembers=[],Object.keys(t.model.family).forEach((),c(),t.getSelectorId=t.firstFamilyGroupSelector=(o=null,t.memberTypes.forEach((function(e){null==o&&t.metadata.family[e].maxCount>0&&(o=e)})),"#"+t.getSelectorId(o)),t.addMember=t.hitLimit=function(e){return t.model.family[e].instances.length>=t.metadata.family[e].maxCount},t.removeMember=function(e,n,r){t.focusToNextRow&&t.focusToNextRow(r),a.removeFamilyMember(t.domPrefix,e,n)}}])}();var sfsFdidDropDownCtrlInstance=0;angular.module("SearchFormServiceUI").controller("FdidDropdownCtrl",["$scope",function(e){sfsFdidDropDownCtrlInstance++,e.exactCheckboxId=e.domPrefix+"sfsFdidDropDownCtrl-"+sfsFdidDropDownCtrlInstance,e.init=function(t,n,a){e.field=e.model.fields[t],e.exactKey=n+"_x",e.options=a}}]),angular.module("SearchFormServiceUI").controller("FdidHierarchicalFilterFieldCtrl",["$scope","sfsFilterHierarchyService",function(e,t){var n;function a(t,n){n=n||0,r(t.slice(0,n),(function(r,i){r||(i.selectedValue=t[n],i.isLeaf=t.length-1===n,i.isLeaf?e.field.value=i.selectedValue:a(t,n+1))}))}function r(a,r){e.filters.splice(a.length,e.filters.length-a.length),t.getFieldFilter(e.domPrefix,n,a,(function(t,i){t?(e.filters=[],e.error=!0,r&&r(t)):(i.id="sfsHierarchyFilter_"+n+"_"+a.length,i.selectedValue="",e.filters.push(i),r&&r(null,i))}))}e.filters=[],e.field=null,e.init=function(i){n=i,e.field=e.model.fields[i],r([],(function(){e.$watch("field.value",(function(r,i){if(null!=r&&""!==r&&0!==e.filters.length){var o,l=e.filters[e.filters.length-1];null==(o=e.field.value)||/^s*$/.test(o)?l.isLeaf&&(e.field.value="",l.selectedValue=""):l.isLeaf&&l.selectedValue===r||t.getValuePathFromFieldValue(e.domPrefix,n,e.field.value,(function(t,n){t?(e.filters=[],e.error=!0):a(n)}))}}))}))},e.$on("clearFormEvent",(function(t,n){e.domPrefix===n&&0!==e.filters.length&&(e.filters[0].selectedValue="",e.filterChanged(e.filters[0],0))})),e.filterChanged=function(t,n){var a=function(e){for(var t=0;t<e.options.length;++t)if(e.options[t].value===e.selectedValue)return e.options[t]}(t);if(a&&a.isLeaf?(e.field.value=t.selectedValue,t.isLeaf=!0):(e.field.value="",t.isLeaf=!1),a){if(t.selectedValue.length>0&&a&&!a.isLeaf){for(var i=[],o=0;o<=n;++o)i.push(e.filters[o].selectedValue);r(i)}}else e.filters.splice(n+1,e.filters.length-1-n)}}]),angular.module("SearchFormServiceUI").controller("FdidHierarchicalFilterPlaceCtrl",["$scope","sfsFilterHierarchyService","sfsDataModelProvider",function(e,t,n){var a;unction i(e){for(var t=0;t<e.options.length;++t)if(e.options[t].value===e.selectedValue)return e.options[t]}function o(t,n){n=n||0,l(t.slice(0,n),(function(a,r){if(!a)if(r.selectedValue=t[n],r.isLeaf=t.length-1===n,r.isLeaf){var l=i(r);r.selectedGpid=l.gpid,e.event.location=r.selectedValue,e.event.gpid=l.gpid}else o(t,n+1)}))}function l(n,r){e.filters.splice(n.length,e.filters.length-n.length),t.getPlaceFilter(e.domPrefix,a,n,(function(t,i){t?(e.filters=[],e.error=!0,r&&r(t)):(i.id="sfsHierarchyFilter_"+a+"_"+n.length,i.selectedValue="",e.filters.push(i),r&&r(null,i))}))}e.filters=[],e.event=null,e.init=function(i){a=i,e.event=n.getEvent(e.domPrefix,i,0),l([],(function(){e.$watch("event",(function(n,i){if(0!==e.filters.length){var l=e.filters[e.filters.length-1];r(e.event.location)||r(e.event.gpid)?l.isLeaf&&(e.event.location="",e.event.gpid="",l.selectedValue="",l.selectedGpid=""):l.isLeaf&&l.selectedValue===e.event.location&&l.selectedGpid===e.event.gpid||t.getValuePathFromPlaceValue(e.domPrefix,a,e.event.location,(function(t,n){t?(e.filters=[],e.error=!0):o(n)}))}}),!0)}))},e.$on("clearFormEvent",(function(t,n){e.domPrefix===n&&0!==e.filters.length&&(e.filters[0].selectedValue="",e.filterChanged(e.filters[0],0))})),e.filterChanged=function(t,n){var a=i(t);if(a&&a.isLeaf?(e.event.location=a.value,e.event.gpid=a.gpid,t.selectedGpid=e.event.gpid,t.isLeaf=!0):(e.event.location="",e.event.gpid="",t.selectedGpid="",t.isLeaf=!1),a){if(t.selectedValue.length>0&&a&&!a.isLeaf){for(var r=[],o=0;o<=n;++o)r.push(e.filters[o].selectedValue);l(r)}}else e.filters.splice(n+1,e.filters.length-1-n)}}]);var sfsFdidTextBoxCtrlInstance=0;angular.module("SearchFormServiceUI").controller("FdidTextBoxCtrl",["$scope",function(e){++sfsFdidTextBoxCtrlInstance,e.exactnessId=e.domPrefix+"sfsFdidTextBoxCtrl-"+sfsFdidTextBoxCtrlInstance,e.init=function(t,n){e.field=e.model.fields[t],e.exactKey=n+"_x"}}]),angular.module("SearchFormServiceUI").controller("FirstAnyEventCtrl",["$scope","sfsDataModelProvider",function(e,t){var n={location:"",date:{year:null},locationExactness:{}};e.event=n,e.$watch("model.events.Self.instances.length",(function(){e.event=0===e.model.events.Self.instances.length?n:e.model.events.Self.instances[0],0===e.model.events.Self.instances.length?(e.event=n,n.location=""):e.event=e.model.events.Self.instances[0]})),e.onLocationChange=function(){null!=e.event.location&&e.event.location.length>0?(0===e.model.events.Self.instances.length&&t.addEvent(e.domPrefix,"Self",0),e.model.events.Self.instances[0].location=e.event.location,e.event=e.model.events.Self.instances[0]):0===e.event.location.length&&null==e.event.date.year&&(t.removeEvent(e.domPrefix,"Self",0),0===e.model.events.Self.instances.length?(e.event=n,n.location=""):e.event=e.model.events.Self.instances[0])}}]),angular.module("SearchFormServiceUI").controller("GenderCtrl",["$scope",function(e){var t=e.model.fields.SelfGender;function n(){"male"===t.value?e.genderSubmitValue="f":"female"===t.value?e.genderSubmitValue="m":e.genderSubmitValue=""}e.genderSubmitValue="",e.genderSubmitValueChanged=function(){"f"===e.genderSubmitValue?t.value="male":"m"===e.genderSubmitValue?t.value="female":(t.value=null,e.genderSubmitValue="")},e.$watch("model.fields.SelfGender",n,!0),n()}]),angular.module("SearchFormServiceUI").controller("MonthModuleCtrl",["$scope","sfsDataModelProvider",function(e,t){e.searchKey="",e.month="unselected",e.event=null,e.init=function(n,a,r){e.searchKey=r,e.event=t.getEvent(e.domPrefix,n)},e.updateMonth=function(){var t="unselected"===e.month?null:parseInt(e.month);t=null!=t&&t>=1&&t<=12?t:null,e.event.date.month=t},e.$watch("event.date.month",(function(){e.month=null!=e.event.date.month?e.event.date.month.toString():"unselected"}))}]),angular.module("SearchFormServiceUI").controller("MSVController",["$scope",function(e){if("OldSearchSimulator"===e.metadata.form.type){var t=e.metadata.form.isRefiningSearch?e.model.viewMode:"record";e.$watch("model.isExactAllEnabled",(function(){e.model.viewMode=e.model.isExactAllEnabled?"category":t}))}}]),angular.module("SearchFormServiceUI").controller("YearModuleCtrl",["$scope","sfsDataModelProvider",function(e,t){e.searchKey="",e.event=null,e.init=function(n,a,r){e.searchKey=r,e.event=t.getEvent(e.domPrefix,n)}}]),angular.module("SearchFormServiceUI").controller("YearRangeCtrl",["$scope","$rootScope",function(e,t){e.parentForm=null,e.showError=!1,e.preventSubmit=!1,e.init=e.rangeChanged=function(t){e.model&&e.model.range&&(null==e.model.range.yearStart||null==e.model.range.yearEnd||e.model.range.yearStart<=e.model.range.yearEnd?(e.showError=!1,e.preventSubmit=!1,e.parentForm.ossyear.$setValidity("yearRange",!0)):e.preventSubmit=!0);t&&13==t.keyCode&&e.checkRange()},e.$watch("model.range",e.rangeChanged,!0),e.checkRange=function(){null!=e.model.range.yearStart&&null!=e.model.range.yearEnd?(e.showError=e.model.range.yearStart>e.model.range.yearEnd,e.showError&&t.$broadcast("yearRangeHasError",e.model)):e.showError=!1,e.parentForm.ossyear.$setValidity("yearRange",!e.showError)},e.$on("yearRangeHasError",(function(t,n){e.model===n&&(e.showError=!0,e.parentForm.ossyear.$setValidity("yearRange",!1))})),e.$on("modelLoaded",()}]),angular.module("SearchFormServiceUI").directive("sfsAllowDigitsOnly",["$window","$timeout",function(e,t){var n=38,a=40,r=65,i=86,o=[8,46,9,27,13,33,34,35,36,37,n,39,a];return{restrict:"A",link:function(l,s){var c=parseInt($(s).attr("maxlength"))||null,u=parseInt(new Array(c+1).join("9"));s.bind("paste",(function(e){t((function(){var e=s.val().replace(/[^0-9]/g,"");null!=c&&(e=e.substr(0,Math.min(e.length,c))),s.val(e)}),0)})),s.bind("keydown",(function(t){if(-1!==$.inArray(t.keyCode,o)||!0===t.ctrlKey&&t.keyCode===i||(!0===t.ctrlKey||!0===t.metaKey)&&t.keyCode===r){var l=t.keyCode!==a&&t.keyCode!==n,d=t.keyCode===a&&$(s).val()>0,f=t.keyCode===n;if(f&&null!=c&&(f=$(s).val()<u),l||d||f)return;t.preventDefault()}(t.shiftKey||t.keyCode<48||t.keyCode>57)&&(t.keyCode<96||t.keyCode>105)&&t.preventDefault();var m=null!=c&&$(s).val().toString().length>=c;!function(t){try{var n=e.getSelection();if(null!=n&&"Range"===n.type&&n.anchorNode,$(t)[0]))return!0;var a=t[0];return null!=a.selectionStart&&null!=a.selectionEnd&&a.selectionStart!=a.selectionEnd}catch(e){return!1}}(s)&&m&&t.preventDefault()}))}}}]),angular.module("SearchFormServiceUI").directive("sfsCallout",["$timeout","$window","$rootScope",function(e,t,n){return{restrict:"A",link:function(n,a,r){var i,o="object"==typeof ui&&ui.callout,l=null;a.on("$destroy",(),e((function(){n.destroyCallout=function(){n.closeCallout(),i&&(o?l.destroy&&l.destroy():a.callout("destroy"),i=!1)},n.closeCallout=function(){i&&(o?ui.callout.close():a.callout("close"))},n.openCallout=function(){i&&(o?l.open():a.callout("open"))},n.createCallout=function(){var e=r.closeButtonId,s=r.sfsOnCloseButtonEvent,c=r.sfsCallout,u=r.sfsCalloutFocus,d=r.sfsCalloutFocusList;if(o){var f=a[0],m=["sfs_Calc_Trigger"].indexOf(f.id)>-1;l=ui.callout(f,{onAfterOpen:function(){if(u){var t=document.getElementById(u);t&&window.setTimeout((function(){t.focus()}),250)}else if(d){n.$eval(d).forEach(()}var r,i=[];if("string"==typeof s){var o=s.split("(");r=o[0].trim();var l=o[1];l&&(i=l.slice(0,-1).split(",").map(())}var f=document.getElementById(e);f&&f.addEventListener("click",(function(){m&&s?(n[r].apply(this,i)?n.closeCallout():(n.closeCallout(),n.openCallout()),n.$apply()):n.closeCallout()}));var v=document.getElementById(c);v&&v.addEventListener("keyup",(function(e){"Enter"===e.key&&(e.stopPropagation(),s?(n[r].apply(this,i)?n.closeCallout():(n.closeCallout(),n.openCallout()),n.$apply()):(n.closeCallout(),a.closest("form").submit()))}))},calloutStyle:"light",type:"click",content:document.getElementById(c)||"",classes:"SUI_SFS_form",position:"bottom"})}else{function v(){var e=r.sfsSetFocusAfterClose;if(e){var t=angular.element("#"+e);t&&t.focus()}}a.callout({onAfterOpen:function(){if(u)$("#"+u).focus();else if(d)for(var r=n.$eval(d),i=0;i<r.length;++i){var o=r[i],l=$("#"+o+":enabled");if(1===l.length){l.focus();break}}e&&angular.element("#"+e).bind("click",(function(){n.$apply((function(){s?n.$eval(s)&&n.closeCallout():n.closeCallout()})),v()})),c&&angular.element("#"+c).keyup((function(e){13!=e.keyCode||t.isIE9||(e.stopPropagation(),s?(n.$eval(s)&&(n.closeCallout(),v()),n.$apply()):(n.closeCallout(),a.closest("form").submit()))}))},style:"light",type:"click",content:$("#"+c),classes:"SUI_SFS_form",position:"bottom",align:"center",keepContentInPlace:!0})}i=!0},n.createCallout()}))}}}]),angular.module("SearchFormServiceUI").directive("sfsClearForm",[function(){return{restrict:"A",link:function(e,t,n){t.on("click",(function(){e.$apply((function(){e.$root.$broadcast("clearFormEvent",e.domPrefix),e[n.sfsClearForm].$setPristine()}))}))}}}]),angular.module("SearchFormServiceUI").directive("sfsPreventSubmit",[function(){return function(e,t,n){t.bind("keydown keypress",(function(e){13===e.which&&"true"===n.sfsPreventSubmit.toLowerCase()&&e.preventDefault()}))}}]),angular.module("SearchFormServiceUI").directive("sfsFocusOnce",[function(){return function(e,t,n){"true"===n.sfsFocusOnce.toLowerCase()&&t[0].focus()}}]),angular.module("SearchFormServiceUI").directive("sfsLocation",["$window","$timeout","sfsLocationExactnessProvider",function(e,t,n){return{restrict:"E",replace:!0,scope:{event:"=",gpidName:"@",inputDomId:"@",autoname:"@",maxResults:"@",domPrefix:"@",notifyTextChanged:"&onTextChange",gpidHintEnabledAttr:"@gpidHintEnabled"},template:'<div><span data-ng-if="gpidHintEnabled" data-ng-show="showGpidHint" style="color: #4272A7;" class="errorMessage icon iconInfo">{{strings.gpidHint}}</span><input autocomplete="off" class="placepicker" type="text" id="{{inputDomId}}" name="{{gpidName}}__ftp" data-ng-class="{\'error error-blue\': showNoGpidHint}" data-ng-change="textChanged()" placeholder="{{strings.placeholder}}" data-ng-model="event.location" data-autoname="PlacePickerTextBox" /><input type="hidden" name="{{gpidName}}" value="{{event.gpid}}" data-ng-if="event.gpid.length > 0" /> <input type="hidden" name="{{gpidName}}_PInfo" value="{{pinfo}}" data-ng-if="event.gpid.length > 0" /></div>',link:function(a,r,i){var o=e[a.domPrefix+"sfsData"],l=e[a.domPrefix+"ScopeMetadata"],s=o.eventPlace;function c(e){n.cachePlaceByPrefixResponse(e),a.$apply((function(){a.event.gpid=e.Id.toString(),a.event.location=e.HName,a.showGpidHint=!1}))}function u(e){if(!a.event.gpid&&e&&e.length>0)for(var t=0;t<e.length;t++)if(d(a.event.location)===d(e[t].HName)){c(e[t]);break}}function d(e){for(var t=e.split(","),n=0;n<t.length;n++)t[n]=[t[n].toLowerCase().trim()];return t.join()}function f(){a.gpidHintEnabled&&a.$apply((function(){a.showGpidHint=!a.event.gpid&&a.event.location.length>=3}))}a.pinfo=null,a.gpidHintEnabled=a.gpidHintEnabledAttr&&"OldSearchSimulator"===l.form.type,a.strings={gpidHint:s.gpidHint,placeholder:s.placeholder},a.$watch("event.gpid",(function(){a.pinfo=null,null!=a.event.gpid&&a.event.gpid.length>0&&null!=a.event.location&&a.event.location.length>0&&n.getPlaceInfoByPrefixMatchingGpid(a.domPrefix,a.event.location,a.event.gpid,(function(e,t){e||(a.pinfo=t.level+"-|"+t.idHierarchy.join("|")+"|")}))})),a.textChanged=function(){a.event.gpid=null,a.event.locationExactness.level=a.event.locationExactness.isExact?0:null,a.event.locationExactness.isAdjacent=!1,a.notifyTextChanged()};var m,v=(s.placePickerUrl||"//placepfx.ancestry.com/s/")+"?maxCount="+(a.maxResults||8)+"&cultureId="+(o.cultureId||"en-US");t((function(){"object"==typeof ui&&ui.autocomplete?ui.autocomplete("#"+a.inputDomId,{customDisplay:dataType:"jsonp",jsonConversion:function(e){var t=e.data;return m=t,t},searchKey:"HName",minLength:3,onClose:onItemSelect:function(e){var t=e.element.getAttribute("data-extra");c(t?JSON.parse(t):e.item)},queryParameter:"prefix",source:v}):$("#"+a.inputDomId).autocomplete({customDisplay:dataType:"jsonp",jsonConversion:key:"HName",minLength:3,onClose:function(e,t,n){1===$.autocomplete.version?u(n):u(m),f()},onResultSelect:function(e){var t=e.attr("data-extra");c(t?$.parseJSON(t):e.data("raw"))},queryParameter:"prefix",source:v,sourceUrl:v,queryString:"prefix",saveResponse:!0,preFiltered:!0,itemHandler:)}))}}}]),angular.module("SearchFormServiceUI").directive("sfsLocationExactness",["$window","sfsLocationExactnessProvider",function(e,t){var n=0;return{restrict:"E",replace:!0,scope:{event:"=",gpidKey:"@",domPrefix:"@",autonamePrefix:"@"},templateUrl:"/sfs-location-exactness.html",link:function(a,r,i){++n,a.exactnessAcronym=null,a.uniquePrefix=a.domPrefix+"-sfsLocationExactness-"+n,a.calloutId=a.uniquePrefix+"-place-callout",a.exactInputId=a.uniquePrefix+"-exact";var o=e[a.domPrefix+"sfsData"];a.searchDomain=o.searchDomain;var l=o.eventPlaceExactnessDisplay,s=o.eventPlace;a.strings={exactTo:s.exactTo,aboutTheseSettings:s.aboutTheseSettings},a.relativeExactnesses=[];var c={relativeLevel:0,absoluteLevel:-1,isAdjacent:!1,acronym:"1",optionString:o.eventPlaceExactnessSelectDisplay[1],exactnessString:l.exactToThisPlace,exactnessStringWhenOneExactnessChoice:l.exactToThisPlace};function u(){var e=null;return a.relativeExactnesses.forEach((),e}a.$watch("event.gpid",(function(){if(null==a.event.gpid||0===a.event.gpid.length)return a.relativeExactnesses.length=0,void(a.exactnessAcronym=null);t.getPlaceInfoByPrefixMatchingGpid(a.domPrefix,a.event.location,a.event.gpid,(function(e,n){var r=t.getExactnesses(a.domPrefix,a.event.gpid);if(a.relativeExactnesses.length=0,a.relativeExactnesses.push.apply(a.relativeExactnesses,r),a.relativeExactnesses.length>0){var i=a.relativeExactnesses.splice(0,1,c)[0];c.exactnessStringWhenOneExactnessChoice=i.exactnessString}if(a.exactnessAcronym=null,a.event.locationExactness.isExact){a.exactnessAcronym="1";for(var o=0;o<a.relativeExactnesses.length;++o){var l=a.relativeExactnesses[o];if(l.relativeLevel===a.event.locationExactness.level&&l.isAdjacent===a.event.locationExactness.isAdjacent){a.exactnessAcronym=l.acronym;break}}"1"===a.exactnessAcronym&&(a.event.locationExactness.level=0,a.event.locationExactness.isAdjacent=!1)}}))})),a.$watch("event.locationExactness",(function(){a.exactnessAcronym=null,a.relativeExactnesses.forEach((function(e){a.event.locationExactness.level===e.relativeLevel&&a.event.locationExactness.isAdjacent===e.isAdjacent&&(a.exactnessAcronym=e.acronym)}))}),!0),a.getExactnessButtonText=function(){if(0===a.relativeExactnesses.length)return s.exact;if(1===a.relativeExactnesses.length)return a.relativeExactnesses[0].exactnessStringWhenOneExactnessChoice;if(!a.event.locationExactness.isExact)return s.exactTo;if(0===a.event.locationExactness.level&&!a.event.locationExactness.isAdjacent)return l.exactToThisPlace;var e=u();return null==a.event.locationExactness.level||null==e?s.exact:e.exactnessString},a.updateIsExact=function(e){a.event.locationExactness.isExact=e,a.event.locationExactness.isExact?(a.exactnessAcronym=a.exactnessAcronym||"1",a.event.locationExactness.level=a.event.locationExactness.level||0):(a.exactnessAcronym=null,a.event.locationExactness.level=null,a.event.locationExactness.isAdjacent=!1)},a.placeExactnessChanged=function(){var e=u();a.event.locationExactness.isExact=!0,a.event.locationExactness.level=e.relativeLevel,a.event.locationExactness.isAdjacent=e.isAdjacent}}}}]),angular.module("SearchFormServiceUI").directive("sfsNameExactness",["$window",function(e){var t=0;return{restrict:"E",replace:!0,scope:{name:"=",domPrefix:"@",isGivenName:"="},template:'<div class="exact-filter" data-ng-show="name[nameProp].length > 0"><input type="hidden" name="{{searchKey}}_x" data-ng-if="isRequired" value="1" /><input type="hidden" name="{{searchKey}}_x" data-ng-if="!isRequired && name[nameProp].length > 0" value="{{exactnessString}}" data-submit-default="" /><div data-ng-if="isRequired"><button type="button" class="link icon iconCheck locationButton">{{exactnessLabel}}</button></div><div data-ng-if="!isRequired"><button type="button" data-ng-class="{iconCheck: exactness.isExact, inputBox: !exactness.isExact}" class="link icon locationButton" data-ng-click="enableNameExactness()" data-sfs-callout="{{calloutId}}" data-sfs-callout-focus="{{calloutExactInputId}}" data-autoname="{{autoname}}">{{exactnessLabel}}</button><div id="{{calloutId}}" class="{{moduleClass}} form SUI_SFS_form calloutDomContent"><div><input class="checkbox" id="{{calloutExactInputId}}" type="checkbox" data-autoname="ExactAnd" data-ng-change="updateNameExactness()" data-ng-model="exactness.isExact"><label for="{{calloutExactInputId}}">{{strings.exactAndEllipsisText}}</label></div><div class="indent" data-ng-repeat="chk in exactnessCheckboxes" data-ng-init="checkboxId = $parent.calloutExactCheckboxIdPrefix + chk.prop"><input class="checkbox" id="{{checkboxId}}" type="checkbox" data-autoname="{{chk.autoname}}" data-ng-model="exactness.flags[chk.prop]" data-ng-change="exactness.isExact = true"><label for="{{checkboxId}}">{{chk.label}}</label></div><div class="about"><button class="link" type="button" data-autoname="Settings" data-sfs-show-help-for="{{showHelpForName}}" data-search-domain="{{searchDomain}}">{{strings.aboutTheseSettingsText}}</button></div></div></div></div>',link:function(n,a,r){++t;var i=n.domPrefix+"sfsNameExactness-"+t,o=e[n.domPrefix+"ScopeMetadata"],l=e[n.domPrefix+"sfsData"],s=n.isGivenName?l.name.firstNameCheckboxes:l.name.lastNameCheckboxes;function c(){if(n.exactness.isExact){var e=[],t=o.name.flagToExactnessStrMap;$.each(n.exactness.flags,(function(a,r){!0===r&&(n.exactness.isExact=!0,e.push(t[a]))})),n.exactnessString=0===e.length?"1":e.join("_")}else n.exactnessString="0";n.exactnessLabel=function(){var e=n.strings.exactText;if(!n.exactness.isExact)return e+"...";var t=[e];if($.each(n.exactnessCheckboxes,(function(e,a){n.exactness.flags[a.prop]&&t.push(a.label.toLowerCase())})),1===t.length)return t[0];var a=t.pop();return t.join(", ")+" & "+a}()}n.strings=l.name,n.nameProp=n.isGivenName?"givenName":"surname",n.exactness=n.isGivenName?n.name.givenNameExactness:n.name.surnameExactness,n.searchKey=n.isGivenName?"gsfn":"gsln",n.exactnessString="0",n.exactnessLabel=n.strings.exactText,n.showHelpForName=n.isGivenName?"fname":"lname",n.moduleClass=n.isGivenName?"SUI_SFS_FirstNameExact_Container":"SUI_SFS_LastNameExact_Container",n.autoname=n.isGivenName?"FirstNameExact":"LastNameExact",n.calloutId=i+"-callout",n.calloutExactInputId=i+"-callout-input",n.calloutExactCheckboxIdPrefix=i+"-callout-checkbox-",n.searchDomain=l.searchDomain,n.exactnessCheckboxes=$.extend(!0,[],s),n.isRequired="true"===r.isRequired,n.enableNameExactness=n.updateNameExactness=function(){n.exactness.isExact||$.each(n.exactness.flags,(),c()},n.$watch("name."+n.nameProp+"Exactness",c,!0)}}}]),angular.module("SearchFormServiceUI").directive("sfsNosubmit",[function(){return{restrict:"A",link:function(e,t,n){void 0!==n.sfsNosubmit&&"true"===n.sfsNosubmit.toLowerCase()&&t.closest("form").bind("submit",()}}}]),angular.module("SearchFormServiceUI").directive("sfsPersonPicker",["$timeout","sfsCookies","sfsPersonPickerService","sfsQuickTilesUtils","$rootScope","$window",function(e,t,n,a,r,i){var o="en-US",l="Global",s="gsln",c="gsfn",u="Surname",d="GivenName",f="isSurnameVisible",m="isGivenNameVisible",v="quickfill-givenname",p="quickfill-surname";return{restrict:"A",link:function(g,h,y){if(!g.sfsData.user.isInstitutional&&g.sfsData.personPicker.enabled){var x=i[g.domPrefix+"sfsData"].personPicker.quickFillSuggestions,S=y.name==s?u:d,E=a.getVersionSettings(),P=a.getFormType(),b=a.getCultureId();if(b==o&&P==l){var w=y.name==s?f:m;if(!E[w])return}else if(S===u)return;var F,I=g.sfsData.personPicker.treeSelectionLabel,C=g.sfsData.personPicker.treeLabel,k=y.sfsPersonPicker||"//search.ancestry.com/personpicker/",N=null,T=null,A=!0;h.bind("mousedown",(function(){N?n.getTreeData()||n.setTreeData(N):D()})).bind("keyup",(function(t){9!==t.which||N||e((,500)})).bind("blur",()}function D(){$.getJSON(k+"trees/?callback=?",null,(function(e){if(N=e,null!=e&&null!=e.AllTrees&&0!==e.AllTrees.length){if(!e.SelectedTree){var n=t.get("personPickerSelectedTreeId");if("string"==typeof n){var a=e.AllTrees.filter((function(e){return e.TreeId===n}));e.SelectedTree=a.length>0?a[0]:null}}e.SelectedTree=e.SelectedTree||(e.AllTrees.length>0?e.AllTrees[0]:null),e.SelectedTree&&(T=e.SelectedTree.TreeId,e.SelectedTree.TreeId!==n&&t.set("personPickerSelectedTreeId",e.SelectedTree.TreeId,365),L(e,T),$(h).is(":focus")&&$(h).trigger("focus"))}}))}function M(e){var a,i,o=document.createElement("div");if("object"==typeof e&&e.AllTrees)if(o.classList.add("sfsTreeSelectionContainer"),o.classList.add("form"),e.AllTrees.length>1){var l="treeSelectLabel";(a=document.createElement("p")).setAttribute("id",l),a.textContent=I,o.appendChild(a),(i=document.createElement("select")).setAttribute("aria-labelledby",l),e.AllTrees.forEach((function(e){var t=document.createElement("option");t.textContent=e.Name,t.setAttribute("value",e.TreeId);var a=n.getTreeId();a&&(T=a),e.TreeId===T&&t.setAttribute("selected",!0),i.appendChild(t)}));var s=function(a,i){$.getJSON(k+"setselectedtree/"+a+"/?callback=?",null,(function(e,t){})),t.set("personPickerSelectedTreeId",a,365),n.setTreeId(a),n.setTreeData(e),i&&(h.blur(),L(e,a),h.focus()),r.$emit("treechanged",a)};r.$on("onSelectedTreeChange",(function(e,t){$("option",i).each((function(){var e=$(this);e.attr("value")==t?e.attr("selected",!0):e.removeAttr("selected",!1)})),F&&F.config&&F.config.source&&(F.config.source=F.config.source.replace(T,t)),T=t,F&&"function"==typeof F.flush&&F.flush(),s(T)})),i.addEventListener("change",(function(){var e=$(this).find("option:selected");T=e.val(),n.setTreeId(T),s(T,!0)})),o.appendChild(i)}else(a=document.createElement("p")).classname="sfsTreeSelectionContainer",a.textContent=C+" "+e.SelectedTree.Name,o.appendChild(a);return o}function L(e,i){var u=void 0!==i?i+"/":"";if("object"==typeof ui&&ui.autocomplete)F=ui.autocomplete(h[0],{source:k+"suggest/"+u,onSearch:function(){var e=a.getQuickFillVersion();if(b==o&&P==l&&("v1"===e||"v2"===e)){var t=n.getTreeId()||T,r=void 0!==t?t+"/":"";F.flush(),"FirstNameTextBox"===h[0].dataset.autoname?(F.config.queryParameter="partialFirstName",F.config.source=k+"suggest/"+r+"?partialLastName="+$("input[name='"+s+"']").val()):(F.config.source=k+"suggest/"+r+"?partialFirstName="+$("input[name='"+c+"']").val(),F.config.queryParameter="partialLastName")}},onOpen:function(){var e=n.getTreeData();if(e){var t=M(e);$(".sfsTreeSelectionContainer").remove(),$(".autocompleteAfter").append(t),F.flush()}},customDisplay:function(e){var t,n=e.data.raw,a="";return null!==n.BirthYear&&(a=n.BirthYear+"-"),null!==n.DeathYear&&(a+=n.DeathYear),n.FormattedFullName?t=$("<div/>").html(n.FormattedFullName).text().replace(/(\$];)(\s+)(\$\[;)/g,"$1<span> </span>$3").replace(/\$\[;/g,'<span class="autocompleteHighlighted">').replace(/\$];/g,"</span>"):(t=$("<div/>").html(n.FirstName+" "+n.LastName).text(),n.GivenName=n.FirstName,n.Surname=n.LastName),t='<span class="sfsPersonPickerExtraData">'+a+"</span>"+t,{value:n[S],display:t}},onResponse:function(){E.isGivenNameVisible&&E.isQuickTilesVisible&&E.isSurnameVisible&&($(".quick-tile-label").remove(),$(".autocompleteResults").prepend('<li class="autocompleteResult quick-tile-label" role="option" id="default" tabindex="0"><div class="textWrap autocompleteHighlighted icon iconDownload">'+x+"</div></li>"))},dataType:"jsonp",searchKey:"GivenName",minLength:3,after:M(e),onItemSelect:function(e){var t=e.element,a=t.getAttribute("data-extra");r.$emit("onCloseQuickTileSuggestion");var i=a?JSON.parse(a):e.item;i.TreeId=i.TreeId?i.TreeId:T,$.getJSON(k+"person/"+i.TreeId+"/"+i.PersonId+"/?callback=?",null,(function(e,a){if("success"===a){var r="";t.name===s?r=p:t.name===c&&(r=v),n.updateModelFromPersonPickerResponse(g.domPrefix,e,r),t.blur()}}))},queryParameter:"partialFirstName"});else{function d(e,n){var a=e.find(".sfsTreeSelectionContainer");if(null!=n&&!a.length)if(n.AllTrees.length>1){for(var r=e.append('<div class="sfsTreeSelectionContainer form"><hr />'+I+" <select /></div>").find(".sfsTreeSelectionContainer select"),i=0;i<n.AllTrees.length;++i){var o=n.AllTrees[i];r.append($("<option>",{value:o.TreeId,text:o.Name,selected:o.TreeId===T}))}r.change((function(){var e=$(this).find("option:selected");T=e.val(),$.getJSON(k+"setselectedtree/"+T+"/?callback=?",null,(function(e,t){})),t.set("personPickerSelectedTreeId",T,365),h.blur(),L(n,T),h.focus()}))}else e.append('<span class="sfsTreeSelectionContainer">'+C+" "+n.SelectedTree.Name+"</span>")}h.autocomplete({source:k+"suggest/"+u,customDisplay:function(e){var t,n=e.raw,a="";return null!=n.BirthYear&&(a=n.BirthYear+"-"),null!=n.DeathYear&&(a+=n.DeathYear),n.FormattedFullName?t=$("<div/>").html(n.FormattedFullName).text().replace(/(\$];)(\s+)(\$\[;)/g,"$1<span> </span>$3").replace(/\$\[;/g,'<span class="autocompleteHighlighted">').replace(/\$];/g,"</span>"):(t=$("<div/>").html(n.FirstName+" "+n.LastName).text(),n.GivenName=n.FirstName,n.Surname=n.LastName),t='<span class="sfsPersonPickerExtraData">'+a+"</span>"+t,{value:n[S],display:t}},dataType:"jsonp",key:"GivenName",minLength:3,onOpen:function(t,n){1===$.autocomplete.version?d(n,e):d(t,e)},onResultSelect:function(e){var t=e.attr("data-extra"),a=t?$.parseJSON(t):e.data("raw");$.getJSON(k+"person/"+a.TreeId+"/"+a.PersonId+"/?callback=?",null,(function(e,t){"success"===t&&n.updateModelFromPersonPickerResponse(g.domPrefix,e)}))},queryParameter:"partialFirstName",sourceUrl:k+"suggest/"+u,queryString:"partialFirstName",isPrefix:!1,saveResponse:!0,itemHandler:function(e,t){var n,a="";return null!=t.BirthYear&&(a=t.BirthYear+"-"),null!=t.DeathYear&&(a+=t.DeathYear),t.FormattedFullName?n=$("<div/>").html(t.FormattedFullName).text().replace(/\$\[;/g,'<span class="autocompleteHighlighted">').replace(/\$];/g,"</span>"):(n=$("<div/>").html(t.FirstName+" "+t.LastName).text(),t.GivenName=t.FirstName,t.Surname=t.LastName),n+='<span class="sfsPersonPickerExtraData">'+a+"</span>",{inputText:t[S],displayText:n}}})}}}}}]),angular.module("SearchFormServiceUI").directive("sfsQuickFillContainer",["sfsCookies","sfsPersonPickerService","$compile","sfsQuickTilesUtils","$rootScope","$timeout","sfsDataModelProvider","$window",function(e,t,n,a,r,i,o,l){return{restrict:"E",replace:!0,scope:{name:"=",personPickerUrl:"@",domPrefix:"@"},link:function(s,c,u){s.quickFillSuggestions=l[s.domPrefix+"sfsData"].personPicker.quickFillSuggestions;var d=a.getVersionSettings(),f=a.getFormType(),m=a.getCultureId();s.showSuggestion=!0,s.closeSuggestion=r.$on("onCloseQuickTileSuggestion",();var v=s.personPickerUrl;s.personTrees={SelectedTree:null,AllTrees:[]},s.personList=[],s.selectedTreeId=null,s.isShowNext=!1,s.isShowPrev=!1,s.isTreeAvailable=!0,s.allTilesLength=0,s.wrapperLength=0,s.currentSection=0,s.firstName="",s.lastName="",s.allowPersonPick=!1,s.isRedwood="rwl"===e.get("UI-2-Style"),s.sfsSelectedPersonData=function(){var e=o.getDataModel(s.domPrefix);return e?e.treePerson.personId:null};var p,g=function(e,t){s[t?"firstName":"lastName"]=e,y(s.firstName,s.lastName),s.isLoading=!0,i((function(){var e=0;jQuery(".quick-fill-tiles-list-wrap").each((function(t,n){e+=$(n).outerWidth()})),s.allTilesLength=e,s.wrapperLength=$(".quick-fill-tiles-wrapper").width(),$(".quick-fill-tiles-container").width(e),s.allTilesLength>s.wrapperLength?s.isShowNext=!0:s.isShowNext=!1,s.isLoading=!1,s.isShowPrev=!1}),1200)};function h(t){t!==e.get("personPickerSelectedTreeId")&&e.set("personPickerSelectedTreeId",t,365)}function y(e,t){if(s.selectedTreeId){t=t||"";var n=(e=e||"")&&e.length>=3||t&&t.length>=3;if(s.allowPersonPick=n,s.allowPersonPick){var a=s.personPickerUrl+"suggest/"+s.selectedTreeId;s.isLoading=!0,$.getJSON(a+"?partialFirstName="+e+"&partialLastName="+t+"&callback=?",null,(function(e){var t=s.sfsSelectedPersonData();if(e=e.slice(0,8),t)for(var n=0;n<e.length;n++)if(e[n].PersonId==t){e.unshift(e[n]),e.splice(n+1,1);break}s.currentSection=0,s.personList=e,s.isLoading=!1,s.$apply();var a=0;jQuery(".quick-fill-tiles").each((function(e,t){a+=$(t).width()})),s.allTilesLength=a,s.wrapperLength=$(".quick-fill-tiles-wrapper").width(),s.allTilesLength>s.wrapperLength?s.isShowNext=!0:s.isShowNext=!1,s.isShowPrev=!1,$(".quick-fill-tiles-container").animate({left:"0px"},0)}))}}}s.selectSuggestion=function(e){$.getJSON(v+"person/"+e.TreeId+"/"+e.PersonId+"/?callback=?",null,(function(e,n){"success"===n&&(t.updateModelFromPersonPickerResponse(s.domPrefix,e,"quickfill-tiles"),$(".quick-fill-tiles-container").animate({left:"0px"},0))}))},$(l).resize((function(){var e=0;jQuery(".quick-fill-tiles-list-wrap").each((),s.allTilesLength=e,s.wrapperLength=$(".quick-fill-tiles-wrapper").width(),$(".quick-fill-tiles-container").width(e)})),s.onChangeNextTiles=function(){s.currentSection=s.currentSection+1;var e=s.currentSection*s.wrapperLength;$(".quick-fill-tiles-container").animate({left:-e+"px"},800),e+s.wrapperLength>s.allTilesLength&&(s.isShowNext=!1),(e>s.wrapperLength||e==s.wrapperLength)&&(s.isShowPrev=!0)},s.onChangePrevTiles=function(){s.currentSection=s.currentSection-1;var e=s.currentSection*s.wrapperLength;$(".quick-fill-tiles-container").animate({left:-e+"px"},800),s.allTilesLength>e&&(s.isShowNext=!0),s.wrapperLength>e&&(s.isShowPrev=!1)},s.changeTreeId=function(e,t){if(s.personTrees.SelectedTree!=e){var n=s.personTrees.AllTrees.find(();s.personTrees.SelectedTree=n,s.selectedTreeId=n.TreeId,y(s.firstName,s.lastName),p&&p.close(),t||r.$emit("onSelectedTreeChange",s.selectedTreeId),$.getJSON(v+"setselectedtree/"+s.selectedTreeId+"/?callback=?",null,(),h(s.selectedTreeId)}},$.getJSON(v+"trees/?callback=?",null,(function(t){if(null==t||null==t.AllTrees||0===t.AllTrees.length)return s.isTreeAvailable=!1,void $(".SUI_SFS_Quick_Fill_Container").removeClass("SUI_SFS_Quick_Fill_Container");if(s.personTrees=t,!t.SelectedTree){var n=e.get("personPickerSelectedTreeId");if("string"==typeof n){var a=t.AllTrees.filter(();t.SelectedTree=a.length>0?a[0]:null}}t.SelectedTree=t.SelectedTree||(t.AllTrees.length>0?t.AllTrees[0]:null),t.SelectedTree&&(s.selectedTreeId=t.SelectedTree.TreeId,h(t.SelectedTree.TreeId),s.$apply(),"object"==typeof ui&&ui.callout?p=ui.callout("#SUI_SFS_List_Tree",{content:"#SUI_SFS_All_Trees"}):$("#SUI_SFS_List_Tree").callout({content:$("#SUI_SFS_All_Trees")}))})),s.isLoading=!1,"en-US"==m&&"Global"==f&&d.isQuickTilesVisible?(s.$watch("name.givenName",(function(e){s.isClickFirstNameAutocomplete?s.isClickFirstNameAutocomplete=!1:s.showSuggestion=!0,g(e,!0)}),!0),s.$watch("name.surname",(function(e){s.isClickLastNameAutocomplete?s.isClickLastNameAutocomplete=!1:s.showSuggestion=!0,g(e,!1)}),!0),r.$on("treechanged",(),c.replaceWith(n('<div class="SUI_SFS_Quick_Fill_Tile" ng-show="isTreeAvailable && showSuggestion && allowPersonPick"><div class="quick-fill-tiles-wrapper" ng-class="{\'redwood\':isRedwood}" ><span class="icon iconClose quick-fill-close" ng-click="closeSuggestion()"></span><h5 class="cardTitle">{{quickFillSuggestions}}</h5><a href="#" class="iconAfter iconArrowDownAfter SUI_SFS_List_Tree" id="SUI_SFS_List_Tree">{{personTrees.SelectedTree.Name}}</a><div class="calloutMenu SUI_SFS_All_Trees" id="SUI_SFS_All_Trees"><ul><li class="sfs-tree-list" ng-repeat="tree in personTrees.AllTrees" ><a ng-class="{\'selected\':tree.TreeId === selectedTreeId}" ng-click="changeTreeId(tree.TreeId)"><span class="sfs-tree-name">{{tree.Name}}</span><span ng-if="tree.TreeId === selectedTreeId" aria-hidden="true" class="icon iconCheck"></span></a></li></ul></div><div class="quick-fill-tiles-container"><div class="quick-fill-tiles-list-wrap" ng-repeat="person in personList" ng-hide="isLoading"  ng-if="$even"><div class="quick-fill-tiles" ng-class="{ selectedSuggestion: person.PersonId == sfsSelectedPersonData(),\'card\':isRedwood}" title = {{person.FullName}} ng-click="selectSuggestion(person)"><h4 ng-class="{\'quick-fill-tiles-allign-vertical\':!person.BirthYear && !person.DeathYear}">{{person.FullName}}</h4><span ng-if="person.BirthYear || person.DeathYear">{{person.BirthYear?person.BirthYear+"-":""}}{{person.DeathYear}}</span></div><div ng-if="personList[$index+1]" class="quick-fill-tiles" ng-class="{ selectedSuggestion: personList[$index+1].PersonId == sfsSelectedPersonData(),\'card\':isRedwood}" title = {{person.FullName}} ng-click="selectSuggestion(personList[$index+1])"><h4 ng-class="{\'quick-fill-tiles-allign-vertical\':!personList[$index+1].BirthYear && !personList[$index+1].DeathYear}">{{personList[$index+1].FullName}}</h4><span ng-if="personList[$index+1].BirthYear || personList[$index+1].DeathYear">{{personList[$index+1].BirthYear?personList[$index+1].BirthYear+"-":""}}{{personList[$index+1].DeathYear}}</span></div></div><div class="no-suggest" ng-if="!isLoading && allowPersonPick && personList.length == 0"> No suggestions found</div><div class="loading" ng-if="allowPersonPick && isLoading"></div></div><div ng-if="isShowNext" class="quick-filter-next" ng-click="onChangeNextTiles()"><button type="button" class="quick-filter-arrow-circle icon iconArrowRight"></button></div><div ng-if="isShowPrev" class="quick-filter-prev" ng-click="onChangePrevTiles()"><button type="button" class="quick-filter-arrow-circle icon iconArrowLeft"></button></div></div></div>')(s))):($(".SUI_SFS_Quick_Fill_Container").removeClass("SUI_SFS_Quick_Fill_Container"),c.replaceWith(n("<div></div>")(s)))}}}]),angular.module("SearchFormServiceUI").directive("sfsRequired",["$timeout",function(e){return{restrict:"A",link:function(t,n,a){"true"===a.sfsRequired.toLowerCase()&&e((function(){n.attr("required","true");var e=angular.element("label[for="+a.id+"]");unction i(){return!n.val()||null!=n.attr("data-minimum-length")&&n.val().length<n.attr("data-minimum-length")}function o(){n.removeClass("error"),e.removeClass("error").addClass("success").siblings('[class="errorMessage icon iconWarning"]').remove()}function l(){n.addClass("error"),e.removeClass("success").addClass("error"),e.siblings('[class="errorMessage icon iconWarning"]').length<1&&e.after('<span class="errorMessage icon iconWarning"></span>')}e.addClass("required"),e.css("float","left"),n.bind("blur",(function(){r()})),n.filter("input[type=text], textarea").on("input",(function(){i()?e.hasClass("success")&&l():o()})),n.closest("form").bind("submit",(function(){n.val().length<1&&l()})),"SELECT"===n.prop("tagName").toUpperCase()&&n.bind("change",(),t.$on("personPickerUpdated",(),t.$on("clearFormEvent",(function(a,r){r===t.domPrefix&&(n.removeClass("error"),e.removeClass("error").removeClass("success").siblings('[class="errorMessage icon iconWarning"]').remove())})),i()||o()}),0)}}}]),angular.module("SearchFormServiceUI").directive("sfsRestoreFocus",["$timeout","$parse",function(e,t){return{restrict:"A",link:function(n,a,r){n.focusToNextRow=function(a){var i=r.$$element.find(".sfsPanel").children("fieldset");if(i.length-1<=0)e((function(){angular.element(t(r.sfsRestoreFocus)(n)).focus()}));else{var o=i.length-1>a?i[a+1]:i[a-1],l=$(o).find("input").filter(":visible");null!=l&&l.length>0&&l.first().focus()}}}}}]),angular.module("SearchFormServiceUI").directive("sfsSafeSubmit",["$window","submitQueryService",function(e,t){return{restrict:"A",link:function(n,a,r){var i=$("#"+n.metadata.form.dataFieldId);a.bind("submit",(function(e){if(e.preventDefault(),!(a.closest("form").find(".error").length>0)){var i=!0;a.closest("form").find("input[required], select[required]").each((function(e,t){var n=$(t),a=n.val(),r=Math.max(1,n.attr("data-minimum-length")||1);return a.length<r&&(i=!1),i})),i&&(a.find(":submit").val(r.sfsSafeSubmit).addClass("disabled").prop("disabled",!0),t.submitSearchQuery(n.model,n.metadata))}})),$(e).on("pageshow",(function(t){(!0===t.originalEvent.persisted||e.performance&&2===e.performance.navigation.type)&&a.find(":submit").each((function(){var e=$(this);e.val(e.attr("data-initial-text")),e.removeClass("disabled"),e.prop("disabled",!1)}))})),n.$on("clearFormEvent",(function(e,t){t===n.domPrefix&&i.val("")}))}}}]),angular.module("SearchFormServiceUI").directive("sfsShowHelpFor",[function(){return{restrict:"A",link:function(e,t,n){t.bind("click",(function(){window.open(n.searchDomain+"/Search/Help/SearchForm.aspx?topic="+n.sfsShowHelpFor,"_blank","toolbar=yes, location=yes, directories=no, status=no, menubar=yes, scrollbars=yes, resizable=no, copyhistory=yes, width=640, height=480")}))}}}]),angular.module("SearchFormServiceUI").directive("sfsUserIdHash",[function(){return{restrict:"A",scope:!1,link:function(e,t){try{t.val(Ancestry.SFS.Settings.UserIdHash)}catch(e){t.val("")}}}}]),angular.module("SearchFormServiceUI").directive("sfsYearExactness",["$window",function(e){var t=0;return{restrict:"E",replace:!0,scope:{proximityName:"@",exactnessName:"@",event:"=",domPrefix:"@"},link:function(n,a,r){++t,n.directiveId="sfsYearExactnes_"+t,n.calloutId="callout_"+n.proximityName+"_"+n.directiveId,n.exactnessCheckboxId="checkbox_"+n.exactnessName+"_"+n.directiveId;var i=e[n.domPrefix+"sfsData"];n.exactText=i.exactYearText,n.exactToText=i.exactToText,n.buttonDisplayText=i.eventYearExactButtonDisplay,n.exactnessDisplayText=i.eventYearExactnessDisplay,n.exactnesses=[0,1,2,5,10],n.setIsExact=function(e){n.isYearExact=e,e?(n.event.dateProximity.day=n.event.dateProximity.day||0,n.event.dateProximity.month=n.event.dateProximity.month||0,n.event.dateProximity.year=n.event.dateProximity.year||0):(n.event.dateProximity.day=null,n.event.dateProximity.month=null,n.event.dateProximity.year=null)},n.$watch("event.dateProximity.year",(function(){n.setIsExact(null!=n.event.dateProximity.year)})),n.getItemDomId=function(e){return"input_"+n.proximityName+"_"+e+"_"+n.directiveId}},template:'<div class="exact-filter"><button type="button" class="link icon locationButton"data-ng-click="setIsExact(true)" data-ng-class="{ iconCheck: isYearExact, inputBox : !isYearExact }" data-sfs-callout="{{calloutId}}" data-sfs-callout-focus="{{exactnessCheckboxId}}" data-autoname="YearExactButton"><span>{{ isYearExact ? buttonDisplayText[event.dateProximity.year] : exactText + "..." }}</span></button><input type="hidden" value="1" data-ng-if="event.date.year != null && isYearExact" name="{{exactnessName}}" /><input type="hidden" value="{{event.dateProximity.year}}" name="{{proximityName}}" data-ng-if="event.date.year != null && isYearExact" /><div id="{{calloutId}}" class="form calloutDomContent"><input id="{{exactnessCheckboxId}}" class="checkbox" type="checkbox" data-ng-model="isYearExact" data-ng-change="setIsExact(isYearExact)"><label for="{{exactnessCheckboxId}}">{{exactToText}}</label><ul style="list-style-type: none;"><li data-ng-repeat="exactness in exactnesses" data-ng-init="itemDomId = getItemDomId(exactness)"><input id="{{itemDomId}}" class="radio" type="radio" name="{{proximityName}}__{{directiveId}}" data-no-submit data-ng-value="{{exactness}}" data-ng-model="$parent.event.dateProximity.year" data-ng-change="setIsExact(true)"><label for="{{itemDomId}}" data-autoname="Exact{{exactness}}">{{exactnessDisplayText[exactness]}}</label></li></ul></div></div>'}}]),angular.module("SearchFormServiceUI").factory("queryParamCollection",["$rootScope","$window",function(e,t){var n={},a=null,r=null,i={},o={};return n.getUrlParams=function(){return a||(a=function(e){var t={};if(!e)return t;for(var n=e.split("&"),a=0;a<n.length;a++){var r=n[a].split("=");if(2==r.length){var i=decodeURIComponent(r[0].replace(/\+/g," ")),o=decodeURIComponent(r[1].replace(/\+/g," "));i&&o&&(t[i]=o)}}return t}(t.location.search.substring(1))),a},n.getPersonPickerParams=function(){return r},n.getQueryStringValue=function(){if(window.ancestry&&window.ancestry.search){if("on"==window.ancestry.search.newSliderEditForm)return!0;if("off"==window.ancestry.search.newSliderEditForm)return!1}return!!decodeURIComponent(window.location.search.replace(new RegExp("^(?:.*[&\\?]"+encodeURIComponent("isNewSlider").replace(/[\.\+\*]/g,"\\$&")+"(?:\\=([^&]*))?)?.*$","i"),"$1"))},n.getPersonPickerParam=n.updatePersonPickerParams=function(e){r=e},n.getByKey=n.getFormData=function(e){if(o[e])return{};if(i[e])return i[e];var a=n.getUrlParams();return i[e]=a,t.Ancestry&&t.Ancestry.SFS&&t.Ancestry.SFS.InitialValues&&$.each(t.Ancestry.SFS.InitialValues,(function(e,t){a[e]=t})),i[e]},e.$on("clearFormEvent",(),n}]),angular.module("SearchFormServiceUI").factory("sfsCookies",["$window",function(e){var t={getAll:get:function(e){for(var n=e+"=",a=t.getAll(),r=0;r<a.length;r++){for(var i=a[r];" "==i.charAt(0);)i=i.substring(1,i.length);if(0==i.indexOf(n))return i.substring(n.length,i.length)}return null},set:function(t,n,a){var r="";if(a){var i=new Date;i.setTime(i.getTime()+24*a*60*60*1e3),r="; expires="+i.toGMTString()}e.document.cookie=t+"="+n+r+"; path=/"},remove:;return t}]),angular.module("SearchFormServiceUI").factory("submitQueryService",["$window","urlCanonicalizerProvider","sfsDataModelProvider","userPreferences","nodeObjectHashProvider","sfsCookies",function(e,t,n,a,r,i){var o=/[?&]debug=(1|true)(&|$)/gi;function l(e,t){for(var n=e.split("&"),a=[],r=Object.keys(t),i=0;i<n.length;i++){var o=n[i].split("=");if(2===o.length)t[s=o[0]]||a.push(n[i])}for(var l=0;l<r.length;l++){var s=r[l];a.push(encodeURI(s)+"="+encodeURI(t[s]))}return a.join("&")}return{submitSearchQuery:function(s,c){var u=$("#"+c.form.domPrefix+"SearchForm > form");if(!(u.find(".error").length>0)){var d={};if("V1"===c.querySetVersion||"V2"!==c.querySetVersion){var f=r.getHasher({coerce:!1,sort:!1,alg:"md5",enc:"base64"}),m=function(e,t,n,a,r,i){var o=t.form.categoryName?[t.form.categoryName]:[],s=t.form.collectionId?[t.form.collectionId]:[];e.qh=a({name:r.name,events:r.events,fields:r.fields,family:r.family,types:r.types,location:r.location,priority:r.priority,range:r.range,treePerson:r.treePerson,categories:o,collections:s,limitRecordsToCountry:r.limitRecordsToCountry,sessionId:i.get("ANCSESSIONID")||""});for(var c=n.serialize().split("&"),u=0;u<c.length;u++){var d=c[u].split("="),f=decodeURIComponent(d[0].replace(/\+/g," ")),m=decodeURIComponent(d[1].replace(/\+/g," "));f&&m&&(e[f]=m)}var v={};n.find("input[data-submit-default], select[data-submit-default]").each((function(){this.value&&this.value.toString()===this.attributes["data-submit-default"].value?delete e[this.name]:"0"===this.value&&(v[this.name]=this.value)})),n.find("input[data-no-submit], select[data-no-submit]").each((function(){delete e[this.name]})),!1===t.form.submitPInfo&&n.find("input[name$=_PInfo]").each(();var p="";for(var g in e)"0"===e[g]&&void 0===v[g]||(p&&(p+="&"),p+=encodeURIComponent(g)+"="+encodeURIComponent(e[g]));return l(p,t.form.passthroughData)}(d,c,u,f,s,i),v=c.form.url+"?"+m;e.location.href=v}else a.saveUserPreferences(c.form.domPrefix,s,(function(){d.debug=o.test(e.location.search)?"1":"0";var a=t.getUrlCanonicalizer(),r=function(e,t,n,a,r){var i=$.extend(!0,{},t);i.page.number=1,i.page.cursor="",r.limitDataModelToFieldsOnSearchForm(n.form.domPrefix,i,n.form.fieldNames);var o=a.queryParamNormalizer.toQueryParams(i,"searchResults",null).queryString||"";return e.debug&&"1"===e.debug&&(o+="&debug=1"),l(o,n.form.passthroughData)}(d,s,c,a,n),i=c.form.url+"?"+r;e.location.href=i}))}}}}]),angular.module("SearchFormServiceUI").factory("userPreferences",["$rootScope","$window","queryParamCollection","sfsDataModelProvider",function(e,t,n,a){var r={},i=null,o={};function l(e,t){if(o[e])return{};if(i)return i;var n=t.user.isInstitutional,a=null!=window.Ancestry&&null!=Ancestry.SFS&&null!=Ancestry.SFS.Settings&&null!=Ancestry.SFS.Settings.UserPreferences,r=null!=window.splitExperiments?window.splitExperiments["international-optimization"]:"off",l=window.sfs_sfsData.cultureId;return(i=!n&&a?angular.copy(Ancestry.SFS.Settings.UserPreferences)||{}:{CategoryBucket:null,CollectionFocus:"0",FirstNameExactness:{Exact:!1,Phonetic:!1,Similar:!1,Initials:!1},LastNameExactness:{Exact:!1,Phonetic:!1,Similar:!1,Soundex:!1},MatchAllTermsExactly:!1,ShowMoreOptions:!1}).CategoryBucket=i.CategoryBucket||"rstp",i.DefaultCollectionFocus="on"===r?"en-US"===l?"0":"1":a?Ancestry.SFS.Settings.DefaultCollectionFocus:"0",i.MatchAllTermsExactly=!0===i.MatchAllTermsExactly,i.ShowMoreOptions=!0===i.ShowMoreOptions,i.FirstNameExactness=i.FirstNameExactness||{Exact:!1,Phonetic:!1,Similar:!1,Initials:!1},i.LastNameExactness=i.LastNameExactness||{Exact:!1,Phonetic:!1,Similar:!1,Soundex:!1},i}function s(e,t,n){e.isExact=n||t.Exact,e.isExact&&$.each(t,(function(t,n){switch(t){case"Phonetic":e.flags.phonetic=n;break;case"Similar":e.flags.similar=n;break;case"Initials":e.flags.initials=n;break;case"Soundex":e.flags.soundex=n}}))}function c(e,t,n){if(t.isExactAllEnabled)return!0;var r=a.getCollectionFocusItem(e,n.defaultSearchBlock);if(t.priority!==r.weightGroupName)return!0;if(!0!==t.types.records||!0!==t.types.stories||!0!==t.types.trees||!0!==t.types.photos)return!0;for(var i=Object.keys(t.events),o=0;o<i.length;++o){var l=i[o],s=t.events[l];if(s.instances.length>0&&"SelfBirth"!==l&&"Self"!==l)return!0;if("Self"===l&&s.instances.length>1)return!0;if(1===s.instances.length){var c=s.instances[0];if(null!=c.date.month||null!=c.date.day)return!0;if("SelfBirth"!==l&&null!=c.date.year)return!0;if("Self"!==l&&null!=c.location&&c.location.length>0)return!0}}var u=Object.keys(t.family);for(o=0;o<u.length;++o){if(t.family[u[o]].instances.length>0)return!0}var d=Object.keys(t.fields);for(o=0;o<d.length;++o){var f=t.fields[d[o]];if(null!=f.value&&f.value.length>0)return!0}return!1}function u(e,t,n,a,r){var i=null!=e&&!0===e.ShowMoreOptions||c(t,n,a);return"V1"===a.querySetVersion&&r.MSAV&&(i="1"===r.MSAV||"2"===r.MSAV||c(t,n,a)),i}return e.$on("clearFormEvent",(function(e,t){o[t]=!0,i=null})),r.updateMetadataDefaults=function(e){var t=a.getMetadata(e),n=l(e,t);t.defaultSearchBlock=null!=n&&void 0!==n.DefaultCollectionFocus?n.DefaultCollectionFocus:t.defaultSearchBlock||"0"},r.applyUserPreferences=function(e){var t=a.getDataModel(e),r=a.getMetadata(e);if(e&&t&&r){var i=n.getUrlParams(),o=l(e,r),c=null!=o&&!0===o.MatchAllTermsExactly,d=r.form.isRefiningSearch;"V1"===r.querySetVersion&&i.MSAV&&(c="-1"===i.MSAV||"2"===i.MSAV),c&&(d?(t.isExactAllEnabled=function(e){if(null!=e.name.givenName&&e.name.givenName.length>0&&!e.name.givenNameExactness.isExact)return!1;if(null!=e.name.surname&&e.name.surname.length>0&&!e.name.surnameExactness.isExact)return!1;for(var t=Object.keys(e.events),n=0;n<t.length;++n)for(var a=e.events[t[n]],r=0;r<a.instances.length;++r){var i=a.instances[r];if(null!=i.date.year&&null==i.dateProximity.year||null!=i.date.month&&null==i.dateProximity.month||null!=i.date.day&&null==i.dateProximity.day)return!1;if(null!=i.location&&i.location.length>0&&!i.locationExactness.isExact)return!1}var o=Object.keys(e.family);for(n=0;n<o.length;++n){var l=e.family[o[n]];for(r=0;r<l.instances.length;++r){var s=l.instances[r];if(null!=s.givenName&&s.givenName.length>0&&!s.givenNameExactness.isExact)return!1;if(null!=s.surname&&s.surname.length>0&&!s.surnameExactness.isExact)return!1}}var c=Object.keys(e.fields);for(n=0;n<c.length;++n){var u=e.fields[c[n]];if(null!=u.value&&u.value.length>0&&!u.isExact)return!1}return!0}(t),t.isExactAllEnabled&&a.matchAllTermsExactly(e,!0)):(t.isExactAllEnabled=!0,a.matchAllTermsExactly(e,!0))),t.isShowMoreOptionsExpanded=u(o,e,t,r,i),null!=o&&(d&&null!=t.name.givenName&&0!==t.name.givenName.length||s(t.name.givenNameExactness,o.FirstNameExactness,t.isExactAllEnabled),d&&null!=t.name.surname&&0!==t.name.surname.length||s(t.name.surnameExactness,o.LastNameExactness,t.isExactAllEnabled));var f="ContentBased"===r.form.type&&r.form.collectionId;if((!d||f)&&(t.page.size=o.ResultsPageSize?o.ResultsPageSize:t.page.size,!f)){var m=null!=o&&null!=o.CollectionFocus?o.CollectionFocus:r.defaultSearchBlock;a.populateCollectionPriority(e,m),o&&o.CategoryBucket&&a.populateCategoryBucketFromString(e,o.CategoryBucket),t.isShowMoreOptionsExpanded=u(o,e,t,r,i),t.showUnviewedRecordsOnly=d?t.showUnviewedRecordsOnly:o.ShowUnviewedRecordsOnly,t.shouldShowUnviewedFilterPopup=o.ShouldShowUnviewedFilterPopup,t.unviewedFilterPopupShownCount=o.UnviewedFilterPopupShownCount}}},r.saveUserPreferences=function(e,t,n){n=n||function(){};var r=t||a.getDataModel(e),i=a.getMetadata(e),o={};if(null!=r.name.givenName&&r.name.givenName.length>0&&-1!==i.form.fieldNames.indexOf("SelfGivenName")&&(o.givenNameExactness=r.name.givenNameExactness),null!=r.name.surname&&r.name.surname.length>0&&-1!==i.form.fieldNames.indexOf("SelfSurname")&&(o.surnameExactness=r.name.surnameExactness),"Global"!==i.form.type&&"OldSearchSimulator"!==i.form.type||(o.types=r.types,o.showMoreOptions=r.isShowMoreOptionsExpanded),o.matchAll=r.isExactAllEnabled,o.showUnviewedRecordsOnly=r.showUnviewedRecordsOnly,o.unviewedFilterPopupShownCount=r.unviewedFilterPopupShownCount,o.shouldShowUnviewedFilterPopup=r.shouldShowUnviewedFilterPopup,i.collectionFocus.isAvailable){var l=i.collectionFocus.items,s=$.grep(l,(function(e){return e.weightGroupName===r.priority})),c=s.length>0?s[0].id:null==r.priority||""===r.priority?"":null;null!=c&&(o.collectionFocus=c)}0===Object.keys(o).length?n():$.ajax({type:"POST",url:i.ancestryDomain+"/api/search-preferences",crossDomain:!0,xhrFields:{withCredentials:!0},contentType:"application/json",data:JSON.stringify(o),processData:!1,dataType:"json",timeout:1e3,success:n,error:n})},r.getUserPreferences=r}]),angular.module("SearchFormServiceUI").service("sfsQuickTilesUtils",["$window",function(e){this.getFormType=function(){return"undefined"!=typeof sfs_ScopeMetadata&&sfs_ScopeMetadata.form&&sfs_ScopeMetadata.form.type?e.sfs_ScopeMetadata.form.type:void 0},this.getCultureId=function(){return"undefined"!=typeof sfs_sfsData&&sfs_sfsData.cultureId?e.sfs_sfsData.cultureId:void 0},this.getQuickFillVersion=function(){if("undefined"!=typeof Ancestry&&Ancestry.SFS&&Ancestry.SFS.Settings&&Ancestry.SFS.Settings.QuickfillVersion)try{return JSON.parse(e.Ancestry.SFS.Settings.QuickfillVersion).version}catch(e){return"normal"}},this.getVersionSettings=function(){var e={v1:{givenName:!0,surname:!0,quickTiles:!1},v2:{givenName:!0,surname:!0,quickTiles:!0},v3:{givenName:!1,surname:!1,quickTiles:!0},normal:{givenName:!0,surname:!1,quickTiles:!1}},t=e[this.getQuickFillVersion()]||e.normal;return{isGivenNameVisible:t.givenName,isSurnameVisible:t.surname,isQuickTilesVisible:t.quickTiles}}}]),angular.module("SearchFormServiceUI").service("sfsDataModelProvider",["$rootScope","$window","$timeout","urlCanonicalizerProvider","sfsLocationExactnessProvider",function(e,t,n,a,r){var i={date:{day:null,month:null,year:null},dateProximity:{day:null,month:null,year:null},gpid:"",location:"",locationExactness:{isExact:!1,isAdjacent:!1,level:null}},o={date:{day:null,month:null,year:null},dateProximity:{day:0,month:0,year:0},gpid:"",location:"",locationExactness:{isExact:!0,isAdjacent:!1,level:0}},l={givenName:"",surname:"",secondSurname:"",givenNameExactness:{flags:{phonetic:!1,similar:!1,initials:!1},isExact:!1},surnameExactness:{flags:{phonetic:!1,similar:!1,soundex:!1},isExact:!1}},s={value:"",isExact:!1},c={};unction d(n){if(null==c[n]){var a,r=u(n),i=null!=window.splitExperiments?window.splitExperiments["international-optimization"]:"off",o=window.sfs_sfsData.cultureId;t.ancestry&&t.ancestry.search&&t.ancestry.search.dataModel?(a=t.ancestry.search.dataModel,c[n]=a):(a="on"===i&&"en-US"!==o?{searchSource:null,types:{records:!0,stories:!0,trees:!0,photos:!0},name:$.extend(!0,{},l),isShowMoreOptionsExpanded:!1,isExactAllEnabled:!1,events:{},family:{},fields:{SelfGender:$.extend(!0,{},s,{relation:"Self",eventName:"",assertion:"Gender"}),SelfRace:$.extend(!0,{},s,{relation:"Self",eventName:"",assertion:"Race"}),keyword:$.extend(!0,{},s,{relation:"",eventName:"",assertion:"keyword"})},page:{number:1,cursor:null,size:20},location:[],priority:"fromquery",range:{yearStart:null,yearEnd:null},treePerson:{treeId:null,personId:null}}:{searchSource:null,types:{records:!0,stories:!0,trees:!0,photos:!0},name:$.extend(!0,{},l),isShowMoreOptionsExpanded:!1,isExactAllEnabled:!1,events:{},family:{},fields:{SelfGender:$.extend(!0,{},s,{relation:"Self",eventName:"",assertion:"Gender"}),SelfRace:$.extend(!0,{},s,{relation:"Self",eventName:"",assertion:"Race"}),keyword:$.extend(!0,{},s,{relation:"",eventName:"",assertion:"keyword"})},page:{number:1,cursor:null,size:20},location:[],priority:"default",range:{yearStart:null,yearEnd:null},treePerson:{treeId:null,personId:null}},c[n]=a,g(n)),$.each(r.events,(function(e,t){a.events[e]=a.events[e]||{instances:[]},a.events[e].relation=t.relation,a.events[e].eventName=t.eventName})),$.each(r.customEvents,(function(e,t){null==a.events[e]&&(a.events[e]={relation:t.relation,eventName:t.eventName,instances:[]})})),$.each(r.fields,(function(e,t){a.fields[e]=a.fields[e]||{value:"",isExact:!1,relation:t.relation,eventName:t.eventName,assertion:t.assertion}})),$.each(r.family,(function(e,t){for(a.family[e]=a.family[e]||{instances:[]};a.family[e].instances.length<t.instances;)N.addFamilyMember(n,e)})),$.each(r.singletonEvents,(),function(t,n){e.sfsDataModels=e.sfsDataModels||{},e.sfsDataModels[t]=n,e.$watch("sfsDataModels."+t,(function(e,a){!function(e,t,n,a){if(e.isExactAllEnabled=!0===e.isExactAllEnabled&&!0===e.name.givenNameExactness.isExact&&!0===e.name.surnameExactness.isExact,!e.isExactAllEnabled)return void(n.isExactAllEnabled!=a.isExactAllEnabled&&P(t,e.isExactAllEnabled));for(var r=Object.keys(e.events),i=0;i<r.length;++i)for(var o=e.events[r[i]],l=0;l<o.instances.length;++l){var s=o.instances[l];if(null==s.dateProximity.year||null==s.dateProximity.month||null==s.dateProximity.day||!1===s.locationExactness.isExact)return void(e.isExactAllEnabled=!1)}var c=Object.keys(e.family);for(i=0;i<c.length;++i){var u=e.family[c[i]];for(l=0;l<u.instances.length;++l){var d=u.instances[l];if(!1===d.givenNameExactness.isExact||!1===d.surnameExactness.isExact)return void(e.isExactAllEnabled=!1)}}var f=Object.keys(e.fields);for(i=0;i<f.length;++i){if(!e.fields[f[i]].isExact)return void(e.isExactAllEnabled=!1)}}(n,t,e,a)}),!0)}(n,a)}return c[n]}function f(e,t){"personPicker"===t&&N.resetData(e)}function m(e,t,n,a){var i=N.getDataModel(e);f(e,n),function(e,t){var n=N.getDataModel(e);n.fields.SelfRace.value=t._83004002||"",n.fields.SelfRace.isExact="1"===t._83004002_x}(e,t),function(e,t){var n=N.getDataModel(e),a=t["_83004003-n_xcl"];n.fields.SelfGender.value="m"===a?"female":"f"===a?"male":null;n.fields.SelfGender.isExact=!1}(e,t),function(e,t){var n=N.getDataModel(e);n.fields.keyword.value=t.gskw||"",n.fields.keyword.isExact="1"===t.gskw_x}(e,t),function(e,t){var n=N.getDataModel(e);if(!n)return;if(!t||!t.MSAV)return;switch(parseInt(t.MSAV)){case 2:n.isExactAllEnabled=!0,n.isShowMoreOptionsExpanded=!0;break;case 1:n.isExactAllEnabled=!1,n.isShowMoreOptionsExpanded=!0;break;case 0:n.isExactAllEnabled=!1,n.isShowMoreOptionsExpanded=!1;break;case-1:n.isExactAllEnabled=!0,n.isShowMoreOptionsExpanded=!1}}(e,t),function(e,t){var n=N.getDataModel(e);n.name.givenName=t.gsfn||"",N.getMetadata(e).name.usesParentSurnameFields&&(t.gsfln||t.gssln)?(n.name.surname=t.gsfln||"",n.name.secondSurname=t.gssln||""):n.name.surname=t.gsln||"";function a(e,t){"0"!==t&&t?"1"===t?(e.isExact=!0,$.each(e.flags,(function(t){e.flags[t]=!1}))):($.each(t.split("_"),(function(t,n){switch(n){case"NP":e.flags.phonetic=!0;break;case"NN":e.flags.similar=!0;break;case"NIC":e.flags.initials=!0;break;case"NS":e.flags.soundex=!0}})),e.isExact=!0):(e.isExact=!1,$.each(e.flags,())}a(n.name.givenNameExactness,t.gsfn_x),a(n.name.surnameExactness,t.gsln_x)}(e,t),function(e,t){function n(e,a,r){var i=e+a+(r=r||""),o=t[i];return null==o&&0==a&&(o=t[i=e+r]),null==o&&"__ftp"==r?n(e,a,"-ftp"):o}function a(e){if(null==e)return null;var t=e.split("|");if(t.length<3)return null;var n=parseInt(t.splice(0,1)[0])||null;t.pop();for(var a=[],r=Math.max(11,n+1),i=0;i<r;++i)a.push(0);var o=!1;return t.forEach((function(e){var t=parseInt(e);isNaN(t)?o=!0:a.push(t)})),o?null:{level:n,idHierarchy:a}}function i(t,i,o){var l=w(e,t),s=parseInt((n(i.day,o)||"")+"")||null,c=null!=s,u=parseInt((n(i.month,o)||"")+"")||null,d=null!=u,f=parseInt((n(i.year,o)||"")+"")||null,m=null!=f,v=n(i.location,o,"__ftp")||"";if(v.length>0||m||d||c){var p=l?N.getEvent(e,t):N.addEvent(e,t);p.date.year=f,p.date.month=u,p.date.day=s,p.location=v;var g=n(i.year,o,"_x"),h=n(i.month,o,"_x"),S=n(i.day,o,"_x"),E=parseInt(n(i.yearProximity,o))||null,P=-1!==$.inArray(g,y)||-1!==$.inArray(h,y)||-1!==$.inArray(S,y);p.dateProximity.year=P?null!=E?E:0:null;var b=n(i.location,o,"__ftp_x")||n(i.location,o,"-ftp_x"),F=n(i.location,o,"_x"),I=n(i.location,o),C=a(n(i.location,o,"_PInfo"));p.gpid=null!=I&&I.length>0?I:null,p.locationExactness.isExact=null!=p.gpid?-1!==$.inArray(F,x):-1!==$.inArray(b,y),p.locationExactness.level=p.locationExactness.isExact?0:null,p.locationExactness.isAdjacent=!1,null!=p.location&&null!=p.gpid&&(null!=C&&r.cachePlaceByPrefixResponse({Id:p.gpid,HName:p.location,IdHierarchy:C.idHierarchy,LevelId:C.level,fromPlaceByPrefix:!1}),r.getPlaceInfoByPrefixMatchingGpid(e,p.location,p.gpid,(function(e,t){!function(e,t,n){if(t.locationExactness.isExact&&-1!==$.inArray(n,x)){var a=r.getExactnessFromStr(t.gpid,n)||{relativeLevel:0,isAdjacent:!1};t.locationExactness.level=a.relativeLevel,t.locationExactness.isAdjacent=a.isAdjacent,t.locationExactness.level<0&&(t.locationExactness.level=0,t.locationExactness.isAdjacent=!1)}}(0,p,F)})))}}ar l=u(e);$.each(l.events,(function(e,t){t.alias&&$.each(t.alias,(function(n,a){for(var r=0;r<t.max;++r){var l={day:o(a,"dd"),month:o(a,"dm"),year:o(a,"dy"),yearProximity:o(a,"dp"),location:o(a,"pn")};i(e,l,r)}}))})),$.each(l.customEvents,(function(e,t){i(e,{day:t.daySearchKey,month:t.monthSearchKey,year:t.yearSearchKey,yearProximity:t.yearProximitySearchKey,location:t.locationSearchKey},0)}))}(e,t),function(e,t){var n=u(e);Object.keys(n.family).forEach((function(a){for(var r=n.family[a],i=-1;i<r.maxCount;i++){var o=S(e,t,a,i,null);E(e,t,a,i,o)}}))}(e,t),function(e,t){var n=N.getDataModel(e);if(!n)return;var a=u(e),r=["","-n","__n"];$.each(n.fields,(function(e,n){var i=a.fields[e];if(null!=i)for(var o=i.searchKey,l=0;l<r.length;++l){var s=t[o+r[l]];void 0!==s&&(n.value=s);var c=t[o+r[l]+"_x"];void 0!==c&&(n.isExact="1"===c)}}))}(e,t),function(e,t){var n=N.getDataModel(e),a=t.ossyear;null!=a&&(n.range.yearStart=parseInt(a)||null);var r=t.ossyearend;null!=r&&(n.range.yearEnd=parseInt(r)||null)}(e,t),i.viewMode="1"===t.MSV?"category":"record";var o=/pt_t([^_]+)_p(([^_]|$)+)/;if(t.ssrc&&o.test(t.ssrc)){var l=t.ssrc.match(o);i.treePerson.treeId=l[1],i.treePerson.personId=l[2]}t.cp&&v(e,t.cp),i.searchType=t.searchType||"form",t&&t.catBucket?h(e,t.catBucket):t&&t.catbucket&&h(e,t.catbucket),i.limitRecordsToCountry="0"===t.sbo,i.isExactAllEnabled&&b(e,i.isExactAllEnabled),a()}function v(e,t){var n=p(e,t),a=N.getDataModel(e);n&&(a&&a.location&&(a.location.length=0),$.merge(a.location||[],n.locationGpids||[]),a.priority=n.weightGroupName||"default")}function p(e,t){var n=u(e).collectionFocus.items;return $.grep(n,(function(e){return e.id===t}))[0]}function g(e){h(e,"OLDSEARCHSIMULATOR"===u(e).form.type.toUpperCase()?"r":"rstp")}function h(e,t){var n=d(e);n.types.records=-1!==t.indexOf("r"),n.types.stories=-1!==t.indexOf("s"),n.types.trees=-1!==t.indexOf("t"),n.types.photos=-1!==t.indexOf("p"),n.types.records||n.types.stories||n.types.trees||n.types.photos||g(e)}t.sfsDataModels=c;var y=["1","XO"],x=["1","PCO","PACO","PS","PAS","PC"];function S(e,t,n,a,r){var i=u(e).family[n].givenNameParam+(-1===a?"":a),o=i+"_x",l=t[i];return null==l||null==(r=r||I(e,n,Math.max(a,0)))?null:(r.givenName=l,r.givenNameExactness.isExact="1"===t[o],r)}function E(e,t,n,a,r){var i=u(e).family[n],o=-1===a?"":a.toString(),l=i.surnameParam+o,s=l+"_x",c=t[l];if(null!=c){if(null==(r=r||I(e,n,Math.max(a,0))))return null;var d=i.surnameParam+"f"+o,f=i.surnameParam+"s"+o;return N.getMetadata(e).name.usesParentSurnameFields&&(t[d]||t[f])?(r.surname=t[d]||"",r.secondSurname=t[f]||""):r.surname=c,r.surname=r.surname.replace(/ +/g," ").replace(/ y /gi," "),r.surnameExactness.isExact="1"===t[s],r.secondSurname=r.secondSurname.replace(/ +/g," ").replace(/ y /gi," "),r}}function P(e,t){var n=N.getDataModel(e);n.name.givenName||(n.name.givenNameExactness.isExact=t),n.name.surname||(n.name.surnameExactness.isExact=t),$.each(n.events,(function(e,n){$.each(n.instances,(function(e,n){if(n.date){var a=Object.values(n.date);if(a){var r=!1;a.forEach((),r&&(n.dateProximity.day||0==n.dateProximity.day||(n.dateProximity.day=t||null),n.dateProximity.month||0==n.dateProximity.month||(n.dateProximity.month=t||null),n.dateProximity.year||0==n.dateProximity.month||(n.dateProximity.year=t||null))}}n.location||(n.locationExactness.isExact=t)}))})),$.each(n.family,(function(e,n){$.each(n.instances,(function(e,n){n.givenName||(n.givenNameExactness.isExact=t),n.surname||(n.surnameExactness.isExact=t)}))})),$.each(n.fields,()}function b(e,t){var n=N.getDataModel(e);function a(e){$.each(e,()}n.isExactAllEnabled=t,n.limitRecordsToCountry=t,n.name.givenNameExactness.isExact=t,n.name.surnameExactness.isExact=t,t||(a(n.name.givenNameExactness.flags),a(n.name.surnameExactness.flags)),$.each(n.events,(function(e,n){$.each(n.instances,(function(e,n){n.dateProximity.day=t?null!=n.dateProximity.day?n.dateProximity.day:0:null,n.dateProximity.month=t?null!=n.dateProximity.month?n.dateProximity.month:0:null,n.dateProximity.year=t?null!=n.dateProximity.year?n.dateProximity.year:0:null,n.locationExactness.isExact=t,n.locationExactness.level=t?null!=n.locationExactness.level?n.locationExactness.level:0:null,n.locationExactness.isAdjacent=t&&n.locationExactness.isAdjacent}))})),$.each(n.family,(function(e,n){$.each(n.instances,()})),$.each(n.fields,()}function w(e,t){var n=u(e);return-1!==$.inArray(t,n.singletonEvents)}function F(e,t){var n=N.getDataModel(e).family[t];if(!n)throw new Error('dataModelProvider does not have a data model with "family.'+t+'" property');return n}function I(e,t,n){var a=function(e,t,n){var a=F(e,t);return n=void 0===n?0:n,null==a||n<0||n>=a.instances.length?null:a.instances[n]}(e,t,n);return null==a&&(a=N.addFamilyMember(e,t)),a}function C(e,t){var n=u(e),a=F(e,t);if(a.instances.length>=n.family[t].maxCount)return null;var r=$.extend(!0,{},l);return N.getDataModel(e).isExactAllEnabled&&(r.givenNameExactness.isExact=!0,r.surnameExactness.isExact=!0),a.instances.push(r),r}function k(e,t){if(!t)return!1;for(var n=0;n<t.length;n++)if(t[n].toLowerCase()===e.toLowerCase())return!0;return!1}var N={unchangedDataModel:function(e){return e&&(c.unchangedData=e),c.unchangedData||{}},getDataModel:d,getMetadata:u,resetData:function(e){var t=N.getDataModel(e);t.limitRecordsToCountry=!1,t.searchSource=null,function(e){var t=u(e);return"ContentBased"===t.form.type&&t.form.collectionId}(e)||v(e,N.getMetadata(e).defaultSearchBlock),g(e),$.extend(!0,t.name,l),t.isExactAllEnabled=!1,$.each(t.events,(function(t,n){w(e,t)?($.extend(!0,n.instances[0],i),n.instances.length>1&&n.instances.splice(1,n.instances.length-1)):n.instances.length=0})),$.each(t.fields,(),t.range.yearStart=null,t.range.yearEnd=null,function(e){var t=N.getDataModel(e),n=N.getMetadata(e),a=Object.keys(t.family);a.forEach((function(t){F(e,t).instances.length=0;for(var a=0;a<n.family[t].instances;++a)C(e,t)}))}(e),t.treePerson.treeId="",t.treePerson.personId=""},populateFromData:function(e,r,i,o){return o=o||function(){},N.getDataModel(e)?r?void("V2"===u(e).querySetVersion?function(e,r,i,o){var l=N.getDataModel(e),s=null!=((t.ancestry||{}).search||{}).dataModel;if("onload"===i&&s)return l.limitRecordsToCountry="0"===r.sbo,o();"onload"===i&&t.Ancestry&&t.Ancestry.SFS&&t.Ancestry.SFS.InitialValues&&m(e,t.Ancestry.SFS.InitialValues,"",(function(){}));a.getUrlCanonicalizer().queryParamNormalizer.getDataModel(r,"searchResults",null,(function(t,a){n((function(){f(e,i),a.searchSource=l.searchSource,a.categories=l.categories,a.collections=l.collections,a.showUnviewedRecordsOnly=l.showUnviewedRecordsOnly,$.extend(!0,a.page,l.page),$.extend(!0,l,a),function(e,t){for(var n=u(e),a=Object.keys(t.family),r=0;r<a.length;++r){var i=a[r],o=n.family[i],l=t.family[i];for(l.instances.splice(o.maxCount,Math.max(l.instances.length-o.maxCount,0));l.instances.length<o.instances;)C(e,i)}}(e,l),l.limitRecordsToCountry="0"===r.sbo,l.isExactAllEnabled&&b(e,l.isExactAllEnabled),o()}),1)}))}(e,r,i,o):m(e,r,i,o)):(f(e,i),o()):o()},matchAllTermsExactly:b,matchAllPrevTermsExactly:P,getEventGroup:function(e,t){return N.getDataModel(e).events[t]},getEvent:function(e,t,n){var a=N.getEventGroup(e,t);return n=void 0===n?0:n,null==a||n<0||n>=a.instances.length?null:a.instances[n]},getEventGroupMaxCount:function(e,t){return w(e,t)?1:N.getMetadata(e).events[t].max},addEvent:function(e,t,n){var a=N.getEventGroup(e,t);if(w(e,t)&&a.instances.length>0)return a.instances[0];var r=void 0===n?a.instances.length:n;if(null==a||r<0||r>a.instances.length)return null;if(a.instances.length+1>N.getEventGroupMaxCount(e,t))return null;var l=N.getDataModel(e).isExactAllEnabled?o:i,s=$.extend(!0,{},l);return a.instances.splice(r,0,s),s},removeEvent:function(e,t,n){if(!w(e,t)){var a=N.getEventGroup(e,t);if(null!=a){var r=void 0===n?a.instances.length-1:n;r<0||r>=a.instances.length||a.instances.splice(r,1)}}},addFamilyMember:C,removeFamilyMember:function(e,t,n){var a=F(e,t);n<0||n>=a.instances.length||a.instances.splice(n,1)},getCategoryBucketString:function(e){var t=d(e),n="";return t.types.records&&(n+="r"),t.types.stories&&(n+="s"),t.types.trees&&(n+="t"),t.types.photos&&(n+="p"),n},getCollectionFocusItem:p,populateCategoryBucketFromString:h,populateCollectionPriority:v,limitDataModelToFieldsOnSearchForm:function(e,t,n){!function(e,t){e.name.givenName&&!k("SelfGivenName",t)&&(e.name.givenName="");e.name.surname&&!k("SelfSurname",t)&&(e.name.surname="",e.name.secondSurname="")}(t,n),function(e,t,n){Object.keys(t.events).forEach((function(a){var r=t.events[a],i=r.instances,o=(r.relation||"")+(r.eventName||"");r.instances.length>1&&w(e,a)&&r.instances.splice(1,r.instances.length-1);for(var l=0;l<i.length;l++){var s=i[l];s.date.day&&!k(o+"Day",n)&&(s.date.day=null),s.date.month&&!k(o+"Month",n)&&(s.date.month=null),s.date.year&&!k(o+"Year",n)&&(s.date.year=null),s.location&&!k(o+"Place",n)&&(s.gpid=null,s.location=null)}}))}(e,t,n),function(e,t){Object.keys(e.family).forEach((function(n){for(var a=e.family[n].instances,r=n,i=0;i<a.length;i++){var o=a[i];o.givenName&&!k(r+"GivenName",t)&&(o.givenName=""),o.surname&&!k(r+"Surname",t)&&(o.surname="")}}))}(t,n),function(e,t){Object.keys(e.fields).forEach((function(n){var a=e.fields[n];a.value&&!k(n,t)&&(a.value=null)}))}(t,n)}};return N}]),function(){function e(e,t,n,a){if(!e.filters||!e.filters[t])return a(new Error("No Filter Found for "+t));for(var r=e.filters[t],i=0;i<n.length;++i){for(var o=n[i],l=0;l<r.options.length;++l)if(r.options[l].value===o){r=r.options[l].filter;break}if(!r)return a(new Error("No Filter Found for "+t+" for value path "+n.join(", ")))}a(null,function(e){var t={};angular.copy(e,t);for(var n=0;n<t.options.length;++n)t.options[n].isLeaf=null==t.options[n].filter,t.options[n].filter=null;return t}(r))}function t(e,t,a,r){if(!e.filters||!e.filters[t])return r(new Error("No Filter Found for "+t));var i=n(e.filters[t],a);return null==i?r(new Error('Could not find value path for "'+t+'" with value "'+a+'"')):r(null,i)}function n(e,t){for(var a=0;a<e.options.length;++a){var r=e.options[a];if(null==r.filter){if(r.value===t)return[t]}else{var i=n(r.filter,t);if(i)return i.splice(0,0,r.value),i}}return null}angular.module("SearchFormServiceUI").service("sfsFilterHierarchyService",["$window","sfsDataModelProvider",function(n,a){return{getFieldFilter:function(t,n,r,i){e(a.getMetadata(t),n,r,i)},getPlaceFilter:function(t,n,r,i){e(a.getMetadata(t),n,r,i)},getValuePathFromFieldValue:function(e,n,r,i){t(a.getMetadata(e),n,r,i)},getValuePathFromPlaceValue:function(e,n,r,i){t(a.getMetadata(e),n,r,i)}}}])}(),angular.module("SearchFormServiceUI").service("sfsLocationExactnessProvider",["$window","$rootScope",function(e,t){var n={},a=["1","PCO","PACO","PS","PAS","PC"],r={},i={},o=[{id:"cty",absoluteLevel:8,supportsAdjacency:!1,acronym:"1"},{id:"cnty",absoluteLevel:7,supportsAdjacency:!0,acronym:"PCO",adjacentAcronym:"PACO"},{id:"st",absoluteLevel:5,supportsAdjacency:!0,acronym:"PS",adjacentAcronym:"PAS"},{id:"ctry",absoluteLevel:3,supportsAdjacency:!1,acronym:"PC"}],l={};function s(t){return function(t){if(!u(t))return null;var n=[],a=e.ancestry.search.locationExactnesses[t],r=-1;return a.forEach((function(e){++r;var t=l[e];n.push(c(t,!1,r)),t.supportsAdjacency&&n.push(c(t,!0,r))})),n}(t)||function(e){if(null==e||null==n[e])return[];var t=[],a=n[e],r=-1;return o.forEach((function(e){e.absoluteLevel>a.level||function(e,t){if(7===e.absoluteLevel){if(-1!==$.inArray(5027,t.idHierarchy)||-1!==$.inArray(3243,t.idHierarchy))return!0}else if(5===e.absoluteLevel&&(-1!==$.inArray(5250,t.idHierarchy)||-1!==$.inArray(3251,t.idHierarchy)||-1!==$.inArray(3250,t.idHierarchy)))return!0;return!1}(e,a)||(++r,t.push(c(e,!1,r)),e.adjacentAcronym&&t.push(c(e,!0,r)))})),t}(t)||[]}function c(e,t,n){return{absoluteLevel:e.absoluteLevel,acronym:t?e.adjacentAcronym:e.acronym,isAdjacent:t,relativeLevel:n}}function u(t){return null!=e.ancestry&&null!=e.ancestry.search&&null!=e.ancestry.search.locationExactnesses&&null!=e.ancestry.search.locationExactnesses[t]}return o.forEach((),{getPlaceInfoByPrefixMatchingGpid:function(a,o,l,s){if(u(l)){s(null,{idHierarchy:[],level:0})}else{if(s=s||null==o||0===o.length)return s(new Error("Location must not be null or empty"));if(i[o]){var c=i[o];return s(null,n[c])}var d=r[o];if(d)d.listeners.push(s);else{d={listeners:[s]},r[o]=d;var f=e[a+"sfsData"],m=(f.eventPlace.placePickerUrl||"//placepfx.ancestry.com/s/")+"?callback=?&maxCount=4&cultureId="+(f.cultureId||"en-US"),v=this;$.ajax({url:m+"&prefix="+encodeURIComponent(o),dataType:"jsonp",timeout:/(^|&|[?])debug=1($|&)/.test(e.location.search||"")?8e3:2e3,success:function(e){if(null==e||e.length<=0)return g();for(var a=null,r=0;r<e.length;++r){var i=e[r];if(i.Id.toString()===l){a=i;break}}if(null==a)return g();t.$apply((function(){v.cachePlaceByPrefixResponse(a),p(null,n[l])}))},error:g})}}function p(e,t){d.listeners.forEach((),delete r[o]}function g(){t.$apply((function(){n[l]?p(null,n[l]):p(new Error("Could not find place info from the place by prefix service with a matching gpid for "+o+" | "+l))}))}},cachePlaceByPrefixResponse:function(e){var t=e.Id.toString(),a={name:e.HName,idHierarchy:e.IdHierarchy,level:e.LevelId};n[t]=a,!1!==e.fromPlaceByPrefix&&(i[a.name]=t)},getExactnesses:function(t,n){var a=e[t+"sfsData"],r=a.eventPlaceExactnessDisplay,i=a.eventPlaceExactnessSelectDisplay;var o=s(n);return o.forEach((function(e){var t;(t=e).optionString=i[t.acronym],t.exactnessString=r[t.acronym]})),o},getExactnessFromStr:function(e,t){if(null==e||null==t||-1===a.indexOf(t))return null;for(var n=s(e),r=0;r<n.length;++r){var i=n[r];if(i.acronym===t)return i}return null}}}]),function(){var e=[];angular.module("SearchFormServiceUI").service("sfsObjectCache",[function(){return{set:function(t,n,a,r){e[n]=e[n]||{cacheItemsByPath:{},cacheItemsWithNullPath:[]};var i=e[n],o=null;null==r?o=i.cacheItemsWithNullPath:(i.cacheItemsByPath[r]=i.cacheItemsByPath[r]||[],o=i.cacheItemsByPath[r]);for(var l=0;l<o.length;++l)if(o[l]===a)return;o.push({object:a,item:t})},get:function(t,n,a){var r=e[t];if(!r)return null;var i=null;if(null==(i=null==a?r.cacheItemsWithNullPath:r.cacheItemsByPath[a]))return null;for(var o=0;o<i.length;++o){var l=i[o];if(l.object===n)return l.item}return null}}}])}(),function(){function e(e,t){if(!e.hasOwnProperty("LifeEvents")||0===e.LifeEvents.length)return[];var n=$.extend(!0,[],e.LifeEvents);"ContentBased"===t.form.type&&(n=function(e,t){var n=t.collection.yearRange.start,a=t.collection.yearRange.end,r=e.filter((),i=e.filter((function(e){return"r"===e.Type&&e.hasOwnProperty("Date")&&e.Date.hasOwnProperty("Year")&&null!=e.LocationText&&e.LocationText.length>0}));if(0===i.length)return r;var o=i.filter(().sort((function(e,t){return e.Date.Year-t.Date.Year}));if(0===o.length){var l=i.filter(().sort((function(e,t){return t.Date.Year-e.Date.Year}));l.length>0&&o.push(l[0]);var s=i.filter(().sort(();s.length>0&&o.push(s[0])}return r.concat(o)}(n,t));for(var a={},r=0;r<n.length;r++){var i=n[r],o=a[i.Type]||0;a[i.Type]=++o;var l="r"===i.Type&&o>4,s="y"===i.Type&&o>11,c="r"!==i.Type&&"y"!==i.Type&&o>1;if(l||s||c)n.splice(r,1),--r;else{var u=i.Date;"r"===i.Type&&u&&(u.Day=null,u.Month=null,u.Year=null)}}return n}function t(e,t){var n=e.Surname?e.Surname.split(" "):[];if("f"===e.Gender&&!t.name.usesParentSurnameFields){var a=e.SpouseSurnames||[],r=t.name.spouseSurnameLimit,i=a.length>=r?r:a.length;a=a.slice(0,i),(e.MaidenName||"").replace(/ +/g," ").replace(/ y /gi," ").length>0&&(n=n.concat(e.MaidenName.split(" "))),n=n.concat(a)}var o={},l=[];return n.forEach((function(e){null!==e&&e.length>0&&!o.hasOwnProperty(e.toLowerCase())&&(o[e.toLowerCase()]=!0,l.push(e))})),l.join(" ")}function n(t,n){var a={r:{relation:"Self",eventName:"Residence"},b:{relation:"Self",eventName:"Birth"},d:{relation:"Self",eventName:"Death"},m:{relation:"Self",eventName:"Marriage"},y:{relation:"Self",eventName:""}},r=e(t,n);if(0===r.length)return{};var i={};return r.forEach((function(e){var t=a[e.Type];if(null!=t){var n=t.relation+t.eventName,r=i[n]||{instances:[],relation:t.relation,eventName:t.eventName};i[n]=r;var o=e.Date||{},l=null!==e.LocationText&&e.LocationGpids&&null!=e.LocationGpids&&e.LocationGpids.Gpid&&null!=e.LocationGpids.Gpid?e.LocationGpids.Gpid.toString():null;r.instances.push({date:{day:o.Day||null,month:o.Month||null,year:o.Year||null},location:e.LocationText||null,gpid:l})}})),i}function a(e,t){if(!e.hasOwnProperty("FamilyMembers")||0===e.FamilyMembers.length)return{};var n={c:"child",f:"father",m:"mother",s:"spouse",b:"sibling"},a={},r={};return e.FamilyMembers.forEach((function(e){var i=n[e.Relationship];if(null!=i){var o=a[i]||0;if(!("child"!==i&&"spouse"!==i&&"sibling"!==i&&o>0)){a[i]=o+1;var l={};e.GivenName&&(l.givenName=e.GivenName),l.surname=e.Surname,t.name.usesParentSurnameFields&&(l.surname=e.FatherSurname,l.secondSurname=e.MotherSurname),(l.givenName||l.surname||l.secondSurname)&&(r[i]||(r[i]={instances:[]}),r[i].instances.push(l))}}})),r}function r(e){var t={value:null,isExact:!1,relation:"Self",eventName:"",assertion:"Gender"};return"m"===e.Gender?t.value="male":"f"===e.Gender?t.value="female":t.value=null,t}function i(e,n){if(!n.name.usesParentSurnameFields){var a=t(e,n);return{givenName:e.GivenName||"",surname:a}}return{givenName:e.GivenName||"",surname:e.FatherSurname||"",secondSurname:e.MotherSurname||""}}angular.module("SearchFormServiceUI").service("sfsPersonPickerService",["$window","$rootScope","queryParamCollection","sfsDataModelProvider","urlCanonicalizerProvider",function(o,l,s,c,u){var d,f;return{updateModelFromPersonPickerResponse:function(o,d,f){var m=c.getDataModel(o),v=c.getMetadata(o),p=null;if("V2"===v.querySetVersion){var g=function(e,t,o,l){return{name:i(e,t),fields:{SelfGender:r(e)},events:n(e,t),family:a(e,t),treePerson:{treeId:e.TreeId,personId:e.PersonId},priority:o.priority,location:$.extend(!0,[],o.location),searchType:l}}(d,v,m,f);c.limitDataModelToFieldsOnSearchForm(o,g,v.form.fieldNames);var h=u.getUrlCanonicalizer().queryParamNormalizer.toQueryParams(g,"searchResults",null);p=h.params}else{var y=$.grep(v.collectionFocus.items,()[0],x={cp:y?y.id.toString():"0",catBucket:c.getCategoryBucketString(o)};p=function(n,a,r,i){var o=$.extend({},r);o.ssrc="pt_t"+n.TreeId+"_p"+n.PersonId,n.hasOwnProperty("LifeEvents")&&n.LifeEvents.length>0&&function(t,n,a){var r=e(n,a),i={};r.forEach((function(e){var n=i[e.Type]||0;i[e.Type]=n+1;var a=e.Date;if(a){if(a.Day){var r="ms"+e.Type+"dd"+n;t[r]=a.Day}if(a.Month){var o="ms"+e.Type+"dm"+n;t[o]=a.Month}if(a.Year){var l="ms"+e.Type+"dy"+n;t[l]=a.Year}}if(e.LocationText){var s="ms"+e.Type+"pn"+n;if(t[s+"__ftp"]=e.LocationText,e.LocationGpids){e.LocationGpids.Gpid&&(t[s]=e.LocationGpids.Gpid.toString());var c=e.LocationGpids.GpidHierarchyIndex,u=e.LocationGpids.GpidHierarchy;c&&u&&(t[s+"_PInfo"]=c+"-|"+u.join("|")+"|")}}}))}(o,n,a);n.hasOwnProperty("FamilyMembers")&&n.FamilyMembers.length>0&&function(e,t,n){var a={};t.FamilyMembers.forEach((function(t){var r=t.Relationship,i=a[r]||0,o=0===i?"":i.toString();if(!("c"!==r&&"s"!==r&&"b"!==r&&i>0)){if(a[r]=i+1,t.GivenName)e["ms"+r+"ng"+o]=t.GivenName;if(t.Surname){var l="ms"+r+"ns"+o,s=t.Surname.replace(/ +/g," ").replace(/ y /gi," ");e[l]=s,n.name.usesParentSurnameFields&&(e["ms"+r+"nsf"+o]=t.FatherSurname,e["ms"+r+"nss"+o]=t.MotherSurname)}}}))}(o,n,a);n.hasOwnProperty("Gender")&&n.Gender&&(o["_83004003-n_xcl"]="m"===n.Gender?"f":"m");n.hasOwnProperty("GivenName")&&n.GivenName&&(o.gsfn=n.GivenName);var l=t(n,a);return o.gsln=l,o.gsfln=n.FatherSurname,o.gssln=n.MotherSurname,o.MSAV="1",o.searchType=i,o}(d,v,x,f)}l.$apply((function(){s.updatePersonPickerParams(p),l.$broadcast("personPickerUpdated",o),m.isShowMoreOptionsExpanded=!0}))},getTreeId:function(){return d},setTreeId:function(e){d=e},setTreeData:getTreeData:}])}();
//# sourceMappingURL=bundle-search-forms-v2-8240c8ea.min.js.map