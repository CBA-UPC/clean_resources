/**
 * @author  <github.com/tarampampam>
 * @weblog  http://blog.kplus.pro/
 * @project https://github.com/tarampampam/jquery.textmistake
 *
 * @version 0.1
 *
 * @licensy Licensed under the MIT, license text: http://goo.gl/JsVjCF
 */
!function(e){e.fn.textmistake=function(t){var n={l10n:{title:"Report a typo author:",urlHint:"Url of the page with error:",errTextHint:"Text with the error:",yourComment:"Your comment:",userComment:"Comment by user:",commentPlaceholder:"Type comment",cancel:"Cancel",send:"Send",mailSubject:"Typo on the site",mailTitle:"Typo on the site",mailSended:"Notification sent",mailSendedDesc:"Your notification has been sent successfully. Thank you for your feedback!",mailNotSended:"Sending error",mailNotSendedDesc:"Your message has not been sent, sorry."},debug:!0,initCss:!0,initHtml:!0,overlayColor:"#666",overlayOpacity:.5,windowZindex:10001,hideBodyScroll:!0,textLimit:400,contextLength:40,closeOnEsc:!0,mailTo:"",mailFrom:"textmistake@"+window.location.hostname,mandrillKey:"",sendmailUrl:"",animateSpeed:0,autocloseTime:1e4,onShow:function(){},onHide:function(){},onLoadingShow:function(){},onLoadingHide:function(){},onCtrlEnter:function(){},onEscPressed:function(){},onSendMail:function(){},onAjaxDone:function(){},onAjaxResultError:function(){},onAjaxSendError:,i=e.extend(!0,n,t),o=function(e){if(i.debug){var t=(new Date).toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1");return console.log("["+t+"] "+e)}},r=e("html").first(),a=e("head").first(),d=e("body").first();i.initCss&&0===a.find("#mt_s").length&&a.append('<style id="mt_s" type="text/css">html.mistake-open,html.mistake-open body{min-height:100%}html.mistake-open body{display:block;position:relative;overflow:hidden;top:0;left:0}#mt_o{position:fixed;padding:0;margin:0;top:0;left:0;width:100%;height:100%;background:'+i.overlayColor+";z-index:"+i.windowZindex.toString()+";-moz-opacity:"+i.overlayOpacity.toString()+";opacity:"+i.overlayOpacity.toString()+";zoom:1;display:none}#mt_c{position:fixed;top:50%;left:50%;width:454px;height:auto;padding:30px 42px;background:#fff;border:1px solid #777;outline:0;box-shadow:0 4px 16px rgba(0,0,0,.2);font-family:Arial,sans-serif;font-size:13px;line-height:18px;word-wrap:break-word;z-index:"+(i.windowZindex+1).toString()+";display:none}#mt_c div.loading, #mt_c div.loading div.overlay{position:absolute;top:0;left:0;width:100%;height:100%;}#mt_c div.loading{z-index:"+(i.windowZindex+2).toString()+";display:none}#mt_c div.loading div.overlay{background:#666;-moz-opacity:0.1;opacity:0.1;}#mt_c div.loading div.spinner{position:absolute;left:50%;top:50%;width:30px;height:30px;margin:-15px 0 0 -15px;background-color:#222;-webkit-animation:rotateplane 1.2s infinite ease-in-out;animation:rotateplane 1.2s infinite ease-in-out}@-webkit-keyframes rotateplane{0%{-webkit-transform:perspective(120px)}50%{-webkit-transform:perspective(120px) rotateY(180deg)}100%{-webkit-transform:perspective(120px) rotateY(180deg) rotateX(180deg)}}@keyframes rotateplane{0%{transform:perspective(120px) rotateX(0deg) rotateY(0deg);-webkit-transform:perspective(120px) rotateX(0deg) rotateY(0deg)}50%{transform:perspective(120px) rotateX(-180.1deg) rotateY(0deg);-webkit-transform:perspective(120px) rotateX(-180.1deg) rotateY(0deg)}100%{transform:perspective(120px) rotateX(-180deg) rotateY(-179.9deg);-webkit-transform:perspective(120px) rotateX(-180deg) rotateY(-179.9deg)}}#mt_c .close{position:absolute;right:0;top:0;margin:0;padding:17px;width:11px;height:11px;background:url('https://i.imgur.com/U3EnhFo.png') no-repeat center center;-moz-opacity:.7;opacity:.7;cursor:pointer;z-index:"+(i.windowZindex+10).toString()+"}#mt_c .close:hover{-moz-opacity:1;opacity:1}#mt_c div.title{height:32px;padding:0 0 0 40px;margin:0 0 16px;background-repeat:no-repeat;background-position:left center}#mt_c div.title.feedback{background-image:url('https://i.imgur.com/BCvESIh.png')}#mt_c div.title.fire{background-image:url('https://i.imgur.com/CHwbq2g.png')}#mt_c div.title.mail{background-image:url('https://i.imgur.com/Mo8R3H8.png')}#mt_c div.title.star{background-image:url('https://i.imgur.com/wgTKfJF.png')}#mt_c div.title.cross{background-image:url('https://i.imgur.com/5nx776T.png')}#mt_c div.title h1{color:#000;display:inline;font-family:Arial,sans-serif;font-size:16px;font-weight:400;line-height:32px}#mt_c p{margin:0 0 13px;padding:0}#mt_c p.nowrap{white-space:nowrap;overflow:hidden;position:relative}#mt_c p.nowrap::after{content:'';position:absolute;right:0;top:0;width:40px;height:100%;background:-moz-linear-gradient(left,rgba(255,255,255,0.2),#fff 100%);background:-webkit-linear-gradient(left,rgba(255,255,255,0.2),#fff 100%);background:-o-linear-gradient(left,rgba(255,255,255,0.2),#fff 100%);background:-ms-linear-gradient(left,rgba(255,255,255,0.2),#fff 100%);background:linear-gradient(to right,rgba(255,255,255,0.2),#fff 100%)}#mt_c p.nopadding{margin:0;padding:0}#mt_c p .url{color:#0f5bd9;text-decoration:underline}#mt_c blockquote{font-family:Arial,sans-serif;font-size:13px;line-height:18px;padding:0;margin:6px 25px 20px 25px;background-image:none;background:transperent}#mt_c blockquote strong{font-weight:700;color:#d31;text-decoration:underline}#mt_c input[type='text']{width:100%;background-color:#fff;border:1px solid #d9d9d9;border-radius:1px;box-sizing:border-box;font-size:13px;padding:3px 8px;resize:none;text-align:start;word-wrap:break-word}#mt_c input[type='text']:focus{outline:0;border-color:#4d90fe}#mt_c div.buttons{margin:22px 0 0;text-align:right}#mt_c input[type='button']{background-color:#f5f5f5;background-image:-webkit-linear-gradient(top,#f5f5f5,#f1f1f1);border-radius:2px;border:1px solid #e2e2e2;color:#444;font-family:Arial,sans-serif;font-size:11px;font-weight:700;height:29px;letter-spacing:normal;line-height:27px;margin:0 0 0 16px;padding:0 15px;text-align:center;outline:0}#mt_c input[type='button']:hover{border-color:#d2d2d2}</style>"),i.initHtml&&0===d.find("#mt_c").length&&d.append('<div id="mt_c"><div class="loading"><div class="spinner"></div><div class="overlay"></div></div><div class="close mt_cl"></div><div class="title feedback"><h1>'+i.l10n.title+'</h1></div><p class="msg"></p><p class="nowrap">'+i.l10n.urlHint+' <span class="url"></span></p><p class="nopadding">'+i.l10n.errTextHint+"</p><blockquote></blockquote><p>"+i.l10n.yourComment+'</p><p><input type="text" maxlength="256" value="" placeholder="'+i.l10n.commentPlaceholder+'" /></p><div class="buttons"><input type="button" class="mt_cl" value="'+i.l10n.cancel+'" /><input type="button" class="mt_snd" value="'+i.l10n.send+'" /></div></div><div id="mt_o"></div>');var l=d.find("#mt_o"),s=d.find("#mt_c"),c=s.find("div.loading").first(),p=s.find("div.title").first(),m=s.find("p.msg").first(),g=s.find("span.url").first(),u=s.find("blockquote").first(),f=s.find("input[type=text]").first(),h=s.find(".mt_cl"),x=s.find(".mt_snd"),b=null,v=function(){var e="";return window.getSelection?e=window.getSelection().toString():document.selection&&"Control"!=document.selection.type&&(e=document.selection.createRange().text),e},y=function(e){var t,n,i,o="",r="";return"undefined"!=typeof window.getSelection?(t=window.getSelection(),t.rangeCount?n=t.getRangeAt(0):(n=document.createRange(),n.collapse(!0)),i=document.createRange(),i.selectNodeContents(e),i.setEnd(n.startContainer,n.startOffset),o=i.toString(),i.selectNodeContents(e),i.setStart(n.endContainer,n.endOffset),r=i.toString()):(t=document.selection)&&"Control"!=t.type&&(n=t.createRange(),i=document.body.createTextRange(),i.moveToElementText(e),i.setEndPoint("EndToStart",n),o=i.text,i.moveToElementText(e),i.setEndPoint("StartToEnd",n),r=i.text),{before:o,after:r}},w=k=)},S=function(){s.css({"margin-top":-(s.height()/2+parseInt(s.css("padding-top"))),"margin-left":-(s.width()/2+parseInt(s.css("padding-left")))})},_=function(t){"boolean"==typeof t&&(t?(e.isFunction(i.onLoadingShow)&&i.onLoadingShow(t),c.show().find("*").show()):(e.isFunction(i.onLoadingHide)&&i.onLoadingHide(t),c.hide()))},C=function(t){return"boolean"==typeof t?t?(e.isFunction(i.onShow)&&i.onShow(t),i.hideBodyScroll&&r.addClass("mistake-open"),s.find("*").show(),p.removeClass().addClass("title feedback"),m.html("").hide(),c.hide(),l.show(i.animateSpeed),S(),s.show(i.animateSpeed),!0):(e.isFunction(i.onHide)&&i.onHide(t),i.hideBodyScroll&&r.removeClass("mistake-open"),s.hide(i.animateSpeed),l.hide(i.animateSpeed),!1):null})},E=function(e,t,n){l.is(":visible")||l.show(),s.find("*").hide(),_(!1),s.find("div.close").show(),p.show().find("h1").html(e).show(),n&&p.removeClass().addClass("title "+n),m.html(t).show(),S(),i.autocloseTime>0&&(clearInterval(b),b=setInterv)},i.autocloseTime)),s.is(":visible")||s.show()})},A=function(){if(!z(i.mailTo))return o('Email "'+i.mailTo+'" is not valid');if(!z(i.mailFrom))return o('Declare valid "Mail From" address');var t='<html lang="en"><head><meta charset="utf-8" /></head><body><h2>'+i.l10n.mailTitle+"</h2>\n<p><small>"+i.l10n.urlHint+' <a href="'+g.text()+'" target="_blank">'+g.text()+"</a></small></p>\n\n<p>"+i.l10n.errTextHint+"</p>\n<blockquote>"+u.html()+"</blockquote>\n\n";f.val()&&(t+="<p>&nbsp;</p><p>"+i.l10n.userComment+"<br />\n<em>"+f.val()+"</em></p>"),t+="</body></html>";var n="",r={key:"",message:{from_email:i.mailFrom,to:[{email:i.mailTo,type:"to"}],autotext:"true",subject:k(i.l10n.mailSubject),html:t}};return i.sendmailUrl.length>0&&(r.key=i.mandrillKey,n=i.sendmailUrl),i.mandrillKey&&22==i.mandrillKey.length&&(r.key=i.mandrillKey,n="https://mandrillapp.com/api/1.0/messages/send.json"),0==n.length?(E("Wrong settings","Check plugin settings","fire"),!1):(e.ajax({type:"POST",dataType:'json',url:n,data:r}).done(function(t){e.isFunction(i.onAjaxDone)&&i.onAjaxDone(t),"undefined"!=typeof t[0]&&"sent"===t[0].status||"undefined"!=typeof t.code&&1==t.code?(e.isFunction(i.onSendMail)&&i.onSendMail(t),E(i.l10n.mailSended,i.l10n.mailSendedDesc,"star")):(e.isFunction(i.onAjaxResultError)&&i.onAjaxResultError(t),E(i.l10n.mailNotSended,i.l10n.mailNotSendedDesc,"fire"),o("Request was sended, but server answer is not valid"))}).error(function(t){e.isFunction(i.onAjaxSendError)&&i.onAjaxSendError(t),E(i.l10n.mailNotSended,i.l10n.mailNotSendedDesc,"fire"),o('Ajax request error with status "'+t.status+'"')}),void _(!0))};h.on("clic)}),x.on("clic)}),d.keydown(function(t){if(t.ctrlKey&&13==t.keyCode){e.isFunction(i.onCtrlEnter)&&i.onCtrlEnter();var n=y(document.body),r=k(n.before.slice(-i.contextLength)),a=k(n.after.slice(0,i.contextLength)),d=w(v()).replace(/(\r\n|\n|\r)/gm," ");if(d.length<1)return!1;if(d.length>i.textLimit)return o("Too many text"),!1;f.val(""),g.text(window.location.href),u.html("&hellip;"+r+"<strong>"+d+"</strong>"+a+"&hellip;"),C(!0)}}),d.keyup(function(t){i.closeOnEsc&&T()&&27==t.keyCode&&(e.isFunction(i.onEscPressed)&&i.onEscPressed(),C(!1))})}}(jQuery);
