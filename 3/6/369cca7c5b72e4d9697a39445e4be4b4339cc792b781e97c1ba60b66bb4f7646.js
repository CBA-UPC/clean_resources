function WsDialCodesPhoneInput($){var _this;return{COUNTRY_NAME_INDEX:0,COUNTRY_KEY_INDEX:1,COUNTRY_CODE_INDEX:2,selectedCountryKeys:{},formattedCountriesData:{},commonCountriesArray:[],pinnedCountriesArray:[],settings:{defaultCountry:"ru",pinnedCountries:["ru","ua","kz","tr"],initCommonCallback:null,setFlagsImageCss:!0,disableEvents:!1},initCommon:function(settings){return _this=this,this.setSettings(settings),this.initData(),this.settings.initCommonCallback&&"function"==typeof this.settings.initCommonCallback&&this.settings.initCommonCallback(),this},renderOnInput:function(selector,key,inputInElement,parseInputValue){var inputElement=inputInElement?inputInElement.querySelector(selector):document.querySelector(selector);this.selectedCountryKeys.hasOwnProperty(key)&&$(inputElement).closest(".ws-dcpi_dropdown").length||(this.setSelectedCountryByInputKey(this.settings.defaultCountry,key),this.renderDropdownElements(selector,key,inputInElement,parseInputValue))},initData:setSettings:function(settings){return $.extend(this.settings,settings),this.settings},setFormattedCountriesData:function(pinnedCountries){this.allCountries.forEach(function(country){_this.formattedCountriesData[country[_this.COUNTRY_KEY_INDEX]]={name:country[_this.COUNTRY_NAME_INDEX],code:country[_this.COUNTRY_CODE_INDEX],key:country[_this.COUNTRY_KEY_INDEX]},pinnedCountries.includes(country[_this.COUNTRY_KEY_INDEX])?_this.pinnedCountriesArray.push(_this.formattedCountriesData[country[_this.COUNTRY_KEY_INDEX]]):_this.commonCountriesArray.push(_this.formattedCountriesData[country[_this.COUNTRY_KEY_INDEX]])})},setSelectedCountryByInputKey:function(countryKey,inputKey){return inputKey&&countryKey?void(this.selectedCountryKeys[inputKey]=countryKey):null},getSelectedCountryByInputKey:toggleClickEvent:countryClickEvent:function(countryKey,rootElement,toggleElement,inputElement,inputKey){this.renderNewSelectedCountry(toggleElement,countryKey,inputKey),this.setSelectedCountryByInputKey(countryKey,inputKey),rootElement.classList.add("ws-dcpi_dropdown--closed"),inputElement.focus()},inputFocus:inputBlur:function(rootElement){rootElement.classList.remove("ws-dcpi_dropdown--focused")},onInput:setEvents:function(rootElement,toggleElement,inputElement,inputKey){$(inputElement).on("input.ws-phone-codes-target-input",_this.onInput),$(inputElement).on("focus.ws-phone-codes-target-input",function(e){_this.inputFocus(rootElement,e)}),$(inputElement).on("blur.ws-phone-codes-target-input",function(e){_this.inputBlur(rootElement,e)}),$(toggleElement).on("click.ws-dcpi_dropdown-toggle",function(){_this.toggleClickEvent(rootElement,inputElement)}),rootElement.querySelectorAll(".ws-dcpi_country").forEach(function(country){$(country).on("click.ws-dcpi_country",function(){_this.countryClickEvent(country.id,rootElement,toggleElement,inputElement,inputKey)})})},clearEvents:function(rootElement,toggleElement,inputElement,inputKey){$(inputElement).off("input.ws-phone-codes-target-input",_this.onInput),$(inputElement).off("focus.ws-phone-codes-target-input",function(e){_this.inputFocus(rootElement,e)}),$(inputElement).off("blur.ws-phone-codes-target-input",,$(toggleElement).off("click.ws-dcpi_dropdown-toggle",function(){_this.toggleClickEvent(rootElement,inputElement)}),rootElement.querySelectorAll(".ws-dcpi_country").forEach(function(country){$(country).off("click.ws-dcpi_country",function(){_this.countryClickEvent(country.id,rootElement,toggleElement,inputElement,inputKey)})})},parseCountry:function(value,inputKey){var country=this.selectedCountryKeys[inputKey].key;if(value=value.replace(/[^\d]/g,""),value.substring(0,this.formattedCountriesData[this.settings.defaultCountry].code.length)===this.formattedCountriesData[this.settings.defaultCountry].code)return{value:value.substring(this.formattedCountriesData[this.settings.defaultCountry].code.length,value.length),country:this.formattedCountriesData[this.settings.defaultCountry].key};for(key in this.formattedCountriesData){var item=this.formattedCountriesData.hasOwnProperty(key)?this.formattedCountriesData[key]:null;if(item&&value.substring(0,item.code.length)===item.code){value=value.substring(item.code.length,value.length),country=item.key;break}}return{value:value,country:country}},renderNewSelectedCountry:function(toggleElement,countryKey,inputKey){if(toggleElement){var flag=toggleElement.querySelector(".ws-dcpi_dropdown-toggle-selected_flag"),dialCode=toggleElement.querySelector(".ws-dcpi_dropdown-toggle-selected_code");flag&&(flag.classList.remove("ws-dcpi_flag-"+this.selectedCountryKeys[inputKey]),flag.classList.add("ws-dcpi_flag-"+countryKey)),dialCode&&(dialCode.textContent="+"+this.formattedCountriesData[countryKey].code)}},renderDropdownElements:function(inputSelector,inputKey,inputInElement,parseInputValue){var inputElement=inputInElement?inputInElement.querySelector(inputSelector):document.querySelector(inputSelector);if(parseInputValue){var parsedData=this.parseCountry(inputElement.value,inputKey);inputElement.value=parsedData.value,this.setSelectedCountryByInputKey(parsedData.country,inputKey)}var rootElement=this.сreateDropdownRootElement(),toggleElement=this.createListToggle(inputKey);inputElement.classList.add("ws-phone-codes-target-input"),inputElement.parentElement.append(rootElement),rootElement.append(toggleElement),rootElement.append(inputElement),rootElement.append(this.createCountriesList()),this.settings.setFlagsImageCss&&this.setFlagsImageCssWithStaticHost(this.settings.flagsStaticHost,this.settings.stylesTagId),this.settings.disableEvents||this.setEvents(rootElement,toggleElement,inputElement,inputKey)},createListToggle:function(inputKey){var countryListToggleElement=document.createElement("span"),countryListToggleElementHtml='<span class="ws-dcpi_dropdown-toggle-selected_flag ws-dcpi_flag ws-dcpi_flag-'+this.getSelectedCountryByInputKey(inputKey).key+'"></span><span class="ws-dcpi_dropdown-toggle-arrow"></span><span class="ws-dcpi_country-code ws-dcpi_dropdown-toggle-selected_code">+'+this.getSelectedCountryByInputKey(inputKey).code+"</span>";return countryListToggleElement.classList.add("ws-dcpi_dropdown-toggle"),countryListToggleElement.innerHTML=countryListToggleElementHtml,countryListToggleElement},"сreateCountryListItem":function(country){var countryListElementHtml='<span class="ws-dcpi_flag ws-dcpi_flag-'+country.key+'"></span><span class="ws-dcpi_country-name" title="'+country.name+'">'+country.name+'</span><span class="ws-dcpi_country-code">+'+country.code+"</span>",countryListElement=document.createElement("li");return countryListElement.classList.add("ws-dcpi_country"),countryListElement.id=country.key,countryListElement.innerHTML=countryListElementHtml,countryListElement},createCountriesList:function(){var countriesList=document.createElement("ul");if(countriesList.classList.add("ws-dcpi_country-list"),this.pinnedCountriesArray.length){var divider=document.createElement("hr");divider.classList.add("ws-dcpi_divider"),this.pinnedCountriesArray.forEach(function(country){countriesList.append(_this.сreateCountryListItem(country))}),countriesList.append(divider)}return this.commonCountriesArray.forEa))}),countriesList},"сreateDropdownRootElement":function(){var dropdownRootElement=document.createElement("div");return dropdownRootElement.classList.add("ws-dcpi_dropdown"),dropdownRootElement.classList.add("ws-dcpi_dropdown--closed"),dropdownRootElement.id=this.settings.rootId?this.settings.rootId:dropdownRootElement.id,dropdownRootElement.style=this.settings.rootStyle?dropdownRootElement.style+this.settings.rootStyle:dropdownRootElement.style,dropdownRootElement.className=this.settings.rootClassName?this.settings.rootClassName+" "+dropdownRootElement.className:dropdownRootElement.className,dropdownRootElement},setFlagsImageCssWithStaticHost:function(staticHost,stylesTagId){staticHost=staticHost?staticHost:"";var style=document.getElementById(stylesTagId);stylesTagId&&style||(style=document.createElement("style"),style.id="phoneCodeSelectFlags"),staticHost=staticHost?staticHost+"/":"",style.append(".ws-dcpi_flag{background-image:url("+staticHost+"img/flags.png);}"),document.body.append(style)},allCountries:[["Afghanistan (‫افغانستان‬‎)","af","93"],["Albania (Shqipëri)","al","355"],["Algeria (‫الجزائر‬‎)","dz","213"],["American Samoa","as","1",5,["684"]],["Andorra","ad","376"],["Angola","ao","244"],["Anguilla","ai","1",6,["264"]],["Antigua and Barbuda","ag","1",7,["268"]],["Argentina","ar","54"],["Armenia (Հայաստան)","am","374"],["Aruba","aw","297"],["Ascension Island","ac","247"],["Australia","au","61",0],["Austria (Österreich)","at","43"],["Azerbaijan (Azərbaycan)","az","994"],["Bahamas","bs","1",8,["242"]],["Bahrain (‫البحرين‬‎)","bh","973"],["Bangladesh (বাংলাদেশ)","bd","880"],["Barbados","bb","1",9,["246"]],["Belarus (Беларусь)","by","375"],["Belgium (België)","be","32"],["Belize","bz","501"],["Benin (Bénin)","bj","229"],["Bermuda","bm","1",10,["441"]],["Bhutan (འབྲུག)","bt","975"],["Bolivia","bo","591"],["Bosnia and Herzegovina (Босна и Херцеговина)","ba","387"],["Botswana","bw","267"],["Brazil (Brasil)","br","55"],["British Indian Ocean Territory","io","246"],["British Virgin Islands","vg","1",11,["284"]],["Brunei","bn","673"],["Bulgaria (България)","bg","359"],["Burkina Faso","bf","226"],["Burundi (Uburundi)","bi","257"],["Cambodia (កម្ពុជា)","kh","855"],["Cameroon (Cameroun)","cm","237"],["Canada","ca","1",1,["204","226","236","249","250","263","289","306","343","354","365","367","368","382","387","403","416","418","428","431","437","438","450","584","468","474","506","514","519","548","579","581","584","587","604","613","639","647","672","683","705","709","742","753","778","780","782","807","819","825","867","873","902","905"]],["Cape Verde (Kabu Verdi)","cv","238"],["Caribbean Netherlands","bq","599",1,["3","4","7"]],["Cayman Islands","ky","1",12,["345"]],["Central African Republic (République centrafricaine)","cf","236"],["Chad (Tchad)","td","235"],["Chile","cl","56"],["China (中国)","cn","86"],["Christmas Island","cx","61",2,["89164"]],["Cocos (Keeling) Islands","cc","61",1,["89162"]],["Colombia","co","57"],["Comoros (‫جزر القمر‬‎)","km","269"],["Congo (DRC) (Jamhuri ya Kidemokrasia ya Kongo)","cd","243"],["Congo (Republic) (Congo-Brazzaville)","cg","242"],["Cook Islands","ck","682"],["Costa Rica","cr","506"],["Côte d’Ivoire","ci","225"],["Croatia (Hrvatska)","hr","385"],["Cuba","cu","53"],["Curaçao","cw","599",0],["Cyprus (Κύπρος)","cy","357"],["Czech Republic (Česká republika)","cz","420"],["Denmark (Danmark)","dk","45"],["Djibouti","dj","253"],["Dominica","dm","1",13,["767"]],["Dominican Republic (República Dominicana)","do","1",2,["809","829","849"]],["Ecuador","ec","593"],["Egypt (‫مصر‬‎)","eg","20"],["El Salvador","sv","503"],["Equatorial Guinea (Guinea Ecuatorial)","gq","240"],["Eritrea","er","291"],["Estonia (Eesti)","ee","372"],["Eswatini","sz","268"],["Ethiopia","et","251"],["Falkland Islands (Islas Malvinas)","fk","500"],["Faroe Islands (Føroyar)","fo","298"],["Fiji","fj","679"],["Finland (Suomi)","fi","358",0],["France","fr","33"],["French Guiana (Guyane française)","gf","594"],["French Polynesia (Polynésie française)","pf","689"],["Gabon","ga","241"],["Gambia","gm","220"],["Georgia (საქართველო)","ge","995"],["Germany (Deutschland)","de","49"],["Ghana (Gaana)","gh","233"],["Gibraltar","gi","350"],["Greece (Ελλάδα)","gr","30"],["Greenland (Kalaallit Nunaat)","gl","299"],["Grenada","gd","1",14,["473"]],["Guadeloupe","gp","590",0],["Guam","gu","1",15,["671"]],["Guatemala","gt","502"],["Guernsey","gg","44",1,["1481","7781","7839","7911"]],["Guinea (Guinée)","gn","224"],["Guinea-Bissau (Guiné Bissau)","gw","245"],["Guyana","gy","592"],["Haiti","ht","509"],["Honduras","hn","504"],["Hong Kong (香港)","hk","852"],["Hungary (Magyarország)","hu","36"],["Iceland (Ísland)","is","354"],["India (भारत)","in","91"],["Indonesia","id","62"],["Iran (‫ایران‬‎)","ir","98"],["Iraq (‫العراق‬‎)","iq","964"],["Ireland","ie","353"],["Isle of Man","im","44",2,["1624","74576","7524","7924","7624"]],["Israel (‫ישראל‬‎)","il","972"],["Italy (Italia)","it","39",0],["Jamaica","jm","1",4,["876","658"]],["Japan (日本)","jp","81"],["Jersey","je","44",3,["1534","7509","7700","7797","7829","7937"]],["Jordan (‫الأردن‬‎)","jo","962"],["Kazakhstan (Казахстан)","kz","7",1,["33","7"]],["Kenya","ke","254"],["Kiribati","ki","686"],["Kosovo","xk","383"],["Kuwait (‫الكويت‬‎)","kw","965"],["Kyrgyzstan (Кыргызстан)","kg","996"],["Laos (ລາວ)","la","856"],["Latvia (Latvija)","lv","371"],["Lebanon (‫لبنان‬‎)","lb","961"],["Lesotho","ls","266"],["Liberia","lr","231"],["Libya (‫ليبيا‬‎)","ly","218"],["Liechtenstein","li","423"],["Lithuania (Lietuva)","lt","370"],["Luxembourg","lu","352"],["Macau (澳門)","mo","853"],["Madagascar (Madagasikara)","mg","261"],["Malawi","mw","265"],["Malaysia","my","60"],["Maldives","mv","960"],["Mali","ml","223"],["Malta","mt","356"],["Marshall Islands","mh","692"],["Martinique","mq","596"],["Mauritania (‫موريتانيا‬‎)","mr","222"],["Mauritius (Moris)","mu","230"],["Mayotte","yt","262",1,["269","639"]],["Mexico (México)","mx","52"],["Micronesia","fm","691"],["Moldova (Republica Moldova)","md","373"],["Monaco","mc","377"],["Mongolia (Монгол)","mn","976"],["Montenegro (Crna Gora)","me","382"],["Montserrat","ms","1",16,["664"]],["Morocco (‫المغرب‬‎)","ma","212",0],["Mozambique (Moçambique)","mz","258"],["Myanmar (Burma) (မြန်မာ)","mm","95"],["Namibia (Namibië)","na","264"],["Nauru","nr","674"],["Nepal (नेपाल)","np","977"],["Netherlands (Nederland)","nl","31"],["New Caledonia (Nouvelle-Calédonie)","nc","687"],["New Zealand","nz","64"],["Nicaragua","ni","505"],["Niger (Nijar)","ne","227"],["Nigeria","ng","234"],["Niue","nu","683"],["Norfolk Island","nf","672"],["North Korea (조선 민주주의 인민 공화국)","kp","850"],["North Macedonia (Северна Македонија)","mk","389"],["Northern Mariana Islands","mp","1",17,["670"]],["Norway (Norge)","no","47",0],["Oman (‫عُمان‬‎)","om","968"],["Pakistan (‫پاکستان‬‎)","pk","92"],["Palau","pw","680"],["Palestine (‫فلسطين‬‎)","ps","970"],["Panama (Panamá)","pa","507"],["Papua New Guinea","pg","675"],["Paraguay","py","595"],["Peru (Perú)","pe","51"],["Philippines","ph","63"],["Poland (Polska)","pl","48"],["Portugal","pt","351"],["Puerto Rico","pr","1",3,["787","939"]],["Qatar (‫قطر‬‎)","qa","974"],["Réunion (La Réunion)","re","262",0],["Romania (România)","ro","40"],["Russia (Россия)","ru","7",0],["Rwanda","rw","250"],["Saint Barthélemy","bl","590",1],["Saint Helena","sh","290"],["Saint Kitts and Nevis","kn","1",18,["869"]],["Saint Lucia","lc","1",19,["758"]],["Saint Martin (Saint-Martin (partie française))","mf","590",2],["Saint Pierre and Miquelon (Saint-Pierre-et-Miquelon)","pm","508"],["Saint Vincent and the Grenadines","vc","1",20,["784"]],["Samoa","ws","685"],["San Marino","sm","378"],["São Tomé and Príncipe (São Tomé e Príncipe)","st","239"],["Saudi Arabia (‫المملكة العربية السعودية‬‎)","sa","966"],["Senegal (Sénégal)","sn","221"],["Serbia (Србија)","rs","381"],["Seychelles","sc","248"],["Sierra Leone","sl","232"],["Singapore","sg","65"],["Sint Maarten","sx","1",21,["721"]],["Slovakia (Slovensko)","sk","421"],["Slovenia (Slovenija)","si","386"],["Solomon Islands","sb","677"],["Somalia (Soomaaliya)","so","252"],["South Africa","za","27"],["South Korea (대한민국)","kr","82"],["South Sudan (‫جنوب السودان‬‎)","ss","211"],["Spain (España)","es","34"],["Sri Lanka (ශ්‍රී ලංකාව)","lk","94"],["Sudan (‫السودان‬‎)","sd","249"],["Suriname","sr","597"],["Svalbard and Jan Mayen","sj","47",1,["79"]],["Sweden (Sverige)","se","46"],["Switzerland (Schweiz)","ch","41"],["Syria (‫سوريا‬‎)","sy","963"],["Taiwan (台灣)","tw","886"],["Tajikistan","tj","992"],["Tanzania","tz","255"],["Thailand (ไทย)","th","66"],["Timor-Leste","tl","670"],["Togo","tg","228"],["Tokelau","tk","690"],["Tonga","to","676"],["Trinidad and Tobago","tt","1",22,["868"]],["Tunisia (‫تونس‬‎)","tn","216"],["Turkey (Türkiye)","tr","90"],["Turkmenistan","tm","993"],["Turks and Caicos Islands","tc","1",23,["649"]],["Tuvalu","tv","688"],["U.S. Virgin Islands","vi","1",24,["340"]],["Uganda","ug","256"],["Ukraine (Україна)","ua","380"],["United Arab Emirates (‫الإمارات العرtà del Vaticano)","va","39",1,["06698"]],["Venezuelaeturn n.grep(a,,i=f,f=k.shift())if("*"===f)f=i;else if("*"!==i&&i!==f){if(g=j[i+" "+f]||j["* "+f],!g)=j[i+" "+h[0]]||j["* "+h[0]])){g===!0?g=j[e]:j[e]!==!0&&(f=h[0],k.unthrows"])b=g(b);else try{b=g(b)}catch(l){return{state:"parsererror"+i+"isArray(b)f(c||in bfaultV,i=h.toString,j=h.hasOwnProperty,k={},l=aa,bgi,rs:m,constructor:n,selector:"",length:0,toArray:function()){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(a){var brn this.pushStack(c>=0&&b>c?[revObject||this.constructor(nulextend=n.fh=1,i=argument++)if(null!=(aj&&d&=n.extend(j{},isFuncty:Array.ia){re(a){rypeof a?h[")?(b=l.createElement("script"),b.text=a,l.head.appendChild(b).pare},nod){va,d!==!1);e++) a?[a]:a):f.call(c,a)),c},inArray:function(a,b,c){return null==b?-1:g.call(b,a,c)||-1},merge:function(a,b){[d];retn(a){return 1&a.compareDocumentPosition(n.createElement("div"))}),ja(function(a){return a.innerHTML="<a href='#'></a>","#"===a.firstChild.getAttribute("href")})||ka("type|href|height|width",function(a,b,c){return c?void 0:a.getAta("value",functionrs,n.expr[":"]=n.expr.pseudos,n.unique=t.uniqueSort,n.text=t.get.ex=function(a,b,c){var d=b[0];return c&&(a=":not("+a+")"),1===a){if(c="<"===a[0]&&">"===a[a.length-1]&&a.length>=3?[null,a,null]:z.exec(a),!c||!c[1]&&b)return!b||b.jws?(b||y).find(a):0)),v.teb[c]);return this}re?(this.:!0};ng:fu;return function(){for(vaon(a,b){for(var c,d=0,e=this.length,f=[],g=u.test(a)||"string"!=typeof a?n(a,b||this.context):0;e>d;d++)for(c=this[d];c&&c!==b;c=c.parentNode)if(c.nodeType<11&&chesSelector(c,a))){f.push(c);break}return this.pushStack(furn a?"string"==typeof a?g.call(n(a),this[0]):g.call(this,a.jws?a[0]:.length:-s.get(),nd(null==ang")},prev:function(a){return D((c)||h.push(c):c&&cments g=f[2],h=f[3];d[f[e,b[2][2].lock),e[f[0]]=function(){return ethis},d(),h=function(a,bay(e);e>b;b++)c[b]&&n.isFunction(=!0,a!==!0&&-triggerHandler("ready"),n(l).off("ready"))))}}),unct(g?()for(;i=1,K.ac|(this.c];if("stache[e],b);else for(d in b)f[d]=b[d];return f},get:function(a,b){var c=this.cache[thision(a,b,c){var d;return void 0===b||b&&"string"==typeof b&&void 0===c?(d=this.get(a,b),voidis.set(a,b,c),void 0!==c?c:b)},remove:function(a,b){var c,d,emove(a,b)}}),n.fn.extend({data:function(a,b){var c,d,e,f=this[0],g=f&&f.attributes;if(voi(d=n.cam,void 0!==c)t(this,a,b)})},null,bpush(c)),d||[]):void 0},dequeue:function(a,b){b=b||"fx";var c=n.queue(a,b),d=c.lnction()"once memory").add(function(){L.remove(a,[b+"queue",c])})})}}),n.fn.extend({queue:functio[0],a):void 0===b?this:thisid 0),a=a||"fx";g--;)c=L.get(f[g],a+"queueHooks"),c&&c.empty&&(d++,c.empty.add(h));return h(),e.promise(b)}});var Q=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,R=["Top","Right","Bottom","Leftion(b);if(r&&(.apply(d,t}},dispa.namespace))&&(a.handleObj=g,a.data=g.data,e=((n.event.special[g.origType]||{}).handle||g.handler).apply(f.elem,i),void 0!==e&&(a.result=e)===!1&&(a.preventDefault(),a.stopPropagation()));return k.postDispatch&&egateCount,i=a.target;if(h&&i.nodeType&&(!a.button||"click"!==a.type))for(;i!==this;i=i.parentNode||this)if(i.disabled!==!0|et tigeX&&null!=b.clientX&&(c=a.target.ownerDocuLeft||e&&e.scrollLeft||0)-(d&&d.client.scrollTop||0)-(d&&d.clientTop||e&&e.clin a;var bthis.fixHooks[e]=g=W.test(e)rops,a=new {trigger:functiype:"focatch:function(a){void 0!==a.result&&a.originalEvent&&(a.originalEvent.returnValue=a.result)}}},simulate:function(a,b,c,d){var e=n.extend(new n.Event,c,{type:a,isSimulated:!0,originalEvent:{}});d?n.event.trigger(e,null,b):n.event.Listener&&a.removeEventLinted||void 0===a.defaultPrevented&&a.returnValue===!1?Z:$):this.type=a,b&&n.extend(this,b),this.timeStamp=a&vented=Z,a&&a.preventDefault&&a.preventDefault()},stopPropagerenter:"pointeronctis(d,d=b,c=b=,d===!1)d=$;elsf.apply(this,arguments)},d.guid=f.guid||(f.guid=n.guid++)),this.each(function(){n.event.add(this,a,d,c,b)})},one:function(a,b,c,d){return this.on(a,b,c,d,1)},off:function(a,b,c){var d,e;if(a&&a.preventDefault&&a.handleObj)return d=a.handleObj,n(a.delegateTarget).off(d.namespace?d.origType+"."+d.namespace:d.origType,d.selector,d.handler),this;if("object"==typeof a){for(e in a)this.off(e,b,a[e]);return this}return(b===!1||"function"==typeof b)&&(c=b,b=void 0),c===!1&&(c=$),this.each(function(){n.event.remove(this,a,c,b)})},trigger:function(a,b){return this.each(function(){n.event.trigger(a,b,this)})},triggerHandler:functionlect multiple=oa(a,"scri",""])[1].toLowerCas,m=0;e=&c.push((d in bxpando(1===thpe){vae||11=unctinerDocument,,clone:ll==b?a:bvar c,d,f,g,h,i,j=0,l=this.length,m=this,o=l-1,p=a[0],q=n.isFunction(p);if(q||l>1&&"string"==typeof p&&!k.checkClonefirstChild,1===c.childNodes.length&&(c=d),d)){for(f=n.map(oa(c,"script"),kctyle="con,e.appendChild(f),a.getComputedStyle&&n.extend(k,{pixelPosition:function(){return g(),b},boxSizingReliable:function(){return null==c&&g(),c},reliableMarginRight:function(){var b,c=f.appendChild(l.createElement("div"));return c.style.cssText=f.style.cssText="-webkit-box-nt-box;display:block;margin:0;border:0;padding:0",c.style.marginRight=c.style.width="0",f.style.width="1px",d.appendChild(e),b=!parseFloat(a.getComputedStyle(c,null).marginRight),d.removeChild(!0,fops[h]||(n.cssProps[h]=Fa(i,||0!==b.indexOf("background")||(i[b]="inherit"),g=n.camelCase(b);return b=n.cssProps[h]||(n.cssf)?f||0:e):e}}),n.d&&waorder!1,e),enRight"]):void 0}),n.each({margin:"",padding:""rn e{vars).show():n(this).hide()})}}),n.Tween=Ka,Ka.prototype={constructor:Ka,Numbtions.duration?this.pos=b=n.easing[this.easing](a,thisis.end-this.start)ions.sow,this),c&&c.set?c.set(this):Ka.propHooks._default.set(this),this}},Ka.prototype.init.prototype=Ka.prototype,Ka.propHooks={_default:{get:function(a){var b;returset:function(a){a.elem.nodeType&&a..fx=Ka.pro:toggle|sh)*e[2]:+e[2]),c}]};n c,d=0,e)&&a,te({opa.queue(a||"fx",[]),this.each(functg[e]);for(e=f.length;e--;)f[e].elem!==this||null!=a&&f[e].queue!==a||(f[e].anim.stop(c),b=!1,f.splice(e,1));(b||!c)&&n.dequeue(this,a)})},finish:function(),d=c[a+"queue"],e=c[a+==this&&f[b+)d[b]&&d[b].finish&&d[b].fiw","hide"]unction(a,d,e){return null==a||"boolean"==typeof a?c.appon(a){n.timers.push(a),a()?n.fx.start():n.timers.pop()},n.fx.interval=13,n.fx.start=function(){Ma||(Ma=setInterval(n.fx.till},n.fx.speeds={!c.disabledJ(this,n.attr,a,b,arg,f=a.nodeTyp,c):(1===f&&n.isXMLDoc(a)||(b=b.toLowerCase(),d?d&&"set"in d&&void 0!==(e=d.set(a,c,b))?e:(a.setAttribute(b,c+"c,d,e=0,f=br.match.bool.test(c)&&(a[d]=!1),a.removeAttribute(c)},attrHookspr.match.bool.source.matcf=$a[b],$a[b]=e,e=null!=c(a,b,d)?b.toLowerCasection(a,b){return J(this,n.prop,a,b,arguments.length>1)},removeProp:function(a){return this.each(function(){delete this[n.propFix[a]||ss":"className"},prop:function(a,b,c){var d,de;return b&).match(E)||lassName?Name=g)}return this},toggleClassis[c].nodeType&&(" "+this[c].classn.extend({valb&&v:(c=e.value,"string"==typeof c?cndex,f="select-one"===a.type||0>e,g=f?null:[],h=f?e+1:d.length,i=0>e?h:f?e:0;h>i;i++)if(c=d[i],!(!c.selected&&i!==e||(k.optDisabled?c.disabled:null!==c.getAttribute("disabled"))||c.parentNode.disabled&&n.nodeName(c.parentoptions,f=n.makeArraf)>=0}}),n.eHooks[thi.checked=n.n null===a.getAttribute("value")?"on"in focusoutc){return arguments.length>0?this.on(b,null,a,c):this.trigger(b)}}),n.fn.extend({hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)},bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return 1===arguments.length?this.off(a,"**"):this.off(b,a||"**",c)}});var cb=n.now(),db=/\?/;n.parseJSON=function(a){return JSON.parse(a+"")},n.parseXML=function(a){var b,c;if(!a||"string"!=typeof a)return null;try{c=new DOMParser,b=c.parseFromString(a,"text/xml")}catch(d){b=void 0}return(!b||b.getElementsByTagName("parsererror").length)&&n.error("Invalid XML: "+a),b};var eb=/#.*$/,fb=/([?&])_=[^&]*/,gb=/^(.*?):[ \t]*([^\r\n]*)$/gm,hb=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,ib=/^(?:GET|HEAD)$/,jb=/^\/\//,kb=/^([\w.+-]+:)(?:\/\/(?:[^location.href,pb=kb.exec(ob.toLowerCase())||[];])),(k.dtentType)&,v.setRequestHeader("Accr(j in k.heareturn v.abort();u="ation(a,b,c(c)&&urn n.a n.isFunction(a)?this.ea]&&(b=n(a,this[0].owner&b.insertBefore(this[0]),b.map(function(){for(var a=this;a.firstElementChild;)a=a.firstElementChild;return a}).append(this)),thime(this,"body")||n(thisilters.hidden=fngs.traditional),n.isn(){e(this.name,this.value)});else for(c in a)Ab(c,a[c],b,e);return d.join("&").replace(vb,"+")},n.rn n.param(this.serializeArray())},serializeArray:function(){return (a.type,a.url,a.async,a.username,a.password),a.xhrFields)for(e in a.xhrFields)f[e]=a.xhrFields[e];a.mimeType&&f.overrideMimeType&&f.overrideMimeType(a.mimeType),a.crossDomain||c["X-RequestettpRequest");for(e in c)f.se=f.onload=f.onerror=null,"null)}catch(h){if(b)throw h}},abort:function(){b&&b()}}:void 0}),n.ajaxSetup({on/ecmascript, application/x-ecefilter("jsonpCallback=n.isFunction(b.jsction(a,b,c){if(!a||"string"!=typeof a)return null;"boolean"==typeof b&&(c=b,b=!1),b(d[1])]:(d=n.buildFragmenn.load;n.fn.load=function(a,b,c){if("string"!=typeof a,"ajaxError","ajaxSuccss(a,"leach(function(ntRect!==U&&(e=d.getBoundingClientRect()),c=Jb(f),{top:e.toptParent(),b=this.offsetb.top-d.top-n.css(c,"marginTop",!0),leftments.length,null)}}),n.each(["top","left"],function(a,b){n.cssHooks[b]=ya(k.pixelPosition,function(a,c){return c?(c=xa(a,bition()[b]+"px":c):void 0})}),n.each({Hei+a,content:b,"":"outer"+a},function(c,d){n.fn[d]=function(d,e){var f=arguments.length&&(c||"boolean"!=typeof d),g=c||(d===!0||e===!0?"margin":"border");return J(this,function(b,c,d){var e;return n.isWindow(b)?b.document.documentElement["client"+a]:9===b.nodeType?(e=b.documentElement,Math.max(b.body["scroll"+a],e["scroll"+a],b.body["offset"+a],e["offset"+a],e["client"+a])):void 0===d?n.css(b,c,g):n.style(b,c,d,g)},b,f?d:void 0,f,null)}})}),n.fn.size=function(){return this.length},n.fn.andSelf=n.fn.addBack,"function"==typeof define&&define.amd&&define("jws",[],function(){return n});var Kb=a.jWS,Lb=a.$;return n.noConflict=function(b){return a.$===n&&(a.$=Lb),b&&a.jWS===n&&(a.jWS=Kb),n},typeof b===U&&(a.jWS=n),n}),function($){void 0==$.fn.inputmask&&($.inputmask={defaults:{placeholder:"_",optionalmarker:{start:"[",end:"]"},escapeChar:"\\",mask:null,oncomplete:$.noop,onincomplete:$.noop,oncleared:$.noop,repeat:0,greedy:!0,autoUnmask:!1,clearMaskOnLostFocus:!0,insertMode:!0,clearIncomplete:!1,aliases:{},onKeyUp:$.noop,onKeyDown:$.noop,sho,COMMAND_LEFT:91,COMMAND_RIGHT:93,CONTROL:17,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,INSERT:45,LEFT:37,MENU:93,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SHIFT:16,SPACE:32,TAB:9,UP:38,WINDOWS:91},ignorables:[8,9,13,16,17,18,20,27,33,34,35,36,37,38,39,40,46,91,93,108]},val:$.fn.val},$.fn.inputmask=function(fn,options){function isInputEventSupported(eventName){var el=document.createElement("input"),eventName="on"+eventName,isSupported=eventName in el;return isSupported||(el.setAttribute(eventName,"return;"),isSupported="function"==typeof el[eventName]),el=null,isSupported}function resolveAlias(aliasStr){var aliasDefinition=opts.aliases[aliasStr];return!!aliasDefinition&&(aliasDefinition.alias&&resolveAlias(aliasDefinition.alias),$.extend(!0,opts,aliasDefinition),$.extend(!0,opts,options),!0)}function getMaskTemplate(){var escaped=!1,outCount=0;1==opts.mask.length&&0==opts.greedy&&(opts.placeholder="");for(var singleMask=$.map(opts.mask.split(""),function(element,index){var outElem=[];if(element==opts.escapeChar)escaped=!0;else if(element!=opts.optionalmarker.start&&element!=opts.optionalmarker.end||escaped){var maskdef=opts.definitions[element];if(maskdef&&!escaped)for(var i=0;i<maskdef.cardinality;i++)outElem.push(getPlaceHolder(outCount+i));else outElem.push(element),escaped=!1;return outCount+=outElem.length,outElem}}),repeatedMask=singleMask.slice(),i=1;i<opts.repeat&&opts.greedy;i++)repeatedMask=repeatedMask.concat(singleMask.slice(getTestingChain(){var isOptional=!1,escaped=!1,newBlockMarker=!1;return $.map(opts.mask.split(""),function(element,index){var outElem=[];if(element==opts.escapeChar)escaped=!0;else if(element!=opts.optionalmarker.start||escaped){if(element!=opts.optionalmarker.end||escaped){var maskdef=opts.definitions[elvalidators=maskdef.prevalidator,prevalidatorsL=prevalidators?prevalidators.length:0,i=1;i<maskdef.cardinality;i++){var prevalidator=prevalidatorsL>=i?prevalidators[i-1]:[],validator=prevalidator.validator,cardinality=prevalidator.cardinality;outElem.push({fn:validator?"string"==typeof validator?new RegExp(validator):new function(){this.test=validator}:new RegExp("."),cardinality:cardinality?cardinality:1,optionality:isOptional,newBlockMarker:1==isOptional&&newBlockMarker,offset:0,casing:maskdef.casing,def:element}),1==isOptional&&(newBlockMarker=!1)}outElem.push({fn:maskdef.validator?"string"==typeof maskdef.validator?new RegExp(maskdef.validator):new function(){this.test=maskdef.validator}:new RegExp("."),cardinality:maskdef.cardinality,optionality:isOptional,newBlockMarker:newBlockMarker,offset:0,casing:maskdef.captionality:isOptional,newBlockMarker:newBlockMarker,offset:0,casing:null,def:element}),escaped=!1;return newBlockMarker=!1,outElem}isOptional=!1,newBlockMarker=!0}else isOptional=!0,newBlockMarker=!0})}function isValid(pos,c,buffer,strict){if(pos<0||pos>=getMaskLength())return!1;for(var testPos=determineTestPosition(pos),loopend=c?1:0,chrs="",i=tests[testPos].cardinality;i>loopend;i--)chrs+=getBufferElement(buffer,testPos-(i-1));return c&&(chrs+=c),null!=tests[testPos].fn&&tests[testPos].fn.test(chrs,buffer,pos,strict,opts)}function isMask(pos){var testPos=determineTestPosition(pos),test=tests[testPos];return void 0!=test&&test.fn}function determineTestPosition(pos){return pos%tests.length}function getPlaceHolder(pos){return opts.placeholder.charAt(pos%opts.placeholder.length)}function getMaskLength(){var calculatedLength=_buffer.length;return!opts.greedy&&opts.repeat>1&&(calculatedLength+=_buffer.length*(opts.repeat-1)),calculatedLength}function seekNext(buffer,pos){var maskL=getMaskLength();if(pos>=maskL)return maskL;for(var position=pos;++position<maskL&&!isMask(position););return position}function seekPrevious(buffer,pos){var position=pos;if(position<=0)return 0;for(;--position>0&&!isMask(position););return position}function setBufferElement(buffer,position,element){var test=tests[determineTestPosition(position)],elem=element;if(void 0!=elem)switch(test.casing)ase();break;case"lower":elem=element.toLowerCase()}buffer[position]=elem}function getBufferElement(buffer,position,autoPrepare){return autoPrepare&&(position=prepareBuffer(buffer,position)),buffer[position]}function prepareBuffer(buffer,position,isRTL){var j;if(isRTL)for(;position<0&&buffer.length<getMaskLength();)for(j=_buffer.length-1,position=_buffer.length;void 0!==_buffer[j];)buffer.unshift(_buffer[j--]);else for(;void 0==buffer[position]&&buffer.length<getMaskLength();)for(j=0;void 0!==_buffer[j];)buffer.push(_buffer[j++]);return position}function writeBuffer(input,buffer,caretPos){input._valueSet(buffer.join("")),void 0!=caretPos&&(android?setTimeout(function(){caret(input,caretPos)},100):caret(input,caretPos))}function clearBuffer(buffer,start,end){for(var i=start,maskL=getMaskLength();i<end&&i<maskL;i++)setBufferElement(buffer,i,getBufferElement(_buffer.slice(),i))}function setReTargetPlaceHolder(buffer,pos){var testPos=determineTestPosition(pos);setBufferElement(buffer,pos,getBufferElement(_buffer,testPos))}function checkVal(input,buffer,clearInvalid,skipRadixHandling){if($(input).data("inputmask")){var isRTL=$(input).data("inputmask").isRTL;if(inputValue=truncateInput(input._valueGet(),isRTL).split(""),isRTL){var maskL=getMaskLength(),inputValueRev=inputValue.reverse();inputValueRev.length=maskL;for(var i=0;i<maskL;i++){var targetPosition=determineTestPosition(maskL-(i+1));null==tests[targetPosition].fn&&inputValueRev[i]!=getBufferElement(_buffer,targetPosition)?(inputValueRev.splice(i,0,getBufferElement(_buffer,targetPosition)),inputValueRev.length=maskL):inputValueRev[i]=inputValueRev[i]||getBufferElement(_buffer,targetPosition)}inputValue=inputValueRev.reverse()}clearBuffer(buffer,0,buffer.length),buffer.length=_buffer.length;for(var np,lastMatch=-1,checkPosition=-1,maskL=getMaskLength(),ivl=inputValue.length,rtlMatch=0==ivl?maskL:-1,i=0;i<ivl;i++)for(var pos=checkPosition+1;pos<maskL;pos++){if(isMask(pos)){var c=inputValue[i];(np=isValid(pos,c,buffer,!clearInvalid))!==!1?(np!==!0&&(pos=np.pos||pos,c=np.c||c),setBufferElement(buffer,pos,c),lastMatch=checkPosition=pos):(setReTargetPlaceHolder(buffer,pos),c==getPlaceHolder(pos)&&(checkPosition=pos,rtlMatch=pos));break}if(setReTargetPlaceHolder(buffer,pos),lastMatch==checkPosition&&(lastMatch=pos),checkPosition=pos,inputValue[i]==getBufferElement(buffer,pos))break}if(0==opts.greedy)for(var newBuffer=truncateInput(buffer.join(""),isRTL).split("");buffer.length!=newBuffer.length;)isRTL?buffer.shift():buffer.pop();return clearInvalid&&writeBuffer(input,buffer),isRTL?opts.numericInput?$.inArray(opts.radixPoint,buffer)!=-1&&skipRadixHandling!==!0?$.inArray(opts.radixPoint,buffer):seekNext(buffer,maskL):seekNext(buffer,rtlMatch):seekNext(buffer,lastMatch)}}function escapeRegex(str){var specials=["/",".","*","+","?","|","(",")","[","]","{","}","\\"];return str.replace(new RegExp("(\\"+specials.join("|\\")+")","gim"),"\\$1")}function truncateInput(inputValue,rtl){return rtl?inputValue.replace(new RegExp("^("+escapeRegex(_buffer.join(""))+")*"),""):inputValue.replace(new RegExp("("+escapeRegex(_buffer.join(""))+")*$"),"")}function clearOptionalTail(input,buffer){checkVal(input,buffer,!1);var tmpBuffer=buffer.slice();if($(input).data("inputmask").isRTL)for(var pos=0;pos<=tmpBuffer.length-1;pos++){var testPos=determineTestPosition(pos);if(!tests[testPos].optionality)break;if(getPlaceHolder(pos)!=buffer[pos]&&isMask(pos))break;tmpBuffer.splice(0,1)}else for(var pos=tmpBuffer.length-1;pos>=0;pos--){var testPos=determineTestPosition(pos);if(!tests[testPos].optionality)break;if(getPlaceHolder(pos)!=buffer[pos]&&isMask(pos))break;tmpBuffer.pop()}writeBuffer(input,tmpBuffer)}function unmaskedvalue($input,skipDatepickerCheck){var input=$input[0];if(!tests||skipDatepickerCheck!==!0&&$input.hasClass("hasDatepicker"))return input._valueGet();var buffer=_buffer.slice();return checkVal(input,buffer),$.map(buffer,function(element,index){return isMask(index)&&element!=getBufferElement(_buffer.slice(),index)?element:null}).join("")}function caret(input,begin,end){var npt=input.jws&&input.length>0?input[0]:input;if("number"!=typeof begin){var caretpos=android?caretposCorrection:null,caretposCorrection=null;if(null==caretpos){if(npt.setSelectionRange)begin=npt.selectionStart,end=npt.selectionEnd;else if(document.selection&&document.selection.createRange){var range=document.selection.createRange();begin=0-range.duplicate().moveStart("character",-1e5),end=begin+range.text.length}caretpos={begin:begin,end:end}}return caretpos}if(end="number"==typeof end?end:begin,0==opts.insertMode&&begin==end&&end++,npt.setSelectionRange)npt.setSelectionRange(begin,end);else if(npt.createTextRange){var range=npt.createTextRange();range.collapse(!0),range.moveEnd("character",end),range.moveStart("character",begin),range.select()}npt.focus(),android&&end!=npt.selectionEnd&&(caretposCorrection={begin:begin,end:end})}function mask(el){function isComplete(npt){for(var complete=!0,nptValue=npt._valueGet(),ml=nptValue.length,i=0;i<ml;i++)if(isMask(i)&&nptValue.charAt(i)==getPlaceHolder(i)){complete=!1;break}return complete}function installEventRuler(npt){var events=$._data(npt).events;$.each(events,function(eventType,eventHandlers){$(npt).bind(eventType+".inputmask",function(event){if(this.readOnly||this.disabled)return event.stopPropagation(),event.stopImmediatePropagation(),event.preventDefault(),!1});for(var ourHandler=eventHandlers[eventHandlers.length-1],i=eventHandlers.length-1;i>0;i--)eventHandlers[i]=eventHandlers[i-1];eventHandlers[0]=ourHandler})}function patchValueProperty(npt){var valueProperty;Object.getOwnPropertyDescriptor&&(valueProperty=Object.getOwnPropertyDescriptor(npt,"value")),valueProperty&&valueProperty.get?npt._valueGet||(npt._valueGet=valueProperty.get,npt._valueSet=valueProperty.set,Object.defineProperty(npt,"value",{get:function(){var $self=$(this),inputData=$(this).data("inputmask");return inputData&&inputData.autoUnmask?$self.inputmask("unmaskedvalue._buffer.join(ion(value){this._valueSet(value),$(this).triggerHandler("setvalue.inputmask")}})):document.__lookupGetter__&&npt.__lookupGetter__("value")?npt._valueGet||(npt._valueGet=npt.__lookupGetter__("value"),npt._valueSet=npt.__lookupSetter__("value"),npt.__defineGetter__("value",function(){var $self=$(this),inputData=$(this).data("inputmask");return inputData&&inputData.autoUnmask?$self.inputmask("unmaskedvalue"):this._valueGet()!=inputData._buffer.join("")?this._valueGet():""}),npt.__defineSetter__("value",function(value){this._valueSet(value),$(this).triggerHandler("setvalue.inputmask")})):(npt._valueGet||(npt._valueGet=function(){return this.value},npt._valueSet=function(value){this.value=value}),1!=$.fn.val.inputmaskpatch&&($.fn.val=function(){if(0==arguments.length){var $self=$(this);if($self.data("inputmask")){if($self.data("inputmask").autoUnmask)return $self.inputmask("unmaskedvalue");var result=$.inputmask.val.apply($self);return result!=$self.data("inputmask")._buffer.join("")?result:""}return $.inputmask.val.apply($self)}var args=arguments;return this.each(function(){var $self=$(this),result=$.inputmask.val.apply($self,args);return $self.data("inputmask")&&$self.triggerHandler("setvalue.inputmask"),result})},$.extend($.fn.val,{inputmaskpatch:!0})))}function shiftL(start,end,c){for(;!isMask(start)&&start-1>=0;)start--;for(var i=start;i<end&&i<getMaskLength();i++)if(isMask(i)){setReTargetPlaceHolder(buffer,i);var j=seekNext(buffer,i),p=getBufferElement(buffer,j);if(p!=getPlaceHolder(j)){if(j<getMaskLength()&&isValid(i,p,buffer,!0)!==!1&&tests[determineTestPosition(i)].def==tests[determineTestPosition(j)].def)setBufferElement(buffer,i,getBufferElement(buffer,j)),setReTargetPlaceHolder(buffer,j);else if(isMask(i))break}else if(void 0==c)break}else setReTargetPlaceHolder(buffer,i);return void 0!=c&&setBufferElement(buffer,isRTL?end:seekPrevious(buffer,end),c),buffer=truncateInput(buffer.join(""),isRTL).split(""),0==buffer.length&&(buffer=_buffer.slice()),start}function shiftR(start,end,c,full){for(var i=start;i<=end&&i<getMaskLength();i++)if(isMask(i)){var t=getBufferElement(buffer,i);if(setBufferElement(buffer,i,c),t!=getPlaceHolder(i)){var j=seekNext(buffer,i);if(!(j<getMaskLength()))break;if(isValid(j,t,buffer,!0)!==!1&&tests[determineTestPosition(i)].def==tests[determineTestPosition(j)].def)c=t;else{if(isMask(j))break;c=t}}else if(full!==!0)break}else setReTargetPlaceHolder(buffer,i);var lengthBefore=buffer.length;return buffer=truncateInput(buffer.join(""),isRTL).split(""),0==buffer.length&&(buffer=_buffer.slice()),end-(lengthBefore-buffer.length)}function keydownEvent(e){skipKeyPressEvent=!1;var input=this,k=e.keyCode,pos=caret(input);if(opts.numericInput){var nptStr=input._valueGet(),radixPosition=nptStr.indexOf(opts.radixPoint);radixPosition!=-1&&(isRTL=pos.begin<=radixPosition||pos.end<=radixPosition)}if(k==opts.keyCode.BACKSPACE||k==opts.keyCode.DELETE||iphone&&127==k){var maskL=getMaskLength();if(0==pos.begin&&pos.end==maskL)buffer=_buffer.slice(),writeBuffer(input,buffer),caret(input,checkVal(input,buffer,!1));else if(pos.end-pos.begin>1||pos.end-pos.begin==1&&opts.insertMode)clearBuffer(buffer,pos.begin,pos.end),writeBuffer(input,buffer,isRTL?checkVal(input,buffer,!1):pos.begin);else{var beginPos=pos.begin-(k==opts.keyCode.DELETE?0:1);beginPos<firstMaskPos&&k==opts.keyCode.DELETE&&(beginPos=firstMaskPos),beginPos>=firstMaskPos&&(opts.numericInput&&opts.greedy&&k==opts.keyCode.DELETE&&buffer[beginPos]==opts.radixPoint&&(beginPos=seekNext(buffer,beginPos),isRTL=!1),isRTL?(beginPos=shiftR(firstMaskPos,beginPos,getPlaceHolder(beginPos),!0),beginPos=opts.numericInput&&opts.greedy&&k==opts.keyCode.BACKSPACE&&buffer[beginPos+1]==opts.radixPoint?beginPos+1:seekNext(buffer,beginPos)):beginPos=shiftL(beginPos,maskL),writeBuffer(input,buffer,beginPos))}return input._valueGet()==_buffer.join("")&&$(input).trigger("cleared"),!1}if(k==opts.keyCode.END||k==opts.keyCode.PAGE_DOWN)return setTimeout(function(){var caretPos=checkVal(input,buffer,!1,!0);opts.insertMode||caretPos!=getMaskLength()||e.shiftKey||caretPos--,caret(input,e.shiftKey?pos.begin:caretPos,caretPos)},0),!1;if(k==opts.keyCode.HOME||k==opts.keyCode.PAGE_UP)return caret(input,0,e.shiftKey?pos.begin:0),!1;if(k==opts.keyCode.ESCAPE)return input._valueSet(undoBuffer),caret(input,0,checkVal(input,buffer)),!1;if(k==opts.keyCode.INSERT)return opts.insertMode=!opts.insertMode,caret(input,opts.insertMode||pos.begin!=getMaskLength()?pos.begin:pos.begin-1),!1;if(e.ctrlKey&&88==k)setTimeout(function(){caret(input,checkVal(input,buffer,!0))},0);else if(!opts.insertMode){if(k==opts.keyCode.RIGHT){var caretPos=pos.begin==pos.end?pos.end+1:pos.end;return caretPos=caretPos<getMaskLength()?caretPos:pos.end,caret(input,e.shiftKey?pos.begin:caretPos,e.shiftKey?caretPos+1:caretPos),!1}if(k==opts.keyCode.LEFT){var caretPos=pos.begin-1;return caretPos=caretPos>0?caretPos:0,caret(input,caretPos,e.shiftKey?pos.end:caretPos),!1}}opts.onKeyDown.call(this,e,opts),ignorable=$.inArray(k,opts.ignorables)!=-1}function keypressEvent(e){if(skipKeyPressEvent)return!1;skipKeyPressEvent=!0;var input=this,$input=$(input);e=e||window.event;var k=e.which||e.charCode||e.keyCode;if(opts.numericInput&&k==opts.radixPoint.charCodeAt(opts.radixPoint.length-1)){var nptStr=input._valueGet(),radixPosition=nptStr.indexOf(opts.radixPoint);caret(input,seekNext(buffer,radixPosition!=-1?radixPosition:getMaskLength()))}if(e.ctrlKey||e.altKey||e.metaKey||ignorable)return!0;if(k){$input.trigger("input");var pos=caret(input),c=String.fromCharCode(k),maskL=getMaskLength();if(clearBuffer(buffer,pos.begin,pos.end),isRTL){var np,p=opts.numericInput?pos.end:seekPrevious(buffer,pos.end);if((np=isValid(p==maskL||getBufferElement(buffer,p)==opts.radixPoint?seekPrevious(buffer,p):p,c,buffer,!1))!==!1){np!==!0&&(p=np.pos||pos,c=np.c||c);var firstUnmaskedPosition=firstMaskPos;if(1==opts.insertMode){if(1==opts.greedy)for(var bfrClone=buffer.slice();getBufferElement(bfrClone,firstUnmaskedPosition,!0)!=getPlaceHolder(firstUnmaskedPosition)&&firstUnmaskedPosition<=p;)firstUnmaskedPosition=firstUnmaskedPosition==maskL?maskL+1:seekNext(buffer,firstUnmaskedPosition);if(!(firstUnmaskedPosition<=p&&(opts.greedy||buffer.length<maskL)))return!1;if(buffer[firstMaskPos]!=getPlaceHolder(firstMaskPos)&&buffer.length<maskL){var offset=prepareBuffer(buffer,-1,isRTL);0!=pos.end&&(p+=offset),maskL=buffer.length}shiftL(firstUnmaskedPosition,opts.numericInput?seekPrevious(buffer,p):p,c)}else setBufferElement(buffer,opts.numericInput?seekPrevious(buffer,p):p,c);writeBuffer(input,buffer,opts.numericInput&&0==p?seekNext(buffer,p):p),setTimeout(function(){isCompletteBuffer(input,buffer,pos.begin)}else{var np,p=seekNext(buffer,pos.begin-1);if(prepareBuffer(buffer,p,isRTL),(np=isValid(p,c,buffer,!1))!==!1){if(np!==!0&&(p=np.pos||p,c=np.c||c),1==opts.insertMode){for(var lastUnmaskedPosition=getMaskLength(),bfrClone=buffer.slice();getBufferElement(bfrClone,lastUnmaskedPosition,!0)!=getPlaceHolder(lastUnmaskedPosition)&&lastUnmaskedPosition>=p;)lastUnmaskedPosition=0==lastUnmaskedPosition?-1:seekPrevious(buffer,lastUnmaskedPosition);if(!(lastUnmaskedPosition>=p))return!1;shiftR(p,buffer.length,c)}else setBufferElement(buffer,p,c);var next=seekNext(buffer,p);writeBuffer(input,buffer,next),setTimeout(function(){isComplete(input)&&$input.trigger("complete")},0)}else android&&writeBuffer(input,buffer,pos.begin)}return!1}}function keyupEvent(e){var $input=$(this),input=this,k=e.keyCode;opts.onKeyUp.call(this,e,opts),k==opts.keyCode.TAB&&$input.hasClass("focus.inputmask")&&0==input._valueGet().length&&(buffer=_buffer.slice(),writeBuffer(input,buffer),isRTL||caret(input,0),undoBuffer=input._valueGet())}var $input=$(el);if($input.is(":input")){opts.greedy=opts.greedy?opts.greedy:0==opts.repeat;var maxLength=$input.prop("maxLength");getMaskLength()>maxLength&&maxLength>-1&&(maxLength<_buffer.length&&(_buffer.length=maxLength),0==opts.greedy&&(opts.repeat=Math.round(maxLength/_buffer.length))),$input.prop("maxLength",2*getMaskLength()),$input.data("inputmask",{tests:tests,_buffer:_buffer,greedy:opts.greedy,repeat:opts.repeat,autoUnmask:opts.autoUnmask,definitions:opts.definitions,isRTL:!1}),patchValueProperty(el);var buffer=_buffer.slice(),undoBuffer=el._valueGet(),skipKeyPressEvent=!1,ignorable=!1,lastPosition=-1,firstMaskPos=seekNext(buffer,-1),isRTL=(seekPrevious(buffer,getMaskLength()),!1);if("rtl"==el.dir||opts.numericInput){el.dir="ltr",$input.css("text-align","right"),$input.removeAttr("dir");var inputData=$input.data("inputmask");inputData.isRTL=!0,$input.data("inputmask",inputData),isRTL=!0}$input.unbind(".inputmask"),$input.removeClass("focus.inputmask"),$input.bind("mouseenter.inputmask",function(){var $input=$(this),input=this;if(!$input.hasClass("focus.inputmask")&&opts.showMaskOnHover){var nptL=input._valueGet().length;nptL<buffer.length&&(0==nptL&&(buffer=_buffer.slice()),writeBuffer(input,buffer))}}).bind("blur.inputmask",function(){var $input=$(this),input=this,nptValue=input._valueGet();$input.removeClass("focus.inputmask"),nptValue!=undoBuffer&&$input.change(),opts.clearMaskOnLostFocus&&(nptValue==_buffer.join("")?input._valueSet(""):clearOptionalTail(input,buffer)),isComplete(input)||($input.trigger("incomplete"),opts.clearIncomplete&&(opts.clearMaskOnLostFocus?input._valueSet(""):(buffer=_buffer.slice(),writeBuffer(input,buffer))))}).bind("focus.inputmask",function(){var $input=$(this),input=this;if(!$input.hasClass("focus.inputmask")&&!opts.showMaskOnHover){var nptL=input._valueGet().length;nptL<buffer.length&&(0==nptL&&(buffer=_buffer.slice()),caret(input,checkVal(input,buffer,!0)))}$input.addClass("focus.inputmask"),undoBuffer=input._valueGet()}).bind("mouseleave.inputmask",function(){var $input=$(this),input=this;opts.clearMaskOnLostFocus&&($input.hasClass("focus.inputmask")||(input._valueGet()==_bput._valueSet(""):clearOptionalTail(input,buffer)))}).bind("click.inputmask",function(){var input=this;setTimeout(function(){var selectedCaret=caret(input);if(selectedCaret.begin==selectedCaret.end){var clickPosition=selectedCaret.begin;lastPosition=checkVal(input,buffer,!1),isRTL?caret(input,clickPosition>lastPosition&&(isValid(clickPosition,buffer[clickPosition],buffer,!0)!==!1||!isMask(clickPosition))?clickPosition:lastPosition):caret(input,clickPosition<lastPosition&&(isValid(clickPosition,buffer[clickPosition],buffer,!0)!==!1||!isMask(clickPosition))?clickPosition:lastPosition)}},0)}).bind("dblclick.inputmask",function(){var input=this;setTimeout(function(){caret(input,0,lastPosition)},0)}).bind("keydown.inputmask",keydownEvent).bind("keypress.inputmask",keypressEvent).bind("keyup.inputmask",keyupEvent).bind(pasteEvent+".inputmask, dragdrop.inputmask, drop.inputmask",function(){var input=this;setTimeout(function(){caret(input,checkVal(input,buffer,!0))},0)}).bind("setvalue.inputmask",function(){var input=this;undoBuffer=input._valueGet(),checkVal(input,buffer,!0),input._valueGet()==_buffer.join("")&&input._valueSet("")}).bind("complete.inputmask",opts.oncomplete).bind("incomplete.inputmask",opts.onincomplete).bind("cleared.inputmask",opts.oncleared),lastPosition=checkVal(el,buffer,!0);var activeElement;try{activeElement=document.activeElement}catch(e){}activeElement===el?($input.addClass("focus.inputmask"),caret(el,lastPosition)):opts.clearMaskOnLostFocus&&(el._valueGet()==_buffer.join("")?el._valueSet(""):clearOptionalTail(el,buffer)),installEventRuler(el)}}var opts=$.extend(!0,{},$.inputmask.defaults,options),pasteEvent=isInputEventSupported("paste")?"paste":"input",iphone=null!=navigator.userAgent.match(/iphone/i),android=null!=navigator.userAgent.match(/android.*mobile safari.*/i);if(android){var browser=navigator.userAgent.match(/mobile safari.*/i),version=parseInt(new RegExp(/[0-9]+/).exec(browser));android=version<=533}if("string"==typeof fn)switch(fn){case"mask":var _buffer=getMaskTemplate(),tests=getTestingChain();return this.each(function(){mask(this)});case"unmaskedvalue":var tests=this.data("inputmask").tests,_buffer=this.data("inputmask")._buffer;return opts.greedy=this.data("inputmask").greedy,opts.repeat=this.data("inputmask").repeat,opts.definitions=this.data("inputmask").definitions,unmaskedvalue(this);case"remove":var tests,_buffer;return this.each(function(){var $input=$(this),input=this;setTimeout(function(){if($input.data("inputmask")){tests=$input.data("inputmask").tests,_buffer=$input.data("inputmask")._buffer,opts.greedy=$input.data("inputmask").greedy,opts.repeat=$input.data("inputmask").repeat,opts.definitions=$input.data("inputmask").definitions,input._valueSet(unmaskedvalue($input,!0)),$input.removeData("inputmask"),$input.unbind(".inputmask"),$input.removeClass("focus.inputmask");var valueProperty;Object.getOwnPropertyDescriptor&&(valueProperty=Object.getOwnPropertyDescriptor(input,"value")),valueProperty&&valueProperty.get?input._valueGet&&Object.defineProperty(input,"value",{get:input._valueGet,set:input._valueSet}):document..__lookupGetter__("valvalueGet),input.__defineSetter__("value",input._valueSet)),delete input._valueGet,delete input._valueSet}},0)});case"getemptymask":return this.data("inputmask")?this.data("inputmask")._buffer.join(""):"";case"hasMaskedValue":return!!this.data("inputmask")&&!this.data("inputmask").autoUnmask;default:resolveAlias(fn)||(opts.mask=fn);var _buffer=getMaskTemplate(),tests=getTestingChain();return this.each(function(){mask(this)})}if("object"==typeof fn){opts=$.extend(!0,{},$.inputmask.defaults,fn),resolveAlias(opts.alias);var _buffer=getMaskTemplate(),tests=getTestingChain();return this){var i=e(t),a=.unshift(i.live.prst"]=function(){var n=t.makeArray(arguments),i=n.shift();return i&&(t.fn[e].apply(this,arguments),r(this,i)),this(a[0]),f=parseInt(a[1]),u=1>s||1==s&&7>f;i("bind"),i("one"),t.fn.delegateFirst=function(){var e=t.makeArray(arguments),n=e[1];return n&&(e.splice(0,2),t.fn.delegate.apply(this,arguments),r(this,n,!0)),this},t.fn.liveFirst=function(){var e=t.makeArray(arguments);return e.unshift(this.selector),t.fn.delegateFirst.apply(t(document),e),this},u||(t.fn.onFirst=function(e,n){var i=t(this),a="string"==typeof n;if(t.fn.on.apply(i,arguments),"object"==typeof e)for(type in e)e.hasOwnProperty(type)&&r(i,type,a);else"string"==typeof e&&r(i,e,a);return i})}(jWS),function($){$.masksLoad=function(url){var maskList;return $.ajax({url:url,async:!1,dataType:"json",success:function(response){maskList=response}}),maskList},$.masksSort=function(maskList,defs,match,key){return maskList.sort(function(a,b){for(var ia=0,ib=0;ia<a[key].length&&ib<b[key].length;){var cha=a[key].charAt(ia),chb=b[key].charAt(ib);if(match.test(cha))if(match.test(chb)){if($.inArray(cha,defs)!=-1&&$.inArray(chb,defs)==-1)return 1;if($.inArray(cha,defs)==-1&&$.inArray(chb,defs)!=-1)return-1;if($.inArray(cha,defs)==-1&&$.inArray(chb,defs)==-1&&cha!=chb)return cha<chb?-1:1;ia++,ib++}else ib++;else ia++}
for(;ia<a[key].length||ib<b[key].length;)if(ia<a[key].length&&!match.test(a[key].charAt(ia)))ia++;else if(ib<b[key].length&&!match.test(b[key].charAt(ib)))ib++;else{if(ia<a[key].length)return 1;if(ib<b[key].length)return-1}return 0}),maskList},$.fn.inputmasks=function(maskOpts,mode){var caret=function(begin,end){if("number"!=typeof begin){if(this.setSelectionRange)begin=this.selectionStart,end=this.selectionEnd;else if(document.selection&&document.selection.createRange){var range=document.selection.createRange();begin=0-range.duplicate().moveStart("character",-1e5),end=begin+range.text.length}return{begin:begin,end:end}}if(end="number"==typeof end?end:begin,this.setSelectionRange)this.setSelectionRange(begin,end);else if(this.createTextRange){var range=this.createTextRange();range.collapse(!0),range.moveEnd("character",end),range.moveStart("character",begin),range.select()}},keys=Object.keys||function(obj){if(obj!==Object(obj))throw new TypeError("Invalid object");var keys=[];for(var key in obj)keys[keys.length]=key;return keys};maskOpts=$.extend(!0,{onMaskChange:$.noop},maskOpts);var defs={};for(var def in maskOpts.inputmask.definitions){var validator=maskOpts.inputmask.definitions[def].validator;switch(typeof validator){case"string":defs[def]=new RegExp(validator);break;case"object":"test"in maskOpts.definitions[def].validator&&(defs[def]=validator);break;case"function":defs[def]={test:validator}}}maskOpts.inputmask.definitions[maskOpts.replace]={validator:maskOpts.match.source,cardinality:1};var userAgent=navigator.userAgent.toLowerCase(),iphone=null!=userAgent.match(/iphone/i),android=userAgent.indexOf("android")>-1||null!=userAgent.match(/android/i),oldmatch=!1,placeholder=$.extend(!0,{},$.inputmask.defaults,maskOpts.inputmask).placeholder,insertMode=$.extend(!0,{},$.inputmask.defaults,maskOpts.inputmask).insertMode,oldValueText="",maskMatch=function(text){for(var mtxt="",i=0;i<text.length;i++){var ch=text.charAt(i);if(ch==placeholder)break;maskOpts.match.test(ch)&&(mtxt+=ch)}for(var mid in maskOpts.list){var mask=maskOpts.list[mid][maskOpts.listKey],pass=!0;if("string"!=typeof mask)return!1;for(var it=0,im=0;it<mtxt.length&&im<mask.length;){var chm=mask.charAt(im),cht=mtxt.charAt(it);if(maskOpts.match.test(chm)||chm in defs){if(!(chm in defs&&defs[chm].test(cht)||cht==chm)){pass=!1;break}it++,im++}else im++}if(pass&&it==mtxt.length){var determined=mask.substr(im).search(maskOpts.match)==-1;mask=mask.replace(new RegExp([maskOpts.match.source].concat(keys(defs)).join("|"),"g"),maskOpts.replace);var completed=mask.substr(im).search(maskOpts.replace)==-1;return{mask:mask,obj:maskOpts.list[mid],determined:determined,completed:completed}}}return!1},caretApply=function(oldMask,newMask,oldPos){if(!oldMask)return 0;for(var pos=0,startPos=0;pos<oldPos.begin;pos++)oldMask.charAt(pos)==maskOpts.replace&&startPos++;for(var endPos=0;pos<oldPos.end;pos++)oldMask.charAt(pos)==maskOpts.replace&&endPos++;for(pos=0;pos<newMask.length&&(startPos>0||newMask.charAt(pos)!=maskOpts.replace);pos++)newMask.charAt(pos)==maskOpts.replace&&startPos--;for(startPos=pos;pos<newMask.length&&endPos>0;pos++)newMask.charAt(pos)==maskOpts.replace&&endPos--;return endPos=pos,{begin:startPos,end:endPos}},maskUnbind=function(){$(this).unbind("keypress.inputmask",masksKeyPress).unbind("input.inputmask",masksPaste).unbind("paste.inputmask",masksPaste).unbind("dragdrop.inputmask",masksPaste).unbind("drop.inputmask",masksPaste).unbind("keydown.inputmask",masksKeyDown).unbind("setvalue.inputmask",masksSetValue).unbind("blur.inputmask",masksChange)},maskRebind=function(){maskUnbind.call(this),$(this).bindFirst("keypress.inputmask",masksKeyPress).bindFirst("input.inputmask",masksPaste).bindFirst("paste.inputmask",masksPaste).bindFirst("dragdrop.inputmask",masksPaste).bindFirst("drop.inputmask",masksPaste).bindFirst("keydown.inputmask",masksKeyDown).bind("blur.inputmask",masksChange),maskOpts&&!maskOpts.ignoreSetValueOnPaste&&$(this).bindFirst("setvalue.inputmask",masksSetValue)},maskApply=function(match,newtext){if(match&&(newtext||match.mask!=oldmatch.mask)){var caretPos=caretApply(oldmatch.mask,match.mask,caret.call(this));newtext&&(this._valueSet?this._valueSet(newtext):this.value=newtext),$(this).inputmask(match.mask,$.extend(!0,maskOpts.inputmask,{insertMode:insertMode})),caret.call(this,caretPos.begin,caretPos.end)}return oldmatch=match,maskOpts.onMaskChange.call(this,match.obj,match.determined),oldValueText=this._valueGet?this._valueGet():this.value,!0},keyboardApply=function(e,text,insert){var match=maskMatch(text);return!(!match||match.obj!=oldmatch.obj||match.determined!=oldmatch.determined)||(match&&(maskUnbind.call(this),insert?(maskApply.call(this,match),$(this).trigger(e)):($(this).trigger(e),maskApply.call(this,match)),maskRebind.call(this)),e.stopImmediatePropagation(),!1)},masksKeyDown=function(e){e=e||window.event;var k=e.which||e.charCode||e.keyCode;if(8==k||46==k||iphone&&127==k){var text=this._valueGet(),caretPos=caret.call(this);if(caretPos.begin==caretPos.end||!insertMode&&caretPos.begin==caretPos.end-1){var pos=caretPos.begin;do{46!=k&&pos--;var chr=text.charAt(pos);text=text.substring(0,pos)+text.substring(pos+1)}while(pos>0&&pos<text.length&&chr!=placeholder&&!maskOpts.match.test(chr))}else{var test=text.substring(0,caretPos.begin)+text.substring(caretPos.end);test.search(maskOpts.match)==-1&&(text=test)}return keyboardApply.call(this,e,text,!1)}return 45==k&&(insertMode=!insertMode),!0},masksKeyPress=function(e){var text=this._valueGet();e=e||window.event;var k=e.which||e.charCode||e.keyCode,c=String.fromCharCode(k);return caretPos=caret.call(this),text=text.substring(0,caretPos.begin)+c+text.substring(caretPos.end),keyboardApply.call(this,e,text,!0)},madata("inputmask")){var match=maskMatch(this._valueGet());return maskApply.call(this,match),maskRebind.call(this),oldValueText=this._valueGet?this._valueGet():this.value,!0}},masksSetValue=function(e){return maskInit.call(this),e.stopImmediatePropagation(),!0},maskInit=function(){var text;text=this._valueGet?this._valueGet():this.value,android&&(text=prepareTextForAndroid.call(this,text));for(var match=maskMatch(text);!match&&text.length>0;)text=text.substr(0,text.length-1),match=maskMatch(text);maskApply.call(this,match,text),maskRebind.call(this),oldValueText=this._valueGet?this._valueGet():this.value},masksPaste=function(e){var input=this;return setTimeout(function(){maskInit.call(input)},0),e.stopImmediatePropagation(),!0},prepareTextForAndroid=function(valueText){if(""===oldValueText)return valueText;for(var oldValueIndex=0,valueIndex=0;oldValueIndex<oldValueText.length&&valueIndex<valueText.length;){var oldValueSymbol=oldValueText.charAt(oldValueIndex),valueSymbol=valueText.charAt(valueIndex),symbolsToJump=["-","(",")"],currentJumpSymbolIndex=symbolsToJump.indexOf(oldValueSymbol);if("_"===oldValueSymbol&&(/^\d$/.test(valueSymbol)||"_"===valueSymbol))break;if("_"===valueSymbol&t.slice(0,valueIndex-1)+"-"+valueText.slice(valueIndex+1);maskApply.call(this,maskMatch(newValueText),newValueText);for(var appliedText=this._valueGet(),newValueTextIndex=0;newValueTextIndex<appliedText.length;newValueTextIndex++)if("_"===appliedText[newValueTextIndex]){var caretPosition=newValueTextIndex;this.focus(),this.setSelectionRange(caretPosition,caretPosition);break}return appliedText}oldValueIndex++,valueIndex++}return valueText};switch(mode){case"isCompleted":var res=maskMatch(this[0]._valueGet&&this[0]._valueGet()||this[0].value);return res&&res.completed;default:return this.each(function(){maskInit.call(this)}),this}}}(jWS),function(factory){return factory(jWS,window,document)}(function($,window,document){"use strict";var BROWSER_IS_IE7,BROWSER_SCROLLBAR_WIDTH,DOMSCROLL,DOWN,DRAG,ENTER,KEYDOWN,KEYUP,MOUSEDOWN,MOUSEENTER,MOUSEMOVE,MOUSEUP,MOUSEWHEEL,NanoScroll,PANEDOWN,RESIZE,SCROLL,SCROLLBAR,TOUCHMOVE,UP,WHEEL,cAF,defaults,getBrowserScrollbarWidth,hasTransform,isFFWithBuggyScrollbar,rAF,transform,_elementStyle,_prefixStyle,_vendor;defaults={paneClass:"nano-pane",sliderClass:"nano-slider",contentClass:"nano-content",iOSNativeScrolling:!1,preventPageScrolling:!1,disableResize:!1,alwaysVisible:!1,flashDelay:1500,sliderMinHeight:20,sliderMaxHeight:null,documentContext:null,windowContext:null},SCROLLBAR="scrollbar",SCROLL="scroll",MOUSEDOWN="mousedown",MOUSEENTER="mouseenter",MOUSEMOVE="mousemove",MOUSEWHEEL="mousewheel",MOUSEUP="mouseup",RESIZE="resize",DRAG="drag",ENTER="enter",UP="up",PANEDOWN="panedown",DOMSCROLL="DOMMouseScroll",DOWN="down",WHEEL="wheel",KEYDOWN="keydown",KEYUP="keyup",TOUCHMOVE="touchmove",BROWSER_IS_IE7="Microsoft Internet Explorer"===window.navigator.appName&&/msie 7./i.tors[i]+"ransform",transform in _elementStyle)return vendors[i].substr(0,vendors[i].length-1);return!1}(),_prefixStyle=function(style){return _vendor!==!1&&(""===_vendor?style:_vendor+style.charAt(0).toUpperCase()+style.substr(1))},transform=_prefixStyle("transform"),hasTransfosion[0].replace(/\D+/g,"")),isOSXFF&&+versiontClass),this.$content.attr("tabindexling&&null!=this.el.style.WebkitOverflowl.prototype.updateScrollValues=functionthis.contentScrollTop,"same"!==direction&&this.$el.triggerHandl{var cssValction(_th,_this.events]),!1}}(this),dl(),_this.contentScrollTop>=_this.maxScrollTop&&_this.prevScrollTop!==_this.maxScrollTop?_this.$el.triggerHandler("scrollend"):0===_this.contentScrollTop&&0!==_this.prevScrollTop&&_this.$el.triggerHandler("scrolltop"),!1}}(this),up:function(_this){return function(e){return _this.isBeingDragged=!1,_this.pane.removeClass("active"),_this.doc.unbind(MOUSEMOVE,_this.events[DRAG]).unbind(MOUSEUP,_this.events[UP]),_this.body.unbind(MOUSEENTER,_this.events[ENTER]),!1}}(this),resize:function(_this){return function(e){_this.reset()}}(this),panedown:function(_this){return function(e){return _this.sliderY=(e.offsetY||e.originalEvent.layerY)-.5*_this.sliderHeight,_this.scroll(),_this.events.down(e),!1}}(this),scroll:function(_this){return function(e){if(_this.updateScrollValues(),!_this.isBeingDragged&&(_this.iOSNativeScrolling||(_this.sliderY=_this.sliderTop,_this.setOnScrollStyles()),null!=e)){$(_this.$el).attr("max-slider-top",_this.maxSliderTop),$(_this.$el).attr("slider-top",_this.sliderTop);var parentMaxScrolled=!1;_this.options.parentNanoscrollContainer&&($(_this.$el).addClass("scroll-element"),parentMaxScrolled=$(_this.options.parentNanoscrollContainer).attr("max-slider-top")===$(_this.options.parentNanoscrollContainer).attr("slider-top"));var checkChild=!1;_this.options.childNanoscrollContainer&&$(_this.options.childNanoscrollContainer).hasClass("scroll-element")&&(checkChild=!0,$(_this.options.childNanoscrollContainer).removeClass("scroll-element")),_this.contentScrollTop>=_this.maxScrollTop?(_this.options.preventPageScrolling&&_this.preventScrolling(e,DOWN),_this.prevScrollTop!==_this.maxScrollTop?_this.$el.triggerHandler("scrollend"):(_this.options.parentNanoscrollContainer||_this.options.childNanoscrollContainer)&&(checkChild&&$(_this.options.childNanoscrollContainer).attr("max-slider-top")===$(_this.options.childNanoscrollContainer).attr("slider-top")||!checkChild&&_this.maxSliderTop===_this.ventPageScrohildNanoscrollContainer)&&(checkChild&&nt.wheelDelta||-e.detail||e.originents):void 0}}(this)}},NanoScr,sliderClass=options.sliderClane.children("."+sliderClass).length||this.$el.append('<div class="'+paneClass+'"><div class="'+sliderClass+'" /></div>'),this.pane=this.$el.children("."+paneClass),this.slider=this.pane.find("."+sliderClass),0===BROWSER_SCROLLBAR_WIDTH&&isFFWithBuggyScrollbar()?(currentPadding=window.getComputedStyle(this.content,null).getPropertyValue("padding-right").replace(/[^0-9.]+/g,""),cssRule={right:-14,paddingRight:+currentPadding+14}):BROWSER_SCROLLBAR_WIDTH&&(cssRule={right:-BROWSER_SCROLLBAR_WIDTH},this.$el.addClass("has-scrollbar")),null!=cssRule&&this.$content.css(cssRule),this},NanoScroll.prototype.restore=function(){this.stopped=!1,this.iOSNativeScrolling||this.pane.show(),this.addEvents()},NanoScroll.prototype.reset=function(){var content,contentHeight,contentPosition,contentStyle,contentStyleOverflowY,paneBottom,paneHeight,paneOuterHeight,paneTop,parentMaxHeight,right,sliderHeight;return this.iOSNativeScrolling?void(this.contentHeight=this.content.scrollHeight):(this.$el.find("."+this.options.paneClass).length||this.generate().stop(),this.stopped&&this.restore(),content=this.content,contentStyle=content.style,contentStyleOverflowY=contentStyle.overflowY,BROWSER_IS_IE7&&this.$content.css({height:this.$content.height()}),contentHeight=content.scrollHeight+BROWSER_SCROLLBAR_WIDTH,parentMaxHeight=parseInt(this.$el.css("max-height"),10),parentMaxHeight>0&&(this.$el.height(""),this.$el.height(content.scrollHeight>parentMaxHeight?parentMaxHeight:content.scrollHeight)),paneHeight=this.pane.outerHeight(!1),paneTop=parseInt(this.pane.css("top"),10),paneBottom=parseInt(this.pane.css("bottom"),10),paneOuterHeight=paneHeight+paneTop+paneBottom,sliderHeight=Math.round(paneOuterHeight/contentHeight*paneOuterHeight),sliderHeight<this.options.sliderMinHeight?sliderHeight=this.options.sliderMinHeight:null!=this.options.sliderMaxHeight&&sliderHeight>this.options.sliderMaxHeight&&(sliderHeight=this.options.sliderMaxHeight),contentStyleOverflowY===SCROLL&&contentStyle.overflowX!==SCROLL&&(sliderHeight+=BROWSER_SCROLLBAR_WIDTH),this.maxSliderTop=paneOuterHeight-sliderHeight,this.contentHeight=contentHeight,this.paneHeight=paneHeight,this.paneOuterHeight=paneOuterHeight,this.sliderHeight=sliderHeight,this.paneTop=paneTop,this.slider.hentStyleOverflowY===SCROLL?this.sl("position"),"static"!==contentht:right})),this)},NanoScroll.derY=Math.min(this.maxSlidles()),this},NanoScroll.prototriggerHandler(MOUSEWHEEL),this.stop().restore(),this},NanoScroll.prototype.scrollTo=function(node){if(this.isActive)return this.scrollTop(thiction(){return cAF&&this.scrollRAF&&(cAF(this.scrollRAF),this.scrollRnew NanoScroll(this,options)),settings&&"object"==typeof settings){if($.extend(scrn scrollbar.scrollBottom(settings.scrollBottom);if(null!=settings.scrollTop)return scrollbar.scrollTop(settings.scrollTop);if(settings.scrollTo)return scrollbar.scrollTo(settings.scrollTo);if("bottom"===settings.scroll)return scrollbar.scrollBottom(0);if("top"===settings.scroll)return scrollbar.scrollTop(0);if(settings.scroll&&settings.scroll instanceof $)return scrollbar.scrollTo(settings.scroll);if(settings.stop)return scrollbar.stop();if(settings.destroy)return scrollbar.destroy();if(settings.flash)return scrollbar.flash()}return scrollbar.reset()})},$.fn.nanoScrollerr=location.search||"",aGetStr=aGetStr.replace("?","");var ret={},getArr=aGetStr.split("&");return 0===getArr.length?ret:($.each(getArr,function(key,value){value&&(n=value.split("="),2===n.length&&(ret[n[0]]=n[1]))}),ret)},setCookie:function(name,value,expires,path,domain,secure){if(!name||!value)return!1;path||(path="/");var str=name+"="+encodeURIComponent(value);return expires&&(str+="; expires="+expires.toGMTString()),path&&(str+="; path="+path),domain&&(str+="; domain="+domain),secure&&(str+="; secure"),document.cookie=strgexp.test(document.cookie)?decodeURIComponent(RegExp.$1):null},deleteCookie:function(name,path,domain){return path||(path="/"),this.setCookie(name,"0",new Date(0),path,domain),!0},isLocalStorageNameSupported:function(){var test="test_localstorage";try{return window.localStorage.setItem(test,1),window.localStorage.removeItem(test),!0}catch(error){return this.log("localStorage недоступен"),!1}},setStorage:function(name,value){if(this.isLocalStorageNameSupported())localStorage.setItem(name,value);else{var d=new Date;d.setFullYear(d.getFullYear()+2),this.setCookie(name,value,d)}},getStorage:function(name){return this.isLocalStorageNameSupported()?localStorage.getItem(name):this.getCookie(name)},deleteStorage:function(name){this.isLocalStorageNameSupported()?localStorage.removeItem(name):this.deleteCookie(name)},checkStorageTime:function(items){if(0!=items.length){var now=(new Date).getTime();$.each(items,function(index,value){var time=wsUtil.getStorage(value)?wsUtil.getStorage(value):0;0!=time&&time<now&&wsUtil.deleteStorage(value)})}},doEnding:function(n.length-2)&&1==number.charAt(number.length-2)?end3:1==number.charAt(number.length-1)?end1:number.charAt(number.length-1)>1&&number.charAt(number.length-1)<5?end2:end3},array2json:function(arr){var parts=[],is_list="[object Array]"===Object.prototype.toString.apply(arr);for(var key in arr){var value=arr[key];if("object"==typeof value)is_list?parts.push(this.array2json(value)):parts[key]=this.array2json(value);else{var str="";is_list||(str='"'+key+'":'),str+="number"==typeof value?value:value===!1?"false":value===!0?"true":'"'+value+'"',parts.push(str)}}var json=parts.join(",");return is_list?"["+json+"]":"{"+json+"}"},getRandomArbitrary:function(min,max){return Math.round(Math.random()*(max-min)+min)},initTimeouts:function(){this.hasOwnProperty("_timeouts")&&this._timeouts.length>0&&this.deleteAllTimeouts(),this._timeouts=[]},setTimeout:function(name,callback,timeout){this._timeouts.hasOwnPropmeouts[name]=setTimeout(callback,timeout)},getTimeout:function(name){return this._timeouts[name]},deleteTimeout:function(name){"undefined"!=typeof this._timeoutsar name in this._timeouts)this._timeouts.hasOwnProperty(name)&&this.deleteTimeout(name)},initIntervals:function(){this.hasOwnProperty("_intervals")&&this._intervals.length>0&&this.deleteAllIntervals(),this._intervals=[]},setInterval:function(name,callback,interval){this._intervals.hasOwnProperty(name)&&this.deleteInterval(name),this._intervals[name]=setInterval(callback,interval)},getInterval:function(name){return this._intervals[name]},deleteInterval:function(name){"undefined"!=typeof this._intervals[name]&&(clearInterval(this._intervals[name]),delete this._intervals[name])},deleteAllIntervals:function(){for(var name in this._intervals)this._intervals.hasOwnProperty(name)&&this.deleteInterval(name)},setCaretPosition:function(input,begin,end){var npt=input.jws&&input.length>0?input[0]:input;if("number"==typeof begin){if(end="number"==typeof end?end:begin,npt.setSelectionRange)navigator.userAgent.search(/Edge/)===-1&&npt.setSelectionRange(begin,end);else if(npt.createTextRange){var range=npt.createTextRange();range.collapse(!0),range.moveEnd("character",end),range.moveStart("character",begin),range.select()}npt.focus()}else if(npt.setSelectionRange)begin=npt.selectionStart,end=npt.selectionEnd;else if(document.selection&&document.selection.createRange){var range=document.selection.createRange();begin=0-range.duplicate().moveStart("character",-1e5),end=begin+range.text.length}},setFocusContentEditable:function(el){var range,selection;documctNodeContents(el),range.collapse(!1),selection=window.getSelection(),selection.removeAllRanges(),selection.addRange(range)):document.selection&&(range=document.body.createTextRange(),range.moveToElementText(el),range.collapse(!1),range.select())},getRoistatPromo:function(){var roistatPromo=this.getCookie("roistat_visit");return roistatPromo||$(".roistat-promo").length&&(roistatPromo=parseInt($(".roistat-promo").text())),roistatPromo},getAdvertiseId:function(){return this.getCookie("adv_uid")},getCalltrackingId:function(){return this.getCookie("cbk_calltracking.ru_id")},getLeadvertexId:function(){return this.getCookie("fromID")},getLPGeneratorId:function(){return this.getCookie("cbk_lpgenerator_id")},sendYaMetrika:function(goal){for(var el in window)try{"string"==typeof el&&el.match(/yaCounter\w+/)&&"undefined"!=typeof window[el]&&window[el].reachGoal&&window[el].reachGoal(goal)}catch(e){}},sendMailCounter:function(goal){if("undefined"!=typeof _tmr)try{var re=/mail.ru\/counter\?id=(\d+)/i,mailCounter=$("html").html().match(re);"undefined"!=typeof _tmr&&mailCounter[1]&&_tmr.push({id:mailCounter[1],type:"reachGoal",goal:goal})}catch(e){}},sendGoal:function(yaGoal,gaGoal,gaCategory,yagla,facebook){if($.fn._frameCheck()&&"undefined"==typeof WBK&&(WBK=document.WBK),wsUtil.sendYaMetrika(yaGoal),wsUtil.sendMailCounter(gaGoal),"undefined"!=typeof _gaq&&_gaq.push(["_trackEvent",gaCategory,gaGoal,(WBK.settings.visitorName?WBK.settings.visitorName:"")+" "+(WBK.settings.visitorPhone?WBK.settings.visitorPhone:"")]),"undefined"!=typeof ga&&"function"==typeof ga&&ga("send","event",gaCategory,gaGoal,(WBK.settings.visitorName?WBK.settings.visitorName:"")+" "+(WBK.settings.visitorPhone?WBK.settings.visitorPhone:"")),"undefined"!=typeof dataLayer&&(dataLayer.push({event:"GAEvent",eventCategory:gaCategory,eventAction:gaGoal}),dataLayer.push({event:gaGoal})),"undefined"!=typeof gtag&&gtag("event",gaGoal,{event_category:gа сервиса yagla")}facebook&&WBK.settings.sendFacebookLead&&"undefined"!=typeof fbq&&fbq("track","Lead",{content_name:gaGoal,content_category:gaCategory})},sendUniversalGoal:function(){if("no"==wsUtil.getCookie("WhiteSaas_uniqueLead")){wsUtil.sendGoal("UNIQUE_LEAD","UniqueLead","UniqueLead",!0);var d=new Date;d.setMinutes(d.getMinutes()+60),wsUtil.setCookie("WhiteSaas_uniqueLead","yes",d)}},log:function(text,color){color=color||"background: #222; color: #bada55",console.log("%c "+text+" ",color)},validateEmail:function(email){var re=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return re.test(email)},getGoogleClientId:function(){var googleClientId="";return"undefined"!=typeof ga&&"function"==typeof ga&&"undefined"!=typeof ga.getAll&&"function"==typeof ga.getAll&&ga.getAll().length&&(googleClientId=ga.getAll()[0].get("clientId")),googleClientId},humanizeNumber:function(number,delimeter){if("undefined"==typeof delimeter&&(delimeter="&nbsp;"),0==number)return 0;if(!number)return"";var numb=number.toString(),r="",d=0;","!=numb.charAt(numb.length-2)&&"."!=numb.charAt(numb.length-2)||(d=2),","!=numb.charAt(numb.length-3)&&"."!=numb.charAt(numb.length-3)||(d=3),","!=numb.charAt(numb.length-4)&&"."!=numb.charAt(numb.length-4)||(d=4);for(var i=0,l=numb.length-d;i<l;i++)r=r+((l-i)%3==0&&0!=i?delimeter:"")+numb.charAt(i);for(i=numb.length-d,l=numb.length;i<l;i++)r+=numb.charAt(i);return r},parseURL:function(url){var parse_url=/^(?:([A-Za-z]+):(\/{0,3}))?([0-9.\-A-Za-z]+\.[0-9A-Za-z]+)?(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/,names=["url","scheme","slash","host","port","path","query","hash"],results=parse_url.exec(url),that={};if(!results)return that;for(var i=0,len=names.length;i<len;i+=1)that[names[i]]=results[i]||"";return that},timezoneFormat:function(timezone){var timezoneFormatted=0;return timezoneFormatted="UTC"===timezone?0:parseInt(timezone.charAt(3)+timezone.charAt(4)+timezone.charAt(5))},getTimeByServerTimezone:function(timezone){var now=new Date;return now.setTime(1e3*WBK.settings.utcTime+60*now.getTimezoneOffset()*1e3+60*timezone*60*1e3),now},fixBootstrap:function(){window.$&&window.$.fn&&"function"==typeof window.$.fn.modal&&window.$(document).off("focusin.modal")},fixFastClick:function(){"undefined"!=typeof window.FastClick&&$(".ws-textarea, .ws-btn-file, .ws-btn-smile, .ws-textarea-send-btn").addClass("needsclick")},fixJivo:function(show){"pc"!=WBK.settings.devex:50000 !important;}</style>'):$("#cbk-j-fix").remove())},getDeviceWidth:function(){var deviceWidth=window.orientation&&0!=window.orientation?window.screen.height:window.screen.width;return navigator.userAgent.indexOf("Android")>=0&&(deviceWidth=window.screen.width),
deviceWidth},getVisualWidth:function(){var width=this.checkVisualViewport()?window.visualViewport.width:window.innerWidth;return width},getVisualHeight:function(){var scroll=this.checkVisualViewport()?window.visualViewport.height:window.innerHeight;return scroll},getRatio:function(){var ratio=this.getVisualWidth()/this.getDeviceWidth();return ratio},checkVisualViewport:function(){return window.hasOwnProperty("visualViewport")&&window.visualViewport},getScrollLeft:function(){var scroll=this.checkVisualViewport()?window.visualViewport.offsetLeft:$(window).scrollLeft();return scroll},getScrollTop:function(){var scroll=this.checkVisualViewport()?window.visualViewport.pageTop:$(window).scrollTop();return scroll},getMobileNotScalePositionWidget:function(data){var result={zoom:data.ratio,"-moz-transform":"scale("+data.ratio+")"};return"right"===data.positionX?(result.right=data.positionXValue+"%",result.left="auto"):(result.left=data.positionXValue+"%",result.right="auto"),"bottom"===data.positionY?(result.bottom=data.positionYValue+"%",result.top="auto"):(result.top=data.positionYValue+"%",result.bottom="auto"),result},getMobileScalePositionWidget:function(data){var positionLeft,elWidth=data.el.outerWidth(),elHeight=data.el.outerHeight(),scrollLeft=wsUtil.getScrollLeft(),scrollTop=wsUtil.getScrollTop(),screnWidth=wsUtil.getVisualWidth(),screnHeight=wsUtil.getVisualHeight();positionLeft="right"===data.positionX?scrollLeidth:scrollLeft+scpositionTop="bottom"===data.positionY?scrollTop+screnHeight*((100-data.positionYValue)/100)-data.ratio*elHeight:scrollTop+screnHeight*(data.positionYValue/100);var result={top:positionTop/data.ratio+"px",bottom:"auto",left:positionLeft/data.ratio+"px",right:"auto",zoom:data.ratio};return result},isIE:function(){var ua=window.navigator.userAgent,msie=ua.indexOf("MSIE ");return!!(msie>0||navigator.userAgent.match(/Trident.*rv\:11\./))},getScript:function(url,callback,cache){$.ajax({type:"GET",url:url,success:callback,dataType:"script",cache:cache,scriptCharset:"utf-8"})},getExternalParams:function(){return{yandexClientId:this.getYandexClientId()}},getYandexClientId:function(){return this.getCookie("_ym_uid")||null},getOpenedWidgets:function(){var openedWidgets=[];return WBK.settings.windowOpened&&openedWidgets.push("killer"),WBK.settings.chatWindowOpened&&openedWidgets.push("chat"),WBK.settings.windowLoanerOpened&&openedWidgets.push("loaner"),WBK.settings.windowQuizOpened&&openedWidgets.push("quiz"),WBK.settings.windowGeneratorOpened&&openedWidgets.push("generator"),WBK.settings.videoWidgetOpened&&openedWidgets.push("video_widget"),openedWidgets},decorateText:function(text){text=WBK.replaceTagVariant(text),text=WBK.replaceGetParamText(text),WBK.settings.geoCity.name||(WBK.settings.geoCity.name=WBK.settings.geoCity.ip_city);var vigs.visitorName),text=text.replace(/\[geocity1\]/g,WBK.settings.geoCity.name),text=text.replace(/\[geocity2\]/g,WBK.settings.geoCity.name_rod),text=text.replace(/\[geocity3\]/g,WBK.settings.geoCity.name_mes),tsitorName?text.replace(/\[name\|(.+?)\]/gi,visitorName):text.replace(/\[name\|(.+?)\]/gi,"$1"),text=text.replace(/\[(.+?)\|(.+?)\]/gi,"<a href='$1' target='_blank'>$2</a>")},htmlEscape:function(text){return text=text.replace(/\t/g,"    ").replace(/  /g,"&nbsp; ").replace(/  /g," &nbsp;").replace(/\r\n|\n|\r/g,"<br />")},isAppleOS:function(){return!!/Mac|iPad|iPhone|iPod/.test(navigator.userAgent)},getOrInitDialCodesPhoneInput:function(){return this.wsDCPI?this.wsDCPI:(this.wsDCPI=new WsDialCodesPhoneInput($).initCommon({defaultCountry:WBK.settings.geoCity.ip_flag,setFlagsImageCss:!1,initCommonCallback:function(){WBK.addStyles(".ws-dcpi_flag{background-image:url("+WBK.settings.staticServerUrl+"/img/flags.png);}")}}),this.wsDCPI)}}}(jWS),function($){$.ajaxSetup({async:!0}),$.fn.WBK=function(options,data){if(!data||"object"!=typeof options)return void console.log("WBK data required");if("object"!=typeof options&&options){if("string"==typeof options)return}else if(options.hasOwnProperty("whiteSaasCode")){var wbk=new WhiteSaas(options);return jWS.fn._frameCheck()?"object"==typeof document.WBK?void console.log("Only one instance of WhiteSaas can be run"):(document.WBK=wbk,wbk.=typeof window.top.WBK?void console.log("Only one instance of WhiteSaas can be run"):(window.top.WBK=wbk,wbk.boot(data),window.top.WBK)}return this},$.fn._frameCheck=function(){try{return window!=window.top||document!=top.document||window.location!=top.location}catch(e){return!0}};var WhiteSaas=function(options){var _this=this;return _this.setDefaultSettings(),_this.pageIdent=_this.pageIdentGen(),$.extend(_this.settings,options),!!this.settings.whiteSaasCode&&void(jWS.fn._frameCheck()?(document.WhiteSaas=this,document.WhiteCallback=this,document.CallbackKiller=this):(window.top.WhiteSaas=this,window.top.WhiteCallback=this,window.top.CallbackKiller=this))};WhiteSaas.prototype.boot=function(data){this.onLoad(data)},WhiteSaas.prototype.sendCrmLead=function(crmId,data,callback){var _t=this;crmId||console.log("Не указан crmId"),data||console.log("Нет данных для отправки"),data.google_client_id=wsUtil.getGoogleClientId(),data.yandex_client_id=wsUtil.getYandexClientId();var url=_t.settings.serverUrl+"/api?action=createLead&callback=?";$.getJSON(url,{code:_t.settings.whiteSaasCode,visitId:_t.settings.visitId||wsUtil.getCoookie("WhiteCallback_visitorId"),crmId:crmId,data:data},function(result){1==result.Success&&console.log("Лид отправлен в crm (id : "+crmId+")"),callback&&"function"==typeof callback&&callback(result)})},WhiteSaas.prototype.setCustomParams=function(data){if(!data)return void console.log("Не указаны данные для отправки");if("object"!=typeof data||!data.length)return void console.log("Некорректный формат, должен быть передан массив или данные отсутствуют");var _t=this,url=_t.settings.serverUrl+"/api?action=setCustomParams&callback=?";$.getJSON(url,{code:_t.settings.whiteSaasCode,visitId:_t.settings.visitId,visitorId:_t.settings.visitorId,url:window.location.href,data:data},function(result){1==result.Success&&console.log("Параметры обновлены")})},WhiteSaas.prototype.clearServiceCookie=function(cookie){for(var _c=cookie.split("; "),_r=[],i=0;i<_c.length;i++)if("string"==typeof _c[i])if(0===_c[i].search(/WhiteCallback_openedpage/)||0===_c[i].search(/sw_openedpage/));else{var _str=_c[i];_r.push(_str.substring(0,64))}return _r.join("; ")},WhiteSaas.prototype.onLoad=function(result){var _this=this;if(result.Settings){if(!result.Settings.visitorId)return!1;if(_this.settings.visitorId=result.Settings.visitorId,!wsUtil.getCookie("WhiteCallback_visitorId")){var d=new Date;d.setMinutes(d.getMinutes()+30),wsUtil.setCookie("WhiteCallback_visitorId",_this.settings.visitorId,d)}if(result.Settings.visitId){if(_this.settings.visitId=result.Settings.visitId,wsUtil.setCookie("WhiteCallback_visit",result.Settings.visitId),!wsUtil.getCookie("WhiteSaas_uniqueLead")){var d=new Date;d.setMinutes(d.getMinutes()+60),wsUtil.setCookie("WhiteSaas_uniqueLead","no",d)}_this.updateVisit()}}if(result.Success&&result.Data&&result.Settings){_this.settings.device=result.Settings.device,result.Settings.visitorName&&""!==result.Settings.visitorName&&(_this.settings.visitorName=result.Settings.visitorName,_this.settings.hasVisitorName=1),result.Settings.visitorPhone&&""!==result.Settings.visitorPhone&&(_this.settings.visitorPhone=result.Settings.visitorPhone),result.Settings.visitorEmail&&""!==result.Settings.visitorEmail&&(_this.settings.visitorEmail=result.Settings.visitorEmail),result.Settings.staticServerUrl&&""!==result.Settings.staticServerUrl&&(_this.settings.staticServerUrl=result.Settings.staticServerUrl),result.Settings.thisIsCallbackKILLER&&(_this.settings.thisIsCallbackKILLER=!0),result.Settings.serviceName&&(_this.settings.servicename=result.Settings.serviceName),result.Settings.serviceDomain&&(_this.settings.servicedomain=result.Settings.serviceDomain),result.Settings.serviceId&&(_this.settings.serviceid=result.Settings.serviceId),result.Settings.accountId&&(_this.settings.accountid=result.Settings.accountId),result.Settings.siteId&&(_this.settings.siteId=parseInt(result.Settings.siteId)),(result.Settings.phoneBase||""===result.Settings.phoneBase)&&(""===result.Settings.phoneBase?_this.settings.phoneBase="":_this.settings.phoneBase=parseInt(result.Settings.phoneBase)),result.Settings.phoneMasks&&(_this.settings.phoneMasks=result.Settings.phoneMasks),result.Settings.phoneBasesCountries&&(_this.settings.phoneBasesCountries=result.Settings.phoneBasesCountries),result.Settings.windowNoCopyright&&(_this.settings.hideCopyright=!0),result.Settings.geoCity&&(_this.settings.geoCity=result.Settings.geoCity,_this.settings.geoCity.name||(_this.settings.geoCity.name=_this.settings.geoCity.ip_city),_this.settings.geoCity.name_rod=_this.settings.geoCity.name_rod||_this.settings.geoCity.name,_this.settings.geoCity.name_mes=_this.settings.geoCity.name_mes||_this.settings.geoCity.name,_this.settings.geoCity.name_vin=_this.settings.geoCity.name_vin||_this.settings.geoCity.name);var now=new Date;result.Settings.utcTime?_this.settings.utcTime=result.Settings.utcTime:_this.settings.utcTime=parseInt(now.getTime()/1e3),result.Settings.siteCode&&(_this.settings.whiteSaasCode=result.Settings.siteCode),result.Settings.notSendFacebookLead&&(_this.settings.sendFacebookLead=!1),result.Settings.versions&&"object"==typeof result.Settings.versions&&(_this.settings.versions=result.Settings.versions),"function"==typeof window.ws_OnCodeLoad&&window.ws_OnCodeLoad(),wsUtil.initTimeouts(),wsUtil.initIntervals(),_this.initStyles(),_this.updatePageShowCount(),wsUtil.deleteCookie("CallbackKiller_timePage"),_this.pageIdentCheck(),_this.pageIdentAdd(_this.pageIdent),_this.pageIdentGetMainPage()?_this.pageIdentObserve():_this.pageIdentSetMainPage(_this.pageIdent),_this.checkIE(),_this.checkResize(),_this.loadWidgets(result),$(window).on("beforeunload.whiteSaas",_this.clearOpenedPages)}},WhiteSaas.prototype.clearOpenedPages=function(){var main_page=wsUtil.getCookie("WhiteCallback_mainPage");wsUtil.deleteCookie("WhiteCallback_mainPage");var ret=[],str=wsUtil.getC===arr.length||arr.length>20)return void wsUtil.deleteCookie("WhiteCallback_openedPages");for(var key in arr)arr.hasOwnProperty(key)&&arr[key]!==main_page&&ret.push(arr[key]);var d=new Date;d.setFullYear(d.getFullYear()+1),wsUtil.setCookie("WhiteCallback_openedPages",ret.join("."),d)},WhiteSaas.prototype.checkResize=function(){var _this=this;_this.settings.windowRatio=wsUtil.getRatio(),wsUtil.setInterval("envyResize",function(){var ratio=wsUtil.getRatio();_this.settings.windowRatio!==ratio&&(_this.settings.windowRatio=ratio,wsUtil.setTimeout("resizeEvent",function(){WBK.settings.chatWindowOpened||WBK.settings.windowOpened||WBK.settings.windowQuizOpened||WBK.settings.windowGeneratorOpened||WBK.settings.videoWidgetOpened||jWS(window).trigger("envy:resize")},250))},200)},WhiteSaas.prototype.checkIE=function(){wsUtil.isIE()&&jWS("body").addClass("envybox-ie")},WhiteSaas.prototype.prepareSettings=function(data,callback){var hide_widgets=[];data.Data.multi_button&&data.Settings.multiButtonId&&("pc"==data.Settings.device||"pc"!=data.Settings.device&&!data.Data.multi_button.hide_mobile)&&(hide_widgets=wsMultiButton.checkWidgetsToHide(data),$.each(hide_widgets,function(index,value){switch(value.action){case"killer":value.action_value==data.Settings.killerId&&(data.Data.callback.killerSettings.hideBtn=1,data.Data.callback.killerSettings.btnHideOnMobile=1,data.Data.callback.killerSettings.btnHideOnTablet=1);break;case"chat":value.action_value==data.Settings.chatWidgetId&&($.fn._frameCheck()&&"undefined"==typeof WBK&&(WBK=document.WBK),WBK.addStyles(".ws-chat .ws-chat-btn-container{display:none!important;}"));break;case"loaner":value.action_value==data.Settings.loanerId&&(data.Data.loaner.position="hide");break;case"quiz":value.action_value==data.Settings.quizId&&(data.Data.quiz.show_button_on_site=0)}})),callback&&callback(data)},WhiteSaas.prototype.loadWidgets=function(data){var _this=this;_this.prepareSettings(data,function(result){try{result.Data.callback&&result.Settings.killerId&&(wsKiller.init(result),"function"==typeof window.ws_OnKillerLoad&&window.ws_OnKillerLoad())}catch(e){wsUtil.log("KILLER : "+e.stack)}try{result.Data.chat&&result.Settings.chatWidgetId&&(result.Data.chat.v2&&(wsChat=wsChatNew),wsChat.init(result),"function"==typeof window.ws_OnChatLoad&&window.ws_OnChatLoad())}catch(e){wsUtil.log("CHAT : "+e.stack)}try{result.Data.generator&&result.Settings.generatorId&&(wsGenerator.init(result),"function"==typeof window.ws_OnGeneratorLoad&&window.ws_OnGeneratorLoad())}catch(e){wsUtil.log("GENERATOR : "+e.stack)}try{if(result.Data.quiz&&result.Settings.quizId&&result.Data.quiz.showQuiz){if(window.wsQuizzes={},window.wsQuizzes[result.Settings.quizId]=new wsQuiz(jWS),window.wsQuizzes[result.Settings.quizId].init(result.Data.quiz,result.Settings.quizId),result.Data.quizzes){var quizzesElements={btn:{selector:'a[href^="#showquiz-"]',attr:"href"},integrate:{selector:'[id^="integrate-quiz-element-"]',attr:"id"}};for(var element in quizzesElements)$(quizzesElements[element].selector).each(function(){var quizId=$(this).attr(quizzesElements[element].attr).split("-").pop();quizId!==result.Settings.quizId&&result.Data.quizzes.hasOwnProperty(quizId)&&!window.wsQuizzes.hasOwnProperty(quizId)&&(window.wsQuizzes[quizId]=new wsQuiz(jWS),window.wsQuizzes[quizId].init(result.Data.quizzes[quizId],quizId))})}"function"==typeof window.ws_OnQuizLoad&&window.ws_OnQuizLoad()}}catch(e){wsUtil.log("QUIZ : "+e.stack)}try{if(result.Data.instinct&&result.Settings.instinctId){var url=WBK.settings.staticServerUrl+"/build/widget/instinct.min.js?v="+WBK.settings.versions.instinct;wsUtil.getScript(url,function(){wsInstinct.init(result),"function"==typeof window.ws_OnInstinctLoad&&window.ws_OnInstinctLoad()},!0)}}catch(e){wsUtil.log("INSTINCT : "+e.stack)}if("mobile"!==_this.settings.device){try{if(result.Data.invader&&result.Settings.invaderId){var url=WBK.settings.staticServerUrl+"/build/widget/invader.min.js?v="+WBK.settings.versions.invader;wsUtil.getScript(url,function(){wsInvader.init(result),"function"==typeof window.ws_OnInvaderLoad&&window.ws_OnInvaderLoad()},!0)}}catch(e){wsUtil.log("INVADER : "+e.stack)}try{result.Data.loaner&&result.Settings.loanerId&&(wsLoaner.init(result),"function"==typeof window.ws_OnLoanerLoad&&window.ws_OnLoanerLoad())}catch(e){wsUtil.log("LOANER : "+e.stack)}}try{result.Data.multi_button&&result.Settings.multiButtonId&&(wsMultiButton.init(result),"function"==typeof window.ws_OnMultiButtonLoad&&window.ws_OnMultiButtonLoad())}catch(e){wsUtil.log("MULTI_BUTTON : "+e.stack)}try{result.Data.calltracking&&result.Settings.calltrackingId&&wsCallTracking.run(result)}catch(e){wsUtil.log("CALLTRACKING : "+e.stack)}try{if(result.Data.form_customizer&&result.Settings.formCustomizerId){var url=WBK.settings.staticServerUrl+"/build/widget/form_customizer.min.js?v="+WBK.settings.versions.form_customizer;wsUtil.getScript(url,function(){wsFormCustomizer.init(result),"function"==typeof window.ws_OnFormCustomizerLoad&&window.ws_OnFormCustomizerLoad()},!0)}}catch(e){wsUtil.log("FORM_CUSTOMIZER : "+e.stack)}try{if(result.Data.video_widget&&result.Settings.videoWidgetId){var url=WBK.settings.staticServerUrl+"/build/widget/video_widget.min.js?v="+WBK.settings.versions.video_widget;wsUtil.getScript(url,function(){wsVideoWidget.init(result.Data.video_widget,result.Settings.videoWidgetId),"function"==typeof window.ws_OnVideoWidgetLoad&&window.ws_OnVideoWidgetLoad()},!0)}}catch(e){wsUtil.log("VIDEO_WIDGET : "+e.stack)}})},WhiteSaas.prototype.setVisitorData=function(data){if(!data.name&&!data.email&&!data.phone)return!1;var url=WBK.settings.serverUrl+"/api?action=setVisitorData&callback=?";jWS.getJSON(url,{code:WBK.settings.whiteSaasCode,name:data.name?data.name:WBK.settings.visitorName,email:data.email?data.email:WBK.settings.visitorEmail,phone:data.phone?data.phone:WBK.settings.visitorPhone,visitorId:WBK.settings.visitorId},function(result){WBK.settings.visitorName=data.name?data.name:WBK.settings.visitorName,WBK.settings.visitorEmail=data.email?data.email:WBK.settings.visitorEmail,WBK.settings.visitorPhone=data.phone?data.phone:WBK.settings.visitorPhone})},WhiteSaas.prototype.getVisitCount=function(){return parseInt(wsUtil.getStorage("ws_visit_countype.updateVisit=function(){vart_id");oldVisitId!=_this.settings.visitId&&(wsUtil.setStorage("ws_visit_id",_this.settings.visitId),_this.updateVisitCount())},WhiteSaas.prototype.updateVisitCount=function(){var _this=this,oldVisitCount=_this.getVisitCount()til.setStorage("ws_visit_count",visitCount)},WhiteSaas.prototype.getPageShowCount=function(){return parseInt(wsUtil.getStorage("ws_page_show_count"))?pahowCount=function(){var _this=this,oldPageShowCount=_this.getPageShowCount(),pageShowCount=oldPageShowCount?oldPageShowCount+1:1;wsUtil.setStorage("ws_page_show_count",pageShowCount)},WhiteSaas.prototype.initStyles=function(){$("body").append("<style id='whitesaasas.prototype.showInvader=function(){window.wsInvader&&wsInvader.showWidget()},WhiteSaas.prototype.showWidgetGenerator=function(type){window.wsGenerator&&wsGenerator.showWidget(typew.wsChat&&wsChat.showWidget()},WhiteSaas.prototype.showWindow=function(showOnType,noWorkTime){window.wsKiller&&wsKiller.showWindow(showOnType,noWorkTime)},WhiteSaas.prototype.newCall=function(phone,immediately){window.wsKiller&&wsKiller.newCall(phone,immediately)},WhiteSaas.prototype.showInvitationByName=function(invitation_name){window.wsChat&&wsChat.showInvitationByName(invitation_name)},WhiteSaas.prototype.checkFormOnSubmit=function(form){window.wsKiller&&wsKiller.checkFormOnSubmit(form)},WhiteSaas.prototype.callToPhone=function(phone,department,customtext){window.wsKiller&&wsKiller.callToPhone(phone,department,customtext)},WhiteSaas.prototype.setCookie=function(name,value,expires,path,domain,secure){window.wsUtil&&wsUtil.setCookie(name,value,expires,path,domain,secure)},WhiteSaas.prototype.getCoogetCookie(name)},WhiteSaas.prototype.setPhoneInputFocusForm=function(el){var _this=this,caretArrayBegin3=[7,38,47,48,39],caretArrayBegin5=[380,358,992,375,373,972,971];el.focus(),el.val()||(""!==_this.settings.phoneBase?(el.val(_this.settings.phoneBase),caretArrayBegin3.includes(_this.settings.phoneBase)&&wsUtil.setCaretPosition(el,3,3),caretArrayBegin5.includes(_this.settings.phoneBase)&&wsUtil.setCaretPosition(el,5,5),77===_this.settings.phoneBase&&wsUtil.setCaretPosition(el,4,4)):"mobile"!==_this.settings.device&&wsUtil.setCaretPosition(el,2,2))},WhiteSaas.prototype._initSocket=function(callbackDone){var _this=this;if(!_this.settings.socket){var socketioUrl=_this.settings.socketioUrl+"?type=visitor&site_id="+_this.settings.siteId+"&id="+_this.settings.visitorId,socket=new io.connect(socketioUrl),cases={disconnect:function(data){_this.settings.socket=!1},sync:function(data){switch(data.event){case"onVisitorMessage":wsChat.onVisitorMessage(data);break;case"onVisitorMessageRead":wsChat.onVisitorMessageRead()}},connected:function(data){_this.settings.socket=socket,_this.settings.socketConnected?WBK.settings.Chat.socketConnected(data,callbackDone):"undefined"!=typettings.socketConnected=1},onOperatorStatus:function(data){wsChat.onOperatorStatus(data)},onConnectToChat:function(data){wsChat.onConnectToChat(data)},onDisconnectFromChat:function(data){wsChat.onDisconnectFromChat(data)},onCloseCha:function(data){wsChat.onOperatorPrinting(data)},onOperatorMessage:function(data){wsChat.onOperatorMessage(data)},onOperatorUpdateMessage:function(data){wsChat.onOperatorUpdateMessage(data)},onMessageReceived:function(data){},onMessageRead:function(data){wsChat.onMessageRead(data)},onUpdateRegistrationId:function(data){wsChat.onUpdateRegistrationId(data)},onCallStatus:function(data){wsKiller.onCallStatus(data)},onCalltracking:function(data){wsCallTracking.onSocket(data)}};Object.keys(cases).forEach(function(key){socket.on(key,function(data){cases[key].call(_this,data)})})}},WhiteSaas.prototype.initSocket=function(callbackDone){var _this=this;_this.settings.socketScript?_this._initSocket(callbackDone):(_this.settings.socketScript=!0,$.getScript(_this.settings.serverUrl+"/widget/socket.io.js").done(function(script,textStatus){_this._initSocket(callbackDone)}).fail(function(jqxhr,settings,exception){_this.settings.socketScript=!1}))},WhiteSaas.prototype.updateTimeAll=function(){var d=new Date;d.setDate(d.getDate()+1),wsUtil.setCookie("WhiteCallback_timeAll",parseInt(wsUtil.getCookie("WhiteCallback_timeAll"))+1||1,d),wsUtil.setCookie("WhiteCallback_timePage",parseInt(wsUts.prototype.pageIdentCheck=function(){var openPages=wsUtil.getCookie("WhiteCallback_openedPages"),newOpenedPages="",newOpenedPagesArray=[];openPages&&openPages.split(".").forEach(function(ident){wsUtil.getCookie("WhiteCallback_openedpage_"+ident)&&newOpenedPagesArray.indexOf(ident)===-1&&newOpenedPagesArray.push(ident)}),newOpenedPagesArray&&(newOpenedPages=newOpenedPagesArray.join("."));var d=new Date;d.setFullYear(d.getFullYear()+1),wsUtil.setCookie("WhiteCallback_openedPages",newOpenedPages,d)},WhiteSaas.prototype.pageIdentAdd=function(ident){var _this=this,d=new Date;d.setFullYear(d.getFullYear()+1);var cop=wsUtil.getCookie("WhiteCallback_openedPages");cop?cop.indexOf(ident)===-1&&(cop+="."+ident):cop=ident,wsUtil.setCookie("WhiteCallback_openedPages",cop,d),wsUtil.setInterval("incrementPageTime",function(){_this.incrementPageTime.apply(_this,[ident])},1e3)},WhiteSaas.prototype.incrementPageTime=function(ident){var d=new Date,now=parseInt((new Date).getTime()/1e3);d.setMinutes(d.getMinutes()+1),"undefined"==typeof window.whitesaas_no_cookie_page&&"e7367ab9d00ca6b7bf516553717689df"!==WBK.settings.whiteSaasCode&&"fadc320b2259aa102e8fab9155a354e6"!==WBK.settings.whiteSaasCode&&"1f01938b0c94b11ededc95f49294cdf6"!==WBK.settings.whiteSaasCode&&wsUtil.setCookie("WhiteCallback_openedpage_"+ident,now,d)on(ident){var ret=[],str=wsUtil.getCookie("WhiteCallback_openedPages")||"",arr=str.split(".");if(wsUtil.deleteCookie("WhiteCallback_openedpage_"+ident),0==arr.length)return wsUtil.deleteCookie("WhiteCallback_openedPages");for(var key in arr)arr.hasOwnProperty(key)&&arr[key]!==ident&&ret.push(arr[key]);if(ret.length>0){var d=new Date;d.setFullYear(d.getFullYear()+1),wsUtil.setCookie("WhiteCallback_openedPages",ret.join("."),d),this.pageIdentSetUpdateMainPage(ret[0])}else wsUtil.deleteCookie("WhiteCallback_openedPages"),wsUtil.deleteCookie("WhiteCallback_mainPage"),wsUtil.deleteCookie("WhiteCallback_updateMainPage")},WhiteSaas.prototype.pageIdentSetMainPage=function(ident){var _this=this,d=new Date;d.setFullYear(d.getFullYear()+1),wsUtil.setCookie("WhiteCallback_mainPage",ident,d),wsUtil.setInterval("updateTimeAll",function(){_this.updateTimeAll.call(_this)},1e3)},WhiteSaas.prototype.pageIdentObserve=function(){var _this=this;wsUtil.setInterval("paiteCallback_updateMainPage");updateMainPage"));var now=parseInt((new Date).getTime()/1e3),main_page=wsUtil.getCookie("WhiteCallback_mainPage"),main_page_time=wsUtil.getCookie("WhiteCallback_openedpage_"+main_page);main_page_time=parseInt(main_page_time),(main_page_time+3<now||isNaN(main_page_time))&&_this.pageIdentRemove.apply(_this,[main_page])},1e3)},WhiteSaas.prototype.pageIdentSetUpdateMainPage=function(ident){if(ident.length>0){var d=new Date;d.setFullYear(d.getFullYear()+1),wsUtil.setCookie("WhiteCallback_updateMainPage",ident,d)}else wsUtil.deleteCookie("WhiteCallback_updateMainPage")},WhiteSaas.prototype.pageIdentGetMainPage=function(){return wsUtil.getCookie("WhiteCallback_mainPage")},WhiteSaas.prototype.pageIdentGen=function(){for(var gen="",list="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",i=0;i<5;i++)gen+=list.charAt(Math.floor(Math.random()*list.length));return gen},WhiteSaas.prototype.animateOnce=function(element,animation,callback){element.addClass("cbk-animated").addClass(animation),setTimeout(function(){element.removeClass("cbk-animated").removeClass(animation),callback&&$.isFunction(callback)&&callback()},1e3)},WhiteSaas.prototype.animateFastOnce=function(element,animation,callback){element.addClass("cbk-animated").addClass("cbk-animated-fast").addClass(animation),setTimeout(function(){element.removeClass("cbk-animated").removeClass("cbk-animated-fast").removeClass(animation),callback&&$.isFunction(callback)&&callback()},250)},WhiteSaas.prototype.animateElTime=function(element,animation,callback,time){element.addClass("cbk-animated").addClass("cbk-animated-fast").addClass(animation),setTimeout(function(){element.removeClass("cbk-animated").removeClass("cbk-animated-fast").removeClass(animation),callback&&$.isFunction(callback)&&callback()},time)},WhiteSaas.prototype.sendAdvertLinkStat=function(type,adverturl,adverttext,widgetId){var _this=this,url=_this.settings.serverUrl+"/api?action=advertlinkstat&callback=?";jWS.getJSON(url,{code:_this.settings.whiteSaasCode,widget:type,widgetId:widgetId,adverturl:adverturl,adverttext:adverttext,visitId:_this.settings.visitId,visitorId:_this.settings.visitorId},function(result){})},WhiteSaas.prototype.Sound=function(filename){var _this=this;if(!filename)return!1;var audioSupport=!1,audio=document.createElement("audio");if(audioSupport=!!audio.canPlayType,""!=audio.canPlayType("audio/mpeg")&&"no"!=audio.canPlayType("audio/mpeg")?ext=".mp3":"no"!=audio.canPlayType('audio/ogg; codecs="vorbis"')&&""!=audio.canPlayType('audio/ogg; codecs="vorbis"')?ext=".ogg":audioSupport=!1,audioSupport){var path=_this.settings.staticServerUrl+"/widget/audio/"+filename+ext;audio.src=path,audio.load();var promise=audio.play();void 0!==promise&&promise.then(function(_){})["catch"](function(error){})}},WhiteSaas.prototype.checkPhone=function(phone,noSubStr){var result=!1;return phone&&(phone=phone.toString(),phone=phone.replace(/\D/g,""),12===phone.length&&"3"===phone.charAt(0)&&"8"===phone.charAt(1)?(0!==phone.indexOf("380",0)&&(phone=!1),result=$(".cbk-phone-checker:first").val(phone).blur().val(),result&&""!==result||(result=!1)):11===phone.length&&"3"===phone.charAt(0)&&"8"===phone.charAt(1)&&"0"===phone.charAt(2)?result=!1:10===phone.length&&"0"===phone.charAt(0)?(10===phone.length&&(phone="38"+phone),result=$(".cbk-phone-checker:first").val(phone).blur().val(),result&&""!==result||(result=!1)):phone.length>=12&&"8"===phone.charAt(0)&&"6"===phone.charAt(1)?(result=$(".cbk-phone-checker:first").val(phone).blur().val(),result&&""!==result||(result=!1)):11===phone.length&&"3"===phone.charAt(0)&&"8"===phone.charAt(1)&&"6"===phone.charAt(2)?(result=$(".cbk-phone-checker:first").val(phone).blur().val(),result&&""!==result||(result=!1)):12===phone.length&&"4"===phone.charAt(0)&&"4"===phone.charAt(1)?(result=$(".cbk-phone-checker:first").val(phone).blur().val(),result&&""!==result||(result=!1)):10!==phone.length&&11!==phone.length||"6"!==phone.charAt(0)||"6"!==phone.charAt(1)?"3"===phone.charAt(0)&&"5"===phone.charAt(1)&&"8"===phone.charAt(2)?(result=$(".cbk-phone-checker:first").val(phone).blur().val(),result&&""!==result||(result=!1)):12===phone.length&&"3"===phone.charAt(0)&&"7"===phone.charAt(1)&&"5"===phone.charAt(2)?(result=$(".cbk-phone-checker:first").val(phone).blur().val(),result&&""!==result||(result=!1)):10!==phone.length&&14!==phone.length||"4"!==phone.charAt(0)||"7"!==phone.charAt(1)?12===phone.length&&"9"===phone.charAt(0)&&"9"===phone.charAt(1)&&"2"===phone.charAt(2)?(result=$(".cbk-phone-checker:first").val(phone).blur().val(),result&&""!==result||(result=!1)):12===phone.length&&"9"===phone.charAt(0)&&"9"===phone.charAt(1)&&"6"===phone.charAt(2)?(result=$(".cbk-phone-checker:first").val(phone).blur().val(),result&&""!==result||(result=!1)):12===phone.length&&"9"===phone.charAt(0)&&"9"===phone.charAt(1)&&"8"===phone.charAt(2)?(result=$(".cbk-phone-checker:first").val(phone).blur().val(),result&&""!==result||(result=!1)):"3"===phone.charAt(0)&&"5"===phone.charAt(1)&&"9"===phone.charAt(2)?(result=$(".cbk-phone-checker:first").val(phone).blur().val(),result&&""!==result||(result=!1)):11===phone.length&&"3"===phone.charAt(0)&&"7"===phone.charAt(1)&&"3"===phone.charAt(2)?(result=$(".cbk-phone-checker:first").val(phone).blur().val(),result&&""!==result||(result=!1)):"1"===phone.charAt(0)&&11===phone.length?(result=$(".cbk-phone-checker:first").val(phone).blur().val(),result&&""!==result||(result=!1)):"6"===phone.charAt(0)&&"2"===phone.charAt(1)&&phone.length>=10?(result=$(".cbk-phone-checker:first").val(phone).blur().val(),result&&""!==result||(result=!1)):"3"===phone.charAt(0)&&"9"===phone.charAt(1)&&phone.length>=11?(result=$(".cbk-phone-checker:first").val(phone).blur().val(),result&&""!==result||(result=!1)):"4"===phone.charAt(0)&&"2"===phone.charAt(1)&&"0"===phone.charAt(2)&&12===phone.length?(result=$(".cbk-phone-checker:first").val(phone).blur().val(),result&&""!==result||(result=!1)):"9"===phone.charAt(0)&&"0"===phone.charAt(1)&&12===phone.length?(result=$(".cbk-phone-checker:first").val(phone).blur().val(),result&&""!==result||(result=!1)):"4"===phone.charAt(0)&&"0"===phone.charAt(1)&&11===phone.length?(result=$(".cbk-phone-checker:first").val(phone).blur().val(),result&&""!==result||(result=!1)):"9"===phone.charAt(0)&&"7"===phone.charAt(1)&&"2"===phone.charAt(2)&&phone.length>=11?(result=$(".cbk-phone-checker:first").val(phone).blur().val(),result&&""!==result||(result=!1)):"9"===phone.charAt(0)&&"7"===phone.charAt(1)&&"1"===phone.charAt(2)&&phone.length>=11?(result=$(".cbk-phone-checker:first").val(phone).blur().val(),result&&""!==result||(result=!1)):10===phone.length&&"0"!==phone.charAt(0)&&"380"!==phone.substring(0,3)&&"7"!==phone.charAt(0)||11===phone.length&&"380"!==phone.substring(0,3)?(10===phone.length&&(phone="7"+phone),11===phone.length&&"8"===phone.charAt(0)&&(phone=phone.substring(0,0)+"7"+phone.substring(1)),result=$(".cbk-phone-checker:first").val(phone).blur().val(),result&&""!==result||(result=!1)):!(phone.length>=11&&"0"!==phone.charAt(0))||"8"!==phone.charAt(0)&&"7"!==phone.charAt(0)||"3"!==phone.charAt(1)&&"4"!==phone.charAt(1)&&"8"!==phone.charAt(1)&&"9"!==phone.charAt(1)&&"7"!==phone.charAt(1)||("8"!==phone.charAt(0)||noSubStr||(phone="7"+phone.substring(1)),phone=!noSubStr&&phone.substring(0,11),result=$(".cbk-phone-checker:first").val(phone).blur().val(),result&&""!==result||(result=!1)):(result=$(".cbk-phone-checker:first").val(phone).blur().val(),result&&""!==result||(result=!1)):(result=$(".cbk-phone-checker:first").val(phone).blur().val(),result&&""!==result||(result=!1))),result},WhiteSaas.prototype.setVisitorInfoIfNot=function(data){data.name&&!WBK.settings.visitorName&&(WBK.settings.visitorName=data.name),
data.phone&&!WBK.settings.visitorPhone&&(WBK.settings.visitorPhone=data.phone),data.email&&!WBK.settings.visitorEmail&&(WBK.settings.visitorEmail=data.email)},WhiteSaas.prototype.checkWidgetOpened=function(widget){var _this=this,result=!0;switch(widget){case"instinct":(_this.settings.windowGeneratorOpened||_this.settings.windowOpened||_this.settings.chatWindowOpened||_this.settings.windowQuizOpened||_this.settings.videoWidgetOpened)&&(result=!1);break;case"video_widget":(_this.settings.windowGeneratorOpened||_this.settings.windowOpened||_this.settings.chatWindowOpened||_this.settings.windowQuizOpened)&&(result=!1)}return result},WhiteSaas.prototype.checkDebug=function(){var result=!1;return 1==wsUtil.getStorage("ws_debug")&&(result=!0),result},WhiteSaas.prototype.formatText=function(text){return text?(text=this.replaceTagVariant(text),text=this.replaceGetParamText(text),text=this.replaceTimeVariant(text)):""},WhiteSaas.prototype.replaceGetParamText=function(text){if(!text)return"";for(var regexp=/\[get:([-\w]+)\]/;_res=regexp.exec(text);){var ptext},WhiteSaas.prototype.replaceTagVariant=function(text){if(!text)return"";for(var regexp=/\[\#([-\w]+)\]/;_result=regexp.exec(text);){var regx=new RegExp("\\[\\#"+_result[1]+"\\]","gi");text=text.replace(regx,$("#"+_result[1]).text())}return text},WhiteSaas.prototype.replaceTimeVariant=function(text){if(!text)return"";for(var regexp=/\[time(\+|\-)?(\d+)?(\|)?(\d+)?\]/;_res=regexp.exec(text);){var _add=!0,d=new Date;"undefined"!=typeof _res[1]&&(_add="-"!=_res[1]),"undefined"!=typeof _res[2]&&d.setMinutes(_add?d.getMinutes()+parseInt(_res[2]):d.getMinutes()-parseInt(_res[2])),text=text.replace(_res[0],(d.getHours()<10?"0":"")+d.getHours()+":"+(d.getMinutes()<10?"0":"")+d.getMinutes())}return text},WhiteSaas.prototype.urlParam=function(name){var results=new RegExp("[?&]"+name+"=([^&#]*)").exec(window.location.href);return null==results?null:results[1]||0},WhiteSaas.prototype.loadFont=function(){if(!this.fontLoaded){this.fontLoaded=!0;var versionFont=11;WBK.addStyles("@font-face{font-family: 'whitesaas';src: url('"+WBK.settings.staticServerUrl+"/widget/fonts/whitesaas.eot?"+versionFont+"');src: url('"+WBK.settings.staticServerUrl+"/widget/fonts/whitesaas.eot?"+versionFont+"#iefix') format('embedded-opentype'),url('"+WBK.settings.staticServerUrl+"/widget/fonts/whitesaas.woff2?"+versionFont+"') format('woff2'),url('"+WBK.settings.staticServerUrl+"/widget/fonts/whitesaas.woff?"+versionFont+"') format('woff'),url('"+WBK.settings.staticServerUrl+"/widget/fonts/whitesaas.ttf?"+versionFont+"') format('truetype'),url('"+WBK.settings.staticServerUrl+"/widget/fonts/whitesaas.svg?"+versionFont+"#font3435') format('svg');font-weight: normal;font-style: normal;}"),WBK.addStyles("@font-face{font-family: 'CBKRobotoLight';src: url('"+WBK.settings.staticServerUrl+"/widget/fonts/roboto/RobotoLight.eot');src: url('"+WBK.settings.staticServerUrl+"/widget/fonts/roboto/RobotoLight.eot?#iefix') format('embedded-opentype'), url('"+WBK.settings.staticServerUrl+"/widget/fonts/roboto/RobotoLight.woff') format('woff'), url('"+WBK.settings.staticServerUrl+"/widget/fonts/roboto/RobotoLight.ttf') format('truetype');font-style: normal;font-weight: normal;}"),WBK.addStyles("@font-face{font-family: 'CBKRobotoRegular';src: url('"+WBK.settings.staticServerUrl+"/widget/fonts/roboto/CBKRobotoRegular.eot');src: url('"+WBK.settings.staticServerUrl+"/widget/fonts/roboto/CBKRobotoRegular.eot?#iefix') format('embedded-opentype'), url('"+WBK.settings.staticServerUrl+"/widget/fonts/roboto/CBKRobotoRegular.woff') format('woff'), url('"+WBK.settings.staticServerUrl+"/widget/fonts/roboto/CBKRobotoRegular.ttf') format('truetype');font-style: normal;font-weight: normal;}"),WBK.addStyles("@font-face{font-family: 'CBKRobotoThin';src: url('"+WBK.settings.staticServerUrl+"/widget/fonts/roboto/RobotoThin.eot');src: url('"+WBK.settings.staticServerUrl+"/widget/fonts/roboto/RobotoThin.eot?#iefix')format('embedded-opentype'), url('"+WBK.settings.staticServerUrl+"/widget/fonts/roboto/RobotoThin.woff') format('woff'), url('"+WBK.settings.staticServerUrl+"/widget/fonts/roboto/RobotoThin.ttf') format('truetype');font-style: normal;font-weight: normal;}"),WBK.addStyles("@font-face{font-family: 'CBKOpenSans';src: url('"+WBK.settings.staticServerUrl+"/widget/fonts/open-sans/OpenSans-Regular.eot');src: local('Open Sans Regular'), local('OpenSans-Regular'), url('"+WBK.settings.staticServerUrl+"/widget/fonts/open-sans/OpenSans-Regular.eot?#iefix') format('embedded-opentype'), url('"+WBK.settings.staticServerUrl+"/widget/fonts/open-sans/OpenSans-Regular.woff2') format('woff2'), url('"+WBK.settings.staticServerUrl+"/widget/fonts/open-sans/OpenSans-Regular.woff') format('woff'), url('"+WBK.settings.staticServerUrl+"/widget/fonts/open-sans/OpenSans-Regular.ttf') format('truetype'), url('"+WBK.settings.staticServerUrl+"/widget/fonts/open-sans/OpenSans-Regular.svg#OpenSans') format('svg');font-style: normal;font-weight: 400;}"),WBK.addStyles("@font-face{font-family: 'Museo';src: url('"+WBK.settings.staticServerUrl+"/widget/fonts/museo/MuseoSansCyrl_500.otf?') format('opentype');}@font-face{font-family: 'Museo'; font-style: normal; font-weight: 900;src: url('"+WBK.settings.staticServerUrl+"/widget/fonts/museo/MuseoSansCyrl_900.otf?') format('opentype');}@font-face{font-family: 'Times New Roman'; font-style: normal; font-weight: normal;src: url('"+WBK.settings.staticServerUrl+"/widget/fonts/times-new-roman/TimesNewRoman.ttf?') format('opentype');font-style: normal; font-weight: 500;}")}},WhiteSaas.prototype.setDefaultSettings=function(){this.settings={thisIsCallbackKILLER:!1,servicename:"WhiteSaaS",servicedomain:"whitesaas.com",serviceid:0,accountid:0,partnerLink:"https://whitesaas.com?utm_source=widget&utm_medium=self&utm_campaign="+location.hostname+"&utm_content=&utm_term=",whiteSaasCode:0,utcTime:!1,visitorId:!1,visitId:!1,siteId:0,visitorName:!1,visitorPhone:!1,visitorEmail:!1,hasVisitorName:0,phoneBase:7,phoneMasks:!1,phoneBasesCountries:!1,device:"pc",phoneMask:"+_(___)___-__-__",language:"ru",months:{0:"января",1:"февраля",2:"марта",3:"апреля",4:"мая",5:"июня",6:"июля",7:"августа",8:"сентября",9:"октября",10:"ноября",11:"декабря"},domain:document.domain,serverUrl:"https://whitesaas.com",staticServerUrl:"https://content.saas-support.com",socketioUrl:"https://chat.callbackkiller.com/cbk",socketConnected:0,windowOpened:!1,windowGeneratorOpened:!1,windowInvaderOpened:!1,windowLoanerOpened:!1,callbackEnabled:!1,generatorEnabled:!1,chatEnabled:!1,chatBtnOpened:!1,chatWindowOpened:!1,chatInvitationOpened:!1,multiButtonVariantsOpened:!1,chatInvitationShown:!1,hideCopyright:!1,invaderStatId:!1,invaderCallbackStatId:!1,invaderGeneratorStatId:!1,instinctStatId:!1,instinctCallbackStatId:!1,instinctGeneratorStatId:!1,generatorStatId:!1,genLeadId:!1,multiButtonEnabled:!1,multiButtonOpened:!1,called:!1,fontLoaded:!1,sendFacebookLead:!0,geoCity:!1,quizIframeEventsLoaded:!1,quizStatId:!1,quizIntegrated:!1,windowRatio:1,versions:{instinct:"0.0.1"},videoWidgetIframeEventsLoaded:!1,videoWidgetOpened:!1}},WhiteSaas.prototype.numberMask=function(value){value=String(value);var res={number:value,mask:""};return value?(res.number=value.replace(/[^\d]/g,""),0==res.number.length||res.number.length<5?rnumber.length?(res.mask="__-__-__",res):7==res.number.length?(res.mask="___-__-__",res):8==res.number.length?(res.mask="___-__-___",res):9==res.number.length?(res.mask="___-___-___",res):10==res.number.length?(0==res.number[0]?(res.number="38"+res.number,res.mask="+__(___)___-__-__"):"372"===res.number.substring(0,3)?res.mask="+___-___-__-__":[3,4,8,9,7].indexOf(parseInt(res.number[0]))!=-1?(res.number="7"+res.number,res.mask="+_(___)___-__-__"):res.mask="(___)___-__-__",res):11==res.number.length?(8==res.number[0]&&(res.number=res.number.replace(res.number.charAt(0),7)),res.mask="+_(___)___-__-__",res):12==res.number.length?(375==res.number.substr(0,3)?res.mask="+___(__)___-__-__":res.mask="+__(___)___-__-__",res):res.number.length>12?(res.mask="(___)___-__-__",res):res):res},WhiteSaas.prototype.initOnlyDigitsEvent=function(selector){$(selector).off("input").on("input",function(e){this.value=this.value.replace(/[^\d]/g,"")})},WhiteSaas.prototype.formatToPhone=function(value){var input=value.replace(/[^+\d]/g,"");if(!input)return input;var first=input.substring(0,1),havePlus=!1;"+"===first&&(havePlus=!0,input=input.replace(/[+]/g,""));var inputLength=input.length;first=input.substring(0,1);var startIndex=0,checkRU=!1;[7,8].includes(+first)&&(startIndex++,checkRU=!0);var subMiddle,zip=input.substring(startIndex,startIndex+3),middle=input.substring(startIndex+3,startIndex+6),lastIndex=startIndex+6;inputLength>6&&(subMiddle=input.substring(lastIndex,startIndex+8),lastIndex+=2);var last=input.substring(lastIndex,startIndex+inputLength),checkLength=checkRU?11:10;return inputLength>checkLength||8===+first&&havePlus?value=input:inputLength>6?value=checkRU?8===+first?first+" ("+zip+") "+middle+(subMiddle?"-"+subMiddle:"")+(last?"-"+last:""):7===+first?first+" "+zip+" "+middle+(subMiddle?"-"+subMiddle:"")+(last?"-"+last:""):first+zip+" "+middle+(last?"-"+last:""):zip+" "+middle+" "+subMiddle+(last?"-"+last:""):inputLength>3?value=checkRU?8===+first?first+" ("+zip+") "+middle:first+" "+zip+" "+middle:zip+" "+middle:inputLength>=0&&(value=checkRU?first+zip:zip),value=value.trim(),havePlus&&(value="+"+value),value},WhiteSaas.prototype.initPhoneFormat=function(selector){var isNumericInput=function(e){var key=e.keyCode;return key>=48&&key<=57||key>=96&&key<=105},isModifierKey=function(e){var key=e.keyCode;return e.shiftKey===!0||35===key||36===key||8===key||9===key||13===key||46===key||107===key||key>36&&key<41||(e.ctrlKey===!0||e.metaKey===!0)&&(65===key||67===key||86===key||88===key||90===key)},formatToPhone=function(e){if(!isModifierKey(e)||8===e.keyCode||46===e.keyCode){var target=e.target;target.value=WBK.formatToPhone(target.value)}},checkDeleteEvent=function(event){var deletedBtn=8===event.keyCode||46===event.keyCode;if(!isModifierKey(event)||8===event.keyCode||46===event.keyCode){var target=event.target,input=event.target.value.replace(/\D/g,"");if(deletedBtn&&target.value.length){var keyUpInputLength=$(event.target).data("input-length"),lastSymbol=target.value.substring(target.value.length-1,target.value.length);if(["(",")"].includes(lastSymbol)&&keyUpInputLength===input.length){var replaceSymbols=input.substring(input.length-1,input.length);target.value=input.replace(replaceSymbols,""),target.value=target.value.trim()}}}};$(selector).off("keydown").on("keydown",function(e){isNumericInput(e)||isModifierKey(e)||e.preventDefault(),checkDeleteEvent(e),$(e.target).data("input-length",e.target.value.replace(/\D/g,"").length)}),$(selector).off("keyup").on("keyup",checkDeleteEvent),$(selector).off("input").on("input",function(e){this.value=this.value.replace(/[^+\d]/g,""),formatToPhone(e)})}}(jWS),wsGenerator=function($){var _this,s,t,w,_debug;return{settings:{},templates:{},widget:{},init:function(data){_this=this,s=this.settings,t=this.templates,w=this.widget,_debug=WBK.checkDebug(),$.fn._frameCheck()&&"undefined"==typeof WBK&&(WBK=document.WBK),_this.loader(data)},loader:function(res){var data=res.Data.generator;if("tablet"===WBK.settings.device&&parseInt(data.hide_tablet))return void(_debug&&_this.log("Виджет скрыт на планшетах"));if("mobile"===WBK.settings.device&&parseInt(data.hide_generator_mobile))return void(_debug&&_this.log("Виджет скрыт на телефонах"));if(_this.setDefaultSettings(),WBK.settings.generatorId=res.Settings.generatorId,s.langText=data.lang_text,void 0!=data.text_general&&(s.langText.text_general=wsUtil.decorateText(data.text_general)),void 0!=data.text_sub&&(s.langText.text_sub=wsUtil.decorateText(data.text_sub)),void 0!=data.text_success&&(s.langText.text_success=wsUtil.decorateText(data.text_success),s.successTextWithTags=data.text_success),void 0!=data.text_counter_title&&(s.langText.text_counter_title=wsUtil.decorateText(data.text_counter_title)),void 0!=data.btn_success_text&&(s.langText.btn_success_text=data.btn_success_text),void 0!=data.btn_cancel_text&&(s.langText.btn_cancel_text=data.btn_cancel_text),void 0!=data.email_agreement_text&&(s.langText.email_agreement_text=data.email_agreement_text),data.show_close_button&&(s.show_close_button=data.show_close_button),data.text_general_color_background&&(s.textGeneralColorBackground=data.text_general_color_background),data.right_block_color&&(s.colorBackgroundRight=data.right_block_color),data.text_general_color_text&&(s.textGeneralColorText=data.text_general_color_text),data.btn_success_color&&(s.btnSuccessColor=data.btn_success_color),data.btn_cancel_color&&(s.btnCancelColor=data.btn_cancel_color),data.counter_time&&(s.counterTime=data.counter_time),data.date_end&&(s.dateEnd=data.date_end),data.date_end_time&&(s.dateEndTime=data.date_end_time),data.date_end_weekday&&(s.dateEndWeekday=parseInt(data.date_end_weekday)),data.date_hours&&(s.dateHours=data.date_hours),data.each_day_to_time&&(s.each_day_to_time=data.each_day_to_time),data.date_hours_type&&(s.dateHoursType=data.date_hours_type),data.get_email&&(s.getEmail=data.get_email),data.get_name&&(s.getName=data.get_name),data.get_phone&&(s.getPhone=data.get_phone),data.img_background&&(s.imgBackground=parseInt(data.img_background)),data.img_background_service&&(s.imgBackgroundService=parseInt(data.img_background_service)),data.logo_file_extension&&(s.logo_file_extension=data.logo_file_extension),data.logo_file_extension_mobile&&(s.logo_file_extension_mobile=data.logo_file_extension_mobile),data.paused_seconds&&(s.pausedSeconds=data.paused_seconds),data.repeat_show_time&&(s.repeatShowTime=data.repeat_show_time),data.repeat_show_type&&(s.repeatShowType=data.repeat_show_type),data.show_enter&&(s.showEnter=data.show_enter),data.paused_sec_target&&(s.paused_sec_target=data.paused_sec_target),data.show_scroll_value&&(s.showScrollValue=parseInt(data.show_scroll_value)),data.show_behavioral_value&&(s.showBehavioralValue=parseInt(data.show_behavioral_value)),data.send_action&&(s.sendAction=data.send_action),data.page_open_type&&(s.pageOpenType=data.page_open_type),data.send_action_url&&(s.sendActionUrl=data.send_action_url),"none"!=data.send_action&&"new_page"==data.page_open_type&&data.send_action_url){var match=wsUtil.parseURL(data.send_action_url);match.scheme||(data.send_action_url="http://"+data.send_action_url),s.actionUrlLinkHrefText='href="'+data.send_action_url+'" target = "_blank"'}data.show_exit&&(s.showExit=data.show_exit),data.timer_enable&&(s.timerEnable=parseInt(data.timer_enable)),data.auto_call&&(s.autoCall=parseInt(data.auto_call)),data.auto_call_text&&(s.autoCallText=data.auto_call_text),data.auto_call_deffered&&(s.autoCallDeffered=parseInt(data.auto_call_deffered)),data.auto_call_deffered_delay&&(s.autoCallDefferedDelay=parseInt(data.auto_call_deffered_delay)),data.ispayed&&(s.isPayed=data.ispayed),data.hasMoneyForLead&&(s.hasMoneyForLead=data.hasMoneyForLead),data.isPayedGenerator&&(s.isPayedGenerator=data.isPayedGenerator),data.close_click_bgr&&(s.closeClickBgr=parseInt(data.close_click_bgr)),data.counter_bgr_color&&(s.counterBgrColor=data.counter_bgr_color),data.counter_number_color&&(s.counterNumberColor=data.counter_number_color),data.container_shadow&&(s.containerShadow=data.container_shadow),res.Settings.serviceDomain&&(s.partnerLink="http://"+WBK.settings.servicedomain+"?utm_source=widget&utm_medium=self&utm_campaign="+location.hostname+"&utm_content=generator&utm_term="),data.partnerLink&&(s.partnerLink=data.partnerLink),data.format_general_text&&(s.textGeneralFormat=data.format_general_text),data.position_gorizontal_general_text&&(s.textGeneralPositionGorizontal=data.position_gorizontal_general_text),data.position_vertical_general_text&&(s.textGeneralPositionVertical=data.position_vertical_general_text),data.font_family_general_text&&(s.textGeneralFontFamily=data.font_family_general_text),data.font_size_general_text&&(s.textGeneralFontSize=parseInt(data.font_size_general_text)),data.email_service&&(s.emailService=data.email_service),data.email_agreement&&(s.emailAgreement=parseInt(data.email_agreement)),data.agreementLink&&(s.agreementLink=data.agreementLink),data.no_show_timeout&&(s.noShowTimeout=parseInt(data.no_show_timeout)),data.hide_background_site&&(s.hideBackgroundSite=parseInt(data.hide_background_site)),data.site_bgr_color&&(s.siteBgrColor=data.site_bgr_color),data.video_repeat&&(s.repeat_video=parseInt(data.video_repeat)),data.video_voice&&(s.voice_video=parseInt(data.video_voice)),data.video_code&&(s.code_video=data.video_code),data.video_position&&(s.video_position=data.video_position),data.text_line_height&&(s.textLineHeight=data.text_line_height),void 0!=data.position_gorizontal_general_text_mobile&&(s.textGeneralPositionGorizontalMobile=data.position_gorizontal_general_text_mobile),void 0!=data.position_vertical_general_text_mobile&&(s.textGeneralPositionVerticalMobile=data.position_vertical_general_text_mobile),void 0!=data.format_general_text_mobile&&(s.formatTextMobile=data.format_general_text_mobile),void 0!=data.text_general_color_background_mobile&&(s.textGeneralColorBackgroundMobile=data.text_general_color_background_mobile),void 0!=data.text_general_color_text_mobile&&(s.textGeneralColorTextMobile=data.text_general_color_text_mobile),void 0!=data.text_sub_color_text_mobile&&(s.textSubColorTextMobile=data.text_sub_color_text_mobile),void 0!=data.generator_next_block_content_bg&&(s.generatorNextBlockContentBg=data.generator_next_block_content_bg),void 0!=data.generator_cross_content_color&&(s.generatorCrossContentColor=data.generator_cross_content_color),void 0!=data.timer_enable_mobile&&(s.timerEnableMobile=parseInt(data.timer_enable_mobile)),void 0!=data.counter_bgr_color_mobile&&(s.counterBgrColorMobile=data.counter_bgr_color_mobile),void 0!=data.counter_number_color_mobile&&(s.counterNumberColorMobile=data.counter_number_color_mobile),void 0!=data.counter_time_mobile&&(s.counterTimeMobile=data.counter_time_mobile),void 0!=data.date_hours_mobile&&(s.dateHoursMobile=data.date_hours_mobile),void 0!=data.date_hours_type_mobile&&(s.dateHoursTypeMobile=data.date_hours_type_mobile),void 0!=data.date_end_weekday_mobile&&(s.dateEndWeekdayMobile=data.date_end_weekday_mobile),void 0!=data.each_day_to_time_mobile&&(s.eachDayToTimeMobile=data.each_day_to_time_mobile),void 0!=data.each_day_to_time_mobile&&(s.eachDayToTimeMobile=data.each_day_to_time_mobile),void 0!=data.no_show_timeout_mobile&&(s.noShowTimeoutMobile=parseInt(data.no_show_timeout_mobile)),void 0!=data.btn_success_color_mobile&&(s.btnSuccessColorMobile=data.btn_success_color_mobile),void 0!=data.email_agreement_mobile&&(s.emailAgreementMobile=data.email_agreement_mobile),void 0!=data.email_agreement_text_mobile&&(s.langText.emailAgreementTextMobile=data.email_agreement_text_mobile),void 0!=data.text_general_mobile&&(s.langText.textGeneralMobile=wsUtil.decorateText(data.text_general_mobile)),void 0!=data.text_sub_mobile&&(s.langText.textSubMobile=wsUtil.decorateText(data.text_sub_mobile)),void 0!=data.text_success_mobile&&(s.langText.textSuccessMobile=wsUtil.decorateText(data.text_success_mobile),s.text_success_mobile=data.text_success_mobile),void 0!=data.text_counter_title_mobile&&(s.langText.textCounterTitleMobile=wsUtil.decorateText(data.text_counter_title_mobile)),void 0!=data.img_background_mobile&&(s.imgBackgroundMobile=parseInt(data.img_background_mobile)),void 0!=data.img_background_service_mobile&&(s.imgBackgroundServiceMobile=data.img_background_service_mobile),void 0!=data.btn_success_text_mobile&&(s.langText.btnSuccessTextMobile=data.btn_success_text_mobile),void 0!=data.date_end_mobile&&(s.dateEndMobile=data.date_end_mobile),void 0!=data.date_end_time_mobile&&(s.dateEndTimeMobile=data.date_end_time_mobile),data.get_mobile_email&&(s.getMobileEmail=data.get_mobile_email),data.get_mobile_phone&&(s.getMobilePhone=data.get_mobile_phone),data.get_mobile_name&&(s.getMobileName=data.get_mobile_name),data.use_telephone_mask&&(s.useTelephoneMask=+data.use_telephone_mask),data.use_telephone_mask_mobile&&(s.useTelephoneMaskMobile=+data.use_telephone_mask_mobile),data.font_family_general_text_mobile&&(s.textGeneralFontFamilyMobile=data.font_family_general_text_mobile),data.font_size_general_text_mobile&&(s.textGeneralFontSizeMobile=parseInt(data.font_size_general_text_mobile)),data.text_line_height_mobile&&(s.textLineHeightMobile=data.text_line_height_mobile),s.calculateHeight=!0,_this.setTemplate(),_this.start()},start:function(){var _this=this;if(w.window=$(t.window).hide().appendTo("body"),w.windowbgr=$(t.windowBgr).hide().click(function(e){return s.closeClickBgr&&_this.closeWidget(),e.preventDefault(),!1}).appendTo("body"),2==s.hideBackgroundSite&&w.windowbgr.addClass("cbk-window-bgr-transparent"),$(".white-saas-generator-copyright-url, .white-saas-mobile-generator-copyright-url").attr("href",s.partnerLink),WBK.settings.visitorPhone&&$(".white-saas-generator-userphone, .white-saas-mobile-generator-userphone").val(WBK.settings.visitorPhone),WBK.settings.visitorEmail&&$(".white-saas-generator-useremail, .white-saas-generator-useremail").val(WBK.settings.visitorEmail),WBK.settings.visitorName&&$(".white-saas-generator-username").val(WBK.settings.visitorName),WBK.settings.hideCopyright?$(".white-saas-generator-copyright-url, .white-saas-mobile-generator-copyright").remove():$("body").on("click",".white-saas-generator-copyright-url, .white-saas-mobile-generator-copyright-url",function(e){WBK.sendAdvertLinkStat($(this).data("widget"),$(this).attr("href"),$(this).text(),WBK.settings.generatorId)}),s.langText.text_general||w.window.find(".white-saas-generator-text-general-span").hide(),s.langText.textGeneralMobile||w.window.find(".white-saas-mobile-generator-image-container").hide(),w.window.find(".white-saas-generator-text-general-span").html(s.langText.text_general),w.window.find(".white-saas-mobile-generator-text-general-span").html(s.langText.textGeneralMobile),parseInt(s.timerEnable)||w.window.find(".white-saas-generator-text-sub").css("max-height","185px"),w.window.find(".white-saas-generator-text-sub").html(s.langText.text_sub),s.emailAgreement||w.window.find(".white-saas-generator-label-agreement").hide(),w.window.find(".white-saas-generator-agreement-link").attr("href",s.agreementLink),s.imgBackgroundService){var d=new Date;w.window.find(".white-saas-generator-image").attr("src",WBK.settings.staticServerUrl+"/uploaded/callback_generators/"+WBK.settings.serviceid+"/logo.png?"+d.getTime())}if(s.isPayed){if(s.code_video&&(w.window.find(".white-saas-generator-container").addClass("generator-video"),_this.playerLoad()),w.window.find(".white-saas-generator-btn-success").text(s.langText.btn_success_text),w.window.find(".white-saas-generator-btn-cancel").text(s.langText.btn_cancel_text),s.siteBgrColor&&w.windowbgr.css("background-color",s.siteBgrColor),s.imgBackground){var d=new Date;w.window.find(".white-saas-generator-image").attr("src",WBK.settings.staticServerUrl+"/uploaded/generators/"+WBK.settings.generatorId+"/logo.png"+s.logo_file_extension+"?"+d.getTime())}if(s.imgBackgroundMobile){var d=new Date;w.window.find(".white-saas-mobile-generator-image").attr("src",WBK.settings.staticServerUrl+"/uploaded/generators/"+WBK.settings.generatorId+"/logo_mobile.png"+s.logo_file_extension_mobile+"?"+d.getTime())}if(s.textGeneralColorBackground&&w.window.find(".white-saas-generator-text-general-span").css("background-color",s.textGeneralColorBackground),s.colorBackgroundRight&&w.window.find(".white-saas-generator-right-block").css("background-color",s.colorBackgroundRight),s.textGeneralColorText&&w.window.find(".white-saas-generator-text-general-span").css("color",s.textGeneralColorText),s.btnSuccessColor&&(w.window.find(".white-saas-generator-btn-success").css("background-color",s.btnSuccessColor),w.window.find(".white-saas-generator-btn-yes").css("background-color",s.btnSuccessColor)),s.btnCancelColor&&w.window.find(".white-saas-generator-btn-cancel").css("background-color",s.btnCancelColor),s.counterBgrColor&&w.window.find(".white-saas-generator-counter-block, .white-saas-generator-counter-dz-block").css("background-color",s.counterBgrColor),s.counterNumberColor&&w.window.find(".white-saas-generator-counter-number").css("color",s.counterNumberColor),s.containerShadow)switch(s.containerShadow){case"none":w.window.css("box-shadow","none");break;case"easy":w.window.css("box-shadow","0 21px 32px 0 rgba(0, 0, 0, 0.15)");break;case"heavy":w.window.css("box-shadow","0 21px 32px 0 rgba(0, 0, 0, 0.45)")}s.textGeneralFormat&&w.window.find(".white-saas-generator-text-general").css("text-align",s.textGeneralFormat),s.textGeneralPositionGorizontal&&w.window.find(".white-saas-generator-text-general").css("left",s.textGeneralPositionGorizontal+"px"),s.textGeneralPositionVertical&&w.window.find(".white-saas-generator-text-general").css("top",s.textGeneralPositionVertical+"px"),s.textGeneralFontFamily&&WBK.addStyles(".white-saas-generator-text-general-span {font-family: "+s.textGeneralFontFamily+"!important;}"),s.textGeneralFontSize&&w.window.find(".white-saas-generator-text-general-span").css("font-size",s.textGeneralFontSize+"px"),s.textLineHeight&&w.window.find(".white-saas-generator-text-general-span").css("line-height",s.textLineHeight),0==s.timerEnable&&w.window.find(".white-saas-generator-counter").hide(),"hide"==s.getName&&w.window.find(".white-saas-generator-username").hide(),"hide"==s.getPhone&&w.window.find(".white-saas-generator-userphone").hide(),"hide"==s.getEmail&&w.window.find(".white-saas-generator-useremail").hide(),"hide"==s.getMobilePhone&&w.window.find(".white-saas-mobile-generator-userphone").hide(),"hide"==s.getMobileName&&w.window.find(".white-saas-mobile-generator-username").hide(),"hide"==s.getMobileEmail&&w.window.find(".white-saas-mobile-generator-useremail").hide(),0==s.show_close_button&&w.window.find(".white-saas-generator-close-button").hide(),s.textGeneralFontFamilyMobile&&w.window.find(".white-saas-mobile-generator-text-general-span").css("font-family",s.textGeneralFontFamilyMobile),s.textGeneralFontSizeMobile&&w.window.find(".white-saas-mobile-generator-text-general-span").css("font-size",s.textGeneralFontSizeMobile),s.textLineHeightMobile&&w.window.find(".white-saas-mobile-generator-text-general-span").css("line-height",s.textLineHeightMobile),s.formatTextMobile&&w.window.find(".white-saas-mobile-generator-text-general").css("text-align",s.formatTextMobile),s.textGeneralPositionGorizontalMobile&&w.window.find(".white-saas-mobile-generator-text-general").css("left",s.textGeneralPositionGorizontalMobile+"%"),s.textGeneralPositionVerticalMobile&&w.window.find(".white-saas-mobile-generator-text-general").css("top",s.textGeneralPositionVerticalMobile+"%"),s.textGeneralColorBackgroundMobile&&w.window.find(".white-saas-mobile-generator-text-general-span").css("background",s.textGeneralColorBackgroundMobile),s.textGeneralColorTextMobile&&w.window.find(".white-saas-mobile-generator-text-general-span").css("color",s.textGeneralColorTextMobile),s.generatorNextBlockContentBg&&w.window.find(".white-saas-mobile-generator-next-block, .white-saas-mobile-generator-bg-image, .white-saas-mobile-generator-success-block").css("background",s.generatorNextBlockContentBg),s.counterBgrColorMobile&&(w.window.find(".white-saas-mobile-generator-block-hours, .white-saas-mobile-generator-block-min, .white-saas-mobile-generator-block-seconds").css("background",s.counterBgrColorMobile),w.window.find(".white-saas-mobile-generator-block-colon span").css("color",s.counterBgrColorMobile)),s.counterBgrColorMobile&&w.window.find(".white-saas-mobile-generator-counter-dig-text").css("color",s.counterNumberColorMobile),s.textSubColorTextMobile&&w.window.find(".white-saas-mobile-generae-saas-mobile-generator-email-agreement-text, .white-saas-mobile-generator-text-success").css("color",s.textSubColorTextMobile),s.langText.emailAgreementTextMobile&&parseInt(s.emailAgreementMobile)||w.window.find(".white-saas-mobile-generator-label-agreement").hide(),0==s.timerEnableMobbtnSuccessColorMobile&&w.window.find(".white-saas-mobile-generator-btn-success").css("background",s.btnSuccessColorMobile),s.generatorCrossContentColor&&w.window.find(".white-saas-mobile-generator-close-button").css("color",s.generatorCrossContentColor)}else s.getPhone="yes",w.window.find(".white-saas-generator-username").hide(),s.getName="hide",w.window.find(".white-saas-generator-useremail").hide(),s.getEmail="hide";if(w.window.find(".white-saas-generator-btn-cancel, .white-saas-generator-close-button, .white-saas-mobile-generator-close-button").click(function(e){return e.preventDefault(),_this.closeWidget(),!1}),WBK.settings.phoneMasks){var listRU=$.masksSort(WBK.settings.phoneMasks,["#"],/[0-9]|#/,"mask"),optsRU={inputmask:{definitions:{"#":{validator:"[0-9]",cardinality:1}},clearIncomplete:!1,showMaskOnHover:!1,autoUnmask:!0},match:/[0-9]/,replace:"#",list:listRU,listKeeholder",$(this).inputmask("getemptymask"))}};s.useTelephoneMask&&$(".white-saas-generator-userphone").inputmasks(optsRU),s.useTelephoneMaskMobile&&$(".white-saas-mobile-generator-userphone").inputmasks(optsRU),optsRU.inputmask.definitions.clearIncomplete=!0,$(".cbk-phone-checker").inputmasks(optsRU)}s.useTelephoneMask||($(".white-saas-generator-userphone").attr("placeholder",s.langText.text_placeholder_userphone),WBK.initOnlyDigitsEvent(".white-saas-generator-userphone")),s.useTelephoneMaskMobile||($(".white-saas-mobile-generator-userphone").attr("placeholder",s.langText.text_placeholder_userphone),WBK.initOnlyDigitsEvent(".white-saas-mobile-generator-userphone")),w.window.find(".white-saas-generator-btn-success, .white-saas-mobile-generator-btn-success").on("click",function(e){"new_page"==s.pageOpenType&&s.sendActionUrl||e.preventDefault(),_this.sendLead(e)}),w.window.find(".white-saas-generator-btn-yes").on("click",function(e){e.preventDefault(),_this.hideWidget()});var open_sec=1;"paused"==s.showEnter&&s.pausedSeconds!=open_sec&&(open_sec=s.pausedSeconds),s.timerEnable&&"mobile"!==WBK.settings.device&&wsUtil.setTimeout("WidgetGeneratorInitTimer",function(){_this.initCountDown()},1e3*open_sec),s.timerEnableMobile&&"mobile"===WBK.settings.device&&wsUtil.setTimeout("WidgetGeneratorInitTimer",function(){_this.initCountDownMobile()},1e3*open_sec),_this.initTimer(),"#showgenerator"===window.top.location.hash&&(s.noShowTimeout?(s.noShow=1,_this.hideWidget()):_this.showWidget("url")),$.fn._frameCheck()&&"undefined"==typeof WBK||$("body").on("click",'a[href="#showgenerator"], a[href="'+window.top.location.origin+'#showgenerator"], a[href="'+window.top.location.origin+'/#showgenerator"]',function(e){return _this.showWidget("url"),e.preventDefault(),!1}),parseInt(s.showExit)&&$("body").mouseleave(function(e){var pos={x:e.pageX,y:e.pageY-$(document).scrollTop()};if(pos.y<=10&&!(s.noShow||WBK.settings.windowOpened||WBK.settings.chatWindowOpened||WBK.settings.windowLoanerOpened||WBK.settings.windowQuizOpened||WBK.settings.windowGeneratorOpened||WBK.settings.videoWidgetOpened||wsUtil.getCookie("WhiteGenerator_closed_"+WBK.settings.generatorId)||wsUtil.getCookie("WhiteGenerator_success_closed_"+WBK.settings.generatorId)||WBK.settings.called||!(parseInt(wsUtil.getCookie("WhiteCallback_timePage"))>8))){WBK.settings.windowInvaderOpened&&(wsInvader.widget.window.find(".cbk-support-new-message-copyright").hide(),wsInvader.widget.window.hide());var d=new Date;d.setMinutes(d.getMinutes()+144e3),wsUtil.setCookie("WhiteGenerator_show_"+WBK.settings.generatorId,"onexit",d),_this.showWidget("exit");
}}),"scroll"==s.showEnter&&$(window).on("scroll.white-saas-generator",function(){var scroll=$(window).scrollTop(),scrollH=$(document).height()-$(window).height(),scrolled=scroll/scrollH*100,type_show="auto";!(s.showScrollValue<=scrolled)||s.noShow||WBK.settings.windowGeneratorOpened||WBK.settings.videoWidgetOpened||WBK.settings.windowOpened||WBK.settings.windowInvaderOpened||WBK.settings.chatWindowOpened||WBK.settings.chatInvitationOpened||WBK.settings.windowLoanerOpened||WBK.settings.windowQuizOpened||wsUtil.getCookie("WhiteGenerator_closed_"+WBK.settings.generatorId)||wsUtil.getCookie("WhiteGenerator_success_closed_"+WBK.settings.generatorId)||WBK.settings.called||("mobile"===WBK.settings.device&&(type_show="mobile"),_this.showWidget(type_show))})},initTimer:function(){if("disabled"!=s.showEnter&&"scroll"!=s.showEnter){var open_seconds=1,type_show="auto";if("mobile"===WBK.settings.device&&(type_show="mobile"),"paused"==s.showEnter&&(open_seconds=s.pausedSeconds,"site"===s.paused_sec_target)){var timeAfterFirstLogin=wsUtil.getCookie("WhiteCallback_timeAll");timeAfterFirstLogin&&(+timeAfterFirstLogin<+open_seconds?open_seconds-=timeAfterFirstLogin:open_seconds=0)}if("behavioral"==s.showEnter){var start=3,end=27;s.showBehavioralValue&&(start+=s.showBehavioralValue,end+=s.showBehavioralValue),open_seconds=wsUtil.getRandomArbitrary(start,end)}wsUtil.setInterval("WidgetGeneratorTimer",function(){s.noShow||WBK.settings.windowGeneratorOpened||WBK.settings.videoWidgetOpened||WBK.settings.windowOpened||WBK.settings.windowInvaderOpened||WBK.settings.chatWindowOpened||WBK.settings.windowLoanerOpened||WBK.settings.windowQuizOpened||(wsUtil.deleteInterval("WidgetGeneratorTimer"),wsUtil.getCookie("WhiteGenerator_closed_"+WBK.settings.generatorId)||wsUtil.getCookie("WhiteGenerator_success_closed_"+WBK.settings.generatorId)||WBK.settings.called||_this.showWidget(type_show))},1e3*open_seconds)}},playerLoad:function(){var tag=document.createElement("script");tag.src="https://www.youtube.com/iframe_api";var firstScriptTag=document.getElementsByTagName("script")[0];firstScriptTag.parentNode.insertBefore(tag,firstScriptTag),window.onYouTubeIframeAPIReady=function(){window.generatorPlayer=new YT.Player("white-saas-generator-player",{events:{onReady:onPlayerReady}})},window.onPlayerReady=function(){0==s.voice_video&&window.generatorPlayer.mute()}},initCountDown:function(){var date=new Date;date=_this.getDate(date);var genData=wsUtil.getCookie("WhiteGenerator_"+WBK.settings.generatorId+"_counter");if(genData=!(!genData||"false"==genData)&&JSON.parse(genData),"fixed"==s.counterTime)if(genData&&genData.counterTime==s.counterTime&&genData.dateHours==s.dateHours&&genData.dateHoursType==s.dateHoursType&&wsUtil.getCookie("WhiteGenerator_"+WBK.settings.generatorId+"_countEnd"))date=new Date(wsUtil.getCookie("WhiteGenerator_"+WBK.settings.generatorId+"_countEnd"));else{wsUtil.setCookie("WhiteGenerator_"+WBK.settings.generatorId+"_countEnd",date,date);var genData={dateHours:s.dateHours,dateHoursType:s.dateHoursType,counterTime:"fixed"};wsUtil.setCookie("WhiteGenerator_"+WBK.settings.generatorId+"_counter",JSON.stringify(genData),date)}else{genData&&(genData.counterTime=s.counterTime);var cookieDate=new Date;cookieDate.setMinutes(cookieDate.getMinutes()+144e3),wsUtil.setCookie("WhiteGenerator_"+WBK.settings.generatorId+"_counter",JSON.stringify(genData),cookieDate)}s.endTime=date,Math.floor((s.endTime-new Date)/1e3)<0&&s.noShowTimeout&&(s.noShow=1,_this.hideWidget()),wsUtil.setInterval("WidgetGeneratorCountDown",function(){var left,d,h,m,sec,days=86400,hours=3600,minutes=60;left=Math.floor((s.endTime-new Date)/1e3),left<0?(s.noShowTimeout&&(s.noShow=1,_this.hideWidget()),_this.stopCountDown(),d="00",h="00",m="00",sec="00"):(d=Math.floor(left/days),d>99&&(d=99),left-=d*days,h=Math.floor(left/hours),left-=h*hours,m=Math.floor(left/minutes),left-=m*minutes,sec=left);var oldType=s.counterTypeInTimer;d>0?s.counterTypeInTimer=1:s.counterTypeInTimer=0,oldType!=s.counterTypeInTimer&&(1==s.counterTypeInTimer?($(".white-saas-generator-counter-number-hours").next().text(s.langText.text_counter_days),$(".white-saas-generator-counter-number-minutes").next().text(s.langText.text_counter_hours),$(".white-saas-generator-counter-number-seconds").next().text(s.langText.text_counter_minutes)):($(".white-saas-generator-counter-number-hours").next().text(s.langText.text_counter_hours),$(".white-saas-generator-counter-number-minutes").next().text(s.langText.text_counter_minutes),$(".white-saas-generator-counter-number-seconds").next().text(s.langText.text_counter_seconds))),1==s.counterTypeInTimer&&(sec=m,m=h,h=d),_this.updateGeneratorDigits(h,".white-saas-generator-counter-number-hours"),_this.updateGeneratorDigits(m,".white-saas-generator-counter-number-minutes"),_this.updateGeneratorDigits(sec,".white-saas-generator-counter-number-seconds")},1e3)},initCountDownMobile:function(){var date=new Date;date=_this.getDateMobile(date);var genData=wsUtil.getCookie("WhiteGenerator_"+WBK.settings.generatorId+"_counterMobile");if(genData=!(!genData||"false"==genData)&&JSON.parse(genData),"fixed"==s.counterTimeMobile)if(genData&&genData.counterTimeMobile==s.counterTimeMobile&&genData.dateHoursMobile==s.dateHoursMobile&&genData.dateHoursTypeMobile==s.dateHoursTypeMobile&&wsUtil.getCookie("WhiteGenerator_"+WBK.settings.generatorId+"_countEndMobile"))date=new Date(wsUtil.getCookie("WhiteGenerator_"+WBK.settings.generatorId+"_countEndMobile"));else{wsUtil.setCookie("WhiteGenerator_"+WBK.settings.generatorId+"_countEndMobile",date,date);var genData={dateHoursMobile:s.dateHoursMobile,dateHoursTypeMobile:s.dateHoursTypeMobile,counterTimeMobile:"fixed"};wsUtil.setCookie("WhiteGenerator_"+WBK.settings.generatorId+"_counterMobile",JSON.stringify(genData),date)}else{genData&&(genData.counterTimeMobile=s.counterTimeMobile);var cookieDate=new Date;cookieDate.setMinutes(cookieDate.getMinutes()+144e3),wsUtil.setCookie("WhiteGenerator_"+WBK.settings.generatorId+"_counterMobile",JSON.stringify(genData),cookieDate)}s.endTimeMobile=date,Math.floor((s.endTimeMobile-new Date)/1e3)<0&&s.noShowTimeoutMobile&&(s.noShow=1,_this.hideWidget()),wsUtil.setInterval("WidgetGeneratorCounttes=60;left=Math.floor((s.endTimeMobile-new Date)/1e3),left<0?(s.noShowTimeoutMobile&&(s.noShow=1,_this.hideWidget()),_this.stopCountDownMobile(),d="00",h="00",m="00",sec="00"):(d=Math.floor(left/days),d>99&&(d=99),left-=d*days,h=Math.floor(left/hours),left-=h*hours,m=Math.floor(left/minutes),left-=m*minutes,sec=left);s.counterTypeInTimer;d>0?s.counterTypeInTimerMobile=1:s.counterTypeInTimerMobile=0,1==s.counterTypeInTimerMobile&&(sec=m,m=h,h=d),_this.updateGeneratorDigits(h,".white-saas-mobile-generator-block-hours .white-saas-mobile-generator-counter-dig-text"),_this.updateGeneratorDigits(m,".white-saas-mobile-generator-block-min .white-saas-mobile-generator-counter-dig-text"),_this.updateGeneratorDigits(sec,".white-saas-mobile-generator-block-seconds .white-saas-mobile-generator-counter-dig-text")},1e3)},stopCountDown:function(){wsUtil.deleteInterval("WidgetGeneratorCountDown")},stopCountDownMobile:function(){wsUtil.deleteInterval("WidgetGeneratorCountDownMobile")},updateGeneratorDigits:function(counter,className){var one=Math.floor(counter/10)%10+"",two=counter%10+"",count=one+two;w.window.find(className).text(count)},getDate:function(date){switch(s.counterTime){case"fixed":"hours"==s.dateHoursType?date.setHours(date.getHours()+parseInt(s.dateHours)):"minutes"==s.dateHoursType&&date.setMinutes(date.getMinutes()+parseInt(s.dateHours));break;case"todate":var d=s.dateEnd.split("."),time=s.dateEndTime.split(":");date=new Date(parseInt(d[2]),parseInt(d[1])-1,parseInt(d[0]),time[0],time[1]);break;case"toweekday":var dayCount,dayNow=(new Date).getDay(),dayGen=parseInt(s.dateEndWeekday);dayCount=dayNow<dayGen?dayGen-dayNow:dayNow===dayGen?7:7-(dayNow-dayGen),date=new Date(new Date(date).setHours(0,0,0,0)),date=date.setDate(date.getDate()+dayCount);break;case"eachdaytotime":var timeToEnd=new Date((new Date).setHours(parseInt(s.each_day_to_time.split(":")[0]),0,0));date>timeToEnd?(date.setDate(date.getDate()+1),date.setHours(timeToEnd.getHours(),0,0)):date=timeToEnd}return date},getDateMobile:function(date){switch(s.counterTimeMobile){case"fixed":"hours"==s.dateHoursTypeMobile?date.setHours(date.getHours()+parseInt(s.dateHoursMobile)):"minutes"==s.dateHoursTypeMobile&&date.setMinutes(date.getMinutes()+parseInt(s.dateHoursMobile));break;case"todate":var d=s.dateEndMobile.split("."),time=s.dateEndTimeMobile.split(":");date=new Date(parseInt(d[2]),parseInt(d[1])-1,parseInt(d[0]),time[0],time[1]);break;case"toweekday":var dayCount,dayNow=(new Date).getDay(),dayGen=parseInt(s.dateEndWeekdayMobile);dayCount=dayNow<dayGen?dayGen-dayNow:dayNow==dayGen?7:7-(dayNow-dayGen),date=new Date(new Date(date).setHours(0,0,0,0)),date=date.setDate(date.getDate()+dayCount);break;case"eachdaytotime":var timeToEnd=new Date((new Date).setHours(parseInt(s.eachDayToTimeMobile.split(":")[0]),0,0));date>timeToEnd?(date.setDate(date.getDate()+1),date.setHours(timeToEnd.getHours(),0,0)):date=timeToEnd}return date},lengthSuccessText:function(content){w.window.find(".white-saas-generator-success").show();var marginTextBlock,blockText=w.window.find(".white-saas-generator-success-text"),rightBlockHeight=blockText.closest(".white-saas-generator-right-block").height(),heightOuterBlock=.83*rightBlockHeight,successBtnHeight=w.window.find(".white-saas-generator-buttons").height();blockText.height()>rightBlockHeight?(blockText.parent().css("margin-top","5%"),blockText.find(".wsg-body-content").css({"overflow-y":"scroll",position:"absolute"}),blockText.height(heightOuterBlock),blockText.nanoScroller({contentClass:"wsg-body-content",paneClass:"wsg-body-pane",sliderClass:"wsg-body-slider"})):(blockText.html(s.langText.text_success),marginTextBlock=100-100*blockText.height()/(rightBlockHeight-successBtnHeight-25),blockText.parent().css("margin-top",Math.floor(marginTextBlock)+"%"))},sendLead:function(e){if(!s.sendingLead){s.sendingLead=!0;var name,email,originalPhone,phone,phoneMask,emailAgreement,from_mobile,minPhoneNumberLength=5;if("mobile"===WBK.settings.device){name=$(".white-saas-mobile-generator-username").val(),email=$(".white-saas-mobile-generator-useremail").val(),originalPhone=phone=$(".white-saas-mobile-generator-userphone").val(),""==name||WBK.settings.visitorName||(WBK.setVisitorInfoIfNot({name:name}),s.langText.textSuccessMobile=wsUtil.decorateText(s.text_success_mobile),w.window.find(".white-saas-mobile-generator-text-success").html(s.langText.textSuccessMobile)),$(".white-saas-mobile-generator-userphone-error, .white-saas-mobile-generator-useremail-error, .white-saas-mobile-generator-userall-error").addClass("white-saas-mobile-generator-error-hidden"),s.useTelephoneMaskMobile&&(phone=WBK.checkPhone(originalPhone),phoneMask=$(".white-saas-mobile-generator-userphone").attr("placeholder")),emailAgreement=$(".white-saas-generator-email-agreement").is(":checked")?1:0,from_mobile=1;var errors_class="";if("yes"==s.getMobileName&&""==name&&($(".white-saas-mobile-generator-username").addClass("white-saas-mobile-generator-error"),errors_class?errors_class+=", .white-saas-mobile-generator-username-error":errors_class=".white-saas-mobile-generator-username-error"),"yes"==s.getMobilePhone&&(""==originalPhone||""!=originalPhone&&originalPhone.length<minPhoneNumberLength||""!=originalPhone&&s.useTelephoneMaskMobile&&""==phone||""!=originalPhone&&s.useTelephoneMaskMobile&&""!=phone&&phone.length<minPhoneNumberLength)&&(errors_class?errors_class+=", .white-saas-mobile-generator-userphone-error":errors_class=".white-saas-mobile-generator-userphone-error"),"yes"!=s.getMobileEmail||""!=email&&wsUtil.validateEmail(email)||($(".white-saas-mobile-generator-useremail").addClass("white-saas-mobile-generator-error"),errors_class?errors_class+=", .white-saas-mobile-generator-useremail-error":errors_class=".white-saas-mobile-generator-useremail-error"),"yes"!=s.getMobileEmail&&"yes"!=s.getMobilePhone&&(""==originalPhone&&""==email?errors_class=".white-saas-mobile-generator-userall-error":((""!=originalPhone&&originalPhone.length<minPhoneNumberLength||""!=originalPhone&&""==phone||""!=originalPhone&&""!=phone&&phone.length<minPhoneNumberLength)&&(errors_class?errors_class+=", .white-saas-mobile-generator-userphone-error":errors_class=".white-saas-mobile-generator-userphone-error"),""==email||wsUtil.validateEmail(email)||(errors_class?errors_class+=", .white-saas-mobile-generator-useremail-error":errors_class=".white-saas-mobile-generator-useremail-error"))),errors_class)return w.window.find(errors_class).removeClass("white-saas-mobile-generator-error-hidden"),s.sendingLead=!1,void e.preventDefault()}else{name=$(".white-saas-generator-username").val().trim(),email=$(".white-saas-generator-useremail").val(),phone=$(".white-saas-generator-userphone").val(),""==name||WBK.settings.visitorName||(WBK.setVisitorInfoIfNot({name:name}),s.langText.text_success=wsUtil.decorateText(s.successTextWithTags)),s.useTelephoneMask&&(phone=WBK.checkPhone(phone),phoneMask=$(".white-saas-generator-userphone").attr("placeholder")),emailAgreement=$(".white-saas-mobile-generator-email-agreement").is(":checked")?1:0,from_mobile=0,$(".white-saas-generator-userphone-error, .white-saas-generator-username-error, .white-saas-generator-useremail-error").addClass("white-saas-generator-error-hidden");var errors_class="";if("yes"==s.getName&&""==name&&(errors_class=".white-saas-generator-username-error"),"hide"!==s.getName&&0!=name.length&&name.length<2&&(errors_class=".white-saas-generator-username-error"),"yes"==s.getPhone&&(""==phone||phone.length<3)&&(errors_class?errors_class+=", .white-saas-generator-userphone-error":errors_class=".white-saas-generator-userphone-error"),"yes"!=s.getEmail||""!=email&&wsUtil.validateEmail(email)||(errors_class?errors_class+=", .white-saas-generator-useremail-error":errors_class=".white-saas-generator-useremail-error"),"yes"!=s.getName&&"yes"!=s.getEmail&&"yes"!=s.getPhone&&""==name&&""==phone&&""==email&&(errors_class=".white-saas-generator-userall-error"),errors_class)return w.window.find(errors_class).removeClass("white-saas-generator-error-hidden"),s.sendingLead=!1,void e.preventDefault()}WBK.setVisitorInfoIfNot({phone:phone,email:email});var _d={code:WBK.settings.whiteSaasCode,name:name,email:email,phone:phone,visitId:WBK.settings.visitId,generatorId:WBK.settings.generatorId,generatorStatId:WBK.settings.generatorStatId,phoneMask:phoneMask,emailAgreement:emailAgreement,agreementLink:"https://whitesaas.com/agreement/",url:"string"==typeof document.URL?document.URL:"",visitorId:WBK.settings.visitorId,invader_id:WBK.settings.invaderId,invaderStatId:WBK.settings.invaderGeneratorStatId,instinct_id:WBK.settings.instinctId,instinctStatId:WBK.settings.instinctGeneratorStatId,roistatPromo:wsUtil.getRoistatPromo(),advertiseId:wsUtil.getAdvertiseId(),calltrackingId:wsUtil.getCalltrackingId(),lpgeneratorId:wsUtil.getLPGeneratorId(),leadvertexId:wsUtil.getLeadvertexId(),fromMobile:from_mobile,googleClientId:wsUtil.getGoogleClientId(),externalParams:wsUtil.getExternalParams()};"function"==typeof window.ws_OnGeneratorSendLead&&window.ws_OnGeneratorSendLead(_d);var url=WBK.settings.serverUrl+"/api?action=genLeadAdd";jWS.post(url,_d,function(result){if(1==result.Success){var date=new Date;if(date.setMinutes(date.getMinutes()+144e3),wsUtil.setCookie("WhiteGenerator_success_closed_"+WBK.settings.generatorId,!0,date),"undefined"!=typeof result.Data.leadId&&(WBK.settings.genLeadId=result.Data.leadId,phone=WBK.checkPhone(phone,!0),phone&&s.autoCall&&WBK.settings.callbackEnabled&&s.isPayed&&s.hasMoneyForLead&&s.isPayedGenerator)){wsKiller.settings.callingWidget=!0;var d=new Date;d.setMinutes(d.getMinutes()+144e3),wsUtil.setCookie("WhiteCallback_shownOn","ongen",d),WBK.settings.phoneMask=s.useTelephoneMask?$(".white-saas-generator-userphone").attr("placeholder"):WBK.numberMask(phone).mask,wsKiller.newCall(phone,!1,s.autoCallDeffered,s.autoCallDefferedDelay)}if(_this.sendGoal("lead"),"go_url"==s.sendAction&&s.sendActionUrl&&"new_page"!==s.pageOpenType){var match=wsUtil.parseURL(s.sendActionUrl);match.scheme||(s.sendActionUrl="http://"+s.sendActionUrl),window.location.href=s.sendActionUrl,_this.hideWidget()}else"mobile"===WBK.settings.device?(w.window.find(".white-saas-mobile-generator-next-block").hide(),w.window.find(".white-saas-mobile-generator-success-block").show()):(w.window.find(".white-saas-generator-right-block").children().hide(),_this.lengthSuccessText(s.langText.text_success));s.sendingLead=!1}},"json")}},hideWidget:function(){WBK.settings.windowGeneratorOpened=!1,w.windowbgr.hide(),w.window.hide(),w.window.each(function(){this.style.setProperty("display","none","important")}),"mobile"===WBK.settings.device&&(w.window.data("noViewport")?(w.window.data("noViewport",0),$("meta[name=viewport]:last").attr("content","")):$("meta[name=viewport]:last").attr("content",w.window.data("oldViewport")),$("body").removeClass("cbk-body-mobile"),$(window).scrollTop(s.scrollTop),$(window).scrollLeft(s.scrollLeft),wsUtil.fixJivo(!1)),s.code_video&&$(".white-saas-generator-video-iframe").remove(),WBK.settings.callbackEnabled&&1!=wsKiller.settings.hideBtn&&wsKiller.settings.btnShow&&wsKiller.widget.btn.show(500),WBK.settings.chatBtnOpened&&wsChat.widget.btn.show(),WBK.settings.loanerId&&"mobile"!=WBK.settings.device&&wsLoaner.showWidget(),WBK.settings.quizId&&!WBK.settings.quizIntegrated&&WBK.settings.thisIsQuizLaId].showWidget(),WBK.settings.multiButtonId&&wsMultiButton.showWidget(),WBK.settings.invaderGeneratorStatId=!1},calculateMobileImageHeight:function(){if(!("pc"===WBK.settings.device||"tablet"===WBK.settings.device&&window.innerWidth>900)&&(w.window.find(".white-saas-mobile-generator-image").css("height","auto"),$(".white-saas-mobile-generator").height()>=window.innerHeight)){var hReducer=0;"hide"!==s.getMobilePhone&&(hReducer+=1),"hide"!==s.getMobileEmail&&(hReducer+=1),"hide"!==s.getMobileName&&(hReducer+=1),hReducer>1&&(w.window.find(".white-saas-mobile-generator-image").css("height",w.window.find(".white-saas-mobile-generator-image").height()-33*(hReducer-1)),$(".white-saas-mobile-generator-image").addClass("white-saas-mobile-generator-image-cover"))}},showWidget:function(type_open){var pos=window.innerHeight/2-w.window.height()/2;if(pos<0&&(pos=0),pos=(pos<0?0:pos)+w.window.scrollTop(),WBK.settings.callbackEnabled&&setTimeout(function(){wsKiller.widget.btn.hide()},200),WBK.settings.chatBtnOpened&&wsChat.widget.btn.hide(),WBK.settings.chatInvitationOpened&&wsChat.hideInvitation(),WBK.settings.loanerId&&"mobile"!=WBK.settings.device&&wsLoaner.hideWidget(),WBK.settings.quizId&&!WBK.settings.quizIntegrated&&WBK.settings.thisIsQuizLanding===!1&&wsQuizzes[WBK.settings.quizId].hideWidget(),WBK.settings.videoWidgetId&&WBK.settings.videoWidgetOpened&&wsVideoWidget.closeWidget(),"mobile"===WBK.settings.device||"tablet"===WBK.settings.device&&window.innerWidth<900){s.scrollLeft=$(window).scrollLeft(),s.scrollTop=$(window).scrollTop(),$("meta[name=viewport]:last").length?(w.window.data("oldViewport",$("meta[name=viewport]:last").attr("content")),$("meta[name=viewport]:last").remove()):w.window.data("noViewport",1),$("head").append($("<meta>").attr("name","viewport").attr("content","width=device-width, user-scalable=0, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0")),$("body").addClass("cbk-body-mobile").css("width",$(window).width()+"px"),s.calculateHeight&&(_this.calculateMobileImageHeight(),s.calculateHeight=!1);var wHeightTop=0;navigator.userAgent.search(/\iPhone\b.*\bSafari\b/g)===-1||90!=window.orientation&&window.orientation!=-90||navigator.userAgent.match("CriOS")||(wHeightTop=38),pos=window.innerHeight/2-w.window.height()/2,pos<0&&(pos=0),pos=(pos<0?0:pos)+w.window.scrollTop()+wHeightTop,w.window.css("top",pos+"px");var cbkWindowWidth=w.window.width(),left=(window.innerWidth-cbkWindowWidth)/2;left<0&&(left=0),w.window.css("left",left+"px"),WBK.settings.windowOpened||WBK.settings.windowLoanerOpened||WBK.settings.windowQuizOpened||WBK.settings.videoWidgetOpene.show(),w.window.each(function(){this.style.setProperty("display","block","important")})),wsUtil.fixJivo(!0),$(window).on("resize",function(){_this.calculateMobileImageHeight(),pos=window.innerHeight/2-w.window.height()/2,pos<0&&(pos=0),pos=(pos<0?0:pos)+w.window.scrollTop(),w.window.css("top",pos+"px"),cbkWindowWidth=w.window.width(),left=(window.innerWidth-cbkWindowWidth)/2,left<0&&(left=0),w.window.css("left",left+"px")}),$(window).on("orientationchange",function(){setTimeout(function(){var wHei||90!=window.orientation&&window.orientation!=-90||navigator.userAgent.match("CriOS")||(wHeightTop=38),pos=window.innerHeight/2-w.window.height()/2,pos<0&&(pos=0),pos=(pos<0?0:pos)+w.window.scrollTop()+wHeightTop,w.window.css("top",pos+"px"),cbkWindowWidth=w.window.width(),left=(window.innerWidth-cbkWindowWidth)/2,left<0&&(left=0),w.window.css("left",left+"px")},600)}),setTimeout(function(){$(window).resize()},600),s.timerEnableMobile&&"paused"==s.showEnter&&(wsUtil.deleteTimeout("WidgetGeneratorInitTimer"),_this.initCountDownMobile()),s.useTelephoneMaskMobile&&WBK.setPhoneInputFocusForm($(".white-saas-mobile-generator-userphone"))}else{if(w.window.css("top",pos+"px"),!(WBK.settings.windowOpened||WBK.settings.windowLoanerOpened||WBK.settings.windowQuizOpened||WBK.settings.videoWidgetOpened)){if(w.windowbgr.show(),$("#btn_agreement_caption")each(function(){this.style.setProperty("display","block","important")}),s.isPayed&&s.code_video){var loopQuery="&loop=0";1==s.repeat_video&&(loopQuery="&loop=1&playlist="+s.code_video),$(".white-saas-generator-video-iframe").length?$(".white-saas-generator-video-iframe").attr("src","https://www.youtube.com/embed/"+s.code_video+"?autoplay=1&autohide=1&controls=0&disablekb=1&modestbranding=1&rel=0&showinfo=0&cc_load_policy=1&iv_load_policy=3&enablejsapi=1&widgetid=1"+loopQuery):($(".white-saas-generator-video").append('<iframe onload="window.onFrameLoad()" class="white-saas-generator-video-iframe" src=https://www.youtube.com/embed/'+s.code_video+"?autoplay=1&autohide=1&controls=0&disablekb=1&modestbranding=1&rel=0&showinfo=0&cc_load_policy=1&iv_load_policy=3&enablejsapi=1&widgetid=1"+loopQuery+"></iframe>"),0==s.voice_video&&(window.generatorPlayer.a=$(".white-saas-generator-video-iframe")[0],window.onFrameLoad=function(){0==s.voice_video&&window.generatorPlayer.mute()}))}s.useTelephoneMask&&WBK.setPhoneInputFocusForm($(".white-saas-generator-userphone"))}s.timerEnable&&"paused"==s.showEnter&&(wsUtil.deleteTimeout("WidgetGeneratorInitTimer"),_this.initCountDown())}WBK.settings.windowGeneratorOpened=!0,0===s.noShow&&(_this.sendEvents("show",type_open),_this.sendGoal("newshow")),wsUtil.fixBootstrap()},closeWidget:function(){var date=new Date;"minutes"==s.repeatShowType?date.setMinutes(date.getMinutes()+parseInt(s.repeatShowTime)):"days"==s.repeatShowType&&date.setDate(date.getDate()+parseInt(s.repeatShowTime)),wsUtil.setCookie("WhiteGenerator_closed_"+WBK.settings.generatorId,!0,date),_this.hideWidget(),_this.sendEvents("close"),_this.sendGoal("close")},sendEvents:function(type,type_open){var url=WBK.settings.serverUrl+"/api?action=genEvent&callback=?";$.getJSON(url,{event:type,openType:type_open,invaderId:"invader"==type_open&&WBK.settings.invaderId,instinctId:"instinct"==type_open&&WBK.settings.instinctId,generatorStatId:WBK.settings.generatorStatId,generatorId:WBK.settings.generatorId,code:WBK.settings.whiteSaasCode,visitId:WBK.settings.visitId,visitorId:WBK.settings.visitorId},function(result){"undefined"!=typeof result.Data.genStatId&&("show"===type?WBK.settings.generatorStatId=result.Data.genStatId:WBK.settings.generatorStatId=!1)})},sendGoal:function(type){var yaGoal,gaGoal,yagla=!1,gaCategory="Generator",facebook=!1;switch(type){case"lead":yaGoal="GEN_LEAD",gaGoal="NewLead",yagla="generator",facebook="NewLead",wsUtil.sendUniversalGoal();break;case"newshow":yaGoal="GEN_SHOW",gaGoal="GenNewShow";break;case"close":yaGoal="GEN_CANCEL",gaGoal="CancelLead"}wsUtil.sendGoal(yaGoal,gaGoal,gaCategory,yagla,facebook)},setDefaultSettings:function(){var defaultSettings={firstApperance:3,reapperance:60,textGeneralColorBackground:!1,colorBackgroundRight:!1,textGeneralColorText:!1,btnSuccessColor:!1,btnCancelColor:!1,counterTime:!1,counterTypeInTimer:0,dateEnd:!1,dateEndTime:!1,dateEndWeekday:!1,dateHours:!1,getEmail:!1,getName:!1,getPhone:!1,imgBackground:0,imgBackgrouundService:0,logo_file_extension:"",logo_file_extension_mobile:"",pausedSeconds:!1,repeatShowTime:!1,repeatShowType:!1,showEnter:!1,showScrollValue:0,showBehavioralValue:0,sendAction:!1,pageOpenType:"current",actionUrlLinkHrefText:'href="javascript:void(0)"',sendActionUrl:!1,showExit:!1,timerEnable:!1,autoCall:0,autoCallText:"0",autoCallDeffered:0,autoCallDefferedDelay:0,isPayed:!1,hasMoneyForLead:!1,isPayedGenerator:!1,closeClickBgr:0,counterBgrColor:!1,counterNumberColor:!1,leadId:!1,partnerLink:!1,textGeneralFormat:!1,textGeneralPositionGorizontal:!1,textGeneralPositionVertical:!1,textGeneralFontFamily:!1,textGeneralFontSize:!1,emailService:"off",emailAgreement:0,langText:{},noShowTimeout:0,noShow:0,containerShadow:!1,sendingLead:!1,hideTablet:!1,hideBackgroundSite:1,siteBgrColor:"rgba(255,255,255,0.7)",close_button:0,voice_video:0,repeat_video:1,code_video:"",video_position:"0"};$.extend(!0,s,defaultSettings)},setTemplate:function(){t="mobile"===WBK.settings.device||"tablet"===WBK.settings.device&&window.innerWidth<900?{windowBgr:'<div class="cbk-window-bgr"></div>',window:'<div class="white-saas-mobile-generator"><div class="white-saas-mobile-generator-bg-image"><div class="white-saas-mobile-generator-image-container"></div><img class="white-saas-mobile-generator-image" src="//saas-support.com/widget/img/background.jpg"><div class="white-saas-mobile-generator-text-general"><span class="white-saas-mobile-generator-text-general-span">'+s.langText.textGeneralMobile+'</span></div><a href="javascript:void(0)" class="white-saas-mobile-generator-close-button" style="">×</a></div><div class="white-saas-mobile-generator-next-block"><div class="white-saas-mobile-generator-next-block-content"><a href="javascript:void(0)" class="white-saas-mobile-generator-close-button white-saas-mobile-generator-only-landscape" style="">×</a><div class="white-saas-mobile-generator-text-sub">'+s.langText.textSubMobile+'</div><div class="white-saas-mobile-generator-counter-clock "><div class="white-saas-mobile-generator-counter-text">'+s.langText.textCounterTitleMobile+'</div><div class="white-saas-mobile-generator-counter-dig"><div class="white-saas-mobile-generator-counter-block"><div class="white-saas-mobile-generator-block-hours" style="background: rgba(170,122,122,1)"><span class="white-saas-mobile-generator-counter-dig-text" style="color: rgba(255,0,0,1)">06</span></div><div class="white-saas-mobile-generator-block-colon"><span style="color: rgba(255,0,0,1);">:</span></div><div class="white-saas-mobile-generator-block-min" style="background: rgba(170,122,122,1)"><span class="white-saas-mobile-generator-counter-dig-text" style="color: rgba(255,0,0,1)">51</span></div><div class="white-saas-mobile-generator-block-colon" "=""><span style="color: rgba(255,0,0,1);">:</span></div><div class="white-saas-mobile-generator-block-seconds" style="background: rgba(170,122,122,1)"><span class="white-saas-mobile-generator-counter-dig-text" style="color: rgba(255,0,0,1)">44</span></div></div></div></div></div><div class="white-saas-mobile-generator-group"><input type="text" class="white-saas-mobile-generator-username" maxlength="32" placeholder="'+s.langText.text_placeholder_username+'"><input type="tel" class="white-saas-mobile-generator-userphone" placeholder="'+s.langText.text_placeholder_userphone+'" maxlength="32"><input type="text" class="cbk-phone-checker white-saas-generator-input-hidden"/><input type="text" class="white-saas-mobile-generator-useremail" maxlength="32" placeholder="email"><div class="white-saas-mobile-generator-group white-saas-mobile-generator-group-with-error"><small class="white-saas-mobile-generator-username-error white-saas-mobile-generator-error-hidden">'+s.langText.error_name+'</small></div><div class="white-saas-mobile-generator-group white-saas-mobile-generator-group-with-error"><small class="white-saas-mobile-generator-userphone-error white-saas-mobile-generator-error-hidden">'+s.langText.error_phone+'</small></div><div class="white-saas-mobile-generator-group white-saas-mobile-generator-group-with-error"><small class="white-saas-mobile-generator-useremail-error white-saas-mobile-generator-error-hidden">'+s.langText.error_email+'</small></div><div class="white-saas-mobile-generator-group white-saas-mobile-generator-group-with-error"><small class="white-saas-mobile-generator-userall-error white-saas-mobile-generator-error-hidden">'+s.langText.error_all+'</small></div></div><div class="white-saas-mobile-generator-group"><a '+s.actionUrlLinkHrefText+' class="white-saas-mobile-generator-btn-success">'+s.langText.btnSuccessTextMobile+'</a></div><div class="white-saas-mobile-generator-group"><label class="white-saas-mobile-generator-label-agreement"><input type="checkbox" class="white-saas-mobile-generator-email-agreement" checked=""><span class="white-saas-mobile-generator-email-agreement-text">'+s.langText.email_agreement_text+'</span></label></div><div class="white-saas-mobile-generator-group"><div class="white-saas-mobile-generator-copyright"><a href="#" class="white-saas-mobile-generator-copyright-url" target="_blank">'+s.langText.text_link+'</a></div></div></div><div class="white-saas-mobile-generator-success-block"><div class="white-saas-mobile-generator-next-block-content"><div class="white-saas-mobile-generator-text-success">'+s.langText.textSuccessMobile+"</div></div></div></div>"}:{windowBgr:'<div class="cbk-window-bgr"></div>',window:'<div class="white-saas-generator"><div class="white-saas-generator-container"><div class="white-saas-generator-video '+(1==s.video_position?"left-position":"")+'">'+(s.code_video?'<iframe id ="white-saas-generator-player" class="white-saas-generator-video-iframe" frameborder="0" allowfullscreen="1" width="100%" height="100%" src="//www.youtube.com/embed/"></iframe>':"")+'</div><div class="white-saas-generator-left-block"'+(s.code_video?'style="pointer-events: none;"':"")+'><img class="white-saas-generator-image" src="'+WBK.settings.staticServerUrl+'/widget/img/background.png"><div class="white-saas-generator-text-general"><span class="white-saas-generator-text-general-span">'+s.langText.text_general+'</span></div></div><div class="white-saas-generator-right-block"><a href="javascript:void(0)" class="white-saas-generator-close-button">×</a><div class="white-saas-generator-success"><div class="white-saas-generator-success-text nano"><div class="wsg-body-content">'+s.langText.text_success+'</div></div><div class="white-saas-generator-buttons"><a href="#" class="white-saas-generator-btn-yes">'+s.langText.text_btn_yes+'</a></div></div><div class="white-saas-generator-text-sub">'+s.langText.text_sub+'</div><div class="white-saas-generator-counter"><div class="white-saas-generator-counter-title">'+s.langText.text_counter_title+'</div><div class="white-saas-generator-counter-clock"><div class="white-saas-generator-counter-dig"><div class="white-saas-generator-counter-block"></div><div class="white-saas-generator-counter-number white-saas-generator-counter-number-hours">00</div><div class="white-saas-generator-counter-name">'+s.langText.text_counter_hours+'</div></div><div class="white-saas-generator-counter-dz"><div class="white-saas-generator-counter-dz-block"></div><div class="white-saas-generator-counter-dz-block"></div></div><div class="white-saas-generator-counter-dig"><div class="white-saas-generator-counter-block"></div><div class="white-saas-generator-counter-number white-saas-generator-counter-number-minutes">00</div><div class="white-saas-generator-counter-name">'+s.langText.text_counter_minutes+'</div></div><div class="white-saas-generator-counter-dz"><div class="white-saas-generator-counter-dz-block"></div><div class="white-saas-generator-counter-dz-block"></div></div><div class="white-saas-generator-counter-dig"><div class="white-saas-generator-counter-block"></div><div class="white-saas-generator-counter-number white-saas-generator-counter-number-seconds">00</div><div class="white-saas-generator-counter-name">'+s.langText.text_counter_seconds+'</div></div></div></div><div class="white-saas-generator-group"><input type="text" class="white-saas-generator-group-input white-saas-generator-username" placeholder="'+s.langText.text_placeholder_username+'"><small class="white-saas-generator-username-error white-saas-generator-error-hidden">'+s.langText.error_name+'</small></div><div class="white-saas-generator-group"><input type="text" class="white-saas-generator-group-input white-saas-generator-userphone" placeholder="'+s.langText.text_placeholder_userphone+'"><input type="text" class="cbk-phone-checker white-saas-generator-input-hidden"/><small class="white-saas-generator-userphone-error white-saas-generator-error-hidden">'+s.langText.error_phone+'</small></div><div class="white-saas-generator-group"><input type="email" class="white-saas-generator-group-input white-saas-generator-useremail" placeholder="name@example.com"><small class="white-saas-generator-useremail-error whitr_email+'</small></div><div class="white-saas-generator-group"><small class="white-saas-generator-userall-error white-saas-generator-error-hidden">'+s.langText.error_all+'</small></div><div class="white-saas-generator-group"><div class="white-saas-generator-label-agreement"><span style="margin-top: -15px;font-size: 9px;position: relative;display: block;">'+s.langText.email_agreement_text_agreement+'</span></div></div><div class="white-saas-generator-buttons"><a '+s.actionUrlLinkHrefText+'  class="white-saas-generator-btn-success ym-disable-clickmap">'+s.langText.btn_success_text+"</a>"+(s.langText.btn_cancel_text?'<a href="javascript:void(0)" class="white-saas-generator-btn-cancel">'+s.langText.btn_cancel_text+"</a>":"")+'</div><div class="white-saas-generator-copyright"><a href="#" class="white-saas-generator-copyright-url" target="_blank" data-widget="generator">'+s.langText.text_link+"</a></div></div></div></div>"
}},log:function(mess){wsUtil.log("GENERATOR : "+mess)}}}(jWS),wsChat=function($){var _this,s,t,w,_debug;return{settings:{},temps.settings,t=this.templates,w=this.widget,$.fn._frameCheck()&&"undefined"==typeof WBK&&(WBK=document.WBK),_debug=WBK.checkDebug(),_this.loader(data)},loader:function(res){var data=res.Data.chat;if(_this.setSettings(data),WBK.settings.chatWidgetId=parseInt(res.Settings.chatWidgetId),WBK.settings.chatEnabled=!0,WBK.settings.chatId=!!data.chatId&&parseInt(data.chatId),s.all_operators=data.users?data.users:{},s.chat_operators=data.chatUsers?data.chatUsers:{},s.free_chat_widget=parseInt(s.free_chat_widget),data.auto_call&&(s.autoCall=parseInt(data.auto_call)),data.auto_call_text&&(s.autoCallText=data.auto_call_text),data.auto_call_deffered&&(s.autoCallDeffered=parseInt(data.auto_call_deffered)),data.auto_call_deffered_delay&&(s.autoCallDefferedDelay=parseInt(data.auto_call_deffered_delay)),s.free_chat_widget&&_debug&&_this.log("Бесплатная версия чата"),parseInt(s.always_online)&&!s.free_chat_widget&&$.each(s.all_operators,function(index,value){s.all_operators[index].status=1}),s.chat_is_online=_this.operatorsIsOnline(),s.partnerLink||(s.partnerLink="http://"+WBK.settings.servicedomain+"?utm_source=widget&utm_medium=self&utm_campaign="+location.hostname+"&utm_content=chat&utm_term="),s.widget_logo=parseInt(data.img_logo),s.img_robot_logo=parseInt(data.img_robot_logo),s.img_robot_logo_service=parseInt(data.img_robot_logo_service),s.chat_widget_logo=WBK.settings.staticServerUrl+"/widget/img/chat_robot.png",s.chat_widget_logo_robot=s.chat_widget_logo,s.img_robot_logo_service){var d=new Date;s.chat_widget_logo_robot=WBK.settings.staticServerUrl+"/uploaded/chat_widgets_service/"+WBK.settings.serviceid+"/logo_robot.png?"+d.getTime()}if(s.img_robot_logo){var d=new Date;s.chat_widget_logo_robot=WBK.settings.staticServerUrl+"/uploaded/chat_widgets/"+WBK.settings.chatWidgetId+"/logo_robot.png?"+d.getTime()}if(s.widget_logo){var d=new Date;s.chat_widget_logo=WBK.settings.staticServerUrl+"/uploaded/chat_widgets/"+WBK.settings.chatWidgetId+"/logo.png?"+d.getTime()}switch(s.btn_corner_class="",s.corner_type){case"smooth":s.btn_corner_class="ws-chat-btn-mini-round";break;case"flat":s.btn_corner_class="";break;case"round":s.btn_corner_class="ws-chat-btn-round"}s.auto_reply_not_connected_and_operators_offline_need_to_show=!1,s.disableMobileOpenHash=parseInt(data.disable_mobile_open_hash),_this.updateUser(),_this.setTemplate(),_this.initWidget()},initWidget:function(){WBK.loadFont(),WBK.addStyles(".ws-chat-message-manager .ws-chat-message, .ws-chat-message-robot .ws-chat-message, .ws-chat-message-manager:before, .ws-chat-message-robot:before{background-color: "+s.color_background_message_operator+" !important;}.ws-chat-message-user .ws-chat-message, .ws-chat-message-user:before{background-color: "+s.color_background_message_user+" !important;}.ws-chat-message-manager .ws-chat-message-source, .ws-chat-message-manager .ws-chat-message-date, .ws-chat-message-robot .ws-chat-message-source, .ws-chat-message-robot .ws-chat-message-date{color: "+s.color_text_message_operator+" !important;}.ws-chat-message-user .ws-chat-message-source, .ws-chat-message-user .ws-chat-message-date{color: "+s.color_text_message_user+" !important;}.ws-chat .ws-chat-container .ws-chat-message-user .ws-chat-message-source .ws-chat-message-link, .ws-chat .ws-chat-container .ws-chat-message-user .ws-chat-message-source .ws-chat-message-link:visited, .ws-chat .ws-chat-container .ws-chat-message-user .ws-chat-message-source .ws-chat-message-link:active{color: "+s.color_text_message_user+" !important;}.ws-chat .ws-chat-container .ws-chat-message-user .ws-chat-message-source .ws-chat-message-link:hover{color: "+s.color_text_message_user+" !important;}.ws-chat .ws-chat-container {background-color: "+s.color_background_window+" !important;}.ws-chat .ws-chat-container:before {background-color: "+s.color_background_window+" !important;}.ws-chat .ws-chat-invitation-container{background-color: "+s.color_background_invitation+" !important;}.ws-chat .ws-chat-invitation-text{background-color: "+s.color_background_invitation_message+" !important;}.ws-chat .ws-chat-invitation-body-text:before{background-color: "+s.color_background_invitation_message+" !important;}.ws-chat .ws-chat-invitation-input{background-color: "+s.color_background_invitation_input+" !important;}.ws-chat .ws-chat-invitation-name{color: "+s.color_text_invitation+" !important;}.ws-chat .ws-chat-invitation-position{color: "+s.color_text_invitation+" !important;}.ws-chat .ws-chat-invitation-container .ws-icon-close{color: "+s.color_text_invitation+" !important;}.ws-chat .ws-chat-invitation-typing{color: "+s.color_text_invitation+" !important;}.ws-chat .ws-chat-invitation-container .ws-chat-invitation-body .ws-chat-invitation-body-el .ws-chat-invitation-text{color: "+s.color_text_invitation_message+" !important;}.ws-chat .ws-chat-invitation-container .ws-chat-invitation-body .ws-chat-invitation-body-el .ws-chat-invitation-text a{color: "+s.color_text_invitation_message+" !important; text-decoration: underline !important;}"),w.container=$(t),w.window=w.container.find(".ws-chat-container").hide(),w.btn=w.container.find(".ws-chat-btn-container").hide(),w.btn_el=w.container.find(".ws-chat-btn-el-container"),w.invitation=w.container.find(".ws-chat-invitation-container").hide(),w.container.appendTo("body"),wsUtil.fixFastClick();var title=s.text_button_online;"pc"!=WBK.settings.device?(w.container.addClass("ws-chat-mobile"),title=s.mobile_text_button_online,WBK.addStyles(".ws-chat .ws-chat-btn-container{background: "+s.mobile_color_background_button+"!important;}.ws-chat .ws-chat-btn-container .ws-btn-title{color: "+s.mobile_color_background_button_text+"!important;}")):(w.btn.addClass(s.btn_corner_class),WBK.addStyles(".ws-chat .ws-chat-btn-container{background: "+s.color_background_button+"!important;}.ws-chat .ws-chat-btn-container .ws-btn-title{color: "+s.color_background_button_text+"!important;}"),w.btn.find(".ws-btn-title").html(title)),s.widget_logo&&(w.window.addClass("ws-chat-logo-yes"),w.btn.addClass("ws-chat-btn-logo-yes")),(s.img_robot_logo||s.img_robot_logo_service)&&w.window.addClass("ws-chat-logo-robot-yes");var sound=wsUtil.getCookie("WidgetChat_sound_"+WBK.settings.chatWidgetId);if(sound?(s.sound=sound,"off"==s.sound?(w.window.find(".ws-chat-sound").attr("title",s.lang_text.sound_on),w.window.find(".ws-chat-sound i").removeClass("ws-icon-sound-on").addClass("ws-icon-sound-off")):(w.window.find(".ws-chat-sound").attr("title",s.lang_text.sound_off),w.window.find(".ws-chat-sound i").removeClass("ws-icon-sound-off").addClass("ws-icon-sound-on"))):"off"==s.sound&&(w.window.find(".ws-chat-sound").attr("title",s.lang_text.sound_on),w.window.find(".ws-chat-sound i").removeClass("ws-icon-sound-on").addClass("ws-icon-sound-off")),WBK.settings.hideCopyright?$(".ws-chat-copyright").hide():$("body").on("click",".ws-chat-copyright-url",function(e){WBK.sendAdvertLinkStat($(this).data("widget"),$(this).attr("href"),$(this).text(),WBK.settings.chatWidgetId)}),_this.loadBtnEvents(),_this.loadWindowEvents(),s.messages_quant_to_rate=0,s.chat_is_online)WBK.settings.chatId&&s.messages?(_this.addOldMessages(),_this.operatorsUpdate(),_this.start()):(s.operators_array.length&&"robot"!==s.hello_message_author?_this.showHelloMessageOperators():_this.showHelloMessage(),s.is_first_message=!0,s.send_autoreply_first=!0),_this.initRating(),_this.checkRatingSettings();else{if("hide"==s.operator_offline_action)return _debug&&_this.log("Операторы онлайн и отключена оффлайн форма"),void _this.showOffline();_this.showOffline()}_this.initBtnPosition(),_this.smilesInit(),WBK.settings.chatId||"hide"==s.button_location||"pc"!=WBK.settings.device&&parseInt(s.hide_mobile)||_this.checkInvitation(),s.chat_invitation_has_scroll_rule&&$(window).on("scroll.callbackkillerchat",ementLink&&w.window.find(".ws-chat-agreement-link").attr("href",s.agreementLink);var _h;if(!$.fn._frameCheck()||"undefined"!=typeof WBK)try{_h=window.top.location.hash}catch(error){}wsUtil.getCookie("WidgetChat_opened_"+WBK.settings.chatWidgetId)&&wsUtil.getCookie("WidgetChat_settings_"+WBK.settings.chatWidgetId)&&s.chat_is_online?_this.showWidget():"#showchat"===_h?(_this.initWindowPosition(),_this.showWidget(),_this.sendGoal("open")):(w.btn.css("display","flex"),WBK.settings.chatBtnOpened=!0,wsUtil.getCookie("WidgetChat_opened_"+WBK.settings.chatWidgetId)&&wsUtil.deleteCookie("WidgetChat_opened_"+WBK.settings.chatWidgetId),_this.initWindowPosition(),"hide"==s.button_location&&"pc"==WBK.settings.device&&(w.btn.hide(),WBK.settings.chatBtnOpened=!1)),"pc"==WBK.settings.device||s.disableMobileOpenHash||$(window).on("hashchange",function(e){"-1"!=e.originalEvent.oldURL.search("#chatIsShown")&&(_this.hideWidget(),window.location.hash="")})},onScroll:function(){wsUtil.setTimeout("scrollTimerChat",function(){_this.checkInvitation()},250)},showBtn:function(){w.btn.css("display","flex"),"horizontal"==s.button_location&&WBK.animateFastOnce(w.btn,"cbk-zoomIn"),WBK.settings.chatBtnOpened=!0},hideBtn:function(){w.btn.hide(),WBK.animateFastOnce(w.btn,"cbk-zoomOut"),WBK.settings.chatBtnOpened=!1},showWidget:function(){_this.hideBtn(),WBK.settings.chatInvitationOpened&&_this.hideInvitation(),WBK.settings.windowInvaderOpened&&(wsInvader.widget.window.find(".cbk-support-new-message-copyright").hide(),wsInvader.widget.window.hide());var d=new Date;if(d.setMinutes(d.getMinutes()+1440),wsUtil.setCookie("WidgetChat_opened_"+WBK.settings.chatWidgetId,!0,d),s.chat_is_online&&"pc"==WBK.settings.device&&wsUtil.getCookie("WidgetChat_settings_"+WBK.settings.chatWidgetId)){var data=JSON.parse(wsUtil.getCookie("WidgetChat_settings_"+WBK.settings.chatWidgetId));w.window.css({top:data.top,left:data.left,width:data.width,height:data.height})}"pc"!=WBK.settings.device&&(s.scroll_left=$(window).scrollLeft(),s.scroll_top=$(window).scrollTop(),$("meta[name=viewport]").length?(w.window.data("oldViewport",$("meta[name=viewport]").last().attr("content")),$("meta[name=viewport]").remove()):w.window.data("noViewport",1),$("head").append($("<meta>").attr("name","viewport").attr("content","width=device-width, user-scalable=0, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0")),$("body").addClass("cbk-body-mobile"),s.unread_messages_count&&_this.setUnreadMessages(0),s.disableMobileOpenHash||(window.location.hash="chatIsShown"));var d=new Date;if(d.setMinutes(d.getMinutes()+144e3),wsUtil.setCookie("WidgetChat_shownOn",s.chat_is_online?"on_btn":"on_btn_offline",d),w.window.show(),"pc"==WBK.settings.device&&WBK.animateFastOnce(w.window,"cbk-zoomIn"),WBK.settings.chatWindowOpened=!0,s.chat_is_online&&"pc"==WBK.settings.device&&w.window.find(".ws-textarea").focus(),s.chatId&&s.chat_created){var hash=(new Date).getTime();_this.sendNode(JSON.stringify(""),hash,"open_window")}else{var lastInvitationId=wsUtil.getStorage("WidgetChat_last_shown_invitation_id");if(WBK.settings.chatInvitationShown){var d=new Date;d.setMinutes(d.getMinutes()+144e3),wsUtil.setCookie("WidgetChat_shownOn",s.chat_is_online?"on_inv":"on_inv_offline",d)}if(!WBK.settings.chatInvitationShown&&lastInvitationId&&s.invitations){WBK.settings.chatInvitationShown=!0;var invitation_id=!1;if($.each(s.invitations,function(k,val){s.invitations[k].id==lastInvitationId&&(invitation_id=k)}),invitation_id!==!1&&(s.invitation_operator_id=_this.getOperatorIdForInvitation(invitation_id),s.invitations[invitation_id]=_this.formatInvitation(s.invitations[invitation_id]),s.chat_is_online&&parseInt(s.invitations[invitation_id].invitation_always))){var operator_arr=s.invitation_operator_id.split("_");s.invitation_show_data={user_id:operator_arr[0],employee_id:operator_arr[1],invitation_id:s.invitations[invitation_id].id,hello_text:s.invitations[invitation_id].hello_text,text1:s.invitations[invitation_id].text1,text2:s.invitations[invitation_id].text2,ai_invitation_id:s.invitations[invitation_id].ai_invitation_id};var data={hash:!1,message:"",date:"",user:s.invitation_operator_id,is_read:!0,message_type:"text",type:"manager",scroll:!1};w.window.find(".ws-chat-robot-hello, .ws-chat-manager-hello, .ws-chat-message-block").remove(),s.invitations[invitation_id].hello_text&&(data.message={text:s.invitations[invitation_id].hello_text},_this.addMessage(data)),s.invitations[invitation_id].text1&&(data.message={text:s.invitations[invitation_id].text1},data.date="",_this.addMessage(data)),s.invitations[invitation_id].text2&&(data.message={text:s.invitations[invitation_id].text2},data.date="",_this.addMessage(data))}}}_this.sendShowType(),w.window.find(".ws-chat-body").nanoScroller({scroll:"bottom",contentClass:"ws-chat-body-content",paneClass:"ws-chat-body-pane",sliderClass:"ws-chat-body-slider ",preventPageScrolling:!0}),w.window.find(".ws-textarea-group").nanoScroller({scroll:"bottom",contentClass:"ws-textarea",paneClass:"ws-textarea-pane",sliderClass:"ws-textarea-slider ",preventPageScrolling:!0}),wsUtil.fixBootstrap()},sendShowType:function(){var url=WBK.settings.serverUrl+"/api?action=chatNewShow&callback=?";$.getJSON(url,{type_show:wsUtil.getCookie("WidgetChat_shownOn"),status:s.chat_is_online?1:0,device:WBK.settings.device,code:WBK.settings.whiteSaasCode,googleClientId:wsUtil.getGoogleClientId(),chatId:WBK.settings.chatWidgetId,visitorId:WBK.settings.visitorId,advertiseId:wsUtil.getAdvertiseId(),calltrackingId:wsUtil.getCalltrackingId(),lpgeneratorId:wsUtil.getLPGeneratorId(),leadvertexId:wsUtil.getLeadvertexId(),externalParams:wsUtil.getExternalParams()})},hideWidget:function(){w.window.hide(),WBK.animateFastOnce(w.window,"cbk-zoomOut"),WBK.settings.chatWindowOpened=!1;var d=new Date;if(d.setMinutes(d.getMinutes()+144e3),wsUtil.deleteCookie("WidgetChat_opened_"+WBK.settings.chatWidgetId),"pc"!=WBK.settings.device&&(w.window.data("noViewport")?(w.window.data("noViewport",0),$("meta[name=viewport]").attr("content","")):$("meta[name=viewport]").attr("content",w.window.data("oldViewport")),$("body").removeClass("cbk-body-mobile"),$(window).scrollTop(s.scroll_top),$(window).scrollLeft(s.scroll_left)),"hide"!=s.button_location&&_this.showBtn(),s.chat_created){var hash=(new Date).getTime();_this.sendNode(JSON.stringify(""),hash,"close_window")}if(!s.chat_is_online){var body_offline=w.window.find(".ws-chat-body-offline");body_offline.children().not(".ws-hide").show(),body_offline.find(".ws-chat-offline-text-success").hide(),wsUtil.deleteTimeout("chatOfflineHide")}WBK.settings.multiButtonId&&wsMultiButton.reInitWidget(),WBK.settings.chatWindowOpened||WBK.settings.windowOpened||WBK.settings.windowQuizOpened||WBK.settings.windowGeneratorOpened||WBK.settings.videoWidgetOpened||jWS(window).trigger("envy:resize")},checkInvitation:function(from){if(!s.invitations||parseInt(s.free_chat_widget))return void(_debug&&_this.log("Нет автоприглашении или бесплатная версия"));_debug&&_this.log("Проверяем автоприглашения");for(var key=0;key<s.invitations.length;key++)if(wsUtil.getCookie("WidgetChat_invitation_"+s.invitations[key].id))_debug&&_this.log("автоприглашение № "+s.invitations[key].id+" уже было показано");else if(s.invitations[key].rules.length){var count_false=0,count_true=0,count_time_true=0,timeout=1,timeouts=[],url=decodeURIComponent(window.location.toString());url||(url=window.location.toString()),$.each(s.invitations[key].rules,function(k,val){switch(val.name){case"rule_url":switch(parseInt(val.type)){case 0:url.indexOf(val.value)+1?count_true++:count_false++;break;case 1:url.indexOf(val.value)+1==0?count_true++:count_false++;break;case 2:url==val.value?count_true++:count_false++;break;case 3:var regex=new RegExp(val.value,"gi");regex.test(url)?count_true++:count_false++;break;case 4:url!=val.value?count_true++:count_false++}break;case"rule_time":timeouts.push(parseInt(val.value)),count_time_true++;break;case"rule_time_site":var time_site=wsUtil.getCookie("WhiteCallback_timeAll")?parseInt(wsUtil.getCookie("WhiteCallback_timeAll")):1,timeout_site=parseInt(val.value)-time_site;timeouts.push(timeout_site>1?timeout_site:1),count_time_true++;break;case"rule_time_close_chat":var time_close=_this.getTimeClosedChat();time_close?(time_close=(new Date).setTime(time_close),time_close=parseInt(val.value)-((new Date).getTime()-time_close)/1e3,timeouts.push(time_close>1?time_close:1)):timeouts.push(1),count_time_true++;break;case"rule_operator":s.chat_is_online?"offline"==val.value?count_false++:count_true++:"online"==val.value?count_false++:count_true++;break;case"rule_visit_count":var visit_count=WBK.getVisitCount();switch(parseInt(val.type)){case 0:parseInt(val.value)==visit_count?count_true++:count_false++;break;case 1:parseInt(val.value)<visit_count?count_true++:count_false++;break;case 2:parseInt(val.value)>visit_count?count_true++:count_false++}break;case"rule_page_show_count":var page_show_count=WBK.getPageShowCount();switch(parseInt(val.type)){case 0:parseInt(val.value)==page_show_count?count_true++:count_false++;break;case 1:parseInt(val.value)<page_show_count?count_true++:count_false++;break;case 2:parseInt(val.value)>page_show_count?count_true++:count_false++}break;case"rule_scroll":var scroll=$(window).scrollTop(),scrollH=$(document).height()-$(window).height(),scrolled=scroll/scrollH*100;parseInt(val.value)<=scrolled?count_true++:count_false++;break;case"rule_name":"known"===val.value?WBK.settings.visitorName?count_true++:count_false++:WBK.settings.visitorName?count_false++:count_true++;break;case"rule_device":parseInt(val.type)?WBK.settings.device==val.value?count_true++:count_false++:WBK.settings.device!=val.value?count_true++:count_false++}}),count_false&&_debug&&_this.log("Не выполнены условия показа автоприглашения № "+s.invitations[key].id),"all"==s.invitations[key].check&&0==count_false&&(_debug&&_this.log("Выполнены все правила показа автоприглашения № "+s.invitations[key].id),timeouts.length>0&&(timeout=Math.max.apply(null,timeouts)),_debug&&_this.log("Показ автоприглашения через: "+timeout),_this.checkNeedGenerateOrShowInvitation(key,timeout,from)),"one"==s.invitations[key].check&&(count_true>0||count_time_true>0)&&(_debug&&_this.log("Выполнено 1 правило показа автоприглашения № "+s.invitations[key].id),count_true>0?timeout=1:timeouts.length>0&&(timeout=Math.min.apply(null,timeouts)),_debug&&_this.log("Показ автоприглашения через: "+timeout),_this.checkNeedGenerateOrShowInvitation(key,timeout,from))}else _this.checkNeedGenerateOrShowInvitation(key,1,from)},checkNeedGenerateOrShowInvitation:function(key,timeout,from){parseInt(s.invitations[key].ai_generated_text_enabled)?_this.getGeneratedAiInvitation(key,timeout,from):_this.showInvitation(key,timeout,from)},setGeneratedTextToPareationKey].hello_text=aiInvitation.hello_text,s.invitations[invitationKey].text1=aiInvitation.main_text,s.invitations[invitationKey].text2=aiInvitation.call_to_action_text,s.invitations[invitationKey].ai_invitation_id=aiInvitation.id,s.invitations[invitationKey].generated=!0},getGeneratedAiInvitation:function(invitationKey,timeout,from){var generationKeywords=document.querySelector('meta[name="keywords"]')?document.querySelector('meta[name="keywords"]').content:"";generationKeywords||(generationKeywords=document.querySelector("title")?document.querySelector("title").textContent:"");var data={invitation_id:s.invitations[invitationKey].id,generation_params:{keywords:generationKeywords,description:document.querySelector('meta[name="description"]')?document.querySelector('meta[name="description"]').content:"",name:WBK.settings.visitorName?WBK.settings.visitorName:""}},url=WBK.settings.serverUrl+"/api?action=chatGetAiInvitation";jWS.post(url,{code:WBK.settings.whiteSaasCode,data:data,visitorId:WBK.settings.visitorId},function(result){result&&result.Success&&result.Data&&(_this.setGeneratedTextToParentInvitation(result.Data.ai_invitation,invitationKey),_this.showInvitation(invitationKey,timeout,from))},"json")},hideInvitation:function(){WBK.settings.chatInvitationOpened=!1,w.invitation.hide()},getOperatorIdForInvitation:function(invitation_id){var operator_id=!1,saved_operator_id=wsUtil.getStorage("WidgetChat_invitation_operator_id"),invitation_operators=s.operators_id;return s.chat_is_online&&(invitation_operators=s.operators_online_id),saved_operator_id&&(s.all_operators.hasOwnProperty(saved_operator_id)||(saved_operator_id=!1)),"operator"==s.invitations[invitation_id].operator_type?(operator_id=s.invitations[invitation_id].operator_id,s.all_operators.hasOwnProperty(operator_id)||(operator_id=saved_operator_id?saved_operator_id:invitation_operators[wsUtil.getRandomArbitrary(0,invitation_operators.length-1)])):operator_id=saved_operator_id?saved_operator_id:invitation_operators[wsUtil.getRandomArbitrary(0,invitation_operators.length-1)],wsUtil.setStorage("WidgetChat_invitation_operator_id",operator_id),operator_id},showInvitationByName:function(invitation_name){for(var invitation_id,key=0;key<s.invitations.length;key++)s.invitations[key].name==invitation_name&&(invitation_id=key);this.hideInvitation(),WBK.settings.chatInvitationShown=!1,s.show_one_invitation=!1,w.invitation.find(".ws-chat-invitation-logo").text(""),w.invitation.find(".ws-chat-invitation-name, .ws-chat-invitation-position, .ws-chat-invitation-text, .ws-chat-invitation-typing").remove(),this.checkNeedGenerateOrShowInvitation(invitation_id,1)},showInvitation:function(invitation_id,timeout,from){if(!(WBK.settings.chatId||WBK.settings.chatWindowOpened||s.show_one_invitation||wsUtil.getCookie("WidgetChat_invitation_planed_"+s.invitations[invitation_id].id)&&s.chat_invitation_has_scroll_rule)){if(s.chat_invitation_has_scroll_rule){var t=new Date;t.setSeconds(t.getSeconds()+timeout+2),wsUtil.setCookie("WidgetChat_invitation_planed_"+s.invitations[invitation_id].id,"true",t)}wsUtil.setInterval("invitationShow_"+invitation_id,function(){if(!(WBK.settings.chatInvitationOpened||WBK.settings.windowGeneratorOpened||WBK.settings.videoWidgetOpened||WBK.settings.windowQuizOpened||WBK.settings.windowLoanerOpened||WBK.settings.windowInvaderOpened||WBK.settings.windowOpened||WBK.settings.chatId||WBK.settings.chatWindowOpened||s.show_one_invitation||WBK.settings.multiButtonVariantsOpened)){wsUtil.setStorage("WidgetChat_last_shown_invitation_id",s.invitations[invitation_id].id),WBK.settings.chatInvitationOpened=!0,WBK.settings.chatInvitationShown=!0,s.show_one_invitation=!0;for(var key=0;key<s.invitations.length;key++)wsUtil.deleteInterval("invitationShow_"+key);var d=new Date;"minutes"==s.invitations[invitation_id].repeat_type?d.setMinutes(d.getMinutes()+parseInt(s.invitations[invitation_id].repeat_time)):"days"==s.invitations[invitation_id].repeat_type&&d.setDate(d.getDate()+parseInt(s.invitations[invitation_id].repeat_time)),wsUtil.setCookie("WidgetChat_invitation_"+s.invitations[invitation_id].id,"true",d),wsUtil.deleteCookie("WidgetChat_invitation_planed_"+s.invitations[invitation_id].id),s.invitation_operator_id=_this.getOperatorIdForInvitation(invitation_id);var operator_id=s.invitation_operator_id;if(s.invitations[invitation_id]=_this.formatInvitation(s.invitations[invitation_id]),s.chat_is_online){var operator_arr=operator_id.split("_");s.invitation_show_data={user_id:operator_arr[0],employee_id:operator_arr[1],invitation_id:s.invitations[invitation_id].id,hello_text:s.invitations[invitation_id].hello_text,text1:s.invitations[invitation_id].text1,text2:s.invitations[invitation_id].text2,ai_invitation_id:s.invitations[invitation_id].ai_invitation_id};var data={hash:!1,message:"",date:"",user:operator_id,is_read:!0,message_type:"text",type:"manager",scroll:!1};w.window.find(".ws-chat-robot-hello, .ws-chat-manager-hello, .ws-chat-message-block").remove(),s.invitations[invitation_id].hello_text&&(data.message={text:s.invitations[invitation_id].hello_text},_this.addMessage(data)),s.invitations[invitation_id].text1&&(data.message={text:s.invitations[invitation_id].text1},data.date="",_this.addMessage(data)),s.invitations[invitation_id].text2&&(data.message={text:s.invitations[invitation_id].text2},data.date="",_this.addMessage(data))}if("open_chat"==s.invitations[invitation_id].action)return void _this.showWidget();w.invitation.find(".ws-chat-invitation-logo").append('<img class="ws-chat-invitation-img" src="'+WBK.settings.staticServerUrl+s.users[operator_id].img+'">');var name=s.users[operator_id].name+(s.users[operator_id].surname?" "+s.users[operator_id].surname:""),profession=s.users[operator_id].profession?s.users[operator_id].profession:"";if(w.invitation.hasClass("from-multi-button")&&(profession||w.invitation.find(".ws-chat-invitation-body-el").addClass("multi-button-no-profession")),w.invitation.find(".ws-chat-invitation-body-text").before('<div class="ws-chat-invitation-name">'+name+'</div><div class="ws-chat-invitation-position">'+profession+"</div>"),w.invitation.find(".ws-chat-invitation-body-text").append('<div class="ws-chat-invitation-text-box"><div class="ws-chat-invitation-text">'+s.invitations[invitation_id].hello_text+"</div></div>"),"undefined"!=typeof from&&"multi_button"==from&&(wsMultiButton.stopTimer(),$.each(wsMultiButton.settings.checked_variants,function(index,value){if(value.show_autoreply_icon)return wsMultiButton.showIconVariant(index),!1}),wsMultiButton.settings.animation_type&&$(".multi_button").removeClass("bouncing"),wsMultiButton.settings.text_tip&&$(".multi_button-main-div-text .multi_button-text").hide()),w.invitation.show(),parseInt(s.invitations[invitation_id].autoinvite_play_sound)&&_this.playSound("message"),WBK.animateFastOnce(w.invitation,"cbk-zoomIn"),s.invitations[invitation_id].text1){var typing=$('<div class="ws-chat-invitation-typing"><span class="ws-chat-typing-action"><i class="ws-icon-typing"></i></span><span class="ws-chat-invitation-typing-name">'+name+"</span> "+s.lang_text.typing+"...</div>");w.invitation.find(".ws-chat-invitation-body-text").append(typing.fadeIn()),wsUtil.setTimeout("invitationMessageTimer",function(){w.invitation.find(".ws-chat-invitation-typing").fadeOut(function(){$(this).remove()}),s.invitations[invitation_id].text1&&($(this).remove(),w.invitation.find(".ws-chat-invitation-body-text").append('<div class="ws-chat-invitation-text-box"><div class="ws-chat-invitation-text">'+s.invitations[invitation_id].text1+"</div></div>")),s.invitations[invitation_id].text2&&wsUtil.setTimeout("invitationMessageTimer",function(){w.invitation.find(".ws-chat-invitation-body-text").append(typing.fadeIn()),wsUtil.setTimeout("invitationMessageTimer",function(){w.invitation.find(".ws-chat-invitation-typing").fadeOut(function(){$(this).remove()}),wsUtil.setTimeout("invitationMessageTimer",function(){w.invitation.find(".ws-chat-invitation-body-text").append(typing.fadeIn()),wsUtil.setTimeout("invitationMessageTimer",function(){w.invitation.find(".ws-chat-invitation-typing").fadeOut(function(){$(this).remove(),s.invitations[invitation_id].text2&&w.invitation.find(".ws-chat-invitation-body-text").append('<div class="ws-chat-invitation-text-box"><div class="ws-chat-invitation-text">'+s.invitations[invitation_id].text2+"</div></div>"),"undefined"!=typeof from&&"multi_button"===from&&wsUtil.setTimeout("invitationAutoHideMultibutton",function(){_this.hideInvitation(),wsMultiButton.reInitWidget(),wsMultiButton.settings.text_tip&&$(".multi_button-main-div-text .multi_button-text").show()},15e3)})},wsUtil.specialChars(s.invitations[invitation_id].text2).length/2*110)},2500),w.invitation.find(".ws-chat-invitation-typing").fadeOut(function(){$(this).remove(),s.invitations[invitation_id].text2&&w.invitation.find(".ws-chat-invitation-body-text").append('<div class="ws-chat-invitation-text-box"><div class="ws-chat-invitation-text">'+s.invitations[invitation_id].text2+"</div></div>")})},wsUtil.specialChars(s.invitations[invitation_id].text2).length/2*110)},2500)},110*wsUtil.specialChars(s.invitations[invitation_id].text1).length)}}},1e3*timeout)}},formatInvitation:function(invitation){if(invitation.hello_text=WBK.formatText(invitation.hello_text),invitation.text1=WBK.formatText(invitation.text1),invitation.text2=WBK.formatText(invitation.text2),WBK.settings.geoCity){WBK.settings.geoCity.name||(WBK.settings.geoCity.name=WBK.settings.geoCity.ip_city);var visitorName="";WBK.settings.visitorName&&(visitorName=WBK.settings.visitorName),invitation.hello_text=invitation.hello_text.replace(/\[geocity1\]/g,WBK.settings.geoCity.name),invitation.hello_text=invitation.hello_text.replace(/\[geocity2\]/g,WBK.settings.geoCity.name_rod),invitation.hello_text=invitation.hello_text.replace(/\[geocity3\]/g,WBK.settings.geoCity.name_mes),invitation.hello_text=invitation.hello_text.replace(/\[geocity4\]/g,WBK.settings.geoCity.name_vin),invitation.hello_text=invitation.hello_text.replace(/\[name\]/g,visitorName),invitation.hello_text=invitation.hello_text.replace(/\[(.+?)\|(.+?)\]/gi,"<a href='$1' target='_blank'>$2</a>"),invitation.text1=invitation.text1.replace(/\[geocity1\]/g,WBK.settings.geoCity.name),invitation.text1=invitation.text1.replace(/\[geocity2\]/g,WBK.settings.geoCity.name_rod),invitation.text1=invitation.text1.replace(/\[geocity3\]/g,WBK.settings.geoCity.name_mes),invitation.text1=invitation.text1.replace(/\[geocity4\]/g,WBK.settings.geoCity.name_vin),invitation.text1=invitation.text1.replace(/\[name\]/g,visitorName),invitation.text1=invitation.text1.replace(/\[(.+?)\|(.+?)\]/gi,"<a href='$1' target='_blank'>$2</a>"),invitation.text2=invitation.text2.replace(/\[geocity1\]/g,WBK.settings.geoCity.name),invitation.text2=invitation.text2.replace(/\[geocity2\]/g,WBK.settings.geoCity.name_rod),invitation.text2=invitation.text2.replace(/\[geocity3\]/g,WBK.settings.geoCity.name_mes),invitation.text2=invitation.text2.replace(/\[geocity4\]/g,WBK.settings.geoCity.name_vin),invitation.text2=invitation.text2.replace(/\[name\]/g,visitorName),invitation.text2=invitation.text2.replace(/\[(.+?)\|(.+?)\]/gi,"<a href='$1' target='_blank'>$2</a>")}return invitation.hello_text=this.smileReplacer(invitation.hello_text,"to_img"),invitation.text1=this.smileReplacer(invitation.text1,"to_img"),invitation.text2=this.smileReplacer(invitation.text2,"to_img"),invitation},smileReplacer:function(text,type){return text?($.each(s.smilesCodes,function(key,value){if("to_img"==type){var reg=new RegExp(value,"g");text=text.replace(reg,'<img class="emoji-img" src="'+WBK.settings.staticServerUrl+"/widget/img/smiles/"+key+'.png">')}if("to_code"==type){var reg=new RegExp('<img class="emoji-img" src="'+WBK.settings.staticServerUrl+"/widget/img/smiles/"+key+'.png">',"g");text=text.replace(reg,value)}}),text):""},smilesInit:function(){var smile_container=w.window.find(".ws-smile-container");$.each(s.smilesCodes,function(key,value){smile_container.append('<a class="ws-emoji-el" href="#"><img class="emoji-img" src="'+WBK.settings.staticServerUrl+"/widget/img/smiles/"+key+'.png"></a>')}),w.window.find(".ws-emoji-el").on("click",function(e){e.preventDefault(),s.chat_is_online?(w.window.find(".ws-textarea").focus(),_this.insertHTML($(this).html())):w.window.find(".ws-offline-textarea").append($(this).html()),w.window.find(".ws-textarea-send-btn").show()})},showOffline:function(){w.window.addClass("ws-chat-offline"),w.btn.find(".ws-chat-status-online").removeClass("ws-chat-status-online"),"pc"!=WBK.settings.device?w.btn.find(".ws-btn-title").text(s.mobile_text_button_offline):w.btn.find(".ws-btn-title").text(s.text_button_offline),w.window.find(".ws-chat-title").text(s.text_button_offline),w.window.find(".ws-chat-body").hide(),w.window.find(".ws-chat-footer").hide(),w.window.find(".ws-chat-status-online").removeClass("ws-chat-status-online"),w.window.find(".ws-chat-body-offline").show(),WBK.setPhoneInputFocusForm($(".ws-offline-phone"))},chatAutoCall:function(phone,phoneMask){if(phone&&s.autoCall&&WBK.settings.callbackEnabled){wsKiller.settings.callingWidget=!0;var d=new Date;
d.setMinutes(d.getMinutes()+144e3),wsUtil.setCookie("WhiteCallback_shownOn","onchat",d),WBK.settings.phoneMask=phoneMask,wsKiller.newCall(phone,!1,s.autoCallDeffered,s.autoCallDefferedDelay)}},sendOfflineMessage:function(){if(!s.offline_message_sending){s.offline_message_sending=!0;var offline_body=w.window.find(".ws-chat-body-offline");offline_body.find(".ws-offline-textarea").removeClass("ws-input-error"),offline_body.find(".ws-offline-input").removeClass("ws-input-error");var name=offline_body.find(".ws-offline-name").val(),email=offline_body.find(".ws-offline-email").val(),phone=offline_body.find(".ws-offline-phone").val();phone=WBK.checkPhone(phone),phone=phone?phone:"";var phoneMask=offline_body.find(".ws-offline-phone").attr("placeholder"),emailAgreement=$(".ws-offline-email-agreement").is(":checked")?1:0,message=_this.smileReplacer(_this.cleanMessage(offline_body.find(".ws-offline-textarea")),"to_code"),errors_class="";if("yes"==s.get_contact_offline_name&&""==name.trim()&&(errors_class=".ws-offline-name"),"yes"==s.get_contact_offline_phone&&""==phone.trim()&&(errors_class?errors_class+=", .ws-offline-phone":errors_class=".ws-offline-phone"),"yes"!=s.get_contact_offline_email||""!=email.trim()&&wsUtil.validateEmail(email.trim())||(errors_class?errors_class+=", .ws-offline-email":errors_class=".ws-offline-email"),"yes"==s.get_contact_offline_message&&""==message.trim()&&(errors_class?errors_class+=", .ws-offline-textarea":errors_class=".ws-offline-textarea"),errors_class)return w.window.find(errors_class).addClass("ws-input-error"),void(s.offline_message_sending=!1);var offline_body=w.window.find(".ws-chat-body-offline");offline_body.children().not(".ws-hide").hide(),offline_body.find(".ws-offline-textarea").text(""),offline_body.find(".ws-chat-offline-text-success").show(),wsUtil.setTimeout("chatOfflineHide",function(){_this.hideWidget()},3e3),s.offline_message_sending=!1;var _d={code:WBK.settings.whiteSaasCode,name:name.trim(),email:email.trim(),phone:phone.trim(),message:message.trim(),emailAgreement:emailAgreement,visitId:WBK.settings.visitId,type_show:wsUtil.getCookie("WidgetChat_shownOn"),chatWidgetId:WBK.settings.chatWidgetId,chatId:WBK.settings.chatId,url:"string"==typeof document.URL?document.URL:"",visitorId:WBK.settings.visitorId,phoneMask:phoneMask,googleClientId:wsUtil.getGoogleClientId(),roistatPromo:wsUtil.getRoistatPromo(),advertiseId:wsUtil.getAdvertiseId(),calltrackingId:wsUtil.getCalltrackingId(),lpgeneratorId:wsUtil.getLPGeneratorId(),leadvertexId:wsUtil.getLeadvertexId(),externalParams:wsUtil.getExternalParams()},url=WBK.settings.serverUrl+"/api?action=chatOfflineMessage&callback=?";jWS.getJSON(url,_d),"function"==typeof window.ws_OnChatOfflineMessage&&window.ws_OnChatOfflineMessage(_d),_this.chatAutoCall(phone.trim(),phoneMask),_this.sendGoal("offline_message")}},showHelloMessage:function(){var hello_message='<div class="ws-chat-manager-join ws-chat-robot-hello"><img src="'+s.chat_widget_logo_robot+'" alt="" class="ws-manager-img"><div class="ws-manager-event" style="color:'+s.color_hello_message+'">'+s.hello_message+"</div></div>";w.window.find(".ws-chat-typing").before(hello_message)},showHelloMessageOperators:function(){s.operators_array.sort(function(a,b){return a=_this.formatTextToDate(a.connected_at),b=_this.formatTextToDate(b.connected_at),a<b?1:a>b?-1:0});var operators_el="";if("last3"===s.hello_message_author)for(var i=0;i<s.operators_array.length;i++){var key=s.operators_array[i].user_id+"_"+s.operators_array[i].employee_id,name=s.all_operators[key].name+(s.all_operators[key].surname?"<br>"+s.all_operators[key].surname:"");if(operators_el+='<div class="ws-chat-manager-hello-el"><img src="'+WBK.settings.staticServerUrl+s.all_operators[key].img+'" class="ws-manager-hello-img"><div class="ws-manager-name">'+name+"</div></div>",2==i)break}else if("operator"===s.hello_message_author){var op_key,operator={};if("rand"===s.hello_message_operator){var operatorsFromRand=[];for(op_key in s.all_operators)s.all_operators.hasOwnProperty(op_key)&&1===s.all_operators[op_key].status&&operatorsFromRand.push(s.all_operators[op_key]);var lucky_operator_number=Math.floor(Math.random()*operatorsFromRand.length);operator=operatorsFromRand[lucky_operator_number]}else{var operatorsFromID=[];for(op_key in s.all_operators)s.all_operators.hasOwnProperty(op_key)&&(operatorsFromID[s.all_operators[op_key].employee_id]=s.all_operators[op_key]);operator=operatorsFromID[s.hello_message_operator]}operators_el+='<div class="ws-chat-manager-hello-el"><img src="'+WBK.settings.staticServerUrl+operator.img+'" class="ws-manager-hello-img"><div class="ws-manager-name">'+operator.name+" "+(operator.surname?operator.surname:"")+"</div></div>"}var hello_message='<div class="ws-chat-manager-join ws-chat-manager-hello"><div class="ws-chat-manager-hello-body">'+operators_el+'</div><div class="ws-manager-event" style="color:'+s.color_hello_message+'">'+s.hello_message+"</div></div>";w.window.find(".ws-chat-typing").before(hello_message)},operatorsUpdate:function(data){var operators_online="";if(data){var user=data.user_id+"_"+data.employee_id;s.all_operators.hasOwnProperty(user)&&(s.all_operators[user].status=data.status)}if(w.window.removeClass("ws-chat-ico-bottom"),w.window.find(".ws-chat-ico-container").empty(),s.chat_operators)for(var key in s.chat_operators)if(s.chat_operators.hasOwnProperty(key)&&"undefined"!=typeof s.all_operators[key]){var name=s.all_operators[key].name+(s.all_operators[key].surname?" "+s.all_operators[key].surname:"");parseInt(s.all_operators[key].status)&&(operators_online+=operators_online?", "+name:name),_this.addIco(s.all_operators[key].user_id+"_"+s.all_operators[key].employee_id,s.all_operators[key].img,name,parseInt(s.all_operators[key].status))}operators_online?w.window.find(".ws-chat-title").text(operators_online):w.window.find(".ws-chat-title").text(s.text_button_online)},addIco:function(user,img_url,name,status){w.window.hasClass(".ws-chat-ico-bottom")||(w.window.addClass("ws-chat-ico-bottom"),w.window.offset().left<100?w.window.addClass("ws-chat-ico-bottom-right"):w.window.removeClass("ws-chat-ico-bottom-right"));var online_class="";status&&(online_class="ws-chat-status-online");var tpl_ico='<div class="ws-chat-ico" id="ico_'+user+'" style="background-color: '+s.color_background_chat_header+';"><div class="ws-chat-logo" data-name="'+name+'"><i class="ws-icon-chat"></i><img src="'+WBK.settings.staticServerUrl+img_url+'" class="ws-chat-logo-img" title="'+name+'"><div class="ws-chat-status-round '+online_class+'"></div></div></div>';w.window.find(".ws-chat-ico-container").append(tpl_ico)},updateIcoBottom:function(user){var container=w.window.find(".ws-chat-ico-container");container.find("#ico_"+user).appendTo(container)},addOldMessages:function(){for(var i=0;i<s.messages.length;i++)if(s.messages[i].message=JSON.parse(s.messages[i].message),"auto_reply"!=s.messages[i].type||s.messages[i].user_id)if("rating"!=s.messages[i].type){var type=s.messages[i].user_id?"manager":"user",user="manager"==type&&s.messages[i].user_id+"_"+s.messages[i].employee_id;_this.addMessage({id:s.messages[i].id,hash:s.messages[i].hash,type:type,message:s.messages[i].message,date:s.messages[i].created_at,user:user,is_read:!!parseInt(s.messages[i].is_read),message_type:s.messages[i].type,scroll:!1}),parseInt(s.messages[i].is_read)||(s.unread_messages[s.messages[i].hash]={id:s.messages[i].id,hash:s.messages[i].hash}),"manager"==type&&(s.last_operator_data={user_id:s.messages[i].user_id,employee_id:s.messages[i].employee_id},s.send_autoreply=!0)}else _this.addMessageRobot(s.messages[i]);else{var res={message:s.messages[i].message.text,type:"auto_reply"};_this.addMessageRobot(res)}},addMessageRobot:function(data){if(data){var message_block="";switch(data.type){case"text":case"auto_reply":if(data.message=wsUtil.specialChars(data.message),data.auto_reply_get_contact){if(!parseInt(s.show_contact_form_inside_chat)){var text_btn=s.autoreplies[data.auto_reply_index].text_btn?s.autoreplies[data.auto_reply_index].text_btn:s.lang_text.autoreply_link;data.message=data.message+'<br><div class="ws-chat-autoreply-link"><a data-index="'+data.auto_reply_index+'" class="ws-chat-autoreply-btn" href="#">'+text_btn+"</a></div>"}var cookieDate=new Date;cookieDate.setMinutes(cookieDate.getMinutes()+43200),wsUtil.setCookie("WidgetChat_autoreply_getcontact_"+WBK.settings.chatId,!0,cookieDate)}message_block='<div class="ws-chat-message-source">'+data.message+"</div>";break;case"lead":case"preform":message_block=parseInt(s.show_contact_form_inside_chat)?'<div class="ws-chat-body-preform ws-chat-body-preform-clear"><div class="ws-chat-preform-text"></div><div class="ws-chat-preform-social"><a href="javascript:void(0)" class="ws-chat-social-el ws-chat-social-vk"><img class="ws-chat-social-img" src="'+WBK.settings.staticServerUrl+'/widget/img/vk.png"></a><a href="javascript:void(0)" class="ws-chat-social-el ws-chat-social-fb"><img class="ws-chat-social-img" src="'+WBK.settings.staticServerUrl+'/widget/img/fb.png"></a></div><div class="ws-preform-input-group"><div class="ws-preform-input-label"></div><input type="text" class="ws-preform-input ws-preform-name" placeholder="'+s.lang_text.form_name_placeholder+'" value="'+s.user_name+'"></div><div class="ws-preform-input-group"><div class="ws-preform-input-label"></div><input type="tel" class="ws-preform-input ws-preform-phone" placeholder="'+s.lang_text.form_phone_placeholder+'" value="'+s.user_phone+'"><input type="text" class="cbk-phone-checker white-saas-generator-input-hidden"/></div><div class="ws-preform-input-group"><div class="ws-preform-input-label"></div><input type="email" class="ws-preform-input ws-preform-email" placeholder="'+s.lang_text.form_email_placeholder+'" value="'+s.user_email+'"></div><div class="ws-preform-input-group ws-preform-input-group-text"><div class="ws-preform-input-label ws-preform-email-text">'+s.lang_text.email_exit+'</div></div><div class="ws-preform-input-group ws-preform-input-group-text"><label class="ws-preform-label-agreement"><span class="ws-preform-email-agreement-text">'+s.email_agreement_text+s.lang_text.email_agreement_text_agreement+'</span></label></div><div class="ws-preform-input-group ws-preform-input-group-btn"><a href="javascript:void(0)" class="ws-preform-btn ws-preform-btn-save">'+s.lang_text.preform_btn+"</a></div></div>":'<div class="ws-chat-message-source">'+s.lang_text.preform_text+'</div><input class="ws-chat-message-input" placeholder="'+s.lang_text.form_name+'">';break;case"load":message_block='<div class="ws-chat-message-source">'+s.lang_text.loading+' ...</div><div class="ws-chat-progress"><div class="ws-chat-progress-bar"></div></div>';break;case"rating":_this.hideRating();var rating_block='<img class="ws-chat-message-rating-el ws-chat-message-rating-el-1" src="'+WBK.settings.staticServerUrl+'/widget/img/blank.gif" alt=""><img class="ws-chat-message-rating-el ws-chat-message-rating-el-2" src="'+WBK.settings.staticServerUrl+'/widget/img/blank.gif" alt=""><img class="ws-chat-message-rating-el ws-chat-message-rating-el-3" src="'+WBK.settings.staticServerUrl+'/widget/img/blank.gif" alt=""><img class="ws-chat-message-rating-el ws-chat-message-rating-el-4" src="'+WBK.settings.staticServerUrl+'/widget/img/blank.gif" alt=""><img class="ws-chat-message-rating-el ws-chat-message-rating-el-5" src="'+WBK.settings.staticServerUrl+'/widget/img/blank.gif" alt="">';"smiles"==s.rate_chat_view&&(rating_block='<img class="ws-chat-message-rating-el" src="'+WBK.settings.staticServerUrl+'/widget/img/blank.gif" alt="">');var rateText="";switch(parseInt(data.message.rate)){case 1:rateText=s.lang_text.rate_text_1;break;case 2:rateText=s.lang_text.rate_text_2;break;case 3:rateText=s.lang_text.rate_text_3;break;case 4:rateText=s.lang_text.rate_text_4;break;case 5:rateText=s.lang_text.rate_text_5}message_block='<div class="ws-chat-message-source">'+s.lang_text.rate_result+'</div></div><div class="ws-chat-message"><div class="ws-chat-message-source"><div class="ws-chat-message-rating ws-chat-message-rating-'+s.rate_chat_view+" ws-chat-message-rating-rate-"+data.message.rate+'">'+rating_block+"</div>"+rateText+"</div>"}var new_block='<div class="ws-chat-message-block ws-chat-message-robot"><div class="ws-chat-message-logo"><img class="ws-chat-message-logo-img" src="'+s.chat_widget_logo_robot+'"></div><div class="ws-chat-message-name"><span class="ws-chat-message-name-text" data-name="">'+s.robot_name+'</span></div><div class="ws-chat-message">'+message_block+"</div></div>";!parseInt(s.show_contact_form_inside_chat)||"lead"!=data.type&&"preform"!=data.type||$(".ws-chat-body-preform")&&$(".ws-chat-body-preform").closest(".ws-chat-message-robot").remove(),w.window.find(".ws-chat-typing").before(new_block),"load"==data.type&&w.window.find(".ws-chat-body-content .ws-chat-message-robot").last().find(".ws-chat-progress-bar").animate({width:"70%"},4e3),WBK.settings.chatWindowOpened&&_this.scroll()}},sendGoal:function(type){if(!s.free_chat_widget){var yaGoal,gaGoal,mailGoal,gaCategory="ChatService",yagla=!1,facebook=!1;switch(type){case"invitation_click":yaGoal="CHAT_SHOW_ON_INVITATION",gaGoal=mailGoal="ChatShowOnInvitation";break;case"invitation_close":yaGoal="CHAT_INVITATION_CLOSE",gaGoal=mailGoal="ChatInvitationClose";break;case"open":yaGoal="CHAT_SHOW_ON_BTN",gaGoal=mailGoal="ChatShowOnBtn";break;case"first_message":yaGoal="CHAT_FIRST_MESSAGE",gaGoal=mailGoal="ChatFirstMessage",yagla="chat";break;case"offline_message":yaGoal="CHAT_OFFLINE_MESSAGE",gaGoal=mailGoal=facebook="ChatOfflineMessage",yagla="chat",wsUtil.sendUniversalGoal();break;case"visitor_introduced":yaGoal="CHAT_VISITOR_INTRODUCED",gaGoal=mailGoal=facebook="ChatVisitorIntroduced",yagla="chat",wsUtil.sendUniversalGoal();break;case"operator_connect":yaGoal="CHAT_OPERATOR_CONNECT",gaGoal=mailGoal="ChatOperatorConnect"}wsUtil.sendGoal(yaGoal,gaGoal,gaCategory,yagla,facebook)}},checkAutoReply:function(type,data){for(var i=0;i<s.autoreplies.length;i++)type==s.autoreplies[i].action&&_this.startAutoReply(i,data)},stopAutoReply:function(type){wsUtil.deleteTimeout("chatTypingAutoreply");for(var i=0;i<s.autoreplies.length;i++)"all"==type?wsUtil.deleteTimeout("auto_reply_"+s.autoreplies[i].id):type==s.autoreplies[i].action&&wsUtil.deleteTimeout("auto_reply_"+s.autoreplies[i].id)},startAutoReply:function(index,data){return!("1"==s.autoreplies[index].info_introduced&&!s.chat_introduced||"2"==s.autoreplies[index].info_introduced&&s.chat_introduced)&&void wsUtil.setTimeout("auto_reply_"+s.autoreplies[index].id,function(){var auto_reply_get_contact=parseInt(s.autoreplies[index].get_contact)&&!wsUtil.getCookie("WidgetChat_autoreply_getcontact_"+WBK.settings.chatId)?1:0;if("not_connected"==s.autoreplies[index].action&&!s.send_autoreply_first)return!1;var show_with_timeout,operator_arr,res,hash,mess={text:s.autoreplies[index].message};"not_connected"==s.autoreplies[index].action&&(show_with_timeout=!1,s.invitation_operator_id&&(operator_arr=s.invitation_operator_id.split("_"),_this.typing({user_id:operator_arr[0],employee_id:operator_arr[1]},20*s.autoreplies[index].message.length),show_with_timeout=!0),res={message:s.autoreplies[index].message,type:"auto_reply",auto_reply_get_contact:auto_reply_get_contact,auto_reply_index:index},show_with_timeout?(res={hash:!1,message:{text:s.autoreplies[index].message},date:"",user:s.invitation_operator_id,is_read:!0,message_type:"auto_reply",type:"manager",scroll:!0,auto_reply_get_contact:auto_reply_get_contact,auto_reply_index:index},wsUtil.setTimeout("auto_reply_not_connected_start",function(){_this.addMessage(res)},21*s.autoreplies[index].message.length)):_this.addMessageRobot(res),parseInt(s.show_contact_form_inside_chat)&&auto_reply_get_contact&&(_this.typing(s.last_operator_data,55*s.autoreplies[index].message.length),wsUtil.setTimeout("auto_reply_get_inline_contact",function(){_this.addMessageRobot({type:"lead"}),$(".ws-preform-phone").inputmasks(_this.optsRU),_this.showPreform("lead",index,$(this))},55*s.autoreplies[index].message.length)),hash=(new Date).getTime(),mess&&_this.sendNode(JSON.stringify(mess),hash,"auto_reply"),s.auto_reply_not_connected_and_operators_offline_showed=!0),"not_answer_operator"==s.autoreplies[index].action&&(_this.typing(data,50*s.autoreplies[index].message.length,2500),wsUtil.setTimeout("chatTypingAutoreply",function(){res={hash:!1,message:{text:s.autoreplies[index].message},date:"",user:data.user_id+"_"+data.employee_id,is_read:!0,message_type:"auto_reply",type:"manager",scroll:!0,auto_reply_get_contact:auto_reply_get_contact,auto_reply_index:index},_this.addMessage(res),parseInt(s.show_contact_form_inside_chat)&&auto_reply_get_contact&&(_this.typing(s.last_operator_data,55*s.autoreplies[index].message.length),wsUtil.setTimeout("auto_reply_get_inline_contact",function(){_this.addMessageRobot({type:"lead"}),$(".ws-preform-phone").inputmasks(_this.optsRU),_this.showPreform("lead",index,$(this))},55*s.autoreplies[index].message.length)),mess.user_id=data.user_id,mess.employee_id=data.employee_id,hash=(new Date).getTime(),mess&&_this.sendNode(JSON.stringify(mess),hash,"auto_reply")},50*s.autoreplies[index].message.length)),"not_connected_and_operators_offline"==s.autoreplies[index].action&&(show_with_timeout=!1,s.invitation_operator_id&&(operator_arr=s.invitation_operator_id.split("_"),_this.typing({user_id:operator_arr[0],employee_id:operator_arr[1]},20*s.autoreplies[index].message.length),show_with_timeout=!0),res={message:s.autoreplies[index].message,type:"auto_reply",auto_reply_get_contact:auto_reply_get_contact,auto_reply_index:index},show_with_timeout?(res={hash:!1,message:{text:s.autoreplies[index].message},date:"",user:s.invitation_operator_id,is_read:!0,message_type:"auto_reply",type:"manager",scroll:!0,auto_reply_get_contact:auto_reply_get_contact,auto_reply_index:index},wsUtil.setTimeout("auto_reply_not_connected_and_operators_offline_start",function(){_this.addMessage(res)},21*s.autoreplies[index].message.length)):_this.addMessageRobot(res),parseInt(s.show_contact_form_inside_chat)&&auto_reply_get_contact&&(_this.typing(s.last_operator_data,55*s.autoreplies[index].message.length),wsUtil.setTimeout("auto_reply_get_inline_contact",function(){_this.addMessageRobot({type:"lead"}),$(".ws-preform-phone").inputmasks(_this.optsRU),_this.showPreform("lead",index,$(this))},55*s.autoreplies[index].message.length)),hash=(new Date).getTime(),mess&&_this.sendNode(JSON.stringify(mess),hash,"auto_reply"))},1e3*parseInt(s.autoreplies[index].time))},initRating:function(){w.container.find(".ws-chat-rating-btns a").on("mouseenter.wbk_chat",function(){if("stars"==s.rate_chat_view)for(var value=$(this).data("value"),i=1;i<=value;i++)w.container.find("a.ws-chat-rating-el-"+i).addClass("ws-chat-rating-el-marked");else $(this).addClass("ws-chat-rating-el-marked")}).on("mouseleave.wbk_chat",function(){w.container.find("a.ws-chat-rating-el").removeClass("ws-chat-rating-el-marked")})},checkRatingSettings:function(){if(WBK.settings.chatId&&parseInt(s.rate_chat)&&!parseInt(s.chatRate)&&!this.ratingIsVisible()&&s.messages_quant_to_rate>=parseInt(s.rate_chat_messages_quant)){for(var i=1;i<=5;i++)$(new Image).attr("src",WBK.settings.staticServerUrl+"/widget/img/rating/24/smile_"+i+".png").load(function(){}),$(new Image).attr("src",WBK.settings.staticServerUrl+"/widget/img/rating/32/smile_"+i+".png").load(function(){});wsUtil.setTimeout("showRating",function(){_this.showRating()},500),w.container.find(".ws-chat-rating-btns a").unbind("click").on("click",function(){s.chatRate=$(this).data("value"),_this.hideRating(),_this.send({message:{rate:$(this).data("value")},type:"rating",scroll:!0})})}},ratingIsVisible:function(){return w.container.hasClass("ws-chat-has-rating")},showRating:function(){w.container.addClass("ws-chat-has-rating"),WBK.animateFastOnce(w.container.find(".ws-chat-rating"),"cbk-fadeIn")},hideRating:function(){w.container.removeClass("ws-chat-has-rating")},sendNode:function(message,hash,type,callback){googleRegistrationIds=[];var o_id=0;if(s.chat_created){if(jWS.isEmptyObject(s.chat_operators))for(o_id in s.all_operators)s.all_operators[o_id].gcm_registration_id&&googleRegistrationIds.push(s.all_operators[o_id].gcm_registration_id);else for(o_id in s.chat_operators)s.chat_operators[o_id].gcm_registration_id&&googleRegistrationIds.push(s.chat_operators[o_id].gcm_registration_id);_this.message(message,hash,type,googleRegistrationIds)}else{for(o_id in s.all_operators)s.all_operators[o_id].gcm_registration_id&&googleRegistrationIds.push(s.all_operators[o_id].gcm_registration_id);s.invitation_show_data&&(message=JSON.parse(message),message.invitation=!0,message.invitation_data=s.invitation_show_data,s.invitation_show_data=!1,message=JSON.stringify(message)),"function"!=typeof callback&&(callback=function(){}),_this.create(message,hash,type,googleRegistrationIds,callback)}"auto_reply"!=type&&"open_window"!=type&&"close_window"!=type&&_this.getAutoReply(),s.is_first_message=!1},getAutoReply:function(){if(!s.free_chat_widget&&s.autoreplies)if(jWS.isEmptyObject(s.chat_operators)){if(operators=wsChat.settings.all_operators,operators)for(var key in operators){if(!(null==operators[key].connected_at&&null==operators[key].disconnected_at||operators[key].connected_at&&operators[key].disconnected_at)){operators_offline=!1;break}operators_offline=!0}s.is_first_message&&(operators_offline?_this.checkAutoReply("not_connected_and_operators_offline"):_this.checkAutoReply("not_connected"))}else s.last_operator_data&&s.send_autoreply&&(_this.checkAutoReply("not_answer_operator",s.last_operator_data),s.send_autoreply=!1)},send:function(data){var mess_to_node="",hash=(new Date).getTime();if(mess_to_node=JSON.stringify(data.message),"rating"==data.type?_this.addMessageRobot(data):_this.addMessage({hash:hash,type:"user",message:data.message,date:!1,user:!1,is_read:!1,message_type:data.type,scroll:data.scroll}),s.is_first_message&&_this.sendGoal("first_message"),s.is_first_message&&parseInt(s.get_contact))if(s.user_name||s.user_email||s.user_phone){var error=!1;"yes"==s.get_contact_name&&""==s.user_name&&(error=!0),"yes"==s.get_contact_email&&""==s.user_email&&(error=!0),"yes"==s.get_contact_phone&&""==s.user_phone&&(error=!0),error?(s.first_message={message:mess_to_node,hash:hash,type:data.type},_this.getContactRobot()):(w.window.find(".ws-textarea").html(""),_this.sendNode(mess_to_node,hash,data.type))}else s.first_message={message:mess_to_node,hash:hash,type:data.type},_this.getContactRobot();else"rating"!=data.type&&w.window.find(".ws-textarea").html(""),_this.sendNode(mess_to_node,hash,data.type);_this.inputScroll()},getContactRobot:function(){_this.addMessageRobot({type:"preform"}),parseInt(s.show_contact_form_inside_chat)&&($(".ws-preform-phone").inputmasks(_this.optsRU),_this.showPreform("preform")),"no"==s.get_contact_can_refuse?(w.window.find(".ws-textarea").html(s.lang_text.block_input).attr("contenteditable",!1),w.window.find(".ws-textarea-group").addClass("ws-textarea-group-hide")):s.first_message&&(_this.sendNode(s.first_message.message,s.first_message.hash,s.first_message.type),s.first_message=!1),parseInt(s.show_contact_form_inside_chat)&&_this.stopAutoReply("not_connected")},sendMessage:function(){var messages=[];if(messages=_this.formatMessage($(".ws-textarea"))){for(var i=0;i<messages.length;i++)""!=messages[i].message.text&&_this.send({message:messages[i].message,type:messages[i].type,data:messages[i].data,scroll:!0});s.is_first_message||w.window.find(".ws-textarea").html(""),this.checkRatingSettings()}},inputScroll:function(){w.window.find(".ws-textarea")[0].scrollHeight>92&&!s.input_scroll?s.input_scroll=!0:w.window.find(".ws-textarea")[0].scrollHeight<=92&&s.input_scroll&&(s.input_scroll=!1);var height_input=w.window.find(".ws-textarea").outerHeight();if(s.height_input!=height_input){var bottom_body=62;56==height_input?bottom_body=76:74==height_input?bottom_body=94:height_input>=92&&(bottom_body=112),w.window.find(".ws-chat-body").css("bottom",bottom_body),s.height_input=height_input,_this.scroll()}w.window.find(".ws-textarea-group").nanoScroller(),w.window.find(".ws-textarea-group").nanoScroller({scrollBottom:0})},insertHTML:function(html){if(navigator.appName.indexOf("Internet Explorer")!=-1)if(document.selection){var r=document.selection.createRange();r.pasteHTML&&r.pasteHTML(html)}else{var r=document.getSelection().getRangeAt(0),n=document.createElement("span");r.surroundContents(n),n.innerHTML=html,r.collapse(!1)}else html&&document.execCommand("insertHtml",!1,html)},uploadFile:function(type){if(s.fileUploadedCount<5){var el,form=new FormData;switch(type){case"doc":el=$(".ws-file-doc-upload")[0].files[0];break;case"img":el=$(".ws-file-img-upload")[0].files[0],form.append("image_type","image")}if(!el)return;form.append(type,el),form.append("type",type),form.append("chat_id",WBK.settings.chatId),_this.uploadFileServer(form,type)}},uploadFileServer:function(form,type){_this.addMessageRobot({type:"load"}),$.ajax({type:"POST",url:WBK.settings.serverUrl+"/chat/api/?action=uploadFile",processData:!1,contentType:!1,crossDomain:!0,data:form,dataType:"json",success:function(response){switch(type){case"doc":$(".ws-file-doc-upload").val("");break;case"img":$(".ws-file-img-upload").val("")}w.window.find(".ws-chat-body-content .ws-chat-message-robot").last().find(".ws-chat-progress-bar").stop().animate({width:"100%"},500,function(){if(w.window.find(".ws-chat-body-content .ws-chat-message-robot").last().remove(),"success"===response.status)switch(type){case"doc":var data={message:{file_ico_url:"widget/img/"+response.ico+".png",file_name:response.original_name,file_name_upload:response.save_name,file_size:response.size,file_size_type:response.size_type},type:"attach_file",scroll:!0};_this.addFileUploaded(data);break;case"img":var data={message:{img_url:WBK.settings.staticServerUrl+"/"+response.path,file_name:response.original_name,file_name_upload:response.save_name,img_type:"uploaded"},type:"attach_image",scroll:!0};_this.addFileUploaded(data)}else _this.addMessageRobot({type:"text",message:response.message})})}})},addFileUploaded:function(data){data&&(s.fileUploaded[(new Date).getTime()]=data,_this.updateFilesUploaded())},updateFilesUploaded:function(){var _this=this;$(".ws-chat-uploaded-files").empty();var fileCount=0;$.isEmptyObject(s.fileUploaded)||$.each(s.fileUploaded,function(index,value){var img_url,link,type="";switch(value.type){case"attach_image":type="img",img_url=value.message.img_url,link=WBK.settings.serverUrl+"/chat/download/?type=image&file="+value.message.file_name_upload+"&filename="+value.message.file_name+"&chat="+WBK.settings.chatId;break;case"attach_file":type="file",img_url=WBK.settings.staticServerUrl+"/"+value.message.file_ico_url,link=WBK.settings.serverUrl+"/chat/download/?type=doc&file="+value.message.file_name_upload+"&filename="+value.message.file_name+"&chat="+WBK.settings.chatId}var block='<div class="ws-chat-uploaded-el" data-index="'+index+'"><div class="ws-chat-uploaded-el-close"><i class="ws-icon-close"></i></div><a class="ws-chat-uploaded-url" href="'+link+'" target="_blank"><img class="ws-chat-uploaded-'+type+'" src="'+img_url+'"></a></div>';$(".ws-chat-uploaded-files").append(block),fileCount++}),fileCount>0?w.window.find(".ws-textarea-send-btn").show():""==$(".ws-textarea").html()&&w.window.find(".ws-textarea-send-btn").hide(),_this.typingPositionUpdate(),s.fileUploadedCount=fileCount},showPreform:function(type,index){void 0==index&&(index=!1),parseInt(s.show_contact_form_inside_chat)||(w.window.find(".ws-chat-body").hide(),w.window.find(".ws-chat-footer").hide()),w.window.find(".ws-preform-name").closest(".ws-preform-input-group").removeClass("ws-hide"),w.window.find(".ws-preform-email").closest(".ws-preform-input-group").removeClass("ws-hide"),w.window.find(".ws-preform-phone").closest(".ws-preform-input-group").removeClass("ws-hide"),parseInt(s.show_introduce_social_button)||w.window.find(".ws-chat-preform-social").hide();var get_name="hide",get_email="hide",get_phone="hide";switch(type){case"preform":get_name=s.get_contact_name,get_phone=s.get_contact_phone,get_email=s.get_contact_email;break;case"lead":get_name=s.autoreplies[index].get_name,get_phone=s.autoreplies[index].get_phone,get_email=s.autoreplies[index].get_email}w.window.find(".ws-chat-preform-text").text(s.lang_text.preform_text),"hide"==get_name?w.window.find(".ws-preform-name").closest(".ws-preform-input-group").addClass("ws-hide"):w.window.find(".ws-preform-name").closest(".ws-preform-input-group").find(".ws-preform-input-label").html(s.lang_text.form_name+'<span class="ws-input-required">'+("yes"==get_name?" *":"</span>")),"hide"==get_phone?w.window.find(".ws-preform-phone").closest(".ws-preform-input-group").addClass("ws-hide"):w.window.find(".ws-preform-phone").closest(".ws-preform-input-group").find(".ws-preform-input-label").html(s.lang_text.form_phone+'<span class="ws-input-required">'+("yes"==get_phone?" *":"</span>")),"hide"==get_email?(w.window.find(".ws-preform-email").closest(".ws-preform-input-group").addClass("ws-hide"),w.window.find(".ws-preform-email-text").closest(".ws-preform-input-group").addClass("ws-hide")):(w.window.find(".ws-preform-email").closest(".ws-preform-input-group").find(".ws-preform-input-label").html(s.lang_text.form_email+'<span class="ws-input-required">'+("yes"==get_email?" *":"</span>")),"lead"==type&&w.window.find(".ws-preform-email-text").closest(".ws-preform-input-group").addClass("ws-hide")),parseInt(s.email_agreement)||w.window.find(".ws-preform-label-agreement").closest(".ws-preform-input-group").addClass("ws-hide"),w.window.find(".ws-preform-btn-save").data("type",type).data("index",index),parseInt(s.show_contact_form_inside_chat)||w.window.find(".ws-chat-body-preform").show(),WBK.setPhoneInputFocusForm($(".ws-preform-phone")),"yes"==get_name&&""==$(".ws-preform-name").val().trim()?$(".ws-preform-name").focus():"yes"!=get_phone||""!=$(".ws-preform-phone").val().trim()&&$(".ws-preform-phone").val().trim()!=WBK.settings.phoneBase?"yes"!=get_email||""!=$(".ws-preform-email").val().trim()&&wsUtil.validateEmail($(".ws-preform-email").val().trim())?wsUtil.setCaretPosition($(".ws-preform-name"),$(".ws-preform-name").val().length):$(".ws-preform-email").focus():$(".ws-preform-phone").focus(),"lead"==type&&parseInt(s.show_contact_form_inside_chat)&&(w.window.find(".ws-preform-input-group:not(.ws-hide):first").css("margin-top","0px"),w.window.find(".ws-chat-preform-text").hide()),s.agreementLink&&w.window.find(".ws-chat-agreement-link").attr("href",s.agreementLink)},hidePreform:function(){s.is_first_message&&s.first_message&&"no"!=s.get_contact_can_refuse&&_this.addMessageRobot({type:"preform"}),w.window.find(".ws-chat-body").show(),w.window.find(".ws-chat-footer").show(),w.window.find(".ws-chat-body-preform").hide(),_this.scroll()},savePreform:function(type,index,context){void 0==type&&(type="preform"),void 0==index&&(index=!1);var get_name="hide",get_email="hide",get_phone="hide";switch(type){case"preform":get_name=s.get_contact_name,get_phone=s.get_contact_phone,get_email=s.get_contact_email;break;case"lead":_this.stopAutoReply("all"),get_name=s.autoreplies[index].get_name,get_phone=s.autoreplies[index].get_phone,get_email=s.autoreplies[index].get_email}w.window.find(".ws-preform-name, .ws-preform-phone, .ws-preform-email").removeClass("ws-input-error");var name=w.window.find(".ws-preform-name").val(),phone=w.window.find(".ws-preform-phone").val();phone=WBK.checkPhone(phone),phone=phone?phone:"";var email=w.window.find(".ws-preform-email").val(),emailAgreement=$(".ws-preform-email-agreement").is(":checked")?1:0,phoneMask=w.window.find(".ws-preform-phone").attr("placeholder"),errors_class="";if("yes"==get_name&&""==name.trim()&&(errors_class=".ws-preform-name"),"yes"==get_phone&&""==phone.trim()&&(errors_class?errors_class+=", .ws-preform-phone":errors_class=".ws-preform-phone"),"yes"!=get_email||""!=email.trim()&&wsUtil.validateEmail(email.trim())||(errors_class?errors_class+=", .ws-preform-email":errors_class=".ws-preform-email"),
errors_class)return void w.window.find(errors_class).addClass("ws-input-error");"lead"==type&&($(".ws-chat-autoreply-link").closest(".ws-chat-message-robot").remove(),$(".ws-chat-autoreply-link").remove()),name&&(WBK.settings.visitorName=name.charAt(0).toUpperCase()+name.substr(1,name.length-1)),email&&(WBK.settings.visitorEmail=email),phone&&(WBK.settings.visitorPhone=phone),_this.updateUser();var message="";"preform"==type&&name?message=s.user_name+", "+s.lang_text.preform_text_success:"preform"==type?(message=s.lang_text.preform_text_success,message=message.charAt(0).toUpperCase()+message.substr(1)):"lead"==type&&name?message=s.user_name+", "+s.lang_text.preform_lead_text_success:"lead"==type&&(message=s.lang_text.preform_lead_text_success,message=message.charAt(0).toUpperCase()+message.substr(1)),_this.addMessageRobot({type:"text",message:message}),w.window.find(".ws-chat-message-input").closest(".ws-chat-message-robot").remove(),_this.hidePreform();var siteUrl="";document.URL&&(siteUrl=encodeURIComponent(document.URL));var url=WBK.settings.serverUrl+"/api?action=chatSavePreform&callback=?",data={code:WBK.settings.whiteSaasCode,url:siteUrl,name:name,email:email,phone:phone,emailAgreement:emailAgreement,type_preform:type,type:s.auth_type,image_url:s.logo_visitor,vk_id:s.visitor_vk_id,fb_id:s.visitor_fb_id,fb_token:s.visitor_fb_token,visitId:WBK.settings.visitId,visitorId:WBK.settings.visitorId,chatWidgetId:WBK.settings.chatWidgetId,chatId:WBK.settings.chatId,phoneMask:phoneMask,googleClientId:wsUtil.getGoogleClientId(),roistatPromo:wsUtil.getRoistatPromo(),advertiseId:wsUtil.getAdvertiseId(),calltrackingId:wsUtil.getCalltrackingId(),lpgeneratorId:wsUtil.getLPGeneratorId(),leadvertexId:wsUtil.getLeadvertexId(),externalParams:wsUtil.getExternalParams()};s.is_first_message&&s.first_message?(_this.sendNode(s.first_message.message,s.first_message.hash,s.first_message.type,function(){data.chatId=WBK.settings.chatId,$.getJSON(url,data)}),s.first_message=!1,w.window.find(".ws-textarea").attr("contenteditable",!0).html(""),w.window.find(".ws-textarea-group").removeClass("ws-textarea-group-hide")):(w.window.find(".ws-textarea").attr("contenteditable",!0).html(""),w.window.find(".ws-textarea-group").removeClass("ws-textarea-group-hide"),$.getJSON(url,data)),"function"==typeof window.ws_OnChatVisitorIntroduced&&window.ws_OnChatVisitorIntroduced(data),_this.chatAutoCall(phone.trim(),phoneMask),_this.sendGoal("visitor_introduced"),void 0!=context&&context.closest(".ws-chat-message-robot").remove()},formatTextToDate:function(date){var result=new Date;if(date){var t=date.split(/[- :]/);result=new Date(t[0],t[1]-1,t[2],t[3],t[4],t[5]);var tz=result.getTimezoneOffset();tz=(tz<0?"+":"-")+Math.abs(tz),result.setTime(result.getTime()+60*tz*1e3-60*s.chat_timezone*60*1e3)}return result},dateFormat:function(date){var res={new_block:!1,date_line:!1},result=_this.formatTextToDate(date),now_time=new Date,format=function(num){return(num+"").length<2?"0"+num:num},minLeft=!1;return s.chat_old_time?(minLeft=s.chat_old_time<result&&Math.ceil((result-s.chat_old_time)/6e4),s.chat_old_time.getFullYear()==result.getFullYear()&&s.chat_old_time.getMonth()==result.getMonth()&&s.chat_old_time.getDate()==result.getDate()||(s.chat_old_time.getFullYear()!=result.getFullYear()?res.date_line=s.lang_text.dayNames[result.getDay()]+", "+result.getDate()+" "+s.lang_text.monthNames[result.getMonth()]+" "+result.getFullYear():res.date_line=s.lang_text.dayNames[result.getDay()]+", "+result.getDate()+" "+s.lang_text.monthNames[result.getMonth()])):(minLeft=now_time>result&&Math.ceil((now_time-result)/6e4),now_time.getFullYear()==result.getFullYear()&&now_time.getMonth()==result.getMonth()&&now_time.getDate()==result.getDate()||(now_time.getFullYear()!=result.getFullYear()?res.date_line=s.lang_text.dayNames[result.getDay()]+", "+result.getDate()+" "+s.lang_text.monthNames[result.getMonth()]+" "+result.getFullYear():res.date_line=s.lang_text.dayNames[result.getDay()]+", "+result.getDate()+" "+s.lang_text.monthNames[result.getMonth()])),s.chat_old_time=result,minLeft&&minLeft>5&&(res.new_block=!0),result.getDay()==now_time.getDay()?(res.time=format(result.getHours())+":"+format(result.getMinutes()),res):(res.time=format(result.getDate())+"."+format(result.getMonth()+1)+"."+(result.getFullYear()+"").substr(2),res)},formatMessage:function(el){if(!el)return"";var message=_this.cleanMessage(el),messages_arr=[];$.isEmptyObject(s.fileUploaded)||($.each(s.fileUploaded,function(index,value){messages_arr.push(value)}),s.fileUploaded={},_this.updateFilesUploaded());var matches=message.match(/(?!((.+)\/widget\/img\/smiles\/(\w+).png))(https?:\/\/[\w\-\.]+\.[a-zA-Z]{2,6}(?:\/\S*)?(?:[\w])+\.(?:jpg|png|gif|jpeg|bmp))/gi);if(matches){for(var i=0;i<matches.length;i++){var pos=message.indexOf(matches[i]);messages_arr.push({message:{text:_this.textUrlFormat(message.slice(0,pos))},type:"text"}),messages_arr.push({message:{img_url:matches[i],file_name:"",file_name_upload:"",img_type:"link"},type:"attach_image"}),message=message.slice(pos,message.length).replace(matches[i],"")}message&&messages_arr.push({message:{text:_this.textUrlFormat(message)},type:"text"})}else messages_arr.push({message:{text:_this.textUrlFormat(message)},type:"text"});return messages_arr},textUrlFormat:function(text){var urlsFound=!1,emailIsFound=!1;return text=(text||"").replace(/(^|[^A-Za-z0-9А-Яа-яёЁ\-\_])(https?:\/\/)?((?:[A-Za-z\$0-9А-Яа-яёЁ](?:[A-Za-z\$0-9\-\_А-Яа-яёЁ]*[A-Za-z\$0-9А-Яа-яёЁ])?\.){1,5}[A-Za-z\$рфуконлайнстРФУКОНЛАЙНСТ\-\d]{2,22}(?::\d{2,5})?)((?:\/(?:(?:\&amp;|\&#33;|,[_%]|[A-Za-z0-9А-Яа-яёЁ\-\_#%?+\/\$.~=;:]+|\[[A-Za-z0-9А-Яа-яёЁ\-\_#%?+\/\$.,~=;:]*\]|\([A-Za-z0-9А-Яа-яёЁ\-\_#%?+\/\$.,~=;:]*\))*(?:,[_%]|[A-Za-z0-9А-Яа-яёЁ\-\_#%?+\/\$.~=;:]*[A-Za-z0-9А-Яа-яёЁ\_#%?+\/\$~=]|\[[A-Za-z0-9А-Яа-яёЁ\-\_#%?+\/\$.,~=;:]*\]|\([A-Za-z0-9А-Яа-яёЁ\-\_#%?+\/\$.,~=;:]*\)))?)?)/gi,function(){var matches=Array.prototype.slice.apply(arguments),prefix=matches[1]||"",protocol=matches[2]||"http://",domain=matches[3]||"",url=domain+(matches[4]||""),full=(matches[2]||"")+matches[3]+matches[4];if(domain.indexOf(".")==-1||domain.indexOf("..")!=-1)return matches[0];var topDomain=domain.split(".").pop(),gDomains="info,name,academy,aero,arpa,coop,media,museum,mobi,travel,xxx,asia,biz,com,net,org,gov,mil,edu,int,tel,ac,ad,ae,af,ag,ai,al,am,an,ao,aq,ar,as,at,au,aw,ax,az,ba,bb,bd,be,bf,bg,bh,bi,bj,bm,bn,bo,br,bs,bt,bv,bw,by,bz,ca,cc,cd,cf,cg,ch,ci,ck,cl,cm,cn,co,cr,cu,cv,cx,cy,cz,de,dj,dk,dm,do,dz,ec,ee,eg,eh,ekw,ky,kz,la,lb,lc,li,lk,lr,ls,lt,lu,lv,ly,ma,mc,md,me,mg,mh,mk,ml,mm,mn,mo,mp,mq,mr,ms,mt,mu,mv,mw,mx,my,mz,na,nc,ne,nf,ng,ni,nl,no,np,nr,nu,nz,om,pa,pe,pf,pg,ph,pk,pl,pm,pn,pr,ps,pt,pw,py,qa,re,ro,ru,rs,rw,sa,sb,sc,sd,se,sg,sh,si,sj,sk,sl,sm,sn,so,sr,ss,st,su,sv,sx,sy,sz,tc,td,tf,tg,th,tj,tk,tl,tm,tn,to,tp,tr,tt,tv,tw,tz,ua,ug,uk,um,us,uy,uz,va,vc,ve,vg,vi,vn,vu,wf,ws,ye,yt,yu,za,zm,zw,рф,укр,сайт,онлайн,срб,cat,pro,local,xn--p1ai,xn--80aswg,xn--80asehdb";if(url.indexOf("widget/img/smiles/")+1>0||matches[0].indexOf("@")!=-1)return matches[0];if((topDomain.length>12||gDomains.split(",").indexOf(topDomain)==-1)&&(!/^[a-zA-Z]+$/.test(topDomain)||!matches[2]))return matches[0];try{full=decodeURIComponent(full)}catch(e){}return urlsFound=!0,prefix+'<a class="ws-chat-message-link" href="'+protocol+url+'" target="_blank">'+full+"</a>"}),text=text.replace(/([a-zA-ZА-Яа-яёЁ\-_\.0-9]+@[a-zA-ZА-Яа-яёЁ\-_0-9]+\.[a-zA-ZА-Яа-яёЁ\-_\.0-9]+[a-zA-ZА-Яа-яёЁ\-_0-9]+)/g,function(email){return emailIsFound=!0,'<a class="ws-chat-message-link ws-chat-message-email ws-chat-message-email-from-user" href="mailto:'+email+'" target="_blank">'+email+"</a>"}),emailIsFound||urlsFound||(text=text.replace(/\+?\d+((\d+|-+| +|\(+|\)+){6,})\d+/g,function(phone){return'<a class="ws-chat-message-link ws-chat-message-phone ws-chat-message-phone-from-user" href="javascript:void(0)" target="_blank">'+phone+"</a>"})),text},cleanTextToApp:function(text){var text=text.replace(/^\n|\n$/g," ").replace(/[\n\xa0]/g," ").replace(/[ ]+/g," ");return text=text?text.replace(/&/g,"&").replace(/</g,"<").replace(/>/g,">").replace(/"/g,'"').replace(/'/g,"'"):""},cleanMessage:function(el){if(!el)return"";el=el instanceof $?el[0].firstChild:el.firstChild;for(var v="",contTag=new RegExp("^(DIV|P|LI|OL|TR|TD|BLOCKQUOTE|SCRIPT)$");el;){switch(el.nodeType){case 3:var str=this.cleanTextToApp(el.data);v+=str;break;case 1:var str=_this.cleanMessage(el);if(el.tagName&&el.tagName.match(contTag)&&str){"\n"!=str.substr(-1)&&(str+="\n");for(var prev=el.previousSibling;prev&&3==prev.nodeType&&""==$.trim(prev.nodeValue);)prev=prev.previousSibling;!prev||prev.tagName&&prev.tagName.match(contTag)||(str="\n"+str)}else"IMG"==el.tagName?str+=el.outerHTML:"BR"==el.tagName&&(str+="\n");v+=str}el=el.nextSibling}return $.trim(v)},create:function(message,hash,type,googleRegistrationIds,callback){var that=this;if(s.chatCreating)wsUtil.setInterval("chatCreating_"+hash,function(e){s.chatCreating||(wsUtil.deleteInterval("chatCreating_"+hash),_this.message(message,hash,type,googleRegistrationIds))},1e3);else{s.chatCreating=!0;var url=WBK.settings.serverUrl+"/api?action=chatCreate&callback=?";jWS.getJSON(url,{code:WBK.settings.whiteSaasCode,visitorName:WBK.settings.visitorName?WBK.settings.visitorName:"",message:message,type:type,hash:hash,type_show:wsUtil.getCookie("WidgetChat_shownOn"),visitorId:WBK.settings.visitorId,chatWidgetId:WBK.settings.chatWidgetId,googleClientId:wsUtil.getGoogleClientId(),roistatPromo:wsUtil.getRoistatPromo(),advertiseId:wsUtil.getAdvertiseId(),calltrackingId:wsUtil.getCalltrackingId(),lpgeneratorId:wsUtil.getLPGeneratorId(),leadvertexId:wsUtil.getLeadvertexId(),externalParams:wsUtil.getExternalParams()},function(result){if(result.Success&&result.Data&&result.Data.chat){for(var key=0;key<s.invitations.length;key++)wsUtil.deleteInterval("invitationShow_"+key);WBK.settings.chatId=result.Data.chat.id,s.chat_visitor_color=result.Data.chat.color,s.chat_visitor_name=result.Data.chat.visitor_name,s.chat_visitor_img=result.Data.chat.img,s.chat_introduced=result.Data.chat.introduced;var chat={chat_id:WBK.settings.chatId,chat_widget_id:result.Data.chat.chat_widget_id,visitor_name:WBK.settings.visitorName?WBK.settings.visitorName:result.Data.chat.visitor_name,color:result.Data.chat.color,img:result.Data.chat.img,created_at:result.Data.chat.created_at,message_id:result.Data.messageId,hash:hash,message:message,type:type,site:result.Data.chat.site,googleRegistrationIds:googleRegistrationIds,fcmData:that.getFcmData(message,!0),introduced:result.Data.chat.introduced,introduce_type:result.Data.chat.introduce_type,users_to_notification:result.Data.chat.users_to_notification};WBK.settings.socket?s.chat_created||(s.chatCreatedCrazyCycle=0,chat.iteration=s.chatCreatedCrazyCycle,WBK.settings.socket.emit("chatCreated",chat),wsUtil.setInterval("chatCreatedCrazyCycle",function(e){s.chatCreatedCrazyCycle++,chat.iteration=s.chatCreatedCrazyCycle,WBK.settings.socket&&WBK.settings.socket.emit("chatCreated",chat),(s.chatCreatedCrazyCycle>10||!WBK.settings.socket)&&wsUtil.deleteInterval("chatCreatedCrazyCycle")},5e3),s.chat_created=!0):WBK.initSocket(function(){s.chat_created||(s.chatCreatedCrazyCycle=0,chat.iteration=s.chatCreatedCrazyCycle,WBK.settings.socket.emit("chatCreated",chat),wsUtil.setInterval("chatCreatedCrazyCycle",function(e){s.chatCreatedCrazyCycle++,chat.iteration=s.chatCreatedCrazyCycle,WBK.settings.socket&&WBK.settings.socket.emit("chatCreated",chat),(s.chatCreatedCrazyCycle>10||!WBK.settings.socket)&&wsUtil.deleteInterval("chatCreatedCrazyCycle")},5e3),s.chat_created=!0)}),s.chatCreating=!1,"function"==typeof callback&&callback()}})}},start:function(){if(WBK.settings.chatId){var siteUrl="";document.URL&&(siteUrl=encodeURIComponent(document.URL)),WBK.settings.socket?(WBK.settings.socket.emit("chatStarted",{chat_id:WBK.settings.chatId,visitor_name:WBK.settings.visitorName,url:siteUrl}),s.chat_created=!0):WBK.initSocket(function(){WBK.settings.socket.emit("chatStarted",{chat_id:WBK.settings.chatId,visitor_name:WBK.settings.visitorName,url:siteUrl}),s.chat_created=!0})}},printing:function(message){WBK.settings.socket&&WBK.settings.chatId&&WBK.settings.socket.emit("printing",{chat_id:WBK.settings.chatId,message:message})},message:function(message,hash,type,googleRegistrationIds){var messageData={message:JSON.parse(message)};messageData.message_type=type,WBK.settings.socket&&WBK.settings.chatId&&WBK.settings.socket.emit("message",{chat_id:WBK.settings.chatId,message:message,hash:hash,type:type,googleRegistrationIds:googleRegistrationIds,fcmData:this.getFcmData(messageData,!1)})},getFcmData:function(message,isFirstMessage){var name=WBK.settings.visitorName?WBK.settings.visitorName:s.user_name?s.user_name:s.chat_visitor_name,text="Новое сообщение",img_url="";switch(img_url="default"!=s.auth_type?s.logo_visitor:s.chat_visitor_img?s.chat_visitor_img:WBK.settings.serverUrl+"/firstletter/?name="+encodeURI(name.substr(0,1))+"&color="+s.chat_visitor_color,message.message_type){case"show_invitation":case"text":text=message.message.text.replace(/(?:\r\n|\r|\n)/g,"<br />");break;case"attach_image":text="Посетитель отправил изображение";break;case"attach_file":text="Посетитель отправил документ";break;case"rating":text="Посетитель оценил работу оператора";break;case"introduced":text="Посетитель представился"}var fcmData={is_first:isFirstMessage,chat_id:WBK.settings.chatId,visitor_id:WBK.settings.visitorId,name:name,message:text,color:s.chat_visitor_color,introduced:s.chat_introduced,auth_type:s.auth_type,image:img_url,vk_id:s.visitor_vk_id,fb_id:s.visitor_fb_id};return fcmData},messageReceived:function(data){WBK.settings.socket&&WBK.settings.socket.emit("messageReceived",data)},messageRead:function(data){WBK.settings.socket&&WBK.settings.socket.emit("messageRead",data)},messageReadVisitor:function(sync){for(var index in s.unread_messages)sync||_this.messageRead(s.unread_messages[index]),delete s.unread_messages[index];_this.setUnreadMessages(0)},messageReadOperator:function(hash){var mess=w.window.find(".ws-chat-body-content").find("#mess_"+hash);mess.data("read",!0);var el=mess.closest(".ws-chat-message-block"),messages=el.find(".ws-chat-message");if(messages.length){var res=!0;messages.each(function(key,value){0==$(value).data("read")&&(res=!1)}),res&&el.find(".ws-chat-message-status").text(s.lang_text.is_read)}},setUnreadMessages:function(count){var favicon_el=$('link[rel="shortcut icon"], link[rel="icon"]');if(count>99&&(count=99),wsUtil.deleteInterval("unreadMessages"),0==count)return w.btn.find(".ws-btn-badge").text("").hide(),s.unread_messages_count=0,document.title=s.document_title,s.new_favicon_href="",void(s.document_favicon_href&&favicon_el.attr("href",s.document_favicon_href));if(w.btn.find(".ws-btn-badge").text(count).show(),s.document_favicon_href){var img=$('<img crossOrigin="anonymous" src="'+s.document_favicon_href+'"/>');img.load(function(){s.new_favicon_href=_this.generateFavicon(img,count),wsUtil.setInterval("unreadMessages",function(){s.document_title==document.title?(document.title=wsUtil.doEnding(count,s.lang_text.one_new_mess,s.lang_text.two_new_mess,s.lang_text.five_new_mess),s.new_favicon_href&&favicon_el.attr("href",s.new_favicon_href)):(document.title=s.document_title,s.document_favicon_href&&favicon_el.attr("href",s.document_favicon_href))},1e3)}).error(function(){wsUtil.setInterval("unreadMessages",function(){s.document_title==document.title?document.title=count+" "+wsUtil.doEnding(count,s.lang_text.one_new_mess,s.lang_text.two_new_mess,s.lang_text.five_new_mess):document.title=s.document_title},1e3)})}else wsUtil.setInterval("unreadMessages",function(){s.document_title==document.title?document.title=count+" "+wsUtil.doEnding(count,s.lang_text.one_new_mess,s.lang_text.two_new_mess,s.lang_text.five_new_mess):document.title=s.document_title},1e3)},generateFavicon:function(img,count){if(s.document_favicon_href){var ctx,canvas=$("<canvas/>");$('link[rel="shortcut icon"], link[rel="icon"]');if(canvas[0].getContext("2d")){canvas[0].height=canvas[0].width=img[0].width,ctx=canvas[0].getContext("2d"),count&&(ctx.globalAlpha=.4,count<10?count=" "+count:count>100&&(count=99));var multiplier=img[0].width/16,fontSize=11*multiplier,xOffset=multiplier,yOffset=11*multiplier,border=multiplier,shadow=2*multiplier;return ctx.drawImage(img[0],0,0),ctx.globalAlpha=1,ctx.font="bold "+fontSize+'px "helvetica", sans-serif',ctx.shadowColor="#FFF",ctx.shadowBlur=shadow,ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.fillStyle="#FFF",ctx.fillText(count,xOffset,yOffset),ctx.fillText(count,xOffset+border,yOffset),ctx.fillText(count,xOffset,yOffset+border),ctx.fillText(count,xOffset+border,yOffset+border),ctx.fillStyle="#000",ctx.fillText(count,xOffset+border/2,yOffset+border/2),canvas[0].toDataURL("image/png")}}},scroll:function(){var body=w.window.find(".ws-chat-body");body[0].hasOwnProperty("nanoscroller")&&(body.nanoScroller(),body.nanoScroller({scrollBottom:0}))},initBtnPosition:function(){var css={},css_invitation={};if(w.btn.show(),"pc"!=WBK.settings.device)"hide"!=s.button_location&&_this.updateBtnPositionMobile();else{switch(s.button_location){case"horizontal":switch(s.position_x){case"left":css.left=s.position_x_value+"%",css.right="auto",w.invitation.addClass("ws-chat-invitation-left");break;case"right":css.right=s.position_x_value+"%",css.left="auto"}switch(s.position_y){case"bottom":css.bottom=s.position_y_value+"%",css.top="auto",0==s.position_y_value&&w.btn.addClass("ws-chat-btn-attach"),WBK.addStyles(".ws-chat .ws-chat-invitation-container:after{border-top-color: "+s.color_background_invitation+" !important;}");break;case"top":css.top=s.position_y_value+"%",css.bottom="auto",0==s.position_y_value&&(w.btn.addClass("ws-chat-btn-attach-top"),w.btn.find(".ws-btn-badge").css("top","32px")),w.invitation.addClass("ws-chat-invitation-bottom"),WBK.addStyles(".ws-chat .ws-chat-invitation-container:after{border-bottom-color: "+s.color_background_invitation+" !important;}")}break;case"vertical_left":w.btn.addClass("ws-chat-btn-rotate").addClass("ws-chat-btn-attach-top"),w.btn.find(".ws-btn-badge").css("top","32px"),css.left=-(w.btn.outerWidth()-w.btn.outerHeight())/2+"px",css.right="auto",css_invitation.left=w.btn.outerWidth()/2+w.btn.outerHeight()+"px",css_invitation.right="auto",w.invitation.addClass("ws-chat-invitation-rotate-right"),WBK.addStyles(".ws-chat .ws-chat-invitation-container:after{border-right-color: "+s.color_background_invitation+" !important;}");break;case"vertical_right":w.btn.addClass("ws-chat-btn-rotate").addClass("ws-chat-btn-attach"),css.right=-(w.btn.outerWidth()-w.btn.outerHeight())/2+"px",css.left="auto",css_invitation.right=w.btn.outerWidth()/2+w.btn.outerHeight()+"px",css_invitation.left="auto",w.invitation.addClass("ws-chat-invitation-rotate-left"),WBK.addStyles(".ws-chat .ws-chat-invitation-container:after{border-left-color: "+s.color_background_invitation+" !important;}")}if("vertical_left"==s.button_location||"vertical_right"==s.button_location){switch(s.position_y){case"bottom":css.bottom=(w.btn.outerWidth()-w.btn.outerHeight())/2+window.innerHeight/100*s.position_y_value+"px",css.top="auto";break;case"top":css.top=(w.btn.outerWidth()-w.btn.outerHeight())/2+window.innerHeight/100*s.position_y_value+"px",css.bottom="auto"}w.invitation.css({top:-(w.btn.outerWidth()-w.btn.outerHeight())/2+"px",bottom:"auto",left:css_invitation.left,right:css_invitation.right})}w.btn_el.css(css)}w.btn.hide()},updateBtnPositionMobile:function(){if(!w.btn_el.hasClass("ws-chat-no-update-position")&&!parseInt(s.hide_mobile)){var ratioScreen=wsUtil.getRatio();s.scallingMobile=1!=ratioScreen;var positionData,position={ratio:ratioScreen,positionX:s.mobile_position_x,positionY:s.mobile_position_y,positionXValue:s.mobile_position_x_value,positionYValue:s.mobile_position_y_value};s.scallingMobile?(w.btn_el.removeClass("envy-not-scalling"),position.el=w.btn_el,positionData=wsUtil.getMobileScalePositionWidget(position),positionData["z-index"]="inherit",w.btn_el.css(positionData),wsUtil.setTimeout("zIndex",function(){w.btn_el.css("z-index",2147483645),parseInt(s.hide_zoom)&&wsUtil.setTimeout("btnElShow",function(){w.btn_el.show()},150)},50)):(w.btn_el.addClass("envy-not-scalling"),positionData=wsUtil.getMobileNotScalePositionWidget(position),w.btn_el.css(positionData),w.btn_el.show()),w.container.addClass(s.mobile_position_x),w.container.addClass(s.mobile_position_y)}},updateOfflineBodySize:function(){s.containerSize=w.window.height();var header_size=w.window.find(".ws-chat-header").height(),body_size=w.window.find(".ws-chat-body-offline").height(),copyright_size=w.window.find(".ws-chat-copyright").height();s.containerSize<header_size+body_size+copyright_size?w.window.addClass("copyright-relative"):w.window.removeClass("copyright-relative")},initWindowPosition:function(){if("pc"==WBK.settings.device){var top_btn=w.btn_el.position().top,left_btn=w.btn_el.position().left,h_window=w.window.outerHeight(),w_window=w.window.width(),h_btn=w.btn.outerHeight(),doc_w=$(window).width(),doc_h=window.innerHeight,ico_left=0;w.window.hasClass("ws-chat-ico-bottom")&&(ico_left=64),left_btn+w_window>doc_w&&(ico_left=0,left_btn=doc_w-w_window),top_btn=top_btn-h_window+h_btn,top_btn<0&&(top_btn=0),left_btn<0&&(left_btn=0),top_btn+h_window>doc_h&&(top_btn=doc_h-h_window),w.window.css({top:top_btn/(doc_h/100)+"%",left:(left_btn+ico_left)/(doc_w/100)+"%"}),WBK.animateFastOnce(w.window,"cbk-zoomIn")}},updateWindowPosition:function(){if("pc"==WBK.settings.device){var left_window=(w.window.position().top,w.window.position().left),w_window=(w.window.height(),w.window.width()),doc_w=wsUtil.getVisualWidth(),ico_left=(wsUtil.getVisualHeight(),0);w.window.hasClass("ws-chat-ico-bottom")&&(ico_left=64),left_window+w_window+ico_left>doc_w-15&&(left_window=doc_w-w_window-ico_left-15),w.window.css({left:(left_window+ico_left)/(doc_w/100)+"%"}),WBK.animateFastOnce(w.window,"cbk-zoomIn")}},loadBtnEvents:function(){w.btn.on("click",function(){1==WBK.settings.chatInvitationOpened&&_this.hideInvitation(),_this.showWidget(),_this.sendGoal("open")}),w.invitation.on("click",function(e){return _this.hideInvitation(),WBK.settings.multiButtonId&&wsMultiButton.hideWidget(),$(e.target).hasClass("ws-chat-invitation-close")||$(e.target).hasClass("ws-icon-close")?(WBK.settings.multiButtonId&&wsMultiButton.reInitWidget(),wsMultiButton.settings.text_tip&&$(".multi_button-main-div-text .multi_button-text").show(),void _this.sendGoal("invitation_close")):(_this.showWidget(),void _this.sendGoal("invitation_click"))})},loadWindowEvents:function(){if(!$.fn._frameCheck()||"undefined"!=typeof WBK)try{$("body").on("click",'a[href="#showchat"], a[href="'+window.top.location.origin+'#showchat"], a[href="'+window.top.location.origin+'/#showchat"]',function(e){return _this.showWidget(),_this.sendGoal("open"),e.preventDefault(),!1})}catch(error){}if(w.window.find(".ws-chat-close").on("click",function(){"pc"!=WBK.settings.device&&(location.hash=""),_this.hideWidget()}),$(document).on("click",".ws-chat-message-element-file",function(){if(s.chat_created){var hash=(new Date).getTime(),data={file_name:$(this).data("fileName"),file_name_upload:$(this).data("fileNameUpload")};_this.sendNode(JSON.stringify(data),hash,"start_download")}}),$(document).on("click",".ws-chat-uploaded-el-close",function(){var index=$(this).parent().data("index");index&&(delete s.fileUploaded[index],_this.updateFilesUploaded())}),w.window.find(".ws-chat-sound").on("click",function(){"on"==s.sound?(s.sound="off",w.window.find(".ws-chat-sound").attr("title",s.lang_text.sound_on),w.window.find(".ws-chat-sound i").removeClass("ws-icon-sound-on").addClass("ws-icon-sound-off")):(s.sound="on",w.window.find(".ws-chat-sound").attr("title",s.lang_text.sound_off),w.window.find(".ws-chat-sound i").removeClass("ws-icon-sound-off").addClass("ws-icon-sound-on"));var d=new Date;d.setMinutes(d.getMinutes()+43200),wsUtil.setCookie("WidgetChat_sound_"+WBK.settings.chatWidgetId,s.sound,d)}),w.window.find(".ws-textarea").bind("keypress",function(e){var code=e.keyCode||e.which;if(10==code||13==code&&e.ctrlKey){var selection=window.getSelection(),range=selection.getRangeAt(0),br=document.createElement("br"),br2=document.createElement("br");document.createTextNode(" ");range.deleteContents(),range.insertNode(br),3==range.startContainer.nodeType&&range.insertNode(br2),range.collapse(!1)}13!=code||e.shiftKey||e.ctrlKey||(e.preventDefault(),_this.sendMessage(),w.window.find(".ws-textarea-send-btn").hide())}),w.window.find(".ws-textarea").bind("keyup",function(e){var code=e.keyCode||e.which;37!=code&&38!=code&&39!=code&&40!=code&&37!=code&&33!=code&&34!=code&&_this.inputScroll()}),w.window.find(".ws-textarea").bind("keydown",function(e){var code=e.keyCode||e.which;8==code&&_this.inputScroll()}),w.window.find(".ws-textarea").on("paste",function(e){e.preventDefault();var text="";if((e.originalEvent||e.originalEvent.clipboardData.getData("text/plain"))&&(text=e.originalEvent.clipboardData.getData("text/plain")),text)try{text=text.replace(/^\n|\n$/g,"<br>").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),_this.insertHTML(text)}catch(e){}var items=e.clipboardData||e.originalEvent.clipboardData;if(items&&(items=items.items)){for(var image=!1,i=0;i<items.length;i++)0==items[i].type.indexOf("image")&&(image=items[i].getAsFile());if(image){image.name=image.filename="image_"+(new Date).getTime()+".png";var file=new File([image],image.filename),form=new FormData;form.append("img",file),form.append("type","img"),form.append("image_type","screen"),form.append("chat_id",WBK.settings.chatId),_this.uploadFileServer(form,"img")}}}),w.window.find(".ws-textarea-send-btn").on("click",function(e){_this.sendMessage(),w.window.find(".ws-textarea-send-btn").hide(),wsUtil.setFocusContentEditable(form[0])}),$(document).on("click",".ws-chat-message-user .ws-chat-message-name-text",function(){_this.getContactRobot()}),$(document).on("click",".ws-chat-message-robot .ws-chat-message-input",function(){_this.showPreform("preform")}),$(document).on("click",".ws-chat-autoreply-btn",function(){parseInt(s.show_contact_form_inside_chat)&&(_this.addMessageRobot({type:"lead"}),$(".ws-preform-phone").inputmasks(_this.optsRU)),_this.showPreform("lead",$(this).data("index"),$(this))}),$(document).on("click",".ws-chat-message-manager .ws-chat-message-name-text, .ws-chat-ico .ws-chat-logo",function(){var text=" "+$(this).data("name")+",&nbsp;";w.window.find(".ws-textarea").is(":focus")||w.window.find(".ws-textarea").focus(),_this.insertHTML(text)}),w.window.find(".ws-textarea").bind("keyup",function(e){var code=e.keyCode||e.which;if(13!=code)if(""!=$(".ws-textarea").html()){w.window.find(".ws-textarea-send-btn").show();var message=_this.cleanMessage($(".ws-textarea"));_this.printing(message)}else 0==s.fileUploadedCount&&w.window.find(".ws-textarea-send-btn").hide()}),w.window.find(".ws-textarea").on("focus",function(){_this.messageReadVisitor(!1)}),w.window.find(".ws-btn-smile, .ws-smile-container").mouseenter(function(){wsUtil.deleteTimeout("hideSmileContainer"),w.window.find(".ws-file-container").hide(),w.window.find(".ws-smile-container").show()}).mouseleave(function(){wsUtil.setTimeout("hideSmileContainer",function(){w.window.find(".ws-smile-container").hide()},300)}),w.window.find(".ws-btn-file, .ws-file-container").mouseenter(function(){wsUtil.deleteTimeout("hideFileContainer"),w.window.find(".ws-smile-container").hide(),w.window.find(".ws-file-container").show()}).mouseleave(function(){wsUtil.setTimeout("hideFileContainer",function(){w.window.find(".ws-file-container").hide()},300)}),$(window).on("resize.ws-chat",function(){if("pc"==WBK.settings.device)wsUtil.setTimeout("resizeChat",function(){WBK.settings.chatWindowOpened?_this.updateWindowPosition():_this.initWindowPosition()},500);else{var inputHeight=w.window.find(".ws-textarea").outerHeight();w.window.find(".ws-chat-body").css("bottom",inputHeight),_this.scroll()}}),"pc"==WBK.settings.device?(w.window.find(".ws-chat-header").on("mousedown",function(e){1!==e.which||$(e.target).hasClass("ws-chat-close")||$(e.target).hasClass("ws-icon-close")||$(e.target).hasClass("ws-chat-sound")||$(e.target).hasClass("ws-icon-sound-on")||$(e.target).hasClass("ws-icon-sound-off")||(w.window.addClass("ws-chat-drag"),s.dragChatObject.elem=w.window,s.dragChatObject.downX=e.pageX,s.dragChatObject.downY=e.pageY)}),$(document).on("mouseup.ws-chat-header",function(e){if(s.dragChatObject.dragStarted){s.dragChatObject.dragStarted=!1;var d=new Date;d.setMinutes(d.getMinutes()+1440);var data=JSON.stringify({top:w.window.css("top"),left:w.window.css("left"),width:w.window.css("width"),height:w.window.css("height")});wsUtil.setCookie("WidgetChat_settings_"+WBK.settings.chatWidgetId,data,d)}w.window.removeClass("ws-chat-drag"),s.dragChatObject={}}),$(document).on("mousemove.ws-chat-header",function(e){if(s.dragChatObject.elem){var moveX=e.pageX-s.dragChatObject.downX,moveY=e.pageY-s.dragChatObject.downY;if(Math.abs(moveX)<3&&Math.abs(moveY)<3)return;s.dragChatObject.dragStarted||(s.dragChatObject.oldPosition={left:s.dragChatObject.elem.position().left||"",top:s.dragChatObject.elem.position().top||""},s.dragChatObject.shiftX=s.dragChatObject.downX-s.dragChatObject.elem.position().left,s.dragChatObject.shiftY=s.dragChatObject.downY-s.dragChatObject.elem.position().top,s.dragChatObject.dragStarted=!0);var pos_left=e.pageX-s.dragChatObject.shiftX,pos_top=e.pageY-s.dragChatObject.shiftY,doc_w=$(window).width(),doc_h=window.innerHeight;pos_top=s.dragChatObject.elem.outerHeight()>doc_h?0:pos_top+s.dragChatObject.elem.outerHeight()>doc_h-10?doc_h-s.dragChatObject.elem.outerHeight():pos_top<10?0:pos_top,pos_left=s.dragChatObject.elem.outerWidth()+pos_left>doc_w?doc_w-s.dragChatObject.elem.outerWidth():pos_left<10?0:pos_left,pos_left<100&&w.window.hasClass("ws-chat-ico-bottom")?w.window.addClass("ws-chat-ico-bottom-right"):w.window.removeClass("ws-chat-ico-bottom-right"),s.dragChatObject.elem.css({left:pos_left+"px",top:pos_top+"px",right:"auto",bottom:"auto"})}}),s.chat_is_online&&(w.window.find(".ws-chat-resize").on("mousedown",function(e){1===e.which&&(s.resizeChatObject.elem=w.window,s.resizeChatObject.elemMinSizeHeight=375,s.resizeChatObject.elemMinSizeHeight=s.resizeChatObject.elemMinSizeHeight+s.resizeChatObject.elem.find(".ws-chat-footer").outerHeight(),s.resizeChatObject.downX=e.pageX,s.resizeChatObject.downY=e.pageY,w.window.addClass("ws-chat-no-select"))}),$(document).on("mouseup.ws-chat-resize",function(e){if(s.resizeChatObject.dragStarted){s.resizeChatObject.dragStarted=!1;var d=new Date;d.setMinutes(d.getMinutes()+1440);var data=JSON.stringify({top:w.window.css("top"),left:w.window.css("left"),width:w.window.css("width"),height:w.window.css("height")});wsUtil.setCookie("WidgetChat_settings_"+WBK.settings.chatWidgetId,data,d),_this.inputScroll()}s.resizeChatObject={},w.window.removeClass("ws-chat-no-select"),_this.typingPositionUpdate()}),$(document).on("mousemove.ws-chat-resize",function(e){if(s.resizeChatObject.elem){var moveX=e.pageX-s.resizeChatObject.downX,moveY=e.pageY-s.resizeChatObject.downY;if(Math.abs(moveX)<3&&Math.abs(moveY)<3)return;s.resizeChatObject.dragStarted||(s.resizeChatObject.old={width:s.resizeChatObject.elem.outerWidth(),height:s.resizeChatObject.elem.outerHeight(),left:s.resizeChatObject.elem.position().left||"",top:s.resizeChatObject.elem.position().top||""},s.resizeChatObject.shiftX=s.resizeChatObject.downX-s.resizeChatObject.elem.position().left,s.resizeChatObject.shiftY=s.resizeChatObject.downY-s.resizeChatObject.elem.position().top,s.resizeChatObject.dragStarted=!0),s.resizeChatObject.dragStarted=!0;var w_window=e.pageX-s.resizeChatObject.downX,h_window=e.pageY-s.resizeChatObject.downY,doc_w=$(window).width(),doc_h=window.innerHeight,height=s.resizeChatObject.old.height+h_window,width=s.resizeChatObject.old.width+w_window;
if(s.resizeChatObject.elem.position().top+height>doc_h){height=doc_h-s.resizeChatObject.elem.position().top}s.resizeChatObject.elem.position().left+width>doc_w&&(width=doc_w-s.resizeChatObject.elem.position().left),s.resizeChatObject.elem.css({width:width>338?width:338,height:height>=400?height:400}),_this.scroll()}}))):($(window).on("scroll.ws-chat",function(){parseInt(s.hide_zoom)&&w.btn_el.hide(),wsUtil.setTimeout("scrollTimerChat",function(){_this.updateBtnPositionMobile()},250)}),$(window).on("envy:resize",function(){_this.updateBtnPositionMobile(),s.containerSize!=w.window.height()&&_this.updateOfflineBodySize()})),w.window.find(".ws-file-upload").on("change",function(e){e.preventDefault(),w.window.find(".ws-file-container").hide(),_this.uploadFile($(this).data("type"))}),w.window.find(".ws-offline-btn").on("click",function(){_this.sendOfflineMessage()}),w.window.find(".ws-preform-btn-cancel").on("click",function(){_this.hidePreform()}),$(document).on("click",".ws-preform-btn-save",function(){_this.savePreform($(this).data("type"),$(this).data("index"),$(this))}),$(document).on("click",".ws-chat-social-vk",function(){var swidth=675,sheight=380,left=(screen.width-swidth)/2,top=(screen.height-sheight)/4;open(WBK.settings.serverUrl+"/chat/auth_vk/?origin="+window.location.origin,"publish","width="+swidth+",height="+sheight+", top="+top+", left="+left+",resizable=yes,scrollbars=yes,status=yes")}),$(document).on("click",".ws-chat-social-fb",function(){var swidth=675,sheight=380,left=(screen.width-swidth)/2,top=(screen.height-sheight)/4;open(WBK.settings.serverUrl+"/chat/auth_fb/?origin="+window.location.origin,"publish","width="+swidth+",height="+sheight+", top="+top+", left="+left+",resizable=yes,scrollbars=yes,status=yes")}),$(window).on("message",function(data){var data=data.originalEvent.data;if(data)switch(data.type){case"vk_auth":_this.vkAuth(data);break;case"fb_auth":_this.fbAuth(data)}}),w.window.find(".ws-preform-input").bind("keypress",function(e){var code=e.keyCode||e.which;13==code&&(e.preventDefault(),_this.savePreform($(".ws-preform-btn-save").data("type"),$(this).data("index")))}),$.fn._frameCheck()||Object.keys(s.invitations).length>0&&(_t=this,Object.keys(s.invitations).map(function(key,index){var v=s.invitations[key];try{$("body").on("click.invitations",'a[href="#autoinvitation-'+v.name.replace(/\s+/g,"-")+'"], a[href="'+window.top.location.origin+"#autoinvitation"+v.name.replace(/\s+/g,"-")+'"], a[href="'+window.top.location.origin+"/#autoinvitation"+v.name.replace(/\s+/g,"-")+'"]',function(e){var invitatiton=$(e.currentTarget).attr("href").replace(new RegExp(window.top.location.origin+"|/|#autoinvitation|-+","g")," ").trim();return _t.showInvitationByName(invitatiton),e.preventDefault(),!1})}catch(e){}})),WBK.settings.phoneMasks){var listRU=$.masksSort(WBK.settings.phoneMasks,["#"],/[0-9]|#/,"mask"),optsRU={inputmask:{definitions:{"#":{validator:"[0-9]",cardinality:1}},clearIncomplete:!1,showMaskOnHover:!1,autoUnmask:!0},match:/[0-9]/,replace:"#",list:listRU,listKey:"mask",onMaskChange:function(){$(this).attr("placeholder",$(this).inputmask("getemptymask"))}};_this.optsRU=optsRU,$(".ws-offline-phone").inputmasks(optsRU),$(".ws-preform-phone").inputmasks(optsRU),optsRU.inputmask.definitions.clearIncomplete=!0,$(".cbk-phone-checker").inputmasks(optsRU)}},vkAuth:function(info){s.visitor_vk_id=info.user_id,$.ajax({url:"https://api.vk.com/method/users.get?user_ids="+info.user_id+"&fields=photo_100&lang=ru&v=5.81",type:"GET",dataType:"jsonp",crossDomain:!0,success:function(data){w.window.find(".ws-preform-name").val(data.response[0].first_name+" "+data.response[0].last_name),info.email&&w.window.find(".ws-preform-email").val(info.email),data.response[0].photo_100&&(s.logo_visitor=data.response[0].photo_100),s.auth_type="vk",_this.savePreform($(".ws-preform-btn-save").data("type"),$(".ws-preform-btn-save").data("index"),$(".ws-preform-btn-save"))}})},fbAuth:function(info){s.visitor_fb_token=info.access_token,$.ajax({url:"https://graph.facebook.com/me?fields=id,email,first_name,last_name,picture.width(100).height(100)&access_token="+info.access_token,type:"GET",dataType:"jsonp",crossDomain:!0,success:function(data){s.visitor_fb_id=data.id,w.window.find(".ws-preform-name").val(data.first_name+" "+data.last_name),data.email&&w.window.find(".ws-preform-email").val(data.email),data.picture.data.url&&(s.logo_visitor=data.picture.data.url),s.auth_type="fb",_this.savePreform($(".ws-preform-btn-save").data("type"),$(".ws-preform-btn-save").data("index"),$(".ws-preform-btn-save"))}})},updateUser:function(){if(s.visitorData&&(s.auth_type=s.visitorData.type,s.logo_visitor=s.visitorData.img,s.visitorData=!1),s.user_name=WBK.settings.visitorName?WBK.settings.visitorName:"",s.user_email=WBK.settings.visitorEmail?WBK.settings.visitorEmail:"",s.user_phone=WBK.settings.visitorPhone?WBK.settings.visitorPhone:"",s.chat_created){w.window.find(".ws-chat-message-user").find(".ws-chat-message-name-text").text(s.user_name),_this.logoVisitor(!0),w.window.find(".ws-chat-message-user").find(".ws-chat-message-name-text").text(s.user_name);var hash=new Date;hash=hash.getTime();var message={visitor_name:s.user_name,visitor_email:s.user_email,visitor_phone:s.user_phone,auth_type:s.auth_type,image:s.logo_visitor,vk_id:s.visitor_vk_id,fb_id:s.visitor_fb_id};WBK.settings.socket?WBK.settings.socket.emit("introduced",{chat_id:WBK.settings.chatId,visitor_name:s.user_name,visitor_email:s.user_email,visitor_phone:s.user_phone,hash:hash,message:JSON.stringify(message),type:"introduced"}):WBK.initSocket(function(){WBK.settings.socket.emit("introduced",{chat_id:WBK.settings.chatId,visitor_name:s.user_name,visitor_email:s.user_email,visitor_phone:s.user_phone,hash:hash,message:JSON.stringify(message),type:"introduced"})})}},operatorsIsOnline:function(){var result=!1;return s.operators_id=[],s.operators_online_id=[],s.operators_array=[],s.all_operators&&$.each(s.all_operators,function(index,value){s.all_operators[index].user_logo&&s.all_operators[index].connected_at&&s.operators_array.push(s.all_operators[index]),s.operators_id.push(s.all_operators[index].user_id+"_"+s.all_operators[index].employee_id),parseInt(s.all_operators[index].status)&&(s.operators_online_id.push(s.all_operators[index].user_id+"_"+s.all_operators[index].employee_id),result=!0)}),result},addMessage:function(data){var name,mess_block_class="",last_user=!0,status=s.lang_text.is_received,read=!1;switch(data.is_read&&(status=s.lang_text.is_read,read=!0),data.user=data.user?data.user:"",data.date=_this.dateFormat(data.date),data.message_type){case"introduced":case"error":case"start_download":case"open_window":case"close_window":case"auto_ended":case"not_require_answer":case"close_chat":case"crm_integration_sended":case"invite_to_chat":case"":return!1;case"show_invitation":case"text":s.messages_quant_to_rate++,data.message=data.message.text.replace(/(?:\r\n|\r|\n)/g,"<br />");break;case"auto_reply":if(data.auto_reply_get_contact){if(parseInt(s.show_contact_form_inside_chat))data.message=wsUtil.specialChars(data.message.text);else{var text_btn=s.autoreplies[data.auto_reply_index].text_btn?s.autoreplies[data.auto_reply_index].text_btn:s.lang_text.autoreply_link;data.message=wsUtil.specialChars(data.message.text)+'<br><div class="ws-chat-autoreply-link"><a data-index="'+data.auto_reply_index+'" class="ws-chat-autoreply-btn" href="#">'+text_btn+"</a></div>"}var cookieDate=new Date;cookieDate.setMinutes(cookieDate.getMinutes()+43200),wsUtil.setCookie("WidgetChat_autoreply_getcontact_"+WBK.settings.chatId,!0,cookieDate)}else data.message=wsUtil.specialChars(data.message.text);break;case"attach_image":s.messages_quant_to_rate++;var link="";switch(data.message.img_type){case"link":link=data.message.img_url;break;case"uploaded":link=WBK.settings.serverUrl+"/chat/download/?type=image&file="+data.message.file_name_upload+"&filename="+data.message.file_name+"&chat="+WBK.settings.chatId}data.message='<a class="ws-chat-message-element"  data-file-name="'+data.message.file_name+'" data-file-name-upload="'+data.message.file_name_upload+'" href="'+link+'" target="_blank"><img class="ws-chat-message-img" src="'+data.message.img_url+'"><div class="ws-foto-hover"></div><div class="ws-foto-hover-img"></div></a>';break;case"attach_file":s.messages_quant_to_rate++;var file='<div class="ws-file-block"><div class="ws-file-el"><img class="ws-icon-file" src="'+WBK.settings.staticServerUrl+"/"+data.message.file_ico_url+'"> <div class="ws-file-size">'+data.message.file_size+" "+data.message.file_size_type+'</div></div><div class="ws-file-name">'+data.message.file_name+'</div></div><div class="ws-file-hover"></div>';data.message='<a class="ws-chat-message-element ws-chat-message-element-file" data-file-name="'+data.message.file_name+'" data-file-name-upload="'+data.message.file_name_upload+'" href="'+WBK.settings.serverUrl+"/chat/download/?type=doc&file="+data.message.file_name_upload+"&filename="+data.message.file_name+"&chat="+WBK.settings.chatId+'" target="_blank">'+file+"</a>";break;case"connect_to_chat":var userName=data.message.user_name+(data.message.user_surname?" "+data.message.user_surname:"");data.date.date_line&&w.window.find(".ws-chat-typing").before('<div class="ws-chat-date-block">'+data.date.date_line+"</div>");var profession=data.message.user_profession?data.message.user_profession:"",join_block='<div class="ws-chat-manager-join"><img src="'+WBK.settings.staticServerUrl+data.message.img_url+'" alt="" class="ws-manager-img"><div class="ws-manager-name">'+userName+'</div><div class="ws-manager-position">'+profession+'</div><div class="ws-manager-event">'+s.lang_text.join_chat+"</div></div>";return w.window.find(".ws-chat-typing").before(join_block),!1;case"disconnect_from_chat":var userName=data.message.user_name+(data.message.user_surname?" "+data.message.user_surname:"");data.date.date_line&&w.window.find(".ws-chat-typing").before('<div class="ws-chat-date-block">'+data.date.date_line+"</div>");var profession=data.message.user_profession?data.message.user_profession:"",join_block='<div class="ws-chat-manager-join"><img src="'+WBK.settings.staticServerUrl+data.message.img_url+'" alt="" class="ws-manager-img"><div class="ws-manager-name">'+userName+'</div><div class="ws-manager-position">'+profession+'</div><div class="ws-manager-event">'+s.lang_text.disconnect_from_chat+"</div></div>";return w.window.find(".ws-chat-typing").before(join_block),!1}data.date.date_line&&w.window.find(".ws-chat-typing").before('<div class="ws-chat-date-block">'+data.date.date_line+"</div>");var message='<div id="mess_'+data.hash+'" data-read="'+read+'" class="ws-chat-message"><div class="ws-chat-message-source">'+data.message+'</div><div class="ws-chat-message-date">'+data.date.time+"</div></div>",last_block=w.window.find(".ws-chat-body-content").children(":not(.ws-chat-typing,.ws-chat-uploaded-files)").last();switch(data.type){case"manager":s.last_operator_message_id=data.id?data.id:s.last_operator_message_id,mess_block_class="ws-chat-message-manager",last_user=last_block.data("user")==data.user;var op=this.getOperator(data.user);op&&(name=op.name+(op.surname?" "+op.surname:""));break;case"user":name=s.user_name?s.user_name:s.lang_text.default_user,mess_block_class="ws-chat-message-user"}if((last_block.hasClass("ws-chat-robot-hello")||last_block.hasClass("ws-chat-manager-hello"))&&last_block.css("padding-bottom","10px"),!data.date.new_block&&last_block.hasClass(mess_block_class)&&last_user)last_block.find(".ws-chat-message-date").remove(),last_block.find(".ws-chat-message:last").after(message),data.is_read||"user"!=data.type||last_block.find(".ws-chat-message-status").text(status).addClass("ws-chat-message-status");else{var logo_block="",message_status_block="",title_name="";if("manager"==data.type){var op=this.getOperator(data.user);logo_block='<div class="ws-chat-message-logo"><img class="ws-chat-message-logo-img" src="'+WBK.settings.staticServerUrl+op.img+'"></div>'}else{var logo_visitor=_this.logoVisitor(!1);logo_block='<div class="ws-chat-message-logo">'+logo_visitor+"</div>",message_status_block='<div class="ws-chat-message-status">'+status+"</div>",title_name=s.lang_text.change_name_title}var new_block='<div class="ws-chat-message-block '+mess_block_class+'" data-user="'+data.user+'">'+logo_block+'<div class="ws-chat-message-name"><span class="ws-chat-message-name-text" data-name="'+name+'" title="'+title_name+'">'+name+"</span></div>"+message+message_status_block+"</div>";w.window.find(".ws-chat-typing").before(new_block)}return data.user||data.is_read&&parseInt(data.is_read)||(w.window.find(".ws-chat-message-status:last").addClass("ws-chat-message-status-hidden"),wsUtil.setTimeout("show_message_status",function(){var el=w.window.find(".ws-chat-message-status.ws-chat-message-status-hidden");el.removeClass("ws-chat-message-status-hidden"),WBK.animateOnce(el,"cbk-flipInY")},1e3)),"manager"==data.type&&data.user&&_this.updateIcoBottom(data.user),!WBK.settings.chatWindowOpened||"attach_image"!=data.message_type&&"attach_file"!=data.message_type||w.window.find(".ws-chat-body-content img:last").load(function(){_this.scroll()}),_this.typingPositionUpdate(),data.scroll&&_this.scroll(),!0},getOperator:function(user_id){var user={img:"/img/avatars/nophoto.png",is_alias:0,name:s.lang_text.operator,surname:!1,profession:"",status:0,user_logo:"/img/avatars/nophoto.png"};return"undefined"!=typeof s.all_operators[user_id]&&(user=s.all_operators[user_id]),user},logoVisitor:function(update){var logo_visitor='<img class="ws-chat-message-logo-img" src="'+s.default_logo_visitor+'">';if("vk"!=s.auth_type&&"fb"!=s.auth_type||!s.logo_visitor){if(s.user_name){var first_letter=s.user_name.substr(0,1).toUpperCase();logo_visitor='<div class="ws-chat-message-logo-letter">'+first_letter+"</div>",update&&w.window.find(".ws-chat-message-user").find(".ws-chat-message-logo-letter").html(logo_visitor)}}else logo_visitor='<img class="ws-chat-message-logo-img" src="'+s.logo_visitor+'">',update&&w.window.find(".ws-chat-message-user").find(".ws-chat-message-logo").html(logo_visitor);return logo_visitor},playSound:function(type){if("off"!=s.sound){var file="";switch(type){case"message":file="chat1";break;case"send_message":break;case"operator_join":file="chat1"}WBK.Sound(file)}},typing:function(data,time,delayTime){var _this=this;void 0==time&&(time=5e3);var user=data.user_id+"_"+data.employee_id,op=this.getOperator(user),operator_name=op.name?op.name:s.lang_text.operator;w.window.find(".ws-chat-typing").find(".ws-manager-name").text(operator_name),_this.typingPositionUpdate(),w.window.find(".ws-chat-typing").removeClass("ws-chat-typing-removing"),wsUtil.setTimeout("chatTypingActivateTimeout",function(){w.window.find(".ws-chat-typing").addClass("ws-chat-typing-active")},300);var timeToShow=time;wsUtil.setTimeout("chatTypingTimeout",function(){w.window.find(".ws-chat-typing").removeClass("ws-chat-typing-active").addClass("ws-chat-typing-removing")},timeToShow)},typingPositionUpdate:function(){var bodyHeight=w.window.find(".ws-chat-body-content").height(),afterHeight=0,beforeHeight=w.window.find(".ws-chat-typing").outerHeight()+w.window.find(".ws-chat-uploaded-files").outerHeight();w.window.find(".ws-chat-body-content").children(":not(.ws-chat-typing,.ws-chat-uploaded-files)").each(function(i,e){if(afterHeight+=$(e).outerHeight(),bodyHeight<afterHeight)return!1});var outHeight=bodyHeight-afterHeight-6,marginTop=0;outHeight>beforeHeight&&(marginTop=outHeight-beforeHeight),w.window.find(".ws-chat-typing").css("marginTop",marginTop)},operatorClosed:function(){w.window.removeClass("ws-chat-ico-bottom"),w.window.find(".ws-chat-ico-container").empty(),s.chat_created=!1},getTimeClosedChat:function(){return wsUtil.getStorage("ws_time_closed_chat")},updateTimeClosedChat:function(){wsUtil.setStorage("ws_time_closed_chat",(new Date).getTime())},operatorJoin:function(data){wsUtil.deleteInterval("chatCreatedCrazyCycle");var user=data.user_id+"_"+data.employee_id;if(!s.chat_operators.hasOwnProperty(user)){user!=s.invitation_operator_id?(_this.addMessage({id:data.id,hash:data.hash,message:JSON.parse(data.message),date:data.created_at,user:user,is_read:!1,message_type:data.type,scroll:!0}),_this.playSound("operator_join")):s.invitation_operator_id=!1;var op=this.getOperator(user);s.chat_operators[user]={employee_id:data.employee_id,name:op.name+(op.surname?" "+op.surname:""),user_id:data.user_id,gcm_registration_id:op.gcm_registration_id},_this.operatorsUpdate(),s.send_autoreply=!0,s.send_autoreply_first=!1,_this.getAutoReply(),_this.scroll(),_this.sendGoal("operator_connect")}},operatorExit:function(data){var user=data.user_id+"_"+data.employee_id;_this.addMessage({id:data.id,hash:data.hash,message:JSON.parse(data.message),date:data.created_at,user:user,chat-typing-active").addClass("ws-chat-typing-removing"),s.chat_operators.hasOwnProperty(user)&&delete s.chat_operators[user],_this.operatorsUpdate(),_this.scroll()},onVisitorMessage:function(data){if("show_invitation"!=data.data.type&&"auto_reply"!=data.data.type){if("rating"==data.data.type)return data.data.message=JSON.parse(data.data.message),s.chatRate=data.data.message.rate,void _this.addMessageRobot(data.data);var scroll=!1;WBK.settings.chatWindowOpened&&(scroll=!0),_this.addMessage({id:data.data.id,hash:data.data.hash,type:"user",message:JSON.parse(data.data.message),date:data.data.created_at,user:!1,is_read:!1,message_type:data.data.type,scroll:scroll}),_this.playSound("message"),this.checkRatingSettings()}},onVisitorMessageRead:function(){_this.messageReadVisitor(!0)},socketConnected:function(data,callback){s.chat_created?_this.reconnect():s.chat_created||"undefined"!=typeof callback&&callback(data)},onOperatorStatus:function(data){1==data.status?(wsUtil.deleteTimeout("chatOperatorsUpdate"),_this.operatorsUpdate(data)):wsUtil.setTimeout("chatOperatorsUpdate",function(){_this.operatorsUpdate(data)},15e3)},onConnectToChat:function(data){s.last_operator_data={user_id:data.user_id,employee_id:data.employee_id},jWS.isEmptyObject(s.autoreplies)||_this.stopAutoReply("not_connected"),_this.operatorJoin(data)},onDisconnectFromChat:function(data){_this.operatorExit(data),jWS.isEmptyObject(s.autoreplies)||_this.stopAutoReply("all")},onCloseChat:function(data){_this.operatorClosed(),_this.stopAutoReply("all"),_this.updateTimeClosedChat()},onOperatorPrinting:function(data){jWS.isEmptyObject(s.autoreplies)||_this.stopAutoReply("all"),_this.typing(data),jWS.isEmptyObject(s.aut},onOperatorMessage:function(data){var user=data.user_id+"_"+data.employee_id;s.last_operator_data={user_id:data.user_id,employee_id:data.employee_id},wsUtil.deleteTimeout("chatTypingTimeout"),w.window.find(".ws-chat-typing").removeClass("ws-chat-typing-active").addClass("ws-chat-typing-removing");var scroll=!1;WBK.settings.chatWindowOpened&&(scroll=!0);var addMessageResult=_this.addMessage({id:data.id,hash:data.hash,type:"manager",message:JSON.parse(data.message),date:!1,user:user,is_read:!1,message_type:data.type,scroll:scroll});addMessageResult&&(_this.playSound("message"),_this.messageReceived(data),s.unread_messages_count+=1),s.unread_messages[data.hash]={id:data.id,hash:data.hash},w.window.find(".ws-textarea").is(":focus")?_this.messageReadVisitor(!1):addMessageResult&&_this.setUnreadMessages(s.unread_messages_count),WBK.settings.chatWindowOpened||WBK.settings.windowOpened||WBK.settings.windowGeneratorOpened||WBK.settings.videoWidgetOpened||WBK.settings.windowQuizOpened||"pc"!=WBK.settings.device||_this.showWidget(),s.send_autoreply=!0,jWS.isEmptyObject(s.autoreplies)||_this.stopAutoReply("not_answer_operator"),this.checkRatingSettings()},onOperatorUpdateMessage:function(data){data.user_id+"_"+data.employee_id;wsUtil.deleteTimeout("chatTypingTimeout"),w.window.find(".ws-chat-typing").removeClass("ws-chat-typing-active").addClass("ws-chat-typing-removing"),data.message=JSON.parse(data.message),$("#mess_"+data.hash+" .ws-chat-message-source").html(data.message.text)},onMessageRead:function(data){_this.messageReadOperator(data.hash)},onUpdateRegistrationId:function(data){var user=data.user_id+"_"+data.employee_id;s.all_operators[user]&&(s.all_operators[user].gcm_registration_id=data.registration_id),s.chat_operators[user]&&(s.chat_operators[user].gcm_registration_id=data.registration_id)},reconnect:function(){$.getJSON(WBK.settings.serverUrl+"/chat/api/",{action:"getUnreadMessages",chatId:WBK.settings.chatId,chatWidgetId:WBK.settings.chatWidgetId,visitorId:WBK.settings.visitorId,lastOperatorMessageId:s.last_operator_message_id?s.last_operator_message_id:0},function(result){if(result.success&&result.data.messages){var scroll=!1;WBK.settings.chatWindowOpened&&(scroll=!0);var messages=result.data.messages,chatIsClosed=!1;for(var id in messages)if(!s.unread_messages.hasOwnProperty(messages[id].hash)){_this.messageReceived(messages[id]),"close_chat"==messages[id].type&&(chatIsClosed=!0);var user=messages[id].user_id+"_"+messages[id].employee_id;_this.addMessage({id:messages[id].id,hash:messages[id].hash,type:"manager",message:JSON.parse(messages[id].message),date:!1,user:user,is_read:!1,message_type:messages[id].type,scroll:scroll}),s.unread_messages[messages[id].hash]={id:messages[id].id,hash:messages[id].hash},s.unread_messages_count+=1,w.window.find(".ws-textarea").is(":focus")?_this.messageReadVisitor(!1):_this.setUnreadMessages(s.unread_messages_count)}chatIsClosed&&(_this.messageReadVisitor(!1),_this.operatorClosed())}})},setTemplate:function(){var btn='<div class="ws-chat-btn-el-container envy-not-scalling"><div class="ws-chat-btn-container ws-chat-btn-mini-hover"><div class="ws-btn-badge"></div><div class="ws-btn-ico"><div class="ws-chat-logo"><i class="ws-icon-chat" style="color: '+s.color_background_button+'"></i><img src="'+s.chat_widget_logo+'" class="ws-chat-logo-img"><div class="ws-chat-status-round ws-chat-status-online"></div></div></div><div class="ws-btn-title"></div></div><div class="ws-chat-invitation-container"><div class="ws-chat-invitation-close"><i class="ws-icon-close"></i></div><div class="ws-chat-invitation-body"><div class="ws-chat-invitation-logo"></div><div class="ws-chat-invitation-body-el"><div class="ws-chat-invitation-body-text"></div></div></div><div class="ws-chat-invitation-form"><input type="text" class="ws-chat-invitation-input" placeholder="'+s.lang_text.form_message_placeholder+'"></div></div></div>';if("pc"!=WBK.settings.device)var btn='<div class="ws-chat-btn-el-container envy-not-scalling"><div class="ws-chat-btn-container ws-chat-btn-mini-hover"><div class="ws-btn-badge"></div><div class="ws-btn-ico"><div class="ws-chat-logo"><i class="ws-icon-chat" style="color: '+s.mobile_color_background_button+'"></i><img src="'+s.chat_widget_logo+'" class="ws-chat-logo-img"><div class="ws-chat-status-round ws-chat-status-online"></div></div></div></div><div class="ws-chat-invitation-container"><div class="ws-chat-invitation-input">'+s.lang_text.form_message_placeholder+'</div><div class="ws-chat-invitation-close"><i class="ws-icon-close"></i></div><div class="ws-chat-invitation-body"><div class="ws-chat-invitation-logo"></div><div class="ws-chat-invitation-body-el"><div class="ws-chat-invitation-body-text"></div></div></div></div></div>';s.text_button_online=this.safe_tags(s.text_button_online),t='<div class="ws-chat"><div class="ws-chat-container ws-chat-round" style="background: '+s.color_background_window+'"><div class="ws-chat-header" style="background: '+s.color_background_chat_header+'"><div class="ws-chat-logo"><i class="ws-icon-chat"></i><img src="'+s.chat_widget_logo+'" class="ws-chat-logo-img"><div class="ws-chat-status-round ws-chat-status-online"></div></div><div class="ws-chat-title" style="color: '+s.color_background_chat_header_text+'">'+s.text_button_online+'</div><a class="ws-chat-close" style="color: '+s.color_background_chat_header_text+'" href="javascript:void(0)" title="'+s.lang_text.close_title+'"><i class="ws-icon-close" style="color: '+s.color_background_chat_header_text+'"></i></a><a class="ws-chat-sound" style="color: '+s.color_background_chat_header_text+'" href="javascript:void(0)" title="'+s.lang_text.sound_off+'"><i class="ws-icon-sound-on" style="color: '+s.color_background_chat_header_text+'"></i></a></div><div class="ws-chat-body"><div class="ws-chat-rating">'+s.lang_text.rate_request+'<div class="ws-chat-rating-btns ws-chat-rating-btns-'+s.rate_chat_view+'"><a class="ws-chat-rating-el ws-chat-rating-el-1" href="javascript:void(0)" data-value="1" title="'+s.lang_text.rate_text_1+'"><img src="'+WBK.settings.staticServerUrl+'/widget/img/blank.gif" alt=""></a><a class="ws-chat-rating-el ws-chat-rating-el-2" href="javascript:void(0)" data-value="2" title="'+s.lang_text.rate_text_2+'"><img src="'+WBK.settings.staticServerUrl+'/widget/img/blank.gif" alt=""></a><a class="ws-chat-rating-el ws-chat-rating-el-3" href="javascript:void(0)" data-value="3" title="'+s.lang_text.rate_text_3+'"><img src="'+WBK.settings.staticServerUrl+'/widget/img/blank.gif" alt=""></a><a class="ws-chat-rating-el ws-chat-rating-el-4" href="javascript:void(0)" data-value="4" title="'+s.lang_text.rate_text_4+'"><img src="'+WBK.settings.staticServerUrl+'/widget/img/blank.gif" alt=""></a><a class="ws-chat-rating-el ws-chat-rating-el-5" href="javascript:void(0)" data-value="5" title="'+s.lang_text.rate_text_5+'"><img src="'+WBK.settings.staticServerUrl+'/widget/img/blank.gif" alt=""></a></div></div><div class="ws-chat-shadow" style="background: linear-gradient(to bottom, '+s.color_background_window+' 0%,rgba(255,255,255,0) 100%)"></div><div class="ws-chat-body-content"><div class="ws-chat-typing"><span class="ws-chat-typing-action"><i class="ws-icon-typing"></i></span><span class="ws-manager-name"></span> '+s.lang_text.typing+'...</div><div class="ws-chat-uploaded-files"></div></div></div><div class="ws-chat-body-offline" style="display: none"><div class="ws-chat-offline-text">'+s.offline_text+'</div><div class="ws-chat-offline-text-success">'+s.lang_text.offline_text_success+'</div><div class="ws-offline-input-group '+("hide"==s.get_contact_offline_name?"ws-hide":"")+'"><div class="ws-offline-input-label">'+s.lang_text.form_name+'<span class="ws-input-required">'+("yes"==s.get_contact_offline_name?" *":"")+'</span></div><input type="text" class="ws-offline-input ws-offline-name" placeholder="'+s.lang_text.form_name_placeholder+'" value="'+s.user_name+'"></div><div class="ws-offline-input-group '+("hide"==s.get_contact_offline_phone?"ws-hide":"")+'"><div class="ws-offline-input-label">'+s.lang_text.form_phone+'<span class="ws-input-required">'+("yes"==s.get_contact_offline_phone?" *":"")+'</span></div><input type="tel" class="ws-offline-input ws-offline-phone" placeholder="'+s.lang_text.form_phone_placeholder+'" value="'+s.user_phone+'"></div><div class="ws-offline-input-group '+("hide"==s.get_contact_offline_email?"ws-hide":"")+'"><div class="ws-offline-input-label">'+s.lang_text.form_email+'<span class="ws-input-required">'+("yes"==s.get_contact_offline_email?" *":"")+'</span></div><input type="email" class="ws-offline-input ws-offline-email" placeholder="'+s.lang_text.form_email_placeholder+'" value="'+s.user_email+'"></div><div class="ws-offline-input-group"><div class="ws-offline-input-label">'+s.lang_text.form_message_placeholder+'<span class="ws-input-required">'+("yes"==s.get_contact_offline_message?" *":"")+'</span></div><div contenteditable="true" class="ws-offline-textarea"></div><div class="ws-offline-textarea-element"><a class="ws-offline-textarea-btn ws-btn-smile" href="javascript:void(0)"><i class="ws-icon-smile"></i></a><div class="ws-smile-container ws-smile-container-offline"></div></div></div><div class="ws-offline-input-group'+(parseInt(s.email_agreement)?"":" ws-hide")+'"><label class="ws-offline-label-agreement"><input type="checkbox" class="ws-offline-email-agreement" checked><span class="ws-offline-email-agreement-text">'+s.email_agreement_text+s.lang_text.email_agreement_text_agreement+'</span></label></div><div class="ws-offline-input-group ws-offline-input-group-btn"><a href="javascript:void(0)" class="ws-offline-btn">'+s.lang_text.offline_btn+'</a></div></div><div class="ws-chat-body-preform" style="display: none"><div class="ws-chat-preform-text"></div><div class="ws-chat-preform-social"><a href="javascript:void(0)" class="ws-chat-social-el ws-chat-social-vk"><img class="ws-chat-social-img" src="'+WBK.settings.staticServerUrl+'/widget/img/vk.png"></a><a href="javascript:void(0)" class="ws-chat-social-el ws-chat-social-fb"><img class="ws-chat-social-img" src="'+WBK.settings.staticServerUrl+'/widget/img/fb.png"></a></div><div class="ws-preform-input-group"><div class="ws-preform-input-label"></div><input type="text" class="ws-preform-input ws-preform-name" placeholder="'+s.lang_text.form_name_placeholder+'" value="'+s.user_name+'"></div><div class="ws-preform-input-group"><div class="ws-preform-input-label"></div><input type="tel" class="ws-preform-input ws-preform-phone" placeholder="'+s.lang_text.form_phone_placeholder+'" value="'+s.user_phone+'"><input type="text" class="cbk-phone-checker white-saas-generator-input-hidden"/></div><div class="ws-preform-input-group"><div class="ws-preform-input-label"></div><input type="email" class="ws-preform-input ws-preform-email" placeholder="'+s.lang_text.form_email_placeholder+'" value="'+s.user_email+'"></div><div class="ws-preform-input-group ws-preform-input-group-text"><div class="ws-preform-input-label ws-preform-email-text">'+s.lang_text.email_exit+'</div></div><div class="ws-preform-input-group ws-preform-input-group-text"><label class="ws-preform-label-agreement"><span class="ws-preform-email-agreement-text">'+s.email_agreement_text+s.lang_text.email_agreement_text_agreement+'</span></label></div><div class="ws-preform-input-group ws-preform-input-group-btn"><a href="javascript:void(0)" class="ws-preform-btn-cancel">'+s.lang_text.offline_btn_cancel+'</a><a href="javascript:void(0)" class="ws-preform-btn ws-preform-btn-save">'+s.lang_text.preform_btn+'</a></div></div><div class="ws-chat-footer"><div class="ws-textarea-element"><a class="ws-textarea-btn ws-btn-file" href="javascript:void(0)"><i class="ws-icon-file"></i></a><a class="ws-textarea-btn ws-btn-smile" href="javascript:void(0)"><i class="ws-icon-smile"></i></a><div class="ws-smile-container"></div><div class="ws-file-container"><div class="ws-file-element ws-file-doc"><i class="ws-icon-document"></i>'+s.lang_text.file+'<input type="file" class="ws-file-upload ws-file-doc-upload" name="ws-doc" data-type="doc" accept="'+s.allow_mime_file+'"></div><div class="ws-file-element ws-file-foto"><i class="ws-icon-image"></i>'+s.lang_text.image+'<input type="file" class="ws-file-upload ws-file-img-upload" name="ws-img" data-type="img" accept="'+s.allow_mime_img+'"></div></div></div><div class="ws-textarea-group"><div contenteditable="true" class="ws-textarea" placeholder="Введите сообщение"></div><div class="ws-textarea-send-btn" title="'+s.lang_text.send_btn_title+'"><i class="ws-icon-enter"></i></div></div></div><div class="ws-chat-copyright"><a href="'+s.partnerLink+'" class="ws-chat-copyright-url" target="_blank" data-widget="chat">'+s.lang_text.text_link+'</a></div><div class="ws-chat-resize" style="color: '+s.color_background_chat_header+'"><i class="ws-icon-resize"></i></div><div class="ws-chat-ico-container"></div></div>'+btn+"</div>"},setSettings:function(settings){var defaultSettings={dragChatObject:{},resizeChatObject:{},chat_created:!1,chat_old_time:!1,chat_timezone:3,unread_messages:{},unread_messages_count:0,document_title:document.title,document_favicon_href:$('link[rel="shortcut icon"]').length?$('link[rel="shortcut icon"]').attr("href"):$('link[rel="icon"]').attr("href"),new_favicon_href:"",input_scroll:!1,
auth_type:"default",default_logo_visitor:WBK.settings.staticServerUrl+"/widget/img/user.png",agreementLink:"https://whitesaas.com/agreement/",logo_visitor:!1,is_first_message:!1,first_message:!1,bottom_body:62,height_input:56,allow_mime_file:".pdf,.txt,.doc,.docx,.xls,.xlsm,.rar,.zip",allow_mime_img:"image/png,image/jpg,image/jpeg,image/gif",invitation_show_data:!1,invitation_operator_id:!1,last_operator_message_id:!1,last_operator_data:!1,send_autoreply:!1,send_autoreply_first:!1,show_one_invitation:!1,fileUploaded:{},fileUploadedCount:0,chatCreating:!1,scallingMobile:!1,offline_message_sending:!1,scroll_left:0,scroll_top:0,containerSize:0,show_contact_form_inside_chat:0,autoCall:0,autoCallText:"0",autoCallDeffered:0,autoCallDefferedDelay:0,disableMobileOpenHash:0,smilesCodes:{"1f601":"😁","1f602":"😂","1f603":"😃","1f604":"😄","1f605":"😅","1f606":"😆","1f609":"😉","1f60a":"😊","1f60b":"😋","1f60c":"😌","1f60d":"😍","1f60f":"😏","1f612":"😒","1f613":"😓","1f614":"😔","1f616":"😖","1f618":"😘","1f61a":"😚","1f61c":"😜","1f61d":"😝","1f61e":"😞","1f620":"😠","1f621":"😡","1f622":"😢","1f623":"😣","1f624":"😤","1f625":"😥","1f628":"😨","1f629":"😩","1f62a":"😪","1f62b":"😫","1f62d":"😭","1f630":"😰"}};$.extend(!0,s,defaultSettings),$.extend(!0,s,setafe_tags:function(str){return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}}}(jWS),wsChatNew=function($){var _this,s,t,w,_debug;return{settings:{},templates:{},widget:{},init:function(data){_this=this,s=this.settings,t=this.templates,w=this.widget,$.fn._frameCheck()&&"undefined"==typeof WBK&&(WBK=document.WBK),_debug=WBK.checkDebug(),this.initSettings(data)},initSettings:function(data){_this.setSettings(data.Data.chat),WBK.settings.chatWidgetId=parseInt(data.Settings.chatWidgetId);var data=data.Data.chat;WBK.settings.chatEnabled=!0,WBK.settings.chatId=!!data.chatId&&parseInt(data.chatId),s.chatKey=data.chatKey;var firstMessage=wsUtil.getCookie("WidgetChat_first_message_"+WBK.settings.chatWidgetId);firstMessage&&(s.first_message=JSON.parse(firstMessage)),s.v2_local?_this.initLocalBase().then(function(){_this.loader(data)}):_this.initFirebase().then(function(){_this.loader(data)})},loader:function(data){s.free_chat_widget=parseInt(s.free_chat_widget),s.online_visitor_enable=parseInt(s.online_visitor_enable),s.online_visitor_enable||_debug&&_this.log("Посетители онлайн отключены"),data.auto_call&&(s.autoCall=parseInt(data.auto_call)),data.auto_call_text&&(s.autoCallText=data.auto_call_text),data.auto_call_deffered&&(s.autoCallDeffered=parseInt(data.auto_call_deffered)),data.auto_call_deffered_delay&&(s.autoCallDefferedDelay=parseInt(data.auto_call_deffered_delay)),data.use_telephony_mask&&(s.useTelephonyMask=parseInt(data.use_telephony_mask)),s.free_chat_widget&&_debug&&_this.log("Бесплатная версия чата"),parseInt(s.always_online)&&!s.free_chat_widget&&$.each(s.all_operators,function(index,value){s.all_operators[index].online=!0});var checkWorkDays=_this.checkWorkDays();if(_debug&&_this.log("Рабочее время: "+checkWorkDays),s.chat_is_online=_this.operatorsIsOnline()&&checkWorkDays||parseInt(s.always_online),s.partnerLink||(s.partnerLink="http://"+WBK.settings.servicedomain+"?utm_source=widget&utm_medium=self&utm_campaign="+location.hostname+"&utm_content=chat&utm_term="),s.widget_logo=parseInt(data.img_logo),s.img_robot_logo=parseInt(data.img_robot_logo),s.img_robot_logo_service=parseInt(data.img_robot_logo_service),s.chat_widget_logo=WBK.settings.staticServerUrl+"/widget/img/chat_robot.png",s.chat_widget_logo_robot=s.chat_widget_logo,s.img_robot_logo_service){var d=new Date;s.chat_widget_logo_robot=WBK.settings.staticServerUrl+"/uploaded/chat_widgets_service/"+WBK.settings.serviceid+"/logo_robot.png?"+d.getTime()}if(s.img_robot_logo){var d=new Date;s.chat_widget_logo_robot=WBK.settings.staticServerUrl+"/uploaded/chat_widgets/"+WBK.settings.chatWidgetId+"/logo_robot.png?"+d.getTime()}if(s.widget_logo){var d=new Date;s.chat_widget_logo=WBK.settings.staticServerUrl+"/uploaded/chat_widgets/"+WBK.settings.chatWidgetId+"/logo.png?"+d.getTime()}switch(s.btn_corner_class="",s.corner_type){case"smooth":s.btn_corner_class="ws-chat-btn-mini-round";break;case"flat":s.btn_corner_class="";break;case"round":s.btn_corner_class="ws-chat-btn-round"}s.auto_reply_not_connected_and_operators_offline_need_to_show=!1,s.disableMobileOpenHash=parseInt(data.disable_mobile_open_hash),s.chat_introduced=data.chat_introduced?parseInt(data.chat_introduced):0,s.logo_visitor=!!parseInt(s.chat_introduced)&&s.chat_visitor_img,_this.updateUser(),_this.setTemplate(),_this.initWidget()},initWidget:function(){WBK.loadFont(),WBK.addStyles(".ws-chat-message-manager .ws-chat-message, .ws-chat-message-robot .ws-chat-message, .ws-chat-message-manager:before, .ws-chat-message-robot:before{background-color: "+s.color_background_message_operator+" !important;}.ws-chat-message-user .ws-chat-message, .ws-chat-message-user:before{background-color: "+s.color_background_message_user+" !important;}.ws-chat-message-manager .ws-chat-message-source, .ws-chat-message-manager .ws-chat-message-date, .ws-chat-message-robot .ws-chat-message-source, .ws-chat-message-robot .ws-chat-message-date{color: "+s.color_text_message_operator+" !important;}.ws-chat .ws-chat-container .ws-chat-message-source .ws-chat-message-link, .ws-chat .ws-chat-container .ws-chat-message-source .ws-chat-message-link:visited, .ws-chat .ws-chat-container .ws-chat-message-source .ws-chat-message-link:active{color: "+s.color_text_message_operator+" !important;}.ws-chat .ws-chat-container .ws-chat-message-source .ws-chat-message-link:hover{color: "+s.color_text_message_operator+" !important;}.ws-chat-message-user .ws-chat-message-source, .ws-chat-message-user .ws-chat-message-date{color: "+s.color_text_message_user+" !important;}.ws-chat .ws-chat-container .ws-chat-message-user .ws-chat-message-source .ws-chat-message-link, .ws-chat .ws-chat-container .ws-chat-message-user .ws-chat-message-source .ws-chat-message-link:visited, .ws-chat .ws-chat-container .ws-chat-message-user .ws-chat-message-source .ws-chat-message-link:active{color: "+s.color_text_message_user+" !important;}.ws-chat .ws-chat-container {background-color: "+s.color_background_window+" !important;}.ws-chat .ws-chat-container:before {background-color: "+s.color_background_window+" !important;}.ws-chat .ws-chat-container .ws-chat-message-user .ws-chat-message-source .ws-chat-message-link:hover{color: "+s.color_text_message_user+" !important;}.ws-chat .ws-chat-invitation-container{background-color: "+s.color_background_invitation+" !important;}.ws-chat .ws-chat-invitation-text{background-color: "+s.color_background_invitation_message+" !important;}.ws-chat .ws-chat-invitation-body-text:before{background-color: "+s.color_background_invitation_message+" !important;}.ws-chat .ws-chat-invitation-input{background-color: "+s.color_background_invitation_input+" !important;}.ws-chat .ws-chat-invitation-name{color: "+s.color_text_invitation+" !important;}.ws-chat .ws-chat-invitation-position{color: "+s.color_text_invitation+" !important;}.ws-chat .ws-chat-invitation-container .ws-icon-close{color: "+s.color_text_invitation+" !important;}.ws-chat .ws-chat-invitation-typing{color: "+s.color_text_invitation+" !important;}.ws-chat .ws-chat-invitation-container .ws-chat-invitation-body .ws-chat-invitation-body-el .ws-chat-invitation-text{color: "+s.color_text_invitation_message+" !important;}.ws-chat .ws-chat-invitation-container .ws-chat-invitation-body .ws-chat-invitation-body-el .ws-chat-invitation-text a{color: "+s.color_text_invitation_message+" !important; text-decoration: underline !important;}.ws-chat .ws-chat-body-content .ws-chat-message-with-pick-department .ws-chat-message-option-pick-department:hover {background-color:"+_this.makeOpacityColor(s.color_background_message_operator,2)+"}.ws-chat .ws-chat-body-content .ws-chat-message-robot-pick-department:before {background-color: #fff !important;}.ws-chat .ws-chat-shadow {background: linear-gradient(to bottom, "+s.color_background_window+" 0%,rgba(255,255,255,0) 100%);}"),w.container=$(t),w.window=w.container.find(".ws-chat-container").hide(),w.btn=w.container.find(".ws-chat-btn-container").hide(),w.btn_el=w.container.find(".ws-chat-btn-el-container"),w.invitation=w.container.find(".ws-chat-invitation-container").hide(),w.container.appendTo("body"),wsUtil.fixFastClick(),4===+s.chat_distribution&&s.chat_department_distribution.length&&!s.chat_created&&$.each(s.chat_department_distribution,function(index,department){Object.keys(department.employees).length&&(s.chat_distribution_department_enabled=!0)});var title=s.text_button_online;"pc"!=WBK.settings.device?(w.container.addClass("ws-chat-mobile"),title=s.mobile_text_button_online,WBK.addStyles(".ws-chat .ws-chat-btn-container{background: "+s.mobile_color_background_button+"!important;}.ws-chat .ws-chat-btn-container .ws-btn-title{color: "+s.mobile_color_background_button_text+"!important;}")):(w.btn.addClass(s.btn_corner_class),WBK.addStyles(".ws-chat .ws-chat-btn-container{background: "+s.color_background_button+"!important;}.ws-chat .ws-chat-btn-container .ws-btn-title{color: "+s.color_background_button_text+"!important;}"),w.btn.find(".ws-btn-title").html(title)),s.widget_logo&&(w.window.addClass("ws-chat-logo-yes"),w.btn.addClass("ws-chat-btn-logo-yes")),(s.img_robot_logo||s.img_robot_logo_service)&&w.window.addClass("ws-chat-logo-robot-yes");var sound=wsUtil.getCookie("WidgetChat_sound_"+WBK.settings.chatWidgetId);if(sound?(s.sound=sound,"off"==s.sound?(w.window.find(".ws-chat-sound").attr("title",s.lang_text.sound_on),w.window.find(".ws-chat-sound i").removeClass("ws-icon-sound-on").addClass("ws-icon-sound-off")):(w.window.find(".ws-chat-sound").attr("title",s.lang_text.sound_off),w.window.find(".ws-chat-sound i").removeClass("ws-icon-sound-off").addClass("ws-icon-sound-on"))):"off"==s.sound&&(w.window.find(".ws-chat-sound").attr("title",s.lang_text.sound_on),w.window.find(".ws-chat-sound i").removeClass("ws-icon-sound-on").addClass("ws-icon-sound-off")),WBK.settings.hideCopyright?$(".ws-chat-copyright").hide():$("body").on("click",".ws-chat-copyright-url",function(e){WBK.sendAdvertLinkStat($(this).data("widget"),$(this).attr("href"),$(this).text(),WBK.settings.chatWidgetId)}),_this.loadBtnEvents(),_this.loadWindowEvents(),s.messages_quant_to_rate=0,s.chat_is_online)WBK.settings.chatId?(_this.addOldMessages(),_this.operatorsUpdate()):(s.operators_online_keys.length&&"roMessageOperators():_this.showHelloMessage(),s.is_first_message=!0,s.send_autoreply_first=!0),_this.initRating(),_this.checkRatingSettings();else{if("hide"==s.operator_offline_action)return _debug&&_this.log("Операторы офлайн и отключена оффлайн форма"),void _this.showOffline();_this.showOffline()}_this.initBtnPosition(),WBK.settings.chatId||"hide"==s.button_location||"pc"!=WBK.settings.device&&parseInt(s.hide_mobile)||_this.checkInvitation(),s.chat_invitation_has_scroll_rule&&$(window).on("scroll.callbackkillerchat",function(){_this.onScroll()}),s.agreementLink&&w.window.find(".ws-chat-agreement-link").attr("href",s.agreementLink);var _h;if(!$.fn._frameCheck()||"undefined"!=typeof WBK)try{_h=window.top.location.hash}catch(error){}wsUtil.getCookie("WidgetChat_opened_"+WBK.settings.chatWidgetId)&&wsUtil.getCookie("WidgetChat_settings_"+WBK.settings.chatWidgetId)&&s.chat_is_online?_this.showWidget():"#showchat"===_h?(_this.initWindowPosition(),_this.showWidget(),_this.sendGoal("open"),_this.autoSendMessage()):(w.btn.css("display","flex"),WBK.settings.chatBtnOpened=!0,wsUtil.getCookie("WidgetChat_opened_"+WBK.settings.chatWidgetId)&&wsUtil.deleteCookie("WidgetChat_opened_"+WBK.settings.chatWidgetId),_this.initWindowPosition(),("hide"==s.button_location||"pc"!=WBK.settings.desettings.chatBtnOpened=!1)),"pc"==WBK.settings.device||s.disableMobileOpenHash||$(window).on("hashchange",function(e){"-1"!=e.originalEvent.oldURL.search("#chatIsShown")&&WBK.settings.chatWindowOpened&&(_this.hideWidget(),window.location.hash="")}),_this.recalculateWidthButton(),w.window.find(".ws-offline-textarea, .ws-textarea").on("selectstart",function($e){return $e.stopPropagation(),!0}),w.window.find(".ws-offline-textarea, .ws-textarea").css("user-select","text"),_this.createVisitor()},loadFirebase:function(){var _t=this,p=$.Deferred();return wsUtil.getScript(WBK.settings.staticServerUrl+"/widget/src/libs/firebase/firebase.js",function(){var config={apiKey:s.FirebaseApiKey,authDomaintabaseURLMinProxy&&(wsUtil.setStorage("firebase:host:"+s.FirebaseDatabaseURLMin,'"'+s.FirebaseDatabaseURLMinProxy+'"'),wsUtil.deleteStorage("firebase:previous_websocket_failure")),s.firebase=firebase.initializeApp(config),s.FirebaseServiceRef="services/"+WBK.settings.serviceid+"/accounts/"+WBK.settings.accountid,s.fireDB=s.firebase.database().refs.chatKey&&promises.push("loadFireChat"),promises=promises.map(function(name){return _t[name]()}),$.when.apply($,promises).done(function(){_t.setupConnectionObserver(),p.resolve()})},!0),p.promise()},loadFireChat:function(){var _t=this,p=$.Deferred();return _t.getChatRef().once("value").then(function(snap){s.fireChat=snap.val(),_t.getChatRef().on("child_changed",function(snap){_this.updateFireChat(snap.key,snap.val())}),_t.getChatRef().on("child_added",function(snap){_this.updateFireChat(snap.key,snap.val())}),_t.getChatRef().on("child_removed",function(snap){_this.updateFireChat(snap.key,"")}),_t.startUpdateVisitorStatus(),s.chat_created||_this.loadFireChatData(snap.val()).then(function(){s.chat_created=!0,p.resolve()})}),p.promise()},setupConnectionObserver:function(){var _t=this;s.firebase.database().ref(".info/connected").on("value",function(connectedSnap){if(connectedSnap.val()){if(!s.chatKey)return;setTimeout(function(){_t.loadChatMessages.call(_t).then(function(){s.unread_m)}})},startUpdateVisitorStatus:function(){var _t=this;s.fireChat&&s.fireChat.visitor&&(_this.updateUserInBase(s.fireChat.visitor,{online:!0,lastActiveAt:{".sv":"timestamp"}}),_t.updateVisitorStatus(),wsUtil.setInterval("updateVisitorStatus",function(){s.fireChat&&s.fireChat.visitor&&_t.updateVisitorStatus()},2e4))},updateVisitorStatus:function(data){var data={key:s.fireChat.visitor,chatKey:s.chatKey,serviceId:WBK.settings.serviceid,accountId:WBK.settings.accountid,useLocalBase:s.v2_local},url=s.firebaseNodeUrl+"/visitor/setOnline";jWS.getJSON(url,data)},loadChatMessages:function(){var p=$.Deferred();return this.getChatMessageRef().once("value").then(function(snap){s.fireOldMessages=snap.val(),p.resolve()}),p.promise()},loadChatOtherUsers:function(data){var p=$.Deferred();return this.getChatUsersRef().child(data.visitor).once("value").then(function(value){var user=value.val();s.fireSender=value.key,s.fireUsers.hasOwnProperty("visitor")&&(user.name=s.fieUsers.visitor.photo),s.fireUsers[value.key]=user,p.resolve()}),p.promise()},loadFireChatData:function(data){var _t=this,p=$.Deferred();return $.when(this.loadChatMessages(),this.loadChatOtherUsers(data)).done(function(){_t.getChatMessageRef().orderByChild("sentAt").limitToLast(1).on("child_added",function(sender){var checkOperatorMessage="operator"==s.fireUsers[data.sender].role&&"system"!=data.type,checkSystemMessage="system"==data.type&&"pay_link"==data.subType,checkTextMessaage)&&(data.key=snap.key,_t.onOperatorMessage(data))}}),_t.getChatMessageRef().on("child_changed",function(snap){_t.updateMessanitLocalBase:function(){var p=$.Deferred();return wsUtil.getScript(WBK.settings.staticServerUrl+"/build/lib/js/chat_local_server.min.js",function(){ChatLocalServer.init(WBK.settings.serviceid,WBK.settings.accountid,WBK.settings.chatWidgetId,WBK.settings.visitorId,s.chat_server_url),parseInt(s.always_online)||parseInt(s.online_visitor_enable)&&!s.free_chat_widget?_this.loadOnlineLocalServer().then(function(){return p.resolve()}):_this.checkUserOnline().then(function(){return p.resolve()})}),p.promise()},checkUserOnline:function(){var p=$.Deferred();return ChatLocalServer.checkOperatorsOnline().then(function(data){return+data.online_count>0?void _this.loadOnlineLocalServer().then(function(data){p.resolve()}):p.resolve()}),p.promise()},loadOnlineLocalServer:function(){var p=$.Deferred();return this.initLocalSocket().then(function(){var promises=["getLocalUsers"];s.chatKey&&promises.push("loadLocalChat"),promises=promises.map(function(name){return _this[name]()}),$.when.apply($,promises).done(function(){p.resolve()})}),p.promise()},getLocalChat:function(){var p=$.Deferred();return ChatLocalServer.getWidgetChat(s.chatKey).then(function(data){return ChatLocalServer.listenChatUpdated(function(data){_this.updateChatDataListener(data)}),ChatLocalServer.listenChatDeleted(function(data){s.chat_created=!1,s.chatKey=null}.bind(_this)),p.resolve(data)}),p.promise()},updateChatDataListener:function(data){var allowKeys=["status","noAnswerRequired","operators","rate","visitorBlocked"];$.each(data,function(key,value){allowKeys.includes(key)&&_this.updateFireChat(key,value)})},loadLocalChatMessages:function(){var p=$.Deferred();return ChatLocalServer.getChatMessages(s.chatKey,s.last_message_id).then(function(data){return s.fireOldMessages=data,p.resolve(data)}),p.promise()},loadLocalChatVisitor:function(chatData){var p=$.Deferred();return ChatLocalServer.getChatVisitor(chatData.visitor,WBK.settings.visitorId).then(function(data){return s.fireSender=data.key,s.fireUsers.hasOwnProperty("visitor")&&(data.name=s.fireUsers.visitor.name,data.photo=s.fireUsers.visitor.photo),s.fireUsers[data.key]=data,p.resolve(data)}),p.pros().then(function(users){return s.fireUserKeys=Object.keys(users),s.fireUsers=users,s.all_operators=$.extend(!0,{},users),_this.subscribeLocalUsers(),_debug&&_this.log("Операторы: "+JSON.stringify(s.fireUsers)),p.resolve()}),p.promise()},subscribeLocalUsers:function(){ChatLocalServer.listenUserUpdated(function(user){var oldUser=null;s.fireUsers.hasOwnProperty(user.key)&&(oldUser=s.fireUsers[user.key]),s.fireUsers[user.key]=Object.assign(oldUser||{},user),(null==oldUser||null!==oldUser&&user.online!==oldUser.online)&&_this.operatorsUpdate()})},loadLocalUsers:function(){var p=$.Deferred();return ChatLocalServer.getWidgetUsnction(index,value){if(value){var data=value;if("operator"==data.role&&(users[value.key]=data,data.hasOwnProperty("aliases")&&data.aliases.hasOwnProperty(WBK.settings.chatWidgetId))){var alias=data.aliases[WBK.settings.chatWidgetId];data.name=alias.name?alias.name:data.name,data.photo=alias.photo?alias.photo:data.photo,data.position=alias.position?alias.posit.role&&(data.key=value.key,users[value.key]=data,s.fireRobot=data)}}),p.resolve(users)}),p.promise()},initLocalSocket:function(){var p=$.Deferred();return this.socketStarted?void p.resolve():(ChatLocalServer.initSocket(_this.restoredConnection.bind(_this)).then(function(){return p.resolve()}),p.promiseatMessages().then(this.addOldMessages.bind(_this)).then(this.scroll)},loadLocalChat:function(){var p=$.Deferred();return _this.getLocalChat().then(function(data){s.fireChat=data,_this.startUpdateVisitorStatus(),s.chat_created||_this.loadLocalChatData(data).then(function(){_this.joinChat().then(function(){s.chat_created=!0,p.resolve()})})}),p.promise()},loadLocalChatData:function(chatData){var p=$.Deferred();return $.when(this.loadLocalChatMessages(),this.loadLocalChatVisitor(chatData)).done(function(){ChatLocalServer.listenMessageCreated(function(data){if(s.last_message_id=data.id,data.sender===s.fireSender)return void _this.onVisitorMessage(data);var checkOperatorMessage="operator"==s.fireUsers[data.sender].role&&"system"!=data.type,checkSystemMessage="system"==data.type&&"pay_link"==data.subType,checkTextMessage="text"===data.type;(checkOperatorMessage||checkSystemMessage||checkTextMessage)&&_this.onOperatorMessage(data)}),ChatLocalServer.listenMessageUpdated(function(data){_this.updateMessageDataById(data.key,data)}),ChatLocalServer.listenPrinting(function(data){_this.showPrinting(data)}),p.resolve()}),p.promise()},joinChat:function(){var p=$.Deferred();return ChatLocalServer.joinChat(s.chatKey).then(function(data){return console.log("join chat"),console.log(data),p.resolve()}),p.promise()},initFirebase:function(){var _t=this,p=$.Deferred();return _t.loadFirebase().then(function(){return p.resolve()}),p.promise()},getUserInFirebaseByKey:function(id){var p=$.Deferred();return this.getChatUsersRef().child(id).once("value").then(function(snap){var datse()},loadFirebaseUsers:function(userIds){var _t=this,p=$.Deferred(),userIds=userIds.map(function(id){return _t.getUserInFirebaseByKey(id)});return $.when.apply($,userIds).then(function(){var usersDb=arguments,users={};$.each(usersDb,function(index,value){if(value){var data=value;if("operator"==data.role&&(users[value.key]=data,data.hasOwnProperty("aliases")&&data.aliases.hasOwnProperty(WBK.settings.chatWidgetId))){var alias=data.aliases[WBK.settings.chatWidgetId];data.name=alias.name?alias.name:data.name,data.photo=alias.photo?alias.photo:data.photo,data.position=alias.position?alias.position:data.position}"robot"==data.role&&(data.key=value.key,users[value.key]=data,s.fireRobot=data)}}),p.resolve(users)}),p.promise()},getFirebaseUsers:function(){var _t=this,p=$.Deferred();return s.fireDB.child("user-keys/"+WBK.settings.chatWidgetId).once("value").then(function(snap){var usersIds="object"==typeof snap.val()?Object.keys(snap.val()):[];s.fireUserKeys=usersIds,_debug&&_this.log("Операторы в виджете: "+usersIds),_t.loadFirebaseUsers(usersIds).then(function(users){s.fireUsers=users,s.all_operators=$.extend(!0,{},users),_t.subscribeUsers(),_debug&&_this.log("Операторы: "+JSON.stringify(s.fireUsers)),p.resolve()})}),p.promise()},subscribeUsers:function(){for(var _t=this,i=0;i<s.fireUserKeys.length;i++)_t.getChatUsersRef().child(s.fireUserKeys[i]).on("child_changed",function(snap){s.fireUsers[snap.ref.parent.key][snap.key]=snap.val(),"online"==snap.key&&_t.operatorsUpdate()})},getChatUsersRef:function(){return s.fireDB.child("users")},getChatRef:function(){return s.fireDB.child("chats/"+s.chatKey)},getChatMessageRef:function(){return s.fireDB.child("chat-messages/"+s.chatKey)},getChatVisitorRef:function(){return s.fireDB.child("visitors/"+s.chatKeyVisitor)},onScroll:function(){wsUtil.setTimeout("scrollTimerChatInvitation",function(){_this.checkInvitation()},250)},showBtn:function(){w.btn.css("display","flex"),"horizontal"==s.button_location&&WBK.animateFastOnce(w.btn,"cbk-zoomIn"),WBK.settings.chatBtnOpened=!0},hideBtn:function(){w.btn.hide(),WBK.animateFastOnce(w.btn,"cbk-zoomOut"),WBK.settings.chatBtnOpened=!1},showWidget:function(){if(this.smilesInit(),WBK.settings.multiButtonEnabled){var chatInButton=!1;$.each(wsMultiButton.settings.checked_variants,function(index,value){"chat"===value.action&&value.action_value==WBK.settings.chatWidgetId&&(chatInButton=!0)}),chatInButton&&wsMultiButton.hideWidget()}_this.hideBtn(),WBK.settings.chatInvitationOpened&&_this.hideInvitation(),WBK.settings.windowInvaderOpened&&(wsInvader.widget.window.find(".cbk-support-new-message-copyright").hide(),wsInvader.widget.window.hide());var d=new Date;if(d.setMinutes(d.getMinutes()+1440),wsUtil.setCookie("WidgetChat_opened_"+WBK.settings.chatWidgetId,!0,d),s.chat_is_online&&"pc"==WBK.settings.device&&wsUtil.getCookie("WidgetChat_settings_"+WBK.settings.chatWidgetId)){var data=JSON.parse(wsUtil.getCookie("WidgetChat_settings_"+WBK.settings.chatWidgetId));w.window.css({top:data.top,left:data.left,width:data.width,height:data.height})}"pc"!=WBK.settings.device&&(s.scroll_left=$(window).scrollLeft(),s.scroll_top=$(window).scrollTop(),$("meta[name=viewport]").length?(w.window.data("oldViewport",$("meta[name=viewport]").last().attr("content")),$("meta[name=viewport]").remove()):w.window.data("noViewport",1),$("head").append($("<meta>").attr("name","viewport").attr("content","width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0")),w.window.data("oldBodyWidth",document.body.style.width),$("body").addClass("cbk-body-mobile").css("width",$(window).width()+"px"),s.unread_messages_count&&_this.setUnreadMessages(0),s.disableMobileOpenHash||(window.location.hash="chatIsShown"));var d=new Date;if(d.setMinutes(d.getMinutes()+144e3),wsUtil.setCookie("WidgetChat_shownOn",s.chat_is_online?"on_btn":"on_btn_offline",d),w.window.show(),"pc"==WBK.settings.device&&WBK.animateFastOnce(w.window,"cbk-zoomIn"),WBK.settings.chatWindowOpened=!0,s.chat_is_online&&("pc"===WBK.settings.device?(w.window.find(".ws-textarea").focus(),w.window.find(".ws-chat-body-preform").is(":visible")&&this.reinitPreformPosition()):this.messageReadVisitor()),s.chatKey&&s.chat_created)_this.sendRobot({text:s.lang_text.visitor_open_window,subType:"open_window"});else{var lastInvitationId=wsUtil.getStorage("WidgetChat_last_shown_invitation_id");if(WBK.settings.chatInvitationShown){var d=new Date;d.setMinutes(d.getMinutes()+144e3),wsUtil.setCookie("WidgetChat_shownOn",s.chat_is_online?"on_inv":"on_inv_offline",d)}if(!WBK.settings.chatInvitationShown&&lastInvitationId&&s.invitations){WBK.settings.chatInvitationShown=!0;var invitation_id=!1;$.each(s.invitations,function(k,val){s.invitations[k].id==lastInvitationId&&(invitation_id=k)}),invitation_id!==!1&&(s.invitation_operator_key=_this.getOperatorKeyForInvitation(invitation_id),s.invitations[invitation_id]=_this.formatInvitation(s.invitations[invitation_id]),s.chat_is_online&&parseInt(s.invitations[invitation_id].invitation_always)&&_this.appendInvitation(invitation_id))}}_this.sendShowType(),s.first_message&&_this.send(s.first_message),w.window.find(".ws-chat-body").nanoScroller({scroll:"bottom",contentClass:"ws-chat-body-content",paneClass:"ws-chat-body-pane",sliderClass:"ws-chat-body-slider",childNanoscrollContainer:".ws-chat-quick-messages"}),w.window.find(".ws-textarea-group").nanoScroller({scroll:"bottom",contentClass:"ws-textarea",paneClass:"ws-textarea-pane",sliderClass:"ws-textarea-slider",preventPageScrolling:!0}),wsUtil.fixBootstrap(),s.quick_messages&&_this.checkQuickMessage(),"function"==typeof window.ws_OnChatShowWidget&&window.ws_OnChatShowWidget(),_this.typingPositionUpdate(),s.unread_messages.length>0&&_this.scroll();var d=new Date;d.setMinutes(d.getMinutes()+1440);var data=JSON.stringify({top:w.window.css("top"),left:w.window.css("left"),width:w.window.css("width"),height:w.window.css("height")});if(wsUtil.setCookie("WidgetChat_settings_"+WBK.settings.chatWidgetId,data,d),wsUtil.getStorage("ws_chat_input_text_"+WBK.settings.chatWidgetId)){var text=wsUtil.getStorage("ws_chat_input_text_"+WBK.settings.chatWidgetId);text=wsUtil.isAppleOS()?text.replace(/\n/g,"<div><br></div>"):text.replace(/\n/g,"<br>"),$(".ws-textarea").html(text),w.window.find(".ws-textarea-group .ws-textarea-placeholder").hide(),w.window.find(".ws-textarea-send-btn").css("display","flex"),w.window.find(".ws-textarea").focus()}},checkQuickMessage:function(){if(!s.quick_messages||parseInt(s.free_chat_widget))return void(_debug&&_this.log("Нет быстрых сообщений или бесплатная версия"));var keys=Object.keys(s.fireOldMessages);if(keys.length)return void(_debug&&_this.log("Быстрые сообщения уже были показаны"));var close=wsUtil.getCookie("WidgetChat_close_quick_messages_"+WBK.settings.chatWidgetId);if(close)return void(_debug&&_this.log("Быстрые сообщения ране были скрыты"));_debug&&_this.log("Проверяем быстрые сообщения"),s.quick_messages.sort(function(a,b){return a.rules.length>0&&b.rules.length>0||0===a.rules.length&&0===b.rules.length?a.position-b.position:a.rules.length>0&&0===b.rules.length||0===a.rules.length&&b.rules.length>0?b.rules.length-a.rules.length:void 0});for(var key=0;key<s.quick_messages.length;key++)if(s.showed_quick_messages)_debug&&_this.log("быстрое сообщение № "+s.quick_messages[key].id+" уже было показано");else if(s.quick_messages[key].rules.length){var rule_case={contains:0,not_contains:1,equally:2,regular:3,not_equally:4},count_false=0,count_true=0,url=decodeURIComponent(window.location.toString());url||(url=window.location.toString()),$.each(s.quick_messages[key].rules,function(k,val){switch(val.name){case"url":switch(parseInt(val.type)){case rule_case.contains:url.indexOf(val.value)+1?count_true++:count_false++;break;case rule_case.not_contains:url.indexOf(val.value)+1===0?count_true++:count_false++;break;case rule_case.equally:url==val.value?count_true++:count_false++;break;case rule_case.regular:var regex=new RegExp(val.value,"gi");regex.test(url)?count_true++:count_false++;break;case rule_case.not_equally:url!=val.value?count_true++:count_false++}break;case"device":1==parseInt(val.type)?val.value.trim()==WBK.settings.device?count_true++:count_false++:val.value.trim()!=WBK.settings.device?count_true++:count_false++}}),count_false&&_debug&&_this.log("Не выполнены условия показа быстрого сообщения № "+s.quick_messages[key].id),"all"===s.quick_messages[key].check&&0==count_false&&(_debug&&_this.log("Выполнены все правила показа быстрого сообщения № "+s.quick_messages[key].id),_debug&&_this.log("Показ быстрого сообщения"),_this.showQuickMessage(key)),"one"===s.quick_messages[key].check&&count_true>0&&(_debug&&_this.log("Выполнено 1 правило показа быстрого сообщения № "+s.quick_messages[key].id),_debug&&_this.log("Показ быстрого сообщения"),_this.showQuickMessage(key))}else _this.showQuickMessage(key);/iPad|iPhone|iPod/.test(navigator.userAgent)&&!w.window.MSStream||($(".ws-chat-quick-messages").addClass("ws-chat-height-fixed"),w.window.find(".ws-chat-quick-messages").is(":visible")&&w.window.find(".ws-chat-quick-messages").nanoScroller({scroll:"top",contentClass:"ws-chat-quick-messages-group",paneClass:"ws-chat-quick-messages-pane",sliderClass:"ws-chat-quick-messages-slider",parentNanoscrollContainer:".ws-chat-body"}),w.window.find(".ws-chat-body").nanoScroller())},startListenEventOnClickQuickMessages:function(){w.window.find(".ws-chat-quick-message").on("click",function(){_this.send({text:$(this).text(),type:"text"},{scroll:!0}),s.sent_quick_messages=!0,$(".ws-chat-quick-messages-group").html("");var form=w.window.find(".ws-textarea");wsUtil.setFocusContentEditable(form[0]),/iPad|iPhone|iPod/.test(navigator.userAgent)&&!w.window.MSStream&&$(".ws-chat-body-pane").addClass("ws-hide"),setTimeout(function(){_this.typingPositionUpdate()},500)})},showQuickMessage:function(message_ind){if(!s.show_quick_message&&!s.showed_quick_messages){$(".ws-chat-manager-hello").css("padding","15px 0 15px 10px"),$(".ws-chat-quick-messages").removeClass("ws-hide");var quick_message="";for(var ind in s.quick_messages[message_ind].messages)s.quick_messages[message_ind].messages.hasOwnProperty(ind)&&void 0!==s.quick_messages[message_ind].messages[ind].message&&(quick_message+='<div class="ws-chat-quick-message">'+s.quick_messages[message_ind].messages[ind].message+"</div>");$(".ws-chat-quick-messages-group").html(quick_message),this.startListenEventOnClickQuickMessages(),s.showed_quick_messages=!0,s.show_quick_message=!0}},sendShowType:function(){var url=WBK.settings.serverUrl+"/api?action=chatNewShow&callback=?";$.getJSON(url,{type_show:wsUtil.getCookie("WidgetChat_shownOn"),status:s.chat_is_online?1:0,device:WBK.settings.device,code:WBK.settings.whiteSaasCode,
googleClientId:wsUtil.getGoogleClientId(),chatId:WBK.settings.chatWidgetId,visitorId:WBK.settings.visitorId,advertiseId:wsUtil.getAdvertiseId(),calltrackingId:wsUtil.getCalltrackingId(),lpgeneratorId:wsUtil.getLPGeneratorId(),leadvertexId:wsUtil.getLeadvertexId(),externalParams:wsUtil.getExternalParams()})},hideWidget:function(){w.window.hide(),WBK.animateFastOnce(w.window,"cbk-zoomOut"),WBK.settings.chatWindowOpened=!1;var d=new Date;if(d.setMinutes(d.getMinutes()+144e3),wsUtil.deleteCookie("WidgetChat_opened_"+WBK.settings.chatWidgetId),"pc"!=WBK.settings.device&&(w.window.data("noViewport")?(w.window.data("noViewport",0),$("meta[name=viewport]").attr("content","")):$("meta[name=viewport]").attr("content",w.window.data("oldViewport")),$("body").removeClass("cbk-body-mobile").css("width",w.window.data("oldBodyWidth")),$(window).scrollTop(s.scroll_top),$(window).scrollLeft(s.scroll_left)),"hide"==s.button_location||"pc"!=WBK.settings.device&&parseInt(s.hide_mobile)||_this.showBtn(),s.chatKey&&s.chat_created&&_this.sendRobot({text:s.lang_text.visitor_close_window,subType:"close_window"}),!s.chat_is_online){var body_offline=w.window.find(".ws-chat-body-offline");body_offline.children().not(".ws-hide").show(),body_offline.find(".ws-chat-offline-text-success").hide(),wsUtil.deleteTimeout("chatOfflineHide")}WBK.settings.multiButtonId&&wsMultiButton.reInitWidget(),WBK.settings.chatWindowOpened||WBK.settings.windowOpened||WBK.settings.windowQuizOpened||WBK.settings.windowGeneratorOpened||WBK.settings.videoWidgetOpened||jWS(window).trigger("envy:resize"),"function"==typeof window.ws_OnChatHideWidget&&window.ws_OnChatHideWidget()},checkInvitation:function(from){if(!s.invitations||parseInt(s.free_chat_widget))return void(_debug&&_this.log("Нет автоприглашении или бесплатная версия"));if(_debug&&_this.log("Проверяем автоприглашения"),"hide"==s.button_location)return void(_debug&&_this.log("Чат скрыт, автоприглашение не нужно"));for(var key=0;key<s.invitations.length;key++)if(wsUtil.getCookie("WidgetChat_invitation_"+s.invitations[key].id))_debug&&_this.log("автоприглашение № "+s.invitations[key].id+" уже было показано");else if(s.invitations[key].rules.length){var url,count_false=0,count_true=0,count_time_true=0,timeout=1,timeouts=[];try{url=decodeURIComponent(window.location.toString())}catch(e){url=window.location.toString()}$.each(s.invitations[key].rules,function(k,val){switch(val.name){case"rule_url":switch(parseInt(val.type)){case 0:url.indexOf(val.value)+1?count_true++:count_false++;break;case 1:url.indexOf(val.value)+1==0?count_true++:count_false++;break;case 2:url==val.value?count_true++:count_false++;break;case 3:var regex=new RegExp(val.value,"gi");regex.test(url)?count_true++:count_false++;break;case 4:url!=val.value?count_true++:count_false++}break;case"rule_time":timeouts.push(parseInt(val.value)),count_time_true++;break;case"rule_time_site":var time_site=wsUtil.getCookie("WhiteCallback_timeAll")?parseInt(wsUtil.getCookie("WhiteCallback_timeAll")):1,timeout_site=parseInt(val.value)-time_site;timeouts.push(timeout_site>1?timeout_site:1),count_time_true++;break;case"rule_time_close_chat":var time_close=_this.getTimeClosedChat();time_close?(time_close=(new Date).setTime(time_close),time_close=parseInt(val.value)-((new Date).getTime()-time_close)/1e3,timeouts.push(time_close>1?time_close:1)):timeouts.push(1),count_time_true++;break;case"rule_operator":s.chat_is_online?"offline"==val.value?count_false++:count_true++:"online"==val.value?count_false++:count_true++;break;case"rule_visit_count":var visit_count=WBK.getVisitCount();switch(parseInt(val.type)){case 0:parseInt(val.value)==visit_count?count_true++:count_false++;break;case 1:parseInt(val.value)<visit_count?count_true++:count_false++;break;case 2:parseInt(val.value)>visit_count?count_true++:count_false++}break;case"rule_page_show_count":var page_show_count=WBK.getPageShowCount();switch(parseInt(val.type)){case 0:parseInt(val.value)==page_show_count?count_true++:count_false++;break;case 1:parseInt(val.value)<page_show_count?count_true++:count_false++;break;case 2:parseInt(val.value)>page_show_count?count_true++:count_false++}break;case"rule_scroll":var scroll=$(window).scrollTop(),scrollH=$(document).height()-$(window).height(),scrolled=scroll/scrollH*100;parseInt(val.value)<=scrolled?count_true++:count_false++;break;case"rule_name":"known"===val.value?WBK.settings.visitorName?count_true++:count_false++:WBK.settings.visitorName?count_false++:count_true++;break;case"rule_device":1==parseInt(val.type)?val.value==WBK.settings.device?count_true++:count_false++:val.value!=WBK.settings.device?count_true++:count_false++}}),count_false&&_debug&&_this.log("Не выполнены условия показа автоприглашения № "+s.invitations[key].id),"all"==s.invitations[key].check&&0==count_false&&(_debug&&_this.log("Выполнены все правила показа автоприглашения № "+s.invitations[key].id),timeouts.length>0&&(timeout=Math.max.apply(null,timeouts)),_debug&&_this.log("Показ автоприглашения через: "+timeout),_this.checkNeedGenerateOrShowInvitation(key,timeout,from)),"one"==s.invitations[key].check&&(count_true>0||count_time_true>0)&&(_debug&&_this.log("Выполнено 1 правило показа автоприглашения № "+s.invitations[key].id),count_true>0?timeout=1:timeouts.length>0&&(timeout=Math.min.apply(null,timeouts)),_debug&&_this.log("Показ автоприглашения через: "+timeout),_this.checkNeedGenerateOrShowInvitation(key,timeout,from))}else _this.checkNeedGenerateOrShowInvitation(key,1,from)},checkNeedGenerateOrShowInvitation:function(key,timeout,from){parseInt(s.invitations[key].ai_generated_text_enabled)?_this.getGeneratedAiInvitation(key,timeout,from):_this.showInvitation(key,timeout,from)},setGeneratedTextToParentInvitation:function(aiInvitation,invitationKey){s.invitations[invitationKey].hello_text=aiInvitation.hello_text,s.invitations[invitationKey].text1=aiInvitation.main_text,s.invitations[invitationKey].text2=aiInvitation.call_to_action_text,s.invitations[invitationKey].ai_invitation_id=aiInvitation.id,s.invitations[invitationKey].generated=!0},getGeneratedAiInvitation:function(invitationKey,timeout,from){var generationKeywords=document.querySelector('meta[name="keywords"]')?document.querySelector('meta[name="keywords"]').content:"";generationKeywords||(generationKeywords=document.querySelector("title")?document.querySelector("title").textContent:"");var data={invitation_id:s.invitations[invitationKey].id,generation_params:{keywords:generationKeywords,description:document.querySelector('meta[name="description"]')?document.querySelector('meta[name="description"]').content:"",name:WBK.settings.visitorName?WBK.settings.visitorName:""}},url=WBK.settings.serverUrl+"/api?action=chatGetAiInvitation";jWS.post(url,{code:WBK.settings.whiteSaasCode,data:data,visitorId:WBK.settings.visitorId},function(result){result&&result.Success&&result.Data&&(_this.setGeneratedTextToParentInvitation(result.Data.ai_invitation,invitationKey),_this.showInvitation(invitationKey,timeout,from))},"json")},hideInvitation:function(){WBK.settings.chatInvitationOpened=!1,w.invitation.hide()},getOperatorKeyForInvitation:function(invitation_id){var operator_id=!1,saved_operator_id=wsUtil.getStorage("WidgetChat_invitation_operator_id"),invitation_operators=Object.keys(s.operators_connect);return s.chat_is_online&&(invitation_operators=s.operators_connect_online_ids),saved_operator_id&&(s.operators_connect.hasOwnProperty(saved_operator_id)||(saved_operator_id=!1)),"operator"==s.invitations[invitation_id].operator_type?(operator_id=s.invitations[invitation_id].operator_id,s.operators_connect.hasOwnProperty(operator_id)||(operator_id=saved_operator_id?saved_operator_id:invitation_operators[wsUtil.getRandomArbitrary(0,invitation_operators.length-1)])):operator_id=saved_operator_id?saved_operator_id:invitation_operators[wsUtil.getRandomArbitrary(0,invitation_operators.length-1)],wsUtil.setStorage("WidgetChat_invitation_operator_id",operator_id),s.operators_connect[operator_id]},showInvitationByName:function(invitation_name){for(var invitation_id,key=0;key<s.invitations.length;key++)s.invitations[key].name==invitation_name&&(invitation_id=key);this.hideInvitation(),WBK.settings.chatInvitationShown=!1,s.show_one_invitation=!1,w.invitation.find(".ws-chat-invitation-logo").text(""),w.invitation.find(".ws-chat-invitation-name, .ws-chat-invitation-position, .ws-chat-invitation-text, .ws-chat-invitation-typing").remove(),this.checkNeedGenerateOrShowInvitation(invitation_id,1)},appendInvitation:function(invitation_id){var time=(new Date).getTime();s.invitation_show_data={sentAt:time,sender:s.invitation_operator_key,invitation_id:s.invitations[invitation_id].id,hello_text:s.invitations[invitation_id].hello_text,text1:s.invitations[invitation_id].text1,text2:s.invitations[invitation_id].text2,ai_invitation_id:s.invitations[invitation_id].ai_invitation_id};var data={sender:s.invitation_operator_key,type:"text",sentAt:time,key:"operator_"+time};s.first_message||w.window.find(".ws-chat-robot-hello, .ws-chat-manager-hello, .ws-chat-message-block").remove(),s.invitations[invitation_id].hello_text&&(data.text=s.invitations[invitation_id].hello_text,_this.appendMessage(data)),s.invitations[invitation_id].text1&&(data.text=s.invitations[invitation_id].text1,data.sentAt=time+1,data.key="operator_"+data.sentAt,_this.appendMessage(data)),s.invitations[invitation_id].text2&&(data.text=s.invitations[invitation_id].text2,data.sentAt=time+2,data.key="operator_"+data.sentAt,_this.appendMessage(data)),_this.updateVisitorAutoInvite()},showInvitation:function(invitation_id,timeout,from){if(!(WBK.settings.chatId||WBK.settings.chatWindowOpened||s.show_one_invitation||wsUtil.getCookie("WidgetChat_invitation_planed_"+s.invitations[invitation_id].id)&&s.chat_invitation_has_scroll_rule)){if(s.chat_invitation_has_scroll_rule){var t=new Date;t.setSeconds(t.getSeconds()+timeout+2),wsUtil.setCookie("WidgetChat_invitation_planed_"+s.invitations[invitation_id].id,"true",t)}wsUtil.setInterval("invitationShow_"+invitation_id,function(){if(!(WBK.settings.chatInvitationOpened||WBK.settings.windowGeneratorOpened||WBK.settings.videoWidgetOpened||WBK.settings.windowQuizOpened||WBK.settings.windowLoanerOpened||WBK.settings.windowInvaderOpened||WBK.settings.windowOpened||WBK.settings.chatId||WBK.settings.chatWindowOpened||s.show_one_invitation||WBK.settings.multiButtonVariantsOpened)){_this.updateVisitorAutoInvite(),wsUtil.setStorage("WidgetChat_last_shown_invitation_id",s.invitations[invitation_id].id),WBK.settings.chatInvitationOpened=!0,WBK.settings.chatInvitationShown=!0,s.show_one_invitation=!0;for(var key=0;key<s.invitations.length;key++)wsUtil.deleteInterval("invitationShow_"+key);var d=new Date;if("minutes"==s.invitations[invitation_id].repeat_type?d.setMinutes(d.getMinutes()+parseInt(s.invitations[invitation_id].repeat_time)):"days"==s.invitations[invitation_id].repeat_type&&d.setDate(d.getDate()+parseInt(s.invitations[invitation_id].repeat_time)),wsUtil.setCookie("WidgetChat_invitation_"+s.invitations[invitation_id].id,"true",d),wsUtil.deleteCookie("WidgetChat_invitation_planed_"+s.invitations[invitation_id].id),s.invitation_operator_key=_this.getOperatorKeyForInvitation(invitation_id),s.invitations[invitation_id]=_this.formatInvitation(s.invitations[invitation_id]),s.chat_is_online&&_this.appendInvitation(invitation_id),"open_chat"==s.invitations[invitation_id].action)return void _this.showWidget();w.invitation.find(".ws-chat-invitation-logo").append('<img class="ws-chat-invitation-img" src="'+s.fireUsers[s.invitation_operator_key].photo+'">');var namerator_key].name,profession=s.fireUsers[s.invitation_operator_key].position?s.fireUsers[s.invitation_operator_key].position:"";if(w.invitation.hasClass("from-multi-button")&&(profession||w.invitation.find(".ws-chat-invitation-body-el").addClass("multi-button-no-profession")),w.invitation.find(".ws-chat-invitation-body-text").before('<div class="ws-chat-invitation-name">'+name+'</div><div class="ws-chat-invitation-position">'+profession+"</div>"),s.invitations[invitation_id].hello_text?w.invitation.find(".ws-chat-invitation-body-text").append('<div class="ws-chat-invitation-text-box"><div class="ws-chat-invitation-text">'+s.invitations[invitation_id].hello_text+"</div></div>"):$(".ws-chat-invitation-body-text").addClass("hide_background_invitation_message"),"undefined"!=typeof from&&"multi_button"==from&&(wsMultiButton.stopTimer(),$.each(wsMultiButton.settings.checked_variants,function(index,value){if(value.show_autoreply_icon)return wsMultiButton.showIconVariant(index),!1})),_this.upInvitationIfNotFit(),w.invitation.show(),parseInt(s.invitations[invitation_id].autoinvite_play_sound)&&_this.playSound("message"),WBK.animateFastOnce(w.invitation,"cbk-zoomIn"),s.invitations[invitation_id].text1||s.invitations[invitation_id].text2){var typing=$('<div class="ws-chat-invitation-typing"><span class="ws-chat-typing-action"><i class="ws-icon-typing"></i></span><span class="ws-chat-invitation-typing-name">'+name+"</span> "+s.lang_text.typing+"...</div>");s.invitations[invitation_id].text1&&w.invitation.find(".ws-chat-invitation-body-text").append(typing.fadeIn()),wsUtil.setTimeout("invitationMessageTimer",function(){_this.updateVisitorAutoInvite(),w.invitation.find(".ws-chat-invitation-typing").fadeOut(function(){s.invitations[invitation_id].text1&&($(this).remove(),w.invitation.find(".ws-chat-invitation-body-text").append('<div class="ws-chat-invitation-text-box"><div class="ws-chat-invitation-text">'+s.invitations[invitation_id].text1+"</div></div>"),$(".ws-chat-invitation-body-text").removeClass("hide_background_invitation_message"))}),s.invitations[invitation_id].text2&&wsUtil.setTimeout("invitationMessageTimer",function(){_this.updateVisitorAutoInvite(),w.invitation.find(".ws-chat-invitation-body-text").append(typing.fadeIn()),wsUtil.setTimeout("invitationMessageTimer",function(){_this.updateVisitorAutoInvite(),w.invitation.find(".ws-chat-invitation-typing").fadeOut(function(){$(this).remove()}),wsUtil.setTimeout("invitationMessageTimer",function(){w.invitation.find(".ws-chat-invitation-body-text").append(typing.fadeIn()),wsUtil.setTimeout("invitationMessageTimer",function(){_this.updateVisitorAutoInvite(),w.invitation.find(".ws-chat-invitation-typing").fadeOut(function(){$(this).remove(),s.invitations[invitation_id].text2&&(w.invitation.find(".ws-chat-invitation-body-text").append('<div class="ws-chat-invitation-text-box"><div class="ws-chat-invitation-text">'+s.invitations[invitation_id].text2+"</div></div>"),$(".ws-chat-invitation-body-text").removeClass("hide_background_invitation_message"))})},wsUtil.specialChars(s.invitations[invitation_id].text2).length/2*110)},2500),w.invitation.find(".ws-chat-invitation-typing").fadeOut(function(){$(this).remove(),s.invitations[invitation_id].text2&&(w.invitation.find(".ws-chat-invitation-body-text").append('<div class="ws-chat-invitation-text-box"><div class="ws-chat-invitation-text">'+s.invitations[invitation_id].text2+"</div></div>"),$(".ws-chat-invitation-body-text").removeClass("hide_background_invitation_message"))})},wsUtil.specialChars(s.invitations[invitation_id].teunction(invitation){if(invitation.hello_text=WBK.formatText(invitation.hello_text),invitation.text1=WBK.formatText(invitation.text1),invitation.text2=WBK.formatText(invitation.text2),WBK.settings.geoCity){WBK.settings.geoCity.name||(WBK.settings.geoCity.name=WBK.settings.geoCity.ip_city);var visitorName="";WBK.settings.visitorName&&(visitorName=WBK.settings.visitorName),invitation.hello_text=invitation.hello_text.replace(/\[geocity1\]/g,WBK.settings.geoCity.name),invitation.hello_text=invitation.hello_text.replace(/\[geocity2\]/g,WBK.settings.geoCity.name_rod),invitation.hello_text=invitation.hello_text.replace(/\[geocity3\]/g,WBK.settings.geoCity.name_mes),invitation.hello_text=invitation.hello_text.replace(/\[geocity4\]/g,WBK.settings.geoCity.name_vin),invitation.hello_text=invitation.hello_text.replace(/\[name\]/g,visitorName),invitation.hello_text=invitation.hello_text.replace(/\[(.+?)\|(.+?)\]/gi,"<a class='ws-text-link' href='$1' target='_blank'>$2</a>"),invitation.text1=invitation.text1.replace(/\[geocity1\]/g,WBK.settings.geoCity.name),invitation.text1=invitation.text1.replace(/\[geocity2\]/g,WBK.settings.geoCity.name_rod),invitation.text1=invitation.text1.replace(/\[geocity3\]/g,WBK.settings.geoCity.name_mes),invitation.text1=invitation.text1.replace(/\[geocity4\]/g,WBK.settings.geoCity.name_vin),invitation.text1=invitation.text1.replace(/\[name\]/g,visitorName),invitation.text1=invitation.text1.replace(/\[(.+?)\|(.+?)\]/gi,"<a class='ws-text-link' href='$1' target='_blank'>$2</a>"),invitation.text2=invitation.text2.replace(/\[geocity1\]/g,WBK.settings.geoCity.name),invitation.text2=invitation.text2.replace(/\[geocity2\]/g,WBK.settings.geoCity.name_rod),invitation.text2=invitation.text2.replace(/\[geocity3\]/g,WBK.settings.geoCity.name_mes),invitation.text2=invitation.text2.replace(/\[geocity4\]/g,WBK.settings.geoCity.name_vin),invitation.text2=invitation.text2.replace(/\[name\]/g,visitorName),invitation.text2=invitation.text2.replace(/\[(.+?)\|(.+?)\]/gi,"<a class='ws-text-link' href='$1' target='_blank'>$2</a>")}return invitation.hello_text=this.smileReplacer(invitation.hello_text,"to_img"),invitation.text1=this.smileReplacer(invitation.text1,"to_img"),invitation.text2=this.smileReplacer(invitation.text2,"to_img"),invitation},urlInvitationLinkClear:function(text){return text=text.replace(/\<a\ class\=\'ws\-text\-link\'\ href\=\'(.+?)\' target\=\'\_blank\'\>(.+?)<\/a>/gi,"$2")},smileReplacer:function(text,type){if(!text)return"";var reg;return $.each(s.smilesCodes,function(key,value){"to_img"===type?(reg=new RegExp(value,"g"),text=text.replace(reg,'<img class="ws-sprite-emoji emoji-img ws-sprite-emoji-'+key+'" src="'+WBK.settings.staticServerUrl+'/widget/img/blank.gif">')):"to_code"===type&&(reg=new RegExp('<img class="ws-sprite-emoji emoji-img ws-sprite-emoji-'+key+'" src="'+WBK.settings.staticServerUrl+'/widget/img/blank.gif">',"g"),text=text.replace(reg,value))}),text},smilesInit:function(){var smile_container=w.window.find(".ws-smile-container");0===smile_container.children(".ws-emoji-el").length&&$.each(s.smilesCodes,function(key){smile_container.append('<a class="ws-emoji-el" href="#"><img class="ws-sprite-emoji emoji-img ws-sprite-emoji-'+key+'" src="'+WBK.settings.staticServerUrl+'/widget/img/blank.gif"></a>')}),s.on_event.emodji||(w.window.find(".ws-emoji-el").on("click",function(e){e.preventDefault(),s.chat_is_online?(w.window.find(".ws-textarea").focus(),_this.insertHTML($(this).html())):w.window.find(".ws-offline-textarea").append($(this).html()),wsUtil.setStorage("ws_chat_input_text_"+WBK.settings.chatWidgetId,$(".ws-textarea").html()),w.window.find(".ws-textarea-send-btn").css("display","flex"),w.window.find(".ws-textarea-group .ws-textarea-placeholder").hide()}),s.on_event.emodji=!0)},showOffline:function(){w.window.addClass("ws-chat-offline"),w.btn.find(".ws-chat-status-online").removeClass("ws-chat-status-online"),"pc"!=WBK.settings.device?w.btn.find(".ws-btn-title").text(s.mobile_text_button_offline):w.btn.find(".ws-btn-title").text(s.text_button_offline),w.window.find(".ws-chat-title").text(s.text_button_offline),w.window.find(".ws-chat-body").hide(),w.window.find(".ws-chat-footer").hide(),w.window.find(".ws-chat-status-online").removeClass("ws-chat-status-online"),w.window.find(".ws-chat-body-offline").show(),s.useTelephonyMask&&WBK.setPhoneInputFocusForm($(".ws-offline-phone"))},chatAutoCall:function(phone,phoneMask){if(phone&&s.autoCall&&WBK.settings.callbackEnabled){wsKiller.settings.callingWidget=!0;var d=new Date;d.setMinutes(d.getMinutes()+144e3),wsUtil.setCookie("WhiteCallback_shownOn","onchat",d),WBK.settings.phoneMask=s.useTelephonyMask?phoneMask:WBK.numberMask(phone).mask,wsKiller.newCall(phone,!1,s.autoCallDeffered,s.autoCallDefferedDelay)}},sendOfflineMessage:function(){if(!s.offline_message_sending){s.offline_message_sending=!0;var offline_body=w.window.find(".ws-chat-body-offline");offline_body.find(".ws-offline-textarea").removeClass("ws-input-error"),offline_body.find(".ws-offline-input").removeClass("ws-input-error");var phoneMask,name=offline_body.find(".ws-offline-name").val(),email=offline_body.find(".ws-offline-email").val(),phone=offline_body.find(".ws-offline-phone").val();s.useTelephonyMask?(phoneMask=offline_body.find(".ws-offline-phone").attr("placeholder"),phone=WBK.checkPhone(phone,!0)):(s.user_phone_without_dial_code=phone,phone=this.getActualPhoneWithCountryCode(phone,"offlinePhone"),phone=phone.replace(/[^\d]/g,"")),phone=phone?phone:"";var emailAgreement=$(".ws-offline-email-agreement").is(":checked")?1:0,emailDistributionAgreement=$(".offline-email-distribution-agreement").is(":checked")?1:0,message=_this.smileReplacer(_this.cleanMessage(offline_body.find(".ws-offline-textarea")),"to_code"),errors_class="";if("yes"==s.get_contact_offline_name&&""==name.trim()&&(errors_class=".ws-offline-name"),"yes"==s.get_contact_offline_phone&&""==phone.trim()&&(errors_class?errors_class+=", .ws-offline-phone":errors_class=".ws-offline-phone"),"yes"!=s.get_contact_offline_email||""!=email.trim()&&wsUtil.validateEmail(email.trim())||(errors_class?errors_class+=", .ws-offline-email":errors_class=".ws-offline-email"),"yes"==s.get_contact_offline_message&&""==message.trim()&&(errors_class?errors_class+=", .ws-offline-textarea":errors_class=".ws-offline-textarea"),errors_class)return w.window.find(errors_class).addClass("ws-input-error"),void(s.offline_message_sending=!1);var offline_body=w.window.find(".ws-chat-body-offline");offline_body.children().not(".ws-hide").hide(),offline_body.find(".ws-offline-textarea").text(""),offline_body.find(".ws-chat-offline-text-success").show(),wsUtil.setTimeout("chatOfflineHide",function(){_this.hideWidget()},3e3),s.offline_message_sending=!1;var _d={code:WBK.settings.whiteSaasCode,name:name.trim(),email:email.trim(),phone:phone.trim(),message:message.trim(),emailAgreement:emailAgreement,emailDistributionAgreement:emailDistributionAgreement,visitId:WBK.settings.visitId,type_show:wsUtil.getCookie("WidgetChat_shownOn"),chatWidgetId:WBK.settings.chatWidgetId,chatId:WBK.settings.chatId,url:"string"==typeof document.URL?document.URL:"",visitorId:WBK.settings.visitorId,phoneMask:phoneMask,googleClientId:wsUtil.getGoogleClientId(),roistatPromo:wsUtil.getRoistatPromo(),advertiseId:wsUtil.getAdvertiseId(),calltrackingId:wsUtil.getCalltrackingId(),lpgeneratorId:wsUtil.getLPGeneratorId(),leadvertexId:wsUtil.getLeadvertexId(),externalParams:wsUtil.getExternalParams()},url=WBK.settings.serverUrl+"/api?action=chatOfflineMessage";jWS.post(url,_d,"json"),"function"==typeof window.ws_OnChatOfflineMessage&&window.ws_OnChatOfflineMessage(_d),_this.chatAutoCall(phone.trim(),phoneMask),_this.sendGoal("offline_message")}},showHelloMessage:function(){var hello_message='<div class=<div class="ws-manager-event" style="color:'+s.color_hello_message+'">'+s.hello_message+"</div></div>";w.window.find(".ws-chat-typing").before(hello_message)},showHelloMessageOperators:function(){s.operators_online_keys.sort(function(a,b){return a=s.all_operators[a].lastActiveAt,b=s.all_operators[b].lastActiveAt,a<b?1:a>b?-1:0});var operators_el="";if("last3"===s.hello_message_author)for(var i=0;i<s.operators_online_keys.length;i++){var name=s.all_operators[s.operators_online_keys[i]].name;if(operators_el+='<div class="ws-chat-manager-hello-el"><img src="'+s.all_operators[s.operators_online_keys[i]].photo+'" class="ws-manager-hello-img"><div class="ws-manager-name">'+name+"</div></div>",2==i)break}else if("operator"===s.hello_message_author){var op_key,operator={};if("rand"===s.hello_message_operator){var operatorsFromRand=[];for(op_key in s.all_operators)s.all_operators.hasOwnProperty(op_key)&&"operator"===s.all_operators[op_key].role&&s.all_operators[op_key].online&&operatorsFromRand.push(s.all_operators[op_key]);var lucky_operator_number=Math.floor(Math.random()*operatorsFromRand.length);operator=operatorsFromRand[lucky_operator_number]}else{var operatorsFromID=[];for(op_key in s.all_operators)s.all_operators.hasOwnProperty(op_key)&&"operator"===s.all_operators[op_key].role&&(operatorsFromID[s.all_operators[op_key].apiId]=s.all_operators[op_key]);if(!operatorsFromID.hasOwnProperty(s.hello_message_operator))return void this.showHelloMessage();operator=operatorsFromID[s.hello_message_operator]}operators_el+='<div class="ws-chat-manager-hello-el"><img src="'+operator.photo+'" class="ws-manager-hello-img"><div class="ws-manager-name">'+operator.name+"</div></div>"}var hello_message='<div class="ws-chat-manager-join ws-chat-manager-hello"><div class="ws-chat-manager-hello-body">'+operators_el+'</div><div class="ws-manager-event" style="color:'+s.color_hello_message+'">'+s.hello_message+"</div></div>";w.window.find(".ws-chat-typing").before(hello_message),s.chat_distribution_department_enabled||$(".ws-chat-manager-join.ws-chat-manager-hello").css("padding-bottom","60px;")},showHelloMessageOperatorsFromDepartments:function(){var pickedDepartment,operators_el="",managerHelloBlock=$(".ws-chat .ws-chat-manager-join");if(managerHelloBlock.length&&($.each(s.chat_department_distribution,function(index,department){department.id===s.chat_distribution_department_picked&&(pickedDepartment=department)}),pickedDepartment)){var countPickedEmloyees=0;$.each(s.operators_online_keys,function(index,key){var employeeId=s.all_operators[key].apiId;if(pickedDepartment.employees[employeeId]){var name=s.all_operators[key].name;operators_el+='<div class="ws-chat-manager-hello-el"><img src="'+s.all_operators[key].photo+'" class="ws-manager-hello-img"><div class="ws-manager-name">'+name+"</div></div>",countPickedEmloyees+=1}if(3===countPickedEmloyees)return!1}),managerHelloBlock.addClass("ws-chat-manager-hello");var hello_message='<div class="ws-chat-manager-hello-body">'+operators_el+'</div><div class="ws-manager-event" style="color:'+s.color_hello_message+'">'+s.hello_message+"</div>";countPickedEmloyees&&(managerHelloBlock.empty(),managerHelloBlock.append(hello_message))}},operatorsUpdate:function(){if(w.window&&s.fireChat.hasOwnProperty("operators")){var operators_online="";w.window.removeClass("ws-chat-ico-bottom"),w.window.find(".ws-chat-ico-container").empty();for(var i=0;i<s.fireChat.operators.length;i++)if(s.fireUsers.hasOwnProperty(s.fireChat.operators[i])){if(s.fireUsers[s.fireChat.operators[i]].online){var name=s.fireUsers[s.fireChat.operators[i]].name?s.fireUsers[s.fireChat.operators[i]].name:"";operators_online+=operators_online?", "+name:name}_this.addIco(s.fireUsers[s.fireChat.operators[i]])}operators_online?w.window.find(".ws-chat-title").text(operators_online):w.window.find(".ws-chat-title").text(s.text_button_online)}},addIco:function(user){w.window.hasClass(".ws-chat-ico-bottom")||(w.window.addClass("ws-chat-ico-bottom"),w.window.offset().left<100?w.window.addClass("ws-chat-ico-bottom-right"):w.window.removeClass("ws-chat-ico-bottom-right"));var online_class="";user.online&&(online_class="ws-chat-status-online");var tpl_ico='<div class="ws-chat-ico" id="ico_'+user.key+'" style="background-color: '+s.color_background_chat_header+';"><div class="ws-chat-logo" data-name="'+user.name+'"><i class="ws-icon-chat"></i><img src="'+user.photo+'" class="ws-chat-logo-img" title="'+user.name+'"><div class="ws-chat-status-round '+online_class+'"></div></div></div>';w.window.find(".ws-chat-ico-container").append(tpl_ico)},updateIcoBottom:function(user){var container=w.wintainer.find("#ico_"+user).appendTo(container)},addOldMessages:function(){if(s.fireOldMessages){var _t=this,keys=Object.keys(s.fireOldMessages);if(keys.length){for(var i=0;i<keys.length;i++)if(s.fireOldMessages.hasOwnProperty(keys[i])){var messageData=s.fireOldMessages[keys[i]];messageData.key=keys[i];var isOperator="operator"==s.fireUsers[messageData.sender].role,isTextMessage="text"===messageData.type,isPayLinkMessage="system"===messageData.type&&"pay_link"===messageData.subType,isVisitorMessage=!isOperator&&messageData.sender===s.fireSender;"read"!=messageData.status&&(isOperator||isTextMessage&&!isVisitorMessage||isPayLinkMessage)&&(s.unread_messages_count+=1,s.unread_messages.push(messageData.key));var params={scroll:!1};if("auto_reply"===messageData.subType&&messageData.autoReplyId)for(var index in s.autoreplies)+s.autoreplies[index].id===+messageData.autoReplyId&&(params.auto_reply_get_contact=s.autoreplies[index].get_contact,params.auto_reply_index=index);_t.appendMessage(messageData,params),"auto_reply"===messageData.subType&&parseInt(s.show_contact_form_inside_chat)&&params.auto_reply_get_contact&&!(WBK.settings.visitorName||WBK.settings.visitorPhone||WBK.settings.visitorEmail||"none"!==w.window.find(".ws-chat-body-preform").css("display"))&&(this.addMessageRobot({subType:"lead"}),this.setPhoneMaskData(".ws-preform-phone"),this.showPreform("lead",index,$(this)))}s.unread_messages_count&&_this.setUnreadMessages(s.unread_messages_count)}}},updateVisitor:function(data){s.online_visitor_enable&&(s.free_chat_sitor(s.chatKeyVisitor).then(function(visitor){if(visitor){var additional={lastActiveAt:{".sv":"timestamp"}};s.chat_distribution_department_picked&&(additional.departmentId=s.chat_distribution_department_picked),_this.updateVisitorInBase(Object.assign(data,additional))}else _this.createVisitor()}):_this.createVisitor()))},updateVisitorInBase:function(data){s.v2_local?ChatLocalServer.updateVisitor(data).then(function(){}):_this.getChatVisitorRef().update(data)},updateUserInBase:function(key,data){s.v2_local?ChatLocalServer.updateUser(key,data).then(function(){}):_this.getChatUsersRef().child(key).update(data)},getVisitor:function(visitorId){var p=$.Deferred();return s.v2_local?ChatLocalServer.getVisitor(visitorId).then(function(data){p.resolve(data)}):s.fireDB.child("visitors/"+visitorId).once("value").then(function(snap){p.resolve(snap.val())}),p.promise()},createVisitor:function(){s.online_visitor_enable&&(s.free_chat_widget||(WBK.settings.visitorId?this.getVisitor(WBK.settings.visitorId).then(function(visitor){visitor?(s.chatKeyVisitor=WBK.settings.visitorId,_this.listenVisitor()):(s.chatKeyVisitor=!1,_this.sendVisitor())}):this.sendVisitor()))},sendVisitor:function(){this.processVisitor||(this.processVisitor=!0,jWS.getJSON(WBK.settings.serverUrl+"/api?action=chatVisitor&callback=?",{code:WBK.settings.whiteSaasCode,type_show:wsUtil.getCookie("WidgetChat_shownOn"),visitorId:WBK.settings.visitorId,visitId:WBK.settings.visitId,chatWidgetId:WBK.settings.chatWidgetId,googleClientId:wsUtil.getGoogleClientId(),roistatPromo:wsUtil.getRoistatPromo(),advertiseId:wsUtil.getAdvertiseId(),calltrackingId:wsUtil.getCalltrackingId(),lpgeneratorId:wsUtil.getLPGeneratorId(),leadvertexId:wsUtil.getLeadvertexId(),invitation:!1,externalParams:wsUtil.getExternalParams()},function(result){result.Success&&result.Data&&result.Data.chat&&(s.chatKeyVisitor=result.Data.chat.visitor_key,_this.listenVisitor()),_this.processVisitor=!1},function(){_this.processVisitor=!1}))},listenVisitor:function(){_this.updateVisitor({currentUrl:window.location.href}),s.v2_local?this.listenVisitorLocalBase():(_this.getChatVisitorRef().on("child_changed",function(snap){"chatKey"==snap.key&&(s.chatKey=snap.val(),s.chatKey&&(_this.loadFireChat().then(function(){_this.addOldMessages(),s.chatCreating=!1,s.chat_created=!0}),_this.updateVisitor({said:!0})))}),_this.getChatVisitorRef().on("child_removed",function(snap){s.chatKeyVisitor=!1}))},listenVisitorLocalBase:function(){ChatLocalServer.listenVisitorUpdated(function(visitor){s.visitor_auto_invite=visitor.autoInvite,
visitor.hasOwnProperty("chatKey")&&(s.chatKey=visitor.chatKey,s.chatKey&&!s.chatCreating&&(_this.loadLocalChat().then(function(){_this.addOldMessages(),s.chatCreating=!1,s.chat_created=!0}),_this.updateVisitor({said:!0})))})},sendSystem:function(data){data.status="read",data.type="system",data.sentAt=(new Date).getTime(),_this.sendFire(data)},sendRobot:function(data,params){data.status="read",data.type="system",data.sender=s.fireRobot.key,data.sentAt=(new Date).getTime(),_this.sendMessageRobot(data,params),"rating"!=data.subType&&"auto_reply"!=data.subType||_this.addMessageRobot(data,params)},sendMessageRobot:function(data){_this.sendFire(data)},addMessageRobot:function(data,params){if(data&&(data=$.extend({},data),!("auto_reply"==data.subType&&data.hasOwnProperty("sender")&&data.sender&&"operator"==s.fireUsers[data.sender].role||"open_window"==data.subType||"close_window"==data.subType||"start_download"==data.subType||"introduction"==data.subType||"not_require_answer"===data.subType))){var message_block="",className="";switch(data.subType){case"text":case"auto_reply":if(data.hasOwnProperty("key")&&(WBK.settings.visitorName||WBK.settings.visitorPhone||WBK.settings.visitorEmail))return;if(data.text=wsUtil.specialChars(data.text),data.text=this.textUrlFormat(data.text),params&&params.auto_reply_get_contact){if(!parseInt(s.show_contact_form_inside_chat)){var text_btn=s.autoreplies[params.auto_reply_index].text_btn?s.autoreplies[params.auto_reply_index].text_btn:s.lang_text.autoreply_link;data.text=data.text+'<br><div class="ws-chat-autoreply-link"><a data-index="'+params.auto_reply_index+'" class="ws-chat-autoreply-btn" href="javascript:void(0)">'+text_btn+"</a></div>"}var cookieDate=new Date;cookieDate.setMinutes(cookieDate.getMinutes()+43200),wsUtil.setCookie("WidgetChat_autoreply_getcontact_"+WBK.settings.chatId,!0,cookieDate)}message_block='<div class="ws-chat-message-source">'+data.text+"</div>";break;case"lead":case"preform":if(className="ws-chat-message-robot-preform",parseInt(s.show_contact_form_inside_chat)){var robotPreformPhoneValue=WBK.formatToPhone(s.user_phone);!s.useTelephonyMask&&s.user_phone_without_dial_code&&(robotPreformPhoneValue=s.user_phone_without_dial_code),message_block='<div class="ws-chat-body-preform ws-chat-body-preform-clear"><div class="ws-chat-preform-text"></div><div class="ws-chat-preform-social"><a href="javascript:void(0)" class="ws-chat-social-el ws-chat-social-vk"><span class="ws-chat-social-img ws-sprite-social-vk"></span></a><a href="javascript:void(0)" class="ws-chat-social-el ws-chat-social-fb"><span class="ws-chat-social-img ws-sprite-social-fb"></span></a></div><div class="ws-preform-input-group"><div class="ws-preform-input-label"></div><input type="text" class="ws-preform-input ws-preform-name" placeholder="'+s.lang_text.form_name_placeholder+'" value="'+s.user_name+'"></div><div class="ws-preform-input-group"><div class="ws-preform-input-label"></div><input type="tel" class="ws-preform-input ws-preform-phone" placeholder="'+s.lang_text.form_phone_placeholder+'" value="'+robotPreformPhoneValue+'"><input type="text" class="cbk-phone-checker white-saas-generator-input-hidden"/></div><div class="ws-preform-input-group"><div class="ws-preform-input-label"></div><input type="email" class="ws-preform-input ws-preform-email" placeholder="'+s.lang_text.form_email_placeholder+'" value="'+s.user_email+'"></div><div class="ws-preform-input-group ws-preform-input-group-text"><div class="ws-preform-input-label ws-preform-email-text">'+s.lang_text.email_exit+'</div></div><div class="ws-preform-input-group'+(parseInt(s.email_distribution_agreement)?"":" ws-hide")+'"><label class="ws-preform-label-agreement"><input type="checkbox" class="ws-preform-email-distribution-agreement preform-email-distribution-agreement"><span class="ws-preform-email-distribution-agreement-text">'+s.email_text_distribution_agreement+'</span></label></div><div class="ws-preform-input-group ws-preform-input-group-text"><label class="ws-preform-label-agreement"><span class="ws-preform-email-agreement-text">'+s.email_agreement_text+s.lang_text.email_agreement_text_agreement+'</span></label></div><div class="ws-preform-input-group ws-preform-input-group-btn"><a href="javascript:void(0)" class="ws-preform-btn ws-preform-btn-save">'+s.lang_text.preform_btn+"</a></div></div>"}else message_block='<div class="ws-chat-message-source">'+s.lang_text.preform_text+'</div><input class="ws-chat-message-input" placeholder="'+s.lang_text.form_name+'">';break;case"load":message_block='<div class="ws-chat-message-source">'+s.lang_text.loading+' ...</div><div class="ws-chat-progress"><div class="ws-chat-progress-bar"></div></div>';break;case"rating":_this.hideRating();var rating_block='<img class="ws-chat-message-rating-el ws-chat-message-rating-el-1" src="'+WBK.settings.staticServerUrl+'/widget/img/blank.gif" alt=""><img class="ws-chat-message-rating-el ws-chat-message-rating-el-2" src="'+WBK.settings.staticServerUrl+'/widget/img/blank.gif" alt=""><img class="ws-chat-message-rating-el ws-chat-message-rating-el-3" src="'+WBK.settings.staticServerUrl+'/widget/img/blank.gif" alt=""><img class="ws-chat-message-rating-el ws-chat-message-rating-el-4" src="'+WBK.settings.staticServerUrl+'/widget/img/blank.gif" alt=""><img class="ws-chat-message-rating-el ws-chat-message-rating-el-5" src="'+WBK.settings.staticServerUrl+'/widget/img/blank.gif" alt="">';"smiles"==s.rate_chat_view&&(rating_block='<img class="ws-chat-message-rating-el" src="'+WBK.settings.staticServerUrl+'/widget/img/blank.gif" alt="">');var rateText="";switch(parseInt(data.attributes.rate)){case 1:rateText=s.lang_text.rate_text_1;break;case 2:rateText=s.lang_text.rate_text_2;break;case 3:rateText=s.lang_text.rate_text_3;break;case 4:rateText=s.lang_text.rate_text_4;break;case 5:rateText=s.lang_text.rate_text_5}message_block='<div class="ws-chat-message-source">'+s.lang_text.rate_result+'</div></div><div class="ws-chat-message"><div class="ws-chat-message-source"><div class="ws-chat-message-rating ws-chat-message-rating-'+s.rate_chat_view+" ws-chat-message-rating-rate-"+data.attributes.rate+'">'+rating_block+"</div>"+rateText+"</div>";break;case"pay_link":message_block='<div class="ws-chat-message-source"><div class="ws-chat-message-pay-title">'+data.attributes.title+'</div><div class="ws-chat-message-pay-amount">'+wsUtil.humanizeNumber(data.attributes.amount)+" "+data.attributes.currencyText+'</div><div class="ws-chat-message-pay-link"><a href="'+data.attributes.link+'" target="_blank">'+s.lang_text.pay+'<i class="ws-icon-link"></i></a></div><div class="ws-chat-message-pay-system">'+s.lang_text.security_pay_in+" "+s.lang_text[data.attributes.paySystem]+"</div></div>";break;case"pick_department":if(s.chat_distribution_department_enabled){className="ws-chat-message-robot-pick-department",message_block='<div class="ws-chat-message-source ws-chat-message-pick-department" style="background:'+s.color_background_message_operator+'">',message_block+='<p class="ws-chat-message-header-pick-department">'+s.lang_text.pick_department_header+"</p>",message_block+='<div class="ws-chat-status-round ws-chat-status-online"></div>',message_block+='<p class="ws-chat-message-text-pick-department">'+s.lang_text.pick_department_text+"</p>",message_block+="</div>",message_block+='<div class="ws-chat-select-pick-department">';var opacityColor=_this.makeOpacityColor(s.color_background_message_operator,3);$.each(s.chat_department_distribution,function(index,department){Object.keys(department.employees).length&&(message_block+='<div class="ws-chat-message-option-pick-department" data-value="'+department.id+'">',message_block+='<div style="border-bottom: 1px solid '+opacityColor+'">'+_this.escapeHtml(department.name)+"</div>",message_block+="</div>")}),message_block+="</div>"}}var new_block='<div class="ws-chat-message-block ws-chat-message-robot '+className+'"><div class="ws-chat-message-logo"><img class="ws-chat-message-logo-img" src="'+s.fireRobot.photo+'"></div><div class="ws-chat-message-name"><span class="ws-chat-message-name-text" data-name="">'+s.fireRobot.name+'</span></div><div class="ws-chat-message'+("pick_department"===data.subType?" ws-chat-message-with-pick-department":"")+'">'+message_block+"</div></div>";!parseInt(s.show_contact_form_inside_chat)||"lead"!=data.type&&"preform"!=data.type||$(".ws-chat-body-preform")&&$(".ws-chat-body-preform").closest(".ws-chat-message-robot").remove(),w.window.find(".ws-chat-typing").before(new_block),!s.useTelephonyMask&&w.window.find(".ws-chat-message-robot-preform .ws-preform-phone").length&&w.wsDCPI.renderOnInput(".ws-preform-phone","chatBodyPreformPhone"+(w.window.find(".ws-chat-message-robot-preform .ws-preform-phone").length-1),w.window.find(".ws-chat-message-robot-preform")[w.window.find(".ws-chat-message-robot-preform .ws-preform-phone").length-1],!s.user_phone_without_dial_code),"load"==data.type&&w.window.find(".ws-chat-body-content .ws-chat-message-robot").last().find(".ws-chat-progress-bar").animate({width:"70%"},4e3),WBK.settings.chatWindowOpened&&_this.scroll()}},sendGoal:function(type){if(!s.free_chat_widget){var yaGoal,gaGoal,mailGoal,gaCategory="ChatService",yagla=!1,facebook=!1;switch(type){case"invitation_click":yaGoal="CHAT_SHOW_ON_INVITATION",gaGoal=mailGoal="ChatShowOnInvitation";break;case"invitation_close":yaGoal="CHAT_INVITATION_CLOSE",gaGoal=mailGoal="ChatInvitationClose";break;case"open":yaGoal="CHAT_SHOW_ON_BTN",gaGoal=mailGoal="ChatShowOnBtn";break;case"first_message":yaGoal="CHAT_FIRST_MESSAGE",gaGoal=mailGoal="ChatFirstMessage",yagla="chat";break;case"offline_message":yaGoal="CHAT_OFFLINE_MESSAGE",gaGoal=mailGoal=facebook="ChatOfflineMessage",yagla="chat",wsUtil.sendUniversalGoal();break;case"visitor_introduced":yaGoal="CHAT_VISITOR_INTRODUCED",gaGoal=mailGoal=facebook="ChatVisitorIntroduced",yagla="chat",wsUtil.sendUniversalGoal();break;case"operator_connect":yaGoal="CHAT_OPERATOR_CONNECT",gaGoal=mailGoal="ChatOperatorConnect"}wsUtil.sendGoal(yaGoal,gaGoal,gaCategory,yagla,facebook)}},checkAutoReply:function(type,data){for(var i=0;i<s.autoreplies.length;i++)type==s.autoreplies[i].action&&_this.startAutoReply(i,data)},stopAutoReply:function(type){wsUtil.deleteTimeout("chatTypingAutoreply");for(var i=0;i<s.autoreplies.length;i++)"all"==type?wsUtil.deleteTimeout("auto_reply_"+s.autoreplies[i].id):type==s.autoreplies[i].action&&wsUtil.deleteTimeout("auto_reply_"+s.autoreplies[i].id)},startAutoReply:function(index,data){if("2"==s.autoreplies[index].info_introduced&&parseInt(s.chat_introduced))return!1;var autoReplyName="auto_reply_"+s.autoreplies[index].id;return!wsUtil._timeouts.hasOwnProperty(autoReplyName)&&void wsUtil.setTimeout(autoReplyName,function(data){var auto_reply_get_contact=parseInt(s.autoreplies[index].get_contact),hasVisitorData=_this.hasVisitorData();if("not_connected"==s.autoreplies[index].action&&(!s.send_autoreply_first||"1"==s.autoreplies[index].info_introduced&&!hasVisitorData||"2"==s.autoreplies[index].info_introduced&&hasVisitorData))return!1;var show_with_timeout;if("not_connected"==s.autoreplies[index].action){show_with_timeout=!1,s.invitation_operator_key&&(_this.typing(s.invitation_operator_key,20*s.autoreplies[index].message.length),show_with_timeout=!0);var data={text:s.autoreplies[index].message,type:"system",subType:"auto_reply",autoReplyId:s.autoreplies[index].id};if(show_with_timeout?(data.sender=s.invitation_operator_key,wsUtil.setTimeout("auto_reply_not_connected_start",function(){_this.appendMessage(data,{auto_reply_get_contact:auto_reply_get_contact,auto_reply_index:index,scroll:!0}),_this.sendSystem(data),_this.playSound("message")},21*s.autoreplies[index].message.length)):(_this.sendRobot(data,{auto_reply_get_contact:auto_reply_get_contact,auto_reply_index:index,scroll:!0}),_this.playSound("message")),parseInt(s.show_contact_form_inside_chat)&&auto_reply_get_contact){if(_this.hasVisitorData())return;if(_this.contactFormIsVisible())return;s.invitation_operator_key&&_this.typing(s.invitation_operator_key,55*s.autoreplies[index].message.length),wsUtil.setTimeout("auto_reply_get_inline_contact",function(){_this.addMessageRobot({subType:"lead"}),_this.setPhoneMaskData(".ws-preform-phone"),_this.showPreform("lead",index,$(this))},55*s.autoreplies[index].message.length)}s.auto_reply_not_connected_and_operators_offline_showed=!0}if("not_answer_operator"==s.autoreplies[index].action){if("1"==s.autoreplies[iex].info_introduced&&hasVisitorData)return!1;_this.typing(s.last_operator_data.user_key,50*s.autoreplies[index].message.length,2500),wsUtil.setTimeout("chatTypingAutoreply",function(){var data={text:s.autoreplies[index].message,type:"system",subType:"auto_reply",sender:s.last_operator_data.user_key,autoReplyId:s.autoreplies[index].id};if(_this.appendMessage(data,{auto_reply_get_contact:auto_reply_get_contact,auto_reply_index:index,scroll:!0}),_this.sendSystem(data),_this.playSound("message"),parseInt(s.show_contact_form_inside_chat)&&auto_reply_get_contact){if(_this.hasVisitorData())return;if(_this.contactFormIsVisible())return;s.last_operator_data&&_this.typing(s.last_operator_data.user_key,55*s.autoreplies[index].message.length),wsUtil.setTimeout("auto_reply_get_inline_contact",function(){_this.addMessageRobot({subType:"lead"}),_this.setPhoneMaskData(".ws-preform-phone"),_this.showPreform("lead",index,$(this))},55*s.autoreplies[index].message.length)}},50*s.autoreplies[index].message.length)}if("not_connected_and_operators_offline"==s.autoreplies[index].action){show_with_timeout=!1,s.invitation_operator_key&&(_this.typing(s.invitation_operator_key,20*s.autoreplies[index].message.length),show_with_timeout=!0);var data={text:s.autoreplies[index].message,type:"system",subType:"auto_reply",autoReplyId:s.autoreplies[index].id};if(show_with_timeout?(data.sender=s.invitation_operator_key,wsUtil.setTimeout("auto_reply_not_consage(data,{age")},21*s.autoreplies[index].message.length)):(_this.sendRobot(data,{auto_reply_get_contact:auto_reply_get_contact,auto_reply_index:index,scroll:!0}),_this.playSound("message")),parseInt(s.show_contact_form_inside_chat)&&auto_reply_get_contact){if(_this.hasVisitorData())return;if(_this.contactFormIsVisible())return;s.invitation_operator_key&&_this.typing(s.invitation_operator_key,55*s.autoreplies[index].message.length),wsUtil.setTimeout("auto_reply_get_inline_contact",function(){_this.addMessageRobot({subType:"lead"}),_this.setPhoneMaskData(".ws-preform-phone"),_this.showPreform("lead",index,$(this))},55*s.autoreplies[index].message.length)}}},1e3*parseInt(s.autoreplies[index].time))},contactFormIsVisible:function(){return w.window.find(".ws-chat-body-preform").is(":visible")},initRating:function(){w.container.find(".ws-chat-rating-btns a").on("mouseenter.wbk_chat",function(){if("stars"==s.rate_chat_view)for(var value=$(this).data("value"),i=1;i<=value;i++)w.container.find("a.ws-chat-rating-el-"+i).addClass("ws-chat-rating-el-marked");else $(this).addClass("ws-chat-rating-el-marked")}).on("mouseleave.wbk_chat",function(){w.container.find("a.ws-chat-rating-el").removeClass("ws-chat-rating-el-marked")})},checkRatingSettings:function(){if(WBK.settings.chatId&&parseInt(s.rate_chat)&&!parseInt(s.fireChat.rate)&&!this.ratingIsVisible()&&s.messages_quant_to_rate>=parseInt(s.rate_chat_messages_quant)){for(var i=1;i<=5;i++)$(new Image).attr("src",WBK.settings.staticServerUrl+"/widget/img/rating/24/smile_"+i+".png").load(function(){}),$(new Image).attr("src",WBK.settings.staticServerUrl+"/widget/img/rating/32/smile_"+i+".png").load(function(){});wsUtil.setTimeout("showRating",function(){_this.showRating()},500),w.container.find(".ws-chat-rating-btns a").unbind("click").on("click",function(){var rate=$(this).data("value");_this.hideRating();var imageUrlFromCurrentRate=WBK.settings.staticServerUrl+"/widget/img/rating/64/smile_"+rate+".png";"stars"===s.rate_chat_view&&(imageUrlFromCurrentRate=WBK.settings.staticServerUrl+"/widget/img/rating/64/star_"+rate+".png"),_this.sendRobot({text:"Посетитель оценил диалог",subType:"rating",attributes:{imageUrl:imageUrlFromCurrentRate,rate:rate}})})}},ratingIsVisible:function(){return w.container.hasClass("ws-chat-has-rating")},showRating:function(){w.container.addClass("ws-chat-has-rating"),WBK.animateFastOnce(w.container.find(".ws-chat-rating"),"cbk-fadeIn")},hideRating:function(){w.container.removeClass("ws-chat-has-rating")},sendFire:function(data,callback){delete data.key,s.chat_created?_this.messageFire(data):(data.hasOwnProperty("text")&&(data.text=this.smileReplacer(data.text,"to_code")),s.invitation_show_data&&(data.invitation=s.invitation_show_data,data.invitation.hello_text=this.urlInvitationLinkClear(this.smileReplacer(data.invitation.hello_text,"to_code")),data.invitation.text1=this.urlInvitationLinkClear(this.smileReplacer(data.invitation.text1,"to_code")),data.invitation.text2=this.urlInvitationLinkClear(this.smileReplacer(data.invitation.text2,"to_code")),s.invitation_show_data=!1),"function"!=typeof callback&&(callback=function(){}),_this.create(data,callback)),"system"!=data.type&&"auto_reply"!=data.subType&&"open_window"!=data.subType&&"close_window"!=data.subType&&_this.getAutoReply(),s.is_first_message=!1},getAutoReply:function(){if(!s.free_chat_widget&&s.autoreplies)if(s.fireChat.hasOwnProperty("operators")&&s.fireChat.operators.length)s.last_operator_data&&s.send_autoreply&&(_this.checkAutoReply("not_answer_operator",s.last_operator_data),s.send_autoreply=!1);else{if(!s.is_first_message)return;for(var operators_offline=!0,i=0;i<s.fireUserKeys.length;i++)s.fireUsers[s.fireUserKeys[i]].online&&(operators_offline=!1);operators_offline&&!parseInt(s.always_online)?_this.checkAutoReply("not_connected_and_operators_offline"):_this.checkAutoReply("not_connected")}},send:function(data,params){$(".ws-chat-quick-messages").html(""),s.show_quick_message=!1;var time=(new Date).getTime();data.sentAt=time,data.key="visitor_"+time,data.status="sent",data.sender=s.fireSender,_this.appendMessage(data,params),s.is_first_message&&(_this.sendGoal("first_message"),"function"==typeof window.ws_OnChatFirstMessage&&window.ws_OnChatFirstMessage());var sendFire=!0,needSendPickDepartment=(s.is_first_message||"yes"===s.get_contact_can_refuse)&&s.chat_distribution_department_enabled&&!s.chat_distribution_department_picked;if(s.is_first_message&&parseInt(s.get_contact))if(sendFire=!1,s.user_name||s.user_email||s.user_phone){var error=!1;"yes"==s.get_contact_name&&""==s.user_name&&(error=!0),"yes"==s.get_contact_email&&""==s.user_email&&(error=!0),"yes"==s.get_contact_phone&&""==s.user_phone&&(error=!0),error?(s.first_message=data,_this.getContactRobot(!0)):(s.chat_introduced=1,w.window.find(".ws-textarea").html(""),_this.sendFire(data))}else s.first_message=data,_this.getContactRobot(!needSendPickDepartment);if(needSendPickDepartment){s.first_message=data;var cookieDate=new Date;cookieDate.setMinutes(cookieDate.getMinutes()+30),wsUtil.setCookie("WidgetChat_first_message_"+WBK.settings.chatWidgetId,JSON.stringify(data),cookieDate),sendFire||"yes"===s.get_contact_can_refuse?(_this.sendPickDepartmentMessage(),sendFire=!1):s.need_send_pick_department=!0}sendFire&&("rating"!=data.subType&&w.window.find(".ws-textarea").html(""),_this.sendFire(data)),_this.inputScroll(),_this.typingPositionUpdate()},getContactRobot:function(sendFire){_this.addMessageRobot({subType:"preform"}),parseInt(s.show_contact_form_inside_chat)&&(_this.setPhoneMaskData(".ws-preform-phone"),_this.showPreform("preform")),"no"==s.get_contact_can_refuse?_this.changeStateInput(!0,s.lang_text.block_input):s.first_message&&sendFire&&(_this.sendFire(s.first_message),s.first_message=!1)},sendMessage:function(){var messages=[];if(messages=_this.formatMessage($(".ws-textarea")),!messages)return!1;for(var i=0;i<messages.length;i++)_this.send(messages[i],{scroll:!0});return s.is_first_message||w.window.find(".ws-textarea").html(""),this.checkRatingSettings(),!0},inputScroll:function(){if("false"!==w.window.find(".ws-textarea").attr("contenteditable")){w.window.find(".ws-textarea")[0].scrollHeight>92&&!s.input_scroll?s.input_scroll=!0:w.window.find(".ws-textarea")[0].scrollHeight<=92&&s.input_scroll&&(s.input_scroll=!1);var height_input=w.window.find(".ws-textarea").outerHeight();if(s.height_input!=height_input){var bottom_body=62;56==height_input?bottom_body=76:74==height_input?bottom_body=94:height_input>=92&&(bottom_body=112),w.window.find(".ws-chat-body").css("bottom",bottom_body),s.height_input=height_input,_this.scroll()}w.window.find(".ws-textarea-group").nanoScroller(),w.window.find(".ws-textarea-group").nanoScroller({scrollBottom:0})}},insertHTML:function(html){if(navigator.appName.indexOf("Internet Explorer")!=-1)if(document.selection){var r=document.selection.createRange();r.pasteHTML&&r.pasteHTML(html)}else{var r=document.getSelection().getRangeAt(0),n=document.createElement("span");r.surroundContents(n),n.innerHTML=html,r.collapse(!1)}else html&&document.execCommand("insertHtml",!1,html)},uploadFile:function(type){if(s.chat_distribution_department_enabled&&!s.chat_distribution_department_picked)return void(_debug&&_this.log("Необходимо выбрать отдел"));if(s.fileUploadedCount<5){var el,form=new FormData;switch(type){case"doc":el=$(".ws-file-doc-upload")[0].files[0];break;case"img":el=$(".ws-file-img-upload")[0].files[0],form.append("image_type","image")}if(!el)return;form.append(type,el),form.append("type",type),form.append("chat_id",WBK.settings.chatId),_this.uploadFileServer(form,type)}},uploadFileServer:function(form,type){_this.addMessageRobot({subType:"load"}),wsUtil.setInterval("uploading_files",function(){switch(type){case"doc":_this.printing("file","");break;case"img":_this.printing("image","")}},300),$.ajax({type:"POST",url:WBK.settings.serverUrl+"/chat/api/?action=uploadFile",processData:!1,contentType:!1,crossDomain:!0,data:form,dataType:"json",success:function(response){switch(type){case"doc":$(".ws-file-doc-upload").val("");break;case"img":$(".ws-file-img-upload").val("")}w.window.find(".ws-chat-body-content .ws-chat-message-robot").last().find(".ws-chat-progress-bar").stop().animate({width:"100%"},500,function(){if(w.window.find(".ws-chat-body-content .ws-chat-message-robot").last().remove(),"success"===response.status)switch(type){case"doc":var data={icon:response.icon,filename:response.original_name,url:WBK.settings.staticServerUrl+"/"+response.path,size:response.size_full,type:"file"};_this.addFileUploaded(data);break;case"img":var data={preview:WBK.settings.staticServerUrl+"/"+response.path_mini,url:WBK.settings.staticServerUrl+"/"+response.path,size:response.size_full,type:"image",filename:response.original_name};_this.addFileUploaded(data)}else _this.addMessageRobot({type:"text",message:response.message});wsUtil.deleteInterval("uploading_files")})}})},addFileUploaded:function(data){data&&(s.fileUploaded[(new Date).getTime()]=data,_this.updateFilesUploaded())},updateFilesUploaded:function(){var _this=this;$(".ws-chat-uploaded-files").empty();var fileCount=0;$.isEmptyObject(s.fileUploaded)||$.each(s.fileUploaded,function(index,value){var img_url,link,type="";switch(value.type){case"image":type="img",img_url=value.preview,link=value.path;break;case"file":type="file",img_url=value.icon,link=value.path}var block='<div class="ws-chat-uploaded-el ws-chat-uploaded-type-'+type+'" data-index="'+index+'"><div class="ws-chat-uploaded-el-close"><i class="ws-icon-close"></i></div><a class="ws-chat-uploaded-url" href="'+link+'" target="_blank"><img class="ws-chat-uploaded-'+type+'" src="'+img_url+'"></a></div>';$(".ws-chat-uploaded-files").append(block),fileCount++}),fileCount>0?w.window.find(".ws-textarea-send-btn").css("display","flex"):""==$(".ws-textarea").html()&&w.window.find(".ws-textarea-send-btn").hide(),_this.typingPositionUpdate(),s.fileUploadedCount=fileCount},showPreform:function(type,index){"undefined"==typeof index&&(index=0),parseInt(s.show_contact_form_inside_chat)||(w.window.find(".ws-chat-body").hide(),w.window.find(".ws-chat-footer").hide()),w.window.find(".ws-preform-name").closest(".ws-preform-input-group").removeClass("ws-hide"),w.window.find(".ws-preform-email").closest(".ws-preform-input-group").removeClass("ws-hide"),w.window.find(".ws-preform-phone").closest(".ws-preform-input-group").removeClass("ws-hide"),parseInt(s.show_introduce_social_button)||w.window.find(".ws-chat-preform-social").hide();var get_name="hide",get_email="hide",get_phone="hide";switch(type){case"preform":get_name=s.get_contact_name,get_phone=s.get_contact_phone,get_email=s.get_contact_email;break;case"lead":get_name=s.autoreplies[index].get_name,get_phone=s.autoreplies[index].get_phone,get_email=s.autoreplies[index].get_email}w.window.find(".ws-chat-preform-text").text(s.lang_text.preform_text),"hide"==get_name?w.window.find(".ws-preform-name").closest(".ws-preform-input-group").addClass("ws-hide"):w.window.find(".ws-preform-name").closest(".ws-preform-input-group").find(".ws-preform-input-label").html(s.lang_text.form_name+'<span class="ws-input-required">'+("yes"==get_name?" *":"</span>")),"hide"==get_phone?w.window.find(".ws-preform-phone").closest(".ws-preform-input-group").addClass("ws-hide"):w.window.find(".ws-preform-phone").closest(".ws-preform-input-group").find(".ws-preform-input-label").html(s.lang_text.form_phone+'<span class="ws-input-required">'+("yes"==get_phone?" *":"</span>")),"hide"==get_email?(w.window.find(".ws-preform-email").closest(".ws-preform-input-group").addClass("ws-hide"),w.window.find(".ws-preform-email-text").closest(".ws-preform-input-group").addClass("ws-hide")):(w.window.find(".ws-preform-email").closest(".ws-preform-input-group").find(".ws-preform-input-label").html(s.lang_text.form_email+'<span class="ws-input-required">'+("yes"==get_email?" *":"</span>")),"lead"==type&&w.window.find(".ws-preform-email-text").closest(".ws-preform-input-group").addClass("ws-hide")),parseInt(s.email_agreement)||w.window.find(".ws-preform-label-agreement").closest(".ws-preform-input-group").addClass("ws-hide"),w.window.find(".ws-preform-btn-save").data("type",type).data("index",index),parseInt(s.show_contact_form_inside_chat)||(w.window.find(".ws-chat-body-preform").show(),"pc"==WBK.settings.device&&this.reinitPreformPosition()),s.useTelephonyMask&&WBK.setPhoneInputFocusForm($(".ws-preform-phone")),"yes"==get_name&&""==$(".ws-preform-name").val().trim()?$(".ws-preform-name").focus():"yes"!=get_phone||""!=$(".ws-preform-phone").val().trim()&&$(".ws-preform-phone").val().trim()!=WBK.settings.phoneBase?"yes"!=get_email||""!=$(".ws-preform-email").val().trim()&&wsUtil.validateEmail($(".ws-preform-email").val().trim())?wsUtil.setCaretPosition($(".ws-preform-name"),$(".ws-preform-name").val().length):$(".ws-preform-email").focus():$(".ws-preform-phone").focus(),"lead"==type&&parseInt(s.show_contact_form_inside_chat)&&(w.window.find(".ws-preform-input-group:not(.ws-hide):first").css("margin-top","0px"),w.window.find(".ws-chat-preform-text").hide()),s.agreementLink&&w.window.find(".ws-chat-agreement-link").attr("href",s.agreementLink)},reinitPreformPosition:function(){var top_window=w.window.position().top,h_window=w.window.find(".ws-chat-header").outerHeight()+w.window.find(".ws-chat-body-preform").outerHeight(),h_doc=wsUtil.getVisualHeight();w.window.outerHeight()<h_window&&w.window.height(h_window);var diff=h_doc-h_window-top_window,top=0;diff<0&&(top=(top_window+diff)/(h_doc/100),top<0&&(top=0),w.window.css({top:top+"%",height:"auto"}))},hidePreform:function(){w.window.find(".ws-chat-body").show(),w.window.find(".ws-chat-footer").show(),""!==$(".ws-textarea").html()?w.window.find(".ws-textarea-group .ws-textarea-placeholder").hide():w.window.find(".ws-textarea-group .ws-textarea-placeholder").show(),w.window.find(".ws-chat-body-preform").hide(),_this.scroll()},savePreform:function(type,index,context){void 0==type&&(type="preform"),void 0==index&&(index=!1);var get_name="hide",get_email="hide",get_phone="hide";switch(type){case"preform":get_name=s.get_contact_name,get_phone=s.get_contact_phone,get_email=s.get_contact_email;break;case"lead":_this.stopAutoReply("all"),get_name=s.autoreplies[index].get_name,get_phone=s.autoreplies[index].get_phone,get_email=s.autoreplies[index].get_email}w.window.find(".ws-preform-name, .ws-preform-phone, .ws-preform-email").removeClass("ws-input-error");var phoneMask,name=w.window.find(".ws-preform-name").val(),email=w.window.find(".ws-preform-email").val(),emailAgreement=$(".ws-preform-email-agreement").is(":checked")?1:0,emailDistributionAgreement=$(".preform-email-distribution-agreement").is(":checked")?1:0,phone=w.window.find(".ws-preform-phone").val();if(s.useTelephonyMask)phoneMask=w.window.find(".ws-preform-phone").attr("placeholder"),phone=WBK.checkPhone(phone,!0);else{s.user_phone_without_dial_code=phone;var formInChatBody=w.window.find(".ws-preform-phone").closest(".ws-chat-message-robot-preform").length;phone=formInChatBody?this.getActualPhoneWithCountryCode(phone,"chatBodyPreformPhone"+(w.window.find(".ws-chat-message-robot-preform .ws-preform-phone").length-1)):this.getActualPhoneWithCountryCode(phone,"preformPhone"),phone=phone.replace(/[^\d]/g,"")}phone=phone?phone:"";var errors_class="";if("yes"==get_name&&""==name.trim()&&(errors_class=".ws-preform-name"),"yes"==get_phone&&""==phone.trim()&&(errors_class?errors_class+=", .ws-preform-phone":errors_class=".ws-preform-phone"),"yes"!=get_email||""!=email.trim()&&wsUtil.validateEmail(email.trim())||(errors_class?errors_class+=", .ws-preform-email":errors_class=".ws-preform-email"),errors_class)return void w.window.find(errors_class).addClass("ws-input-error");"lead"==type&&($(".ws-chat-autoreply-link").closest(".ws-chat-message-robot").remove(),$(".ws-chat-autoreply-link").remove()),name&&(WBK.settings.visitorName=name.charAt(0).toUpperCase()+name.substr(1,name.length-1)),email&&(WBK.settings.visitorEmail=email),phone&&(WBK.settings.visitorPhone=phone),"default"==s.auth_type&&name&&(s.logo_visitor=WBK.settings.serverUrl+"/firstletter/?name="+encodeURI(name.substr(0,1))+"&color="+s.chat_visitor_color),_this.updateUser(!0);var message="";"preform"==type&&name?message=s.user_name+", "+s.lang_text.preform_text_success:"preform"==type?(message=s.lang_text.preform_text_success,message=message.charAt(0).toUpperCase()+message.substr(1)):"lead"==type&&name?message=s.user_name+", "+s.lang_text.preform_lead_text_success:"lead"==type&&(message=s.lang_text.preform_lead_text_success,message=message.charAt(0).toUpperCase()+message.substr(1)),_this.addMessageRobot({subType:"text",text:message}),w.window.find(".ws-chat-message-input").closest(".ws-chat-message-robot").remove();var siteUrl="";document.URL&&(siteUrl=encodeURIComponent(document.URL));var data={code:WBK.settings.whiteSaasCode,url:siteUrl,name:name,email:email,phone:phone,emailAgreement:emailAgreement,emailDistributionAgreement:emailDistributionAgreement,type_preform:type,type:s.auth_type,image_url:s.logo_visitor,vk_id:s.visitor_vk_id,fb_id:s.visitor_fb_id,fb_token:s.visitor_fb_token,visitId:WBK.settings.visitId,visitorId:WBK.settings.visitorId,chatWidgetId:WBK.settings.chatWidgetId,chatId:WBK.settings.chatId,phoneMask:phoneMask,googleClientId:wsUtil.getGoogleClientId(),roistatPromo:wsUtil.getRoistatPromo(),advertiseId:wsUtil.getAdvertiseId(),calltrackingId:wsUtil.getCalltrackingId(),lpgeneratorId:wsUtil.getLPGeneratorId(),leadvertexId:wsUtil.getLeadvertexId(),externalParams:wsUtil.getExternalParams()};if(WBK.setVisitorInfoIfNot({name:name,phone:phone,email:email}),s.need_send_pick_department)s.need_send_pick_department=!1,_this.sendPickDepartmentMessage(),s.preform_request_data={request:data,context:context},_this.clearContextRobotMessage(context);else{
var pickDepartmentSelect=w.window.find(".ws-chat-message-robot-pick-department");if(pickDepartmentSelect&&pickDepartmentSelect.is(":visible"))return w.window.find(".ws-chat-message-robot-preform").remove(),void(s.preform_request_data={request:data,context:context});s.is_first_message&&s.first_message?(_this.sendFire(s.first_message,function(){"default"==s.auth_type&&name&&(s.logo_visitor=WBK.settings.serverUrl+"/firstletter/?name="+encodeURI(name.substr(0,1))+"&color="+s.chat_visitor_color,data.image_url=s.logo_visitor),data.chatId=WBK.settings.chatId,_this.sendPreformRequest(data,context)}),s.first_message=!1,_this.changeStateInput(!1,"")):(_this.changeStateInput(!1,""),_this.sendPreformRequest(data,context))}_this.hidePreform()},sendPreformRequest:function(request,context){var url=WBK.settings.serverUrl+"/api?action=chatSavePreform";$.post(url,request,"json"),"function"==typeof window.ws_OnChatVisitorIntroduced&&window.ws_OnChatVisitorIntroduced(request),_this.chatAutoCall(request.phone.trim(),request.phoneMask),_this.sendGoal("visitor_introduced"),_this.clearContextRobotMessage(context)},clearContextRor res={new_block:!1,date_line:!1},result="";result=date?new Date(date):new Date;var now_time=new Date,format=function(num){return(num+"").length<2?"0"+num:num},minLeft=!1;return s.chat_old_time?(minLeft=s.chat_old_time<result&&Math.ceil((result-s.chat_old_time)/6e4),s.chat_old_time.getFullYear()==result.getFullYear()&&s.chat_old_time.getMonth()==result.getMonth()&&s.chat_old_time.getDate()==result.getDate()||(s.chat_old_time.getFullYear()!=result.getFullYear()?res.date_line=s.lang_text.dayNames[result.getDay()]+", "+result.getDate()+" "+s.lang_text.monthNames[result.getMonth()]+" "+result.getFullYear():res.date_line=s.lang_text.dayNames[result.getDay()]+", "+result.getDate()+" "+s.lang_text.monthNames[result.getMonth()])):(minLeft=now_time>result&&Math.ceil((now_time-result)/6e4),now_time.getFullYear()==result.getFullYear()&&now_time.getMonth()==result.getMonth()&&now_time.getDate()==result.getDate()||(now_time.getFullYear()!=result.getFullYear()?res.date_line=s.lang_text.dayNames[result.getDay()]+", "+result.getDate()+" "+s.lang_text.monthNames[result.getMonth()]+" "+result.getFullYear():res.date_line=s.lang_text.dayNames[result.getDay()]+", "+result.getDate()+" "+s.lang_text.monthNames[result.getMonth()])),s.chat_old_time=result,minLeft&&minLeft>5&&(res.new_block=!0),result.getDay()==now_time.getDay()?(res.time=format(result.getHours())+":"+format(result.getMinutes()),res):(res.time=format(result.getDate())+"."+format(result.getMonth()+1)+"."+(result.getFullYear()+"").substr(2),res)},formatMessage:function(el){if(!el)return"";var message=_this.cleanMessage(el),messages_arr=[];$.isEmptyObject(s.fileUploaded)||($.each(s.fileUploaded,function(index,value){messages_arr.push(value)}),s.fileUploaded={},_this.updateFilesUploaded());var matches=message.match(/(?!((.+)\/widget\/img\/blank.gif))(https?:\/\/[\w\-\.]+\.[a-zA-Z]{2,6}(?:\/\S*)?(?:[\w])+\.(?:jpg|png|gif|jpeg|bmp))/gi);if(matches){for(var i=0;i<matches.length;i++){var pos=message.indexOf(matches[i]);messages_arr.push({text:message.slice(0,pos),type:"text"}),messages_arr.push({type:"image",preview:matches[i],url:matches[i],size:0}),message=message.slice(pos,message.length).replace(matches[i],"")}message&&messages_arr.push({text:message,type:"text"})}else message&&messages_arr.push({text:message,type:"text"});return messages_arr},escapeHtml:function(unsafe){return unsafe.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")},textUrlFormat:function(text){var urlsFound=!1,emailIsFound=!1;return text=(text||"").replace(/(^|([^A-Za-z0-9А-Яа-яёЁ\-\_])|(ws\-text\-link)(.+?)href\=\')(https?:\/\/)?((?:[A-Za-z\$0-9А-Яа-яёЁ](?:[A-Za-z\$0-9\-\_А-Яа-яёЁ]*[A-Za-z\$0-9А-Яа-яёЁ])?\.){1,5}[A-Za-z\$рфуконлайнстРФУКОНЛАЙНСТ\-\d]{2,22}(?::\d{2,5})?)((?:\/?(?:(?:\&|\&amp;|\&#33;|,[_%]|[A-Za-z0-9А-Яа-яёЁ\-\_#%?!+\/\$\|.~=;:']+|\[[A-Za-z0-9А-Яа-яёЁ\-\_#%?!+\/\$.,~=;:]*\]|\([A-Za-z0-9А-Яа-яёЁ\-\_#%?!+\/\$.,~=;:]*\))*(?:,[_%]|[A-Za-z0-9А-Яа-яёЁ\-\_#%?!+\/\$.~=,;:]*[A-Za-z0-9А-Яа-яёЁ\_#%?!+\/\$~=]|\[[A-Za-z0-9А-Яа-яёЁ\-\_#%?!+\/\$.,~=;:]*\]|\([A-Za-z0-9А-Яа-яёЁ\-\_#%?!+\/\$.,~=;:]*\)))?)?)/gi,function(){var matches=Array.prototype.slice.apply(arguments),prefix=matches[1]||"",protocol=matches[5]||"http://",domain=matches[6]||"",url=domain+(matches[7]||""),full=(matches[5]||"")+matches[6]+matches[7];if(domain.indexOf(".")==-1||domain.indexOf("..")!=-1)return matches[0];var topDomain=domain.split(".").pop(),gDomains="info,name,academy,aero,arpa,coop,media,museum,mobi,travel,xxx,asia,biz,com,net,org,gov,mil,edu,int,tel,ac,ad,ae,af,ag,ai,al,am,an,ao,aq,ar,as,at,au,aw,ax,az,ba,bb,bd,be,bf,bg,bh,bi,bj,bm,bn,bo,br,bs,bt,bv,bw,by,bz,ca,cc,cd,cf,cg,ch,ci,ck,cl,cm,cn,co,cr,cu,cv,cx,cy,cz,de,dj,dk,dm,do,dz,ec,ee,eg,eh,er,es,et,eu,fi,fj,fk,fm,fo,fr,ga,gd,ge,gf,gg,gh,gi,gl,gm,gn,gp,gq,gr,gs,gt,gu,gw,gy,hk,hm,hn,hr,ht,hu,id,ie,il,im,in,io,iq,ir,is,it,je,jm,jo,jp,ke,kg,kh,ki,km,kn,kp,kr,kw,ky,kz,la,lb,lc,li,lk,lr,ls,lt,lu,lv,ly,ma,mc,md,me,mg,mh,mk,ml,mm,mn,mo,mp,mq,mr,ms,mt,mu,mv,mw,mx,my,mz,na,nc,ne,nf,ng,ni,nl,no,np,nr,nu,nz,om,pa,pe,pf,pg,ph,pk,pl,pm,pn,pr,ps,pt,pw,py,qa,re,ro,ru,rs,rw,sa,sb,sc,sd,se,sg,sh,si,sj,sk,sl,sm,sn,so,sr,ss,st,su,sv,sx,sy,sz,tc,td,tf,tg,th,tj,tk,tl,tm,tn,to,tp,tr,tt,tv,tw,tz,ua,ug,uk,um,us,uy,uz,va,vc,ve,vg,vi,vn,vu,wf,ws,ye,yt,yu,za,zm,zw,рф,укр,сайт,онлайн,срб,cat,pro,local,plus,xn--p1ai,xn--80aswg,xn--80asehdb";if(url.indexOf("widget/img/blank")+1>0||matches[0].indexOf("@")!=-1)return matches[0];if((topDomain.length>12||gDomains.split(",").indexOf(topDomain)==-1)&&(!/^[a-zA-Z]+$/.test(topDomain)||!matches[5]))return matches[0];try{full=decodeURIComponent(full),full=_this.escapeHtml(full)}catch(e){}return urlsFound=!0,prefix+'<a class="ws-chat-message-link" href="'+protocol+url+'" target="_blank">'+full+"</a>"}),text=text.replace(/([a-zA-ZА-Яа-яёЁ\-_\.0-9]+@[a-zA-ZА-Яа-яёЁ\-_0-9]+\.[a-zA-ZА-Яа-яёЁ\-_\.0-9]+[a-zA-ZА-Яа-яёЁ\-_0-9]+)/g,function(email){return emailIsFound=!0,'<a class="ws-chat-message-link" href="mailto:'+email+'" target="_blank">'+email+"</a>"})},cleanTextToApp:function(text){var text=text.replace(/^\n|\n$/g," ").replace(/[\n\xa0]/g," ").replace(/[ ]+/g," ");return text=text?text.replace(/&/g,"&").replace(/</g,"<").replace(/>/g,">").replace(/"/g,'"').replace(/'/g,"'"):""},cleanTextToHtml:function(text){return text=text?text.replace(/(\<(?!(img class="ws-sprite-emoji emoji-img|a class\=\'ws\-text\-link|\/a)))/g,"&lt;"):"",text=this.textUrlFormat(text)},cleanMessage:function(el){if(!el)return"";el=el instanceof $?el[0].firstChild:el.firsR|TD|BLOCKQUOTE|SCRIPT)$");el;){switch(el.nodeType){case 3:var str=this.cleanTextToApp(el.data);v+=str;break;case 1:var str=_this.cleanMessage(el);if(el.tagName&&el.tagName.="\n");for(var prev=el.prev=prev.previousSibling;!prev||prev.tagName&&prev.tagName.match(contTag)||(str="\n"+str)}else"IMG"==el.tagName?str+=el.outerHTML:"BR"==el.tagName&&(str+="\n");v+=str}el=el.nextSibling}return $.trim(v)},getOperatorsKeys:function(){var operatorsKey={all:[],online:[]};return $.each(s.fireUsers,function(index,value){"operator"===value.role&&(operatorsKey.all.push(index),value.online&&operatorsKey.online.push(index))}),operatorsKey},create:function(messageData,callback){var _t=this;if(s.chatCreating)s.messages_for_send_by_timer.push(messageData),wsUtil.getInterval("chatCreating")||wsUtil.setInterval("chatCreating",function(e){if(!s.chatCreating&&(wsUtil.deleteInterval("chatCreating"),s.messages_for_send_by_timer&&s.messages_for_send_by_timer.length)){for(var i in s.messages_for_send_by_timer)_this.messageFire(s.messages_for_send_by_timer[i]);s.messages_for_send_by_timer=[]}},1e3);else{s.chatCreating=!0;var url=WBK.settings.serverUrl+"/api?action=chatCreateNew",operatorKeys=_t.getOperatorsKeys();jWS.post(url,{code:WBK.settings.whiteSaasCode,visitorName:WBK.settings.visitorName?WBK.settings.visitorName:"",data:messageData,type_show:wsUtil.getCookie("WidgetChat_shownOn"),visitorId:WBK.settings.visitorId,url:"string"==typeof document.URL?document.URL:"",chatWidgetId:WBK.settings.chatWidgetId,googleClientId:wsUtil.getGoogleClientId(),roistatPromo:wsUtil.getRoistatPromo(),advertiseId:wsUtil.getAdvertiseId(),calltrackingId:wsUtil.getCalltrackingId(),lpgeneratorId:wsUtil.getLPGeneratorId(),leadvertexId:wsUtil.getLeadvertexId(),operatorsOnline:operatorKeys.online,operatorsAll:operatorKeys.all,externalParams:wsUtil.getExternalParams(),departmentId:s.chat_distribution_department_picked},function(result){if(result&&result.Success&&result.Data&&result.Data.chat){for(var key=0;key<s.invitations.length;key++)wsUtil.deleteInterval("invitationShow_"+key);WBK.settings.chatId=result.Data.chat.id,s.chat_visitor_color=result.Data.chat.color,s.chat_visitor_name=result.Data.chat.visitor_name,s.chat_visitor_img=result.Data.chat.img,s.chatKey=result.Data.data.chat_key,s.visitorKey=result.Data.data.visitor_key;var invitationsKey=(result.Data.data.message_key,result.Data.data.invitation_keys);invitationsKey&&$.each(invitationsKey,function(index,value){_t.updateMessageId(index,value)}),_t.updateMessageId(messageData.sentAt,result.Data.data.message_key),s.v2_local?(s.fireChat=result.Data.data.chat,s.visitor=result.Data.data.visitor,_t.loadLocalChat().then(function(){s.chatCreating=!1,s.chat_created=!0})):_t.loadFireChat().then(function(){_t.addOldMessages(),s.chatCreating=!1,s.chat_created=!0}),_this.updateVisitor({chatCreated:!0,chatKey:s.chatKey,said:!0}),"function"==typeof callback&&callback()}else s.chatCreating=!1},"json")}},updateFireChat:functAutoReply("not_answer_operator"),_this.stopAutoReply("not_connected")),"userText"==key&&data&&this.showPrinting(data),"operators"==key&&(s.fireChat.operators=data||[],this.operatorsUpdate()),"status"==key&&data&&(s.fireChat.status=data,"ended"!=data&&"auto_ended"!=data&&"lost"!=data||this.onCloseChat()),s.fireChat[key]=data},showPrinting:function(data){jWS.isEmptyObject(data)||$.each(data,function(key,value){if(value&&s.all_operators.hasOwnProperty(key)&&s.fireOperatorPrinting[key]!=did _this.onOperatorPrinting(key)})},printing:function(type,message){s.printingData.type=type,s.printingData.message=this.smileReplacer(message,"to_code"),this.updatePrintingTimeout(),wsUtil.getInterval("printingInterval")||(this.sendPrinting(),wsUtil.setInterval("printingInterval",function(){_this.sendPrinting()},3e3))},sendPrinting:function(){var data={};s.chatKey&&!s.fireChat.visitorBlocked&&s.fireChat.visitor&&s.chat_created&&(s.v2_local?(data=s.printingData,data.userKey=s.fireChat.visitor,ChatLocalServer.printing(s.chatKey,data)):("text"==s.printingData.type&&s.printingData.message&&(data["userText/"+s.fireChat.visitor]=s.printingData.message),data["userActivity/"+s.fireChat.visitor]=s.printingData.type,this.getChatRef().update(data)))},updatePrintingTimeout:function(){wsUtil.deleteTimeout("printingTimeout"),wsUtil.setTimeout("printingTimeout",function(){_this.removePrinting()},5e3)},removePrinting:function(){if(wsUtil.deleteInterval("printingInterval"),wsUtil.deleteTimeout("printingTimeout"),s.chatKey&&s.fireChat&&!s.fireChat.visitorBlocked&&s.chat_created){var data={};s.v2_local?(data={userKey:s.fireChat.visitor,type:null,message:null},ChatLocalServer.printing(s.chatKey,data)):(data["userActivity/"+s.fireChat.visitor]=null,data["userText/"+s.fireChat.visitor]=null,this.getChatRef().update(data))}},messageFire:function(data){s.chatKey&&!s.fireChat.visitorBlocked&&(data.hasOwnProperty("status")||(data.status="delivered"),data.hasOwnProperty("text")&&(data.text=this.smileReplacer(data.text,"to_code")),s.v2_local?_this.messageLocalRun(data):_this.messageFireRun(data))},messageFireRun:function(data){var key=data.sentAt;if(data.sentAt={".sv":"timestamp"},"system"==data.type&&(data.sender||(data.sender=s.fireRobot.key),messageKey=_this.getChatMessageRef().push(data),"rating"==data.subType&&_this.getChatRef().child("rate").set(data.attributes.rate)),"system"!=data.type){data.sender=s.fireSender,_this.removePrinting();var messageKey=_this.getChatMessageRef().push(data,function(error){error||_this.updateMessageId(key,messageKey)}).key;_this.updateVisitor({said:!0}),_this.getChatRef().update({unreadCount:s.fireChat.unreadCount+1,lastMessage:data,noAnswerRequired:!1})}},messageLocalRun:function(data){var key=data.sentAt;data.localKey="visitor_"+key,"system"==data.type&&(data.sender||(data.sender=s.fireRobot.key),ChatLocalServer.sendMessage(s.chatKey,data).then(function(result){_this.updateMessageId(key,result.key)})),"system"!=data.type&&(data.sender=s.fireSender,ChatLocalServer.sendMessage(s.chatKey,data).then(function(result){_this.updateMessageId(key,result.key)}),_this.removePrinting(),_this.updateVisitor({said:!0}))},updateMessageId:function(key,newKey){var key="visitor_"+key,data=s.fireMessages[key];s.fireMessages[newKey]=data,delete s.fireMessages[key];var el=w.window.find(".ws-chat-body-content").find("#"+key);el.attr("id",newKey),el.data("sender",s.visitorKey),this.updateMessageDataById(newKey,{status:"delivered"})},updateMessageDataById:function(key,data){var el=w.window.find(".ws-chat-body-content").find("#"+key);if(el.length>0&&data.text&&data.text!==el.find(".ws-chat-message-source").text()){var text=this.cleanTextToHtml(data.text);text=this.smileReplacer(text,"to_img"),el.find(".ws-chat-message-source").html(text)}if(data.hasOwnProperty("status")){var el=el.closest(".ws-chat-message-block");el.find(".ws-chat-message-status").text(this.getStatusText(data.status))}},getFcmData:function(message,isFirstMessage){var name=WBK.settings.visitorName?WBK.settings.visitorName:s.user_name?s.user_name:s.chat_visitor_name,text="Новое сообщение",img_url="";switch(img_url="default"!=s.auth_type?s.logo_visitor:s.chat_visitor_img?s.chat_visitor_img:WBK.settings.serverUrl+"/firstletter/?name="+name.substr(0,1)+"&color="+s.chat_visitor_color,message.message_type){case"show_invitation":case"text":text=message.message.text.replace(/(?:\r\n|\r|\n)/g,"<br />");break;case"attach_image":text="Посетитель отправил изображение";break;case"attach_file":text="Посетитель отправил документ";break;case"rating":text="Посетитель оценил работу оператора";break;case"introduced":text="Посетитель представился"}var fcmData={is_first:isFirstMessage,chat_id:WBK.settings.chatId,visitor_id:WBK.settings.visitorId,name:name,message:text,color:s.chat_visitor_color,introduced:s.chat_introduced,auth_type:s.auth_type,image:img_url,vk_id:s.visitor_vk_id,fb_id:s.visitor_fb_id};return fcmData},messageRead:function(messageKey){s.chatKey&&s.fireChat&&s.fireChat.visitor&&(s.v2_local?ChatLocalServer.updateMessage(s.chatKey,messageKey,{status:"read"}):(this.getChatMessageRef().child(messageKey).update({status:"read"}),s.fireChat.lastMessage.sender!=s.fireChat.visitor&&this.getChatRef().child("lastMessage").update({status:"read"})),_this.updateVisitor({said:!0}))},messageReadVisitor:function(){for(var i=0;i<s.unread_messages.length;i++)_this.messageRead(s.unread_messages[i]);s.unread_messages=[],_this.setUnreadMessages(0)},setUnreadMessages:function(count){var favicon_el=$('link[rel="shortcut icon"], link[rel="icon"]');if(count>99&&(count=99),WBK.settings.multiButtonEnabled&&wsMultiButton.showBudgeMessage(count),wsUtil.deleteInterval("unreadMessages"),0==count)return w.btn.find(".ws-btn-badge").text("").hide(),s.unread_messages_count=0,document.title=s.document_title,s.new_favicon_href="",void(s.document_favicon_href&&favicon_el.attr("href",s.document_favicon_href));if(w.btn.find(".ws-btn-badge").text(count).show(),s.document_favicon_href){var img=$('<img crossOrigin="anonymous" src="'+s.document_favicon_href+'"/>');img.load(function(){s.new_favicon_href=_this.generateFavicon(img,count),wsUtil.setInterval("unreadMessages",function(){s.document_title==document.title?(document.title=wsUtil.doEnding(count,s.lang_text.one_new_mess,s.lang_text.two_new_mess,s.lang_text.five_new_mess),s.new_favicon_href&&favicon_el.attr("href",s.new_favicon_href)):(document.title=s.document_title,s.document_favicon_href&&favicon_el.attr("href",s.document_favicon_href))},1e3)}).error(function(){wsUtil.setInterval("unreadMessages",function(){s.document_title==document.title?document.title=count+" "+wsUtil.doEnding(count,s.lang_text.one_new_mess,s.lang_text.two_new_mess,s.lang_text.five_new_mess):document.title=s.document_title},1e3)})}else wsUtil.setInterval("unreadMessages",function(){s.document_title==document.title?document.title=count+" "+wsUtil.doEnding(count,s.lang_text.one_new_mess,s.lang_text.two_new_mess,s.lang_text.five_new_mess):document.title=s.document_title},1e3)},generateFavicon:function(img,count){if(s.document_favicon_href){var ctx,canvas=$("<canvas/>");$('link[rel="shortcut icon"], link[rel="icon"]');if(canvas[0].getContext("2d")){canvas[0].height=canvas[0].width=img[0].width,ctx=canvas[0].getContext("2d"),count&&(ctx.globalAlpha=.4,count<10?count=" "+count:count>100&&(count=99));var multiplier=img[0].width/16,fontSize=11*multiplier,xOffset=multiplier,yOffset=11*multiplier,border=multiplier,shadow=2*multiplier;return ctx.drawImage(img[0],0,0),ctx.globalAlpha=1,ctx.font="bold "+fontSize+'px "helvetica", sans-serif',ctx.shadowColor="#FFF",ctx.shadowBlur=shadow,ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.fillStyle="#FFF",ctx.fillText(count,xOffset,yOffset),ctx.fillText(count,xOffset+border,yOffset),ctx.fillText(count,xOffset,yOffset+border),ctx.fillText(count,xOffset+border,yOffset+border),ctx.fillStyle="#000",ctx.fillText(count,xOffset+border/2,yOffset+border/2),canvas[0].toDataURL("image/png")}}},scroll:function(){var body=w.window.find(".ws-chat-body");body[0].hasOwnProperty("nanoscroller")&&(body.nanoScroller(),body.nanoScroller({scrollBottom:0}))},initBtnPosition:function(){var css={},css_invitation={};if(w.btn.show(),"pc"!=WBK.settings.device)"hide"==s.button_location||"pc"!=WBK.settings.device&&parseInt(s.hide_mobile)||_this.updateBtnPositionMobile();else{switch(s.button_location){case"horizontal":switch(s.position_x){case"left":css.left=s.position_x_value+"%",css.right="auto",w.invitation.addClass("ws-chat-invitation-left");break;case"right":css.right=s.position_x_value+"%",css.left="auto"}switch(s.position_y){case"bottom":css.bottom=s.position_y_value+"%",css.top="auto",0==s.position_y_value&&w.btn.addClass("ws-chat-btn-attach"),WBK.addStyles(".ws-chat .ws-chat-invitation-container:after{border-top-color: "+s.color_background_invitation+" !important;}");break;case"top":css.top=s.position_y_value+"%",css.bottom="auto",0==s.position_y_value&&(w.btn.addClass("ws-chat-btn-attach-top"),w.btn.find(".ws-btn-badge").css("top","32px")),w.invitation.addClass("ws-chat-invitation-bottom"),WBK.addStyles(".ws-chat .ws-chat-invitation-container:after{border-bottom-color: "+s.color_background_invitation+" !important;}")}break;case"vertical_left":w.btn.addClass("ws-chat-btn-rotate").addClass("ws-chat-btn-attach-top"),w.btn.find(".ws-btn-badge").css("top","32px"),css.left=-(w.btn.outerWidth()-w.btn.outerHeight())/2+"px",css.right="auto",css_invitation.left=w.btn.outerWidth()/2+w.btn.outerHeight()+"px",css_invitation.right="auto",w.invitation.addClass("ws-chat-invitation-rotate-right"),WBK.addStyles(".ws-chat .ws-chat-invitation-container:after{border-right-color: "+s.color_background_invitation+" !important;}");break;case"vertical_right":w.btn.addClass("ws-chat-btn-rotate").addClass("ws-chat-btn-attach"),css.right=-(w.btn.outerWidth()-w.btn.outerHeight())/2+"px",css.left="auto",css_invitation.right=w.btn.outerWidth()/2+w.btn.outerHeight()+"px",css_invitation.left="auto",w.invitation.addClass("ws-chat-invitation-rotate-left"),WBK.addStyles(".ws-chat .ws-chat-invitation-container:after{border-left-color: "+s.color_background_invitation+" !important;}")}if("vertical_left"==s.button_location||"vertical_right"==s.button_location){switch(s.position_y){case"bottom":css.bottom=(w.btn.outerWidth()-w.btn.outerHeight())/2+window.innerHeight/100*s.position_y_value+"px",css.top="auto";break;case"top":css.top=(w.btn.outerWidth()-w.btn.outerHeight())/2+window.innerHeight/100*s.position_y_value+"px",css.bottom="auto"}w.invitation.css({top:-(w.btn.outerWidth()-w.btn.outerHeight())/2+"px",bottom:"auto",left:css_invitation.left,right:css_invitation.right})}w.btn_el.css(css)}w.btn.hide()},upInvitationIfNotFit:function(){if("mobile"===WBK.settings.device){var byBtn=w.btn_el,settingPositionBtnX=s.mobile_position_x,multiBtn=$(document).find(".multi_button"),advancedOffset=0,advancedOffsetByX=0,chatInButton=this.checkMultibuttonForChatActivated();if(chatInButton)if(byBtn=multiBtn.first(),settingPositionBtnX=wsMultiButton.settings.position_x,"bottom"!==wsMultiButton.settings.position_y)switch(wsMultiButton.settings.size){case"mb_big_size":advancedOffset=20,advancedOffsetByX=20;break;case"mb_medium_size":advancedOffset=10,advancedOffsetByX=10}else switch(wsMultiButton.settings.size){case"mb_big_size":advancedOffset=-20,advancedOffsetByX=20;break;case"mb_medium_size":advancedOffset=-10,advancedOffsetByX=10}var windowWidth=parseInt(window.outerWidth),windowHeight=parseInt(window.outerHeight),btnLeftOffset=parseInt(byBtn.offset().left),btnWidth=byBtn.outerWidth(),btnHeight=byBtn.outerHeight(),btnHeightWithMargin=byBtn.outerHeight(!0),btnRightOffset=windowWidth-(btnLeftOffset+btnWidth),invitationInput=w.invitation.find(".ws-chat-invitation-input"),horizontalPadding=10,smallButtonSize=50,invitationInputWidth=w.invitation.outerWidth()-smallButtonSize,invitationContainerOffsetLeft=windowWidth-w.invitation.outerWidth()-btnRightOffset-horizontalPadding,btnTopOffset=byBtn.position().top,freeSpaceUnderBtn=windowHeight-(btnTopOffset+btnHeight);w.invitation.css({top:"",bottom:""}),("none"!==byBtn.css("display")||chatInButton)&&("left"===settingPositionBtnX&&btnRightOffset<invitationInputWidth||"right"===settingPositionBtnX&&btnLeftOffset<invitationInputWidth&&invitationContainerOffsetLeft<0||invitationContainerOffsetLeft<0&&btnRightOffset<invitationInputWidth)?(w.invitation.css({left:-btnLeftOffset+horizontalPadding}),invitationInput.addClass("invitation-input-full-size"),btnTopOffset>freeSpaceUnderBtn?(this.changeChatVerticalOrientationOnMobile("top"),chatInButton?(this.setChatBtnElVerticalPositionLikeMultibutton(),w.invitation.css({bottom:btnHeight-advancedOffset,top:"unset"}),"top"===wsMultiButton.settings.position_y&&(w.invitation.css({bottom:"unset",top:btnHeightWithMargin}),this.changeChatVerticalOrientationOnMobile("bottom"))):"bottom"===s.mobile_position_y?w.invitation.css({bottom:btnHeight,top:"unset"}):(w.invitation.css({bottom:"unset",top:btnHeight+advancedOffset}),this.changeChatVerticalOrientationOnMobile("bottom"))):freeSpaceUnderBtn>=btnTopOffset&&(chatInButton?(this.setChatBtnElVerticalPositionLikeMultibutton(),w.invitation.css({bottom:"unset",top:btnHeightWithMargin+advancedOffset})):w.invitation.css({bottom:"unset",top:btnHeight+advancedOffset}),thtionOnMobile("bottom"))):(invitationInput.removeClass("invitation-input-full-size"),chatInButton&&(this.setChatBtnElVerticalPositionLikeMultibutton(),"top"===wsMultiButton.settings.position_y?(this.changeChatVerticalOrientationOnMobile("top"),w.invitation.css("top",btnHeightWithMargin)):"bottom"===wsMultiButton.settings.position_y&&this.changeChatVerticalOrientationOnMobile("bottom")),"right"===settingPositionBtnX&&chatInButton===!0&&(w.btn_el.css({right:wsMultiButton.settings.position_x_value+"%"}),w.invitation.css({left:"",right:advancedOffsetByX})))}},setChatBtnElVerticalPositionLikeMultibutton:function(){var multiBtn=$(document).find(".multi_button");w.btn_el.css({top:"",bottom:""}),"top"===wsMultiButton.settings.position_y?w.btn_el.css({top:wsMultiButton.settings.position_y_value+"%"}):w.btn_el.css({bottom:wsMultiButton.settings.position_y_value+"%","margin-bottom":multiBtn.css("margin-bottom")})},setChatBtnElHorizontalPositionLikeMultibutton:function(){switch(w.btn_el.css({left:"auto",right:"auto"}),wsMultiButton.settings.position_x){case"left":w.btn_el.css("left",wsMultiButton.settings.position_x_value+"%");break;case"right":w.btn_el.css("right",wsMultiButton.settings.position_x_value+"%")}},changeChatVerticalOrientationOnMobile:function(orientation){var wsChatMobile=$(".ws-chat-mobile");switch(wsChatMobile.removeClass("top bottom"),orientation){case"top":wsChatMobile.addClass("top");break;case"bottom":wsChatMobile.addClass("bottom")}},changeChatHorizontalOrientationOnMobile:function(orientation){var wsChatMobile=$(".ws-chat-mobile");switch(wsChatMobile.removeClass("left right"),orientation){case"left":wsChatMobile.addClass("left");break;case"right":wsChatMobile.addClass("right")}},checkMultibuttonForChatActivated:function(){var chatInButton=!1;return WBK.settings.multiButtonEnabled&&$.each(wsMultiButton.settings.checked_variants,function(index,value){"chat"===value.action&&value.action_value==WBK.settings.chatWidgetId&&(chatInButton=!0)}),chatInButton},updateBtnPositionMobile:function(){if(!w.btn_el.hasClass("ws-chat-no-update-position")&&!parseInt(s.hide_mobile)){var _this=this,ratioScreen=wsUtil.getRatio();s.scallingMobile=1!=ratioScreen;var positionData,position={ratio:ratioScreen,positionX:s.mobile_position_x,positionY:s.mobile_position_y,positionXValue:s.mobile_position_x_value,positionYValue:s.mobile_position_y_value};s.scallingMobile?(w.btn_el.removeClass("envy-not-scalling"),position.el=w.btn_el,positionData=wsUtil.getMobileScalePositionWidget(position),positionData["z-index"]="inherit",w.btn_el.css(positionData),wsUtil.setTimeout("zIndex",function(){w.btn_el.css("z-index",2147483645),parseInt(s.hide_zoom)&&wsUtil.setTimeout("btnElShow",function(){w.btn_el.show()},150)},50)):(w.btn_el.addClass("envy-not-scalling"),positionData=wsUtil.getMobileNotScalePositionWidget(position),w.btn_el.css(positionData),w.btn_el.show()),w.container.addClass(s.mobile_position_x),w.container.addClass(s.mobile_position_y),_this.upInvitationIfNotFit()}},updateOfflineBodySize:function(){s.containerSize=w.window.height();var header_size=w.window.find(".ws-chat-header").height(),body_size=w.window.find(".ws-chat-body-offline").height(),copyright_size=w.window.find(".ws-chat-copyright").height();s.containerSize<header_size+body_size+copyright_size?w.window.addClass("copyright-relative"):w.window.removeClass("copyright-relative")},initWindowPosition:function(){if("pc"==WBK.settings.device){var top_btn=w.btn_el.position().top,left_btn=w.btn_el.position().left,h_window=w.window.outerHeight(),w_window=w.window.width(),h_btn=w.btn.outerHeight(),doc_w=$(window).width(),doc_h=window.innerHeight,ico_left=0;w.window.hasClass("ws-chat-ico-bottom")&&(ico_left=64),left_btn+w_window>doc_w&&(ico_left=0,left_btn=doc_w-w_window),top_btn=top_btn-h_window+h_btn,top_btn<0&&(top_btn=0),left_btn<0&&(left_btn=0),top_btn+h_window>doc_h&&(top_btn=doc_h-h_window),top_btn<0&&(top_btn=0),w.window.css({top:top_btn/(doc_h/100)+"%",left:(left_btn+ico_left)/(doc_w/100)+"%"}),WBK.animateFastOnce(w.window,"cbk-zoomIn")}},updateWindowPosition:function(){var left_window=(w.window.position().top,w.window.position().left),w_window=(w.window.height(),w.window.width()),doc_w=wsUtil.getVisualWidth(),ico_left=(wsUtil.getVisualHeight(),0);w.window.hasClass("ws-chat-ico-bottom")&&(ico_left=64),left_window+w_window+ico_left>doc_w-15&&(left_window=doc_w-w_window-ico_left-15),left_window<0&&(left_window=0),w.window.css({left:(left_window+ico_left)/(doc_w/100)+"%"}),WBK.animateFastOnce(w.window,"cbk-zoomIn")},loadBtnEvents:function(){w.btn.on("click",function(){1==WBK.settings.chatInvitationOpened&&_this.hideInvitation(),_this.showWidget(),_this.sendGoal("open")}),w.invitation.on("click",function(e){return _this.hideInvitation(),$(e.target).hasClass("ws-chat-invitation-close")||$(e.target).hasClass("ws-icon-close")?(WBK.settings.multiButtonId&&(wsMultiButton.hideWidget(),wsMultiButton.reInitWidget()),wsMultiButton.settings.text_tip&&$(".multi_button-main-div-text .multi_button-text").show(),void _this.sendGoal("invitation_close")):(_this.showWidget(),void _this.sendGoal("invitation_click"))})},loadWindowEvents:function(){if(!$.fn._frameCheck()||"undefined"!=typeof WBK)try{$("body").on("click",'a[href="#showchat"], a[href="'+window.top.location.origin+'#showchat"], a[href="'+window.top.location.origin+'/#showchat"]',function(e){return _this.showWidget(),_this.sendGoal("open"),_this.autoSendMessage(this),e.preventDefault(),!1})}catch(error){}if(w.window.find(".ws-chat-close").on("click",function(){"pc"!=WBK.settings.device&&(location.hash=""),_this.hideWidget()}),$(document).on("click",".ws-chat-message-element-file",function(){if(s.chat_created){var data=((new Date).getTime(),{file_name:$(this).data("fileName"),file_name_upload:$(this).data("fileNameUpload"),file_link:$(this).attr("href")});_this.sendRobot({text:"Посетитель скачал файл "+data.file_name+", "+data.file_link,subType:"start_download"})}}),$(document).on("click",".ws-chat-uploaded-el-close",function(){var index=$(this).parent().data("index");index&&(delete s.fileUploaded[index],_this.updateFilesUploaded())}),w.window.find(".ws-chat-sound").on("click",function(){"on"==s.sound?(s.sound="off",w.window.find(".ws-chat-sound").attr("title",s.lang_text.sound_removeClass("ws-icon-sound-on").addClass("ws-icon-sound-off")):(s.sound="on",w.window.find(".ws-chat-sound").attr("title",s.lang_text.sound_off),w.window.find(".ws-chat-sound i").removeClass("ws-icon-sound-off").addClass("ws-icon-sound-on"));var d=new Date;d.setMinutes(d.getMinutes()+43200),wsUtil.setCookie("WidgetChat_sound_"+WBK.settings.chatWidgetId,s.sound,d)}),w.window.find(".ws-textarea").bind("keypress",function(e){var code=e.keyCode||e.which;if(10==code||13==code&&e.ctrlKey){var selection=window.getSelection(),range=selection.getRangeAt(0),br=document.createElement("br"),br2=document.createElement("br");document.createTextNode(" ");range.deleteContents(),range.insertNode(br),3==range.startContainer.nodeType&&range.insertNode(br2),range.collapse(!1)}if(13==code&&!e.shiftKey&&!e.ctrlKey){if("false"===w.window.find(".ws-textarea").attr("contenteditable"))return;e.preventDefault(),_this.sendMessage()&&w.window.find(".ws-textarea-send-btn").hide()}w.window.find(".ws-textarea-group .ws-textarea-placeholder").hide(),_this.deleteInputTextInLocalStorage()}),w.window.find(".ws-textarea").bind("keyup",function(e){var code=e.keyCode||e.which;37!=code&&38!=code&&39!=code&&40!=code&&37!=code&&33!=code&&34!=code&&_this.inputScroll()}),w.window.find(".ws-textarea").bind("keydown",function(e){var code=e.keyCode||e.which;8==code&&_this.inputScroll()}),w.window.find(".ws-textarea").on("paste",function(e){e.preventDefault();var text="";if((e.originalEvent||e.originalEvent.clipboardData.getData("text/plain"))&&(text=e.originalEvent.clipboardData.getData("text/plain")),text)try{text=text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/\n/g,"<br>"),_this.insertHTML(text)}catch(e){}var items=e.clipboardData||e.originalEvent.clipboardData;if(items&&(items=items.items)){for(var image=!1,i=0;i<items.length;i++)0==items[i].type.indexOf("image")&&(image=items[i].getAsFile());if(image){image.name=image=new File([image],image.filename),form=new FormData;form.append("img",file),form.append("type","img"),form.am,"img")}}}),w.window.find(".ws-textarea-send-btn").on("click",function(e){
if(_this.sendMessage()){w.window.find(".ws-textarea-send-btn").hide(),w.window.find(".ws-textarea-group:not(.ws-textarea-group-hide) .ws-textarea-placeholder").show();var form=w.window.find(".ws-textarea");wsUtil.setFocusContentEditable(form[0]),_this.typingPositionUpdate(),_this.deleteInputTextInLocalStorage()}}),$(document).on("click",".ws-chat-message-user .ws-chat-message-name-text",function(){_this.getContactRobot(!0)}),$(document).on("click",".ws-chat-message-robot .ws-chat-message-input",function(){_this.showPreform("preform")}),$(document).on("click",".ws-chat-autoreply-btn",function(){parseInt(s.show_contact_form_inside_chat)&&(_this.addMessageRobot({subType:"lead"}),_this.setPhoneMaskData(".ws-preform-phone")),_this.showPreform("lead",$(this).data("index"),$(this))}),$(document).on("click",".ws-chat-message-manager .ws-chat-message-name-text, .ws-chat-ico .ws-chat-logo",function(){var text=" "+$(this).text()+", ";w.window.find(".ws-textarea").is(":focus")||w.window.find(".ws-textarea").focus(),_this.insertHTML(text)}),w.window.find(".ws-textarea").bind("keyup paste",function(e){var code=e.keyCode||e.which;if(13!=code)if(""!=$(".ws-textarea").html()||8==code){w.window.find(".ws-textarea-send-btn").css("display","flex");var message=_this.cleanMessage($(".ws-textarea"));_this.printing("text",message),wsUtil.setStorage("ws_chat_input_text_"+WBK.settings.chatWidgetId,$(".ws-textarea").html())}else 0==s.fileUploadedCount&&w.window.find(".ws-textarea-send-btn").hide();""===$(".ws-textarea").html()||"<br>"===$(".ws-textarea").html()?(w.window.find(".ws-textarea-group .ws-textarea-placeholder").show(),_this.deleteInputTextInLocalStorage()):w.window.find(".ws-textarea-group .ws-textarea-placeholder").hide()}),w.window.find(".ws-textarea").on("focus",function(){_this.messageReadVisitor()}),w.window.find(".ws-btn-smile, .ws-smile-container").mouseenter(function(){wsUtil.deleteTimeout("hideSmileContainer"),w.window.find(".ws-file-container").hide(),w.window.find(".ws-smile-container").show()}).mouseleave(function(){wsUtil.setTimeout("hideSmileContainer",function(){w.window.find(".ws-smile-container").hide()},300)}),w.window.find(".ws-btn-file, .ws-file-container").mouseenter(function(){wsUtil.deleteTimeout("hideFileContainer"),w.window.find(".ws-smile-container").hide(),w.window.find(".ws-file-container").show()}).mouseleave(function(){wsUtil.setTimeout("hideFileContainer",function(){w.window.find(".ws-file-container").hide()},300)}),$(window).on("resize.ws-chat",function(){if("pc"==WBK.settings.device)wsUtil.setTimeout("resizeChat",function(){WBK.settings.chatWindowOpened?_this.updateWindowPosition():_this.initWindowPosition()},500);else{var inputHeight=w.window.find(".ws-textarea").outerHeight();inputHeight<62&&(inputHeight=62),w.window.find(".ws-chat-body").css("bottom",inputHeight),_this.scroll()}}),$(document).on("click",".ws-chat .ws-chat-message-option-pick-department",function(){var departmentId=$(this).data("value");departmentId&&_this.setDepartment(departmentId,$(this).text())}),"pc"==WBK.settings.device?(w.window.find(".ws-chat-header").on("mousedown",function(e){1!==e.which||$(e.target).hasClass("ws-chat-close")||$(e.target).hasClass("ws-icon-close")||$(e.target).hasClass("ws-chat-sound")||$(e.target).hasClass("ws-icon-sound-on")||$(e.target).hasClass("ws-icon-sound-off")||(w.window.addClass("ws-chat-drag"),s.dragChatObject.elem=w.window,s.dragChatObject.downX=e.pageX,s.dragChatObject.downY=e.pageY)}),$(document).on("mouseup.ws-chat-header",function(e){if(s.dragChatObject.dragStarted){s.dragChatObject.dragStarted=!1;var d=new Date;d.setMinutes(d.getMinutes()+1440);var data=JSON.stringify({top:w.window.css("top"),left:w.window.css("left"),width:w.window.css("width"),height:w.window.css("height")});wsUtil.setCookie("WidgetChat_settings_"+WBK.settings.chatWidgetId,data,d)}w.window.removeClass("ws-chat-drag"),s.dragChatObject={}}),$(document).on("mousemove.ws-chat-header",function(e){if(s.dragChatObject.elem){var moveX=e.pageX-s.dragChatObject.downX,moveY=e.pageY-s.dragChatObject.downY;if(Math.abs(moveX)<3&&Math.abs(moveY)<3)return;s.dragChatObject.dragStarted||(s.dragChatObject.oldPosition={left:s.dragChatObject.elem.position().left||"",top:s.dragChatObject.elem.position().top||""},s.dragChatObject.shiftX=s.dragChatObject.downX-s.dragChatObject.elem.position().left,s.dragChatObject.shiftY=s.dragChatObject.downY-s.dragChatObject.elem.position().top,s.dragChatObject.dragStarted=!0);var pos_left=e.pageX-s.dragChatObject.shiftX,pos_top=e.pageY-s.dragChatObject.shiftY,doc_w=$(window).width(),doc_h=window.innerHeight;pos_top=s.dragChatObject.elem.outerHeight()>doc_h?0:pos_top+s.dragChatObject.elem.outerHeight()>doc_h-10?doc_h-s.dragChatObject.elem.outerHeight():pos_top<10?0:pos_top,pos_left=s.dragChatObject.elem.outerWidth()+pos_left>doc_w?doc_w-s.dragChatObject.elem.outerWidth():pos_left<10?0:pos_left,pos_left<100&&w.window.hasClass("ws-chat-ico-bottom")?w.window.addClass("ws-chat-ico-bottom-right"):w.window.removeClass("ws-chat-ico-bottom-right"),s.dragChatObject.elem.css({left:pos_left+"px",top:pos_top+"px",right:"auto",bottom:"auto"})}}),s.chat_is_online&&(w.window.find(".ws-chat-resize").on("mousedown",function(e){1===e.which&&(s.resizeChatObject.elem=w.window,s.resizeChatObject.elemMinSizeHeight=310+w.window.find(".ws-chat-header").outerHeight()+s.resizeChatObject.elem.find(".ws-chat-footer").outerHeight(),s.resizeChatObject.downX=e.pageX,s.resizeChatObject.downY=e.pageY,w.window.addClass("ws-chat-no-select"))}),$(document).on("mouseup.ws-chat-resize",function(e){if(s.resizeChatObject.dragStarted){s.resizeChatObject.dragStarted=!1;var d=new Date;d.setMinutes(d.getMinutes()+1440);var data=JSON.stringify({top:w.window.css("top"),left:w.window.css("left"),width:w.window.css("width"),height:w.window.css("height")});wsUtil.setCookie("WidgetChat_settings_"+WBK.settings.chatWidgetId,data,d),_this.inputScroll()}s.resizeChatObject={},w.window.removeClass("ws-chat-no-select"),_this.typingPositionUpdate()}),$(document).on("mousemove.ws-chat-resize",function(e){if(s.resizeChatObject.elem){var moveX=e.pageX-s.resizeChatObject.downX,moveY=e.pageY-s.resizeChatObject.downY;if(Math.abs(moveX)<3&&Math.abs(moveY)<3)return;s.resizeChatObject.dragStarted||(s.resizeChatObject.old={width:s.resizeChatObject.elem.outerWidth(),height:s.resizeChatObject.elem.outerHeight(),left:s.resizeChatObject.elem.position().left||"",top:s.resizeChatObject.elem.position().top||""},s.resizeChatObject.shiftX=s.resizeChatObject.downX-s.resizeChatObject.elem.position().left,s.resizeChatObject.shiftY=s.resizeChatObject.downY-s.resizeChatObject.elem.position().top,s.resizeChatObject.dragStarted=!0),s.resizeChatObject.dragStarted=!0;var w_window=e.pageX-s.resizeChatObject.downX,h_window=e.pageY-s.resizeChatObject.downY,doc_w=$(window).width(),doc_h=window.innerHeight,height=s.resizeChatObject.old.height+h_window,width=s.resizeChatObject.old.width+w_window;if(s.resizeChatObject.elem.position().top+height>doc_h){height=doc_h-s.resizeChatObject.elem.position().top}s.resizeChatObject.elem.position().left+width>doc_w&&(width=doc_w-s.resizeChatObject.elem.position().left),_this.contactFormIsVisible()&&(s.resizeChatObject.elemMinSizeHeight=w.window.find(".ws-chat-body-preform").outerHeight()+w.window.find(".ws-chat-header").outerHeight()),w.window.find(".ws-chat-body-offline").is(":visible")&&(s.resizeChatObject.elemMinSizeHeight=w.window.find(".ws-chat-body-offline").outerHeight()+w.window.find(".ws-chat-header").outerHeight()),s.resizeChatObject.elem.css({width:width>338?width:338,height:height>=s.resizeChatObject.elemMinSizeHeight?height:s.resizeChatObject.elemMinSizeHeight}),_this.scroll()}}))):($(window).on("scroll.ws-chat",function(){parseInt(s.hide_zoom)&&(WBK.settings.chatInvitationOpened=!1,w.btn_el.hide()),wsUtil.setTimeout("scrollTimerChat",function(){_this.updateBtnPositionMobile()},250)}),$(window).on("envy:resize",function(){_this.updateBtnPositionMobile(),s.containerSize!=w.window.height()&&_this.updateOfflineBodySize()})),w.window.find(".ws-file-upload").on("change",function(e){e.preventDefault(),w.window.find(".ws-file-container").hide(),_this.uploadFile($(this).data("type"))}),w.window.find(".ws-offline-btn").on("click",function(){_this.sendOfflineMessage()}),w.window.find(".ws-preform-btn-cancel").on("click",function(){_this.hidePreform()}),$(document).on("click",".ws-preform-btn-save",function(){s.auth_type="default",_this.savePreform($(this).data("type"),$(this).data("index"),$(this))}),$(document).on("click",".ws-chat-social-vk",function(){var swidth=675,sheight=380,left=(screen.width-swidth)/2,top=(screen.height-sheight)/4;open(WBK.settings.serverUrl+"/chat/aht+", top="+top+", left="+left+",resizable=yes,scrollbars=yes,status=yes")}),$(document).on("click",".ws-chat-social-fb",function(){var swidth=675,sheight=380,left=(screen.width-swidth)/2,top=(screen.height-sheight)/4;open(WBK.settings.serverUrl+"/chat/auth_fb/?origin="+window.location.origin,"publish","width="+swidth+",height="+sheight+", top="+top+", left="+left+",resizable=yes,scrollbars=yes,status=yes")}),$(window).on("message",function(data){var data=data.originalEvent.data;if(data)switch(data.type){case"vk_auth":_this.vkAuth(data);break;case"fb_auth":_this.fbAuth(data)}}),w.window.find(".ws-preform-input").bind("keypress",function(e){var code=e.keyCode||e.which;13==code&&(e.preventDefault(),_this.savePreform($(".ws-preform-btn-save").data("type"),$(this).data("index")))}),$.fn._frameCheck()||s.invitations&&Object.keys(s.invitations).length>0&&(_t=this,Object.keys(s.invitations).map(function(key,index){var v=s.invitations[key];try{$("body").on("click.invitations",'a[href="#autoinvitation-'+v.name.replace(/\s+/g,"-")+'"], a[href="'+window.top.location.origin+"#autoinvitation"+v.name.replace(/\s+/g,"-")+'"], a[href="'+window.top.location.origin+"/#autoinvitation"+v.name.replace(/\s+/g,"-")+'"]',function(e){var invitatiton=$(e.currentTarget).attr("href").replace(new RegExp(window.top.location.origin+"|/|#autoinvitation|-+","g")," ").trim();return _t.showInvitationByName(invitatiton),e.preventDefault(),!1})}catch(e){}})),WBK.settings.phoneMasks){var listRU=$.masksSort(WBK.settings.phoneMasks,["#"],/[0-9]|#/,"mask"),optsRU={inputmask:{definitions:{"#":{validator:"[0-9]",cardinality:1}},clearIncomplete:!1,showMaskOnHover:!1,autoUnmask:!0},match:/[0-9]/,replace:"#",list:listRU,listKey:"mask",onMaskChange:function(){$(this).attr("placeholder",$(this).inputmask("getemptymask"))}};_this.optsRU=optsRU,_this.setPhoneMaskData(".ws-offline-phone"),_this.setPhoneMaskData(".ws-preform-phone"),s.useTelephonyMask||_this.initDialCodeSelectors(),optsRU.inputmask.definitions.clearIncomplete=!0,$(".cbk-phone-checker").inputmasks(optsRU)}},initDialCodeSelectors:function(){w.wsDCPI=wsUtil.getOrInitDialCodesPhoneInput(),w.wsDCPI.renderOnInput(".ws-offline-phone","offlinePhone",null,!0),w.wsDCPI.renderOnInput(".ws-preform-phone","preformPhone",null,!0)},getActualPhoneWithCountryCode:function(phone,inputKey){var countryData=w.wsDCPI.getSelectedCountryByInputKey(inputKey);return countryData&&countryData.code&&(phone="+"+countryData.code+phone),phone},setPhoneMaskData:function(selector){s.useTelephonyMask?$(selector).inputmasks(_this.optsRU):$(selector).attr("placeholder",s.lang_text.phone_input_placeholder_text)},deleteInputTextInLocalStorage:function(){wsUtil.deleteStorage("ws_chat_input_text_"+WBK.settings.chatWidgetId)},vkAuth:function(info){s.visitor_vk_id=info.user_id,info.access_token&&$.ajax({url:"https://api.vk.com/method/users.get?user_ids="+info.user_id+"&fields=photo_100&lang=ru&v=5.81&access_token="+info.access_token,type:"GET",dataType:"jsonp",crossDomain:!0,success:function(data){w.window.find(".ws-preform-name").val(data.response[0].first_name+" "+data.response[0].last_name),info.email&&w.window.find(".ws-preform-email").val(info.email),data.response[0].photo_100&&(s.logo_visitor=data.response[0].photo_100),s.auth_type="vk",_this.savePreform($(".ws-preform-btn-save").data("type"),$(".ws-preform-btn-save").data("index"),$(".ws-preform-btn-save"))}})},fbAuth:function(info){s.visitor_fb_token=info.access_token,$.ajax({url:"https://graph.facebook.com/me?fields=id,email,first_name,last_name,picture.width(100).height(100)&access_token="+info.access_token,type:"GET",dataType:"jsonp",crossDomain:!0,success:function(data){s.visitor_fb_id=data.id,w.window.find(".ws-preform-name").val(data.first_name+" "+data.last_name),data.email&&w.window.find(".ws-preform-email").val(data.email),data.picture.data.url&&(s.logo_visitor=data.picture.data.url),s.auth_type="fb",_this.savePreform($(".ws-preform-btn-save").data("type"),$(".ws-preform-btn-save").data("index"),$(".ws-preform-btn-save"))}})},updateUser:function(sendFire){s.user_name=WBK.settings.visitorName?WBK.settings.visitorName:"",s.user_email=WBK.settings.visitorEmail?WBK.settings.visitorEmail:"",s.user_phone=WBK.settings.visitorPhone?WBK.settings.visitorPhone:"";var visitorKey="visitor";if(s.chatKey&&s.fireChat[visitorKey]){visitorKey=s.fireChat[visitorKey];var data={visitUrl:window.location.href};_this.updateUserInBase(visitorKey,data)}else s.fireUsers[visitorKey]={};if(s.fireUsers[visitorKey].name=s.user_name,s.fireUsers[visitorKey].role="visitor",s.fireUsers[visitorKey].photo=s.logo_visitor||s.default_logo_visitor,sendFire){var timer=1e3;s.chat_created&&(timer=0),wsUtil.setInterval("visitorIntroduction",function(e){if(s.chat_created){wsUtil.deleteInterval("visitorIntroduction"),visitorKey=s.visitorKey||visitorKey,s.fireUsers[visitorKey].name=s.user_name,s.fireUsers[visitorKey].photo=s.logo_visitor||s.default_logo_visitor,w.window.find(".ws-chat-message-user").find(".ws-chat-message-name-text").text(s.user_name),w.window.find(".ws-chat-message-user").find(".ws-chat-message-logo-img").attr("src",s.fireUsers[visitorKey].photo);var social=s.visitor_vk_id?"vk":s.visitor_fb_id?"fb":"",socialId=s.visitor_vk_id||s.visitor_fb_id||"",socialData=_this.getSocialParams(social,socialId);if(_this.sendRobot({subType:"introduction",attributes:{email:s.user_email,name:s.user_name,phone:s.user_phone,url:socialData.url,icon:socialData.icon}}),s.user_name||s.fireUsers[visitorKey].photo){var data={};s.user_name&&(data.name=s.user_name),s.fireUsers[visitorKey].photo&&s.default_logo_visitor!=s.fireUsers[visitorKey].photo&&(data.photo=s.fireUsers[visitorKey].photo),s.user_email&&(data.hasEmail=!0),_this.updateUserInBase(visitorKey,data),s.user_email&&(data.email=s.user_email),s.user_phone&&(data.phone=s.user_phone),_this.updateVisitor(data)}}},timer)}},getSocialParams:function(type,id){var data={url:"",icon:""};switch(type){case"vk":data.url="http://vk.com/id"+id,data.icon="http://vk.com/images/safari_60.png";break;case"fb":data.url="http://facebook.com/"+id,data.icon="https://www.facebook.com/rsrc.php/yl/r/H3nktOa7ZMg.ico"}return data},operatorsIsOnline:function(){var result=!1;return s.operators_online_keys=[],s.operators_connect={},s.operators_connect_online_ids=[],s.all_operators&&$.each(s.all_operators,function(index,value){value.apiId&&(s.operators_connect[WBK.settings.accountid+"_"+value.apiId]=index),s.all_operators[index].online&&"operator"===s.all_operators[index].role&&(s.operators_online_keys.push(index),s.operators_connect_online_ids.push(WBK.settings.accountid+"_"+value.apiId),result=!0)}),_debug&&_this.log("Операторы онлайн: "+result),result},checkWorkDays:function(){var result=!1;if(!parseInt(s.workdays_active))return!0;var timezone=wsUtil.timezoneFormat(s.timezone),timeServer=wsUtil.getTimeByServerTimezone(timezone),currentDay=timeServer.getDay();if(currentDay=0==currentDay?7:currentDay,!parseInt(s["workdays_"+currentDay]))return result;var timeStartTimeArr=s["workdays_"+currentDay+"_time_start"].split(":"),timeEndTimeArr=s["workdays_"+currentDay+"_time_end"].split(":"),timeStart=new Date(timeServer.getTime()).setHours(timeStartTimeArr[0],timeStartTimeArr[1]),timeEnd=new Date(timeServer.getTime()).setHours(timeEndTimeArr[0],timeEndTimeArr[1]);return timeServer>timeStart&&timeServer<timeEnd&&(result=!0),result},getStatusText:function(status){var text="";switch(status){case"sent":text=s.lang_text.is_send;break;case"delivered":text=s.lang_text.is_received;break;case"read":text=s.lang_text.is_read}return text},appendMessage:function(data,params){if(!s.fireMessages.hasOwnProperty(data.key)){data.key&&(s.fireMessages[data.key]=data),data=$.extend({},data);var author=s.fireUsers[data.sender];if("system"==data.type&&"robot"==author.role)return void this.addMessageRobot(data,params);var mess_block_class="",status=this.getStatusText(data.status),message_status_block="",date=_this.dateFormat(data.sentAt);switch(data.type){case"crm":case"invitation":return!1;case"text":if(s.messages_quant_to_rate++,data.text=this.cleanTextToHtml(data.text),data.text=this.smileReplacer(data.text,"to_img"),"read"!==data.status&&data.buttons){var quick_message="";$(".ws-chat-quick-messages").removeClass("ws-hide");for(btn in data.buttons)quick_message+='<div class="ws-chat-quick-message">'+data.buttons[btn].text+"</div>";quick_message='<div class="ws-chat-quick-messages-group">'+quick_message+"</div>",$(".ws-chat-quick-messages").html(quick_message),this.startListenEventOnClickQuickMessages(),s.showed_quick_messages=!0,s.show_quick_message=!0}break;case"joined":case"left":var message=s.lang_text.join_chat;"left"==data.type&&(message=s.lang_text.disconnect_from_chat),date.date_line&&w.window.find(".ws-chat-typing").before('<div class="ws-chat-date-block">'+date.date_line+"</div>");var join_block='<div class="ws-chat-manager-join"><img src="'+author.photo+'" alt="" class="ws-manager-img"><div class="ws-manager-name">'+author.name+'</div><div class="ws-manager-position">'+(author.position||"")+'</div><div class="ws-manager-event">'+message+"</div></div>";return w.window.find(".ws-chat-typing").before(join_block),s.is_first_message&&(s.chat_distribution_department_enabled&&(s.chat_distribution_department_picked=_this.getIdDepartmentByIdEmployee(s.fireUsers[author.key].apiId),w.container.find(".ws-chat-departments-block").addClass("ws-hide")),s.showed_quick_messages&&w.window.find(".ws-chat-quick-messages").hide(),s.invitation_show_data&&w.window.find(".ws-chat-message-manager").hide(),_this.typingPositionUpdate()),!1;case"image":s.messages_quant_to_rate++,data.text='<a class="ws-chat-message-element"  href="'+data.url+'" target="_blank"><img class="ws-chat-message-img" src="'+data.preview+'"><div class="ws-foto-hover"></div><div class="ws-foto-hover-img"></div></a>';break;case"file":s.messages_quant_to_rate++;var file='<div class="ws-file-block"><div class="ws-file-el"><img class="ws-icon-file" src="'+data.icon+'"> </div><div class="ws-file-name">'+data.filename+'</div><div class="ws-file-size">'+this.getSize(data.size)+'</div></div><div class="ws-file-hover"></div>';data.text='<a class="ws-chat-message-element ws-chat-message-element-file" data-file-name="'+data.filename+'" data-file-name-upload="'+data.filename+'" href="'+data.url+'" target="_blank">'+file+"</a>";break;case"system":if("auto_reply"!=data.subType)return;if(data.hasOwnProperty("key")&&(WBK.settings.visitorName||WBK.settings.visitorPhone||WBK.settings.visitorEmail))return;if(data.text=wsUtil.specialChars(data.text),params&&params.auto_reply_get_contact){if(!parseInt(s.show_contact_form_inside_chat)){var text_btn=s.autoreplies[params.auto_reply_index].text_btn?s.autoreplies[params.auto_reply_index].text_btn:s.lang_text.autoreply_link;data.text=data.text+'<br><div class="ws-chat-autoreply-link"><a data-index="'+params.auto_reply_index+'" class="ws-chat-autoreply-btn" href="javascript:void(0)">'+text_btn+"</a></div>"}var cookieDate=new Date;cookieDate.setMinutes(cookieDate.getMinutes()+43200),wsUtil.setCookie("WidgetChat_autoreply_getcontact_"+WBK.settings.chatId,!0,cookieDate)}}var messageSendingTime=s.fireMessages.hasOwnProperty(data.key)&&s.fireMessages[data.key].hasOwnProperty("sentAt")?s.fireMessages[data.key].sentAt:Date.now(),message='<div id="'+data.key+'" data-sent-at="'+messageSendingTime+'" class="ws-chat-message"><div class="ws-chat-message-source">'+data.text+'</div><div class="ws-chat-message-date">'+date.time+"</div></div>",last_block=w.window.find(".ws-chat-body-content").children(":not(.ws-chat-typing,.ws-chat-uploaded-files,.ws-chat-quick-messages)").last();(last_block.hasClass("ws-chat-robot-hello")|,"10px");var last_user_this=last_block.data("role")==author.rolmessage-status">'+status+"</div>",author.name=author.name?author.name:s.lang_text.default_user;break;default:mess_block_class="ws-chat-message-manager",last_user_this=last_user_this&&last_block.data("user")==data.sender,s.last_operator_data={user_key:data.sender},s.send_autoreply=!0}if(!date.new_block&&last_block.hasClass(mess_block_class)&&last_user_this){for(var numberOfMessages=last_block.find(".ws-chat-message").length,i=numberOfMessages;i>0;i--){var $currentMessage=last_block.find(".ws-chat-message").eq(i-1),messageDataAttributes=$currentMessage.data();if(messageDataAttributes.hasOwnProperty("sentAt")){if(!(data.key&&s.fireMessages[data.key]&&messageDataAttributes.sentAt>s.fireMessages[data.key].sentAt)){$currentMessage.after(message);break}if(1===i){$currentMessage.before(message);break}}}last_block.find(".ws-chat-message-date").hide(),last_block.find(".ws-chat-message-date:last").show(),last_block.find(".ws-chat-message-status").text(status).addClass("ws-chat-message-status")}else{var new_block='<div class="ws-chat-message-block '+mess_block_class+'" data-role="'+author.role+'" data-user="'+data.sender+'"><div class="ws-chat-message-logo"><img class="ws-chat-message-logo-img" src="'+author.photo+'"></div><div class="ws-chat-message-name"><span class="ws-chat-message-name-text">'+author.name+"</span></div>"+message+message_status_block+"</div>";w.window.find(".ws-chat-typing").before(new_block)}params&&params.hasOwnProperty("scroll")&&params.scroll&&_this.scroll()}},getIdDepartmentByIdEmployee:function(idEmployee){var departments=s.chat_department_distribution.filter(function(department){return Object.keys(department.employees).indexOf(this.toString())!==-1},idEmployee);return departments.length?departments[0].id:null},getSize:function(size){var result="";return size<0?"":result=size/1024>1024?(size/1024/1024).toFixed(1)+" Mb":(size/1024).toFixed(1)+" Kb"},playSound:function(type){if("off"!=s.sound){var file="";switch(type){case"message":file="chat1";break;case"send_message":break;case"operator_join":file="chat1"}WBK.Sound(file)}},typing:function(userKey,time){var _this=this;void 0==time&&(time=5e3);var user=!!s.fireUsers.hasOwnProperty(userKey)&&s.fireUsers[userKey];if(user){var operator_name=user.name?user.name:s.lang_text.operator;w.window.find(".ws-chat-typing").find(".ws-manager-name").text(operator_name),_this.typingPositionUpdate(),w.window.find(".ws-chat-typing").removeClass("ws-chat-typing-removing"),wsUtil.setTimeout("chatTypingActivateTimeout",function(){w.window.find(".ws-chat-typing").addClass("ws-chat-typing-active")},300);var timeToShow=time;wsUtil.setTimeout("chatTypingTimeout",function(){w.window.find(".ws-chat-typing").removeClass("ws-chat-typing-active").addClass("ws-chat-typing-removing")},timeToShow)}},calculationBodyHeight:function(iOS){return iOS?$(window).height()-$(".ws-chat-copyright").outerHeight()-$(".ws-chat-footer").outerHeight()-$(".ws-chat-header").outerHeight()-$(".ws-chat-quick-message").outerHeight():w.window.find(".ws-chat-body-content").heigquick_messagh_child=$(e).outerWidth(),margin_right_child=parseInt($(e).css("margin-right"));quick_messages.push({width:width_child,height:$(e).innerHeight(),margin_right:margin_right_child}),width_quick_messages+=width_child>0?width_child+margin_right_child:0}),quick_messages.length>0&&(width_quick_messages-=quick_messages[quick_messages.length-1].margin_right);var width_chat_body=$(window).width()-parseInt(w.window.find(".ws-chat-body-content").css("padding-right"))+parseInt(w.window.find(".ws-chat-body-content").css("padding-left")),row_quick_messages=1;if(width_quick_messages>width_chat_body&&(row_quick_messages+=1,quick_messages.length>2&&quick_messages[0].width+quick_messages[1].width>width_chat_body&&quick_messages[1].width+quick_messages[2].width>width_chat_body&&(row_quick_messages+=1)),s.invitation_show_data&&!s.chat_distribution_department_enabled||s.invitation_show_data&&s.chat_distribution_department_enabled&&!s.chat_distribution_department_picked)switch(row_quick_messages){case 1:return marginTop;case 2:return s.invitation_show_data&&(marginTop-=2*quick_messages[0].height),marginTop;case 3:return marginTop-3*quick_messages[0].height}else{if(s.invitation_show_data&&s.chat_distribution_department_picked||s.chat_distribution_department_enabled&&s.chat_distribution_department_picked)return quick_messages.length>0&&(marginTop+=quick_messages[0].height),marginTop;switch(row_quick_messages){case 1:return quick_messages.length>0&&s.invitation_show_data&&(marginTop+=quick_messages[0].height),marginTop;case 2:return marginTop-quick_messages[0].height;case 3:return marginTop-2*quick_messages[0].height}}},typingPositionUpdate:function(){var iOS=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!w.window.MSStream,bodyHeight=_this.calculationBodyHeight(iOS),afterHeight=0,beforeHeight=w.window.find(".ws-chat-typing").outerHeight()+w.window.find(".ws-chat-uploaded-files").outerHeight();w.window.find(".ws-chat-body-content").children(":not(.ws-chat-typing,.ws-chat-uploaded-files)").each(function(i,e){if(afterHeight+=$(e).outerHeight(),bodyHeight<afterHeight)return!1});var outHeight=bodyHeight-afterHeight-6,marginTop=0;outHeight>beforeHeight&&(marginTop=outHeight-beforeHeight,s.quick_messages&&!s.sent_quick_messages&&iOS&&(marginTop=_this.calculationMarginTop(marginTop))),w.window.find(".ws-chat-typing").css("marginTop",marginTop)},operatorClosed:function(){w.window.removeClass("ws-chat-ico-bottom"),w.window.find(".ws-chat-ico-container").empty(),s.chat_created=!1},getTimeClosedChat:function(){return wsUtil.getStorage("ws_time_closed_chat")},updateTimeClosedChat:function(){wsUtil.setStorage("ws_time_closed_chat",(new Date).getTime())},onCloseChat:function(){_this.operatorClosed(),_this.stopAutoReply("all"),_this.updateTimeClosedChat()},onOperatorPrinting:function(userKey){jWS.isEmptyObject(s.autoreplies)||_this.stopAutoReply("all"),_this.typing(userKey),jWS.isEmptyObject(s.autoreplies)||_this.stopAutoReply("not_answer_operator")},onVisitorMessage:function(data){s.fireMessages.hasOwnProperty(data.key)||s.fireMessages.hasOwnProperty(data.localKey)||_this.appendMessage(data,{scroll:scroll})},onOperatorMessage:function(data){if(!s.fireMessages.hasOwnProperty(data.key)){if("joined"==data.type)return void this.operatorJoin(data);if("left"==data.type)return void this.operatorExit(data);s.last_operator_data={user_key:data.sender},wsUtil.deleteTimeout("chatTypingTimeout"),w.window.find(".ws-chat-typing").removeClass("ws-chat-typing-active").addClass("ws-chat-typing-removing");var scroll=!1;WBK.settings.chatWindowOpened&&(scroll=!0),_this.appendMessage(data,{scroll:scroll}),_this.playSound("message"),s.unread_messages_count+=1,s.unread_messages.push(data.key),w.window.find(".ws-textarea").is(":focus")?_this.messageReadVisitor():_this.setUnreadMessages(s.unread_messages_count),WBK.settings.chatWindowOpened||WBK.settings.windowOpened||WBK.settings.windowGeneratorOpened||WBK.settings.videoWidgetOpened||WBK.settings.windowQuizOpened||"pc"!=WBK.settings.device||_this.showWidget(),s.send_autoreply=!0,jWS.isEmptyObject(s.autoreplies)||_this.stopAutoReply("not_answer_operator"),this.checkRatingSettings()}},operatorJoin:function(data){s.last_operator_data={user_key:data.sender},jWS.isEmptyObject(s.autoreplies)||_this.stopAutoReply("not_connected"),data.sender!=s.invitation_operator_key?(_this.appendMessage(data),_this.playSound("operator_join")):s.invitation_operator_key=!1,_this.operatorsUpdate(),s.send_autoreply=!0,s.send_autoreply_first=!1,_this.getAutoReply(),_this.scroll(),_this.sendGoal("operator_connect")},operatorExit:function(data){_this.appendMessage(data),w.window.find(".ws-chat-typing").removeClass("ws-chat-typing-active").addClass("ws-chat-typing-removing"),_this.operatorsUpdate(),_this.scroll(),jWS.isEmptyObject(s.autoreplies)||_this.stopAutoReply("all")},onUpdateRegistrationId:function(data){},setTemplate:function(){var btn='<div class="ws-chat-btn-el-container envy-not-scalling"><div class="ws-chat-btn-container ws-chat-btn-mini-hover"><div class="ws-btn-badge"></div><div class="ws-btn-ico"><div class="ws-chat-logo"><i class="ws-icon-chat" style="color: '+s.color_background_button+'"></i><img src="'+s.chat_widget_logo+'" class="ws-chat-logo-img"><div class="ws-chat-status-round ws-chat-status-online"></div></div></div><div class="ws-btn-title"></div></div><div class="ws-chat-invitation-container"><div class="ws-chat-invitation-close"><i class="ws-icon-close"></i></div><div class="ws-chat-invitation-body"><div class="ws-chat-invitation-logo"></div><div class="ws-chat-invitation-body-el"><div class="ws-chat-invitation-body-text"></div></div></div><div class="ws-chat-invitation-form"><input type="text" class="ws-chat-invitation-input" placeholder="'+s.lang_text.form_message_placeholder+'"></div></div></div>';if("pc"!=WBK.settings.device)var btn='<div class="ws-chat-btn-el-container envy-not-scalling"><div class="ws-chat-btn-container ws-chat-btn-mini-hover"><div class="ws-btn-badge"></div><div class="ws-btn-ico"><div class="ws-chat-logo"><i class="ws-icon-chat" style="color: '+s.mobile_color_background_button+'"></i><img src="'+s.chat_widget_logo+'" class="ws-chat-logo-img"><div class="ws-chat-status-round ws-chat-status-online"></div></div></div></div><div class="ws-chat-invitation-container"><div class="ws-chat-invitation-input">'+s.lang_text.form_message_placeholder+'</div><div class="ws-chat-invitation-close"><i class="ws-icon-close"></i></div><div class="ws-chat-invitation-body"><div class="ws-chat-invitation-logo"></div><div class="ws-chat-invitation-body-el"><div class="ws-chat-invitation-body-text"></div></div></div></div></div>';s.text_button_online=this.safe_tags(s.text_button_online),t='<div class="ws-chat"><div class="ws-chat-container ws-chat-round"><div class="ws-chat-header" style="background: '+s.color_background_chat_header+'"><div class="ws-chat-logo"><i class="ws-icon-chat"></i><img src="'+s.chat_widget_logo+'" class="ws-chat-logo-img"><div class="ws-chat-status-round ws-chat-status-online"></div></div><div class="ws-chat-title" style="color: '+s.color_background_chat_header_text+'">'+s.text_button_online+'</div><a class="ws-chat-close" style="color: '+s.color_background_chat_header_text+'" href="javascript:void(0)" title="'+s.lang_text.close_title+'"><i class="ws-icon-close" style="color: '+s.color_background_chat_header_text+'"></i></a><a class="ws-chat-sound" style="color: '+s.color_background_chat_header_text+'" href="javascript:void(0)" title="'+s.lang_text.sound_off+'"><i class="ws-icon-sound-on" style="color: '+s.color_background_chat_header_text+'"></i></a></div><div class="ws-chat-body"><div class="ws-chat-rating">'+s.lang_text.rate_request+'<div class="ws-chat-rating-btns ws-chat-rating-btns-'+s.rate_chat_view+'"><a class="ws-chat-rating-el ws-chat-rating-el-1" href="javascript:void(0)" data-value="1" title="'+s.lang_text.rate_text_1+'"><img src="'+WBK.settings.staticServerUrl+'/widget/img/blank.gif" alt=""></a><a class="ws-chat-rating-el ws-chat-rating-el-2" href="javascript:void(0)" data-value="2" title="'+s.lang_text.rate_text_2+'"><img src="'+WBK.settings.staticServerUrl+'/widget/img/blank.gif" alt=""></a><a class="ws-chat-rating-el ws-chat-rating-el-3" href="javascript:void(0)" data-value="3" title="'+s.lang_text.rate_text_3+'"><img src="'+WBK.settings.staticServerUrl+'/widget/img/blank.gif" alt=""></a><a class="ws-chat-rating-el ws-chat-rating-el-4" href="javascript:void(0)" data-value="4" title="'+s.lang_text.rate_text_4+'"><img src="'+WBK.settings.staticServerUrl+'/widget/img/blank.gif" alt=""></a><a class="ws-chat-rating-el ws-chat-rating-el-5" href="javascript:void(0)" data-value="5" title="'+s.lang_text.rate_text_5+'"><img src="'+WBK.settings.staticServerUrl+'/widget/img/blank.gif" alt=""></a></div></div><div class="ws-chat-shadow"></div><div class="ws-chat-body-content"><div class="ws-chat-typing"><span class="ws-chat-typing-action"><i class="ws-icon-typing"></i></span><span class="ws-manager-name"></span> '+s.lang_text.typing+'...</div><div class="ws-chat-uploaded-files"></div><div class="ws-chat-quick-messages ws-hide"><div class="ws-chat-quick-messages-group"></div></div></div></div><div class="ws-chat-body-offline" style="display: none"><div class="ws-chat-offline-text">'+s.offline_text+'</div><div class="ws-chat-offline-text-success">'+s.lang_text.offline_text_success+'</div><div class="ws-offline-input-group '+("hide"==s.get_contact_offline_name?"ws-hide":"")+'"><div class="ws-offline-input-label">'+s.lang_text.form_name+'<span class="ws-input-required">'+("yes"==s.get_contact_offline_name?" *":"")+'</span></div><input type="text" class="ws-offline-input ws-offline-name" placeholder="'+s.lang_text.form_name_placeholder+'" value="'+s.user_name+'"></div><div class="ws-offline-input-group '+("hide"==s.get_contact_offline_phone?"ws-hide":"")+'"><div class="ws-offline-input-label">'+s.lang_text.form_phone+'<span class="ws-input-required">'+("yes"==s.get_contact_offline_phone?" *":"")+'</span></div><input type="tel" class="ws-offline-input ws-offline-phone" placeholder="'+s.lang_text.form_phone_placeholder+'" value="'+WBK.formatToPhone(s.user_phone)+'"></div><div class="ws-offline-input-group '+("hide"==s.get_contact_offline_email?"ws-hide":"")+'"><div class="ws-offline-input-label">'+s.lang_text.form_email+'<span class="ws-input-required">'+("yes"==s.get_contact_offline_email?" *":"")+'</span></div><input type="email" class="ws-offline-input ws-offline-email" placeholder="'+s.lang_text.form_email_placeholder+'" value="'+s.user_email+'"></div><div class="ws-offline-input-group'+(parseInt(s.email_distribution_agreement)?"":" ws-hide")+'"><label class="ws-offline-label-agreement"><input type="checkbox" class="ws-offline-email-agreement offline-email-distribution-agreement"><span class="ws-offline-email-agreement-text">'+s.email_text_distribution_agreement+'</span></label></div><div class="ws-offline-input-group"><div class="ws-offline-input-label">'+s.lang_text.form_message_placeholder+'<span class="ws-input-required">'+("yes"==s.get_contact_offline_message?" *":"")+'</span></div><div contenteditable="true" class="ws-offline-textarea"></div><div class="ws-offline-textarea-element"><a class="ws-offline-textarea-btn ws-btn-smile" href="javascript:void(0)"><i class="ws-icon-smile"></i></a><div class="ws-smile-container ws-smile-container-offline"></div></div></div><div class="ws-offline-input-group'+(parseInt(s.email_agreement)?"":" ws-hide")+'"><label class="ws-offline-label-agreement"><input type="checkbox" class="ws-offline-email-agreement" checked><span class="ws-offline-email-agreement-text">'+s.email_agreement_text+s.lang_text.email_agreement_text_agreement+'</span></label></div><div class="ws-offline-input-group ws-offline-input-group-btn"><a href="javascript:void(0)" class="ws-offline-btn">'+s.lang_text.offline_btn+'</a></div></div><div class="ws-chat-body-preform" style="display: none"><div class="ws-chat-preform-text"></div><div class="ws-chat-preform-social"><a href="javascript:void(0)" class="ws-chat-social-el ws-chat-social-vk"><span class="ws-chat-social-img ws-sprite-social-vk"></span></a></div><div class="ws-preform-input-group"><div class="ws-preform-input-label"></div><input type="text" class="ws-preform-input ws-preform-name" placeholder="'+s.lang_text.form_name_placeholder+'" value="'+s.user_name+'"></div><div class="ws-preform-input-group"><div class="ws-preform-input-label"></div><input type="tel" class="ws-preform-input ws-preform-phone" placeholder="'+s.lang_text.form_phone_placeholder+'" value="'+WBK.formatToPhone(s.user_phone)+'"><input type="text" class="cbk-phone-checker white-saas-generator-input-hidden"/></div><div class="ws-preform-input-group"><div class="ws-preform-input-label"></div><input type="email" class="ws-preform-input ws-preform-email" placeholder="'+s.lang_text.form_email_placeholder+'" value="'+s.user_email+'"></div><div class="ws-preform-input-group ws-preform-input-group-text"><div class="ws-preform-input-label ws-preform-email-text">'+s.lang_text.email_exit+'</div></div><div class="ws-preform-input-group'+(parseInt(s.email_distribution_agreement)?"":" ws-hide")+'"><label class="ws-preform-label-agreement"><input type="checkbox" class="ws-preform-email-distribution-agreement preform-email-distribution-agreement"><span class="ws-preform-email-distribution-agreement-text">'+s.email_text_distribution_agreement+'</span></label></div><div class="ws-preform-input-group ws-preform-input-group-text"><label class="ws-preform-label-agreement"><span class="ws-preform-email-agreement-text">'+s.email_agreement_text+s.lang_text.email_agreement_text_agreement+'</span></label></div><div class="ws-preform-input-group ws-preform-input-group-btn"><a href="javascript:void(0)" class="ws-preform-btn-cancel">'+s.lang_text.offline_btn_cancel+'</a><a href="javascript:void(0)" class="ws-preform-btn ws-preform-btn-save">'+s.lang_text.preform_btn+'</a></div></div><div class="ws-chat-footer"><div class="ws-textarea-element"><a class="ws-textarea-btn ws-btn-file" href="javascript:void(0)"><i class="ws-icon-file"></i></a><a class="ws-textarea-btn ws-btn-smile" href="javascript:void(0)"><i class="ws-icon-smile"></i></a><div class="ws-smile-container"></div><div class="ws-file-container"><div class="ws-file-element ws-file-doc"><i class="ws-icon-document"></i>'+s.lang_text.file+'<input type="file" class="ws-file-upload ws-file-doc-upload" title="'+s.lang_text.not_selected_file_text+'" name="ws-doc" data-type="doc" accept="'+s.allow_mime_file+'"></div><div class="ws-file-element ws-file-foto"><i class="ws-icon-image"></i>'+s.lang_text.image+'<input type="file" class="ws-file-upload ws-file-img-upload" title="'+s.lang_text.not_selected_file_text+'" name="ws-img" data-type="img" accept="'+s.allow_mime_img+'"></div></div></div><div class="ws-textarea-group"><div contenteditable="true" class="ws-textarea"></div><div class="ws-textarea-send-btn"  title="'+s.lang_text.send_btn_title+'"><i class="ws-icon-enter"></i></div><div class="ws-textarea-placeholder">'+s.lang_text.textarea_placeholder+'</div></div></div><div class="ws-chat-copyright"><a href="'+s.partnerLiext.text_l'"><i class="ws-icon-resize"></i></div><div class="ws-chat-ico-container"></div></div>'+btn+"</div>";
},setSettings:function(settings){var defaultSettings={printingData:{type:"text",message:""},firebase:!1,fireDB:!1,firebaseNodeUrl:"",FirebaseApiKey:"",FirebaseAuthDomain:"",FirebaseDatabaseURL:"",FirebaseServiceRef:"",socketStarted:!1,v2_local:!1,chatKey:!1,chatKeyVisitor:!1,processVisitor:!1,fireChat:!1,fireUsers:{},fireUserKeys:[],fireOldMessages:{},fireMessages:{},fireSender:"visitor",fireRobot:{},visitorKey:!1,fireOperatorPrinting:{},dragChatObject:{},resizeChatObject:{},chat_created:!1,chat_old_time:!1,chat_timezone:3,unread_messages:[],unread_messages_count:0,document_title:document.title,document_favicon_href:$('link[rel="shortcut icon"]').length?$('link[rel="shortcut icon"]').attr("href"):$('link[rel="icon"]').attr("href"),new_favicon_href:"",input_scroll:!1,auth_type:"default",default_logo_visitor:WBK.settings.staticServerUrl+"/widget/img/user.png",agreementLink:"https://whitesaas.com/agreement/",logo_visitor:!1,is_first_message:!1,first_message:!1,bottom_body:62,height_input:56,allow_mime_file:".pdf,.txt,.doc,.docx,.xls,.xlsm,.rar,.zip",allow_mime_img:"image/png,image/jpg,image/jpeg,image/gif",invitation_show_data:!1,invitation_operator_id:!1,last_operator_data:!1,send_autoreply:!1,send_autoreply_first:!1,show_one_invitation:!1,show_quick_message:!1,showed_quick_messages:!1,sent_quick_messages:!1,on_event:{emodji:!1},fileUploaded:{},fileUploadedCount:0,chatCreating:!1,scallingMobile:!1,offline_message_sending:!1,scroll_left:0,scroll_top:0,containerSize:0,show_contact_form_inside_chat:0,use_telephony_mask:1,autoCall:0,autoCallText:"0",autoCallDeffered:0,autoCallDefferedDelay:0,disableMobileOpenHash:0,smilesCodes:{"1f601":"😁","1f602":"😂","1f603":"😃","1f604":"😄","1f605":"😅","1f606":"😆","1f609":"😉","1f60a":"😊","1f60b":"😋","1f60c":"😌","1f60d":"😍","1f60f":"😏","1f612":"😒","1f613":"😓","1f614":"😔","1f616":"😖","1f618":"😘","1f61a":"😚","1f61c":"😜","1f61d":"😝","1f61e":"😞","1f620":"😠","1f621":"😡","1f622":"😢","1f623":"😣","1f624":"😤","1f625":"😥","1f628":"😨","1f629":"😩","1f"1f60e":"😎","1f44c":"👌","1f446":"👆","1f44d":"👍","1f44e":"👎","1f4aa":"💪","1f607":"😇","1f525":"🔥",2705:"✅"},chat_distribution_department_enabled:!1,chat_distribution_department_picked:null,chat_department_picked:!1,need_send_pick_department:!1,preform_request_data:{request:{},context:null},messages_for_send_by_timer:[],last_message_id:null,visitor_auto_invite:!1};$.extend(!0,s,defaultSettings),$.extend(!0,s,settings)},log:function(mess){wsUtil.log("CHAT : "+mess,"background: #00a4b4; color: #ffffff")},safe_tags:function(str){return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},autoSendMessage:function(button){var message="";message=button?$(button).data("message"):$('[href="#showchat"]').data("message"),!message||s.chat_created||s.chatCreating||_this.send({text:message,type:"text"},{scroll:!0})},hasVisitorData:function(){return!!(parseInt(s.chat_introduced)||WBK.settings.visitorName||WBK.settings.visitorPhone||WBK.settings.visitorEmail)},sendPickDepartmentMessage:function(){_this.addMessageRobot({subType:"pick_department"}),_this.changeStateInput(!0,s.lang_text.block_input_for_pick_department)},setDepartment:function(departmentId,title){s.chat_distribution_department_picked=departmentId,_this.showHelloMessageOperatorsFromDepartments(),_this.typingPositionUpdate(),_this.changeStateInput(!1,""),w.window.find(".ws-chat-message-robot-pick-department").hide(),_this.addMessageRobot({subType:"text",text:s.lang_text.picked_department_text+" "+title}),s.first_message&&(_this.sendFire(s.first_message),s.first_message=!1,wsUtil.deleteCookie("WidgetChat_first_message_"+WBK.settings.chatWidgetId)),_this.sendSystem({subType:"text",text:s.lang_text.picked_department_text+" "+title}),Object.keys(s.preform_request_data.request).length&&_this.sendPreformRequest(s.preform_request_data.request,s.preform_request_data.context)},changeStateInput:function(hide,text){w.window.find(".ws-textarea").attr("contenteditable",!hide).html(text),hide?(w.window.find(".ws-textarea-group").addClass("ws-textarea-group-hide"),w.window.find(".ws-textarea-element").hide(),w.window.find(".ws-textarea-group .ws-textarea-placeholder").hide()):(w.window.find(".ws-textarea-group").removeClass("ws-textarea-group-hide"),w.window.find(".ws-textarea-element").show(),text||w.window.find(".ws-textarea-group .ws-textarea-placeholder").show())},makeOpacityColor:function(color,divider){if("rgba"===color.substr(0,4)){var currentOpacity=parseInt(color.substr(color.length-2,color.length-1)),opacity=currentOpacity/divider;return color.substr(0,color.length-2)+opacity+")"}return color},recalculateWidthButton:function(){if(["vertical_left","vertical_right"].indexOf(s.button_location)!==-1){var width=w.btn_el.width();width%2===1&&width++,w.btn_el.width(width)}},updateVisitorAutoInvite:function(){s.visitor_auto_invite||_this.updateVisitor({autoInvite:!0})}}}(jWS),wsKiller=function($){var _this,s,t,w,_debug;return{settings:{},templates:{},widget:{},masksPhoneData:{inited:{"#cbkPhoneInput":!1,"#cbkPhoneDeferredInput":!1},newMask:!1,pasted:{"#cbkPhoneInput":!1,"#cbkPhoneDeferredInput":!1}},init:function(data){_this=this,s=this.settings,t=this.templates,w=this.widget,$.fn._frameCheck()&&"undefined"==typeof WBK&&(WBK=document.WBK),1===WBK.settings.phoneBasesCountries.length&&7===WBK.settings.phoneBase&&(_this.masksPhoneData.newMask=!0),_debug=WBK.checkDebug(),_this.loader(data)},loader:function(res){var data=res.Data.callback;_this.setDefaultText(),data.killerLangText&&(s.text=data.killerLangText),_this.setDefaultSettings(),_this.setTemplate(),document.body.style.setProperty("--envybox-btn-background-color","rgba(244,67,54,0.8)"),WBK.settings.callbackEnabled=!0,WBK.settings.killerId=res.Settings.killerId,WBK.settings.checkCaptcha=!1,data.killerHasMoney&&(s.killerHasMoney=1),data.killerIsPayed&&(s.killerIsPayed=!0),data.killerUseDepartment&&data.killerDepartments&&(s.useDepartment=parseInt(data.killerUseDepartment),s.departments=data.killerDepartments),data.killerTimezone&&""!==data.killerTimezone&&(s.killerTimezone=data.killerTimezone,"UTC"===s.killerTimezone?s.killerTimezone=0:s.killerTimezone=parseInt(s.killerTimezone.charAt(3)+s.killerTimezone.charAt(4)+s.killerTimezone.charAt(5))),data.killerWorkdays&&(s.killerWorkdays=data.killerWorkdays);var now=new Date;if(s.timeDelta=parseInt(now.getTime()/1e3)-WBK.settings.utcTime,now.setTime(1e3*WBK.settings.utcTime+60*now.getTimezoneOffset()*1e3+60*s.killerTimezone*60*1e3),s.currentDay=now.getDay()-1,s.currentDay<0&&(s.currentDay=6),s.prevDay=s.currentDay-1,s.prevDay<0&&(s.prevDay=6),data.killerFormCall=parseInt(data.killerFormCall),data.killerFormCall&&(s.killerFormCall=data.killerFormCall),parseInt(data.killerFormCallHide)&&(s.killerFormCallHide=parseInt(data.killerFormCallHide)),data.killerCallOff=parseInt(data.killerCallOff),data.killerCallOff&&(s.killerCallOff=data.killerCallOff),data.killerText&&(s.text.killerText=data.killerText,s.text.cbkShareTitle[0][0][0]=_this.formatText(s.text.killerText[0].call_deferred[0]),s.text.cbkShareTitle[0][0][1]=_this.formatText(s.text.killerText[0].call_deferred[1]),s.text.cbkShareTitle[0][1][0]=_this.formatText(s.text.killerText[0].call_deferred[0]),s.text.cbkShareTitle[0][1][1]=_this.formatText(s.text.killerText[0].call_deferred[1]),s.text.cbkShareTitle[1][1][0]=_this.formatText(s.text.killerText[1].success_call[0]),s.text.cbkShareTitle[1][1][1]=_this.formatText(s.text.killerText[1].success_call[1]),s.text.cbkDepartmentTitle[0][0]=_this.formatText(s.text.killerText[0].department[0]),s.text.cbkDepartmentTitle[0][1]=_this.formatText(s.text.killerText[0].department[1]),s.text.cbkDepartmentTitle[1][0]=_this.formatText(s.text.killerText[1].department[0]),s.text.cbkDepartmentTitle[1][1]=_this.formatText(s.text.killerText[1].department[1]),s.text.cbkCallTitleFail[1][0]=_this.formatText(s.text.killerText[1].cbk_call_title_fail[0]),s.text.cbkCallTitleFail[1][1]=_this.formatText(s.text.killerText[1].cbk_call_title_fail[1])),res.Settings.serviceName&&(s.text.cbkCopyright="Хочу "+WBK.settings.servicename+" на свой сайт"),res.Settings.serviceDomain&&(s.cbkLink="http://"+WBK.settings.servicedomain+"?utm_source=widget&utm_medium=self&utm_campaign="+location.hostname+"&utm_content=killer&utm_term="),data.partnerLink&&(s.cbkLink=data.partnerLink),data.agreementLink&&(s.agreementLink=data.agreementLink),data.killerIsPaused&&(s.killerIsPaused=data.killerIsPaused),data.killerPausedStart&&(s.killerPausedStart=data.killerPausedStart),data.killerPausedEnd&&(s.killerPausedEnd=data.killerPausedEnd),data.killerPausedDay&&(s.killerPausedDay=data.killerPausedDay),parseInt(data.killerOrderedCall)&&(s.killerOrderedCall=parseInt(data.killerOrderedCall)),data.killerSettings&&(data.killerSettings.windowPosition&&(s.windowPosition=parseInt(data.killerSettings.windowPosition)),data.killerSettings.auto_call_deffered&&(s.auto_call_deffered=parseInt(data.killerSettings.auto_call_deffered),s.auto_call_deffered_delay_value=parseInt(data.killerSettings.auto_call_deffered_delay_value)),data.killerSettings.agreementPersonalData&&(s.agreementPersonalData=data.killerSettings.agreementPersonalData),data.killerSettings.killerTransparentBgr&&(s.killerTransparentBgr=!0),s.contactNameInput=data.killerSettings.contact_name,s.contactEmailInput=data.killerSettings.contact_email,data.killerLogo&&(s.killerLogo=data.killerLogo),data.killerBtnLogo&&(s.killerBtnLogo=data.killerBtnLogo),data.killerSettings.logoStyle&&(s.killerLogoStyle=data.killerSettings.logoStyle),data.killerSettings.positionCustomLogoTop&&(s.customLogoPositionTop=data.killerSettings.positionCustomLogoTop),data.killerSettings.customLogoWidth&&data.killerSettings.customLogoHeight&&(s.customLogoWidth=data.killerSettings.customLogoWidth,s.customLogoHeight=data.killerSettings.customLogoHeight),data.killerUpdatedAt&&(s.killerUpdatedAt=data.killerUpdatedAt),data.killerSettings.btnType&&(s.btnType=data.killerSettings.btnType),data.killerSettings.btnSize&&(s.btnSize=data.killerSettings.btnSize),data.killerSettings.mobileBtnSize&&(s.mobileBtnSize=data.killerSettings.mobileBtnSize),data.killerSettings.animation&&(s.animation=data.killerSettings.animation),data.killerSettings.waveColor&&(s.waveColor=data.killerSettings.waveColor,WBK.addStyles(".callbackkiller.cbk-phone.cbk-phone-pulse .cbk-phone-circle{background-color: "+s.waveColor+"!important;}.callbackkiller.cbk-phone.cbk-phone-wild .cbk-phone-circle{background-color: "+s.waveColor+"!important;}.callbackkiller.cbk-phone.cbk-phone-waves .cbk-phone-circle{background-color: "+s.waveColor+"!important;}.callbackkiller.cbk-phone.cbk-phone-waves .cbk-phone-second_circle, .callbackkiller.cbk-phone.cbk-phone-waves .cbk-phone-third_circle{border: 1px solid "+s.waveColor+"!important;}")),data.killerSettings.btnPosition&&"btn"===s.btnType&&(s.btnPosition=data.killerSettings.btnPosition),data.killerSettings.btnExtendedPosition&&"extended_btn"===s.btnType&&(s.btnExtendedPosition=data.killerSettings.btnExtendedPosition),data.killerSettings.btnExtendedCorner&&"extended_btn"===s.btnType&&(s.btnExtendedCorner=data.killerSettings.btnExtendedCorner),data.killerSettings.hideBtn&&"pc"==WBK.settings.device&&(s.hideBtn=parseInt(data.killerSettings.hideBtn)),2==data.killerSettings.hideBtn&&"mobile"==WBK.settings.device&&(s.hideBtn=parseInt(data.killerSettings.hideBtn)),data.killerSettings.timerType&&(s.timerType=data.killerSettings.timerType),data.killerSettings.hideDefered&&(s.hideDefered=parseInt(data.killerSettings.hideDefered)),data.killerSettings.btnText&&(s.btnText=data.killerSettings.btnText),data.killerSettings.btnFontSize&&(s.btnFontSize=data.killerSettings.btnFontSize),data.killerSettings.btnTextAdd&&"pc"==WBK.settings.device&&(s.btnTextAdd=data.killerSettings.btnTextAdd),data.killerSettings.windowNoCopyright&&(WBK.settings.hideCopyright=!0),data.killerSettings.btnNoAnimateOnScroll&&(s.btnNoPulse=!0),data.killerSettings.btnStaticOnScroll&&(s.btnStaticOnScroll=!0),parseInt(data.killerSettings.btnHideMobileZoom)&&(s.btnHideMobileZoom=!0),data.killerSettings.btnHideOnMobile&&"mobile"===WBK.settings.device&&(s.hideBtn=1),data.killerSettings.btnHideOnTablet&&"tablet"===WBK.settings.device&&(s.hideBtn=1),data.killerSettings.btnRotateTimeout&&(s.timeouts.rotatePhoneIcons=data.killerSettings.btnRotateTimeout),data.killerSettings.btnShowTimeout&&(s.timeouts.btnShowTimeout=data.killerSettings.btnShowTimeout),data.killerSettings.paused_sec_target&&(s.timeouts.paused_sec_target=data.killerSettings.paused_sec_target),data.killerSettings.btnShowScroll&&(s.btnShowScroll=data.killerSettings.btnShowScroll),data.killerSettings.windowBtnTextOnline&&(s.windowBtnTextOnline=data.killerSettings.windowBtnTextOnline),data.killerSettings.windowBtnTextOffline&&(s.windowBtnTextOffline=data.killerSettings.windowBtnTextOffline),void 0!=data.killerSettings.killerManagerRatingCheck&&(s.managerRatingCheck=parseInt(data.killerSettings.killerManagerRatingCheck)),void 0!=data.killerSettings.killerCloseClickBgr&&(s.killerCloseClickBgr=parseInt(data.killerSettings.killerCloseClickBgr)),data.killerSettings.windowMinApperanceOnExitTimeout&&(s.showOnExitApperanceTimeout=data.killerSettings.windowMinApperanceOnExitTimeout),data.killerSettings.windowDisplayMode&&(1===data.killerSettings.windowDisplayMode&&(s.showWindowReapperanceTimeout=0,s.showOnExitReapperanceTimeout=40),2===data.killerSettings.windowDisplayMode&&(s.showWindowReapperanceTimeout=7,s.showOnExitReapperanceTimeout=10080),3===data.killerSettings.windowDisplayMode&&(s.noShowWindow=!0)),data.killerSettings.killerCallTimeout&&(s.callTimeout=parseInt(data.killerSettings.killerCallTimeout)),data.killerSettings.windowMinApperanceTimeout&&data.killerSettings.windowMaxApperanceTimeout&&data.killerSettings.windowMinApperanceTimeout<data.killerSettings.windowMaxApperanceTimeout?s.showWindowApperanceTimeout=wsUtil.getRandomArbitrary(data.killerSettings.windowMinApperanceTimeout,data.killerSettings.windowMaxApperanceTimeout):data.killerSettings.windowMinApperanceTimeout?s.showWindowApperanceTimeout=wsUtil.getRandomArbitrary(data.killerSettings.windowMinApperanceTimeout,data.killerSettings.windowMinApperanceTimeout+7):data.killerSettings.windowMaxApperanceTimeout&&(s.showWindowApperanceTimeout=wsUtil.getRandomArbitrary(0,data.killerSettings.windowMaxApperanceTimeout)),data.killerSettings.windowNoShowOnExit&&(s.noShowOnExit=!0),data.killerSettings.windowShowOnExitAlways&&(s.showOnExitAlways=!0),(data.killerSettings.btnColor||data.killerSettings.btnMobileColor&&"pc"!=WBK.settings.device)&&("pc"!=WBK.settings.device&&data.killerSettings.btnMobileColor?s.btnColor=data.killerSettings.btnMobileColor:data.killerSettings.btnColor&&(s.btnColor=data.killerSettings.btnColor),WBK.addStyles(".ws-killer .ws-killer-btn{background-color: "+s.btnColor+"!important;} .ws-killer .ws-killer-btn .ws-icon-phone{color: "+s.btnColor+"!important;} .cbk-btn, .cbk-btn:hover {background-color: "+s.btnColor+"!important;} .cbk-phone .cbk-phone-bgr {background-color: "+s.btnColor+"!important;}")),(data.killerSettings.btnTextColor||data.killerSettings.btnMobileTextColor&&"pc"!=WBK.settings.device)&&("pc"!=WBK.settings.device&&data.killerSettings.btnMobileTextColor?s.btnTextColor=data.killerSettings.btnMobileTextColor:data.killerSettings.btnTextColor&&(s.btnTextColor=data.killerSettings.btnTextColor),WBK.addStyles(".ws-killer .ws-btn-title {color: "+s.btnTextColor+"!important} .cbk-btn .cbk-title, .cbk-btn:hover .cbk-title {color: "+s.btnTextColor+"!important;} .cbk-phone .cbk-phone-phone .ws-icon-phone, .cbk-phone .cbk-phone-text, .cbk-phone .cbk-phone-text span, .cbk-phone .cbk-phone-phone.cbk-phone-with-text, .cbk-phone .cbk-phone-phone.cbk-phone-with-text span{color: "+s.btnTextColor+"!important;}")),data.killerSettings.windowBackgroundColor&&WBK.addStyles(".cbk-window.cbk-background {background-color: "+data.killerSettings.windowBackgroundColor+"!important;}.cbk-window.callbackkiller-mobile.cbk-background {background-color: "+data.killerSettings.windowBackgroundColor+"!important;}"),data.killerSettings.windowTextColor&&WBK.addStyles(".cbk-window * {color: "+data.killerSettings.windowTextColor+"!important}.cbk-window a, .cbk-window a:hover, .cbk-window a.cbk-button-no.cbk-button-no-dark {color: "+data.killerSettings.windowTextColor+"!important;}.cbk-window a.cbk-button-no.cbk-button-no-dark, .cbk-window a.cbk-button-no.cbk-button-no-dark:hover {color: "+data.killerSettings.windowTextColor+"!important;border-bottom: 1px dashed "+data.killerSettings.windowTextColor+"!important}"),data.killerSettings.windowLinkColor&&WBK.addStyles(".cbk-link-btn a, .cbk-link-btn a:hover, .cbk-link-btn a:active, .cbk-window a.cbk-button-no, .cbk-window a.cbk-button-no:hover{color: "+data.killerSettings.windowLinkColor+"!important; border-bottom: 1px dashed "+data.killerSettings.windowLinkColor+"!important;}"),data.killerSettings.windowInputBackgroundColor&&WBK.addStyles(".cbk-window .cbk-form .cbk-input, .cbk-window .cbk-form .cbk-input:focus, .cbk-window .cbk-form .cbk-input:hover, .cbk-window .cbk-form .cbk-select, .cbk-window .cbk-form .cbk-select option {background: "+data.killerSettings.windowInputBackgroundColor+"!important;}"),data.killerSettings.windowInputTextColor&&WBK.addStyles(".cbk-window .cbk-form .cbk-input, .cbk-window .cbk-form .cbk-input:focus, .cbk-window .cbk-form .cbk-input:hover, .cbk-window .cbk-form .cbk-select, .cbk-window .cbk-form .cbk-select option {color: "+data.killerSettings.windowInputTextColor+"!important;}"),data.killerSettings.windowBtnBackgroundColor&&(document.body.style.setProperty("--envybox-btn-background-color",data.killerSettings.windowBtnBackgroundColor.replace(",1)",",.8)")),WBK.addStyles(".cbk-window .cbk-button {background: "+data.killerSettings.windowBtnBackgroundColor.replace(",1)",",.8)")+"!important;}.cbk-window .cbk-button:hover, .cbk-window .cbk-button:active {background: "+data.killerSettings.windowBtnBackgroundColor+"!important;}")),data.killerSettings.windowBtnTextColor&&WBK.addStyles(".cbk-window .cbk-form .cbk-button, .cbk-window .cbk-form .cbk-button:hover, .cbk-window .cbk-form .cbk-button {color: "+data.killerSettings.windowBtnTextColor+"!important;}"),data.killerSettings.logoShadow&&(s.logoShadow=data.killerSettings.logoShadow,"hide"==s.logoShadow&&WBK.addStyles(".cbk-window-logo {box-shadow:none!important;}")),(data.killerSettings.btnPositionBottom||0===data.killerSettings.btnPositionBottom)&&(s.phonePositionBottom=data.killerSettings.btnPositionBottom),(data.killerSettings.btnPositionRight||0===data.killerSettings.btnPositionRight)&&(s.phonePositionRight=data.killerSettings.btnPositionRight),void 0!==data.killerSettings.btnMobilePositionHorizontal&&(s.btnMobilePositionHorizontal=data.killerSettings.btnMobilePositionHorizontal),data.killerSettings.btnMobilePositionHorizontalType&&(s.btnMobilePositionHorizontalType=data.killerSettings.btnMobilePositionHorizontalType),void 0!==data.killerSettings.btnMobilePositionVertical&&(s.btnMobilePositionVertical=data.killerSettings.btnMobilePositionVertical),data.killerSettings.shiftDayBeginning&&(s.shiftDayBeginning=parseInt(data.killerSettings.shiftDayBeginning)),data.killerSettings.btnMobilePositionVerticalType&&(s.btnMobilePositionVerticalType=data.killerSettings.btnMobilePositionVerticalType),data.killerOffNoWork&&(s.killerOffNoWork=data.killerOffNoWork),data.killerSettings.siteBgrColor&&(s.siteBgrColor=data.killerSettings.siteBgrColor),data.killerSettings.killerSendAction&&(s.killerSendAction=data.killerSettings.killerSendAction),data.killerSettings.killerPageOpenType&&(s.killerPageOpenType=data.killerSettings.killerPageOpenType),data.killerSettings.killerSendActionUrl&&(s.killerSendActionUrl=data.killerSettings.killerSendActionUrl),data.killerSettings.killerSendActionJavascript&&(s.killerSendActionJavascript=data.killerSettings.killerSendActionJavascript)),_this.checkWorkTime(),!s.killerWorking&&s.killerOffNoWork&&(s.hideBtn=1,s.noShowOnExit=!0,s.noShowWindow=!0),s.killerOrderedCall&&(s.hideBtn=1),wsUtil.getCookie("WhiteCallback_callId")&&(s.callId=wsUtil.getCookie("WhiteCallback_callId"),WBK.initSocket()),_this.initWidget(),_this.initKiller(),"#callbackkiller"===window.top.location.hash||"#callbackwidget"===window.top.location.hash){var d=new Date;d.setMinutes(d.getMinutes()+144e3),wsUtil.setCookie("CallbackKiller_shownOn","onbtn",d),_this.showWindow("btn")}if("#callbackkillermodal"===window.top.location.hash||"#callbackwidgetmodal"===window.top.location.hash){var d=new Date;d.setMinutes(d.getMinutes()+144e3),wsUtil.setCookie("CallbackKiller_shownOn","onbtn",d),_this.showWindow("modal")}},checkToInitInputMask:function(input,event){!_this.masksPhoneData.inited["#"+input.id]&&input.value&&(_this.initInputMask(input),_this.masksPhoneData.inited["#"+this.id]=!0)},formatNumberForRussia:function(pastedNumber){return pastedNumber?(pastedNumber=pastedNumber.replace(/[^0-9]/g,""),11===pastedNumber.length&&"8"===pastedNumber[0]?pastedNumber=pastedNumber.replace("8","7"):10===pastedNumber.length&&"9"===pastedNumber[0]&&(pastedNumber=pastedNumber.replace("9","79")),pastedNumber):null},initInputMask:function(selector,inCompleteParam){if(WBK.settings.phoneMasks){var listRU=$.masksSort(WBK.settings.phoneMasks,["#"],/[0-9]|#/,"mask"),optsRU={inputmask:{definitions:{"#":{validator:"[0-9]",cardinality:1}},clearIncomplete:!1,showMaskOnHover:!1,autoUnmask:!0},match:/[0-9]/,replace:"#",list:listRU,listKey:"mask",onMaskChange:function(){$(this).attr("placeholder",$(this).inputmask("getemptymask")),optsRU.ignoreSetValueOnPaste=!0,!_this.masksPhoneData.newMask||$(this).val()||$(this).hasClass("cbk-phone-checker")||_this.removeMask(this)}};"undefined"!=typeof inCompleteParam&&(optsRU.inputmask.definitions.clearIncomplete=!0),_this.masksPhoneData.newMask&&(sks(optsRU);var id=$(selector).attr("id");id&&(_this.masksPhoneData.inited["#"+id]=!0)}},showWindow:function(showOnType,noWorkTime){if(s.agreementPersonalData&&(!noWorkTime&&s.killerWorking?w.window.find(".cbk-personal-agreement span").html(s.windowBtnTextOnline):w.window.find(".cbk-personal-agreement span").html(s.windowBtnTextOffline),$(".cbk-personal-agreement").show()),"auto"===showOnType&&(WBK.settings.windowGeneratorOpened||WBK.settings.videoWidgetOpened||WBK.settings.chatWindowOpened||WBK.settings.chatInvitationOpened||WBK.settings.windowLoanerOpened||WBK.settings.multiButtonVariantsOpened||WBK.settings.windowQuizOpened))wsUtil.getCookie("WhiteCallback_noShowWindow")||s.noShowWindow||wsUtil.setTimeout("showWindowOnTimer",function(){if(!wsUtil.getCookie("WhiteCallback_noShowWindow")&&!wsUtil.getCookie("WhiteCallback_noShowOnExit")&&(_this.checkWorkTime(),!WBK.settings.windowOpened)){var d=new Date;d.setMinutes(d.getMinutes()+144e3),wsUtil.setCookie("WhiteCallback_shownOn","onshow",d),_this.showWindow("auto")}},1e3*s.showWindowApperanceTimeout);else{if("pc"!=WBK.settings.device&&23663!==WBK.settings.siteId&&(s.scrollLeft=$(window).scrollLeft(),s.scrollTop=$(window).scrollTop(),$("meta[name=viewport]:last").length?(w.window.data("oldViewport",$("meta[name=viewport]:last").attr("content")),$("meta[name=viewport]:last").remove()):w.window.data("noViewport",1),$("head").append($("<meta>").attr("name","viewport").attr("content","width=device-width, user-scalable=0, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0")),$("body").addClass("cbk-body-mobile").css("width",$(window).width()+"px")),WBK.settings.windowInvaderOpened&&(wsInvader.widget.window.find(".cbk-support-new-message-copyright").hide(),wsInvader.widget.window.hide()),WBK.settings.chatEnabled&&("auto"==showOnType?WBK.settings.chatBtnOpened&&!WBK.settings.chatInvitationOpened&&(wsChat.widget.btn.hide(),wsChat.widget.invitation.hide()):WBK.settings.chatWindowOpened&&wsChat.widget.window.hide(),WBK.settings.chatBtnOpened&&"auto"!=showOnType&&(wsChat.widget.btn.hide(),wsChat.widget.invitation.hide())),WBK.settings.quizId&&!WBK.settings.quizIntegrated&&WBK.settings.thisIsQuizLanding===!1&&wsQuizzes[WBK.settings.quizId].hideWidget(),WBK.settings.videoWidgetId&&WBK.settings.videoWidgetOpened&&wsVideoWidget.closeWidget(),WBK.settings.loanerId&&"mobile"!=WBK.settings.device&&wsLoaner.hideWidget(),WBK.settings.multiButtonId&&wsMultiButton.hideWidget(),WBK.settings.windowOpened=!0,w.btn.hasClass("cbk-phone")&&"pc"==WBK.settings.device&&(_this.stopRotatePhoneIcons(),w.btn.removeClass("cbk-pulse")),w.btn.is(":visible"))if("exit"===showOnType)w.btn.hide();else{var hideAnimation="cbk-fadeOutRightBtn";"pc"!=WBK.settings.device?hideAnimation="cbk-fadeOutDown":1===s.windowPosition&&(hideAnimation="cbk-fadeOutLeft"),WBK.animateFastOnce(w.btn,hideAnimation,function(){WBK.settings.windowOpened&&w.btn.hide()})}if("exit"===showOnType){w.window.addClass("cbk-window-onexit"),w.window.removeClass("cbk-window-modal");var cbkWindowWidth=w.window.width(),left=s.showOnExitXPosition-cbkWindowWidth/2;left<0&&(left=0),left+cbkWindowWidth>window.innerWidth&&(left=window.innerWidth-cbkWindowWidth-10),w.window.css("left",left+"px"),w.window.css("top","0")}else if(2!==s.windowPosition&&"modal"!==showOnType||"pc"!=WBK.settings.device)w.window.removeClass("cbk-window-onexit"),2!==s.windowPosition&&w.window.removeClass("cbk-window-modal"),w.window.css("left",""),w.window.css("top","");else{w.window.addClass("cbk-window-modal"),w.window.removeClass("cbk-window-onexit");var cbkWindowWidth=w.window.width(),left=(window.innerWidth-cbkWindowWidth)/2;left<0&&(left=0);var cbkWindowHeight=w.window.s("left",left+"px"),w.window.css("top",top+"px")}if(_this.initCallTimer(),w.windowbgr.show(),w.window.find(".cbk-form-title").show(),w.window.find("#cbkNameInput").attr("style","display: "+("none"==s.contactNameInput?"none":"inline-block")+"!important"),w.window.find("#cbkEmailInput").attr("style","display: "+("none"==s.contactEmailInput?"none":"inline-block")+"!important"),w.window.find("#cbkPhoneInput").attr("style","display: inline-block!important"),w.window.show(),"modal"===showOnType)showAnimation="cbk-fadeInUp",WBK.animateFastOnce(w.window,showAnimation);else if("exit"!==showOnType){var showAnimation="cbk-fadeInRight";"pc"!=WBK.settings.device?w.window.show():1===s.windowPosition||2===s.windowPosition?(showAnimation="cbk-fadeInLeft",WBK.animateFastOnce(w.window,showAnimation)):3===s.windowPosition?(showAnimation="cbk-fadeInUp",w.window.addClass("cbk-window-bottom"),WBK.animateFastOnce(w.window,showAnimation)):1!==s.windowPosition&&"sm"===showOnType?(wsInvader&&"right"!=wsInvader.settings.position&&(showAnimation="cbk-fadeInLeft",w.window.addClass("cbk-window-left")),WBK.animateFastOnce(w.window,showAnimation)):1!==s.windowPosition&&"instinct"===showOnType?(wsInstinct&&"right"!=wsInstinct.settings.position_x&&(showAnimation="cbk-fadeInLeft",w.window.addClass("cbk-window-left")),WBK.animateFastOnce(w.window,showAnimation)):1!==s.windowPosition&&"multi_button"===showOnType?("right"!=wsMultiButton.settings.position_x&&(showAnimation="cbk-fadeInLeft",w.window.addClass("cbk-window-left")),WBK.animateFastOnce(w.window,showAnimation)):1!==s.windowPosition&&"video_widget"===showOnType&&("right"!==wsVideoWidget.settings.position_x&&(showAnimation="cbk-fadeInLeft",w.window.addClass("cbk-window-left")),WBK.animateFastOnce(w.window,showAnimation))}switch(showOnType){case"auto":_this.sendGoal("showauto");break;case"exit":_this.sendGoal("showonexit")}if(_this.checkWorkTime(),w.window.find("div.cbk-form").hide(),$("#cbkPhoneBtn").show(),w.window.find(".cbk-timer").removeClass("call"),wsUtil.deleteInterval("callTimerAnimation"),w.window.find(".cbk-text-after-call").hide(),!noWorkTime&&s.killerWorking){w.window.find("div.cbk-callform .cbk-button-no").show(),s.killerHasMoney&&!s.killerCallOff&&"hide"!=s.timerType?w.window.find(".cbk-timer").show():(!s.killerCallOff&&s.killerHasMoney||(showOnType="nomoney"),w.window.find(".cbk-timer").hide()),"modal"===showOnType?showOnType="auto":"sm"!==showOnType&&"instinct"!==showOnType&&"multi_button"!==showOnType&&"video_widget"!==showOnType||(showOnType="btn"),_this.setFormText(w.window.find("div.cbk-callform .cbk-form-title"),s.text.killerText[s.killerWorking][showOnType][WBK.settings.hasVisitorName]),_this.personalizeForms();var callForm=w.window.find("div.cbk-callform");callForm.show(),"pc"==WBK.settings.device&&WBK.animateOnce(callForm,"cbk-fadeIn",function(){WBK.animateOnce(callForm.find("div.cbk-form-title"),"cbk-bounce")}),_this.setPhoneInputFocus()}else{_this.setWorkDays(),s.killerHasMoney?"modal"===showOnType?showOnType="auto":"sm"!==showOnType&&"instinct"!==showOnType&&"multi_button"!==showOnType&&"video_widget"!==showOnType||(showOnType="btn"):showOnType="nomoney",_this.setFormText(w.window.find("div.cbk-cdform .cbk-form-title"),s.text.killerText[s.killerWorking][showOnType][WBK.settings.hasVisitorName]),_this.personalizeForms();var clForm=w.window.find("div.cbk-cdform");clForm.show(),WBK.animateOnce(clForm,"cbk-fadeIn",function(){"pc"==WBK.settings.device&&WBK.animateOnce(clForm.find("div.cbk-form-title"),"cbk-bounce")}),_this.setPhoneInputFocus()}_this.onResizeWindow(),s.callStarted=!1;var url=WBK.settings.serverUrl+"/api?action=newshow&callback=?";$.getJSON(url,{shownOn:wsUtil.getCookie("WhiteCallback_shownOn"),device:WBK.settings.device,code:WBK.settings.whiteSaasCode,googleClientId:wsUtil.getGoogleClientId(),killerId:WBK.settings.killerId,visitorId:WBK.settings.visitorId,advertiseId:wsUtil.getAdvertiseId(),calltrackingId:wsUtil.getCalltrackingId(),lpgeneratorId:wsUtil.getLPGeneratorId(),leadvertexId:wsUtil.getLeadvertexId(),externalParams:wsUtil.getExternalParams()})}wsUtil.fixJivo(!0),wsUtil.fixBootstrap()},hideWindow:function(){if("pc"!=WBK.settings.device&&(w.window.data("noViewport")?(w.window.data("noViewport",0),$("head meta[name=viewport]:last").attr("content","")):$("head meta[name=viewport]:last").attr("content",w.window.data("oldViewport")),$("body").removeClass("cbk-body-mobile").css("width","auto"),$(window).scrollTop(s.scrollTop),$(window).scrollLeft(s.scrollLeft),wsUtil.fixJivo(!1)),w.windowbgr.hide(),WBK.settings.windowOpened){var hideAnimation="cbk-fadeOutRight";"pc"!=WBK.settings.device?(w.window.hide(),w.window.find("div.cbk-form").hide()):1===s.windowPosition||w.window.hasClass("cbk-window-left")?hideAnimation="cbk-fadeOutLeft":(3===s.windowPosition||w.window.hasClass("cbk-window-bottom"))&&(hideAnimation="cbk-fadeOutUp"),"pc"==WBK.settings.device&&WBK.animateFastOnce(w.window,hideAnimation,function(){w.window.hide(),w.window.find("div.cbk-form").hide(),1!==s.windowPosition&&w.window.hasClass("cbk-window-left")&&w.window.removeClass("cbk-window-left")})}if(1!=s.hideBtn&&s.btnShow){var showAnimation="cbk-fadeInRight";"pc"!=WBK.settings.device?(showAnimation="cbk-fadeInUp",w.btn.show(500)):(w.btn.show(),("btn"!=s.btnType||"btn"==s.btnType&&"left"!=s.btnPosition)&&WBK.animateFastOnce(w.btn,showAnimation,function(){_this.updatePhonePosition()}))}if(w.btn.hasClass("cbk-phone")&&"pc"==WBK.settings.device&&_this.startRotatePhoneIcons(),WBK.settings.windowOpened=!1,s.showWindowReapperanceTimeout){var d=new Date;d.setDate(d.getDate()+parseInt(s.showWindowReapperanceTimeout)),wsUtil.setCookie("WhiteCallback_noShowWindow",1,d)}else wsUtil.setCookie("WhiteCallback_noShowWindow",1);var d=new Date;s.showOnExitAlways?d.setSeconds(d.getSeconds()+3):deout)),wsUtil.setCookie("WhiteCallback_noShowOnExit",1,d),WBK.settings.invaderCallbackStatId=!1,WBK.settings.chatEnabled&&(WBK.settings.chatBtnOpened&&wsChat.widget.btn.show(),WBK.settings.chatWindowOpened&&wsChat.widget.window.show()),WBK.settings.quizId&&!WBK.settings.quizIntegrated&&WBK.settings.thisIsQuizLanding===!1&&wsQuizzes[WBK.settings.quizId].showWidget(),WBK.settings.windowInvaderOpened&&!wsUtil.getCookie("WhiteInvader_closed_"+WBK.settings.invaderId)&&wsInvader.showWidget(),
WBK.settings.loanerId&&"mobile"!=WBK.settings.device&&wsLoaner.showWidget(),WBK.settings.multiButtonId&&wsMultiButton.showWidget()},startShakeBtn:function(){wsUtil.setInterval("shakeBtn",function(){"extended_btn"==s.btnType?WBK.animateOnce(w.extended_btn,"cbk-shake"):WBK.animateOnce(w.btn,"cbk-shake")},1e3*s.timeouts.shakeBtn)},stopShakeBtn:function(){wsUtil.deleteInterval("shakeBtn")},startRotatePhoneIcons:function(){if(!s.btnText)return void w.btn.find(".cbk-phone-text").remove();var delayRotateTime=1e3;w.btn.hasClass("cbk-phone-wild")&&(delayRotateTime=3e3),w.btn.hasClass("cbk-phone")&&_this.initBtnText(),w.btn.find(".cbk-phone-content div.cbk-rotate-icon").length||w.btn.find(".cbk-phone-content div:first").addClass("cbk-rotate-icon"),wsUtil.setInterval("rotatePhoneIcons",function(){if(w.btn.hasClass("cbk-pulse"))w.btn.find(".cbk-phone-content div").removeClass("cbk-rotate-icon");else{var isLast=!1;w.btn.find(".cbk-phone-content div.cbk-rotate-icon").is(":last-child")&&(isLast=!0),isLast?(w.btn.find(".cbk-phone-content div").removeClass("cbk-rotate-icon"),w.btn.find(".cbk-phone-content div:first").addClass("cbk-rotate-icon")):w.btn.find(".cbk-phone-content div.cbk-rotate-icon").removeClass("cbk-rotate-icon").next().addClass("cbk-rotate-icon")}w.btn.hasClass("cbk-phone")&&_this.initBtnText()},s.timeouts.rotatePhoneIcons*delayRotateTime)},stopRotatePhoneIcons:function(){return s.btnText?(w.btn.removeClass("cbk-phone-text-none"),wsUtil.deleteInterval("rotatePhoneIcons"),w.btn.find(".cbk-rotate-icon").removeClass("cbk-rotate-icon"),void _this.initBtnText()):void w.btn.addClass("cbk-phone-text-none")},getBackground:function(item){var color=item.css("background-color"),alpha=parseFloat(color.split(",")[3],10);return(isNaN(alpha)||alpha>.8)&&"transparent"!==color?color:!item.is("body")&&_this.getBackground(item.parent())},getLuma:function(color){var rgba=color.substring(4,color.length-1).split(","),r=rgba[0],g=rgba[1],b=rgba[2],luma=.2126*r+.7152*g+.0722*b;return luma},showError:function(element,errorText){element.is("input")||element.is("div")?(element.addClass("cbk-error"),"pc"==WBK.settings.device&&element.addClass("cbk-error").focus()):element.is("select")||(element=element.parent());var message=$('<div class="cbk-error-text">'+errorText+"</div>");element.after(message),setTimeout(function(){message.fadeOut(500,function(){$(this).remove(),element.removeClass("cbk-error")})},2e3),$("#cbkPhoneBtn").show()},hideErorrs:function(){w.window.find(".cbk-error-text").remove(),w.window.find(".cbk-error").removeClass("cbk-error")},initBtn:function(){"btn"==s.btnType&&s.btnText&&($(".cbk-btn .cbk-title").html(s.btnText),$(".cbk-btn .cbk-title").css("font-size",s.btnFontSize)),"extended_btn"==s.btnType&&"pc"==WBK.settings.device&&(s.btnText?w.extended_btn.find(".ws-btn-title").html(s.btnText):w.extended_btn.addClass("ws-killer-text-none")),_this.initBtnText(),w.btn.hasClass("cbk-phone")?("pc"==WBK.settings.device&&(_this.startRotatePhoneIcons(),w.btn.on("mouseenter.callbackkiller",function(e){_this.isTouchDevice()||(wsUtil.deleteTimeout("cbkPhonePulse"),w.btn.removeClass("cbk-pulse"),_this.stopRotatePhoneIcons())}).on("mouseleave.callbackkiller",function(e){_this.isTouchDevice()||(w.btn.find(".cbk-phone-phone").addClass("cbk-rotate-icon"),_this.startRotatePhoneIcons())}).on("dragstart",function(e){e.preventDefault()}).on("mousedown.callbackkiller",function(e){1===e.which&&(s.dragObject.elem=_this.widget.btn,s.dragObject.downX=e.pageX,s.dragObject.downY=e.pageY)}).on("mouseup.callbackkiller",function(e){if(s.dragObject.dragStarted){s.dragObject.dragStarted=!1;var d=new Date;d.setSeconds(d.getSeconds()+1),wsUtil.setCookie("WhiteCallback_noClickOnPhone",1,d)}s.dragObject={}})),$(document).on("mouseup.callbackkiller",function(e){if(s.dragObject.dragStarted){s.dragObject.dragStarted=!1;var d=new Date;d.setSeconds(d.getSeconds()+1),wsUtil.setCookie("WhiteCallback_noClickOnPhone",1,d)}s.dragObject={}}),$(document).on("mousemove.callbackkiller",function(e){if(s.dragObject.elem){var moveX=e.pageX-s.dragObject.downX,moveY=e.pageY-s.dragObject.downY;if(Math.abs(moveX)<3&&Math.abs(moveY)<3)return;s.dragObject.dragStarted||(s.dragObject.oldPosition={left:s.dragObject.elem.position().left||"",top:s.dragObject.elem.position().top||""},s.dragObject.shiftX=s.dragObject.downX-s.dragObject.elem.position().left,s.dragObject.shiftY=s.dragObject.downY-s.dragObject.elem.position().top,s.dragObject.dragStarted=!0),s.dragObject.elem.css({left:e.pageX-s.dragObject.shiftX+"px",top:e.pageY-s.dragObject.shiftY+"px",right:"auto",bottom:"auto"})}})):s.btnNoPulse||_this.startShakeBtn()},initBtnText:function(){if($(".cbk-phone .cbk-phone-text").length){if(s.btnText){var words=new Array,maxLengthWord="",size=0,i=0;for(words=s.btnText.split(" "),i=0;i<words.length;i++)words[i].length>maxLengthWord.length&&(maxLengthWord=words[i]);"sm"===s.btnSize?maxLengthWord.length>10?size=70:maxLengthWord.length>8?size=80:maxLengthWord.length>6&&(size=90):"xs"===s.btnSize?maxLengthWord.length>10?size=70:maxLengthWord.length>8?size=80:maxLengthWord.length>6&&(size=90):maxLengthWord.length>10?size=80:maxLengthWord.length>8&&(size=85),size?$(".cbk-phone .cbk-phone-text").html($("<span>").addClass("cbk-font-size-"+size).html(s.btnText)):$(".cbk-phone .cbk-phone-text").html(s.btnText)}if($(".cbk-phone").is(":visible")?$(".cbk-phone .cbk-phone-text").css("marginTop",($(".cbk-phone").outerHeight()-$(".cbk-phone .cbk-phone-text").outerHeight())/2):($(".cbk-phone").show(),$(".cbk-phone .cbk-phone-text").css("marginTop",($(".cbk-phone").outerHeight()-$(".cbk-phone .cbk-phone-text").outerHeight())/2),$(".cbk-phone").hide()),s.btnTextAdd){var words=new Array,maxLengthWord="",size=0,i=0;for(words=s.btnTextAdd.split(" "),i=0;i<words.length;i++)words[i].length>maxLengthWord.length&&(maxLengthWord=words[i]);"sm"===s.btnSize?maxLengthWord.length>10?size=70:maxLengthWord.length>8?size=80:maxLengthWord.length>6&&(size=90):"xs"===s.btnSize?maxLengthWord.length>10?size=70:maxLengthWord.length>8?size=80:maxLengthWord.length>6&&(size=90):maxLengthWord.length>10?size=80:maxLengthWord.length>8&&(size=90),size?$(".cbk-phone .cbk-phone-phone").addClass("cbk-phone-with-text").html($("<span>").addClass("cbk-font-size-"+size).html(s.btnTextAdd)):$(".cbk-phone .cbk-phone-phone").addClass("cbk-phone-with-text").html(s.btnTextAdd),$(".cbk-phone").is(":visible")?$(".cbk-phone .cbk-phone-phone").css("marginTop",($(".cbk-phone").outerHeight()-$(".cbk-phone .cbk-phone-phone").outerHeight())/2):($(".cbk-phone").show(),$(".cbk-phone .cbk-phone-phone").css("marginTop",($(".cbk-phone").outerHeight()-$(".cbk-phone .cbk-phone-phone").outerHeight())/2),$(".cbk-phone").hide())}}},initPhonePosition:function(){if("pc"!=WBK.settings.device)_this.updateBtnPositionMobile();else if("phone"==s.btnType){if(s.btnStaticOnScroll){$(window).width();w.btn.stop().css({left:s.phonePositionRight>=50?100-s.phonePositionRight+"%":"auto",right:s.phonePositionRight<50?s.phonePositionRight+"%":"auto",bottom:s.phonePositionBottom<=50?s.phonePositionBottom+"%":"auto",top:s.phonePositionBottom>50?100-s.phonePositionBottom+"%":"auto"})}else{var windowScrollTop=$(window).scrollTop(),windowHeight=window.innerHeight,phonePositionBottom=s.phonePositionBottom,phonePositionRight=s.phonePositionRight,positionBottom=windowHeight*phonePositionBottom/100,positionTop=windowHeight-positionBottom+windowScrollTop;phonePositionBottom<50&&(positionTop-=w.btn.outerHeight()),w.btn.stop().css({bottnePositionRight<50?phonePositionRight+"%":"auto"})}w.btn.stop().css({transform:"scale(1)"})}else if("btn"==s.btnType){var css={};"left"===s.btnPosition||"right"===s.btnPosition?(css.top=s.phonePositionBottom>50?100-s.phonePositionBottom+"%":"auto",css.bottom=s.phonePositionBottom<=50?s.phonePositionBottom+"%":"auto",s.phonePositionBottom>50?css.marginTop=-w.btn.outerHeight():css.marginBottom=w.btn.outerWidth()):(css.left=s.phonePositionRight>=50?100-s.phonePositionRight+"%":"auto",css.right=s.phonePositionRight<50?s.phonePositionRight+"%":"auto"),w.btn.stop().css(css)}else if("extended_btn"==s.btnType){var css={bottom:s.phonePositionBottom<=50?s.phonePositionBottom+"%":"auto",top:s.phonePositionBottom>50?100-s.phonePositionBottom+"%":"auto",right:s.phonePositionRight<50?s.phonePositionRight+"%":"auto",left:s.phonePositionRight>=50?100-s.phonePositionRight+"%":"auto"};switch(w.btn.show(),s.btnExtendedPosition){case"horizontal":100==s.phonePositionBottom?w.extended_btn.addClass("ws-killer-btn-attach-top"):0==s.phonePositionBottom&&w.extended_btn.addClass("ws-killer-btn-attach-bottom");break;case"vertical_left":w.extended_btn_container.addClass("ws-killer-btn-left"),w.extended_btn.addClass("ws-killer-btn-attach-top"),s.phonePositionBottom>50?css.marginTop=w.extended_btn.outerWidth():css.marginBottom=-w.extended_btn.outerHeight();break;case"vertical_right":w.extended_btn_container.addClass("ws-killer-btn-right"),w.extended_btn.addClass("ws-killer-btn-attach-bottom"),w.extended_btn.show(),s.phonePositionBottom>50?css.marginTop=-w.extended_btn.outerHeight():css.marginBottom=w.extended_btn.outerWidth()}w.btn.hide(),w.extended_btn_container.stop().css(css)}},updatePhonePosition:function(){if("mobile"===WBK.settings.device&&1!=s.hideBtn&&s.btnShow)_this.updateBtnPositionMobile();else if("tablet"===WBK.settings.device&&1!=s.hideBtn&&s.btnShow)_this.updateBtnPositionMobile();else if("phone"==s.btnType)if(s.btnStaticOnScroll)s.btnNoPulse||"pc"!=WBK.settings.device||(w.btn.addClass("cbk-pulse"),wsUtil.setTimeout("cbkPhonePulse",function(){w.btn.removeClass("cbk-pulse"),w.btn.find(".cbk-phone-phone").addClass("cbk-rotate-icon")},1e3*s.timeouts.phonePulse));else{var windowScrollTop=$(window).scrollTop(),windowHeight=window.innerHeight,phonePositionBottom=s.phonePositionBottom,phonePositionRight=s.phonePositionRight,positionBottom=windowHeight*phonePositionBottom/100,positionTop=windowHeight-positionBottom+windowScrollTop;phonePositionBottom<50&&(positionTop-=w.btn.outerHeight()),w.btn.stop().animate({left:phonePositionRight>50?100-phonePositionRight+"%":"auto",right:phonePositionRight<50?phonePositionRight+"%":"auto",top:positionTop+"px",bottom:"auto"},350,function(){s.btnNoPulse||"pc"!=WBK.settings.device||(w.btn.addClass("cbk-pulse"),wsUtil.setTimeout("cbkPhonePulse",function(){w.btn.removeClass("cbk-pulse"),w.btn.find(".cbk-phone-phone").addClass("cbk-rotate-icon")},1e3*s.timeouts.phonePulse)),"wild"===s.animation&&w.btn.addClass("cbk-phone-wild")})}},updateBtnPositionMobile:function(){var ratio=wsUtil.getRatio(),ratioScreen=.57*ratio;s.scallingMobile=1!=ratio;var positionData,position={ratio:ratioScreen,positionX:s.btnMobilePositionHorizontalType,positionY:s.btnMobilePositionVerticalType,positionXValue:"right"===s.btnMobilePositionHorizontalType?100-s.btnMobilePositionHorizontal:s.btnMobilePositionHorizontal,positionYValue:"bottom"===s.btnMobilePositionVerticalType?100-s.btnMobilePositionVertical:s.btnMobilePositionVertical};s.scallingMobile?(w.btn.removeClass("envy-not-scalling"),position.el=w.btn,positionData=wsUtil.getMobileScalePositionWidget(position),w.btn.css(positionData)):(w.btn.addClass("envy-not-scalling"),positionData=wsUtil.getMobileNotScalePositionWidget(position),w.btn.css(positionData)),1!=s.hideBtn&&s.btnShow&&(w.btn.show(),w.btn.removeClass("btn-hide"))},onResizeWindow:function(){if(w.window.hasClass("cbk-window-modal")){var cbkWindowWidth=w.window.width(),left=(window.innerWidth-cbkWindowWidth)/2;left<0&&(left=0);var cbkWindowHeight=w.window.height(),top=(window.innerHeight-cbkWindowHeight)/2;top<0&&(top=0),w.window.css("left",left+"px"),w.window.css("top",top+"px")}if(s.killerLogo&&"custom"==s.killerLogoStyle&&(s.customLogoWidth&&s.customLogoHeight&&s.customLogoPositionTop&&(w.window.hasClass("cbk-window-modal")||w.window.hasClass("cbk-window-onexit")?(w.window.find(".cbk-window-logo").addClass("cbk-custom-logo"),w.window.find(".cbk-window-logo").css("width",""),w.window.find(".cbk-window-logo").css("height",""),w.window.find(".cbk-window-logo").css("top",0),w.window.find(".cbk-window-logo").css("marginLeft",0)):(w.window.find(".cbk-window-logo").addClass("cbk-custom-logo").css("width",s.customLogoWidth),w.window.find(".cbk-window-logo").addClass("cbk-custom-logo").css("height",s.customLogoHeight),w.window.hasClass("cbk-window-bottom")&&!w.window.hasClass("cbk-window-modal")&&w.window.hasClass("cbk-window-onexit")?(w.window.find(".cbk-window-logo").css("top",s.customLogoPositionTop+"px"),w.window.find(".cbk-window-logo").css("marginLeft",w.window.offsetWidth()-617-s.customLogoWidth/2)):(w.window.find(".cbk-window-logo").css("top",s.customLogoPositionTop+"px"),w.window.find(".cbk-window-logo").css("marginLeft",-(s.customLogoWidth/2))))),"show"==s.logoShadow&&WBK.addStyles(".cbk-window-logo.cbk-custom-logo{box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15)!important;}")),"pc"!=WBK.settings.device){w.window.find("div.cbk-window-logo").css({margin:"20px auto 0",position:"initial"}),w.window.find("div.cbk-form").css("marginTop",20);var formContainer=w.window.find("div.cbk-forms"),formHeight=w.window.find("div.cbk-form:visible").outerHeight(!0),logoHeight=w.window.find("div.cbk-window-logo:visible")?w.window.find("div.cbk-window-logo:visible").outerHeight(!0):0,marginTop=0;window.innerHeight>formHeight+logoHeight&&(marginTop=(window.innerHeight-formHeight-logoHeight)/2);var copyright=w.window.find(".cbk-copyright");formContainer.css("marginTop",0),copyright.css("margin-top",0),copyright.css("margin-top","-"+copyright.outerHeight()+"px");var heightWidget=formHeight+logoHeight+marginTop+copyright.outerHeight();heightWidget<window.innerHeight?heightWidget=window.innerHeight:$(".callbackkiller-mobile .cbk-copyright").attr("style","display: none !important"),w.window.find(".cbk-background").attr("style","height:"+heightWidget+"px !important"),s.btnHideMobileZoom&&s.scallingMobile&&"pc"!=WBK.settings.device&&w.btn.hide()}else{var formContainer=w.window.find("div.cbk-forms");if(3!==s.windowPosition){s.formHeight||(s.formHeight=w.window.find("div.cbk-form:visible").height(),formContainer.height(s.formHeight),w.window.find("div.cbk-forms").height(s.formHeight));var offsetTop=0;!s.killerLogo||w.window.hasClass("cbk-window-modal")||w.window.hasClass("cbk-window-onexit")||(offsetTop=120);var wHeight=0;wHeight=w.window.hasClass("cbk-window-modal")||w.window.hasClass("cbk-window-onexit")||$.fn._frameCheck()?formContainer.parent().height():window.innerHeight;var marginTop=(wHeight-formContainer.height()+offsetTop)/2;formContainer.css("marginTop",marginTop),formContainer.css("margin")}}_this.updatePhonePosition()},onScroll:function(){var _this=this;if(3==s.hideBtn&&!s.btnShow){var scroll=$(window).scrollTop(),scrollH=$(document).height()-$(window).height(),scrolled=scroll/scrollH*100;WBK.settings.windowOpened||WBK.settings.windowGeneratorOpened||WBK.settings.videoWidgetOpened||WBK.settings.windowLoanerOpened||WBK.settings.windowQuizOpened||!(s.btnShowScroll<=scrolled)||(s.btnShow=!0,w.btn.show())}s.btnHideMobileZoom&&"pc"!=WBK.settings.device&&w.btn.addClass("btn-hide"),s.btnStaticOnScroll||"wild"!==s.animation||w.btn.removeClass("cbk-phone-wild"),wsUtil.setTimeout("scrollTimer",function(){_this.updatePhonePosition()},250)},initCallTimer:function(){return"hide"==s.timerType?void w.window.find("div.cbk-timer").hide():(w.window.find("div.cbk-timer").html('<span class="cbk-number">00</span><span class="cbk-d">:</span><span class="cbk-number cbk-number-sec">'+(s.callTimeout-1)+'</span><span class="cbk-d">:</span><span class="cbk-number cbk-number-msec">99</span>'),void("seconds"==s.timerType&&(w.window.find("div.cbk-callform").find(".cbk-d").last().hide(),w.window.find("div.cbk-departmentform").find(".cbk-d").last().hide(),w.window.find("div.cbk-timer").find(".cbk-number-msec").hide())))},initWidget:function(){WBK.loadFont();var btnTemplate=t.phone,btnClass="",btnContainerClass="";if("pc"==WBK.settings.device){if("btn"===s.btnType&&(btnTemplate=t.btn,"left"===s.btnPosition?btnClass="cbk-btn-left":"top"===s.btnPosition?btnClass="cbk-btn-top":"right"===s.btnPosition&&(btnClass="cbk-btn-right")),"phone"===s.btnType&&(s.btnStaticOnScroll&&(btnClass="cbk-phone-fixed "),"sm"===s.btnSize?btnClass+="cbk-phone-sm":"xs"===s.btnSize&&(btnClass+="cbk-phone-xs"),s.animation&&"pulse"===s.animation?(btnClass+=" cbk-phone-pulse",WBK.addStyles(".callbackkiller.cbk-phone.cbk-phone-pulse{--box-shadow-color: 0 9px 16px "+s.btnColor+"!important;}")):!s.animation||"wild"!==s.animation&&"waves"!==s.animation||(btnClass+=" cbk-phone-"+s.animation)),"extended_btn"===s.btnType)switch(btnTemplate=t.extended_btn,s.btnExtendedCorner){case"smooth":btnClass+="ws-killer-btn-mini-round";break;case"round":btnClass+="ws-killer-btn-round";break;case"flat":btnClass+="";break;default:btnClass+="ws-killer-btn-mini-round"}"vertical_left"==s.btnExtendedPosition&&(btnContainerClass+="ws-killer-btn-left"),"vertical_right"==s.btnExtendedPosition&&(btnContainerClass+="ws-killer-btn-right")}else{var mobileBtnClass="";"bg"===s.mobileBtnSize?mobileBtnClass+="cbk-phone-mobile-bg":"xs"===s.mobileBtnSize&&(mobileBtnClass+="cbk-phone-mobile-xs")}w.btn=$(btnTemplate).addClass(btnClass);var btn_click=w.btn;if("extended_btn"===s.btnType&&"pc"==WBK.settings.device&&(w.extended_btn=w.btn.find(".ws-killer-btn").addClass(btnClass),w.extended_btn_container=w.btn.find(".ws-killer-btn-container"),w.extended_btn_container.addClass(btnContainerClass),btn_click=w.extended_btn),"pc"!=WBK.settings.device&&w.btn.addClass(mobileBtnClass),btn_click.click(function(e){if(!wsUtil.getCookie("WhiteCallback_noClickOnPhone")){s.dragObject={};var d=new Date;d.setMinutes(d.getMinutes()+144e3),wsUtil.setCookie("WhiteCallback_shownOn","onbtn",d),_this.showWindow("btn"),_this.sendGoal("showonbtn")}return e.preventDefault(),!1}),w.btn.appendTo("body"),w.btn.hide(),"pc"!=WBK.settings.device&&w.btn.addClass("envy-not-scalling"),1!=s.hideBtn)if(_this.initPhonePosition(),_this.initBtn(),2==s.hideBtn){var open_seconds=s.timeouts.btnShowTimeout;if("site"===s.timeouts.paused_sec_target){var timeAfterFirstLogin=wsUtil.getCookie("WhiteCallback_timeAll");timeAfterFirstLogin&&(+timeAfterFirstLogin<+open_seconds?open_seconds-=timeAfterFirstLogin:open_seconds=0)}wsUtil.setTimeout("btnShowTimeout",function(){s.btnShow=!0,WBK.settings.windowOpened||WBK.settings.windowGeneratorOpened||WBK.settings.videoWidgetOpened||WBK.settings.chatWindowOpened||WBK.settings.windowLoanerOpened||WBK.settings.windowQuizOpened||w.btn.show()},1e3*open_seconds)}else 0==s.hideBtn&&(s.btnShow=!0,WBK.settings.windowOpened||WBK.settings.windowGeneratorOpened||WBK.settings.videoWidgetOpened||WBK.settings.chatWindowOpened||WBK.settings.chatInvitationOpened||WBK.settings.windowLoanerOpened||WBK.settings.windowQuizOpened||w.btn.show());w.windowbgr=$(t.windowbgr).hide().click(function(e){return s.killerCloseClickBgr&&_this.hideWindow(),e.preventDefault(),!1}).appendTo("body"),s.siteBgrColor&&w.windowbgr.css("background-color",s.siteBgrColor),s.killerTransparentBgr&&w.windowbgr.addClass("cbk-window-bgr-transparent"),w.window=$(t.window).hide().find("a.cbk-close-window").click(function(e){return _this.hideWindow(),e.preventDefault(),!1}).end().appendTo("body"),s.killerLogo&&$(t.windowlogo).html($("<img/>").attr("src",WBK.settings.staticServerUrl+s.killerLogo)).prependTo(w.window.find(".cbk-forms")),"extended_btn"==s.btnType&&s.killerBtnLogo&&"pc"==WBK.settings.device&&w.extended_btn.addClass("ws-killer-logo-yes").find(".ws-killer-logo-img").attr("src",WBK.settings.staticServerUrl+s.killerBtnLogo+"?v="+s.killerUpdatedAt),"pc"==WBK.settings.device&&(1===s.windowPosition?w.window.addClass("cbk-window-left"):2===s.windowPosition&&w.window.addClass("cbk-window-modal")),WBK.settings.hideCopyright?w.window.find("a.cbk-copyright").remove():$("body").on("click","a.cbk-copyright",function(e){WBK.sendAdvertLinkStat($(this).data("widget"),$(this).attr("href"),$(this).text(),WBK.settings.killerId)}),s.windowBtnTextOnline&&w.window.find("#cbkPhoneBtn").html(s.windowBtnTextOnline),s.windowBtnTextOffline&&w.window.find("#cbkPhoneDeferredBtn").html(s.windowBtnTextOffline),s.hideDefered&&w.window.find(".cbk-link-btn").hide(),3==s.windowPosition&&$(".cbk-form.cbk-callform").addClass("cbk-forms-bottom"),w.window.find("div.cbk-form").hide(),$("#cbkCallDeferredTime").change(function(){_this.setPhoneInputFocus()}),$("#cbkPhoneBtn").click(function(e){e.preventDefault(),_this.hideErorrs();var phone=$("#cbkPhoneInput").val(),name=$("#cbkNameInput").val().trim(),email=$("#cbkEmailInput").val();WBK.settings.phoneMask=$("#cbkPhoneInput").attr("placeholder"),WBK.settings.smartToken=w.window.find("input[name='smart-token']").val();var isAllFilled=!0;if("required"===s.contactNameInput&&(isAllFilled=isAllFilled&&name),"none"!==s.contactNameInput&&0!==name.length&&(isAllFilled=isAllFilled&&name.length>=2),"required"===s.contactEmailInput&&(isAllFilled=isAllFilled&&email),isAllFilled=isAllFilled&&phone)if(phone=WBK.checkPhone(phone)){if(!$.fn._frameCheck()){var pattern=/\#callbackwidget\_(.*)/,custom_text=window.top.location.hash.match(pattern),custom_text_hash=!(!custom_text||!custom_text[1])&&decodeURI(custom_text[1]);custom_text_hash&&(s.use_custom_text_from_hash=custom_text_hash),window.top.location.hash=""}if(s.useDepartment){if(s.callToPhone=phone,s.callToPhoneIsDeferred=!1,!$.fn._frameCheck()){var re=/\#callbackwidget\-(.*)/,depart=window.top.location.hash.match(re),depart_hash=!(!depart||!depart[1])&&decodeURI(depart[1]);if(depart_hash){var call_depart_hash=!1;if($.each(s.departments,function(key){s.departments[key].department&&s.departments[key].department==depart_hash&&(call_depart_hash=!0)}),call_depart_hash)return WBK.settings.visitorName=name.charAt(0).toUpperCase()+name.substr(1,name.length-1),WBK.settings.visitorEmail=email,_this.callToPhone(s.callToPhone,depart_hash,"",_this.executeActionAfterRequest),void(window.top.location.hash="")}}$("#cbkDepartmentRadioButtons").empty().remove(),$("#cbkDepartment").empty().remove();var $tmpDepartmentsList=$('<select id="cbkDepartment" class="cbk-select"></select>'),$tmpDepartmentsRadioList=$('<div id="cbkDepartmentRadioButtons"></div>');$.each(s.departments,function(key){s.departments[key].department&&""!=s.departments[key].department&&s.departments.length<=4?$($tmpDepartmentsRadioList).append($('<div class="ws-radio-button" style="margin-top: 5px;"><input id="radio'+key+'" name="cbkDepartmentRadio"'+(0==key?' checked="" ':"")+'type="radio" class="radio" value="'+s.departments[key].department+'"><label for="radio'+key+'">'+s.departments[key].department+"</label></div>")):s.departments[key].department&&""!=s.departments[key].department&&s.departments.length>=4&&$($tmpDepartmentsList).append($("<option>").val(s.departments[key].department).text(s.departments[key].department))}),s.departments.length<=4?$(".cbk-departmentform .cbk-form-title").after($tmpDepartmentsRadioList):$(".cbk-departmentform .cbk-form-title").after($tmpDepartmentsList),w.window.find("div.cbk-form").hide();var depForm=w.window.find("div.cbk-departmentform");"none"!=s.timerType&&depForm.find("div.cbk-timer").show(),_this.setFormText(w.window.find("div.cbk-departmentform .cbk-form-title"),s.text.killerText[s.killerWorking].department[WBK.settings.hasVisitorName]),depForm.show(),WBK.animateOnce(depForm,"cbk-fadeIn",function(){"pc"==WBK.settings.device&&WBK.animateOnce(depForm.find("div.cbk-form-title"),"cbk-bounce")}),_this.onResizeWindow()}else WBK.settings.visitorName=name.charAt(0).toUpperCase()+name.substr(1,name.length-1),WBK.settings.visitorEmail=email,_this.callToPhone(phone,"","",_this.executeActionAfterRequest)}else _this.showError($("#cbkPhoneInput"),s.text.cbkErrorNoPhone);else("required"===s.contactNameInput&&!name||"none"!==s.contactNameInput&&0!==name.length&&name.length<2)&&_this.showError($("#cbkNameInput"),s.text.cbkErrorNoName),"required"!==s.contactEmailInput||email||_this.showError($("#cbkEmailInput"),s.text.cbkErrorNoEmail),phone||_this.showError($("#cbkPhoneInput"),s.text.cbkErrorNoPhone);return!1}),$("#cbkDepartmentBtn").click(function(e){_this.hideErorrs();var departmentValue=s.departments.length<=4?$('input[name="cbkDepartmentRadio"]:checked').val():$("#cbkDepartment").val();if(s.callToPhoneIsDeferred)_this.callToPhoneAt(s.callToPhone,$("#cbkCallDeferredTime option:selected").attr("data-date"),$("#cbkCallDeferredTime").val(),departmentValue);else{var name=$("#cbkNameInput").val();WBK.settings.visitorName=name.charAt(0).toUpperCase()+name.substr(1,name.length-1),WBK.settings.visitorEmail=$("#cbkEmailInput").val(),_this.callToPhone(s.callToPhone,departmentValue,"",_this.executeActionAfterRequest)}return e.preventDefault(),!1}),w.window.find("div.cbk-callform .cbk-button-no").click(function(e){_this.hideErorrs(),w.window.find("div.cbk-form").hide(),_this.checkWorkTime(),_this.setWorkDays(),w.window.find("div.cbk-cdform .cbk-form-title").html(s.text.cbkCallLaterTitle),_this.personalizeForms();var clForm=w.window.find("div.cbk-cdform");return clForm.show(),WBK.animateOnce(clForm,"cbk-fadeIn",function(){"pc"==WBK.settings.device&&WBK.animateOnce(clForm.find("div.cbk-form-title"),"cbk-bounce")}),w.window.find(".cbk-cdform .cbk-personal-agreement span").html(s.windowBtnTextOffline),_this.onResizeWindow(),_this.setPhoneInputFocus(),e.preventDefault(),!1}),$("#cbkPhoneDeferredBtn").click(function(e){_this.hideErorrs();var phone=$("#cbkPhoneDeferredInput").val();if(WBK.settings.phoneMask=$("#cbkPhoneDeferredInput").attr("placeholder"),WBK.settings.smartToken=w.window.find("input[name='smart-token']").val(),phone){if(phone=WBK.checkPhone(phone))if(s.useDepartment){s.callToPhone=phone,s.callToPhoneIsDeferred=!0,$("#cbkDepartmentRadioButtons").empty(),$("#cbkDepartment").remove();var $tmpDepartmentsList=$('<select id="cbkDepartment" class="cbk-select"></select>'),$tmpDepartmentsRadioList=$('<div id="cbkDepartmentRadioButtons"></div>');$.each(s.departments,function(key){s.departments[key].department&&""!=s.departments[key].department&&s.departments.length<=4?$($tmpDepartmentsRadioList).append($('<div class="ws-radio-button"><input id="radio'+key+'" name="cbkDepartmentRadio"'+(0==key?' checked="" ':"")+'type="radio" class="radio" value="'+s.departments[key].department+'"><label for="radio'+key+'">'+s.departments[key].department+"</label></div>")):s.departments[key].department&&""!=s.departments[key].department&&s.departments.length>=4&&$($tmpDepartmentsList).append($("<option>").val(s.departments[key].department).text(s.departments[key].department))}),s.departments.length<=4?$(".cbk-departmentform .cbk-form-title").after($tmpDepartmentsRadioList):$(".cbk-departmentform .cbk-form-title").after($tmpDepartmentsList),w.window.find("div.cbk-form").hide();var depForm=w.window.find("div.cbk-departmentform");depForm.find("div.cbk-timer").hide(),_this.setFormText(w.window.find("div.cbk-departmentform .cbk-form-title"),s.text.killerText[s.killerWorking].department[WBK.settings.hasVisitorName]),depForm.show(),WBK.animateOnce(depForm,"cbk-fadeIn",function(){"pc"==WBK.settings.device&&WBK.animateOnce(depForm.find("div.cbk-form-title"),"cbk-bounce")}),_this.onResizeWindow()}else _this.callToPhoneAt(phone,$("#cbkCallDeferredTime option:selected").attr("data-date"),$("#cbkCallDeferredTime").val())}else _this.showError($("#cbkPhoneDeferredInput"),s.text.cbkErrorNoPhone);return e.preventDefault(),!1}),w.window.find("div.cbk-crqform .cbk-button-yes").click(function(e){return _this.callAfterForm(!0),_this.onResizeWindow(),e.preventDefault(),!1}),w.window.find("div.cbk-crqform .cbk-button-no").click(function(e){w.window.find("div.cbk-form").hide(),_this.setFormText(wt[1].no_connect[WBK.settings.hasVisitorName]),_this.personalizeForms();var naForm=w.window.find("div.cbk-naform");return naForm.show(),WBK.animateOnce(naForm,"cbk-fadeIn",function(){"pc"==WBK.settings.device&&WBK.animateOnce(naForm.find("div.cbk-form-title"),"cbk-bounce")}),_this.onResizeWindow(),e.preventDefault(),!1}),_this.masksPhoneData.newMask?($("#cbkPhoneInput, #cbkPhoneDeferredInput").on("keydown",function(event){var input=event.currentTarget,inputKey=event.key;_this.masksPhoneData.pasted["#"+input.id]=!1;var value=$(input).val(),lengthDigits=value.length,ctrlV=(event.ctrlKey||event.metaKey)&&86===event.keyCode,ctrlA=(event.ctrlKey||event.metaKey)&&65===event.keyCode,ctrlX=(event.ctrlKey||event.metaKey)&&88===event.keyCode;if(!lengthDigits&&!_this.masksPhoneData.inited["#"+input.id]){if(!parseInt(inputKey)&&!ctrlV)return void event.prereventDefault(),_this.initInputMask(input);else if("9"===inputKey)$(input).val("7"),_this.initInputMask(input);else if(WBK.settings.phoneBasesCountries&&WBK.settings.phoneBasesCountries.indexOf(inputKey)==-1&&!ctrlV)return $(input).val(""),void event.preventDefault()}var txt="";txt=window.getSelection?window.getSelection().toString():document.selection.createRange().text,txt||(txt=input.value.substring(input.selectionStart,input.selectionEnd)),txt=txt.replace(/[^0-9]/g,"");var selectedEqualLength=txt&&txt.length===lengthDigits;selectedEqualLength&&("8"===inputKey?($(input).val("7"),wsUtil.setCaretPosition($(input),3,3),event.preventDefault()):"9"===inputKey&&($(input).val("7"),wsUtil.setCaretPosition($(input),3,3))),1!==lengthDigits&&!selectedEqualLength||"Control"==event.key||"Meta"==event.key||!_this.masksPhoneData.inited["#"+input.id]||"Backspace"!==inputKey&&!ctrlX||ctrlA||$("#cbkPhoneInput, #cbkPhoneDeferredInput").on("keyup",function(event){_this.masksPhoneData.pasted["#"+input.id]||_this.removeMask(input)})}),$("#cbkPhoneInput, #cbkPhoneDeferredInput").on("paste",function(event){var value,input=event.currentTarget;if(window.clipboardData&&window.clipboardData.getData?value=window.clipboardData.getData("Text"):event.originalEvent.clipboardData&&event.originalEvent.clipboardData.getData&&(value=event.originalEvent.clipboardData.getData("text")),value){var formattedValue=_this.formatNumberForRussia(value);if(!formattedValue)return void event.preventDefault();_this.masksPhoneData.pasted["#"+input.id]=!0,11===this.value.length?this.value=formattedValue:this.value+=formattedValue,_this.checkToInitInputMask(this,event)}})):(_this.initInputMask("#cbkPhoneInput"),_this.initInputMask("#cbkPhoneDeferredInput")),_this.initInputMask(".cbk-phone-checker",!0),$("#cbkPhoneInput").bind("keydown",function(e){13===e.keyCode&&$("#cbkPhoneBtn").click()}),$("#cbkPhoneDeferredInput").bind("keydown",function(e){13===e.keyCode&&$("#cbkPhoneDeferredBtn").click()}),$("#cbkCallDeferredDate").change(function(){var selectedDate=new Date;selectedDate.setTime(selectedDate.getTime()-1e3*s.timeDelta);var date=$(this).val().split("-");selectedDate.setYear(date[0]),selectedDate.setMonth(parseInt(date[1])-1),selectedDate.setDate(date[2]),_this.setWorkTimes(selectedDate),_this.setPhoneInputFocus()}),w.window.find(".cbk-ink-reaction").on("click",function(e){var color=_this.getBackground($(this)),inverse=_this.getLuma(color)>183?" inverse":"",ink=$('<div class="cbk-ink'+inverse+'"></div>'),btnOffset=$(this).offset(),xPos=e.pageX-btnOffset.left,yPos=e.pageY-btnOffset.top;ink.css({top:yPos,left:xPos}).appendTo($(this)),wsUtil.setTimeout("cbkInkReactionTimout",function(){ink.remove()},1500)}),WBK.settings.hideCopyright||"pc"!=WBK.settings.device||WBK.settings.thisIsCallbackKILLER||wsUtil.setInterval("animateCopyright",function(){WBK.animateOnce(w.window.find("a.cbk-copyright"),"cbk-tada")},1e3*s.timeouts.animateCopyright),$(window).on("resize.callbackkiller",function(){_this.onResizeWindow()}),$(window).on("scroll.callbackkiller",function(){_this.onScroll()}),wsUtil.deleteCookie("WhiteCallback_timePage"),WBK.pageIdentAdd(WBK.pageIdent),WBK.pageIdentGetMainPage()?WBK.pageIdentObserve():WBK.pageIdentSetMainPage(WBK.pageIdent),
"tablet"!=WBK.settings.device&&(s.noShowOnExit||$("body").mouseleave(function(e){var pos={x:e.pageX,y:e.pageY-$(document).scrollTop()};if(pos.y<=10){var showOnExitApperanceTimeout=s.showOnExitApperanceTimeout;if(s.showOnExitAlways&&(showOnExitApperanceTimeout=0),!WBK.settings.windowOpened&&!WBK.settings.windowGeneratorOpened&&!WBK.settings.videoWidgetOpened&&!WBK.settings.chatWindowOpened&&!WBK.settings.chatInvitationOpened&&!WBK.settings.windowLoanerOpened&&!WBK.settings.windowQuizOpened&&(1!=parseInt(wsGenerator.settings.showExit)||wsUtil.getCookie("WhiteGenerator_show_"+WBK.settings.generatorId)||wsUtil.getCookie("WhiteGenerator_success_closed_"+WBK.settings.generatorId)||wsUtil.getCookie("WhiteGenerator_closed_"+WBK.settings.generatorId))&&!wsUtil.getCookie("WhiteCallback_noShowOnExit")&&parseInt(wsUtil.getCookie("WhiteCallback_timePage"))>parseInt(showOutes(d.getMinutes()+144e3),wsUtil.setCookie("WhiteCallback_shownOn","onexit",d),_this.showWindow("exit")}showOnExitApperanceTimeout||wsUtil.deleteCookie("WhiteCallback_noShowWindow")}}),wsUtil.getCookie("WhiteCallback_noShowWindow")||s.noShowWindow||WBK.settings.chatWindowOpened||wsUtil.setTimeout("showWindowOnTimer",function(){if(!wsUtil.getCookie("WhiteCallback_noShowWindow")&&(wsUtil.getCookie("WhiteCallback_noShowOnExit")&&!s.showWindowReapperanceTimeout||!wsUtil.getCookie("WhiteCallback_noShowOnExit"))&&(_this.checkWorkTime(),!WBK.settings.windowOpened)){var d=new Date;d.setMinutes(d.getMinutes()+144e3),wsUtil.setCookie("WhiteCallback_shownOn","onshow",d),_this.showWindow("auto")}},1e3*s.showWindowApperanceTimeout),_this.checkWorkTime()),"pc"!=WBK.settings.device&&(w.btn.addClass("callbackkiller-mobile"),w.window.addClass("callbackkiller-mobile"),$(window).on("envy:resize",function(){_this.onResizeWindow()})),$("body").on("click.callbackwidget",'a[href="#callbackwidget"], a[href="'+window.top.location.origin+'#callbackwidget"], a[href="'+window.top.location.origin+'/#callbackwidget"], a[href="#callbackkiller"], a[href="'+window.top.location.origin+'#callbackkiller"], a[href="'+window.top.location.origin+'/#callbackkiller"]',function(e){return"extended_btn"==s.btnType&&"pc"==WBK.settings.device?w.extended_btn.click():w.btn.click(),e.preventDefault(),!1}),$("body").on("click.callbackwidget",'a[href="#callbackwidgetmodal"], a[href="'+window.top.location.origin+'#callbackwidgetmodal"], a[href="'+window.top.location.origin+'/#callbackwidgetmodal"], a[href="#callbackwidgetmodal"], a[href="'+window.top.location.origin+'#callbackkillermodal"], a[href="'+window.top.location.origin+'/#callbackkillermodal"]',function(e){var d=new Date;return d.setMinutes(d.getMinutes()+144e3),wsUtil.setCookie("WhiteCallback_shownOn","onbtn",d),_this.showWindow("modal"),e.preventDefault(),!1}),s.useDepartment&&Object.keys(s.departments).map(function(key,index){var v=s.departments[key];$("body").on("click.callbackwidget",'a[href="#callbackwidget-'+v.department+'"], a[href="'+window.top.location.origin+"#callbackwidget"+v.department+'"], a[href="'+window.top.location.origin+"/#callbackwidget"+v.department+'"]',function(e){return $.fn._frameCheck()||(window.location.hash="#callbackwidget-"+v.department),"extended_btn"==s.btnType&&"pc"==WBK.settings.device?w.extended_btn.click():w.btn.click(),e.preventDefault(),!1})}),$("body").on("click.callbackwidget",'a[href^="#callbackwidget_"], a[href^="'+window.top.location.origin+'#callbackwidget_"], a[href^="'+window.top.location.origin+'/#callbackwidget_"]',function(e){return $.fn._frameCheck()||(window.location.hash=$(this).attr("href")),"extended_btn"==s.btnType&&"pc"==WBK.settings.device?w.extended_btn.click():w.btn.click(),e.preventDefault(),!1}),$("body").keyup(function(e){WBK.settings.windowOpened&&27===e.keyCode&&_this.hideWindow()}),w.window.find("span.cbk-service-name").html(WBK.settings.servicename)},removeMask:function(input){$(input).val(""),$(input).inputmask("remove"),$(input).attr("placeholder",s.text.cbkPhoneInputPlaceholderText),this.masksPhoneData.inited["#"+input.id]=!1,$("#cbkPhoneInput, #cbkPhoneDeferredInput").off("keyup")},checkWorkTime:function(){if(s.killerWorkdays){var killerTime=new Date;killerTime.setTime(killerTime.getTime()-1e3*s.timeDelta+60*killerTime.getTimezoneOffset()*1e3+60*s.killerTimezone*60*1e3);var timeStartArray=s.killerWorkdays.time_start[s.currentDay].split(":"),timeEndArray=s.killerWorkdays.time_end[s.currentDay].split(":"),prevTimeStartArray=s.killerWorkdays.time_start[s.prevDay].split(":"),prevTimeEndArray=s.killerWorkdays.time_end[s.prevDay].split(":");if(s.killerIsPaused&&s.killerPausedStart&&s.killerPausedEnd){var pausedStartDateArray=s.killerPausedStart.split("."),pausedStartDate=new Date(parseInt(pausedStartDateArray[2]),parseInt(pausedStartDateArray[1])-1,parseInt(pausedStartDateArray[0]),killerTime.getHours(),killerTime.getMinutes(),killerTime.getSeconds());pausedStartDate.setTime(pausedStartDate.getTime()-1e3*s.timeDelta+60*killerTime.getTimezoneOffset()*1e3+60*s.killerTimezone*60*1e3);var pausedEndDateArray=s.killerPausedEnd.split("."),pausedEndDate=new Date(parseInt(pausedEndDateArray[2]),parseInt(pausedEndDateArray[1])-1,parseInt(pausedEndDateArray[0]),killerTime.getHours(),killerTime.getMinutes()+1,killerTime.getSeconds());pausedEndDate.setTime(pausedEndDate.getTime()-1e3*s.timeDelta+60*killerTime.getTimezoneOffset()*1e3+60*s.killerTimezone*60*1e3);var _kiilerTime=new Date(killerTime.getFullYear(),killerTime.getMonth(),killerTime.getDate()).valueOf(),_pausedStartDate=new Date(pausedStartDate.getFullYear(),pausedStartDate.getMonth(),pausedStartDate.getDate()).valueOf(),_pausedEndDate=new Date(pausedEndDate.getFullYear(),pausedEndDate.getMonth(),pausedEndDate.getDate()).valueOf();_kiilerTime>=_pausedStartDate&&_kiilerTime<=_pausedEndDate&&(s.killerIsPausedNow=!0)}if(s.killerWorkdays.workdays[s.currentDay]&&"false"!==s.killerWorkdays.workdays[s.currentDay]&&!s.killerIsPausedNow){var startTime=new Date(killerTime.getTime());startTime.setHours(timeStartArray[0]),startTime.setMinutes(timeStartArray[1]),startTime.setSeconds(0);var endTime=new Date(killerTime.getTime());if(endTime.setHours(timeEndArray[0]),parseInt(timeStartArray[0])>parseInt(timeEndArray[0])&&endTime.setHours(endTime.getHours()+24),endTime.setMinutes(timeEndArray[1]),endTime.setSeconds(0),parseInt(timeStartArray[0])===parseInt(timeEndArray[0])&&parseInt(timeStartArray[1])===parseInt(timeEndArray[1]))s.killerWorking=1;else if(killerTime>startTime)if(killerTime<endTime){s.killerWorking=1,s.killerWorkingToday=!0;var myTime=new Date,h=myTime.getHours(),gmt=myTime.getTimezoneOffset();h>=21&&gmt<-180&&(s.killerWorkingToday=!1)}else s.killerWorking=0,s.killerWorkingToday=!1;else s.killerWorking=0,s.killerWorkingToday=!0}else if(s.killerWorkdays.workdays[s.prevDay]&&"false"!==s.killerWorkdays.workdays[s.prevDay]&&parseInt(prevTimeEndArray[0])<parseInt(prevTimeStartArray[0])&&!s.killerIsPausedNow){var startTime=new Date(killerTime.getTime());startTime.setDate(startTime.getDate()-1),startTime.setHours(prevTimeStartArray[0]),startTime.setMinutes(prevTimeStartArray[1]),startTime.setSeconds(0);var endTime=new Date(killerTime.getTime());endTime.setDate(endTime.getDate()-1),endTime.setHours(prevTimeEndArray[0]),parseInt(prevTimeStartArray[0])>parseInt(prevTimeEndArray[0])&&endTime.setHours(endTime.getHours()+24),endTime.setMinutes(prevTimeEndArray[1]),endTime.setSeconds(0),parseInt(prevTimeStartArray[0])===parseInt(prevTimeEndArray[0])&&parseInt(prevTimeStartArray[1])===parseInt(prevTimeEndArray[1])?s.killerWorking=1:killerTime>startTime?killerTime<endTime?(s.killerWorking=1,s.killerWorkingToday=!0):(s.killerWorking=0,s.killerWorkingToday=!1):(s.killerWorking=0,s.killerWorkingToday=!0)}else s.killerWorkingToday=!1}else s.killerWorking=0,s.killerWorkingToday=!1},setWorkTimes:function(selectedDate){_this.checkWorkTime(),$("#cbkCallDeferredTime").empty();var currentDay=selectedDate.getDay()-1;currentDay<0&&(currentDay+=7);var myTime=new Date,now=new Date;now.setTime(now.getTime()-1e3*s.timeDelta+60*now.getTimezoneOffset()*1e3+60*s.killerTimezone*60*1e3);var timeStartArray=s.killerWorkdays.time_start[currentDay].split(":"),timeEndArray=s.killerWorkdays.time_end[currentDay].split(":");s.hourDelta=-now.getTimezoneOffset()/60-s.killerTimezone;var startTime=new Date(now.getTime());startTime.setHours(timeStartArray[0]);var equalDate=selectedDate.getDate()===now.getDate(),hours=startTime.getHours()+s.hourDelta;if(hours<0&&equalDate&&(hours=startTime.getHours()+hours*-1),startTime.setHours(hours),startTime.setMinutes(timeStartArray[1]),!Number.isInteger(s.hourDelta)&&s.hourDelta>0&&("30"===timeStartArray[1]?(hours=Math.round(hours),startTime.setHours(hours),startTime.setMinutes("00")):startTime.setMinutes("30")),!s.killerWorking&&s.shiftDayBeginning&&(startTime.setHours(startTime.getHours()+s.shiftDayBeginning),startTime.setMinutes(timeStartArray[1])),equalDate&&s.killerWorking){var myDate=myTime.getDate(),startDate=startTime.getDate();myDate<startDate&&startTime.setDate(myDate),startTime.setHours(myTime.getHours()+1),startTime.setMinutes(0)}startTime.setSeconds(0),selectedDate.setHours(startTime.getHours()),selectedDate.setMinutes(startTime.getMinutes()),selectedDate.setSeconds(0);var endTime=new Date(now.getTime());endTime.setHours(timeEndArray[0]),endTime.setHours(endTime.getHours()+s.hourDelta);var maxMinutesInHour=59;if(parseInt(timeStartArray[0])>parseInt(timeEndArray[0])?endTime.setHours(endTime.getHours()+24):parseInt(timeStartArray[0])===parseInt(timeEndArray[0])&&parseInt(timeEndArray[1])!==maxMinutesInHour&&endTime.setHours(endTime.getHours()+12),endTime.setMinutes(tigetDate()&&(endTime.setDate(startTime.getDate()),endTime.setHours(23)),startTime<endTime)for(;startTime<endTime;){var h=startTime.getHours(),m=startTime.getMinutes();h<10&&(h="0"+h),m<10&&(m="0"+m),$("#cbkCallDeferredTime").append($("<option>").val(h+":"+m).text(h+":"+m).attr("data-date",selectedDate.getFullYear()+"-"+(selectedDate.getMonth()+1)+"-"+selectedDate.getDate())),startTime.setHours(startTime.getHours()+1),selectedDate.setHours(selectedDate.getHours()+1),startTime.setMinutes(0),selectedDate.setMinutes(0),startTime<endTime||startTime>endTime||startTime.getTime()===endTime.getTime()||$("#cbkCallDeferredTime").append($("<option>").val(h+":30").text(h+":30").attr("data-date",selectedDate.getFullYear()+"-"+(selectedDate.getMonth()+1)+"-"+selectedDate.getDate()))}else{$("#cbkCallDeferredDate option:selected").remove();var selectedDate=new Date;selectedDate.setTime(selectedDate.getTime()-1e3*s.timeDelta);var selectedOption=$("#cbkCallDeferredDate option:selected");if(!selectedOption.length)return;var date=selectedOption.val().split("-");selectedDate.setYear(date[0]),selectedDate.setMonth(parseInt(date[1])-1),selectedDate.setDate(date[2]),_this.setWorkTimes(selectedDate)}},setWorkDays:function(){$("#cbkCallDeferredDate").empty();var dayNames={0:s.text.cbkMondayText,1:s.text.cbkTuesdayText,2:s.text.cbkWednesdayText,3:s.text.cbkThursdayText,4:s.text.cbkFridayText,5:s.text.cbkSaturdayText,6:s.text.cbkSundayText},now=new Date,currentDay=!1,dayDiff=!1,incrementDate=!1,lowerDate=!1;if(s.killerIsPaused&&s.killerPausedStart&&s.killerPausedEnd){var pausedStartDateArray=s.killerPausedStart.split("."),pausedStartDate=new Date(parseInt(pausedStartDateArray[2]),parseInt(pausedStartDateArray[1])-1,parseInt(pausedStartDateArray[0]),now.getHours(),now.getMinutes(),now.getSeconds());pausedStartDate.setTime(pausedStartDate.getTime()-1e3*s.timeDelta+60*now.getTimezoneOffset()*1e3+60*s.killerTimezone*60*1e3);var pausedEndDateArray=s.killerPausedEnd.split("."),pausedEndDate=new Date(parseInt(pausedEndDateArray[2]),parseInt(pausedEndDateArray[1])-1,parseInt(pausedEndDateArray[0]),now.getHours(),now.getMinutes()+1,now.getSeconds());pausedEndDate.setTime(pausedEndDate.getTime()-1e3*s.timeDelta+60*now.getTimezoneOffset()*1e3+60*s.killerTimezone*60*1e3),dayDiff=Math.round((pausedEndDate.getTime()-now.getTime())/864e5)}if(s.killerIsPausedNow)now.setTime(pausedEndDate.getTime()),currentDay=s.killerPausedDay;else{now.setTime(now.getTime()-1e3*s.timeDelta+60*now.getTimezoneOffset()*1e3+60*s.killerTimezone*60*1e3),currentDay=s.currentDay,dayDiff=0;var hourDelta=-now.getTimezoneOffset()/60-s.killerTimezone,hoursTest=new Date(now.getTime()).getHours()+hourDelta;hoursTest>=24&&(currentDay+=1,incrementDate=!0),hoursTest<-1&&(currentDay-=1,lowerDate=!0)}for(var firstWorkDate=!1,twoDayInc=2,threeDayInc=3,dateBetweenPauseDays=function(date){return date>=pausedStartDate&&date<pausedEndDate}.bind(this),day=0;day<4;day++){var checkDay=currentDay+day;checkDay>6&&(checkDay-=7);var checkDayDiff=!1;if((0===day&&s.killerWorkingToday||day>0)&&s.killerWorkdays.workdays[checkDay]&&"false"!==s.killerWorkdays.workdays[checkDay]){var date=new Date(now.getTime()),dayName=dayNames[checkDay],showOnlyDate=!1;if(6435==WBK.settings.killerId&&(showOnlyDate=!0),1===day){date=new Date(now.getTime()+864e5);var firstDate=date;s.killerIsPaused&&(dateBetweenPauseDays(date)?(date=new Date(pausedEndDate.getTime()+864e5),showOnlyDate=!0):(twoDayInc=1,threeDayInc=2)),firstWorkDate||(firstWorkDate=new Daty,dayName=checkDayDiff>6||showOnlyDate?date.getDate()+" "+WBK.settings.months[date.getMonth()]:dayNames[checkDay]}else if(2===day){date=new Date(now.getTime()+1728e5);var secondDate=date;s.killerIsPaused&&(firstDate&&dateBetweenPauseDays(firstDate)||dateBetweenPauseDays(date)?(firstDate||(twoDayInc-=1),date=new Date(pausedEndDate.getTime()+24*twoDayInc*60*60*1e3),showOnlyDate=!0):threeDayInc-=1),firstWorkDate&&!showOnlyDate||(firstWorkDate=new Date(date.getTime())),checkDayDiff=dayDiff+day,dayName=checkDayDiff>6||showOnlyDate?date.getDate()+" "+WBK.settings.months[date.getMonth()]:dayNames[checkDay]}else 3===day?(date=new Date(now.getTime()+2592e5),s.killerIsPaused&&(firstDate&&dateBetweenPauseDays(firstDate)||secondDate&&dateBetweenPauseDays(secondDate)||dateBetweenPauseDays(date))&&(firstDate||(threeDayInc-=1),secondDate||(threeDayInc-=.getTime()+24*threeDayInc*60*60*1e3),showOnlyDate=!0),firstWorkDate||(firstWorkDate=new Date(date.getTime())),checkDayDiff=dayDiff+day,dayName=checkDayDiff>6||showOnlyDate?date.getDate()+" "+WBK.settings.months[date.getMonth()]:dayNames[checkDay]):firstWorkDate||(firstWorkDate=new Date(now.getTime()));incrementDate&&date.setDate(date.getDate()+1),lowerDate&&date.setDate(date.getDate()-1);var dayValue=date.getFullYear()+"-"+(date.getMonth()+1)+"-"+date.getDate();$("#cbkCallDeferredDate").append($("<option>").val(dayValue).text(dayName))}}if(!firstWorkDate){date=new Date(now.getTime()+864e5),firstWorkDate=new Date(now.getTime()+864e5),dayName=dayNames[s.currentDay],incrementDate&&date.setDate(date.getDate()+1),lowerDate&&date.setDate(date.getDate()-1);var dayValue=date.getFullYear()+"-"+(date.getMonth()+1)+"-"+date.getDate();$("#cbkCallDeferredDate").append($("<option>").val(dayValue).text(dayName))}incrementDate&&firstWorkDate.setDate(firstWorkDate.getDate()+1),_this.setWorkTimes(firstWorkDate)},initKiller:function(){_this._initKiller(),wsUtil.setTimeout("cbkInitKilerTimout",function(){_this._initKiller()},3e3)},_initKiller:function(){if(WBK.settings.callbackEnabled&&s.killerFormCall){if("ru-mod.ru"===window.location.hostname&&"/emarket/cart/"===window.location.pathname)return!1;var formSelector='form:not(".callbackwidget-not-call-form")';2===s.killerFormCall&&(formSelector="form.callbackwidget-call-form, form.callbackkiller-call-form"),_debug&&console.log("Forms to check:"),_debug&&console.log($(document).find(formSelector)),$(document).find(formSelector).off("submit.cbk").on("submit.cbk",function(){_this.checkFormOnSubmit(this)});try{$(document).find("iframe").each(function(){var _iframe=this;try{_iframe.contentWindow&&_iframe.contentDocument&&(_debug&&console.log("Forms in frame to check:"),_debug&&console.log($(_iframe.contentWindow.document).find(formSelector)),$(_iframe.contentWindow.document).find(formSelector).off("submit.cbk").on("submit.cbk",function(){_this.checkFormOnSubmit(this)}))}catch(e){}})}catch(e){}}$(document).find("input, select").each(function(){var inputType=$(this).attr("type");"button"!==inputType&&"submit"!==inputType&&"radio"!==inputType&&"checkbox"!==inputType&&($(this).off("focus.callbackkiller").on("focus.callbackkiller",function(){s.noShowWindow=!0}),$(this).off("blur.callbackkiller").on("blur.callbackkiller",function(){s.noShowWindow=!1}))}),$(document).find("iframe").each(function(){var _iframe=this;try{_iframe.contentWindow&&_iframe.contentDocument&&$(_iframe.contentWindow.document).find("input, select").each(function(){var inputType=$(this).attr("type");"button"!==inputType&&"submit"!==inputType&&"radio"!==inputType&&"checkbox"!==inputType&&($(this).off("focus.callbackkiller").on("focus.callbackkiller",function(){s.noShowWindow=!0}),$(this).off("blur.callbackkiller").on("blur.callbackkiller",function(){s.noShowWindow=!1}))})}catch(e){}}),_this.startCheckNeedToCall()},checkFormOnSubmit:function(form){_debug&&console.log("Form submitted:"),_debug&&console.log($(form)),_this.checkWorkTime(),$(form).find("input").each(function(){var inputType=$(this).attr("type");if("button"!==inputType&&"submit"!==inputType&&"radio"!==inputType&&"checkbox"!==inputType&&"file"!==inputType&&"image"!==inputType&&"password"!==inputType&&"hidden"!==inputType){var phone=$(this).val();if(WBK.settings.phoneMask="+_(___)___-__-__",phone){var phone=WBK.checkPhone($(this).val());if(phone){var d=new Date;d.setMinutes(d.getMinutes()+144e3),wsUtil.setCookie("WhiteCallback_shownOn","onform",d);var name=$(form).find("input.callbackwidget-name").val(),email=$(form).find("input.callbackwidget-email").val(),departmentElement=$(form).find(".callbackwidget-department"),department=!1;if(s.useDepartment&&departmentElement.length)switch(departmentElement.attr("type")){case"radio":case"checkbox":department=$(form).find(".callbackwidget-department:checked").val();break;default:department=departmentElement.val()}""==name&&""==email||WBK.setVisitorData({name:name,email:email}),WBK.settings.phoneMask=$(".cbk-phone-checker:first").attr("placeholder"),wsUtil.setCookie("WhiteCallback_needcall",!0),wsUtil.setCookie("WhiteCallback_needcall_phone",phone),department&&wsUtil.setCookie("WhiteCallback_needcall_department",department)}}}})},startCheckNeedToCall:function(){_this.checkNeedToCall(),wsUtil.setInterval("checkNeedToCall",function(){_this.checkNeedToCall()},1e3*s.timeouts.needToCall)},checkNeedToCall:function(){if(wsUtil.getCookie("WhiteCallback_needcall")){_this.checkWorkTime();var phone=wsUtil.getCookie("WhiteCallback_needcall_phone"),department=wsUtil.getCookie("WhiteCallback_needcall_department");if(s.killerWorking){if(s.killerFormCallHide){if(s.showWindowReapperanceTimeout){var d=new Date;d.setDate(d.getDate()+parseInt(s.showWindowReapperanceTimeout)),wsUtil.setCookie("WhiteCallback_noShowWindow",1,d)}else wsUtil.setCookie("WhiteCallback_noShowWindow",1);var d=new Date;s.showOnExitAlways?d.setSeconds(d.getSeconds()+3):d.setMinutes(d.getMinutes()+parseteCallback_noShowOnExit",1,d)}else _this.showWindow("auto");if(s.callingFromForm=!0,_this.setWorkDays(),$("#cbkPhoneInput").val(phone),s.phoneMask=$("#cbkPhoneInput").attr("placeholder"),wsUtil.deleteCookie("WhiteCallback_needcall"),wsUtil.deleteCookie("WhiteCallback_needcall_phone"),wsUtil.deleteCookie("WhiteCallback_needcall_department"),s.auto_call_deffered&&s.auto_call_deffered_delay_value){var d=new Date;d.setMinutes(d.getMinutes()+s.auto_call_deffered_delay_value),_this.deferredCall(phone,d.getFullYear()+"-"+((d.getMonth()+1<10?"0":"")+(d.getMonth()+1))+"-"+(d.getDate()<10?"0":"")+d.getDate(),(d.getHours()<10?"0":"")+d.getHours()+":"+(d.getMinutes()<10?"0":"")+d.getMinutes(),department),"onform"==wsUtil.getCookie("WhiteCallback_shownOn")&&38835==WBK.settings.siteId?(_this.sendGoal("form"),_this.sendGoal("form")):_this.sendGoal("call")}else _this.callToPhone(phone,department)}else _this.setWorkDays(),_this.deferredCall(phone,$("#cbkCallDeferredTime option:first").attr("data-date"),$("#cbkCallDeferredTime option:first").text(),department),wsUtil.deleteCookie("WhiteCallback_needcall"),wsUtil.deleteCookie("WhiteCallback_needcall_phone"),wsUtil.deleteCookie("WhiteCallback_needcall_department"),"onform"==wsUtil.getCookie("WhiteCallback_shownOn")&&38835==WBK.settings.siteId?_this.sendGoal("form"):_this.sendGoal("call")}},callAfterForm:function(no_rating){if(s.managerRatingCheck&&no_rating){_this.initRating(),w.window.find("div.cbk-form").hide();var crqForm=w.window.find("div.cbk-ratingform");crqForm.show(),WBK.animateOnce(crqForm,"cbk-fadeIn",function(){"pc"==WBK.settings.device&&WBK.animateOnce(crqForm.find("div.cbk-form-title"),"cbk-bounce")})}else _this.congratulationsForm()},congratulationsForm:function(){w.window.find("div.cbk-form").hide();var shs.killerHasMoney;!killerHasMoneyType&&s.killerIsPayed&&s.killerCallOff&&(killerHasMoneyType=1);var title=s.text.cbkShareTitle[s.killerWorking][killerHasMoneyType][WBK.settings.hasVisitorName];!s.killerCallOff&&"hide"==s.timerType&&s.calling&&(title=s.text.cbkCallTitleOnHideTimer),w.window.find("div.cbk-shareform .cbk-form-title").html(title),_this.personalizeForms(),w.window.find(".cbk-form-title").show(),shareForm.show(),WBK.animateOnce(shareForm,"cbk-fadeIn",function(){"pc"==WBK.settings.device&&WBK.animateOnce(shareForm.find("div.cbk-form-title"),"cbk-bounce")}),_this.onResizeWindow()},initRating:function(){var ratingObj=w.window.find("ul.cbk-call-rating");ratingObj.find("a").unbind("mouseenter.callbackkiller").unbind("mouseleave.callbackkiller").unbind("click.callbackkiller").removeClass("cbk-marked"),ratingObj.find("a").on("mouseenter.callbackkiller",function(){for(var value=$(this).data("value"),i=1;i<=value;i++)$("#cbkRating"+i).addClass("cbk-marked")}).on("mouseleave.callbackkiller",function(){ratingObj.find("a").removeClass("cbk-marked")}).on("click.callbackkiller",function(e){var url=WBK.settings.serverUrl+"/api?action=rating&callback=?",value=$(this).data("value");return jWS.getJSON(url,{code:WBK.settings.whiteSaasCode,rating:value,callId:s.callId,killerId:WBK.settings.killerId,visitorId:WBK.settings.visitorId},function(result){}),_this.callAfterForm(!1),_this.onResizeWindow(),e.preventDefault(),!1})},personalizeForms:function(){var _this=this,time=s.callTimeout+"&nbsp;"+wsUtil.doEnding(s.callTimeout,s.text.cbkSecond1,s.text.cbkSecond2,s.text.cbkSecond3);w.window.find("div.cbk-form-title").each(function(){$(this).html($(this).html().replace(/\[time\]/g,time))}),WBK.settings.visitorPhone?($("#cbkPhoneInput").val(WBK.settings.visitorPhone),$("#cbkPhoneDeferredInput").val(WBK.settings.visitorPhone),_this.masksPhoneData.newMask&&(_this.initInputMask("#cbkPhoneInput"),_this.initInputMask("#cbkPhoneDeferredInput"))):_this.masksPhoneData.newMask&&$("#cbkPhoneInput, #cbkPhoneDeferredInput").attr("placeholder",s.text.cbkPhoneInputPlaceholderText),WBK.settings.visitorEmail&&$("#cbkEmailInput").val(WBK.settings.visitorEmail),WBK.settings.visitorName?(w.window.find("span.cbk-visitor-name").replaceWith($("<a>").bk-button-no-dark").attr("href","javascript:void(0)").html(WBK.settings.visitorName)),w.window.find(".cbk-visitor-name-no-link").text(WBK.settings.visitorName),$("#cbkNameInput").val(WBK.settings.visitorName),w.window.find("div.cbk-form-title").each(function(){$(this).html($(this).html().replace(/\[name\]/g,"<a href='javascript:void(0)' class='cbk-change-name cbk-button-no cbk-button-no-dark'>"+WBK.settings.visitorName+"</a>"))})):(w.window.find(".cbk-visitor-name-to-delete").remove(),w.window.find("div.cbk-form-title").each(function(){$(this).html($(this).html().replace("[name]",""))})),w.window.find("a.cbk-copyright").attr("href",s.cbkLink),w.window.find("a.cbk-agreement-link").attr("href",s.agreementLink),WBK.settings.thisIsCallbackKILLER&&w.window.find("a.cbk-copyright").addClass("cbk-copyright-callbackkiller").html(s.text.cbkCopyrightEnvybox)},setPhoneInputFocus:function(){var id="cbkPhoneInput",caretArrayBegin4=[77,38,39,44,48],caretArrayBegin5=[380,358,992,375,373,972,971];$("div.cbk-cdform:visible").length&&(id="cbkPhoneDeferredInput"),"pc"===WBK.settings.device&&$("#"+id).focus(),$("#"+id).val()||s.calling||(""!==WBK.settings.phoneBase?(_this.masksPhoneData.newMask||$("#"+id).val(WBK.settings.phoneBase),"pc"==WBK.settings.device&&(_this.masksPhoneData.newMask||(7===WBK.settings.phoneBase&&wsUtil.setCaretPosition($("#"+id),3,3),caretArrayBegin5.includes(WBK.settings.phoneBase)&&wsUtil.setCaretPosition($("#"+id),5,5),caretArrayBegin4.includes(WBK.settings.phoneBase)&&wsUtil.setCaretPosition($("#"+id),4,4)))):"pc"!=WBK.settings.device||_this.masksPhoneData.newMask||wsUtil.setCaretPosition($("#"+id),2,2)),"pc"!=WBK.settings.device&&(_this.masksPhoneData.newMask||$("#"+id).off("focus.caretPosition").on("focus.caretPosition",function(){!s.calling&&$("#"+id).val().length<4&&(""!==WBK.settings.phoneBase?($("#"+id).val(WBK.settings.phoneBase),7===WBK.settings.phoneBase&&wsUtil.setCaretPosition($("#"+id),3,3),caretArrayBegin4.includes(WBK.settings.phoneBase)&&wsUtil.setCaretPosition($("#"+id),4,4),caretArrayBegin5.includes(WBK.settings.phoneBase)&&wsUtil.setCaretPosition($("#"+id),5,5)):wsUtil.setCaretPosition($("#"+id),2,2))}),(s.killerLogo||"required"==s.contactNameInput&&"required"==s.contactEmailInput||navigator.userAgent.match(/iPad|iPhone/gi))&&_this.animateToInput(id),$(window).off("orientationchange.cbkWindow").on("orientationchange.cbkWindow",function(){setTimeout(function(){window.innerWidth>window.innerHeight&&(s.killerLogo||"required"==s.contactNameInput&&"required"==s.contactEmailInput)&&_this.animateToInput(id)},500,id)}),!s.calling&&$("#"+id).val().length<4&&$("#"+id).focus())},getCheckerPhoneMask:function(){var phoneCheckerElement=w.window.find(".cbk-phone-checker:first");phoneCheckerElement.length&&(WBK.settings.phoneMask=phoneCheckerElement.attr("placeholder"))},setFormText:function(obj,killerText){obj.html(_this.formatText(killerText))},formatText:function(killerText){var title=WBK.replaceTagVariant(killerText.title);title=WBK.replaceGetParamText(title);var text=WBK.replaceTagVariant(killerText.text);return text=WBK.replaceGetParamText(text),WBK.settings.geoCity&&(WBK.settings.geoCity.name||(WBK.settings.geoCity.name=WBK.settings.geoCity.ip_city),title&&(title=title.replace(/\[geocity1\]/g,WBK.settings.geoCity.name).replace(/\[geocity2\]/g,WBK.settings.geoCity.name_rod).replace(/\[geocity3\]/g,WBK.settings.geoCity.name_mes).replace(/\[geocity4\]/g,WBK.settings.geoCity.name_vin)),text&&(text=text.replace(/\[geocity1\]/g,WBK.settings.geoCity.name).replace(/\[geocity2\]/g,WBK.settings.geoCity.name_rod).replace(/\[geocity3\]/g,WBK.settings.geoCity.name_mes).replace(/\[geocity4\]/g,WBK.settings.geoCity.name_vin))),title=title.replace(/\[name\]/g,WBK.settings.visitorName),text=text.replace(/\[name\]/g,WBK.settings.visitorName),killerText.title&&killerText.text?title=title+"<br/><small>"+text+"</small>":!killerText.t(type){if(s.killerIsPayed){var yaGoal,gaGoal,yagla=!1,gaCategory="CallbackWidget",facebook=!1;switch(WBK.settings.thisIsCallbackKILLER&&(gaCategory="CallbackKILLER"),type){case"call":yaGoal=WBK.settings.thisIsCallbackKILLER?"CBK_CALL":"CBW_CALL",gaGoal="NewCall",yagla="callback",facebook="NewCall",wsUtil.sendUniversalGoal();break;case"showonbtn":yaGoal=WBK.settings.thisIsCallbackKILLER?"CBK_SHOW_ON_BTN":"CBW_SHOW_ON_BTN",gaGoal="ShowOnBtn";break;case"showauto":yaGoal=WBK.settings.thisIsCallbackKILLER?"CBK_SHOW_AUTO":"CBW_SHOW_AUTO",gaGoal="ShowAuto";break;case"showonexit":yaGoal=WBK.settings.thisIsCallbackKILLER?"CBK_SHOW_ON_EXIT":"CBW_SHOW_ON_EXIT",gaGoal="ShowOnExit";break;case"form":yaGoal=WBK.settings.thisIsCallbackKILLER?"CBK_CALL_ON_FORM":"CBW_CALL_ON_FORM",gaGoal="NewCallOnForm",wsUtil.sendUniversalGoal()}wsUtil.sendGoal(yaGoal,gaGoal,gaCategory,yagla,facebook)}},callToPhone:function(phone,department,customtext,callback){if(s.use_custom_text_from_hash&&(customtext=s.use_custom_text_from_hash,s.use_custom_text_from_hash=!1),phone=WBK.checkPhone(phone),_this.getCheckerPhoneMask(),phone&&!s.calling){s.calling=!0,s.callStarted=!0,$("#cbkPhoneBtn, .cbk-personal-agreement").css("display","none");var callParam={phone:phone,name:WBK.settings.visitorName?WBK.settings.visitorName.trim():"",email:WBK.settings.visitorEmail,department:department?department:"",customtext:customtext?customtext:$('meta[name="callbackkiller:customtext"]').length?$('meta[name="callbackkiller:customtext"]').attr("content"):"",phoneMask:WBK.settings.phoneMask,shownOn:wsUtil.getCookie("WhiteCallback_shownOn"),url:"string"==typeof document.URL?document.URL:"",device:WBK.settings.device,code:WBK.settings.whiteSaasCode,visitorId:WBK.settings.visitorId,visitId:WBK.settings.visitId,googleClientId:wsUtil.getGoogleClientId(),killerId:WBK.settings.killerId,generatorId:WBK.settings.generatorId,quizId:WBK.settings.quizId,invader_id:WBK.settings.invaderId,invaderStatId:WBK.settings.invaderCallbackStatId,instinct_id:WBK.settings.instinctId,instinctStatId:WBK.settings.instinctCallbackStatId,generatorLeadId:WBK.settings.genLeadId,roistatPromo:wsUtil.getRoistatPromo(),advertiseId:wsUtil.getAdvertiseId(),calltrackingId:wsUtil.getCalltrackingId(),lpgeneratorId:wsUtil.getLPGeneratorId(),leadvertexId:wsUtil.getLeadvertexId(),externalParams:wsUtil.getExternalParams(),checkCaptcha:WBK.settings.checkCaptcha,smartToken:WBK.settings.smartToken},url=WBK.settings.serverUrl+"/api?action=call";$.post(url,callParam,function(result){"function"==typeof window.ws_OnCallbackOnlineCall&&window.ws_OnCallbackOnlineCall(callParam),s.callingWidget=!1,WBK.settings.genLeadId=!1,WBK.settings.visitorPhone=phone,WBK.settings.called=!0,_this.onCall(result,callParam),"undefined"!=typeof callback&&callback(result)},"json")}},executeActionAfterRequest:function(result){result.Success&&!result.Errors&&_this.executeActionAfterCall()},executeActionAfterCall:function(){if(s.killerSendAction&&"none"!==s.killerSendAction)switch(s.killerSendAction){case"go_url":if(s.killerSendActionUrl){var match=wsUtil.parseURL(s.killerSendActionUrl);switch(match.scheme||(s.killerSendActionUrl="http://"+s.killerSendActionUrl),s.killerPageOpenType){case"new_page":window.open(s.killerSendActionUrl,"_blank");break;case"current":window.location.href=s.killerSendActionUrl}}break;case"go_javascript":s.killerSendActionJavascript&&eval(s.killerSendActionJavascript)}},onCapcha:function(result){WBK.settings.checkCaptcha=!0,window.smartCaptcha?window.smartCaptcha.reset():wsUtil.getScript("https://smartcaptcha.yandexcloud.net/captcha.js",function(){var data={sitekey:result.key,hl:"ru"};if(window.smartCaptcha){const container=w.window.find("#cbk-captcha-container")[0];window.smartCaptcha.render(container,data)}}),w.window.find("#cbk-captcha-container").show()},onCall:function(result,callParam){if(result.Success||!result.Errors||s.callingFromForm){if(result.Success&&result.Data.noWorkTime&&!s.callingFromForm)result.Data.killerWorkdays&&(s.killerWorkdays=result.Data.killerWorkdays),result.Data.killerIsPaused&&(s.killerIsPaused=result.Data.killerIsPaused),result.Data.killerPausedStart&&(s.killerPausedStart=result.Data.killerPausedStart),result.Data.killerPausedEnd&&(s.killerPausedEnd=result.Data.killerPausedEnd),result.Data.killerPausedDay&&(s.killerPausedDay=result.Data.killerPausedDay),s.calling=!1,s.callStarted=!1,_this.showWindow("auto",!0);else if(result.Success&&result.Data.callId){if(WBK.settings.checkCaptcha=!1,w.window.find("#cbk-captcha-container").hide(),s.callingFromForm&&(s.killerFormCallHide||_this.showWindow("auto",!1),
w.window.find("div.cbk-callform .cbk-form-title").html(s.text.cbkCallTitleOnFormCall),$("#cbkPhoneBtn").hide()),result.Data.callId){s.callId=result.Data.callId;var d=new Date;d.setMinutes(d.getMinutes()+15),wsUtil.setCookie("WhiteCallback_callId",s.callId,d),WBK.initSocket()}if(s.killerHasMoney)if(parseInt(result.Data.callOff))_this.congratulationsForm(),s.calling=!1,s.callStarted=!1;else{if(!w.window.find("div.cbk-callform:visible").length){w.window.find("div.cbk-form").hide();var callForm=w.window.find("div.cbk-callform");callForm.show()}w.window.find("div.cbk-callform .cbk-link-btn .cbk-button-no").hide(),w.window.find(".cbk-form-title").hide(),w.window.find(".cbk-window-logo").hide(),w.window.find("#cbkNameInput").attr("style","display: none!important"),w.window.find("#cbkEmailInput").attr("style","display: none!important"),w.window.find("#cbkPhoneInput").attr("style","display: none!important"),w.window.find(".cbk-timer").addClass("call"),s.calling=!0,"hide"==s.timerType?_this.callAfterForm(!0):(w.window.find(".cbk-text-after-call").show(),wsUtil.setInterval("callTimerAnimation",function(){var htmlSec=w.window.find("div.cbk-callform .cbk-timer .cbk-number-sec"),htmlMSec=w.window.find("div.cbk-callform .cbk-timer .cbk-number-msec"),sec=parseInt(htmlSec.text()),msec=parseInt(htmlMSec.text());if(msec--,msec<1&&(sec--,msec=99),sec<1){wsUtil.deleteInterval("callTimerAnimation"),s.calling=!1,w.window.find(".cbk-timer").removeClass("call"),w.window.find(".cbk-window-logo").show(),w.window.find(".cbk-text-after-call").hide(),w.window.find(".cbk-form-title").show(),w.window.find("#cbkPhoneInput").attr("style","display: inline-block!important"),w.window.find("div.cbk-form").hide();var crqForm=w.window.find("div.cbk-crqform");crqForm.show(),WBK.animateOnce(crqForm,"cbk-fadeIn",function(){"pc"==WBK.settings.device&&WBK.animateOnce(crqForm.find("div.cbk-form-title"),"cbk-bounce")}),_this.onResizeWindow(),msec=0,sec=0}sec<10&&(sec="0"+sec),msec<10&&(msec="0"+msec),htmlSec.text(sec),htmlMSec.text(msec)},10))}else _this.congratulationsForm();"onform"!=wsUtil.getCookie("WhiteCallback_shownOn")||38835!=WBK.settings.siteId&&53201!=WBK.settings.siteId&&19381!=WBK.settings.siteId&&38333!=WBK.settings.siteId&&31073!=WBK.settings.siteId?_this.sendGoal("call"):_this.sendGoal("form")}}else s.useDepartment&&_this.showError($(s.departments.length<=4?"#cbkDepartmentRadioButtons":"#cbkDepartment"),result.Errors[0]),s.calling?(_this.showError($("#cbkPhoneInput"),result.Errors[0]),result.captcha&&_this.onCapcha(result)):_this.showError($("#cbkPhoneDeferredInput"),result.Errors[0]),s.calling=!1,s.callStarted=!1},newCall:function(phone,immediately,deffered,defferedDelay){if(phone=WBK.checkPhone(phone),phone&&!s.calling){var vName,vEmail;if($(".callbackwidget-name").each(function(){$(this).val()&&(vName=$(this).val())}),$(".callbackwidget-email").each(function(){$(this).val()&&(vEmail=$(this).val())}),(vName||vEmail)&&WBK.setVisitorData({name:vName,email:vEmail,phone:phone}),WBK.settings.phoneMask=w.window.find(".cbk-phone-checker:first").attr("placeholder"),_this.setWorkDays(),s.killerWorking||immediately)if(deffered&&defferedDelay){var d=new Date;d.setMinutes(d.getMinutes()+defferedDelay),_this.deferredCall(phone,d.getFullYear()+"-"+((d.getMonth()+1<10?"0":"")+(d.getMonth()+1))+"-"+(d.getDate()<10?"0":"")+d.getDate(),(d.getHours()<10?"0":"")+d.getHours()+":"+(d.getMinutes()<10?"0":"")+d.getMinutes()),_this.sendGoal("call")}else _this.callToPhone(phone);else _this.deferredCall(phone,$("#cbkCallDeferredTime option:first").attr("data-date"),$("#cbkCallDeferredTime option:first").text()),_this.sendGoal("call")}},callToPhoneAt:function(phone,date,time,department,customtext){phone=WBK.checkPhone(phone),phone&&(s.callStarted=!0,_this.deferredCall(phone,date,time,department,customtext,function(result){if(!result.Success&&result.Errors)_this.showError($("#cbkPhoneDeferredInput"),result.Errors[0]),result.captcha&&_this.onCapcha(result),s.calling=!1;else if(result.Success){if(WBK.settings.checkCaptcha=!1,w.window.find("#cbk-captcha-container").hide(),result.Data.callId){s.callId=result.Data.callId;var d=new Date;d.setMinutes(d.getMinutes()+15),wsUtil.setCookie("WhiteCallback_callId",s.callId,d)}_this.congratulationsForm(),_this.onResizeWindow(),_this.executeActionAfterCall(),"onform"==wsUtil.getCookie("WhiteCallback_shownOn")&&38835==WBK.settings.siteId?_this.sendGoal("form"):_this.sendGoal("call")}}))},deferredCall:function(phone,date,time,department,customtext,callback){var _this=this;if(phone=WBK.checkPhone(phone),_this.getCheckerPhoneMask(),phone){var callParam={phone:phone,department:department?department:"",customtext:customtext?customtext:$('meta[name="callbackkiller:customtext"]').length?$('meta[name="callbackkiller:customtext"]').attr("content"):"",phoneMask:WBK.settings.phoneMask,shownOn:wsUtil.getCookie("WhiteCallback_shownOn"),url:"string"==typeof document.URL?document.URL:"",device:WBK.settings.device,code:WBK.settings.whiteSaasCode,visitorId:WBK.settings.visitorId,visitId:WBK.settings.visitId,googleClientId:wsUtil.getGoogleClientId(),killerWorking:s.killerWorking,hourDelta:s.hourDelta,date:date,time:time,killerId:WBK.settings.killerId,generatorId:WBK.settings.generatorId,quizId:WBK.settings.quizId,generatorLeadId:WBK.settings.genLeadId,invader_id:WBK.settings.invaderId,invaderStatId:WBK.settings.invaderCallbackStatId,instinct_id:WBK.settings.instinctId,instinctStatId:WBK.settings.instinctCallbackStatId,roistatPromo:wsUtil.getRoistatPromo(),advertiseId:wsUtil.getAdvertiseId(),calltrackingId:wsUtil.getCalltrackingId(),lpgeneratorId:wsUtil.getLPGeneratorId(),leadvertexId:wsUtil.getLeadvertexId(),externalParams:wsUtil.getExternalParams(),checkCaptcha:WBK.settings.checkCaptcha,smartToken:WBK.settings.smartToken},url=WBK.settings.serverUrl+"/api?action=calldeferred";jWS.post(url,callParam,function(result){"function"==typeof window.ws_OnCallbackDeferredCall&&window.ws_OnCallbackDeferredCall(callParam),"undefined"!=typeof callback&&callback(result),WBK.settings.genLeadId=!1,WBK.settings.called=!0},"json")}},onCallStatus:function(data){if(parseInt(data.site_id)===WBK.settings.siteId&&parseInt(data.call_id)===parseInt(s.callId))if(1===parseInt(data.call_status)&&"hide"!=s.timerType){if(WBK.settings.windowOpened||(!s.callingFromForm||s.callingFromForm&&!s.killerFormCallHide)&&_this.showWindow("auto"),w.window.find("div.cbk-callform").is(":visible")&&(w.window.find("div.cbk-callform .cbk-form-title").html(s.text.cbkCallTitleCalling),w.window.find(".cbk-text-after-call").hide(),w.window.find(".cbk-form-title").show(),_this.personalizeForms(),"pc"==WBK.settings.device)){var callForm=w.window.find("div.cbk-callform");WBK.animateOnce(callForm.find("div.cbk-form-title"),"cbk-bounce")}}else if(2===parseInt(data.call_status))w.window.find(".cbk-form-title").show(),WBK.settings.windowOpened||(!s.callingFromForm||s.callingFromForm&&!s.killerFormCallHide)&&_this.showWindow("auto"),wsUtil.deleteInterval("callTimerAnimation"),s.calling=!1,_this.callAfterForm(!0),_this.onResizeWindow();else if(4===parseInt(data.call_status)){w.window.find(".cbk-text-after-call").hide(),w.window.find(".cbk-form-title").show(),WBK.settings.windowOpened||(!s.callingFromForm||s.callingFromForm&&!s.killerFormCallHide)&&_this.showWindow("auto"),wsUtil.deleteInterval("callTimerAnimation"),w.window.find(".cbk-timer").hide(),s.calling=!1,w.window.find("div.cbk-form").hide();var callForm=w.window.find("div.cbk-callform");WBK.settings.hasVisitorName?callForm.find("div.cbk-form-title").html(s.text.cbkCallTitleFail[1][1]):callForm.find("div.cbk-form-title").html(s.text.cbkCallTitleFail[1][0]),_this.personalizeForms(),callForm.show(),"pc"==WBK.settings.device&&WBK.animateOnce(callForm.find("div.cbk-form-title"),"cbk-bounce")}},setDefaultText:function(){s.text={cbkBtnTitle:"Закажите звонок",cbkCopyright:"Хочу <span class='cbk-service-name'></span> на свой сайт",cbkCopyrightEnvybox:"<span class='ws-copyright-text'>Сделано в </span><img class='ws-copyright-img' src='"+WBK.settings.staticServerUrl+"/img/logo/envybox_widget.png'>",cbkCallTitleCalling:"<span class='cbk-visitor-name'>Мы</span><span class='cbk-visitor-name-to-delete'>, мы</span> уже звоним Вам, возьмите трубку!",cbkCallTitleNoTariff:"Здравствуйте<span class='cbk-visitor-name-to-delete'>, </span><span class='cbk-visitor-name'></span>!<br/>Оставьте номер, и мы Вам перезвоним!",cbkCallTitleNoTariffOnExit:"<span class='cbk-visitor-name'>Не</span><span class='cbk-visitor-name-to-delete'>, не</span> нашли что искали? Оставьте номер, и мы Вам перезвоним!",cbkCallTitleOnFormCall:"Спасибо!<br/><small>Мы сейчас с Вами свяжемся!</small>",cbkCallTitleOnHideTimer:"Спасибо за заказ звонка,<br/><small> мы свяжемся с Вами в ближайшее время!</small>",cbkDepartmentTitle:{0:{0:"Выберите с кем хотите связаться:",1:"[name], выберите с кем хотите связаться:"},1:{0:"Выберите с кем хотите связаться:",1:"[name], выберите с кем хотите связаться:"}},cbkCallTitleFail:{1:{0:"Выберите с кем хотите связаться:",1:"Мы не можем до вас дозвониться [name], давайте проверим ваш номер!"}},cbkPhoneInputPlaceholderText:"Введите телефон",cbkDepartmentBtnTitle:"Жду звонка!",cbkPhoneBtnTitle:"Позвоните мне!",cbkPhoneDeferredBtnTitle:"Жду звонка!",cbkSelectTimeIn:"в",cbkCallLaterBtnTitle:"Выбрать удобное время звонка",cbkCallResultQuestionTitle:"<span class='cbk-visitor-name'>Скажите</span>,<br/><small>Вам удалось начать разговор с менеджером?</small>",cbkAfterCall:"Ждите звонка",cbkYes:"Да",cbkNo:"Нет",cbkRatingTitle:"Оцените<br/><small>на сколько Вам понравилось общение с менеджером</small>",cbkSendCallToEmailTitle:"<span class='cbk-visitor-name'>Спасибо</span>,<br/><small>учтем оценку. Еще могу выслать Вам на email запись этого разговора через <span class='cbk-service-name'>"+WBK.settings.servicename+"</span>.</small>",cbkSendCallToEmailTitle2:"<span class='cbk-visitor-name'>Еще могу</span><span class='cbk-visitor-name-to-delete'>,</span><br/><small><span class='cbk-visitor-name-to-delete'>еще могу </span>выслать Вам на email запись этого разговора через <span class='cbk-service-name'>"+WBK.settings.servicename+"</span>.</small>",cbkEmailPlaceholder:"Введите email",cbkSendEmail:"Получить аудиозапись!",cbkNoThanks:"Нет, спасибо",cbkGetNameTitle:"Учтем оценку.<br/><small>Хотите в следующий раз мы будем обращаться к Вам по имени?</small>",cbkGetNameTitle2:"Хорошо,<br/><small>хотите в следующий раз мы будем обращаться к Вам по имени?</small>",cbkGetNameTitle3:"<span class='cbk-visitor-name-no-link'></span>,<br/><small>если вы не <span class='cbk-visitor-name-no-link'></span>, а представились шутливым именем, тогда укажите настоящее имя :)</small>",cbkGetNamePlaceholder:"Введите имя",cbkAgreementPersonalData:"Нажимая на кнопку \"<span>Позвоните мне</span>\", я даю свое согласие на обработку персональных данных и принимаю <a href='' class='cbk-agreement-link' target='_blank'>условия соглашения</a>",cbkSendName:"Будем знакомы!",cbkSkip:"Пропустить &gt;&gt;",cbkShareTitle:{0:{0:{0:"Спасибо!<br/><small>Мы Вам перезвоним в указанное время.</small>",1:"[name], спасибо!<br/><small>Мы Вам перезвоним в указанное время.</small>"},1:{0:"Спасибо!<br/><small>Мы Вам перезвоним в указанное время.</small>",1:"[name], спасибо!<br/><small>Мы Вам перезвоним в указанное время.</small>"}},1:{0:{0:"Спасибо за заявку!",1:"[name], спасибо за заявку!"},1:{0:"Спасибо за звонок!",1:"[name], спасибо за звонок!"}}},cbkYesAgree:"Да, согласен!",cbkCallLaterTitle:"Выберите<br/><small>удобное время звонка.</small>",cbkCallLaterTitle3:"Не нашли что искали?<br/><small>Хотите мы Вам позвоним и поможем?</small>",cbkErrorNoPhone:"Пожалуйста, введите свой номер!",cbkErrorNoAgree:"Вы должны принять соглашение!",cbkErrorNoName:"Пожалуйста, введите свое имя!",cbkErrorNoEmail:"Пожалуйста, введите свой email!",cbkSecond1:"секунду",cbkSecond2:"секунды",cbkSecond3:"секунд",cbkMondayText:"Понедельник",cbkTuesdayText:"Вторник",cbkWednesdayText:"Среда",cbkThursdayText:"Четверг",cbkFridayText:"Пятница",cbkSaturdayText:"Суббота",cbkSundayText:"Воскресенье",cbkCloseText:"Закрыть"}},setDefaultSettings:function(){var settings={timeouts:{socketReconnect:2,needToCall:1,shakeBtn:5,rotatePhoneIcons:1.5,phonePulse:1.5,animateCopyright:5,btnShowTimeout:0,paused_sec_target:"page"},btnShowScroll:0,btnShow:!1,callTimeout:24,btnColor:!1,btnTextColor:!1,btnNoPulse:!1,btnPosition:!1,btnExtendedPosition:!1,btnExtendedCorner:!1,btnSize:!1,btnStaticOnScroll:!1,btnText:!1,btnFontSize:"22px",btnTextAdd:!1,btnType:"phone",calling:!1,callingWidget:!1,callingFromForm:!1,callId:!1,callStarted:!1,callToPhoneIsDeferred:!1,currentDay:0,departments:!1,hideBtn:0,hourDelta:0,killerId:!1,killerCallOff:!1,killerFormCall:!1,killerFormCallHide:0,killerIsPayed:!1,killerLogo:!1,killerBtnLogo:!1,killerUpdatedAt:!1,killerTimezone:3,killerTransparentBgr:!1,killerWorkdays:!1,killerWorking:0,killerWorkingToday:!0,killerHasMoney:0,killerIsPaused:!1,killerPausedStart:!1,killerPausedEnd:!1,killerPausedDay:!1,killerIsPausedNow:!1,noShowOnExit:!1,noShowWindow:!1,phonePositionRight:20,phonePositionBottom:5,prevDay:0,showWindowApperanceTimeout:27,showWindowReapperanceTimeout:1,showOnExitApperanceTimeout:8,showOnExitReapperanceTimeout:1440,managerRatingCheck:!0,killerCloseClickBgr:!0,timeDelta:0,useDepartment:"",sockjs:!1,cbkLink:"https://whitesaas.com?utm_source=widget&utm_medium=self&utm_campaign="+location.hostname+"&utm_content=&utm_term=",agreementLink:"https://whitesaas.com/agreement/",cssUrl:"//saas-support.com/widget/cbk.css",btnMobilePositionHorizontal:40,btnMobilePositionHorizontalType:"left",btnMobilePositionVertical:95,btnMobilePositionVerticalType:"bottom",mobileViewPort:!1,timerType:"millisecond",windowPosition:0,dragObject:{},btnHideMobileZoom:!1,scallingMobile:!1,formHeight:!1,hideDefered:0,scrollLeft:0,scrollTop:0,auto_call_deffered:0,auto_call_deffered_delay_value:10,agreementPersonalData:0,shiftDayBeginning:0,showOnExitAlways:!1,mobileBtnSize:!1};$.extend(!0,s,settings)},setTemplate:function(){t={btn:'<a class="callbackkiller cbk-btn" href="javascript:void(0)"><span class="cbk-title">'+s.text.cbkBtnTitle+"</span></a>",phone:'<a class="callbackkiller cbk-phone" href="javascript:void(0)"><div class="cbk-phone-bgr"></div><div class="cbk-phone-content"><div class="cbk-phone-phone cbk-rotate-icon"><i class="ws-icon-phone"></i></div><div class="cbk-phone-text">'+s.text.cbkBtnTitle+'</div></div><div class="cbk-phone-circle"></div><div class="cbk-phone-second_circle"></div><div class="cbk-phone-third_circle"></div></a>',extended_btn:'<div class="ws-killer"><div class="ws-killer-btn-container"><div class="ws-killer-btn"><div class="ws-killer-btn-ico"><div class="ws-killer-btn-logo"><i class="ws-icon-phone"></i><img src="" class="ws-killer-logo-img"></div></div><div class="ws-btn-title">'+s.text.cbkBtnTitle+"</div></div></div></div>",windowbgr:'<div class="cbk-window-bgr"></div>',windowlogo:'<div class="cbk-window-logo"></div>',window:'<div class="callbackkiller cbk-window cbk-background"><a class="cbk-close-window" href="javascript:void(0)">'+s.text.cbkCloseText+'&nbsp;</a><div class="cbk-forms"><div class ="cbk-form cbk-callform" style="display:inline-block"><div class="cbk-form-element cbk-form-text"><div class="cbk-form-title"></div></div><div class="cbk-form-element cbk-form-action" ><div class="cbk-form-field"><input type="text" id="cbkNameInput" class="cbk-input" maxlength="255" placeholder="'+s.text.cbkGetNamePlaceholder+'"/></div><div class="cbk-f" class="cbk-input" maxlength="255" placeholder="'+s.text.cbkEmailPlaceholder+'"/></div><div class="cbk-form-field"><input type="tel" id="cbkPhoneInput" class="cbk-input" maxlength="22" autocomplete="off"/><input type="text" class="cbk-phone-checker cbk-input-hidden"/></div><div class="cbk-form-field"><button type="button" id="cbkPhoneBtn" class="cbk-button cbk-button-lg cbk-ink-reaction ym-disable-clickmap">'+s.text.cbkPhoneBtnTitle+'</b.cbkAgreementPersonalData+'</label></div><div class="cbk-timer"></div><div class="cbk-text-after-call" style="display:none; text-align:center;">'+s.text.cbkAfterCall+'</div><br/><div class="cbk-link-btn"><a href="javascript:void(0)" class="cbk-button-no">'+s.text.cbkCallLaterBtnTitle+'</a></div></div><div class="cbk-form cbk-cdform" style="display:inline-block"><div class="cbk-form-element cbk-form-text"><div class="cbk-form-title"></div><div class="cbk-deferred"><select id="cbkCallDeferredDate" class="cbk-select cbk-deferred-date"></select> <div>'+s.text.cbkSelectTimeIn+'</div> <select id="cbkCallDeferredTime" class="cbk-select cbk-deferred-time"></select></div></div><div class="cbk-form-element cbk-form-action"><input type="tel" id="cbkPhoneDeferredInput" class="cbk-input" maxlength="22"/><button type="button" id="cbkPhoneDeferredBtn" class="cbk-button cbk-button-lg cbk-ink-reaction ym-disable-clickmap">'+s.text.cbkPhoneDeferredBtnTitle+'</button></div><div><label class="cbk-label cbk-personal-agreement" style="display:none">'+s.text.cbkAgreementPersonalData+'</label></div></div><div class="cbk-form cbk-departmentform" style="display:inline-block"><div class="cbk-form-element cbk-form-text"><div class="cbk-form-title">'+s.text.cbkDepartmentTitle+'</div></div><div class="cbk-form-element cbk-form-action"><button type="button" id="cbkDepartmentBtn" class="cbk-button cbk-button-lg cbk-ink-reaction ym-disable-clickmap">'+s.text.cbkDepartmentBtnTitle+'</button></div><div class="cbk-timer"></div></div><div class="cbk-form cbk-crqform" style="display:inline-block"><div class="cbk-form-title">'+s.text.cbkCallResultQuestionTitle+'</div><button type="button" class="cbk-button cbk-button-yes">'+s.text.cbkYes+'</button><button type="button" class="cbk-button cbk-button-no">'+s.text.cbkNo+'</button></div><div class="cbk-form cbk-ratingform" style="display:inline-block"><div class="cbk-form-title">'+s.text.cbkRatingTitle+'</div><ul class="cbk-call-rating"><li><a id="cbkRating1" href="javascript:void(0)" data-value="1">1</a></li><li><a id="cbkRating2" href="javascript:void(0)" data-value="2">2</a></li><li><a id="cbkRating3" href="javascript:void(0)" data-value="3">3</a></li><li><a id="cbkRating4" href="javascript:void(0)" data-value="4">4</a></li><li><a id="cbkRating5" href="javascript:void(0)" data-value="5">5</a></li></ul></div><div class="cbk-form cbk-geform" style="display:inline-block"><div class="cbk-form-element cbk-form-text"><div class="cbk-form-title">'+s.text.cbkSendCallToEmailTitle+'</div></div><div class="cbk-form-element cbk-form-action"><input type="text" id="cbkEmailInputRecord" class="cbk-input" placeholder="'+s.text.cbkEmailPlaceholder+'"/><button type="button" class="cbk-button cbk-button-yes">'+s.text.cbkSendEmail+'</button></div><div class="cbk-link-btn"><a href="javascript:void(0)" class="cbk-button-no">'+s.text.cbkNoThanks+'</a></div></div><div class="cbk-form cbk-shareform" style="display:inline-block"><div class="cbk-form-title"></div></div><div class="cbk-form cbk-naform" style="display:inline-block"><div class="cbk-form-title"></div></div></div><div id="cbk-captcha-container" class="cbk-captcha-container" style="display:none;"></div><a class="cbk-copyright" target="_blank" href="'+s.cbkLink+'" data-widget="callback"><span class="copyright-content">'+s.text.cbkCopyright+"</span></a></div></div>"}},animateToInput:function(id){var otherInputs="";"required"==s.contactNameInput&&(otherInputs+=" ,#cbkNameInput"),"required"==s.contactEmailInput&&(otherInputs+=" ,#cbkEmailInput");var thisInput=$("#"+id+otherInputs);navigator.userAgent.match(/iPad|iPhone/gi)?(thisInput.off("focus.ios").on("focus.ios",function(){$("body").animate({scrollTop:0},0),$("body").animate({scrollTop:$(this).offset().top+$(this).height()-$(window).height()/4},0)}),setTimeout(function(){thisInput.blur(),thisInput.focus()},500,thisInput)):(thisInput.off("focus.cbkInput").on("focus.cbkInput",function(){setTimeout(function(element){$(window).height()<=$(element).offset().top+$(element).height()&&($(".cbk-window").animate({scrollTop:0},0),$(".cbk-window").animate({scrollTop:$(element).offset().top+$(element).height()-$(window).height()+20},0))},500,thisInput)}),thisInput.blur(),thisInput.focus())},log:function(mess){wsUtil.log("KILLER : "+mess)},isTouchDevice:function(){return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0}}}(jWS);var wsLoaner=function($){function makeUrl(url,params){var glue="?";return url.search(/\?/)>=0&&(glue="&"),url+glue+$.param(params)}var _windowTemplate,_widgetTemplate,_widget={},_settings={url:"https://unicom24.ru/mfi_iframe_v7/",price_param:"sum",name_param:"name",price_id:"loaner-price",serviceName:"Envybox",partnerLink:"",lang_text:{iframe_warning:"Ваш браузер не поддерживает плавающие фреймы"},dragObject:{}};return{init:function(data){$.fn._frameCheck()&&"undefined"==typeof WBK&&(window.WBK=document.WBK),WBK.checkDebug()&&(this.log=this.consoleLog),this.loader(data)},loader:function(res){var data=res.Data.loaner;this.setSettings(data),WBK.settings.loanerId=parseInt(res.Settings.loanerId),_settings.serviceName=res.Settings.serviceName,_settings.partner_link=res.Settings.partner_link,_settings.partner_link||(_settings.partner_link="http://whitesaas.com/?utm_source=widget&utm_medium=self&utm_campaign="+WBK.settings.domain+"&utm_content=loaner"),this.setTemplate(),this.initWidget()},setSettings:function(settings){$.extend(!0,_settings,settings)},setTemplate:function(){if("new"===_settings.work_type){var visitorName=WBK.settings.visitorName?WBK.settings.visitorName:"",visitorEmail=WBK.settings.visitorEmail?WBK.settings.visitorEmail:"",visitorPhone=WBK.settings.visitorPhone&&"7"===WBK.settings.visitorPhone.substr(0,1)?WBK.settings.visitorPhone:"7",agreement_link="http://whitesaas.com/agreement/loaner/"+WBK.settings.loanerId+"/0/";"1"===_settings.agreement_personal_data_format&&_settings.agreement_personal_data_custom_link&&(agreement_link=_settings.agreement_personal_data_custom_link),_windowTemplate="<div class='ws-loaner'><div class='ws-loaner-modal-overflow'></div><div class='ws-loaner-modal-wrap'><div class='ws-loaner-modal-container ws-loaner-modal-new'><form onsubmit='return false;this.submit()' class='ws-loaner-form'><a class='loaner-close-window' href='javascript:void(0)'>Закрыть&nbsp;</a><div class='ws-loaner-header-text'>"+_settings.form_header_text+"</div><div class='ws-loaner-body-text'>"+_settings.form_body_text+"</div><div class = 'ws-loaner-input-group'><div class = 'ws-loaner-input-user-name ws-loaner-input-container'><input class='ws-loaner-input' placeholder='Ваше Имя' value='"+visitorName+"' oninput = this.classList.remove('invalid-field')></div>","hidden"!==_settings.email_require&&(_windowTemplate+="<div class = 'ws-loaner-input-user-email ws-loaner-input-container'><input class='ws-loaner-input' placeholder='Email' value='"+visitorEmail+"' oninput = this.classList.remove('invalid-field')></div>"),_windowTemplate+="<div class = 'ws-loaner-input-user-phone ws-loaner-input-container'><input class='ws-loaner-input' placeholder='+7(___)___-__-__' value='"+visitorPhone+"' oninput = this.classList.remove('invalid-field') ></div><div class = 'ws-loaner-input-container'><input type='submit' class='ws-loaner-input ws-loaner-submit' value='"+_settings.form_button_text+"'></div>","1"===_settings.agreement_personal_data&&(_windowTemplate+="<div class = 'personal-agreement'><input type='checkbox' id ='loaner-personal-agreement' checked onchange = this.classList.remove('invalid-field')><label for='loaner-personal-agreement'><span>Согласен на обработку персональных данных и принимаю <a href='"+agreement_link+"' class='cbk-agreement-link' target='_blank'>условия соглашения</a></span></label></div>"),_windowTemplate+="<a class='ws-loaner-copyright' target='_blank' href='"+_settings.partner_link+"' data-widget='loaner'><span class='copyright-content'>Работает на <span class='service-name'>"+(WBK.settings.thisIsCallbackKILLER?"<img class='ws-copyright-img' src=\""+WBK.settings.staticServerUrl+'/img/logo/envybox_widget.png">':_settings.serviceName)+"</span></span></a></div></form><div class = 'final_form'><a class='loaner-close-window' href='javascript:void(0)'>Закрыть&nbsp;</a><div class='ws-loaner-post-header-text'>Спасибо!</div><div class='ws-loaner-post-body-text'>С Вами свяжется менеджер для согласования заявки</div><a class='ws-loaner-copyright' target='_blank' href='"+_settings.partner_link+"' data-widget='loaner'><span class='copyright-content'>Работает на <span class='service-name'>"+(WBK.settings.thisIsCallbackKILLER?"<img class='ws-copyright-img' src=\""+WBK.settings.staticServerUrl+'/img/logo/envybox_widget.png">':_settings.serviceName)+"</span></span></a></div></div></div></div>"}else _windowTemplate="<div class='ws-loaner'><div class='ws-loaner-modal-overflow'></div><div class='ws-loaner-modal-wrap'><div class='ws-loaner-modal-container'><iframe class='ws-loaner-modal'>"+_settings.lang_text.iframe_warning+"</iframe><a class='ws-loaner-mon-container" style="display: none;"><div class="ws-loaner-btn-el-container ws-loaner-not-scalling"><div class="ws-loaner-btn-container ws-loaner-btn-mini-hover"><div class="ws-btn-ico"><div class="ws-loaner-logo"><i class="ws-icon-loaner" style="color: '+_settings.color_background+'"></i><img src="'+_settings.loaner_widget_logo+'" class="ws-loaner-logo-img"></div></div><div class="ws-btn-title"></div></div></div>'},initWidget:function(){var _this=this;if("new"===_settings.work_type){var values=this.getPageValues();if(!values.name||!values.price)return!1}WBK.loadFont(),_widget.usable=!0;var url,price=$("#"+_settings.price_id).text(),$windowTemplate=$(_windowTemplate),$widgetTemplate=$(_widgetTemplate),params={};params[_settings.price_param]=price,params[_settings.name_param]=name,params.key="bgpcqofvjphjndzbayoifdsayrinbbnd",params.sub_id=encodeURIComponent(JSON.stringify({visit:WBK.settings.visitId,visitor:WBK.settings.visitorId,loaner:WBK.settings.loanerId})),url=makeUrl(_settings.url,params),_widget.$modalOverflow=$windowTemplate.find(".ws-loaner-modal-overflow"),_widget.$modalWrap=$windowTemplate.find(".ws-loaner-modal-wrap"),_widget.$modalFrame=$windowTemplate.find(".ws-loaner-modal"),_widget.$modalOverflow.hide(),_widget.$modalWrap.hide(),_widget.$modalFrame.attr("src",url),_widget.$widget=$("body").append($widgetTemplate).find(".ws-loan-container"),_widget.$window=$("body").append($windowTemplate).find(".ws-loaner"),$(".ws-loaner-submit").on("click",this.submit),_widget.$widget.find(".ws-loaner-btn-container").addClass("loan-corner-"+_settings.corner_type),WBK.addStyles(".ws-loan-container .ws-loaner-btn-container{background: "+_settings.color_background+"!important;}.ws-loan-container .ws-loaner-btn-container .ws-btn-title{color: "+_settings.color_text+"!important;}");var cssVariablesStyle="",variablesStyles=["form_color_text","form_color_background","form_button_color","form_button_text_color"];variablesStyles.forEach(function(property_name){_settings[property_name]&&(cssVariablesStyle+="--"+property_name+":"+_settings[property_name]+";")}),cssVariablesStyle&&WBK.addStyles(".ws-loaner{"+cssVariablesStyle+"}"),_widget.$widget.find(".ws-btn-title").html(_settings.widget_text);var css={};if("hide"!==_settings.position){switch(_widget.$widget.show(),_settings.position){case"horizontal":switch(_settings.position_x){case"left":css.left=_settings.position_x_value+"%",css.right="auto";break;case"right":css.right=_settings.position_x_value+"%",css.left="auto"}switch(_settings.position_y){case"bottom":css.bottom=_settings.position_y_value+"%",css.top="auto",0==_settings.position_y_value&&_widget.$widget.find(".ws-loaner-btn-container").addClass("ws-loaner-btn-attach");break;case"top":css.top=_settings.position_y_value+"%",css.bottom="auto",0==_settings.position_y_value&&_widget.$widget.find(".ws-loaner-btn-container").addClass("ws-loaner-btn-attach-top")}break;case"vertical_left":_widget.$widget.find(".ws-loaner-btn-container").addClass("ws-loaner-btn-rotate").addClass("ws-loaner-btn-attach-top"),css.left=-(_widget.$widget.find(".ws-loaner-btn-container").outerWidth()-_widget.$widget.find(".ws-loaner-btn-container").outerHeight())/2+"px",css.right="auto";break;case"vertical_right":_widget.$widget.find(".ws-loaner-btn-container").addClass("ws-loaner-btn-rotate").addClass("ws-loaner-btn-attach"),css.right=-(_widget.$widget.find(".ws-loaner-btn-container").outerWidth()-_widget.$widget.find(".ws-loaner-btn-container").outerHeight())/2+"px",css.left="auto"}if("vertical_left"==_settings.position||"vertical_right"==_settings.position)switch(_settings.position_y){case"bottom":css.bottom=(_widget.$widget.find(".ws-loaner-btn-container").outerWidth()-_widget.$widget.find(".ws-loaner-btn-container").outerHeight())/2+$(window).height()/100*_settings.position_y_value+"px",css.top="auto";break;case"top":css.top=(_widget.$widget.find(".ws-loaner-btn-container").outerWidth()-_widget.$widget.find(".ws-loaner-btn-container").outerHeight())/2+$(window).height()/100*_settings.position_y_value+"px",css.bottom="auto"}if(_widget.$widget.find(".ws-loaner-btn-el-container").css(css),_settings.img_src){var d=new Date;_settings.loaner_widget_logo=WBK.settings.staticServerUrl+"/uploaded/loaners/"+_settings.img_src+"?"+d.getTime(),_widget.$widget.find(".ws-loaner-btn-container").addClass("ws-loaner-btn-logo-yes"),_widget.$widget.find(".ws-loaner-logo-img").attr("src",_settings.loaner_widget_logo)}}$(_widget.$window).on("click",".ws-loaner-modal-close, .loaner-close-window",function(event){event.preventDefault(),_this.hideWindow(),_this.reTemplate()}.bind(_this)),$(_widget.$widget).on("click",function(event){wsUtil.getCookie("WhiteCallback_noClickOnLoanerButton")||(_settings.dragObject={},event.preventDefault(),_this.sendGoal("click"),_this.showWindow())}.bind(_this)),window.loaner=this;var _h;if(!$.fn._frameCheck()||"undefined"!=typeof WBK)try{_h=window.top.location.hash}catch(error){}if("#showloaner"==_h&&(_this.sendGoal("click"),_this.showWindow()),!$.fn._frameCheck()||"undefined"!=typeof WBK)try{$("body").on("click",'a[href="#showloaner"], a[href="'+window.top.location.origin+'#showloaner"], a[href="'+window.top.location.origin+'/#showloaner"]',function(e){return _this.sendGoal("click"),_this.showWindow(),e.preventDefault(),!1}),$("body").on("click",".ws-show-loaner-action",function(e){return _this.sendGoal("click"),_this.showWindow(),e.preventDefault(),!1})}catch(error){}if("pc"==WBK.settings.device&&"horizontal"==_settings.position&&0!=_settings.position_y_value&&100!=_settings.position_y_value&&(_widget.$widget.find(".ws-loaner-btn-el-container").on("mousedown.ws-loaner-btn-el-container",function(e){1===e.which&&(_settings.dragObject.elem=_widget.$widget.find(".ws-loaner-btn-el-container"),_settings.dragObject.downX=e.pageX,_settings.dragObject.downY=e.pageY)}).on("dragstart",function(e){e.preventDefault()}).on("mouseup",function(e){if(_settings.dragObject.dragStarted){_settings.dragObject.dragStarted=!1;var d=new Date;d.setSeconds(d.getSeconds()+1),wsUtil.setCookie("WhiteCallback_noClickOnLoanerButton",1,d)}_settings.dragObject={}}),$(document).on("mouseup.ws-loaner-btn-el-container",function(e){if(_settings.dragObject.dragStarted){_settings.dragObject.dragStarted=!1;var d=new Date;d.setSeconds(d.getSeconds()+1),wsUtil.setCookie("WhiteCallback_noClickOnLoanerButton",1,d)}_settings.dragObject={}}),$(document).on("mousemove.ws-loaner-btn-el-container",function(e){if(_settings.dragObject.elem){var moveX=e.pageX-_settings.dragObject.downX,moveY=e.pageY-_settings.dragObject.downY;if(Math.abs(moveX)<3&&Math.abs(moveY)<3)return;_settings.dragObject.dragStarted||(_settings.dragObject.oldPosition={left:_settings.dragObject.elem.position().left||"",top:_settings.dragObject.elem.position().top||""
},_settings.dragObject.shiftX=_settings.dragObject.downX-_settings.dragObject.elem.position().left,_settings.dragObject.shiftY=_settings.dragObject.downY-_settings.dragObject.elem.position().top,_settings.dragObject.dragStarted=!0),_settings.dragObject.elem.css({left:e.pageX-_settings.dragObject.shiftX+"px",top:e.pageY-_settings.dragObject.shiftY+"px",right:"auto",bottom:"auto"})}})),WBK.settings.phoneMasks){var masks=[];WBK.settings.phoneMasks.forEach(function(item){"+7"===item.mask.substr(0,2)&&masks.push(item)}),this.masks=masks;var listRU=$.masksSort(masks,["#"],/[0-9]|#/,"mask"),optsRU={inputmask:{definitions:{"#":{validator:"[0-9]",cardinality:1}},clearIncomplete:!1,showMaskOnHover:!1,autoUnmask:!0},match:/[0-9]/,replace:"#",list:listRU,listKey:"mask",onMaskChange:function(){$(this).attr("placeholder",$(this).inputmask("getemptymask"))}};$(".ws-loaner-input-user-phone input").inputmasks(optsRU)}_this.sendEvents("show","loaner","")},showWidget:function(){return!!_widget.usable&&void("hide"!==_settings.position&&_widget.$widget.show())},hideWidget:function(){return!!_widget.usable&&void _widget.$widget.hide()},showWindow:function(){var _this=this;return!!_widget.usable&&(WBK.settings.windowLoanerOpened=!0,_widget.$modalOverflow.show(),_widget.$modalWrap.show(),this.hideWidget(),_this.sendEvents("click","loaner",""),WBK.settings.windowInvaderOpened&&(wsInvader.widget.window.find(".cbk-support-new-message-copyright").hide(),wsInvader.widget.window.hide()),WBK.settings.callbackEnabled&&wsKiller.widget.btn.hide(),WBK.settings.chatBtnOpened&&wsChat.widget.btn.hide(),WBK.settings.quizId&&!WBK.settings.quizIntegrated&&WBK.settings.thisIsQuizLanding===!1&&wsQuizzes[WBK.settings.quizId].hideWidget(),WBK.settings.videoWidgetId&&WBK.settings.videoWidgetOpened&&wsVideoWidget.closeWidget(),WBK.settings.chatInvitationOpened&&wsChat.hideInvitation(),WBK.settings.multiButtonId&&!WBK.settings.multiButtonHidden&&wsMultiButton.hideWidget(),void $(".ws-loaner-input-user-name input").focus())},hideWindow:function(){return!!_widget.usable&&(WBK.settings.windowLoanerOpened=!1,this.sendGoal("cancel"),_widget.$modalOverflow.hide(),_widget.$modalWrap.hide(),this.showWidget(),WBK.settings.chatEnabled&&(WBK.settings.chatBtnOpened&&wsChat.widget.btn.show(),WBK.settings.chatWindowOpened&&wsChat.widget.window.show()),WBK.settings.windowInvaderOpened&&wsInvader.showWidget(),WBK.settings.callbackEnabled&&1!=wsKiller.settings.hideBtn&&wsKiller.settings.btnShow&&wsKiller.widget.btn.show(),WBK.settings.multiButtonId&&wsMultiButton.showWidget(),void(WBK.settings.quizId&&!WBK.settings.quizIntegrated&&WBK.settings.thisIsQuizLanding===!1&&wsQuizzes[WBK.settings.quizId].showWidget()))},consoleLog:function(message,data){"undefined"==typeof data?console.log(message):console.log(message,data)},log:function(){},sendGoal:function(type){var yaGoal,gaGoal,mailGoal,gaCategory="Loaner";switch(type){case"click":yaGoal="LOAN_CLICK",gaGoal=mailGoal="ClickLoaner";break;case"close":yaGoal="LOAN_CANCEL",gaGoal=mailGoal="CancelLoaner"}wsUtil.sendGoal(yaGoal,gaGoal,gaCategory,!1,!1)},submit:function(){var nameField=$(".ws-loaner-input-user-name input"),name=nameField.val(),emailField=$(".ws-loaner-input-user-email input"),email=emailField.val(),phoneField=$(".ws-loaner-input-user-phone input"),phone=phoneField.val(),agreementField=$("#loaner-personal-agreement"),agreement=agreementField.prop("checked");return name?email&&/^.*@.+\..+$/.test("email")?(emailField.addClass("invalid-field"),!1):email||"required"!==_settings.email_require?phone&&11===phone.length?parseInt(_settings.agreement_personal_data)&&!agreement?(agreementField.addClass("invalid-field"),!1):(wsLoaner.sendLead(name,email,phone),wsLoaner.reTemplate("final"),!1):(phoneField.addClass("invalid-field"),!1):(emailField.addClass("invalid-field"),!1):(nameField.addClass("invalid-field"),!1)},sendLead:function(name,email,phone){var url=WBK.settings.serverUrl+"/api?action=loanerAddLead&callback=?",page_values=this.getPageValues();$.getJSON(url,{widgetType:this.widgetType,widgetId:this.widgetId,loanerId:WBK.settings.loanerId,loanerStatId:WBK.settings.loanerStatId,code:WBK.settings.whiteSaasCode,visitId:WBK.settings.visitId,visitorId:WBK.settings.visitorId,leadInfo:{name:name,email:email,phone:phone,product:page_values.name,price:page_values.price}})},getPageValues:function(){var values={name:_settings.product_value,price:_settings.price_value};if(_settings.product_values_substitution){var product=$("#"+_settings.product_id);product.val()?values.name=product.val():product.text()&&(values.name=product.text())}if(_settings.price_values_substitution){var price=$("#"+_settings.price_id);price.val()?values.price=price.val():price.text()&&(values.price=price.text())}var pattern=new RegExp("\\s+|`","gi");return values.price=parseFloat(values.price.trim().replace(pattern,"")),values},reTemplate:function(type){var widgetContainer=$(".ws-loaner-modal-container.ws-loaner-modal-new");"final"===type?widgetContainer.addClass("final"):widgetContainer.removeClass("final")},sendEvents:function(type,widget,value){var url=WBK.settings.serverUrl+"/api?action=loanerEvent&callback=?";$.getJSON(url,{event:type,widgetType:widget,widgetId:parseInt(value)?parseInt(value):0,loanerId:WBK.settings.loanerId,loanerStatId:WBK.settings.loanerStatId,code:WBK.settings.whiteSaasCode,visitId:WBK.settings.visitId,visitorId:WBK.settings.visitorId},function(result){if(result&&result.Data&&"undefined"!=typeof result.Data.id&&"click"===type)switch(widget){case"loaner":WBK.settings.loanerStatId=result.Data.id}})}}}(jWS);wsMultiButton=function($){var _this,s,t,w,_debug;return{settings:{},templates:{},widget:{},init:function(data){_this=this,s=this.settings,t=this.templates,w=this.widget,s.showBudgeMessage=!1;$.fn._frameCheck()&&"undefined"==typeof WBK&&(WBK=document.WBK),_debug=WBK.checkDebug(),_this.loader(data)},loader:function(res){var data=res.Data.multi_button;if(_this.setSettings(data),WBK.settings.multiButtonId=parseInt(res.Settings.multiButtonId),WBK.settings.multiButtonHidden=s.hide_mobile&&"pc"!==WBK.settings.device,WBK.settings.loanerId=parseInt(res.Settings.loanerId),WBK.settings.chatWidgetId=parseInt(res.Settings.chatWidgetId),!s.hide_mobile||"pc"===WBK.settings.device){if(s.checked_variants=_this.checkVariants(),s.display_mode&&(checkActionInIconOneMode=_this.checkActionValue("one_icon_action")),!s.checked_variants.length)return _debug&&_this.log("Нет подходящих вариантов"),void(WBK.settings.multiButtonEnabled=!1);s.partnerLink||(s.partnerLink="http://"+WBK.settings.servicedomain+"?utm_source=widget&utm_medium=self&utm_campaign="+location.hostname+"&utm_content=multibutton&utm_term="),_this.setTemplate(),_this.initWidget()}},initWidget:function(){w.btn=$(t),w.variants_list=w.bn.hide().appendTo("body");var need_chat=!1;$.each(s.checked_variants,function(index,value){"chat"==value.action&&value.action_value==WBK.settings.chatWidgetId&&(need_chat=!0,wsChat.settings.invitations&&(wsMultiButton.settings.checked_variants[index].show_autoreply_icon=!0))}),WBK.settings.multiButtonEnabled=!0,need_chat?wsUtil.setInterval("chatLoad",function(){$(".ws-chat").length&&(s.checked_variants=s.checked_variants.filter(function(variant){return"chat"!==variant.action||!(!wsChat.settings.chat_is_online&&"hide"===wsChat.settings.operator_offline_action)&&(wsChat.checkInvitation("multi_button"),!0)}),s.checked_variants.length&&(_this.loadWidget(),wsChat.settings.unread_messages_count&&_this.showBudgeMessage(wsChat.settings.unread_messages_count)),wsUtil.deleteInterval("chatLoad"),_this.updateInvitationsStyles(),WBK.settings.chatWindowOpened||_this.showWidget())},300):(_this.loadWidget(),_this.showWidget()),_this.loadIconFont(),WBK.settings.hideCopyright?w.btn.find(".ws-multi_button-copyright").remove():w.btn.addClass("has-copyright-link")},loadIconFont:function(){var versionFont=8;WBK.addStyles("@font-face{font-family: 'CBKMultiIcon';src: url('"+WBK.settings.staticServerUrl+"/widget/fonts/icons/fontello.eot?"+versionFont+"');src: url('"+WBK.settings.staticServerUrl+"/widget/fonts/icons/fontello.eot?"+versionFont+"#iefix') format('embedded-opentype'),url('"+WBK.settings.staticServerUrl+"/widget/fonts/icons/fontello.woff2?"+versionFont+"') format('woff2'),url('"+WBK.settings.staticServerUrl+"/widget/fonts/icons/fontello.woff?"+versionFont+"') format('woff'),url('"+WBK.settings.staticServerUrl+"/widget/fonts/icons/fontello.ttf?"+versionFont+"') format('truetype'),url('"+WBK.settings.staticServerUrl+"/widget/fonts/icons/fontello.svg?"+versionFont+"#font3436') format('svg');font-weight: normal;font-style: normal;}")},d(".multi_button_list");$.each(variants,function(index,value){multi_button.append('<div class="icon_in_button '+(0==index?"active":"")+'" style="background:'+value.settings.color_button+'"><a href="javascript:void(0);" data-index="'+index+'"><i class="multi-button-icon '+value.settings.icon+'" style="color:'+value.settings.color_icon+'"></i></a>'+(s.text_tip&&""!=value.settings.text?'<a href="javascript:void(0);" dan-main-div-text defacolor_for_text_tip+'">'+value.settings.text+"</span></div></a>":"")+(""!=value.settings.text&&"mobile"!=WBK.settings.device?'<a href="javascript:void(0);" data-index="'+index+'"><div class="multi_button-div-text multi_button-main-div-text variant-tooltip" style="display: none"><span class="multi_button-text" style="background-color:'+value.settings.color_background+"; color:"+value.settings.color_text+'">'+value.settings.text+"</span></div></a>":"")+"</div>"),variants.length>1&&multi_button_list.append('<li class="multi_button_element">'+("chat"===value.action?'<div class="cbk-multi-button-budge-message"><span></span></div>':"")+'<div class="multi_button-body" style="background:'+value.settings.color_button+'"><a href="javascript:void(0);" data-index="'+index+'"><i class="multi-button-icon '+value.settings.icon+'" style="color:'+value.settings.color_icon+'"></i></a><div class="multi_button-div-text">'+(value.settings.text?'<span class="multi_button-text" style="background:'+value.settings.color_background+"; color:"+value.settings.color_text+'" data-index="'+index+'" >'+value.settings.text+"</span>":"")+"</div></div></li>")}),multi_button.append('<div class="icon_in_button one_icon_mode active" style="background:'+s.color_button_for_one_icon_mode+'"><a href="javascript:void(0);"  data-index="0">'+(0==s.img_mode_for_one_icon_mode?'<i class="multi-button-icon '+s.icon_for_one_icon_mode+'" style="color:'+s.color_icon_for_one_icon_mode+'"></i>':"")+(s.img_for_one_icon_mode&&1==s.img_mode_for_one_icon_mode?'<img class="multi_button-logo-img" src="'+WBK.settings.staticServerUrl+"/uploaded/multibuttons/"+WBK.settings.multiButtonId+"/"+s.img_for_one_icon_mode+'">':"")+"</a>"+(s.text_tip&&""!=s.text_tip_for_one_icon_mode?'<div class="multi_button-div-text multi_button-main-div-text">'+(s.text_tip_for_one_icon_mode?'<span class="multi_button-text" style="background-color:'+s.background_color_for_text_tip+"; color:"+s.color_for_text_tip+'">'+s.text_tip_for_one_icon_mode+"</span>":"")+"</div>":"")+"</div>")},checkShow:function(){var res=!0;return res},checkWidgetsToHide:function(data){var hide_widgets=[];return"undefined"!=typeof data.Data.multi_button.variants&&$.each(data.Data.multi_button.variants,function(index,value){var check=!1;switch(value.action){case"killer":value.action_value==data.Settings.killerId&&(check=!0);break;case"chat":value.action_value==data.Settings.chatWidgetId&&(check=!0);break;case"loaner":value.action_value==data.Settings.loanerId&&(check=!0);break;case"quiz":value.action_value==data.Settings.quizId&&(check=!0)}check&&hide_widgets.push(value)}),hide_widgets},checkActionValue:function(from,value){var _t=this,check=!1;switch("one_icon_action"==from&&(value={action:_t.settings.action,action_value:_t.settings.action_value}),value.action){case"killer":value.action_value==WBK.settings.killerId&&(check=!0,void 0!=wsKiller&&!wsKiller.settings.killerWorking&&wsKiller.settings.killerOffNoWork&&(check=!1,_debug&&("variant"==from?_this.log("для варианта № "+value.id+' установлена настройка "Отключить виджет в нерабочее время"'):_this.log('для действия в режиме одна иконка установлена настройка "Отключить ви))));break;case"generator":value.action_value==WBK.settings.generatorId&&(check=!0);break;case"quiz":value.action_value==WBK.settings.quizId&&(check=!0);break;case"chat":value.action_value==WBK.settings.chatWidgetId&&(check=!0);break;case"loaner":value.action_value==WBK.settings.loanerId&&(check=!0);break;case"javascript":case"other_widget":switch(check=!0,value.action_value){case"$('.button-widget-open').click();":$(".button-widget-open").css("display","none");break;case"$('#vk_community_messages').css('display', 'block');":$("#vk_community_messages").append('<a id="vkCommunityWidgetClose" href="#" style="position: absolute; left: 303px; width: 40px; height: 40px; z-index: 10001; "></a>'),$("#vkCommunityWidgetClose").click(function(){_this.showWidget(),$("#vk_community_messages").css("display","none")}),$("#vk_community_messages").css("display","none");break;case"if (typeof jivo_api !== 'undefined'){jivo_api.open();}":_t.settings.jivo_in_variants=!0,WBK.addStyles(".jivo_hide{display: none!important; opacity: 0!important; pointer-events: none!important}"),window.jivo_onLoadCallback=function(){$("jdiv#jvlabelWrap").addClass("jivo_hide"),$(".__jivoMobileButton").find("jdiv").addClass("jivo_hide")},window.jivo_onOpen=function(){w.btn.hasClass("active")&&w.btn.removeClass("active")},window.jivo_onClose=function(){$("jdiv#jvlabelWrap").addClass("jivo_hide"),$(".__jivoMobileButton").find("jdiv").addClass("jivo_idget !== 'undefined'){PozvonimcomWidget.api.show();}":"undefined"!=typeof PozvonimcomWidget&&WBK.addStyles("#pozvonim-button{display: none!important;}");break;case"if (typeof Chatra !== 'undefined'){Chatra.show();Chatra('openChat', true);}":"undefined"==typeof Chatra||window.Chatra._chatExpanded||window.Chatra.hide()}"$('#zcwMiniButton').click();"==value.action_value&&WBK.addStyles("#zcwMiniButton{display: none!important; opacity: 0!important; pointer-events: none!important}");break;case"url":case"facebook":case"telegram":case"youtube":case"inst":case"viber":case"whatsapp":case"vk":check=!0;break;case"none":check=!0}return check},checkVariants:function(){var _t=this,checked_variants=[];return $.each(s.variants,function(index,value){_t.checkActionValue("variant",value)?checked_variants.push(value):_debug&&_this.log("для варианта № "+value.id+" не загрузился виджет")}),checked_variants},initPosition:function(){var css={};switch(s.position_x){case"left":css.left=s.position_x_value+"%",css.right="acss.bottom=s.position_y_value+"%",css.top="auto";break;case"top":css.top=s.position_y_value+"%",css.bottom="auto"}w.btn.css(css),_this.initVariantsPosition()},initVariantsPosition:function(){$(".multi_button .multi_button_list").addClass("position_"+s.position_x).addClass("position_"+s.position_y),$(".multi_button").addClass("mb_"+s.position_x).addClass("mb_"+s.position_y)},initTimer:function(){s.showBudgeMessage||wsUtil.setInterval("WidgetMultiButtonTimer",function(){_this.showIconVariant()},1e3*s.time_icons_change)},stopTimer:function(){wsUtil.deleteInterval("WidgetMultiButtonTimer")},reInitTimerWithSelectedIcon:function(variant_id){s.checked_variants&&(variant_id?$.each(s.checked_variants,function(index,value){if(value.id==variant_id)return s.checked_variants_index=index,s.first_variant_to_show_for_change_icons_mode=value.id,!1}):s.checked_variants_index=0,_this.stopTimer(),_this.showIconVariant(s.checked_variants_index),_this.initTimer())},showIconVariant:function(index){_debug&&_this.log("Генерируем вариант иконки"),s.checked_variants_index==s.checked_variants.length-1?s.checked_variants_index=0:s.checked_variants_index++,"undefined"!=typeof index&&(s.checked_variants_index=index),$(".multi_button .icon_in_button").removeClass("active"),$(".multi_button .icon_in_button").eq(s.checked_variants_index).addClass("active"),$(".multi_button").css("background",s.checked_variants[s.checked_variants_index].settings.color_button)},setOneIconMode:function(){this.widget.btn.find(".icon_in_button.active:not('.icon_in_button.one_icon_mode.active')").removeClass("active"),this.widget.btn.find(".one_icon_mode").addClass("active")},loadWindowEvents:function(){w.btn.on("click",function(e){_this.clickWidget(e)}),"mobile"!=WBK.settings.device&&"bounce"==s.animation_type&&0==s.text_tip&&($(window).on("scroll.multi_button",function(){wsUtil.setTimeout("multiButtonBouncing",function(){WBK.settings.multiButtonVariantsOpened||WBK.settings.chatInvitationOpened||(w.btn.addClass("bouncing"),wsUtil.setTimeout("multiButtonBouncingStop",function(){w.btn.removeClass("bouncing")},1500))},250)}),w.btn.on("mouseenter.multi_button",function(e){w.btn.removeClass("bouncing")})),w.variants_list.find("a, .multi_button-text").on("click",function(e){_this.clickVariants(e)}),w.btn.find("a.multi_button_mobile_close").on("click",function(e){_this.clickMobileCloseLink(e)}),w.btn.find(".ws-multi_button-copyright").on("click",function(e){e.stopPropagation()}),w.btn.on("mouseover",function(e){s.text_tip&&s.variants.length>1&&("mobile"!=WBK.settings.device&&$(".default-tooltip").hide(),$(".variant-tooltip").css("display","inline-block")),s.text_tip||$(".variant-tooltip").css("display","inline-block")}),w.btn.on("mousemove",function(e){(WBK.settings.chatInvitationOpened||wsMultiButton.settings.jivo_in_variants&&$("#jivo-iframe-container").hasClass("jivo-expanded"))&&!WBK.settings.windowOpened||(WBK.settings.multiButtonVariantsOpened=!0,wsUtil.deleteTimeout("main_button_active"),w.btn.hasClass("active")||w.btn.addClass("active"))}),w.btn.on("mouseleave",function(e){wsUtil.setTimeout("main_button_active",function(){w.btn.removeClass("active"),WBK.settings.multiButtonVariantsOpened=!1,"pc"!=WBK.settings.device&&_this.clickMobileCloseLink(e)},400),$(".default-tooltip").css("display","inline-block"),$(".variant-tooltip").hide()}),"mobile"!=WBK.settings.device&&"bounce"==s.animation_type&&0==s.text_tip&&wsUtil.setInterval("multiButtonBouncing",function(){WBK.settings.multiButtonVariantsOpened||WBK.settings.chatInvitationOpened||(w.btn.addClass("bouncing"),wsUtil.setTimeout("multiButtonBouncing",function(){w.btn.removeClass("bouncing")},1500))},15e3),"pc"!=WBK.settings.device&&($(window).on("scroll.multi_button",function(){wsUtil.setTimeout("scrollTimerMultiButton",function(){_this.updateBtnPositionMobile()},250)}),$(window).on("envy:resize",function(){_this.updateBtnPositionMobile()}))},clickWidget:function(e){if(!s.display_mode||checkActionInIconOneMode||"pc"!=WBK.settings.device){var clickBtn=$(e.currentTarget).hasClass("multi_button");"mobile"==WBK.settings.device&&(w.variants_list.css("display","inline-block"),_this.stopTimer(),w.btn.css("background-color","#fff"),w.btn.find(".multi_button_mobile_close").addClass("active")),clickBtn?s.display_mode?_this.clickBtnOneIconMode():w.variants_list[0].childElementCount<=1&&"mobile"==WBK.settings.device?_this.clickVariants(e):w.variants_list[0].childElementCount>=1&&"mobile"!=WBK.settings.device?_this.clickVariants(e):w.variants_list[0].childElementCount>1&&"mobile"==WBK.settings.device?w.btn.find(".icon_in_button.active").removeClass("active"):_this.clickVariants(e):_this.clickVariants(e)}},clickBtnOneIconMode:function(){this.clickAction("one_icon_action"),this.sendGoal("click_one_icon"),this.sendClickEvent(null)},clickAction:function(from,value){switch("one_icon_action"==from&&(value={action:s.action,action_value:s.action_value,open_window:s.open_window}),value.action){case"killer":_this.hideWidget();var d=new Date;d.setMinutes(d.getMinutes()+144e3),wsUtil.setCookie("WhiteCallback_shownOn","on_multi_button",d),wsKiller.showWindow("multi_button");break;case"generator":_this.hideWidget(),wsGenerator.showWidget("multi_button");break;case"quiz":WBK.settings.quizIntegrated||_this.hideWidget(),wsQuizzes[WBK.settings.quizId].showWindow("multi_button");break;case"chat":_this.hideWidget(),wsChat.showWidget();break;case"loaner":_this.hideWidget(),wsLoaner.showWindow();break;case"vk":case"facebook":case"telegram":value.action_value.indexOf("http")!==-1||value.action_value.indexOf("tg://resolve?domain=")!==-1?window.open(value.action_value,"_blank"):window.open("tg://resolve?domain="+value.action_value,"_blank");break;case"youtube":case"inst":case"url":parseInt(value.open_window)?window.location.href=value.action_value:window.open(value.action_value,"_blank");break;case"viber":var viberNumber=value.action_value,firstPlus="+"===viberNumber[0];viberNumber=firstPlus?viberNumber.replace("+","%2B"):"%2B"+viberNumber,$("body").append('<a href="viber://chat?number='+viberNumber+'" class="js-viber-link"></a>'),$(".js-viber-link")[0].click(),$(".js-viber-link").remove();break;case"whatsapp":var link="https://wa.me/"+value.action_value;"pc"!==WBK.settings.device?link="whatsapp://send?phone="+value.action_value:"-1"!=navigator.userAgent.indexOf("Firefox")&&(link="https://web.whatsapp.com/send?phone="+value.action_value),window.open(link,"_blank");break;case"javascript":case"other_widget":eval(value.action_value),"$('#vk_community_messages').css('display', 'block');"==value.action_value&&(_this.hideWidget(),eval($("#vk_community_messages script").text().trim())),"if (typeof Chatra !== 'undefined'){Chatra.show();Chatra('openChat', true);}"==value.action_value&&wsUtil.setInterval("chatra_timer_expanded",function(){"undefined"!=typeof Chatra&&window.Chatra._chatExpanded&&(wsUtil.deleteInterval("chatra_timer_expanded"),wsUtil.setInterval("chatra_timer",function(){"undefined"==typeof Chatra||window.Chatra._chatExpanded||(window.Chatra.hide(),wsUtil.deleteInterval("chatra_timer"))},250))},250)}},clickVariants:function(e){e.stopPropagation();var clicked_variant=0!=$(e.currentTarget).find(".active a").length?s.checked_variants[$(e.currentTarget).find(".active a").attr("data-index")]:s.checked_variants[e.currentTarget.dataset.index];_this.sendGoal("click_variant",clicked_variant.settings.translit_text),this.clickAction("variant",clicked_variant),this.sendClickEvent(clicked_variant.id),"pc"!=WBK.settings.device&&(s.display_mode||(_this.showIconVariant(),_this.initTimer()),w.btn.find(".multi_button_mobile_close").removeClass("active"),w.variants_list.css("display","none"))},sendClickEvent:function(variantId){var url=WBK.settings.serverUrl+"/api?action=multiButtonClickEvent&callback=?",siteUrl="";document.URL&&(siteUrl=encodeURIComponent(document.URL)),$.getJSON(url,{code:WBK.settings.whiteSaasCode,multiButtonId:WBK.settings.multiButtonId,multiButtonVariantId:variantId,visitId:WBK.settings.visitId,visitorId:WBK.settings.visitorId,url:siteUrl})},clickMobileCloseLink:function(e){e.stopPropagation(),s.display_mode?w.btn.find(".icon_in_button.one_icon_mode").addClass("active"):(_this.initTimer(),_this.showIconVariant()),w.btn.removeClass("active"),w.btn.find(".multi_button_mobile_close").removeClass("active"),w.variants_list.css("display","none")},showWidget:function(){WBK.settings.multiButtonEnabled&&(w.btn.show(),WBK.settings.multiButtonOpened=!0)},hideWidget:function(){WBK.settings.multiButtonEnabled&&(w.btn.hide(),WBK.settings.multiButtonOpened=!1)},reInitWidget:function(){this.showWidget(),$(".multi_button").removeClass("active"),s.display_mode?oal){var yaGoal,gaGoal,mailGoal,gaCategory="MultiButton";switch(type){case"click_variant":goal&&(yaGoal=goal,gaGoal=mailGoal=goal);break;case"click_one_icon":yaGoal="MULTIBUTTON_ONE_ICON_CLICK",gaGoal=mailGoal="OneIconClickMultiButton"}wsUtil.sendGoal(yaGoal,gaGoal,gaCategory,!1,!1)},setTemplate:function(){t='<div class="multi_button"><a class="multi_button_mobile_close"></a><ul class="multi_button_list"></ul><div class="ws-multi_button-copyright"><a href="'+s.partnerLink+'" class="ws-multi_button-copyright-url" target="_blank" data-widget="multibutton">'+(WBK.settings.thisIsCallbackKILLER?"<span>"+s.translate.text_link_cbk+'</span><img class="multi_button-copyright-img" src="'+WBK.settings.staticServerUrl+'/img/logo/envybox_widget.png">':"<span>Хочу на свой сайт</span>")+'</a></div><div class="cbk-multi-button-budge-message"><span></span></div><div class="cbk-multi-button-circle" style="background-color:'+s.animation_wave_color+'"></div><div class="cbk-multi-button-second_circle" style="background-color:'+s.animation_wave_color+'"></div><div class="cbk-multi-button-third_circle" style="background-color:'+s.animation_wave_color+'"></div></div>'},setSettings:function(settings){var defaultSettings={checked_variants:[],checked_variants_index:0,started:!1,chat_multi_button_variants:[]};$.extend(!0,s,defaultSettings),$.extend(!0,s,settings)},log:function(mess){wsUtil.log("MULTI_BUTTON : "+mess)},updateBtnPositionMobile:function(){var positionData,ratioScreen=wsUtil.getRatio(),position={ratio:ratioScreen,positionX:s.position_x,positionY:s.position_y,positionXValue:s.position_x_value,positionYValue:s.position_y_value};if(s.disable_btn_mobile_position)positionData={zoom:ratioScreen};else if(1==ratioScreen)w.btn.addClass("envy-not-scalling"),positionData=wsUtil.getMobileNotScalePositionWidget(position);else{w.btn.removeClass("envy-not-scalling"),position.el=w.btn,positionData=wsUtil.getMobileScalePositionWidget(position);var left=(parseInt(positionData.left)+w.btn.width())*ratioScreen;left>jWS(window).width()&&(positionData.left=parseInt(positionData.left)-(left-jWS(window).width())/ratioScreen+"px")}positionData["z-index"]=19e8,w.btn.css(positionData)},updateInvitationsStyles:function(){if("pc"!=WBK.settings.device){var container=$(".ws-chat-btn-el-container"),advansedSizeY=0;container.addClass("ws-chat-not-scalling"),container.addClass("ws-chat-no-update-position");var ratio_screen=wsUtil.getRatio();this.widget.btn.show();var p=this.widget.btn.position(),advansedSizeX=advansedSizeY=0;"mb_big_size"==s.size?(advansedSizeX=p.left*ratio_screen>window.innerWidth/2?this.widget.btn.width()-20:27,advansedSizeY=p.top*ratio_screen>window.innerHeight/2?20:0):p.left*ratio_screen>window.innerWidth/2&&(advansedSizeX=this.widget.btn.width());var topPosition=p.top+this.widget.btn.width()-advansedSizeY;if(s.partnerLink)switch(s.size){case"mb_big_size":topPosition+=p.top*ratio_screen<=window.innerHeight/2?18:0;break;case"mb_medium_size":topPosition+=p.top*ratio_screen<=window.innerHeight/2?22:0;break;case"mb_small_size":topPosition+=p.top*ratio_screen<=window.innerHeight/2?32:0}var containerPositionLeft=p.left+advansedSizeX;container.css({top:topPosition+"px",bottom:"auto",left:containerPositionLeft+"px",right:"auto","z-index":"inherit"}),$(".ws-chat").removeClass("left right top bottom"),$(".ws-chat").addClass(p.left*ratio_screen<window.innerWidth/2?"left":"right"),$(".ws-chat").addClass(p.top*ratio_screen<window.innerHeight/2?"top":"bottom"),wsUtil.setTimeout("zIndex",function(){container.css("z-index",2147483645),parseInt(s.hide_zoom)&&wsUtil.setTimeout("btnElShow",function(){container.show()},150)},50)}else{var container=$(".ws-chat-invitation-container"),css=(container.find(".ws-chat-invitation-form"),{});switch(container.addClass("from-multi-button"),container.addClass(s.position_x+"-invitation-position"),container.addClass(s.position_y+"-invitation-position"),container.addClass(s.size+"-invitation"),container.find(".ws-chat-invitation-input").attr("placeholder",wsChat.settings.lang_text.invitation_form_message_placeholder),s.partnerLink&&container.addClass("with-partner-link"),s.position_x){case"left":css.left=s.position_x_value+"%",css.right="auto";break;case"right":css.right=s.position_x_value+"%",css.left="auto"}switch(s.position_y){case"bottom":css.bottom=s.position_y_value+"%",css.top="auto";break;case"top":css.top=s.position_y_value+"%",css.bottom="auto"}if(!WBK.settings.hideCopyright){var additionalMarginBottom=25;"mb_big_size"===s.size&&(additionalMarginBottom="top"===s.position_y?-35:45),css["margin-bottom"]=parseInt(container.css("margin-bottom"))+additionalMarginBottom+"px"}container.css(css)}},showBudgeMessage:function(countMessage){var variantId=!1;$.each(s.checked_variants,function(index,value){"chat"===value.action&&(variantId=index)}),variantId!==!1&&(countMessage?(s.display_mode||(_this.stopTimer(),_this.showIconVariant(variantId)),$(".cbk-multi-button-budge-message > span").text(countMessage),$(".cbk-multi-button-budge-message").show(),s.showBudgeMessage=!0):($(".cbk-multi-button-budge-message").hide(),s.showBudgeMessage=!1,s.display_mode||_this.initTimer()))},loadWidget:function(){_this.initPosition(),_this.setVariants(s.checked_variants),_this.loadWindowEvents(),s.size&&"mb_big_size"!==s.size&&w.btn.addClass(s.size),s.animation_type&&"none"!==s.animation_type&&0==s.text_tip&&w.btn.addClass("multi-button-"+s.animation_type),"mobile"==WBK.settings.device&&(s.disable_btn_mobile_position?w.btn.addClass("disable-mobile-position"):w.btn.addClass("mobile")),"pc"!=WBK.settings.device&&_this.updateBtnPositionMobile(),s.display_mode?($(".multi_button").addClass("one_icon_mode"),$(".multi_button .icon_in_button.active:not('.icon_in_button.one_icon_mode.active')").removeClass("active")):(_this.showIconVariant(s.checked_variants_index),_this.reInitTimerWithSelectedIcon(s.first_variant_to_show_for_change_icons_mode))}}}(jWS),window.wsQuiz=function($){function makeUrl(url,params){var glue="?";return url.search(/\?/)>=0&&(glue="&"),url+glue+$.param(params)}var _windowTemplate,_widgetTemplate,_widget={},_settings={lang_text:{iframe_warning:"Ваш браузер не поддерживает плавающие фреймы"},dragObject:{},hasHash:!1,needShowAuto:!1,eventsLoaded:!1,thisIsQuizLanding:!1},_constants={mobileViewType:{onlyIcon:{id:0,title:"Только иконка"},onlyText:{id:1,title:"Только текст"},iconWithText:{id:2,title:"Иконка и текст"}}},heightMobile="100%";return{init:function(data,quizId){if($.fn._frameCheck()&&"undefined"==typeof WBK)var WBK=document.WBK;WBK&&WBK.checkDebug()&&(this.log=this.consoleLog),this.loader(data,quizId)},loader:function(data,quizId){this.setSettings(data),WBK.settings.thisIsQuizLanding=data.thisIsQuizLanding,this.quizId=parseInt(quizId),WBK.settings.quizId||(WBK.settings.quizId=this.quizId),this.setTemplate(),(void 0===data.thisIsQuizLanding||data.thisIsQuizLanding===!1||data.thisIsQuizLanding===!0&&1===+data.landing_view_type)&&this.initWidget()},setSettings:function(settings){$.extend(!0,_settings,settings),"off"!=_settings.window_display_mode&&("often"===_settings.window_display_mode&&(_settings.showWindowReapperanceTimeout=0),"rare"===_settings.window_display_mode&&(_settings.showWindowReapperanceTimeout=7),"normal"===_settings.window_display_mode&&(_settings.showWindowReapperanceTimeout=1)),_settings.window_min_apperance_timeout&&_settings.window_max_apperance_timeout&&_settings.window_min_apperance_timeout<_settings.window_max_apperance_timeout&&_settings.need_max_apperance_timeout_text?_settings.showWindowApperanceTimeout=wsUtil.getRandomArbitrary(_settings.window_min_apperance_timeout,_settings.window_max_apperance_timeout):_settings.window_min_apperance_timeout?_settings.showWindowApperanceTimeout=wsUtil.getRandomArbitrary(_settings.window_min_apperance_timeout,_settings.window_min_apperance_timeout+7):_settings.window_max_apperance_timeout&&_settings.need_max_apperance_timeout_text&&(_settings.showWindowApperanceTimeout=wsUtil.getRandomArbitrary(0,_settings.window_max_apperance_timeout))},setTemplate:function(){if(_windowTemplate="<div class='ws-quiz'><div class='ws-quiz-modal-overflow'></div><div class='ws-quiz-modal-wrap'><div class='ws-quiz-modal-container'><iframe id='ws-quiz-iframe-"+this.quizId+"' name='ws-quiz-iframe-"+this.quizId+"' class='ws-quiz-modal'>"+_settings.lang_text.iframe_warning+"</iframe></div></div></div>",
_widgetTemplate='<div class="ws-quiz-container" style="display: none;"><div class="ws-quiz-btn-el-container envy-not-scalling"><div class="ws-quiz-btn-container ws-quiz-btn-mini-hover'+("none"!=_settings.animation_type?" quiz-animation-"+_settings.animation_type+'"':'"')+'><div class="ws-btn-ico"><div class="ws-quiz-logo">'+(""!==_settings.img_src?'<img src="'+_settings.img_src+'" class="ws-quiz-logo-img">':'<i class="ws-icon-quiz" style="color: '+_settings.color_background+'"></i>')+'</div></div><div class="ws-btn-title"></div></div></div>',"pc"!=WBK.settings.device){_windowTemplate="<div class='ws-quiz'><div class='ws-quiz-modal-overflow'></div><div class='ws-quiz-modal-wrap'><div class='ws-quiz-modal-container quiz-mobile'><iframe id='ws-quiz-iframe-"+this.quizId+"' name='ws-quiz-iframe-"+this.quizId+"' class='ws-quiz-modal'>"+_settings.lang_text.iframe_warning+"</iframe></div></div></div>";var buttonIconTemplate="";+_settings.mobile_button_view_mode!==_constants.mobileViewType.onlyIcon.id&&+_settings.mobile_button_view_mode!==_constants.mobileViewType.iconWithText.id||(buttonIconTemplate='<div class="ws-quiz-logo"><i class="ws-icon-quiz" style="color: '+_settings.mobile_color_icon+'"></i></div>');var buttonTextTemplate="";+_settings.mobile_button_view_mode!==_constants.mobileViewType.onlyText.id&&+_settings.mobile_button_view_mode!==_constants.mobileViewType.iconWithText.id||(buttonTextTemplate='<span class="ws-quiz-logo-text button-text-with-break-line" style="color: '+_settings.mobile_color_icon+'">'+_settings.mobile_button_text+"</span>"),_widgetTemplate='<div class="ws-quiz-container ws-quiz-mobile" style="display: none;"><div class="ws-quiz-btn-el-container envy-not-scalling"><div class="ws-quiz-btn-container" style="background: '+_settings.mobile_color_background_button+'">'+buttonIconTemplate+buttonTextTemplate+"</div></div></div>"}},sendResizeBlockAnswerEvent:function(){var obj=this.getObjectToPostMessage("resizeBlockAnswer");obj.integrateToSite=$("#integrate-quiz-element-"+this.quizId).length||WBK.settings.quizId===this.quizId&&$("#integrate-quiz-element").length,this.sendPostMessageToFrame(obj)},initWidget:function(){var _this=this,body=$("body");WBK.loadFont(),_widget.usable=!0;var url,$windowTemplate=$(_windowTemplate),$widgetTemplate=$(_widgetTemplate),params={};params.code=WBK.settings.whiteSaasCode,params.widgetId=this.quizId,params.noajax=!0,url=makeUrl(WBK.settings.serverUrl+"/api/quizes/"+this.quizId+"/?action=show",params),_widget.$modalOverflow=$windowTemplate.find(".ws-quiz-modal-overflow"),_widget.$modalWrap=$windowTemplate.find(".ws-quiz-modal-wrap"),_widget.$modalFrame=$windowTemplate.find(".ws-quiz-modal"),_widget.$modalOverflow.hide(),_widget.$modalWrap.hide(),_widget.$modalFrame.attr("src",url);var quizClassId="ws-quiz-id-"+this.quizId;if($windowTemplate.addClass(quizClassId),_widget.$window=body.append($windowTemplate).find("."+quizClassId),"pc"===WBK.settings.device?(WBK.addStyles(".ws-quiz-container .ws-quiz-btn-container{background: "+_settings.color_background+"!important;}.ws-quiz-container .ws-quiz-btn-container .ws-btn-title{color: "+_settings.color_text+"!important;}"),_settings.show_expert||"no"!=_settings.offer_discount||_widget.$window.addClass("hide-sidebar")):WBK.addStyles(".ws-quiz-container.ws-quiz-mobile .ws-quiz-btn-container{background: "+_settings.mobile_color_background_button+"!important;}.ws-quiz-container.ws-quiz-mobile .ws-quiz-btn-container {box-shadow: 0px 4px 8px 0px "+_settings.mobile_color_background_button+"!important;}"),WBK.settings.quizId===this.quizId){_widget.$widget=body.append($widgetTemplate).find(".ws-quiz-container"),_widget.$widget.find(".ws-quiz-btn-container").addClass("quiz-corner-"+_settings.corner_type),_widget.$widget.find(".ws-btn-title").html(_settings.widget_text);var css={};if(_settings.show_button_on_site)if(_widget.$widget.show(),"pc"===WBK.settings.device){switch(_settings.position){case"horizontal":switch(_settings.position_x){case"left":css.left=_settings.position_x_value+"%",css.right="auto";break;case"right":css.right=_settings.position_x_value+"%",css.left="auto"}switch(_settings.position_y){case"bottom":css.bottom=_settings.position_y_value+"%",css.top="auto",0===_settings.position_y_value&&_widget.$widget.find(".ws-quiz-btn-container").addClass("ws-quiz-btn-attach");break;case"top":css.top=_settings.position_y_value+"%",css.bottom="auto",0===_settings.position_y_value&&_widget.$widget.find(".ws-quiz-btn-container").addClass("ws-quiz-btn-attach-top")}break;case"vertical_left":_widget.$widget.find(".ws-quiz-btn-container").addClass("ws-quiz-btn-rotate").addClass("ws-quiz-btn-attach-top"),css.left=-(_widget.$widget.find(".ws-quiz-btn-container").outerWidth()-_widget.$widget.find(".ght())/2+"px",css.right="auto";break;case"vertical_right":_widget.$widget.find(".ws-quiz-btn-container").addClass("ws-quiz-btn-rotate").addClass("ws-quiz-btn-attach"),css.right=-(_widget.$widget.find(".ws-quiz-btn-container").outerWidth()-_widget.$widget.find(".ws-quiz-btn-container").outerHeight())/2+"px",css.left="auto"}if("vertical_left"===_settings.position||"vertical_right"===_settings.position)switch(_settings.position_y){case"bottom":css.bottom=(_widget.$widget.find(".ws-quiz-btn-container").outerWidth()-_widget.$widget.find(".ws-quiz-btn-container").outerHeight())/2+$(window).height()/100*_settings.position_y_value+"px",css.top="auto";break;case"top":css.top=(_widget.$widget.find(".ws-quiz-btn-container").outerWidth()-_widget.$widget.find(".ws-quiz-btn-container").outerHeight())/2+$(window).height()/100*_settings.position_y_value+"px",css.bottom="auto"}if(_widget.$widget.find(".ws-quiz-btn-el-container").css(css),_settings.img_src){var d=new Date;_settings.quiz_widget_logo=WBK.settings.staticServerUrl+"/uploaded/quizes/"+this.quizId+"/logo/"+_settings.img_src+"?"+d.getTime(),_widget.$widget.find(".ws-quiz-btn-container").addClass("ws-quiz-btn-logo-yes"),_widget.$widget.find(".ws-quiz-logo-img").attr("src",_settings.quiz_widget_logo)}}else{var quizBtnContainer=_widget.$widget.find(".ws-quiz-btn-container");quizBtnContainer.addClass("ws-quiz-btn-container-"+_settings.mobile_button_size),_settings.mobile_button_view_mode==_constants.mobileViewType.onlyIcon.id?quizBtnContainer.addClass("view-type-only-icon"):_settings.mobile_button_view_mode==_constants.mobileViewType.onlyText.id?quizBtnContainer.addClass("view-type-only-text"):_settings.mobile_button_view_mode==_constants.mobileViewType.iconWithText.id&&quizBtnContainer.addClass("view-type-icon-with-text"),this.updateBtnPositionMobile()}}var defaultIntegrateElement=$("#integrate-quiz-element").length&&WBK.settings.quizId===this.quizId;if(defaultIntegrateElement||$("#integrate-quiz-element-"+this.quizId).length){var iframe=_widget.$window.find("#ws-quiz-iframe-"+this.quizId),element=$("#integrate-quiz-element"+(defaultIntegrateElement?"":"-"+this.quizId)),width="900px",height="500px";"no"!=_settings.offer_discount||_settings.show_expert||"mobile"===WBK.settings.device||_settings.show_start_page||(width="650px",height="534px");var cssElement={display_block:"block",width:width,height:height,margin:"auto"};iframe&&element.length&&("mobile"===WBK.settings.device?(cssElement={display_block:"block",width:"100%",height:"auto"},element.append("<div class='ws-quiz'><div class='ws-quiz-modal-container quiz-mobile'><div class='ws-lds-ring'><div></div><div></div><div></div><div></div></div></div></div>"),element.find(".ws-quiz-modal-container.quiz-mobile").append(iframe)):(element.append("<div class='ws-lds-ring'><div></div><div></div><div></div><div></div></div>"),element.append(iframe)),"mobile"!==WBK.settings.device&&iframe.css({width:0,height:0}),element.css(cssElement),iframe.load(function(){"mobile"===WBK.settings.device?cssElement.height=heightMobile:iframe.css(cssElement),element.find(".ws-lds-ring").hide(),WBK.settings.quizIntegrated=!0,_this.quizIntegrated=!0,_this.sendEvents("show","integrated")}))}else _settings.show_start_page&&"mobile"!==WBK.settings.device&&$(".ws-quiz-modal-container").css({width:"900px"});$(_widget.$window).on("click",".ws-quiz-modal-close",function(event){event.preventDefault(),_this.hideWindow()}.bind(_this)),_widget.$widget&&$(_widget.$widget).on("click",function(event){wsUtil.getCookie("WhiteCallback_noClickOnQuizButton")||(_settings.dragObject={},event.preventDefault(),_settings.eventsLoaded&&(_this.sendGoal("click"),_this.showWindow("btn")))}.bind(_this)),window.quiz=this;var _h;if(!$.fn._frameCheck()||"undefined"!=typeof WBK)try{_h=window.top.location.hash}catch(error){}if("#showquiz"===_h&&(_settings.hasHash=!0),!$.fn._frameCheck()||"undefined"!=typeof WBK)try{body.on("click",'a[href="#showquiz"], a[href="#showquiz-'+_this.quizId+'"], a[href="'+window.top.location.origin+'#showquiz"], a[href="'+window.top.location.origin+'/#showquiz"]',function(e){if("#showquiz"!==$(this).attr("href")||WBK.settings.quizId===_this.quizId)return _settings.eventsLoaded&&(_this.sendGoal("click"),_this.showWindow("url")),e.preventDefault(),!1}),body.on("click",".ws-show-quiz-action",function(e){return _settings.eventsLoaded&&(_this.sendGoal("click"),_this.showWindow()),e.preventDefault(),!1})}catch(error){}_widget.$widget&&"pc"===WBK.settings.device&&"horizontal"===_settings.position&&0!==_settings.position_y_value&&100!==_settings.position_y_value&&(_widget.$widget.find(".ws-quiz-btn-el-container").on("mousedown.ws-quiz-btn-el-container",function(e){1===e.which&&(_settings.dragObject.elem=_widget.$widget.find(".ws-quiz-btn-el-container"),_settings.dragObject.downX=e.pageX,_settings.dragObject.downY=e.pageY)}).on("dragstart",function(e){e.preventDefault()}).on("mouseup",function(){if(_settings.dragObject.dragStarted){_settings.dragObject.dragStarted=!1;var d=new Date;d.setSeconds(d.getSeconds()+1),wsUtil.setCookie("WhiteCallback_noClickOnQuizButton",1,d)}_settings.dragObject={}}),$(document).on("mouseup.ws-quiz-btn-el-container",function(){if(_settings.dragObject.dragStarted){_settings.dragObject.dragStarted=!1;var d=new Date;d.setSeconds(d.getSeconds()+1),wsUtil.setCookie("WhiteCallback_noClickOnQuizButton",1,d)}_settings.dragObject={}}),$(document).on("mousemove.ws-quiz-btn-el-container",function(e){if(_settings.dragObject.elem){var moveX=e.pageX-_settings.dragObject.downX,moveY=e.pageY-_settings.dragObject.downY;if(Math.abs(moveX)<3&&Math.abs(moveY)<3)return;_settings.dragObject.dragStarted||(_settings.dragObject.oldPosition={left:_settings.dragObject.elem.position().left||"",top:_settings.dragObject.elem.position().top||""},_settings.dragObject.shiftX=_settings.dragObject.downX-_settings.dragObject.elem.position().left,_settings.dragObject.shiftY=_settings.dragObject.downY-_settings.dragObject.elem.position().top,_settings.dragObject.dragStarted=!0),_settings.dragObject.elem.css({left:e.pageX-_settings.dragObject.shiftX+"px",top:e.pageY-_settings.dragObject.shiftY+"px",right:"auto",bottom:"auto"})}})),$(window).on("message",function(event){var data=event.originalEvent.data;if(+data.quizId===_this.quizId&&"quiz"===data.widget){if("start_click"===data.action){$(".ws-quiz-modal-container").css({width:""});var defaultIntegrateElementQuiz=$("#integrate-quiz-element").length&&WBK.settings.quizId===_this.quizId;if(defaultIntegrateElementQuiz||$("#integrate-quiz-element-"+_this.quizId).length){var elementQuiz=$("#integrate-quiz-element"+(defaultIntegrateElementQuiz?"":"-"+_this.quizIdpx",heightQuiz="500px";"no"!=_settings.offer_discount||_settings.show_expert||"mobile"===WBK.settings.device||(widthQuiz="650px",heightQuiz="534px"),elementQuiz.css({height:heightQuiz,width:widthQuiz}),iframeQuiz.css({height:heightQuiz,width:widthQuiz})}}if("iframe_events_loaded"===data.action&&(_settings.hasHash&&_this.showWindowWithEvents("click","url"),_settings.needShowAuto&&_this.showWindowWithEvents("showauto","auto"),_settings.eventsLoaded||(_settings.eventsLoaded=!0),WBK.settings.quizIframeEventsLoaded=!0,_this.sendDataToLoadedIframe(),_settings.thisIsQuizLanding===!0)){var obj=_this.getObjectToPostMessage("initQuizLandingSettings");$("[id^='integrate-quiz-element']").css("height","auto"),_this.sendPostMessageToFrame(obj)}if("close"===data.action&&_this.hideWindow(),"updateStatus"===data.action){var _data=data,url=WBK.settings.serverUrl+"/api?action=quizUpdateStatus&callback=?",data={code:WBK.settings.whiteSaasCode,quizId:_this.quizId,questionId:data.questionId,question:data.question,status:data.status,tempId:data.tempId,visitId:WBK.settings.visitId,visitorId:WBK.settings.visitorId,firstOpen:data.firstOpen,url:"string"==typeof document.URL?document.URL:""};$.getJSON(url,data,function(result){if(result.Success){var obj=_this.getObjectToPostMessage("statusUpdated");_this.sendPostMessageToFrame(obj),void 0!==_data.sendYaGoal&&_data.sendYaGoal&&_this.sendGoal("answeredQuestion","QUESTION_"+_data.question.id)}else console.log("updateStatus Error")})}if("send"===data.action){var url=WBK.settings.serverUrl+"/api?action=quizLeadAdd",data={code:WBK.settings.whiteSaasCode,info:data.info,discount:data.discount,visitId:WBK.settings.visitId,visitorId:WBK.settings.visitorId,quizId:_this.quizId,quizStatId:_this.quizStatId,url:"string"==typeof document.URL?document.URL:"",questions:data.questions,phoneMask:data.phoneMask,tempId:data.tempId,roistatPromo:wsUtil.getRoistatPromo(),advertiseId:wsUtil.getAdvertiseId(),calltrackingId:wsUtil.getCalltrackingId(),lpgeneratorId:wsUtil.getLPGeneratorId(),leadvertexId:wsUtil.getLeadvertexId(),googleClientId:wsUtil.getGoogleClientId(),externalParams:wsUtil.getExternalParams()};$.post(url,data,function(result){if(result.Success){if(_this.sendGoal("send"),WBK.setVisitorInfoIfNot(data.info),"function"==typeof window.ws_OnQuizSendLead&&window.ws_OnQuizSendLead(data),_this.sendPostMessageToFrame(Object.assign(_this.getObjectToPostMessage("sendData"),{data:result.Data})),data.info.phone&&_settings.auto_call&&WBK.settings.callbackEnabled&&parseInt(_settings.ispayed)){wsKiller.settings.callingWidget=!0;var d=new Date;d.setMinutes(d.getMinutes()+144e3),wsUtil.setCookie("WhiteCallback_shownOn","onquiz",d),WBK.settings.phoneMask=_settings.use_telephony_mask?data.phoneMask:WBK.numberMask(data.info.phone).mask,wsKiller.newCall(data.info.phone,!1,_settings.auto_call_deffered,_settings.auto_call_deffered_delay)}if("go_url"==_settings.send_action&&_settings.send_action_url&&"new_page"!==_settings.page_open_type){var match=wsUtil.parseURL(_settings.send_action_url);match.scheme||(_settings.send_action_url="http://"+_settings.send_action_url),window.location.href=_settings.send_action_url,_this.hideWidget()}}},"json")}"resize_iframe"===data.action&&data.height&&(heightMobile=data.height,$("#ws-quiz-iframe-"+_this.quizId).css("height",data.height+"px")),"scrollToIframeTop"===data.action&&$("html, body").animate({scrollTop:$("#ws-quiz-iframe-"+_this.quizId).offset().top},100),"sendAdvertStat"===data.action&&WBK.sendAdvertLinkStat("quiz",data.href,data.text,data.widgetId)}}),"pc"!==WBK.settings.device&&($(window).on("scroll.envy-quiz",function(){wsUtil.setTimeout("scrollEnvyQuiz",function(){_this.updateBtnPositionMobile()},250)}),$(window).on("envy:resize",function(){_this.updateBtnPositionMobile()})),wsUtil.getCookie("WhiteQuiz_noShowWindow")||"off"==_settings.window_display_mode||WBK.settings.chatWindowOpened||WBK.settings.windowOpened||wsUtil.setTimeout("showQuizOnTimer",function(){wsUtil.getCookie("WhiteQuiz_noShowWindow")||WBK.settings.windowQuizOpened||(WBK.settings.quizIframeEventsLoaded&&_this.showWindow("auto"),_settings.needShowAuto=!0)},1e3*_settings.showWindowApperanceTimeout),_settings.thisIsQuizLanding===!0&&_widget.$widget&&_widget.$widget.hide(),this.catchAttemptToLeave()},catchAttemptToLeave:function(){var _this=this;_settings.window_show_on_exit&&"pc"===WBK.settings.device&&$("body").mouseleave(function(e){var pos={x:e.pageX,y:e.pageY-$(document).scrollTop()};if(!(parseInt(wsUtil.getCookie("WhiteCallback_timePage"))<9||pos.y>=10||wsUtil.getCookie("WhiteQuiz_noShowWindow")||"onexit"===wsUtil.getCookie("WhiteQuiz_show_"+_this.quizId)||wsUtil.getOpenedWidgets().length)){var now=new Date;now.setMinutes(now.getMinutes()+1440),wsUtil.setCookie("WhiteQuiz_show_"+_this.quizId,"onexit",now),_this.showWindow("exit")}})},showWindowWithEvents:function(goal,from){this.sendGoal(goal),this.showWindow(from)},updateBtnPositionMobile:function(){var btnEl=_widget.$widget.find(".ws-quiz-btn-el-container"),ratioScreen=wsUtil.getRatio();_settings.scallingMobile=1!=ratioScreen;var positionData,position={ratio:ratioScreen,positionX:_settings.mobile_position_x,positionY:_settings.mobile_position_y,positionXValue:_settings.mobile_position_x_value,positionYValue:_settings.mobile_position_y_value};_settings.scallingMobile?(btnEl.removeClass("envy-not-scalling"),position.el=btnEl,positionData=wsUtil.getMobileScalePositionWidget(position)):(btnEl.addClass("envy-not-scalling"),positionData=wsUtil.getMobileNotScalePositionWidget(position));var btnElWidth=btnEl.outerWidth(!0);if(btnEl.css(positionData),+_settings.mobile_button_view_mode===_constants.mobileViewType.onlyText.id||+_settings.mobile_button_view_mode===_constants.mobileViewType.iconWithText.id){"right"===_settings.mobile_position_x&&(_settings.mobile_position_x="left");var windowWidth=$(window).width(),freeSpaceByX=windowWidth-btnElWidth,coeffInPercent=_settings.mobile_position_x_value,btnElOffsetLeft=freeSpaceByX/100*coeffInPercent;100===+coeffInPercent?btnEl.css("left","auto").css("right",0):btnEl.css("right","auto").css("left",btnElOffsetLeft)}btnEl.show()},showWidget:function(){"hide"!==_settings.position&&_settings.show_button_on_site&&_wi&_widget.$widget.show()},hideWidget:function(){_widget.$widget&&_widget.$widget.hide()},getObjectToPostMessage:function(action){if(action){var obj={widget:"quiz",action:action,settings:{}};return _settings.partnerLink&&(obj.settings.partnerLink=_settings.partnerLink),_settings.agreementLink&&(obj.settings.agreementLink=_settings.agreementLink),_settings.thisIsQuizLanding&&(obj.settings.quizLanding=_settings.thisIsQuizLanding),"undefined"!=typeof WBK&&(obj.settings.wbkSettings=WBK.settings,obj.settings.wbkSettings.socket&&delete obj.settings.wbkSettings.socket),obj}},showWindow:function(type_open){var _this=this;if("auto"===type_open&&(WBK.settings.windowGeneratorOpened||WBK.settings.videoWidgetOpened||WBK.settings.chatWindowOpened||WBK.settings.chatInvitationOpened||WBK.settings.windowLoanerOpened||WBK.settings.multiButtonVariantsOpened||WBK.settings.windowOpened))wsUtil.getCookie("WhiteQuiz_noShowWindow")||"off"==_settings.window_display_mode||wsUtil.setTimeout("showQuizOnTimer",function(){wsUtil.getCookie("WhiteQuiz_noShowWindow")||WBK.settings.windowQuizOpened||_this.showWindow("auto")},1e3*_settings.showWindowApperanceTimeout);else{if("auto"===type_open&&_this.sendGoal("showauto"),"multi_button"!==type_open&&"video_widget"!==type_open||(_this.sendGoal("click"),type_open="btn"),"mobile"!==WBK.settings.device||$("[id^='integrate-quiz-element']").length||(_settings.scrollLeft=$(window).scrollLeft(),_settings.scrollTop=$(window).scrollTop(),$("meta[name=viewport]").length?(_widget.$window.data("oldViewport",$("meta[name=viewport]").last().attr("content")),$("meta[name=viewport]").remove()):_widget.$window.data("noViewport",1),$("head").append($("<meta>").attr("name","viewport").attr("content","width=device-width, user-scalable=0, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0")),_this.quizIntegrated||$("body").addClass("cbk-body-mobile").css("width",$(window).width()+"px")),($("#integrate-quiz-element").length&&WBK.settings.quizId===_this.quizId||$("#integrate-quiz-element-"+_this.quizId).length)&&$("#ws-quiz-iframe-"+_this.quizId).length)return void $("html, body").animate({scrollTop:$("#ws-quiz-iframe-"+_this.quizId).offset().top},1e3);_settings.show_start_page&&"mobile"!==WBK.settings.device&&$(".ws-quiz-modal-container").css({width:"900px"});var obj=this.getObjectToPostMessage("open");if(this.sendPostMessageToFrame(obj),!_widget.usable)return!1;WBK.settings.windowQuizOpened=!0,_widget.$modalOverflow.show(),_widget.$modalWrap.show(),this.hideWidget(),WBK.settings.windowInvaderOpened&&(wsInvader.widget.window.find(".cbk-support-new-message-copyright").hide(),wsInvader.widget.window.hide()),WBK.settings.callbackEnabled&&wsKiller.widget.btn.hide(),WBK.settings.windowInvaderOpened&&(wsInvader.widget.window.find(".cbk-support-new-message-copyright").hide(),wsInvader.widget.window.hide()),WBK.settings.callbackEnabled&&wsKiller.widget.btn.hide(),WBK.settings.chatEnabled&&(WBK.settings.chatBtnOpened&&wsChat.widget.btn.hide(),WBK.settings.chatWindowOpened&&wsChat.widget.window.hide()),WBK.settings.multiButtonId&&!WBK.settings.multiButtonHidden&&WBK.settings.multiButtonOpened&&wsMultiButton.hideWidget(),WBK.settings.chatInvitationOpened&&wsChat.hideInvitation(),WBK.settings.loanerId&&"mobile"!==WBK.settings.device&&wsLoaner.hideWidget(),WBK.settings.videoWidgetId&&WBK.settings.videoWidgetOpened&&wsVideoWidget.closeWidget(),_this.quizIntegrated||_this.sendEvents("show",type_open)}},hideWindow:function(){if(!_widget.usable)return!1;if("mobile"!==WBK.settings.device||$("[id^='integrate-quiz-element']").length||(_widget.$window.data("noViewport")?(_widget.$window.data("noViewport",0),$("meta[name=viewport]").attr("content","")):$("meta[name=viewport]").attr("content",_widget.$window.data("oldViewport")),$("body").removeClass("cbk-body-mobile").css("width","auto"),$(window).scrollTop(_settings.scrollTop),$(window).scrollLeft(_settings.scrollLeft)),WBK.settings.windowQuizOpened=!1,_settings.showWindowReapperanceTimeout){var d=new Date;d.setDate(d.getDate()+parseInt(_settings.showWindowReapperanceTimeout)),wsUtil.setCookie("WhiteQuiz_noShowWindow",1,d)}else wsUtil.setCookie("WhiteQuiz_noShowWindow",1);this.sendGoal("cancel"),_widget.$modalOverflow.hide(),_widget.$modalWrap.hide(),_settings.show_button_on_site&&this.showWidget(),WBK.settings.chatEnabled&&(WBK.settings.chatBtnOpened&&wsChat.widget.btn.show(),WBK.settings.chatWindowOpened&&wsChat.widget.window.show()),WBK.settings.windowInvaderOpened&&wsInvader.showWidget(),WBK.settings.callbackEnabled&&1!==wsKiller.settings.hideBtn&&wsKiller.settings.btnShow&&wsKiller.widget.btn.show(),WBK.settings.multiButtonId&&WBK.settings.multiButtonEnabled&&wsMultiButton.reInitWidget(),WBK.settings.loanerId&&wsLoaner.showWidget(),jWS(window).trigger("envy:resize")},consoleLog:function(message,data){"undefined"==typeof data?console.log(message):console.log(message,data)},log:function(){},sendEvents:function(type,type_open){var url=WBK.settings.serverUrl+"/api?action=quizEvent&callback=?";$.getJSON(url,{event:type,openType:type_open,quizStatId:this.quizStatId,quizId:this.quizId,code:WBK.settings.whiteSaasCode,visitId:WBK.settings.visitId,visitorId:WBK.settings.visitorId},function(result){"undefined"!=typeof result.Data.quizStatId&&("show"===type?this.quizStatId=result.Data.quizStatId:this.quizStatId=null)})},sendGoal:function(type,questionGoal){var yaGoal,gaGoal,mailGoal,gaCategory="Quiz",facebook=!1;switch(type){case"click":yaGoal="QUIZ_CLICK",gaGoal=mailGoal="ClickQuiz";break;case"cancel":yaGoal="QUIZ_CANCEL",gaGoal=mailGoal="CancelQuiz";break;case"send":yaGoal="QUIZ_LEAD",gaGoal=mailGoal=facebook="LeadQuiz";break;case"showauto":yaGoal="QUIZ_SHOW_AUTO",gaGoal="ShowAutoQuiz";break;case"answeredQuestion":gaGoal=void 0!==questionGoal?mailGoal=yaGoal=questionGoal:yaGoal=""}wsUtil.sendGoal(yaGoal,gaGoal,gaCategory,!1,facebook)},sendDataToLoadedIframe:function(){if(WBK.settings.phoneMasks){var listRU=$.masksSort(WBK.settings.phoneMasks,["#"],/[0-9]|#/,"mask"),optsRU={inputmask:{definitions:{"#":{validator:"[0-9]",cardinality:1}},clearIncomplete:!1,showMaskOnHover:!1,autoUnmask:!0},match:/[0-9]/,replace:"#",list:listRU,listKey:"mask"},data={optsRU:optsRU},obj=this.getObjectToPostMessage("load");obj.data=data,obj.integrateToSite=$("#integrate-quiz-element-"+this.quizId).length||WBK.settings.quizId===this.quizId&&$("#integrate-quiz-element").length,this.sendPostMessageToFrame(obj)}},sendPostMessageToFrame:function(data){var frame=document.getElementById("ws-quiz-iframe-"+this.quizId).contentWindow;frame.postMessage(data,"*")}}},wsVideoWidget=function($){function makeUrl(url,params){var glue="?";return url.search(/\?/)>=0&&(glue="&"),url+glue+$.param(params)}var _windowTemplate,_widget={},_settings={};return{settings:{lang_text:{iframe_warning:"Ваш браузер не поддерживает плавающие фреймы"},hasHash:!1,eventsLoaded:!1},init:function(settings,videoWidgetId){if($.fn._frameCheck()&&"undefined"==typeof WBK)var WBK=document.WBK;WBK&&WBK.checkDebug()&&(this.log=this.consoleLog),_settings=this.settings,this.loader(settings,videoWidgetId)},loader:function(settings,videoWidgetId){this.setSettings(settings),this.videoWidgetId=videoWidgetId,WBK.settings.videoWidgetId||(WBK.settings.videoWidgetId=this.videoWidgetId),wsUtil.getCookie("WhiteVideoWidget_closed_"+WBK.settings.videoWidgetId)||(this.setTemplate(),this.initWidget())},setSettings:function(settings){$.extend(!0,_settings,settings)},setTemplate:function(){_windowTemplate="<div class='ws-video-widget'><iframe id='ws-video-widget-iframe-"+this.videoWidgetId+"' class='ws-video-widget-frame'>"+_settings.lang_text.iframe_warning+"</iframe></div>"},prepareSettings:function(){$.each(_settings.video_variants,function(index,videoVariant){videoVariant.settings.name=wsUtil.htmlEscape(wsUtil.decorateText(videoVariant.settings.name))})},initWidget:function(){var _this=this,body=$("body");WBK.loadFont();var $windowTemplate=$(_windowTemplate),params={},url;params.code=WBK.settings.whiteSaasCode,params.widgetId=this.videoWidgetId,params.noajax=!0,url=makeUrl(WBK.settings.serverUrl+"/api/video_widget/"+this.videoWidgetId+"/?action=show",params),_settings.safari=navigator.userAgent.indexOf("Safari")>-1&&navigator.userAgent.indexOf("Chrome")===-1,_widget.container=$windowTemplate,_widget.container.hide(),_widget.$frame=$windowTemplate.find(".ws-video-widget-frame"),_widget.$frame.attr("src",url);var videoWidgetClassId="ws-video-widget-id-"+this.videoWidgetId;$windowTemplate.addClass(videoWidgetClassId),$windowTemplate.addClass(_settings.zoom_widget_on_view+"-size"),$windowTemplate.css("transform-origin",_settings.position_x+" "+_settings.position_y),+_settings.show_video_frame&&$windowTemplate.addClass("video-widget-border"),$windowTemplate.addClass(_settings.orientation_type),_widget.$window=body.append($windowTemplate).find("."+videoWidgetClassId),_this.initPosition(),window.video_widget=this,$(window).on("message.video-widget",function(event){var data=event.originalEvent.data;if(+data.videoWidgetId===_this.videoWidgetId&&"video_widget"===data.widget)switch(data.action){case"show_widget":return _settings.safari||_this.setWidgetStyles(),_this.showWidgetBySetting(),void(_settings.safari&&setTimeout(function(){_this.setWidgetStyles()},500));case"iframe_events_loaded":return _settings.eventsLoaded||(_settings.eventsLoaded=!0),_this.prepareSettings(),WBK.settings.videoWidgetIframeEventsLoaded=!0,void _this.sendDataToLoadedIframe();case"update_volume_level":return void wsUtil.setStorage("ws_video_widget_volume_level",data.value);case"open_full_version":return _widget.container.addClass("video-widget-full"),WBK.settings.videoWidgetOpened=!0,void _this.sendGoal("preview_click");case"close_full_version":return _widget.container.removeClass("video-widget-full"),void(WBK.settings.videoWidgetOpened=!1);case"close":var date=new Date;return"minutes"===_settings.repeat_show_type?date.setMinutes(date.getMinutes()+_settings.repeat_show_time):"days"===_settings.repeat_show_type&&date.setDate(date.getDate()+_settings.repeat_show_time),wsUtil.setCookie("WhiteVideoWidget_closed_"+WBK.settings.videoWidgetId,!0,date),WBK.settings.videoWidgetOpened=!1,void _this.hideWidget();case"btn_action_click":return _this.sendGoal("button_click"),void _this.sendEvents(_settings.video_variants[data.videoVariantIndex].id,"btn_click","btn");case"send_advert_stat":return void WBK.sendAdvertLinkStat("video_widget",data.href,data.text,data.widgetId);case"execute_btn_action":switch(data.btnAction){case"url":window.location.href=data.url;break;case"killer":if(+_settings.video_variants[data.videoVariantIndex].settings.open_widget_id===+WBK.settings.killerId){var d=new Date;d.setMinutes(d.getMinutes()+144e3),wsUtil.setCookie("WhiteCallback_shownOn","on_video_widget",d),wsKiller.showWindow("video_widget")}break;case"generator":+_settings.video_variants[data.videoVariantIndex].settings.open_widget_id===+WBK.settings.generatorId&&wsGenerator.showWidget("video_widget");break;case"chat":+_settings.video_variants[data.videoVariantIndex].settings.open_widget_id===+WBK.settings.chatWidgetId&&wsChat.showWidget();bwsQuizzes[WBK.settings.quizId].showWindow("video_widget");break;case"javascript":eval(_settings.video_variants[data.videoVariantIndex].settings.action_javascript)}return;case"event":return void _this.sendEvents(_settings.video_variants[data.videoVariantIndex].id,data.type,data.openType);case"send":var url=WBK.settings.serverUrl+"/api?action=videoWidgetLeadAdd",sendData={code:WBK.settings.whiteSaasCode,info:data.info,visitId:WBK.settings.visitId,visitorId:WBK.settings.visitorId,videoWidgetId:_this.videoWidgetId,videoWidgetVariantId:_settings.video_variants[data.videoVariantIndex].id,url:"string"==typeof document.URL?document.URL:"",phoneMask:data.phoneMask,roistatPromo:wsUtil.getRoistatPromo(),advertiseId:wsUtil.getAdvertiseId(),calltrackingId:wsUtil.getCalltrackingId(),lpgeneratorId:wsUtil.getLPGeneratorId(),leadvertexId:wsUtil.getLeadvertexId(),googleClietExternalParams()};$.post(url,sendData,function(result){if(result.Success){if(_this.sendGoal("send"),WBK.setVisitorInfoIfNot(sendData.info),"function"==typeof window.ws_OnVideoWidgetSendLead&&window.ws_OnVideoWidgetSendLead(sendData),sendData.info.phone&&_settings.auto_call&&WBK.settings.callbackEnabled&&parseInt(_settings.ispayed)){wsKiller.settings.callingWidget=!0;var d=new Date;d.setMinutes(d.getMinutes()+144e3),wsUtil.setCookie("WhiteCallback_shownOn","on_video_widget",d),WBK.settings.phoneMask=_settings.video_variants[data.videoVariantIndex].settings.use_telephony_mask?sendData.phoneMask:WBK.numberMask(sendData.info.phone).mask,wsKiller.newCall(sendData.info.phone,!1,_settings.auto_call_deferred,_settings.auto_call_deferred_delay)}if("go_url"===_settings.video_variants[data.videoVariantIndex].settings.send_action&&_settings.video_variants[data.videoVariantIndex].settings.send_action_url&&"new_page"!==_settings.video_variants[data.videoVariantIndex].settings.page_open_type){var match=wsUtil.parseURL(_settings.video_variants[data.videoVariantIndex].settings.send_action_url);match.scheme||(_settings.video_variants[data.videoVariantIndex].settings.send_action_url="http://"+_settings.video_variants[data.videoVariantIndex].settings.send_action_url),window.location.href=_settings.video_variants[data.videoVariantIndex].settings.send_action_url}}},"json")}})},setWidgetStyles:function(){if(+_settings.show_video_frame&&(WBK.addStyles(".ws-video-widget .ws-video-widget-frame{border-color: "+_settings.color_video_frame+";background-color: "+_settings.color_video_frame+";}"),WBK.addStyles(".ws-video-widget .ws-video-widget-frame:hover{border-color: "+_settings.color_hover_video_frame+"!important;background-color: "+_settings.color_hover_video_frame+"!important;}")),WBK.addStyles(".ws-video-widget-frame{-webkit-box-shadow: 0 14px 21px 0 rgba(0, 0, 0, 0.15);-moz-box-shadow: 0 14px 21px 0 rgba(0, 0, 0, 0.15);box-shadow: 0 14px 21px 0 rgba(0, 0, 0, 0.15);}.ws-video-widget .ws-video-widget-frame:hover{-webkit-box-shadow: 0 14px 21px 0 rgba(0, 0, 0, 0.25);-moz-box-shadow: 0 14px 21px 0 rgba(0, 0, 0, 0.25);box-shadow: 0 14px 21px 0 rgba(0, 0, 0, 0.25);}.ws-video-widget.video-widget-border .ws-video-widget-frame{border-width: 3px;border-style: solid;-webkit-transition: background-color 0.3s ease, border-color 0.3s ease, border-radius 0.3s ease, box-shadow 0.3s ease-out, border-width 1s ease-in, border-style 1s ease-in;transition: background-color 0.3s ease, border-color 0.3s ease-out, border-radius 0.3s ease-out, box-shadow 0.3s ease-out, border-width 1s ease-in, border-style 1s ease-in;}"),
"pc"!==WBK.settings.device){var widthToCheck={horizontal:{large:548,medium:500,small:450},vertical:{large:380,medium:330,small:280}};if(widthToCheck.hasOwnProperty(_settings.orientation_type)&&widthToCheck[_settings.orientation_type].hasOwnProperty(_settings.zoom_widget_on_view)){var needWidth=widthToCheck[_settings.orientation_type][_settings.zoom_widget_on_view];if(window.innerWidth<needWidth)WBK.addStyles(".ws-video-widget.video-widget-full{max-width: "+window.innerWidth+"px;"+_settings.positionX+":0!important;}");else if(window.innerWidth-window.innerWidth*_settings.position_x_value/100<needWidth){var setMobilePosition=(window.innerWidth-needWidth)/2;setMobilePosition=setMobilePosition>0?ss(".ws-video-widget.video-widget-full{"+_settings.positionX+":"+setMobilePosition+"px!important;}")}}}},showWidgetBySetting:function(){var _this=this;if("opened"===_settings.start_show)return void this.showWidget();if("paused"===_settings.start_show){var openSeconds=_settings.show_paused_time;if("site"===_settings.paused_sec_target){var timeAfterFirstLogin=wsUtil.getCookie("WhiteCallback_timeAll");timeAfterFirstLogin&&(+timeAfterFirstLogin<+openSeconds?openSeconds-=timeAfterFirstLogin:openSeconds=0)}return void wsUtil.setInterval("VideoWidgetTimer",function(){WBK.checkWidgetOpened("video_widget")&&(wsUtil.deleteInterval("VideoWidgetTimer"),_this.showWidget())},1e3*openSeconds)}"scroll"===_settings.start_show&&$(window).on("scroll.video-widget-container",function(){var scroll=$(window).scrollTop(),scrollH=$(document).height()-$(window).height(),scrolled=scroll/scrollH*100;_settings.show_scroll_percent<=scrolled&&(_this.showWidget(),$(window).off("scroll.video-widget-container"))})},initPosition:function(){var css={};switch(_settings.position_x){case"left":css.left=_settings.position_x_value+"%",css.right="auto",_settings.positionX="left";break;case"right":css.right=_settings.position_x_value+"%",css.left="auto",_settings.positionX="right"}switch(_settings.position_y){case"bottom":css.bottom=_settings.position_y_value+"%",css.top="auto";break;case"top":css.top=_settings.position_y_value+"%",css.bottom="auto"}_widget.container.css(css)},showWidget:function(){_widget.container&&_widget.container.show()},hideWidget:function(){_widget.container&&_widget.container.hide()},closeWidget:function(){this.sendPostMessageToFrame(this.getObjectToPostMessage("close")),WBK.settings.videoWidgetOpened=!1},getObjectToPostMessage:function(action){if(action)return{widget:"video_widget",action:action}},consoleLog:function(message,data){"undefined"==typeof data?console.log(message):console.log(message,data)},sendEvents:function(videoWidgetVariantId,type,openType){var url=WBK.settings.serverUrl+"/api?action=videoWidgetEvent&callback=?";$.getJSON(url,{event:type,openType:openType,videoWidgetId:this.videoWidgetId,videoWidgetVariantId:videoWidgetVariantId,code:WBK.settings.whiteSaasCode,visitId:WBK.settings.visitId,visitorId:WBK.settings.visitorId},function(result){})},sendGoal:function(type){var yaGoal,gaGoal,mailGoal,yagla=!1,gaCategory="VideoWidget",facebook=!1;switch(type){case"preview_click":yaGoal="VIDEOWIDGET_PREVIEWCLICK",gaGoal=mailGoal="PreviewClickVideoWidget";break;case"button_click":yaGoal="VIDEOWIDGET_BUTTONCLICK",gaGoal=mailGoal="ButtonClickVideoWidget";break;case"send":yaGoal="VIDEOWIDGET_NEWLEAD",gaGoal=mailGoal=facebook="NewLeadVideoWidget",yagla="video-widget",wsUtil.sendUniversalGoal()}wsUtil.sendGoal(yaGoal,gaGoal,gaCategory,yagla,facebook)},sendDataToLoadedIframe:function(){var data={};if(WBK.settings.phoneMasks){var listRU=$.masksSort(WBK.settings.phoneMasks,["#"],/[0-9]|#/,"mask"),optsRU={inputmask:{definitions:{"#":{validator:"[0-9]",cardinality:1}},clearIncomplete:!1,showMaskOnHover:!1,autoUnmask:!0},match:/[0-9]/,replace:"#",list:listRU,listKey:"mask"};data.optsRU=optsRU}var obj=this.getObjectToPostMessage("setData");data.settings=_settings,data.volumeValue=wsUtil.getStorage("ws_video_widget_volume_level"),"undefined"!=typeof WBK&&(data.wbkSettings=WBK.settings,data.wbkSettings.socket&&delete data.wbkSettings.socket),data.settings.video_variants.length&&(data.settings.video_variants=JSON.parse(JSON.stringify(data.settings.video_variants))),obj.data=data,this.sendPostMessageToFrame(obj)},sendPostMessageToFrame:function(data){var frame=document.getElementById("ws-video-widget-iframe-"+this.videoWidgetId).contentWindow;frame.postMessage(data,"*")}}}(jWS),window.wsCallTracking=function($){var _debug,s,w,widget=function(){var template=$('<div class="ws-call-tracking"></div>');if(s.logo){var logo=$("<img>").attr("src",WBK.settings.staticServerUrl+"/uploaded/calltracking/"+WBK.settings.calltrackingId+"/logo/"+s.logo);switch(logo.css("width","40px").css("height","40px"),s.corner_type){case"rect":break;case"round":logo.css("border-radius","50%");break;case"smooth":default:logo.css("border-radius","3px")}template.append($("<div>").css("width","40px").css("height","40px").css("margin-right","4px").css("float","left").append(logo))}var before=$("<span>").css("display","inline-block").css("height","100%").css("vertical-align","middle"),inner=$("<span>").css("display","inline-block").css("vertical-align","middle").html(s.text);switch(template.append($("<div>").css("height","40px").css("overflow","hidden").append(before).append(inner)),template.css("padding","4px"),template.css("font-size","14px"),template.css("background-color",s.background_color).css("color",s.text_color),s.corner_type){case"rect":break;case"round":template.css("border-radius","24px");break;case"smooth":default:template.css("border-radius","6px")}this.show(template)},plain=function(){this.show(s.phone)},drivers={itself:{x:function(widget){var x=Math.round($(window).width()/100*s.position_x);return x+widget.outerWidth()>=$(window).width()&&(x=$(window).width()-widget.outerWidth()),x},y:function(widget){var y=Math.round($(window).height()/100*s.position_y);return y+widget.outerHeight()>=$(window).height()&&(y=$(window).height()-widget.outerHeight()),y},show:function(widget){widget.css({position:"fixed","z-index":"999999","max-width":"350px",height:"48px"}),widget.appendTo("body"),widget.css({left:this.x(widget)+"px",top:this.y(widget)+"px"})}},phone:{_:$(".ws-integrate-calltracking-phone"),show:function(widget){$(this._).html($("<a>").attr("href","tel:"+widget).html(widget))}}};return{settings:{},widget:{},log:function(mess){_debug&&wsUtil.log("CALLTRACKING: "+mess)},run:function(data){s=this.settings,w=this.widget,_debug=WBK.checkDebug(),$.fn._frameCheck()&&"undefined"==typeof WBK&&(WBK=document.WBK),WBK.settings.calltrackingId=data.Settings.calltrackingId,"function"==typeof window.ws_OnCallTrackingBeforeInit&&window.ws_OnCallTrackingBeforeInit();try{this.init(data.Data.calltracking),this.load(),WBK.initSocket(),"function"==typeof window.ws_OnCallTrackingLaunched&&window.ws_OnCallTrackingLaunched()}catch(e){this.log(e.message),"function"==typeof window.ws_OnCallTrackingFailedInit&&window.ws_OnCallTrackingFailedInit(e)}finally{"function"==typeof window.ws_OnCallTrackingAfterInit&&window.ws_OnCallTrackingAfterInit()}},init:function(settings){if(!settings.ispayed)throw new Error("Виджет не оплачен");s.logo=settings.logo,s.phone=settings.phone,s.text=settings.text.replace("[телефон]",settings.phone),s.text_color=settings.text_color,s.background_color=settings.background_color,s.corner_type=settings.corner_type,s.type=settings.type,s.position_x=settings.position_x,s.position_y=settings.position_y,s.country=settings.country},load:function(){switch(s.type){case"itself":widget.call(drivers.itself);break;case"phone":plain.call(drivers.phone);break;default:this.log('"'+s.type+'" is not defined')}},onSocket:function(event){switch(event.name){case"call":wsUtil.sendGoal(event.ya_goal,event.ga_goal,event.ga_category,!1,!1)}}}}(jWS),wsFormCustomizer=function($){var _this,s,_debug;return{settings:{},haveClass:{name:!1,phone:!1,email:!1},init:function(data){_this=this,s=this.settings,$.fn._frameCheck()&&"undefined"==typeof WBK&&(WBK=document.WBK),_debug=WBK.checkDebug();try{_this.loader(data)}catch(e){_this.log(e.message)}},loader:function(res){var data=res.Data.form_customizer;if(!data.ispayed)throw new Error("Виджет не оплачен");_this.setSettings.formCustomizerId=parseInt(res.Settings.formCustomizerId),_this.start()},start:function(){var forms=$(".ws-formcustom-form");0===forms.length&&(forms=$("form, div[plp-form-container]")),_this.checkForms(forms);var dat.eaciframe.contentDocument){var forms=$(_iframe.contentWindow.document).find("form");if(!forms.length)return;_this.checkForms(forms)}}catch(e){}}),$(document).find("iframe").each(function(){var _iframe=this;try{if(_iframe.contentWindow&&_iframe.contentDocument){var forms=$(_iframe.contentWindow.document).find("form");if(!forms.length)return;var data=_this.paster(forms);dataIframesForms=dataIframesForms?_this.mergeStatData(dataIframesForms,data):data}}catch(e){}})}catch(e){}var stat=_this.paster(forms);dataIframesForms&&(stat=_this.mergeStatData(stat,dataIframesForms)),_this.sendStat(stat)},mergeStatData:function(stat,newStat){return newStat.count&&(stat.count+=newStat.count,stat.email=stat.email||newStat.email,stat.name=stat.name||newStat.name,stat.phone=stat.phone||newStat.phone),stat},checkForms:function(forms){forms.find("input.ws-formcustom-phone").length&&(this.haveClass.phone=!0),forms.find("input.ws-formcustom-email").length&&(this.haveClass.email=!0),forms.find("input.ws-formcustom-name").length&&(this.haveClass.name=!0)},paster:function(forms){var stat={count:0,name:"",phone:"",email:""};if(s.fill_phone&&WBK.settings.visitorPhone){var phonePushedCount=0,inputsWithPhoneClass=forms.find("input.ws-formcustom-phone"),inputsWithPhoneClassCount=inputsWithPhoneClass.length;if(inputsWithPhoneClassCount)inputsWithPhoneClass.val(WBK.settings.visitorPhone),phonePushedCount+=inputsWithPhoneClassCount;else if(!this.haveClass.phone){var inputsPhone=forms.find("input").filter(function(){return!$(this).val()&&("tel"===this.type||this.placeholder&&this.placeholder.match(/phone|tel\.?$|^[+]*[(]{0,1}[0-9]{1,4}[)]{0,1}[-\\s\\.\\\/0-9]{0,11}$|телефон|тел.?$/gi)||this.id&&$("[for='"+this.id+"']").text().match(/phone|tel.?$|телефон|тел.?$/gi)||this.name&&this.name.match(/phone|телефон|tel.?$/gi)||this.id&&this.id.match(/phone|телефон|tel.?$/gi)||this.value&&this.value.match(/phone|телефон|tel.?$/gi)||this.autocomplete&&this.autocomplete.match(/phone|телефон|tel/gi))||$(this).val()&&this.value&&this.value.match(/phone|телефон|tel.?$/gi)}),inputsPhoneCount=inputsPhone.length;inputsPhoneCount&&(inputsPhone.val(WBK.settings.visitorPhone),phonePushedCount=inputsPhoneCount)}phonePushedCount&&(stat.count+=phonePushedCount,stat.phone=WBK.settings.visitorPhone)}if(s.fill_email&&WBK.settings.visitorEmail){var emailPushedCount=0,inputsWithEmailClass=forms.find("input.ws-formcustom-email"),inputsWithEmailClassCount=inputsWithEmailClass.length;if(inputsWithEmailClassCount)inputsWithEmailClass.val(WBK.settings.visitorEmail),emailPushedCount=inputsWithEmailClassCount;else if(!this.haveClass.email){var inputsEmail=forms.find("input").filter(function(){return!$(this).val()&&("email"===this.type||this.placeholder.match(/email|емейл|электр.* почт|^(([^<>()\[\]\.,;:\s@\"]+(\.[^<>()\[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})/gi)||this.id&&$("[for='"+this.id+"']").text().match(/email|емейл|электр.* почт/gi)||this.name.match(/email|емейл|электр.* почт/gi)||this.id.match(/e?mail/gi)||this.value&&this.value.match(/e?mail/gi)||this.autocomplete&&this.autocomplete.match(/e?mail/gi))}),inputsEmailCount=inputsEmail.length;inputsEmailCount&&(inputsEmail.val(WBK.settings.visitorEmail),emailPushedCount=inputsEmailCount)}emailPushedCount&&(stat.count+=emailPushedCount,stat.email=WBK.settings.visitorEmail)}if(s.fill_name&&WBK.settings.visitorName){var namePushedCount=0,inputsWithNameClass=forms.find("input.ws-formcustom-name"),inputsWithNameClassCount=inputsWithNameClass.length;if(inputsWithNameClassCount)inputsWithNameClass.val(WBK.settings.visitorName),namePushedCount=inputsWithNameClassCount;else if(!this.haveClass.name){var inputsName=forms.find("input").filter(function(){return!$(this).val()&&(("text"===this.type||""===this.type)&&this.placeholder.match(/name|имя|фио/gi)||this.id&&$("[for='"+this.id+"']").text().match(/name|имя|фио/gi)||this.name.match(/name/gi)||this.id.match(/name|fio/gi)||this.value&&this.value.match(/name|имя|fio/gi)||this.autocomplete&&this.autocomplete.match(/name|fio/gi))||$(this).val()&&this.value&&this.value.match(/name|имя|fio/gi)}),inputsNameCount=inputsName.length;inputsNameCount&&(inputsName.val(WBK.settings.visitorName),namePushedCount=inputsNameCount)}namePushedCount&&(stat.count+=namePushedCount,stat.name=WBK.settings.visitorName)}return stat},sendStat:function(stat){if(!stat.count)return void this.sendStatToYametrics(!1);this.sendStatToYametrics(!0);var url=WBK.settings.serverUrl+"/api?action=formCustomizerStat&callback=?";$.getJSON(url,{stat:stat,formCustomizerId:WBK.settings.formCustomizerId,code:WBK.settings.whiteSaasCode},function(result){})},sendStatToYametrics:function(substitution){for(var el in window)try{"string"==typeof el&&el.match(/yaCounter\w+/)&&"undefined"!=typeof window[el]&&window[el].params({substitution:substitution})}catch(e){}},setSettings:function(settings){$.extend(!0,s,settings)},log:function(mess){_debug&&wsUtil.log("FORM_CUSTOMIZER: "+mess)}}}(jWS);