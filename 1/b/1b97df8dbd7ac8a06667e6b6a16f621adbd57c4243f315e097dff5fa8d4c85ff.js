(function(){var _resolvedRequire=function(requirePath){var resolvedModule=function(filename){var path=require("path");if(filename.charAt(0)!==".")return filename;return path.resolve(path.dirname(module.parent.filename),filename)};var required=require(resolvedModule(requirePath));return required};var _getRemovedExtentionPath=function(filePath){var splitFilePath=filePath.match(/(\w*)(\.)?(js)?$/);var removedExtentionPath=splitFilePath[1];return removedExtentionPath};var Namespace=function(){var merge=var consoleEnabled=Boolean(window.console);var warnAvailable=consoleEnabled&&typeof console.warn==="function";function _warn(msg){const message="[Namespace] "+msg;if(consoleEnabled&&warnAvailable){console.warn(message)}else if(consoleEnabled){console.log(message)}try{throw new Error(message)}catch(error){window.dispatchEvent(new ErrorEvent("error",{message:message,error:error,filename:window.location?window.location.href:"namespace-1.0.1.js"}))}}var debugAvailable=consoleEnabled&&typeof console.debug==="function";var _debug=consoleEnabled?debugAvailable?function(msg){console.debug("[Namespace] "+msg)}:var _assertValidFQN=var Procedure=function _Private_Class_Of_Proc(){merge(this,{state:{},steps:[],_status:"init"})};merge(Procedure.prototype,{next:function(state){if(state)this.enqueue(state);return this},isRunning:enqueue:dequeue:call:function(initialState,callback){if(this.isRunning())throw new Error("do not run twice");this.state=initialState||{};this.enqueue(function($c){$c();if(callback)callback(this)});this._status="running";this._invoke()},_invoke:function(){var _self=this;var step=_self.dequeue();if(!step){_self._status="finished";return undefined}if(step.call){return step.call(_self.state,function _cont(state){if(state)_self.state=state;_self._invoke()})}var finishedProcess=0;if(step.length===0)_self._invoke();var _getJoinWait=function(l){return function _joinWait(){finishedProcess++;if(finishedProcess==l){_self._invoke()}}};for(var i=0,l=step.length;i<l;i++){step[i].call(_self.state,_getJoinWait(l))}return undefined}});var createProcedure=var NamespaceObject=function _Private_Class_Of_NamespaceObject(fqn){merge(this,{stash:{CURRENT_NAMESPACE:fqn},fqn:fqn,proc:createProcedure(),loaded:false})};merge(NamespaceObject.prototype,{enqueue:call:valueOf:merge:getStash:function(){return this.stash},getExport:function(importName){if(importName==="*")return this.stash;var importNames=importName.split(","),retStash={};for(var i=0,l=importNames.length;i<l;i++){var names=importNames[i].split("=>");if(1<names.length){retStash[names[1]]=this.stash[names[0]]}else{retStash[importNames[i]]=this.stash[importNames[i]]}}return retStash}});var NamespaceObjectFactory=function(){var cache={};return{create:function(fqn){_assertValidFQN(fqn);return cache[fqn]||(cache[fqn]=new NamespaceObject(fqn))}}}();var NamespaceDefinitionFactory=function(){var definedMap={};return{create:function(fqn){_assertValidFQN(fqn);var nsObj=NamespaceObjectFactory.create(fqn);if(fqn in definedMap){return new NamespaceDuplicatedDefinition(nsObj)}definedMap[fqn]=true;return new NamespaceDefinition(nsObj)}}}();var NamespaceDefinition=function _Private_Class_Of_NamespaceDefinition(nsObj){merge(this,{namespaceObject:nsObj,requires:[],useList:[],stash:{},defineCallback:undefined});var _self=this;nsObj.enqueue(};merge(NamespaceDefinition.prototype,{use:function(syntax){this.useList.push(syntax);var splitted=syntax.split(/\s+/);var fqn=splitted[0];splitted[0]="";var importName=splitted.join("");_assertValidFQN(fqn);this.requires.push(function($c){var context=this;var require=NamespaceObjectFactory.create(fqn);require.call(this,});return this},_mergeStashWithNS:function(nsObj){var nsList=nsObj.fqn.split(/\./);var current=this.getStash();for(var i=0,l=nsList.length;i<l-1;i++){if(!current[nsList[i]])current[nsList[i]]={};current=current[nsList[i]]}var lastLeaf=nsList[nsList.length-1];current[lastLeaf]=merge(current[lastLeaf]||{},nsObj.getStash())},loadImport:function(nsObj,importName){if(!nsObj.loaded){var sourceFqn=this.namespaceObject.fqn;var usedUndefinedFqn=nsObj.fqn;var message="Undefined module "+usedUndefinedFqn+" used by "+sourceFqn;_warn(message)}if(importName){merge(this.stash,nsObj.getExport(importName))}else{this._mergeStashWithNS(nsObj)}},define:function(callback){this._defineImpl(callback)},override:function(callback){this._defineImpl(callback)},_defineImpl:function(callback){var nsDef=this,nsObj=this.namespaceObject;this.defineCallback=function($c){var ns={provide:;merge(ns,nsDef.getStash());merge(ns,nsObj.getStash());callback(ns)}},import:function(requirePath){var nsDef=this,nsObj=this.namespaceObject;this.defineCallback=function($c){var stash={};var removedExtentionPath=_getRemovedExtentionPath(requirePath);stash[removedExtentionPath]=_resolvedRequire(requirePath);nsObj.merge(stash);$c()}},getStash:valueOf:apply:function(callback){this._applyImpl(callback)},_applyImpl:function(callback){var nsDef=this;createProcedure(nsDef.requires).next(nsDef.defineCallback).call(nsDef,}});var NamespaceDuplicatedDefinition=merge(merge(NamespaceDuplicatedDefinition.prototype,NamespaceDefinition.prototype),{define:function(callback){var nsObj=this.namespaceObject;var fqn=nsObj.fqn;_debug("Duplicated module found. Since Namespace.js v0.0.4+, "+"it ignore duplicated module definitions: "+fqn)},apply:function(callback){var nsObj=this.namespaceObject;var fqn=nsObj.fqn;_debug("Duplicated module found. Since Namespace.js v0.0.4+, "+"it ignore duplicated module applications: "+fqn)},override:function(callback){this._defineImpl(callback)}});var _anonymouseNamespaceCounter=0;var createNamespace=function(fqn){return NamespaceDefinitionFactory.create(fqn||"main_"+_anonymouseNamespaceCounter++)};merge(createNamespace,{Object:NamespaceObjectFactory,Definition:NamespaceDefinition,Proc:createProcedure});return createNamespace}();Namespace.use=Namespace.fromInternal=Namespace.GET=function(){var get=function(){var createRequester=function(){var xhr;try{xhr=new XMLHttpRequest}catch(e0){try{xhr=new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(e1){try{xhr=new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(e2){try{xhr=new ActiveXObject("Msxml2.XMLHTTP")}catch(e3){try{xhr=new ActiveXObject("Microsoft.XMLHTTP")}catch(e4){throw new Error("This browser does not support XMLHttpRequest.")}}}}}return xhr};var isSuccessStatus=function(status){return status>=200&&status<300||status==304||status==1223||!status&&(location.protocol=="file:"||location.protocol=="chrome:")};return function(url,callback){var xhr=createRequester();xhr.open("GET",url,true);xhr.onreadystatechange=function(){if(xhr.readyState===4){if(isSuccessStatus(xhr.status||0)){callback(true,xhr.responseText)}else{callback(false)}}};xhr.send("")}}();return function(url,isManualProvide){return function(ns){get(url,function(isSuccess,responseText){if(isSuccess){if(isManualProvide)return eval(responseText);else return ns.provide(eval(responseText))}else{var pub={};pub[url]="loading error";ns.provide(pub);return undefined}})}}}();Namespace.fromExternal=function(){var callbacks={};var createScriptElement=function(url,callback){var scriptElement=document.createElement("script");scriptElement.loaded=false;scriptElement.onload=scriptElement.onreadystatechange=function(){if(!/^(loaded|complete)$/.test(this.readyState))return;if(this.loaded)return;scriptElement.loaded=true;callback()};scriptElement.src=url;document.body.appendChild(scriptElement);return scriptElement.src};var domSrc=function(url){return function(ns){createScriptElement(url,function(){var name=ns.CURRENT_NAMESPACE;var cb=callbacks[name];delete callbacks[name];cb(ns)})}};domSrc.registerCallback=function(namespace,callback){callbacks[namespace]=callback};return domSrc}();Namespace.loadFile=function(){return function(filePath,namespace){Namespace(namespace||_getRemovedExtentionPath(filePath)).define(}}();try{window.Namespace=Namespace}catch(e){}try{module.exports=Namespace}catch(e){}})();Namespace("brook").define(function(ns){var VERSION="0.01";var Promise=function(next){this.next=next||;(function(proto){proto.concat=function(after){var _before=this;var next=return new Promise(next)};proto.bind=function(){var r=this;for(var i=0,l=arguments.length;i<l;i++){var s=arguments[i];s=s instanceof Promise?s:promise(s);r=r.concat(s)}return r};proto.ready=proto.run=proto.subscribe=function(next,val){var next=next?next:function(){};if(!this.errorHandler)return this.next(next,val);try{this.next(next,val)}catch(e){this.onError(e)}};proto.forEach=proto.subscribe;proto.setErrorHandler=function(promise){this.errorHandler=promise};proto.onError=function(e){(this.errorHandler||new Promise).subscribe(function(){},e)}})(Promise.prototype);var promise=function(next){return new Promise(next)};ns.provide({promise:promise,VERSION:VERSION})});Namespace("brook.util").use("brook promise").define(function(ns){var mapper=var through=function(f){return ns.promise(};var filter=function(f){return ns.promise(};var takeBy=function(by){var num=1;var queue=[];return ns.promise(function(next,val){queue.push(val);if(num++%by==0){next(queue);queue=[]}})};var scatter=function(){return ns.promise(};var wait=function(msec){var msecFunc=typeof msec=="function"?msec:function(){return msec};return ns.promise(function(next,val){setTimeout(function(){next(val)},msecFunc())})};var waitUntil=function(f){var p=function(next,val){if(f()){return next(val)}setTimeout(function(){p(next,val)},100)};return ns.promise(p)};var debug=function(sig){var sig=sig?sig:"debug";return through(};var cond=function(f,promise){return ns.promise(function(next,val){if(!f(val))return next(val);promise.subscribe(function(val){return next(val)},val)})};var ifelse=function(f,thenPromise,elsePromise){if(!elsePromise){elsePromise=thenPromise.or;thenPromise=thenPromise.then}return ns.promise(function(next,val){var promise=f(val)?thenPromise:elsePromise;promise.subscribe(next,val)})};var match=function(dispatchTable){return ns.promise(function(next,val){var promise=dispatchTable[val]||dispatchTable["__default__"]||ns.promise();promise.subscribe(val)})};var LOCK_MAP={};var unlock=function(name){return ns.promise(function(next,val){LOCK_MAP[name]=false;next(val)})};var lock=function(name){var tryLock=function(next,val){if(!LOCK_MAP[name]){LOCK_MAP[name]=true;return next(val)}setTimeout(100)};return ns.promise(tryLock)};var from=function(value){if(value.observe){return ns.promise(function(next,val){value.observe(ns.promise(function(n,v){next(v)}))})}return ns.promise(};var EMIT_INTERVAL_MAP={};var emitInterval=function(msec,name){var msecFunc=typeof msec=="function"?msec:return ns.promise(function(next,val){var id=setInterval(msecFunc());if(name){EMIT_INTERVAL_MAP[name]=id}})};var stopEmitInterval=function(name){return ns.promise(function(next,value){clearInterval(EMIT_INTERVAL_MAP[name]);next(value)})};ns.provide({mapper:mapper,through:through,filter:filter,scatter:scatter,takeBy:takeBy,wait:wait,cond:cond,ifelse:ifelse,match:match,debug:debug,lock:lock,unlock:unlock,from:from,waitUntil:waitUntil,emitInterval:emitInterval,stopEmitInterval:stopEmitInterval})});Namespace("brook.lambda").define(function(ns){var cache={};var hasArg=var parseExpression=function(expression){var fixed=hasArg(expression)?expression:"$->"+expression;var splitted=fixed.split("->");var argsExp=splitted.shift();var bodyExp=splitted.join("->");return{argumentNames:argsExp.split(","),body:hasArg(bodyExp)?lambda(bodyExp).toString():bodyExp}};var lambda=function(expression){if(cache[expression])return cache[expression];var parsed=parseExpression(expression);var func=new Function(parsed.argumentNames,"return ("+parsed.body+");");cache[expression]=func;return func};ns.provide({lambda:lambda})});Namespace("brook.channel").use("brook promise").define(function(ns){var Channel=(function(proto){var through=function(k){return k};proto.send=function(func){var func=func?func:through;var _self=this;return ns.promise(function(next,val){_self.sendMessage(func(val));next(val)})};proto.sendMessage=function(msg){this.queue.push(msg);while(this.queue.length){var v=this.queue.shift();for(var i=0,l=this.promises.length;i<l;i++){this.promises[i].run(v)}}};proto.observe=function(promise){for(var i=0;i<this.promises.length;i++){if(this.promises[i]===promise){return}}this.promises.push(promise)};proto.stopObserving=function(promise){for(var i=0;i<this.promises.length;i++){if(this.promises[i]===promise){this.promises.splice(i,1);i--}}}})(Channel.prototype);var channel=function(name){if(name){return getNamedChannel(name)}return new Channel};var NAMED_CHANNEL={};var getNamedChannel=function(name){if(NAMED_CHANNEL[name]){return NAMED_CHANNEL[name]}NAMED_CHANNEL[name]=new Channel;return NAMED_CHANNEL[name]};var observeChannel=function(name,promise){getNamedChannel(name).observe(promise)};var stopObservingChannel=function(name,promise){getNamedChannel(name).stopObserving(promise)};var sendChannel=ns.provide({channel:channel,sendChannel:sendChannel,observeChannel:observeChannel,stopObservingChannel:stopObservingChannel,createChannel:)});Namespace("brook.model").use("brook promise").use("brook.util *").use("brook.channel *").use("brook.lambda *").define(function(ns){var Model=function(obj){this.methods={};this.channels={};for(var prop in obj){if(!obj.hasOwnProperty(prop))continue;this.addMethod(prop,obj[prop])}};Model.prototype.addMethod=function(method,promise){if(this.methods[method])throw"already "+method+" defined";var channel=ns.createChannel();this.methods[method]=promise.bind(channel.send());this.channels[method]=channel;return this};Model.prototype.notify=Model.prototype.method=function(method){if(!this.channels[method])throw"do not observe undefined method";return this.channels[method]};var createModel=function(obj){return new Model(obj)};ns.provide({createModel:createModel})});Namespace("brook.view.htmltemplate.core").define(function(ns){var module={exports:{}};
/**
 * @author Daichi Hiroki <hirokidaichi@gmail.com>
 * @name html-template-core.js
 * @license MIT License
 * @link https://github.com/hirokidaichi/html-template
 */var util={};util.defineClass=function(obj,superClass){var klass=if(superClass)klass.prototype=new superClass;for(var prop in obj){if(!obj.hasOwnProperty(prop))continue;klass.prototype[prop]=obj[prop]}if(!klass.prototype.initialize)klass.prototype.initalize=function(){};return klass};util.merge=function(origin,target){for(var prop in target){if(!target.hasOwnProperty(prop))continue;origin[prop]=target[prop]}};util.k=function(k){return k};util.emptyFunction=util.listToArray=util.curry=function(){var args=util.listToArray(arguments);var f=args.shift();return ;util.merge(util,{isArray:isFunction:function(object){return typeof object=="function"},isString:function(object){return typeof object=="string"},isNumber:function(object){return typeof object=="number"},isUndefined:);util.createRegexMatcher=function(escapeChar,expArray){function _escape(regText){return(regText+"").replace(new RegExp(escapeChar,"g"),"\\")}var count=0;var e;var regValues={mapping:{fullText:[0]},text:[]};for(var i=0,l=expArray.length;i<l;i++){e=expArray[i];if(util.isString(e)){regValues.text.push(e);continue}if(!regValues.mapping[e.map]){regValues.mapping[e.map]=[]}regValues.mapping[e.map].push(++count)}var reg=undefined;regValues.text=_escape(regValues.text.join(""));return function matcher(matchingText){if(!reg){reg=new RegExp(regValues.text)}var results=(matchingText||"").match(reg);if(results){var ret={};var prop=0,i=0,map=regValues.mapping;for(prop in map){var list=map[prop];var length=list.length;for(i=0;i<length;i++){if(results[list[i]]){ret[prop]=results[list[i]];break}}}return ret}else{return undefined}}};var CHUNK_REGEXP_ATTRIBUTE=util.createRegexMatcher("%",["<","(%/)?",{map:"close"},"TMPL_","(VAR|LOOP|IF|ELSE|ELSIF|UNLESS|INCLUDE)",{map:"tag_name"},"%s*","(?:","(?:DEFAULT)=","(?:","'([^'>]*)'|",{map:"default"},'"([^">]*)"|',{map:"default"},"([^%s=>]*)",{map:"default"},")",")?","%s*","(?:","(?:ESCAPE)=","(?:",'(JS|URL|HTML|0|1|NONE|"0")',{map:"escape"},")",")?","%s*","(?:","(?:DEFAULT)=","(?:","'([^'>]*)'|",{map:"default"},'"([^">]*)"|',{map:"default"},"([^%s=>]*)",{map:"default"},")",")?","%s*","(?:","(NAME|EXPR)=",{map:"attribute_name"},"(?:","'([^'>]*)'|",{map:"attribute_value"},'"([^">]*)"|',{map:"attribute_value"},"([^%s=>]*)",{map:"attribute_value"},")",")?","%s*","(?:","(?:DEFAULT)=","(?:","'([^'>]*)'|",{map:"default"},'"([^">]*)"|',{map:"default"},"([^%s=>]*)",{map:"default"},")",")?","%s*","(?:","(?:ESCAPE)=","(?:",'(JS|URL|HTML|0|1|NONE|"0")',{map:"escape"},")",")?","%s*","(?:","(?:DEFAULT)=","(?:","'([^'>]*)'|",{map:"default"},'"([^">]*)"|',{map:"default"},"([^%s=>]*)",{map:"default"},")",")?","%s*",">"]);var element={};element.Base=util.defineClass({initialize:function(option){this.mergeOption(option)},mergeOption:function(option){util.merge(this,option);this["isCloseTag"]=this["isCloseTag"]?true:false},isParent:util.emptyFunction,execute:util.emptyFunction,getCode:toString:function(){return["<",this.isCloseTag?"/":"",this.type,this.hasName?" NAME=":"",this.name?this.name:"",">"].join("")},_pathLike:function(attribute,matched){var pos=matched=="/"?"0":"$_C.length -"+(matched.split("..").length-1);return["(($_C["+pos+"]['",attribute,"']) ? $_C["+pos+"]['",attribute,"'] : undefined )"].join("")},getParam:function(){var ret="";if(this.attributes["name"]){var matched=this.attributes["name"].match(/^(\/|(?:\.\.\/)+)(\w+)/);if(matched){return this._pathLike(matched[2],matched[1])}var _default=this.attributes["default"]?"'"+this.attributes["default"]+"'":"undefined";ret=["(($_T['",this.attributes["name"],"']) ? $_T['",this.attributes["name"],"'] : ",_default," )"].join("")}if(this.attributes["expr"]){var operators={gt:">",lt:"<",eq:"==",ne:"!=",ge:">=",le:"<="};var replaced=this.attributes["expr"].replace(/{(\/|(?:\.\.\/)+)(\w+)}/g,function(full,matched,param){return["$_C[",matched=="/"?"0":"$_C.length -"+(matched.split("..").length-1),']["',param,'"]'].join("")}).replace(/\s+(gt|lt|eq|ne|ge|le|cmp)\s+/g,;ret=["(function(){","    with($_F){","        with($_T){","            return (",replaced,");","}}})()"].join("")}if(this.attributes["escape"]){var _escape={NONE:"NONE",0:"NONE",'"0"':"NONE",1:"HTML",HTML:"HTML",JS:"JS",URL:"URL"}[this.attributes["escape"]];ret=["$_F.__escape"+_escape+"(",ret,")"].join("")}return ret}});var cache={STRING_FRAGMENT:[]};util.merge(element,{ROOTElement:util.defineClass({type:"root",getCode:function(){if(this.isCloseTag){return'return $_R.join("");'}else{return["var $_R  = [];","var $_C  = [param];","var $_F  = funcs||{};","var $_T  = param||{};","var $_S  = cache.STRING_FRAGMENT;"].join("")}}},element.Base),LOOPElement:util.defineClass({type:"loop",initialize:getLoopId:function(){if(this._ID){return this._ID}if(!element.LOOPElement.instanceId){element.LOOPElement.instanceId=0}var id=element.LOOPElement.instanceId++;this._ID="$"+id.toString(16);return this._ID},getCode:function(){if(this.isCloseTag){return["}","$_T = $_C.pop();"].join("")}else{var id=this.getLoopId();return["var $_L_"+id+" ="+this.getParam()+"|| [];","var $_LL_"+id+" = $_L_"+id+".length;","$_C.push($_T);","for(var i_"+id+"=0;i_"+id+"<$_LL_"+id+";i_"+id+"++){","   $_T = (typeof $_L_"+id+"[i_"+id+'] == "object")?',"                $_L_"+id+"[i_"+id+"] : {};","$_T['__first__'] = (i_"+id+" == 0) ? true: false;","$_T['__counter__'] = i_"+id+"+1;","$_T['__odd__']   = ((i_"+id+"+1)% 2) ? true: false;","$_T['__last__']  = (i_"+id+" == ($_LL_"+id+" - 1)) ? true: false;","$_T['__inner__'] = ($_T['__first__']||$_T['__last__'])?false:true;"].join("")}}},element.Base),VARElement:util.defineClass({type:"var",getCode:function(){if(this.isCloseTag){throw new Error("HTML.Template ParseError TMPL_VAR")}else{return"$_R.push("+this.getParam()+");"}}},element.Base),IFElement:util.defineClass({type:"if",getCondition:function(param){return"!!"+this.getParam(param)},getCode:function(){if(this.isCloseTag){return"}"}else{return"if("+this.getCondition()+"){"}}},element.Base),ELSEElement:util.defineClass({type:"else",getCode:function(){if(this.isCloseTag){throw new Error("HTML.Template ParseError No Close Tag for TMPL_ELSE")}else{return"}else{"}}},element.Base),INCLUDEElement:util.defineClass({type:"include",getCode:function(){if(this.isCloseTag){throw new Error("HTML.Template ParseError No Close Tag for TMPL_INCLUDE")}else{var name='"'+this.attributes["name"]+'"';return["$_R.push($_F.__include(",name,",$_T,$_F));"].join("\n")}}},element.Base),TEXTElement:util.defineClass({type:"text",isCloseTag:false,initialize:getCode:function(){if(this.isCloseTag){throw new Error("HTML.Template ParseError No Close Tag for TEXT")}else{cache.STRING_FRAGMENT.push(this.value);return"$_R.push($_S["+(cache.STRING_FRAGMENT.length-1)+"]);"}}},element.Base)});element.ELSIFElement=util.defineClass({type:"elsif",getCode:function(){if(this.isCloseTag){throw new Error("HTML.Template ParseError No Close Tag for TMPL_ELSIF")}else{return"}else if("+this.getCondition()+"){"}}},element.IFElement);element.UNLESSElement=util.defineClass({type:"unless",getCondition:,element.IFElement);element.createElement=function(type,option){return new element[type+"Element"](option)};var parseHTMLTemplate=function(source){var chunks=[];var createElement=element.createElement;var root=createElement("ROOT",{isCloseTag:false});var matcher=CHUNK_REGEXP_ATTRIBUTE;chunks.push(root);while(source.length>0){var results=matcher(source);if(!results){chunks.push(createElement("TEXT",source));source="";break}var index=0;var fullText=results.fullText;if((index=source.indexOf(fullText))>0){var text=source.slice(0,index);chunks.push(createElement("TEXT",text));source=source.slice(index)}var attr,name,value;if(results.attribute_name){name=results.attribute_name.toLowerCase();value=results.attribute_value;attr={};attr[name]=value;attr["default"]=results["default"];attr["escape"]=results["escape"]}else{attr=undefined}chunks.push(createElement(results.tag_name,{attributes:attr,isCloseTag:results.close,parent:this}));source=source.slice(fullText.length)}chunks.push(createElement("ROOT",{isCloseTag:true}));return chunks};module.exports.getFunctionText=function(chunksOrSource){var chunks=util.isString(chunksOrSource)?parseHTMLTemplate(chunksOrSource):chunksOrSource;var codes=[];for(var i=0,l=chunks.length;i<l;i++){codes.push(chunks[i].getCode())}return codes.join("\n")};module.exports.compileFunctionText=function(functionText){return util.curry(new Function("cache","param","funcs",functionText),cache)};ns.provide(module.exports)});Namespace("brook.view.htmltemplate").use("brook.view.htmltemplate.core *").define(function(ns){var merge=function(origin,target){for(var prop in target){if(!target.hasOwnProperty(prop))continue;origin[prop]=target[prop]}};var meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};var _map=function(list,mapper){var result=[];for(var i=0,l=list.length;i<l;i++){result.push(mapper(list[i]))}return result};var quote=function(str){return'"'+_map(str.split(""),.join("")+'"'};var GLOBAL_FUNC={__escapeHTML:__escapeJS:function(str){return quote(str)},__escapeURL:__escapeNONE:__include:function(name,param,func){var tmpl=Klass.getByElementId(name);if(!tmpl){return}tmpl.param(param);tmpl.registerFunction(func);return tmpl.output()}};var Klass=function _HTMLTemplate(func){this._param={};this._funcs={};merge(this._funcs,GLOBAL_FUNC);this._output=func};merge(Klass.prototype,{param:registerFunction:output:);var COMMENT_NODE="Node"in window?Node.COMMENT_NODE:8;var _getSourceFromElement=function(element){var children=element.childNodes||[];var result=[];for(var i=0,l=children.length;i<l;i++){var e=children[i];if(e.nodeType!=COMMENT_NODE){continue}result.push(e.data)}return result.join("")};var _getFunctionTextFromElement=merge(Klass,{cache:{},get:function(source){var uniqId="autocache:"+Klass.hashFunction(source);var func=Klass.resolve(uniqId);if(func)return new Klass(func);var functionBody=ns.getFunctionText(source);var outputFunction=ns.compileFunctionText(functionBody);return new Klass(Klass.reserve(uniqId,outputFunction))},resolve:reserve:function(name,outputFunction){Klass.cache[name]=outputFunction;return Klass.cache[name]},getByElementId:function(elementId){var uniqId="dom:"+elementId;var func=Klass.resolve(uniqId);if(func){return new Klass(func)}var element=document.getElementById(elementId);if(!element){return undefined}var functionBody=_getFunctionTextFromElement(element);var outputFunction=ns.compileFunctionText(functionBody);return new Klass(Klass.reserve(uniqId,outputFunction))},hashFunction:function(string){var max=1<<31;var length=string.length;var ret=34351;var pos="x";for(var i=0;i<length;i++){var c=string.charCodeAt(i);ret*=37;pos^=c;ret+=c;ret%=max}return ret.toString(16)+"-"+(pos&255).toString(16)},registerFunction:);ns.provide({HTMLTemplate:Klass})});Namespace("brook.dom.compat").define(function(ns){var dataset=function(){var wrapper=if(window["HTMLElemenT"]&&HTMLElement.prototype){var proto=HTMLElement.prototype;if(proto.dataset)return wrapper;if(proto.__lookupGetter__&&proto.__lookupGetter__("dataset"))return wrapper}var camelize=return function(element){var sets={};for(var i=0,a=element.attributes,l=a.length;i<l;i++){var attr=a[i];if(!attr.name.match(/^data-/))continue;sets[camelize(attr.name.replace(/^data-/,""))]=attr.value}return sets}}();var ClassList=var classList=(function(proto){var check=function(token){if(token==""){throw"SYNTAX_ERR"}if(token.indexOf(/\s/)!=-1){throw"INVALID_CHARACTER_ERR"}};this._fake=true;this._refresh=function(){var classes=(this._element.className||"").split(/\s+/);if(classes.length&&classes[0]==""){classes.shift()}if(classes.length&&classes[classes.length-1]==""){classes.pop()}this._classList=classes;this.length=classes.length;return this};this.item=this.contains=function(token){check(token);for(var i=0;i<this.length;++i){if(this._classList[i]==token){return true}}return false};this.add=function(token){check(token);for(var i=0;i<this.length;++i){if(this._classList[i]==token){return}}this._classList.push(token);this.length=this._classList.length;this._element.className=this._classList.join(" ")};this.remove=function(token){check(token);for(var i=0;i<this._classList.length;++i){if(this._classList[i]==token){this._classList.splice(i,1);this._element.className=this._classList.join(" ")}}this.length=this._classList.length};this.toggle=function(token){check(token);for(var i=0;i<this.length;++i){if(this._classList[i]==token){this.remove(token);return false}}this.add(token);return true}}).apply(ClassList.prototype);var hasClassName=function(element,className){var classSyntax=element.className;if(!(classSyntax&&className))return false;return new RegExp("(^|\\s)"+className+"(\\s|$)").test(classSyntax)};var getElementsByClassName=function(className){if(document.getElementsByClassName)return document.getElementsByClassName(className);var allElements=document.getElementsByTagName("*");var ret=[];for(var i=0,l=allElements.length;i<l;i++){if(!hasClassName(allElements[i],className))continue;ret.push(allElements[i])}return ret};ns.provide({getElementsByClassName:getElementsByClassName,hasClassName:hasClassName,dataset:dataset,classList:classList})});Namespace("brook.dom.gateway").define(;Namespace("brook.widget").use("brook promise").use("brook.channel *").use("brook.util *").use("brook.dom.compat *").define(function(ns){var TARGET_CLASS_NAME="widget";var classList=ns.classList;var dataset=ns.dataset;var widgetChannel=ns.channel("widget");var errorChannel=ns.channel("error");var removeClassName=var elementsByClassName=ns.promise(function(n,v){v=v||TARGET_CLASS_NAME;n([v,Array.prototype.slice.call(ns.getElementsByClassName(v))])});var mapByNamespace=ns.promise(function(n,val){var targetClassName=val[0];var widgetElements=val[1];var map={};for(var i=0,l=widgetElements.length;i<l;i++){var widget=widgetElements[i];removeClassName(targetClassName||TARGET_CLASS_NAME,widget);var data=dataset(widget);var widgetNamespace=data.widgetNamespace;if(!widgetNamespace)continue;if(!map[widgetNamespace])map[widgetNamespace]=[];map[widgetNamespace].push([widget,data])}n(map)});var mapToPairs=ns.promise(function(n,map){var pairs=[];for(var namespace in map)if(map.hasOwnProperty(namespace))pairs.push([namespace,map[namespace]]);n(pairs)});var applyCounterOf={};var applyNamespace=ns.promise(function(n,pairs){var fqn=pairs[0];var widgets=pairs[1];applyCounterOf[fqn]=++applyCounterOf[fqn]||1;Namespace("bind.widget.apply.by."+fqn+"."+applyCounterOf[fqn]).use(fqn+" *").apply(});var registerElements=ns.promise(function(n,v){var _ns=v[0];var widgets=v[1];try{if(_ns.registerElement){for(var i=0,l=widgets.length;i<l;i++){_ns.registerElement.apply(null,widgets[i])}}else if(_ns.registerElements){var elements=[];for(var i=0,l=widgets.length;i<l;i++){elements.push(widgets[i][0])}_ns.registerElements(elements)}else{throw"registerElement or registerElements not defined in "+_ns.CURRENT_NAMESPACE}}catch(e){errorChannel.sendMessage(e)}});var updater=ns.promise().bind(ns.lock("class-seek"),elementsByClassName,mapByNamespace,mapToPairs,ns.unlock("class-seek"),ns.scatter(),applyNamespace,registerElements);widgetChannel.observe(updater);ns.provide({bindAllWidget:widgetChannel.send()})});