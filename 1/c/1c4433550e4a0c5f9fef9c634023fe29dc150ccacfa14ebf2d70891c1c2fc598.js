(()=>{var et=Object.create;var A=Object.defineProperty;var tt=Object.getOwnPropertyDescriptor;var st=Object.getOwnPropertyNames,he=Object.getOwnPropertySymbols,nt=Object.getPrototypeOf,le=Object.prototype.hasOwnProperty,it=Object.prototype.propertyIsEnumerable;var fe=(i,e,t)=>e in i?A(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,de=(i,e)=>{for(var t in e||(e={}))le.call(e,t)&&fe(i,t,e[t]);if(he)for(var t of he(e))it.call(e,t)&&fe(i,t,e[t]);return i};var rt=i=>A(i,"__esModule",{value:!0});var S=(i,e)=>()=>(e||i((e={exports:{}}).exports,e),e.exports);var ot=(i,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of st(e))!le.call(i,n)&&(t||n!=="default")&&A(i,n,{get:()=>e[n],enumerable:!(s=tt(e,n))||s.enumerable});return i},pe=(i,e)=>ot(rt(A(i!=null?et(nt(i)):{},"default",!e&&i&&i.__esModule?{get:()=>i.default,enumerable:!0}:{value:i,enumerable:!0})),i);var W=S((Xt,Q)=>{"use strict";var I=typeof Reflect=="object"?Reflect:null,be=I&&typeof I.apply=="function"?I.apply:function(e,t,s){return Function.prototype.apply.call(e,t,s)},D;I&&typeof I.ownKeys=="function"?D=I.ownKeys:Object.getOwnPropertySymbols?D=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:D=function(e){return Object.getOwnPropertyNames(e)};function ct(i){console&&console.warn&&console.warn(i)}var _e=Number.isNaN||function(e){return e!==e};function u(){u.init.call(this)}Q.exports=u;Q.exports.once=lt;u.EventEmitter=u;u.prototype._events=void 0;u.prototype._eventsCount=0;u.prototype._maxListeners=void 0;var ge=10;function j(i){if(typeof i!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof i)}Object.defineProperty(u,"defaultMaxListeners",{enumerable:!0,get:function(){return ge},set:function(i){if(typeof i!="number"||i<0||_e(i))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+i+".");ge=i}});u.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};u.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||_e(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function me(i){return i._maxListeners===void 0?u.defaultMaxListeners:i._maxListeners}u.prototype.getMaxListeners=function(){return me(this)};u.prototype.emit=function(e){for(var t=[],s=1;s<arguments.length;s++)t.push(arguments[s]);var n=e==="error",o=this._events;if(o!==void 0)n=n&&o.error===void 0;else if(!n)return!1;if(n){var r;if(t.length>0&&(r=t[0]),r instanceof Error)throw r;var c=new Error("Unhandled error."+(r?" ("+r.message+")":""));throw c.context=r,c}var a=o[e];if(a===void 0)return!1;if(typeof a=="function")be(a,this,t);else for(var h=a.length,b=Ee(a,h),s=0;s<h;++s)be(b[s],this,t);return!0};function Se(i,e,t,s){var n,o,r;if(j(t),o=i._events,o===void 0?(o=i._events=Object.create(null),i._eventsCount=0):(o.newListener!==void 0&&(i.emit("newListener",e,t.listener?t.listener:t),o=i._events),r=o[e]),r===void 0)r=o[e]=t,++i._eventsCount;else if(typeof r=="function"?r=o[e]=s?[t,r]:[r,t]:s?r.unshift(t):r.push(t),n=me(i),n>0&&r.length>n&&!r.warned){r.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+r.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=i,c.type=e,c.count=r.length,ct(c)}return i}u.prototype.addListener=function(e,t){return Se(this,e,t,!1)};u.prototype.on=u.prototype.addListener;u.prototype.prependListener=function(e,t){return Se(this,e,t,!0)};function at(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function ve(i,e,t){var s={fired:!1,wrapFn:void 0,target:i,type:e,listener:t},n=at.bind(s);return n.listener=t,s.wrapFn=n,n}u.prototype.once=function(e,t){return j(t),this.on(e,ve(this,e,t)),this};u.prototype.prependOnceListener=function(e,t){return j(t),this.prependListener(e,ve(this,e,t)),this};u.prototype.removeListener=function(e,t){var s,n,o,r,c;if(j(t),n=this._events,n===void 0)return this;if(s=n[e],s===void 0)return this;if(s===t||s.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,s.listener||t));else if(typeof s!="function"){for(o=-1,r=s.length-1;r>=0;r--)if(s[r]===t||s[r].listener===t){c=s[r].listener,o=r;break}if(o<0)return this;o===0?s.shift():ut(s,o),s.length===1&&(n[e]=s[0]),n.removeListener!==void 0&&this.emit("removeListener",e,c||t)}return this};u.prototype.off=u.prototype.removeListener;u.prototype.removeAllListeners=function(e){var t,s,n;if(s=this._events,s===void 0)return this;if(s.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):s[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete s[e]),this;if(arguments.length===0){var o=Object.keys(s),r;for(n=0;n<o.length;++n)r=o[n],r!=="removeListener"&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=s[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this};function ye(i,e,t){var s=i._events;if(s===void 0)return[];var n=s[e];return n===void 0?[]:typeof n=="function"?t?[n.listener||n]:[n]:t?ht(n):Ee(n,n.length)}u.prototype.listeners=function(e){return ye(this,e,!0)};u.prototype.rawListeners=function(e){return ye(this,e,!1)};u.listenerCount=function(i,e){return typeof i.listenerCount=="function"?i.listenerCount(e):Ce.call(i,e)};u.prototype.listenerCount=Ce;function Ce(i){var e=this._events;if(e!==void 0){var t=e[i];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}u.prototype.eventNames=function(){return this._eventsCount>0?D(this._events):[]};function Ee(i,e){for(var t=new Array(e),s=0;s<e;++s)t[s]=i[s];return t}function ut(i,e){for(;e+1<i.length;e++)i[e]=i[e+1];i.pop()}function ht(i){for(var e=new Array(i.length),t=0;t<e.length;++t)e[t]=i[t].listener||i[t];return e}function lt(i,e){return new Promise(function(t,s){function n(r){i.removeListener(e,o),s(r)}function o(){typeof i.removeListener=="function"&&i.removeListener("error",n),t([].slice.call(arguments))}we(i,e,o,{once:!0}),e!=="error"&&ft(i,n,{once:!0})})}function ft(i,e,t){typeof i.on=="function"&&we(i,"error",e,t)}function we(i,e,t,s){if(typeof i.on=="function")s.once?i.once(e,t):i.on(e,t);else if(typeof i.addEventListener=="function")i.addEventListener(e,function n(o){s.once&&i.removeEventListener(e,n),t(o)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof i)}});var Y=S(v=>{"use strict";Object.defineProperty(v,"__esModule",{value:!0});v.unsubscribedCodes=v.subscribingCodes=v.disconnectedCodes=v.connectingCodes=v.errorCodes=void 0;v.errorCodes={timeout:1,transportClosed:2,clientDisconnected:3,clientClosed:4,clientConnectToken:5,clientRefreshToken:6,subscriptionUnsubscribed:7,subscriptionSubscribeToken:8,subscriptionRefreshToken:9,transportWriteError:10,connectionClosed:11};v.connectingCodes={connectCalled:0,transportClosed:1,noPing:2,subscribeTimeout:3,unsubscribeError:4};v.disconnectedCodes={disconnectCalled:0,unauthorized:1,badProtocol:2,messageSizeLimit:3};v.subscribingCodes={subscribeCalled:0,transportClosed:1};v.unsubscribedCodes={unsubscribeCalled:0,unauthorized:1,clientClosed:2}});var U=S(T=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0});T.SubscriptionState=T.State=void 0;var dt;(function(i){i.Disconnected="disconnected",i.Connecting="connecting",i.Connected="connected"})(dt=T.State||(T.State={}));var pt;(function(i){i.Unsubscribed="unsubscribed",i.Subscribing="subscribing",i.Subscribed="subscribed"})(pt=T.SubscriptionState||(T.SubscriptionState={}))});var $=S(m=>{"use strict";Object.defineProperty(m,"__esModule",{value:!0});m.ttlMilliseconds=m.errorExists=m.backoff=m.log=m.isFunction=m.startsWith=void 0;function bt(i,e){return i.lastIndexOf(e,0)===0}m.startsWith=bt;function ke(i){return i==null?!1:typeof i=="function"}m.isFunction=ke;function _t(i,e){if(globalThis.console){let t=globalThis.console[i];ke(t)&&t.apply(globalThis.console,e)}}m.log=_t;function gt(i,e){return Math.floor(Math.random()*(e-i+1)+i)}function mt(i,e,t){i>31&&(i=31);let s=gt(0,Math.min(t,e*Math.pow(2,i)));return Math.min(t,e+s)}m.backoff=mt;function St(i){return"error"in i&&i.error!==null}m.errorExists=St;function vt(i){return Math.min(i*1e3,2147483647)}m.ttlMilliseconds=vt});var X=S(O=>{"use strict";var yt=O&&O.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(O,"__esModule",{value:!0});O.Subscription=void 0;var Ct=yt(W()),y=Y(),C=U(),F=$(),Te=class extends Ct.default{constructor(e,t,s){super();this._resubscribeTimeout=null,this._refreshTimeout=null,this.channel=t,this.state=C.SubscriptionState.Unsubscribed,this._centrifuge=e,this._token=null,this._getToken=null,this._data=null,this._recover=!1,this._offset=null,this._epoch=null,this._recoverable=!1,this._positioned=!1,this._joinLeave=!1,this._minResubscribeDelay=500,this._maxResubscribeDelay=2e4,this._resubscribeTimeout=null,this._resubscribeAttempts=0,this._promises={},this._promiseId=0,this._inflight=!1,this._refreshTimeout=null,this._setOptions(s),this._centrifuge._debugEnabled?(this.on("state",n=>{this._centrifuge._debug("subscription state",t,n.oldState,"->",n.newState)}),this.on("error",n=>{this._centrifuge._debug("subscription error",t,n)})):this.on("error",function(){Function.prototype()})}ready(e){return this.state===C.SubscriptionState.Unsubscribed?Promise.reject({code:y.errorCodes.subscriptionUnsubscribed,message:this.state}):this.state===C.SubscriptionState.Subscribed?Promise.resolve():new Promise((t,s)=>{let n={resolve:t,reject:s};e&&(n.timeout=setTimeout(function(){s({code:y.errorCodes.timeout,message:"timeout"})},e)),this._promises[this._nextPromiseId()]=n})}subscribe(){this._isSubscribed()||(this._resubscribeAttempts=0,this._setSubscribing(y.subscribingCodes.subscribeCalled,"subscribe called"))}unsubscribe(){this._setUnsubscribed(y.unsubscribedCodes.unsubscribeCalled,"unsubscribe called",!0)}publish(e){let t=this;return this._methodCall().then(function(){return t._centrifuge.publish(t.channel,e)})}presence(){let e=this;return this._methodCall().then(function(){return e._centrifuge.presence(e.channel)})}presenceStats(){let e=this;return this._methodCall().then(function(){return e._centrifuge.presenceStats(e.channel)})}history(e){let t=this;return this._methodCall().then(function(){return t._centrifuge.history(t.channel,e)})}_methodCall(){return this._isSubscribed()?Promise.resolve():this._isUnsubscribed()?Promise.reject({code:y.errorCodes.subscriptionUnsubscribed,message:this.state}):new Promise((e,t)=>{let s=setTimeout(function(){t({code:y.errorCodes.timeout,message:"timeout"})},this._centrifuge._config.timeout);this._promises[this._nextPromiseId()]={timeout:s,resolve:e,reject:t}})}_nextPromiseId(){return++this._promiseId}_needRecover(){return this._recover===!0}_isUnsubscribed(){return this.state===C.SubscriptionState.Unsubscribed}_isSubscribing(){return this.state===C.SubscriptionState.Subscribing}_isSubscribed(){return this.state===C.SubscriptionState.Subscribed}_setState(e){if(this.state!==e){let t=this.state;return this.state=e,this.emit("state",{newState:e,oldState:t,channel:this.channel}),!0}return!1}_usesToken(){return this._token!==null||this._getToken!==null}_clearSubscribingState(){this._resubscribeAttempts=0,this._clearResubscribeTimeout()}_clearSubscribedState(){this._clearRefreshTimeout()}_setSubscribed(e){if(!this._isSubscribing())return;this._clearSubscribingState(),e.recoverable&&(this._recover=!0,this._offset=e.offset||0,this._epoch=e.epoch||""),this._setState(C.SubscriptionState.Subscribed);let t=this._centrifuge._getSubscribeContext(this.channel,e);this.emit("subscribed",t),this._resolvePromises();let s=e.publications;if(s&&s.length>0)for(let n in s)!s.hasOwnProperty(n)||this._handlePublication(s[n]);e.expires===!0&&(this._refreshTimeout=setTimeout(()=>this._refresh(),(0,F.ttlMilliseconds)(e.ttl)))}_setSubscribing(e,t){this._isSubscribing()||(this._isSubscribed()&&this._clearSubscribedState(),this._setState(C.SubscriptionState.Subscribing)&&this.emit("subscribing",{channel:this.channel,code:e,reason:t}),this._subscribe(!1,!1))}_subscribe(e,t){if(this._centrifuge._debug("subscribing on",this.channel),this._centrifuge.state!==C.State.Connected&&!e)return this._centrifuge._debug("delay subscribe on",this.channel,"till connected"),null;if(this._usesToken()){if(this._token)return this._sendSubscribe(this._token,t);{if(e)return null;let s=this;return this._getSubscriptionToken().then(function(n){if(!!s._isSubscribing()){if(!n){s._failUnauthorized();return}s._token=n,s._sendSubscribe(n,!1)}}).catch(function(n){!s._isSubscribing()||(s.emit("error",{type:"subscribeToken",channel:s.channel,error:{code:y.errorCodes.subscriptionSubscribeToken,message:n!==void 0?n.toString():""}}),s._scheduleResubscribe())}),null}}else return this._sendSubscribe("",t)}_sendSubscribe(e,t){let n={channel:this.channel};if(e&&(n.token=e),this._data&&(n.data=this._data),this._positioned&&(n.positioned=!0),this._recoverable&&(n.recoverable=!0),this._joinLeave&&(n.join_leave=!0),this._needRecover()){n.recover=!0;let r=this._getOffset();r&&(n.offset=r);let c=this._getEpoch();c&&(n.epoch=c)}let o={subscribe:n};return this._inflight=!0,this._centrifuge._call(o,t).then(r=>{this._inflight=!1;let c=r.reply.subscribe;this._handleSubscribeResponse(c),r.next&&r.next()},r=>{this._inflight=!1,this._handleSubscribeError(r.error),r.next&&r.next()}),o}_handleSubscribeError(e){if(!!this._isSubscribing()){if(e.code===y.errorCodes.timeout){this._centrifuge._disconnect(y.connectingCodes.subscribeTimeout,"subscribe timeout",!0);return}this._subscribeError(e)}}_handleSubscribeResponse(e){!this._isSubscribing()||this._setSubscribed(e)}_setUnsubscribed(e,t,s){this._isUnsubscribed()||(this._isSubscribed()&&(s&&this._centrifuge._unsubscribe(this),this._clearSubscribedState()),this._isSubscribing()&&this._clearSubscribingState(),this._setState(C.SubscriptionState.Unsubscribed)&&this.emit("unsubscribed",{channel:this.channel,code:e,reason:t}),this._rejectPromises({code:y.errorCodes.subscriptionUnsubscribed,message:this.state}))}_handlePublication(e){let t=this._centrifuge._getPublicationContext(this.channel,e);this.emit("publication",t),e.offset&&(this._offset=e.offset)}_handleJoin(e){let t=this._centrifuge._getJoinLeaveContext(e.info);this.emit("join",{channel:this.channel,info:t})}_handleLeave(e){let t=this._centrifuge._getJoinLeaveContext(e.info);this.emit("leave",{channel:this.channel,info:t})}_resolvePromises(){for(let e in this._promises)this._promises[e].timeout&&clearTimeout(this._promises[e].timeout),this._promises[e].resolve(),delete this._promises[e]}_rejectPromises(e){for(let t in this._promises)this._promises[t].timeout&&clearTimeout(this._promises[t].timeout),this._promises[t].reject(e),delete this._promises[t]}_scheduleResubscribe(){let e=this,t=this._getResubscribeDelay();this._resubscribeTimeout=setTimeout(function(){e._isSubscribing()&&e._subscribe(!1,!1)},t)}_subscribeError(e){if(!!this._isSubscribing())if(e.code<100||e.code===109||e.temporary===!0){e.code===109&&(this._token=null);let t={channel:this.channel,type:"subscribe",error:e};this._centrifuge.state===C.State.Connected&&this.emit("error",t),this._scheduleResubscribe()}else this._setUnsubscribed(e.code,e.message,!1)}_getResubscribeDelay(){let e=(0,F.backoff)(this._resubscribeAttempts,this._minResubscribeDelay,this._maxResubscribeDelay);return this._resubscribeAttempts++,e}_setOptions(e){!e||(e.since&&(this._offset=e.since.offset,this._epoch=e.since.epoch,this._recover=!0),e.data&&(this._data=e.data),e.minResubscribeDelay!==void 0&&(this._minResubscribeDelay=e.minResubscribeDelay),e.maxResubscribeDelay!==void 0&&(this._maxResubscribeDelay=e.maxResubscribeDelay),e.token&&(this._token=e.token),e.getToken&&(this._getToken=e.getToken),e.positioned===!0&&(this._positioned=!0),e.recoverable===!0&&(this._recoverable=!0),e.joinLeave===!0&&(this._joinLeave=!0))}_getOffset(){let e=this._offset;return e!==null?e:0}_getEpoch(){let e=this._epoch;return e!==null?e:""}_clearRefreshTimeout(){this._refreshTimeout!==null&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null)}_clearResubscribeTimeout(){this._resubscribeTimeout!==null&&(clearTimeout(this._resubscribeTimeout),this._resubscribeTimeout=null)}_getSubscriptionToken(){this._centrifuge._debug("get subscription token for channel",this.channel);let e={channel:this.channel},t=this._getToken;if(t===null)throw new Error("provide a function to get channel subscription token");return t(e)}_refresh(){this._clearRefreshTimeout();let e=this;this._getSubscriptionToken().then(function(t){if(!e._isSubscribed())return;if(!t){e._failUnauthorized();return}e._token=t;let n={sub_refresh:{channel:e.channel,token:t}};e._centrifuge._call(n).then(o=>{let r=o.reply.sub_refresh;e._refreshResponse(r),o.next&&o.next()},o=>{e._refreshError(o.error),o.next&&o.next()})}).catch(function(t){e.emit("error",{type:"refreshToken",channel:e.channel,error:{code:y.errorCodes.subscriptionRefreshToken,message:t!==void 0?t.toString():""}}),e._refreshTimeout=setTimeout(()=>e._refresh(),e._getRefreshRetryDelay())})}_refreshResponse(e){!this._isSubscribed()||(this._centrifuge._debug("subscription token refreshed, channel",this.channel),this._clearRefreshTimeout(),e.expires===!0&&(this._refreshTimeout=setTimeout(()=>this._refresh(),(0,F.ttlMilliseconds)(e.ttl))))}_refreshError(e){!this._isSubscribed()||(e.code<100||e.temporary===!0?(this.emit("error",{type:"refresh",channel:this.channel,error:e}),this._refreshTimeout=setTimeout(()=>this._refresh(),this._getRefreshRetryDelay())):this._setUnsubscribed(e.code,e.message,!0))}_getRefreshRetryDelay(){return(0,F.backoff)(0,1e4,2e4)}_failUnauthorized(){this._setUnsubscribed(y.unsubscribedCodes.unauthorized,"unauthorized",!0)}};O.Subscription=Te});var Re=S(N=>{"use strict";Object.defineProperty(N,"__esModule",{value:!0});N.SockjsTransport=void 0;var Pe=class{constructor(e,t){this.endpoint=e,this.options=t,this._transport=null}name(){return"sockjs"}subName(){return"sockjs-"+this._transport.transport}emulation(){return!1}supported(){return this.options.sockjs!==null}initialize(e,t){this._transport=new this.options.sockjs(this.endpoint,null,this.options.sockjsOptions),this._transport.onopen=()=>{t.onOpen()},this._transport.onerror=s=>{t.onError(s)},this._transport.onclose=s=>{t.onClose(s)},this._transport.onmessage=s=>{t.onMessage(s.data)}}close(){this._transport.close()}send(e){this._transport.send(e)}};N.SockjsTransport=Pe});var Oe=S(K=>{"use strict";Object.defineProperty(K,"__esModule",{value:!0});K.WebsocketTransport=void 0;var Ie=class{constructor(e,t){this.endpoint=e,this.options=t,this._transport=null}name(){return"websocket"}subName(){return"websocket"}emulation(){return!1}supported(){return this.options.websocket!==void 0&&this.options.websocket!==null}initialize(e,t){let s="";e==="protobuf"&&(s="centrifuge-protobuf"),s!==""?this._transport=new this.options.websocket(this.endpoint,s):this._transport=new this.options.websocket(this.endpoint),e==="protobuf"&&(this._transport.binaryType="arraybuffer"),this._transport.onopen=()=>{t.onOpen()},this._transport.onerror=n=>{t.onError(n)},this._transport.onclose=n=>{t.onClose(n)},this._transport.onmessage=n=>{t.onMessage(n.data)}}close(){this._transport.close()}send(e){this._transport.send(e)}};K.WebsocketTransport=Ie});var xe=S(q=>{"use strict";Object.defineProperty(q,"__esModule",{value:!0});q.HttpStreamTransport=void 0;var Me=class{constructor(e,t){this.endpoint=e,this.options=t,this._abortController=null,this._utf8decoder=new TextDecoder,this._protocol="json"}name(){return"http_stream"}subName(){return"http_stream"}emulation(){return!0}_handleErrors(e){if(!e.ok)throw new Error(e.status);return e}_fetchEventTarget(e,t,s){let n=new EventTarget;return e.options.fetch(t,s).then(e._handleErrors).then(r=>{n.dispatchEvent(new Event("open"));let c="",a=0,h=new Uint8Array,b=r.body.getReader();return new e.options.readableStream({start(w){function l(){return b.read().then(({done:g,value:_})=>{if(g){n.dispatchEvent(new Event("close")),w.close();return}try{if(e._protocol==="json")for(c+=e._utf8decoder.decode(_);a<c.length;)if(c[a]===`
`){let f=c.substring(0,a);n.dispatchEvent(new MessageEvent("message",{data:f})),c=c.substring(a+1),a=0}else++a;else{let f=new Uint8Array(h.length+_.length);for(f.set(h),f.set(_,h.length),h=f;;){let R=e.options.decoder.decodeReply(h);if(R.ok){let k=h.slice(0,R.pos);n.dispatchEvent(new MessageEvent("message",{data:k})),h=h.slice(R.pos);continue}break}}}catch(f){n.dispatchEvent(new Event("error",{detail:f})),n.dispatchEvent(new Event("close")),w.close();return}l()}).catch(function(g){n.dispatchEvent(new Event("error",{detail:g})),n.dispatchEvent(new Event("close")),w.close()})}return l()}})}).catch(r=>{n.dispatchEvent(new Event("error",{detail:r})),n.dispatchEvent(new Event("close"))}),n}supported(){return this.options.fetch!==null&&this.options.readableStream!==null&&typeof TextDecoder!="undefined"&&typeof AbortController!="undefined"&&typeof EventTarget!="undefined"&&typeof Event!="undefined"&&typeof MessageEvent!="undefined"&&typeof Error!="undefined"}initialize(e,t,s){this._protocol=e,this._abortController=new AbortController;let n,o;e==="json"?(n={Accept:"application/json","Content-Type":"application/json"},o=s):(n={Accept:"application/octet-stream","Content-Type":"application/octet-stream"},o=s);let r={method:"POST",headers:n,body:o,mode:"cors",credentials:"same-origin",cache:"no-cache",signal:this._abortController.signal},c=this._fetchEventTarget(this,this.endpoint,r);c.addEventListener("open",()=>{t.onOpen()}),c.addEventListener("error",a=>{this._abortController.abort(),t.onError(a)}),c.addEventListener("close",()=>{this._abortController.abort(),t.onClose({code:4,reason:"connection closed"})}),c.addEventListener("message",a=>{t.onMessage(a.data)})}close(){this._abortController.abort()}send(e,t,s){let n,o,r={session:t,node:s,data:e};this._protocol==="json"?(n={"Content-Type":"application/json"},o=JSON.stringify(r)):(n={"Content-Type":"application/octet-stream"},o=this.options.encoder.encodeEmulationRequest(r));let c=this.options.fetch,a={method:"POST",headers:n,body:o,mode:"cors",credentials:"same-origin",cache:"no-cache"};c(this.options.emulationEndpoint,a)}};q.HttpStreamTransport=Me});var Ae=S(z=>{"use strict";Object.defineProperty(z,"__esModule",{value:!0});z.SseTransport=void 0;var Le=class{constructor(e,t){this.endpoint=e,this.options=t,this._protocol="json",this._transport=null,this._onClose=null}name(){return"sse"}subName(){return"sse"}emulation(){return!0}supported(){return this.options.eventsource!==null&&this.options.fetch!==null}initialize(e,t,s){let n;globalThis&&globalThis.document&&globalThis.document.baseURI?n=new URL(this.endpoint,globalThis.document.baseURI):n=new URL(this.endpoint),n.searchParams.append("cf_connect",s);let o={},r=new this.options.eventsource(n.toString(),o);this._transport=r;let c=this;r.onopen=function(){t.onOpen()},r.onerror=function(a){r.close(),t.onError(a),t.onClose({code:4,reason:"connection closed"})},r.onmessage=function(a){t.onMessage(a.data)},c._onClose=function(){t.onClose({code:4,reason:"connection closed"})}}close(){this._transport.close(),this._onClose!==null&&this._onClose()}send(e,t,s){let n={session:t,node:s,data:e},o={"Content-Type":"application/json"},r=JSON.stringify(n),c=this.options.fetch,a={method:"POST",headers:o,body:r,mode:"cors",credentials:"same-origin",cache:"no-cache"};c(this.options.emulationEndpoint,a)}};z.SseTransport=Le});var je=S(M=>{"use strict";var J=M&&M.__awaiter||function(i,e,t,s){function n(o){return o instanceof t?o:new t(function(r){r(o)})}return new(t||(t=Promise))(function(o,r){function c(b){try{h(s.next(b))}catch(w){r(w)}}function a(b){try{h(s.throw(b))}catch(w){r(w)}}function h(b){b.done?o(b.value):n(b.value).then(c,a)}h((s=s.apply(i,e||[])).next())})};Object.defineProperty(M,"__esModule",{value:!0});M.WebtransportTransport=void 0;var De=class{constructor(e,t){this.endpoint=e,this.options=t,this._transport=null,this._stream=null,this._writer=null,this._utf8decoder=new TextDecoder,this._protocol="json"}name(){return"webtransport"}subName(){return"webtransport"}emulation(){return!1}supported(){return this.options.webtransport!==void 0&&this.options.webtransport!==null}initialize(e,t){return J(this,void 0,void 0,function*(){let s;globalThis&&globalThis.document&&globalThis.document.baseURI?s=new URL(this.endpoint,globalThis.document.baseURI):s=new URL(this.endpoint),e==="protobuf"&&s.searchParams.append("cf_protocol","protobuf"),this._protocol=e;let n=new EventTarget;this._transport=new this.options.webtransport(s.toString()),this._transport.closed.then(()=>{t.onClose({code:4,reason:"connection closed"})}).catch(()=>{t.onClose({code:4,reason:"connection closed"})});try{yield this._transport.ready}catch{this.close();return}let o;try{o=yield this._transport.createBidirectionalStream()}catch{this.close();return}this._stream=o,this._writer=this._stream.writable.getWriter(),n.addEventListener("close",()=>{t.onClose({code:4,reason:"connection closed"})}),n.addEventListener("message",r=>{t.onMessage(r.data)}),this._startReading(n),t.onOpen()})}_startReading(e){return J(this,void 0,void 0,function*(){let t=this._stream.readable.getReader(),s="",n=0,o=new Uint8Array;try{for(;;){let{done:r,value:c}=yield t.read();if(c.length>0)if(this._protocol==="json")for(s+=this._utf8decoder.decode(c);n<s.length;)if(s[n]===`
`){let a=s.substring(0,n);e.dispatchEvent(new MessageEvent("message",{data:a})),s=s.substring(n+1),n=0}else++n;else{let a=new Uint8Array(o.length+c.length);for(a.set(o),a.set(c,o.length),o=a;;){let h=this.options.decoder.decodeReply(o);if(h.ok){let b=o.slice(0,h.pos);e.dispatchEvent(new MessageEvent("message",{data:b})),o=o.slice(h.pos);continue}break}}if(r)break}}catch{e.dispatchEvent(new Event("close"))}})}close(){return J(this,void 0,void 0,function*(){try{this._writer&&(yield this._writer.close()),this._transport.close()}catch{}})}send(e){return J(this,void 0,void 0,function*(){let t;this._protocol==="json"?t=new TextEncoder().encode(e+`
`):t=e;try{yield this._writer.write(t)}catch{this.close()}})}};M.WebtransportTransport=De});var Fe=S(x=>{"use strict";Object.defineProperty(x,"__esModule",{value:!0});x.JsonDecoder=x.JsonEncoder=void 0;var We=class{encodeCommands(e){return e.map(t=>JSON.stringify(t)).join(`
`)}};x.JsonEncoder=We;var Ue=class{decodeReplies(e){return e.trim().split(`
`).map(t=>JSON.parse(t))}};x.JsonDecoder=Ue});var qe=S(L=>{"use strict";var Et=L&&L.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(L,"__esModule",{value:!0});L.Centrifuge=void 0;var wt=X(),p=Y(),kt=Re(),Ne=Oe(),Tt=xe(),Pt=Ae(),Rt=je(),Ke=Fe(),P=$(),d=U(),It=Et(W()),Ot={protocol:"json",token:null,getToken:null,data:null,debug:!1,name:"js",version:"",fetch:null,readableStream:null,websocket:null,eventsource:null,sockjs:null,sockjsOptions:{},emulationEndpoint:"/emulation",minReconnectDelay:500,maxReconnectDelay:2e4,timeout:5e3,maxServerPingDelay:1e4,networkEventTarget:null},B=class extends It.default{constructor(e,t){super();this._reconnectTimeout=null,this._refreshTimeout=null,this._serverPingTimeout=null,this.state=d.State.Disconnected,this._endpoint=e,this._emulation=!1,this._transports=[],this._currentTransportIndex=0,this._triedAllTransports=!1,this._transportWasOpen=!1,this._transport=null,this._transportClosed=!0,this._encoder=null,this._decoder=null,this._reconnecting=!1,this._reconnectTimeout=null,this._reconnectAttempts=0,this._client=null,this._session="",this._node="",this._subs={},this._serverSubs={},this._commandId=0,this._commands=[],this._batching=!1,this._refreshRequired=!1,this._refreshTimeout=null,this._callbacks={},this._token=void 0,this._dispatchPromise=Promise.resolve(),this._serverPing=0,this._serverPingTimeout=null,this._sendPong=!1,this._promises={},this._promiseId=0,this._debugEnabled=!1,this._config=Object.assign(Object.assign({},Ot),t),this._configure(),this._debugEnabled?(this.on("state",s=>{this._debug("client state",s.oldState,"->",s.newState)}),this.on("error",s=>{this._debug("client error",s)})):this.on("error",function(){Function.prototype()})}newSubscription(e,t){if(this.getSubscription(e)!==null)throw new Error("Subscription to the channel "+e+" already exists");let s=new wt.Subscription(this,e,t);return this._subs[e]=s,s}getSubscription(e){return this._getSub(e)}removeSubscription(e){!e||(e.state!==d.SubscriptionState.Unsubscribed&&e.unsubscribe(),this._removeSubscription(e))}subscriptions(){return this._subs}ready(e){return this.state===d.State.Disconnected?Promise.reject({code:p.errorCodes.clientDisconnected,message:"client disconnected"}):this.state===d.State.Connected?Promise.resolve():new Promise((t,s)=>{let n={resolve:t,reject:s};e&&(n.timeout=setTimeout(function(){s({code:p.errorCodes.timeout,message:"timeout"})},e)),this._promises[this._nextPromiseId()]=n})}connect(){if(this._isConnected()){this._debug("connect called when already connected");return}if(this._isConnecting()){this._debug("connect called when already connecting");return}this._reconnectAttempts=0,this._startConnecting()}disconnect(){this._disconnect(p.disconnectedCodes.disconnectCalled,"disconnect called",!1)}send(e){let t={send:{data:e}},s=this;return this._methodCall().then(function(){return s._transportSendCommands([t])?Promise.resolve():Promise.reject(s._createErrorObject(p.errorCodes.transportWriteError,"transport write error"))})}rpc(e,t){let s={rpc:{method:e,data:t}},n=this;return this._methodCall().then(function(){return n._callPromise(s,function(o){return{data:o.rpc.data}})})}publish(e,t){let s={publish:{channel:e,data:t}},n=this;return this._methodCall().then(function(){return n._callPromise(s,function(){return{}})})}history(e,t){let s={history:this._getHistoryRequest(e,t)},n=this;return this._methodCall().then(function(){return n._callPromise(s,function(o){let r=o.history,c=[];if(r.publications)for(let a=0;a<r.publications.length;a++)c.push(n._getPublicationContext(e,r.publications[a]));return{publications:c,epoch:r.epoch||"",offset:r.offset||0}})})}presence(e){let t={presence:{channel:e}},s=this;return this._methodCall().then(function(){return s._callPromise(t,function(n){return{clients:n.presence.presence}})})}presenceStats(e){let t={presence_stats:{channel:e}},s=this;return this._methodCall().then(function(){return s._callPromise(t,function(n){let o=n.presence_stats;return{numUsers:o.num_users,numClients:o.num_clients}})})}startBatching(){this._batching=!0}stopBatching(){let e=this;Promise.resolve().then(function(){Promise.resolve().then(function(){e._batching=!1,e._flush()})})}_debug(...e){!this._debugEnabled||(0,P.log)("debug",e)}_setFormat(e){if(!this._formatOverride(e)){if(e==="protobuf")throw new Error("not implemented by JSON-only Centrifuge client, use client with Protobuf support");this._encoder=new Ke.JsonEncoder,this._decoder=new Ke.JsonDecoder}}_formatOverride(e){return!1}_configure(){if(!("Promise"in globalThis))throw new Error("Promise polyfill required");if(!this._endpoint)throw new Error("endpoint configuration required");if(this._config.protocol!=="json"&&this._config.protocol!=="protobuf")throw new Error("unsupported protocol "+this._config.protocol);if(this._config.token!==null&&(this._token=this._config.token),this._setFormat("json"),this._config.protocol==="protobuf"&&this._setFormat("protobuf"),(this._config.debug===!0||typeof localStorage!="undefined"&&localStorage.getItem("centrifuge.debug"))&&(this._debugEnabled=!0),this._debug("config",this._config),typeof this._endpoint!="string")if(typeof this._endpoint=="object"&&this._endpoint instanceof Array){this._transports=this._endpoint,this._emulation=!0;for(let e in this._transports){let t=this._transports[e];if(!t.endpoint||!t.transport)throw new Error("malformed transport configuration");let s=t.transport;if(["websocket","http_stream","sse","sockjs","webtransport"].indexOf(s)<0)throw new Error("unsupported transport name: "+s)}}else throw new Error("unsupported url configuration type: only string or array of objects are supported")}_setState(e){if(this.state!==e){this._reconnecting=!1;let t=this.state;return this.state=e,this.emit("state",{newState:e,oldState:t}),!0}return!1}_isDisconnected(){return this.state===d.State.Disconnected}_isConnecting(){return this.state===d.State.Connecting}_isConnected(){return this.state===d.State.Connected}_nextCommandId(){return++this._commandId}_setNetworkEvents(){let e=null;this._config.networkEventTarget!==null?e=this._config.networkEventTarget:typeof globalThis.addEventListener!="undefined"&&(e=globalThis),e&&(e.addEventListener("offline",()=>{this._debug("offline event triggered"),this.state===d.State.Connected&&this._transport&&!this._transportClosed&&(this._transportClosed=!0,this._transport.close())}),e.addEventListener("online",()=>{this._debug("online event triggered"),this.state===d.State.Connecting&&(this._clearReconnectTimeout(),this._startReconnecting())}))}_getReconnectDelay(){let e=(0,P.backoff)(this._reconnectAttempts,this._config.minReconnectDelay,this._config.maxReconnectDelay);return this._reconnectAttempts+=1,e}_clearOutgoingRequests(){for(let e in this._callbacks)if(this._callbacks.hasOwnProperty(e)){let t=this._callbacks[e];clearTimeout(t.timeout);let s=t.errback;if(!s)continue;s({error:this._createErrorObject(p.errorCodes.connectionClosed,"connection closed")})}this._callbacks={}}_clearConnectedState(){this._client=null,this._clearServerPingTimeout(),this._clearRefreshTimeout();for(let e in this._subs){if(!this._subs.hasOwnProperty(e))continue;let t=this._subs[e];t.state===d.SubscriptionState.Subscribed&&t._setSubscribing(p.subscribingCodes.transportClosed,"transport closed")}for(let e in this._serverSubs)this._serverSubs.hasOwnProperty(e)&&this.emit("subscribing",{channel:e})}_handleWriteError(e){for(let t of e){let s=t.id;if(!(s in this._callbacks))continue;let n=this._callbacks[s];clearTimeout(this._callbacks[s].timeout),delete this._callbacks[s],n.errback({error:this._createErrorObject(p.errorCodes.transportWriteError,"transport write error")})}}_transportSendCommands(e){if(!e.length)return!0;if(!this._transport)return!1;try{this._transport.send(this._encoder.encodeCommands(e),this._session,this._node)}catch(t){return this._debug("error writing commands",t),this._handleWriteError(e),!1}return!0}_initializeTransport(){let e;this._config.websocket!==null?e=this._config.websocket:typeof globalThis.WebSocket!="function"&&typeof globalThis.WebSocket!="object"||(e=globalThis.WebSocket);let t=null;this._config.sockjs!==null?t=this._config.sockjs:typeof globalThis.SockJS!="undefined"&&(t=globalThis.SockJS);let s=null;this._config.eventsource!==null?s=this._config.eventsource:typeof globalThis.EventSource!="undefined"&&(s=globalThis.EventSource);let n=null;this._config.fetch!==null?n=this._config.fetch:typeof globalThis.fetch!="undefined"&&(n=globalThis.fetch);let o=null;if(this._config.readableStream!==null?o=this._config.readableStream:typeof globalThis.ReadableStream!="undefined"&&(o=globalThis.ReadableStream),this._emulation){this._currentTransportIndex>=this._transports.length&&(this._triedAllTransports=!0,this._currentTransportIndex=0);let l=0;for(;;){if(l>=this._transports.length)throw new Error("no supported transport found");let g=this._transports[this._currentTransportIndex],_=g.transport,f=g.endpoint;if(_==="websocket"){if(this._debug("trying websocket transport"),this._transport=new Ne.WebsocketTransport(f,{websocket:e}),!this._transport.supported()){this._debug("websocket transport not available"),this._currentTransportIndex++,l++;continue}}else if(_==="webtransport"){if(this._debug("trying webtransport transport"),this._transport=new Rt.WebtransportTransport(f,{webtransport:globalThis.WebTransport,decoder:this._decoder,encoder:this._encoder}),!this._transport.supported()){this._debug("webtransport transport not available"),this._currentTransportIndex++,l++;continue}}else if(_==="http_stream"){if(this._debug("trying http_stream transport"),this._transport=new Tt.HttpStreamTransport(f,{fetch:n,readableStream:o,emulationEndpoint:this._config.emulationEndpoint,decoder:this._decoder,encoder:this._encoder}),!this._transport.supported()){this._debug("http_stream transport not available"),this._currentTransportIndex++,l++;continue}}else if(_==="sse"){if(this._debug("trying sse transport"),this._transport=new Pt.SseTransport(f,{eventsource:s,fetch:n,emulationEndpoint:this._config.emulationEndpoint}),!this._transport.supported()){this._debug("sse transport not available"),this._currentTransportIndex++,l++;continue}}else if(_==="sockjs"){if(this._debug("trying sockjs"),this._transport=new kt.SockjsTransport(f,{sockjs:t,sockjsOptions:this._config.sockjsOptions}),!this._transport.supported()){this._debug("sockjs transport not available"),this._currentTransportIndex++,l++;continue}}else throw new Error("unknown transport "+_);break}}else{if((0,P.startsWith)(this._endpoint,"http"))throw new Error("Provide explicit transport endpoints configuration in case of using HTTP (i.e. using array of TransportEndpoint instead of a single string), or use ws(s):// scheme in an endpoint if you aimed using WebSocket transport");if(this._debug("client will use websocket"),this._transport=new Ne.WebsocketTransport(this._endpoint,{websocket:e}),!this._transport.supported())throw new Error("WebSocket not available")}let r=this,c,a=!1,h=!0;this._transport.name()==="sse"&&(h=!1);let b=[];if(this._transport.emulation()){let l=r._sendConnect(!0);if(b.push(l),h){let g=r._sendSubscribeCommands(!0,!0);for(let _ in g)b.push(g[_])}}let w=this._encoder.encodeCommands(b);this._transport.initialize(this._config.protocol,{onOpen:function(){a=!0,c=r._transport.subName(),r._debug(c,"transport open"),r._transportWasOpen=!0,r._transportClosed=!1,!r._transport.emulation()&&(r.startBatching(),r._sendConnect(!1),h&&r._sendSubscribeCommands(!0,!1),r.stopBatching())},onError:function(l){r._debug("transport level error",l)},onClose:function(l){r._debug(r._transport.name(),"transport closed"),r._transportClosed=!0;let g="connection closed",_=!0,f=0;if(l&&"code"in l&&l.code&&(f=l.code),l&&l.reason)try{let k=JSON.parse(l.reason);g=k.reason,_=k.reconnect}catch{g=l.reason,(f>=3500&&f<4e3||f>=4500&&f<5e3)&&(_=!1)}f<3e3?(f===1009?(f=p.disconnectedCodes.messageSizeLimit,g="message size limit exceeded",_=!1):(f=p.connectingCodes.transportClosed,g="transport closed"),r._emulation&&!r._transportWasOpen&&(r._currentTransportIndex++,r._currentTransportIndex>=r._transports.length&&(r._triedAllTransports=!0,r._currentTransportIndex=0))):r._transportWasOpen=!0;let R=!1;if(r._emulation&&!r._transportWasOpen&&!r._triedAllTransports&&(R=!0),r._isConnecting()&&!a&&r.emit("error",{type:"transport",error:{code:p.errorCodes.transportClosed,message:"transport closed"},transport:r._transport.name()}),r._disconnect(f,g,_),r._isConnecting()){let k=r._getReconnectDelay();R&&(k=0),r._debug("reconnect after "+k+" milliseconds"),r._reconnecting=!1,r._reconnectTimeout=setTimeout(()=>{r._startReconnecting()},k)}},onMessage:function(l){r._dataReceived(l)}},w)}_sendConnect(e){let t=this._constructConnectCommand(),s=this;return this._call(t,e).then(n=>{let o=n.reply.connect;s._connectResponse(o),n.next&&n.next()},n=>{s._connectError(n.error),n.next&&n.next()}),t}_startReconnecting(){if(!this._isConnecting()||this._reconnecting)return;if(this._reconnecting=!0,!(this._refreshRequired||!this._token&&this._config.getToken!==null)){this._initializeTransport();return}let t=this;this._getToken().then(function(s){if(!!t._isConnecting()){if(!s){t._failUnauthorized();return}t._token=s,t._debug("connection token refreshed"),t._initializeTransport()}}).catch(function(s){if(!t._isConnecting())return;t.emit("error",{type:"connectToken",error:{code:p.errorCodes.clientConnectToken,message:s!==void 0?s.toString():""}});let n=t._getReconnectDelay();t._debug("error on connection token refresh, reconnect after "+n+" milliseconds",s),t._reconnecting=!1,t._reconnectTimeout=setTimeout(()=>{t._startReconnecting()},n)})}_connectError(e){this.state===d.State.Connecting&&(e.code===109&&(this._refreshRequired=!0),e.code<100||e.temporary===!0||e.code===109?(this.emit("error",{type:"connect",error:e}),this._transport&&!this._transportClosed&&(this._transportClosed=!0,this._transport.close())):this._disconnect(e.code,e.message,!1))}_constructConnectCommand(){let e={};this._token&&(e.token=this._token),this._config.data&&(e.data=this._config.data),this._config.name&&(e.name=this._config.name),this._config.version&&(e.version=this._config.version);let t={},s=!1;for(let n in this._serverSubs)if(this._serverSubs.hasOwnProperty(n)&&this._serverSubs[n].recoverable){s=!0;let o={recover:!0};this._serverSubs[n].offset&&(o.offset=this._serverSubs[n].offset),this._serverSubs[n].epoch&&(o.epoch=this._serverSubs[n].epoch),t[n]=o}return s&&(e.subs=t),{connect:e}}_getHistoryRequest(e,t){let s={channel:e};return t!==void 0&&(t.since&&(s.since={offset:t.since.offset},t.since.epoch&&(s.since.epoch=t.since.epoch)),t.limit!==void 0&&(s.limit=t.limit),t.reverse===!0&&(s.reverse=!0)),s}_methodCall(){return this._isConnected()?Promise.resolve():new Promise((e,t)=>{let s=setTimeout(function(){t({code:p.errorCodes.timeout,message:"timeout"})},this._config.timeout);this._promises[this._nextPromiseId()]={timeout:s,resolve:e,reject:t}})}_callPromise(e,t){return new Promise((s,n)=>{this._call(e,!1).then(o=>{s(t(o.reply)),o.next&&o.next()},o=>{n(o.error),o.next&&o.next()})})}_dataReceived(e){this._serverPing>0&&this._waitServerPing();let t=this._decoder.decodeReplies(e);this._dispatchPromise=this._dispatchPromise.then(()=>{let s;this._dispatchPromise=new Promise(n=>{s=n}),this._dispatchSynchronized(t,s)})}_dispatchSynchronized(e,t){let s=Promise.resolve();for(let n in e)e.hasOwnProperty(n)&&(s=s.then(()=>this._dispatchReply(e[n])));s=s.then(()=>{t()})}_dispatchReply(e){let t,s=new Promise(o=>{t=o});if(e==null)return this._debug("dispatch: got undefined or null reply"),t(),s;let n=e.id;return n&&n>0?this._handleReply(e,t):e.push?this._handlePush(e.push,t):this._handleServerPing(t),s}_call(e,t){return new Promise((s,n)=>{e.id=this._nextCommandId(),this._registerCall(e.id,s,n),t||this._addCommand(e)})}_startConnecting(){this._debug("start connecting"),this._setState(d.State.Connecting)&&this.emit("connecting",{code:p.connectingCodes.connectCalled,reason:"connect called"}),this._client=null,this._startReconnecting()}_disconnect(e,t,s){if(this._isDisconnected())return;let n=this.state,o={code:e,reason:t},r=!1;s?r=this._setState(d.State.Connecting):(r=this._setState(d.State.Disconnected),this._rejectPromises({code:p.errorCodes.clientDisconnected,message:"disconnected"})),this._clearOutgoingRequests(),n===d.State.Connecting&&this._clearReconnectTimeout(),n===d.State.Connected&&this._clearConnectedState(),r&&(this._isConnecting()?this.emit("connecting",o):this.emit("disconnected",o)),this._transport&&!this._transportClosed&&(this._transportClosed=!0,this._transport.close())}_failUnauthorized(){this._disconnect(p.disconnectedCodes.unauthorized,"unauthorized",!1)}_getToken(){if(this._debug("get connection token"),!this._config.getToken)throw new Error("provide a function to get connection token");return this._config.getToken({})}_refresh(){let e=this._client,t=this;this._getToken().then(function(s){if(e!==t._client)return;if(!s){t._failUnauthorized();return}if(t._token=s,t._debug("connection token refreshed"),!t._isConnected())return;let n={refresh:{token:t._token}};t._call(n,!1).then(o=>{let r=o.reply.refresh;t._refreshResponse(r),o.next&&o.next()},o=>{t._refreshError(o.error),o.next&&o.next()})}).catch(function(s){t.emit("error",{type:"refreshToken",error:{code:p.errorCodes.clientRefreshToken,message:s!==void 0?s.toString():""}}),t._refreshTimeout=setTimeout(()=>t._refresh(),t._getRefreshRetryDelay())})}_refreshError(e){e.code<100||e.temporary===!0?(this.emit("error",{type:"refresh",error:e}),this._refreshTimeout=setTimeout(()=>this._refresh(),this._getRefreshRetryDelay())):this._disconnect(e.code,e.message,!1)}_getRefreshRetryDelay(){return(0,P.backoff)(0,5e3,1e4)}_refreshResponse(e){this._refreshTimeout&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null),e.expires&&(this._client=e.client,this._refreshTimeout=setTimeout(()=>this._refresh(),(0,P.ttlMilliseconds)(e.ttl)))}_removeSubscription(e){e!==null&&delete this._subs[e.channel]}_unsubscribe(e){if(!this._isConnected())return;let s={unsubscribe:{channel:e.channel}},n=this;this._call(s,!1).then(o=>{o.next&&o.next()},o=>{o.next&&o.next(),n._disconnect(p.connectingCodes.unsubscribeError,"unsubscribe error",!0)})}_getSub(e){let t=this._subs[e];return t||null}_isServerSub(e){return this._serverSubs[e]!==void 0}_sendSubscribeCommands(e,t){let s=[];for(let n in this._subs){if(!this._subs.hasOwnProperty(n))continue;let o=this._subs[n];if(o._inflight!==!0&&o.state===d.SubscriptionState.Subscribing){let r=o._subscribe(e,t);r&&s.push(r)}}return s}_connectResponse(e){if(this._transportWasOpen=!0,this._reconnectAttempts=0,this._refreshRequired=!1,this._isConnected())return;this._client=e.client,this._setState(d.State.Connected),this._setNetworkEvents(),this._refreshTimeout&&clearTimeout(this._refreshTimeout),e.expires&&(this._refreshTimeout=setTimeout(()=>this._refresh(),(0,P.ttlMilliseconds)(e.ttl))),this._session=e.session,this._node=e.node,this.startBatching(),this._sendSubscribeCommands(!1,!1),this.stopBatching();let t={client:e.client,transport:this._transport.subName()};e.data&&(t.data=e.data),this.emit("connected",t),this._resolvePromises(),this._processServerSubs(e.subs||{}),e.ping&&e.ping>0?(this._serverPing=e.ping*1e3,this._sendPong=e.pong===!0,this._waitServerPing()):this._serverPing=0}_processServerSubs(e){for(let t in e){if(!e.hasOwnProperty(t))continue;let s=e[t];this._serverSubs[t]={offset:s.offset,epoch:s.epoch,recoverable:s.recoverable||!1};let n=this._getSubscribeContext(t,s);this.emit("subscribed",n)}for(let t in e){if(!e.hasOwnProperty(t))continue;let s=e[t];if(s.recovered){let n=s.publications;if(n&&n.length>0)for(let o in n)n.hasOwnProperty(o)&&this._handlePublication(t,n[o])}}for(let t in this._serverSubs)!this._serverSubs.hasOwnProperty(t)||e[t]||(this.emit("unsubscribed",{channel:t}),delete this._serverSubs[t])}_clearRefreshTimeout(){this._refreshTimeout!==null&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null)}_clearReconnectTimeout(){this._reconnectTimeout!==null&&(clearTimeout(this._reconnectTimeout),this._reconnectTimeout=null)}_clearServerPingTimeout(){this._serverPingTimeout!==null&&(clearTimeout(this._serverPingTimeout),this._serverPingTimeout=null)}_waitServerPing(){this._config.maxServerPingDelay!==0&&(!this._isConnected()||(this._clearServerPingTimeout(),this._serverPingTimeout=setTimeout(()=>{!this._isConnected()||this._disconnect(p.connectingCodes.noPing,"no ping",!0)},this._serverPing+this._config.maxServerPingDelay)))}_getSubscribeContext(e,t){let s={channel:e,positioned:!1,recoverable:!1,wasRecovering:!1,recovered:!1};t.recovered&&(s.recovered=!0),t.positioned&&(s.positioned=!0),t.recoverable&&(s.recoverable=!0),t.was_recovering&&(s.wasRecovering=!0);let n="";"epoch"in t&&(n=t.epoch);let o=0;return"offset"in t&&(o=t.offset),(s.positioned||s.recoverable)&&(s.streamPosition={offset:o,epoch:n}),t.data&&(s.data=t.data),s}_handleReply(e,t){let s=e.id;if(!(s in this._callbacks)){t();return}let n=this._callbacks[s];if(clearTimeout(this._callbacks[s].timeout),delete this._callbacks[s],(0,P.errorExists)(e)){let o=n.errback;if(!o){t();return}let r=e.error;o({error:r,next:t})}else{let o=n.callback;if(!o)return;o({reply:e,next:t})}}_handleJoin(e,t){let s=this._getSub(e);if(!s){if(this._isServerSub(e)){let n={channel:e,info:this._getJoinLeaveContext(t.info)};this.emit("join",n)}return}s._handleJoin(t)}_handleLeave(e,t){let s=this._getSub(e);if(!s){if(this._isServerSub(e)){let n={channel:e,info:this._getJoinLeaveContext(t.info)};this.emit("leave",n)}return}s._handleLeave(t)}_handleUnsubscribe(e,t){let s=this._getSub(e);if(!s){this._isServerSub(e)&&(delete this._serverSubs[e],this.emit("unsubscribed",{channel:e}));return}t.code<2500?s._setUnsubscribed(t.code,t.reason,!1):s._setSubscribing(t.code,t.reason)}_handleSubscribe(e,t){this._serverSubs[e]={offset:t.offset,epoch:t.epoch,recoverable:t.recoverable||!1},this.emit("subscribed",this._getSubscribeContext(e,t))}_handleDisconnect(e){let t=e.code,s=!0;(t>=3500&&t<4e3||t>=4500&&t<5e3)&&(s=!1),this._disconnect(t,e.reason,s)}_getPublicationContext(e,t){let s={channel:e,data:t.data};return t.offset&&(s.offset=t.offset),t.info&&(s.info=this._getJoinLeaveContext(t.info)),t.tags&&(s.tags=t.tags),s}_getJoinLeaveContext(e){let t={client:e.client,user:e.user};return e.conn_info&&(t.connInfo=e.conn_info),e.chan_info&&(t.chanInfo=e.chan_info),t}_handlePublication(e,t){let s=this._getSub(e);if(!s){if(this._isServerSub(e)){let n=this._getPublicationContext(e,t);this.emit("publication",n),t.offset!==void 0&&(this._serverSubs[e].offset=t.offset)}return}s._handlePublication(t)}_handleMessage(e){this.emit("message",{data:e.data})}_handleServerPing(e){if(this._sendPong){let t={};this._transportSendCommands([t])}e()}_handlePush(e,t){let s=e.channel;e.pub?this._handlePublication(s,e.pub):e.message?this._handleMessage(e.message):e.join?this._handleJoin(s,e.join):e.leave?this._handleLeave(s,e.leave):e.unsubscribe?this._handleUnsubscribe(s,e.unsubscribe):e.subscribe?this._handleSubscribe(s,e.subscribe):e.disconnect&&this._handleDisconnect(e.disconnect),t()}_flush(){let e=this._commands.slice(0);this._commands=[],this._transportSendCommands(e)}_createErrorObject(e,t,s){let n={code:e,message:t};return s&&(n.temporary=!0),n}_registerCall(e,t,s){this._callbacks[e]={callback:t,errback:s,timeout:null},this._callbacks[e].timeout=setTimeout(()=>{delete this._callbacks[e],(0,P.isFunction)(s)&&s({error:this._createErrorObject(p.errorCodes.timeout,"timeout")})},this._config.timeout)}_addCommand(e){this._batching?this._commands.push(e):this._transportSendCommands([e])}_nextPromiseId(){return++this._promiseId}_resolvePromises(){for(let e in this._promises)this._promises[e].timeout&&clearTimeout(this._promises[e].timeout),this._promises[e].resolve(),delete this._promises[e]}_rejectPromises(e){for(let t in this._promises)this._promises[t].timeout&&clearTimeout(this._promises[t].timeout),this._promises[t].reject(e),delete this._promises[t]}};L.Centrifuge=B;B.SubscriptionState=d.SubscriptionState;B.State=d.State});var ze=S(E=>{"use strict";var Mt=E&&E.__createBinding||(Object.create?function(i,e,t,s){s===void 0&&(s=t);var n=Object.getOwnPropertyDescriptor(e,t);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,s,n)}:function(i,e,t,s){s===void 0&&(s=t),i[s]=e[t]}),xt=E&&E.__exportStar||function(i,e){for(var t in i)t!=="default"&&!Object.prototype.hasOwnProperty.call(e,t)&&Mt(e,i,t)};Object.defineProperty(E,"__esModule",{value:!0});E.Subscription=E.Centrifuge=void 0;var Lt=qe();Object.defineProperty(E,"Centrifuge",{enumerable:!0,get:function(){return Lt.Centrifuge}});var At=X();Object.defineProperty(E,"Subscription",{enumerable:!0,get:function(){return At.Subscription}});xt(U(),E)});var Be=pe(ze());var Je=pe(W()),Z=class{constructor(){this.eventEmitter=new Je.EventEmitter}getEventEmitter(){return this.eventEmitter}};var ee=class{constructor(e,t,s){this.subscribePromise=null;this.unsubscribePromise=null;this.shouldUnsubscribe=!1;this.shouldSubscribe=!1;this.centrifuge=e,this.subscription=e.newSubscription(t),this.subscription.on("publication",s)}subscribe(){if(this.shouldSubscribe=!0,this.shouldUnsubscribe=!1,!this.subscribePromise){let e;this.subscribePromise=new Promise((t,s)=>{e=s;let n=()=>{this.subscription.on("subscribed",()=>{this.subscribePromise=null,t()}),this.subscription.on("error",()=>{this.subscribePromise=null,s()}),this.subscription.subscribe()};this.unsubscribePromise?this.unsubscribePromise.then(()=>{this.shouldSubscribe?n():e()}):n()})}return this.subscribePromise}unsubscribe(){if(this.shouldSubscribe=!1,this.shouldUnsubscribe=!0,!this.unsubscribePromise){let e;this.unsubscribePromise=new Promise((t,s)=>{e=s,this.subscription.on("unsubscribed",()=>{this.unsubscribePromise=null,t({willResubscribe:this.shouldSubscribe})});let n=()=>{this.subscription.unsubscribe()};this.subscribePromise?this.subscribePromise.then(()=>{this.shouldUnsubscribe?n():e()}):n()})}return this.unsubscribePromise}getSubscription(){return this.subscription}};var te=class extends Z{constructor(e){super();this.subscriptions={};this.createCentrifugeSubscriptionProxy=(e,t)=>[e,(...s)=>this.eventEmitter.emit(t,...s)];this.centrifuge=e,this.centrifuge.on(...this.createCentrifugeSubscriptionProxy("connected","connect")),this.centrifuge.on(...this.createCentrifugeSubscriptionProxy("disconnected","disconnect")),this.centrifuge.on(...this.createCentrifugeSubscriptionProxy("error","error"))}connect(){this.centrifuge.connect()}subscribe(e){return this.subscriptions[e]||(this.subscriptions[e]=new ee(this.centrifuge,e,({data:t})=>{this.eventEmitter.emit("message",e,t)})),this.subscriptions[e].subscribe()}disconnectBeforeReconnect(){this.centrifuge.disconnect()}disconnect(){this.centrifuge.disconnect()}destroy(){this.getEventEmitter().removeAllListeners(),this.centrifuge.removeAllListeners()}unsubscribe(e){this.subscriptions[e]&&this.subscriptions[e].unsubscribe().then(({willResubscribe:t})=>{t||(this.centrifuge.removeSubscription(this.subscriptions[e].getSubscription()),delete this.subscriptions[e])})}};function Dt(i,e){return 2**e*Math.max(i,1e3)}function He(i){let{wsURL:e,token:t,reconnectConfig:s}=i,n=new Be.Centrifuge(e,{token:t,minReconnectDelay:s.initReconnectionDelay,maxReconnectDelay:Dt(s.initReconnectionDelay,s.maxReconnectionAttempts)});return new te(n)}var se=class{constructor(e){this.subscriptions=new Map;this.onFirstSubscriptionAdd=e.onFirstSubscriptionAdd,this.onLastSubscriptionRemove=e.onLastSubscriptionRemove}getAllSubscriptions(){return Array.from(this.subscriptions.values())}getAllSubscriptionsSnapshot(){return this.getAllSubscriptions().reduce((e,{clientIds:t,key:s})=>(t.forEach(n=>{e.push({clientId:n,subscriptionKey:s})}),e),[])}hasClient(e){return Array.from(this.subscriptions.values()).some(({clientIds:t})=>t.has(e))}hasSubscription(e){return this.subscriptions.has(e)}getOnSubscribePromise(e){var t;return((t=this.subscriptions.get(e))==null?void 0:t.onSubscribePromise)||null}clientHasSubscription(e,t){var s;return!!((s=this.subscriptions.get(t))==null?void 0:s.clientIds.has(e))}getClientSubscriptionKeys(e){return Array.from(this.subscriptions.values()).filter(({clientIds:t})=>t.has(e)).map(({key:t})=>t)}getClientsWithSubscription(e){var t;return Array.from(((t=this.subscriptions.get(e))==null?void 0:t.clientIds.values())||[])}createClientSubscription(e,t,s){if(this.clientHasSubscription(e,t))return;let n=!this.subscriptions.size;this.subscriptions.set(t,{clientIds:new Set([e]),key:t,onSubscribePromise:s}),n&&this.onFirstSubscriptionAdd&&this.onFirstSubscriptionAdd()}addClientToExistingSubscription(e,t){var s;(s=this.subscriptions.get(e))==null||s.clientIds.add(t)}removeClientSubscription(e,t){if(!this.clientHasSubscription(e,t))return;let s=this.subscriptions.get(t);if(!s)return;s.clientIds.delete(e),s.clientIds.size||this.subscriptions.delete(t),!this.subscriptions.size&&this.onLastSubscriptionRemove&&this.onLastSubscriptionRemove()}removeClient(e){!this.hasClient(e)||this.getClientSubscriptionKeys(e).forEach(t=>this.removeClientSubscription(e,t))}removeAllSubscriptions(){this.getAllSubscriptionsSnapshot().forEach(({clientId:e,subscriptionKey:t})=>this.removeClientSubscription(e,t))}};var Ve=i=>typeof i=="object"&&i!==null,ne=(i,e)=>{if(!Ve(i)||!Ve(e))return i===e;let t=Object.keys(i),s=Object.keys(e);if(t.length!==s.length)return!1;for(let n of t)if(!ne(i[n],e[n]))return!1;return!0};var ie=class{constructor(e){this.isConnected=!1;this.connection=null;this.createSubscribedHandler=(e,t)=>{let s=!1;return()=>{let n=!this.subscriptions.clientHasSubscription(e,t);s||n||(s=!0,this.onSocketSubscribed(e,t))}};this.onMessage=(e,t)=>{this.subscriptions.getClientsWithSubscription(e).forEach(s=>{this.onSocketMessage(s,e,t)})};this.disconnect=()=>{!this.connection||(this.connection.getEventEmitter().removeAllListeners(),this.connection.disconnect(),this.connection=null,this.isConnected&&(this.isConnected=!1,this.onDisconnect({reason:"disconnect",reconnect:!1})))};this.onConnect=e.onConnect,this.onDisconnect=e.onDisconnect,this.onSocketSubscribed=e.onSocketSubscribed,this.onSocketMessage=e.onSocketMessage,this.onError=e.onError,this.subscriptions=new se(e)}connectOrReconnect(e,t){this.connection?this.reconnect(this.connection,e,t):this.connect(e),this.config=e}connect(e){!e.wsURL||!e.token||(this.connection=He(e),this.connection.getEventEmitter().on("connect",t=>{this.isConnected=!0,this.onConnect(t)}).on("disconnect",t=>{this.onDisconnect(t)}).on("message",this.onMessage).on("error",this.onError),this.connection.connect())}reconnect(e,t,s){if(!ne(t,this.config)){e.getEventEmitter().removeAllListeners(),e.disconnect(),this.isConnected&&(this.isConnected=!1,this.onDisconnect({reason:"reconnect",reconnect:!0}));let n=this.subscriptions.getAllSubscriptionsSnapshot();this.subscriptions.removeAllSubscriptions(),this.connect(t),n.forEach(({clientId:o,subscriptionKey:r})=>this.subscribe(o,r));return}this.isConnected&&s()}subscribe(e,t){if(!this.connection)return;let s=this.subscriptions.getOnSubscribePromise(t);s?this.subscriptions.addClientToExistingSubscription(t,e):(s=this.connection.subscribe(t),this.subscriptions.createClientSubscription(e,t,s)),s.then(this.createSubscribedHandler(e,t))}unsubscribe(e,t){var s;!this.subscriptions.clientHasSubscription(e,t)||(this.subscriptions.removeClientSubscription(e,t),this.subscriptions.hasSubscription(t)||(s=this.connection)==null||s.unsubscribe(t))}unsubscribeClient(e){this.subscriptions.removeClient(e)}};var Ge=self,jt=5e3,re=class{constructor(e){this.cancelFn=null;this.clientIds=new Set;this.deleteClient=e=>{this.clientIds.delete(e)};this.stopWatch=()=>{this.cancelFn&&(this.cancelFn(),this.cancelFn=null)};this.onDeleteClient=e.onDeleteClient}getClients(){return Ge.clients.matchAll({type:"window",includeUncontrolled:!0})}async getClient(e){return(await this.getClients()).find(({id:s})=>s===e)}async startWatch(){if(this.cancelFn)return;let e=0,t=!1;this.cancelFn=()=>{t=!0,clearInterval(e)},this.clientIds=new Set((await this.getClients()).map(({id:s})=>s)),!t&&(e=Ge.setInterval(async()=>{let s=new Set((await this.getClients()).map(({id:n})=>n));t||(this.clientIds.forEach(n=>{s.has(n)||this.onDeleteClient(n)}),this.clientIds=s)},jt))}};var Wt=1e4,H=class{constructor(){this.clientIds=new Set;this.deleteClient=e=>{this.workerClients.deleteClient(e),this.onDeleteClient(e)};this.onDeleteClient=e=>{this.clientIds.delete(e),this.socket.unsubscribeClient(e),this.clientIds.size===0&&this.socket.disconnect()};this.onConnect=e=>{this.clientIds.forEach(t=>{this.postMessage(t,{type:"connected",data:e})})};this.onDisconnect=e=>{this.clientIds.forEach(t=>{this.postMessage(t,{type:"disconnected",data:e})})};this.onError=e=>{this.clientIds.forEach(t=>{this.postMessage(t,{type:"error",data:e})})};this.onSocketMessage=(e,t,s)=>{this.postMessage(e,{type:"message",subscriptionKey:t,data:s})};this.onSocketSubscribed=async(e,t)=>{this.postMessage(e,{type:"subscribed",subscriptionKey:t})};this.onFirstSubscriptionAdd=()=>{this.workerClients.startWatch()};this.onLastSubscriptionRemove=()=>{this.workerClients.stopWatch()};this.pingRandomClient=()=>{if(this.clientIds.size>0){let e=Array.from(this.clientIds),t=e[Math.floor(Math.random()*e.length)];this.postMessage(t,{type:"ping"})}};this.workerClients=new re({onDeleteClient:this.onDeleteClient}),this.socket=new ie({onConnect:this.onConnect,onDisconnect:this.onDisconnect,onSocketSubscribed:this.onSocketSubscribed,onSocketMessage:this.onSocketMessage,onFirstSubscriptionAdd:this.onFirstSubscriptionAdd,onLastSubscriptionRemove:this.onLastSubscriptionRemove,onError:this.onError}),setInterval(this.pingRandomClient,Wt)}async postMessage(e,t){let s=await this.workerClients.getClient(e);if(!s){this.deleteClient(e);return}let n=de({source:"socket-worker"},t);s.postMessage(n)}onMessage({source:e,data:t={}}){if(!(e instanceof Client))return;let s=t,n=e.id,{type:o}=s;switch(o){case"connectOrReconnect":{this.clientIds.add(n);let r=()=>this.postMessage(n,{type:"connected",data:{client:"",latency:0,transport:""}});this.socket.connectOrReconnect(s.config,r);break}case"disconnect":{this.deleteClient(n);break}case"subscribe":this.socket.subscribe(n,s.subscriptionKey);break;case"unsubscribe":this.socket.unsubscribe(n,s.subscriptionKey);break;default:break}}};var oe="ml-analytics-worker",V=class{constructor(){this.getSendOptions=e=>({method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}async onMessage({source:e,data:t={}}){if(!(e instanceof Client))return;let{type:s,payload:n,url:o,fullEventName:r}=t;switch(s){case"MlAnalyticsEvent":{try{let c=await this.send(o,n),a={source:oe,type:r,payload:n,errorMessage:c.ok?null:await c.text()};e.postMessage(a)}catch(c){let a=c instanceof Error?c.message:String(c),h={source:oe,type:r,payload:n,errorMessage:a};e.postMessage(h)}break}default:break}}send(e,t){return fetch(e,this.getSendOptions(t))}};var Ut=[/https:\/\/sentry-public((.*)?)/,/https:\/\/sentry.stripchat.tech(.*)?/],G=class{onFetch(e){Ut.some(t=>e.request.url.match(t))&&e.respondWith(fetch(e.request).then(t=>{if(!t.ok)throw Error();return t}).catch(()=>new Response("A network error was intercepted.",{status:200,statusText:"OK"})))}};var Qe="ping-worker-event",Ye="pong-worker-event";var ce=class{constructor(){this.onMessage=({source:e,data:t})=>{e instanceof Client&&t===Qe&&e.postMessage(Ye)}}};var $e={pingPong:!0},Xe="FEATURES_WORKER_REQUEST",Ze="FEATURES_WORKER_RESPONSE";var ae=class{constructor(){this.onMessage=({source:e,data:t})=>{if(e instanceof Client&&t===Xe){let s={type:Ze,payload:$e};e.postMessage(s)}}}};var Ft="v1",Nt="string"!==void 0?"1705571830437":"",ue=`${Ft}::${Nt}::cache`,Kt=["/pwa-offline.html"],qt=new H,zt=new V,Jt=new G,Bt=new ce,Ht=new ae,Vt=i=>{i.waitUntil(caches.open(ue).then(e=>e.addAll(Kt).catch(()=>{})))},Gt=i=>{i.waitUntil(caches.keys().then(e=>Promise.all(e.filter(t=>!t.startsWith(ue)).map(t=>caches.delete(t)))))},Qt=i=>{if(navigator.onLine)return Jt.onFetch(i);i.respondWith(fetch(i.request).catch(e=>{if(i.request.destination==="document")return caches.open(ue).then(t=>t.match("/pwa-offline.html"));throw e}))},Yt=i=>{Ht.onMessage(i),Bt.onMessage(i),qt.onMessage(i),zt.onMessage(i)};self.addEventListener("install",Vt);self.addEventListener("fetch",Qt);self.addEventListener("activate",Gt);self.addEventListener("message",Yt);})();
