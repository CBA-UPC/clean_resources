![function(t,e,n){var r=new(n(12));self.addEventListener("message",(function(t){var e=t.data,n=e.type,o=e.data;switch(n){case"add-site-data":var i=o.siteDomain,a=o.siteId,s=o.firstTimeStampForCalculation,_=o.numberOfDaysParticipatingInCalculation;return void r.addSiteData({siteDomain:i,siteId:a,numberOfDaysParticipatingInCalculation:_,firstTimeStampForCalculation:s});case"add-auction-data":var E=o.auctionData;r.collectData(E)}}))},function(t,e,n){const{openDB:r}=n(76),o=n(13),i=n(74),{USER_LEVEL_HB_AUCTION:{USER_HB_AUCTION_DATA:a,USER_HB_AUCTION_DATA_STORE:s,USER_HB_AUCTION_USER_ID:_,USER_HB_AUCTION_DATA_RESULT:E,MAIN_AUCTION_COUNT:u,BIDDER_WISE_OLDEST_AUCTION_DATE:c,DB_VERSION:d,LOGGER_EVENTS:{AUCTION_END_DATA:l,AUCTION_END_CALCULATION:T,AUCTION_END_BLOCKING_RESULT:p},WORKER_MESSAGES:{USER_ID_UPDATED:A}}}=n(75);t.exports=class{constructor(){this.dbName=a,this.storeName=s,this.dbVersion=d,this.offlineIndexDbData=[],this.indexDb=null,this.userID=null,this.onGoingProcess=Promise.resolve(),this.connectIndexDB(),this.apLoggerData=[],this.logAuctionDataPeriodically()}addSiteData({siteDomain:t,siteId:e,firstTimeStampForCalculation:n=0,numberOfDaysParticipatingInCalculation:r=30}){this.siteDomain=t,this.siteId=e,this.firstTimeStampForCalculation=n,this.numberOfDaysParticipatingInCalculation=r}getFormattedDate(t){return`${t.getDate()}/${t.getMonth()+1}/${t.getFullYear()}`}getDateFromFormattedDate(t){const[e,n,r]=t.split("/");return new Date(r,n-1,e,0,0,0,0)}connectIndexDB(){const t=this.storeName;r(this.dbName,this.dbVersion,{upgradeterminated(){const t=new Error("Index db terminated abnormally");postMessage({type:"webworker-user-level-hb-auction-error-logging",data:{error:t}})}}).then(.then(()=>postMessage({type:A,data:{userID:this.userID}})).then(.catch(t=>{this.indexDb=null,postMessage({type:"webworker-user-level-hb-auction-error-logging",data:{error:t}})})}setUserID(){return this.indexDb.get(this.storeName,_).then(t=>{if(!t)return this.userID=i(),this.indexDb.put(this.storeName,this.userID,_);this.userID=t})}insertAuctionDataStoredInOfflineQueue(){for(const t of this.offlineIndexDbData)this.collectData(t);this.offlineIndexDbData=[]}getAuctionResponseTimesBidderWise(t=[]){return t.reduce((t,e)=>{const{bidder:n,timeToRespond:r}=e;return t[n]||(t[n]=[]),t[n].push({time:r}),t},{})}collectData(t){postMessage({type:"webworker-user-level-hb-auction-debug-log",data:{msg:"collectData is called after auction end",logData:t}});const e=new Date,n=this.getFormattedDate(e);this.indexDb?(this.onGoingProcess||(this.onGoingProcess=Promise.resolve()),this.onGoingProcess=this.onGoingProcess.then(()=>this.indexDb.get(this.storeName,n).then(r=>{const o=performance.now(),{bidsReceived:i}=t,a=this.getUniqueBidsInAuctionForFormatwiseBidder(i),s=this.indexDb.transaction([this.storeName],"readwrite");return this.logAuctionDataToApLogger(t,a),this.doBidderBlockingAndTimeoutProcessing({transaction:s,startTime:o,auctionData:t,today:e,bidderLevelUniqueBidsReceived:a}).then(()=>s.objectStore(this.storeName).get(u)).then((t=0)=>{{const e=this.getProcessedAuctionData(r,a);return Promise.all([s.objectStore(this.storeName).put(e,n),s.objectStore(this.storeName).put(t<0?0:t+1,u)])}})}).catch(t=>{this.onGoingProcess=Promise.resolve(),postMessage({type:"webworker-user-level-hb-auction-error-logging",data:{error:t}})}))):this.offlineIndexDbData.push(t)}getUniqueBidsInAuctionForFormatwiseBidder(t){const e=t.reduce((t,e)=>{const{adUnitCode:n,bidder:r,timeToRespond:o,cpm:i}=e;let a={cpm:i,timeToRespond:o,bidder:r,adUnitCode:n};const s=t[n]||{};if(s[r]){const{cpm:t,timeToRespond:e}=s[r];a={...s[r],cpm:Math.max(t,i),timeToRespond:Math.max(e,o)}}return s[r]=a,t[n]=s,t},{});return Object.values(e).reduce((t,e)=>[...t,...Object.values(e)],[])}getProcessedAuctionData(t={},e){const{auctionCount:n=0,...r}=t,o={...r};for(const t of e){const{bidder:e,cpm:n,timeToRespond:r}=t,i=o[e];if(i){const{cpmRange:t,responseTimes:a}=i,s=Math.min(t[0],n),_=Math.max(t[1],n);a.push(r),o[e]={cpmRange:[s,_],responseTimes:a}}else o[e]={cpmRange:[n,n],responseTimes:[r]}}return{...o,auctionCount:n+1}}iveMeanOnNewItemAddition(t,e,n){const r=t+(n-t)/(e+1);return Number.isNaN(r)?0:r}giveMeanOnItemRemoval(t,e,n){if(e<=1)return 0;const r=t-(n-t)/(e-1);return Number.isNaN(r)?0:r}giveSdOnNewItemAddition({oldMean:t,newMean:e,newVal:n,oldSd:r,size:o}){if(!o)return 0;const i=((o-1)*r*r+(n-t)*(n-e))/o;return Number.isNaN(i)?0:Math.sqrt(i)}giveSdOnItemRemoval({oldMean:t,currentMean:e,removedVal:n,currentSd:r,size:o}){if(o<=1)return 0;const i=(o*r*r-(n-e)*(n-t))/(o-1);return Number.isNaN(i)?0:Math.sqrt(i)}getMedianUsingCountingSort(t,e){if(!e)return;const n=Object.keys(t).map(;if(n.sort(,e%2==0){const r=e/2,o=e/2+1;let i=0,a=null,s=null;for(const e of n)if(i+=t[e],!a&&i>=r&&(a=e),!s&&i>=o){s=e;break}return(a+s)/2}{const r=(e+1)/2;let o=null,i=0;for(const e of n)if(i+=t[e],!o&&i>=r){o=e;break}return o}}updateBidderDbData(t,e,n){return e.objectStore(this.storeName).get(t).then((r={mean:0,median:0,responseCount:0,sd:0,responseTimesMap:{}})=>{let{responseCount:o,mean:i,sd:a,responseTimesMap:s}=r;const _=n[t];for(const{time:t}of _){s[t]||(s[t]=0),s[t]++;const e=this.giveMeanOnNewItemAddition(i,o,t),n=this.giveSdOnNewItemAddition({oldMean:i,newMean:e,newVal:t,oldSd:a,size:o+1});i=e,a=n,o++}o<=0&&(o=0,s={});const E=this.getMedianUsingCountingSort(s,o),u={responseCount:o,mean:i,sd:a,responseTimesMap:{...s},median:E};return e.objectStore(this.storeName).put(u,t)})}updateBidderWiseResponseTimesInDb(t,e){const n=this.getAuctionResponseTimesBidderWise(t),r=Object.keys(n);return this.runPromisesWithConcurrency({dataList:r,func:this.updateBidderDbData,concurrencyLimit:r.length},e,n)}isKeyDateetLastNthDate(t,e){return new Date(t.getTime()-24*e*60*60*1e3)}runPromisesWithConcurrency({dataList:t,func:e,concurrencyLimit:n},...r){const o=[...t],i=new Array(n).fill(Promise.resolve()),a=t=>{if(o.length){const n=o.shift();return t.then(()=>{const t=e.apply(this,[n,...r]);return a(t)})}return t};return Promise.all(i.map(a))}giveFinalCpmRange({daysDataNeededForCalculation:t,transaction:e}){const n={};return this.runPromisesWithConcurrency({dataList:t,func:(t,n)=>e.objectStore(this.storeName).get(t).then((t={})=>{const e=Object.keys(t).filter(;for(const r of e){const{cpmRange:e}=t[r];if(n[r]){const t=Math.min(e[0],n[r][0]),o=Math.max(e[1],n[r][1]);n[r]=[t,o]}else n[r]=[...e]}}),concurrencyLimit:3},n).then(}getDateWiseDataWithInTimeFrame(t,e){const n=this.calculateCutoffDate(e);return t.filter(t=>this.getDateFromFormattedDate(t.date)>=n)}getActiveBiddersWithInTimeFrame(t,e){const n=this.getDateWiseDataWithInTimeFrame(t,e),r=new Set;return n.forEach(t=>{const e=t.data||{};for(const t in e)"auctionCount"!==t&&r.add(t)}),r}getStaleBidders(t,e,n){const r=this.getActiveBiddersWithInTimeFrame(e,n);return o(t,Array.from(r))}calculateCutoffDate(t){const e=new Date(t);return e.setDate(e.getDate()-this.numberOfDaysParticipatingInCalculation),e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0),e}isBidderOlderThanCutoff(t,e){return new Date(t)<e}getLongTermBidders(t,e){const n=this.calculateCutoffDate(e),r=[];for(const e in t){const o=t[e];this.isBidderOlderThanCutoff(o,n)&&r.push(e)}return r}giveBidderForFinalResult(t,e,n){const r=t.map(t=>e.objectStore(this.storeName).get(t).then();return e.objectStore(this.storeName).get(c).then(async t=>{const r=await this.getDateWiseData(e),o=this.getLongTermBidders(t,n);return{bidderWiseOldestAuctionDate:t,staleBidders:this.getStaleBidders(o,r,n)}}).then(async({bidderWiseOldestAuctionDate:t,staleBidders:e})=>Promise.all(r).then(n=>{const r={},o=Object.keys(t).reduce((t,e)=>(t[e]=-1,t),{});let i=-1;for(const t of n){const{mean:e,sd:n,median:a,bidderName:s,responseCount:_}=t;o[s]=_,_>0&&(r[s]={mean:e,sd:n,median:a}),i=Math.max(e+n,i)}return{biddersDataForResult:r,bidderTimeOut:i,bidderWiseResponseCount:o,staleBidders:e}}))}getDaysDifference(t,e){const n=Math.abs(e-t);return Math.floor(n/864e5)}calculateFinalResult({transaction:t,startTime:e,today:n}){return t.objectStore(this.storeName).getAllKeys().then(r=>{const o=[],i=[];for(const t of r)this.isKeyDate(t)&&t!==this.getFormattedDate(n)?o.push(t):[u,_,E,c].includes(t)||this.isKeyDate(t)||i.push(t);return Promise.all([this.giveFinalCpmRange({daysDataNeededForCalculation:o,transaction:t}),this.giveBidderForFinalResult(i,t,n),t.objectStore(this.storeName).get(u)]).then(([r,i,a=0])=>{const{biddersDataForResult:s,bidderTimeOut:_,staleBidders:u,bidderWiseResponseCount:c}=i,d=Object.keys(s);let l=null;l=0===o.length?Date.now():Math.min(...o.map();const A=new Date(l);let I=this.getDaysDifference(A,n);const R={daysDifference:I,bidderWiseResponseCount:c,bidderTimeOut:_,oldestDate:A.getTime(),cpmRange:{...r},biddersData:{...s},auctionCount:a+1,bidderToSendRequest:[...d],staleBidders:[...u],timeTakenForCalcultion:performance.now()-e,userID:this.userID,siteId:this.siteId,siteDomain:this.siteDomain,timeStamp:Date.now()};if(postMessage({type:"webworker-user-level-hb-auction-debug-log",data:{msg:"calculated result data for apLogger",logData:{resultDataForLogging:R}}}),postMessage({type:"webworker-user-level-hb-auction-aplogging",data:{event:T,loggerData:R}}),I<this.numberOfDaysParticipatingInCalculation)return t.objectStore(this.storeName).put(null,E).then(;postMessage({type:"webworker-user-level-hb-auction-aplogging",data:{event:p,loggerData:R}});const D={bidderTimeOut:_,bidderWiseResponseCount:c,bidderToSendRequest:[...d],staleBidders:[...u]};return t.objectStore(this.storeName).put(D,E).then(()=>(postMessage({type:"webworker-user-level-hb-auction-debug-log",data:{msg:"Yay ! Calculated final result",logData:{resultObjectToStore:D}}}),postMessage({type:"webworker-user-level-hb-auction-update-results",data:D})))})})}getDateWiseData(t){return t.objectStore(this.storeName).getAllKeys().then(e=>{let n=[];for(let t of e)this.isKeyDate(t)&&n.push(t);return Promise.all(n.map(e=>t.objectStore(this.storeName).get(e).then())})}calculateBidderWiseOldestAuctionTimeStamp(t){let e={};for(let n of t){let t=this.getDateFromFormattedDate(n.date).getTime(),r=Object.keys(n.data).filter(;for(let n of r)e[n]?e[n]=Math.min(e[n],t):e[n]=t}return e}updateBidderWiseOldestAuctionDate(t,e,n){return this.getDateWiseData(e).then(.then(r=>e.objectStore(this.storeName).get(c).then(o=>{const i={...Array.from(new Set(t.adUnits.flatMap(t=>t.bids).map()).reduce((t,e)=>(t[e]=n.getTime(),t),{}),...r,...o||{}};return e.objectStore(this.storeName).put(i,c)}))}doBidderBlockingAndTimeoutProcessing({bidderLevelUniqueBidsReceived:t,transaction:e,startTime:n,today:r,auctionData:o}){return this.updateBidderWiseOldestAuctionDate(o,e,r).then(.then(()=>this.calculateFinalResult({transaction:e,startTime:n,today:r}))}logAuctionDataToApLogger(t,e){const{auctionId:n,noBids:r}=t,o={auctionId:n,userID:this.userID,siteDomain:this.siteDomain,siteId:this.siteId},i={};for(const t of e){const{adUnitCode:e,bidder:n,cpm:r,timeToRespond:a}=t,s=i[e]||{...o,slotId:e,bidders:{},timeStamp:Date.now()},{bidders:_}=s;_[n]={cpm:r,responseTime:a},s.bidders=_,i[e]=s}for(const t of r){const{adUnitCode:e,bidder:n}=t,r=i[e]||{...o,bidders:{},slotId:e},{bidders:a={}}=r;a[n]||(a[n]={noData:!0}),r.bidders=a,i[e]=r}const a=Object.values(i);this.apLoggerData.push(...a)}logAuctionDataPeriodically(){setInterval(()=>{if(this.apLoggerData.length){const t=this.apLoggerData.splice(0,2);postMessage({type:"webworker-user-level-hb-auction-aplogging",data:{event:l,loggerData:{data:t}}}),postMessage({type:"webworker-user-level-hb-auction-aplogging-datadog",data:{event:l,loggerData:{data:t}}}),postMessage({type:"webworker-user-level-hb-auction-debug-log",data:{msg:"calculated auction data for apLogger",logData:{subsetAuctionData:t}}})}},250)}}},function(t,e,n){var r=n(17),o=n(41),i=n(43),a=n(44),s=n(45);function _(t){var e=-1,n=null==t?0:t.length;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}_.prototype.clear=r,_.prototype.delete=o,_.prototype.get=i,_.prototype.has=a,_.prototype.set=s,t.exports=_},function(t,e,n){var r=n(19),o=n(29),i=n(30),a=n(31),s=n(32);function _(t){var e=-1,n=null==t?0:t.length;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}_.prototype.clear=r,_.prototype.delete=o,_.prototype.get=i,_.prototype.has=a,_.prototype.set=s,t.exports=_},function(t,e,n){var r=n(2);t.exports=function(t){return r(this,t).get(t)}},function(t,e){t.exports=)},function(t,e,n){"use strict";n.r(e),n.d(e,"unwrap",(function(){return T})),n.d(e,"wrap",(function(){return l})),n.d(e,"deleteDB",(function(){return A})),n.d(e,"openDB",();let r,o;const i=new WeakMap,a=new WeakMap,s=new WeakMap,_=new WeakMap,E=new WeakMap;let u={getset:has:;st T=nst I=["get","getKey","getAll","getAllKeys","count"],R=["put","add","delete","clear"],D=new Map;=((u)}]);