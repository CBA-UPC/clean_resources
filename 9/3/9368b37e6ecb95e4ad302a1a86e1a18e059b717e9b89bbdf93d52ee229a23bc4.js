(()=>{ window.UBT_LOADTIMES = (window.UBT_LOADTIMES||0) + 1;if(window.UBT_LOADTIMES >1){console.log("UBT_LOADTIMES:"+window.UBT_LOADTIMES);return;}var t={1434:(t,e)=>{"use strict";var r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";e.Z=function(t){try{var e=Math.random().toString(16).slice(-4);if(t<=4)return e.slice(0,t);for(var n="",i=0;i<t-e.length;i++){var o=Math.ceil(Math.random()*(r.length-1));n+=r[o]}return e+n}catch(t){console.error("genRandomStr error.",t)}}},3434:(t,e)=>{"use strict";var r,n;e.Z=(r=16384,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",function(t){var e=[];t=unescape(encodeURIComponent(t));for(var i=0;i<t.length;i++)e.push(t.charCodeAt(i));return function(t){var e=[],i=[],o=-1,s=0,a=0,c=0,u=0,l=[];y(19);for(var d=0;d<t.length&&a<t.length;d+=r)d>0&&(i=i.slice(r)),p();return-1!=o&&v(),2==u?(m(c<<4&63),65==n.length&&(m(64),m(64))):4==u&&(m(c<<2&63),65==n.length&&m(64)),l.join("");function p(){for(var n=f(d+32768,t.length),c=f(n,t.length-3+1);a<n;a++){var u=0,l=0;if(a<c){var p=h();if(a>=s)for(var m=e[p]-1;130!=u&&m>=0&&m>=a-r;){var b=g(m);b>=3&&b>u&&(l=a-m-(u=b)),m=i[m-d]}i[a-d]=e[p]-1,e[p]=a+1}if(u>=3){for(s=a+u,-1!=o&&(v(),o=-1),y(u-3);l>127;)y(255&(127&l|128)),l>>=7;y(l)}else a>=s&&-1==o&&(o=a)}}unction h(){for(var e=0,r=a;r<a+3;r++)e*=16777619,e^=t[r];return 16383&e}function g(e){var r,n,i=f(e+130,a);for(r=e,n=a;r<i&&n<t.length&&t[r]==t[n];r++,n++);return r-e}function v(){for(var e=o;e<a;e+=127){var r=f(127,a-e);y(255&-r);for(var n=e;n<a&&n<e+r;n++)y(t[n])}}function y(t){var e=c<<6-u;m(63&(e|=(c=255&t)>>(u+=2))),u>=6&&m(63&(e=c>>(u-=6)))}(e)})},9662:6077:9670:1318:3658:206:4326:648:9920:8880:9114:8052:3072:5117:9781:4154:317:7207:8113:7392:748:1060:5392:2914:2109:7293:2104:4374:6916:6530:5668:1702:5005:8044:8173:7854:2597:3501:4664:8361:9587:2788:8340:9909:3157:614:4705:8554:111:1913:2190:6244:6339:4758:6277:3070:1236:8006:5181:(t,e)=>{e.f=Object.getOwnPropertySymbols},7976:6324:5296:7674:2140:3887:2626:4488:6200:5465:2309:,6293,1400,5656,9303,7466,7908,7593,4948,1694,1340,6330,9711,3307,3353,4811,5112,9191,7658,541,1703,8862},e={}r.d,r.g(),r.o,r.r,(()=>{"use strict";var t={};r.r(t),r.d(t,{FORCE_EXEC_TAG:()=>N,JSONParse_Safe:()=>k,TTAG:()=>U,compareVersion:()=>x,convertRadix:()=>O,decodeURI:()=>C,divideTaskExec:()=>B,fnWithLimit:()=>P,getDateStr:()=>A,promisify:()=>j,throttle:()=>M,transformLocalValue:()=>L,typeOf});const e={client:{},webClient:{},miniAppClient:{},mini:{},clientType:"",clientInfo:{},watcher:{}};r(8862),r(7658);let n({})nst a=classwatch(t,e){if(e=Array.isArray(e)?e:[e],this.triggeredMap.has(t)){let r=this.triggeredMap.get(t);e.forEach())}else if(this.watchingMap.has(t)){let r=this.watchingMap.get(t)||[];r.push(...e),this.watchingMap.set(t,r)}else this.watchingMap.set(t,e)}trigger(...t){let e=Array.prototype.shift.call(arguments),r=this.watchingMap.get(e);if(this.triggeredMap.set(e,arguments),!r||0===r.length)return!1;for(let t,e=0;t=r[e++];)t.apply(this,arguments);this.watchingMap.delete(e)}getTriggeredVal(t){if(this.triggeredMap.has(t)){let e=this.triggeredMap.get(t);if(null!=e)return Array.from(e)[0]}return null};var c,u,l;r(1703);const d=null===(c="1.1.71             ")?void 0:c.replace(/(\s*$)/,""),p=null===(u="73965/26129        ")?void 0:u.replace(/(\s*$)/,""),f={enterTs:Date.now(),instMap:new Map,curInst:null,version:d,summary:{resouceSize:parseInt(p.split("/")[0])||0,gzipSize:parseInt(p.split("/")[1])||0},setInst:function(t,e){try{if(f.curInst=e,f.instMap.size>=5){let t=f.instMap.keys().next().value;f.instMap.delete(t)}f.instMap.set(t,e)}catch(t){dt.printError("setInst err.",t)}},registerTime:0},h=[],g=f.summary;g.tag={sdkVersion:f.version,npmVersion:(null===(l=f.ubtCom)||void 0===l?void 0:l.version)||""};const v=f,y={UBT_LASTVIEW:"UBT_LASTVIEW",BFA_LS:"UBT_BFA",OLD_MINI_BFA_LS:"CTRIP_UBT_M",UBT:"UBTPending",BFA_COOKIE:"_bfa",VID_COOKIE:"UBT_VID",UBT_DESERTED:"UBT_DESERTED",UBT_UNHANDLED:"UBT_UNHANDLED",UBT_MAGNET:"UBT_MAGNET",UBT_CID:"UBT_CID"},m={BFA:/^1\.\d+\..{3,12}\.1\.\d+\.\d+\.\d+\.\d+\..+$/,VID:/^\d{10,13}\.[a-zA-Z0-9]{3,12}$/,UBT_LSKEY:new RegExp("^"+y.UBT+"_.+$","g"),TEST_ENV:/(\.qa\.nt\.)|(localhost|172\.16|127\.0|10\.15|10\.32)|(\.uat\.)|(\.fws\.)|(\.fat\d*\.)|(\.tripqate\.)|(\.(beta|dev)\.qunar\.)/i,TRIP:/\.trip/gi,INTRANET:/\.ctripcorp\./gi,MOBILE:/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i,TRIP_APP:/(ibuctrip)|(trip\.com_ctripwireless)/i,CTRIP_APP:/ctripwireless/i,UBTC:/^ubtc_([a-zA-Z](_?[a-zA-Z0-9]{1,20}){0,3})$/},b=3456e7,w=18e5,S=3e5,E=1e4,I=30,T=["o_page_render_check","http_request_perf"],_={repeatErrorDuration:6e4,multiSendIntervalTime:1e3,logReportIt:2e3,multiSendMaxCount:50,fpVersion:"*",tcpSwitch:!1,processChunkCount:20,requestConcurrenceMaxCount:20,mpStoreMaxCount:50,storageMaxSize:2097152}function O(t,e){return null==t?0:("number"==typeof t&&(t=t.toString()),parseInt(t,e))}function R(t){switch(Object.prototype.toString.call(t)){case"[object Number]":return isNaN(t)?vt.NaN:vt.Number;case"[object Boolean]":return vt.Boolean;case"[object String]":return vt.String;case"[object Array]":return vt.Array;case"[object Object]":return vt.Object;case"[object Undefined]":return vt.Undefined;case"[object RegExp]":return vt.RegExp;case"[object Error]":return vt.Error;case"[object Function]":return vt.Function;default:return vt.Unknown}}function k(t,e=null){try{if(!t)return e;let r=JSON.parse(t);return e&&Object.prototype.toString.call(e)!=Object.prototype.toString.call(r)?e:r}catch(t){return e}}function A(){return(new Date).toLocaleDateString("zh-cn").replace(/\//g,"")}function P(t,e=1){return function(){let r=1;return(...n)=>{n[0]&&1==n[0].stop&&(r=e+1),r++>e||t(...n)}}()}function x(t,e){try{if(!t||!e)return-1;let r=t.split("."),n=e.split(".");for(let t=0;t<=2;t++){let e=(r[t].match(/^\d+/g)||[])[0]||0,i=(n[t].match(/^\d+/g)||[])[0]||0;if(e>i)return 1;if(e<i)return-1}return 0}catch(r){return dt.reportError(`compareVersion error.sv:${t},cv:${e}`,r),-1}}function M(t,e){let r,n=!1;const i=()=>{null==r?n=!1:(t(...r),r=null,setTimeout(i,e))};return(...o)=>{let s=o[o.length-1]===N;s&&o.pop(),s||!n?(n=!0,t(...o),setTimeout(i,e)):r=o}}const U={DECODE:1,MAP:2,JSONPARSE:3};function L(t,e=0){return null==t||null==t?null:((e&U.DECODE)==U.DECODE&&(t=C(t)),(e&U.MAP)==U.MAP&&(t=function(t){let e={},r=t.split("&")||[];for(let t=0;t<r.length;t++){let n=r[t].split("=");n.length>1&&(e[n[0]]=n[1])}return e||{}}(t)),(e&U.JSONPARSE)==U.JSONPARSE&&(t=k(t)),t)}function B(t,e,r,n,i){!function o(){try{let s=0;if(t&&t.length>0){let n=t[0];for(;n&&s<=e;)r(n),s++,t.shift(),n=t[0]}i&&i(),t&&t.length>0?setTimeout(),0):n&&n()}catch(t){dt.reportError("unitTask error.",t)}}()}function j(t){return function(...e){let r=t(...e);return Promise.resolve(r)}}const N="force-exec";var D=r(1434);const $=function(){let t="";return function(e){return t||(t=e.isProd?e.isTrip?"//m.trip.com":e.isLAN?"//apigateway.ctripcorp.com":e.isIPV6?"//upgrade-m.ctrip.com":"//m.ctrip.com":"//gateway.m.fws.qa.nt.ctripcorp.com")}}();function V(t,e){return e||!t.isProd?"//s.uat.qa.nt.ctripcorp.com":t.isTrip?"//ubt-sin.tripcdn.com":"//s.c-ctrip.com"}function F(t){return t.isProd?t.isTrip?"//webresource.tripcdn.com":"//webresource.c-ctrip.com":t.isTrip?"//webresource.english.uat.qa.nt.ctripcorp.com":"//webresource.uat.qa.nt.ctripcorp.com"}function K(t){const e=$(t);return`${t.requestProtocol}${e}/restapi/soa2/18088/getAppConfig.json`}function q(t){const e=$(t);return`${t.requestProtocol}${e}/restapi/soa2/12538/createClientId`}function G(t,e){const r=V(t,e);return`${t.requestProtocol}${r}/bf.gif`}const J={context:["pid","vid","sid","pvid","version","appId","deviceImei","deviceMac","env","clientId","url","fromPage","fromPvid","fromSid","screenWidth","screenHeight","cookieLength","cookieCount","storageLength","lang","engine","referrer","appInfo","devicePixelRatio","other","idc","rid","fp","ffp","trafficSource","newVisitor","newSession"],user:["userId","abTest","corpid","duid"],business:["allianceId","allianceSid","allianceOuid","allianceCreateTime","sourceId","orderId","productId","innerOuId","innerSid","pushCode","attrs"],ubtList:["seq","triggerTs","type","subType","data"]},z={[n.ERROR]:"error",[n.USER_BLOCK]:"ub",[n.TRACE]:"tiled_tl",[n.DEV_TRACE]:"tiled_tl",[n.PRIVATE_TRACE]:"pr_t"};var Q=r(3434);async function W(t,r){let n=JSON.stringify({d:t}),i=function(t,e){const r=V(t,e);return`${t.requestProtocol}${r}/bee/collect`}(e.clientInfo,r);try{if(e.clientInfo.isSupportSendBeacon&&e.client.reportBySendBeacon)return e.client.reportBySendBeacon(n,i)}catch(t){e.clientInfo.isSupportSendBeacon=!1}let o=await e.client.request({body:n,url:i},E);return o.success&&200==o.data.status?{success:!0}:{success:!1,message:"postReport Faild."}}async function X(t,r,n){try{dt.log4Checking({tag:"report",data:t,ts:Date.now()}),!n&&e.client.reportMagenet&&e.client.reportMagenet());let i=function(t){let e={};for(const r in t){let n=[],i=t[r],o=J[r];o?(Array.isArray(i)?i.forEach((t=>{let e=[];o.forEach(((r,n)=>{e[n]=t[r]})),n.push(e)})):o.forEach()),e[r]=n):e[r]=i}return e}(t);if(i.sendTs=Date.now(),"tcp"==r&&e.client.reportByTcp)return e.client.reportByTcp(i);let o=`ac=b&d=${(0,Q.Z)(JSON.stringify(i))}`;return"single"==r?async function(t,r){return await e.client.imgRequest({body:t,headers:{"Content-Type":"image/gif"},url:G(e.clientInfo,r)})}(o,n):W(`f00${i.sendTs}!m1Legacy!${o}`,n)}catch(t){return dt.reportError("send error.",t),{success:!1,message:null==t?void 0:t.message}}}class Z{static getIntance(){return this._instance||(this._instance=new Z),this._instancepush(t,e){try{if(e.type==n.PV||t.pvSend)return this.send(t,e),!0;var r;if(this.pendingPushQ.has(t)&&Array.isArray(this.pendingPushQ.get(t)))null===(r=this.pendingPushQ.get(t))||void 0===r||r.push(e);else this.pendingPushQ.set(t,[e]);return!0}catch(e){return dt.reportError("multiSender push error.",e,t.instKey),!1}}async send(t,e){let r=`${t.instKey}_${e.seq}`;if(this.sendingCount>=_.requestConcurrenceMaxCount)return this.pendingSendQ.set(r,[t,e]),!0;this.pendingSendQ.has(r)&&this.pendingSendQ.delete(r),this.sendingCount++;let n=await X({ubtList:[e],...t.getCommon()},"single");return this.completeSend(t,e,n),n.success}async completeSend(t,e,r){if(this.sendingCount--,e.type==n.PV&&null!=r&&r.success&&(t.pvSend=!0,this.pendingPushQ.has(t))){let e=this.pendingPushQ.get(t)||[];await Promise.all(e.map())),this.pendingPushQ.set(t,[])}let i=Array.from(this.pendingSendQ.values())[0];if(i){const[t,e]=i;await this.send(t,e)}}start(){}close(){}restart(){}}const H=Z,{JSONParse_Safe:Y}=t,tt="pv";class etush(t,r){try{if(!e.client.checkLsPush())return this.senderReplacer=this.senderReplacer||H.getIntance(),this.senderReplacer.push(t,r);let i=t.instKey,o=t.getCommon(),s=r.type==n.PV,a=`${y.UBT}_${i}`,c=s?tt:r.seq+"",u=e.client.getLs(a,!0);u&&u.ubts?u.ubts[c]=r:u={common:o,ubts:{[c]:r}};let l=JSON.stringify(u);return this.usedSize=l.length,e.client.setLs(a,l),(s||Object.keys(u.ubts||{}).length>=_.multiSendMaxCount)&&this.send(new Map([[a,u]])),!0}catch(e){return dt.reportError("multiSender push error.",e,t.instKey),!1}}beforeSend(t,r){if(!t||!r||0==r.length)return;r.forEach((e=>this.sendingKeys.add(`${t}_${e}`)));let n=e.client.getLs(t,!0);if(n){let i=n.ubts||{};r.forEach()),0==Object.keys(i).length?e.client.removeLs(t):e.client.setLs(t,JSON.stringify(n)),this.usedSize=JSON.stringify(n).length}}completeSend(t,e){t&&e&&0!=e.length&&e.forEach((e=>{if(this.sendingKeys.delete(`${t}_${e}`),e==tt){let e=t.split("_")[1],r=v.instMap.get(e);r&&(r.pvSend=!0)}}))}getNextSendingItems(t){let r=new Map;try{let t=0,n=!1;return e.client.iterateLsKeys((i=>{if(!i||!m.UBT_LSKEY.test(i))return;let o=Y(e.client.getLs(i)),s=(null==o?void 0:o.ubts)||{};o&&s&&0!=Object.keys(s).length||e.client.removeLs(i);let a={};if(!n)for(const e in s){if(t>=_.multiSendMaxCount)break;this.sendingKeys.has(`${i}_${e}`)||(a[e]=s[e],e!=tt&&(n=!0,t++))}!(tt in s)||tt in a||this.sendingKeys.has(`${i}_${tt}`)||(a[tt]=s[tt]),Object.keys(a).length>0&&r.set(i,{common:o.common,ubts:a})})),r}catch(e){return dt.reportError("getNextSendingItems error.",e,t),null}}async send(t){let e=[];return t.forEach(((t,r)=>{let n=t.ubts||{};tt in n&&(e.push({lsKey:r,subKeys:[tt],request:{...t.common,ubtList:[n[tt]]}}),delete n[tt]),Object.keys(n).length>0&&e.push({lsKey:r,subKeys:Object.keys(n),request:{...t.common,ubtList:Object.values(n)}})})),await Promise.all(e.map((async({lsKey:t,subKeys:e,request:r})=>{this.beforeSend(t,e);let n=await X(r,"multi");n&&n.success&&this.completeSend(t,e)}))),!0}scheduleSend(t,e){try{let r=this.getNextSendingItems(t);return r&&r.size>0&&(this.send(r),e&&this.scheduleSend(t,!0)),this.scheduleSend.bind(this)}catch(t){dt.reportError("scheduleSend error.",t)}}start(t){return!!e.clientInfo.isSupportLS&&(null!=this.timer&&clearInterval(this.timer),this.timer=setInterval(this.scheduleSend.call(this,t),_.multiSendIntervalTime),!0)}close(t){e.clientInfo.isSupportLS&&null!=this.timer&&(clearInterval(this.timer),this.scheduleSend(t,!0))}const rt=et;const nt=class{constructor(t){s(this,"updateSessionTs",M((()=>{let t=e.client.readBfa();this.bfa&&t.id==this.bfa.id&&t.sid==this.bfa.sid&&t.pvid==this.bfa.pvid&&(this.bfa.session_ts=Date.now(),e.client.writeBfa(this,!0))}),2e3));try{e.client.refreshClientEnv(),dt.log4Checking({tag:"new ubt",data:t}),this.props=t,bt.ubtPropsCheck(t),this.pageId=t.pageId,this.appId=t.appId,this.business=t.business||{},this.initSettings(t.settings),this.isTimeout4waitingFields=!1,this.reportedErrorSet=new Set,this.pendingQueue=[],this.beginTs=t.registerTs||Date.now(),this.instKey=t.instKey,this.nextSeqNum=1,this.sender=e.clientInfo.isSupportLS&&this.sendSetting.isMultiSend?rt.getIntance():H.getIntance(),this.init(),lt.handleBfRegisterReq(this.instKey)}catch(e){var r;this.initInstFailed=!0,dt.printError("init error.",e,{tag:"Ubt.constructor err",data:{props:t,err:e.stack}}),this.clearErrorTimer&&clearInterval(this.clearErrorTimer),null!==(r=this.sender)&&void 0!==r&&r.timer&&clearInterval(this.sender.timer)}}initSettings(t){var e,r,n,i;t=t||{},this.sendSetting={waitingFields:null!==(e=t.waitingFields)&&void 0!==e?e:[],isMultiSend:null===(r=t.isMultiSend)||void 0===r||r,waitingTimes:null!==(n=t.waitingTimes)&&void 0!==n?n:1e4,bizTokenKeys:null!==(i=t.bizTokenKeys)&&void 0!==i?i:[],urlMaxLength:t.urlMaxLength||600,referrerMaxLength:t.referrerMaxLength||500,abTestMaxLength:t.abTestMaxLength||512}}init(){this.setBfa(),this.setCommon(),this.instKey||(this.instKey=this.genInstKey()),v.setInst(this.instKey,this),this.startClearErrorTimer(),this.sendSetting.waitingFields&&this.sendSetting.waitingFields.length>0&&setTimeout(),this.sendSetting.waitingTimes),this.sender.start(this.instKey),this.send({type:n.PV},this.beginTs),this.sendFPMetric()}startClearErrorTimer(){try{this.clearErrorTimer&&clearInterval(this.clearErrorTimer),this.clearErrorTimer=setInterval(),_.repeatErrorDuration)}catch(t){dt.reportError("startClearErrorTimer error.",t,this.instKey)}}genInstKey(){let t=this.common.context.vid.split(".")[1];return`${this.beginTs}_${t}`set(t){try{let{pageId:r,...n}=t;return r&&(this.pageId=r,this.bfa.pageId=r,e.client.writeBfa(this)),Object.assign(this.business,n),this.setCommon(),this.readyCheck(),{success:!0,readyStatus:this.readyStatus}}catch(t){return dt.reportError("UBT.set error.",t,this.instKey),{success:!1,message:null==t?void 0:t.message}}}send(t,e){try{if(this.updateSessionTs(),!t)throw new pt("send request is empty !");let{type:r,data:i}=t;if(e=e||(new Date).getTime(),bt.isUbtErrorData(r,i)&&this.isRepeatError(i))return{success:!1,message:"error repeat."};bt.stringifySendData(t),bt.validateSendRequest(t);let o={seq:this.seqNum_autoAdd,type:r==n.USER_BLOCK?n.ERROR:r,subType:z[r],triggerTs:e,data:bt.transformUbtData(t)};return this.pendingQueue.push(o),this.readyCheck(),{success:!0,readyStatus:this.readyStatus}}catch(t){return dt.reportError("send error.",t,this.instKey),{success:!1,message:null==t?void 0:t.message}}readyCheck(){let t=!0;if(this.pageId){if(!this.readyStatus&&!this.isTimeout4waitingFields){let e=Array.from(new Set([...this.sendSetting.waitingFields||[]]));for(let r=0;r<e.length;r++){const n=e[r];if(void 0===this.business[n]){t=!1;break}}}}else t=!1;return this.readyStatus=t,t&&this.handleReady(),t}async handleReady(){await e.client.bindClientInfo(this),e.clientInfo.tcpReady?X({...this.common,ubtList:this.pendingQueue},"tcp"):this.pendingQueue.forEach()),this.pendingQueue=[]}isRepeatError(t){if(this.clearErrorTimer){var e=[t.category,t.message,t.file,t.line,t.column].toString();if(this.reportedErrorSet.has(e))return!0;this.reportedErrorSet.add(e)}return!1}sendFPMetric(){let t=this;lt.get({name:"afp",handleResolve:e=>{e&&t.send({type:n.METRIC,key:"bbz_ubt_fp",data:{tag:e}})}})}setCommon(){this.common={context:{},business:{},user:{}};try{var t,r,n,i;let o={pid:this.pageId,vid:this.bfa.vid,sid:this.bfa.sid,pvid:this.bfa.pvid,version:`${v.version}${e.client.sdkVerSuffix||""}`,appId:this.appId,fromPage:null===(t=this.lastView)||void 0===t?void 0:t.pageId,fromPvid:null===(r=this.lastView)||void 0===r?void 0:r.pvid,fromSid:null===(n=this.lastView)||void 0===n?void 0:n.sid,trafficSource:e.client.getTrafficSource(this),newVisitor:1==this.bfa.sid,newSession:1==this.bfa.pvid},{orderId:s,productId:a,loginName:c,url:u,isBack:l,refer:d,abTest:p,...f}=this.business,h={enterTs:v.enterTs,...f||{}};null!==(i=v.ubtCom)&&void 0!==i&&i.symbol&&(h.npmVersion=v.ubtCom.version,h.npmEnterTs=v.ubtCom.enterTs),v.tcpReady&&(h.webVid=this.bfa.vid),"mini"==e.clientType&&(h.miniAppId=e.mini.appId),this.common={context:o,business:{orderId:s,productId:a,attrs:h},user:{userId:c}},e.client.bindClientInfo(this)}catch(t){dt.reportError("setCommon error.",t,this.instKey)}}setBfa(){let t=this.bfa=e.client.readBfa(),r=t.genVid();this.lastView="function"==typeof e.client.readLastView?e.client.readLastView(this):t,r||(r=e.clientInfo.vid),r&&m.VID.test(r)||(r=bt.genVidVal());let n=r.split(".");if(Object.assign(t,{vid:r,vid_ts:parseInt(n[0]),id:n[1]}),t.sid&&t.pvid){this.beginTs-t.session_ts>w?(t.sid++,t.pvid=1):t.pvid++,t.lastSession_ts=t.session_ts,t.session_ts=this.beginTs}else t.lastSession_ts=this.beginTs,t.session_ts=this.beginTs,t.sid=1,t.pvid=1;return t.pageId=this.pageId,e.client.writeBfa(this),e.client.writeVID(r),t}},it="unknown",{fnWithLimit:ot,divideTaskExec:st}=t,at={success:!0},ct=t=>({success:!1,message:null==t?void 0:t.message});class ut{static get(t,r){let{name:n,timeout:i,sync:o,handleResolve:s,handleReject:a}=t||{};try{if(!n)return;"function"!=typeof s&&(o=!0);let c,u=t.name+("bfa"==t.name&&r?`_${r}`:"");if(o)return e.watcher.getTriggeredVal(u);let l=ot(s),d=setTimeout((()=>{"function"==typeof a?(a("get timeout."),l({stop:!0})):l(null)}),null!=i?i:5e3);c,e.watcher.watch(u,c)}catch(t){dt.reportError("get error",t,r),a?a(t):s&&s(null)}}static findUbtInst(t){return t?v.instMap.get(t):v.curInst}static ubtApiPush(t,e){try{if("boolean"==typeof t)return at;if(dt.log4Checking({tag:"push req",data:t}),!t||!t.type||!t.data)throw new pt("Invalid push data.");let{type:r,data:n,pvId:i,triggerTs:o,context:s}=t;if(function(t,e){return"register"==e}(0,r)){let t=n;return i&&(t.instKey=i),o&&(t.registerTs=o),s&&(t.context=s),ut.register(t)}if(function(t,e){return"get"==e}(0,r))return ut.get(n,i);if(function(t,e){return"send"==e}(0,r))return ut.send(n,i,o,e);if(0,r))return ut.set(n,i,e)}catch(t){dt.reportError("Push error.",t)}}static handleBfRegisterReq(t){e.client.handleAfterRegister&&e.client.handleAfterRegister();let r=[];t!=it&&r.push(ut.BF_REGISTER_MAP.get(it)),r.push(ut.BF_REGISTER_MAP.get(t));for(let t=0;t<r.length;t++){const e=r[t];e&&0!=e.length&&st(e,_.processChunkCount,))}}static handleBfClientReadyReq(){st(ut.BF_CLIENTREADY_REQS,_.processChunkCount,))}static register(t){try{return t.instKey||(t.instKey=(0,D.Z)(6)),ut.pushCheck({data:t,type:"register"})?("mini"==e.clientType&&(t.appId=t.appId||e.mini.appId),new nt(t),t.instKey):t.instKey}catch(t){dt.printError("register err.",t)}}static send(t,e,r,n){try{return r=r||Date.now(),ut.invokeInstApi({type:"send",data:t,pvId:e,triggerTs:r},n),at}catch(t){return ct(t)}}static set(t,e,r){try{return ut.invokeInstApi({type:"set",data:t,pvId:e},r),at}catch(t){return ct(t)}}static pushCheck(t){return!!e.client.clientReady||(ut.BF_CLIENTREADY_REQS.push(t),!1)}static invokeInstApi(t,e){var r;if(!ut.pushCheck(t))return;let{type:n,data:i,pvId:o,triggerTs:s}=t,a=ut.findUbtInst(o),c=t.pvId||it,u=!a||!(null===(r=ut.BF_REGISTER_MAP.get(c))||void 0===r||!r.length)&&!e;if(u){var l,d;if(ut.BF_REGISTER_MAP.has(c)&&Array.isArray(ut.BF_REGISTER_MAP.get(c)))null===(d=ut.BF_REGISTER_MAP.get(c))||void 0===d||d.push(t);else ut.BF_REGISTER_MAP.set(c,[t]);null===(l=ut.BF_REGISTER_MAP.get(c))||void 0===l||l.push(t)}else"function"==typeof a[n]?a[n](i,s):dt.printError("invokeInstApi error",new pt(`inst:${!!a},type:${n},bufferReq:${u}`))}}s(ut,"BF_CLIENTREADY_REQS",[]),s(ut,"BF_REGISTER_MAP",new Map);const lt=ut;class dt{static printInfo(t){console.info(`[UBT INFO] ${t}`)static printError(t,e,r){console.error(`[UBT ERROR] ${t}`,e),r&&dt.log4Checking(r)}static reportError(t,e,r){try{dt.log4Checking({tag:"error",data:`${t}-${null==e?void 0:e.stack}`}),e instanceof ft||console.error(`[UBT ERROR] ${t}`,e),dt.errStacks.push(e.stack);let n=dt.errStacks.length;n>dt.ERR_STACK_SIZE&&(dt.errStacks=dt.errStacks.slice(n-dt.ERR_STACK_SIZE,n));let i="ExceptionError";e instanceof pt?i="ValidationError":e instanceof ft&&(i="IgnorableError"),dt.errStacks.filter()).length>=dt.LOOP_LIMIT_MAX||dt.sendErrorUbt({name:t||(null==e?void 0:e.name),stack:null==e?void 0:e.stack,message:`${t}\n ${null==e?void 0:e.message}`,extendedField:{errType:i}},"error",r)}catch(t){dt.printError("reportError error.",e)}}static sendErrorUbt(t,r,i){lt.send({type:n.ERROR,data:{...t,category:e.client.errCategory,framework:"normal",extendedField:{from:"framework",catcher:`auto_${v.version}_${r}`,...null==t?void 0:t.extendedField}}},i,Date.now())}static switchChecking(){try{let t=_.checkConfigs;if(!t||0==t.length)return;dt.checkConfig=t.find((({urlRegex:t})=>t&&new RegExp(t).test(e.client.getUrl()))),dt.checkConfig&&(dt.checkId=(0,D.Z)(6))}catch(t){dt.reportError("Log.switchChecking err.",t)}}static log4Checking(t,e=!0){if(!e||dt.checkConfig)try{var r,i;t.data=k(JSON.stringify(t.data));let o=(null===(r=dt.checkConfig)||void 0===r?void 0:r.tags)||[],s=(null===(i=dt.checkConfig)||void 0===i?void 0:i.keys)||[];if(o.length>0&&!o.includes(t.tag))return;if("report"==t.tag){let e=t.data||{},r=[];if(s.length>0){if((e.ubtList||[]).forEach((t=>{var e;(t.type==n.PV||s.includes(null===(e=t.data)||void 0===e?void 0:e.key))&&r.push(t)})),0==r.length)return;e.ubtList=r}}if(t.ts||(t.ts=Date.now()),h.push(t),!e)return;let a=h.length>=50;dt.reportChecking(a?N:null)}catch(t){dt.printError("log4Checking err",t)}}}s(dt,"LOOP_LIMIT_MAX",5),s(dt,"ERR_STACK_SIZE",10),s(dt,"errStacks",[]),s(dt,"checkConfig",null),s(dt,"checkId",""),s(dt,"reportChecking",M((async()=>{let t=h.length;if(dt.checkConfig&&0!=t)try{let{bfa:r}=v.curInst||{},n=function(t){return t.isProd?t.isTrip?`${t.requestProtocol}//www.trip.com/restapi/soa2/25894/json/reportUbtLog`:`${t.requestProtocol}//m.ctrip.com/restapi/soa2/25894/json/reportUbtLog`:`${t.requestProtocol}//m.uat.ctripqa.com/restapi/soa2/25894/reportUbtLog`}(e.clientInfo),i=JSON.stringify({id:dt.checkId,page:dt.checkConfig.pageId,bfa:r,logs:h,client:e.clientInfo});await fetch(n,{headers:{"Content-Type":"application/json",Accept:"application/json"},method:"POST",body:i}),h.splice(0,t)}catch(e){dt.printError("reportCheckingLog err",e),h.splice(0,t)}}),100));class pt extends Error{constructor(t){super(t)}class ht{constructor(){s(this,"clientReady",!1),this.watcher=new a}handleClientReadbeforeOpLs(t,e,r){let n=this.lsStatus,i=this.getLs(e);"s"==t?n[0].add(e):n[0].delete(e),null==r&&(r=""),null==i&&(i="");let o="string"==typeof r?r:JSON.stringify(r),s="string"==typeof i?i:JSON.stringify(i);n[1]+=o.length-s.length}setVid(){let t=this.readVid();if(!t){t=this.readBfa().genVid(),t||(t=bt.genVidVal()),this.writeVID(t)}return dt.log4Checking({tag:"setVid",data:{vid:t}},!1),this.watcher.trigger("vid",t),this.clientInfo.vid=t}triggerBfa(t){if(!t||!t.bfa)return;let{bfa:e,instKey:r}=t;[`bfa_${r}`,"bfa"].forEach((t=>{this.watcher.trigger(t,{vid:e.vid,sid:e.sid,pvid:e.pvid,pageId:e.pageId})}))}}let gt({}),vt({});const{typeOf:yt}=t;function mt(t){var r,n,i,o;dt.log4Checking({tag:"set config",data:t},!1);let s={..._};Object.assign(_,{multiSendMaxCount:t.multiSendMaxCount||s.multiSendMaxCount,multiSendIntervalTime:t.multiSendIntervalTime||s.multiSendIntervalTime,repeatErrorDuration:t.repeatErrorDuration||s.repeatErrorDuration,logReportIt:t.logReportIt||s.logReportIt,checkConfigs:t.checkConfigs||s.checkConfigs,fpVersion:null!==(r=t.fpVersion)&&void 0!==r?r:s.fpVersion,tcpSwitch:null!==(n=t.tcpSwitch)&&void 0!==n?n:s.tcpSwitch,processChunkCount:null!==(i=t.processChunkCount)&&void 0!==i?i:s.processChunkCount,requestConcurrenceMaxCount:null!==(o=t.requestConcurrenceMaxCount)&&void 0!==o?o:s.requestConcurrenceMaxCount}),e.clientInfo.tcpReady=e.clientInfo.tcpReady&&_.tcpSwitch;let a=v.curInst;if(a){s.repeatErrorDuration!=t.repeatErrorDuration&&a.startClearErrorTimer();let e=a.sender;e&&e.timer&&(s.multiSendMaxCount!=t.multiSendMaxCount||(s.multiSendIntervalTime,t.multiSendIntervalTime)),e.restart()}}const bt={initUbtConfig:async function(){let t={appId:"5278",categoryList:["ubtconfig"],head:{appid:"5278",cid:e.clientInfo.vid,cver:"000.001",sid:"8892"}},{success:r,data:n}=await e.client.request({body:JSON.stringify(t),url:K(e.clientInfo)});if(r){var i;let t=null===(i=((null==n?void 0:n.configList)||[])[0])||void 0===i?void 0:i.configContent;if(!t)return;mt(JSON.parse(t))}},setUbtConfig:mt,genVidVal:function(){return`${Date.now()}.${(0,D.Z)(12)}`},isUbtErrorData:function(t,e){return t==n.ERROR},ubtPropsCheck:function(t){if(!t||!t.appId)throw new pt("appId is required !");let{appId:e,settings:r}=t;if("number"!=typeof e&&isNaN(parseInt(e)))throw new pt("appId must be a number !");if(null!=r&&r.waitingFields&&!Array.isArray(r.waitingFields))throw new pt("waitingFields must be type of string[] !")},validateSendRequest:function(t){let{type:e,key:r,data:i}=t,o=[...Object.values(n)],s=`${e}-${r}`;if(!o.includes(e))throw new pt(`${s}: Unsupported sending type: ${e}! The supported types include ${o.join(", ")}.`);if(r&&!["number","string"].includes(typeof r))throw new pt(`${s}: key supports only number or string. `);let a=yt(i);if(e==n.PV||a!=vt.Null&&a!=vt.Undefined||(t.data="")(e)){if(null!=i&&i.value&&!function(t){let e=yt(t=t||0);if(e==vt.Number)return!0;if(e==vt.Object){let e=Object.keys(t);for(let r=0;r<e.length;r++)(r>=I||yt(t[e[r]])!=vt.Number)&&delete t[e[r]];return!0}return!1}(i.value))throw new pt(`${s}: illegal metric value.Value:${JSON.stringify(i)}`);if(null!=i&&i.tag&&!function(t,e,r){e=e||!1;let n=Object.keys(e);for(let t=0;t<n.length;t++){let i=n[t],o=e[i],s=yt(o);!T.includes(i)&&t>=r||![vt.String,vt.Boolean,vt.Number].includes(s)?delete e[i]:s==vt.String&&(e[i]=null==o?void 0:o.substring(0,200))}return!0}(0,i.tag,30))throw new pt(`${s}: illegal metric tag.`)}if(JSON.stringify(i||"").length>51200){let e=t.data=`${s}: data is too long. The maximum data size is 50KB.`;dt.printError(e)}return!0},stringifySendData:function(t){let{data:e,type:r}=t;if(r==n.METRIC)return;if(!e||yt(e)!=vt.Object)return;let i={};for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t)){let r=e[t];switch(typeof r){case"undefined":case"symbol":case"function":break;case"object":i[t]=JSON.stringify(r);break;default:i[t]=r}}t.data=i},transformUbtData:function(t){let{type:r,key:i,data:o}=t,s={},a=yt(o);if(a==vt.Null||a==vt.Undefined)return null;let c=a==vt.Object?o:{data:o};switch(r){case n.TRACE:case n.DEV_TRACE:"mini"==e.clientType&&(c.applet_scene=e.mini.scene),s={key:i,val:c};break;case n.PRIVATE_TRACE:s={key:i,val:o};break;case n.METRIC:s={name:i,tags:o.tag,value:o.value};break;case n.EXPOSURE:s={key:i,data:o};break;default:s={key:i,...c},r==n.ERROR&&!s.ownerOrgId&&s.organizationId&&(s.ownerOrgId=s.organizationId)}return s}},wt=window.UBT_BIZCONFIG||{};function St(){let t=Date.now();if(g.fpSwitch=1,"0"==_.fpVersion){let t=e.webClient.getCookie("UBT_FP");if(!t){t=`${(0,D.Z)(6)}-${(0,D.Z)(6)}-${(0,D.Z)(6)}`,e.webClient.setCookie("UBT_FP",t,864e5)}return v.fp=t,void e.watcher.trigger("fp",v.fp)}window.document.addEventListener("cfp_loaded",(()=>{g.fpTime=Date.now()-t;try{let t=window.cfp.toString();R(t)!=vt.Object&&(t={});let{browserId:r,secStr:n}=t;v.fp=r,v.ffp=n,e.watcher.trigger("fp",r),e.watcher.trigger("ffp",n),e.watcher.trigger("afp",{fp:r,ffp:n})}catch(t){dt.reportError("listen c_sec_loaded error.",t)}})),e.webClient.loadScript(function(t,e){let r=F(t);return`${t.requestProtocol}${r}/ares2/train/csec/${e}/default/sec/c-sec.js`}(e.clientInfo,_.fpVersion))}const Et={loadModules:function(){try{let{isLoadFP:t,isLoadMarketing:r,isLoadRMS:n}=wt;!1!==t&&St(),!1!==n&&e.webClient.loadScript(function(t){let e=F(t);return`${t.requestProtocol}${e}/ares2/risk/ubtrms/*/default/${t.isOnline?"rms":"mrms"}.js`}(e.clientInfo)),setTimeout((()=>{e.clientInfo.isTrip||!1===r||e.webClient.loadScript(function(t){return t.isOnline?`${t.requestProtocol}//webresource.c-ctrip.com/ResUnionOnline/R1/remarketing/js/remarketing.js`:`${t.requestProtocol}//webresource.c-ctrip.com/ResUnionOnline/R7/common/h5Redirect.js`}(e.clientInfo))}),0)}catch(t){dt.reportError("loadModules err.",t)}}};class It{static initConsole(){window.UBT_DEV={cdata(){var t;let r=null==v||null===(t=v.curInst)||void 0===t?void 0:t.bfa,{vid:n,sid:i,pvid:o}=r||{};if(n&&i&&o){let t=`${It.CDATA_URL}/${n}/${i}/${o}${e.clientInfo.isProd?"":"?env=fws"}`;window.open(t,"_blank")}return n},magnet(){var t;let e=null==v||null===(t=v.curInst)||void 0===t?void 0:t.bfa,{vid:r}=e||{};if(r){let t=`${It.MONITOR_URL}?id=${r}&type=vid`;window.open(t,"_blank")}return r},get bfa(){var t;return(null==v||null===(t=v.curInst)||void 0===t?void 0:t.bfa)||{}},get vi}}static async switchMagnet(){try{let t,{magnetKey:r,magnetOn:n}=e.webClient.getUrlSearchObject()||{};if(r&&"true"===n&&(t=await It.connectMagnet(r)),"false"===n&&(t=!1,It.disconnectMagnet(r)),null==t){let n=e.webClient.getCookie(y.UBT_MAGNET);!n||r&&r!=n||(t=!0)}v.magnetSwitch=t}catch(t){dt.reportError("switchMagnet error.",t)}}static inMagnetDebug(){if(!v.magnetSwitch)return!1;let t=e.webClient.getCookie(y.UBT_MAGNET);return v.magnetSwitch=!!t,v.magnetSwitch}static updateMagnetMaxAge(){let t=e.webClient.getCookie(y.UBT_MAGNET);t&&e.webClient.setCookie(y.UBT_MAGNET,t,S)}static async connectMagnet(t){try{e.webClient.setCookie(y.UBT_MAGNET,t,S);let r=`${It.MAGNET_SVC_URL}/${t}?type=debugOn`,n=await fetch(r,{headers:{"Content-Type":"application/json;charset=UTF-8"},method:"POST",body:JSON.stringify({debug:!0,vid:e.clientInfo.vid,meta:{sdkver:v.version}})});if(200==n.status){return!0===(await n.json()).success}return!1}catch(t){return dt.reportError("connectMagnet error.",t),!1}}s(It,"MONITOR_URL","http://magnet.mobile.uat.qa.nt.ctripcorp.com/monitor"),s(It,"MAGNET_SVC_URL","//magnet.mobile.uat.qa.nt.ctripcorp.com/web/access"),s(It,"CDATA_URL","https://mpaas.ctripcorp.com/cdataV2/session");const Tt=It,_t={start_point:null,start_touch:!1,moving:!1};function Ct(t){try{if(!t||!t.reason)return;let e=t.reason,r="string"==typeof e?null:function(t){var e;if(!t)return;let r=t.split("\n"),n=r[r.length-1];n=null===(e=n)||void 0===e?void 0:e.substring(n.indexOf("(")+1,n.indexOf(")"));let i=n.split(":");return i.length<3?void 0:{column:i.pop(),line:i.pop(),file:i.join(":")}}(null==e?void 0:e.stack),n={name:e.message||e,message:e.message||e,stack:null==e?void 0:e.stack,line:null==r?void 0:r.line,column:null==r?void 0:r.column,file:null==r?void 0:r.file};dt.sendErrorUbt(n,"rejection")}catch(t){dt.reportError("handleRejection error.",t)}}function Ot(t,e,r,n,i){try{var o;let s={name:(null==i?void 0:i.name)||(null==t?void 0:t.message)||t,stack:(null==i?void 0:i.stack)||(null==t||null===(o=t.error)||void 0===o?void 0:o.stack),message:(null==i?void 0:i.message)||(null==t?void 0:t.message),line:r||(null==t?void 0:t.lineno),column:n||(null==t?void 0:t.colno),file:e||(null==t?void 0:t.file)};dt.log4Checking({tag:"error-listener",data:s}),dt.sendErrorUbt(s,"error")}catch(i){dt.reportError("handleError error.",i)}}function Rt(t,e){let r=0;if("DIV"==e&&(t.attributes["page-url"]||t.getAttribute("page-url")))return"";if(t.parentNode){let e=t.parentNode.firstChild;for(;e&&e!=t;)1==e.nodeType&&e.tagName==t.tagName&&r++,e=e.nextSibling}return r>0?"["+ ++r+"]":""}function kt(t){try{if(!t||!t.target)return;let i=t.target,o=window.document.documentElement,s=window.document.body;if(i&&1==i.nodeType&&i.nodeName&&i.getBoundingClientRect){var e,r;let a,c,u=i.nodeName.toUpperCase(),l=i.getBoundingClientRect(),d="",p=Math.max(o.scrollLeft,s.scrollLeft),f=Math.max(o.scrollTop,s.scrollTop),h=(null===(e=_t.start_point)||void 0===e?void 0:e.pageX)||t.pageX||0,g=(null===(r=_t.start_point)||void 0===r?void 0:r.pageY)||t.pageY||0,v=O((o.clientWidth||s.clientWidth)/2,10);if("SELECT"==u&&g-l.top-f<0?(d+="[@x='"+O(h+l.left+p-v,10)+"'][@y='"+O(g+l.top,10)+"']",a=h,c=g-f):(d+="[@x='"+(h-v)+"'][@y='"+g+"']",a=O(h-l.left-p,10)||0,c=O(g-l.top-f,10)||0),a>=0&&c>=0&&a<=screen.width+p){d+="[@rx='"+a+"']",d+="[@ry='"+c+"']";let t=function(t){let e,r=[],n=0;for(;t&&9!=t.nodeType;){if(1==t.nodeType){let i=(t.nodeName||"").toUpperCase(),o=t.id||"",s=i+Rt(t,i);o&&"function"==typeof o.indexOf&&-1==o.indexOf("client_id_viewport")&&(s+="[@id='"+o+"']"),e=t.getAttribute("data-ubt-key"),e&&(s+="[@cid='"+e+"']"),r[n++]=s}t=t.parentNode}return r.length>2?r.reverse().join("/"):""}(i);t&&lt.send({type:n.ACTION,data:{xpath:t+d,action:"click"}})}}}catch(t){dt.reportError("handleClick error.",t)}}function At(t){_t.start_point=t.touches&&t.touches[0]||t,_t.moving=!1,_t.start_touch=!0}function Pt(t){if(_t.start_touch){var e,r;let n=t.touches&&t.touches[0]||t,i=0,o=0;i=Math.abs(n.pageX-((null===(e=_t.start_point)||void 0===e?void 0:e.pageX)||0)),o=Math.abs(n.pageY-((null===(r=_t.start_point)||void 0===r?void 0:r.pageY)||0)),_t.moving=!(i<6||o<6)}}function xt(t){!_t.moving&&_t.start_touch&&kt(t),_t.start_touch=!1,_t.start_point=null}const Mt={init:function(){window.addEventListener("error",Ot),window.addEventListener("unhandledrejection",Ct);let t="ontouchstart"in window,r=t?"touchstart":"mousedown",n=t?"touchmove":"mousemove",i=t?"touchend":"mouseup";window.document.addEventListener(r,At,!0),window.document.addEventListener(n,Pt,!0),window.document.addEventListener(i,xt,!0),window.document.addEventListener("visibilitychange",(t=>{"visible"===window.document.visibilityState&&v.curInst&&e.webClient.writeLastView(v.curInst)}))}};r(541);const Ut=window.UBT_COMP||{},Lt={_trace:n.TRACE,_tracklog:n.TRACE,_devTrace:n.DEV_TRACE,_privateTrace:n.PRIVATE_TRACE,_exposure:n.EXPOSURE,_trackMetric:n.METRIC,_trackMatrix:n.METRIC,_trackError:n.ERROR,_trackUserBlock:n.USER_BLOCK};function Bt(){1==v.instMap.size&&setTimeout((()=>{!function(){window.__bfi=window.__bfi||[];const t=window.__bfi;g.init_old_counts=t.length,B(t,_.processChunkCount,jt,)),window.$_bf=window.$_bf||{},window.$_bf._getStatus=function(){let t=v.curInst;if(!t)return{};let{context:e,user:r}=(null==t?void 0:t.getCommon())||{};return{vid:null==e?void 0:e.vid,sid:null==e?void 0:e.sid,pvid:null==e?void 0:e.pvid,abtest:null==r?void 0:r.abTest,pid:t.pageId,pv:t.pvSend}}}()}),0)}function jt(t){dt.log4Checking({tag:"old push",data:t});try{let[e,...r]=t;if(["_getFullPV","_getStatus","_getFP","_getPageid"].includes(e)){let t,n=r[0],i="function"==typeof n;switch(e){case"_getFullPV":return lt.get({name:"bfa",handleResolve:function(t){i&&n(t?`${t.vid}.${t.sid}.${t.pvid}`:"")}});case"_getStatus":return lt.get({name:"bfa",handleResolve:function(t){i&&n(t?{vid:t.vid,sid:t.sid,pvid:t.pvid,pid:t.pageId}:{})}});case"_getPageid":return lt.get({name:"bfa",handleResolve:function(t){i&&n(!1,null==t?void 0:t.pageId)}});case"_getFP":let t=r[1];return lt.get({name:"fp",handleResolve:function(e){if(!i)return;let r="";e&&(r=`a${encodeURIComponent(e)}`),t?n(JSON.stringify({fp:e,sfp:r})):n(e,r,e)}})}return void(n&&"function"==typeof n&&n(t))}let i=v.curInst;if(!i)return;let o=Lt[e];if(!o)return;let s,a="",c=null;switch(o){case n.TRACE:case n.DEV_TRACE:case n.PRIVATE_TRACE:case n.EXPOSURE:a=r.shift(),s=r[0],c=r[1];break;case n.METRIC:if("_trackMetric"==e){let t=r[0]||{};a=t.name,s={tag:t.tag,value:t.value}}else"_trackMatrix"==e&&(a=r[0],s={tag:r[1],value:r[2]},c=r[4]);break;case n.ERROR:case n.USER_BLOCK:s=r[0],c=r[1];break;default:throw new pt("unsupported old push: "+JSON.stringify(t))}i.send({type:o,key:a,data:s}),"function"==typeof c&&c()}catch(t){dt.reportError("Old api push error.",t)}}let Nt=!1;function Dt(){Nt||window.UBT_LEAVING_TAG||(Nt=!0,dt.log4Checking({tag:"consumer init",data:Ut}),Ut&&Ut.symbol&&x(Ut.version,"1.1.1")<=0&&(dt.printWarn(`@ctrip/ubt-web版本较低为: ${Ut.version}，请尽早升级至新版: >1.3.x`),function(){window.UBT_CTOR=nt;let t=e.webClient.getLs(y.UBT_DESERTED,!0)||[],{insts:r}=Ut,n=[...t,...r||[]];n&&0!=n.length&&(n.forEach((t=>{let{props:e,registerTs:r,requestQ:n,instKey:i}=t,o=new nt({...e,registerTs:r,instKey:i});Bt(),t.realInst=o,n.forEach((t=>{let{name:e,data:r,triggerTs:n}=t;o[e](r,n),t.hasReceived=!0}))})),e.webClient.removeLs(y.UBT_DESERTED),Ut.insts=[])}()),async function(){try{if(window.UBT_API=window.UBT_API||[],R(window.UBT_API)!=vt.Array)return;window.UBT_API_TEMP={push:lt.ubtApiPush};let t=e.webClient.getLs(y.UBT_UNHANDLED,!0)||[];R(t)==vt.Array&&(
//***!!!顺序保证!!!***
Ut.symbol&&x(Ut.version,"1.1.2")>0&&t.unshift(!0),window.UBT_API.unshift(...t));let r=window.UBT_API;g.init_new_counts=r.length,B(r,_.processChunkCount,lt.ubtApiPush,(()=>{delete window.UBT_API_TEMP,window.UBT_API.push=lt.ubtApiPush,window.UBT_API.rewrited=!0}),(()=>{try{if(0==t.length)return;t.splice(0,_.processChunkCount),e.webClient.setLs(y.UBT_UNHANDLED,JSON.stringify(t));let r=k(e.webClient.getLs("ubt_test_c"))||0;e.webClient.setLs("ubt_test_c",r+1)}catch(t){dt.printError("afterUnitTaskCb error.",t)}}))}catch(t){dt.reportError("ProcessUbtApi error.",t)}}())}v.consumer=Dt;const $t={init:Dt,handleAfterRegister:Bt};class Vt{constructt.keys(t).forEach((e=>{this[e]=t[e]})),t.vid&&!t.id)){let e=t.vid.split(".");this.vid_ts=parseInt(e[0]),this.id=e[1]}}genBfaVal(){return`1.${this.vid_ts}.${this.id}.1.${this.lastSession_ts}.${this.session_ts}.${this.sid}.${this.pvid}.${this.pageId||0}`}genVid(){return this.vid?this.vid:this.vid_ts&&this.id?this.vid=`${this.vid_ts}.${this.id}`:void 0}static parse(t,e="cookie"){let r;try{if(!t)return new Vt;if("cookie"==e){let e=t.split(".")||[];m.BFA.test(t)&&e.length>6&&(r={vid_ts:parseInt(e[1]),id:e[2],lastSession_ts:parseInt(e[4]),session_ts:parseInt(e[5]),sid:parseInt(e[6]),pvid:parseInt(e[7]),pageId:e[8]})}else{let e=k(t,{});e.vid&&e.sid&&e.pvid&&(r=e)}let n=new Vt(r);return n.genVid(),n}catch(t){return dt.reportError("BFA parse error.",t),new Vt}}}const Ft=Vt,Kt="ab_testing_tracker";const qt=class extends ht{constructor(){super(),this.clientType="web",this.errCategory=window.__NEXT_DATA__&&"string"==typeof window.__NEXT_DATA__.version?"Nfes-error":"Web-error",this.lsStatus=this.getLsStatus(),this.init()}async init(){try{"undefined"!=typeof window&&(window.UBT_GLOBAL=v,v.ubtCom=window.UBT_COMP);let t=Date.now();await this.setClientInfo(),dt.log4Checking({tag:"sdk init"},!1),window.UBT_API=window.UBT_API||[],await Tt.switchMagnet();let e=Date.now();this.initUbtConfig().then((()=>{let t=Date.now(),r=t-e;g.getConfigTime=r,dt.switchChecking(),Et.loadModules(),Mt.init(),$t.init(),Tt.initConsole();let n=Date.now();g.microTime=n-t})),this.handleClientReady();let r=Date.now();g.macroTime=r-t}c("init err",t)}}refreshClientEnv(){}async initUbtConfig(){try{var t;if(null!==(t=window.UBT_COMP)&&void 0!==t&&t.ubtConfig)return v.summary.prefetchConfig=1,void bt.setUbtConfig(window.UBT_COMP.ubtConfig);await bt.initUbtConfig()}catch(t){dt.rereturn t.business.trafficSource||""}async setClientInfo(){let t=this.checkLsSupport(),e=this.getRootDomain();const{location:r,navigator:n}=window,i=null==n?void 0:n.userAgent,o=n&&n.javaEnabled()?1:0,s=m.CTRIP_APP.test(i),a=m.TRIP_APP.test(i),c=!m.MOBILE.test(i),u=null!=wt.isLAN?!!wt.isLAN:m.INTRANET.test(r.href),l=r.protocol,d="https:"!=l&&"http:"!=l,p=d?"https:":l;let f=null!=wt.isOverseas?wt.isOverseas:m.TRIP.test(r.host);const h=null!=wt.isProd?wt.isProd:!m.TEST_ENV.test(r.host),g=/\.uat\./.test(r.host),v=!!window.__ubt_ipv6;let y;y=c?gt.Online:s||a||d?gt.hybrid:gt.H5;let b={javaEnable:o,isCtripApp:s,isTripApp:a,isOnline:c,isFile:d,webType:y,isSupportLS:t,rootDomain:e,isTrip:f,isProd:h,isUat:g,isLAN:u,isIPV6:v,protocol:l,requestProtocol:p,tcpReady:"undefined"!=typeof CtripBusiness&&"function"==typeof CtripBusiness.app_track_UBT_JS_log_V2};return b.isSupportSendBeacon=this.checkIsSupportSendBeacon(b),this.clientInfo=b,this.sdkVerSuffix="/new/"+(f?"t":"c"),this.syncCwxParams(),this.setVid(),await this.setClientIds(),this.clientInfo}async bindClientInfo(t){let{common:e,sendSetting:r}=t;try{var n,i,o,s,a,c,u;let l=this.getLocals(r)||{},d={storageLength:this.clientInfo.isSupportLS?null===(n=localStorage)||void 0===n?void 0:n.length:0,env:this.clientInfo.webType,clientId:this.clientID,lang:(navigator&&navigator.language?navigator.language:"").toLowerCase(),screenWidth:screen.width,screenHeight:screen.height,url:null===(i=(null===(o=t.props.context)||void 0===o?void 0:o.url)||this.getUrl())||void 0===i?void 0:i.substring(0,r.urlMaxLength),referrer:null===(s=(null===(a=t.props.context)||void 0===a?void 0:a.referrer)||this.getReferrer())||void 0===s?void 0:s.substring(0,r.urlMaxLength),devicePixelRatio:window.devicePixelRatio||1,cookieLength:document.cookie.length,cookieCount:(document.cookie.match(/[^=]+=[^;]*;?/g)||[]).length,rid:null===(c=window.__NEXT_DATA__)||void 0===c?void 0:c.rootMessageId};Object.assign(e.context,l.context,d),Object.assign(e.business,l.business),Object.assign(e.user,{...l.user,userId:e.user.userId||(null===(u=l.user)||void 0===u?void 0:u.userId)});let p=e.business.attrs.bizTokens||[];p.length>0&&!e.user.duid&&(e.user.duid=p[0]);let f=this.getBizTokens(r.bizTokenKeys);Object.assign(e.business.attrs,{bizTokens:f,eid:l.eid},l.ubtc)}catch(t){dt.reportError("bindClientInfo error.",t)}}readLastView(t){let e=this.getLs(y.UBT_LASTVIEW,!0);if(e){let r=Array.from(v.instMap.keys()),n=r.indexOf(t.instKey),i=n>=0?n-1:r.length-1;if(i>=0&&r[i]==e.instKey||document.referrer.indexOf(`${e.host}${e.path}`)>=0)return e}}writeLastView(t){try{this.setLs(y.UBT_LASTVIEW,JSON.stringify({...t.bfa,host:location.host,path:location.pathname,instKey:t.instKey}))}catch(e){dt.reportError("writeLastView error.",e,t.instKey)}}writeBfa(t,e){this.setCookie(y.BFA_COOKIE,t.bfa.genBfaVal()),this.setLs(y.BFA_LS,JSON.stringify(t.bfa)),this.wrreturn this.getCookie(y.VID_COOKIE)}writeVID(t){this.setCookie(y.VID_COOKIE,t||"")}readBfa(){let t=null,e=this.getCookie(y.BFA_COOKIE);if(t=Ft.parse(e),!t.id){let e=this.getLs(y.BFA_LS);t=Ft.parse(e,"ls")}return t}reportMagenet(t){this.clientInfo.isProd&&Tt.inMagnetDebug()&&(t(),Tt.updateMagnetMaxAge())}reportByTcp(t){return CtripBusiness.app_track_UBT_JS_log_V2("ubt_js_sdk_v2",t),{success:!0}}reportBySendBeacon(t,e){let r=new Blob([t],{type:"application/json"});return{success:navigator.sendBeacon(e,r)}}syncCwxParams(){try{if(this.clientInfo.isOnline)return;let t=this.getUrlSearchObject("_cwxobj");if(!t)return;let e=k(decodeURIComponent(t));if(null==e||!e.cid)return;e.cid&&e.cid.length>20&&(e.cid=e.cid.slice(0,20)),this.setLs("UBT_FROM_CWX",JSON.stringify({appid:e.appid,cid:e.cid,personalRecommendSwitch:e.personalRecommendSwitch,localRecommendSwitch:e.localRecommendSwitch,marketSwitch:e.marketSwitch})),window.__nfesGlobalDatas||(this.setLs("GUID",e.cid||""),this.setCookie("GUID",e.cid))}catch(t){dt.reportError("syncCwxParams error.",t)}}async request(t,e){try{const troller;e&&setTimeout((()=>r.abort()),e);let n={headers:{"Content-Type":"application/json",Accept:"application/json",...t.headers},method:t.method||"POST",body:t.body,signal:r.signal},i=await fetch(t.url,n),o=await i.json(),s=200==i.status&&i.ok;return{success:s,[s?"data":"message"]:o}}catch(e){var r;let n=(null===(r=t.url)||void 0===r?void 0:r.split("/"))||[],i=n[n.length-1];return dt.reportError(`svcFetch error.Path:${i}`,new ft(e)),{success:!1,message:`${null==e?void 0:e.stack}`}}}async imgRequest(t){return new Promise(((e,r)=>{try{let r=new Image;r.referrerPolicy="no-rr.onload=function(){e({success:!0})},r.onerror=function(t,n,i,o,s){r.onload=r.onerror=null,e({success:!1,message:`imageReport failed.event: ${t}, error: ${s}`}),dt.reportError("imgRequest error.",new ft(s))},r.src=`${t.url}?${t.body}`}catch(t){r(t)}}))}async setClientIds(){return new nc t=>{let e=setTimeout((()=>{t(!1)}),100);try{let r="";if(r=(this.getLs("UBT_FROM_CWX",!0)||{}).cid,g.cid_from=3,!r){g.cid_from=2;let t=this.getCookie("GUID"),e=this.getLs("GUID");r=t||e}r||delete g.cid_from,g.cid_type=r?/{|"|:/g.test(r||"")?2:1:0,this.clientID=r,clearTimeout(e),this.watcher.trigger("cid",r),t(!0)}catch(t){dt.reportError("setClientIds error.",t)}}))}async createCid(t,e=0){try{let r,n={head:{appid:"700062"},appId:"700062",platformCode:1,deviceId:t},i=await this.request({body:JSON.stringify(n),url:q(this.clientInfo)});return i.success&&i.data&&(r=i.data.clientId),!r&&e<3?this.createCid(t,e++):(e>0&&(g.retryCreateCidTimes=e),r)}catch(r){return this.createCid(t,e++)}}getLocals(t,e){if(this.locals&&!e)return this.locals;try{var r,n,i,o,s;let e=(this.clientInfo.isProd?"PRO":this.clientInfo.isUat?"UAT":"FAT")+"_Servers_Eid",a=this.multiGetCookie([["Session",U.MAP],["CtripUserInfo",U.MAP],["StartCity_Pkg",U.MAP],["Union",U.MAP],["login_uid"],["weduid"],["corpid"],["bid"],["DUID"],["BDUID"],["Servers_Eid"],[e]]),c=this.batchGetLs([["SOURCEID"],["USER",U.JSONPARSE],["CINFO",U.JSONPARSE]]),u=a.Session||{},l=a.CtripUserInfo||{},d=(a.StartCity_Pkg,a.Union||{}),p=a.login_uid,f=a.DUID||window.ubt_duid||l.U||"",h=p;if(!f&&!h){let t=c.USER;if(t&&t.value){let e=t.value;h=e.LoginName||e.UserName,f=e.UserID}}let g=d;g||(g=this.getLs("UNION",!0));let v=k(g.exmktID)||{},y=this.getUrlSearchObject(),m=this.getOther(),b=this.getAppInfo(c.CINFO),w=this.getIdc(),S={eid:a[e]||a.Servers_Eid,ubtc:this.readUbtc(),context:{engine:null!==(r=u.SmartLinkCode)&&void 0!==r?r:"",other:JSON.stringify(m),appInfo:b,idc:w},user:{corpid:a.corpid,duid:"we.ctrip.com"==location.hostname?a.weduid:f,userId:h,abTest:this.getABtest(t.abTestMaxLength)},business:{allianceId:null!==(n=g.AllianceID)&&void 0!==n?n:"",allianceSid:null!==(i=g.SID)&&void 0!==i?i:"",allianceOuid:null!==(o=g.OUID)&&void 0!==o?o:"",allianceCreatetime:null!==(s=g.createtime)&&void 0!==s?s:"",sourceId:c.SOURCEID,innerSid:v.innersid||y.innersid,innerOuid:v.innerouid||y.innerouid,pushCode:v.pushcode||y.pushcode}};return this.locals=S}catch(t){dt.reportError("getLocals error.",t)}}readUbtc(){let t={},e=this.getCookieAll();for(const r in e)m.UBTC.test(r)&&(t[r.substring(5)]=e[r]);return t}getBizTokens(t){if(!t||0==t.length)return[];t.length>3&&(t=t.slice(0, e=this.multiGetCookie(t.map((t=>[t])))||{};return Object.values(e).filter((t=>!["",null,void 0].includes(t)))}getAppInfo(t){let e={version:(null==t?void 0:t.internalVersion)||"",ver:null==t?void 0:t.version,net:(null==t?void 0:t.networkStatus)||"None",platform:(null==t?void 0:t.platform)||""};return JSON.stringify(e)}getIdc(){let t="";try{let e=document.documentElement;t=e.dataset&&e.dataset.idc||e.getAttribute("data-idc")||""}catch(t){dt.reportError("getIdc error.",t)}return(t+"").substring(0,30)}getOther(){let t="";if("object"==typeof window.Lizard){let e=window.Lizard;t=e.selfCollection||e.version||""}let e={fef_name:"",fef_ver:"",rg:this.getCookie("_RSG",""),lang:document.documentElement.getAttribute("lang")||""};return this.clientInfo.isOnline?e.lizard=t:(e.tz=-(new Date).getTimezoneOffset(),e.dt=outerHeight-innerHeight>160||outerWidth-innerWidth>160),e}getABtest(t){try{let e="",r="",n=document.getElementById(Kt),i=[];for(;n;){let t=n.value;/;$/.test(t)||(t+=";"),r+=t,i.push(n),n.removeAttribute("id"),n.removeAttribute("name"),n=document.getElementById(Kt)}for(let t=0;t<i.length;t++)i[t].setAttribute("id",Kt);let o=location.hash;if(o.indexOf("abtest=")>=0){let t=o.replace(/.*(abtest=)/i,"").replace(/#.*/i,"");r+=decodeURIComponent(t)}return t&&t>0?r.substring(0,t):e}catch(t){return dt.rRegister(){$t.handleAfterRegister()}getReferrer(){let t="";t=document&&document.referrer;try{!t&&opener&&(t=opener.location&&openurn t}getUrl(){return location.href}setCookie(t,e,r=b){let n=this.clientInfo.rootDomain?`;domain=${this.clientInfo.rootDomain}`:"",i="";if(r>=0){i=`;expires=${new Date((new Date).getTime()+r).toUTCString()}`}return document.cookie=`${t}=${encodeURIComponent(e)}${n};path=/${i}`,!0}getCookie(t,e,r){let n=new RegExp("(^| )"+t+"=([^;]*)(;|$)"),i=document.cookie.match(n),o=e||"";return i&&(o=r?decodeURI(i[2]):i[2]),o}checkLsPush(){let[t,e]=this.lsStatus;return e<4194304}getLsStatus(t="B"){let e=0,r=new Set;for(const t in localStorage)if(Object.prototype.hasOwnProperty.call(localStorage,t)){let n=localStorage.getItem(t);null!==n&&(r.add(t),e+=n?n.length:0)}return"KB"==t&&(e=Math.ceil(e/1024)),"MB"==t&&(e=Math.ceil(e/1024)),[r,e]}setLs(t,e){this.clientInfo.isSupportLS&&(this.beforeOpLs("s",t,e),window.localStorage.setItem(t,e))}removeLs(t){this.clientInfo.isSupportLS&&(this.beforeOpLs("r",t),window.localStorage.removeItem(t))}getLs(t,e){if(!this.clientInfo.isSupportLS)return;let r=window.localStorage.getItem(t);return e?k(r):r}iterateLsKeys(t){let e=localStorage.length;for(let r=0;r<e;r++){const e=localStorage.key(r);e&&t(e)}}batchGetLs(t){let e={};if(!this.clientInfo.isSupportLS)return e;let r=window.localStorage;return t.forEach((([t,n])=>{let i=r[t];i=L(i,n),e[t]=i})),e}checkLsSupport(){if(Storage&&localStorage){try{localStorage.setItem("store_test","1"),localStorage.getItem("store_test"),localStorage.removeItem("store_test")}catch(t){return!1}return!0}return!1}getUrlSearchObject(t){let e=document.location.search.replace("?",""),r=this.mapQuerys2Object(e)||{};return t?r[t]:r}mapQuerys2Object(t){let e={},r=t.split("&")||[];for(let t=0;t<r.length;t++){let n=r[t].split("=");n.length>1&&(e[n[0]]=n[1])}return e||{}}checkIsSupportSendBeacon(t){return"object"==typeof navigator&&"function"==typeof navigator.sendBeacon&&(t.isTripApp||t.isCtripApp||"undefined"==typeof CtripBusiness)&&!t.isFile&&-1==navigator.userAgent.indexOf("tripPal")&&-1==navigator.userAgent.indexOf("AliApp")&&!/CBP(IOS)?_Wireless/i.test(navigator.userAgent)}multiGetCookie(t){let e={},r=this.getCookieAll();return t.forEach((([t,n])=>{let i=r[t];i=L(i,n),e[t]=i})),e}getCookieAll(){let t=document.cookie;if(!t)return{};let e={};return t.split("; ").forEach((t=>{let r=t.indexOf("="),n=t.substring(0,r),i=t.substring(r+1);e[n]=i})),e}removeCookie(t){let e=this.getRootDomain();document.cookie=`${t}=;domain=${e};expires=Thu, 01 Jan 1970 00:00:01 GMT;`}getRootDomain(){let t="",e="_bfp=cookie",r=location.hostname.split(".");for(let n=r.length-1;n>=0;n--)if(t="."+r.slice(n).join("."),document.cookie=`${e};domain=${t};`,document.cookie.indexOf(e)>-1)return document.cookie=`${e.split("=")[0]}=;domain=${t};expires=Thu, 01 Jan 1970 00:00:01 GMT;`,t;return t}async loadScript(t,e,r=!0){if(!t)return;let n=!1,i=document.createElement("script");i.type="text/javascript",i.async=!0,i.setAttribute("crossorigin","anonymous"),i.onload=i.onreadystatechange=function(t){n||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(this.onload=this.onreadystatechange=null,n=!0,e&&e(t))},r&&(t=t+"?v="+A()),i.src=t;let o=document.getElementsByTagName("body")[0];null==o||o.appendChild(i)}};e.client=e.webClient=new qt,e.clientType=e.client.clientType,e.clientInfo=e.client.clientInfo,e.watcher=e.client.watcher})()})();