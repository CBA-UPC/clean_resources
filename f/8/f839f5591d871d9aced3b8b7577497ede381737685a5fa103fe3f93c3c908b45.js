/*! For license information please see 99.3ff7af57d6ed153e5b81.chunk.v7.js.LICENSE.txt */
(window.officehome_webpackJsonp=window.officehome_webpackJsonp||[]).push([[99],{"+BZq":function(e,t,n){"use strict";function i(e){"visibilityState"in document?document.addEventListener("visibilitychange",():"onpagehide"in window?window.addEventListener("pagehide",e):"onbeforeunload"in window&&window.addEventListener("beforeunload",e)}n.d(t,"a",(function(){return i}))},"+Ckz":function(e,t,n){var i=n("V2ZB"),r=n("tb+2");e.exports=function(e,t){return i(e,r(e),t)}},"+Ega":function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n("NgDi");class r extends i.a{constructor(e){if(super(),this.isDisposed=!1,this.forwardingEvents=new Map,void 0!==e){const t=t=>this.forwardEvent(e,t);this.on(r.removeListenerEvent,(t=>this.unforwardEvent(e,t))),this.on(r.newListenerEvent,t)}}et disposed(){return this.isDisposed}dispose(){this.isDisposed=!0;for(const e of this.forwardingEvents.values())for(const t of e.values())try{t()}catch(e){}this.removeAllListeners(),this.forwardingEvents.clear()}forwardEvent(e){for(var t=this,n=arguments.length,i=new Array(n>1?n-1:0),s=1;s<n;s++)i[s-1]=arguments[s];for(const n of i)if(void 0!==e&&void 0!==n&&!r.isEmitterEvent(n)){let i=this.forwardingEvents.get(n);if(void 0===i&&(i=new Map,this.forwardingEvents.set(n,i)),!i.has(e)){const r=i.set(e,(()=>e.off(n,r))),e.on(n,r)}}}unforwardEvent(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(const t of n)if(void 0!==t&&!r.isEmitterEvent(t)){const n=this.forwardingEvents.get(t);if(!0===(null==n?void 0:n.has(e))&&0===this.listenerCount(t)){const i=n.get(e);void 0!==i&&i(),n.delete(e),0===n.size&&this.forwardingEvents.delete(t)}}}}r.newListenerEvent="newListener",r.removeListenerEvent="removeListener"},"/5e1":"/6iw":function(e,t,n){"use strict";n.d(t,"a",(function(){return C})),n.d(t,"b",(function(){return w}));var i=n("n3ZG"),r=n("qDpI"),s=n("ESz4");class o extends s.a{constructor(e,t){super(null!=e?e:"Bad Request",!1,null!=t?t:"BadRequest",r.g.BadRequest)}}class a extends s.a{constructor(e,t){super(null!=e?e:"Broken pipe issue",!0,null!=t?t:"BrokenPipeIssue",r.g.Consensus)}}class c extends s.a{constructor(e,t){super(null!=e?e:"Conflict error",!0,null!=t?t:"ConflictError",r.g.Conflict)}}class l extends s.a{constructor(e,t){super(null!=e?e:"Data corruption exception",!1,null!=t?t:"DataCorruption",r.g.DataCorruption)}}class d extends s.a{constructor(e,t){super(null!=e?e:"Forbidden",!1,null!=t?t:"Forbidden",r.g.Forbidden)}}class u extends s.a{constructor(e,t){super(null!=e?e:"Internal Server Error",!1,null!=t?t:"InternalServerError",r.g.UnhandledException)}}var h=n("9UhD"),m=n("WS3M");class g extends s.a{constructor(e,t){super(null!=e?e:"Not Implemented",!1,null!=t?t:"NotImplemented",r.g.NotImplemented)}}class p extends s.a{constructor(e,t){super(null!=e?e:"Payload Too Large",!1,null!=t?t:"PayloadTooLarge",r.g.PayloadTooLarge)}}var f=n("Lywj");class v extends s.a{constructor(e,t){super(null!=e?e:"Too many requests",!0,null!=t?t:"TooManyRequests",r.g.TooManyRequests)}}class y extends s.a{constructor(e,t){super(null!=e?e:"Unauthorized",!1,null!=t?t:"Unauthorized",r.g.Unauthorized)}}var b=n("AVrd");class S extends s.a{constructor(e,t,n){super(t=null!=t?t:"Unexpected error",!0,n=null!=n?n:"UnexpectedError",r.g.UnhandledException),e instanceof Error&&b.c.logError(n,r.g.UnhandledException,{errorType:n,error:e,message:t},n)}}function C(e,t,n){var s;const b=null!==(s=t.message)&&void 0!==s?s:e;if(t instanceof r.f)switch(t.statusCode){case 400:return new o(b,n);case 401:return new y(b,n);case 403:return new d(b,n);case 404:return new m.a(b,n);case 409:return new c(b,n);case 413:return new p(b,n);case 418:return t instanceof i.j?new f.a(b,n):new h.a(b,n);case 429:return new v(b,n);case 499:return new a(b,n);case 500:return new u(b,n);case 501:return new g(b,n);case 510:return new l(b,n)}return new S(t,b,n)}function w(e){return t=>{try{const n=t?C(t.message,t):void 0;e(n)}catch(e){}}}},"/MCO":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IFluidDataStoreFactory=void 0,t.IFluidDataStoreFactory="IFluidDataStoreFactory"},"/Qyy":"/q/p":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VisibilityState=t.FlushModeExperimental=t.FlushMode=void 0,function(e){e[e.Immediate=0]="Immediate",e[e.TurnBased=1]="TurnBased"}(t.FlushMode||(t.FlushMode={})),function(e){e[e.Async=2]="Async"}(t.FlushModeExperimental||(t.FlushModeExperimental={})),t.VisibilityState={NotVisible:"NotVisible",LocallyVisible:"LocallyVisible",GloballyVisible:"GloballyVisible"}},"0711":"07F0":"0KRy":function(e,t,n){var i=n("LSEb")(n("s3UK"),"Map");e.exports=i},"1Yvd":function(e,t,n){"use strict";n.d(t,"b",(function(){return i})),n.d(t,"a",(function(){return r}));const i="EventStats";class r{constructor(){this.clearEventStats()}clearEventStats(e){this.stats={eventsList:{},totalCount:0,lastSentTime:e}}shouldSendStatsToTelemetry(){const e=this.stats.totalCount;return 0!==e&&(e>50||void 0!==this.stats.lastSentTime&&Date.now()-this.stats.lastSentTime>=1e4)}prepareEventStatsEvent(e,t,n){t in e.eventsList?e.eventsList[t].push(n):e.eventsList[t]=[n],e.totalCount+=1}}},"1bkS":function(e,t,n){"use strict";n.d(t,"g",(function(){return i})),n.d(t,"o",(function(){return o})),n.d(t,"c",(function(){return c})),n.d(t,"b",(function(){return l})),n.d(t,"a",(function(){return d})),n.d(t,"d",(function(){return u})),n.d(t,"e",(function(){return h})),n.d(t,"f",(function(){return m})),n.d(t,"h",(function(){return g})),n.d(t,"i",(function(){return p})),n.d(t,"l",(function(){return f})),n.d(t,"k",(function(){return v})),n.d(t,"j",(function(){return y})),n.d(t,"n",(function(){return b})),n.d(t,"m",(function(){return S}));var i,r=n("Jbnz"),s=n("lMKH");function o(){return"object"==typeof navigator&&null!==navigator&&"boolean"==typeof navigator.onLine?navigator.onLine?i.Online:i.Offline:i.Unknown}!function(e){e[e.Offline=0]="Offline",e[e.Online=1]="Online",e[e.Unknown=2]="Unknown"}(i||(i={}));class a extends s.a{constructor(e,t,n){super(e,n),this.canRetry=t,this.errorType=r.a.genericNetworkError}}class c extends s.a{constructor(e,t){super(e,t),this.errorType=r.a.fluidInvalidSchema,this.canRetry=!1}}class l extends s.a{constructor(e,t){super(e,Object.assign(Object.assign({},t),{statusCode:400})),this.errorType=l.errorType,this.canRetry=!1}}l.errorType=r.a.deltaStreamConnectionForbidden;class d extends s.a{constructor(e,t,n,i){super(e,i,new Set(["claims","tenantId"])),this.claims=t,this.tenantId=n,this.errorType=r.a.authorizationError,this.canRetry=!1}}class u extends s.a{constructor(e,t,n){super(e,n,new Set(["redirectUrl"])),this.redirectUrl=t,this.errorType=r.a.locationRedirection,this.canRetry=!1}}class h extends s.a{class m extends h{constructor(e,t,n){super(e,t,!1,n),this.errorType=t}}class g extends h{constructor(e,t,n){super(e,t,!0,n),this.errorType=t}}class p extends s.a{constructor(e,t,n){super(e,n),this.retryAfterSeconds=t,this.errorType=r.a.throttlingError,this.canRetry=!0}}const f=(e,t)=>new m(e,r.a.writeError,t);function v(e,t,n){return void 0!==t.retryAfterMs&&t.canRetry?new p(e,t.retryAfterMs/1e3,n):new a(e,t.canRetry,n)}const y=b=e=>null==e?void 0:e.retryAfterSeconds,S=e=>void 0!==(null==e?void 0:e.retryAfterSeconds)?1e3*e.retryAfterSeconds:void 0},"1ezk":"1hTJ":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VisibilityState=t.FlushModeExperimental=t.FlushMode=void 0,function(e){e[e.Immediate=0]="Immediate",e[e.TurnBased=1]="TurnBased"}(t.FlushMode||(t.FlushMode={})),function(e){e[e.Async=2]="Async"}(t.FlushModeExperimental||(t.FlushModeExperimental={})),t.VisibilityState={NotVisible:"NotVisible",LocallyVisible:"LocallyVisible",GloballyVisible:"GloballyVisible"}},"1y8n":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gcDeletedBlobKey=t.gcTombstoneBlobKey=t.gcBlobPrefix=t.gcTreeKey=void 0,t.gcTreeKey="gc",t.gcBlobPrefix="__gc",t.gcTombstoneBlobKey="__tombstones",t.gcDeletedBlobKey="__deletedNodes"},"2AbI":function(e,t,n){var i=n("6TGQ"),r=n("tb+2"),s=n("h0av");e.exports=function(e){return i(e,s,r)}},"2wRU":"3/00":function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n("rK/e");class r{tatic start(){const e=i.a.now();return new r(e)}trace(){const e=i.a.now(),t={totalTimeElapsed:e-this.startTick,duration:e-this.lastTick,tick:e};return this.lastTick=e,t}}},"316b":"3YFW":function(e,t,n){"use strict";function i(e){if(this._capacity=s(e),this._length=0,this._front=0,r(e)){for(var t=e.length,n=0;n<t;++n)this[n]=e[n];this._length=t}}i.prototype.toArray=function(){for(var e=this._length,t=new Array(e),n=this._front,i=this._capacity,r=0;r<e;++r)t[r]=this[n+r&i-1];return t},i.prototype.push=function(e){var t=arguments.length,n=this._length;if(t>1){var i=this._capacity;if(n+t>i){for(var r=0;r<t;++r)this._checkCapacity(n+1),this[s=this._front+n&this._capacity-1]=arguments[r],n++,this._length=n;return n}var s=this._front;for(r=0;r<t;++r)this[s+n&i-1]=arguments[r],s++;return this._length=n+t,n+t}return 0===t?n:(this._checkCapacity(n+1),this[r=this._front+n&this._capacity-1]=e,this._length=n+1,n+1)},i.prototype.pop=i.prototype.shift=i.prototype.unshift=function(e){var t=this._length,n=arguments.length;if(n>1){if(t+n>(r=this._capacity)){for(var i=n-1;i>=0;i--){var r;this._checkCapacity(t+1),this[o=(this._front-1&(r=this._capacity)-1^r)-r]=arguments[i],t++,this._length=t,this._front=o}return t}var s=this._front;for(i=n-1;i>=0;i--){var o;this[o=(s-1&r-1^r)-r]=arguments[i],s=o}return this._front=s,this._length=t+n,t+n}return 0===n?t:(this._checkCapacity(t+1),this[i=(this._front-1&(r=this._capacity)-1^r)-r]=e,this._length=t+1,this._front=i,t+1)},i.prototype.peekBack=i.prototype.peekFront=i.prototype.get=function(e){var t=e;if(t===(0|t)){var n=this._length;if(t<0&&(t+=n),!(t<0||t>=n))return this[this._front+t&this._capacity-1]}},i.prototype.isEmpty=function(){return 0===this._length},i.prototype.clear=function(){for(var e=this._length,t=this._front,n=this._capacity,i=0;i<e;++i)this[t+i&n-1]=void 0;this._length=0,this._front=0},i.prototype.valueOf=i.prototype.toString=function(){return this.toArray().toString()},i.prototype.removeFront=i.prototype.shift,i.prototype.removeBack=i.prototype.pop,i.prototype.insertFront=i.prototype.unshift,i.prototype.insertBack=i.prototype.push,i.prototype.enqueue=i.prototype.push,i.prototype.dequeue=i.prototype.shift,i.prototype.toJSON=i.prototype.toArray,Object.defineProperty(i.prototype,"length",{get:function(){return this._length},set:function(){throw new RangeError("")}}),i.prototype._checkCapacity=i.prototype._resizeTo=function(e){var t=this._capacity;this._capacity=e;var n=this._front,i=this._length;n+i>t&&this,0,this,t,n+i&t-1)};var r=Array.isArray;function s(e){if("number"!=typeof e){if(!r(e))return 16;e=e.length}return function(e){return e>>>=0,e-=1,e|=e>>1,e|=e>>2,e|=e>>4,1+((e|=e>>8)|e>>16)}(Math.min(Math.max(16,e),1073741824))}e.exports=i},"3kU/":function(e,t,n){var i=n("2wRU"),r=n("TsNJ"),s=n("DhoL"),o=s&&s.isTypedArray,a=o?r(o):i;e.exports=a},"3mBU":function(e,t,n){"use strict";n.d(t,"c",(function(){return s})),n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return o}));var i,r=n("f79D");unction o(e){return e.type===r.a.NoOp||e.type===i.Accept}!function(e){e.Accept="accept"}(i||(i={}))},"40n3":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IFluidDataStoreRegistry=void 0,t.IFluidDataStoreRegistry="IFluidDataStoreRegistry"},"4KXX":function(e,t,n){"use strict";n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return s}));var i=n("czZE");const r=e=>null!=e.totalCount&&e.totalCount>=i.a,s=e=>!0},"5+lF":function(e,t,n){var i=n("naAV");e.exports=function(e,t){var n=t?i(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.byteLength)}},6758:"6TGQ":"6dK/":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,n,i){u("aLength",e),u("bLength",t),h("isCommon",n),h("foundSubsequence",i);const o=r(0,e,0,t,n);if(0!==o&&i(o,0,0),e!==o||t!==o){const r=o,a=o,c=s(r,e-1,a,t-1,n),l=e-c,u=t-c,h=o+c;e!==h&&t!==h&&d(0,r,l,a,u,!1,[{foundSubsequence:i,isCommon:n}],[0],[0],{aCommonFollowing:0,aCommonPreceding:0,aEndPreceding:0,aStartFollowing:0,bCommonFollowing:0,bCommonPreceding:0,bEndPreceding:0,bStartFollowing:0,nChangeFollowing:0,nChangePreceding:0,nCommonFollowing:0,nCommonPreceding:0}),0!==c&&i(c,l,u)}};const i="diff-sequences",r=(e,t,n,i,r)=>{let s=0;for(;e<t&&n<i&&r(e,n);)e+=1,n+=1,s+=1;return s},s=(e,t,n,i,r)=>{let s=0;for(;e<=t&&n<=i&&r(t,i);)t-=1,i-=1,s+=1;return s},o=(e,t,n,i,s,o,a)=>{let c=0,l=-e,d=o[c],u=d;o[c]+=r(d+1,t,i+d-l+1,n,s);const h=e<a?e:a;for(c+=1,l+=2;c<=h;c+=1,l+=2){if(c!==e&&u<o[c])d=o[c];else if(d=u+1,t<=d)return c-1;u=o[c],o[c]=d+r(d+1,t,i+d-l+1,n,s)}return a},a=(e,t,n,i,r,o,a)=>{let c=0,l=e,d=o[c],u=d;o[c]-=s(t,d-1,n,i+d-l-1,r);const h=e<a?e:a;for(c+=1,l-=2;c<=h;c+=1,l-=2){if(c!==e&&o[c]<u)d=o[c];else if(d=u-1,d<t)return c-1;u=o[c],o[c]=d-s(t,d-1,n,i+d-l-1,r)}return a},c=(e,t,n,i,o,a,c,l,d,u,h)=>{const m=i-t,g=o-i-(n-t),p=-g-(e-1),f=e-1-g;let v=0;const y=e<l?e:l;for(let l=0,b=-e;l<=y;l+=1,b+=2){const y=0===l||l!==e&&v<c[l],S=y?c[l]:v,C=y?S:S+1,w=m+C-b,O=r(C+1,n,w+1,o,a),I=C+O;if(v=c[l],c[l]=I,p<=b&&b<=f){const r=(e-1-(b+g))/2;if(r<=u&&d[r]-1<=I){const r=m+S-(y?b+1:b-1),c=s(t,S,i,r,a),l=S-c+1,d=r-c+1;h.nChangePreceding=e-1,e-1==l+d-t-i?(h.aEndPreceding=t,h.bEndPreceding=i):(h.aEndPreceding=l,h.bEndPreceding=d),h.nCommonPreceding=c,0!==c&&(h.aCommonPreceding=l,h.bCommonPreceding=d),h.nCommonFollowing=O,0!==O&&(h.aCommonFollowing=C+1,h.bCommonFollowing=w+1);const u=I+1,g=w+O+1;return h.nChangeFollowing=e-1,e-1==n+o-u-g?(h.aStartFollowing=n,h.bStartFollowing=o):(h.aStartFollowing=u,h.bStartFollowing=g),!0}}}return!1},l=(e,t,n,i,o,a,c,l,d,u,h)=>{const m=o-n,g=o-i-(n-t),p=g-e,f=g+e;let v=0;const y=e<u?e:u;for(let u=0,b=e;u<=y;u+=1,b-=2){const y=0===u||u!==e&&d[u]<v,S=y?d[u]:v,C=y?S:S-1,w=m+C-b,O=s(t,C-1,i,w-1,a),I=C-O;if(v=d[u],d[u]=I,p<=b&&b<=f){const s=(e+(b-g))/2;if(s<=l&&I-1<=c[s]){const s=w-O;if(h.nChangePreceding=e,e===I+s-t-i?(h.aEndPreceding=t,h.bEndPreceding=i):(h.aEndPreceding=I,h.bEndPreceding=s),h.nCommonPreceding=O,0!==O&&(h.aCommonPreceding=I,h.bCommonPreceding=s),h.nChangeFollowing=e-1,1===e)h.nCommonFollowing=0,h.aStartFollowing=n,h.bStartFollowing=o;else{const t=m+S-(y?b-1:b+1),i=r(S,n,t,o,a);h.nCommonFollowing=i,0!==i&&(h.aCommonFollowing=S,h.bCommonFollowing=t);const s=S+i,c=t+i;e-1==n+o-s-c?(h.aStartFollowing=n,h.bStartFollowing=o):(h.aStartFollowing=s,h.bStartFollowing=c)}return!0}}}return!1},d=(e,t,n,r,s,u,h,m,g,p)=>{if(s-r<n-t){if((u=!u)&&1===h.length){const{foundSubsequence:e,isCommon:t}=h[0];h[1]={foundSubsequence:isCommon:(e,n)=>t(n,e)}}const e=t,i=n;t=r,n=s,r=e,s=i}const{foundSubsequence:f,isCommon:v}=h[u?1:0];((e,t,n,r,s,d,u,h,m)=>{const g=r-t,p=s-n,f=n-t,v=s-r,y=v-f;let b=f,S=f;if(u[0]=t-1,h[0]=n,y%2==0){const i=(e||y)/2,c=(f+v)/2;for(let e=1;e<=c;e+=1)if(b=o(e,n,s,g,d,u,b),e<i)S=a(e,t,r,p,d,h,S);else if(l(e,t,n,r,s,d,u,b,h,S,m))return}else{const i=((e||y)+1)/2,l=(f+v+1)/2;let C=1;for(b=o(C,n,s,g,d,u,b),C+=1;C<=l;C+=1)if(S=a(C-1,t,r,p,d,h,S),C<i)b=o(C,n,s,g,d,u,b);else if(c(C,t,n,r,s,d,u,b,h,S,m))return}throw new Error(`${i}: no overlap aStart=${t} aEnd=${n} bStart=${r} bEnd=${s}`)})(e,t,n,r,s,v,m,g,p);const{nChangePreceding:y,aEndPreceding:b,bEndPreceding:S,nCommonPreceding:C,aCommonPreceding:w,bCommonPreceding:O,nCommonFollowing:I,aCommonFollowing:N,bCommonFollowing:T,nChangeFollowing:E,aStartFollowing:k,bStartFollowing:j}=p;t<b&&r<S&&d(y,t,b,r,S,u,h,m,g,p),0!==C&&f(C,w,O),0!==I&&f(I,N,T),k<n&&j<s&&d(E,k,n,j,s,u,h,m,g,p)},u=(e,t)=>{if("number"!=typeof t)throw new TypeError(`${i}: ${e} typeof ${typeof t} is not a number`);if(!Number.isSafeInteger(t))throw new RangeError(`${i}: ${e} value ${t} is not a safe integer`);if(t<0)throw new RangeError(`${i}: ${e} value ${t} is a negative integer`)},h=(e,t)=>{const n=typeof t;if("function"!==n)throw new TypeError(`${i}: ${e} typeof ${n} is not a function`)}},"6iN7":"6tX4":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IFluidDataStoreRegistry=void 0,t.IFluidDataStoreRegistry="IFluidDataStoreRegistry"},"7/yF":function(e,t,n){"use strict";function i(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Unreachable Case";throw new Error(t)}n.d(t,"a",(function(){return i}))},"7EWA":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.totalBlobSizePropertyName=t.CreateSummarizerNodeSource=t.channelsTreeName=t.blobCountPropertyName=t.gcTreeKey=t.gcTombstoneBlobKey=t.gcDeletedBlobKey=t.gcBlobPrefix=t.IFluidDataStoreRegistry=t.IFluidDataStoreFactory=t.VisibilityState=t.FlushModeExperimental=t.FlushMode=void 0;var i=n("/q/p");Object.defineProperty(t,"FlushMode",{enumerable:!0,get:function(){return i.FlushMode}}),Object.defineProperty(t,"FlushModeExperimental",{enumerable:!0,get:function(){return i.FlushModeExperimental}}),Object.defineProperty(t,"VisibilityState",{enumerable:!0,get:function(){return i.VisibilityState}});var r=n("xAP2");Object.defineProperty(t,"IFluidDataStoreFactory",{enumerable:!0,get:function(){return r.IFluidDataStoreFactory}});var s=n("40n3");Object.defineProperty(t,"IFluidDataStoreRegistry",{enumerable:!0,get:function(){return s.IFluidDataStoreRegistry}});var o=n("bOrJ");Object.defineProperty(t,"gcBlobPrefix",{enumerable:!0,get:function(){return o.gcBlobPrefix}}),Object.defineProperty(t,"gcDeletedBlobKey",{enumerable:!0,get:function(){return o.gcDeletedBlobKey}}),Object.defineProperty(t,"gcTombstoneBlobKey",{enumerable:!0,get:function(){return o.gcTombstoneBlobKey}}),Object.defineProperty(t,"gcTreeKey",{enumerable:!0,get:function(){return o.gcTreeKey}});var a=n("a5cT");Object.defineProperty(t,"blobCountPropertyName",{enumerable:!0,get:function(){return a.blobCountPropertyName}}),Object.defineProperty(t,"channelsTreeName",{enumerable:!0,get:function(){return a.channelsTreeName}}),Object.defineProperty(t,"CreateSummarizerNodeSource",{enumerable:!0,get:function(){return a.CreateSummarizerNodeSource}}),Object.defineProperty(t,"totalBlobSizePropertyName",{enumerable:!0,get:function(){return a.totalBlobSizePropertyName}})},"7Ndq":function(e,t){function n(e,t){this._elements=new Array(e||50),this._first=0,this._last=0,this._size=0,this._evictedCb=t}e.exports=n,n.prototype.capacity=function(){return this._elements.length},n.prototype.isEmpty=n.prototype.isFull=n.prototype.peek=function(){if(this.isEmpty())throw new Error("RingBuffer is empty");return this._elements[this._first]},n.prototype.peekN=function(e){if(e>this._size)throw new Error("Not enough elements in RingBuffer");var t=Math.min(this._first+e,this.capacity()),n=this._elements.slice(this._first,t);if(t<this.capacity())return n;var i=this._elements.slice(0,e-n.length);return n.concat(i)},n.prototype.deq=function(){var e=this.peek();return this._size--,this._first=(this._first+1)%this.capacity(),e},n.prototype.deqN=function(e){var t=this.peekN(e);return this._size-=e,this._first=(this._first+e)%this.capacity(),t},n.prototype.enq=function(e){this._end=(this._first+this.size())%this.capacity();var t=this.isFull();return t&&this._evictedCb&&this._evictedCb(this._elements[this._end]),this._elements[this._end]=e,t?this._first=(this._first+1)%this.capacity():this._size++,this.size()},n.prototype.size=function(){return this._size}},"7Oo1":function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n("Jbnz"),r=n("lMKH");class s extends r.a{constructor(e){super(e,{usageError:!0}),this.errorType=i.a.usageError,this.canRetry=!1}}},"7o+A":"7qnD":"8Leb":"8TGV":"8d3v":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.totalBlobSizePropertyName=t.blobCountPropertyName=t.channelsTreeName=t.CreateSummarizerNodeSource=void 0,function(e){e[e.FromSummary=0]="FromSummary",e[e.FromAttach=1]="FromAttach",e[e.Local=2]="Local"}(t.CreateSummarizerNodeSource||(t.CreateSummarizerNodeSource={})),t.channelsTreeName=".channels",t.blobCountPropertyName="BlobCount",t.totalBlobSizePropertyName="TotalBlobSize"},"9JcD":function(e,t,n){"use strict";function i(e,t){return function(){if(e.disposed)throw new Error("Already disposed");return t(...arguments)}}n.d(t,"a",(function(){return i}))},"9UhD":function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n("qDpI"),r=n("ESz4");class s extends r.a{constructor(e,t){super(null!=e?e:"Invalid operation",!0,null!=t?t:"InvalidOperation",i.g.NotAllowed)}}},"9aUh":"9hJ/":ABR0:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VisibilityState=t.FlushModeExperimental=t.FlushMode=void 0,function(e){e[e.Immediate=0]="Immediate",e[e.TurnBased=1]="TurnBased"}(t.FlushMode||(t.FlushMode={})),function(e){e[e.Async=2]="Async"}(t.FlushModeExperimental||(t.FlushModeExperimental={})),t.VisibilityState={NotVisible:"NotVisible",LocallyVisible:"LocallyVisible",GloballyVisible:"GloballyVisible"}},AJMQ:function(e,t){e.exports=function(e){return this.__data__.has(e)}},"AJa+":function(e,t,n){"use strict";n.d(t,"d",(function(){return i})),n.d(t,"e",(function(){return a})),n.d(t,"a",(function(){return c})),n.d(t,"b",(function(){return l})),n.d(t,"c",(function(){return d}));var i,r=n("rK/e"),s=n("ambg"),o=n("etL/");!function(e){e.CodeArtifact="CodeArtifact",e.UserData="UserData"}(i||(i={}));class a{constructor(e,t){this.namespace=e,this.properties=t}static formatTick(e){return Math.floor(e)}static numberFromString(e){if(null==e)return;const t=Number(e);return Number.isNaN(t)?e:t}static sanitizePkgName(e){return e.replace("@","").replace("/","-")}static prepareErrorObject(e,t,n){const{message:i,errorType:r,stack:s}=Object(o.c)(t,!0);if(e.stack=s,e.error=i,e.errorType=r,Object(o.f)(t)){const n=t.getTelemetryProperties();for(const t of Object.keys(n))void 0===e[t]&&(e[t]=n[t])}void 0===e.stack&&n&&(e.stack=Object(o.d)())}sendTelemetryEvent(e,t){var n;this.sendTelemetryEventCore(Object.assign(Object.assign({},e),{category:null!==(n=e.category)&&void 0!==n?n:"generic"}),t)}sendTelemetryEventCore(e,t){const n=function(e){var{category:t,eventName:n}=e,i=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n}(e,["category","eventName"]);const r={category:t,eventName:n};for(const e of Object.keys(i))r[e]=h(i[e]);return r}(e);void 0!==t&&a.prepareErrorObject(n,t,!1),"number"==typeof n.duration&&(n.duration=a.formatTick(n.duration)),this.send(n)}sendErrorEvent(e,t){this.sendTelemetryEventCore(Object.assign(Object.assign({error:e.eventName},e),{category:"error"}),t)}sendPerformanceEvent(e,t){var n;const i=Object.assign(Object.assign({},e),{category:null!==(n=e.category)&&void 0!==n?n:"performance"});this.sendTelemetryEventCore(i,t)}prepareEvent(e){const t="error"===e.category||void 0!==e.error,n=Object.assign({},e);if(void 0!==this.namespace&&(n.eventName=`${this.namespace}${a.eventNamespaceSeparator}${n.eventName}`),this.properties){const i=[];i.push(this.properties.all),t&&i.push(this.properties.error);for(const t of i)if(void 0!==t)for(const i of Object.keys(t)){if(void 0!==e[i])continue;const r=t[i],s="function"==typeof r?r():r;void 0!==s&&(n[i]=s)}}return n}}a.eventNamespaceSeparator=":";class c extends a{constructor(e,t,n){super(t,n),this.baseLogger=e,Object(s.b)(e)&&Object(s.d)(this,new s.a(this,e.config))}static create(e,t,n){if(e instanceof c){const i={};for(const t of[e.properties,n])void 0!==t&&(void 0!==t.all&&(i.all=Object.assign(Object.assign({},i.all),t.all)),void 0!==t.error&&(i.error=Object.assign(Object.assign({},i.error),t.error)));return new c(e.baseLogger,void 0===e.namespace?t:void 0===t?e.namespace:`${e.namespace}${a.eventNamespaceSeparator}${t}`,i)}return new c(e||new u,t,n)}send(e){this.baseLogger.send(this.prepareEvent(e))}}class l extends a{constructor(e,t){super(e,t),this.loggers=[]}end(e){const t=this.prepareEvent(e);this.loggers.forEach((e=>{e.send(t)}))}}class d{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{end:!0,cancel:"generic"};var i;this.logger=e,this.markers=n,this.startTime=r.a.now(),this.event=Object.assign({},t),this.markers.start&&this.reportEvent("start"),"object"==typeof window&&null!=window&&(null===(i=window.performance)||void 0===i?void 0:i.mark)&&(this.startMark=`${t.eventName}-start`,window.performance.mark(this.startMark))}static start(e,t,n){return new d(e,t,n)}static timedExec(e,t,n,i){const r=d.start(e,t,i);try{const e=n(r);return r.autoEnd(),e}catch(e){throw r.cancel(void 0,e),e}}static async timedExecAsync(e,t,n,i){const r=d.start(e,t,i);try{const e=await n(r);return r.autoEnd(),e}catch(e){throw r.cancel(void 0,e),e}}get duration(){return r.a.now()-this.startTime}reportProgress(e){this.reportEvent(arguments.length>1&&void 0!==arguments[1]?arguments[1]:"update",e)}autoEnd(){this.event&&this.markers.end&&this.reportEvent("end"),this.performanceEndMark(),this.event=void 0}end(e){this.reportEvent("end",e),this.performanceEndMark(),this.event=void 0}performanceEndMark(){if(this.startMark&&this.event){const e=`${this.event.eventName}-end`;window.performance.mark(e),window.performance.measure(`${this.event.eventName}`,this.startMark,e),this.startMark=void 0}}cancel(e,t){void 0!==this.markers.cancel&&this.reportEvent("cancel",Object.assign({category:this.markers.cancel},e),t),this.event=void 0}reportEvent(e,t,n){if(!this.event)return;const i=Object.assign(Object.assign({},this.event),t);i.eventName=`${i.eventName}_${e}`,"start"!==e&&(i.duration=this.duration),this.logger.sendPerformanceEvent(i,n)}}class u{send(e){}}function h(e){return Object(o.g)(e)?{value:m(e.value),tag:e.tag}:m(e)}function m(e){switch(typeof e){case"string":case"number":case"boolean":case"undefined":return e;case"object":return JSON.stringify(e);default:return console.error(`convertToBasePropertyTypeUntagged: INVALID PROPERTY (typed as ${typeof e})`),`INVALID PROPERTY (typed as ${typeof e})`}}},AVrd:function(e,t,n){"use strict";n.d(t,"c",(function(){return r})),n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return o})),n.d(t,"d",(function(){return a}));var i=n("qDpI");const r=i.e.getInstance().getMfsLogger("metafolder"),s=Object(i.j)(r),o=Object(i.k)(r);function a(e,t){e.appInfo.mfsFeature="folders",e.appInfo.mfsFeatureVersion="2.0.1",i.e.getInstance().setContext(e,t)}},AqD5:function(e,t,n){e.exports=function(e){unction i(e){let n;function o(...e){if(!o.enabled)return;const t=o,r=Number(new Date);t.diff=r-(n||r),t.prev=n,t.curr=r,n=r,e[0]=i.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let s=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,((n,r)=>{if("%%"===n)return n;s++;const o=i.formatters[r];return"function"==typeof o&&(n=o.call(t,e[s]),e.splice(s,1),s--),n})),i.formatArgs.call(t,e),(t.log||i.log).apply(t,e)}return o.namespace=e,o.enabled=i.enabled(e),o.useColors=i.useColors(),o.color=t(e),o.destroy=r,o.extend=s,"function"==typeof i.init&&i.init(o),i.instances.push(o),o}urn i.debug=i,i.default=i,i.coerce=i.disable=i.enable=i.enabled=i.humanize=n("kKrb"),Object.keys(e).forEach((),i.instances=[],i.names=[],i.skips=[],i.formatters={},i.selectColor=t,i.enable(i.load()),i}},ArpJ:function(e,t,n){var i=n("V2ZB"),r=n("Vujp");e.exports=function(e,t){return e&&i(t,r(t),e)}},"B4/L":B4Jh:Bpme:function(e,t,n){var i=n("CIUO"),r=n("TsNJ"),s=n("DhoL"),o=s&&s.isMap,a=o?r(o):i;e.exports=a},Bq5F:CIBY:CIUO:function(e,t,n){var i=n("s3t7"),r=n("T9Ud");e.exports=function(e){return r(e)&&"[object Map]"==i(e)}},CPLO:Chmn:CzB4:DDiJ:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.totalBlobSizePropertyName=t.CreateSummarizerNodeSource=t.channelsTreeName=t.blobCountPropertyName=t.gcTreeKey=t.gcTombstoneBlobKey=t.gcDeletedBlobKey=t.gcBlobPrefix=t.IFluidDataStoreRegistry=t.IFluidDataStoreFactory=t.VisibilityState=t.FlushModeExperimental=t.FlushMode=void 0;var i=n("EinJ");Object.defineProperty(t,"FlushMode",{enumerable:!0,get:function(){return i.FlushMode}}),Object.defineProperty(t,"FlushModeExperimental",{enumerable:!0,get:function(){return i.FlushModeExperimental}}),Object.defineProperty(t,"VisibilityState",{enumerable:!0,get:function(){return i.VisibilityState}});var r=n("/MCO");Object.defineProperty(t,"IFluidDataStoreFactory",{enumerable:!0,get:function(){return r.IFluidDataStoreFactory}});var s=n("t5Lo");Object.defineProperty(t,"IFluidDataStoreRegistry",{enumerable:!0,get:function(){return s.IFluidDataStoreRegistry}});var o=n("1y8n");Object.defineProperty(t,"gcBlobPrefix",{enumerable:!0,get:function(){return o.gcBlobPrefix}}),Object.defineProperty(t,"gcDeletedBlobKey",{enumerable:!0,get:function(){return o.gcDeletedBlobKey}}),Object.defineProperty(t,"gcTombstoneBlobKey",{enumerable:!0,get:function(){return o.gcTombstoneBlobKey}}),Object.defineProperty(t,"gcTreeKey",{enumerable:!0,get:function(){return o.gcTreeKey}});var a=n("wVje");Object.defineProperty(t,"blobCountPropertyName",{enumerable:!0,get:function(){return a.blobCountPropertyName}}),Object.defineProperty(t,"channelsTreeName",{enumerable:!0,get:function(){return a.channelsTreeName}}),Object.defineProperty(t,"CreateSummarizerNodeSource",{enumerable:!0,get:function(){return a.CreateSummarizerNodeSource}}),Object.defineProperty(t,"totalBlobSizePropertyName",{enumerable:!0,get:function(){return a.totalBlobSizePropertyName}})},DGBo:function(e,t){},DLbW:function(e,t,n){"use strict";n.d(t,"d",(function(){return s})),n.d(t,"a",(function(){return o})),n.d(t,"b",(function(){return a})),n.d(t,"c",(function(){return c}));var i=n("he5V"),r=n("HJ7Z");function s(e){var t,n,i,s;return void 0!==(null==e?void 0:e.tree)&&(null===(n=null===(t=e.tree)||void 0===t?void 0:t[".app"])||void 0===n?void 0:n.type)===r.a.Tree&&(null===(s=null===(i=e.tree)||void 0===i?void 0:i[".protocol"])||void 0===s?void 0:s.type)===r.a.Tree&&2===Object.keys(e.tree).length}function o(e,t){return Object(i.a)(!s(e),1448),Object(i.a)(!s(t),1449),{type:r.a.Tree,tree:{".protocol":t,".app":e}}}function a(e){return JSON.parse(e.tree.attributes.content)},DZMJ:Dh2Y:DhoL:E7Xw:"EAG+":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VisibilityState=t.FlushModeExperimental=t.FlushMode=void 0,function(e){e[e.Immediate=0]="Immediate",e[e.TurnBased=1]="TurnBased"}(t.FlushMode||(t.FlushMode={})),function(e){e[e.Async=2]="Async"}(t.FlushModeExperimental||(t.FlushModeExperimental={})),t.VisibilityState={NotVisible:"NotVisible",LocallyVisible:"LocallyVisible",GloballyVisible:"GloballyVisible"}},EN0E:ESz4:function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n("qDpI");class r extends i.f{},EX4G:function(e,t,n){"use strict";async function i(e,t){const n=`/${e}`,i=await t.request({url:n});if(200!==i.status||"fluid/object"!==i.mimeType)throw new Error(`Unable to retrieve Fluid object with ID: "${e}" from URL: "${n}"`);if(void 0===i.value)throw new Error(`Empty response for ID: "${e}" from URL: "${n}"`);return i.value}n.d(t,"a",(function(){return i}))},EinJ:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VisibilityState=t.FlushModeExperimental=t.FlushMode=void 0,function(e){e[e.Immediate=0]="Immediate",e[e.TurnBased=1]="TurnBased"}(t.FlushMode||(t.FlushMode={})),t.FlushModeExperimental||(t.FlushModeExperimental={})),t.VisibilityState={NotVisible:"NotVisible",LocallyVisible:"LocallyVisible",GloballyVisible:"GloballyVisible"}},F3Ab:FEiO:FQMq:FfeU:Fldm:G1vT:G9gt:GI0s:Gstq:function(e,t,n){(function(i){t.log=t.formatArgs=t.save=t.load=t.useColors=t.storage=),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],e.exports=n("AqD5")(t);const{formatters:r}=e.exports;r.j=).call(this,n("5IsQ"))},HE1N:HIoB:HJ7Z:HLVI:HVn3:I4it:J9xP:Jbnz:Jrlr:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gcDeletedBlobKey=t.gcTombstoneBlobKey=t.gcBlobPrefix=t.gcTreeKey=void 0,t.gcTreeKey="gc",t.gcBlobPrefix="__gc",t.gcTombstoneBlobKey="__tombstones",t.gcDeletedBlobKey="__deletedNodes"},K2jg:K87Y:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.totalBlobSizePropertyName=t.blobCountPropertyName=t.channelsTreeName=t.CreateSummarizerNodeSource=void 0,function(e){e[e.FromSummary=0]="FromSummary",e[e.FromAttach=1]="FromAttach",e[e.Local=2]="Local"}(t.CreateSummarizerNodeSource||(t.CreateSummarizerNodeSource={})),t.channelsTreeName=".channels",t.blobCountPropertyName="BlobCount",t.totalBlobSizePropertyName="TotalBlobSize"},KGtu:function(e,t,n){"use strict";n.d(t,"a",(function(){return O})),n.d(t,"c",(function(){return N})),n.d(t,"b",(function(){return T})),n.d(t,"d",(function(){return E})),n.d(t,"e",(function(){return k}));var i=n("NsUA"),r=n("he5V"),s=n("rK/e");new(n("O9x+").a)((()=>a(d())));const o={getRawConfig:()=>{}},a=e=>null!=e?new u(void 0,{getRawConfig:t=>{var n,i;try{return null===(i=l(null!==(n=e.getItem(t))&&void 0!==n?n:void 0))||void 0===i?void 0:i.raw}catch(e){}}}):o;function c(e){switch(e){case"boolean":case"number":case"string":return!0;default:return!1}}function l(e){let t,n=e;if("string"==typeof e)try{n=JSON.parse(e),t={raw:e,string:e}}catch(e){}if(void 0===n)return t;const i=typeof n;if(c(i))return Object.assign(Object.assign({},t),{raw:e,[i]:n});if(Array.isArray(n)){const i=typeof n[0];if(!c(i))return t;for(const e of n)if(typeof e!==i)return t;return Object.assign(Object.assign({},t),{raw:e,[`${i}[]`]:n})}return t}const d=()=>{var e;try{return null!==(e=globalThis.sessionStorage)&&void 0!==e?e:void 0}catch(e){return}};class u{constructor(e){this.logger=e,this.configCache=new Map,this.orderedBaseProviders=[];const t=new Set;for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];const s=[...i];for(;s.length>0;){const e=s.shift();void 0!==e&&h(e)&&!t.has(e)&&(t.add(e),e instanceof u?s.push(...e.orderedBaseProviders):this.orderedBaseProviders.push(e))}}getBoolean(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.boolean}getNumber(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.number}getString(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.string}getBooleanArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["boolean[]"]}getNumberArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["number[]"]}getStringArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["string[]"]}getRawConfig(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.raw}getCacheEntry(e){var t;if(!this.configCache.has(e)){for(const n of this.orderedBaseProviders){const i=l(null==n?void 0:n.getRawConfig(e));if(void 0!==i)return this.configCache.set(e,i),null===(t=this.logger)||void 0===t||t.send({category:"generic",eventName:"ConfigRead",configName:{tag:m.CodeArtifact,value:e},configValue:{tag:m.CodeArtifact,value:JSON.stringify(i)}}),i}this.configCache.set(e,{raw:void 0})}return this.configCache.get(e)}}function h(e){return"function"==typeof(null==e?void 0:e.getRawConfig)}var m,g=n("lMKH");!function(e){e.CodeArtifact="CodeArtifact",e.UserData="UserData"}(m||(m={}));class p{constructor(e,t){this.namespace=e,this.properties=t}static formatTick(e){return Math.floor(e)}static numberFromString(e){if(null==e)return;const t=Number(e);return Number.isNaN(t)?e:t}static sanitizePkgName(e){return e.replace("@","").replace("/","-")}static prepareErrorObject(e,t,n){const{message:i,errorType:r,stack:s}=Object(g.b)(t,!0);if(e.stack=s,e.error=i,e.errorType=r,Object(g.d)(t)){const n=t.getTelemetryProperties();for(const t of Object.keys(n))void 0===e[t]&&(e[t]=n[t])}void 0===e.stack&&n&&(e.stack=Object(g.c)())}sendTelemetryEvent(e,t){var n;this.sendTelemetryEventCore(Object.assign(Object.assign({},e),{category:null!==(n=e.category)&&void 0!==n?n:"generic"}),t)}sendTelemetryEventCore(e,t){const n=function(e){var{category:t,eventName:n}=e,i=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n}(e,["category","eventName"]);const r={category:t,eventName:n};for(const e of Object.keys(i))r[e]=v(i[e]);return r}(e);void 0!==t&&p.prepareErrorObject(n,t,!1),"number"==typeof n.duration&&(n.duration=p.formatTick(n.duration)),this.send(n)}sendErrorEvent(e,t){this.sendTelemetryEventCore(Object.assign(Object.assign({error:e.eventName},e),{category:"error"}),t)}sendPerformanceEvent(e,t){var n;const i=Object.assign(Object.assign({},e),{category:null!==(n=e.category)&&void 0!==n?n:"performance"});this.sendTelemetryEventCore(i,t)}prepareEvent(e){const t="error"===e.category||void 0!==e.error,n=Object.assign({},e);if(void 0!==this.namespace&&(n.eventName=`${this.namespace}${p.eventNamespaceSeparator}${n.eventName}`),this.properties){const i=[];i.push(this.properties.all),t&&i.push(this.properties.error);for(const t of i)if(void 0!==t)for(const i of Object.keys(t)){if(void 0!==e[i])continue;const r=t[i],s="function"==typeof r?r():r;void 0!==s&&(n[i]=s)}}return n}}p.eventNamespaceSeparator=":";class f{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{end:!0,cancel:"generic"};var i;this.logger=e,this.markers=n,this.startTime=s.a.now(),this.event=Object.assign({},t),this.markers.start&&this.reportEvent("start"),"object"==typeof window&&null!=window&&(null===(i=window.performance)||void 0===i?void 0:i.mark)&&(this.startMark=`${t.eventName}-start`,window.performance.mark(this.startMark))}tatic timedExec(e,t,n,i){const r=f.start(e,t,i);try{const e=n(r);return r.autoEnd(),e}catch(e){throw r.cancel(void 0,e),e}}static async timedExecAsync(e,t,n,i){const r=f.start(e,t,i);try{const e=await n(r);return r.autoEnd(),e}catch(e){throw r.cancel(void 0,e),e}}eportProgress(e){this.reportEvent(arguments.length>1&&void 0!==arguments[1]?arguments[1]:"update",e)}autoEnd(){this.event&&this.markers.end&&this.reportEvent("end"),this.performanceEndMark(),this.event=void 0}end(e){this.reportEvent("end",e),this.performanceEndMark(),this.event=void 0}performanceEndMark(){if(this.startMark&&this.event){const e=`${this.event.eventName}-end`;window.performance.mark(e),window.performance.measure(`${this.event.eventName}`,this.startMark,e),this.startMark=void 0}}cancel(e,t){void 0!==this.markers.cancel&&this.reportEvent("cancel",Object.assign({category:this.markers.cancel},e),t),this.event=void 0}reportEvent(e,t,n){if(!this.event)return;const i=Object.assign(Object.assign({},this.event),t);i.eventName=`${i.eventName}_${e}`,"start"!==e&&(i.duration=this.duration),this.logger.sendPerformanceEvent(i,n)}}function v(e){return Object(g.e)(e)?{value:y(e.value),tag:e.tag}:y(e)}function y(e){switch(typeof e){case"string":case"number":case"boolean":case"undefined":return e;case"object":return JSON.stringify(e);default:return console.error(`convertToBasePropertyTypeUntagged: INVALID PROPERTY (typed as ${typeof e})`),`INVALID PROPERTY (typed as ${typeof e})`}}var b=n("1bkS"),S=n("zCUP"),C=n("fxwU");class w{constructor(e,t,n,r,s,o){this.to=t,this.payloadSize=n,this.logger=r,this.requestCallback=s,this.responseCallback=o,this.results=new Map,this.workingState="working",this.requestsInFlight=0,this.endEvent=new i.a,this.requests=0,this.latestRequested=e,this.nextToDeliver=e,this.knewTo=void 0!==t}get working(){return"working"===this.workingState}ancelsync run(e){Object(r.a)(e>0,258),Object(r.a)(this.working,259);let t=e;for(;t>0;)t--,this.addRequest();return this.dispatch(),this.endEvent.promise}done(){Object(r.a)(void 0!==this.to,260),Object(r.a)(this.nextToDeliver>=this.to,261),this.working&&(this.workingState="done",this.endEvent.resolve())}fail(e){this.working&&(this.workingState="done",this.endEvent.reject(e))}dispatch(){for(;this.working;){const e=this.results.get(this.nextToDeliver);if(void 0===e)break;this.results.delete(this.nextToDeliver),Object(r.a)(e.length<=this.payloadSize,473),this.nextToDeliver+=e.length,this.responseCallback(e)}this.working&&(0===this.requestsInFlight?(Object(r.a)(0===this.results.size,263),this.done()):void 0!==this.to&&this.nextToDeliver>=this.to&&(Object(r.a)(!this.knewTo,264),this.done()))}getNextChunk(){if(!this.working)return;const e=this.latestRequested;return void 0!==this.to&&this.to<=e?void 0:(this.latestRequested+=this.payloadSize,void 0!==this.to&&(this.latestRequested=Math.min(this.to,this.latestRequested)),Object(r.a)(e<this.latestRequested,265),{from:e,to:this.latestRequested})}addRequest(){const e=this.getNextChunk();void 0!==e&&this.addRequestCore(e.from,e.to).catch(this.fail.bind(this))}async addRequestCore(e,t){Object(r.a)(this.working,266);let n=e,i=t;for(this.requestsInFlight++;this.working;){const e=i-n;Object(r.a)(e>0,267),void 0!==this.to&&(Object(r.a)(n<this.to,268),Object(r.a)(i<=this.to,269)),this.requests++;const t=this.requestCallback(this.requests,n,i,void 0!==this.to,{});this.dispatch();const{payload:s,cancel:o,partial:a}=await t;if(o&&this.cancel(),void 0!==this.to&&n>=this.to){Object(r.a)(!this.knewTo,270),0!==s.length&&this.logger.sendErrorEvent({eventName:"ParallelRequests_GotExtra",from:n,to:i,end:this.to,length:s.length});break}if(this.working){const t=n,o=s.length;let c=e<=o;if(0!==o){e<o&&this.logger.sendTelemetryEvent({eventName:"ParallelRequests_Over",from:n,to:i,length:o});const t=s.splice(0,e);this.results.set(n,t),n+=t.length}else Object(r.a)(!a,271),Object(r.a)(!this.knewTo,272);if(!a&&!c){if(!this.knewTo){(void 0===this.to||this.to>n)&&(this.to=n);break}this.logger.sendPerformanceEvent({eventName:"ParallelRequests_Partial",from:t,to:i,length:o})}if(i===this.latestRequested&&(0!==s.length&&(this.results.set(n,s),n+=s.length),this.latestRequested=n,c=!0),c){const e=this.getNextChunk();if(void 0===e)break;n=e.from,i=e.to}}}this.requestsInFlight--,this.dispatch()}}class O{ushValue(e){this.pushCore(Promise.resolve({done:!1,value:e}))}pushError(e){this.pushCore(Promise.reject(e)),this.done=!0}pushDone(){this.pushCore(Promise.resolve({done:!0})),this.done=!0}pushCore(e){Object(r.a)(!this.done,274),this.deferred?(Object(r.a)(0===this.queue.length,275),this.deferred.resolve(e),this.deferred=void 0):this.queue.push(e)}async read(){Object(r.a)(void 0===this.deferred,276);const e=this.queue.shift();return void 0!==e?e:(Object(r.a)(!this.done,277),this.deferred=new i.a,this.deferred.promise)}}const I=async()=>{var e;if(!1===(null===(e=globalThis.navigator)||void 0===e?void 0:e.onLine)&&void 0!==globalThis.addEventListener)return new Promise(()};function N(e,t,n,i,o,a,c,l){let d,u=0,h=0;const m=new O,g={fromTotal:n,toTotal:i},p=f.start(a,Object.assign(Object.assign({eventName:"GetDeltas"},g),{reason:l})),v=new w(n,i,o,a,(async(t,n,i,r,o)=>(u++,async function(e,t,n,i,r,o){let a,c,l=0,d=0,u=0;for(;!0!==(null==r?void 0:r.aborted);){d++;let r=Math.min(1e4,100*Math.pow(2,d));const h=s.a.now();try{const{messages:i,partialResult:r}=await e(Object.assign(Object.assign({},t),{retry:d}));if(0!==i.length||!n)return null==c||c.end(Object.assign(Object.assign({duration:l},t),{reason:o})),{payload:i,cancel:!1,partial:r};if(void 0===a)a=s.a.now();else if(s.a.now()-a>3e4)throw Object(b.k)("Failed to retrieve ops from storage (Too Many Retries)",{canRetry:!1},Object.assign({retry:d,driverVersion:C.a},t))}catch(e){const n=Object(b.j)(e),a=Object(b.m)(e);if(Object(S.a)(i,Object.assign(Object.assign({eventName:"GetDeltas_Error"},t),{retry:d,duration:s.a.now()-h,retryAfter:a,reason:o}),e),!n)throw e;void 0!==a&&(r=a)}void 0===c&&(u=s.a.now(),c=f.start(i,{eventName:"GetDeltasWaitTime"})),await new Promise((),await I(),l+=s.a.now()-u}return{partial:!1,cancel:!0,payload:[]}}((,Object.assign(Object.assign({request:t,from:n,to:i},g),o),r,a,c,l))),(e=>{void 0===d?Object(r.a)(e[0].sequenceNumber===n,621):Object(r.a)(e[0].sequenceNumber===d+1,622),d=e[e.length-1].sequenceNumber,Object(r.a)(d-e[0].sequenceNumber+1===e.length,623),h+=e.length,m.pushValue(e)})),y=e=>{v.cancel()};return void 0!==c&&c.addEventListener("abort",y),v.run(t).finally(().then((()=>{const e={lastFetch:d,length:h,requests:u};v.canceled?p.cancel(Object.assign(Object.assign({},e),{error:"ops request cancelled by client"})):(Object(r.a)(void 0===i||void 0!==d&&d>=i-1,624),p.end(e)),m.pushDone()})).catch((e=>{p.cancel({lastFetch:d,length:h,requests:u},e),m.pushError(e)})),m}const T={read:;function E(e){let t=e;return{read:async()=>{if(void 0===t)return{done:!0};const e=await t;return t=void 0,0===e.length?{done:!0}:{done:!1,value:e}}}}function k(e,t){return{read:async()=>{const n=await e.read();return t(n),n}}}},"KjZ+":LB3q:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IContainerRuntime=void 0,t.IContainerRuntime="IContainerRuntime"},LBQr:function(e,t,n){var i=n("SHde")(Object.getPrototypeOf,Object);e.exports=i},LSEb:Lalj:Lrhb:Ls0c:function(e,t,n){"use strict";n.d(t,"f",(function(){return o})),n.d(t,"g",(function(){return a})),n.d(t,"e",(function(){return c})),n.d(t,"b",(function(){return l})),n.d(t,"c",(function(){return d})),n.d(t,"a",(function(){return u})),n.d(t,"d",(function(){return h}));var i=n("HJ7Z"),r=n("l4ds"),s=n("7/yF");function o(e){const t=e.type===i.a.Handle?e.handleType:e.type;switch(t){case i.a.Blob:case i.a.Attachment:return r.a.File;case i.a.Tree:return r.a.Directory;default:Object(s.a)(t,`Unknown type: ${t}`)}}function a(e){const t=e.type===i.a.Handle?e.handleType:e.type;switch(t){case i.a.Blob:case i.a.Attachment:return"blob";case i.a.Tree:return"tree";default:Object(s.a)(t,`Unknown type: ${t}`)}}function c(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Map,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i={},r={id:e.sha,blobs:{},trees:{}};i[""]=r;for(const r of e.tree){const e=n?r.path.replace(/^\.app\//,""):r.path,s=e.lastIndexOf("/"),o=e.slice(0,Math.max(0,s)),a=e.slice(s+1),c=i[o];if("tree"===r.type){const t={id:r.sha,blobs:{},commits:{},trees:{}};c.trees[decodeURIComponent(a)]=t,i[e]=t}else{if("blob"!==r.type)throw new Error("Unknown entry type!!");c.blobs[decodeURIComponent(a)]=r.sha,t.set(r.sha,`/${e}`)}}return r}class l{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"utf-8";this.path=e,this.mode=r.a.File,this.type=r.b.Blob,this.value={contents:t,encoding:n}}}class d{constructor(e,t){this.path=e,this.value=t,this.mode=r.a.Directory,this.type=r.b.Tree}}class u{constructor(e,t){this.path=e,this.id=t,this.mode=r.a.File,this.type=r.b.Attachment,this.value={id:t}}}function h(e,t,n){e.entries.push({mode:r.a.File,path:t,type:r.b.Blob,value:{contents:JSON.stringify(n),encoding:"utf-8"}})}},Lywj:function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n("qDpI"),r=n("ESz4");class s extends r.a{constructor(e,t){super(null!=e?e:"Target resource id is already be used",!1,null!=t?t:"ResourceIdAlreadyInUse",i.g.UnhandledException)}}},MNOf:function(e,t,n){"use strict";.exports=function(e,t,n,s){n=n||"=";var o={};if("string"!=typeof e||0===e.length)return o;var a=/\+/g;e=e.split(t=t||"&");var c=1e3;s&&"number"==typeof s.maxKeys&&(c=s.maxKeys);var l=e.length;c>0&&l>c&&(l=c);for(var d=0;d<l;++d){var u,h,m,g,p=e[d].replace(a,"%20"),f=p.indexOf(n);f>=0?(u=p.substr(0,f),h=p.substr(f+1)):(u=p,h=""),m=decodeURIComponent(u),g=decodeURIComponent(h),i(o,m)?r(o[m])?o[m].push(g):o[m]=[o[m],g]:o[m]=g}return o};var r=Array.isArray||,MQuF:NAKK:NfLg:NgDi:function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n("hBZP");class r extends i.EventEmitter{constructor(){super(),this.addListener=super.addListener.bind(this),this.on=super.on.bind(this),this.once=super.once.bind(this),this.prependListener=super.prependListener.bind(this),this.prependOnceListener=super.prependOnceListener.bind(this),this.removeListener=super.removeListener.bind(this),this.off=super.off.bind(this)}}},O7fF:ONOI:OSDc:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.totalBlobSizePropertyName=t.CreateSummarizerNodeSource=t.channelsTreeName=t.blobCountPropertyName=t.gcTreeKey=t.gcTombstoneBlobKey=t.gcDeletedBlobKey=t.gcBlobPrefix=t.IFluidDataStoreRegistry=t.IFluidDataStoreFactory=t.VisibilityState=t.FlushModeExperimental=t.FlushMode=void 0;var i=n("ABR0");Object.defineProperty(t,"FlushMode",{enumerable:!0,get:function(){return i.FlushMode}}),Object.defineProperty(t,"FlushModeExperimental",{enumerable:!0,get:function(){return i.FlushModeExperimental}}),Object.defineProperty(t,"VisibilityState",{enumerable:!0,get:function(){return i.VisibilityState}});var r=n("pwCb");Object.defineProperty(t,"IFluidDataStoreFactory",{enumerable:!0,get:function(){return r.IFluidDataStoreFactory}});var s=n("6tX4");Object.defineProperty(t,"IFluidDataStoreRegistry",{enumerable:!0,get:function(){return s.IFluidDataStoreRegistry}});var o=n("iTAa");Object.defineProperty(t,"gcBlobPrefix",{enumerable:!0,get:function(){return o.gcBlobPrefix}}),Object.defineProperty(t,"gcDeletedBlobKey",{enumerable:!0,get:function(){return o.gcDeletedBlobKey}}),Object.defineProperty(t,"gcTombstoneBlobKey",{enumerable:!0,get:function(){return o.gcTombstoneBlobKey}}),Object.defineProperty(t,"gcTreeKey",{enumerable:!0,get:function(){return o.gcTreeKey}});var a=n("K87Y");Object.defineProperty(t,"blobCountPropertyName",{enumerable:!0,get:function(){return a.blobCountPropertyName}}),Object.defineProperty(t,"channelsTreeName",{enumerable:!0,get:function(){return a.channelsTreeName}}),Object.defineProperty(t,"CreateSummarizerNodeSource",{enumerable:!0,get:function(){return a.CreateSummarizerNodeSource}}),Object.defineProperty(t,"totalBlobSizePropertyName",{enumerable:!0,get:function(){return a.totalBlobSizePropertyName}})},Ono3:PHxc:PYDc:PixY:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IFluidDataStoreRegistry=void 0,t.IFluidDataStoreRegistry="IFluidDataStoreRegistry"},PqlX:QDPn:QlKF:QnlE:function(e,t,n){"use strict";n.d(t,"b",(function(){return xe})),n.d(t,"a",(function(){return Re}));var i,r=n("HVn3"),s=n.n(r),o=n("A3AF"),a=n("he5V"),c=n("rK/e"),l=n("7/yF");!function(e){e.Detached="Detached",e.Attaching="Attaching",e.Attached="Attached"}(i||(i={}));const d=e=>"object"==typeof e&&"string"==typeof(null==e?void 0:e.name)&&"object"==typeof(null==e?void 0:e.fluid),u=e=>{const t=e;return"object"==typeof t&&("string"==typeof(null==t?void 0:t.package)||d(null==t?void 0:t.package))&&(void 0===(null==t?void 0:t.config)||"object"==typeof(null==t?void 0:t.config))};var h;!h||(h={}));var m=n("etL/");class g extends m.a{constructor(e,t,n){super(e,n,new Set(["error"])),this.error=t,this.errorType=h.genericError}}class p extends m.a{tatic wrap(e,t,n){return Object(m.j)(e,(e=>new p(e,t)),n)}}class f extends m.a{constructor(e,t){super(e,Object.assign(Object.assign({},t),{usageError:!0})),this.errorType=h.usageError}}class v extends m.a{constructor(e,t){super(e,Object.assign(Object.assign({},t),{dataProcessingError:1})),this.errorType=h.dataCorruptionError,this.canRetry=!1}}class y extends m.a{constructor(e){super(e),this.errorType=h.dataProcessingError,this.canRetry=!1}static create(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const r=y.wrapIfUnrecognized(e,t,n);return r.addTelemetryProperties(i),r}static wrapIfUnrecognized(e,t,n){const i=Object.assign({dataProcessingError:1,dataProcessingCodepath:t},void 0===n?void 0:b(n)),r=Object(m.h)(e,{props:i});if(Object(m.e)(r)||r.errorType===m.b){const e=Object(m.i)(r,(e=>new y(e)));return e.addTelemetryProperties(r.getTelemetryProperties()),e}return r}}const b=e=>({messageClientId:e.clientId,messageSequenceNumber:e.sequenceNumber,messageClientSequenceNumber:e.clientSequenceNumber,messageReferenceSequenceNumber:e.referenceSequenceNumber,messageMinimumSequenceNumber:e.minimumSequenceNumber,messageTimestamp:e.timestamp});var S=n("DLbW"),C=n("qQRf"),w=n("gaGA"),O=n("Jbnz"),I=n("1bkS"),N=n("fxwU");async function T(e,t,n,i){var r,s;let o,a=!1,l=1e3,d=0;const u=c.a.now();let h;do{try{o=await e(i.cancel),a=!0}catch(e){if(!Object(I.j)(e))throw n.sendTelemetryEvent({eventName:`${t}_cancel`,retry:d,duration:c.a.now()-u,fetchCallName:t},e),e;if(!0===(null===(r=i.cancel)||void 0===r?void 0:r.aborted))throw n.sendTelemetryEvent({eventName:`${t}_runWithRetryAborted`,retry:d,duration:c.a.now()-u,fetchCallName:t},e),new I.f("runWithRetry was Aborted",O.a.genericError,{driverVersion:N.a,fetchCallName:t});0===d&&n.sendTelemetryEvent({eventName:`${t}_firstFailed`,duration:c.a.now()-u,fetchCallName:t},e),d++,h=e,l=null!==(s=Object(I.m)(e))&&void 0!==s?s:Math.min(2*l,8e3),i.onRetry&&i.onRetry(l,e),await Object(w.a)(l)}}while(!a);return d>0&&n.sendTelemetryEvent({eventName:`${t}_lastError`,retry:d,duration:c.a.now()-u,fetchCallName:t},h),o}var E=n("ZkeI"),k=n("HJ7Z"),j=n("f79D");const P="connected";var _=n("AJa+"),M=n("NgDi");class D extends M.a{constructor(e){super(),this.errorHandler=e}emit(e){try{for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return super.emit(e,...n)}catch(t){return this.errorHandler(e,t),!0}}}var x=n("ambg"),A=n("hBZP");class R extends A.EventEmitter{constructor(){super(...arguments),this.members=new Map}ddMember(e,t){if(this.members.has(e)){const n=this.members.get(e);Object(a.a)(JSON.stringify(n)===JSON.stringify(t),1202)}else this.members.set(e,t),this.emit("addMember",e,t)}removeMember(e){const t=this.members.get(e);return void 0!==t&&(this.members.delete(e),this.emit("removeMember",e,t),!0)}getMembers(){return new Map(this.members)}getMember(e){return this.members.get(e)}}var F,q=n("NsUA");class z{constructor(e,t,n,i,r,s,o,a,c,l,d,u,h,m,g,p,f,v){this.container=e,this.scope=t,this.codeLoader=n,this._codeDetails=i,this._baseSnapshot=r,this.deltaManager=s,this.loader=a,this.submitFn=c,this.submitSummaryFn=l,this.submitBatchFn=d,this.submitSignalFn=u,this.disposeFn=h,this.closeFn=m,this.version=g,this.updateDirtyContainerState=p,this.existing=f,this.pendingLocalState=v,this._disposed=!1,this.lifecycleEvents=new M.a,this._connected=this.container.connected,this._quorum=o,this.taggedLogger=e.subLogger,this._fluidModuleP=new q.b((async()=>this.loadCodeModule(i))),this.supportedFeatures=new Map([["referenceSequenceNumbers",!0]]),this.attachListener()}static async createOrLoad(e,t,n,i,r,s,o,a,c,l,d,u,h,m,g,p,f,v){const y=new z(e,t,n,i,r,s,o,a,c,l,d,u,h,m,g,p,f,v);return await y.instantiateRuntime(f),y}get clientId(){return this.container.clientId}get id(){const e=this.container.resolvedUrl;return Object(C.b)(e)?e.id:""}get clientDetails(){return this.container.clientDetails}get connected(){return this._connected}et serviceConfiguration(){return this.container.serviceConfiguration}get audience(){return this.container.audience}get options(){return this.container.options}get baseSnapshot(){return this._baseSnapshot}get storage(){return this.container.storage}get runtime(){if(void 0===this._runtime)throw new Error("Attempted to access runtime before it was defined");return this._runtime}get disposed(){return this._disposed}get codeDetails(){return this._codeDetails}get quorum(){return this._quorum}async getEntryPoint(){var e,t;if(this._disposed)throw new f("The context is already disposed");return void 0!==this._runtime?null===(t=null===(e=this._runtime)||void 0===e?void 0:e.getEntryPoint)||void 0===t?void 0:t.call(e):new Promise(((e,t)=>{const n=()=>{var t,n;Object(a.a)(void 0!==this._runtime,1443),e(null===(n=(t=this._runtime).getEntryPoint)||void 0===n?void 0:n.call(t)),this.lifecycleEvents.off("disposed",i)},i=()=>{t(new Error("ContainerContext was disposed")),this.lifecycleEvents.off("runtimeInstantiated",n)};this.lifecycleEvents.once("runtimeInstantiated",n),this.lifecycleEvents.once("disposed",i)}))}getSpecifiedCodeDetails(){var e;return null!==(e=this._quorum.get("code"))&&void 0!==e?e:this._quorum.get("code2")}dispose(e){this._disposed||(this._disposed=!0,this.lifecycleEvents.emit("disposed"),this.runtime.dispose(e),this._quorum.dispose(),this.deltaManager.dispose())}getLoadedFromVersion(){return this.container.loadedFromVersion}get attachState(){return this.container.attachState}createSummary(e){return this.runtime.createSummary(e)}setConnectionState(e,t){const n=this.runtime;this._connected=e,n.setConnectionState(e,t)}process(e,t){this.runtime.process(e,t)}processSignal(e,t){this.runtime.processSignal(e,t)}async request(e){return this.runtime.request(e)}async getAbsoluteUrl(e){return this.container.getAbsoluteUrl(e)}getPendingLocalState(){return this.runtime.getPendingLocalState()}async satisfies(e){var t;const n=[],i=this.codeLoader;void 0!==i.IFluidCodeDetailsComparer&&n.push(i.IFluidCodeDetailsComparer);const r=await this._fluidModuleP,s=null===(t=r.module)||void 0===t?void 0:t.fluidExport;if(void 0!==(null==s?void 0:s.IFluidCodeDetailsComparer)&&n.push(s.IFluidCodeDetailsComparer),0===n.length)return!1;for(const t of n)if(!1===await t.satisfies(r.details,e))return!1;return!0}async notifyOpReplaysync getRuntimeFactory(){var e;const t=null===(e=(await this._fluidModuleP).module)||void 0===e?void 0:e.fluidExport,n=null==t?void 0:t.IRuntimeFactory;if(void 0===n)throw new Error("Code package does not implement IRuntimeFactory");return n}async instantiateRuntime(e){const t=await this.getRuntimeFactory();this._runtime=await _.c.timedExecAsync(this.taggedLogger,{eventName:"InstantiateRuntime"},(),this.lifecycleEvents.emit("runtimeInstantiated")}sync loadCodeModule(e){const t=await _.c.timedExecAsync(this.taggedLogger,{eventName:"CodeLoad"},(async()=>this.codeLoader.load(e)));if("module"in t){const{module:n,details:i}=t;return{module:n,details:null!=i?i:e}}return this.taggedLogger.sendTelemetryEvent({eventName:"LegacyCodeLoader"}),t}}!function(e){e.Never="Never",e.Disabled="Disabled",e.Enabled="Enabled"}(F||(F={}));var B,L=n("vqXW"),V=n.n(L);!function(e){e.genericError="genericError",e.genericNetworkError="genericNetworkError",e.authorizationError="authorizationError",e.fileNotFoundOrAccessDeniedError="fileNotFoundOrAccessDeniedError",e.throttlingError="throttlingError",e.offlineError="offlineError",e.unsupportedClientProtocolVersion="unsupportedClientProtocolVersion",e.writeError="writeError",e.fetchFailure="fetchFailure",e.fetchTokenError="fetchTokenError",e.incorrectServerResponse="incorrectServerResponse",e.fileOverwrittenInStorage="fileOverwrittenInStorage",e.deltaStreamConnectionForbidden="deltaStreamConnectionForbidden",e.locationRedirection="locationRedirection",e.fluidInvalidSchema="fluidInvalidSchema",e.usageError="usageError",e.fileIsLocked="fileIsLocked"}(B||(B={}));var U=n("3mBU"),H=n("3YFW"),G=n.n(H);class $ extends M.a{constructor(e){super(),this.worker=e,this.isDisposed=!1,this.q=new G.a,this.pauseCount=1}get disposed(){return this.isDisposed}et length(){return this.q.length}get idle(){return void 0===this.processingPromise&&0===this.q.length}async waitTillProcessingDone(){var e;return null!==(e=this.processingPromise)&&void 0!==e?e:{count:0,duration:0}}dispose(){throw new Error("Not implemented.")}clear(){this.q.clear()}peek(){return this.q.peekFront()}toArray(){return this.q.toArray()}push(e){try{this.q.push(e),this.emit("push",e),this.ensureProcessing()}catch(e){this.emit("error",e)}}async pause(){this.pauseCount++,await this.waitTillProcessingDone()}resume(){Object(a.a)(this.pauseCount>0,244),this.pauseCount--,this.ensureProcessing()}ensureProcessing(){this.anythingToProcess()&&void 0===this.processingPromise&&(this.processingPromise=Promise.resolve().then((()=>{Object(a.a)(void 0!==this.processingPromise,895);const e=this.processDeltas();return Object(a.a)(void 0!==this.processingPromise,896),this.processingPromise=void 0,e})).catch((e=>(this.error=e,this.processingPromise=void 0,this.emit("error",e),{count:0,duration:0}))),Object(a.a)(void 0!==this.processingPromise,897))}anythingToProcess(){return 0!==this.q.length&&!this.paused&&void 0===this.error}processDeltas(){const e=c.a.now();let t=0;for(;this.anythingToProcess();){const e=this.q.shift();t++,this.worker(e),this.emit("op",e)}const n=c.a.now()-e;return 0===this.q.length&&this.emit("idle",t,n),{count:t,duration:n}}}var K,W=n("RLzy");!function(e){e.ClientJoin="join",e.ClientLeave="leave",e.Clear="clear"}(K||(K={}));class J extends W.a{constructor(e,t,n,i){super(e.minimumSequenceNumber,e.sequenceNumber,1,t.members,t.proposals,t.values,n),this.audience=i,this.quorum.on("addMember",(),this.quorum.on("removeMember",(e=>i.removeMember(e)));for(const[e,t]of this.quorum.getMembers())this.audience.addMember(e,t.client)}processMessage(e,t){const n=this.quorum.getMember(e.clientId);if(null!=e.clientId){if(void 0===n&&e.type!==j.a.ClientJoin)throw new Error("Remote message's clientId is missing from the quorum");if(!0===(null==n?void 0:n.shouldHaveLeft)&&!Object(U.b)(e))throw new Error("Remote message's clientId already should have left")}return super.processMessage(e,t)}processSignal(e){var t;const n=e.content;switch(n.type){case K.Clear:{const e=this.audience.getMembers();for(const[t,n]of e)"read"===n.mode&&this.audience.removeMember(t);break}case K.ClientJoin:{const e=n.content;"read"===e.client.mode&&this.audience.addMember(e.clientId,e.client);break}case K.ClientLeave:{const e=n.content;"read"===(null===(t=this.audience.getMember(e))||void 0===t?void 0:t.mode)&&this.audience.removeMember(e);break}}}}function Q(e){if(Object(U.c)(e))return!0;switch(e.type){case j.a.Propose:case j.a.Reject:case j.a.NoOp:case U.a.Accept:case j.a.Summarize:return!0;default:return!1}}class X extends M.a{constructor(e,t,n,i){super(),this.serviceProvider=e,this.logger=t,this._active=n,this.pending=[],this.currentlyProcessingOps=!1,this.minSequenceNumber=0,this.lastQueuedSequenceNumber=0,this.lastObservedSeqNumber=0,this.lastProcessedSequenceNumber=0,this.noOpCount=0,this.lastClientSequenceNumber=0,this.opsSize=0,this.initSequenceNumber=0,this._closed=!1,this._disposed=!1,this.throttlingIdSet=new Set,this.timeTillThrottling=0,this.closeAbortController=new V.a,this.deltaStorageDelayId=Object(o.a)(),this.deltaStreamDelayId=Object(o.a)(),this.messageBuffer=[],this.connectionManager=i({incomingOpHandler:(e,t)=>{try{this.enqueueMessages(e,t)}catch(e){this.logger.sendErrorEvent({eventName:"EnqueueMessages_Exception"},e),this.close(Object(m.h)(e))}},signalHandler:e=>this._inboundSignal.push(e),reconnectionDelayHandler:closeHandler:e=>this.close(e),disconnectHandler:e=>this.disconnectHandler(e),connectHandler:e=>this.connectHandler(e),pongHandler:readonlyChangeHandler:e=>function(e,t,n){try{for(var i=arguments.length,r=new Array(i>3?i-3:0),s=3;s<i;s++)r[s-3]=arguments[s];e.emit(n,...r)}catch(e){t.sendErrorEvent({eventName:"RaiseEventError",event:n},e)}}(this,this.logger,"readonly",e)}),this._inbound=new $((e=>{this.processInboundMessage(e)})),this._inbound.on("error",(e=>{this.close(y.wrapIfUnrecognized(e,"deltaManagerInboundErrorHandler",this.lastMessage))})),this._inboundSignal=new $((e=>{if(void 0===this.handler)throw new Error("Attempted to process an inbound signal without a handler attached");this.handler.processSignal({clientId:e.clientId,content:JSON.parse(e.content)})})),this._inboundSignal.on("error",(e=>{this.close(Object(m.h)(e))}))}get active(){return this._active()}get disposed(){return this._closed}get IDeltaSender(){return this}get inbound(){return this._inbound}get inboundSignal(){return this._inboundSignal}get initialSequenceNumber(){return this.initSequenceNumber}get lastSequenceNumber(){return this.lastProcessedSequenceNumber}get lastMessage(){return this.lastProcessedMessage}get lastKnownSeqNumber(){return this.lastObservedSeqNumber}get minimumSequenceNumber(){return this.minSequenceNumber}get hasCheckpointSequenceNumber(){return Object(a.a)(this.connectionManager.connected,223),void 0!==this._checkpointSequenceNumber}get maxMessageSize(){return this.connectionManager.maxMessageSize}get version(){return this.connectionManager.version}get serviceConfiguration(){return this.connectionManager.serviceConfiguration}get outbound(){return this.connectionManager.outbound}get readOnlyInfo(){return this.connectionManager.readOnlyInfo}get clientDetails(){return this.connectionManager.clientDetails}submit(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>5?arguments[5]:void 0;const r={contents:t,metadata:arguments.length>3?arguments[3]:void 0,referenceSequenceNumber:null!=i?i:this.lastProcessedSequenceNumber,type:e,compression:arguments.length>4?arguments[4]:void 0};n||this.flush();const s=this.connectionManager.prepareMessageToSend(r);return void 0===s?-1:(Object(a.a)(Q(s),1049),void 0!==t&&(this.opsSize+=t.length),this.messageBuffer.push(s),s.type===j.a.NoOp&&this.noOpCount++,this.emit("submitOp",s),n||this.flush(),s.clientSequenceNumber)}submitSignal(e){return this.connectionManager.submitSignal(e)}flush(){var e,t,n;const i=this.messageBuffer;0!==i.length&&(this.messageBuffer=[],this.emit("prepareSend",i),1===i.length?Object(a.a)(void 0===(null===(e=i[0].metadata)||void 0===e?void 0:e.batch),969):(Object(a.a)(!0===(null===(t=i[0].metadata)||void 0===t?void 0:t.batch),970),Object(a.a)(!1===(null===(n=i[i.length-1].metadata)||void 0===n?void 0:n.batch),971)),this.connectionManager.sendMessages(i),Object(a.a)(0===this.messageBuffer.length,972))}get connectionProps(){return Object.assign({sequenceNumber:this.lastSequenceNumber,opsSize:this.opsSize>0?this.opsSize:void 0},this.connectionManager.connectionProps)}logConnectionIssue(e){var t;Object(a.a)(this.connectionManager.connected,568);const n=this.pending.sort(((e,t)=>e.sequenceNumber-t.sequenceNumber));this.logger.sendErrorEvent(Object.assign(Object.assign(Object.assign(Object.assign({},e),{fetchReason:this.fetchReason,lastQueuedSequenceNumber:this.lastQueuedSequenceNumber,lastProcessedSequenceNumber:this.lastProcessedSequenceNumber,lastObserved:this.lastObservedSeqNumber}),this.connectionManager.connectionVerboseProps),{pendingOps:this.pending.length,pendingFirst:null===(t=n[0])||void 0===t?void 0:t.sequenceNumber,haveHandler:void 0!==this.handler,inboundLength:this.inbound.length,inboundPaused:this.inbound.paused}))}connectHandler(e){this.refreshDelayInfo(this.deltaStreamDelayId);const t=this.connectionManager.connectionVerboseProps;t.connectionLastQueuedSequenceNumber=this.lastQueuedSequenceNumber,t.connectionLastObservedSeqNumber=this.lastObservedSeqNumber;const n=e.checkpointSequenceNumber;this._checkpointSequenceNumber=n,void 0!==n&&this.updateLatestKnownOpSeqNumber(n),Object(a.a)(0===this.messageBuffer.length,233),this.opsSize=0,this.noOpCount=0,this.emit("connect",e,void 0!==n?this.lastObservedSeqNumber-this.lastSequenceNumber:void 0),void 0!==n?n>this.lastQueuedSequenceNumber&&this.fetchMissingDeltas("AfterConnection"):"read"===e.mode&&this.fetchMissingDeltas("AfterReadConnection")}dispose(){throw new Error("Not implemented.")}async attachOpHandler(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"none";if(this.initSequenceNumber=t,this.lastProcessedSequenceNumber=t,this.minSequenceNumber=e,this.lastQueuedSequenceNumber=t,this.lastObservedSeqNumber=t,Object(a.a)(void 0===this.handler,226),this.handler=n,Object(a.a)(!!this.handler,227),Object(a.a)(void 0===this.fetchReason,616),!this._closed){if(this._inbound.resume(),this._inboundSignal.resume(),"none"!==i){const e="cached"===i;await this.fetchMissingDeltasCore(`DocumentOpen_${i}`,e),e&&this.fetchMissingDeltas("PostDocumentOpen")}Object(a.a)(void 0!==this.fetchReason||0===this.pending.length,617)}}connect(e){var t;const n=null===(t=e.fetchOpsFromStorage)||void 0===t||t;!function(e,t,n){if(e)return!0;t.send({eventName:"CantFetchWithoutBaseline",category:"error"})}(void 0!==this.handler||!n,this.logger),n&&this.fetchMissingDeltas(e.reason),this.connectionManager.connect(e.mode)}async getDeltas(e,t,n,i,r){const s=this.serviceProvider();if(void 0===s)throw new Error("Delta manager is not attached");let o;if(void 0===this.deltaStorage&&(this.deltaStorage=await s.connectToDeltaStorage()),void 0!==t){const i=t-1;if(this.lastQueuedSequenceNumber>=i)return void this.logger.sendPerformanceEvent(Object.assign({reason:n,eventName:"ExtraStorageCall",early:!0,from:e,to:t},this.connectionManager.connectionVerboseProps));o=else o=const c=new V.a;let l=!1;const d=e=>{Object(a.a)(e.sequenceNumber===this.lastQueuedSequenceNumber,570),!l&&o(e)&&(c.abort(),this._inbound.off("push",d))};try{this._inbound.on("push",d),Object(a.a)(null===this.closeAbortController.signal.onabort,488),this.closeAbortController.signal.onabort=()=>c.abort();const s=this.deltaStorage.fetchMessages(e,t,c.signal,r,n);for(;;){const e=await s.read();if(e.done)break;try{l=!0,i(e.value)}finally{l=!1}}}finally{this.closeAbortController.signal.onabort=null,this._inbound.off("push",d),Object(a.a)(!l,649)}}close(e,t){this._closed?!0===t&&this.disposeInternal(e):(this._closed=!0,this.connectionManager.dispose(e,!0!==t),this.closeAbortController.abort(),this._inbound.clear(),this._inboundSignal.clear(),this._inbound.pause(),this._inboundSignal.pause(),this.pending=[],!0===t||this.emit("closed",e),this.disposeInternal(e))}disposeInternal(e){this._disposed||(this._disposed=!0,this.emit("disposed",e),this.removeAllListeners())}refreshDelayInfo(e){this.throttlingIdSet.delete(e),0===this.throttlingIdSet.size&&(this.timeTillThrottling=0)}disconnectHandler(e){this.messageBuffer.length=0,this.emit("disconnect",e)}emitDelayInfo(e,t,n){const i=Date.now();if(this.throttlingIdSet.add(e),t>0&&i+t>this.timeTillThrottling){this.timeTillThrottling=i+t;const e=p.wrap(n,t/1e3,this.logger);this.emit("throttled",e)}}comparableMessagePayloadnqueueMessages(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];var i,r;if(void 0===this.handler)return void(this.pending=this.pending.concat(e));if(Object(a.a)(0===this.pending.length||void 0!==this.fetchReason,489),0===e.length)return;const s=e[0].sequenceNumber,o=e[e.length-1].sequenceNumber;if(o>this.lastQueuedSequenceNumber){let i=s-1;const r=i-this.lastQueuedSequenceNumber;let a,c,l=0,d=0;for(const t of e)t.sequenceNumber===i?l++:t.sequenceNumber!==i+1&&(d++,void 0===a&&(a=i+1)),i=t.sequenceNumber;0!==l||0!==d&&!n||r>0&&void 0===this.fetchReason?c="enqueueMessages":void 0!==this.fetchReason&&this.fetchReason!==t&&s<=this.lastQueuedSequenceNumber+1&&o>this.lastQueuedSequenceNumber&&(c="enqueueMessagesExtraFetch"),void 0!==c&&this.logger.sendPerformanceEvent(Object.assign({eventName:c,reason:t,previousReason:this.prevEnqueueMessagesReason,from:s,to:o+1,length:e.length,fetchReason:this.fetchReason,duplicate:l>0?l:void 0,initialGap:0!==r?r:void 0,gap:d>0?d:void 0,firstMissing:a,dmInitialSeqNumber:this.initialSequenceNumber},this.connectionManager.connectionVerboseProps))}this.updateLatestKnownOpSeqNumber(e[e.length-1].sequenceNumber);const c=null===(i=this.previouslyProcessedMessage)||void 0===i?void 0:i.sequenceNumber;Object(a.a)(void 0===c||c===this.lastQueuedSequenceNumber,236);for(const n of e)if(n.sequenceNumber<=this.lastQueuedSequenceNumber){if((null===(r=this.previouslyProcessedMessage)||void 0===r?void 0:r.sequenceNumber)===n.sequenceNumber){const e=this.comparableMessagePayload(this.previouslyProcessedMessage),t=this.comparableMessagePayload(n);if(e!==t){const i=new I.f("Found two messages with the same sequenceNumber but different payloads. Likely to be a service issue",B.fileOverwrittenInStorage,{clientId:this.connectionManager.clientId,sequenceNumber:n.sequenceNumber,message1:e,message2:t,driverVersion:void 0});this.close(i)}}}else n.sequenceNumber!==this.lastQueuedSequenceNumber+1?(this.pending.push(n),this.fetchMissingDeltas(t,n.sequenceNumber)):(this.lastQueuedSequenceNumber=n.sequenceNumber,this.previouslyProcessedMessage=n,this._inbound.push(n));this.prevEnqueueMessagesReason=this.pending.length>0?"unknown":t}processInboundMessage(e){const t=Date.now();Object(a.a)(!this.currentlyProcessingOps,943),this.currentlyProcessingOps=!0,this.lastProcessedMessage=e;const n="string"==typeof e.clientId;if(Object(a.a)(null===e.clientId||n,1050),!n&&Q(e)&&e.type!==j.a.NoOp)throw new v("Mismatch in clientId",Object.assign(Object.assign({},b(e)),{messageType:e.type}));if("string"==typeof e.contents&&""!==e.contents&&e.type!==j.a.ClientLeave&&(e.contents=JSON.parse(e.contents)),void 0!==this.connectionManager.clientId&&this.connectionManager.clientId===e.clientId){e.type===j.a.NoOp&&this.noOpCount--;const t=e.clientSequenceNumber-this.lastClientSequenceNumber-1;if(this.noOpCount-=t,this.noOpCount<0)throw new Error(`gap in client sequence number: ${t}`);this.lastClientSequenceNumber=e.clientSequenceNumber}if(this.connectionManager.beforeProcessingIncomingOp(e),this.minSequenceNumber>e.minimumSequenceNumber)throw new v("Found a lower minimumSequenceNumber (msn) than previously recorded",Object.assign(Object.assign({},b(e)),{clientId:this.connectionManager.clientId}));const i=e.sequenceNumber-e.minimumSequenceNumber;if(i<0||0===i&&null!==e.clientId)throw new v("MSN has to be lower than sequence #",b(e));if(this.minSequenceNumber=e.minimumSequenceNumber,e.sequenceNumber!==this.lastProcessedSequenceNumber+1)throw new v("Found a non-Sequential sequenceNumber",Object.assign(Object.assign({},b(e)),{clientId:this.connectionManager.clientId}));if(this.lastProcessedSequenceNumber=e.sequenceNumber,Object(a.a)(this.lastProcessedSequenceNumber<=this.lastObservedSeqNumber,615),void 0===e.term&&(e.term=1),void 0===this.handler)throw new Error("Attempted to process an inbound message without a handler attached");this.handler.process(e),this.currentlyProcessingOps=!1;const r=Date.now();this.emit("op",e,r-t)}fetchMissingDeltas(e,t){this.fetchMissingDeltasCore(e,!1,t).catch((e=>{this.logger.sendErrorEvent({eventName:"fetchMissingDeltasException"},e)}))}async fetchMissingDeltasCore(e,t,n){var i;if(void 0===this.fetchReason)if(this._closed)this.logger.sendTelemetryEvent({eventName:"fetchMissingDeltasClosedConnection",reason:e});else if(void 0!==this.handler)try{let r=this.lastQueuedSequenceNumber+1;const s=null===(i=this.previouslyProcessedMessage)||void 0===i?void 0:i.sequenceNumber;void 0!==s&&(Object(a.a)(s===this.lastQueuedSequenceNumber,242),Object(a.a)(r>1,243),r--);const o=`${e}_fetch`;this.fetchReason=o,await this.getDeltas(r,n,o,(e=>{this.refreshDelayInfo(this.deltaStorageDelayId),this.enqueueMessages(e,o)}),t)}catch(e){this.logger.sendErrorEvent({eventName:"GetDeltas_Exception"},e),this.close(Object(m.h)(e))}finally{this.refreshDelayInfo(this.deltaStorageDelayId),this.fetchReason=void 0,this.processPendingOps(e)}else Object(a.a)(0===this.lastQueuedSequenceNumber,619)}processPendingOps(e){if(this._closed)return;Object(a.a)(void 0!==this.handler,620);const t=this.pending.sort(((e,t)=>e.sequenceNumber-t.sequenceNumber));this.pending=[],this.enqueueMessages(t,`${e}_pending`,!0),void 0===this.fetchReason&&this.lastQueuedSequenceNumber<this.lastObservedSeqNumber&&this.fetchMissingDeltas("OpsBehind")}updateLatestKnownOpSeqNumber(e){this.lastObservedSeqNumber<e&&(this.lastObservedSeqNumber=e)}}var Z=n("+Ega");class Y extends Z.a{constructor(e){super(e),this.deltaManager=e}get IDeltaSender(){return this}get inbound(){return this.deltaManager.inbound}get outbound(){return this.deltaManager.outbound}get inboundSignal(){return this.deltaManager.inboundSignal}get minimumSequenceNumber(){return this.deltaManager.minimumSequenceNumber}get lastSequenceNumber(){return this.deltaManager.lastSequenceNumber}get lastMessage(){return this.deltaManager.lastMessage}get lastKnownSeqNumber(){return this.deltaManager.lastKnownSeqNumber}get initialSequenceNumber(){return this.deltaManager.initialSequenceNumber}get hasCheckpointSequenceNumber(){return this.deltaManager.hasCheckpointSequenceNumber}get clientDetails(){return this.deltaManager.clientDetails}get version(){return this.deltaManager.version}get maxMessageSize(){return this.deltaManager.maxMessageSize}get serviceConfiguration(){return this.deltaManager.serviceConfiguration}get active(){return this.deltaManager.active}get readOnlyInfo(){return this.deltaManager.readOnlyInfo}dispose(){super.dispose()}submitSignal(e){return this.deltaManager.submitSignal(e)}flush(){return this.deltaManager.flush()}}class ee extends Z.a{constructor(e){super(e),this.queue=e}get paused(){return this.queue.paused}get length(){return this.queue.length}get idle(){return this.queue.idle}peek(){return this.queue.peek()}toArray(){return this.queue.toArray()}async systemPause(){return this.pause()}async pause(){return this.queue.pause()}async systemResume(){return this.resume()}async resume(){this.queue.resume()}async waitTillProcessingDone(){return this.queue.waitTillProcessingDone()}}class te extends Y{constructor(e){super(e),this._inbound=new ee(e.inbound),this._outbound=new ee(e.outbound),this._inboundSignal=new ee(e.inboundSignal)}get inbound(){return this._inbound}get outbound(){return this._outbound}get inboundSignal(){return this._inboundSignal}dispose(){this._inbound.dispose(),this._outbound.dispose(),this._inboundSignal.dispose(),super.dispose()}}var ne=n("UPAM"),ie=n("NAKK"),re=n("Xou4"),se=n("7Oo1");class oe{constructor(e,t){this.internalStorageService=e,this.addProtocolSummaryIfMissing=t,this.getSnapshotTree=this.internalStorageService.getSnapshotTree.bind(this.internalStorageService),this.getVersions=this.internalStorageService.getVersions.bind(this.internalStorageService),this.createBlob=this.internalStorageService.createBlob.bind(this.internalStorageService),this.readBlob=this.internalStorageService.readBlob.bind(this.internalStorageService),this.downloadSummary=this.internalStorageService.downloadSummary.bind(this.internalStorageService),this.dispose=this.internalStorageService.dispose.bind(this.internalStorageService)}get policies(){return this.internalStorageService.policies}get repositoryUrl(){return this.internalStorageService.repositoryUrl}get disposed(){return this.internalStorageService.disposed}async uploadSummaryWithContextclass ae{et policies(){return this.internalStorageService.policies}get disposed(){return this._disposed}dispose(){this._disposed=!0}get repositoryUrl(){return this.internalStorageService.repositoryUrl}async getSnapshotTree(e,t){return this.runWithRetry((async()=>this.internalStorageService.getSnapshotTree(e,t)),"storage_getSnapshotTree")}async readBlob(e){return this.runWithRetry((async()=>this.internalStorageService.readBlob(e)),"storage_readBlob")}async getVersions(e,t,n,i){return this.runWithRetry((,"storage_getVersions")}async uploadSummaryWithContext(e,t){return Object(a.a)(0===t.referenceSequenceNumber==(void 0===t.ackHandle),593),0!==t.referenceSequenceNumber?this.internalStorageService.uploadSummaryWithContext(e,t):this.runWithRetry((,"storage_uploadSummaryWithContext")}async downloadSummary(e){return this.runWithRetry((async()=>this.internalStorageService.downloadSummary(e)),"storage_downloadSummary")}heckStorageDisposed(e,t){if(this._disposed)throw this.logger.sendTelemetryEvent({eventName:`${e}_abortedStorageDisposed`,fetchCallName:e},t),new g("Storage Service is disposed. Cannot retry",{canRetry:!1})}async runWithRetry(e,t){return T(e,t,this.logger,{onRetry:(e,n)=>this.checkStorageDisposed(t,n)})}}class ce{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=arguments.length>3?arguments[3]:void 0,r=arguments.length>4?arguments[4]:void 0;this.logger=t,this.blobContents=n,this.addProtocolSummaryIfMissing=i,this.disposed=!1,this._storageService=new le(e,t),this._summarizeProtocolTree=r}ispose(e){var t,n;null===(n=null===(t=this._storageService)||void 0===t?void 0:t.dispose)||void 0===n||n.call(t,e),this.disposed=!0}async connectToService(e){var t,n,i,r;if(!(this._storageService instanceof le))return;const s=await e.connectToStorage(),o=this._storageService=new ae(s,this.logger);this._summarizeProtocolTree=null!==(t=this._summarizeProtocolTree)&&void 0!==t?t:null===(n=e.policies)||void 0===n?void 0:n.summarizeProtocolTree,this.summarizeProtocolTree&&(this.logger.sendTelemetryEvent({eventName:"summarizeProtocolTreeEnabled"}),this._storageService=new oe(o,this.addProtocolSummaryIfMissing)),Object(a.a)((null===(i=s.policies)||void 0===i?void 0:i.minBlobSize)===(null===(r=this._storageService.policies)||void 0===r?void 0:r.minBlobSize),224)}loadSnapshotForRehydratingContainer(e){this.getBlobContents(e)}getBlobContents(e){for(const[t,n]of Object.entries(e.blobsContents))this.blobContents[t]=n;for(const[t,n]of Object.entries(e.trees))this.getBlobContents(n)}get policieset repositoryUrl(){return this._storageService.repositoryUrl}async getSnapshotTree(e,t){return this._storageService.getSnapshotTree(e,t)}async readBlob(e){const t=this.blobContents[e];return void 0!==t?"string"==typeof t?Object(re.e)(t,"utf8"):t:this._storageService.readBlob(e)}sync uploadSummaryWithContext(e,t){return this._storageService.uploadSummaryWithContext(e,t)}async downloadSummary(e){return this._storageService.downloadSummary(e)}async createBlob(e){return this._storageService.createBlob(e)}}class le{constructor(e,t){this.detachedStorage=e,this.logger=t,this.getSnapshotTree=this.notCalled,this.getVersions=this.notCalled,this.write=this.notCalled,this.uploadSummaryWithContext=this.notCalled,this.downloadSummary=this.notCalled}async createBlob(e){return this.verifyStorage().createBlob(e)}erifyStorage(){if(void 0===this.detachedStorage)throw new se.a("Real storage calls not allowed in Unattached container");return this.detachedStorage}get policies(){return this.notCalled()}get repositoryUrl(){return this.notCalled()}notCalled(){this.verifyStorage();try{throw new Error("BlobOnlyStorage not implemented method used")}catch(e){throw this.logger.sendTelemetryEvent({eventName:"BlobOnlyStorageWrongCall"},e),e}}}const de=".blobs";async function ue(e,t){const n={};return await he(e,n,t),n}async function he(e,t,n){let i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const r=[];for(const[s,o]of Object.entries(e.trees))i&&s===de||r.push(he(o,t,n,!1));for(const i of Object.values(e.blobs)){const e=await n.readBlob(i);t[i]=Object(re.c)(e,"utf8")}return Promise.all(r)}unction ge(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];for(const[i,r]of Object.entries(e.trees))n&&i===de||ge(r,t,!1);for(const n of Object.values(e.blobs)){const i=e.blobsContents[n];Object(a.a)(void 0!==i,748),t[n]=Object(re.c)(i,"utf8")}}var pe=n("XxIN"),fe=n("8Leb");class ve{constructor(e,t){this.deltaManager=e,this.listener=t,this.caughtUp=!1,this.opHandler=e=>{!this.caughtUp&&e.sequenceNumber>=this.targetSeqNumber&&(this.caughtUp=!0,this.listener())},this.disposed=!1,this.targetSeqNumber=this.deltaManager.lastKnownSeqNumber,Object(a.a)(this.targetSeqNumber>=this.deltaManager.lastSequenceNumber,892),this.deltaManager.on("op",this.opHandler),this.opHandler({sequenceNumber:this.deltaManager.lastSequenceNumber})}dispose(){this.disposed||(this.disposed=!0,this.deltaManager.off("op",this.opHandler))}}class ye extends class{constructor(e,t){this.inputs=e,this.pimpl=t(this)}get connectionState(){return this.pimpl.connectionState}get pendingClientId(){return this.pimpl.pendingClientId}containerSaved(){return this.pimpl.containerSaved()}dispose(){return this.pimpl.dispose()}initProtocol(e){return this.pimpl.initProtocol(e)}receivedDisconnectEvent(e){return this.pimpl.receivedDisconnectEvent(e)}receivedConnectEvent(e){return this.pimpl.receivedConnectEvent(e)}get logger(){return this.inputs.logger}connectionStateChanged(e,t,n){return this.inputs.connectionStateChanged(e,t,n)}shouldClientJoinWrite(){return this.inputs.shouldClientJoinWrite()}get maxClientLeaveWaitTime(){return this.inputs.maxClientLeaveWaitTime}{constructor(e,t,n){super(e,t),this.deltaManager=n,this.transitionToConnectedState=()=>{const e=this.pimpl.connectionState;Object(a.a)(e===fe.a.Connected,997),Object(a.a)(this._connectionState===fe.a.CatchingUp,998),this._connectionState=fe.a.Connected,this.inputs.connectionStateChanged(fe.a.Connected,fe.a.CatchingUp,"caught up")},this._connectionState=this.pimpl.connectionState}get connectionState(){return this._connectionState}connectionStateChanged(e,t,n){var i;switch(e){case fe.a.Connected:return Object(a.a)(this._connectionState===fe.a.CatchingUp,993),Object(a.a)(void 0===this.catchUpMonitor,1003),void(this.catchUpMonitor=new ve(this.deltaManager,this.transitionToConnectedState));case fe.a.Disconnected:null===(i=this.catchUpMonitor)||void 0===i||i.dispose(),this.catchUpMonitor=void 0;break;case fe.a.CatchingUp:Object(a.a)(this._connectionState===fe.a.Disconnected,995)}this._connectionState=e,this.inputs.connectionStateChanged(e,t,n)}}class be{constructor(e,t,n){var i;this.handler=e,this.readClientsWaitForJoinSignal=t,this._connectionState=fe.a.Disconnected,this._clientId=n,this.prevClientLeftTimer=new pe.b(null!==(i=this.handler.maxClientLeaveWaitTime)&&void 0!==i?i:3e5,(()=>{Object(a.a)(this.connectionState!==fe.a.Connected,684),this.applyForConnectedState("timeout")})),this.joinOpTimer=new pe.b(0,(()=>{if(this.connectionState!==fe.a.CatchingUp)return;const e={protocolInitialized:void 0!==this.protocol,pendingClientId:this.pendingClientId,clientJoined:this.hasMember(this.pendingClientId),waitingForLeaveOp:this.waitingForLeaveOp};this.handler.logConnectionIssue("NoJoinOp","error",e)}))}get connectionState(){return this._connectionState}get clientId(){return this._clientId}get pendingClientId(){return this._pendingClientId}startJoinOpTimer(){Object(a.a)(!this.joinOpTimer.hasTimer,564),Object(a.a)(void 0!==this.connection,1203),this.joinOpTimer.start("write"===this.connection.mode?45e3:5e3)}stopJoinOpTimer(){Object(a.a)(this.joinOpTimer.hasTimer,565),this.joinOpTimer.clear()}get waitingForLeaveOp(){return this.prevClientLeftTimer.hasTimer}dispose(){Object(a.a)(!this.joinOpTimer.hasTimer,677),this.prevClientLeftTimer.clear()}containerSavedeceivedAddMemberEvent(e){e===this.pendingClientId?(this.joinOpTimer.hasTimer?this.stopJoinOpTimer():this.shouldWaitForJoinSignal()&&this.handler.logConnectionIssue("ReceivedJoinOp","generic"),this.waitingForLeaveOp&&(this.waitEvent=_.c.start(this.handler.logger,{eventName:"WaitBeforeClientLeave",details:JSON.stringify({waitOnClientId:this._clientId,hadOutstandingOps:this.handler.shouldClientJoinWrite()})})),this.applyForConnectedState("addMemberEvent")):e===this.clientId&&(Object(a.a)(!this.waitingForLeaveOp,1490),Object(a.a)(this.connectionState!==fe.a.Connected,1491),this.prevClientLeftTimer.restart())}applyForConnectedState(e){var t;Object(a.a)(void 0!==this.protocol,566),Object(a.a)(!this.waitingForLeaveOp||this.hasMember(this.clientId),738),this.pendingClientId!==this.clientId&&this.hasMember(this.pendingClientId)&&!this.waitingForLeaveOp?(null===(t=this.waitEvent)||void 0===t||t.end({source:e}),this.setConnectionState(fe.a.Connected)):this.handler.logger.sendTelemetryEvent({eventName:"connectedStateRejected",category:"timeout"===e&&this.connectionState!==fe.a.Disconnected?"error":"generic",details:JSON.stringify({source:e,pendingClientId:this.pendingClientId,clientId:this.clientId,waitingForLeaveOp:this.waitingForLeaveOp,clientJoined:this.hasMember(this.pendingClientId)})})}receivedRemoveMemberEvent(e){this.clientId===e&&(this.prevClientLeftTimer.clear(),this.applyForConnectedState("removeMemberEvent"))}receivedDisconnectEvent(e){this.connection=void 0,this.setConnectionState(fe.a.Disconnected,e)}shouldWaitForJoinSignal(){return Object(a.a)(void 0!==this.connection,1204),"write"===this.connection.mode||this.readClientsWaitForJoinSignal}receivedConnectEvent(e){this.connection=e;const t=this._connectionState;this._connectionState=fe.a.CatchingUp,this._pendingClientId=e.clientId,this.handler.connectionStateChanged(fe.a.CatchingUp,t),!this.hasMember(this._pendingClientId)&&this.shouldWaitForJoinSignal()?this.startJoinOpTimer():this.waitingForLeaveOp||this.setConnectionState(fe.a.Connected)}setConnectionState(e,t){var n,i;if(this.connectionState===e)return void this.handler.logger.sendErrorEvent({eventName:"setConnectionStateSame",value:e});const r=this._connectionState;let s;this._connectionState=e,void 0!==this._clientId&&(s=null===(i=null===(n=this.protocol)||void 0===n?void 0:n.quorum)||void 0===i?void 0:i.getMember(this._clientId)),e===fe.a.Connected?(Object(a.a)(r===fe.a.CatchingUp,472),void 0!==s&&(s.shouldHaveLeft=!0),this._clientId=this.pendingClientId):e===fe.a.Disconnected&&(this._pendingClientId=void 0,this.joinOpTimer.hasTimer&&this.stopJoinOpTimer(),void 0!==s&&this.handler.shouldClientJoinWrite()&&!this.waitingForLeaveOp?this.prevClientLeftTimer.restart():this.handler.logger.sendTelemetryEvent({eventName:"noWaitOnDisconnected",details:JSON.stringify({clientId:this._clientId,inQuorum:void 0!==s,waitingForLeaveOp:this.waitingForLeaveOp,hadOutstandingOps:this.handler.shouldClientJoinWrite()})})),this.handler.connectionStateChanged(this._connectionState,r,t)}get membershipnitProtocol(e){var t,n;this.protocol=e,null===(t=this.membership)||void 0===t||t.on("addMember",((t,n)=>{Object(a.a)("read"===n.mode||void 0!==e.quorum.getMember(t),1205),this.receivedAddMemberEvent(t)})),null===(n=this.membership)||void 0===n||n.on("removeMember",(t=>{Object(a.a)(void 0===e.quorum.getMember(t),1206),this.receivedRemoveMemberEvent(t)})),this.hasMember(this.pendingClientId)&&this.receivedAddMemberEvent(this.pendingClientId),void 0!==this.clientId&&this.hasMember(this.clientId)&&this.prevClientLeftTimer.restart()}hasMember(e){var t;return void 0!==(null===(t=this.membership)||void 0===t?void 0:t.getMember(null!=e?e:""))}}var Se=n("gczY"),Ce=n("9JcD");class we extends Z.a{constructor(e){super(e),super.setMaxListeners(50),this.propose=Object(Ce.a)(this,e.propose.bind(e)),this.has=Object(Ce.a)(this,e.has.bind(e)),this.get=Object(Ce.a)(this,e.get.bind(e)),this.getMembers=Object(Ce.a)(this,e.getMembers.bind(e)),this.getMember=Object(Ce.a)(this,e.getMember.bind(e))}}function Oe(e){return[["code",{key:"code",value:e,approvalSequenceNumber:0,commitSequenceNumber:0,sequenceNumber:0}]]}class Ie{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2e3,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50;this.submit=e,this.NoopCountFrequency=n,this.opsCountSinceNoop=0,t!==1/0&&(this.timer=new pe.b(t,(()=>{0!==this.opsCountSinceNoop&&this.submitNoop(!1)})))}scheduleSequenceNumberUpdate(e,t){t?this.submitNoop(!0):Object(U.c)(e)&&(this.opsCountSinceNoop++,this.opsCountSinceNoop===this.NoopCountFrequency&&Promise.resolve().then((()=>{this.opsCountSinceNoop>=this.NoopCountFrequency&&(this.submitNoop(!1),this.opsCountSinceNoop=0)})),void 0!==this.timer&&(1===this.opsCountSinceNoop&&this.timer.restart(),Object(a.a)(this.timer.hasTimer,578)))}submitNoop(e){this.submit(e?U.a.Accept:j.a.NoOp),Object(a.a)(0===this.opsCountSinceNoop,579)}stopSequenceNumberUpdate(){this.opsCountSinceNoop=0}}var Ne=n("zCUP"),Te=n("XPga");const Ee={fatalConnectError:!0},ke={mode:"read",details:{capabilities:{interactive:!0}},permission:[],user:{id:"storage-only client"},scopes:[]},je="storage-only client";class Pe extends M.a{constructor(){super(...arguments),this.clientId=je,this.claims={scopes:[Te.a.DocRead]},this.mode="read",this.existing=!0,this.maxMessageSize=0,this.version="",this.initialMessages=[],this.initialSignals=[],this.initialClients=[{client:ke,clientId:je}],this.serviceConfiguration={maxMessageSize:0,blockSize:0},this.checkpointSequenceNumber=void 0,this._disposed=!1}submit(e){this.emit("nack",this.clientId,e.map((e=>({operation:e,content:{message:"Cannot submit with storage-only connection",code:403}}))))}submitSignal(e){this.emit("nack",this.clientId,{operation:e,content:{message:"Cannot submit signal with storage-only connection",code:403}})}get disposed(){return this._disposed}dispose(){this._disposed=!0}}const _e=async()=>{var e;if(!1===(null===(e=globalThis.navigator)||void 0===e?void 0:e.onLine)&&void 0!==globalThis.addEventListener)return new Promise((e=>{const t=()=>{e(),globalThis.removeEventListener("online",t)};globalThis.addEventListener("online",t)}))};class Me{constructor(e,t,n,i,r,s){this.serviceProvider=e,this.containerDirty=t,this.client=n,this.logger=r,this.props=s,this._forceReadonly=!1,this.pendingReconnect=!1,this.clientSequenceNumber=0,this.clientSequenceNumberObserved=0,this.localOpsToIgnore=0,this.connectFirstConnection=!0,this._connectionVerboseProps={},this._connectionProps={},this._disposed=!1,this.opHandler=(e,t)=>{const n=Array.isArray(t)?t:[t];this.props.incomingOpHandler(n,"opHandler")},this.nackHandler=(e,t)=>{const n=t[0];if(!0===this._readonlyPermissions)return void this.props.closeHandler(Object(I.l)("writeOnReadOnlyDocument",{driverVersion:void 0}));const i=function(e){const t=`Nack (${e.type}): ${e.message}`,n=403!==e.code,i=void 0!==e.retryAfter?1e3*e.retryAfter:void 0;return Object(I.k)(t,{canRetry:n,retryAfterMs:i},{statusCode:e.code,driverVersion:void 0})}(n.content);i.canRetry?this.reconnectOnError("write",i):this.props.closeHandler(i)},this.disconnectHandlerInternal=e=>{this.reconnectOnError(this.defaultReconnectionMode,e)},this.errorHandler=this.clientDetails=this.client.details,this.defaultReconnectionMode=this.client.mode,this._reconnectMode=i?F.Enabled:F.Never,this._outbound=new $((e=>{if(void 0===this.connection)throw new Error("Attempted to submit an outbound message without connection");this.connection.submit(e)})),this._outbound.on("error",(e=>{this.props.closeHandler(Object(m.h)(e))}))}get connectionVerboseProps(){return this._connectionVerboseProps}t clientId(){var e;return null===(e=this.connection)||void 0===e?void 0:e.clientId}get reconnectMode(){return this._reconnectMode}et version(){if(void 0===this.connection)throw new Error("Cannot check version without a connection");return this.connection.version}get serviceConfiguration(){var e;return null===(e=this.connection)||void 0===e?void 0:e.serviceConfiguration}et outbound(){return this._outbound}get connectionProps(){return void 0!==this.connection?this._connectionProps:Object.assign(Object.assign({},this._connectionProps),{sentOps:this.clientSequenceNumber})}shouldJoinWrite(){const e=this.clientSequenceNumberObserved<this.clientSequenceNumber-this.localOpsToIgnore,t=this.containerDirty();return e!==t&&this.logger.sendTelemetryEvent({eventName:"DesiredConnectionModeMismatch",details:JSON.stringify({outstandingOps:e,isDirty:t})}),e||t}get readonly(){return this.readOnlyInfo.readonly}get readOnlyInfo(){const e=void 0!==this.connection&&this.connection instanceof Pe;return e||this._forceReadonly||!0===this._readonlyPermissions?{readonly:!0,forced:this._forceReadonly,permissions:this._readonlyPermissions,storageOnly:e}:{readonly:this._readonlyPermissions}}static detailsFromConnection(e){return{claims:e.claims,clientId:e.clientId,checkpointSequenceNumber:e.checkpointSequenceNumber,get initialClients(){return e.initialClients},mode:e.mode,serviceConfiguration:e.serviceConfiguration,version:e.version}}dispose(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._disposed||(this._disposed=!0,this.pendingConnection=void 0,this._reconnectMode=F.Never,this._outbound.clear(),this.disconnectFromDeltaStream("Closing DeltaManager"),t&&this.set_readonlyPermissions(!0))}setAutoReconnect(e){Object(a.a)(e!==F.Never&&this._reconnectMode!==F.Never,632),this._reconnectMode=e,e!==F.Enabled&&this.disconnectFromDeltaStream("setAutoReconnect")}forceReadonly(e){e!==this._forceReadonly&&this.logger.sendTelemetryEvent({eventName:"ForceReadOnly",value:e});const t=this.readonly;if(this._forceReadonly=e,t!==this.readonly){if(this._reconnectMode===F.Never)throw new f("API is not supported for non-connecting or closed container");let e=!1;!0===this.readonly&&(this.shouldJoinWrite()&&this.logger.sendErrorEvent({eventName:"ForceReadonlyPendingChanged"}),e=this.disconnectFromDeltaStream("Force readonly")),this.props.readonlyChangeHandler(this.readonly),e&&this.triggerConnect("read")}}set_readonlyPermissions(e){const t=this.readonly;this._readonlyPermissions=e,t!==this.readonly&&this.props.readonlyChangeHandler(this.readonly)}connect(e){this.connectCore(e).catch((e=>{const t=Object(m.h)(e,{props:Ee});this.props.closeHandler(t)}))}async connectCore(e){var t,n,i;if(Object(a.a)(!this._disposed,618),void 0!==this.connection)return;let r;void 0!==this.pendingConnection&&(r=this.pendingConnection.connectionMode,this.cancelConnection(),Object(a.a)(void 0===this.pendingConnection,836));let s=null!==(t=null!=e?e:r)&&void 0!==t?t:this.defaultReconnectionMode;this.shouldJoinWrite()&&(s="write");const o=this.serviceProvider();let l;if(Object(a.a)(void 0!==o,679),!0===(null===(n=o.policies)||void 0===n?void 0:n.storageOnly))return l=new Pe,this.setupNewSuccessfulConnection(l,"read"),void Object(a.a)(void 0===this.pendingConnection,691);let d=1e3,u=0;const h=c.a.now();let g;const p=new V.a,f=p.signal;for(this.pendingConnection={abort:connectionMode:s};void 0===l;){if(this._disposed)throw new Error("Attempting to connect a closed DeltaManager");if(!0===f.aborted)return void this.logger.sendTelemetryEvent({eventName:"ConnectionAttemptCancelled",attempts:u,duration:_.e.formatTick(c.a.now()-h),connectionEstablished:!1});u++;try{this.client.mode=s,l=await o.connectToDeltaStream(Object.assign(Object.assign({},this.client),{mode:s})),l.disposed&&(this.logger.sendTelemetryEvent({eventName:"ReceivedClosedConnection"}),l=void 0)}catch(e){if("object"==typeof e&&null!==e&&(null==e?void 0:e.errorType)===B.deltaStreamConnectionForbidden){l=new Pe,s="read";break}if(!Object(I.j)(e)){const t=Object(m.h)(e,{props:Ee});throw this.props.closeHandler(t),t}Object(Ne.a)(this.logger,{attempts:u,delay:d,eventName:"DeltaConnectionFailureToConnect",duration:_.e.formatTick(c.a.now()-h)},e),g=e;const t=Object(I.m)(e);void 0!==t?(this.props.reconnectionDelayHandler(t,e),await new Promise((e=>{setTimeout(e,t)}))):!1!==(null===(i=globalThis.navigator)||void 0===i?void 0:i.onLine)&&await new Promise((e=>{setTimeout(e,d),d=Math.min(2*d,8e3)})),await _e()}}if(u>1&&Object(Ne.a)(this.logger,{eventName:"MultipleDeltaConnectionFailures",attempts:u,duration:_.e.formatTick(c.a.now()-h)},g),!0===f.aborted)return l.dispose(),void this.logger.sendTelemetryEvent({eventName:"ConnectionAttemptCancelled",attempts:u,duration:_.e.formatTick(c.a.now()-h),connectionEstablished:!0});this.setupNewSuccessfulConnection(l,s)}isconnectFromDeltaStream(e){if(this.pendingReconnect=!1,void 0===this.connection)return void 0!==this.pendingConnection&&(this.cancelConnection(),!0);Object(a.a)(void 0===this.pendingConnection,635);const t=this.connection;return this.connection=void 0,t.off("op",this.opHandler),t.off("signal",this.props.signalHandler),t.off("nack",this.nackHandler),t.off("disconnect",this.disconnectHandlerInternal),t.off("error",this.errorHandler),t.off("pong",this.props.pongHandler),this._outbound.pause(),this._outbound.clear(),t.dispose(),this.props.disconnectHandler(e),this._connectionVerboseProps={},!0}cancelConnection(){Object(a.a)(void 0!==this.pendingConnection,837),this.pendingConnection.abort(),this.pendingConnection=void 0,this.logger.sendTelemetryEvent({eventName:"ConnectionCancelReceived"})}setupNewSuccessfulConnection(e,t){var n;Object(a.a)(void 0===this.connection,230),Object(a.a)(!e.disposed,650),this.pendingConnection=void 0,this.connection=e;const i=!e.claims.scopes.includes(Te.a.DocWrite);if(e.mode!==t&&this.logger.sendTelemetryEvent({eventName:"ConnectionModeMismatch",requestedMode:t,mode:e.mode}),Object(a.a)("read"===t||i===("read"===this.connectionMode),231),Object(a.a)(!i||"read"===this.connectionMode,232),this.set_readonlyPermissions(i),this._disposed)return void this.disconnectFromDeltaStream("ConnectionManager already closed");this._outbound.resume(),e.on("op",this.opHandler),e.on("signal",this.props.signalHandler),e.on("nack",this.nackHandler),e.on("disconnect",this.disconnectHandlerInternal),e.on("error",this.errorHandler),e.on("pong",this.props.pongHandler);const r=e.initialMessages.sort(((e,t)=>e.sequenceNumber-t.sequenceNumber));let s=e.checkpointSequenceNumber;this._connectionVerboseProps={clientId:e.clientId,mode:e.mode},this._connectionProps={},void 0!==e.relayServiceAgent&&(this._connectionVerboseProps.relayServiceAgent=e.relayServiceAgent,this._connectionProps.relayServiceAgent=e.relayServiceAgent),this._connectionProps.socketDocumentId=e.claims.documentId,this._connectionProps.connectionMode=e.mode;let o=-1;0!==r.length&&(this._connectionVerboseProps.connectionInitialOpsFrom=r[0].sequenceNumber,o=r[r.length-1].sequenceNumber,this._connectionVerboseProps.connectionInitialOpsTo=o+1,(void 0===s||s<o)&&(s=o)),this.props.incomingOpHandler(r,this.connectFirstConnection?"InitialOps":"ReconnectOps");const c=Me.detailsFromConnection(e);c.checkpointSequenceNumber=s,this.props.connectHandler(c),this.connectFirstConnection=!1;const l={clientId:null,content:JSON.stringify({type:K.Clear})};this.props.signalHandler(l);for(const t of null!==(n=e.initialClients)&&void 0!==n?n:[]){const e={clientId:null,content:JSON.stringify({type:K.ClientJoin,content:t})};this.props.signalHandler(e)}if(void 0!==e.initialSignals)for(const t of e.initialSignals)this.props.signalHandler(t)}reconnectOnError(e,t){this.reconnect(e,t.message,t).catch(this.props.closeHandler)}async reconnect(e,t,n){if(Object(a.a)(void 0!==this.connection,235),this.disconnectFromDeltaStream(t),void 0===n||n.canRetry||this.logger.sendTelemetryEvent({eventName:"reconnectingDespiteFatalError",reconnectMode:this.reconnectMode},n),this.reconnectMode===F.Never&&this.props.closeHandler(),this._disposed||this.reconnectMode!==F.Enabled)return;const i=Object(I.m)(n);void 0!==n&&void 0!==i&&(this.props.reconnectionDelayHandler(i,n),await new Promise((e=>{setTimeout(e,i)}))),await _e(),this.triggerConnect(e)}prepareMessageToSend(e){var t,n;if(!0!==this.readonly)return Object(a.a)(!!this.connection,228),this.lastSubmittedClientId!==(null===(t=this.connection)||void 0===t?void 0:t.clientId)&&(this.lastSubmittedClientId=null===(n=this.connection)||void 0===n?void 0:n.clientId,this.clientSequenceNumber=0,this.clientSequenceNumberObserved=0),Object(U.c)(e)?this.localOpsToIgnore=0:this.localOpsToIgnore++,Object.assign(Object.assign({},e),{clientSequenceNumber:++this.clientSequenceNumber});{Object(a.a)(!0===this.readOnlyInfo.readonly,496);const e=new g("deltaManagerReadonlySubmit",void 0,{readonly:this.readOnlyInfo.readonly,forcedReadonly:this.readOnlyInfo.forced,readonlyPermissions:this.readOnlyInfo.permissions,storageOnly:this.readOnlyInfo.storageOnly});this.props.closeHandler(e)}}submitSignal(e){void 0!==this.connection?this.connection.submitSignal(e):this.logger.sendErrorEvent({eventName:"submitSignalDisconnected"})}sendMessages(e){Object(a.a)(this.connected,692),"read"!==this.connectionMode?(Object(a.a)(!this.pendingReconnect,693),this._outbound.push(e)):this.pendingReconnect||(this.pendingReconnect=!0,Promise.resolve().then((async()=>{this.pendingReconnect&&await this.reconnect("write","Switch to write")})).catch((()=>{})))}beforeProcessingIncomingOp(e){if(Object(a.a)(this.clientId!==e.clientId||this.lastSubmittedClientId===e.clientId,238),void 0!==this.lastSubmittedClientId&&this.lastSubmittedClientId===e.clientId){const t=e.clientSequenceNumber;Object(a.a)(this.clientSequenceNumberObserved<t,239),Object(a.a)(t<=this.clientSequenceNumber,240),this.clientSequenceNumberObserved=t}e.type===j.a.ClientLeave&&JSON.parse(e.data)===this.clientId&&(this.logger.sendPerformanceEvent({eventName:"ReadConnectionTransition"}),this.reconnect("read","Switch to read").catch((e=>{this.logger.sendErrorEvent({eventName:"SwitchToReadConnection"},e)})))}}const De="saved";async function xe(e){if(e.closed)throw new f("waitContainerToCatchUp: Container closed");return new Promise(((t,n)=>{const i=e.deltaManager,r=t=>{e.off("closed",r);const i="Container closed while waiting to catch up";n(void 0!==t?Object(m.i)(t,():new g(i))};e.on("closed",r);const s=()=>{Object(a.a)(e.connectionState===fe.a.CatchingUp||e.connectionState===fe.a.Connected,205);const n=i.hasCheckpointSequenceNumber,s=i.lastKnownSeqNumber;if(Object(a.a)(i.lastSequenceNumber<=s,614),i.lastSequenceNumber===s)return e.off("closed",r),void t(n);const o=a=>{s<=a.sequenceNumber&&(e.off("closed",r),t(n),i.off("op",o))};i.on("op",o)};if(e.connectionState===fe.a.Connected)return void s();const o=e.on(P,o),e.connectionState===fe.a.Disconnected&&e.connect()}))}const Ae="summarizer";class Re extends D{constructor(e,t,n){var r,s,a;super(((e,t)=>{this.mc.logger.sendErrorEvent({eventName:"ContainerEventHandlerException",name:"string"==typeof e?e:void 0},t)})),this.loader=e,this.protocolHandlerBuilder=n,this._canReconnect=!0,this._lifecycleState="loading",this._attachState=i.Detached,this.inboundQueuePausedFromInit=!0,this.firstConnection=!0,this.connectionTransitionTimes=[],this.messageCountAfterDisconnection=0,this.attachStarted=!1,this._dirtyContainer=!1,this.savedOps=[],this.setAutoReconnectTime=c.a.now(),this._disposed=!1,this.clientDetailsOverride=t.clientDetailsOverride,this._resolvedUrl=t.resolvedUrl,void 0!==t.canReconnect&&(this._canReconnect=t.canReconnect);const l=this.client.details.type;this.subLogger=_.a.create(e.services.subLogger,void 0,{all:{clientType:`${this.client.details.capabilities.interactive?"interactive":"noninteractive"}${void 0!==l&&""!==l?`/${l}`:""}`,containerId:Object(o.a)(),docId:()=>{var e,t;return null!==(t=null===(e=this._resolvedUrl)||void 0===e?void 0:e.id)&&void 0!==t?t:void 0},containerAttachState:()=>this._attachState,containerLifecycleState:()=>this._lifecycleState,containerConnectionState:()=>fe.a[this.connectionState],serializedContainer:void 0!==t.serializedContainerState},error:{dmInitialSeqNumber:()=>{var e;return null===(e=this._deltaManager)||void 0===e?void 0:e.initialSequenceNumber},dmLastProcessedSeqNumber:()=>{var e;return null===(e=this._deltaManager)||void 0===e?void 0:e.lastSequenceNumber},dmLastKnownSeqNumber:()=>{var e;return null===(e=this._deltaManager)||void 0===e?void 0:e.lastKnownSeqNumber},containerLoadedFromVersionId:()=>{var e;return null===(e=this.loadedFromVersion)||void 0===e?void 0:e.id},containerLoadedFromVersionDate:dmLastMsqSeqNumber:()=>{var e,t;return null===(t=null===(e=this.deltaManager)||void 0===e?void 0:e.lastMessage)||void 0===t?void 0:t.sequenceNumber},dmLastMsqSeqTimestamp:()=>{var e,t;return null===(t=null===(e=this.deltaManager)||void 0===e?void 0:e.lastMessage)||void 0===t?void 0:t.timestamp},dmLastMsqSeqClientId:()=>{var e,t;return null===(t=null===(e=this.deltaManager)||void 0===e?void 0:e.lastMessage)||void 0===t?void 0:t.clientId},dmLastMsgClientSeq:()=>{var e,t;return null===(t=null===(e=this.deltaManager)||void 0===e?void 0:e.lastMessage)||void 0===t?void 0:t.clientSequenceNumber},connectionStateDuration:()=>c.a.now()-this.connectionTransitionTimes[this.connectionState]}}),this.mc=Object(x.c)(_.a.create(this.subLogger,"Container")),this.options=Object.assign({},this.loader.services.options),this._deltaManager=this.createDeltaManager(),this.connectionStateHandler=function(e,t,n){const i=Object(x.c)(e.logger);return function(e,t,n,i,r){return e?new ye(n,(,i):new be(n,t,r)}(!0===i.config.getBoolean("Fluid.Container.CatchUpBeforeDeclaringConnected"),!0===i.config.getBoolean("Fluid.Container.EnableJoinSignalWait"),e,t,n)}({logger:this.mc.logger,connectionStateChanged:(e,t,n)=>{e===fe.a.Connected&&(this._clientId=this.connectionStateHandler.pendingClientId),this.logConnectionStateChangeTelemetry(e,t,n),"loaded"===this._lifecycleState&&this.propagateConnectionState(!1,e===fe.a.Disconnected?n:void 0)},shouldClientJoinWrite:()=>this._deltaManager.connectionManager.shouldJoinWrite(),maxClientLeaveWaitTime:this.loader.services.options.maxClientLeaveWaitTime,logConnectionIssue:(e,t,n)=>{const i=this.connectionMode;this._deltaManager.logConnectionIssue(Object.assign({eventName:e,mode:i,category:"loading"===this._lifecycleState?"generic":t,duration:c.a.now()-this.connectionTransitionTimes[fe.a.CatchingUp]},void 0===n?{}:{details:JSON.stringify(n)})),"read"===i&&(this.disconnect(),this.connect())}},this.deltaManager,null===(r=t.serializedContainerState)||void 0===r?void 0:r.clientId),this.on(De,();const d=null!==(s=this.mc.config.getBoolean("Fluid.Container.summarizeProtocolTree2"))&&void 0!==s?s:this.loader.services.options.summarizeProtocolTree;this.storageAdapter=new ce(this.loader.services.detachedBlobStorage,this.mc.logger,null===(a=t.serializedContainerState)||void 0===a?void 0:a.snapshotBlobs,(e=>!0===Object(S.d)(e)?e:Object(S.a)(e,this.captureProtocolSummary())),d),"object"==typeof document&&null!==document&&"function"==typeof document.addEventListener&&null!==document.addEventListener&&(this.lastVisible=document.hidden?c.a.now():void 0,this.visibilityEventHandler=()=>{document.hidden?this.lastVisible=c.a.now():setTimeout((,0)},document.addEventListener("visibilitychange",this.visibilityEventHandler))}static async load(e,t,n,i){const r=new Re(e,{clientDetailsOverride:t.clientDetailsOverride,resolvedUrl:t.resolvedUrl,canReconnect:t.canReconnect,serializedContainerState:n},i);return _.c.timedExecAsync(r.mc.logger,{eventName:"Load"},(async e=>new Promise(((i,s)=>{var o,a;const c=t.version,l={opsBeforeReturn:"cached"},d=n?Object.assign(Object.assign({},null!==(o=t.loadMode)&&void 0!==o?o:l),{opsBeforeReturn:void 0}):null!==(a=t.loadMode)&&void 0!==a?a:l,u=e=>{s(null!=e?e:new g("Container closed without error during load"))};r.on("closed",u),r.load(c,d,n).finally(().then((n=>{e.end(Object.assign(Object.assign({},n),t.loadMode)),i(r)}),(e=>{const t=Object(m.h)(e);r.close(t),u(t)}))}))),{start:!0,end:!0,cancel:"generic"})}static async createDetached(e,t,n){const i=new Re(e,{},n);return _.c.timedExecAsync(i.mc.logger,{eventName:"CreateDetached"},(async e=>(await i.createDetached(t),i)),{start:!0,end:!0,cancel:"generic"})}static async rehydrateDetachedFromSnapshot(e,t,n){const i=new Re(e,{},n);return _.c.timedExecAsync(i.mc.logger,{eventName:"RehydrateDetachedFromSnapshot"},(async e=>{const n=JSON.parse(t);return await i.rehydrateDetachedFromSnapshot(n),i}),{start:!0,end:!0,cancel:"generic"})}setLoaded(){"loading"===this._lifecycleState&&(this.propagateConnectionState(!0),this._lifecycleState="loaded")}et storage(){return this.storageAdapter}get context(){if(void 0===this._context)throw new g("Attempted to access context before it was defined");return this._context}et connectionMode(){return this._deltaManager.connectionManager.connectionMode}get IFluidRouter(){return this}get resolvedUrl(){return this._resolvedUrl}get loadedFromVersion(){return this._loadedFromVersion}get readOnlyInfo(){return this._deltaManager.readOnlyInfo}get closeSignal(){return this._deltaManager.closeAbortController.signal}et deltaManager(){return this._deltaManager}get connectionState(){return this.connectionStateHandler.connectionState}et serviceConfiguration(){return this._deltaManager.serviceConfiguration}get clientId(){return this._clientId}get scopes(){return this._deltaManager.connectionManager.scopes}get clientDetails(){return this._deltaManager.clientDetails}get offlineLoadEnabled(){var e,t;return(null!==(e=this.mc.config.getBoolean("Fluid.Container.enableOfflineLoad"))&&void 0!==e?e:!0===(null===(t=this.options)||void 0===t?void 0:t.enableOfflineLoad))&&this.clientDetails.capabilities.interactive}t audience(){return this.protocolHandler.audience}get isDirty(){return this._dirtyContainer}get serviceFactory(){return this.loader.services.documentServiceFactory}get urlResolver(){return this.loader.services.urlResolver}get scope(){return this.loader.services.scope}sync getEntryPoint(){var e,t;if("disposing"===this._lifecycleState||"disposed"===this._lifecycleState)throw new f("The container is disposing or disposed");for(;void 0===this._context;)await new Promise(((e,t)=>{const n=()=>{e(),this.off("disposed",i)},i=e=>{t(null!=e?e:"The Container is disposed"),this.off("contextChanged",n)};this.once("contextChanged",n),this.once("disposed",i)})),Object(a.a)(void 0!==this._context,1442);return await(null===(t=(e=this._context).getEntryPoint)||void 0===t?void 0:t.call(e))}getQuorum(){return this.protocolHandler.quorum}dispose(e){this._deltaManager.close(e,!0),this.verifyClosed()}erifyClosed(){Object(a.a)(this.connectionState===fe.a.Disconnected,207),Object(a.a)("closed"===this._lifecycleState||"disposed"===this._lifecycleState,788)}closeCore(e){var t,n,i;Object(a.a)(!this.closed,789);try{try{this.mc.logger.sendTelemetryEvent({eventName:"ContainerClose",category:"loading"!==this._lifecycleState&&void 0!==e?"error":"generic"},e),this._lifecycleState="closing",null===(t=this._protocolHandler)||void 0===t||t.close(),this.connectionStateHandler.dispose(),null===(n=this._context)||void 0===n||n.dispose(void 0!==e?new Error(e.message):void 0),this.storageAdapter.dispose(),null===(i=this.service)||void 0===i||i.dispose(e)}catch(e){this.mc.logger.sendErrorEvent({eventName:"ContainerCloseException"},e)}this.emit("closed",e),void 0!==this.visibilityEventHandler&&document.removeEventListener("visibilitychange",this.visibilityEventHandler)}finally{this._lifecycleState="closed"}}disposeCore(e){var t,n,i;Object(a.a)(!this._disposed,1356),this._disposed=!0;try{try{this.mc.logger.sendTelemetryEvent({eventName:"ContainerDispose",category:"generic"},e),"closed"!==this._lifecycleState&&(this._lifecycleState="disposing"),null===(t=this._protocolHandler)||void 0===t||t.close(),this.connectionStateHandler.dispose(),null===(n=this._context)||void 0===n||n.dispose(void 0!==e?new Error(e.message):void 0),this.storageAdapter.dispose(),null===(i=this.service)||void 0===i||i.dispose(e)}catch(e){this.mc.logger.sendErrorEvent({eventName:"ContainerDisposeException"},e)}this.emit("disposed",e),this.removeAllListeners(),void 0!==this.visibilityEventHandler&&document.removeEventListener("visibilitychange",this.visibilityEventHandler)}finally{this._lifecycleState="disposed"}}etPendingLocalState(){if(!this.offlineLoadEnabled)throw new f("Can't get pending local state unless offline load is enabled");Object(a.a)(this.attachState===i.Attached,209),Object(a.a)(void 0!==this.resolvedUrl&&"fluid"===this.resolvedUrl.type,210),Object(a.a)(!!this.baseSnapshot,1492),Object(a.a)(!!this.baseSnapshotBlobs,1493);const e={pendingRuntimeState:this.context.getPendingLocalState(),baseSnapshot:this.baseSnapshot,snapshotBlobs:this.baseSnapshotBlobs,savedOps:this.savedOps,url:this.resolvedUrl.url,term:1,clientId:this.clientId};return this.mc.logger.sendTelemetryEvent({eventName:"GetPendingLocalState"}),JSON.stringify(e)}get attachState(){return this._attachState}serialize(){Object(a.a)(this.attachState===i.Detached,211);const e=this.context.createSummary(),t=this.captureProtocolSummary(),n=Object(S.a)(e,t);return this.loader.services.detachedBlobStorage&&this.loader.services.detachedBlobStorage.size>0&&(n.tree[".hasAttachmentBlobs"]={type:k.a.Blob,content:"true"}),JSON.stringify(n)}async attach(e){await _.c.timedExecAsync(this.mc.logger,{eventName:"Attach"},(async()=>{var t;if("loaded"!==this._lifecycleState)throw new f(`The Container is not in a valid state for attach [${this._lifecycleState}]`);Object(a.a)(this._attachState===i.Detached&&!this.attachStarted,517),this.attachStarted=!0;const n=void 0!==this.loader.services.detachedBlobStorage&&this.loader.services.detachedBlobStorage.size>0;try{let t;if(Object(a.a)(0===this.deltaManager.inbound.length,214),!n){const e=this.context.createSummary(),n=this.captureProtocolSummary();if(t=Object(S.a)(e,n),this._attachState=i.Attaching,this.emit("attaching"),this.offlineLoadEnabled){const e=Object(Se.b)(t);this.baseSnapshot=e,this.baseSnapshotBlobs=me(e)}}const r=await this.urlResolver.resolve(e);Object(C.a)(r),void 0===this.service&&(Object(a.a)(this.client.details.type!==Ae,708),this.service=await T((async()=>this.serviceFactory.createContainer(t,r,this.subLogger,!1)),"containerAttach",this.mc.logger,{cancel:this.closeSignal}));const s=this.service.resolvedUrl;if(Object(C.a)(s),this._resolvedUrl=s,await this.storageAdapter.connectToService(this.service),n){Object(a.a)(!!this.loader.services.detachedBlobStorage,590);const e=new Map;for(;e.size<this.loader.services.detachedBlobStorage.size;){const t=this.loader.services.detachedBlobStorage.getBlobIds().filter(();for(const n of t){const t=await this.loader.services.detachedBlobStorage.readBlob(n),i=await this.storageAdapter.createBlob(t);e.set(n,i.id)}}const n=this.context.createSummary(e),r=this.captureProtocolSummary();if(t=Object(S.a)(n,r),this._attachState=i.Attaching,this.emit("attaching"),this.offlineLoadEnabled){const e=Object(Se.b)(t);this.baseSnapshot=e,this.baseSnapshotBlobs=me(e)}await this.storageAdapter.uploadSummaryWithContext(t,{referenceSequenceNumber:0,ackHandle:void 0,proposalHandle:void 0})}this._attachState=i.Attached,this.emit("attached"),this.closed||this.resumeInternal({fetchOpsFromStorage:!1,reason:"createDetached"})}catch(e){const n=Object(m.h)(e),i=this.resolvedUrl;throw Object(C.b)(i)&&n.addTelemetryProperties({resolvedUrl:i.url}),this.close(n),null===(t=this.dispose)||void 0===t||t.call(this,n),n}}),{start:!0,end:!0,cancel:"generic"})}async request(e){return _.c.timedExecAsync(this.mc.logger,{eventName:"Request"},(,{end:!0,cancel:"error"})}setAutoReconnectInternal(e){if(this._deltaManager.connectionManager.reconnectMode===e)return;const t=c.a.now(),n=t-this.setAutoReconnectTime;this.setAutoReconnectTime=t,this.mc.logger.sendTelemetryEvent({eventName:e===F.Enabled?"AutoReconnectEnabled":"AutoReconnectDisabled",connectionMode:this.connectionMode,connectionState:fe.a[this.connectionState],duration:n}),this._deltaManager.connectionManager.setAutoReconnect(e)}connect(){if(this.closed)throw new f("The Container is closed and cannot be connected");if(this._attachState!==i.Attached)throw new f("The Container is not attached and cannot be connected");this.connected||this.connectInternal({reason:"DocumentConnect",fetchOpsFromStorage:!1})}connectInternal(e){Object(a.a)(!this.closed,709),Object(a.a)(this._attachState===i.Attached,710),this.resumeInternal(e),this.setAutoReconnectInternal(F.Enabled)}disconnectisconnectInternal(){Object(a.a)(!this.closed,711),this.setAutoReconnectInternal(F.Disabled)}resumeInternal(e){Object(a.a)(!this.closed,217),this.inboundQueuePausedFromInit&&(this.inboundQueuePausedFromInit=!1,this._deltaManager.inbound.resume(),this._deltaManager.inboundSignal.resume()),this.connectToDeltaStream(e)}async getAbsoluteUrl(e){var t;if(void 0!==this.resolvedUrl)return this.urlResolver.getAbsoluteUrl(this.resolvedUrl,e,(e=>{let t;return t=e&&"name"in e?e:d(null==e?void 0:e.package)?null==e?void 0:e.package.name:null==e?void 0:e.package,{name:t}})(null===(t=this._context)||void 0===t?void 0:t.codeDetails))}async proposeCodeDetails(e){if(!u(e))throw new Error("Provided codeDetails are not IFluidCodeDetails");if(this.codeLoader.IFluidCodeDetailsComparer){const t=await this.codeLoader.IFluidCodeDetailsComparer.compare(e,this.getCodeDetailsFromQuorum());if(void 0!==t&&t<=0)throw new Error("Proposed code details should be greater than the current")}return this.protocolHandler.quorum.propose("code",e).then((()=>!0)).catch(()}async processCodeProposal(){var e;const t=this.getCodeDetailsFromQuorum();if(await Promise.all([this.deltaManager.inbound.pause(),this.deltaManager.inboundSignal.pause()]),!0===await this.context.satisfies(t))return this.deltaManager.inbound.resume(),void this.deltaManager.inboundSignal.resume();const n=new g("Existing context does not satisfy incoming proposal");this.close(n),null===(e=this.dispose)||void 0===e||e.call(this,n)}async getVersion(e){return(await this.storageAdapter.getVersions(e,1))[0]}recordConnectStartTime(){void 0===this.connectionTransitionTimes[fe.a.Disconnected]&&(this.connectionTransitionTimes[fe.a.Disconnected]=c.a.now())}connectToDeltaStream(e){this.recordConnectStartTime(),this._canReconnect&&this.client.details.capabilities.interactive||(e.mode="write"),this._deltaManager.connect(e)}async load(e,t,n){var r;if(void 0===this._resolvedUrl)throw new Error("Attempting to load without a resolved url");this.service=await this.serviceFactory.createDocumentService(this._resolvedUrl,this.subLogger,this.client.details.type===Ae);const s={reason:"DocumentOpen",mode:"write",fetchOpsFromStorage:!1};void 0!==t.deltaConnection||n||this.connectToDeltaStream(s),n?this.storageAdapter.connectToService(this.service).catch((e=>{var t;this.close(e),null===(t=this.dispose)||void 0===t||t.call(this,e)})):await this.storageAdapter.connectToService(this.service),this._attachState=i.Attached;const{snapshot:o,versionId:c}=void 0===n?await this.fetchSnapshotTree(e):{snapshot:n.baseSnapshot,versionId:void 0};n?(this.baseSnapshot=n.baseSnapshot,this.baseSnapshotBlobs=n.snapshotBlobs):(Object(a.a)(void 0!==o,567),this.offlineLoadEnabled&&(this.baseSnapshot=o,this.baseSnapshotBlobs=await ue(o,this.storage)));const d=await this.getDocumentAttributes(this.storageAdapter,o),u=null===(r=null==n?void 0:n.savedOps[n.savedOps.length-1])||void 0===r?void 0:r.sequenceNumber,h=void 0!==u?Object.assign(Object.assign({},d),{sequenceNumber:u}):d;let m;switch(t.opsBeforeReturn){case void 0:this.attachDeltaManagerOpHandler(h,"none"!==t.deltaConnection?"all":"none");break;case"cached":m=this.attachDeltaManagerOpHandler(h,"cached");break;case"all":m=this.attachDeltaManagerOpHandler(h,"all");break;default:Object(l.a)(t.opsBeforeReturn)}await this.initializeProtocolStateFromSnapshot(d,this.storageAdapter,o);const g=this.getCodeDetailsFromQuorum();if(await this.instantiateContext(!0,g,o,null==n?void 0:n.pendingRuntimeState),n){for(const e of n.savedOps)this.processRemoteMessage(e),await this.context.notifyOpReplay(e);n.savedOps=[],Object(a.a)(void 0===this.clientId,1494),this._clientId=null==n?void 0:n.clientId}if(!this.closed)switch(void 0!==m&&(this._deltaManager.inbound.resume(),await _.c.timedExecAsync(this.mc.logger,{eventName:"WaitOps"},(),await _.c.timedExecAsync(this.mc.logger,{eventName:"WaitOpProcessing"},(),this._deltaManager.inbound.pause()),t.deltaConnection){case void 0:n&&this.connectToDeltaStream(s);case"delayed":Object(a.a)(this.inboundQueuePausedFromInit,838),this.inboundQueuePausedFromInit=!1,this._deltaManager.inbound.resume(),this._deltaManager.inboundSignal.resume();break;case"none":break;default:Object(l.a)(t.deltaConnection)}if(this.closed)throw new Error("Container was closed while load()");return this.setLoaded(),{sequenceNumber:d.sequenceNumber,version:c,dmLastProcessedSeqNumber:this._deltaManager.lastSequenceNumber,dmLastKnownSeqNumber:this._deltaManager.lastKnownSeqNumber}}async createDetached(e){const t={sequenceNumber:0,term:1,minimumSequenceNumber:0};await this.attachDeltaManagerOpHandler(t);const n=Oe(e);this.initializeProtocolState(t,{members:[],proposals:[],values:n}),await this.instantiateContextDetached(!1),this.setLoaded()}async rehydrateDetachedFromSnapshot(e){void 0!==e.tree[".hasAttachmentBlobs"]&&(Object(a.a)(!!this.loader.services.detachedBlobStorage&&this.loader.services.detachedBlobStorage.size>0,592),delete e.tree[".hasAttachmentBlobs"]);const t=Object(Se.b)(e);this.storageAdapter.loadSnapshotForRehydratingContainer(t);const n=await this.getDocumentAttributes(this.storageAdapter,t);await this.attachDeltaManagerOpHandler(n);const i=Object(Se.a)(t),r=function(e){const t=new Map(e).get("code");return Object(a.a)(void 0!==t,732),null==t?void 0:t.value}(await Object(E.a)(this.storageAdapter,i.blobs.quorumValues));this.initializeProtocolState(n,{members:[],proposals:[],values:void 0!==r?Oe(r):[]}),await this.instantiateContextDetached(!0,t),this.setLoaded()}async getDocumentAttributes(e,t){if(void 0===t)return{minimumSequenceNumber:0,sequenceNumber:0,term:1};const n=".protocol"in t.trees?t.trees[".protocol"].blobs.attributes:t.blobs[".attributes"];return await Object(E.a)(e,n)}async initializeProtocolStateFromSnapshot(e,t,n){const i={members:[],proposals:[],values:[]};if(void 0!==n){const e=Object(Se.a)(n);[i.members,i.proposals,i.values]=await Promise.all([Object(E.a)(t,e.blobs.quorumMembers),Object(E.a)(t,e.blobs.quorumProposals),Object(E.a)(t,e.blobs.quorumValues)])}this.initializeProtocolState(e,i)}initializeProtocolState(e,t){var n;const i=(null!==(n=this.protocolHandlerBuilder)&&void 0!==n?n:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return new J(...t,new R)})(e,t,((e,t)=>this.submitMessage(j.a.Propose,JSON.stringify({key:e,value:t})))),r=_.a.create(this.subLogger,"ProtocolHandler");i.quorum.on("error",(),this.connectionStateHandler.initProtocol(i),i.quorum.on("addProposal",(e=>{"code"!==e.key&&"code2"!==e.key||this.emit("codeDetailsProposed",e.value,e)})),i.quorum.on("approveProposal",((e,t,n)=>{"code"!==t&&"code2"!==t||(u(n)||this.mc.logger.sendErrorEvent({eventName:"CodeProposalNotIFluidCodeDetails"}),this.processCodeProposal().catch((e=>{var t;const n=Object(m.h)(e);throw this.close(n),null===(t=this.dispose)||void 0===t||t.call(this,n),e})))})),this._protocolHandler=i}captureProtocolSummary(){const e=this.protocolHandler.snapshot();return{tree:{attributes:{content:JSON.stringify(this.protocolHandler.attributes),type:k.a.Blob},quorumMembers:{content:JSON.stringify(e.members),type:k.a.Blob},quorumProposals:{content:JSON.stringify(e.proposals),type:k.a.Blob},quorumValues:{content:JSON.stringify(e.values),type:k.a.Blob}},type:k.a.Tree}}getCodeDetailsFromQuorum(){return(e=>{var t;return null!==(t=e.get("code"))&&void 0!==t?t:e.get("code2")})(this.protocolHandler.quorum)}get client(){var e;const t=void 0!==(null===(e=this.options)||void 0===e?void 0:e.client)?this.options.client:{details:{capabilities:{interactive:!0}},mode:"read",permission:[],scopes:[],user:{id:""}};return void 0!==this.clientDetailsOverride&&s()(t.details,this.clientDetailsOverride),t.details.environment=[t.details.environment,` loaderVersion:${ie.a}`].join(";"),t}activeConnection(){return this.connectionState===fe.a.Connected&&"write"===this.connectionMode}createDeltaManager(){const e=()=>this.service,t=new X(e,_.a.create(this.subLogger,"DeltaManager"),(,(t=>new Me(e,(,this.client,this._canReconnect,_.a.create(this.subLogger,"ConnectionManager"),t)));return t.inbound.pause(),t.inboundSignal.pause(),t.on("connect",((e,t)=>{Object(a.a)(this.connectionMode===e.mode,1207),this.connectionStateHandler.receivedConnectEvent(e)})),t.on("disconnect",(e=>{var t;null===(t=this.collabWindowTracker)||void 0===t||t.stopSequenceNumberUpdate(),this.closed||this.connectionStateHandler.receivedDisconnectEvent(e)})),t.on("throttled",(e=>{const t=e;!0!==t.logged&&this.mc.logger.sendTelemetryEvent({eventName:"ContainerWarning"},t),this.emit("warning",t)})),t.on("readonly",(e=>{this.setContextConnectedState(this.connectionState===fe.a.Connected,e),this.emit("readonly",e)})),t.on("closed",(e=>{this.closeCore(e)})),t.on("disposed",(e=>{this.disposeCore(e)})),t}async attachDeltaManagerOpHandler(e,t){return this._deltaManager.attachOpHandler(e.minimumSequenceNumber,e.sequenceNumber,{process:e=>this.processRemoteMessage(e),processSignal:e=>{this.processSignal(e)}},t)}logConnectionStateChangeTelemetry(e,t,n){var i;const r=c.a.now();this.connectionTransitionTimes[e]=r;const s=r-this.connectionTransitionTimes[t];let o,a,l,d,u;e===fe.a.Disconnected?l=this._deltaManager.connectionManager.reconnectMode:(e===fe.a.Connected?(o=r-this.connectionTransitionTimes[fe.a.Disconnected],o=_.e.formatTick(o)):(d=this.deltaManager.lastKnownSeqNumber,this.deltaManager.hasCheckpointSequenceNumber&&(u=d-this.deltaManager.lastSequenceNumber)),a=this.firstConnection?"InitialConnect":"AutoReconnect"),this.mc.logger.sendPerformanceEvent(Object.assign({eventName:`ConnectionStateChange_${fe.a[e]}`,from:fe.a[t],duration:s,durationFromDisconnected:o,reason:n,connectionInitiationReason:a,pendingClientId:this.connectionStateHandler.pendingClientId,clientId:this.clientId,autoReconnect:l,opsBehind:u,online:I.g[Object(I.o)()],lastVisible:void 0!==this.lastVisible?c.a.now()-this.lastVisible:void 0,checkpointSequenceNumber:d,quorumSize:null===(i=this._protocolHandler)||void 0===i?void 0:i.quorum.getMembers().size},this._deltaManager.connectionProps)),e===fe.a.Connected&&(this.firstConnection=!1)}propagateConnectionState(e,t){var n;if(!e&&this.connectionState!==fe.a.Connected&&this.connectionState!==fe.a.Disconnected)return;const i=this.connectionState===fe.a.Connected,r=this.connectionState===fe.a.Connected&&!this.firstConnection&&"write"===this.connectionMode;r&&(this.messageCountAfterDisconnection=0),this.setContextConnectedState(i,null!==(n=this.readOnlyInfo.readonly)&&void 0!==n&&n),this.protocolHandler.setConnectionState(i,this.clientId),function(e,t,n,i,r){try{n?t.emit(P,i):t.emit("disconnected",r)}catch(t){e.sendErrorEvent({eventName:"RaiseConnectedEventError"},t)}}(this.mc.logger,this,i,this.clientId,t),r&&this.mc.logger.sendTelemetryEvent({eventName:"OpsSentOnReconnect",count:this.messageCountAfterDisconnection})}submitContainerMessage(e,t,n,i){var r;switch(e){case j.a.Operation:return this.submitMessage(e,JSON.stringify(t),n,i);case j.a.Summarize:return this.submitSummaryMessage(t);default:{const t=new g("invalidContainerSubmitOpType",void 0,{messageType:e});return this.close(t),null===(r=this.dispose)||void 0===r||r.call(this,t),-1}}}submitBatch(e,t){let n=-1;for(const i of e)n=this.submitMessage(j.a.Operation,i.contents,!0,i.metadata,i.compression,t);return this._deltaManager.flush(),n}submitSummaryMessage(e,t){return void 0===e.details&&(e.details={}),e.details.includesProtocolTree=this.storageAdapter.summarizeProtocolTree,this.submitMessage(j.a.Summarize,JSON.stringify(e),!1,void 0,void 0,t)}submitMessage(e,t,n,i,r,s){var o;return this.connectionState!==fe.a.Connected?(this.mc.logger.sendErrorEvent({eventName:"SubmitMessageWithNoConnection",type:e}),-1):(this.messageCountAfterDisconnection+=1,null===(o=this.collabWindowTracker)||void 0===o||o.stopSequenceNumberUpdate(),this._deltaManager.submit(e,t,n,i,r,s))}processRemoteMessage(e){this.offlineLoadEnabled&&this.savedOps.push(e);const t=this.clientId===e.clientId,n=this.protocolHandler.processMessage(e,t);this.context.process(e,t),this.activeConnection()&&(void 0===this.collabWindowTracker&&(Object(a.a)(void 0!==this.serviceConfiguration,740),this.collabWindowTracker=new Ie((e=>{Object(a.a)(this.activeConnection(),577),this.submitMessage(e)}),this.serviceConfiguration.noopTimeFrequency,this.serviceConfiguration.noopCountFrequency)),this.collabWindowTracker.scheduleSequenceNumberUpdate(e,!0===n.immediateNoOp)),this.emit("op",e)}rocessSignal(e){null===e.clientId?this.protocolHandler.processSignal(e):this.context.processSignal(e,this.clientId===e.clientId)}async fetchSnapshotTree(e){var t;const n=await this.getVersion(null!=e?e:null);void 0===n&&void 0!==e&&this.mc.logger.sendErrorEvent({eventName:"NoVersionFoundWhenSpecified",id:e}),this._loadedFromVersion=n;const i=null!==(t=await this.storageAdapter.getSnapshotTree(n))&&void 0!==t?t:void 0;return void 0===i&&void 0!==n&&this.mc.logger.sendErrorEvent({eventName:"getSnapshotTreeFailed",id:n.id}),{snapshot:i,versionId:null==n?void 0:n.id}}async instantiateContextDetached(e,t){const n=this.getCodeDetailsFromQuorum();if(void 0===n)throw new Error("pkg should be provided in create flow!!");await this.instantiateContext(e,n,t)}async instantiateContext(e,t,n,i){var r;Object(a.a)(!1!==(null===(r=this._context)||void 0===r?void 0:r.disposed),221);const s=new ne.b(this,this.loader);this._context=await z.createOrLoad(this,this.scope,this.codeLoader,t,n,new te(this._deltaManager),new we(this.protocolHandler.quorum),s,(,((e,t)=>this.submitSummaryMessage(e,t)),(,(e=>this.submitSignal(e)),(e=>{var t;return null===(t=this.dispose)||void 0===t?void 0:t.call(this,e)}),(e=>this.close(e)),Re.version,(e=>this.updateDirtyContainerState(e)),e,i),this.emit("contextChanged",t)}updateDirtyContainerState(e){this._dirtyContainer!==e&&(this._dirtyContainer=e,this.emit(e?"dirty":De))}setContextConnectedState(e,t){var n;!1===(null===(n=this._context)||void 0===n?void 0:n.disposed)&&this.context.setConnectionState(e&&!t,this.clientId)}}Re.version="^0.1.0"},QzZJ:function(e,t,n){"use strict";var i=this&&this.__extends||);function r(e,t){if(Number.isFinite(e)&&Number.isFinite(t))return e-t;var n=typeof e,i=typeof t;if(n!==i)return n<i?-1:1;if("object"===n){if(null===e)return null===t?0:-1;if(null===t)return 1;if((n=typeof(e=e.valueOf()))!=(i=typeof(t=t.valueOf())))return n<i?-1:1}return e<t?-1:e>t?1:e===t?0:Number.isNaN(e)?Number.isNaN(t)?0:-1:Number.isNaN(t)?1:Array.isArray(e)?0:Number.NaN}Object.defineProperty(t,"__esModule",{value:!0}),t.EmptyBTree=t.asSet=t.simpleComparator=t.defaultComparator=void 0,t.defaultComparator=r,t.simpleComparator=var s=function(){function e(e,t,n){this._root=m,this._size=0,this._maxNodeSize=n>=4?Math.min(n,256):32,this._compare=t||r,e&&this.setPairs(e)}return Object.defineProperty(e.prototype,"size",{get:function(){return this._size},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"length",{get:function(){return this._size},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isEmpty",{get:enumerable:!1,configurable:!0}),e.prototype.clear=e.prototype.forEach=function(e,t){var n=this;return void 0!==t&&(e=e.bind(t)),this.forEachPair(()},e.prototype.forEachPair=function(e,t){var n=this.minKey(),i=this.maxKey();return this.forRange(n,i,!0,e,t)},e.prototype.get=e.prototype.set=function(e,t,n){this._root.isShared&&(this._root=this._root.clone());var i=this._root.set(e,t,n,this);return!0===i||!1===i?i:(this._root=new c([this._root,i]),!0)},e.prototype.has=function(e){return 0!==this.forRange(e,e,!0,void 0)},e.prototype.delete=function(e){return 0!==this.editRange(e,e,!0,u)},e.prototype.with=function(e,t,n){var i=this.clone();return i.set(e,t,n)||n?i:this},e.prototype.withPairs=function(e,t){var n=this.clone();return 0!==n.setPairs(e,t)||t?n:this},e.prototype.withKeys=function(e,t){for(var n=this.clone(),i=!1,r=0;r<e.length;r++)i=n.set(e[r],void 0,!1)||i;return t&&!i?this:n},e.prototype.without=function(e,t){return this.withoutRange(e,e,!0,t)},e.prototype.withoutKeys=function(e,t){var n=this.clone();return n.deleteKeys(e)||!t?n:this},e.prototype.withoutRange=function(e,t,n,i){var r=this.clone();return 0===r.deleteRange(e,t,n)&&i?this:r},e.prototype.filter=function(e,t){var n,i=this.greedyClone();return i.editAll((function(t,i,r){if(!e(t,i,r))return n=d})),!n&&t?this:i},e.prototype.mapValues=function(e){var t={},n=this.greedyClone();return n.editAll((function(n,i,r){return t.value=e(i,n,r),t})),n},e.prototype.reduce=function(e,t){for(var n,i=0,r=t,s=this.entries(this.minKey(),p);!(n=s.next()).done;)r=e(r,n.value,i++,this);return r},e.prototype.entries=function(e,t){var n=this.findPath(e);if(void 0===n)return o();var i=n.nodequeue,r=n.nodeindex,s=n.leaf,a=void 0!==t?1:0,c=void 0===e?-1:s.indexOf(e,0,this._compare)-1;return o((function(){e:for(;;)switch(a){case 0:if(++c<s.keys.length)return{done:!1,value:[s.keys[c],s.values[c]]};a=2;continue;case 1:if(++c<s.keys.length)return t[0]=s.keys[c],t[1]=s.values[c],{done:!1,value:t};a=2;case 2:for(var e=-1;;){if(++e>=i.length){a=3;continue e}if(++r[e]<i[e].length)break}for(;e>0;e--)i[e-1]=i[e][r[e]].children,r[e-1]=0;s=i[0][r[0]],c=-1,a=void 0!==t?1:0;continue;case 3:return{done:!0,value:void 0}}}))},e.prototype.entriesReversed=function(e,t,n){if(void 0===e&&(n=void 0,void 0===(e=this.maxKey())))return o();var i=this.findPath(e)||this.findPath(this.maxKey()),r=i.nodequeue,s=i.nodeindex,a=i.leaf;f(!r[0]||a===r[0][s[0]],"wat!");var c=a.indexOf(e,0,this._compare);!n&&c<a.keys.length&&this._compare(a.keys[c],e)<=0&&c++;var l=void 0!==t?1:0;return o((function(){e:for(;;)switch(l){case 0:if(--c>=0)return{done:!1,value:[a.keys[c],a.values[c]]};l=2;continue;case 1:if(--c>=0)return t[0]=a.keys[c],t[1]=a.values[c],{done:!1,value:t};l=2;case 2:for(var e=-1;;){if(++e>=r.length){l=3;continue e}if(--s[e]>=0)break}for(;e>0;e--)r[e-1]=r[e][s[e]].children,s[e-1]=r[e-1].length-1;c=(a=r[0][s[0]]).keys.length,l=void 0!==t?1:0;continue;case 3:return{done:!0,value:void 0}}}))},e.prototype.findPath=function(e){var t,n,i=this._root;if(i.isLeaf)t=g,n=g;else{t=[],n=[];for(var r=0;!i.isLeaf;r++){if(t[r]=i.children,n[r]=void 0===e?0:i.indexOf(e,0,this._compare),n[r]>=t[r].length)return;i=t[r][n[r]]}t.reverse(),n.reverse()}return{nodequeue:t,nodeindex:n,leaf:i}},e.prototype.diffAgainst=function(t,n,i,r){if(t._compare!==this._compare)throw new Error("Tree comparators are not the same.");if(this.isEmpty||t.isEmpty){if(this.isEmpty&&t.isEmpty)return;return this.isEmpty?void 0===i?void 0:e.stepToEnd(e.makeDiffCursor(t),i):void 0===n?void 0:e.stepToEnd(e.makeDiffCursor(this),n)}for(var s=this._compare,o=e.makeDiffCursor(this),a=e.makeDiffCursor(t),c=!0,l=!0,d=e.compare(o,a,s);c&&l;){var u=e.compare(o,a,s),h=o.leaf,m=o.internalSpine,g=o.levelIndices,p=a.leaf,f=a.internalSpine,v=a.levelIndices;if(h||p){if(0!==d)if(0===u){if(h&&p&&r){var y=h.values[g[g.length-1]],b=p.values[v[v.length-1]];if(!Object.is(y,b)&&(S=r(o.currentKey,y,b))&&S.break)return S.break}}else if(u>0){if(p&&i&&(S=i(a.currentKey,p.values[v[v.length-1]]))&&S.break)return S.break}else if(n){var S;if(h&&0!==d&&(S=n(o.currentKey,y=h.values[g[g.length-1]]))&&S.break)return S.break}}else if(!h&&!p&&0===u){var C=m.length-1,w=f.length-1;if(f[w][v[w]]===m[C][g[C]]){d=0,c=e.step(o,!0),l=e.step(a,!0);continue}}d=u,u<0?c=e.step(o):l=e.step(a)}return c&&n?e.finishCursorWalk(o,a,s,n):l&&i?e.finishCursorWalk(a,o,s,i):void 0},e.finishCursorWalk=function(t,n,i,r){var s=e.compare(t,n,i);if(0===s){if(!e.step(t))return}else s<0&&f(!1,"cursor walk terminated early");return e.stepToEnd(t,r)},e.stepToEnd=function(t,n){for(var i=!0;i;){var r=t.leaf,s=t.levelIndices;if(r){var o=n(t.currentKey,r.values[s[s.length-1]]);if(o&&o.break)return o.break}i=e.step(t)}},e.makeDiffCursor=function(e){var t=e._root;return{height:e.height,internalSpine:[[t]],levelIndices:[0],leaf:void 0,currentKey:t.maxKey()}},e.step=function(e,t){var n=e.internalSpine,i=e.levelIndices,r=e.leaf;if(!0===t||r){var s=i.length;if(!0===t||0===i[s-1]){var o=n.length;if(0===o)return!1;for(var a=o-1,c=a;c>=0;){if(i[c]>0)return c<s-1&&(e.leaf=void 0,i.pop()),c<a&&(e.internalSpine=n.slice(0,c+1)),e.currentKey=n[c][--i[c]].maxKey(),!0;c--}return!1}var l=--i[s-1];return e.currentKey=r.keys[l],!0}var d=n.length,u=d-1,h=n[u][i[u]];if(h.isLeaf)e.leaf=h,l=i[d]=h.values.length-1,e.currentKey=h.keys[l];else{var m=h.children;n[d]=m;var g=m.length-1;i[d]=g,e.currentKey=m[g].maxKey()}return!0},e.compare=function(e,t,n){var i=e.height,r=e.levelIndices,s=t.height,o=t.levelIndices,a=n(t.currentKey,e.currentKey);if(0!==a)return a;var c=i<s?i:s;return r.length-(i-c)-(o.length-(s-c))},e.prototype.keys=function(e){var t=this.entries(e,p);return o((function(){var e=t.next();return e.value&&(e.value=e.value[0]),e}))},e.prototype.values=function(e){var t=this.entries(e,p);return o((function(){var e=t.next();return e.value&&(e.value=e.value[1]),e}))},Object.defineProperty(e.prototype,"maxNodeSize",{get:function(){return this._maxNodeSize},enumerable:!1,configurable:!0}),e.prototype.minKey=function(){return this._root.minKey()},e.prototype.maxKey=function(){return this._root.maxKey()},e.prototype.clone=function(){this._root.isShared=!0;var t=new e(void 0,this._compare,this._maxNodeSize);return t._root=this._root,t._size=this._size,t},e.prototype.greedyClone=function(t){var n=new e(void 0,this._compare,this._maxNodeSize);return n._root=this._root.greedyClone(t),n._size=this._size,n},e.prototype.toArray=function(e){void 0===e&&(e=2147483647);var t=this.minKey(),n=this.maxKey();return void 0!==t?this.getRange(t,n,!0,e):[]},e.prototype.keysArray=function(){var e=[];return this._root.forRange(this.minKey(),this.maxKey(),!0,!1,this,0,(function(t,n){e.push(t)})),e},e.prototype.valuesArray=function(){var e=[];return this._root.forRange(this.minKey(),this.maxKey(),!0,!1,this,0,(),e},e.prototype.toString=e.prototype.setIfNotPresent=e.prototype.nextHigherPair=function(e,t){return t=t||[],void 0===e?this._root.minPair(t):this._root.getPairOrNextHigher(e,this._compare,!1,t)},e.prototype.nextHigherKey=function(e){var t=this.nextHigherPair(e,p);return t&&t[0]},e.prototype.nextLowerPair=function(e,t){return t=t||[],void 0===e?this._root.maxPair(t):this._root.getPairOrNextLower(e,this._compare,!1,t)},e.prototype.nextLowerKey=function(e){var t=this.nextLowerPair(e,p);return t&&t[0]},e.prototype.getPairOrNextLower=function(e,t){return this._root.getPairOrNextLower(e,this._compare,!0,t||[])},e.prototype.getPairOrNextHigher=function(e,t){return this._root.getPairOrNextHigher(e,this._compare,!0,t||[])},e.prototype.changeIfPresent=function(e,t){return 0!==this.editRange(e,e,!0,()},e.prototype.getRange=function(e,t,n,i){void 0===i&&(i=67108863);var r=[];return this._root.forRange(e,t,n,!1,this,0,(function(e,t){return r.push([e,t]),r.length>i?h:void 0})),r},e.prototype.setPairs=function(e,t){for(var n=0,i=0;i<e.length;i++)this.set(e[i][0],e[i][1],t)&&n++;return n},e.prototype.forRange=function(e,t,n,i,r){var s=this._root.forRange(e,t,n,!1,this,r||0,i);return"number"==typeof s?s:s.break},e.prototype.editRange=function(e,t,n,i,r){var s=this._root;s.isShared&&(this._root=s=s.clone());try{var o=s.forRange(e,t,n,!0,this,r||0,i);return"number"==typeof o?o:o.break}finally{for(var a=void 0;s.keys.length<=1&&!s.isLeaf;)a||(a=s.isShared),this._root=s=0===s.keys.length?m:s.children[0];a&&(s.isShared=!0)}},e.prototype.editAll=function(e,t){return this.editRange(this.minKey(),this.maxKey(),!0,e,t)},e.prototype.deleteRange=e.prototype.deleteKeys=function(e){for(var t=0,n=0;t<e.length;t++)this.delete(e[t])&&n++;return n},Object.defineProperty(e.prototype,"height",{get:function(){for(var e=this._root,t=-1;e;)t++,e=e.isLeaf?void 0:e.children[0];return t},enumerable:!1,configurable:!0}),e.prototype.freeze=function(){var e=this;e.clear=e.set=e.editRange=,e.prototype.unfreeze=Object.defineProperty(e.prototype,"isFrozen",{get:enumerable:!1,configurable:!0}),e.prototype.checkValid=function(){var e=this._root.checkValid(0,this,0);f(e===this.size,"size mismatch: counted ",e,"but stored",this.size)},e}();function o(e){void 0===e&&(e=;var t={next:e};return Symbol&&Symbol.iterator&&(t[Symbol.iterator]=function(){return this}),t}t.default=s,t.asSet=Symbol&&Symbol.iterator&&(s.prototype[Symbol.iterator]=s.prototype.entries),s.prototype.where=s.prototype.filter,s.prototype.setRange=s.prototype.setPairs,s.prototype.add=s.prototype.set;var a=function(){function e(e,t){void 0===e&&(e=[]),this.keys=e,this.values=t||l,this.isShared=void 0}return Object.defineProperty(e.prototype,"isLeaf",{get:enumerable:!1,configurable:!0}),e.prototype.maxKey=e.prototype.indexOf=function(e,t,n){for(var i=this.keys,r=0,s=i.length,o=s>>1;r<s;){var a=n(i[o],e);if(a<0)r=o+1;else{if(!(a>0)){if(0===a)return o;if(e==e)return i.length;throw new Error("BTree: NaN was used as a key")}s=o}o=r+s>>1}return o^t},e.prototype.minKey=e.prototype.minPair=function(e){if(0!==this.keys.length)return e[0]=this.keys[0],e[1]=this.values[0],e},e.prototype.maxPair=function(e){if(0!==this.keys.length){var t=this.keys.length-1;return e[0]=this.keys[t],e[1]=this.values[t],e}},e.prototype.clone=function(){var t=this.values;return new e(this.keys.slice(0),t===l?t:t.slice(0))},e.prototype.greedyClone=function(e){return this.isShared&&!e?this:this.clone()},e.prototype.get=function(e,t,n){var i=this.indexOf(e,-1,n._compare);return i<0?t:this.values[i]},e.prototype.getPairOrNextLower=function(e,t,n,i){var r=this.indexOf(e,-1,t),s=r<0?~r-1:n?r:r-1;if(s>=0)return i[0]=this.keys[s],i[1]=this.values[s],i},e.prototype.getPairOrNextHigher=function(e,t,n,i){var r=this.indexOf(e,-1,t),s=r<0?~r:n?r:r+1,o=this.keys;if(s<o.length)return i[0]=o[s],i[1]=this.values[s],i},e.prototype.checkValid=function(e,t,n){var i=this.keys.length,r=this.values.length;return f(this.values===l?i<=r:i===r,"keys/values length mismatch: depth",e,"with lengths",i,r,"and baseIndex",n),f(0==e||i>0,"empty leaf at depth",e,"and baseIndex",n),i},e.prototype.set=function(e,t,n,i){var r=this.indexOf(e,-1,i._compare);if(r<0){if(r=~r,i._size++,this.keys.length<i._maxNodeSize)return this.insertInLeaf(r,e,t,i);var s=this.splitOffRightSide(),o=this;return r>this.keys.length&&(r-=this.keys.length,o=s),o.insertInLeaf(r,e,t,i),s}return!1!==n&&(void 0!==t&&this.reifyValues(),this.keys[r]=e,this.values[r]=t),!1},e.prototype.reifyValues=function(){return this.values===l?this.values=this.values.slice(0,this.keys.length):this.values},e.prototype.insertInLeaf=function(e,t,n,i){if(this.keys.splice(e,0,t),this.values===l){for(;l.length<i._maxNodeSize;)l.push(void 0);if(void 0===n)return!0;this.values=l.slice(0,this.keys.length-1)}return this.values.splice(e,0,n),!0},e.prototype.takeFromRight=function(e){var t=this.values;e.values===l?t!==l&&t.push(void 0):(t=this.reifyValues()).push(e.values.shift()),this.keys.push(e.keys.shift())},e.prototype.takeFromLeft=function(e){var t=this.values;e.values===l?t!==l&&t.unshift(void 0):(t=this.reifyValues()).unshift(e.values.pop()),this.keys.unshift(e.keys.pop())},e.prototype.splitOffRightSide=function(){var t=this.keys.length>>1;return new e(this.keys.splice(t),this.values===l?l:this.values.splice(t))},e.prototype.forRange=function(e,t,n,i,r,s,o){var a,c,d=r._compare;if(t===e){if(!n)return s;if(c=(a=this.indexOf(e,-1,d))+1,a<0)return s}else a=this.indexOf(e,0,d),(c=this.indexOf(t,-1,d))<0?c=~c:!0===n&&c++;var u=this.keys,h=this.values;if(void 0!==o)for(var m=a;m<c;m++){var g=u[m],p=o(g,h[m],s++);if(void 0!==p){if(!0===i){if(g!==u[m]||!0===this.isShared)throw new Error("BTree illegally changed or cloned in editRange");p.delete?(this.keys.splice(m,1),this.values!==l&&this.values.splice(m,1),r._size--,m--,c--):p.hasOwnProperty("value")&&(h[m]=p.value)}if(void 0!==p.break)return p}}else s+=c-a;return s},e.prototype.mergeSibling=function(e,t){if(this.keys.push.apply(this.keys,e.keys),this.values===l){if(e.values===l)return;this.values=this.values.slice(0,this.keys.length)}this.values.push.apply(this.values,e.reifyValues())},e}(),c=function(e){function t(t,n){var i=this;if(!n){n=[];for(var r=0;r<t.length;r++)n[r]=t[r].maxKey()}return(i=e.call(this,n)||this).children=t,i}return i(t,e),t.prototype.clone=function(){for(var e=this.children.slice(0),n=0;n<e.length;n++)e[n].isShared=!0;return new t(e,this.keys.slice(0))},t.prototype.greedyClone=function(e){if(this.isShared&&!e)return this;for(var n=new t(this.children.slice(0),this.keys.slice(0)),i=0;i<n.children.length;i++)n.children[i]=n.children[i].greedyClone(e);return n},t.prototype.minKey=t.prototype.minPair=t.prototype.maxPair=t.prototype.get=function(e,t,n){var i=this.indexOf(e,0,n._compare),r=this.children;return i<r.length?r[i].get(e,t,n):void 0},t.prototype.getPairOrNextLower=function(e,t,n,i){var r=this.indexOf(e,0,t),s=this.children;if(r>=s.length)return this.maxPair(i);var o=s[r].getPairOrNextLower(e,t,n,i);return void 0===o&&r>0?s[r-1].maxPair(i):o},t.prototype.getPairOrNextHigher=function(e,t,n,i){var r=this.indexOf(e,0,t),s=this.children,o=s.length;if(!(r>=o)){var a=s[r].getPairOrNextHigher(e,t,n,i);return void 0===a&&r<o-1?s[r+1].minPair(i):a}},t.prototype.checkValid=function(e,t,n){var i=this.keys.length,r=this.children.length;f(i===r,"keys/children length mismatch: depth",e,"lengths",i,r,"baseIndex",n),f(i>1||e>0,"internal node has length",i,"at depth",e,"baseIndex",n);for(var s=0,o=this.children,a=this.keys,c=0,l=0;l<r;l++)f((s+=o[l].checkValid(e+1,t,n+s))>=(c+=o[l].keys.length),"wtf",n),f(0===l||o[l-1].constructor===o[l].constructor,"type mismatch, baseIndex:",n),o[l].maxKey()!=a[l]&&f(!1,"keys[",l,"] =",a[l],"is wrong, should be ",o[l].maxKey(),"at depth",e,"baseIndex",n),0===l||t._compare(a[l-1],a[l])<0||f(!1,"sort violation at depth",e,"index",l,"keys",a[l-1],a[l]);var d=0===c;return(d||c>t.maxNodeSize*r)&&f(!1,d?"too few":"too many","children (",c,s,") at depth",e,"maxNodeSize:",t.maxNodeSize,"children.length:",r,"baseIndex:",n),s},t.prototype.set=function(e,t,n,i){var r,s=this.children,o=i._maxNodeSize,a=i._compare,c=Math.min(this.indexOf(e,0,a),s.length-1),l=s[c];l.isShared&&(s[c]=l=l.clone()),l.keys.length>=o&&(c>0&&(r=s[c-1]).keys.length<o&&a(l.keys[0],e)<0?(r.isShared&&(s[c-1]=r=r.clone()),r.takeFromRight(l),this.keys[c-1]=r.maxKey()):void 0!==(r=s[c+1])&&r.keys.length<o&&a(l.maxKey(),e)<0&&(r.isShared&&(s[c+1]=r=r.clone()),r.takeFromLeft(l),this.keys[c]=s[c].maxKey()));var d=l.set(e,t,n,i);if(!1===d)return!1;if(this.keys[c]=l.maxKey(),!0===d)return!0;if(this.keys.length<o)return this.insert(c+1,d),!0;var u=this.splitOffRightSide(),h=this;return a(d.maxKey(),this.maxKey())>0&&(h=u,c-=this.keys.length),h.insert(c+1,d),u},t.prototype.insert=function(e,t){this.children.splice(e,0,t),this.keys.splice(e,0,t.maxKey())},t.prototype.splitOffRightSide=function(){var e=this.children.length>>1;return new t(this.children.splice(e),this.keys.splice(e))},t.prototype.takeFromRight=function(e){this.keys.push(e.keys.shift()),this.children.push(e.children.shift())},t.prototype.takeFromLeft=function(e){this.keys.unshift(e.keys.pop()),this.children.unshift(e.children.pop())},t.prototype.forRange=function(e,t,n,i,r,s,o){var a=r._compare,c=this.keys,l=this.children,d=this.indexOf(e,0,a),u=d,h=Math.min(t===e?d:this.indexOf(t,0,a),c.length-1);if(i){if(u<=h)try{for(;u<=h;u++){if(l[u].isShared&&(l[u]=l[u].clone()),g=l[u].forRange(e,t,n,i,r,s,o),c[u]=l[u].maxKey(),"number"!=typeof g)return g;s=g}}finally{var m=r._maxNodeSize>>1;for(d>0&&d--,u=h;u>=d;u--)l[u].keys.length<=m&&(0!==l[u].keys.length?this.tryMerge(u,r._maxNodeSize):(c.splice(u,1),l.splice(u,1)));0!==l.length&&0===l[0].keys.length&&f(!1,"emptiness bug")}}else for(;u<=h;u++){var g;if("number"!=typeof(g=l[u].forRange(e,t,n,i,r,s,o)))return g;s=g}return s},t.prototype.tryMerge=function(e,t){var n=this.children;return e>=0&&e+1<n.length&&n[e].keys.length+n[e+1].keys.length<=t&&(n[e].isShared&&(n[e]=n[e].clone()),n[e].mergeSibling(n[e+1],t),n.splice(e+1,1),this.keys.splice(e+1,1),this.keys[e]=n[e].maxKey(),!0)},t.prototype.mergeSibling=function(e,t){var n=this.keys.length;this.keys.push.apply(this.keys,e.keys);var i=e.children;if(this.children.push.apply(this.children,i),e.isShared&&!this.isShared)for(var r=0;r<i.length;r++)i[r].isShared=!0;this.tryMerge(n-1,t)},t}(a),l=[],d={delete:!0},u=function(){return d},h={break:!0},m=),g=[],p=[];function f(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];if(!e)throw t.unshift("B+ tree"),new Error(t.join(" "))}t.EmptyBTree=)},R8iU:function(e,t,n){"use strict";(function(t){r r={resolve:normalize:isAbsolute:join:relative:function(e,t){if(n(e),n(t),e===t)return"";if((e=r.resolve(e))===(t=r.resolve(t)))return"";for(var i=1;i<e.length&&47===e.charCodeAt(i);++i);for(var s=e.length,o=s-i,a=1;a<t.length&&47===t.charCodeAt(a);++a);for(var c=t.length-a,l=o<c?o:c,d=-1,u=0;u<=l;++u){if(u===l){if(c>l){if(47===t.charCodeAt(a+u))return t.slice(a+u+1);if(0===u)return t.slice(a+u)}else o>l&&(47===e.charCodeAt(i+u)?d=u:0===u&&(d=0));break}var h=e.charCodeAt(i+u);if(h!==t.charCodeAt(a+u))break;47===h&&(d=u)}var m="";for(u=i+d+1;u<=s;++u)u!==s&&47!==e.charCodeAt(u)||(m+=0===m.length?"..":"/..");return m.length>0?m+t.slice(a+d):(47===t.charCodeAt(a+=d)&&++a,t.slice(a))},_makeLong:function(e){return e},dirname:basename:extname:format:parse:function(e){n(e);var t={root:"",dir:"",base:"",ext:"",name:""};if(0===e.length)return t;var i,r=e.charCodeAt(0),s=47===r;s?(t.root="/",i=1):i=0;for(var o=-1,a=0,c=-1,l=!0,d=e.length-1,u=0;d>=i;--d)if(47!==(r=e.charCodeAt(d)))-1===c&&(l=!1,c=d+1),46===r?-1===o?o=d:1!==u&&(u=1):-1!==o&&(u=-1);else if(!l){a=d+1;break}return-1===o||-1===c||0===u||1===u&&o===c-1&&o===a+1?-1!==c&&(t.base=t.name=e.slice(0===a&&s?1:a,c)):(0===a&&s?(t.name=e.slice(1,o),t.base=e.slice(1,c)):(t.name=e.slice(a,o),t.base=e.slice(a,c)),t.ext=e.slice(o,c)),a>0?t.dir=e.slice(0,a-1):s&&(t.dir="/"),t},sep:"/",delimiter:":",win32:null,posix:null};r.posix=r,e.exports=r}).call(this,n("5IsQ"))},RLzy:function(e,t,n){"use strict";n.d(t,"b",(function(){return s})),n.d(t,"a",(function(){return o}));var i=n("f79D"),r=n("rtkY");function s(e){switch(e.type){case i.a.ClientJoin:case i.a.ClientLeave:case i.a.Propose:case i.a.Reject:case i.a.NoOp:case i.a.NoClient:case i.a.Summarize:case i.a.SummaryAck:case i.a.SummaryNack:return!0;default:return!1}}class o{constructor(e,t,n,i,s,o,a){this.minimumSequenceNumber=e,this.sequenceNumber=t,this.term=null!=n?n:1,this._quorum=new r.a(i,s,o,a)}get quorum(){return this._quorum}etConnectionState(e,t){this._quorum.setConnectionState(e,t)}snapshot(){return this._quorum.snapshot()}close(){this._quorum.close()}processMessage(e,t){if(e.sequenceNumber!==this.sequenceNumber+1)throw new Error(`Protocol state is not moving sequentially. Current is ${this.sequenceNumber}. Next is ${e.sequenceNumber}`);this.sequenceNumber=e.sequenceNumber,this.minimumSequenceNumber=e.minimumSequenceNumber;let n=!1;switch(e.type){case i.a.ClientJoin:const r=e,s=JSON.parse(r.data);this._quorum.addMember(s.clientId,{client:s.detail,sequenceNumber:r.sequenceNumber});break;case i.a.ClientLeave:const o=JSON.parse(e.data);this._quorum.removeMember(o);break;case i.a.Propose:"string"==typeof e.contents&&(e.contents=JSON.parse(e.contents));const a=e.contents;this._quorum.addProposal(a.key,a.value,e.sequenceNumber,t,e.clientSequenceNumber),n=!0}return this._quorum.updateMinimumSequenceNumber(e),{immediateNoOp:n}}getProtocolState(){return Object.assign({sequenceNumber:this.sequenceNumber,minimumSequenceNumber:this.minimumSequenceNumber},this._quorum.snapshot())}}},"RW/s":function(e,t,n){var i=n("iOq2"),r=n("HE1N"),s=n("VZJX"),o=n("J9xP"),a=n("PHxc");function c(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var i=e[t];this.set(i[0],i[1])}}c.prototype.clear=i,c.prototype.delete=r,c.prototype.get=s,c.prototype.has=o,c.prototype.set=a,e.exports=c},RoC8:RqPZ:SHde:SN9N:SyCk:T2h0:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gcDeletedBlobKey=t.gcTombstoneBlobKey=t.gcBlobPrefix=t.gcTreeKey=void 0,t.gcTreeKey="gc",t.gcBlobPrefix="__gc",t.gcTombstoneBlobKey="__tombstones",t.gcDeletedBlobKey="__deletedNodes"},T9Ud:THQi:TQ2W:function(e,t,n){var i=n("y0Qj"),r=2654435761,s=2246822519,o=3266489917,a=374761393;function c(e,t){return(e|=0)>>>(32-(t|=0)|0)|e<<t|0}function l(e,t,n){return 0|i.imul((e|=0)>>>(32-(t|=0)|0)|e<<t,n|=0)}function d(e,t){return(e|=0)>>>(t|=0)^e|0}function u(e,t,n,r,s){return l(i.imul(t,n)+e,r,s)}function h(e,t,n){return l(e+i.imul(t[n],a),11,r)}function m(e,t,n){return u(e,i.readU32(t,n),o,17,668265263)}function g(e,t,n){return[u(e[0],i.readU32(t,n+0),s,13,r),u(e[1],i.readU32(t,n+4),s,13,r),u(e[2],i.readU32(t,n+8),s,13,r),u(e[3],i.readU32(t,n+12),s,13,r)]}t.hash=function(e,t,n,l){var u,p;if(p=l,l>=16){for(u=[e+r+s,e+s,e,e-r];l>=16;)u=g(u,t,n),n+=16,l-=16;u=c(u[0],1)+c(u[1],7)+c(u[2],12)+c(u[3],18)+p}else u=e+a+l>>>0;for(;l>=4;)u=m(u,t,n),n+=4,l-=4;for(;l>0;)u=h(u,t,n),n++,l--;return(u=d(i.imul(d(i.imul(d(u,15),s),13),o),16))>>>0}},TsNJ:UKnr:ULPR:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));,UPAM:function(e,t,n){"use strict";n.d(t,"b",(function(){return g})),n.d(t,"a",(function(){return p}));var i,r=n("A3AF");!function(e){e.cache="fluid-cache",e.clientDetails="fluid-client-details",e.loadMode="loadMode",e.reconnect="fluid-reconnect",e.sequenceNumber="fluid-sequence-number",e.version="version"}(i||(i={}));var s=n("ambg"),o=n("rK/e"),a=n("Gstq"),c=n("AJa+");class l extends c.e{constructor(e,t,n){super(void 0,n),this.debug=e,this.debugErr=t}static create(e,t){const n=Object(a.debug)(e),i=Object(a.debug)(e);return i.log=function(){n.enabled?a.debug.log(...arguments):console.error(...arguments)},i.enabled=!0,new l(n,i,t)}static mixinDebugLogger(e,t,n){if(!t)return l.create(e,n);const i=new c.b(void 0,n);return i.addLogger(l.create(e,this.tryGetBaseLoggerProps(t))),i.addLogger(c.a.create(t,e)),i}static tryGetBaseLoggerPropsend(e){const t=this.prepareEvent(e),n="error"===t.category;let i=n?this.debugErr:this.debug;const r=e.eventName.lastIndexOf(c.e.eventNamespaceSeparator),s=e.eventName.substring(r+1);r>0&&(i=i.extend(e.eventName.substring(0,r))),t.eventName=void 0;let a="";a=`tick=${c.e.formatTick(o.a.now())}`;const l=t.stack?t.stack:"";let d;t.stack=void 0;try{d=JSON.stringify(t)}catch(e){t.error=void 0,d=JSON.stringify(t)}"{}"===d&&(d=""),n&&(i.enabled=!0),i(`${s} ${d} ${a} ${l}`)}}var d=n("qQRf"),u=n("QnlE"),h=n("gczY"),m=n("NAKK");class g{constructor(e,t){this.container=e,this.loader=t}get IFluidRouter(){return this}async resolve(e){var t,n,r,s,o;if(e.url.startsWith("/")){if(function(e){return void 0===e.headers||!1!==e.headers[i.cache]}(e))return this.container;{const a=this.container.resolvedUrl;return Object(d.a)(a),await u.a.load(this.loader,{canReconnect:null===(t=e.headers)||void 0===t?void 0:t[i.reconnect],clientDetailsOverride:null===(n=e.headers)||void 0===n?void 0:n[i.clientDetails],resolvedUrl:Object.assign({},a),version:null!==(s=null===(r=e.headers)||void 0===r?void 0:r[i.version])&&void 0!==s?s:void 0,loadMode:null===(o=e.headers)||void 0===o?void 0:o[i.loadMode]})}}if(void 0===this.loader)throw new Error("Cannot resolve external containers");return this.loader.resolve(e)}async request(e){return e.url.startsWith("/")?(await this.resolve(e)).request(e):void 0===this.loader?{status:404,value:"Cannot request external containers",mimeType:"plain/text"}:this.loader.request(e)}}class p{constructor(e){var t,n;this.containers=new Map;const i=Object.assign({},e.scope);!1!==(null===(t=e.options)||void 0===t?void 0:t.provideScopeLoader)&&(i.ILoader=this);const o={loaderId:Object(r.a)(),loaderVersion:m.a},a=Object(s.d)(l.mixinDebugLogger("fluid:telemetry",e.logger,{all:o}),s.e.value,e.configProvider);this.services={urlResolver:e.urlResolver,documentServiceFactory:e.documentServiceFactory,codeLoader:e.codeLoader,options:null!==(n=e.options)&&void 0!==n?n:{},scope:i,subLogger:a.logger,detachedBlobStorage:e.detachedBlobStorage},this.mc=Object(s.c)(c.a.create(this.services.subLogger,"Loader")),this.protocolHandlerBuilder=e.protocolHandlerBuilder}get IFluidRouter(){return this}async createDetachedContainer(e){const t=await u.a.createDetached(this,e,this.protocolHandlerBuilder);return this.cachingEnabled&&t.once("attached",(()=>{Object(d.a)(t.resolvedUrl);const e=Object(h.c)(t.resolvedUrl.url);void 0!==e&&this.addToContainerCache(e.id,Promise.resolve(t))})),t}async rehydrateDetachedContainerFromSnapshot(e){return u.a.rehydrateDetachedFromSnapshot(this,e,this.protocolHandlerBuilder)}async resolve(e,t){return c.c.timedExecAsync(this.mc.logger,{eventName:void 0===t?"Resolve":"ResolveWithPendingState"},(async()=>(await this.resolveCore(e,void 0!==t?JSON.parse(t):void 0)).container))}async request(e){return c.c.timedExecAsync(this.mc.logger,{eventName:"Request"},(async()=>{const t=await this.resolveCore(e);return t.container.request(Object.assign(Object.assign({},e),{url:`${t.parsed.path}${t.parsed.query}`}))}))}getKeyForContainerCache(e,t){var n;return void 0!==(null===(n=e.headers)||void 0===n?void 0:n[i.version])?`${t.id}@${e.headers[i.version]}`:t.id}addToContainerCache(e,t){this.containers.set(e,t),t.then((t=>{t.closed?this.containers.delete(e):t.once("closed",(()=>{this.containers.delete(e)}))})).catch((e=>{}))}async resolveCore(e,t){const n=await this.services.urlResolver.resolve(e);Object(d.a)(n);const i=Object(h.c)(n.url);if(void 0===i)throw new Error(`Invalid URL ${n.url}`);if(void 0!==t){const e=Object(h.c)(t.url);if((null==e?void 0:e.id)!==i.id||(null==e?void 0:e.path.replace(/\/$/,""))!==i.path.replace(/\/$/,""))throw new Error(`URL ${n.url} does not match pending state URL ${t.url}`)}const{canCache:r,fromSequenceNumber:s}=this.parseHeader(i,e);let o;if(void 0===t&&r){const t=this.getKeyForContainerCache(e,i),r=await this.containers.get(t);if(void 0!==r)o=r;else{const i=this.loadContainer(e,n);this.addToContainerCache(t,i),o=await i}}else o=await this.loadContainer(e,n,t);return o.deltaManager.lastSequenceNumber<=s&&await new Promise(((e,t)=>{o.on("op",(function t(n){n.sequenceNumber>s&&(e(),o.removeListener("op",t))}))})),{container:o,parsed:i}}get cachingEnabledanCacheForRequest(e){return this.cachingEnabled&&!1!==e[i.cache]}parseHeader(e,t){var n,r;let s=-1;t.headers=null!==(n=t.headers)&&void 0!==n?n:{};const o=t.headers[i.sequenceNumber];return void 0!==o&&(s=o),t.headers[i.version]=null!==(r=e.version)&&void 0!==r?r:t.headers[i.version],{canCache:this.canCacheForRequest(t.headers),fromSequenceNumber:s}}async loadContainer(e,t,n){var r,s,o,a,c;return u.a.load(this,{canReconnect:null===(r=e.headers)||void 0===r?void 0:r[i.reconnect],clientDetailsOverride:null===(s=e.headers)||void 0===s?void 0:s[i.clientDetails],resolvedUrl:t,version:null!==(a=null===(o=e.headers)||void 0===o?void 0:o[i.version])&&void 0!==a?a:void 0,loadMode:null===(c=e.headers)||void 0===c?void 0:c[i.loadMode]},n,this.protocolHandlerBuilder)}}},UgeB:function(e,t,n){var i=n("GI0s"),r=n("T9Ud");e.exports=function(e){return r(e)&&"[object Arguments]"==i(e)}},V2ZB:VNQV:function(e,t,n){var i=n("LSEb")(n("s3UK"),"DataView");e.exports=i},VZJX:Vujp:WAeH:function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n("5IsQ"),r=n("I4it");function s(){return r.a?performance.now():1e3*Object(i.uptime)()}},"WMT/":WRuO:WS3M:function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n("qDpI"),r=n("ESz4");class s extends r.a{constructor(e,t){super(null!=e?e:"Not Found",!1,null!=t?t:"NotFound",i.g.NotFound)}}},WjON:"X/0h":XPga:function(e,t,n){"use strict";var i;n.d(t,"a",(function(){return i})),function(e){e.DocRead="doc:read",e.DocWrite="doc:write",e.SummaryWrite="summary:write"}(i||(i={}))},XXCu:XxIN:function(e,t,n){"use strict";n.d(t,"c",(function(){return o})),n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return c}));var i=n("he5V"),r=n("NsUA");const s=2147483647;function o(e,t,n){let i;if(t>s){const r=t-s;i=setTimeout((()=>o(e,r,n)),s)}else i=setTimeout((()=>e()),Math.max(t,0));return null==n||n(i),i}class a{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:()=>Date.now();this.defaultTimeout=e,this.defaultHandler=t,this.getCurrentTick=n}tart(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.defaultTimeout;this.startCore(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.defaultHandler,e)}clear(){this.runningState&&(clearTimeout(this.runningState.timeout),this.runningState=void 0)}restart(e,t){var n,i;if(this.runningState){const r=null!=e?e:this.runningState.intendedDuration,s=null!==(i=null!=t?t:null===(n=this.runningState.restart)||void 0===n?void 0:n.handler)&&void 0!==i?i:this.runningState.handler,o=this.calculateRemainingTime(this.runningState);r<o?this.start(r,s):r===o?(this.runningState.handler=s,this.runningState.restart=void 0,this.runningState.intendedDuration=r):this.runningState.restart={startTick:this.getCurrentTick(),duration:r,handler:s}}else this.start(e,t)}startCore(e,t,n){this.clear(),this.runningState={startTick:this.getCurrentTick(),duration:e,intendedDuration:n,handler:t,timeout:o((()=>this.handler()),e,(e=>{void 0!==this.runningState&&(this.runningState.timeout=e)}))}}handler(){Object(i.a)(!!this.runningState,10);const e=this.runningState.restart;if(void 0!==e){const t=this.calculateRemainingTime(e);this.startCore(t,(()=>e.handler()),e.duration)}else{const e=this.runningState.handler;this.clear(),e()}}calculateRemainingTime(e){const t=this.getCurrentTick()-e.startTick;return e.duration-t}}class c{constructor(e,t){this.timer=new a(e,(()=>this.wrapHandler(t)))}get hasTimer(){return this.timer.hasTimer}async start(e,t){return this.clear(),this.deferred=new r.a,this.timer.start(e,t?()=>this.wrapHandler(t):void 0),this.deferred.promise}clear(){this.timer.clear(),this.deferred&&(this.deferred.resolve({timerResult:"cancel"}),this.deferred=void 0)}wrapHandler(e){e(),Object(i.a)(!!this.deferred,11),this.deferred.resolve({timerResult:"timeout"}),this.deferred=void 0}}},YaJL:YzAP:function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var i=n("bgLm"),r=n("3M/p"),s=n("QjXU"),o=function(e){return"number"==typeof e},a=function(){return Date.now()};"object"==typeof window&&"object"==typeof window.performance&&"function"==typeof window.performance.now&&(a=;var c="Event",l=".",d=!1;function u(e){return"object"==typeof e}function h(e,t,n){for(var i="",r="",s=0,o=e;s<o.length;s++){var a=i+r+JSON.stringify(o[s]);if(a.length>t)break;i=a,n.sp+=1,r="\n"}return i}unction g(e,t){Object(i.b)(e,1,(function(){return"WebSink:"+t}))}var p=function(){function e(e){this.preprocessors=[],this.stats=function(){var e;return(e={}).q=0,e.po={},e.pw=0,e.wa=0,e.wp=0,e.wd=0,e.wr={},e.ws=0,e.pm=0,e.sp=0,e.ss=0,e.sd=0,e.pd={},e.md=0,e.d=0,e.b=0,e.s=0,e}(),this._batchInterval=1e3,this._queueSize=500,this._queue=[],this.enabled=!0,e&&e.queueSize&&(this._queueSize=e.queueSize)}return e.prototype.init=function(e,t){return e.endpointUrl&&t.uuid&&t.getWorker?(e.uploadFrequency&&(this._batchInterval=e.uploadFrequency),this._props=e,this._utils=t,!0):(this.enabled=!1,),!1)},e.prototype.isInitialized=function(){if(this.enabled){if(this._props)return!0;m(1)}return!1},e.prototype.mergeStats=function(e){var t=this;Object.keys(e).forEach((function(n){o(t.stats[n])?o(e[n])?t.stats[n]+=e[n]:t.stats[n]=e[n]:n==="wr".toString()&&Object.keys(e.wr).forEach((function(n){t.stats.wr[n]=t.stats.wr[n]+e.wr||e.wr[n]}))}))},e.prototype.startWorker=function(){var e=this;if(this.isInitialized()){this.stats.s=1;try{this._worker=this._utils.getWorker(),this._worker.addEventListener("message",(function(t){var n=t.data;switch(n.t){case 1:e.handleLoadedMessage();break;case 4:e.mergeStats(n.d);break;case 5:m(n.d);break;default:m(14)}})),this._worker.addEventListener("error",(function(t){m(12),1===e.stats.s&&e.failToStartWorker()})),this._worker.addEventListener("errormessage",()}catch(e){m(10),this.failToStartWorker()}}},e.prototype.handleLoadedMessage=function(){this.isInitialized()&&(this.stats.s=2,Object(i.b)(2,1,(function(){return"WebSink:Loaded"})),this._worker.postMessage({t:2,d:this._props}),this.flushQueue())},e.prototype.failToStartWorker=e.prototype.flushQueue=function(){var e=a();try{var t=this._queue.length;t&&(this.stats.pw+=t,this._worker.postMessage({t:3,d:this._queue}))}catch(e){m(11)}finally{this._queue=[],this.stats.md+=a()-e,this._queueTimeout&&clearTimeout(this._queueTimeout),this._queueTimeout=setTimeout(this.flushQueue.bind(this),this._batchInterval)}},e.prototype.preprocess=function(e){for(var t=0;t<this.preprocessors.length;t++){var n=this.preprocessors[t],i=n.name,s=!1,o=a();try{s=n.processEvent(e)}catch(e){}var c=a()-o;if(this.stats.pd[i]=this.stats.pd[i]+c||c,!s)return this.stats.po[i]=this.stats.po[i]+1||1,!1}return e.dataFields.push(Object(r.d)("OTelJS.Sink","WebSink")),!0},e.prototype.queueEvent=function(e){2===this.stats.s||this._queue.length<this._queueSize?(this.stats.q+=1,this._queue.push(e)):(m(3),this.stats.s=3,this.shutdown(!1))},e.prototype.sendTelemetryEvent=function(e){this.enabled&&this.preprocess(e)&&this.queueEvent({event:e,t:1})},e.prototype.sendCustomerContent=function(e){this.enabled&&this.preprocess(e)&&this.queueEvent({event:e,t:2})},e.prototype.shutdown=function(e){if(this.isInitialized())try{this.stats.pm=this._queue.length,function(e,t,n){if(d)Object(i.b)(0,1,(function(){return"OTelJSMin:20"}));else try{var r=function(e,t,n){var i,r;function a(e,t,n,i){var r,a=t,c=0;if(void 0!==a&&""!==a){switch(o(t)&&(c=6),n){case 3:c=6;break;case 2:c=4;break;case 4:c=8;break;case"dt":c=9;break;case 0:a="string"==typeof a?a.substr(0,25e3):a}if(h){for(var d=i.data,m=i.ext.metadata,g=0;g<e.length-1;){var p=e[g];if(!p)return;if(d[p]){if(!u(d))return}else d[p]={};d=d[p];var f=m.f||{};f[p]||(f[p]={}),m.f=f,m=f[p],g++}var v=e[g];u(d)&&!u(d[v])&&(d[v]=a,c&&(m.f=Object(s.__assign)(Object(s.__assign)({},m.f),((r={})[v]={t:c},r))))}else{var y=e.join(l);i.data[y]=t,c&&(i.ext.metadata.f[y]={t:c})}}}function d(e,t,n){e&&e.forEach((function(e){var i=e.classification;if(4===i||1===i){var r=e.name.split(l);"zC"!==r[0]&&(t&&r.unshift("Data"),a(r,e.value,e.dataType,n))}}))}var h=!0===(null===(r=null===(i=e.extensionConfig)||void 0===i?void 0:i.PostChannel)||void 0===r?void 0:r.enableCompoundKey),m=[],g={},p=t.uuid(),f=e.minSinkLimit;f=o(f)?f:500;var v=n.slice(0,f),y=t.stats.pw+1;return v.forEach((function(t){var n=t.event.telemetryProperties.ariaTenantToken,i=function(t,n,i,r){if(1===t.t){var s=t.event,o=s.timestamp,u=(o?new Date(o):new Date).toISOString(),h=s.eventFlags.diagnosticLevel;if(e.enableOptionalEvents||10===h||110===h||120===h){var m=s.eventName,g={name:m,time:u,ver:"4.0",iKey:"o:"+n.substr(0,32),ext:{sdk:{seq:i},metadata:{f:{}}},data:{}};a([c,"Source"],"OTelJS",0,g),a(["baseData","properties","version"],"OTelJSMin=4.8.14",0,g),d(e.persistentDataFields,!1,g),a([c,"Name"],m,0,g),a([c,"Sequence"],i,2,g),a([c,"Time"],u,"dt",g),a([c,"Id"],r+l+i,0,g);var p="custom",f=s.eventContract;if(f){var v=f.name;a([c,"Contract"],v,0,g),p+=l+v.toLowerCase().replace(/\./g,"_"),d(f.dataFields,!1,g)}return g.data.baseType=p,d(s.dataFields,!0,g),g}}}(t,n,y,p);i&&(m.push(i),g[n]=!0,y+=1)})),[m,Object.keys(g)]}(e,t,n),a=r[0],m=r[1];if(0===a.length||0===m.length)return;var g=e.endpointUrl+"?cors=true&content-type=application/x-json-stream&apikey="+m.join(),p=t.stats;t.useSendBeacon?function(e,t,n){var i=t.length;if(Boolean(null===navigator||void 0===navigator?void 0:navigator.sendBeacon)){var r=if(r(e,h(t,65536,n)))n.ss=n.sp;else{for(var s=0;s<i&&r(e,JSON.stringify(t[s]));)s++;n.ss=s,n.sd=n.sp-s}}else n.sd=i}(g,a,p):function(e,t,n){var i=h(t,4194304,n),r=new XMLHttpRequest;r.onload=function(){var e=r.responseText;if(e){var t=JSON.parse(e);t.acc&&(n.ss+=parseInt(t.acc,10)),t.rej&&(n.sd+=parseInt(t.rej,10))}},r.onerror=r.open("POST",e),r.send(i)}(g,a,p),d=!0}catch(e){Object(i.b)(0,1,(function(){return"OTelJSMin:22"}))}}(this._props,{uuid:this._utils.uuid,useSendBeacon:e,stats:this.stats},this._queue),this._queue=[]}catch(e){m(30)}this.enabled=!1,this._queueTimeout&&clearTimeout(this._queueTimeout)},e}()},Yzgk:ZkeI:function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n("Xou4");async function r(e,t){const n=await e.readBlob(t),r=Object(i.c)(n,"utf8");return JSON.parse(r)}},a5cT:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.totalBlobSizePropertyName=t.blobCountPropertyName=t.channelsTreeName=t.CreateSummarizerNodeSource=void 0,function(e){e[e.FromSummary=0]="FromSummary",e[e.FromAttach=1]="FromAttach",e[e.Local=2]="Local"}(t.CreateSummarizerNodeSource||(t.CreateSummarizerNodeSource={})),t.channelsTreeName=".channels",t.blobCountPropertyName="BlobCount",t.totalBlobSizePropertyName="TotalBlobSize"},aBIM:function(e,t,n){var i=n("zcvR");e.exports=function(e){return i(this,e).get(e)}},ambg:function(e,t,n){"use strict";n.d(t,"e",(function(){return s})),n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return h})),n.d(t,"c",(function(){return m})),n.d(t,"d",(function(){return g}));var i=n("O9x+"),r=n("AJa+");const s=new i.a((()=>a(d()))),o={getRawConfig:()=>{}},a=e=>null!=e?new u(void 0,{getRawConfig:t=>{var n,i;try{return null===(i=l(null!==(n=e.getItem(t))&&void 0!==n?n:void 0))||void 0===i?void 0:i.raw}catch(e){}}}):o;function c(e){switch(e){case"boolean":case"number":case"string":return!0;default:return!1}}function l(e){let t,n=e;if("string"==typeof e)try{n=JSON.parse(e),t={raw:e,string:e}}catch(e){}if(void 0===n)return t;const i=typeof n;if(c(i))return Object.assign(Object.assign({},t),{raw:e,[i]:n});if(Array.isArray(n)){const i=typeof n[0];if(!c(i))return t;for(const e of n)if(typeof e!==i)return t;return Object.assign(Object.assign({},t),{raw:e,[`${i}[]`]:n})}return t}const d=()=>{var e;try{return null!==(e=globalThis.sessionStorage)&&void 0!==e?e:void 0}catch(e){return}};class u{constructor(e){this.logger=e,this.configCache=new Map,this.orderedBaseProviders=[];const t=new Set;for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];const s=[...i];for(;s.length>0;){const e=s.shift();void 0!==e&&p(e)&&!t.has(e)&&(t.add(e),e instanceof u?s.push(...e.orderedBaseProviders):this.orderedBaseProviders.push(e))}}getBoolean(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.boolean}getNumber(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.number}getString(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.string}getBooleanArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["boolean[]"]}getNumberArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["number[]"]}getStringArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["string[]"]}getRawConfig(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.raw}getCacheEntry(e){var t;if(!this.configCache.has(e)){for(const n of this.orderedBaseProviders){const i=l(null==n?void 0:n.getRawConfig(e));if(void 0!==i)return this.configCache.set(e,i),null===(t=this.logger)||void 0===t||t.send({category:"generic",eventName:"ConfigRead",configName:{tag:r.d.CodeArtifact,value:e},configValue:{tag:r.d.CodeArtifact,value:JSON.stringify(i)}}),i}this.configCache.set(e,{raw:void 0})}return this.configCache.get(e)}}function h(e){const t=e;return p(null==t?void 0:t.config)&&void 0!==(null==t?void 0:t.logger)}function m(e){return h(e)?e:g(e,s.value)}function g(e){if(h(e))throw new Error("Logger is already a monitoring context");const t=e;for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];return t.config=new u(e,...i),t.logger=e,t}function p(e){return"function"==typeof(null==e?void 0:e.getRawConfig)}},b2OE:function(e,t,n){var i=n("LSEb")(n("s3UK"),"Set");e.exports=i},bE7W:bOrJ:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gcDeletedBlobKey=t.gcTombstoneBlobKey=t.gcBlobPrefix=t.gcTreeKey=void 0,t.gcTreeKey="gc",t.gcBlobPrefix="__gc",t.gcTombstoneBlobKey="__tombstones",t.gcDeletedBlobKey="__deletedNodes"},bim0:cGWa:function(e,t,n){"use strict";function i(e){return 0===e.byteOffset&&e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}n.d(t,"a",(function(){return i}))},ckUF:cm7J:czZE:function(e,t,n){"use strict";(function(e,i){n.d(t,"a",(function(){return O})),n.d(t,"b",(function(){return T}));var r=n("3M/p"),s=n("aI0E"),o=n("bgLm"),a=n("av1u"),c=n("aCzR"),l=n("J78o"),d=n("svub"),u=n("YzAP"),h=n("A3AF"),m=n("fDqU"),g=n("O7fF"),p=n("WAeH"),f=n("I4it"),v=n("4KXX"),y=n("G1vT"),b=n("+BZq"),S=n("9hJ/"),C=n("ULPR"),w=n("1Yvd");const O=10,I=.005,N=[];class T{constructor(t){this.getContext=()=>this.context,this.setContext=(e,t,n)=>{this.context=e,this.eventNamePrefix=this.getAriaInfoFromService(e.serviceLoggingInfo).namespacePrefix,this.isTelemetryEnabled()&&this.initializeOtelLogger(e,t,n)},this.scheduleSendingActivities=()=>{this.isRequestIdleCallbackScheduled=!0,f.a?window.requestIdleCallback((,{timeout:30}):this.processActivityEvents(void 0)},this.processActivityEvents=e=>{for(this.isRequestIdleCallbackScheduled=!1,void 0===e&&(e={timeRemaining:function(){return Number.MAX_SAFE_INTEGER}});e.timeRemaining()&&this.activityQueue.length>0;){const e=this.activityQueue.pop();if(!e)return;this.sendActivityEventToTelemetry(e.result,e.activityObj,e.shouldSend,e.processedEndTime,e.processedCallTime,e.errorObject,e.verboseLogs)}this.activityQueue.length>0&&this.scheduleSendingActivities()},this.sendActivityEventToTelemetry=(e,t,n,i,r,s,o)=>{const a="success"===e,c=i-t.startTime;let l;if(a)l=S.a.Ok;else{const e=null==s?void 0:s.error;l=e&&e instanceof C.a?e.statusCode:y.UnhandledException}t.activityEventType==g.a.AGGREGATED?this.logAggregatedActivityInternal(t.activityName,t.component,t.operationName,a,c,l,n,void 0,r):t.activityEventType==g.a.SINGLE&&this.logSingleActivityInternal(t.activityName,t.component,t.operationName,a,c,l,void 0,r),s&&this.sendTelemetryErrorEvent(`${t.activityName}`,"error",t.operationName,t.component,s,l,null!=o?o:[])},this.getDataField=(e,t)=>"string"==typeof e?Object(r.d)(t,e):"number"==typeof e?Object(r.b)(t,e):"boolean"==typeof e?Object(r.a)(t,e):r.d(t,JSON.stringify(e)),this.getDataFieldsFromProps=e=>{const t=[];return Object.entries(e).forEach((([e,n])=>{if(void 0!==n){const i=this.getDataField(n,e);t.push(i)}})),t},this.getTableName=e=>{switch(e){case"error":case"warn":return"MonitoringErrors";case"info":return"MonitoringInfo";case"activity":return"AppActivities";case"trace":return"Trace";case"metric":return"CustomMetrics";case"verbose":return"Verbose"}},this.prepareAndFireEvent=(e,t)=>{const n=N.concat(this.getDataFieldsFromProps(e)),i=this.otelLogger,r={dataCategories:s.a.DataCategories.ProductServiceUsage,diagnosticLevel:s.a.DiagnosticLevel.RequiredServiceData},o={eventName:`${this.eventNamePrefix}.${this.getTableName(e.logLevel)}`,eventFlags:r,dataFields:n};this.eventStatsBuffer.prepareEventStatsEvent(this.eventStatsBuffer.stats,e.eventName+"-"+e.logLevel,e.sequenceNumber),t&&(o.timestamp=t),i.sendTelemetryEvent(o),this.eventStatsBuffer.shouldSendStatsToTelemetry()&&this.sendStatsEventToTelemetry()},this.logCustomMetricInternal=(e,t,n,i,r,s,o,a)=>{const c={metricName:e,eventName:e,logLevel:s,component:r,description:t,customMetricData:n,operationName:i,logParams:JSON.stringify(o),sequenceNumber:this.sequenceNumber++};this.prepareAndFireEvent(c,null!=a?a:Date.now())},this.logAggregatedActivityInternal=(e,t,n,i,r,s,o,a,c)=>{var l;if(this.eventMap){const d=this.eventMap.get(e);let u;if(d&&d[0]&&d[1]){u=d[0],o=d[1],i&&void 0!==u.successCount&&(u.successCount+=1);const e=u.mfsStatusCode,t=u.timeTaken;null==e||e.push(s),null==t||t.push(r),u.totalCount=(null!==(l=u.totalCount)&&void 0!==l?l:0)+1}else o||(o=v.b),u={eventName:e,operationName:n,logLevel:"activity",component:t,successCount:i?1:0,timeTaken:[r],mfsStatusCode:[s],totalCount:1,logParams:JSON.stringify(a),activityEventType:g.a.AGGREGATED,sequenceNumber:this.sequenceNumber++};const h=this.eventMap.get(e),m=h?h[2]:Date.now();this.eventMap.set(e,[u,o,m]),o(u)&&this.sendAggregateEvent(u,e,c),this.checkPartialAggregatedEvents()}},this.logSingleActivityInternal=(e,t,n,i,r,s,o,a)=>{const c={eventName:e,operationName:n,logLevel:"activity",component:t,timeTaken:r,successCount:i?1:0,totalCount:1,mfsStatusCode:s,activityEventType:g.a.SINGLE,logParams:JSON.stringify(o),sequenceNumber:this.sequenceNumber++};this.prepareAndFireEvent(c,null!=a?a:Date.now()),this.checkPartialAggregatedEvents()},this.sendAggregateEvent=(e,t,n)=>{this.computeTimeTakenHistogram(e),this.prepareAndFireEvent(e,null!=n?n:Date.now()),this.eventMap.delete(t)},this.checkPartialAggregatedEvents=()=>{Array.from(this.eventMap.keys()).forEach((e=>{var t;const n=this.eventMap.get(e);n&&(Date.now()-n[2])/1e3>60&&this.sendAggregateEvent(n[0],null!==(t=n[0].eventName)&&void 0!==t?t:"",n[2])}))},this.computeTimeTakenHistogram=e=>{const t=[],n=[],i=e.timeTaken;if(!i||i.length<=1)return;for(let e=0;e<i.length;e++){const r=Math.floor(i[e]/I);t[r]=r*I,n[r]=n[r]?n[r]+1:1}const r=t.filter((e=>void 0!==e)),s=n.filter((e=>void 0!==e));e.timeTaken=r,e.timeTakenFreq=s,e.timeTakenBinSize=I},this.addDataFieldIfNeeded=(e,t,n)=>{void 0!==n&&e.push(this.getDataField(n,t))},this.isTelemetryEnabled=()=>{var e,t,n;return null!==(n=null===(t=null===(e=this.context)||void 0===e?void 0:e.serviceLoggingInfo)||void 0===t?void 0:t.isLoggingEnabled)&&void 0!==n&&n},this.getAriaInfoFromService=this.initializeOtelLogger=(e,t,n)=>{if(n)this.setSharedSink(this.otelLogger,n);else{const t=[];t.push(...this.getAppFields(e)),t.push(...this.getUserFields(e)),t.push(...this.getDeviceFields(e)),this.configureWebSink(this.otelLogger,t)}this.setMfsFields(e),o.c().addListener((e=>{e.level!==s.a.LogLevel.Error&&e.level!==s.a.LogLevel.Warning||t("otelOnNotification",`${e.category} \n ${e.level} \n ${e.message}`)})),Object(b.a)((()=>{this.processActivityEvents(void 0),this.eventStatsBuffer.stats.totalCount>0&&this.sendStatsEventToTelemetry()})),this.loggerInit=!0},this.getAppFields=e=>{const t=[];return t.push(...a.b.getFields({platform:e.appInfo.appPlatform,name:"OfficeTaosMfs",version:e.appInfo.appVersion}),...a.e.getFields({id:e.sessionId})),this.addDataFieldIfNeeded(t,"Release.AudienceGroup",e.serviceLoggingInfo.mfsServiceEnvironment),t},this.getUserFields=e=>{const t=[];return e.user?t.push(...a.f.getFields({primaryIdentityHash:e.user.passportUserId,primaryIdentitySpace:s.a.PrimaryIdentitySpace.OrgIdPuid,tenantId:e.user.tenantId,tenantGroup:e.user.tenantGroup,isAnonymous:!1})):t.push(...a.f.getFields({isAnonymous:!0})),this.addDataFieldIfNeeded(t,"User.Language",navigator.language||""),t},this.getDeviceFields=e=>{var t,n,i,r,s;const o=[],a=Object(m.a)();return"mobile"===(null===(t=e.appInfo)||void 0===t?void 0:t.appPlatform)&&(this.addDataFieldIfNeeded(o,"Device.Manufacturer",null===(n=e.deviceInfo)||void 0===n?void 0:n.manufacturer),this.addDataFieldIfNeeded(o,"Device.Model",null===(i=e.deviceInfo)||void 0===i?void 0:i.model)),this.addDataFieldIfNeeded(o,"DeviceInfo.OsName",(null===(r=e.deviceInfo)||void 0===r?void 0:r.os)||a.os.name),this.addDataFieldIfNeeded(o,"DeviceInfo.OsVersion",(null===(s=e.deviceInfo)||void 0===s?void 0:s.osVersion)||a.os.version),this.addDataFieldIfNeeded(o,"DeviceInfo.BrowserName",a.browser.name),this.addDataFieldIfNeeded(o,"DeviceInfo.BrowserVersion",a.browser.version),o},this.setMfsFields=e=>{this.addDataFieldIfNeeded(N,"App.Id",e.appInfo.appId),this.addDataFieldIfNeeded(N,"App.MfsCoreVersion",e.appInfo.mfsCoreVersion),this.addDataFieldIfNeeded(N,"App.MfsFeatureName",e.appInfo.mfsFeature),this.addDataFieldIfNeeded(N,"App.MfsFeatureVersion",e.appInfo.mfsFeatureVersion),this.addDataFieldIfNeeded(N,"App.AppHostingPlatform",e.appInfo.appHostingPlatform),this.addDataFieldIfNeeded(N,"App.ClientRing",e.appInfo.clientRing),this.addDataFieldIfNeeded(N,"User.Id",e.user.userId),this.addDataFieldIfNeeded(N,"User.PassportUserId",e.user.passportUserId),this.addDataFieldIfNeeded(N,"Release.AudienceGroup",e.serviceLoggingInfo.mfsServiceEnvironment),this.addDataFieldIfNeeded(N,"ServiceBuildNumber",e.serviceLoggingInfo.mfsServiceBuildNumber),this.addDataFieldIfNeeded(N,"User.TenantDataBoundaryRestriction",e.user.tenantDataBoundaryRestriction||"")},this.configureWebSink=(t,r)=>{if(t.telemetrySinks.length>0)return t.telemetrySinks[0];const s=new u.a,o="EU"==this.context.user.tenantDataBoundaryRestriction?{endpointUrl:d.a.EUDB}:{endpointUrl:d.a.PUBLIC},a=URL.createObjectURL(new Blob(["(",function(){!function(t,i){"object"==typeof exports&&"object"==typeof e?e.exports=i():"function"==typeof define&&n("K2jg")?define([],i):"object"==typeof exports?exports.worker=i():t.worker=i()}("undefined"!=typeof self?self:this,(function(){return [function(e,t,n){n.d(t,"h",(function(){return i})),n.d(t,"j",(function(){return r})),n.d(t,"l",(function(){return s})),n.d(t,"k",(function(){return o})),n.d(t,"i",(function(){return a})),n.d(t,"g",(function(){return c})),n.d(t,"b",(function(){return l})),n.d(t,"f",(function(){return d})),n.d(t,"a",(function(){return u})),n.d(t,"c",(function(){return h})),n.d(t,"d",(function(){return m})),n.d(t,"e",(function(){return g}));var i="function",r="object",s="undefined",o="prototype",a="hasOwnProperty",c="default",l=Object,d=l[o],u=l.assign,h=l.create,m=l.defineProperty,g=d[a]},,,function(e,t,n){(.call(this,n(9))},,,function(e,t,n){(function(e){var t=n(10);void 0===e.env.JEST_WORKER_ID&&Object(t.a)({})}).call(this,n(8))},function(e,t,n){n.r(t),n(6)},function(e,t,n){n.d(t,"a",(function(){return ji}));var i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)};ar s,o,a=c=(s=[],{fireEvent:addListener:function(e){e&&s.push(e)}});nction u(e,t,n,i){var r=!0;if(t)for(var s=function(t){var s,o=t.classification,a=t.dataType,c=t.name;if(o&&!(4===o||1===o||2===i&&32===o||3===i&&2048===o))return r=!1,"break";if(3===i&&n&&3!==a&&1!==a&&2!==a&&"OTelJS.Version"!==c&&"OTelJS.Sink"!==c)return l(0,1,(function(){return"DNM: Invalid field type "+c})),r=!1,"break";s=n?"zC."===c.substr(0,3)?"zC.Data."+c.substr(3):"Data."+c:c;var d=void 0;switch(a){case 3:d=6;break;case 2:d=4;break;case 4:d=8;break;case 0:return e[s]="string"==typeof t.value?t.value.substr(0,25e3):t.value,"continue";case 1:default:return e[s]=t.value,"continue"}e[s]={value:t.value,propertyType:d}},o=0,a=t;o<a.length&&"break"!==s(a[o]);o++);return r}function h(e,t){try{return e()}catch(e){return d(1,"1DS Sink",e),t}}o||(o={}));var g={};r v=/^Office(\.[A-Z][a-zA-Z0-9]*){2,}$/,y=/^[a-zA-Z0-9_\.]{1,95}$/;function b(e){return y.test(e)}function S(e){e&&e.forEach((function(e){if("string"!=typeof e.name||!b(e.name))throw new Error("Invalid dataField name");2===e.dataType&&function(e){if("number"!=typeof e||!isFinite(e)||Math.floor(e)!==e||e<-9007199254740991||e>9007199254740991)throw new Error("Invalid integer ".concat(JSON.stringify(e)))}(e.value)}))}function C(e,t,n){return{name:e,dataType:0,value:t,classification:n||4}}nction I(e,t,n,i){n&&i.push(C("".concat(O(e,t)),n))}!function(){.prototype.addEventContentType=function(e,t){e.push(function(e,t,n){return{name:"EventContent.Type",dataType:2,value:t,classification:4}}(0,t))},e.prototype.sendTelemetryEvent=function(e){var t=w(e),n=t.telemetryProperties;n.nexusTenantToken=-1,n.ariaTenantToken||f(t.eventName,n)||n.ariaTenantToken?this.sendTelemetryEventInternal(t,1):l(0,0,(function(){return"No tenant token: "+e.eventName}))},e.prototype.sendCustomerContent=e.prototype.sendDirectNumericEvent=function(e){var t=w(e),n=t.telemetryProperties;n.dnmToken||f(t.eventName,n)||n.dnmToken?(this.addEventContentType(t.dataFields,1),this.sendTelemetryEventInternal(t,3)):l(0,0,(function(){return"No dnm token: "+t.eventName}))},e.prototype.sendTelemetryEventInternal=function(e,t){if(2===t||!e.telemetryProperties.customerContentVersion&&!e.telemetryProperties.customerContentType){try{if(0===this.telemetrySinks.length)return void(this.config.enableQueue&&this.eventQueue.length<1e3?this.eventQueue.push([e,t]):l(1,0,(function(){return"No telemetry sinks are attached."})));this.processTelemetryEvent(e,t)}catch(e){return void d(0,"SendTelemetryEvent",e)}try{this.telemetrySinks.forEach((function(n){2===t?n.sendCustomerContent&&n.sendCustomerContent(e):3===t?n.sendNonStandardEvent&&n.sendNonStandardEvent(e,t):n.sendTelemetryEvent(e)}))}catch(e){}}else l(0,0,(function(){return"Customer content"}))},e.prototype.processTelemetryEvent=function(e,t){var n,i,r;if(e.dataFields&&(null===(r=e.dataFields)||void 0===r||r.unshift(C("OTelJS.Version","4.9.0")),3!==t&&this.persistentDataFields&&(n=e.dataFields).unshift.apply(n,this.persistentDataFields)),this.partAFields.length>0){var s=e.eventContract||{name:"",dataFields:[]};(i=s.dataFields).push.apply(i,this.partAFields),e.eventContract=s}this.config.disableValidation||function(e){if(!function(e){return!(!e||e.length>98)&&v.test(e)}(e.eventName))throw new Error("Invalid eventName");var t=e.eventContract;if(t){if(t.name&&!b(t.name))throw new Error("Invalid eventContract");S(t.dataFields)}S(e.dataFields)}(e)},e.prototype.addSink=function(e){this.telemetrySinks.push(e),this.flushQueue()},e.prototype.flushQueue=function(){var e=this.eventQueue;if(this.eventQueue=[],this.telemetrySinks.length>0)for(var t=0,n=e;t<n.length;t++){var i=n[t];this.sendTelemetryEventInternal(i[0],i[1])}},e.prototype.setTenantToken=e.prototype.setDNMToken=e.prototype.cloneEvent=function(e){return w(e)},e.prototype.getConfig=function(){return this.config}}();var N=n(0),T=n(3),E=Object,k=E.getPrototypeOf,j=E.getOwnPropertyNames,P=0;e,t,n,i){_(e,"prototype")||F("theClass is an invalid class definition.");var r=e.prototype;((r,t)||F("["+L(e)+"] is not in class hierarchy of ["+L(t)+"]");var s=null;_(r,"_dynClass")?s=r._dynClass:(s="_dynCls$"+L(e,"_")+"$"+P,P++,r._dynClass=s);var o=V._dfOpts,a=!!o.useBaseInst;a&&i&&void 0!==i.useBaseInst&&(a=!!i.useBaseInst);var c=t);n(t,r,t,c,a));var l=!!k&&!!o.setInstFuncs;l&&i&&(l=!!i.setInstFuncs),function(e,t,n,i,r){if(!M(e)){var s=n._dynInstFuncs=n._dynInstFuncs||{},o=s[t]=s[t]||{};!1!==s._dynInstChk&&(s._dynInstChk=!!r),A(n,()}}(r,s,t,c,!1!==l)}V._dfOpts={setInstFuncs:!0,useBaseInst:!0};var U=N.d,H=N.b.freeze,G=N.b.keys,$=String[N.k],K=$.trim,W=$.endsWith,J=$.startsWith,Q=Date[N.k].toISOString,X=Array.isArray,Z=N.f.toString,Y=N.e.toString,ee=Y.call(N.b),te=/-([a-z])/g,ne=/([^\w\d_$])/g,ie=/^(\d+[\w\d_$])/,re=Object.getPrototypeOf;tion le(e){return!(!e||typeof e!==N.j)}e=X||function(e){return!(!e||"[object Array]"!==Z.call(e))};function fe(e){return"string"==typeof e}function ve(e){return"number"==typeof e}unction be(e){var t=!1;if(e&&"object"==typeof e){var n=re?re(e):e);n?(n.constructor&&N.e.call(n,"constructor")&&(n=n.constructor),t=typeof n===N.h&&Y.call(n)===ee):t=!0}return t}Ie=!{toString:null}.propertyIsEnumerable("toString"),Ne=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"];r ke=H||function(e){return e};unction Pe(e){return e)?e.name:""}function _e(e,t,n,i,r){var s=n;return e&&((s=e[t])===n||r&&!r(s)||i&&!i(n)||(e[t]=s=n)),s}null,Be=null,Le=null,Ve=null;nction Ge(){return Boolean(typeof window===N.j&&window)}function $e(){return Ge()?window:He("window")}ventsSent","eventsDiscarded","eventsSendRequest","perfEvent"],ct=null;mt=function(){function e(e,t,n,i){void 0===n&&(n=!1),this.messageId=e,this.message=(n?"AI: ":"AI (Internal): ")+e;var r="";Xe()&&(r=Ze().stringify(i));var s=(t?" message:"+ut(t):"")+(i?" props:"+ut(r):"");this.message+=s}return e.dataType="MessageData",e}(),gt=function(){function e(t){this.identifier="DiagnosticLogger",this.queue=[];var n,i,r,s,o=0,a={};V(e,this,(function(e){||{}),e.consoleLoggingLevel=function(){return n},e.telemetryLoggingLevel=function(){return i},e.maxInternalMessageLimit=function(){return r},e.enableDebugExceptions=function(){return s},e.throwInternal=e.warnToConsole=function(e){ht("warn",e),l("warning",e)},e.errorToConsole=e.resetInternalMessageCount=e.logInternalMessage=c}))}return e.__ieDyn=1,e}(); yt=null,bt=null,St=null,Ct=Ke(),wt={},Ot={};nction Tt(e,t){var n,i=e||Ot),r=i.path||"/",s=i.domain,o=!1!==i.enabled,a=((n={isEnabled:).setEnabled=n.set=function(e,t,n,o,c){var l=!1;if(It(a)&&!i,e)){var d={},u=Oe(t||""),h=u.indexOf(";");if(-1!==h&&(u=Oe(t.substring(0,h)),d=kt(t.substring(h+1))),_e(d,"domain",o||s,xe,se),!oe(n)){var m=et();if(se(d.expires)){var g=je()+1e3*n;if(g>0){var p=new Date;p.setTime(g),_e(d,"expires",jt(p,m?"toGMTString":"toUTCString")||jt(p,m?"toGMTString":"toUTCString")||"",xe)}}m||_e(d,"max-age",""+n,null,se)}var f=Qe();f&&"https:"===f.protocol&&(_e(d,"secure",null,null,se),null===bt&&(bt=!function(e){return!(!fe(e)||!ge(e,"CPU iPhone OS 12")&&!ge(e,"iPad; CPU OS 12")&&!(ge(e,"Macintosh; Intel Mac OS X 10_14")&&ge(e,"Version/")&&ge(e,"Safari"))&&(!ge(e,"Macintosh; Intel Mac OS X 10_14")||!function(e,t){var n=!1;return e&&!(n=e===t)&&(n=W?e.endsWith(t):function(e,t){var n=!1,i=t.length,r=e?e.length:0;if(i&&r&&r>=i&&!(n=e===t)){for(var s=r-1,o=i-1;o>=0;o--){if(e[s]!=t[o])return!1;s--}n=!0}return n}(e,t)),n}(e,"AppleWebKit/605.1.15 (KHTML, like Gecko)"))&&!ge(e,"Chrome/5")&&!ge(e,"Chrome/6")&&(!ge(e,"UnrealEngine")||ge(e,"Chrome"))&&!ge(e,"UCBrowser/12")&&!ge(e,"UCBrowser/11"))}((Je()||{}).userAgent)),bt&&_e(d,"SameSite","None",null,se)),_e(d,"path",c||r,null,se),(i.setCookie||Mt)(e,Pt(u,d)),l=!0}return l},n.get=n.del=n.purge=n);return a._ckMgr=a,a}=!1,xt=123456789,At=987654321;function Rt(e){var t=0,n=He("crypto")||He("msCrypto");return n&&n.getRandomValues&&(t=4294967295&n.getRandomValues(new Uint32Array(1))[0]),0===t&&et()&&(Dt||function(){try{var e=2147483647&je();!function(e){e<0&&(e>>>=0),xt=123456789+e&4294967295,At=987654321-e&4294967295,Dt=!0}((4294967296*Math.random()^e)+e)}catch(e){}}(),t=4294967295&function(e){var t=((At=36969*(65535&At)+(At>>16)&4294967295)<<16)+(65535&(xt=18e3*(65535&xt)+(xt>>16)&4294967295))>>>0&4294967295|0;return t>>>=0}()),0===t&&(t=Math.floor(4294967296*Math.random()|0)),e||(t>>>=0),t}var Ft=N.d,qt="."+function(e){void 0===e&&(e=22);for(var t=Rt()>>>0,n=0,i="";i.length<e;)n++,i+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(63&t),t>>>=6,5===n&&(t=(Rt()<<2&4294967295|3&t)>>>0,n=0);return i}(6),zt=0;nction Vt(e){var t={id:Lt("_aiData-"+(e||"")+".2.8.8"),accept:function(e){return Bt(e)},get:kill:;return t}var Ut=Lt("aiEvtPageHide"),Ht=Lt("aiEvtPageShow"),Gt=/\.[\.]+/g,$t=/[\.]+$/,Kt=1,Wt=Vt("events"),Jt=/^([^.]*)(?:\.(.+)|)/;n rn(e,t,n,i,r){if(void 0===r&&(r=!1),e)try{var s=Xt(t,i),o=!1;!e,s,(),o||Yt(e,s,n,r)}catch(e){}}r an,cn=n(14);function ln(e){var t={};return he(e,(),function(e){return H&&he(e,(),ke(e)}(t)}var dn="Failed",un="Track",hn="Storage",mn=(ln({CRITICAL:1,WARNING:2}),ln(((an={})["BrowserDoesNotSupportLocal"+hn]=0,an["BrowserCannotReadLocal"+hn]=1,an["BrowserCannotReadSession"+hn]=2,an["BrowserCannotWriteLocal"+hn]=3,an["BrowserCannotWriteSession"+hn]=4,an["BrowserFailedRemovalFromLocal"+hn]=5,an["BrowserFailedRemovalFromSession"+hn]=6,an.CannotSendEmptyTelemetry=7,an.ClientPerformanceMathError=8,an.ErrorParsingAISessionCookie=9,an.ErrorPVCalc=10,an.ExceptionWhileLoggingError=11,an.FailedAddingTelemetryToBuffer=12,an.FailedMonitorAjaxAbort=13,an.FailedMonitorAjaxDur=14,an.FailedMonitorAjaxOpen=15,an.FailedMonitorAjaxRSC=16,an.FailedMonitorAjaxSend=17,an.FailedMonitorAjaxGetCorrelationHeader=18,an.FailedToAddHandlerForOnBeforeUnload=19,an.FailedToSendQueuedTelemetry=20,an.FailedToReportDataLoss=21,an.FlushFailed=22,an.MessageLimitPerPVExceeded=23,an.MissingRequiredFieldSpecification=24,an.NavigationTimingNotSupported=25,an.OnError=26,an.SessionRenewalDateIsZero=27,an.SenderNotInitialized=28,an.StartTrackEventFailed=29,an.StopTrackEventFailed=30,an["Start"+un+dn]=31,an["Stop"+un+dn]=32,an.TelemetrySampledAndNotSent=33,an[un+"Event"+dn]=34,an[un+"Exception"+dn]=35,an[un+"Metric"+dn]=36,an[un+"PV"+dn]=37,an.TrackPVFailedCalc=38,an[un+"Trace"+dn]=39,an.TransmissionFailed=40,an[dn+"ToSet"+hn+"Buffer"]=41,an[dn+"ToRestore"+hn+"Buffer"]=42,an.InvalidBackendResponse=43,an.FailedToFixDepricatedValues=44,an.InvalidDurationValue=45,an.TelemetryEnvelopeInvalid=46,an.CreateEnvelopeError=47,an.CannotSerializeObject=48,an.CannotSerializeObjectNonSerializable=49,an.CircularReferenceDetected=50,an.ClearAuthContextFailed=51,an.ExceptionTruncated=52,an.IllegalCharsInName=53,an.ItemNotInArray=54,an.MaxAjaxPerPVExceeded=55,an.MessageTruncated=56,an.NameTooLong=57,an.SampleRateOutOfRange=58,an.SetAuthContextFailed=59,an.SetAuthContextFailedAccountName=60,an.StringValueTooLong=61,an.StartCalledMoreThanOnce=62,an.StopCalledWithoutStart=63,an.TelemetryInitializerFailed=64,an.TrackArgumentsNotSpecified=65,an.UrlTooLong=66,an.SessionStorageBufferFull=67,an.CannotAccessCookie=68,an.IdTooLong=69,an.InvalidEvent=70,an.FailedMonitorAjaxSetRequestHeader=71,an.SendBrowserInfoOnUserInit=72,an.PluginException=73,an.NotificationException=74,an.SnippetScriptLoadFailure=99,an.InvalidInstrumentationKey=100,an.CannotParseAiBlobValue=101,an.InvalidContentBlob=102,an[un+"PageActionEvent"+dn]=103,an.FailedAddingCustomDefinedRequestContext=104,an.InMemoryStorageBufferFull=105,an.InstrumentationKeyDeprecation=106,an))),gn=(ln({NotSet:0,Pii_DistinguishedName:1,Pii_GenericData:2,Pii_IPV4Address:3,Pii_IPv6Address:4,Pii_MailSubject:5,Pii_PhoneNumber:6,Pii_QueryString:7,Pii_SipAddress:8,Pii_SmtpAddress:9,Pii_Identity:10,Pii_Uri:11,Pii_Fqdn:12,Pii_IPV4AddressLegacy:13,CustomerContent_GenericContent:32}),ln({Normal:1,CostDeferred:2,RealTime:3,Immediate:4}),ln({Unspecified:0,String:1,Int32:2,UInt32:3,Int64:4,UInt64:5,Double:6,Bool:7,Guid:8,DateTime:9})),pn=(ln({Normal:1,Critical:2}),ln({NONE:0,ERROR:1,WARNING:2,INFORMATION:3}),ke(Object(cn.a)(Object(cn.a)({},mn),ln({AuthHandShakeError:501,AuthRedirectFail:502,BrowserCannotReadLocalStorage:503,BrowserCannotWriteLocalStorage:504,BrowserDoesNotSupportLocalStorage:505,CannotParseBiBlobValue:506,CannotParseDataAttribute:507,CVPluginNotAvailable:508,DroppedEvent:509,ErrorParsingAISessionCookie:510,ErrorProvidedChannels:511,FailedToGetCookies:512,FailedToInitializeCorrelationVector:513,FailedToInitializeSDK:514,InvalidContentBlob:515,InvalidCorrelationValue:516,SessionRenewalDateIsZero:517,SendPostOnCompleteFailure:518,PostResponseHandler:519,SDKNotInitialized:520}))),function(e,t){var n=this;this.eventsProcessed=0,this.eventsSent=0,this.eventsDiscarded=0;var i=[],r=!1,s=!0,o={name:"DiagnosticLevel",processEvent:,a={},c=function(){var e=function(){for(var e,t=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],n="",i=0;i<4;i++)n+=t[15&(e=Rt())]+t[e>>4&15]+t[e>>8&15]+t[e>>12&15]+t[e>>16&15]+t[e>>20&15]+t[e>>24&15]+t[e>>28&15];var r=t[8+(3&Rt())|0];return n.substr(0,8)+n.substr(9,4)+"4"+n.substr(13,3)+r+n.substr(16,3)+n.substr(19,12)}();return e.substring(0,8)+"-"+e.substring(8,12)+"-"+e.substring(12,16)+"-"+e.substring(16,20)+"-"+e.substring(20)}();this.init=function(){return s=s&&function(e){ar n=t("App.Name")&&t("App.Version")&&t("App.Platform")&&t("Session.Id"),i=e["User.IsAnonymous"];if(!1!==i&&void 0!==i||(n=n&&t("User.PrimaryIdentityHash")&&t("User.PrimaryIdentitySpace")),!n)return n;/^(\d+\.){3}\d+(-?[a-zA-Z0-9]+)?$/.test(e["App.Version"])||(m("App.Version"),n=!1);var r=/^[0-9a-fA-F]{8}-([0-9a-fA-F]{4}-){3}[0-9a-fA-F]{12}$/,s=e["User.TenantId"];return!s||t("User.TenantId")&&r.test(s)||(m("User.TenantId"),n=!1),r.test(e["Session.Id"])||(m("Session.Id"),n=!1),n}(a)},this.getOneDSTelemetryEvent=this.getOneDSCustomerContent=function(e){if(t.enableCustomerContent&&e.telemetryProperties.customerContentVersion&&Math.floor(e.telemetryProperties.customerContentVersion)<=1&&1===e.telemetryProperties.customerContentType)return d(e,{eventType:2})};var d=function(e,t){var r,s=w(e);if(function(e,t){for(var n=i=0;i<t.length;i++){var r=n(i);if("object"==typeof r)return r.value}return!0}(s,i)){var o=(r=s,r.timestamp?new Date(r.timestamp):new Date).toISOString(),d={"Event.Name":s.eventName,"Event.Source":"OTelJS","Event.Time":{value:o,propertyType:gn.DateTime}};for(var h in n.eventsProcessed++,d["Event.Sequence"]={value:n.eventsProcessed,propertyType:gn.Int64},d["Event.Id"]=c+"."+n.eventsProcessed,a)d[h]=a[h];if(!u(d,s.dataFields,!0,t.eventType))return void l(0,1,();var m="custom";s.eventContract&&(s.eventContract.name&&(d["Event.Contract"]=s.eventContract.name,m+="."+s.eventContract.name.toLowerCase().replace(/\./g,"_")),u(d,s.eventContract.dataFields,!1,t.eventType));var g=s,t.eventType);if(!g)return;return{iKey:g,name:s.eventName,data:d,time:o,baseType:m,ext:{sdk:{seq:n.eventsProcessed}}}}};this.addPreprocessor=function(e){i.push(e)},this.getOneDSPersistentDataFields=function(){return a},this.getPreprocessors=function(){return i};var h=this.addPersistentDataFields=h,this.setOptionalEventsEnabled=function(e){r=e},this.setFullEventsEnabled=this.setOptionalEventsEnabled,t.enableOptionalEvents&&(r=!0),h(e);var g=t.coreFields;if(g){h(function(e){var t=[];return I("App","Name",e.name,t),I("App","Platform",e.platform,t),I("App","Version",e.version,t),t}(g.app)),h(function(e){var t=[];return I("User","PrimaryIdentityHash",e.primaryIdentityHash,t),I("User","PrimaryIdentitySpace",e.primaryIdentitySpace,t),I("User","TenantId",e.tenantId,t),I("User","TenantGroup",e.tenantGroup,t),function(e,t,n,i){"boolean"==typeof n&&i.push(function(e,t,n){return{name:e,dataType:1,value:t,classification:4}}("".concat(O("User","IsAnonymous")),n))}(0,0,e.isAnonymous,t),t}(g.user)),h(function(e){var t=[];return I("Session","Id",e.id,t),I("Session","EcsETag",e.ecsETag,t),t}(g.session));var p=g.release;p&&h(function(e){var t=[];return I("Release","AudienceGroup",e.audienceGroup,t),t}(p))}this.addPreprocessor(o)}),fn=),vn=);function yn(e,t,n,i,r){if(e){var s=e;if(s.getPerfMgr&&(s=s.getPerfMgr()),s){var o=void 0,a=s.getCtx("CoreUtils.doPerf");try{if(o=s.create(t(),i,r)){if(a&&o.setCtx&&(o.setCtx(fn.ParentContextKey,a),a.getCtx&&a.setCtx)){var c=a.getCtx(fn.ChildrenContextKey);c||a.setCtx(fn.ChildrenContextKey,c=[]),c.push(o)}return s.setCtx("CoreUtils.doPerf",o),n(o)}}catch(e){o&&o.setCtx&&o.setCtx("exception",e)}finally{o&&s.fire(o),s.setCtx("CoreUtils.doPerf",a)}}}return n()}ar Sn=Vt("plugin"); In=0;function Nn(e,t,n,i){var r=null,s=[];null!==i&&(r=i?e,n,i):e);var o={_next:function(){var e=r;return r=e?e.getNext():null,e||s&&s.length>0&&(Ce(s,(),s=[]),e},ctx:{core:function(){return n},diagLog:getCfg:function(){return t},getExtCfg:a,getConfig:hasNext:getNext:function(){return r},setNext:function(e){r=e},iterate:onComplete:};eturn o}ction jn(e,t,n,i){var r=null,s=!i;if(pe(e)&&e.length>0){var o=null;Ce(e,(function(e){if(s||i!==e||(s=!0),s&&e&&de(e.processTelemetry)){var a=function(e,t,n){var i,r=null,s=de(e.processTelemetry),o=de(e.setNextPlugin),a={getPlugin:function(){return e},getNext:function(){return r},processTelemetry:function(t,n){l(n=n||c(),(,"processTelemetry",(,!t.sync)||n.processNext(t)},unload:update:_id:i=e?e.identifier+"-"+e.priority+"-"+In++:"Unknown-0-"+In++,_setNext:function(e){r=e}};turn ke(a)}(e,t,n);r||(r=a),o&&o._setNext(a),o=a}}))}return i&&!r?jn([i],t,n):r}r Mn=function(){function e(){var t,n,i,r,s,o=this;function a(e){void 0===e&&(e=null);var t=e;return t||(t=(n||Tn(null,{},o.core)).createNew(null,i&&i.getPlugin?i.getPlugin:i)),t}),V(e,o,(function(e){e.initialize=e.teardown=e.update=function(t,n){var r=e.core;if(r&&(!t||r===t.core())){var s,o=!1,a=t||kn(null,r,i&&i.getPlugin?i.getPlugin():i);return e._doUpdate&&!0===e._doUpdate(a,n||{reason:0},l)?s=!0:l(),s},e._addHook=Re(e,"_addUnloadCb",(function(){return r}),"add")})),o.diagLog=o.isInitialized=function(){return t},o.setInitialized=function(e){t=e},o.setNextPlugin=o.processNext=o._getTelCtx=a}return e.__ieDyn=1,e}(),Dn=function(e){eturn Object(cn.b)(t,e),t.__ieDyn=1,t}(Mn),xn={loggingLevelConsole:1};r Fn=function(){function e(){var t,n,i,r,s,o,a,c,l,d,u,h,m,g,p,f,v,y,b,S,C=0;V(e,this,(function(e){nction I(n){var i=function(e,t,n){var i,r=[],s={};return Ce(n,(function(t){(oe(t)||oe(t.initialize))&&Ae("Plugins must provide initialize method");var n=t.priority,i=t.identifier;t&&n&&(oe(s[n])?s[n]=i:vt(e,"Two extensions have same priority #"+n+" - "+s[n]+", "+i)),(!n||n<500)&&r.push(t)})),(i={all:n}).core=r,i}(e.logger,0,l);d=i.core,c=null;var r=i.all;if(m=ke(h,r,e)),u){var s=we(r,u);-1!==s&&r.splice(s,1),-1!==(s=we(d,u))&&d.splice(s,1),u._setQueue(m)}else u=function(e,t){unction i(e,t,n,i){var r=e?e.length+1:1;>0&&Ce(e,(function(e){if(e&&e.queue.length>0){var i=t.createNew(e.chain);i.onComplete(s),n(i)}else r--})),s()}var r=!1;return{identifier:"ChannelControllerPlugin",priority:500,initialize:isInitialized:processTelemetry:update:pause:function(){i(e,n(),(function(e){e.iterate((function(e){e.pause&&e.pause()}))}),null)},resume:teardown:getChannel:flush:_setQueue:function(t){e=t}}}(m,e);r.push(u),d.push(u),e._extensions=On(r),u.initialize(t,e,r),wn(O(),r),e._extensions=ke(On(d||[])).slice(),n&&n)}isInitialized=function(){return n},e.initialize=function(i,s,a,c){g&&Ae("SDK is still unloading..."),e.isInitialized()&&Ae("Core should not be initialized more than once"),e.config=t=i||{},oe(i.instrumentationKey)&&Ae("Please provide instrumentation key"),r=c,e._notificationManager=c,function(){var e=De(t.disableDbgExt);!0===e&&b&&(r.removeNotificationListener(b),b=null),r&&!b&&!0!==e&&(b=t),r.addNotificationListener(b))}(),function(){var e=De(t.enablePerfMgr);!e&&o&&(o=null),e&&Me(t,"createPerfMgr",An)}(),Me(t,"extensionConfig",{}).NotificationManager=r,a&&(e.logger=a);var d=Me(t,"extensions",[]);(l=[]).push.apply(l,Object(cn.c)(Object(cn.c)([],s,!1),d,!1)),h=Me(t,"channels",[]),I(null),m&&0!==m.length||Ae("No channels available"),n=!0,e.releaseQueue()},e.getTransmissionControls=e.track=e.getProcessTelContext=O,e.getNotifyMgr=e.addNotificationListener=function(e){r&&r.addNotificationListener(e)},e.removeNotificationListener=function(e){r&&r.removeNotificationListener(e)},e.getCookieMgr=e.setCookieMgr=function(e){a=e},e.getPerfMgr=e.setPerfMgr=function(e){s=e},e.eventCnt=function(){return i.length},e.releaseQueue=e.pollInternalLogs=e.stopPollingInternalLogs=function(e,t,n,i){e&&t&&le(e)&&pe(n)&&Ce(n,(function(n){fe(n)&&Re(e,n,t,n,void 0)}))}(e,(function(){return p}),["addTelemetryInitializer"]),e.unload=function(t,i,r){var s;void 0===t&&(t=!0),n||Ae("SDK is not initialized"),g&&Ae("SDK is still unloading...");var o=((s={reason:50}).isAsync=t,s.flushComplete=!1,s),a=En(E(),e);.onComplete((,e),P(t,c,6,r)||c(!1)},e.getPlugin=N,e.addPlugin=e.evtNamespace=function(){return v},e.flush=P,e.getTraceCtx=function(e){var t;return S||(t={},S={getName:function(){return t.name},setName:function(e){t.name=e},getTraceId:function(){return t.traceId},setTraceId:function(e){(function(e){return bn(e,32,"00000000000000000000000000000000")})(e)&&(t.traceId=e)},getSpanId:function(){return t.spanId},setSpanId:function(e){((e)&&(t.spanId=e)},getTraceFlags:function(){return t.traceFlags},setTraceFlags:function(e){t.traceFlags=e}}),S},e.setTraceCtx=Re(e,"addUnloadCb",(function(){return y}),"add")}))}return e.__ieDyn=1,e}();ar zn,Bn=function(){function e(t){this.listeners=[];var n=!!(t||{}).perfEvtsSendAll;V(e,this,()}return e.__ieDyn=1,e}(),Ln=function(e){eturn Object(cn.b)(t,e),t.__ieDyn=1,t}(Fn),Vn=((zn={})[0]=0,zn[2]=6,zn[1]=1,zn[3]=7,zn[4098]=6,zn[4097]=1,zn[4099]=7,zn);unction Hn(e,t,n){var i=-1;if(!se(e))if(t>0&&(32===t?i=8192:t<=13&&(i=t<<5)),n))-1===i&&(i=0),i|=n;else{var r=Vn[Wn(e)]||-1;-1!==i&&-1!==r?i|=r:6===r&&(i=r)}return i}function Gn(e,t,n,i,r){var s={},o=!1,a=0,c=arguments.length,l=Object[N.k],d=arguments;for("[object Boolean]"===l.toString.call(d[0])&&(o=d[0],a++);a<c;a++)he(e=d[a],();return s}Boolean(Ke()),Boolean($e());var $n=function(){var e=);return e&&e.now?e.now():je()};unction Wn(e){var t=0;if(null!=e){var n=typeof e;"string"===n?t=1:"number"===n?t=2:"boolean"===n?t=3:n===N.j&&(t=4,pe(e)?(t=4096,e.length>0&&(t|=Wn(e[0]))):N.e.call(e,"value")&&(t=8192|Wn(e.value)))}return t}var Jn=function(e){function t(){var n=e.call(this)||this;return n.pluginVersionStringArr=[],V(t,n,(function(e,t){e.logger&&e.logger.queue||(e.logger=new gt({loggingLevelConsole:1})),e.initialize=function(n,i,r,s){yn(e,(function(){return"AppInsightsCore.initialize"}),(function(){var o=e.pluginVersionStringArr;if(n){n.endpointUrl||(n.endpointUrl="https://browser.events.data.microsoft.com/OneCollector/1.0/");var a=n.propertyStorageOverride;!a||a.getProperty&&a.setProperty||Ae("Invalid property storage override passed."),n.channels&&Ce(n.channels,(function(e){e&&Ce(e,(function(e){e.identifier&&e.version&&o.push(e.identifier+"="+e.version)}))}))}e.getWParam=i&&Ce(i,(function(e){e&&e.identifier&&e.version&&o.push(e.identifier+"="+e.version)})),e.pluginVersionString=o.join(";"),e.pluginVersionStringArr=o;try{t.initialize(n,i,r,s),e.pollInternalLogs("InternalLog")}catch(t){var c=e.logger,l=tt(t);-1!==l.indexOf("channels")&&(l+="\n - Channels must be provided through config.channels only!"),ft(c,1,514,"SDK Initialization Failed - no telemetry will be sent: "+l)}}),(function(){return{config:n,extensions:i,logger:r,notificationManager:s}}))},e.track=function(n){yn(e,(function(){return"AppInsightsCore.track"}),(function(){var i=n;if(i){i.timings=i.timings||{},i.timings.trackStart=$n(),function(e){return!!(e&&ve(e)&&e>=1&&e<=4)}(i.latency)||(i.latency=1);var r=i.ext=i.ext||{};r.sdk=r.sdk||{},r.sdk.ver="1DS-Web-JS-3.2.7";var s=i.baseData=i.baseData||{};s.properties=s.properties||{};var o=s.properties;o.version=o.version||e.pluginVersionString||""}t.track(i)}),(function(){return{item:n}}),!n.sync)}})),n}return Object(cn.b)(t,e),t.__ieDyn=1,t}(Ln),Qn=ln({Unknown:0,NonRetryableStatus:1,InvalidEvent:2,SizeLimitExceeded:3,KillSwitch:4,QueueFull:5});r Yn=function(){function e(t,n){var i=n?[].concat(n):[],r=Zn(i);this.iKey=function(){return t},this.Msfpc=this.count=function(){return i.length},this.events=function(){return i},this.addEvent=this.split=return e.create=function(t,n){return new e(t,n)},e}(),ei=),ti=function(){function e(){var t={};V(e,this,(function(e){e.setKillSwitchTenants=function(e,n){if(e&&n)try{var i=(o=e.split(","),a=[],o&&Ce(o,(),a);if("this-request-only"===n)return i;for(var r=1e3*parseInt(n,10),s=0;s<i.length;++s)t[i[s]]=je()+r}catch(e){return[]}var o,a;return[]},e.isTenantKilled=))}return e.__ieDyn=1,e}();ar ii,ri=Math.min(2e6,65e3),si=/\./,oi=function(){function e(t,n,i,r){var s=!!r,o=n,a={};V(e,this,(function(e){function n(e,t,r,c,l,d,u){he(e,(function(e,h){var m=null;if(h||Un(h)){var g=r,p=e,f=l,v=t;if(s&&!c&&si.test(e)){var y=e.split("."),b=y.length;if(b>1){f&&(f=f.slice());for(var S=0;S<b-1;S++){var C=y[S];v=v[C]=v[C]||{},g+="."+C,f&&f.push(C)}p=y[b-1]}}if(m=c&&g)||!o||!o.handleField(g,p)?function(e,t,n){if(!t&&!Un(t)||"string"!=typeof e)return null;var i=typeof t;if("string"===i||"number"===i||"boolean"===i||pe(t))t={value:t};else if("object"!==i||N.e.call(t,"value")){if(oe(t.value)||""===t.value||!fe(t.value)&&!ve(t.value)&&!ye(t.value)&&!pe(t.value))return null}else t={value:n?JSON.stringify(t):t};if(pe(t.value)&&!t.value))return null;if(!oe(t.kind)){if(pe(t.value)||!function(e){return 0===e||e>0&&e<=13||32===e}(t.kind))return null;t.value=t.value.toString()}return t}(p,h,i):o.value(g,p,h,i)){var w=m.value;if(v[p]=w,d&&d(f,p,m),u&&"object"==typeof w&&!pe(w)){var O=f;O&&(O=O.slice()).push(p),n(h,w,g+"."+p,c,O,d,u)}}}}))}e.createPayload=e.appendPayload=function(n,i,r){var s=n&&i&&!n.overflow;return s&&yn(t,(function(){return"Serializer:appendPayload"}),(function(){for(var t=i.events(),s=n.payloadBlob,o=n.numEvents,a=!1,c=[],l=[],d=n.isBeacon,u=d?65e3:3984588,h=d?ri:2e6,m=0,g=0;m<t.length;){var p=t[m];if(p){if(o>=r){n.overflow=i.split(m);break}var f=e.getEventBlob(p);if(f&&f.length<=h){if(s.length+f.length>u){n.overflow=i.split(m);break}s&&(s+="\n"),s+=f,++g>20&&(s.substr(0,1),g=0),a=!0,o++}else f?c.push(p):l.push(p),t.splice(m,1),m--}m++}if(c&&c.length>0&&n.sizeExceed.push(Yn.create(i.iKey(),c)),l&&l.length>0&&n.failedEvts.push(Yn.create(i.iKey(),l)),a){n.batches.push(i),n.payloadBlob=s,n.numEvents=o;var v=i.iKey();-1===we(n.apiKeys,v)&&n.apiKeys.push(v)}}),(),s},e.getEventBlob=function(e){try{return yn(t,(function(){return"Serializer.getEventBlob"}),(function(){var t={};t.name=e.name,t.time=e.time,t.ver=e.ver,t.iKey="o:"+function(e){if(e){var t=e.indexOf("-");if(t>-1)return e.substring(0,t)}return""}(e.iKey);var i={},r=e.ext;r&&(t.ext=i,he(r,());var s=t.data={};s.baseType=e.baseType;var o=s.baseData={};return n(e.baseData,o,"baseData",!1,["baseData"],(function(e,t,n){ai(i,e,t,n)}),!0),n(e.data,s,"data",!1,[],(,!0),JSON.stringify(t)}),(function(){return{item:e}}))}catch(e){return null}}}))}return e.__ieDyn=1,e}();ar ci=((ii={})[1]="requeue",ii[100]="requeue",ii[200]="sent",ii[8004]="drop",ii[8003]="drop",ii),li={},di={};uthMsaDeviceTicket","AuthMsaDeviceTicket",!1),ui("client-version","client-version"),ui("client-id","Client-Id"),ui("apikey","apikey"),ui("time-delta-to-apply-millis","time-delta-to-apply-millis"),ui("upload-time","upload-time"),ui("AuthXToken","AuthXToken");var fi=function(){function e(t,n,i,r,s){this._responseHandlers=[];var o,a,c,l,d,u,h,m,g,p="?cors=true&"+"content-type".toLowerCase()+"=application/x-json-stream",f=new ti,v=!1,y=new ei,b=!1,S=0,C=!0,w=[],O={},I=[],T=null,E=!1,k=!1,j=!1;V(e,this,(function(e){var P=!0;nction D(e,t,n){var i,r=e.urlString,o=!1,a=!1,c=((i={body:e.data,method:"POST"}).Microsoft_ApplicationInsights_BypassAjaxInstrumentation=!0,i);n&&(c.keepalive=!0,2===e._sendReason&&(o=!0,r+="&NoResponseBody=true")),P&&(c.credentials="include"),e.headers&&Te(e.headers).length>0&&(c.headers=e.headers),fetch(r,c).then(().catch((),o&&!a&&(a=!0,A(t,200,{})),!a&&e.timeout>0&&s.set((,e.timeout)}function x(e,t,n){unction r(e,n){A(t,e.status,function(e){var t={};return e.getAllResponseHeaders?t=function(e){var t={};return fe(e)&&Ce(Oe(e).split(/[\r\n]+/),(),t}(e.getAllResponseHeaders()):(t=i(t,e,"time-delta-millis"),t=i(t,e,"kill-duration"),t=i(t,e,"kill-duration-seconds")),t}(e),n)}n&&e.disableXhrSync&&(n=!1);var s=function(e,t,n,i,r,s){oid 0===i&&(i=!1),void 0===r&&(r=!1);var a=new XMLHttpRequest;return i&&o(a,"Microsoft_ApplicationInsights_BypassAjaxInstrumentation",i),n&&o(a,"withCredentials",n),a.open("POST",t,!r),n&&o(a,"withCredentials",n),!r&&s&&o(a,"timeout",s),a}(0,e.urlString,P,!0,n,e.timeout);he(e.headers,(),s.onload=s.onerror=function(){r(s)},s.ontimeout=s.send(e.data)}unction R(e,t,n){var i=200,r=e._thePayload,s=e.urlString+"&NoResponseBody=true";try{var o=Je();if(!o.sendBeacon(s,e.data))if(r){var c=[];Ce(r.batches,(),J(c,8003,r.sendType,!0)}else i=0}catch(e){vt(a,"Failed to send telemetry using sendBeacon API. Ex:"+tt(e)),i=0}finally{A(t,i,{},"")}}n H(e,t){var n={url:p,hdrs:{},useHdrs:!1};t?(n.hdrs=Gn(n.hdrs,O),n.useHdrs=Te(n.hdrs).length>0):he(O,(),gi(n,"client-id","NO_AUTH",t),gi(n,"client-version","1DS-Web-JS-3.2.7",t);var i="";Ce(e.apiKeys,(),gi(n,"apikey",i,t),gi(n,"upload-time",je().toString(),t);var r=e);if(Un(r)&&(n.url+="&ext.intweb.msfpc="+r),y.shouldAddClockSkewHeaders()&&gi(n,"time-delta-to-apply-millis",y.getClockSkewHeaderValue(),t),l.getWParam){var s=l.getWParam();s>=0&&(n.url+="&w="+s)}for(var o=0;o<w.length;o++)n.url+="&"+w[o].name+"="+w[o].value;return n}unction $(t,n,r,s){if(t&&t.payloadBlob&&t.payloadBlob.length>0){var d=!!e.sendHook,g=c[t.sendType];!F(t.sendType)&&t.isBeacon&&2===t.sendReason&&(g=c[2]||c[3]||g);var p=j;(t.isBeacon||3===g._transport)&&(p=!1);var v=H(t,p);p=p||v.useHdrs;var b=$n();yn(l,(function(){return"HttpManager:_doPayloadSend"}),(function(){for(var c=0;c<t.batches.length;c++)for(var w=t.batches[c].events(),O=0;O<w.length;O++){var I=w[O];if(E){var T=I.timings=I.timings||{};G(T,"sendEventStart",b),G(T,"serializationStart",n),G(T,"serializationCompleted",r)}I.sendAttempt>0?I.sendAttempt++:I.sendAttempt=1}J(t.batches,1e3+(s||0),t.sendType,!0);var j={data:t.payloadBlob,urlString:v.url,headers:v.hdrs,_thePayload:t,_sendReason:s,timeout:u,disableXhrSync:h,disableFetchKeepAlive:m};p&&(mi(j.headers,"cache-control")||(j.headers["cache-control"]="no-cache, no-store"),mi(j.headers,"content-type")||(j.headers["content-type"]="application/x-json-stream"));var P=null;g&&(P=function(n){y.firstRequestSent();var r=function(n,r){!function(t,n,r,s){var a,c=9e3,l=null,d=!1,u=!1;try{var h=!0;if(typeof t!==N.l){if(n&&(y.setClockSkew(n["time-delta-millis"]),Ce(f.setKillSwitchTenants(n["kill-tokens"],n["kill-duration"]||n["kill-duration-seconds"]),()),200==t||204==t)return void(c=200);((a=t)>=300&&a<500&&408!=a&&429!=a||501==a||505==a||r.numEvents<=0)&&(h=!1),c=9e3+t%1e3}if(h){c=100;var m=r.retryCnt;0===r.sendType&&(m<i?(d=!0,K((,k,ni(m))):(u=!0,k&&(c=8001)))}}finally{d||(y.setClockSkew(),function(t,n,i,r){try{r&&o._backOffTransmission(),200===n&&(r||t.isSync||o._clearBackOff(),t.batches)),J(t.batches,n,t.sendType,!0)}finally{0===t.sendType&&(S--,5!==i&&e.sendQueuedRequests(t.sendType,i))}}(r,c,s,u)),J(l,8004,r.sendType)}}(n,r,t,s)},c=t.isTeardown||t.isSync;try{g.sendPOST(n,r,c),e.sendListener&&e.sendListener(j,n,c,t.isBeacon)}catch(e){vt(a,"Unexpected exception sending payload. Ex:"+tt(e)),A(r,0,{})}}),yn(l,(function(){return"HttpManager:_doPayloadSend.sender"}),()}),(,t.isSync)}t.sizeExceed&&t.sizeExceed.length>0&&J(t.sizeExceed,8003,t.sendType),t.failedEvts&&t.failedEvts.length>0&&J(t.failedEvts,8002,t.sendType)}nction J(e,t,n,i){if(e&&e.length>0&&r){var s=r[function(e){var t=ci[e];return Un(t)||(t="oth",e>=9e3&&e<=9999?t="rspFail":e>=8e3&&e<=8999?t="drop":e>=1e3&&e<=1999&&(t="send")),t}(t)];if(s){var o=0!==n;yn(l,(function(){return"HttpManager:_sendBatchesNotification"}),(,(,!o)}}}e.initialize=function(e,t,n,i,r){var s;r||(r={}),p=e+p,j=!!se(r.avoidOptions)||!r.avoidOptions,l=t,d=t.getCookieMgr(),E=!l.config.disableEventTimings;var f=!!l.config.enableCompoundKey;a=(o=n).diagLog();var v=r.valueSanitizer,y=r.stringifyObjects;se(r.enableCompoundKey)||(f=!!r.enableCompoundKey),u=r.xhrTimeout,h=!!r.disableXhrSync,m=!!r.disableFetchKeepAlive,b=!Ye(),T=new oi(l,v,y,f),oe(r.useSendBeacon)||(b=!!r.useSendBeacon);var S=i,w=r.alwaysUseXhrOverride?i:null,O=r.alwaysUseXhrOverride?i:null,I=[3,2];if(!i){C=!1;var N=Qe();N&&N.protocol&&"file:"===N.protocol.toLowerCase()&&(P=!1);var k=[];Ye()?(k=[2,1],I=[2,1,3]):k=[1,2,3],(i=_(k=pi(k,r.transports),!1))||vt(a,"No available transport to send events"),S=_(k,!0)}w||(w=_(I=pi(I,r.unloadTransports),!0)),g=!C&&(b&&nt()||!m&&it(!0)),(s={})[0]=i,s[1]=S||_([1,2,3],!0),s[2]=w||S||_([1],!0),s[3]=O||_([2,3],!0)||S||_([1],!0),c=s},e._getDbgPlgTargets=e.addQueryStringParameter=e.addHeader=function(e,t){O[e]=t},e.canSendRequest=e.sendQueuedRequests=e.isCompletelyIdle=e.setUnloading=function(e){k=e},e.addBatch=e.teardown=e.pause=e.resume=e.sendSynchronousBatch=))}return e.__ieDyn=1,e}(); Si=function(e){function t(){var n,i=e.call(this)||this;i.identifier="PostChannel",i.priority=1011,i.version="3.2.7";var r,s,o,a,c,l,d,u=!1,h=[],m=null,g=!1,p=0,f=500,v=0,y=1e4,b={},S="REAL_TIME",C=null,w=null,O=0,I=0,N={},T=-1,E=!0,k=!1,j=6,P=2;return V(t,i,(function(e,t){function i(e){"beforeunload"!==(e||$e().event).type&&s.setUnloading(k=!0),z(2,2)}function _(e){s.setUnloading(k=!1)}function M(e,t){if(e.sendAttempt||(e.sendAttempt=0),e.latency||(e.latency=1),e.ext&&e.ext.trace&&delete e.ext.trace,e.ext&&e.ext.user&&e.ext.user.id&&delete e.ext.user.id,E&&(e.ext=Fe(e.ext),e.baseData&&(e.baseData=Fe(e.baseData)),e.data&&(e.data=Fe(e.data))),e.sync)if(O||g)e.latency=3,e.sync=!1;else if(s)return E&&(e=Fe(e)),void s.sendSynchronousBatch(Yn.create(e.iKey,[e]),!0===e.sync?1:e.sync,3);var n=e.latency,i=v,r=y;4===n&&(i=p,r=f);var o=!1;if(i<r)o=!V(e,t);else{var a=1,c=20;4===n&&(a=4,c=1),o=!0,function(e,t,n,i){for(;n<=t;){var r=B(e,t,!0);if(r&&r.count()>0){var s=r.split(0,i),o=s.count();if(o>0)return 4===n?p-=o:v-=o,J("eventsDiscarded",[s],Qn.QueueFull),!0}n++}return U(),!1}(e.iKey,e.latency,a,c)&&(o=!V(e,t))}o&&W("eventsDiscarded",[e],Qn.QueueFull)}ction R(){n=null,u=!1,h=[],m=null,g=!1,p=0,f=500,v=0,y=1e4,b={},S="REAL_TIME",C=null,w=null,O=0,I=0,r=null,N={},o=void 0,a=0,T=-1,c=null,E=!0,k=!1,j=6,P=2,l=null,d=bi(),s=new fi(500,2,1,{requeue:$,send:Q,sent:X,drop:Z,rspFail:Y,oth:ee},d),G(),N[4]={batches:[],iKeyMap:{}},N[3]={batches:[],iKeyMap:{}},N[2]={batches:[],iKeyMap:{}},N[1]={batches:[],iKeyMap:{}},te()}n H(t,n,i){var r=!1,o=0===n;return!o||s.canSendRequest()?yn(e.core,(function(){return"PostChannel._queueBatches"}),(function(){for(var e=[],n=4;n>=t;){var i=N[n];i&&i.batches&&i.batches.length>0&&(Ce(i.batches,(),i.batches=[],i.iKeyMap={}),n--}e.length>0&&W("eventsDiscarded",e,Qn.KillSwitch),r&&T>=t&&(T=-1,c=0)}),(function(){return{latency:t,sendType:n,sendReason:i}}),!o):(T=T>=0?Math.min(T,t):t,c=Math.max(c,i)),r}unction $(t,n){var i=[],r=j;k&&(r=P),Ce(t,(),i.length>0&&W("eventsDiscarded",i,Qn.NonRetryableStatus),k&&z(2,2)}on Y(e){J("eventsDiscarded",e,Qn.NonRetryableStatus),A()}function ee(e,t){J("eventsDiscarded",e,Qn.Unknown),A()}(),e._getDbgPlgTargets=e.initialize=function(a,c,u){yn(c,(function(){return"PostChannel:initialize"}),(function(){var h=c;t.initialize(a,c,u);try{l=tn(Lt(e.identifier),c.evtNamespace&&c.evtNamespace());var m=e._getTelCtx();a.extensionConfig[e.identifier]=a.extensionConfig[e.identifier]||{},n=m.getExtCfg(e.identifier),d=bi(n.setTimeoutOverride,n.clearTimeoutOverride),E=!n.disableOptimizeObj&&!!He("chrome"),h),n.eventsLimitInMem>0&&(y=n.eventsLimitInMem),n.immediateEventLimit>0&&(f=n.immediateEventLimit),n.autoFlushEventsLimit>0&&(o=n.autoFlushEventsLimit),ve(n.maxEventRetryAttempts)&&(j=n.maxEventRetryAttempts),ve(n.maxUnloadEventRetryAttempts)&&(P=n.maxUnloadEventRetryAttempts),te(),n.httpXHROverride&&n.httpXHROverride.sendPOST&&(r=n.httpXHROverride),Un(a.anonCookieName)&&s.addQueryStringParameter("anoncknm",a.anonCookieName),s.sendHook=n.payloadPreprocessor,s.sendListener=n.payloadListener;var g=n.overrideEndpointUrl?n.overrideEndpointUrl:a.endpointUrl;e._notificationManager=a.extensionConfig.NotificationManager,s.initialize(g,e.core,e,r,n);var p=a.disablePageUnloadEvents||[];(function(e,t,n){!function(e,t,n,i){t&&e&&pe(e)&&!sn(e,t,n,i)&&n&&n.length>0&&sn(e,t,null,i)}(["beforeunload","unload","pagehide"],e,t,n)})(i,p,l),function e(t,n,i){var r=tn(Ut,i),s=sn(["pagehide"],t,n,r);return n&&-1!==we(n,"visibilitychange")||(s=sn(["visibilitychange"],(function(e){var n=Ke();t&&n&&"hidden"===n.visibilityState&&t(e)}),n,r)||s),!s&&n&&(s=e(t,null,i)),s}(i,p,l),_,a.disablePageShowEvents,l)}catch(t){throw e.setInitialized(!1),t}}),()},e.processTelemetry=e._doTeardown=function(e,t){z(2,2),u=!0,s.teardown(),on(["beforeunload","unload","pagehide"],null,l),function(e,t){var n=tn(Ut,t);on(["pagehide"],null,n),on(["visibilitychange"],null,n)}(0,l),function(e,t){var n=tn(Ht,t);on(["pageshow"],null,n),on(["visibilitychange"],null,n)}(0,l),R()},e.setEventQueueLimits=e.pause=e.resume=e.addResponseHandler=e._loadTransmitProfiles=function(e){q(),G(),S="REAL_TIME",A(),he(e,(function(e,t){var n=t.length;if(n>=2){var i=n>2?t[2]:0;t.splice(0,n-2),t[1]<0&&(t[0]=-1),t[1]>0&&t[0]>0&&(t[0]=Math.ceil(t[0]/t[1])*t[1]),i>=0&&t[1]>=0&&i>t[1]&&(i=t[1]),t.push(i),b[e]=t}}))},e.flush=e.setMsaAuthTicket=e.hasEvents=x,e._setTransmitProfile=e._backOffTransmission=e._clearBackOff=Ee(e,"_setTimeoutOverride",(function(){return d.set}),(),Ee(e,"_clearTimeoutOverride",(function(){return d.clear}),()})),i}return Object(cn.b)(t,e),t.__ieDyn=1,t}(Mn),Ci=),wi=function(){eturn e.prototype.create=e.prototype.fire=function(e){if(e&&e.complete(),this._callbacks)switch(e.name){case"HttpManager:_sendBatches":this.handleSendBatches(e);break;case"HttpManager:_sendBatchesNotification":this.handleSendBatchesNotification(e)}},e.prototype.setCtx=function(e,t){},e.prototype.getCtx=function(e){},e.prototype.handleSendBatches=function(e){this._callbacks.requestProcessingStats&&this._callbacks.requestProcessingStats(e.time||0,0)},e.prototype.handleSendBatchesNotification=function(e){if(this._callbacks.requestProcessingStats&&e.payload){var t=e.payload();if(t.batches&&t.reason&&t.reason>=1e3&&t.reason<=1999){var n=0;for(var i in t.batches)n+=t.batches[i].evts.length;this._callbacks.requestProcessingStats(0,n)}}},e}();function Oi(e,t,n,i){var r={instrumentationKey:t,endpointUrl:n,channelConfiguration:{eventsLimitInMem:e.eventsLimitInMem,httpXHROverride:e.httpXHROverride,setTimeoutOverride:e.setTimeoutOverride,clearTimeoutOverride:e.clearTimeoutOverride,ignoreMc1Ms0CookieProcessing:!0,disableOptimizeObj:!0},disableCookiesUsage:!0,extensionConfig:a({},e.extensionConfig)};e.stats&&e.stats.networkStats&&r.channelConfiguration&&(r.channelConfiguration.payloadListener=;var s=new Ni;return s.initialize(r,i),s.setUploadFrequency(e.uploadFrequency),e.notificationListener&&s.addNotificationListener(e.notificationListener),e.stats&&s.setPerfMgr(new wi(e.stats)),s}var Ii=function(e,t){t&&t.addNotificationListener({eventsSent:eventsDiscarded:)},Ni=function(e){eturn r(t,e),t.prototype.initialize=function(t,n){this._postChannel=new Si;var i=[];n&&(i=i.concat(n)),t.channels=[[this._postChannel]],t.extensionConfig=t.extensionConfig||[],t.extensionConfig[this._postChannel.identifier]=a(a({},t.channelConfiguration),t.extensionConfig[this._postChannel.identifier]);try{e.prototype.initialize.call(this,t,i)}catch(e){this.logger.warnToConsole("Failed to initialize SDK."+e)}},t.prototype.setUploadFrequency=function(e){if(this._postChannel&&e){var t=e/1e3,n={};n.OTelCustomTransmissionProfile=[t,t/2],this._postChannel._loadTransmitProfiles(n),this._postChannel._setTransmitProfile("OTelCustomTransmissionProfile")}},t.prototype.flush=t.prototype.shutdown=t}(Jn),Ti=function(e){function t(t,n){var i,r,s=e.call(this,t,n)||this;s.sendTelemetryEvent=function(e){return h((function(){var t=s.getOneDSTelemetryEvent(e);t&&i&&i.track(t)}),void 0)},s.sendCustomerContent=function(e){return h((,void 0)},s.sendNonStandardEvent=function(e,t){var n=!1;c.forEach((function(i){if(i.canHandle(t))return i.processEvent(e),void(n=!0)})),n||l(0,1,()},s.flush=function(e){null==i||i.flush(e),null==r||r.flush(e),c.forEach((function(t){t.flush(e)}))},s.shutdown=function(){try{null==i||i.shutdown(),null==r||r.shutdown(),c.forEach((function(e){e.shutdown()}))}catch(e){l(0,2,(function(){return"An error occurred on shutdown"}))}};var a=n.plugins||[],c=n.specialEventHandlers||[];if(c.forEach((),!n.endpointUrl)throw new Error("Missing Endpoint Url");return i=Oi(n,"f998cc5ba4d448d6a1e8e913ff18be94-dd122e0a-fcf8-4dc5-9dbb-6afac5325183-7405",n.endpointUrl,a),n.enableCustomerContent&&n.endpointUrl===o.PUBLIC&&(r=Oi(n,"b22a201c3f1d41d28ccc399ba6cc9ca2-1972c77f-1f79-4283-a0f9-b4ddc4646f55-7121",o.CUSTOMER_CONTENT,a)),n.disableStatsTracking||(Ii(s,i),Ii(s,r)),s}return r(t,e),t}(pn);"object"==typeof window&&"object"==typeof window.performance&&window;var Ei=function(){var e;return(e={}).q=0,e.po={},e.pw=0,e.wa=0,e.wp=0,e.wd=0,e.wr={},e.ws=0,e.pm=0,e.sp=0,e.ss=0,e.sd=0,e.pd={},e.md=0,e.d=0,e.b=0,e.s=0,e},ki=function(){function e(e){var t=this;this._handlerProps=e,this._stats=Ei(),this._oneDsStats={requestProcessingStats:function(e,n){t._stats.wp+=n,t._stats.d+=e,t.statsUpdated()},networkStats:function(e){t._stats.b+=e,t.statsUpdated()}},this._listener={eventsSent:function(e){t._stats.ws+=e.length,t.statsUpdated()},eventsDiscarded:function(e,n){t._stats.wd+=e.length,t._stats.wr[n]=t._stats.wr[n]+e.length||e.length,t.statsUpdated()}}}return e.prototype.statsUpdated=function(){var e=this;void 0===this._statsTimer&&(this._statsTimer=setTimeout((function(){e.postMessage({d:e._stats,t:4}),e._stats=Ei(),e._statsTimer=void 0}),1e3))},e.prototype.postMessage=function(e){this._handlerProps.postMessage(e)},e.prototype.ensureInitialized=function(){return void 0!==this._oneDsSink},e.prototype.handleInitializeMessage=function(e){var t=a(a(a({stats:this._oneDsStats},this._handlerProps.oneDSSinkProps),e),{notificationListener:this._listener});t.endpointUrl?this._oneDsSink=new Ti(e.persistentDataFields,t):this.postMessage({d:21,t:5})},e.prototype.handleTelemetryEventMessage=function(e){var t=this;this.ensureInitialized()?(e.d.forEach((function(e){switch(t._stats.wa++,e.t){case 1:t._oneDsSink.sendTelemetryEvent(e.event);break;case 2:t._oneDsSink.sendCustomerContent(e.event);break;case 3:t._oneDsSink.sendNonStandardEvent(e.event,e.t)}})),this._oneDsSink.flush(!1)):this.postMessage({d:15,t:5})},e.prototype.handleMessage=function(e){if(e&&e.data){var t=e.data;switch(t.t){case 2:this.handleInitializeMessage(t.d);break;case 3:this.handleTelemetryEventMessage(t)}}},e.prototype.postLoadedMessage=e}();function ji(e){var t=new ki({oneDSSinkProps:e||{},postMessage:function(e){self.postMessage(e)}});self.addEventListener("message",t.handleMessage.bind(t)),t.postLoadedMessage()}},,,,function(e,t,n){n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return a})),n.d(t,"c",(function(){return c}));var i=n(0),r=n(3),s=(Object(r.a)(),Object(r.a)(),i.a||,o=)}))}.toString(),")()"],{type:"text/javascript"}));s.init({...o,persistentDataFields:r},{uuid:h.a,getWorker:()=>new Worker(a,{type:"module"})}),"undefined"==typeof window?i.on("exit",(()=>{s.shutdown(!0)})):window.addEventListener("beforeunload",();const l=this.getAriaInfoFromService(this.context.serviceLoggingInfo);return t.setTenantToken(l.namespacePrefix,l.token,c.b),s.startWorker(),t.addSink(s),s},this.setSharedSink=(e,t)=>{if(1==e.telemetrySinks.length&&e.telemetrySinks[0]instanceof u.a){if(1!=t.enabled)return;e.telemetrySinks[0].shutdown(!0),e.telemetrySinks.shift()}const n=this.getAriaInfoFromService(this.context.serviceLoggingInfo);e.setTenantToken(n.namespacePrefix,n.token,c.b),e.addSink(t)},this.eventStatsBuffer=t.eventStatsBuffer,this.eventNamePrefix="",this.context=this.getContext(),this.otelLogger=new l.a(void 0,void 0,{disableValidation:!0}),this.loggerInit=!1,this.isRequestIdleCallbackScheduled=!1,this.activityQueue=[],this.eventMap=new Map,f.a&&(window.requestIdleCallback=window.requestIdleCallback||this.requestIdleCallbackShim),this.sequenceNumber=0}setPodLocationIdoggerIsInitialized(){return this.loggerInit}toBufferendTelemetryEvent(e,t,n,i,r,s,o){const a={eventName:e,logLevel:t,operationName:n,component:i,description:r,logParams:JSON.stringify(s),sequenceNumber:this.sequenceNumber++};this.prepareAndFireEvent(a,o)}sendCustomTelemetryEventendTelemetryErrorEvent(e,t,n,i,r,s,o,a,c){var l,d;const u={eventName:e,mfsStatusCode:s,errorMessage:(null==r?void 0:r.message)?null==r?void 0:r.message:"",errorStack:(null===(l=null==r?void 0:r.error)||void 0===l?void 0:l.stack)?null===(d=null==r?void 0:r.error)||void 0===d?void 0:d.stack:"",errorType:(null==r?void 0:r.errorType)?null==r?void 0:r.errorType:"",userMessage:(null==r?void 0:r.message)?null==r?void 0:r.message:"",logLevel:t,operationName:n,component:i,verboseLogs:o,logParams:JSON.stringify(a),sequenceNumber:this.sequenceNumber++};this.prepareAndFireEvent(u,c)}sendActivityEvent(e,t,n,i,r,s,o){const a=Object(p.a)(),c=s||a,l=o||Date.now();this.activityQueue.push({result:e,activityObj:t,shouldSend:n,processedEndTime:c,processedCallTime:l,errorObject:i,verboseLogs:r}),this.isRequestIdleCallbackScheduled||this.scheduleSendingActivities()}requestIdleCallbackShimendStatsEventToTelemetry(){const e=this.otelLogger.telemetrySinks[0];this.isWebSink(e)&&(this.eventStatsBuffer.stats.websinkStats=e.stats);const t=N.concat(this.getDataFieldsFromProps(this.eventStatsBuffer.stats)),n={eventName:`${this.eventNamePrefix}.${w.b}`,eventFlags:{dataCategories:s.a.DataCategories.ProductServiceUsage,diagnosticLevel:s.a.DiagnosticLevel.RequiredServiceData},dataFields:t,timestamp:Date.now()};this.otelLogger.sendTelemetryEvent(n),this.eventStatsBuffer.clearEventStats(Date.now())}}).call(this,n("Ono3")(e),n("5IsQ"))},d6Vr:dIZa:dkAV:function(e,t,n){"use strict";n.d(t,"h",(function(){return i})),n.d(t,"e",(function(){return r})),n.d(t,"g",(function(){return s})),n.d(t,"l",(function(){return o})),n.d(t,"f",(function(){return a})),n.d(t,"k",(function(){return c})),n.d(t,"d",(function(){return l})),n.d(t,"j",(function(){return d})),n.d(t,"c",(function(){return u})),n.d(t,"a",(function(){return h})),n.d(t,"b",(function(){return m})),n.d(t,"i",(function(){return g}));const i="Personal",r="Card",s="Tag",o=3,a="Tag Container",c="Tag Container Id",l=100,d=["label","labelId","displayText","origin","title","secondaryLabels","activities","kind","id","tags","updatedAt","inUse"],u="02fd0275-74ff-4b12-8a94-719af744c614",h="defaultPod",m="detachedPodId",g="fluidConnected"},e1Ej:e766:eVZi:function(e,t,n){var i=n("TQ2W"),r=n("y0Qj"),s=65536,o=u(5<<20),a=function(){try{return new Uint32Array(s)}catch(n){for(var e=new Array(s),t=0;t<s;t++)e[t]=0;return e}}(),c=407708164,l=2147483648,d={4:65536,5:262144,6:1048576,7:4194304};function u(e){try{return new Uint8Array(e)}catch(i){for(var t=new Array(e),n=0;n<e;n++)t[n]=0;return t}}function h(e,t,n){if(void 0!==typeof e.buffer){if(Uint8Array.prototype.slice)return e.slice(t,n);var i=e.length;t=(t|=0)<0?Math.max(i+t,0):Math.min(t,i),n=(n=void 0===n?i:0|n)<0?Math.max(i+n,0):Math.min(n,i);for(var r=new Uint8Array(n-t),s=t,o=0;s<n;)r[o++]=e[s++];return r}return e.slice(t,n)}t.compressBound=function(e){return e+e/255+16|0},t.decompressBound=function(e){var t=0;if(r.readU32(e,t)!==c)throw new Error("invalid magic number");t+=4;var n=e[t++];if(64!=(192&n))throw new Error("incompatible descriptor version "+(192&n));var i=0!=(16&n),s=0!=(8&n),o=e[t++]>>4&7;if(void 0===d[o])throw new Error("invalid block size "+o);var a=d[o];if(s)return r.readU64(e,t);t++;for(var u=0;;){var h=r.readU32(e,t);if(t+=4,u+=h&l?h&=2147483647:a,0===h)return u;i&&(t+=4),t+=h}},t.makeBuffer=u,t.decompressBlock=function(e,t,n,i,r){var s,o,a,c,l;for(a=n+i;n<a;){var d=e[n++],u=d>>4;if(u>0){if(15===u)for(;u+=e[n],255===e[n++];);for(c=n+u;n<c;)t[r++]=e[n++]}if(n>=a)break;if(o=e[n++]|e[n++]<<8,15==(s=15&d))for(;s+=e[n],255===e[n++];);for(c=(l=r-o)+(s+=4);l<c;)t[r++]=0|t[l++]}return r},t.compressBlock=function(e,t,n,i,s){var o,a,c,l,d,u,h,m;if(u=0,h=i+n,a=n,i>=13)for(var g=67;n+4<h-5;){var p=r.readU32(e,n),f=r.hashU32(p)>>>0;if(o=s[f=(f>>16^f)>>>0&65535]-1,s[f]=n+1,o<0||n-o>>>16>0||r.readU32(e,o)!==p)n+=g++>>6;else{for(g=67,d=n-a,l=n-o,o+=4,c=n+=4;n<h-5&&e[n]===e[o];)n++,o++;var v=(c=n-c)<15?c:15;if(d>=15){for(t[u++]=240+v,m=d-15;m>=255;m-=255)t[u++]=255;t[u++]=m}else t[u++]=(d<<4)+v;for(var y=0;y<d;y++)t[u++]=e[a+y];if(t[u++]=l,t[u++]=l>>8,c>=15){for(m=c-15;m>=255;m-=255)t[u++]=255;t[u++]=m}a=n}}if(0===a)return 0;if((d=h-a)>=15){for(t[u++]=240,m=d-15;m>=255;m-=255)t[u++]=255;t[u++]=m}else t[u++]=d<<4;for(n=a;n<h;)t[u++]=e[n++];return u},t.decompressFrame=function(e,n){var i,s,o,a,u=0,h=0;if(r.readU32(e,u)!==c)throw new Error("invalid magic number");if(u+=4,64!=(192&(a=e[u++])))throw new Error("incompatible descriptor version");i=0!=(16&a),s=0!=(4&a),o=0!=(8&a);var m=e[u++]>>4&7;if(void 0===d[m])throw new Error("invalid block size");for(o&&(u+=8),u++;;){var g;if(g=r.readU32(e,u),u+=4,0===g)break;if(i&&(u+=4),0!=(g&l)){g&=2147483647;for(var p=0;p<g;p++)n[h++]=e[u++]}else h=t.decompressBlock(e,n,u,g,h),u+=g}return s&&(u+=4),h},t.compressFrame=function(e,n){var l=0;r.writeU32(n,l,c),l+=4,n[l++]=64,n[l++]=112,n[l]=i.hash(0,n,4,l-4)>>8,l++;var u=d[7],h=e.length,m=0;for(function(e){for(var t=0;t<s;t++)a[t]=0}();h>0;){var g,p=h>u?u:h;if((g=t.compressBlock(e,o,m,p,a))>p||0===g){r.writeU32(n,l,2147483648|p),l+=4;for(var f=m+p;m<f;)n[l++]=e[m++];h-=p}else{r.writeU32(n,l,g),l+=4;for(var v=0;v<g;)n[l++]=o[v++];m+=p,h-=p}}return r.writeU32(n,l,0),l+4},t.decompress=function(e,n){var i,r;return void 0===n&&(n=t.decompressBound(e)),i=t.makeBuffer(n),(r=t.decompressFrame(e,i))!==n&&(i=h(i,0,r)),i},t.compress=function(e,n){var i,r;return void 0===n&&(n=t.compressBound(e.length)),i=t.makeBuffer(n),(r=t.compressFrame(e,i))!==n&&(i=h(i,0,r)),i}},"etL/":function(e,t,n){"use strict";n.d(t,"c",(function(){return c})),n.d(t,"f",(function(){return l})),n.d(t,"h",(function(){return u})),n.d(t,"d",(function(){return m})),n.d(t,"i",(function(){return g})),n.d(t,"j",(function(){return p})),n.d(t,"e",(function(){return v})),n.d(t,"g",(function(){return y})),n.d(t,"a",(function(){return C})),n.d(t,"b",(function(){return w}));var i=n("A3AF");const r=e=>"function"==typeof(null==e?void 0:e.getTelemetryProperties)&&"function"==typeof(null==e?void 0:e.addTelemetryProperties),s=e=>"string"==typeof(null==e?void 0:e.errorInstanceId);function o(e){return"string"==typeof(null==e?void 0:e.errorType)&&"string"==typeof(null==e?void 0:e.message)&&s(e)&&r(e)}function a(e){return"string"==typeof(null==e?void 0:e.errorType)&&"string"==typeof(null==e?void 0:e.message)&&r(e)}function c(e,t){const n={message:"string"==typeof(null==e?void 0:e.message)?e.message:String(e)};if((e=>null!==e&&!Array.isArray(e)&&"object"==typeof e)(e)){const{errorType:i,stack:r,name:s}=e;"string"==typeof i&&(n.errorType=i),"string"==typeof r&&(n.stack=((e,n)=>{if(!t)return e;const i=e.split("\n");return i.shift(),void 0!==n&&i.unshift(n),i.join("\n")})(r,"string"==typeof s?s:void 0))}return n}const l=e=>"function"==typeof(null==e?void 0:e.getTelemetryProperties);function d(e){void 0===e.errorInstanceId&&(e.errorInstanceId=Object(i.a)())}function u(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var n;if(a(e)&&d(e),o(e))return e.addTelemetryProperties(null!==(n=t.props)&&void 0!==n?n:{}),e;const{message:i,stack:r}=c(e,!1),s=new O({message:i,stack:r});if("object"==typeof e&&null!==e){const{canRetry:t,retryAfterSeconds:n}=e;Object.assign(u,{canRetry:t,retryAfterSeconds:n})}"object"!=typeof e&&s.addTelemetryProperties({typeofError:typeof e});const l=C.typeCheck(e)?e.getTelemetryProperties():{untrustedOrigin:1};return s.addTelemetryProperties(Object.assign(Object.assign({},l),t.props)),s}let h;function m(){return function(){const e=new Error("<<generated stack>>");if(void 0===h&&(h=void 0!==e.stack),h)return e;try{throw e}catch(e){return e}}().stack}function g(e,t){const{message:n,stack:i}=c(e,!1),r=t(n);return void 0!==i&&f(r,i),v(e)&&r.addTelemetryProperties({untrustedOrigin:1}),s(e)&&(r.overwriteErrorInstanceId(e.errorInstanceId),r.addTelemetryProperties({innerErrorInstanceId:e.errorInstanceId})),l(e)&&r.addTelemetryProperties(e.getTelemetryProperties()),r}function p(e,t,n){const i=g(e,t),r=i.errorInstanceId;return n.sendTelemetryEvent({eventName:"WrapError",errorInstanceId:r,wrappedByErrorInstanceId:r},e),i}function f(e,t){try{Object.assign(e,{stack:t})}catch(n){e.addTelemetryProperties({stack2:t})}}function v(e){return C.typeCheck(e)?e.errorType===w&&1===e.getTelemetryProperties().untrustedOrigin:!a(e)}function y(e){var t;return"string"==typeof(null===(t=e)||void 0===t?void 0:t.tag)}function b(e,t){return Array.isArray(e)&&e.every((e=>S(e)))?JSON.stringify(e):S(e)?e:(console.error(`UnSupported Format of Logging Error Property for key ${t}:`,e),"REDACTED (arbitrary object)")}function S(e){switch(typeof e){case"string":case"number":case"boolean":case"undefined":return!0;default:return!1}}class C extends Error{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Set;super(e),this.omitPropsFromLogging=n,this._errorInstanceId=Object(i.a)(),this.fluidErrorCode="-",n.add("omitPropsFromLogging"),n.add("_errorInstanceId"),t&&this.addTelemetryProperties(t)}get errorInstanceId(){return this._errorInstanceId}overwriteErrorInstanceId(e){this._errorInstanceId=e}static typeCheck(e){return"object"==typeof e&&null!==e&&"function"==typeof e.addTelemetryProperties&&"function"==typeof e.getTelemetryProperties&&"string"==typeof e.errorInstanceId}addTelemetryProperties(e){!function(e,t){for(const n of Object.keys(t))void 0===e[n]&&(e[n]=t[n])}(this,e)}getTelemetryProperties(){const e=function(e,t){const n={};for(const i of Object.keys(e)){if(t.has(i))continue;const r=e[i];n[i]=y(r)?{value:b(r.value,i),tag:r.tag}:b(r,i)}return n}(this,this.omitPropsFromLogging);return Object.assign(Object.assign({},e),{stack:this.stack,message:this.message,errorInstanceId:this._errorInstanceId})}}const w="genericError";class O extends C{constructor(e){super(e.message),this.errorType=w,void 0!==e.stack&&f(this,e.stack)}}},"f/Xo":f79D:function(e,t,n){"use strict";var i,r,s;n.d(t,"a",(function(){return i})),n.d(t,"c",(function(){return r})),n.d(t,"b",(function(){return s})),i||(i={})),function(e){e.ClientJoin="join",e.ClientLeave="leave"}(r||(r={})),function(e){e.ThrottlingError="ThrottlingError",e.InvalidScopeError="InvalidScopeError",e.BadRequestError="BadRequestError",e.LimitExceededError="LimitExceededError"}(s||(s={}))},fDqU:function(e,t,n){"use strict";var i;n.d(t,"a",(function(){return a})),i||(i={}));const r=[{keyword:"PhantomJS/",browserType:i.PhantomJS},{keyword:"Edge/",browserType:i.EdgeLegacy},{keyword:"EdgA/",browserType:i.Edge},{keyword:"EdgiOS/",browserType:i.Edge},{keyword:"Edg/",browserType:i.Edge},{keyword:"wv/",browserType:i.WebView},{keyword:"MSIE/",browserType:i.IE},{keyword:"Trident/",browserType:i.IE},{keyword:"OPR/",browserType:i.Opera},{keyword:"Chrome/",browserType:i.Chrome},{keyword:"CriOS/",browserType:i.Chrome},{keyword:"Firefox/",browserType:i.Firefox},{keyword:"Safari/",browserType:i.Safari}];var s;!s||(s={}));const o=[{keyword:"Windows NT",platformType:s.PC},{keyword:"Windows XP",platformType:s.PC},{keyword:"Macintosh",platformType:s.Mac},{keyword:"Windows Phone",platformType:s.WindowsPhone},{keyword:"iPad",platformType:s.iPad},{keyword:"iPhone",platformType:s.iPhone},{keyword:"Android",platformType:s.AndroidPhone},{keyword:"Linux",platformType:s.Linux},{keyword:"CrOS",platformType:s.Chromebook}];function a(){return{browser:function(){const e=navigator.userAgent;let t={name:"Other",version:"v1"};return r.some((n=>{if(e.includes(n.keyword)){const i=n.browserType,r=e.split(n.keyword)[1].split(" ")[0];return t={name:i,version:r},!0}return!1})),t}(),os:function(){const e=navigator.userAgent,t=e.toLowerCase();let n={keyword:"Other",platformType:s.Other};o.some((e=>!!t.includes(e.keyword.toLowerCase())&&(n=e,!0))),n.platformType===s.AndroidPhone&&-1===t.indexOf("mobile")&&(n={keyword:"Android",platformType:s.AndroidTablet});let i="0.0.0";if(n.platformType===s.Mac){const t=/Mac OS X (\d+)(_|\.)(\d+)([_.]?)(\d*)/i.exec(e);t&&t.length>=6&&(i=`${t[1]}.${t[3]}.${t[5]}`)}else if(n.platformType===s.PC||n.platformType===s.WindowsPhone)if(-1!==t.indexOf("windows xp"))i="5.1.0";else{const t=/Windows (NT|Phone) (OS )?(\d+)\.(\d+)/i.exec(e);t&&t.length>=5&&(i=`${t[3]}.${t[4]}.0`)}else if(n.platformType===s.iPad||n.platformType===s.iPhone){const e=t.match(/os (\d+)_(\d+)(_(\d+))?/);e&&(i=`${e[1]||0}.${e[2]||0}.${e[4]||0}`)}else if(n.platformType===s.AndroidPhone||n.platformType===s.AndroidTablet){const e=t.match(/Android (\d+).(\d+)(.(\d+))?/);e&&(i=`${e[1]||0}.${e[2]||0}.${e[4]||0}`)}return{name:n.keyword,version:i}}()}}},fRAL:fxeQ:fxwU:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));const i="2.0.0-internal.4.3.0"},gczY:function(e,t,n){"use strict";n.d(t,"c",(function(){return h})),n.d(t,"b",(function(){return p})),n.d(t,"a",(function(){return f}));var i=n("so/P"),r=n("A3AF"),s=n("Xou4"),o=n("cGWa"),a=n("7/yF"),c=n("he5V"),l=n("HJ7Z"),d=n("etL/"),u=n("DLbW");function h(e){var t;const n=Object(i.parse)(e,!0);if("string"!=typeof n.pathname)throw new d.a("Failed to parse pathname");const r=null!==(t=n.search)&&void 0!==t?t:"",s=/^\/([^/]*\/[^/]*)(\/?.*)$/.exec(n.pathname);return 3===(null==s?void 0:s.length)?{id:s[1],path:s[2],query:r,version:n.query.version}:void 0}function m(e){const t={blobs:{},blobsContents:{},trees:{},id:Object(r.a)(),unreferenced:e.unreferenced},n=Object.keys(e.tree);for(const i of n){const n=e.tree[i];switch(n.type){case l.a.Tree:t.trees[i]=m(n);break;case l.a.Attachment:t.blobs[i]=n.id;break;case l.a.Blob:{const e=Object(r.a)();t.blobs[i]=e;const a="string"==typeof n.content?Object(s.e)(n.content,"utf8"):Object(o.a)(n.content);t.blobsContents[e]=a;break}case l.a.Handle:throw new d.a("No handles should be there in summary in detached container!!");default:Object(a.a)(n,`Unknown tree type ${n.type}`)}}return t}function g(e,t){const n={type:l.a.Tree,tree:Object.assign({},t.tree)};return n.tree[".protocol"]=e,m(n)}const p=e=>(Object(c.a)(Object(u.d)(e),480),g(e.tree[".protocol"],e.tree[".app"]));function f(e){return".protocol"in e.trees?e.trees[".protocol"]:e}},gwRl:h0av:htzX:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.totalBlobSizePropertyName=t.CreateSummarizerNodeSource=t.channelsTreeName=t.blobCountPropertyName=t.gcTreeKey=t.gcTombstoneBlobKey=t.gcDeletedBlobKey=t.gcBlobPrefix=t.IFluidDataStoreRegistry=t.IFluidDataStoreFactory=t.VisibilityState=t.FlushModeExperimental=t.FlushMode=void 0;var i=n("1hTJ");Object.defineProperty(t,"FlushMode",{enumerable:!0,get:function(){return i.FlushMode}}),Object.defineProperty(t,"FlushModeExperimental",{enumerable:!0,get:function(){return i.FlushModeExperimental}}),Object.defineProperty(t,"VisibilityState",{enumerable:!0,get:function(){return i.VisibilityState}});var r=n("sNwM");Object.defineProperty(t,"IFluidDataStoreFactory",{enumerable:!0,get:function(){return r.IFluidDataStoreFactory}});var s=n("PixY");Object.defineProperty(t,"IFluidDataStoreRegistry",{enumerable:!0,get:function(){return s.IFluidDataStoreRegistry}});var o=n("T2h0");Object.defineProperty(t,"gcBlobPrefix",{enumerable:!0,get:function(){return o.gcBlobPrefix}}),Object.defineProperty(t,"gcDeletedBlobKey",{enumerable:!0,get:function(){return o.gcDeletedBlobKey}}),Object.defineProperty(t,"gcTombstoneBlobKey",{enumerable:!0,get:function(){return o.gcTombstoneBlobKey}}),Object.defineProperty(t,"gcTreeKey",{enumerable:!0,get:function(){return o.gcTreeKey}});var a=n("8d3v");Object.defineProperty(t,"blobCountPropertyName",{enumerable:!0,get:function(){return a.blobCountPropertyName}}),Object.defineProperty(t,"channelsTreeName",{enumerable:!0,get:function(){return a.channelsTreeName}}),Object.defineProperty(t,"CreateSummarizerNodeSource",{enumerable:!0,get:function(){return a.CreateSummarizerNodeSource}}),Object.defineProperty(t,"totalBlobSizePropertyName",{enumerable:!0,get:function(){return a.totalBlobSizePropertyName}})},i0JV:iOq2:iTAa:iXK7:jL4t:jgJv:function(e,t,n){var i=n("s3UK");e.exports=i.Symbol},jjHt:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.totalBlobSizePropertyName=t.blobCountPropertyName=t.channelsTreeName=t.CreateSummarizerNodeSource=void 0,function(e){e[e.FromSummary=0]="FromSummary",e[e.FromAttach=1]="FromAttach",e[e.Local=2]="Local"}(t.CreateSummarizerNodeSource||(t.CreateSummarizerNodeSource={})),t.channelsTreeName=".channels",t.blobCountPropertyName="BlobCount",t.totalBlobSizePropertyName="TotalBlobSize"},kCQp:kKrb:function(e,t){var n=1e3,i=60*n,r=60*i,s=24*r;.exports=,l4ds:l7Do:lLPU:lMKH:function(e,t,n){"use strict";n.d(t,"b",(function(){return r})),n.d(t,"d",(function(){return s})),n.d(t,"c",(function(){return a})),n.d(t,"e",(function(){return c})),n.d(t,"a",(function(){return u}));var i=n("A3AF");function r(e,t){const n={message:"string"==typeof(null==e?void 0:e.message)?e.message:String(e)};if((e=>null!==e&&!Array.isArray(e)&&"object"==typeof e)(e)){const{errorType:i,stack:r,name:s}=e;"string"==typeof i&&(n.errorType=i),"string"==typeof r&&(n.stack=((e,n)=>{if(!t)return e;const i=e.split("\n");return i.shift(),void 0!==n&&i.unshift(n),i.join("\n")})(r,"string"==typeof s?s:void 0))}return n}const s=e=>"function"==typeof(null==e?void 0:e.getTelemetryProperties);let o;function a(){return function(){const e=new Error("<<generated stack>>");if(void 0===o&&(o=void 0!==e.stack),o)return e;try{throw e}catch(e){return e}}().stack}function c(e){var t;return"string"==typeof(null===(t=e)||void 0===t?void 0:t.tag)}function l(e,t){return Array.isArray(e)&&e.every((e=>d(e)))?JSON.stringify(e):d(e)?e:(console.error(`UnSupported Format of Logging Error Property for key ${t}:`,e),"REDACTED (arbitrary object)")}function d(e){switch(typeof e){case"string":case"number":case"boolean":case"undefined":return!0;default:return!1}}class u extends Error{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Set;super(e),this.omitPropsFromLogging=n,this._errorInstanceId=Object(i.a)(),this.fluidErrorCode="-",n.add("omitPropsFromLogging"),n.add("_errorInstanceId"),t&&this.addTelemetryProperties(t)}get errorInstanceId(){return this._errorInstanceId}overwriteErrorInstanceId(e){this._errorInstanceId=e}static typeCheck(e){return"object"==typeof e&&null!==e&&"function"==typeof e.addTelemetryProperties&&"function"==typeof e.getTelemetryProperties&&"string"==typeof e.errorInstanceId}addTelemetryProperties(e){!function(e,t){for(const n of Object.keys(t))void 0===e[n]&&(e[n]=t[n])}(this,e)}getTelemetryProperties(){const e=function(e,t){const n={};for(const i of Object.keys(e)){if(t.has(i))continue;const r=e[i];n[i]=c(r)?{value:l(r.value,i),tag:r.tag}:l(r,i)}return n}(this,this.omitPropsFromLogging);return Object.assign(Object.assign({},e),{stack:this.stack,message:this.message,errorInstanceId:this._errorInstanceId})}}},lYsT:lgYy:lphy:function(e,t,n){(function(e,i){var r;!function(i){var s,o=2147483647,a=36,c=/^xn--/,l=/[^\x20-\x7E]/,d=/[\x2E\u3002\uFF0E\uFF61]/g,u={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},h=Math.floor,m=String.fromCharCode;O(e){var t,n,i,r,s,c,l,d,u,p,f,y,b,w,O,I=[];for(y=(e=v(e)).length,t=128,n=0,s=72,c=0;c<y;++c)(f=e[c])<128&&I.push(m(f));for(i=r=I.length,r&&I.push("-");i<y;){for(l=o,c=0;c<y;++c)(f=e[c])>=t&&f<l&&(l=f);for(l-t>h((o-n)/(b=i+1))&&g("overflow"),n+=(l-t)*b,t=l,c=0;c<y;++c)if((f=e[c])<t&&++n>o&&g("overflow"),f==t){for(d=n,u=a;!(d<(p=u<=s?1:u>=s+26?26:u-s));u+=a)I.push(m(S(p+(O=d-p)%(w=a-p),0))),d=h(O/w);I.push(m(S(d,0))),s=C(n,b,i==r),n=0,++i}++n,++t}return I.join("")}s={version:"1.4.1",ucs2:{decode:v,encode:y},decode:w,encode:O,toASCII:toUnicode:,void 0===(r=function(){return s}.call(t,n,t,e))||(e.exports=r)}()}).call(this,n("RoC8")(e),n("pCvA"))},n3ZG:function(e,t,n){"use strict";var i;n.d(t,"k",(function(){return i})),n.d(t,"g",(function(){return r})),n.d(t,"m",(function(){return ce})),n.d(t,"v",(function(){return le})),n.d(t,"d",(function(){return bp})),n.d(t,"e",(function(){return Sp})),n.d(t,"h",(function(){return Ip})),n.d(t,"c",(function(){return qg})),n.d(t,"b",(function(){return zg})),n.d(t,"s",(function(){return ee})),n.d(t,"p",(function(){return te})),n.d(t,"q",(function(){return ne})),n.d(t,"i",(function(){return Np})),n.d(t,"f",(function(){return Ep})),n.d(t,"a",(function(){return kp})),n.d(t,"r",(function(){return mp})),n.d(t,"t",(function(){return gp})),n.d(t,"n",(function(){return O})),n.d(t,"l",(function(){return s})),n.d(t,"u",(function(){return m})),n.d(t,"o",(function(){return L})),n.d(t,"j",(function(){return ae})),function(e){e[e.OneWay=0]="OneWay",e[e.TwoWay=1]="TwoWay"}(i||(i={}));const r={None:0,OrderedList:1},s={fail:ok:e=>({isOK:!0,value:e})};var o,a,c,l,d,u,h=n("qDpI");!function(e){e[e.Before=0]="Before",e[e.After=1]="After"}(o||(o={})),function(e){e[e.Malformed=0]="Malformed",e[e.Invalid=1]="Invalid",e[e.Applied=2]="Applied"}(a||(a={})),function(e){e[e.Edit=0]="Edit",e[e.Handle=1]="Handle",e[e.NoOp=2]="NoOp",e[e.Update=3]="Update"}(c||(c={})),function(e){e.v0_0_2="0.0.2",e.v0_1_1="0.1.1"}(l||(l={})),d||(d={})),function(e){e[e.InvalidAndDiscard=0]="InvalidAndDiscard",e[e.InvalidRetry=1]="InvalidRetry",e[e.ValidRetry=2]="ValidRetry"}(u||(u={}));const m={conflictingRule:e=>new h.f(`Conflicting ${e} rules`,h.g.BadRequest),nullOrWhitespace:e=>new h.f(`${e} must not be null or a whitespace.`,h.g.BadRequest),emptyMfsQuery:()=>new h.f("query should specify at least one option",h.g.NotAllowed),emptySelectQuery:()=>new h.f("select should specify at least one app property set",h.g.NotAllowed),mustBePositiveInteger:e=>new h.f("Name must be an integer value greater than 0",h.g.BadRequest),invalidStableNodeId:(e,t)=>new h.f(t?`Node ID ${t} produced an invalid Stable Node ID ${e}`:`Invalid Stable Node ID ${e}`,h.g.NotAllowed),invalidPosition:()=>new h.f("Invalid position provided.",h.g.BadRequest),invalidCollectionKind:()=>new h.f("Collection kind value is not recognized.",h.g.BadRequest),invalidCollectionValues:()=>new h.f("Collection values should be an array of Mfs Item Ids.",h.g.BadRequest),circularReference:()=>new h.f("Circular references are not allowed.",h.g.BadRequest),invalidMove:()=>new h.f("Invalid move attempted. Make sure the elementIds in `from` and `to` are different and `from` is not an ancestor of `to`.",h.g.BadRequest),invalidQueryDepth:e=>new h.f(`Invalid depth: ${e}. Depth should be a positive integer >= 1`,h.g.BadRequest),systemPropertiesProvided:()=>new h.f("Providing system properties in item is not allowed",h.g.NotAllowed),emptyValues:e=>new h.f("Empty values are not allowed.",h.g.BadRequest),maxInputLengthExceeded:e=>new h.f("Max input length exceeded",h.g.BadRequest),assertionFailed:()=>new h.f("Assertion failed",h.g.BadRequest),invalidItemId:()=>new h.f("Invalid item id provided",h.g.BadRequest),invalidItem:()=>new h.f("Attempted to read an item which was missing required properties.",h.g.BadRequest),invalidSecLabel:()=>new h.f("Invalid label value provided in secondary labels.",h.g.BadRequest),invalidLabel:()=>new h.f("Invalid label provided.",h.g.BadRequest),invalidLabelId:()=>new h.f("Invalid label id provided.",h.g.BadRequest),invalidDisplayText:()=>new h.f("Invalid display text value provided.",h.g.BadRequest),invalidSecLabelsDelta:()=>new h.f("Invalid label value provided in the add/remove values for secondary labels.",h.g.BadRequest),invalidMfsDeltaValue:()=>new h.f("Invalid delta value provided. At least one of values to add or remove must be defined.",h.g.BadRequest),itemNotFound:e=>new h.f(`item id: ${e} does not exist`,h.g.NotFound),notCollectionItem:e=>new h.f(`Item with id:${e} is not a collection item.`,h.g.BadRequest),labelIdInUse:(e,t,n)=>new ae(e),invalidEdgeLabel:()=>new h.f("Two way edge label expected",h.g.UnhandledException),accessDenied:(e,t)=>new h.f(`Cannot ${e} for property`,h.g.Forbidden),deltaNotAllowed:e=>new h.f("Delta not allowed for single-value property",h.g.BadRequest),invalidAppPrefix:()=>new h.f("Invalid app prefix value provided. Make sure you provide a non-empty string consisting of only letters.",h.g.BadRequest),invalidAppId:()=>new h.f("Invalid app id value provided. Make sure you provide a globally unique app identifier value.",h.g.BadRequest),invalidCreationMethod:()=>new h.f("Cannot create a collection using this method.",h.g.BadRequest),unrecognizedChangeSequence:e=>new h.f(`Unrecognized change sequence received ${e}`,h.g.UnhandledException),droppedEdit:(e,t)=>e===a.Invalid?new h.f("Concurrent changes caused one of more merge conflicts and the edit was not applied to the current view. Please retry the operation.",h.g.Conflict):new h.f("Malformed edit detected",h.g.UnhandledException),invalidPropertyKind:e=>new h.f(`the property was not of expected kind: ${e}`,h.g.BadRequest),malformedProperty:()=>new h.f("Property was added both as a single-value & multi-valued property. Delete & recreate the affected property. }",h.g.DataCorruption),parentCollectionNotFound:(e,t)=>new h.f(`${t} parent collection not found for elementId: ${e}`,h.g.DataCorruption),orphanedNode:e=>new h.f(`The parent of nodeId:${e} was not found in snapshot`,h.g.DataCorruption),indexCorruption:(e,t)=>new h.f(`Cannot read the item node indexed by (itemId: ${e} -> itemNodeId: ${t})`,h.g.DataCorruption),unrecognizedDelta:e=>new h.f("Unrecognized delta:",h.g.UnhandledException),nodeNotFound:(e,t)=>new h.f("Expected node not found",h.g.DataCorruption),maxBootKeys:(e,t)=>new h.f(`You can only save up to ${e} keys in the boot index. Currently in use: ${t.length}.`,h.g.NotAllowed),invalidBootValue:()=>new h.f("Invalid boot index value. Only item id values are allowed.",h.g.BadRequest),notImplemented:()=>new h.f("Method not implemented",h.g.NotImplemented),consensusError:(e,t,n,i,r)=>new h.f(`Failed to ${e} item id: '${i}' due to consensus error.`,h.g.Consensus)},g=S("kind"),p=S("secondaryLabels"),f=S("displayText"),v=S("id"),y=S("label"),b=S("labelId");nction w(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function O(e,t){if(e&&t&&"object"==typeof e&&typeof e==typeof t){const n=e,i=t;return Object.keys(n).length===Object.keys(i).length&&Object.keys(n).every(()}return e===t}nction T(e,t){const n=void 0!==t?(e,n,i)=>i.findIndex((n=>t(e,n)))===n:return e.filter(()}function E(e){return Number.isInteger(e)&&e>0}const k="",j=function P(e,t,n,i){if(!j(t))return s.fail(m.invalidLabel());if(!j(n))return s.fail(m.invalidLabelId());const r=e.getItemId(t,n);return r&&r!==i?s.fail(m.labelIdInUse(r,t,n)):s.ok(r)}const _=e=>(t=>null!=e&&"object"==typeof e&&(ce in e||le in e))()&&(void 0===e[ce]||M(e[ce]))&&(void 0===e[le]||M(e[le])),M=function D(e,t){if(!C(t))throw m.invalidItemId();F(e,t)}function x(e,t){if(("boolean"!=typeof t||!1!==t)&&(!t||"string"==typeof t&&I(t)||0==t))throw m.emptyValues(e)}function A(e,t){if("string"==typeof t&&R(t))throw m.maxInputLengthExceeded(e)}const R=unction q(e){F("propertyName",e)}const z=e=>!!e&&"string"==typeof e&&!I(e),B=e=>void 0===e||Array.isArray(e)&&!e.some((e=>!C(e)||!j(e)));function L(e,t){if(!e)throw"function"==typeof t?t():m.assertionFailed()}function*V(e,t){let n=0;for(const i of e){if(n===t)break;yield i,++n}}function*U(e,t){let n=0;for(const i of e)n>=t&&(yield i),++n}function H(e){if(e){if(void 0===e.top&&void 0===e.skip&&void 0===e.filter&&void 0===e.select&&void 0===e.orderBy)throw m.emptyMfsQuery();if(void 0!==e.top&&t(e.top,"top"),void 0!==e.skip&&t(e.skip,"skip"),e.select&&!e.select.some(())throw m.emptySelectQuery()}function t(e,t){if(!E(e))throw m.mustBePositiveInteger(t)}}function G(e,t){if(t.some((t=>t===e)))throw m.circularReference()}const $={id:10,label:28,secondaryLabels:836,labelId:132,displayText:84,kind:44},K={id:!0},W={label:!0,displayText:!0},J={kind:!0},Q={...K,...W};onst Z=(e,t)=>Y(e)&&($[e]&t)===t;function Y(e){return X(e)}function ee(e,t){return t?!(t.includes("label")&&!e.label||t.includes("displayText")&&!e.displayText||!e.id):ie(e,Q)}function te(e){return ie(e,J)&&e.kind===r.OrderedList}unction ie(e,t){for(const n in t)if(t[n]&&!(n in e))return!1;return!0}const re=Symbol("values");function se(e,t,n){const i=n.value;return i?(n.value=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return D("itemId",t[0]),i.apply(this,t)},n):n}function oe(e,t,n){const i=n.value;return i?(n.value=function(e,t){return F("itemId",e),q(t),i.apply(this,[e,t])},n):n}class ae extends h.f{constructor(e){super(`label and labelId are already in use by itemId: ${e}.`,h.g.NotAllowed),this.itemId=e}}const ce=Symbol("add"),le=Symbol("remove"),de=e=>{let{addValues:t,removeValues:n}=e;return L(!!t||!!n,m.invalidMfsDeltaValue),{...t&&{[ce]:t},...n&&{[le]:n}}};var ue,he=n("he5V"),me=n("NgDi");!function(e){e.genericError="genericError",e.throttlingError="throttlingError",e.dataCorruptionError="dataCorruptionError",e.dataProcessingError="dataProcessingError",e.usageError="usageError",e.clientSessionExpiredError="clientSessionExpiredError"}(ue||(ue={}));var ge=n("A3AF");const pe=e=>"function"==typeof(null==e?void 0:e.getTelemetryProperties)&&"function"==typeof(null==e?void 0:e.addTelemetryProperties),fe=e=>"string"==typeof(null==e?void 0:e.errorInstanceId);function ve(e){return"string"==typeof(null==e?void 0:e.errorType)&&"string"==typeof(null==e?void 0:e.message)&&fe(e)&&pe(e)}function ye(e){return"string"==typeof(null==e?void 0:e.errorType)&&"string"==typeof(null==e?void 0:e.message)&&pe(e)}function be(e,t){const n={message:"string"==typeof(null==e?void 0:e.message)?e.message:String(e)};if((e=>null!==e&&!Array.isArray(e)&&"object"==typeof e)(e)){const{errorType:i,stack:r,name:s}=e;"string"==typeof i&&(n.errorType=i),"string"==typeof r&&(n.stack=((e,n)=>{if(!t)return e;const i=e.split("\n");return i.shift(),void 0!==n&&i.unshift(n),i.join("\n")})(r,"string"==typeof s?s:void 0))}return n}const Se=e=>"function"==typeof(null==e?void 0:e.getTelemetryProperties);function Ce(e){void 0===e.errorInstanceId&&(e.errorInstanceId=Object(ge.a)())}function we(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var n;if(ye(e)&&Ce(e),ve(e))return e.addTelemetryProperties(null!==(n=t.props)&&void 0!==n?n:{}),e;const{message:i,stack:r}=be(e,!1),s=new Me({message:i,stack:r});if("object"==typeof e&&null!==e){const{canRetry:t,retryAfterSeconds:n}=e;Object.assign(we,{canRetry:t,retryAfterSeconds:n})}"object"!=typeof e&&s.addTelemetryProperties({typeofError:typeof e});const o=Pe.typeCheck(e)?e.getTelemetryProperties():{untrustedOrigin:1};return s.addTelemetryProperties(Object.assign(Object.assign({},o),t.props)),s}let Oe;function Ie(){const e=new Error("<<generated stack>>");if(void 0===Oe&&(Oe=void 0!==e.stack),Oe)return e;try{throw e}catch(e){return e}}function Ne(e,t){try{Object.assign(e,{stack:t})}catch(n){e.addTelemetryProperties({stack2:t})}}function Te(e){return Pe.typeCheck(e)?e.errorType===_e&&1===e.getTelemetryProperties().untrustedOrigin:!ye(e)}function Ee(e){var t;return"string"==typeof(null===(t=e)||void 0===t?void 0:t.tag)}function ke(e,t){return Array.isArray(e)&&e.every((e=>je(e)))?JSON.stringify(e):je(e)?e:(console.error(`UnSupported Format of Logging Error Property for key ${t}:`,e),"REDACTED (arbitrary object)")}function je(e){switch(typeof e){case"string":case"number":case"boolean":case"undefined":return!0;default:return!1}}class Pe extends Error{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Set;super(e),this.omitPropsFromLogging=n,this._errorInstanceId=Object(ge.a)(),this.fluidErrorCode="-",n.add("omitPropsFromLogging"),n.add("_errorInstanceId"),t&&this.addTelemetryProperties(t)}get errorInstanceId(){return this._errorInstanceId}overwriteErrorInstanceId(e){this._errorInstanceId=e}static typeCheck(e){return"object"==typeof e&&null!==e&&"function"==typeof e.addTelemetryProperties&&"function"==typeof e.getTelemetryProperties&&"string"==typeof e.errorInstanceId}addTelemetryProperties(e){!function(e,t){for(const n of Object.keys(t))void 0===e[n]&&(e[n]=t[n])}(this,e)}getTelemetryProperties(){const e=function(e,t){const n={};for(const i of Object.keys(e)){if(t.has(i))continue;const r=e[i];n[i]=Ee(r)?{value:ke(r.value,i),tag:r.tag}:ke(r,i)}return n}(this,this.omitPropsFromLogging);return Object.assign(Object.assign({},e),{stack:this.stack,message:this.message,errorInstanceId:this._errorInstanceId})}}const _e="genericError";class Me extends Pe{constructor(e){super(e.message),this.errorType=_e,void 0!==e.stack&&Ne(this,e.stack)}}class De extends Pe{constructor(e,t){super(e,Object.assign(Object.assign({},t),{usageError:!0})),this.errorType=ue.usageError}}class xe extends Pe{constructor(e){super(e),this.errorType=ue.dataProcessingError,this.canRetry=!1}static create(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const r=xe.wrapIfUnrecognized(e,t,n);return r.addTelemetryProperties(i),r}static wrapIfUnrecognized(e,t,n){const i=we(e,{props:Object.assign({dataProcessingError:1,dataProcessingCodepath:t},void 0===n?void 0:Ae(n))});if(Te(i)||i.errorType===_e){const e=function(e,t){const{message:n,stack:i}=be(e,!1),r=(e=>new xe(e))(n);return void 0!==i&&Ne(r,i),Te(e)&&r.addTelemetryProperties({untrustedOrigin:1}),fe(e)&&(r.overwriteErrorInstanceId(e.errorInstanceId),r.addTelemetryProperties({innerErrorInstanceId:e.errorInstanceId})),Se(e)&&r.addTelemetryProperties(e.getTelemetryProperties()),r}(i);return e.addTelemetryProperties(i.getTelemetryProperties()),e}return i}}const Ae=e=>({messageClientId:e.clientId,messageSequenceNumber:e.sequenceNumber,messageClientSequenceNumber:e.clientSequenceNumber,messageReferenceSequenceNumber:e.referenceSequenceNumber,messageMinimumSequenceNumber:e.minimumSequenceNumber,messageTimestamp:e.timestamp});var Re,Fe=n("ZkeI"),qe=n("f79D");!function(e){e.Detached="Detached",e.Attaching="Attaching",e.Attached="Attached"}(Re||(Re={}));var ze=n("OSDc");class Be extends me.a{constructor(e){super(),this.errorHandler=e}emit(e){try{for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return super.emit(e,...n)}catch(t){return this.errorHandler(e,t),!0}}}var Le=n("rK/e"),Ve=n("O9x+");const Ue=new Ve.a((()=>Ge(We()))),He={getRawConfig:()=>{}},Ge=e=>null!=e?new Je(void 0,{getRawConfig:t=>{var n,i;try{return null===(i=Ke(null!==(n=e.getItem(t))&&void 0!==n?n:void 0))||void 0===i?void 0:i.raw}catch(e){}}}):He;function $e(e){switch(e){case"boolean":case"number":case"string":return!0;default:return!1}}function Ke(e){let t,n=e;if("string"==typeof e)try{n=JSON.parse(e),t={raw:e,string:e}}catch(e){}if(void 0===n)return t;const i=typeof n;if($e(i))return Object.assign(Object.assign({},t),{raw:e,[i]:n});if(Array.isArray(n)){const i=typeof n[0];if(!$e(i))return t;for(const e of n)if(typeof e!==i)return t;return Object.assign(Object.assign({},t),{raw:e,[`${i}[]`]:n})}return t}const We=()=>{var e;try{return null!==(e=globalThis.sessionStorage)&&void 0!==e?e:void 0}catch(e){return}};class Je{constructor(e){this.logger=e,this.configCache=new Map,this.orderedBaseProviders=[];const t=new Set;for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];const s=[...i];for(;s.length>0;){const e=s.shift();void 0!==e&&Ze(e)&&!t.has(e)&&(t.add(e),e instanceof Je?s.push(...e.orderedBaseProviders):this.orderedBaseProviders.push(e))}}getBoolean(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.boolean}getNumber(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.number}getString(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.string}getBooleanArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["boolean[]"]}getNumberArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["number[]"]}getStringArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["string[]"]}getRawConfig(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.raw}getCacheEntry(e){var t;if(!this.configCache.has(e)){for(const n of this.orderedBaseProviders){const i=Ke(null==n?void 0:n.getRawConfig(e));if(void 0!==i)return this.configCache.set(e,i),null===(t=this.logger)||void 0===t||t.send({category:"generic",eventName:"ConfigRead",configName:{tag:Ye.CodeArtifact,value:e},configValue:{tag:Ye.CodeArtifact,value:JSON.stringify(i)}}),i}this.configCache.set(e,{raw:void 0})}return this.configCache.get(e)}}function Qe(e){const t=e;return Ze(null==t?void 0:t.config)&&void 0!==(null==t?void 0:t.logger)}function Xe(e){if(Qe(e))throw new Error("Logger is already a monitoring context");const t=e;for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];return t.config=new Je(e,...i),t.logger=e,t}function Ze(e){return"function"==typeof(null==e?void 0:e.getRawConfig)}var Ye,et,tt;!function(e){e.CodeArtifact="CodeArtifact",e.UserData="UserData"}(Ye||(Ye={}));class nt{constructor(e,t){this.namespace=e,this.properties=t}static formatTick(e){return Math.floor(e)}static numberFromString(e){if(null==e)return;const t=Number(e);return Number.isNaN(t)?e:t}static sanitizePkgName(e){return e.replace("@","").replace("/","-")}static prepareErrorObject(e,t,n){const{message:i,errorType:r,stack:s}=be(t,!0);if(e.stack=s,e.error=i,e.errorType=r,Se(t)){const n=t.getTelemetryProperties();for(const t of Object.keys(n))void 0===e[t]&&(e[t]=n[t])}void 0===e.stack&&n&&(e.stack=function(){return Ie().stack}())}sendTelemetryEvent(e,t){var n;this.sendTelemetryEventCore(Object.assign(Object.assign({},e),{category:null!==(n=e.category)&&void 0!==n?n:"generic"}),t)}sendTelemetryEventCore(e,t){const n=function(e){var{category:t,eventName:n}=e,i=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n}(e,["category","eventName"]);const r={category:t,eventName:n};for(const e of Object.keys(i))r[e]=st(i[e]);return r}(e);void 0!==t&&nt.prepareErrorObject(n,t,!1),"number"==typeof n.duration&&(n.duration=nt.formatTick(n.duration)),this.send(n)}sendErrorEvent(e,t){this.sendTelemetryEventCore(Object.assign(Object.assign({error:e.eventName},e),{category:"error"}),t)}sendPerformanceEvent(e,t){var n;const i=Object.assign(Object.assign({},e),{category:null!==(n=e.category)&&void 0!==n?n:"performance"});this.sendTelemetryEventCore(i,t)}prepareEvent(e){const t="error"===e.category||void 0!==e.error,n=Object.assign({},e);if(void 0!==this.namespace&&(n.eventName=`${this.namespace}${nt.eventNamespaceSeparator}${n.eventName}`),this.properties){const i=[];i.push(this.properties.all),t&&i.push(this.properties.error);for(const t of i)if(void 0!==t)for(const i of Object.keys(t)){if(void 0!==e[i])continue;const r=t[i],s="function"==typeof r?r():r;void 0!==s&&(n[i]=s)}}return n}}nt.eventNamespaceSeparator=":";class it extends nt{constructor(e,t,n){super(t,n),this.baseLogger=e,Qe(e)&&Xe(this,new Je(this,e.config))}static create(e,t,n){if(e instanceof it){const i={};for(const t of[e.properties,n])void 0!==t&&(void 0!==t.all&&(i.all=Object.assign(Object.assign({},i.all),t.all)),void 0!==t.error&&(i.error=Object.assign(Object.assign({},i.error),t.error)));return new it(e.baseLogger,void 0===e.namespace?t:void 0===t?e.namespace:`${e.namespace}${nt.eventNamespaceSeparator}${t}`,i)}return new it(e||new rt,t,n)}send(e){this.baseLogger.send(this.prepareEvent(e))}}class rt{send(e){}}function st(e){return Ee(e)?{value:ot(e.value),tag:e.tag}:ot(e)}function ot(e){switch(typeof e){case"string":case"number":case"boolean":case"undefined":return e;case"object":return JSON.stringify(e);default:return console.error(`convertToBasePropertyTypeUntagged: INVALID PROPERTY (typed as ${typeof e})`),`INVALID PROPERTY (typed as ${typeof e})`}}class at{constructor(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new Map;this.eventBase=e,this.logger=t,this.sampleThreshold=n,this.includeAggregateMetrics=i,this.perBucketProperties=r,this.disposed=!1,this.measurementsMap=new Map}measure(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";var n,i,r;const s=Le.a.now(),o=e(),a=Le.a.now()-s;let c=this.measurementsMap.get(t);return void 0===c&&(c={count:0,duration:-1},this.measurementsMap.set(t,c)),c.count++,c.duration=a,this.includeAggregateMetrics&&(c.totalDuration=(null!==(n=c.totalDuration)&&void 0!==n?n:0)+a,c.minDuration=Math.min(null!==(i=c.minDuration)&&void 0!==i?i:a,a),c.maxDuration=Math.max(null!==(r=c.maxDuration)&&void 0!==r?r:0,a)),c.count>=this.sampleThreshold&&this.flushBucket(t),o}flushBucket(e){const t=this.measurementsMap.get(e);if(void 0!==t&&0!==t.count){const n=this.perBucketProperties.get(e),i=Object.assign(Object.assign(Object.assign({},this.eventBase),n),t);this.logger.sendPerformanceEvent(i),this.measurementsMap.delete(e)}}dispose(e){this.measurementsMap.forEach(((e,t)=>this.flushBucket(t)))}}function ct(e,t){if(""===e)return void 0===t?"":t.absolutePath;{let n=e.startsWith("/")?e.slice(1):e;return n=n.endsWith("/")?n.slice(0,-1):n,void 0===t?`/${n}`:`${"/"===t.absolutePath?"":t.absolutePath}/${n}`}}!function(e){e.Detached="Detached",e.Attaching="Attaching",e.Attached="Attached"}(et||(et={})),function(e){e.cache="fluid-cache",e.clientDetails="fluid-client-details",e.loadMode="loadMode",e.reconnect="fluid-reconnect",e.sequenceNumber="fluid-sequence-number",e.version="version"}(tt||(tt={}));var lt=n("NsUA"),dt=n("7/yF"),ut=n("3/00"),ht=n("gaGA");const mt=e=>"function"==typeof(null==e?void 0:e.getTelemetryProperties)&&"function"==typeof(null==e?void 0:e.addTelemetryProperties),gt=e=>"string"==typeof(null==e?void 0:e.errorInstanceId);function pt(e){return"string"==typeof(null==e?void 0:e.errorType)&&"string"==typeof(null==e?void 0:e.message)&&gt(e)&&mt(e)}function ft(e){return"string"==typeof(null==e?void 0:e.errorType)&&"string"==typeof(null==e?void 0:e.message)&&mt(e)}function vt(e,t){const n={message:"string"==typeof(null==e?void 0:e.message)?e.message:String(e)};if((e=>null!==e&&!Array.isArray(e)&&"object"==typeof e)(e)){const{errorType:i,stack:r,name:s}=e;"string"==typeof i&&(n.errorType=i),"string"==typeof r&&(n.stack=((e,n)=>{if(!t)return e;const i=e.split("\n");return i.shift(),void 0!==n&&i.unshift(n),i.join("\n")})(r,"string"==typeof s?s:void 0))}return n}const yt=e=>"function"==typeof(null==e?void 0:e.getTelemetryProperties);function bt(e){void 0===e.errorInstanceId&&(e.errorInstanceId=Object(ge.a)())}function St(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var n;if(ft(e)&&bt(e),pt(e))return e.addTelemetryProperties(null!==(n=t.props)&&void 0!==n?n:{}),e;const{message:i,stack:r}=vt(e,!1),s=new Mt({message:i,stack:r});if("object"==typeof e&&null!==e){const{canRetry:t,retryAfterSeconds:n}=e;Object.assign(St,{canRetry:t,retryAfterSeconds:n})}"object"!=typeof e&&s.addTelemetryProperties({typeofError:typeof e});const o=Pt.typeCheck(e)?e.getTelemetryProperties():{untrustedOrigin:1};return s.addTelemetryProperties(Object.assign(Object.assign({},o),t.props)),s}let Ct;function wt(){const e=new Error("<<generated stack>>");if(void 0===Ct&&(Ct=void 0!==e.stack),Ct)return e;try{throw e}catch(e){return e}}unction It(e,t){const{message:n,stack:i}=vt(e,!1),r=t(n);return void 0!==i&&Nt(r,i),Tt(e)&&r.addTelemetryProperties({untrustedOrigin:1}),gt(e)&&(r.overwriteErrorInstanceId(e.errorInstanceId),r.addTelemetryProperties({innerErrorInstanceId:e.errorInstanceId})),yt(e)&&r.addTelemetryProperties(e.getTelemetryProperties()),r}function Nt(e,t){try{Object.assign(e,{stack:t})}catch(n){e.addTelemetryProperties({stack2:t})}}function Tt(e){return Pt.typeCheck(e)?e.errorType===_t&&1===e.getTelemetryProperties().untrustedOrigin:!ft(e)}function Et(e){var t;return"string"==typeof(null===(t=e)||void 0===t?void 0:t.tag)}function kt(e,t){return Array.isArray(e)&&e.every((e=>jt(e)))?JSON.stringify(e):jt(e)?e:(console.error(`UnSupported Format of Logging Error Property for key ${t}:`,e),"REDACTED (arbitrary object)")}function jt(e){switch(typeof e){case"string":case"number":case"boolean":case"undefined":return!0;default:return!1}}class Pt extends Error{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Set;super(e),this.omitPropsFromLogging=n,this._errorInstanceId=Object(ge.a)(),this.fluidErrorCode="-",n.add("omitPropsFromLogging"),n.add("_errorInstanceId"),t&&this.addTelemetryProperties(t)}get errorInstanceId(){return this._errorInstanceId}overwriteErrorInstanceId(e){this._errorInstanceId=e}static typeCheck(e){return"object"==typeof e&&null!==e&&"function"==typeof e.addTelemetryProperties&&"function"==typeof e.getTelemetryProperties&&"string"==typeof e.errorInstanceId}addTelemetryProperties(e){!function(e,t){for(const n of Object.keys(t))void 0===e[n]&&(e[n]=t[n])}(this,e)}getTelemetryProperties(){const e=function(e,t){const n={};for(const i of Object.keys(e)){if(t.has(i))continue;const r=e[i];n[i]=Et(r)?{value:kt(r.value,i),tag:r.tag}:kt(r,i)}return n}(this,this.omitPropsFromLogging);return Object.assign(Object.assign({},e),{stack:this.stack,message:this.message,errorInstanceId:this._errorInstanceId})}}const _t="genericError";class Mt extends Pt{constructor(e){super(e.message),this.errorType=_t,void 0!==e.stack&&Nt(this,e.stack)}}var Dt;!function(e){e.CodeArtifact="CodeArtifact",e.UserData="UserData"}(Dt||(Dt={}));class xt{constructor(e,t){this.namespace=e,this.properties=t}static formatTick(e){return Math.floor(e)}static numberFromString(e){if(null==e)return;const t=Number(e);return Number.isNaN(t)?e:t}static sanitizePkgName(e){return e.replace("@","").replace("/","-")}static prepareErrorObject(e,t,n){const{message:i,errorType:r,stack:s}=vt(t,!0);if(e.stack=s,e.error=i,e.errorType=r,yt(t)){const n=t.getTelemetryProperties();for(const t of Object.keys(n))void 0===e[t]&&(e[t]=n[t])}void 0===e.stack&&n&&(e.stack=Ot())}sendTelemetryEvent(e,t){var n;this.sendTelemetryEventCore(Object.assign(Object.assign({},e),{category:null!==(n=e.category)&&void 0!==n?n:"generic"}),t)}sendTelemetryEventCore(e,t){const n=function(e){var{category:t,eventName:n}=e,i=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n}(e,["category","eventName"]);const r={category:t,eventName:n};for(const e of Object.keys(i))r[e]=zt(i[e]);return r}(e);void 0!==t&&xt.prepareErrorObject(n,t,!1),"number"==typeof n.duration&&(n.duration=xt.formatTick(n.duration)),this.send(n)}sendErrorEvent(e,t){this.sendTelemetryEventCore(Object.assign(Object.assign({error:e.eventName},e),{category:"error"}),t)}sendPerformanceEvent(e,t){var n;const i=Object.assign(Object.assign({},e),{category:null!==(n=e.category)&&void 0!==n?n:"performance"});this.sendTelemetryEventCore(i,t)}prepareEvent(e){const t="error"===e.category||void 0!==e.error,n=Object.assign({},e);if(void 0!==this.namespace&&(n.eventName=`${this.namespace}${xt.eventNamespaceSeparator}${n.eventName}`),this.properties){const i=[];i.push(this.properties.all),t&&i.push(this.properties.error);for(const t of i)if(void 0!==t)for(const i of Object.keys(t)){if(void 0!==e[i])continue;const r=t[i],s="function"==typeof r?r():r;void 0!==s&&(n[i]=s)}}return n}}xt.eventNamespaceSeparator=":";class At{constructor(e){this.logger=e}send(e){const t={category:e.category,eventName:e.eventName};for(const n of Object.keys(e)){const i=e[n],{value:r,tag:s}="object"==typeof i?i:{value:i,tag:void 0};switch(s){case void 0:t[n]=r;break;case"PackageData":case Dt.CodeArtifact:t[n]=r;break;case Dt.UserData:t[n]="REDACTED (UserData)";break;default:t[n]="REDACTED (unknown tag)"}}this.logger.send(t)}}class Rt extends xt{constructor(e,t,n){super(t,n),this.baseLogger=e,Wt(e)&&Qt(this,new Kt(this,e.config))}static create(e,t,n){if(e instanceof Rt){const i={};for(const t of[e.properties,n])void 0!==t&&(void 0!==t.all&&(i.all=Object.assign(Object.assign({},i.all),t.all)),void 0!==t.error&&(i.error=Object.assign(Object.assign({},i.error),t.error)));return new Rt(e.baseLogger,void 0===e.namespace?t:void 0===t?e.namespace:`${e.namespace}${xt.eventNamespaceSeparator}${t}`,i)}return new Rt(e||new qt,t,n)}send(e){this.baseLogger.send(this.prepareEvent(e))}}class Ft{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{end:!0,cancel:"generic"};var i;this.logger=e,this.markers=n,this.startTime=Le.a.now(),this.event=Object.assign({},t),this.markers.start&&this.reportEvent("start"),"object"==typeof window&&null!=window&&(null===(i=window.performance)||void 0===i?void 0:i.mark)&&(this.startMark=`${t.eventName}-start`,window.performance.mark(this.startMark))}static start(e,t,n){return new Ft(e,t,n)}static timedExec(e,t,n,i){const r=Ft.start(e,t,i);try{const e=n(r);return r.autoEnd(),e}catch(e){throw r.cancel(void 0,e),e}}static async timedExecAsync(e,t,n,i){const r=Ft.start(e,t,i);try{const e=await n(r);return r.autoEnd(),e}catch(e){throw r.cancel(void 0,e),e}}get duration(){return Le.a.now()-this.startTime}reportProgress(e){this.reportEvent(arguments.length>1&&void 0!==arguments[1]?arguments[1]:"update",e)}autoEnd(){this.event&&this.markers.end&&this.reportEvent("end"),this.performanceEndMark(),this.event=void 0}end(e){this.reportEvent("end",e),this.performanceEndMark(),this.event=void 0}performanceEndMark(){if(this.startMark&&this.event){const e=`${this.event.eventName}-end`;window.performance.mark(e),window.performance.measure(`${this.event.eventName}`,this.startMark,e),this.startMark=void 0}}cancel(e,t){void 0!==this.markers.cancel&&this.reportEvent("cancel",Object.assign({category:this.markers.cancel},e),t),this.event=void 0}reportEvent(e,t,n){if(!this.event)return;const i=Object.assign(Object.assign({},this.event),t);i.eventName=`${i.eventName}_${e}`,"start"!==e&&(i.duration=this.duration),this.logger.sendPerformanceEvent(i,n)}}class qt{send(e){}}function zt(e){return Et(e)?{value:Bt(e.value),tag:e.tag}:Bt(e)}function Bt(e){switch(typeof e){case"string":case"number":case"boolean":case"undefined":return e;case"object":return JSON.stringify(e);default:return console.error(`convertToBasePropertyTypeUntagged: INVALID PROPERTY (typed as ${typeof e})`),`INVALID PROPERTY (typed as ${typeof e})`}}const Lt=new Ve.a((()=>Ut($t()))),Vt={getRawConfig:()=>{}},Ut=e=>null!=e?new Kt(void 0,{getRawConfig:t=>{var n,i;try{return null===(i=Gt(null!==(n=e.getItem(t))&&void 0!==n?n:void 0))||void 0===i?void 0:i.raw}catch(e){}}}):Vt;function Ht(e){switch(e){case"boolean":case"number":case"string":return!0;default:return!1}}function Gt(e){let t,n=e;if("string"==typeof e)try{n=JSON.parse(e),t={raw:e,string:e}}catch(e){}if(void 0===n)return t;const i=typeof n;if(Ht(i))return Object.assign(Object.assign({},t),{raw:e,[i]:n});if(Array.isArray(n)){const i=typeof n[0];if(!Ht(i))return t;for(const e of n)if(typeof e!==i)return t;return Object.assign(Object.assign({},t),{raw:e,[`${i}[]`]:n})}return t}const $t=()=>{var e;try{return null!==(e=globalThis.sessionStorage)&&void 0!==e?e:void 0}catch(e){return}};class Kt{constructor(e){this.logger=e,this.configCache=new Map,this.orderedBaseProviders=[];const t=new Set;for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];const s=[...i];for(;s.length>0;){const e=s.shift();void 0!==e&&Xt(e)&&!t.has(e)&&(t.add(e),e instanceof Kt?s.push(...e.orderedBaseProviders):this.orderedBaseProviders.push(e))}}getBoolean(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.boolean}getNumber(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.number}getString(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.string}getBooleanArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["boolean[]"]}getNumberArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["number[]"]}getStringArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["string[]"]}getRawConfig(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.raw}getCacheEntry(e){var t;if(!this.configCache.has(e)){for(const n of this.orderedBaseProviders){const i=Gt(null==n?void 0:n.getRawConfig(e));if(void 0!==i)return this.configCache.set(e,i),null===(t=this.logger)||void 0===t||t.send({category:"generic",eventName:"ConfigRead",configName:{tag:Dt.CodeArtifact,value:e},configValue:{tag:Dt.CodeArtifact,value:JSON.stringify(i)}}),i}this.configCache.set(e,{raw:void 0})}return this.configCache.get(e)}}function Wt(e){const t=e;return Xt(null==t?void 0:t.config)&&void 0!==(null==t?void 0:t.logger)}function Jt(e){return Wt(e)?e:Qt(e,Lt.value)}function Qt(e){if(Wt(e))throw new Error("Logger is already a monitoring context");const t=e;for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];return t.config=new Kt(e,...i),t.logger=e,t}function Xt(e){return"function"==typeof(null==e?void 0:e.getRawConfig)}var Zt,Yt,en,tn;!function(e){e[e.NoCaching=0]="NoCaching",e[e.Prefetch=1]="Prefetch"}(Zt||(Zt={})),function(e){e.default="default",e.noCache="noCache"}(Yt||(Yt={})),function(e){e.summarizingClient="fluid-client-summarizer",e.createNew="createNew"}(en||(en={})),function(e){e.genericError="genericError",e.throttlingError="throttlingError",e.dataCorruptionError="dataCorruptionError",e.dataProcessingError="dataProcessingError",e.usageError="usageError",e.clientSessionExpiredError="clientSessionExpiredError"}(tn||(tn={}));class nn extends Pt{constructor(e,t,n){super(e,n,new Set(["error"])),this.error=t,this.errorType=tn.genericError}}class rn extends Pt{constructor(e,t){super(e,Object.assign(Object.assign({},t),{usageError:!0})),this.errorType=tn.usageError}}class sn extends Pt{constructor(e,t){super(e,{timeoutMs:t}),this.expiryMs=t,this.errorType=tn.clientSessionExpiredError}}class on extends Pt{constructor(e,t){super(e,Object.assign(Object.assign({},t),{dataProcessingError:1})),this.errorType=tn.dataCorruptionError,this.canRetry=!1}}class an extends Pt{constructor(e){super(e),this.errorType=tn.dataProcessingError,this.canRetry=!1}static create(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const r=an.wrapIfUnrecognized(e,t,n);return r.addTelemetryProperties(i),r}static wrapIfUnrecognized(e,t,n){const i=St(e,{props:Object.assign({dataProcessingError:1,dataProcessingCodepath:t},void 0===n?void 0:cn(n))});if(Tt(i)||i.errorType===_t){const e=It(i,(e=>new an(e)));return e.addTelemetryProperties(i.getTelemetryProperties()),e}return i}}const cn=e=>({messageClientId:e.clientId,messageSequenceNumber:e.sequenceNumber,messageClientSequenceNumber:e.clientSequenceNumber,messageReferenceSequenceNumber:e.referenceSequenceNumber,messageMinimumSequenceNumber:e.minimumSequenceNumber,messageTimestamp:e.timestamp});var ln=n("HJ7Z"),dn=n("htzX");class un{constructor(e){this.request=e;const t=this.request.url.indexOf("?");this.query=t>=0?this.request.url.substring(t):""}static getPathParts(e){const t=e.indexOf("?");return e.substring(0,t<0?e.length:t).split("/").reduce(((e,t)=>(void 0!==t&&t.length>0&&e.push(decodeURIComponent(t)),e)),[])}static create(e){return e instanceof un?e:new un(e)}get url(){return this.request.url}get headers(){return this.request.headers}get pathParts(){return void 0===this.requestPathParts&&(this.requestPathParts=un.getPathParts(this.url)),this.requestPathParts}isLeaf(e){return""===this.query&&this.pathParts.length===e}createSubRequest(e){const t=this.pathParts.length;if(e<0||e>t)throw new Error("incorrect sub-request");if(e===t&&this.url.includes("?"))return{url:`/${this.query}`,headers:this.headers};const n=`/${this.pathParts.slice(e).join("/")}`;return{url:""===this.query?n:`${n}/${this.query}`,headers:this.headers}}}function hn(e){if(null!==e&&"object"==typeof e&&!0===e.errorFromRequestFluidObject){const t=e;return{mimeType:"text/plain",status:t.code,value:t.message,get stack(){return t.stack},headers:t.underlyingResponseHeaders}}const t=wt();return{mimeType:"text/plain",status:500,value:`${e}`,get stack(){var n;return null!==(n=null==e?void 0:e.stack)&&void 0!==n?n:t.stack}}}function mn(e,t){const n=e.value,i=wt();return{errorFromRequestFluidObject:!0,message:n,name:"Error",code:e.status,get stack(){var t;return null!==(t=e.stack)&&void 0!==t?t:i.stack},underlyingResponseHeaders:e.headers}}function gn(e){return e?{value:e.join("/"),tag:Dt.CodeArtifact}:void 0}async function pn(e,t){const n="string"==typeof t?{url:t}:t,i=await e.request(n);if(200!==i.status||"fluid/object"!==i.mimeType)throw mn(i);return Object(he.a)(i.value,410),i.value}const fn=function vn(e,t,n,i){var r;Object(he.a)(200!==e,411);const s=null===(r=n.url)||void 0===r?void 0:r.split("?")[0],o=wt();return{mimeType:"text/plain",status:e,value:void 0===s?t:`${t}: ${s}`,get stack(){return o.stack},headers:i}}var yn=n("Xou4"),bn=n("nCVa"),Sn=n("Ls0c"),Cn=n("l4ds");function wn(){const e={treeNodeCount:0,blobNodeCount:0,handleNodeCount:0,totalBlobSize:0,unreferencedBlobSize:0};for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];for(const t of n)e.treeNodeCount+=t.treeNodeCount,e.blobNodeCount+=t.blobNodeCount,e.handleNodeCount+=t.handleNodeCount,e.totalBlobSize+=t.totalBlobSize,e.unreferencedBlobSize+=t.unreferencedBlobSize;return e}function On(e){return"string"==typeof e?function(e){let t=e.length;for(let n=e.length-1;n>=0;n--){const i=e.charCodeAt(n);i>127&&i<=2047?t++:i>2047&&i<=65535&&(t+=2),i>=56320&&i<=57343&&n--}return t}(e):e.byteLength}function In(e,t){switch(e.type){case ln.a.Tree:t.treeNodeCount++;for(const n of Object.values(e.tree))In(n,t);return;case ln.a.Handle:return void t.handleNodeCount++;case ln.a.Blob:return t.blobNodeCount++,void(t.totalBlobSize+=On(e.content));default:return}}unction Tn(e,t,n){e.summary.tree[t]={type:ln.a.Blob,content:n},e.stats.blobNodeCount++,e.stats.totalBlobSize+=On(n)}class En{constructor(){this.attachmentCounter=0,this.summaryTree={},this.summaryStats=wn(),this.summaryStats.treeNodeCount++}get summary(){return{type:ln.a.Tree,tree:Object.assign({},this.summaryTree)}}get stats(){return Object.assign({},this.summaryStats)}addBlob(e,t){Tn({summary:{type:ln.a.Tree,tree:this.summaryTree},stats:this.summaryStats},e,t)}addHandle(e,t,n){this.summaryTree[e]={type:ln.a.Handle,handleType:t,handle:n},this.summaryStats.handleNodeCount++}addWithStats(e,t){this.summaryTree[e]=t.summary,this.summaryStats=wn(this.summaryStats,t.stats)}addAttachment(e){this.summaryTree[this.attachmentCounter++]={id:e,type:ln.a.Attachment}}getSummaryTree(){return{summary:this.summary,stats:this.stats}}}function kn(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=new En;for(const i of e.entries)switch(i.type){case Cn.b.Blob:{const e=i.value,t="base64"===e.encoding?yn.a.from(e.contents,"base64"):e.contents;n.addBlob(i.path,t);break}case Cn.b.Tree:{const e=jn(i.value,t);n.addWithStats(i.path,e);break}case Cn.b.Attachment:n.addAttachment(i.value.id);break;default:throw new Error("Unexpected TreeEntry type")}const i=n.getSummaryTree();return i.summary.unreferenced=e.unreferenced,i}function jn(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e.id&&!t){const t=wn();return t.handleNodeCount++,{summary:{handle:e.id,handleType:ln.a.Tree,type:ln.a.Handle},stats:t}}return kn(e,t)}function Pn(e){const t=new En;for(const[n,i]of Object.entries(e.blobs)){let r;if(void 0!==e.blobsContents){const t=e.blobsContents[i];void 0!==t&&(r=Object(yn.c)(t,"utf-8"))}else void 0!==e.blobs[i]&&(r=Object(bn.a)(e.blobs[i]));void 0!==r&&t.addBlob(n,r)}for(const[n,i]of Object.entries(e.trees)){const e=Pn(i);t.addWithStats(n,e)}const n=t.getSummaryTree();return n.summary.unreferenced=e.unreferenced,n}function _n(e){const t=[];for(const[n,i]of Object.entries(e.tree))switch(i.type){case ln.a.Blob:{let e,r="utf-8";"string"==typeof i.content?e=i.content:(e=Object(yn.b)(i.content,"base64"),r="base64"),t.push(new Sn.b(n,e,r));break}case ln.a.Tree:t.push(new Sn.c(n,_n(i)));break;case ln.a.Attachment:t.push(new Sn.a(n,i.id));break;case ln.a.Handle:throw new Error("Should not have Handle type in summary tree");default:Object(dt.a)(i,"Unexpected summary tree type")}return{entries:t,unreferenced:e.unreferenced}}class Mn{et(e,t,n){this.telemetry.set(`${e}${t}`,n)}setMultiple(e,t,n){for(const i of Object.keys(n))this.set(e,`${t}_${i}`,n[i])}erialize(){const e={};return this.telemetry.forEach((),JSON.stringify(e)}}function Dn(e){return e.replace(/^\/+/g,"")}lass An{fixAndAddNodes(e,t){for(const[n,i]of Object.entries(t)){let t=Dn(n);t=`/${e}/${t}`,t=xn(t),this.gcNodesSet[t]=new Set(i)}}addNodes(e){for(const[t,n]of Object.entries(e))this.gcNodesSet[t]=new Set(n)}addRouteToAllNodes(e){for(const t of Object.values(this.gcNodesSet))t.add(e)}function Rn(e,t){if(""===e)return void 0===t?"":t.absolutePath;{let n=e.startsWith("/")?e.slice(1):e;return n=n.endsWith("/")?n.slice(0,-1):n,void 0===t?`/${n}`:`${"/"===t.absolutePath?"":t.absolutePath}/${n}`}}class Fn{constructor(e,t,n){this.path=e,this.runtime=t,this.routeContext=n,this.absolutePath=Rn(e,this.routeContext)}get IFluidHandleContext(){return this}attachGraph(){throw new Error("can't attach container runtime form within container!")}get isAttachedsync resolveHandle(e){return this.runtime.resolveHandle(e)}}class qn{constructor(e){this.map=new Map;for(const t of e){if(this.map.has(t[0]))throw new rn("Duplicate entry names exist");this.map.set(t[0],t[1])}}get IFluidDataStoreRegistry(){return this}class zn{constructor(e,t,n){this.clientId=e,this.deltaManager=t,this.pongCount=0,this.msnTrackingTimestamp=0,this.opProcessingTimes={},this.opPerfData={},this.firstConnection=!0,this.bootTime=Le.a.now(),this.connectionStartTime=0,this.gap=0,this.logger=Rt.create(n,"OpPerf"),this.deltaManager.on("pong",(e=>this.recordPingTime(e))),this.deltaManager.on("submitOp",(e=>this.beforeOpSubmit(e))),this.deltaManager.on("op",(e=>this.afterProcessingOp(e))),this.deltaManager.on("connect",((e,t)=>{this.clientId=e.clientId,void 0!==t&&(this.connectionOpSeqNumber=this.deltaManager.lastKnownSeqNumber,this.gap=t,this.connectionStartTime=Le.a.now(),this.gap<=0&&this.reportGettingUpToDate())})),this.deltaManager.on("disconnect",(()=>{this.sequenceNumberForMsnTracking=void 0,this.clientSequenceNumberForLatencyStatistics=void 0,this.opProcessingTimes={},this.opPerfData={},this.connectionOpSeqNumber=void 0,this.firstConnection=!1,this.pongCount=0})),this.deltaManager.outbound.on("push",(e=>{for(const t of e)t.type===qe.a.Operation&&this.clientSequenceNumberForLatencyStatistics===t.clientSequenceNumber&&(Object(he.a)(void 0===this.opProcessingTimes.outboundPushEventTime,712),Object(he.a)(void 0===this.opPerfData.durationNetwork,713),this.opProcessingTimes.outboundPushEventTime=Date.now(),Object(he.a)(void 0===this.opPerfData.durationOutboundBatching,714),Object(he.a)(void 0!==this.opProcessingTimes.submitOpEventTime,715),this.opPerfData.durationOutboundBatching=this.opProcessingTimes.outboundPushEventTime-this.opProcessingTimes.submitOpEventTime)})),this.deltaManager.inbound.on("push",(e=>{this.clientId===e.clientId&&e.type===qe.a.Operation&&this.clientSequenceNumberForLatencyStatistics===e.clientSequenceNumber&&void 0!==this.opProcessingTimes.outboundPushEventTime&&(this.opProcessingTimes.inboundPushEventTime=Date.now(),this.opPerfData.durationNetwork=this.opProcessingTimes.inboundPushEventTime-this.opProcessingTimes.outboundPushEventTime,this.opProcessingTimes.outboundPushEventTime=void 0,this.opPerfData.lengthInboundQueue=this.deltaManager.inbound.length)})),this.deltaManager.inbound.on("idle",((e,t)=>{"number"==typeof e&&e>=100&&this.logger.sendPerformanceEvent({eventName:"GetDeltas_OpProcessing",count:e,duration:t})}))}reportGettingUpToDate(){this.connectionOpSeqNumber=void 0,this.logger.sendPerformanceEvent({eventName:"ConnectionSpeed",duration:Le.a.now()-this.connectionStartTime,ops:this.gap,timeToConnect:this.firstConnection?xt.formatTick(this.connectionStartTime-this.bootTime):void 0,firstConnection:this.firstConnection})}recordPingTime(e){this.pingLatency=e,this.pongCount%100==0&&this.deltaManager.active&&this.logger.sendPerformanceEvent({eventName:"DeltaLatency",duration:e}),this.pongCount++}beforeOpSubmit(e){void 0===this.clientSequenceNumberForLatencyStatistics&&e.clientSequenceNumber%500==1&&(Object(he.a)(void 0===this.opProcessingTimes.outboundPushEventTime,716),Object(he.a)(void 0===this.opPerfData.durationNetwork,717),this.opProcessingTimes.submitOpEventTime=Date.now(),this.clientSequenceNumberForLatencyStatistics=e.clientSequenceNumber)}afterProcessingOp(e){const t=e.sequenceNumber;if(t===this.connectionOpSeqNumber&&this.reportGettingUpToDate(),void 0===this.sequenceNumberForMsnTracking&&t%1e3==0&&(this.sequenceNumberForMsnTracking=t,this.msnTrackingTimestamp=e.timestamp),void 0!==this.sequenceNumberForMsnTracking&&e.minimumSequenceNumber>=this.sequenceNumberForMsnTracking&&(Object(he.a)(void 0!==this.msnTrackingTimestamp,718),this.logger.sendPerformanceEvent({eventName:"MsnStatistics",sequenceNumber:t,msnDistance:t-this.sequenceNumberForMsnTracking,duration:e.timestamp-this.msnTrackingTimestamp}),this.sequenceNumberForMsnTracking=void 0),this.clientId===e.clientId&&this.clientSequenceNumberForLatencyStatistics===e.clientSequenceNumber){Object(he.a)(void 0!==this.opProcessingTimes.submitOpEventTime,288);const n=Date.now();void 0!==this.opProcessingTimes.inboundPushEventTime&&(this.opPerfData.durationInboundToProcessing=n-this.opProcessingTimes.inboundPushEventTime);const i=n-this.opProcessingTimes.submitOpEventTime;this.logger.sendPerformanceEvent(Object.assign({eventName:"OpRoundtripTime",sequenceNumber:t,referenceSequenceNumber:e.referenceSequenceNumber,duration:i,category:i>5e3?"error":"performance",pingLatency:this.pingLatency,msnDistance:this.deltaManager.lastSequenceNumber-this.deltaManager.minimumSequenceNumber},this.opPerfData)),this.clientSequenceNumberForLatencyStatistics=void 0,this.opPerfData={},this.opProcessingTimes={}}}}var Bn=n("3YFW"),Ln=n.n(Bn);const Vn="2.0.0-internal.4.3.0";class Un{constructor(e,t){var n,i;if(this.stateHandler=e,this.pendingMessages=new Ln.a,this.initialMessages=new Ln.a,this.disposeOnce=new Ve.a((()=>{this.initialMessages.clear(),this.pendingMessages.clear()})),this.isProcessingBatch=!1,this.dispose=()=>this.disposeOnce.value,null==t?void 0:t.pendingStates){const e=null==t?void 0:t.pendingStates;let r=!1;for(let t=0;t<e.length;t++){const s=e[t];"message"===s.type&&((null===(n=s.opMetadata)||void 0===n?void 0:n.batch)?r=!0:!1===(null===(i=s.opMetadata)||void 0===i?void 0:i.batch)?r=!1:!r||t!==e.length-1&&"flush"!==e[t+1].type||(r=!1,s.opMetadata=Object.assign(Object.assign({},s.opMetadata),{batch:!1})),this.initialMessages.push(s))}}}get pendingMessagesCount(){return this.pendingMessages.length}hasPendingMessagesetLocalState(){if(Object(he.a)(this.initialMessages.isEmpty(),745),!this.pendingMessages.isEmpty())return{pendingStates:this.pendingMessages.toArray().map((e=>Object.assign(Object.assign({},e),e.messageType===ss.IdAllocation?{content:Object.assign(Object.assign({},e.content),{stashedState:e.localOpMetadata}),localOpMetadata:void 0}:{localOpMetadata:void 0})))}}get disposed(){return this.disposeOnce.evaluated}onSubmitMessage(e,t,n,i,r){this.pendingMessages.push({type:"message",messageType:e,clientSequenceNumber:-1,referenceSequenceNumber:t,content:n,localOpMetadata:i,opMetadata:r})}async applyStashedOpsAt(e){for(;!this.initialMessages.isEmpty();){const t=this.initialMessages.peekFront();if(void 0!==e){if(t.referenceSequenceNumber>e)break;if(t.referenceSequenceNumber<e)throw new Error("loaded from snapshot too recent to apply stashed ops")}const n=await this.stateHandler.applyStashedOp(t.messageType,t.content);t.localOpMetadata=n,t.messageType===ss.IdAllocation&&delete t.content.stashedState,this.pendingMessages.push(this.initialMessages.shift())}}processPendingLocalMessage(e){this.maybeProcessBatchBegin(e);const t=this.pendingMessages.peekFront();if(Object(he.a)(void 0!==t,361),this.pendingMessages.shift(),t.messageType===e.type)return JSON.stringify(t.content)===JSON.stringify(e.contents)?(this.maybeProcessBatchEnd(e),t.localOpMetadata):void this.stateHandler.close(an.create("pending local message content mismatch","unexpectedAckReceived",e));this.stateHandler.close(an.create("pending local message type mismatch","unexpectedAckReceived",e,{expectedMessageType:t.messageType}))}maybeProcessBatchBegin(e){var t;(null===(t=e.metadata)||void 0===t?void 0:t.batch)&&(Object(he.a)(!this.isProcessingBatch&&void 0===this.pendingBatchBeginMessage,363),this.pendingBatchBeginMessage=e,this.isProcessingBatch=!0)}maybeProcessBatchEnd(e){var t,n;if(!this.isProcessingBatch)return;Object(he.a)(void 0!==this.pendingBatchBeginMessage,365);const i=null===(t=e.metadata)||void 0===t?void 0:t.batch;if(this.pendingMessages.isEmpty()||!1===i){const t=null===(n=this.pendingBatchBeginMessage.metadata)||void 0===n?void 0:n.batch;this.pendingBatchBeginMessage===e?Object(he.a)(void 0===t,366):!0===t&&!1===i||this.stateHandler.close(an.create("Pending batch inconsistency","processPendingLocalMessage",e,{runtimeVersion:Vn,batchClientId:this.pendingBatchBeginMessage.clientId,clientId:this.stateHandler.clientId(),hasBatchStart:!0===t,hasBatchEnd:!1===i,messageType:e.type,pendingMessagesCount:this.pendingMessagesCount})),this.pendingBatchBeginMessage=void 0,this.isProcessingBatch=!1}}replayPendingStates(){var e,t;Object(he.a)(this.stateHandler.connected(),370),Object(he.a)(this.clientId!==this.stateHandler.clientId(),371),this.clientId=this.stateHandler.clientId(),Object(he.a)(this.initialMessages.isEmpty(),372);let n=this.pendingMessages.length;if(0!==n)for(;n>0;){let i=this.pendingMessages.shift();n--,Object(he.a)(!1!==(null===(e=i.opMetadata)||void 0===e?void 0:e.batch),1051),(null===(t=i.opMetadata)||void 0===t?void 0:t.batch)?(Object(he.a)(n>0,1364),this.stateHandler.orderSequentially((()=>{for(var e,t;n>=0&&(this.stateHandler.reSubmit(i.messageType,i.content,i.localOpMetadata,i.opMetadata),!1!==(null===(e=i.opMetadata)||void 0===e?void 0:e.batch));)Object(he.a)(n>0,1365),i=this.pendingMessages.shift(),n--,Object(he.a)(!0!==(null===(t=i.opMetadata)||void 0===t?void 0:t.batch),1366)}))):this.stateHandler.reSubmit(i.messageType,i.content,i.localOpMetadata,i.opMetadata)}}}const Hn="Fluid.GarbageCollection.RunSweep",Gn="Fluid.GarbageCollection.DisableTombstone",$n="Fluid.GarbageCollection.ThrowOnTombstoneLoad",Kn="Fluid.GarbageCollection.ThrowOnTombstoneUsage",Wn="DataStore",Jn="SubDataStore",Qn="Blob",Xn="Other",Zn="Active",Yn="Inactive",ei="SweepReady";var ti=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n};class ni{constructor(e,t,n,i,r,s,o,a){this.mc=e,this.configs=t,this.isSummarizerClient=n,this.gcTombstoneEnforcementAllowed=i,this.createContainerMetadata=r,this.getNodeType=s,this.getNodeStateTracker=o,this.getNodePackagePath=a,this.loggedUnreferencedEvents=new Set,this.pendingEventsQueue=[]}shouldLogNonActiveEvent(e,t,n,i,r){return i.state!==Zn&&(t!==Jn||"Revived"===n)&&t!==Xn&&!this.loggedUnreferencedEvents.has(r)}nodeUsed(e){const t=this.getNodeStateTracker(e.nodeId);if(!t||void 0===e.currentReferenceTimestampMs)return;const n=`${t.state}-${e.nodeId}-${e.usageType}`,i=this.getNodeType(e.nodeId);if(!this.shouldLogNonActiveEvent(e.nodeId,i,e.usageType,t,n))return;this.loggedUnreferencedEvents.add(n);const r=t.state,s=ti(e,["usageType","currentReferenceTimestampMs","packagePath"]),o=Object.assign(Object.assign({id:e.nodeId,type:i,unrefTime:t.unreferencedTimestampMs,age:e.currentReferenceTimestampMs-t.unreferencedTimestampMs,timeout:r===Yn?this.configs.inactiveTimeoutMs:this.configs.sweepTimeoutMs},s),this.createContainerMetadata);if("Revived"===e.usageType&&e.isTombstoned&&ii(this.mc,{eventName:`GC_Tombstone_${i}_Revived`,category:"generic",url:e.nodeId,gcTombstoneEnforcementAllowed:this.gcTombstoneEnforcementAllowed},void 0),this.isSummarizerClient)this.pendingEventsQueue.push(Object.assign(Object.assign({},o),{usageType:e.usageType,state:r}));else if("Loaded"===e.usageType){const t=Object.assign({eventName:`${r}Object_${e.usageType}`,pkg:gn(e.packagePath),stack:Ot()},o);r===Yn?this.mc.logger.sendTelemetryEvent(t):this.mc.logger.sendErrorEvent(t)}}logIfMissingExplicitReferences(e,t,n,i){var r,s;for(const[o,a]of Object.entries(e.gcNodes)){const e=null!==(r=t.gcNodes[o])&&void 0!==r?r:[],c=null!==(s=n.get(o))&&void 0!==s?s:[],l=[];for(const t of a){const n=this.getNodeType(t);n!==Wn&&n!==Qn||o.startsWith(t)||e.includes(t)||c.includes(t)||l.push(t)}l.length>0&&i.sendErrorEvent({eventName:"gcUnknownOutboundReferences",gcNodeId:o,gcRoutes:JSON.stringify(l)})}}async logPendingEvents(e){for(const t of this.pendingEventsQueue){const{usageType:n,state:i}=t,r=ti(t,["usageType","state"]),s=this.getNodeStateTracker(t.id);if("Revived"===n==(void 0===s||s.state===Zn)){const s=await this.getNodePackagePath(t.id),o=t.fromId?await this.getNodePackagePath(t.fromId):void 0,a=Object.assign(Object.assign({},r),{eventName:`${i}Object_${n}`,pkg:s?{value:s.join("/"),tag:Dt.CodeArtifact}:void 0,fromPkg:o?{value:o.join("/"),tag:Dt.CodeArtifact}:void 0});i===Yn?e.sendTelemetryEvent(a):e.sendErrorEvent(a)}}this.pendingEventsQueue=[]}logSweepEvents(e,t,n,i,r){if(!0!==this.mc.config.getBoolean("Fluid.GarbageCollection.DisableSweepLog")&&void 0!==this.configs.sweepTimeoutMs)for(const[s,o]of n){if(o.state!==ei)return;const n=this.getNodeType(s);if(n!==Wn&&n!==Qn)return;const a=`Deleted-${s}`;if(this.loggedUnreferencedEvents.has(a))return;this.loggedUnreferencedEvents.add(a),e.sendTelemetryEvent(Object.assign({eventName:"GCObjectDeleted",id:s,type:n,age:t-o.unreferencedTimestampMs,timeout:this.configs.sweepTimeoutMs,completedGCRuns:i,lastSummaryTime:r},this.createContainerMetadata))}}}function ii(e,t,n,i){t.pkg=gn(n),t.tombstoneFlags=JSON.stringify({DisableTombstone:e.config.getBoolean(Gn),ThrowOnTombstoneUsage:e.config.getBoolean(Kn),ThrowOnTombstoneLoad:e.config.getBoolean($n)}),t.sweepFlags=JSON.stringify({EnableSweepFlag:e.config.getBoolean(Hn)}),e.logger.sendTelemetryEvent(t,i)}class ri{et numAttempts(){return this.startTimes.length}et latestAttemptTime(){return this.startTimes.length>0?this.startTimes[this.startTimes.length-1]:void 0}getDelay(){const e=Date.now(),t=this.latestAttemptTime;if(void 0!==t){const n=t-e;n>0&&(this.startTimes=this.startTimes.map(())}this.startTimes=this.startTimes.filter((t=>e-t<this.delayWindowMs));const n=Math.min(this.delayFn(this.startTimes.length),this.maxDelayMs);return this.startTimes.push(e),this.startTimes=this.startTimes.map((),n===this.maxDelayMs&&this.startTimes.shift(),n}}const si=function(){let{multiplier:e=2,coefficient:t=1,offset:n=0,initialDelay:i}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return r=>Math.max(0,r<=0&&void 0!==i?i:t*Math.pow(e,r)+n)},oi="summarizer";class ai extends me.a{constructor(e,t,n,i){super(),this.logger=e,this.summaryCollection=t,this.clientElection=n,this.maxOpsSinceLastSummary=i,this.lastReportedSeq=0,this.summaryCollection.on("default",(e=>{let{sequenceNumber:t}=e;var n,i;const r=this.electedClientId;if(void 0===r)return void(this.clientElection.eligibleCount>0&&this.clientElection.resetElectedClient(t));const s=this.clientElection.electionSequenceNumber;t-(null!==(n=this.lastSummaryAckSeqForClient)&&void 0!==n?n:s)>this.maxOpsSinceLastSummary&&t-this.lastReportedSeq>this.maxOpsSinceLastSummary&&(this.logger.sendTelemetryEvent({eventName:"ElectedClientNotSummarizing",electedClientId:r,lastSummaryAckSeqForClient:this.lastSummaryAckSeqForClient,electionSequenceNumber:s,nextElectedClientId:null===(i=this.clientElection.peekNextElectedClient())||void 0===i?void 0:i.clientId}),this.lastReportedSeq=t)})),this.summaryCollection.on(qe.a.SummaryAck,(),this.clientElection.on("election",((e,t)=>{this.lastSummaryAckSeqForClient=void 0,void 0===e&&this.clientElection.eligibleCount>0&&this.clientElection.resetElectedClient(t),this.emit("electedSummarizerChanged")}))}get electedClientId(){var e;return null===(e=this.clientElection.electedClient)||void 0===e?void 0:e.clientId}erialize(){var e;const{electedClientId:t,electedParentId:n,electionSequenceNumber:i}=this.clientElection.serialize();return{electedClientId:t,electedParentId:n,electionSequenceNumber:null!==(e=this.lastSummaryAckSeqForClient)&&void 0!==e?e:i}}static isClientEligible(e){const t=e.client.details;return void 0===t||ai.clientDetailsPermitElection(t)}}ai.clientDetailsPermitElection=e=>e.capabilities.interactive||e.type===oi;class ci{constructor(e,t,n){this.path=e,this.routeContext=t,this.get=n,this.attached=!1,this.absolutePath=Rn(e,this.routeContext)}get IFluidHandle(){return this}get isAttached(){return this.attached}lass li{sync getDelay(){return Promise.race([this.cancelP.promise,new Promise((e=>setTimeout(e,this.throttler.getDelay())))])}cancel(){this.cancelP.resolve(),this.cancelP=new lt.a}}var di;!di||(di={}));class ui extends me.a{constructor(e,t,n,i,r,s,o){let a=arguments.length>7&&void 0!==arguments[7]?arguments[7]:{},c=arguments.length>8?arguments[8]:void 0;super(),this.routeContext=e,this.getStorage=n,this.blobRequested=r,this.isBlobDeleted=s,this.runtime=o,this.closeContainer=c,this.pendingBlobs=new Map,this.opsInFlight=new Map,this.retryThrottler=new li(new ri(6e4,3e4,si({coefficient:20,initialDelay:0}))),this.tombstonedBlobs=new Set,this.mc=Jt(Rt.create(this.runtime.logger,"BlobManager")),this.throwOnTombstoneLoad=!0===this.mc.config.getBoolean($n)&&this.runtime.gcTombstoneEnforcementAllowed&&this.runtime.clientDetails.type!==oi,this.runtime.on("disconnected",(()=>this.onDisconnected())),this.redirectTable=this.load(t),Object.entries(a).forEach((e=>{let[t,n]=e;const i=Object(yn.e)(n.blob,"base64");if(n.minTTLInSeconds&&n.uploadTime){const e=(Date.now()-n.uploadTime)/1e3;if(n.minTTLInSeconds-e>n.minTTLInSeconds/2)return void this.pendingBlobs.set(t,{blob:i,status:di.OfflinePendingOp,handleP:new lt.a,uploadP:void 0,uploadTime:n.uploadTime,minTTLInSeconds:n.minTTLInSeconds})}this.pendingBlobs.set(t,{blob:i,status:di.OfflinePendingUpload,handleP:new lt.a,uploadP:this.uploadBlob(t,i)})})),this.sendBlobAttachOp=(e,t)=>{const n=this.pendingBlobs.get(e);if((null==n?void 0:n.uploadTime)&&(null==n?void 0:n.minTTLInSeconds)){const i=(Date.now()-n.uploadTime)/1e3,r=n.minTTLInSeconds-i<0;this.mc.logger.sendTelemetryEvent({eventName:"sendBlobAttach",entryStatus:n.status,secondsSinceUpload:i,minTTLInSeconds:n.minTTLInSeconds,expired:r}),r&&this.closeContainer(new nn("Trying to submit a BlobAttach for expired blob",void 0,{localId:e,blobId:t,entryStatus:n.status,secondsSinceUpload:i}))}return i(e,t)}}get pendingOfflineUploads(){return Array.from(this.pendingBlobs.values()).filter((e=>e.status===di.OfflinePendingUpload))}et hasPendingBlobs(){return this.runtime.attachState!==et.Attached&&this.redirectTable.size>0||this.pendingBlobs.size>0}async onConnected(){this.retryThrottler.cancel();const e=this.pendingOfflineUploads.map(();await Ft.timedExecAsync(this.mc.logger,{eventName:"BlobUploadOnConnected",count:e.length},(,{start:!0,end:!0})}onDisconnected(){for(const[e,t]of this.pendingBlobs)t.status===di.OnlinePendingOp&&this.transitionToOffline(e)}get storageIds(){const e=new Set(this.redirectTable.values()),t=e.delete(void 0);return Object(he.a)(!t||this.runtime.attachState===et.Detached&&0===e.size,898),e}async getBlob(e){this.verifyBlobValidity(e);const t=this.pendingBlobs.get(e);if(t)return t.blob;let n;if(this.runtime.attachState===et.Detached)Object(he.a)(this.redirectTable.has(e),899),n=e;else{const t=this.redirectTable.get(e);Object(he.a)(!!t,287),n=t}return this.blobRequested(hi(e)),Ft.timedExecAsync(this.mc.logger,{eventName:"AttachmentReadBlob",id:n},(async()=>this.getStorage().readBlob(n)),{end:!0,cancel:"error"})}getBlobHandle(e){return Object(he.a)(this.redirectTable.has(e)||this.pendingBlobs.has(e),900),new ci(`${ui.basePath}/${e}`,this.routeContext,()}async createBlobDetached(e){const t=await this.getStorage().createBlob(e);return this.setRedirection(t.id,void 0),this.getBlobHandle(t.id)}async createBlob(e){if(this.runtime.attachState===et.Detached)return this.createBlobDetached(e);this.runtime.attachState===et.Attaching&&(this.mc.logger.sendTelemetryEvent({eventName:"CreateBlobWhileAttaching"}),await new Promise(()),Object(he.a)(this.runtime.attachState===et.Attached,901);const t=Object(ge.a)(),n={blob:e,status:di.OnlinePendingUpload,handleP:new lt.a,uploadP:this.uploadBlob(t,e)};return this.pendingBlobs.set(t,n),n.handleP.promise}async uploadBlob(e,t){return Ft.timedExecAsync(this.mc.logger,{eventName:"createBlob"},(,{end:!0,cancel:this.runtime.connected?"error":"generic"}).then((t=>this.onUploadResolve(e,t)),()}eleteAndEmitsIfEmpty(e){this.pendingBlobs.has(e)&&(this.pendingBlobs.delete(e),this.hasPendingBlobs||this.emit("noPendingBlobs"))}onUploadResolve(e,t){var n;const i=this.pendingBlobs.get(e);return Object(he.a)((null==i?void 0:i.status)===di.OnlinePendingUpload||(null==i?void 0:i.status)===di.OfflinePendingUpload,902),i.storageId=t.id,i.uploadTime=Date.now(),i.minTTLInSeconds=t.minTTLInSeconds,this.runtime.connected?i.status===di.OnlinePendingUpload?(this.sendBlobAttachOp(e,t.id),this.storageIds.has(t.id)?(this.setRedirection(e,t.id),i.handleP.resolve(this.getBlobHandle(e)),this.deleteAndEmitsIfEmpty(e)):(this.opsInFlight.set(t.id,(null!==(n=this.opsInFlight.get(t.id))&&void 0!==n?n:[]).concat(e)),i.status=di.OnlinePendingOp)):i.status===di.OfflinePendingUpload&&(i.status=di.OfflinePendingOp):(this.mc.logger.sendTelemetryEvent({eventName:"BlobUploadSuccessWhileDisconnected"}),i.status===di.OnlinePendingUpload&&this.transitionToOffline(e),i.status=di.OfflinePendingOp),t}async onUploadReject(e,t){const n=this.pendingBlobs.get(e);if(Object(he.a)(!!n,903),this.runtime.connected)throw n.handleP.reject(t),t;return n.status===di.OnlinePendingUpload&&this.transitionToOffline(e),n.uploadP=this.retryThrottler.getDelay().then((),n.uploadP}transitionToOffline(e){Object(he.a)(!this.runtime.connected,904);const t=this.pendingBlobs.get(e);Object(he.a)(!!t,905),Object(he.a)([di.OnlinePendingUpload,di.OnlinePendingOp].includes(t.status),906),t.status!==di.OnlinePendingOp&&this.sendBlobAttachOp(e,t.storageId),t.status=t.status===di.OnlinePendingUpload?di.OfflinePendingUpload:di.OfflinePendingOp,t.handleP.resolve(this.getBlobHandle(e))}reSubmit(e){Object(he.a)(!!e,907);const{localId:t,blobId:n}=e;Object(he.a)(void 0!==t,1293);const i=this.pendingBlobs.get(t);return n?this.sendBlobAttachOp(t,n):(Object(he.a)((null==i?void 0:i.status)===di.OfflinePendingOp&&!!(null==i?void 0:i.storageId),909),this.sendBlobAttachOp(t,i.storageId))}processBlobAttachOp(e,t){var n,i;const r=null===(n=e.metadata)||void 0===n?void 0:n.localId,s=null===(i=e.metadata)||void 0===i?void 0:i.blobId;if(Object(he.a)(void 0!==s,298),void 0!==r&&this.setRedirection(r,s),this.setRedirection(s,s),t){Object(he.a)(void 0!==r,1294);const e=this.opsInFlight.get(s);void 0!==e&&(e.forEach((e=>{const t=this.pendingBlobs.get(e);Object(he.a)(void 0!==t,911),t.status===di.OnlinePendingOp&&(this.setRedirection(e,s),t.handleP.resolve(this.getBlobHandle(e)),this.deleteAndEmitsIfEmpty(e))})),this.opsInFlight.delete(s)),this.deleteAndEmitsIfEmpty(r)}}static async load(e,t){if(!e)return{};let n;const i=e.blobs[this.redirectTableBlobName];return i&&(n=await t(i)),{ids:Object.entries(e.blobs).filter((e=>{let[t,n]=e;return t!==this.redirectTableBlobName})).map((),redirectTable:n}}load(e){var t,n,i;this.mc.logger.sendTelemetryEvent({eventName:"AttachmentBlobsLoaded",count:null!==(n=null===(t=e.ids)||void 0===t?void 0:t.length)&&void 0!==n?n:0,redirectTable:null===(i=e.redirectTable)||void 0===i?void 0:i.length});const r=new Map(e.redirectTable);if(e.ids){const t=this.runtime.attachState===et.Detached;e.ids.forEach((e=>r.set(e,t?void 0:e)))}return r}summarize(e){const t=Array.from(this.storageIds.size>0?this.storageIds:this.redirectTable.keys()),n=new En;return t.forEach((e=>{n.addAttachment(e)})),this.redirectTable.size>t.length&&n.addBlob(ui.redirectTableBlobName,JSON.stringify(Array.from(this.redirectTable.entries()).filter((e=>{let[t,n]=e;return t!==n})))),n.getSummaryTree()}getGCData(){const e={gcNodes:{}};for(const[t,n]of this.redirectTable)Object(he.a)(!!n,912),t!==n&&(e.gcNodes[hi(t)]=[]);return e}updateUnusedRoutes(e){this.deleteBlobsFromRedirectTable(e)}deleteSweepReadyNodes(e){return!0!==this.mc.config.getBoolean("Fluid.GarbageCollection.Test.SweepAttachmentBlobs")?[]:(this.deleteBlobsFromRedirectTable(e),Array.from(e))}deleteBlobsFromRedirectTable(e){if(0===e.length)return;const t=new Set;for(const n of e){const e=mi(n);if(!this.redirectTable.has(e)){this.mc.logger.sendErrorEvent({eventName:"DeletedAttachmentBlobNotFound",blobId:e});continue}const i=this.redirectTable.get(e);Object(he.a)(!!i,1467),t.add(i),this.redirectTable.delete(e)}for(const[e,n]of this.redirectTable.entries())Object(he.a)(!!n,1468),t.has(n)&&e!==n&&t.delete(n);for(const e of t)this.redirectTable.delete(e)}updateTombstonedRoutes(e){const t=new Set;for(const n of e){const e=mi(n);t.add(e)}for(const e of this.tombstonedBlobs)t.has(e)||this.tombstonedBlobs.delete(e);for(const e of t)this.tombstonedBlobs.add(e)}verifyBlobValidity(e){let t="valid";if(this.isBlobDeleted(hi(e))?t="deleted":this.tombstonedBlobs.has(e)&&(t="tombstoned"),"valid"===t)return;const n="deleted"===t||this.throwOnTombstoneLoad,i=mn(vn(404,"Blob was deleted",{url:e},"tombstoned"===t?{[us]:!0}:void 0));if(ii(this.mc,{eventName:"tombstoned"===t?"GC_Tombstone_Blob_Requested":"GC_Deleted_Blob_Requested",category:n?"error":"generic",gcTombstoneEnforcementAllowed:this.runtime.gcTombstoneEnforcementAllowed},[ui.basePath],i),n)throw i}setRedirectTable(e){Object(he.a)(this.runtime.attachState===et.Detached,594),Object(he.a)(this.redirectTable.size===e.size,913);for(const[t,n]of e)Object(he.a)(this.redirectTable.has(t),596),this.setRedirection(t,n),this.setRedirection(n,n)}getPendingBlobs(){const e={};for(const[t,n]of this.pendingBlobs)e[t]=n.minTTLInSeconds?{blob:Object(yn.c)(n.blob,"base64"),uploadTime:n.uploadTime,minTTLInSeconds:n.minTTLInSeconds}:{blob:Object(yn.c)(n.blob,"base64")};return e}}unction mi(e){const t=e.split("/");return Object(he.a)(3===t.length&&t[1]===ui.basePath,1469),t[2]}ui.basePath="_blobs",ui.redirectTableBlobName=".redirectTable";class gi{constructor(e,t,n){this.value=e,this.path=t,this.routeContext=n,this.pendingHandlesToMakeVisible=new Set,this.locallyVisible=!1,this.absolutePath=Rn(t,this.routeContext)}get IFluidHandle(){return this}get isAttached(){return this.routeContext.isAttached}sync get(){return this.value}attachGraph(){this.visible||(this.locallyVisible=!0,this.pendingHandlesToMakeVisible.forEach((e=>{e.attachGraph()})),this.pendingHandlesToMakeVisible.clear(),this.routeContext.attachGraph())}bindfunction pi(e){const t=e.filter((),n=new Map;for(const e of t){Object(he.a)(e.startsWith("/"),1504);const t=e.split("/")[1],i=e.slice(t.length+1),r=n.get(t);void 0!==r?r.push(i):n.set(t,[i])}return n}function fi(e,t,n){const i=[];for(const r of t){const t=`${e}${r.path}`;if(r.type===Cn.b.Blob){const e=r.value,s=Object(yn.e)(e.contents,e.encoding),o=Object(ge.a)();n.set(o,s),i.push({mode:Cn.a[r.mode],path:t,sha:o,size:0,type:"blob",url:""})}else if(r.type===Cn.b.Tree){Object(he.a)(r.type===Cn.b.Tree,257);const e=r.value;i.push({mode:Cn.a[r.mode],path:t,sha:"",size:-1,type:"tree",url:""});const s=fi(`${t}/`,e.entries,n);i.push(...s)}}return i}function vi(e,t){const n=function(e,t){return{sha:"",tree:fi("",e,t),url:""}}(e,t);return Object(Sn.e)(n)}class yi{constructor(e){this.notBoundContexts=new Set,this._contexts=new Map,this.deferredContexts=new Map,this.disposeOnce=new Ve.a((()=>{for(const[e,t]of this.deferredContexts)t.promise.then(().catch((t=>{this._logger.sendErrorEvent({eventName:"FluidDataStoreContextDisposeError",fluidDataStoreId:e},t)}))})),this.dispose=this._logger=Rt.create(e)}et size(){return this._contexts.size}get disposed(){return this.disposeOnce.evaluated}notBoundLength(){return this.notBoundContexts.size}isNotBound(e){return this.notBoundContexts.has(e)}has(e){return this._contexts.has(e)}get(e){return this._contexts.get(e)}delete(e){return this.deferredContexts.delete(e),this.notBoundContexts.delete(e),this._contexts.delete(e)}getUnbound(e){const t=this._contexts.get(e);if(void 0!==t&&this.notBoundContexts.has(e))return t}addUnbound(e){const t=e.id;Object(he.a)(!this._contexts.has(t),344),this._contexts.set(t,e),this.notBoundContexts.add(t),this.ensureDeferred(t)}async getBoundOrRemoted(e,t){const n=this.ensureDeferred(e);if(t||n.isCompleted)return n.promise}ensureDeferred(e){const t=this.deferredContexts.get(e);if(t)return t;const n=new lt.a;return this.deferredContexts.set(e,n),n}bind(e){const t=this.notBoundContexts.delete(e);Object(he.a)(t,345),this.resolveDeferred(e)}resolveDeferred(e){const t=this._contexts.get(e);Object(he.a)(!!t,346),Object(he.a)(!this.notBoundContexts.has(e),347);const n=this.deferredContexts.get(e);Object(he.a)(!!n,348),n.resolve(t)}addBoundOrRemoted(e){const t=e.id;Object(he.a)(!this._contexts.has(t),349),this._contexts.set(t,e),this.ensureDeferred(t),this.resolveDeferred(t)}}class bi{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;this.threshold=e,this.logger=t,this.thresholdMultiple=n}send(e,t){t<this.threshold||this.logger.sendPerformanceEvent({eventName:e,value:t})}sendIfMultiple(e,t){t===this.thresholdMultiple&&(this.logger.sendPerformanceEvent({eventName:e,value:t}),this.thresholdMultiple=2*this.thresholdMultiple)}}function Si(e){return e.summaryFormatVersion?e.summaryFormatVersion:"0.1"===e.snapshotFormatVersion?1:0}onst wi=e=>void 0===e?void 0:{clientId:e.clientId,clientSequenceNumber:e.clientSequenceNumber,minimumSequenceNumber:e.minimumSequenceNumber,referenceSequenceNumber:e.referenceSequenceNumber,sequenceNumber:e.sequenceNumber,timestamp:e.timestamp,type:e.type},Oi=".aliases",Ii=".metadata",Ni=".chunks",Ti=".electedSummarizer",Ei=".idCompressor",ki=[".protocol",".logTail",".serviceProtocol",".blobs",dn.gcTreeKey,Ei],ji=".component";function Pi(e){e.summary={type:ln.a.Tree,tree:{[dn.channelsTreeName]:e.summary}},e.stats.treeNodeCount++}function _i(e,t){return{pkg:JSON.stringify(e),summaryFormatVersion:2,isRootDataStore:t}}function Mi(e,t){const n=_i(e,t);return new Sn.b(ji,JSON.stringify(n))}class Di extends me.a{constructor(e,t,n,i){var r;super(),this.existing=t,this.isLocalDataStore=n,this.makeLocallyVisibleFn=i,this._disposed=!1,this._tombstoned=!1,this.deleted=!1,this.detachedRuntimeCreation=!1,this.loaded=!1,this.pending=[],this._isInMemoryRoot=!1,this._containerRuntime=e.runtime,this.id=e.id,this.storage=e.storage,this.scope=e.scope,this.pkg=e.pkg,Object(he.a)(!this.id.includes("/"),314),this._attachState=this.containerRuntime.attachState!==et.Detached&&this.existing?this.containerRuntime.attachState:et.Detached,this.summarizerNode=e.createSummarizerNodeFn((,(async e=>this.getGCDataInternal(e))),this.mc=Jt(Rt.create(this.logger,"FluidDataStoreContext")),this.thresholdOpsCounter=new bi(Di.pendingOpsCountThreshold,this.mc.logger),this.throwOnTombstoneUsage=!0===this.mc.config.getBoolean(Kn)&&this._containerRuntime.gcTombstoneEnforcementAllowed&&this.clientDetails.type!==oi,this.localChangesTelemetryCount=null!==(r=this.mc.config.getNumber("Fluid.Telemetry.LocalChangesTelemetryCount"))&&void 0!==r?r:10}get packagePath(){return Object(he.a)(void 0!==this.pkg,313),this.pkg}get options(){return this._containerRuntime.options}get clientId(){return this._containerRuntime.clientId}get clientDetails(){return this._containerRuntime.clientDetails}get logger(){return this._containerRuntime.logger}get deltaManager(){return this._containerRuntime.deltaManager}get connected(){return this._containerRuntime.connected}get IFluidHandleContext(){return this._containerRuntime.IFluidHandleContext}get containerRuntime(){return this._containerRuntime}ensureNoDataModelChanges(e){return this._containerRuntime.ensureNoDataModelChanges(e)}get isLoaded(){return this.loaded}get baseSnapshot(){return this._baseSnapshot}get idCompressor(){return this._containerRuntime.idCompressor}get disposed(){return this._disposed}get tombstoned(){return this._tombstoned}get attachState(){return this._attachState}get IFluidDataStoreRegistry(){return this.registry}async isRoot(){return this.isInMemoryRoot()||(await this.getInitialSnapshotDetails()).isRootDataStore}isInMemoryRoot(){return this._isInMemoryRoot}dispose(){this._disposed||(this._disposed=!0,this.channelDeferred&&this.channelDeferred.promise.then((e=>{e.dispose()})).catch((e=>{})))}delete(){this.deleted=!0}ejectDeferredRealize(e,t,n){throw new Pt(e,{failedPkgPath:{value:t,tag:Dt.CodeArtifact},fullPackageName:gn(n)})}async realize(){return Object(he.a)(!this.detachedRuntimeCreation,317),this.channelDeferred||(this.channelDeferred=new lt.a,this.realizeCore(this.existing).catch((e=>{var t;const n=an.wrapIfUnrecognized(e,"realizeFluidDataStoreContext");n.addTelemetryProperties({fluidDataStoreId:{value:this.id,tag:Dt.CodeArtifact},packageName:gn(this.pkg)}),null===(t=this.channelDeferred)||void 0===t||t.reject(n),this.logger.sendErrorEvent({eventName:"RealizeError"},n)}))),this.channelDeferred.promise}async factoryFromPackagePath(e){let t;Object(he.a)(this.pkg===e,318),void 0===e&&this.rejectDeferredRealize("packages is undefined");let n,i=this._containerRuntime.IFluidDataStoreRegistry;for(const r of e)i||this.rejectDeferredRealize("No registry for package",n,e),n=r,t=await i.get(r),t||this.rejectDeferredRealize("Registry does not contain entry for the package",r,e),i=t.IFluidDataStoreRegistry;const r=null==t?void 0:t.IFluidDataStoreFactory;return void 0===r&&this.rejectDeferredRealize("Can't find factory for package",n,e),{factory:r,registry:i}}async realizeCore(e){const t=await this.getInitialSnapshotDetails();this._baseSnapshot=t.snapshot;const n=t.pkg,{factory:i,registry:r}=await this.factoryFromPackagePath(n);Object(he.a)(void 0===this.registry,319),this.registry=r;const s=await i.instantiateDataStore(this,e);Object(he.a)(void 0!==s,320),this.bindRuntime(s)}setConnectionState(e,t){this.verifyNotClosed("setConnectionState",!1),this.loaded&&(Object(he.a)(this.connected===e,321),this.channel.setConnectionState(e,t))}process(e,t,n){var i;this.verifyNotClosed("process",!0,cn(e));const r=e.contents,s=Object.assign(Object.assign({},e),{type:r.type,contents:r.content});if(this.summarizerNode.recordChange(s),this.loaded)return null===(i=this.channel)||void 0===i?void 0:i.process(s,t,n);Object(he.a)(!t,322),Object(he.a)(void 0!==this.pending,573),this.pending.push(s),this.thresholdOpsCounter.sendIfMultiple("StorePendingOps",this.pending.length)}processSignal(e,t){var n;this.verifyNotClosed("processSignal"),this.loaded&&(null===(n=this.channel)||void 0===n||n.processSignal(e,t))}getQuorum(){return this._containerRuntime.getQuorum()}getAudience(){return this._containerRuntime.getAudience()}async summarize(){return this.summarizerNode.summarize(arguments.length>0&&void 0!==arguments[0]&&arguments[0],!(arguments.length>1&&void 0!==arguments[1])||arguments[1],arguments.length>2?arguments[2]:void 0)}async summarizeInternal(e,t,n){await this.realize();const i=await this.channel.summarize(e,t,n);Pi(i);const r=[dn.channelsTreeName],{pkg:s}=await this.getInitialSnapshotDetails(),o=_i(s,await this.isRoot());return Tn(i,ji,JSON.stringify(o)),this.summarizerNode.isReferenced()||(i.summary.unreferenced=!0,i.stats.unreferencedBlobSize=i.stats.totalBlobSize),Object.assign(Object.assign({},i),{id:this.id,pathPartsForChildren:r})}async getGCData(){return this.summarizerNode.getGCData(arguments.length>0&&void 0!==arguments[0]&&arguments[0])}async getGCDataInternal(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return await this.realize(),Object(he.a)(void 0!==this.channel,323),this.channel.getGCData(e)}updateUsedRoutes(e){this.summarizerNode.updateUsedRoutes(e),this.lastUsedRoutes=e,this.loaded&&this.updateChannelUsedRoutes()}addedGCOutboundReference(e,t){this._containerRuntime.addedGCOutboundReference(e,t)}updateChannelUsedRoutes(){if(Object(he.a)(this.loaded,324),Object(he.a)(void 0!==this.channel,325),void 0===this.lastUsedRoutes)return;const e=this.lastUsedRoutes.filter((e=>"/"!==e&&""!==e));this.channel.updateUsedRoutes(e)}ubmitMessage(e,t,n){this.verifyNotClosed("submitMessage"),Object(he.a)(!!this.channel,326);const i={content:t,type:e};this.identifyLocalChangeInSummarizer("DataStoreMessageSubmittedInSummarizer",e),this._containerRuntime.submitDataStoreOp(this.id,i,n)}setChannelDirty(e){this.verifyNotClosed("setChannelDirty");const t=this.deltaManager.lastSequenceNumber;this.summarizerNode.invalidate(t);const n=this.summarizerNode.getChild(e);n&&n.invalidate(t)}submitSignal(e,t){return this.verifyNotClosed("submitSignal"),Object(he.a)(!!this.channel,327),this._containerRuntime.submitDataStoreSignal(this.id,e,t)}makeLocallyVisible(){Object(he.a)(void 0!==this.channel,719),Object(he.a)(this.channel.visibilityState===dn.VisibilityState.LocallyVisible,1424),this.makeLocallyVisibleFn()}bindToContext(){this.makeLocallyVisibleFn()}bindRuntime(e){var t;if(this.channel)throw new Error("Runtime already bound");try{Object(he.a)(!this.detachedRuntimeCreation,328),Object(he.a)(void 0!==this.channelDeferred,329),Object(he.a)(void 0!==this.pkg,330);const t=this.pending;for(const n of t)e.process(n,!1,void 0);this.thresholdOpsCounter.send("ProcessPendingOps",t.length),this.pending=void 0,this.loaded=!0,this.channel=e,Object.freeze(this.pkg),this.updateChannelUsedRoutes(),this.channelDeferred.resolve(this.channel)}catch(e){null===(t=this.channelDeferred)||void 0===t||t.reject(e),this.logger.sendErrorEvent({eventName:"BindRuntimeError",fluidDataStoreId:{value:this.id,tag:Dt.CodeArtifact}},e)}}async getAbsoluteUrl(e){if(this.attachState===et.Attached)return this._containerRuntime.getAbsoluteUrl(e)}setInMemoryRoot(){this._isInMemoryRoot=!0}eSubmit(e,t){Object(he.a)(!!this.channel,331),this.channel.reSubmit(e.type,e.content,t)}rollback(e,t){if(!this.channel)throw new Error("Channel must exist when rolling back ops");if(!this.channel.rollback)throw new Error("Channel doesn't support rollback");this.channel.rollback(e.type,e.content,t)}async applyStashedOp(e){return this.channel||await this.realize(),Object(he.a)(!!this.channel,332),this.channel.applyStashedOp(e.content)}verifyNotClosed(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(this.deleted){const t=new on(`Context is deleted! Call site [${e}]`,n);throw this.mc.logger.sendErrorEvent({eventName:"GC_Deleted_DataStore_Changed",callSite:e},t),t}if(this._disposed)throw new Error(`Context is closed! Call site [${e}]`);if(t&&this.tombstoned){const t=new on(`Context is tombstoned! Call site [${e}]`,n);if(ii(this.mc,{eventName:"GC_Tombstone_DataStore_Changed",category:this.throwOnTombstoneUsage?"error":"generic",gcTombstoneEnforcementAllowed:this._containerRuntime.gcTombstoneEnforcementAllowed,callSite:e},this.pkg,t),this.throwOnTombstoneUsage)throw t}}identifyLocalChangeInSummarizer(e,t){var n,i;this.clientDetails.type!==oi||this.localChangesTelemetryCount<=0||(this.mc.logger.sendTelemetryEvent({eventName:e,type:t,fluidDataStoreId:{value:this.id,tag:Dt.CodeArtifact},packageName:gn(this.pkg),isSummaryInProgress:null===(i=(n=this.summarizerNode).isSummaryInProgress)||void 0===i?void 0:i.call(n),stack:Ot()}),this.localChangesTelemetryCount--)}getCreateChildSummarizerNodeFn(e,t){return(n,i)=>this.summarizerNode.createChild(n,e,t,{throwOnFailure:!0},i)}async uploadBlob(e){return this.containerRuntime.uploadBlob(e)}}Di.pendingOpsCountThreshold=1e3;class xi extends Di{constructor(e){super(e,!0,!1,(()=>{throw new Error("Already attached")})),this.initialSnapshotDetailsP=new lt.b((async()=>{var e;let t=this.initSnapshotValue,n=!0;if(t&&void 0!==t.blobs[".component"]){const i=await Object(Fe.a)(this.storage,t.blobs[".component"]);let r;r=Si(i)<1?i.pkg.startsWith('["')&&i.pkg.endsWith('"]')?JSON.parse(i.pkg):[i.pkg]:JSON.parse(i.pkg),this.pkg=r,n=null===(e=i.isRootDataStore)||void 0===e||e,Ci(i)&&(t=t.trees[dn.channelsTreeName],Object(he.a)(void 0!==t,510))}return{pkg:this.pkg,isRootDataStore:n,snapshot:t}})),this.initSnapshotValue=e.snapshotTree,void 0!==e.snapshotTree&&this.summarizerNode.updateBaseSummaryState(e.snapshotTree)}async getInitialSnapshotDetails(){return this.initialSnapshotDetailsP}generateAttachMessage(){throw new Error("Cannot attach remote store")}}class Ai extends Di{constructor(e){super(e,void 0!==e.snapshotTree,!0,e.makeLocallyVisibleFn),this.identifyLocalChangeInSummarizer("DataStoreCreatedInSummarizer"),this.snapshotTree=e.snapshotTree,!0===e.isRootDataStore&&this.setInMemoryRoot(),this.createProps=e.createProps,this.attachListeners()}attachListeners(){this.once("attaching",(()=>{Object(he.a)(this.attachState===et.Detached,333),this._attachState=et.Attaching})),this.once("attached",(()=>{Object(he.a)(this.attachState===et.Attaching,334),this._attachState=et.Attached}))}generateAttachMessage(){Object(he.a)(void 0!==this.channel,335),Object(he.a)(void 0!==this.pkg,336);const e=this.channel.getAttachSummary();Pi(e);const t=_i(this.pkg,this.isInMemoryRoot());Tn(e,ji,JSON.stringify(t));const n=_n(e.summary);return{id:this.id,snapshot:n,type:this.pkg[this.pkg.length-1]}}async getInitialSnapshotDetails(){var e;let t,n=this.snapshotTree,i=!1;return void 0!==n&&(t=await async function(e,t){const n=await Object(Fe.a)(e,t.blobs[".component"]),i=Si(n);return Object(he.a)(i>0,469),n}(this.storage,n),Ci(t)&&(n=n.trees[dn.channelsTreeName],Object(he.a)(void 0!==n,511)),void 0===this.pkg&&(this.pkg=JSON.parse(t.pkg),(null===(e=t.isRootDataStore)||void 0===e||e)&&(i=!0,this.setInMemoryRoot()))),Object(he.a)(void 0!==this.pkg,338),{pkg:this.pkg,isRootDataStore:i,snapshot:n}}delete(){ii(this.mc,{eventName:"GC_Deleted_DataStore_Unexpected_Delete",message:"Unexpected deletion of a local data store context",category:"error",gcTombstoneEnforcementAllowed:void 0},this.pkg),super.delete()}}lass Fi extends Ai{sync attachRuntime(e,t){var n;Object(he.a)(this.detachedRuntimeCreation,340),this.detachedRuntimeCreation=!1,Object(he.a)(void 0===this.channelDeferred,341),this.channelDeferred=new lt.a;const i=e.IFluidDataStoreFactory,r=await this.factoryFromPackagePath(this.pkg);Object(he.a)(r.factory===i,342),Object(he.a)(void 0===this.registry,343),this.registry=r.registry,super.bindRuntime(t),await(null===(n=t.entryPoint)||void 0===n?void 0:n.get()),await this.isRoot()&&t.makeVisibleAndAttachGraph()}async getInitialSnapshotDetails(){if(this.detachedRuntimeCreation)throw new Error("Detached Fluid Data Store context can't be realized! Please attach runtime first!");return super.getInitialSnapshotDetails()}}class qi extends class{constructor(e){this.internalStorageService=e}set policies(e){this._policies=e}et repositoryUrl(){return this.internalStorageService.repositoryUrl}async getSnapshotTree(e,t){return this.internalStorageService.getSnapshotTree(e,t)}async getVersions(e,t,n,i){return this.internalStorageService.getVersions(e,t,n,i)}async uploadSummaryWithContext(e,t){return this.internalStorageService.uploadSummaryWithContext(e,t)}async downloadSummary(e){return this.internalStorageService.downloadSummary(e)}async createBlob(e){return this.internalStorageService.createBlob(e)}async readBlob(e){return this.internalStorageService.readBlob(e)}}{constructor(e,t){super(e),this.attachBlobs=t}get policies(){return this.internalStorageService.policies}async readBlob(e){const t=this.attachBlobs.get(e);return void 0!==t?t:this.internalStorageService.readBlob(e)}}const zi=e=>"string"==typeof(null==e?void 0:e.internalId)&&"string"==typeof(null==e?void 0:e.alias),Bi=(e,t,n,i,r)=>new Ui(e,t,n,i,r);var Li,Vi;!function(e){e.Aliased="Aliased",e.Aliasing="Aliasing",e.None="None"}(Li||(Li={}));class Ui{constructorsync trySetAlias(e){if(e.includes("/"))throw new rn(`The alias cannot contain slashes: '${e}'`);switch(this.aliasState){case Li.Aliasing:return Object(he.a)(void 0!==this.aliasResult,790),await this.aliasResult,this.alias===e?"Success":"AlreadyAliased";case Li.Aliased:return this.alias===e?"Success":"AlreadyAliased";case Li.None:if(void 0!==this.pendingAliases.get(e))return"Conflict";break;default:Object(dt.a)(this.aliasState)}return this.aliasState=Li.Aliasing,this.aliasResult=this.trySetAliasInternal(e),this.pendingAliases.set(e,this.aliasResult),this.aliasResult}async trySetAliasInternal(e){const t={internalId:this.internalId,alias:e};if(this.fluidDataStoreChannel.makeVisibleAndAttachGraph(),this.runtime.attachState===et.Detached){const e=this.datastores.processAliasMessageCore(t);return this.aliasState=Li.Aliased,e?"Success":"Conflict"}return await this.ackBasedPromise(().catch((t=>(this.logger.sendErrorEvent({eventName:"AliasingException",alias:{value:e,tag:Dt.UserData},internalId:{value:this.internalId,tag:Dt.CodeArtifact}},t),!1))).finally(()?(this.alias=e,this.aliasState=Li.Aliased,"Success"):(this.aliasState=Li.None,this.aliasResult=void 0,"Conflict")}async request(e){return this.fluidDataStoreChannel.request(e)}get entryPoint(){return this.fluidDataStoreChannel.entryPoint}get IFluidRouter(){return this.fluidDataStoreChannel}async ackBasedPromise(e){let t;return new Promise(((n,i)=>{t=()=>i(new Error("ContainerRuntime disposed while this ack-based Promise was pending")),this.runtime.disposed?t():(this.runtime.on("dispose",t),e(n,i))})).finally((()=>{this.runtime.off("dispose",t)}))}}class Hi{constructor(e,t,n,i,r,s,o,a,c){let l=arguments.length>9&&void 0!==arguments[9]?arguments[9]:new yi(s);this.baseSnapshot=e,this.runtime=t,this.submitAttachFn=n,this.getCreateChildSummarizerNodeFn=i,this.deleteChildSummarizerNodeFn=r,this.gcNodeUpdated=o,this.isDataStoreDeleted=a,this.aliasMap=c,this.contexts=l,this.pendingAttach=new Map,this.attachOpFiredForDataStore=new Set,this.disposeOnce=new Ve.a((()=>this.contexts.dispose())),this.dataStoresSinceLastGC=[],this.pendingAliasMap=new Map,this.dispose=()=>this.disposeOnce.value,this.mc=Jt(Rt.create(s)),this.containerRuntimeHandle=new gi(this.runtime,"/",this.runtime.IFluidHandleContext),this.throwOnTombstoneLoad=!0===this.mc.config.getBoolean($n)&&this.runtime.gcTombstoneEnforcementAllowed&&this.runtime.clientDetails.type!==oi;const d=new Map;if(e)for(const[t,n]of Object.entries(e.trees))d.set(t,n);let u=0;for(const[e,t]of d){let n;if(t.unreferenced&&u++,this.runtime.attachState!==et.Detached)n=new xi({id:e,snapshotTree:t,runtime:this.runtime,storage:this.runtime.storage,scope:this.runtime.scope,createSummarizerNodeFn:this.getCreateChildSummarizerNodeFn(e,{type:dn.CreateSummarizerNodeSource.FromSummary})});else{if("object"!=typeof t)throw new Pt("Snapshot should be there to load from!!");const i=t;n=new Ri({id:e,pkg:void 0,runtime:this.runtime,storage:this.runtime.storage,scope:this.runtime.scope,createSummarizerNodeFn:this.getCreateChildSummarizerNodeFn(e,{type:dn.CreateSummarizerNodeSource.FromSummary}),makeLocallyVisibleFn:()=>this.makeDataStoreLocallyVisible(e),snapshotTree:i,isRootDataStore:void 0})}this.contexts.addBoundOrRemoted(n)}this.containerLoadStats={containerLoadDataStoreCount:d.size,referencedDataStoreCount:d.size-u}}get aliases(){return this.aliasMap}get pendingAliases(){return this.pendingAliasMap}async waitIfPendingAliasrocessAttachMessage(e,t){var n,i;const r=e.contents;if(this.dataStoresSinceLastGC.push(r.id),t)return Object(he.a)(this.pendingAttach.has(r.id),350),null===(n=this.contexts.get(r.id))||void 0===n||n.emit("attached"),void this.pendingAttach.delete(r.id);if(this.alreadyProcessed(r.id))throw new on("Duplicate DataStore created with existing id",Object.assign(Object.assign({},cn(e)),{dataStoreId:{value:r.id,tag:Dt.CodeArtifact}}));const s=new Map;let o;r.snapshot&&(o=vi(r.snapshot.entries,s));const a=[r.type],c=new xi({id:r.id,snapshotTree:o,runtime:this.runtime,storage:new qi(this.runtime.storage,s),scope:this.runtime.scope,createSummarizerNodeFn:this.getCreateChildSummarizerNodeFn(r.id,{type:dn.CreateSummarizerNodeSource.FromAttach,sequenceNumber:e.sequenceNumber,snapshot:null!==(i=r.snapshot)&&void 0!==i?i:{entries:[Mi(a,!0)]}}),pkg:a});this.contexts.addBoundOrRemoted(c)}processAliasMessage(e,t,n){const i=e.contents;if(!zi(i))throw new on("malformedDataStoreAliasMessage",Object.assign({},cn(e)));const r=t,s=this.processAliasMessageCore(i);n&&r(s)}processAliasMessageCore(e){if(this.alreadyProcessed(e.alias))return!1;const t=this.contexts.get(e.internalId);if(void 0===t)return this.mc.logger.sendErrorEvent({eventName:"AliasFluidDataStoreNotFound",fluidDataStoreId:e.internalId}),!1;const n=new gi(t,e.internalId,this.runtime.IFluidHandleContext);return this.runtime.addedGCOutboundReference(this.containerRuntimeHandle,n),this.aliasMap.set(e.alias,t.id),t.setInMemoryRoot(),!0}alreadyProcessed(e){return void 0!==this.aliasMap.get(e)||void 0!==this.contexts.get(e)}makeDataStoreLocallyVisible(e){const t=this.contexts.getUnbound(e);if(Object(he.a)(!!t,351),this.runtime.attachState!==et.Detached){t.emit("attaching");const n=t.generateAttachMessage();this.pendingAttach.set(e,n),this.submitAttachFn(n),this.attachOpFiredForDataStore.add(e)}this.contexts.bind(e)}createDetachedDataStoreCore(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Object(ge.a)();Object(he.a)(!n.includes("/"),780);const i=new Fi({id:n,pkg:e,runtime:this.runtime,storage:this.runtime.storage,scope:this.runtime.scope,createSummarizerNodeFn:this.getCreateChildSummarizerNodeFn(n,{type:dn.CreateSummarizerNodeSource.Local}),makeLocallyVisibleFn:()=>this.makeDataStoreLocallyVisible(n),snapshotTree:void 0,isRootDataStore:t});return this.contexts.addUnbound(i),i}_createFluidDataStoreContext(e,t,n){Object(he.a)(!t.includes("/"),781);const i=new Ri({id:t,pkg:e,runtime:this.runtime,storage:this.runtime.storage,scope:this.runtime.scope,createSummarizerNodeFn:this.getCreateChildSummarizerNodeFn(t,{type:dn.CreateSummarizerNodeSource.Local}),makeLocallyVisibleFn:()=>this.makeDataStoreLocallyVisible(t),snapshotTree:void 0,isRootDataStore:!1,createProps:n});return this.contexts.addUnbound(i),i}get disposed(){return this.disposeOnce.evaluated}resubmitDataStoreOp(e,t){const n=this.contexts.get(e.address);Object(he.a)(!!n,352),n.reSubmit(e.contents,t)}rollbackDataStoreOp(e,t){const n=this.contexts.get(e.address);Object(he.a)(!!n,744),n.rollback(e.contents,t)}async applyStashedOp(e){const t=this.contexts.get(e.address);return Object(he.a)(!!t,353),t.applyStashedOp(e.contents)}async applyStashedAttachOp(e){this.pendingAttach.set(e.id,e),this.processAttachMessage({contents:e},!1)}processFluidDataStoreOp(e,t,n){const i=e.contents,r=Object.assign(Object.assign({},e),{contents:i.contents});this.validateNotDeleted(i.address,{url:i.address});const s=this.contexts.get(i.address);Object(he.a)(!!s,354),s.process(r,t,n),this.gcNodeUpdated(`/${i.address}`,e.timestamp,s.isLoaded?s.packagePath:void 0)}async getDataStore(e,t){const n=Object.assign(Object.assign({},hs),t),i={url:e};this.validateNotDeleted(e,i,n);const r=await this.contexts.getBoundOrRemoted(e,n.wait);if(void 0===r)throw mn(fn(i));return this.validateNotTombstoned(r,i,t),r}validateNotDeleted(e,t,n){if(this.isDataStoreDeleted(`/${e}`)){Object(he.a)(!this.contexts.has(e),1392);const i=mn(vn(404,"DataStore was deleted",t));throw ii(this.mc,{eventName:"GC_Deleted_DataStore_Requested",category:"error",isSummarizerClient:this.runtime.clientDetails.type===oi,headers:JSON.stringify(n),gcTombstoneEnforcementAllowed:this.runtime.gcTombstoneEnforcementAllowed},void 0,i),i}}validateNotTombstoned(e,t,n){if(e.tombstoned){const i=this.throwOnTombstoneLoad&&!n.allowTombstone,r=mn(vn(404,"DataStore was deleted",t,{[us]:!0}));if(ii(this.mc,{eventName:"GC_Tombstone_DataStore_Requested",category:i?"error":"generic",isSummarizerClient:this.runtime.clientDetails.type===oi,headers:JSON.stringify(n),gcTombstoneEnforcementAllowed:this.runtime.gcTombstoneEnforcementAllowed},e.isLoaded?e.packagePath:void 0,r),i)throw r}}processSignal(e,t,n){this.validateNotDeleted(e,{url:e});const i=this.contexts.get(e);if(!i)return Object(he.a)(!n,355),void this.mc.logger.sendTelemetryEvent({eventName:"SignalFluidDataStoreNotFound",fluidDataStoreId:{value:e,tag:Dt.CodeArtifact}});i.processSignal(t,n)}setConnectionState(e,t){for(const[n,i]of this.contexts)try{i.setConnectionState(e,t)}catch(i){this.mc.logger.sendErrorEvent({eventName:"SetConnectionStateError",clientId:t,fluidDataStore:n,details:JSON.stringify({runtimeConnected:this.runtime.connected,connected:e})},i)}}setAttachState(e){const t=e===et.Attaching?"attaching":"attached";for(const[,e]of this.contexts)this.contexts.isNotBound(e.id)||e.emit(t)}get size(){return this.contexts.size}async summarize(e,t,n){const i=new En;return await Promise.all(Array.from(this.contexts).filter((e=>{let[t,n]=e;return Object(he.a)(n.attachState!==et.Attaching,1416),n.attachState===et.Attached})).map((async r=>{let[s,o]=r;const a=await o.summarize(e,t,n);i.addWithStats(s,a)}))),i.getSummaryTree()}createSummary(e){const t=new En;let n;do{const e=t.summary.tree;n=this.contexts.notBoundLength(),Array.from(this.contexts).filter((t=>{let[n,i]=t;return!(this.contexts.isNotBound(n)||e[n]||this.attachOpFiredForDataStore.has(n))})).map((e=>{let n,[i,r]=e;r.isLoaded?n=jn(r.generateAttachMessage().snapshot,!0):(Object(he.a)(!!this.baseSnapshot,358),n=Pn(this.baseSnapshot.trees[i])),t.addWithStats(i,n)}))}while(n!==this.contexts.notBoundLength());return t.getSummaryTree()}async updateStateBeforeGC(){for(const e of this.dataStoresSinceLastGC){const t=this.contexts.get(e);if(Object(he.a)(void 0!==t,694),await t.isRoot()){const n=new gi(t,e,this.runtime.IFluidHandleContext);this.runtime.addedGCOutboundReference(this.containerRuntimeHandle,n)}}this.dataStoresSinceLastGC=[]}async getGCData(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t=new An;return await Promise.all(Array.from(this.contexts).filter((e=>{let[t,n]=e;return Object(he.a)(n.attachState!==et.Attaching,1417),n.attachState===et.Attached})).map((async n=>{let[i,r]=n;const s=await r.getGCData(e);t.prefixAndAddNodes(i,s.gcNodes)}))),t.addNode("/",await this.getOutboundRoutes()),t.getGCData()}updateUsedRoutes(e){var t;const n=pi(e);for(const[e]of n)Object(he.a)(this.contexts.has(e),359);for(const[e,i]of this.contexts)i.updateUsedRoutes(null!==(t=n.get(e))&&void 0!==t?t:[])}updateUnusedRoutes(e){for(const t of e){const e=t.split("/");if(e.length>2)continue;const n=e[1];Object(he.a)(this.contexts.has(n),727),this.contexts.delete(n),this.deleteChildSummarizerNodeFn(n)}}deleteSweepReadyNodes(e){if(!0!==this.mc.config.getBoolean("Fluid.GarbageCollection.Test.SweepDataStores"))return[];for(const t of e){const e=t.split("/"),n=e[1];if(e.length>2)continue;this.contexts.has(n)||this.mc.logger.sendErrorEvent({eventName:"DeletedDataStoreNotFound",dataStoreId:n});const i=this.contexts.get(n);Object(he.a)(void 0!==i,1393),i.delete(),this.contexts.delete(n),this.deleteChildSummarizerNodeFn(n)}return Array.from(e)}updateTombstonedRoutes(e){const t=new Set;for(const n of e){const e=n.split("/");if(e.length>2)continue;const i=e[1];Object(he.a)(this.contexts.has(i),1296),t.add(i)}for(const[e,n]of this.contexts)n.setTombstone(t.has(e))}async getOutboundRoutes(){const e=[];for(const[t,n]of this.contexts)await n.isRoot()&&e.push(`/${t}`);return e}async getDataStorePackagePath(e){var t;const n=this.contexts.get(e.split("/")[1]);return null===(t=await(null==n?void 0:n.getInitialSnapshotDetails()))||void 0===t?void 0:t.pkg}getGCNodeType(e){const t=e.split("/");if(this.contexts.has(t[1]))return 2===t.length?Wn:Jn}}function Gi(e){var t;return e&&null!==(t=e.gcFeature)&&void 0!==t?t:0}function $i(e){const t=Object.entries(e.gcNodes);t.sort(();const n={gcNodes:{}};for(const[e,i]of t)i.outboundRoutes.sort(),n.gcNodes[e]=i;return n}function Ki(e,t){var n;const i={};for(const[t,n]of Object.entries(e.gcNodes))i[t]={outboundRoutes:Array.from(n.outboundRoutes),unreferencedTimestampMs:n.unreferencedTimestampMs};for(const[e,r]of Object.entries(t.gcNodes)){let t=i[e];void 0===t?t={outboundRoutes:Array.from(r.outboundRoutes),unreferencedTimestampMs:r.unreferencedTimestampMs}:(void 0!==r.unreferencedTimestampMs&&void 0!==t.unreferencedTimestampMs&&Object(he.a)(r.unreferencedTimestampMs===t.unreferencedTimestampMs,1495),t={outboundRoutes:[...new Set([...r.outboundRoutes,...t.outboundRoutes])],unreferencedTimestampMs:null!==(n=r.unreferencedTimestampMs)&&void 0!==n?n:t.unreferencedTimestampMs}),i[e]=t}return{gcNodes:i}}function Wi(e){const t={};for(const[n,i]of Object.entries(e.gcNodes))t[n]=Array.from(i);return{gcNodes:t}}async function Ji(e,t){let n,i,r={gcNodes:{}};for(const s of Object.keys(e.blobs)){if(s===dn.gcDeletedBlobKey){i=await t(e.blobs[s]);continue}if(s===dn.gcTombstoneBlobKey){n=await t(e.blobs[s]);continue}if(!s.startsWith(dn.gcBlobPrefix))continue;const o=e.blobs[s];if(void 0===o)continue;const a=await t(o);Object(he.a)(void 0!==a,1496),r=Ki(r,a)}return{gcState:r,tombstones:n,deletedNodes:i}}function Qi(e){const t=new Map;if(void 0===e.gcData)return t;const n=e.gcData.gcNodes;for(const[e,i]of Object.entries(n)){if("/"===e)continue;Object(he.a)(e.startsWith("/"),1497);const n=e.split("/")[1];let r=e.slice(n.length+1);""===r&&(r="/");let s=t.get(n);void 0===s&&(s={gcData:{gcNodes:{}},usedRoutes:[]}),Object(he.a)(void 0!==s.gcData,1498),s.gcData.gcNodes[r]=[...new Set(i)],t.set(n,s)}if(void 0===e.usedRoutes)return t;const i=e.usedRoutes.filter((e=>""!==e&&"/"!==e));for(const e of i){Object(he.a)(e.startsWith("/"),1499);const n=e.split("/")[1],i=e.slice(n.length+1),r=t.get(n);Object(he.a)(void 0!==(null==r?void 0:r.usedRoutes),1500),r.usedRoutes.push(i),t.set(n,r)}return t}function Xi(e,t){const n=new Set,i=[...t];for(const t of i){if(n.has(t))continue;n.add(t);const r=e[t];void 0!==r&&i.push(...r)}const r=[],s=[];for(const t of Object.keys(e))n.has(t)?r.push(t):s.push(t);return{referencedNodeIds:r,deletedNodeIds:s}}class Zi{constructor(e){this.path=e}tatic createAndConcat(e){var t;let n=Zi.create(null!==(t=e[0])&&void 0!==t?t:"");for(let t=1;t<e.length;t++)n=n.concat(Zi.create(e[t]));return n}toString(){return this.path}concat(e){return new Zi(`${this.path}/${e.path}`)}}class Yi{constructor(e){this.summary=e}static createForRoot(e){return new Yi({referenceSequenceNumber:e,basePath:void 0,localPath:Zi.create("")})}get referenceSequenceNumber(){return this.summary.referenceSequenceNumber}get basePath(){return this.summary.basePath}get localPath(){return this.summary.localPath}get additionalPath(){return this.summary.additionalPath}et fullPath(){var e,t;return null!==(t=null===(e=this.basePath)||void 0===e?void 0:e.concat(this.localPath))&&void 0!==t?t:this.localPath}get fullPathForChildren(){return void 0!==this.additionalPath?this.fullPath.concat(this.additionalPath):this.fullPath}createForChild(e){return new Yi({referenceSequenceNumber:this.referenceSequenceNumber,basePath:this.fullPathForChildren,localPath:Zi.create(e)})}}function er(e){const t=e.trees[dn.channelsTreeName];return void 0!==t?{childrenTree:t,childrenPathPart:dn.channelsTreeName}:{childrenTree:e,childrenPathPart:void 0}}class tr{constructor(e,t,n,i,r,s,o,a){var c;this.summarizeInternalFn=t,this._changeSequenceNumber=i,this._latestSummary=r,this.initialSummary=s,this.wipSummaryLogger=o,this.telemetryNodeId=a,this.children=new Map,this.pendingSummaries=new Map,this.wipSkipRecursion=!1,this.canReuseHandle=null===(c=n.canReuseHandle)||void 0===c||c,this.logger=Rt.create(e,void 0,{all:{id:{tag:Dt.CodeArtifact,value:this.telemetryNodeId}}})}get referenceSequenceNumber(){var e,t;return null!==(t=null===(e=this._latestSummary)||void 0===e?void 0:e.referenceSequenceNumber)&&void 0!==t?t:0}startSummary(e,t){Object(he.a)(void 0===this.wipSummaryLogger,415),Object(he.a)(void 0===this.wipReferenceSequenceNumber,416),this.wipSummaryLogger=t;for(const t of this.children.values())t.startSummary(e,this.wipSummaryLogger);this.wipReferenceSequenceNumber=e}async summarize(e){let t=arguments.length>2?arguments[2]:void 0;if(Object(he.a)(this.isSummaryInProgress(),417),Object(he.a)(void 0!==this.wipSummaryLogger,418),this.canReuseHandle&&!e&&!this.hasChanged()){const e=this._latestSummary;if(void 0!==e){this.wipLocalPaths={localPath:e.localPath,additionalPath:e.additionalPath},this.wipSkipRecursion=!0;const t=wn();return t.handleNodeCount++,{summary:{type:ln.a.Handle,handle:e.fullPath.path,handleType:ln.a.Tree},stats:t}}}Object(he.a)(void 0!==this.wipReferenceSequenceNumber,1503);const n=void 0!==this._latestSummary?{summarySequenceNumber:this.wipReferenceSequenceNumber,latestSummarySequenceNumber:this._latestSummary.referenceSequenceNumber,summaryPath:this._latestSummary.fullPath.path}:void 0,i=await this.summarizeInternalFn(e,!0,t,n);return this.wipLocalPaths={localPath:Zi.create(i.id)},void 0!==i.pathPartsForChildren&&(this.wipLocalPaths.additionalPath=Zi.createAndConcat(i.pathPartsForChildren)),{summary:i.summary,stats:i.stats}}ompleteSummaryCore(e,t,n){Object(he.a)(void 0!==this.wipSummaryLogger,419),Object(he.a)(void 0!==this.wipReferenceSequenceNumber,420);let i=this.wipLocalPaths;if(n){const e=this._latestSummary;if(void 0===e)return void this.clearSummary();i={localPath:e.localPath,additionalPath:e.additionalPath}}void 0===i&&this.throwUnexpectedError({eventName:"NodeNotSummarized",proposalHandle:e});const r=new Yi(Object.assign(Object.assign({},i),{referenceSequenceNumber:this.wipReferenceSequenceNumber,basePath:t})),s=r.fullPathForChildren;for(const t of this.children.values())t.completeSummaryCore(e,s,this.wipSkipRecursion||n);this.pendingSummaries.set(e,r),this.clearSummary()}clearSummary(){this.wipReferenceSequenceNumber=void 0,this.wipLocalPaths=void 0,this.wipSkipRecursion=!1,this.wipSummaryLogger=void 0;for(const e of this.children.values())e.clearSummary()}async refreshLatestSummary(e,t,n,i,r){const s={proposalHandle:e,summaryRefSeq:t,referenceSequenceNumber:this.referenceSequenceNumber};return Ft.timedExecAsync(this.logger,Object.assign({eventName:"refreshLatestSummary"},s),(async o=>{var a;if(this.isSummaryInProgress())throw new Pt("UnexpectedRefreshDuringSummarize",{inProgressSummaryRefSeq:this.wipReferenceSequenceNumber});if(void 0!==e){const n=this.pendingSummaries.get(e);if(void 0!==n)return this.refreshLatestSummaryFromPending(e,n.referenceSequenceNumber),s.wasSummaryTracked=!0,s.latestSummaryUpdated=!0,o.end(s),{latestSummaryUpdated:!0,wasSummaryTracked:!0,summaryRefSeq:t};const i={summaryRefSeq:t,pendingSize:null!==(a=this.pendingSummaries.size)&&void 0!==a?a:void 0};this.logger.sendTelemetryEvent({eventName:"PendingSummaryNotFound",proposalHandle:e,referenceSequenceNumber:this.referenceSequenceNumber,details:JSON.stringify(i)})}if(this.referenceSequenceNumber>=t)return s.latestSummaryUpdated=!1,o.end(s),{latestSummaryUpdated:!1};const{snapshotTree:c,snapshotRefSeq:l}=await n();return this.referenceSequenceNumber>=l?(s.latestSummaryUpdated=!1,o.end(s),{latestSummaryUpdated:!1}):(await this.refreshLatestSummaryFromSnapshot(l,c,void 0,Zi.create(""),r,i),s.latestSummaryUpdated=!0,s.wasSummaryTracked=!1,s.summaryRefSeq=l,o.end(s),{latestSummaryUpdated:!0,wasSummaryTracked:!1,snapshotTree:c,summaryRefSeq:l})}),{start:!0,end:!0,cancel:"error"})}refreshLatestSummaryFromPending(e,t){const n=this.pendingSummaries.get(e);if(void 0!==n){Object(he.a)(t===n.referenceSequenceNumber,423),this.pendingSummaries.delete(e),this.refreshLatestSummaryCore(t),this._latestSummary=n;for(const n of this.children.values())n.refreshLatestSummaryFromPending(e,t)}else Object(he.a)(void 0===this._latestSummary,422)}async refreshLatestSummaryFromSnapshot(e,t,n,i,r,s){if(this.referenceSequenceNumber>=e)return;this.refreshLatestSummaryCore(e),this._latestSummary=new Yi({referenceSequenceNumber:e,basePath:n,localPath:i});const o=[],{childrenTree:a,childrenPathPart:c}=er(t);void 0!==c&&o.push(c),o.length>0&&(this._latestSummary.additionalPath=Zi.createAndConcat(o));const l=this._latestSummary.fullPathForChildren;await Promise.all(Array.from(this.children).filter((e=>{let[t]=e;return void 0!==a.trees[t]})).map((async t=>{let[n,i]=t;return i.refreshLatestSummaryFromSnapshot(e,a.trees[n],l,Zi.create(n),r,s)})))}refreshLatestSummaryCore(e){for(const[t,n]of this.pendingSummaries)n.referenceSequenceNumber<e&&this.pendingSummaries.delete(t)}updateBaseSummaryState(e){const{childrenPathPart:t}=er(e);void 0!==t&&void 0!==this._latestSummary&&(this._latestSummary.additionalPath=Zi.create(t))} latestSummary(){return this._latestSummary}createChild(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};Object(he.a)(!this.children.has(t),427);const r=this.getCreateDetailsForChild(t,n),s=new tr(this.logger,e,i,r.changeSequenceNumber,r.latestSummary,r.initialSummary,this.wipSummaryLogger,r.telemetryNodeId);return this.maybeUpdateChildState(s,t),this.children.set(t,s),s}getChild(e){return this.children.get(e)}getCreateDetailsForChild(e,t){var n,i;let r,s,o;const a=this._latestSummary;switch(t.type){case dn.CreateSummarizerNodeSource.FromAttach:if(void 0!==a&&t.sequenceNumber<=a.referenceSequenceNumber)s=a.createForChild(e);else{const n=jn(t.snapshot);r={sequenceNumber:t.sequenceNumber,id:e,summary:n}}o=t.sequenceNumber;break;case dn.CreateSummarizerNodeSource.FromSummary:void 0===this.initialSummary&&Object(he.a)(!!a,428);case dn.CreateSummarizerNodeSource.Local:{const i=this.initialSummary;if(void 0!==i){let n,s;if(void 0!==i.summary){const{childrenTree:t}=function(e){const t=e.tree[dn.channelsTreeName];return void 0!==t?{childrenTree:t,childrenPathPart:dn.channelsTreeName}:{childrenTree:e,childrenPathPart:void 0}}(i.summary.summary);Object(he.a)(t.type===ln.a.Tree,470),n=t.tree[e]}t.type===dn.CreateSummarizerNodeSource.FromSummary&&Object(he.a)(!!n,429),void 0!==n&&(Object(he.a)(n.type===ln.a.Tree,430),s={summary:n,stats:Nn(n)}),r={sequenceNumber:i.sequenceNumber,id:e,summary:s}}s=null==a?void 0:a.createForChild(e),o=null!==(n=null==a?void 0:a.referenceSequenceNumber)&&void 0!==n?n:-1;break}default:{const e=t.type;Object(dt.a)(t,`Unexpected CreateSummarizerNodeSource: ${e}`)}}return{initialSummary:r,latestSummary:s,changeSequenceNumber:o,telemetryNodeId:`${null!==(i=this.telemetryNodeId)&&void 0!==i?i:""}/${e}`}}maybeUpdateChildState(e,t){if(this.isSummaryInProgress()&&(e.wipReferenceSequenceNumber=this.wipReferenceSequenceNumber),void 0!==e._latestSummary)for(const[t,n]of this.pendingSummaries.entries()){const i=new Yi({referenceSequenceNumber:n.referenceSequenceNumber,basePath:e._latestSummary.basePath,localPath:e._latestSummary.localPath});e.addPendingSummary(t,i)}}addPendingSummary(e,t){this.pendingSummaries.set(e,t)}isSummaryInProgress(){return void 0!==this.wipReferenceSequenceNumber}throwUnexpectedError(e){const t=new Pt(e.eventName,Object.assign(Object.assign({},e),{referenceSequenceNumber:this.wipReferenceSequenceNumber,id:{tag:Dt.CodeArtifact,value:this.telemetryNodeId}}));throw this.logger.sendErrorEvent(e,t),t}}lass ir extends tr{constructor(e,t,n,i,r,s,o,a,c,l){super(e,(async(e,n,i,r)=>t(e,!0,i,r)),n,i,r,s,o,l),this.summarizeFn=t,this.getGCDataFn=a,this.baseGCDetailsLoaded=!1,this.usedRoutes=[""],this.gcDisabled=!0===n.gcDisabled,this.baseGCDetailsP=new lt.b((async()=>{var e;return null!==(e=await(null==c?void 0:c()))&&void 0!==e?e:{usedRoutes:[]}})),this.childNodesBaseGCDetailsP=new lt.b((async()=>(await this.loadBaseGCDetails(),Qi({gcData:this.gcData,usedRoutes:this.usedRoutes}))))}async loadBaseGCDetails(){if(this.baseGCDetailsLoaded)return;const e=await this.baseGCDetailsP;this.baseGCDetailsLoaded||(this.baseGCDetailsLoaded=!0,void 0!==e.gcData&&(this.gcData=Wi(e.gcData)),void 0!==e.usedRoutes&&(this.usedRoutes=Array.from(e.usedRoutes).sort(),this.referenceUsedRoutes=Array.from(e.usedRoutes).sort()))}async summarize(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2?arguments[2]:void 0;return!this.gcDisabled&&this.isSummaryInProgress()&&Object(he.a)(void 0!==this.wipSerializedUsedRoutes,433),t?super.summarize(e,!0,n):this.summarizeFn(e,t,n)}async getGCData(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(Object(he.a)(!this.gcDisabled,434),Object(he.a)(void 0!==this.getGCDataFn,435),await this.loadBaseGCDetails(),this.canReuseHandle&&!e&&!this.hasDataChanged()&&void 0!==this.gcData)return Wi(this.gcData);const t=await this.getGCDataFn(e);return this.gcData=Wi(t),t}startSummary(e,t){this.gcDisabled||Object(he.a)(void 0===this.wipSerializedUsedRoutes,436),super.startSummary(e,t)}completeSummaryCore(e,t,n){let i;if(this.gcDisabled||(i=this.wipSerializedUsedRoutes,void 0===i&&this.throwUnexpectedError({eventName:"NodeDidNotRunGC",proposalHandle:e})),super.completeSummaryCore(e,t,n),!this.gcDisabled){const t=this.pendingSummaries.get(e);if(void 0!==t){const n=new nr(i,t);this.pendingSummaries.set(e,n)}}}efreshLatestSummaryFromPending(e,t){if(!this.gcDisabled){const n=this.pendingSummaries.get(e);if(void 0!==n){const i=n;if(void 0===i.serializedUsedRoutes){const n=new Pt("MissingGCStateInPendingSummary",{proposalHandle:e,referenceSequenceNumber:t,id:{tag:Dt.CodeArtifact,value:this.telemetryNodeId}});throw this.logger.sendErrorEvent({eventName:n.message},n),n}this.referenceUsedRoutes=JSON.parse(i.serializedUsedRoutes)}}return super.refreshLatestSummaryFromPending(e,t)}async refreshLatestSummaryFromSnapshot(e,t,n,i,r,s){return await this.refreshGCStateFromSnapshot(e,t,s),super.refreshLatestSummaryFromSnapshot(e,t,n,i,r,s)}async refreshGCStateFromSnapshot(e,t,n){if(this.gcDisabled||this.referenceSequenceNumber>=e)return;if(await this.loadBaseGCDetails(),this.referenceSequenceNumber>=e)return;let i;const r=t.trees[dn.gcTreeKey];if(void 0!==r){const e=await Ji(r,n);if(void 0!==e.gcState){const t={};for(const[n,i]of Object.entries(e.gcState.gcNodes))t[n]=Array.from(i.outboundRoutes);i={gcData:{gcNodes:t},usedRoutes:Xi(t,["/"]).referencedNodeIds}}}else{const e=t.blobs[dn.gcTreeKey];void 0!==e&&(i=JSON.parse(e))}if(this.gcData=void 0!==(null==i?void 0:i.gcData)?Wi(i.gcData):void 0,this.referenceUsedRoutes=void 0!==(null==i?void 0:i.usedRoutes)?Array.from(i.usedRoutes):void 0,this.usedRoutes=void 0!==(null==i?void 0:i.usedRoutes)?Array.from(i.usedRoutes):[""],void 0===i)return;const s=Qi(i),{childrenTree:o}=er(t);s.forEach(((e,t)=>{void 0!==o.trees[t]&&(o.trees[t].blobs[dn.gcTreeKey]=JSON.stringify(e))}))}createChild(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r=arguments.length>4?arguments[4]:void 0;var s;Object(he.a)(!this.children.has(t),438);const o=this.getCreateDetailsForChild(t,n),a=new ir(this.logger,e,Object.assign(Object.assign({},i),{gcDisabled:null!==(s=i.gcDisabled)&&void 0!==s?s:this.gcDisabled}),o.changeSequenceNumber,o.latestSummary,o.initialSummary,this.wipSummaryLogger,r,(async()=>{var e;return null!==(e=(await this.childNodesBaseGCDetailsP).get(t))&&void 0!==e?e:{}}),o.telemetryNodeId);return this.maybeUpdateChildState(a,t),this.children.set(t,a),a}maybeUpdateChildState(e,t){var n;if(super.maybeUpdateChildState(e,t),void 0!==e.latestSummary)for(const[i,r]of this.pendingSummaries.entries()){const s=r;if(void 0!==s.serializedUsedRoutes){const o=null!==(n=pi(JSON.parse(s.serializedUsedRoutes)).get(t))&&void 0!==n?n:[""],a=new nr(JSON.stringify(o),{referenceSequenceNumber:r.referenceSequenceNumber,basePath:e.latestSummary.basePath,localPath:e.latestSummary.localPath});e.addPendingSummary(i,a)}}}deleteChild(e){this.children.delete(e)}getChild(e){return this.children.get(e)}pdateUsedRoutes(e){this.usedRoutes=e.sort(),!this.gcDisabled&&this.isSummaryInProgress()&&(this.wipSerializedUsedRoutes=JSON.stringify(this.usedRoutes))}sUsedStateChanged(){return!this.gcDisabled&&(void 0===this.referenceUsedRoutes||JSON.stringify(this.usedRoutes)!==JSON.stringify(this.referenceUsedRoutes))}}!Vi||(Vi={}));class rr{constructor(e,t){this.clientId=e,this.clientSequenceNumber=t,this.state=Vi.Local,this.defSummaryOp=new lt.a,this.defSummaryAck=new lt.a}tatic createFromOp(e){const t=new rr(e.clientId,e.clientSequenceNumber);return t.broadcast(e),t}get summaryOp(){return this._summaryOp}get summaryAckNack(){return this._summaryAckNack}roadcast(e){return Object(he.a)(this.state===Vi.Local,373),this._summaryOp=e,this.defSummaryOp.resolve(),this.state=Vi.Broadcast,!0}ackNack(e){return Object(he.a)(this.state===Vi.Broadcast,374),this._summaryAckNack=e,this.defSummaryAck.resolve(),this.state=e.type===qe.a.SummaryAck?Vi.Acked:Vi.Nacked,!0}async waitBroadcast(){return await this.defSummaryOp.promise,this._summaryOp}async waitAckNack(){return await this.defSummaryAck.promise,this._summaryAckNack}}class sr{constructor(e,t){this.clientId=e,this.summaryCollection=t,this.localSummaries=new Map,this._disposed=!1}get disposed(){return this._disposed}watchSummary(e){let t=this.localSummaries.get(e);return t||(t=rr.createLocal(this.clientId,e),this.localSummaries.set(t.clientSequenceNumber,t)),t}waitFlushed(){return this.summaryCollection.waitFlushed()}tryGetSummary(e){return this.localSummaries.get(e)}isposeclass or extends me.a{constructor(e,t){super(),this.deltaManager=e,this.logger=t,this.summaryWatchers=new Map,this.pendingSummaries=new Map,this.refreshWaitNextAck=new lt.a,this.deltaManager.on("op",(e=>this.handleOp(e)))}get latestAck(){return this.lastAck}emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return super.emit(e,...n)}get opsSinceLastAck(){var e,t;return this.deltaManager.lastSequenceNumber-(null!==(t=null===(e=this.lastAck)||void 0===e?void 0:e.summaryAck.sequenceNumber)&&void 0!==t?t:this.deltaManager.initialSequenceNumber)}addOpListener(e){this.deltaManager.on("op",e)}reateWatcher(e){const t=new sr(e,this);return this.summaryWatchers.set(e,t),t}removeWatcher(e){this.summaryWatchers.delete(e)}setPendingAckTimerTimeoutCallback(e,t){this.maxAckWaitTime=e,this.pendingAckTimerTimeoutCallback=t}sync waitFlushed(){for(;this.pendingSummaries.size>0;){const e=Array.from(this.pendingSummaries,();await Promise.all(e)}return this.lastAck}async waitSummaryAck(e){for(;!this.lastAck||this.lastAck.summaryOp.referenceSequenceNumber<e;)await this.refreshWaitNextAck.promise;return this.lastAck}parseContentandleOp(e){var t;const n=Object.assign({},e);switch(n.type){case qe.a.Summarize:return this.parseContent(n),this.handleSummaryOp(n);case qe.a.SummaryAck:case qe.a.SummaryNack:return void 0!==n.data?n.contents=JSON.parse(n.data):this.parseContent(n),n.type===qe.a.SummaryAck?this.handleSummaryAck(n):this.handleSummaryNack(n);default:{const e=n.timestamp;return void 0!==this.lastSummaryTimestamp&&void 0!==this.maxAckWaitTime&&e-this.lastSummaryTimestamp>=this.maxAckWaitTime&&(null===(t=this.pendingAckTimerTimeoutCallback)||void 0===t||t.call(this)),void this.emit("default",n)}}}handleSummaryOp(e){let t;const n=this.summaryWatchers.get(e.clientId);n&&(t=n.tryGetSummary(e.clientSequenceNumber),t&&t.broadcast(e)),t||(t=rr.createFromOp(e),n&&n.setSummary(t)),this.pendingSummaries.set(e.sequenceNumber,t),this.lastSummaryTimestamp=e.timestamp,this.emit(qe.a.Summarize,e)}handleSummaryAck(e){const t=e.contents.summaryProposal.summarySequenceNumber,n=this.pendingSummaries.get(t);n&&void 0!==n.summaryOp?(n.ackNack(e),this.pendingSummaries.delete(t),(!this.lastAck||t>this.lastAck.summaryAck.contents.summaryProposal.summarySequenceNumber)&&(this.lastAck={summaryOp:n.summaryOp,summaryAck:e},this.refreshWaitNextAck.resolve(),this.refreshWaitNextAck=new lt.a,this.emit(qe.a.SummaryAck,e))):t>this.deltaManager.initialSequenceNumber&&this.logger.sendTelemetryEvent({eventName:"SummaryAckWithoutOp",sequenceNumber:e.sequenceNumber,summarySequenceNumber:t,initialSequenceNumber:this.deltaManager.initialSequenceNumber})}handleSummaryNack(e){const t=e.contents.summaryProposal.summarySequenceNumber,n=this.pendingSummaries.get(t);n&&(n.ackNack(e),this.pendingSummaries.delete(t),this.emit(qe.a.SummaryNack,e))}}class ar extends me.a{constructor(e,t,n){super(),this.clientMap=new Map,this.rootNode={sequenceNumber:-1,olderClient:void 0,youngerClient:void 0},this._youngestClient=this.rootNode,this.logger=Rt.create(e,"OrderedClientCollection");const i=n.getMembers();for(const[e,t]of i)this.addClient(e,t);n.on("addMember",((e,n)=>{const i=this.addClient(e,n);this.emit("addClient",i,t.lastSequenceNumber)})),n.on("removeMember",(e=>{const n=t.lastSequenceNumber,i=this.removeClient(e);void 0===i?this.logger.sendErrorEvent({eventName:"ClientNotFound",clientId:e,sequenceNumber:n}):this.emit("removeClient",i,n)}))}get count(){return this.clientMap.size}get oldestClient(){return this.rootNode.youngerClient}addClient(e,t){Object(he.a)(t.sequenceNumber>-1,502);let n=this._youngestClient;for(;n.sequenceNumber>t.sequenceNumber;)Object(he.a)(void 0!==n.olderClient,503),n=n.olderClient;const i={clientId:e,sequenceNumber:t.sequenceNumber,client:Object.assign({},t.client),olderClient:n,youngerClient:n.youngerClient};return i.olderClient.youngerClient=i,void 0===i.youngerClient?this._youngestClient=i:i.youngerClient.olderClient=i,this.clientMap.set(e,i),i}removeClient(e){const t=this.clientMap.get(e);if(void 0!==t)return t.olderClient.youngerClient=t.youngerClient,void 0===t.youngerClient?this._youngestClient=t.olderClient:t.youngerClient.olderClient=t.olderClient,this.clientMap.delete(e),t}getAllClients(){const e=[];let t=this.rootNode;for(;void 0!==t.youngerClient;)e.push(t.youngerClient),t=t.youngerClient;return e}}class cr extends me.a{constructor(e,t,n,i){let r,s;super(),this.logger=e,this.orderedClientCollection=t,this.isEligibleFn=i,this._eligibleCount=0;for(const e of t.getAllClients())this.addClient(e,0),"number"!=typeof n&&(e.clientId===n.electedClientId&&(r=e,void 0===n.electedParentId&&e.client.details.type!==oi&&(s=e)),e.clientId===n.electedParentId&&(s=e));t.on("addClient",((e,t)=>this.addClient(e,t))),t.on("removeClient",((e,t)=>this.removeClient(e,t))),"number"==typeof n?this._electionSequenceNumber=n:((null==r?void 0:r.clientId)!==n.electedClientId?e.sendErrorEvent({eventName:"InitialElectedClientNotFound",electionSequenceNumber:n.electionSequenceNumber,expectedClientId:n.electedClientId,electedClientId:null==r?void 0:r.clientId,clientCount:t.count}):void 0===r||i(r)||(r=s=this.findFirstEligibleParent(s),e.sendErrorEvent({eventName:"InitialElectedClientIneligible",electionSequenceNumber:n.electionSequenceNumber,expectedClientId:n.electedClientId,electedClientId:null==r?void 0:r.clientId})),this._electedParent=s,this._electedClient=r,this._electionSequenceNumber=n.electionSequenceNumber)}get eligibleCount(){return this._eligibleCount}get electionSequenceNumber(){return this._electionSequenceNumber}get electedClient(){return this._electedClient}get electedParent(){return this._electedParent}tryElectingClient(e,t){var n,i;let r=!1;const s=(null==e?void 0:e.client.details.type)===oi,o=this._electedClient;this._electedClient!==e&&(this._electionSequenceNumber=t,this._electedClient=e,r=!0),this._electedParent===e||s||(this._electedParent=e,r=!0),r&&(this.logger.sendTelemetryEvent({eventName:"SummarizerClientElected",electedClientId:null===(n=this._electedClient)||void 0===n?void 0:n.clientId,electedParentId:null===(i=this._electedParent)||void 0===i?void 0:i.clientId,electionSequenceNumber:t,isSummarizerClient:s}),this.emit("election",e,t,o))}tryElectingParent(e,t){var n,i;this._electedParent!==e&&(this._electedParent=e,this.logger.sendTelemetryEvent({eventName:"SummarizerParentElected",electedClientId:null===(n=this._electedClient)||void 0===n?void 0:n.clientId,electedParentId:null===(i=this._electedParent)||void 0===i?void 0:i.clientId,electionSequenceNumber:t}),this.emit("election",this._electedClient,t,this._electedClient))}findFirstEligibleParent(e){let t=e;for(;void 0!==t&&(!this.isEligibleFn(t)||t.client.details.type===oi);)t=t.youngerClient;return t}addClient(e,t){var n;if(this.isEligibleFn(e)){this._eligibleCount++;const i=e.client.details.type===oi,r=(null===(n=this._electedClient)||void 0===n?void 0:n.client.details.type)===oi;void 0===this._electedClient||!r&&i?this.tryElectingClient(e,t):void 0!==this._electedParent||i||this.tryElectingParent(e,t)}}removeClient(e,t){var n,i,r,s,o;if(this.isEligibleFn(e))if(this._eligibleCount--,this._electedClient===e)if(this._electedParent!==e){if(this._electedClient.client.details.type!==oi)throw new rn("Elected client should be a summarizer client 1");this.tryElectingClient(this._electedParent,t)}else{const e=null!==(i=this.findFirstEligibleParent(null===(n=this._electedParent)||void 0===n?void 0:n.youngerClient))&&void 0!==i?i:this.findFirstEligibleParent(this.orderedClientCollection.oldestClient);this.tryElectingClient(e,t)}else if(this._electedParent===e){if((null===(r=this._electedClient)||void 0===r?void 0:r.client.details.type)!==oi)throw new rn("Elected client should be a summarizer client 2");const e=null!==(o=this.findFirstEligibleParent(null===(s=this._electedParent)||void 0===s?void 0:s.youngerClient))&&void 0!==o?o:this.findFirstEligibleParent(this.orderedClientCollection.oldestClient);this.tryElectingParent(e,t)}}ncrementElectedClient(e){var t,n;const i=null!==(n=this.findFirstEligibleParent(null===(t=this._electedParent)||void 0===t?void 0:t.youngerClient))&&void 0!==n?n:this.findFirstEligibleParent(this.orderedClientCollection.oldestClient);void 0===this._electedClient||this._electedClient===this._electedParent?this.tryElectingClient(i,e):this.tryElectingParent(i,e)}resetElectedClient(e){const t=this.findFirstEligibleParent(this.orderedClientCollection.oldestClient);void 0===this._electedClient||this._electedClient===this._electedParent?this.tryElectingClient(t,e):this.tryElectingParent(t,e)}peekNextElectedClient(){var e,t;return null!==(t=this.findFirstEligibleParent(null===(e=this._electedParent)||void 0===e?void 0:e.youngerClient))&&void 0!==t?t:this.findFirstEligibleParent(this.orderedClientCollection.oldestClient)}serialize(){var e,t;return{electionSequenceNumber:this.electionSequenceNumber,electedClientId:null===(e=this.electedClient)||void 0===e?void 0:e.clientId,electedParentId:null===(t=this.electedParent)||void 0===t?void 0:t.clientId}}}var lr,dr=n("hBZP"),ur=n("XxIN");!lr||(lr={}));var hr=n("3mBU");class mr{constructor(e,t){this.lastOpSequenceNumber=e,this.hasMissingOpData=!1,this.totalOpsSize=0,this.totalOpsSizeBefore=0,this.numNonRuntimeOps=0,this.numNonRuntimeOpsBefore=0,this.numRuntimeOps=0,this.numRuntimeOpsBefore=0,this._lastAttempt=t,this._lastSuccessfulSummary=Object.assign({},t)}get lastAttempt(){return this._lastAttempt}get lastSuccessfulSummary(){return this._lastSuccessfulSummary}get opsSinceLastSummary(){return this.numNonRuntimeOpsBefore+this.numRuntimeOpsBefore}updateWithLastSummaryAckInfo(e){this._lastAttempt=e,this._lastSuccessfulSummary=Object.assign({},e)}recordAttempt(e){this._lastAttempt={refSequenceNumber:null!=e?e:this.lastOpSequenceNumber,summaryTime:Date.now()},this.numNonRuntimeOpsBefore=this.numNonRuntimeOps,this.numRuntimeOpsBefore=this.numRuntimeOps,this.totalOpsSizeBefore=this.totalOpsSize}markLastAttemptAsSuccessful(){this._lastSuccessfulSummary=Object.assign({},this.lastAttempt),this.numNonRuntimeOps-=this.numNonRuntimeOpsBefore,this.numNonRuntimeOpsBefore=0,this.numRuntimeOps-=this.numRuntimeOpsBefore,this.numRuntimeOpsBefore=0,this.totalOpsSize-=this.totalOpsSizeBefore,this.totalOpsSizeBefore=0}}class gr{constructor(e,t,n,i){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:);this.heuristicData=e,this.configuration=t,this.logger=i,this.summarizeStrategies=r,this.idleTimer=new ur.b(this.idleTime,(),this.runSummarize=e=>{var t;null===(t=this.idleTimer)||void 0===t||t.clear(),this.opsSinceLastAck>0&&n(e)}}get idleTime(){const e=this.configuration.maxIdleTime,t=this.configuration.minIdleTime,n=1*fr(this.heuristicData.numRuntimeOps,this.heuristicData.numNonRuntimeOps,this.configuration.runtimeOpWeight,this.configuration.nonRuntimeOpWeight)/this.configuration.maxOps;return n>=1?t:e-(e-t)*n}get opsSinceLastAck(){return this.heuristicData.lastOpSequenceNumber-this.heuristicData.lastSuccessfulSummary.refSequenceNumber}un(){var e;for(const e of this.summarizeStrategies)if(e.shouldRunSummary(this.configuration,this.heuristicData))return this.runSummarize(e.summarizeReason);null===(e=this.idleTimer)||void 0===e||e.restart(this.idleTime)}shouldRunLastSummary(){const e=fr(this.heuristicData.numRuntimeOps,this.heuristicData.numNonRuntimeOps,this.configuration.runtimeOpWeight,this.configuration.nonRuntimeOpWeight),t=this.configuration.minOpsForLastSummaryAttempt;return this.logger.sendTelemetryEvent({eventName:"ShouldRunLastSummary",weightedOpsSinceLastAck:e,minOpsForLastSummaryAttempt:t}),e>=t}class pr{constructor(){this.summarizeReason="maxTime"}shouldRunSummary(e,t){return Date.now()-t.lastSuccessfulSummary.summaryTime>e.maxTime}}function fr(e,t,n,i){return n*e+i*t}class vr{houldRunSummary(e,t){return fr(t.numRuntimeOps,t.numNonRuntimeOps,e.runtimeOpWeight,e.nonRuntimeOpWeight)>e.maxOps}}var yr=n("1bkS");async function br(e,t,n){const i=[e.then((),t.then(()];return void 0!==n&&i.push(n.waitCancelled.then(()),Promise.race(i)}const Sr={submitSummaryFailure:"Error while generating, uploading, or submitting summary",summaryOpWaitTimeout:"Timeout while waiting for summarize op broadcast",summaryAckWaitTimeout:"Timeout while waiting for summaryAck/summaryNack op",summaryNack:"Server rejected summary via summaryNack op",disconnect:"Summary cancelled due to summarizer or main client disconnect"};class Cr{ail(e,t,n,i){Object(he.a)(!this.receivedSummaryAckOrNack.isCompleted,606);const r={success:!1,message:e,data:void 0,error:t,retryAfterSeconds:i};this.summarySubmitted.resolve(r),this.summaryOpBroadcasted.resolve(r),this.receivedSummaryAckOrNack.resolve(Object.assign(Object.assign({},r),{data:n}))}class wr{constructor(e,t,n,i,r,s){this.pendingAckTimer=e,this.heuristicData=t,this.submitSummaryCallback=n,this.successfulSummaryCallback=i,this.summaryWatcher=r,this.logger=s,this.summarizeTimer=new ur.b(2e4,()}summarize(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new Cr;return this.summarizeCore(e,t,i,n).catch((t=>{const n="UnexpectedSummarizeError";this.logger.sendErrorEvent(Object.assign({eventName:n},e),t),i.fail(n,t)})),i.build()}async summarizeCore(e,t,n,i){const{refreshLatestAck:r,fullTree:s}=t,o=Rt.create(this.logger,void 0,{all:e});let a={fullTree:s,timeSinceLastAttempt:Date.now()-this.heuristicData.lastAttempt.summaryTime,timeSinceLastSummary:Date.now()-this.heuristicData.lastSuccessfulSummary.summaryTime};const c=Ft.start(o,Object.assign({eventName:"Summarize",refreshLatestAck:r},a),{start:!0,end:!0,cancel:"generic"}),l=(e,t,r,s)=>{const o=Object(yr.n)(t),a=i.cancelled||(null==t?void 0:t.errorType)===lr.offlineError?"generic":"error",l=((e);c.cancel(Object.assign(Object.assign({},r),{reason:l,category:a,retryAfterSeconds:o}),null!=t?t:l),n.fail(l,t,s,o)};let d;this.summarizeTimer.start();try{const e=this.heuristicData.lastAttempt.refSequenceNumber;d=await this.submitSummaryCallback({fullTree:s,refreshLatestAck:r,summaryLogger:o,cancellationToken:i});const t=d.referenceSequenceNumber;if(a=Object.assign(Object.assign({},a),{referenceSequenceNumber:t,minimumSequenceNumber:d.minimumSequenceNumber,opsSinceLastAttempt:t-e,opsSinceLastSummary:t-this.heuristicData.lastSuccessfulSummary.refSequenceNumber,stage:d.stage}),a=this.addSummaryDataToTelemetryProps(d,a),"submit"!==d.stage)return l("submitSummaryFailure",d.error,a);if(!s&&!d.forcedFullTree){const{summarizedDataStoreCount:e,gcStateUpdatedDataStoreCount:t=0}=d.summaryStats;e>t+this.heuristicData.opsSinceLastSummary&&o.sendErrorEvent({eventName:"IncrementalSummaryViolation",summarizedDataStoreCount:e,gcStateUpdatedDataStoreCount:t,opsSinceLastSummary:this.heuristicData.opsSinceLastSummary})}c.reportEvent("generate",Object.assign({},a)),n.summarySubmitted.resolve({success:!0,data:d})}catch(e){return l("submitSummaryFailure",e)}finally{void 0===d&&this.heuristicData.recordAttempt(),this.summarizeTimer.clear()}try{const e=this.pendingAckTimer.start(),t=this.summaryWatcher.watchSummary(d.clientSequenceNumber),r=await br(t.waitBroadcast(),e,i);if("cancelled"===r.result)return l("disconnect");if("done"!==r.result)return l("summaryOpWaitTimeout");const s=r.value,u=Date.now()-this.heuristicData.lastAttempt.summaryTime;n.summaryOpBroadcasted.resolve({success:!0,data:{summarizeOp:s,broadcastDuration:u}}),this.heuristicData.lastAttempt.summarySequenceNumber=s.sequenceNumber,o.sendTelemetryEvent({eventName:"Summarize_Op",duration:u,referenceSequenceNumber:s.referenceSequenceNumber,summarySequenceNumber:s.sequenceNumber,handle:s.contents.handle});const h=await br(t.waitAckNack(),e,i);if("cancelled"===h.result)return l("disconnect");if("done"!==h.result)return l("summaryAckWaitTimeout");const m=h.value;this.pendingAckTimer.clear();const g=Date.now()-this.heuristicData.lastAttempt.summaryTime;if(a=Object.assign({ackWaitDuration:g,ackNackSequenceNumber:m.sequenceNumber,summarySequenceNumber:m.contents.summaryProposal.summarySequenceNumber},a),m.type!==qe.a.SummaryAck){Object(he.a)(m.type===qe.a.SummaryNack,628);const e=m.contents,t=null==e?void 0:e.retryAfter,n=new Pt("Received summaryNack",{retryAfterSeconds:t,errorMessage:null==e?void 0:e.message});return Object(he.a)(Object(yr.n)(n)===t,607),l("summaryNack",n,Object.assign(Object.assign({},a),{nackRetryAfter:t}),{summaryNackOp:m,ackNackDuration:g})}this.heuristicData.markLastAttemptAsSuccessful(),this.successfulSummaryCallback(),c.end(Object.assign(Object.assign({},a),{handle:m.contents.handle})),n.receivedSummaryAckOrNack.resolve({success:!0,data:{summaryAckOp:m,ackNackDuration:g}})}finally{this.pendingAckTimer.clear()}}addSummaryDataToTelemetryProps(e,t){switch(e.stage){case"base":return t;case"generate":return Object.assign(Object.assign(Object.assign({},t),e.summaryStats),{generateDuration:e.generateDuration});case"upload":return Object.assign(Object.assign(Object.assign({},t),e.summaryStats),{generateDuration:e.generateDuration,handle:e.handle,uploadDuration:e.uploadDuration});case"submit":return Object.assign(Object.assign(Object.assign({},t),e.summaryStats),{generateDuration:e.generateDuration,handle:e.handle,uploadDuration:e.uploadDuration,clientSequenceNumber:e.clientSequenceNumber,hasMissingOpData:this.heuristicData.hasMissingOpData,opsSizesSinceLastSummary:this.heuristicData.totalOpsSize,nonRuntimeOpsSinceLastSummary:this.heuristicData.numNonRuntimeOps,runtimeOpsSinceLastSummary:this.heuristicData.numRuntimeOps});default:Object(he.a)(!0,919)}return t}summarizeTimerHandler(e,t){if(this.logger.sendPerformanceEvent({eventName:"SummarizeTimeout",timeoutTime:e,timeoutCount:t}),t<5){const n=2*e;this.summarizeTimer.start(n,()}}dispose(){this.summarizeTimer.clear()}}var Or=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n};class Ir{constructor(e,t,n,i,r,s,o,a,c,l){var d,u;this.summaryWatcher=t,this.configuration=n,this.submitSummaryCallback=i,this.refreshLatestSummaryAckCallback=r,this.heuristicData=s,this.summaryCollection=o,this.cancellationToken=a,this.stopSummarizerCallback=c,this.runtime=l,this.stopping=!1,this._disposed=!1,this.tryWhileSummarizing=!1,this.summarizeCount=0,this.totalSuccessfulAttempts=0,this.initialized=!1,this.tryGetCorrelatedLogger=e=>this.heuristicData.lastAttempt.refSequenceNumber===e?this.mc.logger:void 0,this.heuristicRunnerMicroTaskExists=!1,this.mc=Jt(Rt.create(e,"Running",{all:{summarizeCount:()=>this.summarizeCount,summarizerSuccessfulAttempts:()=>this.totalSuccessfulAttempts}})),"disableHeuristics"!==n.state&&(Object(he.a)("enabled"===this.configuration.state,746),this.heuristicRunner=new gr(s,this.configuration,(e=>this.trySummarize(e)),this.mc.logger)),Object(he.a)("disabled"!==this.configuration.state,747);const h=Math.min(this.configuration.maxAckWaitTime,6e5);this.pendingAckTimer=new ur.a(h,(()=>{this.mc.logger.sendErrorEvent({eventName:"SummaryAckWaitTimeout",message:"Pending summary ack not received in time",maxAckWaitTime:h,referenceSequenceNumber:this.heuristicData.lastAttempt.refSequenceNumber,summarySequenceNumber:this.heuristicData.lastAttempt.summarySequenceNumber,timePending:Date.now()-this.heuristicData.lastAttempt.summaryTime})})),o.setPendingAckTimerTimeoutCallback(h,(()=>{this.pendingAckTimer.hasTimer&&(this.mc.logger.sendTelemetryEvent({eventName:"MissingSummaryAckFoundByOps",referenceSequenceNumber:this.heuristicData.lastAttempt.refSequenceNumber,summarySequenceNumber:this.heuristicData.lastAttempt.summarySequenceNumber}),this.pendingAckTimer.clear())})),this.generator=new wr(this.pendingAckTimer,this.heuristicData,this.submitSummaryCallback,(,this.summaryWatcher,this.mc.logger),this.deltaManagerListener=e=>{Object(hr.c)(e)||this.handleOp(e,!1)},this.runtimeListener=(e,t)=>{t&&this.handleOp(e,!0)},this.runtime.deltaManager.on("op",this.deltaManagerListener),null===(u=(d=this.runtime).on)||void 0===u||u.call(d,"op",this.runtimeListener)}static async start(e,t,n,i,r,s,o,a,c,l){var d,u;const h=new Ir(e,t,n,i,r,s,o,a,c,l),m=await h.handleSummaryAck();await h.waitStart(),h.processIncomingSummaryAcks(m).catch((t=>{e.sendErrorEvent({eventName:"HandleSummaryAckFatalError"},t)}));const g=l.deltaManager.lastSequenceNumber-(s.lastSuccessfulSummary.refSequenceNumber+s.numNonRuntimeOps+s.numRuntimeOps);return s.hasMissingOpData=g>0,s.hasMissingOpData&&(s.numNonRuntimeOps+=Math.ceil(g/2),s.numRuntimeOps+=Math.floor(g/2)),s.lastOpSequenceNumber=l.deltaManager.lastSequenceNumber,null===(d=h.heuristicRunner)||void 0===d||d.start(),null===(u=h.heuristicRunner)||void 0===u||u.run(),h}get disposed(){return this._disposed}async handleSummaryAck(){var e;const t=this.summaryCollection.latestAck;let n=-1;if(void 0!==t){n=t.summaryOp.referenceSequenceNumber;const i=null!==(e=this.tryGetCorrelatedLogger(n))&&void 0!==e?e:this.mc.logger,r=t.summaryOp.contents.handle,s=t.summaryAck.contents.handle;for(;void 0!==this.summarizingLock;)i.sendTelemetryEvent({eventName:"RefreshAttemptWithSummarizerRunning",referenceSequenceNumber:n,proposalHandle:r,ackHandle:s}),await this.summarizingLock;await this.lockedSummaryAction((()=>{}),(async()=>this.refreshLatestSummaryAckCallback({proposalHandle:r,ackHandle:s,summaryRefSeq:n,summaryLogger:i}).catch((async e=>{const t=pt(e)&&e.errorType===lr.fileNotFoundOrAccessDeniedError;i.sendTelemetryEvent({eventName:t?"HandleSummaryAckErrorIgnored":"HandleLastSummaryAckError",referenceSequenceNumber:n,proposalHandle:r,ackHandle:s},e)}))),(()=>{})),n++}return n}async processIncomingSummaryAcks(e){var t;let n=e>0?e:this.runtime.deltaManager.initialSequenceNumber;for(;!this.disposed;){const i=null!==(t=this.tryGetCorrelatedLogger(n))&&void 0!==t?t:this.mc.logger;await this.summaryCollection.waitSummaryAck(n),i.sendTelemetryEvent({eventName:"processIncomingSummaryAcks",referenceSequenceNumber:n,lastAckRefSeq:e}),n=await this.handleSummaryAck(),Object(he.a)(n>=0,1423)}}dispose(){var e,t,n;this.runtime.deltaManager.off("op",this.deltaManagerListener),null===(t=(e=this.runtime).off)||void 0===t||t.call(e,"op",this.runtimeListener),this.summaryWatcher.dispose(),null===(n=this.heuristicRunner)||void 0===n||n.dispose(),this.heuristicRunner=void 0,this.generator.dispose(),this.pendingAckTimer.clear(),this.disposeEnqueuedSummary(),this._disposed=!0,this.stopping=!0}handleOp(e,t){this.heuristicData.lastOpSequenceNumber=e.sequenceNumber,t?this.heuristicData.numRuntimeOps++:this.heuristicData.numNonRuntimeOps++,this.heuristicData.totalOpsSize+=(e=>{var t;const n="string"==typeof e.contents?e.contents:null!==(t=JSON.stringify(e.contents))&&void 0!==t?t:"",i=((e)?e.data:"";return n.length+i.length})(e),this.initialized&&this.opCanTriggerSummary(e,t)&&!this.tryRunEnqueuedSummary()&&!this.heuristicRunnerMicroTaskExists&&(this.heuristicRunnerMicroTaskExists=!0,Promise.resolve().then(().finally(())}opCanTriggerSummary(e,t){switch(e.type){case qe.a.Summarize:case qe.a.SummaryAck:case qe.a.SummaryNack:return!1;default:return t||this.nonRuntimeOpCanTriggerSummary()}}nonRuntimeOpCanTriggerSummary(){return"enabled"===this.configuration.state&&(void 0===this.configuration.nonRuntimeHeuristicThreshold||this.configuration.nonRuntimeHeuristicThreshold<=this.heuristicData.lastOpSequenceNumber-this.heuristicData.lastSuccessfulSummary.refSequenceNumber)}async waitStop(e){var t;this.stopping||(this.stopping=!0,this.disposeEnqueuedSummary(),e&&(null===(t=this.heuristicRunner)||void 0===t?void 0:t.shouldRunLastSummary())&&void 0===this.summarizingLock&&this.trySummarizeOnce({reason:"lastSummary"},{}),await this.summarizingLock)}async waitStart(){const e=await br(this.summaryWatcher.waitFlushed(),this.pendingAckTimer.start());this.pendingAckTimer.clear(),this.summaryCollection.unsetPendingAckTimerTimeoutCallback(),"done"===e.result&&void 0!==e.value&&this.heuristicData.updateWithLastSummaryAckInfo({refSequenceNumber:e.value.summaryOp.referenceSequenceNumber,summaryTime:Date.now(),summarySequenceNumber:e.value.summaryOp.sequenceNumber}),this.initialized=!0}fterSummaryAction(){var e;const t=this.tryWhileSummarizing;this.tryWhileSummarizing=!1,this.stopping||this.tryRunEnqueuedSummary()||!t||null===(e=this.heuristicRunner)||void 0===e||e.run()}async lockedSummaryAction(e,t,n){Object(he.a)(void 0===this.summarizingLock,603);const i=new lt.a;return this.summarizingLock=i.promise,e(),t().finally((()=>{i.resolve(),this.summarizingLock=void 0,n()}))}trySummarizeOnce(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.cancellationToken,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new Cr;return this.lockedSummaryAction((()=>{this.beforeSummaryAction()}),(async()=>this.generator.summarize(e,t,n,i).receivedSummaryAckOrNack),(()=>{this.afterSummaryAction()})).catch((),i.build()}trySummarize(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.cancellationToken;void 0===this.summarizingLock?this.lockedSummaryAction((()=>{this.beforeSummaryAction()}),(async()=>{var n;const i=[{refreshLatestAck:!1,fullTree:!1},{refreshLatestAck:!0,fullTree:!1},{refreshLatestAck:!0,fullTree:!1,delaySeconds:120},{refreshLatestAck:!0,fullTree:!0,delaySeconds:600}];let r,s,o=0,a=0,c=null!==(n=this.mc.config.getNumber("Fluid.Summarizer.Attempts"))&&void 0!==n?n:2;if(c>i.length)this.mc.logger.sendTelemetryEvent({eventName:"InvalidSummarizerAttempts",attempts:c}),c=2;else if(c<1)throw new rn("Invalid number of attempts.");for(let n=0;n<c;){if(this.cancellationToken.cancelled)return;if(++o>1&&"lastSummary"===e)return;a++;const c=i[n],{delaySeconds:l=0}=c,d=Or(c,["delaySeconds"]),u=Object.assign({reason:e,summaryAttempts:o,summaryAttemptsPerPhase:a,summaryAttemptPhase:n+1},d),h=this.generator.summarize(u,d,t),m=await h.receivedSummaryAckOrNack;if(m.success)return;r=m.retryAfterSeconds,(void 0===r||a>1)&&(n++,a=0),s=m;const g=null!=r?r:l;g>0&&(this.mc.logger.sendPerformanceEvent(Object.assign({eventName:"SummarizeAttemptDelay",duration:g,summaryNackDelay:void 0!==r},u)),await Object(ht.a)(1e3*g))}this.mc.logger.sendErrorEvent({eventName:"FailToSummarize",reason:e,message:null==s?void 0:s.message},null==s?void 0:s.error),this.stopSummarizerCallback("failToSummarize")}),(()=>{this.afterSummaryAction()})).catch((e=>{this.mc.logger.sendErrorEvent({eventName:"UnexpectedSummarizeError"},e)})):this.tryWhileSummarizing=!0}summarizeOnDemand(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Cr,t=arguments.length>1?arguments[1]:void 0;var{reason:n}=t,i=Or(t,["reason"]);if(this.stopping)return e.fail("RunningSummarizer stopped or disposed",void 0),e.build();if(void 0!==this.summarizingLock)throw new rn("Attempted to run an already-running summarizer on demand");return this.trySummarizeOnce({reason:`onDemand/${n}`},i,this.cancellationToken,e)}enqueueSummarize(e){var{reason:t,afterSequenceNumber:n=0,override:i=!1}=e,r=Or(e,["reason","afterSequenceNumber","override"]);const s=`enqueue;${t}`;let o=!1;if(void 0!==this.enqueuedSummary){if(!i)return{alreadyEnqueued:!0};this.enqueuedSummary.resultsBuilder.fail("Aborted; overridden by another enqueue summarize attempt",void 0),this.enqueuedSummary=void 0,o=!0}this.enqueuedSummary={reason:s,afterSequenceNumber:n,options:r,resultsBuilder:new Cr};const a=this.enqueuedSummary.resultsBuilder.build();return this.tryRunEnqueuedSummary(),o?Object.assign(Object.assign({},a),{alreadyEnqueued:!0,overridden:!0}):a}tryRunEnqueuedSummary(){if(this.stopping)return this.disposeEnqueuedSummary(),!1;if(void 0===this.enqueuedSummary||this.heuristicData.lastOpSequenceNumber<this.enqueuedSummary.afterSequenceNumber||void 0!==this.summarizingLock)return!1;const{reason:e,resultsBuilder:t,options:n}=this.enqueuedSummary;return this.enqueuedSummary=void 0,this.trySummarizeOnce({reason:`enqueuedSummary/${e}`},n,this.cancellationToken,t),!0}disposeEnqueuedSummary(){void 0!==this.enqueuedSummary&&(this.enqueuedSummary.resultsBuilder.fail("RunningSummarizer stopped or disposed",void 0),this.enqueuedSummary=void 0)}}class Nr extends Pt{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];super(e),this.logged=t,this.errorType="summarizingError",this.canRetry=!0}static wrap(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return function(e,n,i){const r=It(e,(),s=r.errorInstanceId;return i.sendTelemetryEvent({eventName:"WrapError",errorInstanceId:s,wrappedByErrorInstanceId:s},e),r}(e,0,arguments.length>2?arguments[2]:void 0)}}class Tr extends dr.EventEmitter{constructor(e,t,n,i,r,s){var o;super(),o=this,this.runtime=e,this.configurationGetter=t,this.internalsProvider=n,this.summaryCollection=r,this.runCoordinatorCreateFn=s,this._disposed=!1,this.starting=!1,this.stopDeferred=new lt.a,this.summarizeOnDemand=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i;try{if(o._disposed||(null===(i=o.runningSummarizer)||void 0===i?void 0:i.disposed))throw new rn("Summarizer is already disposed.");if(void 0!==o.runtime.summarizerClientId&&o.runtime.summarizerClientId!==o.runtime.clientId)throw new rn("On-demand summary attempted while an elected summarizer is present");const e=new Cr;return o.runningSummarizer?o.runningSummarizer.summarizeOnDemand(e,...t):(o.runCoordinatorCreateFn(o.runtime).then((n=>{o.start(o.runtime.clientId,n).then((async i=>{i.summarizeOnDemand(e,...t);const r=await Promise.race([o.stopDeferred.promise,n.waitCancelled]);await i.waitStop(!1),n.stop(r),o.close()})).catch((t=>{e.fail("Failed to start summarizer",t)}))})).catch((),e.build())}catch(e){throw Nr.wrap(e,!1,o.logger)}},this.enqueueSummarize=function(){if(o._disposed||void 0===o.runningSummarizer||o.runningSummarizer.disposed)throw new rn("Summarizer is not running or already disposed.");return o.runningSummarizer.enqueueSummarize(...arguments)},this.logger=Rt.create(this.runtime.logger,"Summarizer")}get ISummarizer(){return this}static async create(e,t){var n;const i={headers:{[tt.cache]:!1,[tt.clientDetails]:{capabilities:{interactive:!1},type:oi},[en.summarizingClient]:!0,[tt.reconnect]:!1},url:t},r=await e.resolve(i),s=r.getEntryPoint?await(null===(n=r.getEntryPoint)||void 0===n?void 0:n.call(r)):await pn(r,{url:"_summarizer"});if(void 0===(null==s?void 0:s.ISummarizer))throw new rn("Fluid object does not implement ISummarizer");return s.ISummarizer}async run(e){try{return await this.runCore(e)}catch(e){throw this.stop("summarizerException"),Nr.wrap(e,!1,this.logger)}finally{this.close()}}stop(e){this.stopDeferred.resolve(e)}close(){var e;this.dispose(),(null!==(e=this.runtime.disposeFn)&&void 0!==e?e:this.runtime.closeFn)()}async runCore(e){const t=await this.runCoordinatorCreateFn(this.runtime),n=Promise.race([t.waitCancelled,this.stopDeferred.promise]);if(n.then((),t.cancelled)return t.waitCancelled;const i=await this.start(e,t),r=await n;return await i.waitStop(!t.cancelled&&Tr.stopReasonCanRunLastSummary(r)),t.stop(r),r}sync start(e,t){var n=this;if(this.runningSummarizer){if(this.runningSummarizer.disposed)throw new rn("Starting a disposed summarizer");return this.runningSummarizer}if(this.starting)throw new rn("Attempting to start a summarizer that is already starting");this.starting=!0,this.logger.sendTelemetryEvent({eventName:"RunningSummarizer",onBehalfOf:e,initSummarySeqNumber:this.runtime.deltaManager.initialSequenceNumber,config:JSON.stringify(this.configurationGetter())});const i=this.runtime.clientId;if(void 0===i)throw new rn("clientId should be defined if connected.");this._heuristicData=new mr(this.runtime.deltaManager.lastSequenceNumber,{refSequenceNumber:this.runtime.deltaManager.initialSequenceNumber,summaryTime:Date.now()});const r=await Ir.start(this.logger,this.summaryCollection.createWatcher(i),this.configurationGetter(),(async function(){return n.internalsProvider.submitSummary(...arguments)}),(,this._heuristicData,this.summaryCollection,t,(e=>t.stop(e)),this.runtime);return this.runningSummarizer=r,this.starting=!1,r}dispose(){this.stop("summarizerClientDisconnected"),this._disposed=!0,this.runningSummarizer&&(this.runningSummarizer.dispose(),this.runningSummarizer=void 0)}new Promise((()=>{}));class Er{et cancelled(){return this._cancelled||Object(he.a)(this.active(),605),this._cancelled}get waitCancelled(){return this.stopDeferred.promise}static async create(e,t){const n=new Er(e,t);return await n.waitStart(),n}async waitStart(){if(this.runtime.disposed)this.stop("summarizerClientDisconnected");else{if(this.runtime.once("dispose",(()=>this.stop("summarizerClientDisconnected"))),!this.runtime.connected){const e=new Promise((e=>this.runtime.once("connected",e)));await Promise.race([e,this.waitCancelled])}this.runtime.once("disconnected",(()=>this.stop("summarizerClientDisconnected")))}}stopconst kr=5e3,jr=4e3;var Pr;!function(e){e[e.Off=0]="Off",e[e.Starting=1]="Starting",e[e.Running=2]="Running",e[e.Stopping=3]="Stopping"}(Pr||(Pr={}));class _r{constructor(e,t,n,i,r,s){var o=this;let{initialDelayMs:a=kr,opsToBypassInitialDelay:c=jr}=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{},l=arguments.length>7?arguments[7]:void 0;this.clientElection=e,this.connectedState=t,this.summaryCollection=n,this.requestSummarizerFn=r,this.startThrottler=s,this.disableHeuristics=l,this.state=Pr.Off,this._disposed=!1,this.handleConnected=this.handleDisconnected=()=>{this.refreshSummarizer()},this.refreshSummarizer=()=>{const e=this.getShouldSummarizeState();switch(this.state){case Pr.Off:return void(e.shouldSummarize&&this.startSummarization());case Pr.Starting:return;case Pr.Running:return void(!1===e.shouldSummarize&&this.stop(e.stopReason));case Pr.Stopping:default:return}},this.summarizeOnDemand=function(){if(void 0===o.summarizer)throw Error("No running summarizer client");return o.summarizer.summarizeOnDemand(...arguments)},this.enqueueSummarize=function(){if(void 0===o.summarizer)throw Error("No running summarizer client");return o.summarizer.enqueueSummarize(...arguments)},this.logger=Rt.create(i,"SummaryManager",{all:{clientId:()=>this.latestClientId}}),this.connectedState.on("connected",this.handleConnected),this.connectedState.on("disconnected",this.handleDisconnected),this.latestClientId=this.connectedState.clientId,this.opsToBypassInitialDelay=c,this.initialDelayMs=a}get disposed(){return this._disposed}get currentState(){return this.state}etShouldSummarizeState(){return this.connectedState.clientId!==this.clientElection.electedParentId?{shouldSummarize:!1,stopReason:"notElectedParent"}:this.state!==Pr.Running&&this.connectedState.clientId!==this.clientElection.electedClientId?{shouldSummarize:!1,stopReason:"notElectedClient"}:this.connectedState.connected?this.disposed?void Object(he.a)(!1,608):{shouldSummarize:!0}:{shouldSummarize:!1,stopReason:"parentNotConnected"}}startSummarization(){Object(he.a)(this.state===Pr.Off,609),this.state=Pr.Starting,Object(he.a)(void 0===this.summarizer,610),this.delayBeforeCreatingSummarizer().then((async e=>{const t=this.getShouldSummarizeState();if(e&&!1===t.shouldSummarize)return`early exit ${t.stopReason}`;Object(he.a)(this.state===Pr.Starting,611),this.state=Pr.Running;const n=await this.requestSummarizerFn();this.summarizer=n;const i=this.getShouldSummarizeState();if(!1===i.shouldSummarize){if(e||!Tr.stopReasonCanRunLastSummary(i.stopReason))return this.state=Pr.Starting,n.stop(i.stopReason),`early exit after starting summarizer ${i.stopReason}`;this.logger.sendTelemetryEvent({eventName:"LastAttemptToSummarize"})}const r=this.latestClientId;return Ft.timedExecAsync(this.logger,{eventName:"RunningSummarizer",attempt:this.startThrottler.numAttempts},()})).then(().catch((e=>{this.logger.sendTelemetryEvent({eventName:"EndingSummarizer",reason:"exception"},e),(this.getShouldSummarizeState().shouldSummarize||void 0!==this.summarizer)&&this.logger.sendTelemetryEvent({eventName:"SummarizerException",category:(null==e?void 0:e.errorType)===lr.offlineError?"generic":"error"},e)})).finally((()=>{var e;Object(he.a)(this.state!==Pr.Off,612),this.state=Pr.Off,null===(e=this.summarizer)||void 0===e||e.close(),this.summarizer=void 0,this.getShouldSummarizeState().shouldSummarize&&this.startSummarization()}))}stop(e){var t;_r.isStartingOrRunning(this.state)&&(this.state=Pr.Stopping,null===(t=this.summarizer)||void 0===t||t.stop(e))}async delayBeforeCreatingSummarizer(){let e=this.startThrottler.getDelay();this.logger.sendTelemetryEvent({eventName:"CreatingSummarizer",throttlerDelay:e,initialDelay:this.initialDelayMs,startThrottlerMaxDelayMs:this.startThrottler.maxDelayMs,opsSinceLastAck:this.summaryCollection.opsSinceLastAck,opsToBypassInitialDelay:this.opsToBypassInitialDelay,electedParentId:this.clientElection.electedParentId,electedClientId:this.clientElection.electedClientId});let t=!1;if(this.summaryCollection.opsSinceLastAck<this.opsToBypassInitialDelay&&(t=!0,e=Math.max(e,this.initialDelayMs)),e>0){let t,n;const i=()=>{this.summaryCollection.opsSinceLastAck>=this.opsToBypassInitialDelay&&(clearTimeout(t),n())},r=new Promise((n=>{t=setTimeout((()=>n()),e)})),s=new Promise(();this.summaryCollection.addOpListener(i),await Promise.race([r,s]),this.summaryCollection.removeOpListener(i)}return t}dispose(){this.clientElection.off("electedSummarizerChanged",this.refreshSummarizer),this.connectedState.off("connected",this.handleConnected),this.connectedState.off("disconnected",this.handleDisconnected),this._disposed=!0}}function Mr(e){return e&&e+432e6+864e5}_r.isStartingOrRunning=const Dr=`${dn.gcBlobPrefix}_root`;class xr{constructor(e,t){var n;this.configs=e,this.currentGCVersion=this.configs.gcVersionInEffect,this.wasGCRunInLatestSummary=t,this.latestSummaryGCVersion=null!==(n=this.configs.gcVersionInBaseSnapshot)&&void 0!==n?n:this.currentGCVersion}et doesSummaryStateNeedReset(){return this.doesGCStateNeedReset||this.configs.shouldRunGC&&this.latestSummaryGCVersion!==this.currentGCVersion}initializeBaseState(e){this.latestSummaryData={serializedGCState:e.gcState?JSON.stringify($i(e.gcState)):void 0,serializedTombstones:JSON.stringify(e.tombstones),serializedDeletedNodes:JSON.stringify(e.deletedNodes)}}summarize(e,t,n,i,r){if(!this.configs.shouldRunGC)return;const s=JSON.stringify($i(n)),o=i.size>0?JSON.stringify(Array.from(i).sort()):void 0,a=this.configs.tombstoneMode&&r.length>0?JSON.stringify(r.sort()):void 0;if(this.pendingSummaryData={serializedGCState:s,serializedTombstones:a,serializedDeletedNodes:o},t&&!e&&void 0!==this.latestSummaryData){if(this.latestSummaryData.serializedGCState===s&&this.latestSummaryData.serializedTombstones===a&&this.latestSummaryData.serializedDeletedNodes===o){const e=wn();return e.handleNodeCount++,{summary:{type:ln.a.Handle,handle:`/${dn.gcTreeKey}`,handleType:ln.a.Tree},stats:e}}return this.buildGCSummaryTree(s,a,o,!0)}return this.buildGCSummaryTree(s,a,o,!1)}buildGCSummaryTree(e,t,n,i){var r,s,o;const a=new En;return(null===(r=this.latestSummaryData)||void 0===r?void 0:r.serializedGCState)===e&&i?a.addHandle(Dr,ln.a.Blob,`/${dn.gcTreeKey}/${Dr}`):a.addBlob(Dr,e),void 0!==t&&((null===(s=this.latestSummaryData)||void 0===s?void 0:s.serializedTombstones)===t&&i?a.addHandle(dn.gcTombstoneBlobKey,ln.a.Blob,`/${dn.gcTreeKey}/${dn.gcTombstoneBlobKey}`):a.addBlob(dn.gcTombstoneBlobKey,t)),void 0===n||((null===(o=this.latestSummaryData)||void 0===o?void 0:o.serializedDeletedNodes)===n&&i?a.addHandle(dn.gcDeletedBlobKey,ln.a.Blob,`/${dn.gcTreeKey}/${dn.gcDeletedBlobKey}`):a.addBlob(dn.gcDeletedBlobKey,n)),a.getSummaryTree()}async refreshLatestSummary(e,t,n){if(t.latestSummaryUpdated&&t.wasSummaryTracked&&(this.wasGCRunInLatestSummary=this.configs.shouldRunGC),!t.latestSummaryUpdated||!this.configs.shouldRunGC)return;if(t.wasSummaryTracked)return this.latestSummaryGCVersion=this.currentGCVersion,this.latestSummaryData=this.pendingSummaryData,void(this.pendingSummaryData=void 0);const i=t.snapshotTree,r=i.blobs[".metadata"],s=r?await n(r):void 0;this.latestSummaryGCVersion=Gi(s);const o=i.trees[dn.gcTreeKey];if(this.wasGCRunInLatestSummary=void 0!==o,void 0===o)return;let a=await Ji(o,n);return Gi(s)!==this.currentGCVersion&&(a={gcState:void 0,tombstones:void 0,deletedNodes:a.deletedNodes}),this.latestSummaryData={serializedGCState:JSON.stringify(a.gcState),serializedTombstones:JSON.stringify(a.tombstones),serializedDeletedNodes:JSON.stringify(a.deletedNodes)},a}}class Ar extends ur.b{constructor(e){super(0,(),this.callback=e}start(e){super.start(e,this.callback)}restart(e){super.restart(e,this.callback)}}class Rr{constructor(e,t,n,i){this.unreferencedTimestampMs=e,this.inactiveTimeoutMs=t,this.sweepTimeoutMs=i,this._state=Zn,void 0!==this.sweepTimeoutMs&&Object(he.a)(this.inactiveTimeoutMs<=this.sweepTimeoutMs,944),this.sweepTimer=new Ar((()=>{this._state=ei,Object(he.a)(!this.inactiveTimer.hasTimer,945)})),this.inactiveTimer=new Ar((()=>{this._state=Yn,void 0!==this.sweepTimeoutMs&&this.sweepTimer.restart(this.sweepTimeoutMs-this.inactiveTimeoutMs)})),this.updateTracking(n)}get state(){return this._state}updateTracking(e){const t=e-this.unreferencedTimestampMs;return void 0!==this.sweepTimeoutMs&&t>=this.sweepTimeoutMs?(this._state=ei,void this.clearTimers()):t>=this.inactiveTimeoutMs?(this._state=Yn,this.inactiveTimer.clear(),void(void 0!==this.sweepTimeoutMs&&this.sweepTimer.restart(this.sweepTimeoutMs-t))):void this.inactiveTimer.restart(this.inactiveTimeoutMs-t)}lass Fr{constructor(e){this.newReferencesSinceLastRun=new Map,this.tombstones=[],this.deletedNodes=new Set,this.unreferencedNodesState=new Map,this.completedRuns=0,this.runtime=e.runtime,this.isSummarizerClient=e.isSummarizerClient,this.getNodePackagePath=e.getNodePackagePath,this.getLastSummaryTimestampMs=e.getLastSummaryTimestampMs,this.activeConnection=e.activeConnection;const t=e.baseSnapshot,n=e.readAndParseBlob;if(this.mc=Jt(Rt.create(e.baseLogger,"GarbageCollector",{all:{completedGCRuns:()=>this.completedRuns}})),this.configs=function(e,t){var n,i,r,s,o,a,c,l,d,u;let h,m,g,p,f;if(t.existing)f=Gi(t.metadata),h=f>0,m=null===(n=t.metadata)||void 0===n?void 0:n.sessionExpiryTimeoutMs,g=null!==(r=null===(i=t.metadata)||void 0===i?void 0:i.sweepTimeoutMs)&&void 0!==r?r:Mr(m),p=null===(s=t.metadata)||void 0===s?void 0:s.gcFeatureMatrix;else{const n=t.gcOptions.gcTombstoneGeneration,i=t.gcOptions.gcSweepGeneration;if(void 0!==i&&!1===t.gcOptions.gcAllowed)throw new rn("GC sweep phase cannot be enabled without enabling GC mark phase");const r=e.config.getNumber("Fluid.GarbageCollection.TestOverride.SweepTimeoutMs");h=!1!==t.gcOptions.gcAllowed,h&&!1!==e.config.getBoolean("Fluid.GarbageCollection.RunSessionExpiry")&&(m=null!==(o=t.gcOptions.sessionExpiryTimeoutMs)&&void 0!==o?o:2592e6),g=null!=r?r:Mr(m),void 0===n&&void 0===i||(p={tombstoneGeneration:n,sweepGeneration:i})}const v=function(e,t){return void 0!==t&&(0===t?0===e.sweepGeneration||0===e.tombstoneGeneration:e.sweepGeneration===t)}(null!=p?p:{},t.gcOptions.gcSweepGeneration),y=null!==(a=e.config.getBoolean("Fluid.GarbageCollection.RunGC"))&&void 0!==a?a:h&&!t.gcOptions.disableGC,b=y&&void 0!==g&&(null!==(c=e.config.getBoolean(Hn))&&void 0!==c?c:v),S=null!==(d=null!==(l=e.config.getNumber("Fluid.GarbageCollection.TestOverride.InactiveTimeoutMs"))&&void 0!==l?l:t.gcOptions.inactiveTimeoutMs)&&void 0!==d?d:6048e5;if(void 0!==g&&S>g)throw new rn("inactive timeout should not be greater than the sweep timeout");const C=null!==(u=e.config.getBoolean("Fluid.GarbageCollection.GCTestMode"))&&void 0!==u?u:!0===t.gcOptions.runGCInTestMode,w=!b&&!0!==e.config.getBoolean(Gn);return{gcEnabled:h,sweepEnabled:v,shouldRunGC:y,shouldRunSweep:b,runFullGC:t.gcOptions.runFullGC,testMode:C,tombstoneMode:w,sessionExpiryTimeoutMs:m,sweepTimeoutMs:g,inactiveTimeoutMs:S,persistedGcFeatureMatrix:p,gcVersionInBaseSnapshot:f,gcVersionInEffect:!0===e.config.getBoolean("Fluid.GarbageCollection.GCVersionUpgradeToV3")?3:2}}(this.mc,e),void 0!==this.configs.sessionExpiryTimeoutMs){const e=this.mc.config.getNumber("Fluid.GarbageCollection.TestOverride.SessionExpiryMs"),t=null!=e?e:this.configs.sessionExpiryTimeoutMs;this.sessionExpiryTimer=new ur.b(t,(()=>{this.runtime.closeFn(new sn("Client session expired.",t))})),this.sessionExpiryTimer.start()}this.summaryStateTracker=new xr(this.configs,void 0!==(null==t?void 0:t.trees[dn.gcTreeKey])),this.telemetryTracker=new ni(this.mc,this.configs,this.isSummarizerClient,this.runtime.gcTombstoneEnforcementAllowed,e.createContainerMetadata,(e=>this.runtime.getNodeType(e)),(e=>this.unreferencedNodesState.get(e)),this.getNodePackagePath),this.baseSnapshotDataP=new lt.b((async()=>{if(void 0!==t)try{const e=t.trees[dn.gcTreeKey];if(void 0===e)return;const i=await Ji(e,n);return this.configs.gcVersionInBaseSnapshot!==this.summaryStateTracker.currentGCVersion?{gcState:void 0,tombstones:void 0,deletedNodes:i.deletedNodes}:i}catch(e){const t=an.wrapIfUnrecognized(e,"FailedToInitializeGC");throw t.addTelemetryProperties({gcConfigs:JSON.stringify(this.configs)}),t}})),this.initializeGCStateFromBaseSnapshotP=new lt.b((async()=>{const e=this.runtime.getCurrentReferenceTimestampMs();if(void 0===e)return void this.mc.logger.sendErrorEvent({eventName:"GarbageCollectorInitializedWithoutTimestamp",gcConfigs:JSON.stringify(this.configs)});const t=await this.baseSnapshotDataP;void 0!==t&&(this.updateStateFromSnapshotData(t,e),this.summaryStateTracker.initializeBaseState(t))})),this.baseGCDetailsP=new lt.b((async()=>{const e=await this.baseSnapshotDataP;if(void 0===(null==e?void 0:e.gcState))return{};const t={};for(const[n,i]of Object.entries(e.gcState.gcNodes))t[n]=Array.from(i.outboundRoutes);return{gcData:{gcNodes:t},usedRoutes:Xi(t,["/"]).referencedNodeIds}})),this.isSummarizerClient&&this.mc.logger.sendTelemetryEvent({eventName:"GarbageCollectorLoaded",gcConfigs:JSON.stringify(this.configs),gcOptions:JSON.stringify(e.gcOptions)})}static create(e){return new Fr(e)}get shouldRunGC(){return this.configs.shouldRunGC}get summaryStateNeedsReset(){return this.summaryStateTracker.doesSummaryStateNeedReset}async initializeBaseState(){const e=await this.baseSnapshotDataP;void 0!==e&&(void 0!==e.deletedNodes&&(this.deletedNodes=new Set(e.deletedNodes)),this.configs.tombstoneMode&&void 0!==e.tombstones&&(this.tombstones=Array.from(e.tombstones),this.runtime.updateTombstonedRoutes(this.tombstones)))}updateStateFromSnapshotData(e,t){for(const[,e]of this.unreferencedNodesState)e.stopTracking();if(this.unreferencedNodesState.clear(),this.configs.shouldRunSweep){const t=(null==e?void 0:e.deletedNodes)?new Set(e.deletedNodes):void 0;if(void 0!==t){const e=[];for(const n of t)this.deletedNodes.has(n)||e.push(n)}}else this.configs.tombstoneMode&&(this.tombstones=(null==e?void 0:e.tombstones)?Array.from(e.tombstones):[],this.runtime.updateTombstonedRoutes(this.tombstones));if(void 0===(null==e?void 0:e.gcState))return void(this.gcDataFromLastRun=void 0);const n={};for(const[i,r]of Object.entries(e.gcState.gcNodes))void 0!==r.unreferencedTimestampMs&&this.unreferencedNodesState.set(i,new Rr(r.unreferencedTimestampMs,this.configs.inactiveTimeoutMs,t,this.configs.sweepTimeoutMs)),n[i]=Array.from(r.outboundRoutes);this.gcDataFromLastRun={gcNodes:n}}setConnectionState(e,t){this.activeConnection()&&this.configs.shouldRunGC&&this.initializeGCStateFromBaseSnapshotP.catch((e=>{}))}async collectGarbage(e,t){var n;const i=null!==(n=e.fullGC)&&void 0!==n?n:!0===this.configs.runFullGC||this.summaryStateTracker.doesSummaryStateNeedReset;null==t||t.setMultiple("fluid_GC","Options",{fullGC:i,runSweep:e.runSweep});const r=e.logger?Rt.create(e.logger,void 0,{all:{completedGCRuns:()=>this.completedRuns}}):this.mc.logger,s=this.runtime.getCurrentReferenceTimestampMs();if(void 0!==s)return Ft.timedExecAsync(r,{eventName:"GarbageCollection"},(async e=>{await this.runPreGCSteps();const t=await this.runtime.getGCData(i),n=Xi(t.gcNodes,["/"]),o=await this.runPostGCSteps(t,n,r,s);return e.end(Object.assign(Object.assign({},o),{timestamp:s})),this.completedRuns++,o}),{end:!0,cancel:"error"});r.sendErrorEvent({eventName:"CollectGarbageCalledWithoutTimestamp",gcConfigs:JSON.stringify(this.configs)})}async runPreGCSteps(){await this.initializeGCStateFromBaseSnapshotP,await this.runtime.updateStateBeforeGC()}async runPostGCSteps(e,t,n,i){const r=this.generateStats(t),s=this.updateMarkPhase(e,t,i,n);this.runtime.updateUsedRoutes(t.referencedNodeIds),this.telemetryTracker.logSweepEvents(n,i,this.unreferencedNodesState,this.completedRuns,this.getLastSummaryTimestampMs());let o=e;return this.configs.shouldRunSweep?o=this.runSweepPhase(s,e):this.configs.testMode?this.runtime.updateUnusedRoutes(t.deletedNodeIds):this.configs.tombstoneMode&&(this.tombstones=s,this.runtime.updateTombstonedRoutes(this.tombstones)),this.gcDataFromLastRun=Wi(o),await this.telemetryTracker.logPendingEvents(n),r}summarize(e,t,n){var i;if(!this.configs.shouldRunGC||void 0===this.gcDataFromLastRun)return;const r={gcNodes:{}};for(const[e,t]of Object.entries(this.gcDataFromLastRun.gcNodes))r.gcNodes[e]={outboundRoutes:t,unreferencedTimestampMs:null===(i=this.unreferencedNodesState.get(e))||void 0===i?void 0:i.unreferencedTimestampMs};return this.summaryStateTracker.summarize(e,t,r,this.deletedNodes,this.tombstones)}getMetadata(){return{gcFeature:this.configs.gcEnabled?this.summaryStateTracker.currentGCVersion:0,gcFeatureMatrix:this.configs.persistedGcFeatureMatrix,sessionExpiryTimeoutMs:this.configs.sessionExpiryTimeoutMs,sweepEnabled:!1,sweepTimeoutMs:this.configs.sweepTimeoutMs}}async getBaseGCDetails(){return this.baseGCDetailsP}async refreshLatestSummary(e,t,n){const i=await this.summaryStateTracker.refreshLatestSummary(e,t,n);if(this.shouldRunGC&&t.latestSummaryUpdated&&!t.wasSummaryTracked){const n=this.runtime.getCurrentReferenceTimestampMs();if(void 0===n)throw an.create("No reference timestamp when updating GC state from snapshot","refreshLatestSummary",void 0,{proposalHandle:e,summaryRefSeq:t.summaryRefSeq,gcConfigs:JSON.stringify(this.configs)});this.updateStateFromSnapshotData(i,n)}}nodeUpdated(e,t,n,i,r){this.configs.shouldRunGC&&this.telemetryTracker.nodeUsed({nodeId:e,usageType:t,currentReferenceTimestampMs:null!=n?n:this.runtime.getCurrentReferenceTimestampMs(),packagePath:i,completedGCRuns:this.completedRuns,isTombstoned:this.tombstones.includes(e),lastSummaryTime:this.getLastSummaryTimestampMs(),viaHandle:null==r?void 0:r[ds.viaHandle]})}addedOutboundReference(e,t){var n;if(!this.configs.shouldRunGC)return;const i=null!==(n=this.newReferencesSinceLastRun.get(e))&&void 0!==n?n:[];i.push(t),this.newReferencesSinceLastRun.set(e,i),this.telemetryTracker.nodeUsed({nodeId:t,usageType:"Revived",currentReferenceTimestampMs:this.runtime.getCurrentReferenceTimestampMs(),packagePath:void 0,completedGCRuns:this.completedRuns,isTombstoned:this.tombstones.includes(t),lastSummaryTime:this.getLastSummaryTimestampMs(),fromId:e})}isNodeDeleted(e){return this.deletedNodes.has(e)}pdateMarkPhase(e,t,n,i){var r;const s=null!==(r=this.findAllNodesReferencedBetweenGCs(e,this.gcDataFromLastRun,i))&&void 0!==r?r:t.referencedNodeIds;this.newReferencesSinceLastRun.clear();for(const e of s){const t=this.unreferencedNodesState.get(e);void 0!==t&&(t.stopTracking(),this.unreferencedNodesState.delete(e))}const o=[];for(const e of t.deletedNodeIds){const t=this.unreferencedNodesState.get(e);void 0===t?this.unreferencedNodesState.set(e,new Rr(n,this.configs.inactiveTimeoutMs,n,this.configs.sweepTimeoutMs)):(t.updateTracking(n),t.state===ei&&o.push(e))}return o}runSweepPhase(e,t){const n=this.runtime.deleteSweepReadyNodes(e),i=this.deleteSweptRoutes(n,t);for(const e of n){const t=this.unreferencedNodesState.get(e);void 0!==t&&(t.stopTracking(),this.unreferencedNodesState.delete(e)),this.deletedNodes.add(e)}return i}deleteSweptRoutes(e,t){const n=new Set(e),i={};for(const[e,r]of Object.entries(t.gcNodes))n.has(e)||(i[e]=Array.from(r));return{gcNodes:i}}findAllNodesReferencedBetweenGCs(e,t,n){if(void 0===t)return;if(this.telemetryTracker.logIfMissingExplicitReferences(e,t,this.newReferencesSinceLastRun,n),0===this.newReferencesSinceLastRun.size)return;const i=function(e,t){const n=Wi(e);for(const[e,i]of Object.entries(t.gcNodes))if(void 0===n.gcNodes[e])n.gcNodes[e]=Array.from(i);else{const t=[...i,...n.gcNodes[e]];n.gcNodes[e]=[...new Set(t)]}return n}(t,e),r=[];return this.newReferencesSinceLastRun.forEach(((e,t)=>{void 0===i.gcNodes[t]?i.gcNodes[t]=e:i.gcNodes[t].push(...e),r.push(...e)})),Xi(i.gcNodes,["/",...r]).referencedNodeIds}generateStats(e){const t={nodeCount:0,dataStoreCount:0,attachmentBlobCount:0,unrefNodeCount:0,unrefDataStoreCount:0,unrefAttachmentBlobCount:0,updatedNodeCount:0,updatedDataStoreCount:0,updatedAttachmentBlobCount:0},n=(e,n)=>{t.nodeCount++;const i=void 0===this.gcDataFromLastRun||this.unreferencedNodesState.has(e)===n;i&&t.updatedNodeCount++,n||t.unrefNodeCount++,this.runtime.getNodeType(e)===Wn&&(t.dataStoreCount++,i&&t.updatedDataStoreCount++,n||t.unrefDataStoreCount++),this.runtime.getNodeType(e)===Qn&&(t.attachmentBlobCount++,i&&t.updatedAttachmentBlobCount++,n||t.unrefAttachmentBlobCount++)};for(const t of e.referencedNodeIds)n(t,!0);for(const t of e.deletedNodeIds)n(t,!1);return t}}class qr{constructor(e,t,n,i){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:this.batchEventEmitter=e,this.trackedBatchCount=0,this.logger=Rt.create(t,"Batching"),this.batchEventEmitter.on("batchBegin",(e=>{this.startBatchSequenceNumber=e.sequenceNumber,this.batchProcessingStartTimeStamp=r(),this.trackedBatchCount++})),this.batchEventEmitter.on("batchEnd",((e,t)=>{Object(he.a)(void 0!==this.startBatchSequenceNumber&&void 0!==this.batchProcessingStartTimeStamp,698);const s=t.sequenceNumber-this.startBatchSequenceNumber+1;s>=n&&this.logger.sendPerformanceEvent({eventName:"LengthTooBig",length:s,threshold:n,batchEndSequenceNumber:t.sequenceNumber,duration:r()-this.batchProcessingStartTimeStamp,batchError:void 0!==e}),this.trackedBatchCount%i==0&&this.logger.sendPerformanceEvent({eventName:"Length",length:s,samplingRate:i,batchEndSequenceNumber:t.sequenceNumber,duration:r()-this.batchProcessingStartTimeStamp}),this.startBatchSequenceNumber=void 0,this.batchProcessingStartTimeStamp=void 0}))}}class zr{constructor(e,t){this.logger=t,this.processingTimeIncrement=10,this.currentAllowedProcessingTimeForTurn=zr.processingTime,this.schedulingCount=0,this.deltaManager=e,this.deltaManager.inbound.on("idle",(()=>{this.inboundQueueIdle()}))}batchBegin(e){this.processingStartTime||(this.processingStartTime=Le.a.now()),void 0===this.schedulingLog&&this.schedulingCount%500==0&&(this.schedulingLog={opsRemainingToProcess:0,numberOfTurns:1,totalProcessingTime:0,numberOfBatchesProcessed:0,firstSequenceNumber:e.sequenceNumber,lastSequenceNumber:e.sequenceNumber,startTime:Le.a.now()})}batchEnd(e){if(this.schedulingLog&&(this.schedulingLog.numberOfBatchesProcessed++,this.schedulingLog.lastSequenceNumber=e.sequenceNumber,this.schedulingLog.opsRemainingToProcess=this.deltaManager.inbound.length),this.shouldRunScheduler()){const e=Le.a.now(),t=e-this.processingStartTime;t>this.currentAllowedProcessingTimeForTurn&&(this.deltaManager.inbound.pause(),this.currentAllowedProcessingTimeForTurn+=this.processingTimeIncrement,this.schedulingLog&&(this.schedulingLog.numberOfTurns++,this.schedulingLog.totalProcessingTime+=t),setTimeout((()=>{this.schedulingLog&&this.logger.sendTelemetryEvent({eventName:"InboundOpsPartialProcessingTime",duration:xt.formatTick(t),opsProcessed:this.schedulingLog.lastSequenceNumber-this.schedulingLog.firstSequenceNumber+1,opsRemainingToProcess:this.deltaManager.inbound.length,processingTime:xt.formatTick(this.schedulingLog.totalProcessingTime),numberOfTurns:this.schedulingLog.numberOfTurns,batchesProcessed:this.schedulingLog.numberOfBatchesProcessed,timeToResume:xt.formatTick(Le.a.now()-e)}),this.deltaManager.inbound.resume()})),this.processingStartTime=void 0)}}inboundQueueIdle(){if(this.schedulingLog){const e=Le.a.now();this.schedulingLog.totalProcessingTime+=e-this.processingStartTime,this.logger.sendTelemetryEvent({eventName:"InboundOpsProcessingTime",opsRemainingToProcess:this.schedulingLog.opsRemainingToProcess,numberOfTurns:this.schedulingLog.numberOfTurns,processingTime:xt.formatTick(this.schedulingLog.totalProcessingTime),opsProcessed:this.schedulingLog.lastSequenceNumber-this.schedulingLog.firstSequenceNumber+1,batchesProcessed:this.schedulingLog.numberOfBatchesProcessed,duration:xt.formatTick(e-this.schedulingLog.startTime),schedulingCount:this.schedulingCount}),this.schedulingLog=void 0}this.schedulingCount++,this.processingStartTime=void 0,this.currentAllowedProcessingTimeForTurn=zr.processingTime}zr.processingTime=50;class Br{constructor(e,t,n,i){this.deltaManager=e,this.emitter=t,this.getClientId=n,this.logger=i,this.hitError=!1,this.deltaScheduler=new zr(this.deltaManager,Rt.create(this.logger,"DeltaScheduler")),new Lr(e,n,i)}beforeOpProcessing(e){var t;if(this.batchClientId!==e.clientId){Object(he.a)(void 0===this.batchClientId,674),this.emitter.emit("batchBegin",e),this.deltaScheduler.batchBegin(e);const n=null===(t=null==e?void 0:e.metadata)||void 0===t?void 0:t.batch;this.batchClientId=n?e.clientId:void 0}}afterOpProcessing(e,t){var n;if(Object(he.a)(!this.hitError,675),e)return this.hitError=!0,this.batchClientId=void 0,this.emitter.emit("batchEnd",e,t),void this.deltaScheduler.batchEnd(t);const i=null===(n=null==t?void 0:t.metadata)||void 0===n?void 0:n.batch;return void 0===this.batchClientId||!1===i?(this.batchClientId=void 0,this.emitter.emit("batchEnd",void 0,t),void this.deltaScheduler.batchEnd(t)):void 0}}class Lr{constructor(e,t,n){this.deltaManager=e,this.getClientId=t,this.logger=n,this.localPaused=!1,this.timePaused=0,this.batchCount=0,this.deltaManager.on("prepareSend",(e=>{if(0===e.length)return;const t=e[0].metadata;if(!(null==t?void 0:t.batch))return;if(1===e.length)return void delete t.batch;const n=e[e.length-1];n.metadata=Object.assign(Object.assign({},n.metadata),{batch:!1})})),this.deltaManager.inbound.on("push",(e=>{this.trackPending(e)})),Object(he.a)(!this.localPaused,659);const i=this.deltaManager.inbound.toArray();for(const e of i)this.trackPending(e);this.deltaManager.on("op",()}afterOpProcessing(e){Object(he.a)(!this.localPaused,660),0!==this.deltaManager.inbound.length?void 0!==this.pauseSequenceNumber&&(Object(he.a)(e<this.pauseSequenceNumber,662),e+1===this.pauseSequenceNumber&&this.pauseQueue()):Object(he.a)(void 0===this.pauseSequenceNumber,661)}pauseQueue(){Object(he.a)(!this.localPaused,663),this.localPaused=!0,this.timePaused=Le.a.now(),this.deltaManager.inbound.pause()}resumeQueue(e,t){const n=t.sequenceNumber,i=this.localPaused?Le.a.now()-this.timePaused:void 0;this.batchCount++,this.batchCount%1e3==1&&this.logger.sendTelemetryEvent({eventName:"BatchStats",sequenceNumber:n,length:n-e+1,msnDistance:n-t.minimumSequenceNumber,duration:i,batchCount:this.batchCount,interrupted:this.localPaused}),this.localPaused&&(this.localPaused=!1,this.deltaManager.inbound.resume())}trackPending(e){Object(he.a)(0!==this.deltaManager.inbound.length,664),Object(he.a)(void 0===this.currentBatchClientId==(void 0===this.pauseSequenceNumber),665);const t=e.metadata,n=null==t?void 0:t.batch;if(!Object(hr.c)(e)){if(void 0!==this.currentBatchClientId)throw an.create("Received a system message during batch processing","trackPending",e,{runtimeVersion:Vn,batchClientId:this.currentBatchClientId,pauseSequenceNumber:this.pauseSequenceNumber,localBatch:this.currentBatchClientId===this.getClientId(),messageType:e.type});return Object(he.a)(void 0===n,667),void Object(he.a)(!this.localPaused,668)}if(void 0!==this.currentBatchClientId||void 0!==n){if(void 0!==this.currentBatchClientId&&this.currentBatchClientId!==e.clientId)throw new on("OpBatchIncomplete",Object.assign({runtimeVersion:Vn,batchClientId:this.currentBatchClientId,pauseSequenceNumber:this.pauseSequenceNumber,localBatch:this.currentBatchClientId===this.getClientId(),localMessage:e.clientId===this.getClientId()},cn(e)));n?(Object(he.a)(void 0===this.currentBatchClientId,670),Object(he.a)(!this.localPaused,671),this.pauseSequenceNumber=e.sequenceNumber,this.currentBatchClientId=e.clientId,1===this.deltaManager.inbound.length&&this.pauseQueue()):!1===n?(Object(he.a)(void 0!==this.pauseSequenceNumber,672),this.resumeQueue(this.pauseSequenceNumber,e),this.pauseSequenceNumber=void 0,this.currentBatchClientId=void 0):Object(he.a)(void 0!==this.currentBatchClientId,673)}else Object(he.a)(!this.localPaused,669)}}class Vr{constructor(e){this.groupedBatchingEnabled=e}groupBatch(e){if(e.content.length<2||!this.groupedBatchingEnabled)return e;for(const t of e.content){if(t.deserializedContent.type===ss.BlobAttach)return e;if(t.metadata){const e=Object.keys(t.metadata);Object(he.a)(e.length<2,1501),Object(he.a)(0===e.length||"batch"===e[0],1502)}}const t={type:Vr.groupedBatchOp,contents:e.content.map((e=>({contents:void 0===e.contents?void 0:JSON.parse(e.contents),metadata:e.metadata,compression:e.compression})))};return Object.assign(Object.assign({},e),{content:[{localOpMetadata:void 0,metadata:void 0,referenceSequenceNumber:e.content[0].referenceSequenceNumber,deserializedContent:t,contents:JSON.stringify(t)}]})}ungroupOp(e){var t;if((null===(t=e.contents)||void 0===t?void 0:t.type)!==Vr.groupedBatchOp)return[e];let n=1;return e.contents.contents.map((t=>Object.assign(Object.assign({},e),{clientSequenceNumber:n++,contents:t.contents,metadata:t.metadata,compression:t.compression})))}}Vr.groupedBatchOp="groupedBatch";class Ur{et length(){return this.pendingBatch.length}get contentSizeInBytes(){return this.batchContentSize}get sequenceNumbers(){return{referenceSequenceNumber:this.referenceSequenceNumber,clientSequenceNumber:this.clientSequenceNumber}}get referenceSequenceNumber(){return 0===this.pendingBatch.length?void 0:this.pendingBatch[this.pendingBatch.length-1].referenceSequenceNumber}push(e,t){var n,i;const r=this.batchContentSize+(null!==(i=null===(n=e.contents)||void 0===n?void 0:n.length)&&void 0!==i?i:0),s=r+200*this.pendingBatch.length;return!(void 0!==this.options.softLimit&&this.length>0&&s>=this.options.softLimit||s>=this.options.hardLimit||(0===this.pendingBatch.length&&(this.clientSequenceNumber=t),this.batchContentSize=r,this.pendingBatch.push(e),0))}get empty(){return 0===this.pendingBatch.length}popBatch(){const e={content:this.pendingBatch,contentSizeInBytes:this.batchContentSize,referenceSequenceNumber:this.referenceSequenceNumber};return this.pendingBatch=[],this.batchContentSize=0,this.clientSequenceNumber=void 0,Hr(e)}checkpoint(){const e=this.pendingBatch.length;return{rollback:t=>{var n,i;for(let r=this.pendingBatch.length;r>e;){r--;const e=this.pendingBatch[r];this.batchContentSize-=null!==(i=null===(n=e.contents)||void 0===n?void 0:n.length)&&void 0!==i?i:0,t(e)}this.pendingBatch.length=e}}}}const Hr=e=>(e.content.length>1&&(e.content[0].metadata=Object.assign(Object.assign({},e.content[0].metadata),{batch:!0}),e.content[e.content.length-1].metadata=Object.assign(Object.assign({},e.content[e.content.length-1].metadata),{batch:!1})),e),Gr=e=>e.contentSizeInBytes+200*e.content.length,$r=(e,t)=>!(void 0!==e.referenceSequenceNumber&&void 0!==t.referenceSequenceNumber&&e.referenceSequenceNumber!==t.referenceSequenceNumber||void 0!==e.clientSequenceNumber&&void 0!==t.clientSequenceNumber&&e.clientSequenceNumber!==t.clientSequenceNumber);class Kr{constructor(e,t,n,i,r){this.submitBatchFn=t,this.chunkSizeInBytes=n,this.maxBatchSizeInBytes=i,this.chunkMap=new Map(e),this.logger=Rt.create(r,"OpSplitter")}get isBatchChunkingEnabled(){return this.chunkSizeInBytes<Number.POSITIVE_INFINITY&&void 0!==this.submitBatchFn}get chunks(){return this.chunkMap}processRemoteMessage(e){if(e.type!==ss.ChunkedOp)return{message:e,state:"Skipped"};const t=e.clientId,n=e.contents;if(this.addChunk(t,n,e),n.chunkId<n.totalChunks)return{message:e,state:"Accepted"};const i=this.chunkMap.get(t).join("");this.clearPartialChunks(t);const r=Object.assign({},e);return r.contents=""===i?void 0:JSON.parse(i),r.type=n.originalType,r.metadata=n.originalMetadata,r.compression=n.originalCompression,{message:r,state:"Processed"}}clearPartialChunks(e){this.chunkMap.has(e)&&this.chunkMap.delete(e)}addChunk(e,t,n){let i=this.chunkMap.get(e);if(void 0===i&&(i=[],this.chunkMap.set(e,i)),t.chunkId!==i.length+1)throw new on("Chunk Id mismatch",Object.assign(Object.assign({},cn(n)),{chunkMapLength:i.length,chunkId:t.chunkId,totalChunks:t.totalChunks}));i.push(t.contents)}splitFirstBatchMessage(e){var t,n,i,r,s;Object(he.a)(this.isBatchChunkingEnabled,1299),Object(he.a)(e.contentSizeInBytes>0&&e.content.length>0,1300),Object(he.a)(void 0!==e.referenceSequenceNumber,1418),Object(he.a)(0!==this.chunkSizeInBytes,1301),Object(he.a)(this.chunkSizeInBytes<this.maxBatchSizeInBytes,1302);const o=e.content[0];Object(he.a)((null!==(n=null===(t=o.contents)||void 0===t?void 0:t.length)&&void 0!==n?n:0)>=this.chunkSizeInBytes,1304);const a=e.content.slice(1),c=Gr(e),l=Jr(o,this.chunkSizeInBytes,c>=this.maxBatchSizeInBytes);Object(he.a)(void 0!==this.submitBatchFn,1305);for(const t of l.slice(0,-1))this.submitBatchFn([Wr(t,e.referenceSequenceNumber)],e.referenceSequenceNumber);const d=Wr(l[l.length-1],e.referenceSequenceNumber,{batch:null===(i=o.metadata)||void 0===i?void 0:i.batch});return this.logger.sendPerformanceEvent({eventName:"CompressedChunkedBatch",length:e.content.length,sizeInBytes:e.contentSizeInBytes,chunks:l.length,chunkSizeInBytes:this.chunkSizeInBytes,socketSize:c}),{content:[d,...a],contentSizeInBytes:null!==(s=null===(r=d.contents)||void 0===r?void 0:r.length)&&void 0!==s?s:0,referenceSequenceNumber:e.referenceSequenceNumber}}}const Wr=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;const i={type:ss.ChunkedOp,contents:e};return{contents:JSON.stringify(i),deserializedContent:i,metadata:n,localOpMetadata:void 0,referenceSequenceNumber:t}},Jr=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i=[];Object(he.a)(null!=e.contents,1306);const r=e.contents.length,s=Math.floor((r-1)/t)+1+(n?1:0);let o=0;for(let n=1;n<=s;n++){const a={chunkId:n,contents:e.contents.substr(o,t),originalType:e.deserializedContent.type,totalChunks:s};n===s&&(a.originalMetadata=e.metadata,a.originalCompression=e.compression),i.push(a),o+=t,Object(he.a)(n>=s-1||o<=r,1419)}return Object(he.a)(o>=r,1420),Object(he.a)(i.length===s,1445),i};class Qr{constructor(e,t,n){this.opSplitter=e,this.opDecompressor=t,this.opGroupingManager=n}get partialMessages(){return this.opSplitter.chunks}clearPartialMessagesFor(e){this.opSplitter.clearPartialChunks(e)}process(e){const t=[];for(const n of this.opGroupingManager.ungroupOp(Xr(e))){const e=this.opDecompressor.processMessage(n).message;for(let n of this.opGroupingManager.ungroupOp(e)){Yr(n);const e=this.opSplitter.processRemoteMessage(n);if(n=e.message,"Processed"===e.state)for(const e of this.opGroupingManager.ungroupOp(n)){const n=this.opDecompressor.processMessage(e);for(const e of this.opGroupingManager.ungroupOp(n.message))"Skipped"!==n.state?(Zr(e),t.push(e)):t.push(e)}else t.push(n)}}return t}}const Xr=e=>{const t=Object.assign({},e);return"string"==typeof t.contents&&""!==t.contents&&(t.contents=JSON.parse(t.contents)),t},Zr=e=>{const t=e.contents;e.type=t.type,e.contents=t.contents};function Yr(e){return e.type===qe.a.Operation&&(void 0!==e.contents.address&&void 0===e.contents.type?e.type=ss.FluidDataStoreOp:Zr(e),!0)}var es=n("eVZi");class ts{constructor(e){this.activeBatch=!1,this.processedCount=0,this.logger=Rt.create(e,"OpDecompressor")}processMessage(e){var t,n,i,r;if(Object(he.a)(void 0===e.compression||e.compression===ms.lz4,1297),!0===(null===(t=e.metadata)||void 0===t?void 0:t.batch)&&this.isCompressed(e)){Object(he.a)(!1===this.activeBatch,1208),e.compression&&Object(he.a)(e.compression===ms.lz4,1209),this.activeBatch=!0;const t=yn.a.from(e.contents.packedContents,"base64"),n=Object(es.decompress)(t),i=Object(yn.b)(n),r=JSON.parse(i);return this.rootMessageContents=r,{message:ns(e,this.rootMessageContents[this.processedCount++]),state:"Accepted"}}if(void 0!==this.rootMessageContents&&void 0===(null===(n=e.metadata)||void 0===n?void 0:n.batch)&&this.activeBatch)return Object(he.a)(void 0===e.contents,1298),{message:ns(e,this.rootMessageContents[this.processedCount++]),state:"Accepted"};if(void 0!==this.rootMessageContents&&!1===(null===(i=e.metadata)||void 0===i?void 0:i.batch)){const t=ns(e,this.rootMessageContents[this.processedCount++]);return this.activeBatch=!1,this.rootMessageContents=void 0,this.processedCount=0,{message:t,state:"Processed"}}if(void 0===(null===(r=e.metadata)||void 0===r?void 0:r.batch)&&this.isCompressed(e)){Object(he.a)(!1===this.activeBatch,1210);const t=yn.a.from(e.contents.packedContents,"base64"),n=Object(es.decompress)(t),i=(new TextDecoder).decode(n),r=JSON.parse(i);return{message:ns(e,r[0]),state:"Processed"}}return{message:e,state:"Skipped"}}isCompressed(e){var t,n,i;if(e.compression===ms.lz4)return!0;try{if(null!==e.contents&&"object"==typeof e.contents&&1===Object.keys(e.contents).length&&void 0!==(null===(t=e.contents)||void 0===t?void 0:t.packedContents)&&"string"==typeof(null===(n=e.contents)||void 0===n?void 0:n.packedContents)&&e.contents.packedContents.length>0&&yn.a.from(e.contents.packedContents,"base64").toString("base64")===e.contents.packedContents)return this.logger.sendTelemetryEvent({eventName:"LegacyCompression",type:e.type,batch:null===(i=e.metadata)||void 0===i?void 0:i.batch}),!0}catch(e){return!1}return!1}}const ns=(e,t)=>Object.assign(Object.assign({},e),{contents:t,compression:void 0,metadata:Object.assign({},e.metadata)});class is{constructor(e){this.params=e,this.defaultAttachFlowSoftLimitInBytes=327680,this.maxMismatchedOpsToReport=3,this.mismatchedOpsReported=0,this.mc=Jt(Rt.create(e.logger,"Outbox"));const t=this.params.config.compressionOptions.minimumBatchSizeInBytes!==Number.POSITIVE_INFINITY,n=t?1/0:this.params.config.maxBatchSizeInBytes;this.attachFlowBatch=new Ur({hardLimit:n,softLimit:t?1/0:this.defaultAttachFlowSoftLimitInBytes}),this.mainBatch=new Ur({hardLimit:n})}aybeFlushPartialBatch(){const e=this.mainBatch.sequenceNumbers,t=this.attachFlowBatch.sequenceNumbers;Object(he.a)(this.params.config.disablePartialFlush||$r(e,t),1421);const n=this.params.getCurrentSequenceNumbers();$r(e,n)&&$r(t,n)||(++this.mismatchedOpsReported<=this.maxMismatchedOpsToReport&&this.mc.logger.sendTelemetryEvent({category:this.params.config.disablePartialFlush?"error":"generic",eventName:"ReferenceSequenceNumberMismatch",mainReferenceSequenceNumber:e.referenceSequenceNumber,mainClientSequenceNumber:e.clientSequenceNumber,attachReferenceSequenceNumber:t.referenceSequenceNumber,attachClientSequenceNumber:t.clientSequenceNumber,currentReferenceSequenceNumber:n.referenceSequenceNumber,currentClientSequenceNumber:n.clientSequenceNumber},function(e){try{const t=Error.stackTraceLimit;Error.stackTraceLimit=50;const n=e();return Error.stackTraceLimit=t,n}catch(t){return e()}}(()),this.params.config.disablePartialFlush||this.flush())}submit(e){var t,n;if(this.maybeFlushPartialBatch(),!this.mainBatch.push(e,this.params.getCurrentSequenceNumbers().clientSequenceNumber))throw new nn("BatchTooLarge",void 0,{opSize:null!==(n=null===(t=e.contents)||void 0===t?void 0:t.length)&&void 0!==n?n:0,batchSize:this.mainBatch.contentSizeInBytes,count:this.mainBatch.length,limit:this.mainBatch.options.hardLimit})}submitAttach(e){var t,n;if(this.maybeFlushPartialBatch(),!this.attachFlowBatch.push(e,this.params.getCurrentSequenceNumbers().clientSequenceNumber)&&(this.flushInternal(this.attachFlowBatch.popBatch()),!this.attachFlowBatch.push(e,this.params.getCurrentSequenceNumbers().clientSequenceNumber)))throw new nn("BatchTooLarge",void 0,{opSize:null!==(n=null===(t=e.contents)||void 0===t?void 0:t.length)&&void 0!==n?n:0,batchSize:this.attachFlowBatch.contentSizeInBytes,count:this.attachFlowBatch.length,limit:this.attachFlowBatch.options.hardLimit});this.attachFlowBatch.contentSizeInBytes>=this.params.config.compressionOptions.minimumBatchSizeInBytes&&this.flushInternal(this.attachFlowBatch.popBatch())}flushlushInternal(e){const t=this.compressBatch(e);this.sendBatch(t),this.persistBatch(e.content)}compressBatch(e){if(0===e.content.length||void 0===this.params.config.compressionOptions||this.params.config.compressionOptions.minimumBatchSizeInBytes>e.contentSizeInBytes||void 0===this.params.containerContext.submitBatchFn)return this.params.groupingManager.groupBatch(e);const t=this.params.compressor.compressBatch(this.params.groupingManager.groupBatch(e));if(this.params.splitter.isBatchChunkingEnabled)return t.contentSizeInBytes<=this.params.splitter.chunkSizeInBytes?t:this.params.splitter.splitFirstBatchMessage(t);if(t.contentSizeInBytes>=this.params.config.maxBatchSizeInBytes)throw new nn("BatchTooLarge",void 0,{batchSize:e.contentSizeInBytes,compressedBatchSize:t.contentSizeInBytes,count:t.content.length,limit:this.params.config.maxBatchSizeInBytes,chunkingEnabled:this.params.splitter.isBatchChunkingEnabled,compressionOptions:JSON.stringify(this.params.config.compressionOptions),socketSize:Gr(e)});return t}sendBatch(e){if(0===e.content.length||!this.params.shouldSend())return;const t=Gr(e);if(t>=this.params.config.maxBatchSizeInBytes&&this.mc.logger.sendPerformanceEvent({eventName:"LargeBatch",length:e.content.length,sizeInBytes:e.contentSizeInBytes,socketSize:t}),void 0===this.params.containerContext.submitBatchFn){Object(he.a)(void 0===e.content[0].compression,1446);for(const t of e.content)this.params.containerContext.submitFn(qe.a.Operation,t.deserializedContent,!0,t.metadata);this.params.containerContext.deltaManager.flush()}else Object(he.a)(void 0!==e.referenceSequenceNumber,1422),this.params.containerContext.submitBatchFn(e.content.map((),e.referenceSequenceNumber)}persistBatch(e){for(const t of e)this.params.pendingStateManager.onSubmitMessage(t.deserializedContent.type,t.referenceSequenceNumber,t.deserializedContent.contents,t.localOpMetadata,t.metadata)}class rs{ompressBatch(e){Object(he.a)(e.contentSizeInBytes>0&&e.content.length>0,1444);const t=Date.now(),n=(new TextEncoder).encode(this.serializeBatch(e)),i=Object(es.compress)(n),r=yn.a.from(i).toString("base64"),s=Date.now()-t,o=[];o.push(Object.assign(Object.assign({},e.content[0]),{contents:JSON.stringify({packedContents:r}),metadata:e.content[0].metadata,compression:ms.lz4}));for(const t of e.content.slice(1))o.push({deserializedContent:{contents:void 0,type:t.deserializedContent.type},localOpMetadata:t.localOpMetadata,metadata:t.metadata,referenceSequenceNumber:t.referenceSequenceNumber});const a={contentSizeInBytes:r.length,content:o,referenceSequenceNumber:e.referenceSequenceNumber};return e.contentSizeInBytes>2e5&&this.logger.sendPerformanceEvent({eventName:"CompressedBatch",duration:s,sizeBeforeCompression:e.contentSizeInBytes,sizeAfterCompression:a.contentSizeInBytes,opCount:a.content.length,socketSize:Gr(a)}),a}serializeBatch(e){try{return JSON.stringify(e.content.map((e=>e.deserializedContent)))}catch(t){if("Invalid string length"===t.message){const t=new rn("Payload too large");throw this.logger.sendErrorEvent({eventName:"BatchTooLarge",size:e.contentSizeInBytes,length:e.content.length},t),t}throw t}}}var ss,os=n("+Ega");class as extends os.a{et IDeltaSender(){return this}get inbound(){return this.deltaManager.inbound}get outbound(){return this.deltaManager.outbound}get inboundSignal(){return this.deltaManager.inboundSignal}get minimumSequenceNumber(){return this.deltaManager.minimumSequenceNumber}get lastSequenceNumber(){return this.deltaManager.lastSequenceNumber}get lastMessage(){return this.deltaManager.lastMessage}get lastKnownSeqNumber(){return this.deltaManager.lastKnownSeqNumber}get initialSequenceNumber(){return this.deltaManager.initialSequenceNumber}get hasCheckpointSequenceNumber(){return this.deltaManager.hasCheckpointSequenceNumber}get clientDetails(){return this.deltaManager.clientDetails}get version(){return this.deltaManager.version}get maxMessageSize(){return this.deltaManager.maxMessageSize}get serviceConfiguration(){return this.deltaManager.serviceConfiguration}get active(){return this.deltaManager.active}get readOnlyInfo(){return this.deltaManager.readOnlyInfo}dispose(){super.dispose()}submitSignal(e){return this.deltaManager.submitSignal(e)}flush(){return this.deltaManager.flush()}}class cs extends as{constructor(e){super(e),this.isSummarizerClient=this.deltaManager.clientDetails.type===oi}et readOnlyInfo(){return this.isSummarizerClient?{readonly:!0,forced:!1,permissions:void 0,storageOnly:!1}:this.deltaManager.readOnlyInfo}}!function(e){e.FluidDataStoreOp="component",e.Attach="attach",e.ChunkedOp="chunkedOp",e.BlobAttach="blobAttach",e.Rejoin="rejoin",e.Alias="alias",e.IdAllocation="idAllocation"}(ss||(ss={}));const ls={state:"enabled",minIdleTime:0,maxIdleTime:3e4,maxTime:6e4,maxOps:100,minOpsForLastSummaryAttempt:10,maxAckWaitTime:18e4,maxOpsSinceLastSummary:7e3,initialSummarizerDelayMs:5e3,nonRuntimeOpWeight:.1,runtimeOpWeight:1,nonRuntimeHeuristicThreshold:20};var ds;!function(e){e.wait="wait",e.viaHandle="viaHandle"}(ds||(ds={}));const us="isTombstoned",hs={wait:!0,viaHandle:!1,allowTombstone:!1};var ms;!ms||(ms={}));const gs=dn.FlushMode.TurnBased,ps=716800,fs={minimumBatchSizeInBytes:614400,compressionAlgorithm:ms.lz4},vs=204800;var ys;!ys||(ys={}));const bs="_scheduler";class Ss extends me.a{constructor(e,t,n,i,r,s,o,a,c,l,d,u,h,m,g,p){var f,v,y,b,S,C,w,O,I,N,T;let E;void 0===g&&(g=Object.assign(Object.assign({},ls),null===(v=o.summaryOptions)||void 0===v?void 0:v.summaryConfigOverrides)),super(),f=this,this.context=e,this.registry=t,this.runtimeOptions=o,this.containerScope=a,this.logger=c,this._storage=u,this.requestHandler=m,this.summaryConfiguration=g,this.defaultMaxConsecutiveReconnects=7,this._orderSequentiallyCalls=0,this.flushTaskExists=!1,this.consecutiveReconnects=0,this.ensureNoDataModelChangesCalls=0,this.opReentryCallsToReport=5,this._disposed=!1,this.emitDirtyDocumentEvent=!0,this.defaultTelemetrySignalSampleCount=100,this._perfSignalData={signalsLost:0,signalSequenceNumber:0,signalTimestamp:0,trackingSignalSequenceNumber:void 0},this.summarizeOnDemand=function(){if(f.clientDetails.type===oi)return f.summarizer.summarizeOnDemand(...arguments);if(void 0!==f.summaryManager)return f.summaryManager.summarizeOnDemand(...arguments);throw new rn(`Can't summarize, disableSummaries: ${f.summariesDisabled}`)},this.enqueueSummarize=function(){if(f.clientDetails.type===oi)return f.summarizer.enqueueSummarize(...arguments);if(void 0!==f.summaryManager)return f.summaryManager.enqueueSummarize(...arguments);throw new rn(`Can't summarize, disableSummaries: ${f.summariesDisabled}`)},this.innerDeltaManager=e.deltaManager,this.deltaManager=new cs(e.deltaManager),this.mc=Jt(Rt.create(this.logger,"ContainerRuntime")),l?(this.createContainerMetadata={createContainerRuntimeVersion:null==n?void 0:n.createContainerRuntimeVersion,createContainerTimestamp:null==n?void 0:n.createContainerTimestamp},E=null!==(y=null==n?void 0:n.summaryNumber)&&void 0!==y?y:0,this.idCompressorEnabled=null!==(b=null==n?void 0:n.idCompressorEnabled)&&void 0!==b&&b):(this.createContainerMetadata={createContainerRuntimeVersion:Vn,createContainerTimestamp:Date.now()},E=0,this.idCompressorEnabled=null!==(S=this.mc.config.getBoolean("Fluid.ContainerRuntime.IdCompressorEnabled"))&&void 0!==S?S:void 0!==h),this.nextSummaryNumber=E+1,this.messageAtLastSummary=null==n?void 0:n.message,this._connected=this.context.connected,this.gcTombstoneEnforcementAllowed=null===(C=null==n?void 0:n.gcFeatureMatrix)||void 0===C?void 0:C.tombstoneGeneration,this.runtimeOptions.gcOptions.gcTombstoneGeneration),this.mc.logger.sendTelemetryEvent({eventName:"GCFeatureMatrix",metadataValue:JSON.stringify(null==n?void 0:n.gcFeatureMatrix),inputs:JSON.stringify({gcOptions_gcTombstoneGeneration:this.runtimeOptions.gcOptions.gcTombstoneGeneration})}),this.telemetryDocumentId=null!==(w=null==n?void 0:n.telemetryDocumentId)&&void 0!==w?w:Object(ge.a)(),this.disableAttachReorder=this.mc.config.getBoolean("Fluid.ContainerRuntime.disableAttachOpReorder");const k=this.mc.config.getBoolean("Fluid.ContainerRuntime.CompressionChunkingDisabled"),j=new Vr(this.groupedBatchingEnabled),P=new Kr(r,this.context.submitBatchFn,!0===k?Number.POSITIVE_INFINITY:o.chunkSizeInBytes,o.maxBatchSizeInBytes,this.mc.logger);this.remoteMessageProcessor=new Qr(P,new ts(this.mc.logger),j),this.handleContext=new Fn("",this),"enabled"===this.summaryConfiguration.state&&this.validateSummaryHeuristicConfiguration(this.summaryConfiguration);const _=this.mc.config.getBoolean("Fluid.ContainerRuntime.DisableOpReentryCheck");this.enableOpReentryCheck=!0===o.enableOpReentryCheck&&!0!==_,this.summariesDisabled=this.isSummariesDisabled(),this.heuristicsDisabled=this.isHeuristicsDisabled(),this.maxOpsSinceLastSummary=this.getMaxOpsSinceLastSummary(),this.initialSummarizerDelayMs=this.getInitialSummarizerDelayMs(),this.idCompressorEnabled&&(this.idCompressor=h),this.maxConsecutiveReconnects=null!==(O=this.mc.config.getNumber("Fluid.ContainerRuntime.MaxConsecutiveReconnects"))&&void 0!==O?O:this.defaultMaxConsecutiveReconnects,o.flushMode===dn.FlushModeExperimental.Async&&!0!==(null===(I=e.supportedFeatures)||void 0===I?void 0:I.get("referenceSequenceNumbers"))?(this.mc.logger.sendErrorEvent({eventName:"FlushModeFallback"}),this._flushMode=dn.FlushMode.TurnBased):this._flushMode=o.flushMode;const M=e.pendingLocalState,D=null===(T=null===(N=this._storage)||void 0===N?void 0:N.policies)||void 0===T?void 0:T.maximumCacheDurationMs;if(void 0!==D&&D>432e6)throw new rn("Driver's maximumCacheDurationMs policy cannot exceed 5 days");this.garbageCollector=Fr.create({runtime:this,gcOptions:this.runtimeOptions.gcOptions,baseSnapshot:e.baseSnapshot,baseLogger:this.mc.logger,existing:l,metadata:n,createContainerMetadata:this.createContainerMetadata,isSummarizerClient:this.context.clientDetails.type===oi,getNodePackagePath:async e=>this.getGCNodePackagePath(e),getLastSummaryTimestampMs:()=>{var e;return null===(e=this.messageAtLastSummary)||void 0===e?void 0:e.timestamp},readAndParseBlob:async e=>Object(Fe.a)(this.storage,e),getContainerDiagnosticId:()=>this.context.id,activeConnection:()=>this.innerDeltaManager.active});const x=this.deltaManager.initialSequenceNumber;this.summarizerNode=function(e,t,n,i){let r=arguments.length>5?arguments[5]:void 0,s=arguments.length>6?arguments[6]:void 0;return new ir(e,t,arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},n,void 0===i?void 0:Yi.createForRoot(i),void 0,void 0,r,s,"")}(Rt.create(this.logger,"SummarizerNode"),(async(e,t,n)=>this.summarizeInternal(e,t,n)),x,e.baseSnapshot?x:void 0,{canReuseHandle:!1,throwOnFailure:!0,gcDisabled:!this.garbageCollector.shouldRunGC},(async e=>this.getGCDataInternal(e)),(),e.baseSnapshot&&this.summarizerNode.updateBaseSummaryState(e.baseSnapshot),this.dataStores=new Hi(function(e,t){if(e){if(t)){const t=e.trees[dn.channelsTreeName];return Object(he.a)(!!t,360),t}{const t={};for(const[n,i]of Object.entries(e.trees))ki.includes(n)||(t[n]=i);return Object.assign(Object.assign({},e),{trees:t})}}}(e.baseSnapshot,n),this,(,((e,t)=>(n,i)=>this.summarizerNode.createChild(n,e,t,void 0,i)),(e=>this.summarizerNode.deleteChild(e)),this.mc.logger,((e,t,n)=>this.garbageCollector.nodeUpdated(e,"Changed",t,n)),(e=>this.garbageCollector.isNodeDeleted(e)),new Map(s)),this.blobManager=new ui(this.handleContext,d,(()=>this.storage),((e,t)=>{this.disposed||this.submit(ss.BlobAttach,void 0,void 0,{localId:e,blobId:t})}),(,(,this,null==M?void 0:M.pendingAttachmentBlobs,(e=>this.closeFn(e))),this.scheduleManager=new Br(e.deltaManager,this,(()=>this.clientId),Rt.create(this.logger,"ScheduleManager")),this.pendingStateManager=new Un({applyStashedOp:this.applyStashedOp.bind(this),clientId:()=>this.clientId,close:this.closeFn,connected:()=>this.connected,reSubmit:this.reSubmit.bind(this),rollback:this.rollback.bind(this),orderSequentially:this.orderSequentially.bind(this)},null==M?void 0:M.pending);const A=this.mc.config.getBoolean("Fluid.ContainerRuntime.CompressionDisabled"),R=!0===A?{minimumBatchSizeInBytes:Number.POSITIVE_INFINITY,compressionAlgorithm:ms.lz4}:o.compressionOptions,F=this.mc.config.getBoolean("Fluid.ContainerRuntime.DisablePartialFlush");this.outbox=new is({shouldSend:()=>this.canSendOps(),pendingStateManager:this.pendingStateManager,containerContext:this.context,compressor:new rs(this.mc.logger),splitter:P,config:{compressionOptions:R,maxBatchSizeInBytes:o.maxBatchSizeInBytes,disablePartialFlush:!0===F},logger:this.mc.logger,groupingManager:j,getCurrentSequenceNumbers:),this.context.quorum.on("removeMember",(),this.summaryStateUpdateMethod=this.mc.config.getString("Fluid.ContainerRuntime.Test.SummaryStateUpdateMethod");const q=this.mc.config.getNumber("Fluid.ContainerRuntime.Test.CloseSummarizerDelayOverrideMs");if(this.closeSummarizerDelayMs=null!=q?q:1e4,this.summaryCollection=new or(this.deltaManager,this.logger),this.dirtyContainer=this.context.attachState!==et.Attached||this.pendingStateManager.hasPendingMessages(),this.context.updateDirtyContainerState(this.dirtyContainer),this.summariesDisabled)this.mc.logger.sendTelemetryEvent({eventName:"SummariesDisabled"});else{const e=Rt.create(this.logger,"OrderedClientElection"),t=new ar(e,this.context.deltaManager,this.context.quorum),n=new cr(e,t,null!=i?i:this.context.deltaManager.lastSequenceNumber,ai.isClientEligible);if(this.summarizerClientElection=new ai(e,this.summaryCollection,n,this.maxOpsSinceLastSummary),this.context.clientDetails.type===oi)this._summarizer=new Tr(this,(()=>this.summaryConfiguration),this,this.handleContext,this.summaryCollection,(async e=>Er.create(e,(()=>this.innerDeltaManager.active))));else if(ai.clientDetailsPermitElection(this.context.clientDetails)){const e=()=>{this.summaryCollection.opsSinceLastAck>this.maxOpsSinceLastSummary&&(this.logger.sendTelemetryEvent({eventName:"SummaryStatus:Behind"}),this.summaryCollection.once(qe.a.SummaryAck,(()=>{this.logger.sendTelemetryEvent({eventName:"SummaryStatus:CaughtUp"}),this.summaryCollection.on("default",e)})),this.summaryCollection.off("default",e))};this.summaryCollection.on("default",e),this.summaryManager=new _r(this.summarizerClientElection,this,this.summaryCollection,this.logger,this.formRequestSummarizerFn(this.context.loader),new ri(6e4,3e4,si({coefficient:20,initialDelay:0})),{initialDelayMs:this.initialSummarizerDelayMs},this.heuristicsDisabled),this.summaryManager.start()}}this.deltaManager.on("readonly",(e=>{Object(he.a)(e===this.innerDeltaManager.readOnlyInfo.readonly,292),Object(he.a)(!e||!this.connected,293),this.replayPendingStates()})),c.sendTelemetryEvent(Object.assign({eventName:"DeviceSpec"},function(){try{if("object"==typeof navigator&&null!==navigator)return{deviceMemory:navigator.deviceMemory,hardwareConcurrency:navigator.hardwareConcurrency}}catch(e){}return{}}())),this.logger.sendTelemetryEvent(Object.assign(Object.assign(Object.assign({eventName:"ContainerLoadStats"},this.createContainerMetadata),this.dataStores.containerLoadStats),{summaryNumber:E,summaryFormatVersion:null==n?void 0:n.summaryFormatVersion,disableIsolatedChannels:null==n?void 0:n.disableIsolatedChannels,gcVersion:null==n?void 0:n.gcFeature,options:JSON.stringify(o),featureGates:JSON.stringify({disableCompression:A,disableOpReentryCheck:_,disableChunking:k,disableAttachReorder:this.disableAttachReorder,disablePartialFlush:F,idCompressorEnabled:this.idCompressorEnabled,summaryStateUpdateMethod:this.summaryStateUpdateMethod,closeSummarizerDelayOverride:q}),telemetryDocumentId:this.telemetryDocumentId,groupedBatchingEnabled:this.groupedBatchingEnabled})),this.context.clientId,this.deltaManager,this.logger),function(e,t){new qr(e,t,arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3,arguments.length>3&&void 0!==arguments[3]?arguments[3]:1e3)}(this,this.logger),this.entryPoint=new lt.b((async()=>this.context.clientDetails.type===oi?(Object(he.a)(void 0!==this._summarizer,1471),this._summarizer):null==p?void 0:p(this)))}get IContainerRuntime(){return this}get IFluidRouter(){return this}static async load(e,t,n){let i=!0;return(arguments.length>5?arguments[5]:void 0)||(i=!1),this.loadRuntime({context:e,registryEntries:t,existing:i,requestHandler:n,runtimeOptions:arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},containerScope:arguments.length>4&&void 0!==arguments[4]?arguments[4]:e.scope,containerRuntimeCtor:arguments.length>6&&void 0!==arguments[6]?arguments[6]:Ss})}static async loadRuntime(e){var t,i,r,s,o,a;const{context:c,registryEntries:l,existing:d,requestHandler:u,runtimeOptions:h={},containerScope:m={},containerRuntimeCtor:g=Ss,initializeEntryPoint:p}=e,f=null!==(t=c.taggedLogger)&&void 0!==t?t:new At(c.logger),v=Rt.create(f,void 0,{all:{runtimeVersion:Vn}}),{summaryOptions:y={},gcOptions:b={},loadSequenceNumberVerification:S="close",flushMode:C=gs,compressionOptions:w=fs,maxBatchSizeInBytes:O=ps,enableRuntimeIdCompressor:I=!1,chunkSizeInBytes:N=vs,enableOpReentryCheck:T=!1,enableGroupedBatching:E=!1}=h,k=new qn(l),j=async e=>{var t;const n=null===(t=c.baseSnapshot)||void 0===t?void 0:t.blobs[e];if(c.baseSnapshot&&n)return Object(he.a)(void 0!==c.storage,501),Object(Fe.a)(c.storage,n)},[P,_,M,D,x]=await Promise.all([j(Ni),j(Ii),j(Ti),j(Oi),j(Ei)]),A=!0===d||!0===c.existing,R=await ui.load(null===(i=c.baseSnapshot)||void 0===i?void 0:i.trees[".blobs"],(async e=>(Object(he.a)(void 0!==c.storage,598),Object(Fe.a)(c.storage,e)))),F=null===(r=null==_?void 0:_.message)||void 0===r?void 0:r.sequenceNumber;if(!c.pendingLocalState&&void 0!==F){const e=c.deltaManager.initialSequenceNumber;if("bypass"!==S&&F!==e){const t=new on("Summary metadata mismatch",{runtimeVersion:Vn,runtimeSequenceNumber:F,protocolSequenceNumber:e});"log"===S?v.sendErrorEvent({eventName:"SequenceNumberMismatch"},t):(c.closeFn(t),null===(s=c.disposeFn)||void 0===s||s.call(c,t))}}let q;if(null!==(a=null!==(o=null==_?void 0:_.idCompressorEnabled)&&void 0!==o?o:h.enableRuntimeIdCompressor)&&void 0!==a&&a){const{IdCompressor:e,createSessionId:t}=await n.e(129).then(n.bind(null,"Zd4/"));q=void 0!==x?e.deserialize(x,t()):new e(t(),v)}const z=new g(c,k,_,M,null!=P?P:[],null!=D?D:[],{summaryOptions:y,gcOptions:b,loadSequenceNumberVerification:S,flushMode:C,compressionOptions:w,maxBatchSizeInBytes:O,chunkSizeInBytes:N,enableRuntimeIdCompressor:I,enableOpReentryCheck:T,enableGroupedBatching:E},m,v,A,R,c.storage,q,u,void 0,p);return await z.pendingStateManager.applyStashedOpsAt(0),await z.initializeBaseState(),z}get options(){return this.context.options}get clientId(){return this.context.clientId}get clientDetails(){return this.context.clientDetails}get storage(){return this._storage}get reSubmitFn(){return this.reSubmit}et closeFn(){return e=>{var t,n;this.context.closeFn(e),null===(n=(t=this.context).disposeFn)||void 0===n||n.call(t,e)}}get flushMode(){return this._flushMode}get scope(){return this.containerScope}get IFluidDataStoreRegistry(){return this.registry}get attachState(){return this.context.attachState}get IFluidHandleContext(){return this.handleContext}ensureNoDataModelChanges(e){this.ensureNoDataModelChangesCalls++;try{return e()}finally{this.ensureNoDataModelChangesCalls--}}get connected(){return this._connected}get summarizerClientId(){var e;return null===(e=this.summarizerClientElection)||void 0===e?void 0:e.electedClientId}get disposed(){return this._disposed}get summarizer(){return Object(he.a)(void 0!==this._summarizer,599),this._summarizer}isSummariesDisabled(){return"disabled"===this.summaryConfiguration.state}etMaxOpsSinceLastSummaryetInitialSummarizerDelayMs(){return void 0!==this.runtimeOptions.summaryOptions.initialSummarizerDelayMs?this.runtimeOptions.summaryOptions.initialSummarizerDelayMs:"disabled"!==this.summaryConfiguration.state?this.summaryConfiguration.initialSummarizerDelayMs:0}ispose(e){var t;this._disposed||(this._disposed=!0,this.logger.sendTelemetryEvent({eventName:"ContainerRuntimeDisposed",isDirty:this.isDirty,lastSequenceNumber:this.deltaManager.lastSequenceNumber,attachState:this.attachState},e),void 0!==this.summaryManager&&this.summaryManager.dispose(),this.garbageCollector.dispose(),null===(t=this._summarizer)||void 0===t||t.dispose(),this.dataStores.dispose(),this.pendingStateManager.dispose(),this.emit("dispose"),this.removeAllListeners())}async request(e){try{const t=un.create(e);return"_summarizer"===t.pathParts[0]&&1===t.pathParts.length?void 0!==this._summarizer?{status:200,mimeType:"fluid/object",value:this.summarizer}:fn(e):void 0!==this.requestHandler?this.requestHandler(t,this):fn(e)}catch(e){return hn(e)}}async resolveHandle(e){try{const t=un.create(e),n=t.pathParts[0];if("_channels"===n)return this.resolveHandle(t.createSubRequest(1));if(n===ui.basePath&&t.isLeaf(2)){const n=await this.blobManager.getBlob(t.pathParts[1]);return n?{status:200,mimeType:"fluid/object",value:n}:fn(e)}if(t.pathParts.length>0){const i=await this.getDataStoreFromRequest(n,e),r=t.createSubRequest(1);return Object(he.a)(r.url.startsWith("/"),294),i.IFluidRouter.request(r)}return fn(e)}catch(e){return hn(e)}}async getEntryPoint(){return this.entryPoint}internalId(e){var t;return null!==(t=this.dataStores.aliases.get(e))&&void 0!==t?t:e}async getDataStoreFromRequest(e,t){var n,i,r;const s={};"boolean"==typeof(null===(n=t.headers)||void 0===n?void 0:n[ds.wait])&&(s.wait=t.headers[ds.wait]),"boolean"==typeof(null===(i=t.headers)||void 0===i?void 0:i[ds.viaHandle])&&(s.viaHandle=t.headers[ds.viaHandle]),"boolean"==typeof(null===(r=t.headers)||void 0===r?void 0:r.allowTombstone)&&(s.allowTombstone=t.headers.allowTombstone),await this.dataStores.waitIfPendingAlias(e);const o=this.internalId(e),a=await this.dataStores.getDataStore(o,s),c=await a.realize(),l=function(e){return e.replace(/^\/+|\/+$/g,"")}(t.url.split("?")[0]);return this.garbageCollector.nodeUpdated(`/${l}`,"Loaded",void 0,a.packagePath,null==t?void 0:t.headers),c}addMetadataToSummary(e){var t;const n=Object.assign(Object.assign(Object.assign(Object.assign({},this.createContainerMetadata),{summaryNumber:this.nextSummaryNumber++,summaryFormatVersion:1}),this.garbageCollector.getMetadata()),{message:null!==(t=wi(this.deltaManager.lastMessage))&&void 0!==t?t:this.messageAtLastSummary,telemetryDocumentId:this.telemetryDocumentId,idCompressorEnabled:!!this.idCompressorEnabled||void 0});Tn(e,Ii,JSON.stringify(n))}addContainerStateToSummary(e,t,n,i){var r;if(this.addMetadataToSummary(e),this.idCompressorEnabled){Object(he.a)(void 0!==this.idCompressor,1658);const t=JSON.stringify(this.idCompressor.serialize(!1));Tn(e,Ei,t)}if(this.remoteMessageProcessor.partialMessages.size>0){const t=JSON.stringify([...this.remoteMessageProcessor.partialMessages]);Tn(e,Ni,t)}const s=this.dataStores.aliases;if(s.size>0&&Tn(e,Oi,JSON.stringify([...s])),this.summarizerClientElection){const t=JSON.stringify(null===(r=this.summarizerClientElection)||void 0===r?void 0:r.serialize());Tn(e,Ti,t)}const o=this.blobManager.summarize();Object.keys(o.summary.tree).length>0&&function(e,t,n){e.summary.tree[".blobs"]=n.summary,e.stats=wn(e.stats,n.stats)}(e,0,o);const a=this.garbageCollector.summarize(t,n,i);void 0!==a&&function(e,t,n){e.summary.tree[t]=n.summary,e.stats=wn(e.stats,n.stats)}(e,dn.gcTreeKey,a)}shouldContinueReconnecting(){return this.maxConsecutiveReconnects<=0||(this.hasPendingMessages()?(this.consecutiveReconnects===Math.floor(this.maxConsecutiveReconnects/2)&&this.mc.logger.sendTelemetryEvent({eventName:"ReconnectsWithNoProgress",attempts:this.consecutiveReconnects,pendingMessages:this.pendingStateManager.pendingMessagesCount}),this.consecutiveReconnects<this.maxConsecutiveReconnects):(this.resetReconnectCount(),!0))}resetReconnectCount(){this.consecutiveReconnects=0}replayPendingStates(){if(!this.canSendOps())return;const e=this.dirtyContainer;let t;this.dirtyContainer=!1,Object(he.a)(this.emitDirtyDocumentEvent,295),this.emitDirtyDocumentEvent=!1;try{this.pendingStateManager.replayPendingStates()}finally{t=this.dirtyContainer,this.dirtyContainer=e,this.emitDirtyDocumentEvent=!0}this.updateDocumentDirtyState(t)}async applyStashedIdAllocationOp(e){const{IdCompressor:t}=await n.e(129).then(n.bind(null,"Zd4/"));this.idCompressor=t.deserialize(e.stashedState)}async applyStashedOp(e,t){switch(e){case ss.FluidDataStoreOp:return this.dataStores.applyStashedOp(t);case ss.Attach:return this.dataStores.applyStashedAttachOp(t);case ss.IdAllocation:return Object(he.a)(void 0!==this.idCompressor,1659),this.applyStashedIdAllocationOp(t);case ss.Alias:case ss.BlobAttach:return;case ss.ChunkedOp:throw new Error("chunkedOp not expected here");case ss.Rejoin:throw new Error("rejoin not expected here");default:Object(dt.a)(e,`Unknown ContainerMessageType: ${e}`)}}setConnectionState(e,t){return!1===e&&void 0!==this.delayConnectClientId?(this.delayConnectClientId=void 0,void this.mc.logger.sendTelemetryEvent({eventName:"UnsuccessfulConnectedTransition"})):e&&!this._connected&&!this.innerDeltaManager.readOnlyInfo.readonly&&this.blobManager.hasPendingOfflineUploads?(Object(he.a)(!this.delayConnectClientId,914),Object(he.a)(!!t,915),this.delayConnectClientId=t,void this.blobManager.onConnected().then((()=>{this.delayConnectClientId!==t||this.disposed||(this.delayConnectClientId=void 0,this.setConnectionStateCore(e,t))}),(e=>this.closeFn(e)))):void this.setConnectionStateCore(e,t)}setConnectionStateCore(e,t){Object(he.a)(!this.delayConnectClientId,916),this.verifyNotClosed();const n=this._connected!==e,i=n&&!e;this._connected=e,e?Object(he.a)(this.attachState===et.Attached,973):(this._perfSignalData.signalsLost=0,this._perfSignalData.signalTimestamp=0,this._perfSignalData.trackingSignalSequenceNumber=void 0),!i||(this.consecutiveReconnects++,this.shouldContinueReconnecting())?(n&&this.replayPendingStates(),this.dataStores.setConnectionState(e,t),this.garbageCollector.setConnectionState(e,t),function(e,t,n,i,r){try{n?t.emit("connected",i):t.emit("disconnected",void 0)}catch(t){e.sendErrorEvent({eventName:"RaiseConnectedEventError"},t)}}(this.mc.logger,this,e,t)):this.closeFn(an.create("Runtime detected too many reconnects with no progress syncing local ops.","setConnectionState",void 0,{dataLoss:1,attempts:this.consecutiveReconnects,pendingMessages:this.pendingStateManager.pendingMessagesCount}))}async notifyOpReplay(e){await this.pendingStateManager.applyStashedOpsAt(e.sequenceNumber)}process(e,t){this.verifyNotClosed();const n=e.type===qe.a.Operation,i=Object.assign({},e);for(const e of this.remoteMessageProcessor.process(i))this.processCore(e,t,n)}processCore(e,t,n){var i;this.scheduleManager.beforeOpProcessing(e),this._processedClientSequenceNumber=e.clientSequenceNumber;try{let r;switch(t&&n&&e.type!==ss.ChunkedOp&&(r=this.pendingStateManager.processPendingLocalMessage(e)),this.hasPendingMessages()||this.updateDocumentDirtyState(!1),e.type){case ss.Attach:this.dataStores.processAttachMessage(e,t);break;case ss.Alias:this.processAliasMessage(e,r,t);break;case ss.FluidDataStoreOp:this.dataStores.processFluidDataStoreOp(e,t,r);break;case ss.BlobAttach:this.blobManager.processBlobAttachOp(e,t);break;case ss.IdAllocation:Object(he.a)(void 0!==this.idCompressor,1660),this.idCompressor.finalizeCreationRange(e.contents);break;case ss.ChunkedOp:case ss.Rejoin:break;default:if(n){const n=an.create("Runtime message of unknown type","OpProcessing",e,{local:t,type:e.type,contentType:typeof e.contents,batch:null===(i=e.metadata)||void 0===i?void 0:i.batch,compression:e.compression});throw this.closeFn(n),n}}(n||this.groupedBatchingEnabled)&&this.emit("op",e,n),this.scheduleManager.afterOpProcessing(void 0,e),t&&this.resetReconnectCount()}catch(t){throw this.scheduleManager.afterOpProcessing(t,e),t}}endSignalTelemetryEvent(e){const t=Date.now()-this._perfSignalData.signalTimestamp;this.logger.sendPerformanceEvent({eventName:"SignalLatency",duration:t,signalsLost:this._perfSignalData.signalsLost}),this._perfSignalData.signalsLost=0,this._perfSignalData.signalTimestamp=0}processSignal(e,t){const n=e.content,i={clientId:e.clientId,content:n.contents.content,type:n.contents.type};e.clientId===this.clientId&&this.connected&&(void 0!==this._perfSignalData.trackingSignalSequenceNumber&&n.clientSignalSequenceNumber>this._perfSignalData.trackingSignalSequenceNumber?(this._perfSignalData.signalsLost++,this._perfSignalData.trackingSignalSequenceNumber=void 0,this.logger.sendErrorEvent({eventName:"SignalLost",type:n.contents.type,signalsLost:this._perfSignalData.signalsLost,trackingSequenceNumber:this._perfSignalData.trackingSignalSequenceNumber,clientSignalSequenceNumber:n.clientSignalSequenceNumber})):n.clientSignalSequenceNumber===this._perfSignalData.trackingSignalSequenceNumber&&(0===this.consecutiveReconnects&&this.sendSignalTelemetryEvent(n.clientSignalSequenceNumber),this._perfSignalData.trackingSignalSequenceNumber=void 0)),void 0!==n.address?this.dataStores.processSignal(n.address,i,t):this.emit("signal",i,t)}async getRootDataStore(e){return this.getRootDataStoreChannel(e,!(arguments.length>1&&void 0!==arguments[1])||arguments[1])}async getRootDataStoreChannel(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];await this.dataStores.waitIfPendingAlias(e);const n=this.internalId(e),i=await this.dataStores.getDataStore(n,{wait:t});return Object(he.a)(await i.isRoot(),299),i.realize()}flush(){Object(he.a)(0===this._orderSequentiallyCalls,588),this.outbox.flush(),Object(he.a)(this.outbox.isEmpty,975)}orderSequentially(e){let t,n;this.mc.config.getBoolean("Fluid.ContainerRuntime.EnableRollback")&&(t=this.outbox.checkpoint().mainBatch);try{this._orderSequentiallyCalls++,n=e()}catch(e){if(t)try{t.rollback((e=>this.rollback(e.deserializedContent.type,e.deserializedContent.contents,e.localOpMetadata)))}catch(e){const t=It(e,(e=>an.create(`RollbackError: ${e}`,"checkpointRollback",void 0)));throw this.closeFn(t),t}else this.closeFn(new nn("orderSequentially callback exception",e));throw e}finally{this._orderSequentiallyCalls--}return this.flushMode!==dn.FlushMode.TurnBased&&0===this._orderSequentiallyCalls&&this.flush(),n}async createDataStore(e){const t=Object(ge.a)();return Bi(await this._createDataStore(e,t),t,this,this.dataStores,this.mc.logger)}createDetachedRootDataStore(e,t){if(t.includes("/"))throw new rn(`Id cannot contain slashes: '${t}'`);return this.dataStores.createDetachedDataStoreCore(e,!0,t)}sync _createDataStoreWithProps(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Object(ge.a)();const i=await this.dataStores._createFluidDataStoreContext(Array.isArray(e)?e:[e],n,t).realize();return Bi(i,n,this,this.dataStores,this.mc.logger)}async _createDataStore(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Object(ge.a)(),n=arguments.length>2?arguments[2]:void 0;return this.dataStores._createFluidDataStoreContext(Array.isArray(e)?e:[e],t,n).realize()}urrentlyBatching(){return this.flushMode!==dn.FlushMode.Immediate||0!==this._orderSequentiallyCalls}getQuorum(){return this.context.quorum}getAudience(){return this.context.audience}get isDirty(){return this.dirtyContainer}isContainerMessageDirtyable(e,t){if(e===ss.Attach){if(t.id===bs)return!1}else if(e===ss.FluidDataStoreOp&&t.address===bs)return!1;return!0}createNewSignalEnvelope(e,t,n){const i=++this._perfSignalData.signalSequenceNumber,r={address:e,clientSignalSequenceNumber:i,contents:{type:t,content:n}};return i%this.defaultTelemetrySignalSampleCount==1&&void 0===this._perfSignalData.trackingSignalSequenceNumber&&(this._perfSignalData.signalTimestamp=Date.now(),this._perfSignalData.trackingSignalSequenceNumber=i),r}submitSignal(e,t){this.verifyNotClosed();const n=this.createNewSignalEnvelope(void 0,e,t);return this.context.submitSignalFn(n)}submitDataStoreSignal(e,t,n){const i=this.createNewSignalEnvelope(e,t,n);return this.context.submitSignalFn(i)}setAttachState(e){e===et.Attaching?Object(he.a)(this.attachState===et.Attaching,301):(Object(he.a)(this.attachState===et.Attached,302),this.emit("attached")),e!==et.Attached||this.hasPendingMessages()||this.updateDocumentDirtyState(!1),this.dataStores.setAttachState(e)}createSummary(e,t){e&&this.blobManager.setRedirectTable(e);const n=this.dataStores.createSummary(t);return Pi(n),this.addContainerStateToSummary(n,!0,!1,t),n.summary}async getAbsoluteUrl(e){if(void 0===this.context.getAbsoluteUrl)throw new Error("Driver does not implement getAbsoluteUrl");if(this.attachState===et.Attached)return this.context.getAbsoluteUrl(e)}async summarizeInternal(e,t,n){const i=await this.dataStores.summarize(e,t,n);Pi(i);const r=[dn.channelsTreeName];return this.addContainerStateToSummary(i,e,t,n),Object.assign(Object.assign({},i),{id:"",pathPartsForChildren:r})}async summarize(e){this.verifyNotClosed();const{fullTree:t=!1,trackState:n=!0,summaryLogger:i=this.mc.logger,runGC:r=this.garbageCollector.shouldRunGC,runSweep:s,fullGC:o}=e,a=new Mn;a.setMultiple("fluid_Summarize","Options",{fullTree:t,trackState:n,runGC:r,fullGC:o,runSweep:s});try{let e;r&&(e=await this.collectGarbage({logger:i,runSweep:s,fullGC:o},a));const{stats:c,summary:l}=await this.summarizerNode.summarize(t,n,a);return Object(he.a)(l.type===ln.a.Tree,303),{stats:c,summary:l,gcStats:e}}finally{this.logger.sendTelemetryEvent({eventName:"SummarizeTelemetry",details:a.serialize()})}}async updateStateBeforeGC(){return this.dataStores.updateStateBeforeGC()}async getGCDataInternal(e){return this.dataStores.getGCData(e)}async getGCData(e){const t=new An,n=await this.summarizerNode.getGCData(e);t.addNodes(n.gcNodes);const i=this.blobManager.getGCData(e);return t.addNodes(i.gcNodes),t.getGCData()}updateUsedRoutes(e){this.summarizerNode.updateUsedRoutes([""]);const{dataStoreRoutes:t}=this.getDataStoreAndBlobManagerRoutes(e);this.dataStores.updateUsedRoutes(t)}updateUnusedRoutes(e){const{blobManagerRoutes:t,dataStoreRoutes:n}=this.getDataStoreAndBlobManagerRoutes(e);this.blobManager.updateUnusedRoutes(t),this.dataStores.updateUnusedRoutes(n)}deleteUnusedNodes(e){throw new Error("deleteUnusedRoutes should not be called")}deleteSweepReadyNodes(e){const{dataStoreRoutes:t,blobManagerRoutes:n}=this.getDataStoreAndBlobManagerRoutes(e);return this.dataStores.deleteSweepReadyNodes(t).concat(this.blobManager.deleteSweepReadyNodes(n))}updateTombstonedRoutes(e){const{blobManagerRoutes:t,dataStoreRoutes:n}=this.getDataStoreAndBlobManagerRoutes(e);this.blobManager.updateTombstonedRoutes(t),this.dataStores.updateTombstonedRoutes(n)}getCurrentReferenceTimestampMs(){var e,t,n;return null!==(t=null===(e=this.deltaManager.lastMessage)||void 0===e?void 0:e.timestamp)&&void 0!==t?t:null===(n=this.messageAtLastSummary)||void 0===n?void 0:n.timestamp}getNodeType(e){var t;return this.isBlobPath(e)?Qn:null!==(t=this.dataStores.getGCNodeType(e))&&void 0!==t?t:Xn}async getGCNodePackagePath(e){switch(this.getNodeType(e)){case Qn:return[ui.basePath];case Wn:case Jn:return this.dataStores.getDataStorePackagePath(e);default:Object(he.a)(!1,734)}}isBlobPath(e){const t=e.split("/");return!(t.length<2||t[1]!==ui.basePath)}getDataStoreAndBlobManagerRoutes(e){const t=[],n=[];for(const i of e)this.isBlobPath(i)?t.push(i):n.push(i);return{blobManagerRoutes:t,dataStoreRoutes:n}}async collectGarbage(e,t){return this.garbageCollector.collectGarbage(e,t)}addedGCOutboundReferencesync submitSummary(e){var t,n,i,r;const{fullTree:s=!1,refreshLatestAck:o,summaryLogger:a}=e,c=this.nextSummaryNumber,l=Rt.create(a,void 0,{all:{summaryNumber:c}});let d;if(Object(he.a)(this.outbox.isEmpty,977),o){const e=await this.refreshLatestSummaryAckFromServer(Rt.create(l,void 0,{all:{safeSummary:!0}})),t=e.latestSnapshotRefSeq;d=e.latestSnapshotVersionId,await this.waitForDeltaManagerToCatchup(t,l)}const u=!0!==this.mc.config.getBoolean("Fluid.ContainerRuntime.SubmitSummary.disableInboundSignalPause");let h;try{await this.deltaManager.inbound.pause(),u&&await this.deltaManager.inboundSignal.pause(),h=this.deltaManager.lastSequenceNumber;const o=this.deltaManager.minimumSequenceNumber,a=`Summary @${h}:${this.deltaManager.minimumSequenceNumber}`,m=this.summaryCollection.latestAck;this.summarizerNode.startSummary(h,l);const g=()=>{var t;return e.cancellationToken.cancelled?{continue:!1,error:"disconnected"}:(Object(he.a)(this.connected,600),this.deltaManager.lastSequenceNumber!==h?{continue:!1,error:`lastSequenceNumber changed before uploading to storage. ${this.deltaManager.lastSequenceNumber} !== ${h}`}:(Object(he.a)(h===(null===(t=this.deltaManager.lastMessage)||void 0===t?void 0:t.sequenceNumber),917),m!==this.summaryCollection.latestAck?{continue:!1,error:`Last summary changed while summarizing. ${this.summaryCollection.latestAck} !== ${m}`}:{continue:!0}))};let p=g();if(!p.continue)return{stage:"base",referenceSequenceNumber:h,minimumSequenceNumber:o,error:p.error};const f=ut.a.start();let v;const y=this.garbageCollector.summaryStateNeedsReset;try{v=await this.summarize({fullTree:s||y,trackState:!0,summaryLogger:l,runGC:this.garbageCollector.shouldRunGC})}catch(e){return{stage:"base",referenceSequenceNumber:h,minimumSequenceNumber:o,error:e}}const{summary:b,stats:S}=v;this.messageAtLastSummary=this.deltaManager.lastMessage;const C=b.tree[dn.channelsTreeName];Object(he.a)(C.type===ln.a.Tree,508);const w=Object.values(C.tree).filter(().length,O=b.tree[dn.gcTreeKey]?Nn(b.tree[dn.gcTreeKey]):void 0,I=Object.assign({dataStoreCount:this.dataStores.size,summarizedDataStoreCount:this.dataStores.size-w,gcStateUpdatedDataStoreCount:null===(t=v.gcStats)||void 0===t?void 0:t.updatedDataStoreCount,gcBlobNodeCount:null==O?void 0:O.blobNodeCount,gcTotalBlobsSize:null==O?void 0:O.totalBlobSize,summaryNumber:c},S),N={referenceSequenceNumber:h,minimumSequenceNumber:o,summaryTree:b,summaryStats:I,generateDuration:f.trace().duration,forcedFullTree:y};if(p=g(),!p.continue)return Object.assign(Object.assign({stage:"generate"},N),{error:p.error});let T,E;T=(null==m?void 0:m.summaryAck.contents.handle)!==d&&void 0!==d?{proposalHandle:void 0,ackHandle:d,referenceSequenceNumber:h}:void 0===m?{proposalHandle:void 0,ackHandle:null===(n=this.context.getLoadedFromVersion())||void 0===n?void 0:n.id,referenceSequenceNumber:h}:{proposalHandle:m.summaryOp.contents.handle,ackHandle:m.summaryAck.contents.handle,referenceSequenceNumber:h};try{E=await this.storage.uploadSummaryWithContext(v.summary,T)}catch(e){return Object.assign(Object.assign({stage:"generate"},N),{error:e})}const k=T.ackHandle,j={handle:E,head:k,message:a,parents:k?[k]:[]},P=Object.assign(Object.assign({},N),{handle:E,uploadDuration:f.trace().duration});if(p=g(),!p.continue)return Object.assign(Object.assign({stage:"upload"},P),{error:p.error});let _;try{_=this.submitSummaryMessage(j,h)}catch(e){return Object.assign(Object.assign({stage:"upload"},P),{error:e})}const M=Object.assign(Object.assign({stage:"submit"},P),{clientSequenceNumber:_,submitOpDuration:f.trace().duration});return this.summarizerNode.completeSummary(E),M}finally{this.summarizerNode.clearSummary(),null===(r=null===(i=this._summarizer)||void 0===i?void 0:i.recordSummaryAttempt)||void 0===r||r.call(i,h),this.deltaManager.inbound.resume(),u&&this.deltaManager.inboundSignal.resume()}}hasPendingMessages(){return this.pendingStateManager.hasPendingMessages()||!this.outbox.isEmpty}updateDocumentDirtyState(e){this.attachState!==et.Attached?Object(he.a)(e,978):Object(he.a)(!e||this.hasPendingMessages(),979),this.dirtyContainer!==e&&(this.dirtyContainer=e,this.emitDirtyDocumentEvent&&(this.emit(e?"dirty":"saved"),this.context.updateDirtyContainerState(e)))}submitDataStoreOp(e,t){this.submit(ss.FluidDataStoreOp,{address:e,contents:t},arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0)}submitDataStoreAliasOp(e,t){if(!zi(e))throw new rn("malformedDataStoreAliasMessage");this.submit(ss.Alias,e,t)}async uploadBlob(e){return this.verifyNotClosed(),this.blobManager.createBlob(e)}maybeSubmitIdAllocationOp(e){var t,n;if(e!==ss.IdAllocation){let e,i;if(this.idCompressorEnabled&&(Object(he.a)(void 0!==this.idCompressor,1661),i=this.idCompressor.takeNextCreationRange(),i=void 0!==(null===(t=null==i?void 0:i.ids)||void 0===t?void 0:t.first)?i:void 0),void 0!==i){const t={type:ss.IdAllocation,contents:i};e={contents:JSON.stringify(t),deserializedContent:t,referenceSequenceNumber:this.deltaManager.lastSequenceNumber,metadata:void 0,localOpMetadata:null===(n=this.idCompressor)||void 0===n?void 0:n.serialize(!0)}}void 0!==e&&this.outbox.submit(e)}}submit(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:void 0;this.verifyNotClosed(),this.verifyCanSubmitOps(),Object(he.a)(this.attachState!==et.Detached,306);const r=JSON.stringify({type:e,contents:t});this.innerDeltaManager.readOnlyInfo.readonly&&this.logger.sendTelemetryEvent({eventName:"SubmitOpInReadonly",connected:this.connected});const s={contents:r,deserializedContent:JSON.parse(r),metadata:i,localOpMetadata:n,referenceSequenceNumber:this.deltaManager.lastSequenceNumber};try{this.maybeSubmitIdAllocationOp(e),this.currentlyBatching()&&e===ss.Attach&&!0!==this.disableAttachReorder?this.outbox.submitAttach(s):this.outbox.submit(s),this.currentlyBatching()?this.scheduleFlush():this.flush()}catch(e){throw this.closeFn(e),e}this.isContainerMessageDirtyable(e,t)&&this.updateDocumentDirtyState(!0)}scheduleFlush(){if(this.flushTaskExists)return;this.flushTaskExists=!0;const e=()=>{this.flushTaskExists=!1;try{this.flush()}catch(e){this.closeFn(e)}};switch(this.flushMode){case dn.FlushMode.TurnBased:Promise.resolve().then(e);break;case dn.FlushModeExperimental.Async:setTimeout(e,0);break;default:Object(he.a)(this._orderSequentiallyCalls>0,1415)}}submitSummaryMessage(e,t){return this.verifyNotClosed(),Object(he.a)(this.connected,307),Object(he.a)(this.outbox.isEmpty,980),void 0!==this.context.submitSummaryFn?this.context.submitSummaryFn(e,t):this.context.submitFn(qe.a.Summarize,e,!1)}verifyNotClosed(){if(this._disposed)throw new Error("Runtime is closed")}verifyCanSubmitOps(){if(this.ensureNoDataModelChangesCalls>0){const e="Op was submitted from within a `ensureNoDataModelChanges` callback";if(this.opReentryCallsToReport>0&&(this.mc.logger.sendTelemetryEvent({eventName:"OpReentry"},new rn(e)),this.opReentryCallsToReport--),this.enableOpReentryCheck)throw new rn(e)}}reSubmit(e,t,n,i){switch(e){case ss.FluidDataStoreOp:this.dataStores.resubmitDataStoreOp(t,n);break;case ss.Attach:case ss.Alias:case ss.IdAllocation:this.submit(e,t,n);break;case ss.ChunkedOp:throw new Error("chunkedOp not expected here");case ss.BlobAttach:this.blobManager.reSubmit(i);break;case ss.Rejoin:this.submit(e,t);break;default:Object(dt.a)(e,`Unknown ContainerMessageType: ${e}`)}}rollback(e,t,n){switch(e){case ss.FluidDataStoreOp:this.dataStores.rollbackDataStoreOp(t,n);break;default:throw new Error(`Can't rollback ${e}`)}}async waitForDeltaManagerToCatchup(e,t){e>this.deltaManager.lastSequenceNumber&&await Ft.timedExecAsync(t,{eventName:"WaitingForSeq",lastSequenceNumber:this.deltaManager.lastSequenceNumber,targetSequenceNumber:e,lastKnownSeqNumber:this.deltaManager.lastKnownSeqNumber},(,{start:!0,end:!0,cancel:"error"})}async refreshLatestSummaryAck(e){const{proposalHandle:t,ackHandle:n,summaryRefSeq:i,summaryLogger:r}=e,s=async e=>Object(Fe.a)(this.storage,e),o=await this.summarizerNode.refreshLatestSummary(t,i,(async()=>{let e=await this.fetchLatestSnapshotFromStorage(r,{eventName:"RefreshLatestSummaryAckFetch",ackHandle:n,targetSequenceNumber:i},s);if(e.latestSnapshotRefSeq<i&&(e=await this.fetchSnapshotFromStorage(r,{eventName:"RefreshLatestSummaryAckFetchBackCompat",ackHandle:n,targetSequenceNumber:i},s,n)),e.latestSnapshotRefSeq<i){const t=an.create("Fetched snapshot is older than the received ack","RefreshLatestSummaryAck",void 0,{ackHandle:n,summaryRefSeq:i,fetchedSnapshotRefSeq:e.latestSnapshotRefSeq});throw this.closeFn(t),t}return await this.waitForDeltaManagerToCatchup(e.latestSnapshotRefSeq,r),{snapshotTree:e.snapshotTree,snapshotRefSeq:e.latestSnapshotRefSeq}}),s,r);await this.garbageCollector.refreshLatestSummary(t,o,s)}async refreshLatestSummaryAckFromServer(e){const t={snapshotTree:n,versionId:i,latestSnapshotRefSeq:r}=await this.fetchLatestSnapshotFromStorage(e,{eventName:"RefreshLatestSummaryFromServerFetch"},t),s={snapshotTree:n,snapshotRefSeq:r},o=await this.summarizerNode.refreshLatestSummary(void 0,r,(async()=>s),t,e);return await this.garbageCollector.refreshLatestSummary(void 0,o,t),{latestSnapshotRefSeq:r,latestSnapshotVersionId:i}}async fetchLatestSnapshotFromStoragesync fetchSnapshotFromStorage(e,t,n,i){var r;const s=await Ft.timedExecAsync(e,t,(async e=>{const t={},r=ut.a.start(),s=await this.storage.getVersions(i,1,"refreshLatestSummaryAckFromServer",null===i?Yt.noCache:void 0);Object(he.a)(!!s&&!!s[0],311),t.getVersionDuration=r.trace().duration;const o=await this.storage.getSnapshotTree(s[0]);Object(he.a)(!!o,312),t.getSnapshotDuration=r.trace().duration;const a=await async function(e,t){const n=e.trees[".protocol"].blobs.attributes;return(await t(n)).sequenceNumber}(o,n);return t.snapshotRefSeq=a,t.snapshotVersion=s[0].id,e.end(t),{snapshotTree:o,versionId:s[0].id,latestSnapshotRefSeq:a}}));if("restart"===this.summaryStateUpdateMethod){const e=new nn("Restarting summarizer instead of refreshing");throw this.mc.logger.sendTelemetryEvent(Object.assign(Object.assign({},t),{eventName:"ClosingSummarizerOnSummaryStale",codePath:t.eventName,message:"Stopping fetch from storage",versionId:null!=i?i:void 0,closeSummarizerDelayMs:this.closeSummarizerDelayMs}),e),await Object(ht.a)(this.closeSummarizerDelayMs),null===(r=this._summarizer)||void 0===r||r.stop("latestSummaryStateStale"),this.closeFn(),e}return s}notifyAttaching(){}getPendingLocalState(){if(0!==this._orderSequentiallyCalls)throw new rn("can't get state during orderSequentially");return this.flush(),{pending:this.pendingStateManager.getLocalState(),pendingAttachmentBlobs:this.blobManager.getPendingBlobs()}}formRequestSummarizerFn(e){return async()=>{const t={headers:{[tt.cache]:!1,[tt.clientDetails]:{capabilities:{interactive:!1},type:oi},[en.summarizingClient]:!0,[tt.reconnect]:!1},url:"/_summarizer"},n=(await pn(e,t)).ISummarizer;if(!n)throw new rn("Fluid object does not implement ISummarizer");return n}}validateSummaryHeuristicConfiguration(e){for(const t in e)if("number"==typeof e[t]&&e[t]<0)throw new rn(`Summary heuristic configuration property "${t}" cannot be less than 0`);if(e.minIdleTime>e.maxIdleTime)throw new rn(`"minIdleTime" [${e.minIdleTime}] cannot be greater than "maxIdleTime" [${e.maxIdleTime}]`)}get groupedBatchingEnabled(){return!0!==this.mc.config.getBoolean("Fluid.ContainerRuntime.DisableGroupedBatching")&&this.runtimeOptions.enableGroupedBatching}}const Cs=async(e,t)=>new Promise(((n,i)=>{if(e.on("closed",i),e.on("disposed",i),e.lastSequenceNumber>=t)n();else{const i=r=>{r.sequenceNumber>=t&&(n(),e.off("op",i))};e.on("op",i)}}));class ws{constructor(e,t){this.absolutePath=e,this.routeContext=t,this.isAttached=!0,Object(he.a)(e.startsWith("/"),413)}get IFluidRouter(){return this}get IFluidHandleContext(){return this}get IFluidHandle(){return this}async get(){return void 0===this.objectP&&(this.objectP=this.routeContext.resolveHandle({url:this.absolutePath,headers:{[ds.viaHandle]:!0}}).then((e=>{if("fluid/object"===e.mimeType)return e.value;throw function(e,t){const n=e.value,i=Ie();return{errorFromRequestFluidObject:!0,message:n,name:"Error",code:e.status,get stackunderlyingResponseHeaders:e.headers}}(e)}))),this.objectP}attachGraph(){}sync request(e){try{const t=(await this.get()).IFluidRouter;return void 0!==t?t.request(e):(e=>function(e,t,n,i){var r;Object(he.a)(!0,411);const s=null===(r=n.url)||void 0===r?void 0:r.split("?")[0],o=Ie();return{mimeType:"text/plain",status:404,value:void 0===s?t:`${t}: ${s}`,get stack(){return o.stack},headers:void 0}}(0,"not found",e))(e)}catch(e){return function(e){if(null!==e&&"object"==typeof e&&!0===e.errorFromRequestFluidObject){const t=e;return{mimeType:"text/plain",status:t.code,value:t.message,get stack(){return t.stack},headers:t.underlyingResponseHeaders}}const t=Ie();return{mimeType:"text/plain",status:500,value:`${e}`,get stack}(e)}}}class Os{constructor(e,t){for(this.context=e,this.handleParsedCb=t,this.encodeValue=(e,t)=>{const n=null==e?void 0:e.IFluidHandle;return void 0!==n?this.serializeHandle(n,t):e},this.decodeValue=e=>{if(((e)){const t=e.url.startsWith("/")?e.url:ct(e.url,this.context),n=new ws(t,this.root);return this.handleParsedCb(n),n}return e},this.root=this.context;void 0!==this.root.routeContext;)this.root=this.root.routeContext}get IFluidSerializer(){return this}encode(e,t){return e&&"object"==typeof e?this.recursivelyReplace(e,this.encodeValue,t):e}decode(e){return e&&"object"==typeof e?this.recursivelyReplace(e,this.decodeValue):e}stringify(e,t){return JSON.stringify(e,((e,n)=>this.encodeValue(n,t)))}parse(e){return JSON.parse(e,()}recursivelyReplace(e,t,n){const i=t(e,n);if(i!==e)return i;let r;for(const i of Object.keys(e)){const s=e[i];if(s&&"object"==typeof s){const o=this.recursivelyReplace(s,t,n);o!==s&&(r=null!=r?r:Array.isArray(e)?[...e]:Object.assign({},e),r[i]=o)}}return null!=r?r:e}serializeHandle(e,t){return t.bind(e),{type:"__fluid_handle__",url:e.absolutePath}}}class Is extends class{constructor(e,t,n){this.value=e,this.path=t,this.routeContext=n,this.pendingHandlesToMakeVisible=new Set,this.locallyVisible=!1,this.absolutePath=ct(t,this.routeContext)}get IFluidHandle(){return this}get isAttached(){return this.routeContext.isAttached}get visible(){return this.isAttached||this.locallyVisible}async get(){return this.value}attachGraph(){this.visible||(this.locallyVisible=!0,this.pendingHandlesToMakeVisible.forEach((e=>{e.attachGraph()})),this.pendingHandlesToMakeVisible.clear(),this.routeContext.attachGraph())}bind(e){this.visible?e.attachGraph():this.pendingHandlesToMakeVisible.add(e)}}{et isAttached(){return this.value.isAttached()}class Ns extends Os{rializeHandle(e,t){return this.serializedRoutes.add(e.absolutePath),super.serializeHandle(e,t)}}class Ts extends Be{constructor(e,t,n){super(((e,t)=>this.eventListenerErrorHandler(e,t))),this.id=e,this.runtime=t,this.attributes=n,this._connected=!1,this._isBoundToContext=!1,Object(he.a)(!e.includes("/"),772),this.handle=new Is(this,e,t.IFluidHandleContext),this.logger=it.create(t.logger,void 0,{all:{sharedObjectId:Object(ge.a)(),ddsType:{value:this.attributes.type,tag:Ye.CodeArtifact}}}),this.mc=this.logger),[this.opProcessingHelper,this.callbacksHelper]=this.setUpSampledTelemetryHelpers(),this.attachListeners()}get IFluidLoadable(){return this}get connected(){return this._connected}setUpSampledTelemetryHelpers(){var e,t;Object(he.a)(void 0!==this.mc&&void 0!==this.logger,841);const n=new at({eventName:"ddsOpProcessing",category:"performance"},this.logger,null!==(e=this.mc.config.getNumber("Fluid.SharedObject.OpProcessingTelemetrySampling"))&&void 0!==e?e:1e3,!0,new Map([["local",{localOp:!0}],["remote",{localOp:!1}]])),i=new at({eventName:"ddsEventCallbacks",category:"performance"},this.logger,null!==(t=this.mc.config.getNumber("Fluid.SharedObject.DdsCallbacksTelemetrySampling"))&&void 0!==t?t:1e3,!0);return this.runtime.once("dispose",(),[n,i]}closeWithErrorerifyNotClosed(){if(void 0!==this.closeError)throw this.closeError}eventListenerErrorHandler(e,t){const n=xe.wrapIfUnrecognized(t,"SharedObjectEventListenerException");throw n.addTelemetryProperties({emittedEventName:String(e)}),this.closeWithError(n),n}attachListeners(){this.isAttached()||this.runtime.once("attaching",(()=>{this.didAttach()}))}async load(e){this.runtime.attachState!==Re.Detached&&(this.services=e),await this.loadCore(e.objectStorage),this.runtime.attachState!==Re.Detached&&this.attachDeltaHandler()}indToContextAttached(){return void 0!==this.services&&this.runtime.attachState!==Re.Detached}handleDecoded(e){var t,n,i;this.isAttached()&&(null===(i=null===(t=this.services)||void 0===t?void 0:(n=t.deltaConnection).addedGCOutboundReference)||void 0===i||i.call(n,this.handle,e))}initializeLocalCore(){}didAttach(){}submitLocalMessage(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;this.verifyNotClosed(),this.isAttached()&&this.services.deltaConnection.submit(e,t)}dirtynConnect(){}reSubmitCore(e,t){this.submitLocalMessage(e,t)}async newAckBasedPromise(e){let t;return new Promise(((n,i)=>{t=this.runtime.disposed?t():(this.runtime.on("dispose",t),e(n,i))})).finally(()}attachDeltaHandler(){Object(he.a)(void 0!==this.services,122),this._isBoundToContext=!0,this.didAttach(),this.services.deltaConnection.attach({process:setConnectionState:reSubmit:(e,t)=>{this.reSubmit(e,t)},applyStashedOp:e=>this.applyStashedOp(e),rollback:),this.setConnectionState(this.services.deltaConnection.connected)}setConnectionState(e){this._connected!==e&&(this._connected=e,e?this.onConnect():this.onDisconnect())}process(e,t,n){this.verifyNotClosed(),this.emitInternal("pre-op",e,t,this),this.opProcessingHelper.measure((,t?"local":"remote"),this.emitInternal("op",e,t,this)}reSubmit(e,t){this.reSubmitCore(e,t)}mit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return this.callbacksHelper.measure((()=>this.runtime.ensureNoDataModelChanges((()=>super.emit(e,...n)))))}emitInternal(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return super.emit(e,...n)}}class Es extends Ts{constructor(e,t,n,i){super(e,t,n),this.telemetryContextPrefix=i,this._isGCing=!1,this._serializer=new Os(this.runtime.channelsRoutingContext,(e=>this.handleDecoded(e)))}get serializer(){return Object(he.a)(!this._isGCing,117),this._serializer}getAttachSummary(){let e=arguments.length>2?arguments[2]:void 0;const t=this.summarizeCore(this.serializer,e);return this.incrementTelemetryMetric(ze.blobCountPropertyName,t.stats.blobNodeCount,e),this.incrementTelemetryMetric(ze.totalBlobSizePropertyName,t.stats.totalBlobSize,e),t}async summarize(){let e=arguments.length>2?arguments[2]:void 0;const t=this.summarizeCore(this.serializer,e,arguments.length>3?arguments[3]:void 0);return this.incrementTelemetryMetric(ze.blobCountPropertyName,t.stats.blobNodeCount,e),this.incrementTelemetryMetric(ze.totalBlobSizePropertyName,t.stats.totalBlobSize,e),t}getGCData(){let e;Object(he.a)(!this._isGCing,120),this._isGCing=!0;try{const t=new Ns(this.runtime.channelsRoutingContext,();this.processGCDataCore(t),e={gcNodes:{"/":t.getSerializedRoutes()}},Object(he.a)(this._isGCing,121)}finally{this._isGCing=!1}return e}ncrementTelemetryMetric(e,t,n){var i;const r=null!==(i=null==n?void 0:n.get(this.telemetryContextPrefix,e))&&void 0!==i?i:0;null==n||n.set(this.telemetryContextPrefix,e,r+t)}}var ks;function js(){const e={treeNodeCount:0,blobNodeCount:0,handleNodeCount:0,totalBlobSize:0,unreferencedBlobSize:0};for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];for(const t of n)e.treeNodeCount+=t.treeNodeCount,e.blobNodeCount+=t.blobNodeCount,e.handleNodeCount+=t.handleNodeCount,e.totalBlobSize+=t.totalBlobSize,e.unreferencedBlobSize+=t.unreferencedBlobSize;return e}!function(e){e[e.Shared=0]="Shared",e[e.Plain=1]="Plain"}(ks||(ks={}));class Ps{constructor(){this.attachmentCounter=0,this.summaryTree={},this.summaryStats=js(),this.summaryStats.treeNodeCount++}get summary(){return{type:ln.a.Tree,tree:Object.assign({},this.summaryTree)}}ddBlob(e,t){!function(e,t,n){e.summary.tree[t]={type:ln.a.Blob,content:n},e.stats.blobNodeCount++,e.stats.totalBlobSize+=function(e){return"string"==typeof e?e):e.byteLength}(n)}({summary:{type:ln.a.Tree,tree:this.summaryTree},stats:this.summaryStats},e,t)}addHandle(e,t,n){this.summaryTree[e]={type:ln.a.Handle,handleType:t,handle:n},this.summaryStats.handleNodeCount++}addWithStats(e,t){this.summaryTree[e]=t.summary,this.summaryStats=js(this.summaryStats,t.stats)}addAttachment(e){this.summaryTree[this.attachmentCounter++]={id:e,type:ln.a.Attachment}}var _s=n("R8iU");function Ms(e,t,n){const i=e.makeSerialized(t,n);return{type:i.type,value:i.value&&JSON.parse(i.value)}}class Ds{constructor(e){this.value=e}akeSerialized(e,t){const n=function(e,t,n){return void 0!==e?t.stringify(e,n):e}(this.value,e,t);return{type:this.type,value:n}}}class xs{constructor(e){this.serializer=e}fromSerializable(e){e.type===ks[ks.Shared]&&(e.type=ks[ks.Plain],e.value={type:"__fluid_handle__",url:e.value});const t=function(e,t){return void 0!==e?t.parse(JSON.stringify(e)):e}(e.value,this.serializer);return new Ds(t)}const As="2.0.0-internal.4.3.0";var Rs,Fs;const qs=_s.posix,zs="header";class Bs{get type(){return Bs.Type}sync load(e,t,n,i){const r=new Ls(t,e,i);return await r.load(n),r}create(e,t){const n=new Ls(t,e,Bs.Attributes);return n.initializeLocal(),n}}Bs.Type="https://graph.microsoft.com/types/directory",Bs.Attributes={type:Bs.Type,snapshotFormatVersion:"0.1",packageVersion:As};class Ls extends Es{constructor(e,t,n){super(e,t,n,"fluid_directory_"),this[Rs]="SharedDirectory",this.root=new $s(0,new Set,this,this.runtime,this.serializer,qs.sep),this.messageHandlers=new Map,this.localValueMaker=new xs(this.serializer),this.setMessageHandlers(),this.root.on("containedValueChanged",((e,t)=>{this.emit("containedValueChanged",e,t,this)})),this.root.on("subDirectoryCreated",((e,t)=>{this.emit("subDirectoryCreated",e,t,this)})),this.root.on("subDirectoryDeleted",((e,t)=>{this.emit("subDirectoryDeleted",e,t,this)}))}static createt absolutePath(){return this.root.absolutePath}get(e){return this.root.get(e)}ispose(e){this.root.dispose(e)}get disposed(){return this.root.disposed}delete(e){return this.root.delete(e)}as(e){return this.root.has(e)}Rs=Symbol.toStringTag,Symbol.iterator)]ntries(){return this.root.entries()}countSubDirectory(){return this.root.countSubDirectory()}keys(){return this.root.keys()}values(){return this.root.values()}createSubDirectory(e){return this.root.createSubDirectory(e)}getSubDirectory(e){return this.root.getSubDirectory(e)}hasSubDirectory(e){return this.root.hasSubDirectory(e)}tWorkingDirectory(e){const t=this.makeAbsolute(e);if(t===qs.sep)return this.root;let n=this.root;const i=t.slice(1).split(qs.sep);for(const e of i)if(n=n.getSubDirectory(e),!n)return;return n}summarizeCoreubmitCore(e,t){const n=e,i=this.messageHandlers.get(n.type);Object(he.a)(void 0!==i,13),i.submit(n,t)}async loadCore(e){const t=await Object(Fe.a)(e,zs),n=t;Array.isArray(n.blobs)?(this.populate(n.content),await Promise.all(n.blobs.map((async t=>{const n=await Object(Fe.a)(e,t);this.populate(n)})))):this.populate(t)}populate(e){const t=[];for(t.push([this.root,e]);t.length>0;){const[e,n]=t.pop();if(n.subdirectories)for(const[i,r]of Object.entries(n.subdirectories)){let n=e.getSubDirectory(i);if(!n){const t=r.ci;n=new $s(void 0!==t?t.csn:0,void 0!==t?new Set(t.ccIds):new Set,this,this.runtime,this.serializer,qs.join(e.absolutePath,i)),e.populateSubDirectory(i,n)}t.push([n,r])}if(n.storage)for(const[t,i]of Object.entries(n.storage)){const n=this.makeLocal(t,e.absolutePath,i);e.populateStorage(t,n)}}}processCore(e,t,n){if(e.type===qe.a.Operation){const i=e.contents,r=this.messageHandlers.get(i.type);Object(he.a)(void 0!==r,14),r.process(e,i,t,n)}}rollback(e,t){const n=e,i=this.getWorkingDirectory(n.path);i&&i.rollback(n,t)}akeLocal(e,t,n){return Object(he.a)(n.type===ks[ks.Plain]||n.type===ks[ks.Shared],484),this.localValueMaker.fromSerializable(n)}isSubDirectoryDeletePending(e){const t=this.makeAbsolute(e);if(t===qs.sep)return!1;let n=this.root;const i=t.split(qs.sep);let r=1;for(;r<i.length;){const e=i[r];if(n.isSubDirectoryDeletePending(e))return!0;if(n=n.getSubDirectory(e),void 0===n)return!0;r+=1}return!1}setMessageHandlers(){this.messageHandlers.set("clear",{process:(e,t,n,i)=>{const r=this.getWorkingDirectory(t.path);r&&!this.isSubDirectoryDeletePending(t.path)&&r.processClearMessage(e,t,n,i)},submit:(e,t)=>{const n=this.getWorkingDirectory(e.path);n&&n.resubmitClearMessage(e,t)},applyStashedOp:e=>{const t=this.getWorkingDirectory(e.path);if(t)return t.applyStashedClearMessage(e)}}),this.messageHandlers.set("delete",{process:(e,t,n,i)=>{const r=this.getWorkingDirectory(t.path);r&&!this.isSubDirectoryDeletePending(t.path)&&r.processDeleteMessage(e,t,n,i)},submit:(e,t)=>{const n=this.getWorkingDirectory(e.path);n&&n.resubmitKeyMessage(e,t)},applyStashedOp:e=>{const t=this.getWorkingDirectory(e.path);if(t)return t.applyStashedDeleteMessage(e)}}),this.messageHandlers.set("set",{process:(e,t,n,i)=>{const r=this.getWorkingDirectory(t.path);if(r&&!this.isSubDirectoryDeletePending(t.path)){const s=n?void 0:this.makeLocal(t.key,t.path,t.value);r.processSetMessage(e,t,s,n,i)}},submit:(e,t)=>{const n=this.getWorkingDirectory(e.path);n&&n.resubmitKeyMessage(e,t)},applyStashedOp:e=>{const t=this.getWorkingDirectory(e.path);if(t){const n=this.makeLocal(e.key,e.path,e.value);return t.applyStashedSetMessage(e,n)}}}),this.messageHandlers.set("createSubDirectory",{process:(e,t,n,i)=>{const r=this.getWorkingDirectory(t.path);r&&!this.isSubDirectoryDeletePending(t.path)&&r.processCreateSubDirectoryMessage(e,t,n,i)},submit:(e,t)=>{const n=this.getWorkingDirectory(e.path);n&&n.resubmitSubDirectoryMessage(e,t)},applyStashedOp:e=>{const t=this.getWorkingDirectory(e.path);if(t)return t.applyStashedCreateSubDirMessage(e)}}),this.messageHandlers.set("deleteSubDirectory",{process:(e,t,n,i)=>{const r=this.getWorkingDirectory(t.path);r&&!this.isSubDirectoryDeletePending(t.path)&&r.processDeleteSubDirectoryMessage(e,t,n,i)},submit:(e,t)=>{const n=this.getWorkingDirectory(e.path);n&&n.resubmitSubDirectoryMessage(e,t)},applyStashedOp:e=>{const t=this.getWorkingDirectory(e.path);if(t)return t.applyStashedDeleteSubDirMessage(e)}})}applyStashedOp(e){const t=this.messageHandlers.get(e.type);if(void 0===t)throw new Error("no apply stashed op handler");return t.applyStashedOp(e)}serializeDirectory(e,t,n){const i=new Ps;let r=0;const s=[],o=[],a={};for(o.push([e,a]);o.length>0;){const[e,n]=o.pop();n.ci=e.getSerializableCreateInfo();for(const[o,a]of e.getSerializedStorage(t)){n.storage||(n.storage={});const t={type:a.type,value:a.value&&JSON.parse(a.value)};if(a.value&&a.value.length>=8192){const n={};let a=n;if(e.absolutePath!==qs.sep)for(const t of e.absolutePath.slice(1).split(qs.sep)){const e={};a.subdirectories={[t]:e},a=e}a.storage={[o]:t};const c=`blob${r}`;r++,s.push(c),i.addBlob(c,JSON.stringify(n))}else n.storage[o]=t}for(const[t,i]of e.subdirectories()){n.subdirectories||(n.subdirectories={});const e={};n.subdirectories[t]=e,o.push([i,e])}}return i.addBlob(zs,JSON.stringify({blobs:s,content:a})),i.getSummaryTree()}}function Vs(e){return void 0!==e&&"number"==typeof e.pendingMessageId&&"edit"===e.type}function Us(e){return void 0!==e&&"clear"===e.type&&"number"==typeof e.pendingMessageId&&"object"==typeof e.previousStorage}function Hs(e){return void 0!==e&&"number"==typeof e.pendingMessageId&&("createSubDir"===e.type||"deleteSubDir"===e.type)}function Gs(e){Object(he.a)(null!==e,1711)}class $s extends me.a{constructor(e,t,n,i,r,s){super(),this.sequenceNumber=e,this.clientIds=t,this.directory=n,this.runtime=i,this.serializer=r,this.absolutePath=s,this._deleted=!1,this[Fs]="SubDirectory",this._storage=new Map,this._subdirectories=new Map,this.pendingKeys=new Map,this.pendingSubDirectories=new Map,this.pendingDeleteSubDirectoriesCount=new Map,this.pendingMessageId=-1,this.pendingClearMessageIds=[]}dispose(e){this._deleted=!0,this.emit("disposed",this)}undisposeet disposed(){return this._deleted}throwIfDisposed(){if(this._deleted)throw new De("Cannot access Disposed subDirectory")}has(e){return this.throwIfDisposed(),this._storage.has(e)}get(e){var t;return this.throwIfDisposed(),null===(t=this._storage.get(e))||void 0===t?void 0:t.value}set(e,t){if(this.throwIfDisposed(),null==e)throw new Error("Undefined and null keys are not supported");const n=this.directory.localValueMaker.fromInMemory(t),i=Ms(n,this.serializer,this.directory.handle),r=this.setCore(e,n,!0);return this.directory.isAttached()?(this.submitKeyMessage({key:e,path:this.absolutePath,type:"set",value:i},r),this):this}countSubDirectory(){return this._subdirectories.size}createSubDirectory(e){var t;if(this.throwIfDisposed(),null==e)throw new Error("SubDirectory name may not be undefined or null");if(e.includes(qs.sep))throw new Error(`SubDirectory name may not contain ${qs.sep}`);const n=this.createSubDirectoryCore(e,!0,-1,null!==(t=this.runtime.clientId)&&void 0!==t?t:"detached"),i=this._subdirectories.get(e);return Object(he.a)(void 0!==i,1450),this.directory.isAttached()?(n&&this.submitCreateSubDirectoryMessage({path:this.absolutePath,subdirName:e,type:"createSubDirectory"}),i):i}getSubDirectory(e){return this.throwIfDisposed(),this._subdirectories.get(e)}hasSubDirectory(e){return this.throwIfDisposed(),this._subdirectories.has(e)}deleteSubDirectory(e){this.throwIfDisposed();const t=this.deleteSubDirectoryCore(e,!0);return this.directory.isAttached()?(void 0!==t&&this.submitDeleteSubDirectoryMessage({path:this.absolutePath,subdirName:e,type:"deleteSubDirectory"},t),void 0!==t):void 0!==t}subdirectories(){return this.throwIfDisposed(),this._subdirectories.entries()}getWorkingDirectory(e){return this.throwIfDisposed(),this.directory.getWorkingDirectory(this.makeAbsolute(e))}isSubDirectoryDeletePending(e){const t=this.pendingDeleteSubDirectoriesCount.get(e);return void 0!==t&&t>0}delete(e){this.throwIfDisposed();const t=this.deleteCore(e,!0);return this.directory.isAttached()?(this.submitKeyMessage({key:e,path:this.absolutePath,type:"delete"},t),void 0!==t):void 0!==t}clear(){if(this.throwIfDisposed(),!this.directory.isAttached())return void this.clearCore(!0);const e=new Map(this._storage);this.clearCore(!0),this.submitClearMessage({path:this.absolutePath,type:"clear"},e)}forEach(e){this.throwIfDisposed(),this._storage.forEach(((t,n,i)=>{e(t.value,n,i)}))}ntries(){this.throwIfDisposed();const e=this._storage.entries();return{next(){const t=e.next();return t.done?{value:void 0,done:!0}:{value:[t.value[0],t.value[1].value],done:!1}},[Symbol.iterator](){return this}}}alues(){this.throwIfDisposed();const e=this._storage.values();return{next(){const t=e.next();return t.done?{value:void 0,done:!0}:{value:t.value.value,done:!1}},[Symbol.iterator](){return this}}}[(Fs=Symbol.toStringTag,Symbol.iterator)]rocessClearMessage(e,t,n,i){if(this.throwIfDisposed(),this.isMessageForCurrentInstanceOfSubDirectory(e))if(n){Object(he.a)(Us(i),15);const e=this.pendingClearMessageIds.shift();Object(he.a)(e===i.pendingMessageId,810)}else this.clearExceptPendingKeys(!1)}applyStashedClearMessage(e){this.throwIfDisposed();const t=new Map(this._storage);this.clearExceptPendingKeys(!0);const n=++this.pendingMessageId;return this.pendingClearMessageIds.push(n),{type:"clear",pendingMessageId:n,previousStorage:t}}processDeleteMessage(e,t,n,i){this.throwIfDisposed(),this.isMessageForCurrentInstanceOfSubDirectory(e)&&this.needProcessStorageOperation(t,n,i)&&this.deleteCore(t.key,n)}applyStashedDeleteMessage(e){this.throwIfDisposed();const t=this.deleteCore(e.key,!0);return{type:"edit",pendingMessageId:this.getKeyMessageId(e),previousValue:t}}processSetMessage(e,t,n,i,r){this.throwIfDisposed(),this.isMessageForCurrentInstanceOfSubDirectory(e)&&this.needProcessStorageOperation(t,i,r)&&this.setCore(t.key,n,i)}applyStashedSetMessage(e,t){this.throwIfDisposed();const n=this.setCore(e.key,t,!0);return{type:"edit",pendingMessageId:this.getKeyMessageId(e),previousValue:n}}processCreateSubDirectoryMessage(e,t,n,i){this.throwIfDisposed(),this.needProcessSubDirectoryOperation(e,t,n,i)&&(Gs(e.clientId),this.createSubDirectoryCore(t.subdirName,n,e.sequenceNumber,e.clientId))}applyStashedCreateSubDirMessage(e){var t;return this.throwIfDisposed(),this.createSubDirectoryCore(e.subdirName,!0,-1,null!==(t=this.runtime.clientId)&&void 0!==t?t:"detached"),{type:"createSubDir",pendingMessageId:this.getSubDirMessageId(e)}}processDeleteSubDirectoryMessage(e,t,n,i){this.throwIfDisposed(),this.isMessageForCurrentInstanceOfSubDirectory(e)&&this.needProcessSubDirectoryOperation(e,t,n,i)&&this.deleteSubDirectoryCore(t.subdirName,n)}applyStashedDeleteSubDirMessage(e){this.throwIfDisposed();const t=this.deleteSubDirectoryCore(e.subdirName,!0);return{type:"deleteSubDir",pendingMessageId:this.getSubDirMessageId(e),subDirectory:t}}submitClearMessage(e,t){this.throwIfDisposed();const n=++this.pendingMessageId;this.pendingClearMessageIds.push(n),this.directory.submitDirectoryMessage(e,{type:"clear",pendingMessageId:n,previousStorage:t})}resubmitClearMessage(e,t){Object(he.a)(Us(t),811);const n=this.pendingClearMessageIds.shift();Object(he.a)(n===t.pendingMessageId,812),this.submitClearMessage(e,t.previousStorage)}getKeyMessageId(e){const t=++this.pendingMessageId,n=this.pendingKeys.get(e.key);return void 0!==n?n.push(t):this.pendingKeys.set(e.key,[t]),t}submitKeyMessage(e,t){this.throwIfDisposed();const n=this.getKeyMessageId(e);this.directory.submitDirectoryMessage(e,{type:"edit",pendingMessageId:n,previousValue:t})}resubmitKeyMessage(e,t){Object(he.a)(Vs(t),813);const n=this.pendingKeys.get(e.key);Object(he.a)(void 0!==n&&n[0]===t.pendingMessageId,814),n.shift(),0===n.length&&this.pendingKeys.delete(e.key),this.submitKeyMessage(e,t.previousValue)}getSubDirMessageId(e){var t;const n=++this.pendingMessageId,i=this.pendingSubDirectories.get(e.subdirName);if(void 0!==i?i.push(n):this.pendingSubDirectories.set(e.subdirName,[n]),"deleteSubDirectory"===e.type){const n=null!==(t=this.pendingDeleteSubDirectoriesCount.get(e.subdirName))&&void 0!==t?t:0;this.pendingDeleteSubDirectoriesCount.set(e.subdirName,n+1)}return n}submitCreateSubDirectoryMessage(e){this.throwIfDisposed();const t=this.getSubDirMessageId(e);this.directory.submitDirectoryMessage(e,{type:"createSubDir",pendingMessageId:t})}submitDeleteSubDirectoryMessage(e,t){this.throwIfDisposed();const n=this.getSubDirMessageId(e);this.directory.submitDirectoryMessage(e,{type:"deleteSubDir",pendingMessageId:n,subDirectory:t})}resubmitSubDirectoryMessage(e,t){Object(he.a)(Hs(t),815);const n=this.pendingSubDirectories.get(e.subdirName);Object(he.a)(void 0!==n&&n[0]===t.pendingMessageId,816),n.shift(),0===n.length&&this.pendingSubDirectories.delete(e.subdirName),"createSubDir"===t.type?this.submitCreateSubDirectoryMessage(e):this.submitDeleteSubDirectoryMessage(e,t.subDirectory)}*getSerializedStorage(e){this.throwIfDisposed();for(const[t,n]of this._storage){const i=[t,n.makeSerialized(e,this.directory.handle)];yield i}}getSerializableCreateInfo(){return this.throwIfDisposed(),{csn:this.sequenceNumber,ccIds:Array.from(this.clientIds)}}populateStorage(e,t){this.throwIfDisposed(),this._storage.set(e,t)}etLocalValue(e){return this.throwIfDisposed(),this._storage.get(e)}rollbackPendingMessageId(e,t,n){const i=e.get(t),r=null==i?void 0:i.pop();if(!i||r!==n)throw new Error("Rollback op does not match last pending");0===i.length&&e.delete(t)}rollback(e,t){if(!function(e){return void 0!==e&&"number"==typeof e.pendingMessageId&&("edit"===e.type||"deleteSubDir"===e.type||"clear"===e.type&&"object"==typeof e.previousStorage||"createSubDir"===e.type)}(t))throw new Error("Invalid localOpMetadata");if("clear"===e.type&&"clear"===t.type){for(const[e,n]of t.previousStorage.entries())this.setCore(e,n,!0);const e=this.pendingClearMessageIds.pop();if(void 0===e||e!==t.pendingMessageId)throw new Error("Rollback op does match last clear")}else if("delete"!==e.type&&"set"!==e.type||"edit"!==t.type)if("createSubDirectory"===e.type&&"createSubDir"===t.type)this.deleteSubDirectoryCore(e.subdirName,!0),this.rollbackPendingMessageId(this.pendingSubDirectories,e.subdirName,t.pendingMessageId);else{if("deleteSubDirectory"!==e.type||"deleteSubDir"!==t.type)throw new Error("Unsupported op for rollback");{void 0!==t.subDirectory&&(this.undeleteSubDirectoryTree(t.subDirectory),this._subdirectories.set(e.subdirName,t.subDirectory),this.emit("subDirectoryCreated",e.subdirName,!0,this)),this.rollbackPendingMessageId(this.pendingSubDirectories,e.subdirName,t.pendingMessageId);const n=this.pendingDeleteSubDirectoriesCount.get(e.subdirName);Object(he.a)(void 0!==n&&n>0,1451),this.pendingDeleteSubDirectoriesCount.set(e.subdirName,n-1),1===n&&this.pendingDeleteSubDirectoriesCount.delete(e.subdirName)}}else void 0===t.previousValue?this.deleteCore(e.key,!0):this.setCore(e.key,t.previousValue,!0),this.rollbackPendingMessageId(this.pendingKeys,e.key,t.pendingMessageId)}eedProcessStorageOperation(e,t,n){if(this.pendingClearMessageIds.length>0){if(t){Object(he.a)(void 0!==n&&Vs(n)&&n.pendingMessageId<this.pendingClearMessageIds[0],16);const t=this.pendingClearMessageIds[0],i=this.pendingKeys.get(e.key);if(void 0!==i){let n=0;for(;i[n]<t;)n+=1;const r=i.splice(n);0===r.length?this.pendingKeys.delete(e.key):this.pendingKeys.set(e.key,r)}}return!1}if(void 0!==this.pendingKeys.get(e.key)){if(t){Object(he.a)(void 0!==n&&Vs(n),17);const t=this.pendingKeys.get(e.key);Object(he.a)(void 0!==t&&t[0]===n.pendingMessageId,817),t.shift(),0===t.length&&this.pendingKeys.delete(e.key)}return!1}return!t}isMessageForCurrentInstanceOfSubDirectory(e){return null!==e.clientId&&this.clientIds.has(e.clientId)||this.clientIds.has("detached")||-1!==this.sequenceNumber&&this.sequenceNumber<=e.referenceSequenceNumber}needProcessSubDirectoryOperation(e,t,n,i){const r=this.pendingSubDirectories.get(t.subdirName);if(Gs(e.clientId),void 0!==r){if(n){Object(he.a)(Hs(i),18);const e=this.pendingSubDirectories.get(t.subdirName);if(Object(he.a)(void 0!==e&&e[0]===i.pendingMessageId,818),e.shift(),0===e.length&&this.pendingSubDirectories.delete(t.subdirName),"deleteSubDirectory"===t.type){const e=this.pendingDeleteSubDirectoriesCount.get(t.subdirName);Object(he.a)(void 0!==e&&e>0,1452),this.pendingDeleteSubDirectoriesCount.set(t.subdirName,e-1),1===e&&this.pendingDeleteSubDirectoriesCount.delete(t.subdirName)}}else if("deleteSubDirectory"===t.type){const e=this._subdirectories.get(t.subdirName);e&&(e.clearExceptPendingKeys(n),e.sequenceNumber=-1,e.clientIds.clear())}if("createSubDirectory"===t.type){const n=this._subdirectories.get(t.subdirName);-1===(null==n?void 0:n.sequenceNumber)&&(n.sequenceNumber=e.sequenceNumber),void 0!==n&&!n.clientIds.has(e.clientId)&&n.sequenceNumber<=e.sequenceNumber&&n.clientIds.add(e.clientId)}return!1}return!n}clearExceptPendingKeys(e){const t=new Map;for(const[e]of this.pendingKeys){const n=this._storage.get(e);void 0!==n&&t.set(e,n)}this.clearCore(e);for(const[e,n]of t.entries())this.setCore(e,n,!0)}clearCore(e){this._storage.clear(),this.directory.emit("clear",e,this.directory)}deleteCore(e,t){const n=this._storage.get(e),i=null==n?void 0:n.value;return this._storage.delete(e)&&(this.directory.emit("valueChanged",{key:e,path:this.absolutePath,previousValue:i},t,this.directory),this.emit("containedValueChanged",{key:e,previousValue:i},t,this)),n}setCore(e,t,n){const i=this._storage.get(e),r=null==i?void 0:i.value;return this._storage.set(e,t),this.directory.emit("valueChanged",{key:e,path:this.absolutePath,previousValue:r},n,this.directory),this.emit("containedValueChanged",{key:e,previousValue:r},n,this),i}createSubDirectoryCore(e,t,n,i){const r=this._subdirectories.get(e);if(void 0===r){const r=qs.join(this.absolutePath,e),s=new $s(n,new Set([i]),this.directory,this.runtime,this.serializer,r);return this.registerEventsOnSubDirectory(s,e),this._subdirectories.set(e,s),this.emit("subDirectoryCreated",e,t,this),!0}return r.clientIds.add(i),!1}registerEventsOnSubDirectory(e,t){e.on("subDirectoryCreated",((e,n)=>{this.emit("subDirectoryCreated",qs.join(t,e),n,this)})),e.on("subDirectoryDeleted",((e,n)=>{this.emit("subDirectoryDeleted",qs.join(t,e),n,this)}))}deleteSubDirectoryCore(e,t){const n=this._subdirectories.get(e);return void 0!==n&&(this._subdirectories.delete(e),this.disposeSubDirectoryTree(n),this.emit("subDirectoryDeleted",e,t,this)),n}disposeSubDirectoryTree(e){if(!e)return;const t=e.subdirectories();for(const[e,n]of t)this.disposeSubDirectoryTree(n);"function"==typeof e.dispose&&e.dispose()}undeleteSubDirectoryTree(e){for(const[e,t]of this._subdirectories.entries())this.undeleteSubDirectoryTree(t);e.undispose()}}function Ks(e){return void 0!==e&&"number"==typeof e.pendingMessageId&&("add"===e.type||"edit"===e.type)}function Ws(e){return void 0!==e&&"clear"===e.type&&"number"==typeof e.pendingMessageId}function Js(e,t,n){return{type:"clear",pendingMessageId:t,previousMap:n}}function Qs(e,t,n){return n?{type:"edit",pendingMessageId:t,previousValue:n}:{type:"add",pendingMessageId:t}}class Xs{constructor(e,t,n,i,r){this.serializer=e,this.handle=t,this.submitMessage=n,this.isAttached=i,this.eventEmitter=r,this.messageHandlers=new Map,this.data=new Map,this.pendingKeys=new Map,this.pendingMessageId=-1,this.pendingClearMessageIds=[],this.localValueMaker=new xs(e),this.messageHandlers=this.getMessageHandlers()}get size(){return this.data.size}keys(){return this.data.keys()}entries(){const e=this.data.entries();return{next(){const t=e.next();return t.done?{value:void 0,done:!0}:{value:[t.value[0],t.value[1].value],done:!1}},[Symbol.iterator](){return this}}}values(){const e=this.data.values();return{next(){const t=e.next();return t.done?{value:void 0,done:!0}:{value:t.value.value,done:!1}},[Symbol.iterator](){return this}}}orEach(e){this.data.forEach(()}get(e){const t=this.data.get(e);return void 0===t?void 0:t.value}has(e){return this.data.has(e)}set(e,t){if(null==e)throw new Error("Undefined and null keys are not supported");const n=this.localValueMaker.fromInMemory(t),i=Ms(n,this.serializer,this.handle),r=this.setCore(e,n,!0);this.isAttached()&&this.submitMapKeyMessage({key:e,type:"set",value:i},r)}delete(e){const t=this.deleteCore(e,!0);return this.isAttached()?(this.submitMapKeyMessage({key:e,type:"delete"},t),void 0!==t):void 0!==t}clear(){const e=this.isAttached()?new Map(this.data):void 0;this.clearCore(!0),this.isAttached()&&this.submitMapClearMessage({type:"clear"},e)}getSerializedStorage(e){const t={};for(const[n,i]of this.data.entries())t[n]=i.makeSerialized(e,this.handle);return t}getSerializableStorage(e){const t={};for(const[n,i]of this.data.entries())t[n]=Ms(i,e,this.handle);return t}opulateFromSerializable(e){for(const[t,n]of Object.entries(e)){const e={key:t,value:this.makeLocal(t,n)};this.data.set(e.key,e.value)}}rySubmitMessage(e,t){const n=this.messageHandlers.get(e.type);return void 0!==n&&(n.submit(e,t),!0)}tryApplyStashedOp(e){const t=this.messageHandlers.get(e.type);if(void 0===t)throw new Error("no apply stashed op handler");return t.applyStashedOp(e)}tryProcessMessage(e,t,n){const i=this.messageHandlers.get(e.type);return void 0!==i&&(i.process(e,t,n),!0)}rollback(e,t){if(!function(e){return void 0!==e&&"number"==typeof e.pendingMessageId&&("add"===e.type||"edit"===e.type||"clear"===e.type)}(t))throw new Error("Invalid localOpMetadata");if("clear"===e.type&&"clear"===t.type){if(void 0===t.previousMap)throw new Error("Cannot rollback without previous map");for(const[e,n]of t.previousMap.entries())this.setCore(e,n,!0);const e=this.pendingClearMessageIds.pop();if(void 0===e||e!==t.pendingMessageId)throw new Error("Rollback op does match last clear")}else{if("delete"!==e.type&&"set"!==e.type)throw new Error("Unsupported op for rollback");{if("add"===t.type)this.deleteCore(e.key,!0);else{if("edit"!==t.type||void 0===t.previousValue)throw new Error("Cannot rollback without previous value");this.setCore(e.key,t.previousValue,!0)}const n=this.pendingKeys.get(e.key),i=null==n?void 0:n.pop();if(!n||i!==t.pendingMessageId)throw new Error("Rollback op does not match last pending");0===n.length&&this.pendingKeys.delete(e.key)}}}setCore(e,t,n){const i=this.data.get(e),r=null==i?void 0:i.value;return this.data.set(e,t),this.eventEmitter.emit("valueChanged",{key:e,previousValue:r},n,this.eventEmitter),i}clearCore(e){this.data.clear(),this.eventEmitter.emit("clear",e,this.eventEmitter)}deleteCore(e,t){const n=this.data.get(e),i=null==n?void 0:n.value;return this.data.delete(e)&&this.eventEmitter.emit("valueChanged",{key:e,previousValue:i},t,this.eventEmitter),n}clearExceptPendingKeys(){const e=new Map;for(const t of this.pendingKeys.keys())e.set(t,this.data.get(t));this.clearCore(!1);for(const[t,n]of e.entries())this.setCore(t,n,!0)}makeLocal(e,t){if(t.type===ks[ks.Plain]||t.type===ks[ks.Shared])return this.localValueMaker.fromSerializable(t);throw new Error("Unknown local value type")}needProcessKeyOperation(e,t,n){if(this.pendingClearMessageIds.length>0)return t&&Object(he.a)(void 0!==n&&Ks(n)&&n.pendingMessageId<this.pendingClearMessageIds[0],19),!1;if(void 0!==this.pendingKeys.get(e.key)){if(t){Object(he.a)(void 0!==n&&Ks(n),20);const t=this.pendingKeys.get(e.key);Object(he.a)(void 0!==t&&t[0]===n.pendingMessageId,762),t.shift(),0===t.length&&this.pendingKeys.delete(e.key)}return!1}return!t}getMessageHandlers(){const e=new Map;return e.set("clear",{process:(e,t,n)=>{if(t){Object(he.a)(Ws(n),21);const e=this.pendingClearMessageIds.shift();Object(he.a)(e===n.pendingMessageId,763)}else this.pendingKeys.size>0?this.clearExceptPendingKeys():this.clearCore(t)},submit:(e,t)=>{Object(he.a)(Ws(t),764);const n=this.pendingClearMessageIds.shift();Object(he.a)(n===t.pendingMessageId,765),this.submitMapClearMessage(e,t.previousMap)},applyStashedOp:e=>{const t=new Map(this.data);return this.clearCore(!0),Js(0,this.getMapClearMessageId(),t)}}),e.set("delete",{process:(e,t,n)=>{this.needProcessKeyOperation(e,t,n)&&this.deleteCore(e.key,t)},submit:(e,t)=>{this.resubmitMapKeyMessage(e,t)},applyStashedOp:e=>{const t=this.deleteCore(e.key,!0);return Qs(0,this.getMapKeyMessageId(e),t)}}),e.set("set",{process:(e,t,n)=>{if(!this.needProcessKeyOperation(e,t,n))return;const i=this.makeLocal(e.key,e.value);this.setCore(e.key,i,t)},submit:(e,t)=>{this.resubmitMapKeyMessage(e,t)},applyStashedOp:e=>{const t=this.makeLocal(e.key,e.value),n=this.setCore(e.key,t,!0);return Qs(0,this.getMapKeyMessageId(e),n)}}),e}getMapClearMessageId(){const e=++this.pendingMessageId;return this.pendingClearMessageIds.push(e),e}submitMapClearMessage(e,t){const n=Js(0,this.getMapClearMessageId(),t);this.submitMessage(e,n)}getMapKeyMessageId(e){const t=++this.pendingMessageId,n=this.pendingKeys.get(e.key);return void 0!==n?n.push(t):this.pendingKeys.set(e.key,[t]),t}submitMapKeyMessage(e,t){const n=Qs(0,this.getMapKeyMessageId(e),t);this.submitMessage(e,n)}resubmitMapKeyMessage(e,t){Object(he.a)(Ks(t),766);const n=this.pendingKeys.get(e.key);Object(he.a)(void 0!==n&&n[0]===t.pendingMessageId,767),n.shift(),0===n.length&&this.pendingKeys.delete(e.key);const i=this.getMapKeyMessageId(e);this.submitMessage(e,"edit"===t.type?{type:"edit",pendingMessageId:i,previousValue:t.previousValue}:{type:"add",pendingMessageId:i})}}var Zs;const Ys="header";class eo{get type(){return eo.Type}get attributes(){return eo.Attributes}async load(e,t,n,i){const r=new to(t,e,i);return await r.load(n),r}create(e,t){const n=new to(t,e,eo.Attributes);return n.initializeLocal(),n}}eo.Type="https://graph.microsoft.com/types/map",eo.Attributes={type:eo.Type,snapshotFormatVersion:"0.2",packageVersion:As};class to extends Es{constructor(e,t,n){super(e,t,n,"fluid_map_"),this[Zs]="SharedMap",this.kernel=new Xs(this.serializer,this.handle,((e,t)=>this.submitLocalMessage(e,t)),(()=>this.isAttached()),this)}static create(e,t){return e.createChannel(t,eo.Type)}static getFactory(){return new eo}keys(){return this.kernel.keys()}entries(){return this.kernel.entries()}values(){return this.kernel.values()}[(Zs=Symbol.toStringTag,Symbol.iterator)](){return this.kernel.entries()}get size(){return this.kernel.size}forEach(e){this.kernel.forEach(e)}get(e){return this.kernel.get(e)}has(e){return this.kernel.has(e)}set(e,t){return this.kernel.set(e,t),this}delete(e){return this.kernel.delete(e)}clear(){this.kernel.clear()}summarizeCore(e,t){let n=0,i=0,r={};const s=[],o=new Ps,a=this.kernel.getSerializedStorage(e);for(const e of Object.keys(a)){const t=a[e];if(t.value&&t.value.length>=8192){const n=`blob${i}`;i++,s.push(n);const r={[e]:{type:t.type,value:JSON.parse(t.value)}};o.addBlob(n,JSON.stringify(r))}else{if(n+=t.type.length+21,t.value&&(n+=t.value.length),n>16384){const e=`blob${i}`;i++,s.push(e),o.addBlob(e,JSON.stringify(r)),r={},n=0}r[e]={type:t.type,value:void 0===t.value?void 0:JSON.parse(t.value)}}}return o.addBlob(Ys,JSON.stringify({blobs:s,content:r})),o.getSummaryTree()}async loadCore(e){const t=await Object(Fe.a)(e,Ys),n=t;Array.isArray(n.blobs)?(this.kernel.populateFromSerializable(n.content),await Promise.all(n.blobs.map((async t=>{const n=await Object(Fe.a)(e,t);this.kernel.populateFromSerializable(n)})))):this.kernel.populateFromSerializable(t)}onDisconnect(){}reSubmitCore(e,t){this.kernel.trySubmitMessage(e,t)}applyStashedOp(e){return this.kernel.tryApplyStashedOp(e)}processCore(e,t,n){e.type===qe.a.Operation&&this.kernel.tryProcessMessage(e.contents,t,n)}rollback(e,t){this.kernel.rollback(e,t)}}var no,io;!function(e){e.Detached="Detached",e.Attaching="Attaching",e.Attached="Attached"}(no||(no={})),function(e){e.genericError="genericError",e.throttlingError="throttlingError",e.dataCorruptionError="dataCorruptionError",e.dataProcessingError="dataProcessingError",e.usageError="usageError",e.clientSessionExpiredError="clientSessionExpiredError"}(io||(io={}));const ro=e=>"function"==typeof(null==e?void 0:e.getTelemetryProperties)&&"function"==typeof(null==e?void 0:e.addTelemetryProperties),so=e=>"string"==typeof(null==e?void 0:e.errorInstanceId);function oo(e){return"string"==typeof(null==e?void 0:e.errorType)&&"string"==typeof(null==e?void 0:e.message)&&so(e)&&ro(e)}function ao(e){return"string"==typeof(null==e?void 0:e.errorType)&&"string"==typeof(null==e?void 0:e.message)&&ro(e)}function co(e,t){const n={message:"string"==typeof(null==e?void 0:e.message)?e.message:String(e)};if((e=>null!==e&&!Array.isArray(e)&&"object"==typeof e)(e)){const{errorType:i,stack:r,name:s}=e;"string"==typeof i&&(n.errorType=i),"string"==typeof r&&(n.stack=((e,n)=>{if(!t)return e;const i=e.split("\n");return i.shift(),void 0!==n&&i.unshift(n),i.join("\n")})(r,"string"==typeof s?s:void 0))}return n}const lo=e=>"function"==typeof(null==e?void 0:e.getTelemetryProperties);function uo(e){void 0===e.errorInstanceId&&(e.errorInstanceId=Object(ge.a)())}function ho(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var n;if(ao(e)&&uo(e),oo(e))return e.addTelemetryProperties(null!==(n=t.props)&&void 0!==n?n:{}),e;const{message:i,stack:r}=co(e,!1),s=new Oo({message:i,stack:r});if("object"==typeof e&&null!==e){const{canRetry:t,retryAfterSeconds:n}=e;Object.assign(ho,{canRetry:t,retryAfterSeconds:n})}"object"!=typeof e&&s.addTelemetryProperties({typeofError:typeof e});const o=Co.typeCheck(e)?e.getTelemetryProperties():{untrustedOrigin:1};return s.addTelemetryProperties(Object.assign(Object.assign({},o),t.props)),s}let mo;function go(){const e=new Error("<<generated stack>>");if(void 0===mo&&(mo=void 0!==e.stack),mo)return e;try{throw e}catch(e){return e}}function po(){return go().stack}function fo(e,t){try{Object.assign(e,{stack:t})}catch(n){e.addTelemetryProperties({stack2:t})}}function vo(e){return Co.typeCheck(e)?e.errorType===wo&&1===e.getTelemetryProperties().untrustedOrigin:!ao(e)}function yo(e){var t;return"string"==typeof(null===(t=e)||void 0===t?void 0:t.tag)}function bo(e,t){return Array.isArray(e)&&e.every((e=>So(e)))?JSON.stringify(e):So(e)?e:(console.error(`UnSupported Format of Logging Error Property for key ${t}:`,e),"REDACTED (arbitrary object)")}function So(e){switch(typeof e){case"string":case"number":case"boolean":case"undefined":return!0;default:return!1}}class Co extends Error{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Set;super(e),this.omitPropsFromLogging=n,this._errorInstanceId=Object(ge.a)(),this.fluidErrorCode="-",n.add("omitPropsFromLogging"),n.add("_errorInstanceId"),t&&this.addTelemetryProperties(t)}get errorInstanceId(){return this._errorInstanceId}overwriteErrorInstanceId(e){this._errorInstanceId=e}static typeCheck(e){return"object"==typeof e&&null!==e&&"function"==typeof e.addTelemetryProperties&&"function"==typeof e.getTelemetryProperties&&"string"==typeof e.errorInstanceId}addTelemetryProperties(e){!function(e,t){for(const n of Object.keys(t))void 0===e[n]&&(e[n]=t[n])}(this,e)}getTelemetryProperties(){const e=function(e,t){const n={};for(const i of Object.keys(e)){if(t.has(i))continue;const r=e[i];n[i]=yo(r)?{value:bo(r.value,i),tag:r.tag}:bo(r,i)}return n}(this,this.omitPropsFromLogging);return Object.assign(Object.assign({},e),{stack:this.stack,message:this.message,errorInstanceId:this._errorInstanceId})}}const wo="genericError";class Oo extends Co{constructor(e){super(e.message),this.errorType=wo,void 0!==e.stack&&fo(this,e.stack)}}class Io extends Co{constructor(e,t){super(e,Object.assign(Object.assign({},t),{usageError:!0})),this.errorType=io.usageError}}class No extends Co{constructor(e,t){super(e,Object.assign(Object.assign({},t),{dataProcessingError:1})),this.errorType=io.dataCorruptionError,this.canRetry=!1}}class To extends Co{constructor(e){super(e),this.errorType=io.dataProcessingError,this.canRetry=!1}static create(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const r=To.wrapIfUnrecognized(e,t,n);return r.addTelemetryProperties(i),r}static wrapIfUnrecognized(e,t,n){const i=ho(e,{props:Object.assign({dataProcessingError:1,dataProcessingCodepath:t},void 0===n?void 0:Eo(n))});if(vo(i)||i.errorType===wo){const e=function(e,t){const{message:n,stack:i}=co(e,!1),r=(e=>new To(e))(n);return void 0!==i&&fo(r,i),vo(e)&&r.addTelemetryProperties({untrustedOrigin:1}),so(e)&&(r.overwriteErrorInstanceId(e.errorInstanceId),r.addTelemetryProperties({innerErrorInstanceId:e.errorInstanceId})),lo(e)&&r.addTelemetryProperties(e.getTelemetryProperties()),r}(i);return e.addTelemetryProperties(i.getTelemetryProperties()),e}return i}}const Eo=e=>({messageClientId:e.clientId,messageSequenceNumber:e.sequenceNumber,messageClientSequenceNumber:e.clientSequenceNumber,messageReferenceSequenceNumber:e.referenceSequenceNumber,messageMinimumSequenceNumber:e.minimumSequenceNumber,messageTimestamp:e.timestamp});var ko;!function(e){e.CodeArtifact="CodeArtifact",e.UserData="UserData"}(ko||(ko={}));class jo{constructor(e,t){this.namespace=e,this.properties=t}static formatTick(e){return Math.floor(e)}static numberFromString(e){if(null==e)return;const t=Number(e);return Number.isNaN(t)?e:t}static sanitizePkgName(e){return e.replace("@","").replace("/","-")}static prepareErrorObject(e,t,n){const{message:i,errorType:r,stack:s}=co(t,!0);if(e.stack=s,e.error=i,e.errorType=r,lo(t)){const n=t.getTelemetryProperties();for(const t of Object.keys(n))void 0===e[t]&&(e[t]=n[t])}void 0===e.stack&&n&&(e.stack=po())}sendTelemetryEvent(e,t){var n;this.sendTelemetryEventCore(Object.assign(Object.assign({},e),{category:null!==(n=e.category)&&void 0!==n?n:"generic"}),t)}sendTelemetryEventCore(e,t){const n=function(e){var{category:t,eventName:n}=e,i=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n}(e,["category","eventName"]);const r={category:t,eventName:n};for(const e of Object.keys(i))r[e]=Mo(i[e]);return r}(e);void 0!==t&&jo.prepareErrorObject(n,t,!1),"number"==typeof n.duration&&(n.duration=jo.formatTick(n.duration)),this.send(n)}sendErrorEvent(e,t){this.sendTelemetryEventCore(Object.assign(Object.assign({error:e.eventName},e),{category:"error"}),t)}sendPerformanceEvent(e,t){var n;const i=Object.assign(Object.assign({},e),{category:null!==(n=e.category)&&void 0!==n?n:"performance"});this.sendTelemetryEventCore(i,t)}prepareEvent(e){const t="error"===e.category||void 0!==e.error,n=Object.assign({},e);if(void 0!==this.namespace&&(n.eventName=`${this.namespace}${jo.eventNamespaceSeparator}${n.eventName}`),this.properties){const i=[];i.push(this.properties.all),t&&i.push(this.properties.error);for(const t of i)if(void 0!==t)for(const i of Object.keys(t)){if(void 0!==e[i])continue;const r=t[i],s="function"==typeof r?r():r;void 0!==s&&(n[i]=s)}}return n}}jo.eventNamespaceSeparator=":";class Po extends jo{constructor(e,t,n){super(t,n),this.baseLogger=e,Lo(e)&&Vo(this,new Bo(this,e.config))}static create(e,t,n){if(e instanceof Po){const i={};for(const t of[e.properties,n])void 0!==t&&(void 0!==t.all&&(i.all=Object.assign(Object.assign({},i.all),t.all)),void 0!==t.error&&(i.error=Object.assign(Object.assign({},i.error),t.error)));return new Po(e.baseLogger,void 0===e.namespace?t:void 0===t?e.namespace:`${e.namespace}${jo.eventNamespaceSeparator}${t}`,i)}return new Po(e||new _o,t,n)}send(e){this.baseLogger.send(this.prepareEvent(e))}}class _o{send(e){}}function Mo(e){return yo(e)?{value:Do(e.value),tag:e.tag}:Do(e)}function Do(e){switch(typeof e){case"string":case"number":case"boolean":case"undefined":return e;case"object":return JSON.stringify(e);default:return console.error(`convertToBasePropertyTypeUntagged: INVALID PROPERTY (typed as ${typeof e})`),`INVALID PROPERTY (typed as ${typeof e})`}}const xo=new Ve.a((()=>Ro(zo()))),Ao={getRawConfig:()=>{}},Ro=e=>null!=e?new Bo(void 0,{getRawConfig:t=>{var n,i;try{return null===(i=qo(null!==(n=e.getItem(t))&&void 0!==n?n:void 0))||void 0===i?void 0:i.raw}catch(e){}}}):Ao;function Fo(e){switch(e){case"boolean":case"number":case"string":return!0;default:return!1}}function qo(e){let t,n=e;if("string"==typeof e)try{n=JSON.parse(e),t={raw:e,string:e}}catch(e){}if(void 0===n)return t;const i=typeof n;if(Fo(i))return Object.assign(Object.assign({},t),{raw:e,[i]:n});if(Array.isArray(n)){const i=typeof n[0];if(!Fo(i))return t;for(const e of n)if(typeof e!==i)return t;return Object.assign(Object.assign({},t),{raw:e,[`${i}[]`]:n})}return t}const zo=()=>{var e;try{return null!==(e=globalThis.sessionStorage)&&void 0!==e?e:void 0}catch(e){return}};class Bo{constructor(e){this.logger=e,this.configCache=new Map,this.orderedBaseProviders=[];const t=new Set;for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];const s=[...i];for(;s.length>0;){const e=s.shift();void 0!==e&&Uo(e)&&!t.has(e)&&(t.add(e),e instanceof Bo?s.push(...e.orderedBaseProviders):this.orderedBaseProviders.push(e))}}getBoolean(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.boolean}getNumber(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.number}getString(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.string}getBooleanArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["boolean[]"]}getNumberArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["number[]"]}getStringArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["string[]"]}getRawConfig(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.raw}getCacheEntry(e){var t;if(!this.configCache.has(e)){for(const n of this.orderedBaseProviders){const i=qo(null==n?void 0:n.getRawConfig(e));if(void 0!==i)return this.configCache.set(e,i),null===(t=this.logger)||void 0===t||t.send({category:"generic",eventName:"ConfigRead",configName:{tag:ko.CodeArtifact,value:e},configValue:{tag:ko.CodeArtifact,value:JSON.stringify(i)}}),i}this.configCache.set(e,{raw:void 0})}return this.configCache.get(e)}}function Lo(e){const t=e;return Uo(null==t?void 0:t.config)&&void 0!==(null==t?void 0:t.logger)}function Vo(e){if(Lo(e))throw new Error("Logger is already a monitoring context");const t=e;for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];return t.config=new Bo(e,...i),t.logger=e,t}function Uo(e){return"function"==typeof(null==e?void 0:e.getRawConfig)}var Ho=n("sXgR");function Go(e){return e?{value:e.join("/"),tag:ko.CodeArtifact}:void 0}const $o=e=>Ko(404,"not found",e);function Ko(e,t,n,i){var r;Object(he.a)(200!==e,411);const s=null===(r=n.url)||void 0===r?void 0:r.split("?")[0],o=go();return{mimeType:"text/plain",status:e,value:void 0===s?t:`${t}: ${s}`,get stack(){return o.stack},headers:i}}function Wo(e,t){if(""===e)return void 0===t?"":t.absolutePath;{let n=e.startsWith("/")?e.slice(1):e;return n=n.endsWith("/")?n.slice(0,-1):n,void 0===t?`/${n}`:`${"/"===t.absolutePath?"":t.absolutePath}/${n}`}}class Jo{constructor(e){this.request=e;const t=this.request.url.indexOf("?");this.query=t>=0?this.request.url.substring(t):""}static getPathParts(e){const t=e.indexOf("?");return e.substring(0,t<0?e.length:t).split("/").reduce(((e,t)=>(void 0!==t&&t.length>0&&e.push(decodeURIComponent(t)),e)),[])}static create(e){return e instanceof Jo?e:new Jo(e)}get url(){return this.request.url}get headers(){return this.request.headers}get pathParts(){return void 0===this.requestPathParts&&(this.requestPathParts=Jo.getPathParts(this.url)),this.requestPathParts}isLeaf(e){return""===this.query&&this.pathParts.length===e}createSubRequest(e){const t=this.pathParts.length;if(e<0||e>t)throw new Error("incorrect sub-request");if(e===t&&this.url.includes("?"))return{url:`/${this.query}`,headers:this.headers};const n=`/${this.pathParts.slice(e).join("/")}`;return{url:""===this.query?n:`${n}/${this.query}`,headers:this.headers}}}function Qo(){const e={treeNodeCount:0,blobNodeCount:0,handleNodeCount:0,totalBlobSize:0,unreferencedBlobSize:0};for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];for(const t of n)e.treeNodeCount+=t.treeNodeCount,e.blobNodeCount+=t.blobNodeCount,e.handleNodeCount+=t.handleNodeCount,e.totalBlobSize+=t.totalBlobSize,e.unreferencedBlobSize+=t.unreferencedBlobSize;return e}function Xo(e,t,n){e.summary.tree[t]={type:ln.a.Blob,content:n},e.stats.blobNodeCount++,e.stats.totalBlobSize+=function(e){return"string"==typeof e?function(e){let t=e.length;for(let n=e.length-1;n>=0;n--){const i=e.charCodeAt(n);i>127&&i<=2047?t++:i>2047&&i<=65535&&(t+=2),i>=56320&&i<=57343&&n--}return t}(e):e.byteLength}(n)}class Zo{constructor(){this.attachmentCounter=0,this.summaryTree={},this.summaryStats=Qo(),this.summaryStats.treeNodeCount++}get summary(){return{type:ln.a.Tree,tree:Object.assign({},this.summaryTree)}}get stats(){return Object.assign({},this.summaryStats)}addBlob(e,t){Xo({summary:{type:ln.a.Tree,tree:this.summaryTree},stats:this.summaryStats},e,t)}addHandle(e,t,n){this.summaryTree[e]={type:ln.a.Handle,handleType:t,handle:n},this.summaryStats.handleNodeCount++}addWithStats(e,t){this.summaryTree[e]=t.summary,this.summaryStats=Qo(this.summaryStats,t.stats)}addAttachment(e){this.summaryTree[this.attachmentCounter++]={id:e,type:ln.a.Attachment}}getSummaryTree(){return{summary:this.summary,stats:this.stats}}}function Yo(e){const t=new Zo;for(const[n,i]of Object.entries(e.blobs)){let r;if(void 0!==e.blobsContents){const t=e.blobsContents[i];void 0!==t&&(r=Object(yn.c)(t,"utf-8"))}else void 0!==e.blobs[i]&&(r=Object(bn.a)(e.blobs[i]));void 0!==r&&t.addBlob(n,r)}for(const[n,i]of Object.entries(e.trees)){const e=Yo(i);t.addWithStats(n,e)}const n=t.getSummaryTree();return n.summary.unreferenced=e.unreferenced,n}function ea(e){const t=[];for(const[n,i]of Object.entries(e.tree))switch(i.type){case ln.a.Blob:{let e,r="utf-8";"string"==typeof i.content?e=i.content:(e=Object(yn.b)(i.content,"base64"),r="base64"),t.push(new Sn.b(n,e,r));break}case ln.a.Tree:t.push(new Sn.c(n,ea(i)));break;case ln.a.Attachment:t.push(new Sn.a(n,i.id));break;case ln.a.Handle:throw new Error("Should not have Handle type in summary tree");default:Object(dt.a)(i,"Unexpected summary tree type")}return{entries:t,unreferenced:e.unreferenced}}function ta(e){return e.replace(/^\/+/g,"")}function na(e){return e.replace(/\/+$/g,"")}class ia{constructor(){this.gcNodesSet={}}get gcNodes(){const e={};for(const[t,n]of Object.entries(this.gcNodesSet))e[t]=[...n];return e}addNode(e,t){this.gcNodesSet[e]=new Set(t)}prefixAndAddNodes(e,t){for(const[n,i]of Object.entries(t)){let t=ta(n);t=`/${e}/${t}`,t=na(t),this.gcNodesSet[t]=new Set(i)}}addNodes(e){for(const[t,n]of Object.entries(e))this.gcNodesSet[t]=new Set(n)}addRouteToAllNodes(e){for(const t of Object.values(this.gcNodesSet))t.add(e)}getGCData(){return{gcNodes:this.gcNodes}}}class ra{constructor(e,t,n,i){this.tree=e,this.storage=t,this.logger=n,this.extraBlobs=i,this.flattenedTree={},void 0!==e&&ra.flattenTree("",e,this.flattenedTree)}static flattenTree(e,t,n){for(const i in t.trees)ra.flattenTree(`${e}${i}/`,t.trees[i],n);for(const i in t.blobs)n[`${e}${i}`]=t.blobs[i]}sync readBlob(e){const t=await this.getIdForPath(e),n=void 0!==this.extraBlobs?this.extraBlobs.get(t):void 0;if(void 0!==n)return n;const i=this.storage.readBlob(t);return i.catch((e=>this.logger.sendErrorEvent({eventName:"ChannelStorageBlobError"},e))),i}async list(e){var t;let n=this.tree;const i=function(e){let t=e;return t.startsWith("/")&&(t=t.substr(1)),t.endsWith("/")&&(t=t.substr(0,t.length-1)),t.length>0?t.split("/"):[]}(e);for(;void 0!==n&&i.length>0;){const e=i.shift();n=n.trees[e]}if(void 0===n||0!==i.length)throw new Error("path does not exist");return Object.keys(null!==(t=null==n?void 0:n.blobs)&&void 0!==t?t:{})}class sa{constructor(e,t,n,i){this._connected=e,this.submit=t,this.dirty=n,this.addedGCOutboundReference=i}get handler(){return Object(he.a)(!!this._handler,375),this._handler}get connected(){return this._connected}attach(e){Object(he.a)(void 0===this._handler,376),this._handler=e}rocess(e,t,n){try{this.handler.process(e,t,n)}catch(t){throw To.wrapIfUnrecognized(t,"channelDeltaConnectionFailedToProcessMessage",e)}}reSubmit(e,t){this.handler.reSubmit(e,t)}rollback(e,t){if(void 0===this.handler.rollback)throw new Error("Handler doesn't support rollback");this.handler.rollback(e,t)}applyStashedOp(e){return this.handler.applyStashedOp(e)}}const oa=".attributes";function aa(e,t,n,i,r,s,o,a){return{deltaConnection:new sa(e,(,n,i),objectStorage:new ra(o,r,s,a)}}function ca(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3?arguments[3]:void 0;const r=e.getAttachSummary(t,n,i);return Xo(r,oa,JSON.stringify(e.attributes)),r}async function la(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3?arguments[3]:void 0,r=arguments.length>4?arguments[4]:void 0;const s=await e.summarize(t,n,i,r);return Xo(s,oa,JSON.stringify(e.attributes)),s}async function da(e,t,n,i,r){let s;await t.objectStorage.contains(oa)&&(s=await Object(Fe.a)(t.objectStorage,oa));const o=s?s.type:r;if(void 0===o)throw new No("channelTypeNotAvailable",{channelId:{value:n,tag:ko.CodeArtifact},dataStoreId:{value:e.id,tag:ko.CodeArtifact},dataStorePackagePath:e.packagePath.join("/"),channelFactoryType:r});const a=i.get(o);if(void 0===a)throw new No("channelFactoryNotRegisteredForGivenType",{channelId:{value:n,tag:ko.CodeArtifact},dataStoreId:{value:e.id,tag:ko.CodeArtifact},dataStorePackagePath:e.packagePath.join("/"),channelFactoryType:o});return s=null!=s?s:a.attributes,{factory:a,attributes:s}}async function ua(e,t,n,i,r,s){return void 0!==t.snapshotFormatVersion&&t.snapshotFormatVersion!==n.attributes.snapshotFormatVersion&&r.sendTelemetryEvent({eventName:"ChannelAttributesVersionMismatch",channelType:{value:t.type,tag:ko.CodeArtifact},channelSnapshotVersion:{value:`${t.snapshotFormatVersion}@${t.packageVersion}`,tag:ko.CodeArtifact},channelCodeVersion:{value:`${n.attributes.snapshotFormatVersion}@${n.attributes.packageVersion}`,tag:ko.CodeArtifact}}),n.load(e,s,i,t)}var ha,ma=n("yEOx"),ga=n.n(ma);class pa{constructor(e,t,n,i,r){this.id=e,this.runtime=t,this.services=n,this.channelP=i,this._channel=r,this.globallyVisible=!1,this.pending=[],Object(he.a)(!this.id.includes("/"),783)}async getChannel(){return void 0===this._channel?this.channelP.then(():this.channelP}get isLoaded(){return void 0!==this._channel}setConnectionState(e,t){this.globallyVisible&&this.isLoaded&&this.services.value.deltaConnection.setConnectionState(e)}processOp(e,t,n){Object(he.a)(this.globallyVisible,723),this.isLoaded?this.services.value.deltaConnection.process(e,t,n):(Object(he.a)(!1===t,393),this.pending.push(e))}reSubmit(e,t){Object(he.a)(this.isLoaded,394),Object(he.a)(this.globallyVisible,724),this.services.value.deltaConnection.reSubmit(e,t)}rollback(e,t){Object(he.a)(this.isLoaded,750),Object(he.a)(this.globallyVisible,751),this.services.value.deltaConnection.rollback(e,t)}applyStashedOp(){throw new Error("no stashed ops on local channel")}async summarize(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2?arguments[2]:void 0;return la(await this.getChannel(),e,t,n)}getAttachSummary(e){return Object(he.a)(void 0!==this._channel,397),ca(this._channel,!0,!1,e)}makeVisible(){if(this.globallyVisible)throw new Error("Channel is already globally visible");this.isLoaded&&(Object(he.a)(!!this._channel,402),this._channel.connect(this.services.value)),this.globallyVisible=!0}async getGCData(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.getChannel()).getGCData(e)}updateUsedRoutes(e){}}class fa extends pa{constructor(e,t,n,i,r,s,o,a,c,l){super(e,n,new Ve.a((()=>{const e=new Map,t=ga()(this.snapshotTree);return this.isSnapshotInOldFormatAndCollectBlobs(t,e)&&this.sanitizeSnapshot(t),aa(i.connected,o,this.dirtyFn,c,r,s,t,e)})),new lt.b((async()=>{try{const{attributes:e,factory:r}=await da(i,this.services.value,this.id,t),o=await ua(n,e,r,this.services.value,s,this.id);for(const e of this.pending)this.services.value.deltaConnection.process(e,!1,void 0);return o}catch(e){throw To.wrapIfUnrecognized(e,"rehydratedLocalChannelContextFailedToLoadChannel",void 0)}}))),this.snapshotTree=l,this.dirtyFn=()=>{a(e)}}isSnapshotInOldFormatAndCollectBlobs(e,t){let n=!1;Object.entries(e.blobsContents).forEach((i=>{let[r,s]=i;t.set(r,s),void 0!==e.blobs[r]&&(n=!0)}));for(const i of Object.values(e.trees))n=n||this.isSnapshotInOldFormatAndCollectBlobs(i,t);return n}sanitizeSnapshot(e){const t=new Map(Object.entries(e.blobs));for(const[n,i]of t.entries())void 0===t.get(i)&&delete e.blobs[n];for(const t of Object.values(e.trees))this.sanitizeSnapshot(t)}}class va extends pa{constructor(e,t,n,i,r,s,o,a,c,l){Object(he.a)(void 0!==n,521);const d=t.get(n);if(void 0===d)throw new Error(`Channel Factory ${n} not registered`);const u=d.create(i,e);super(e,i,new Ve.a((()=>aa(r.connected,a,this.dirtyFn,l,s,o))),Promise.resolve(u),u),this.channel=u,this.dirtyFn=}class ya{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;this.threshold=e,this.logger=t,this.thresholdMultiple=n}send(e,t){t<this.threshold||this.logger.sendPerformanceEvent({eventName:e,value:t})}sendIfMultiple(e,t){t===this.thresholdMultiple&&(this.logger.sendPerformanceEvent({eventName:e,value:t}),this.thresholdMultiple=2*this.thresholdMultiple)}}class ba{constructor(e,t,n,i,r,s,o,a,c,l,d,u){this.id=o,this.isLoaded=!1,this.pending=[],Object(he.a)(!this.id.includes("/"),784),this.subLogger=Po.create(e.logger,"RemoteChannelContext"),this.services=aa(t.connected,i,(,s,n,this.subLogger,a,l),this.channelP=new lt.b((async()=>{const{attributes:n,factory:i}=await da(t,this.services,this.id,c,u),r=await ua(e,n,i,this.services,this.subLogger,this.id);Object(he.a)(void 0!==this.pending,575);for(const e of this.pending)this.services.deltaConnection.process(e,!1,void 0);return this.thresholdOpsCounter.send("ProcessPendingOps",this.pending.length),this.channel=r,this.pending=void 0,this.isLoaded=!0,this.services.deltaConnection.setConnectionState(t.connected),this.channel})),this.summarizerNode=d((async(e,t,n,i)=>this.summarizeInternal(e,t,n,i)),(async e=>this.getGCDataInternal(e))),this.thresholdOpsCounter=new ya(ba.pendingOpsCountThreshold,this.subLogger)}getChannel(){return this.channelP}pplyStashedOp(e){return Object(he.a)(this.isLoaded,404),this.services.deltaConnection.applyStashedOp(e)}processOp(e,t,n){this.summarizerNode.invalidate(e.sequenceNumber),this.isLoaded?this.services.deltaConnection.process(e,t,n):(Object(he.a)(!t,405),Object(he.a)(void 0!==this.pending,574),this.pending.push(e),this.thresholdOpsCounter.sendIfMultiple("StorePendingOps",this.pending.length))}reSubmit(e,t){Object(he.a)(this.isLoaded,406),this.services.deltaConnection.reSubmit(e,t)}rollback(e,t){Object(he.a)(this.isLoaded,752),this.services.deltaConnection.rollback(e,t)}async summarize(){return this.summarizerNode.summarize(arguments.length>0&&void 0!==arguments[0]&&arguments[0],!(arguments.length>1&&void 0!==arguments[1])||arguments[1],arguments.length>2?arguments[2]:void 0)}async summarizeInternal(e,t,n,i){const r=await this.getChannel(),s=await la(r,e,t,n,i);return Object.assign(Object.assign({},s),{id:this.id})}async getGCData(){return this.summarizerNode.getGCData(arguments.length>0&&void 0!==arguments[0]&&arguments[0])}async getGCDataInternal(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.getChannel()).getGCData(e)}updateUsedRoutesba.pendingOpsCountThreshold=1e3;class Sa{constructor(e,t,n){this.value=e,this.path=t,this.routeContext=n,this.pendingHandlesToMakeVisible=new Set,this.locallyVisible=!1,this.absolutePath=Wo(t,this.routeContext)}get IFluidHandle(){return this}get isAttached(){return this.routeContext.isAttached}get visible(){return this.isAttached||this.locallyVisible}async get(){return this.value}attachGraph(){this.visible||(this.locallyVisible=!0,this.pendingHandlesToMakeVisible.forEach((e=>{e.attachGraph()})),this.pendingHandlesToMakeVisible.clear(),this.routeContext.attachGraph())}bind(e){this.visible?e.attachGraph():this.pendingHandlesToMakeVisible.add(e)}}!function(e){e.Attach="attach",e.ChannelOp="op"}(ha||(ha={}));class Ca extends me.a{constructor(e,t,n,i){var r;super(),this.dataStoreContext=e,this.sharedObjectRegistry=t,this._disposed=!1,this.contexts=new Map,this.contextsDeferred=new Map,this.pendingAttach=new Map,this.deferredAttached=new lt.a,this.localChannelContextQueue=new Map,this.notBoundedChannelContextSet=new Set,this.pendingHandlesToMakeVisible=new Set,Object(he.a)(!e.id.includes("/"),782),this.mc=function(e){return Lo(e)?e:Vo(e,xo.value)}(Po.create(e.logger,"FluidDataStoreRuntime",{all:{dataStoreId:Object(ge.a)()}})),this.id=e.id,this.options=e.options,this.deltaManager=e.deltaManager,this.quorum=e.getQuorum(),this.audience=e.getAudience();const s=e.baseSnapshot;if(void 0!==(null==s?void 0:s.trees)&&Object.keys(s.trees).forEach((t=>{if("_search"===t)return;let n;e.isLocalDataStore?(n=new fa(t,this.sharedObjectRegistry,this,this.dataStoreContext,this.dataStoreContext.storage,this.logger,((e,n)=>this.submitChannelOp(t,e,n)),(e=>this.setChannelDirty(e)),((e,t)=>this.addedGCOutboundReference(e,t)),s.trees[t]),e.attachState!==no.Detached?n.makeVisible():this.localChannelContextQueue.set(t,n)):n=new ba(this,e,e.storage,((e,n)=>this.submitChannelOp(t,e,n)),(e=>this.setChannelDirty(e)),((e,t)=>this.addedGCOutboundReference(e,t)),t,s.trees[t],this.sharedObjectRegistry,void 0,this.dataStoreContext.getCreateChildSummarizerNodeFn(t,{type:Ho.CreateSummarizerNodeSource.FromSummary}));const i=new lt.a;i.resolve(n),this.contexts.set(t,n),this.contextsDeferred.set(t,i)})),i){const e=new lt.b(();this.entryPoint=new Sa(e,"",this.objectsRoutingContext)}this.attachListener(),this._attachState=e.attachState,this.visibilityState=n?e.attachState===no.Detached?Ho.VisibilityState.LocallyVisible:Ho.VisibilityState.GloballyVisible:Ho.VisibilityState.NotVisible,n&&this.deferredAttached.resolve(),this.localChangesTelemetryCount=null!==(r=this.mc.config.getNumber("Fluid.Telemetry.LocalChangesTelemetryCount"))&&void 0!==r?r:10}static load(e,t,n){return new Ca(e,t,n,(async e=>async function(e,t){const n={url:"/"},i=await e.request(n);if(200!==i.status||"fluid/object"!==i.mimeType)throw function(e,t){const n=e.value,i=go();return{errorFromRequestFluidObject:!0,message:n,name:"Error",code:e.status,get stack(){var t;return null!==(t=e.stack)&&void 0!==t?t:i.stack},underlyingResponseHeaders:e.headers}}(i);return Object(he.a)(i.value,410),i.value}(e)))}get IFluidRouter(){return this}get connected(){return this.dataStoreContext.connected}get clientId(){return this.dataStoreContext.clientId}get clientDetails(){return this.dataStoreContext.clientDetails}et attachState(){return this._attachState}et routeContext(){return this.dataStoreContext.IFluidHandleContext}get idCompressor(){return this.dataStoreContext.idCompressor}get IFluidHandleContext(){return this}get rootRoutingContext(){return this}get channelsRoutingContext(){return this}get objectsRoutingContext(){return this}get disposed(){return this._disposed}get logger(){return this.mc.logger}ensureNoDataModelChanges(e){return void 0===this.dataStoreContext.ensureNoDataModelChanges?e():this.dataStoreContext.ensureNoDataModelChanges(e)}disposesync resolveHandle(e){return this.request(e)}async request(e){try{const t=Jo.create(e),n=t.pathParts[0];if("_channels"===n||"_custom"===n)return this.request(t.createSubRequest(1));if(this.contextsDeferred.has(n)&&t.isLeaf(1))try{const e=await this.contextsDeferred.get(n).promise;return{mimeType:"fluid/object",status:200,value:await e.getChannel()}}catch(t){return this.mc.logger.sendErrorEvent({eventName:"GetChannelFailedInRequest"},t),Ko(500,`Failed to get Channel: ${t}`,e)}return $o(e)}catch(e){return function(e){if(null!==e&&"object"==typeof e&&!0===e.errorFromRequestFluidObject){const t=e;return{mimeType:"text/plain",status:t.code,value:t.message,get stack(){return t.stack},headers:t.underlyingResponseHeaders}}const t=go();return{mimeType:"text/plain",status:500,value:`${e}`,get stack(){var n;return null!==(n=null==e?void 0:e.stack)&&void 0!==n?n:t.stack}}}(e)}}async getChannel(e){this.verifyNotClosed(),this.contextsDeferred.has(e)||this.contextsDeferred.set(e,new lt.a);const t=await this.contextsDeferred.get(e).promise;return await t.getChannel()}createChannel(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Object(ge.a)(),t=arguments.length>1?arguments[1]:void 0;if(e.includes("/"))throw new Io(`Id cannot contain slashes: ${e}`);this.verifyNotClosed(),Object(he.a)(!this.contexts.has(e),377),this.notBoundedChannelContextSet.add(e);const n=new va(e,this.sharedObjectRegistry,t,this,this.dataStoreContext,this.dataStoreContext.storage,this.logger,((t,n)=>this.submitChannelOp(e,t,n)),(e=>this.setChannelDirty(e)),((e,t)=>this.addedGCOutboundReference(e,t)));if(this.contexts.set(e,n),this.contextsDeferred.has(e))this.contextsDeferred.get(e).resolve(n);else{const t=new lt.a;t.resolve(n),this.contextsDeferred.set(e,t)}return this.identifyLocalChangeInSummarizer("DDSCreatedInSummarizer",e,t),n.channel}bindChannel(e){Object(he.a)(this.notBoundedChannelContextSet.has(e.id),379),this.notBoundedChannelContextSet.delete(e.id),this.isAttached?this.attachChannel(e):this.pendingHandlesToMakeVisible.has(e.handle)||(this.bind(e.handle),this.localChannelContextQueue.has(e.id)||this.localChannelContextQueue.set(e.id,this.contexts.get(e.id)))}makeVisibleAndAttachGraph(){this.visibilityState===Ho.VisibilityState.NotVisible&&(this.visibilityState=Ho.VisibilityState.LocallyVisible,this.pendingHandlesToMakeVisible.forEach((e=>{e.attachGraph()})),this.pendingHandlesToMakeVisible.clear(),this.dataStoreContext.makeLocallyVisible())}attachGraph(){this.makeVisibleAndAttachGraph()}bindToContext(){this.makeVisibleAndAttachGraph()}bind(e){this.visibilityState===Ho.VisibilityState.NotVisible?this.pendingHandlesToMakeVisible.add(e):e.attachGraph()}setConnectionState(e,t){this.verifyNotClosed();for(const[,n]of this.contexts)n.setConnectionState(e,t);!function(e,t,n,i,r){try{n?t.emit("connected",i):t.emit("disconnected",void 0)}catch(t){e.sendErrorEvent({eventName:"RaiseConnectedEventError"},t)}}(this.logger,this,e,t)}getQuorum(){return this.quorum}getAudience(){return this.audience}rocess(e,t,n){this.verifyNotClosed();try{switch(e.type){case ha.Attach:{const n=e.contents,i=n.id;if(t)Object(he.a)(this.pendingAttach.has(i),380),this.pendingAttach.delete(i);else{Object(he.a)(!this.contexts.has(i),381);const t=new Map,r=vi(n.snapshot.entries,t),s=new ba(this,this.dataStoreContext,this.dataStoreContext.storage,(,(e=>this.setChannelDirty(e)),((e,t)=>this.addedGCOutboundReference(e,t)),i,r,this.sharedObjectRegistry,t,this.dataStoreContext.getCreateChildSummarizerNodeFn(i,{type:Ho.CreateSummarizerNodeSource.FromAttach,sequenceNumber:e.sequenceNumber,snapshot:n.snapshot}),n.type);if(this.contexts.set(i,s),this.contextsDeferred.has(i))this.contextsDeferred.get(i).resolve(s);else{const e=new lt.a;e.resolve(s),this.contextsDeferred.set(i,e)}}break}case ha.ChannelOp:this.processChannelOp(e,t,n)}this.emit("op",e)}catch(t){throw To.wrapIfUnrecognized(t,"fluidDataStoreRuntimeFailedToProcessMessage",e)}}sChannelAttached(e){return!this.notBoundedChannelContextSet.has(e)&&!this.localChannelContextQueue.has(e)&&!this.pendingAttach.has(e)}getOutboundRoutes(){const e=[];for(const[t]of this.contexts)e.push(`${this.absolutePath}/${t}`);return e}updateGCNodes(e){e.addRouteToAllNodes(this.absolutePath),e.addNode("/",this.getOutboundRoutes())}async getGCData(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t=new ia;return await Promise.all(Array.from(this.contexts).filter((e=>{let[t,n]=e;return this.isChannelAttached(t)})).map((async n=>{let[i,r]=n;const s=await r.getGCData(e);t.prefixAndAddNodes(i,s.gcNodes)}))),this.updateGCNodes(t),t.getGCData()}updateUsedRoutes(e){var t;const n=function(e){const t=e.filter((e=>""!==e&&"/"!==e)),n=new Map;for(const e of t){Object(he.a)(e.startsWith("/"),1504);const t=e.split("/")[1],i=e.slice(t.length+1),r=n.get(t);void 0!==r?r.push(i):n.set(t,[i])}return n}(e);for(const[e]of n)Object(he.a)(this.contexts.has(e),382);for(const[e,i]of this.contexts)i.updateUsedRoutes(null!==(t=n.get(e))&&void 0!==t?t:[])}sync summarize(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2?arguments[2]:void 0;const i=new Zo;return await Promise.all(Array.from(this.contexts).filter((e=>{let[t,n]=e;const i=this.isChannelAttached(t);return Object(he.a)(i,383),i})).map((async r=>{let[s,o]=r;const a=await o.summarize(e,t,n);i.addWithStats(s,a)}))),i.getSummaryTree()}getAttachSummary(e){this.attachGraph();const t=new Zo;for(const[n,i]of this.contexts){if(!(i instanceof pa))throw new Co("Should only be called with local channel handles");if(!this.notBoundedChannelContextSet.has(n)){let r;if(i.isLoaded){const t=i.getAttachSummary(e);Object(he.a)(t.summary.type===ln.a.Tree,384),r={stats:t.stats,summary:t.summary}}else Object(he.a)(!!this.dataStoreContext.baseSnapshot,385),r=Yo(this.dataStoreContext.baseSnapshot.trees[n]);t.addWithStats(n,r)}}return t.getSummaryTree()}ync waitAttached(){return this.deferredAttached.promise}attachChannel(e){if(this.verifyNotClosed(),e.handle.isAttached)return;e.handle.attachGraph(),Object(he.a)(this.isAttached,386),Object(he.a)(this.visibilityState===Ho.VisibilityState.GloballyVisible,720);const t=ea(ca(e,!0,!1).summary),n={id:e.id,snapshot:t,type:e.attributes.type};this.pendingAttach.set(e.id,n),this.submit(ha.Attach,n),this.contexts.get(e.id).makeVisible()}submitChannelOp(e,t,n){this.submit(ha.ChannelOp,{address:e,contents:t},n)}submit(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;this.verifyNotClosed(),this.dataStoreContext.submitMessage(e,t,n)}reSubmit(e,t,n){switch(this.verifyNotClosed(),e){case ha.ChannelOp:{const e=t,i=this.contexts.get(e.address);Object(he.a)(!!i,387),i.reSubmit(e.contents,n);break}case ha.Attach:this.submit(e,t,n);break;default:Object(dt.a)(e)}}rollback(e,t,n){switch(this.verifyNotClosed(),e){case ha.ChannelOp:{const e=t,i=this.contexts.get(e.address);Object(he.a)(!!i,749),i.rollback(e.contents,n);break}default:throw new Co(`Can't rollback ${e} message`)}}async applyStashedOp(e){const t=e,n=this.contexts.get(t.address);return Object(he.a)(!!n,388),await n.getChannel(),n.applyStashedOp(t.contents)}rocessChannelOp(e,t,n){this.verifyNotClosed();const i=e.contents,r=Object.assign(Object.assign({},e),{contents:i.contents}),s=this.contexts.get(i.address);return Object(he.a)(!!s,389),s.processOp(r,t,n),s}attachListener(){this.setMaxListeners(Number.MAX_SAFE_INTEGER),this.dataStoreContext.once("attaching",(()=>{this.attachGraph(),this._attachState=no.Attaching,Object(he.a)(this.visibilityState===Ho.VisibilityState.LocallyVisible,721),this.visibilityState=Ho.VisibilityState.GloballyVisible,this.localChannelContextQueue.forEach((e=>{e.makeVisible()})),this.localChannelContextQueue.clear(),this.deferredAttached.resolve(),this.emit("attaching")})),this.dataStoreContext.once("attached",(()=>{Object(he.a)(this.visibilityState===Ho.VisibilityState.GloballyVisible,722),this._attachState=no.Attached,this.emit("attached")}))}dentifyLocalChangeInSummarizer(e,t,n){"summarizer"!==this.clientDetails.type||this.localChangesTelemetryCount<=0||(this.mc.logger.sendTelemetryEvent({eventName:e,channelType:n,channelId:{value:t,tag:ko.CodeArtifact},fluidDataStoreId:{value:this.id,tag:ko.CodeArtifact},fluidDataStorePackagePath:Go(this.dataStoreContext.packagePath),stack:po()}),this.localChangesTelemetryCount--)}}class wa{constructor(){this.providers=new Map;for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parents=t.filter(()}get IFluidDependencySynthesizer(){return this}register(e,t){if(this.providers.has(e))throw new Error(`Attempting to register a provider of type ${String(e)} that already exists`);this.providers.set(e,t)}ynthesize(e,t){const n={};return this.generateRequired(n,t),this.generateOptional(n,e),Object.defineProperty(n,"IFluidDependencySynthesizer",{get:),n}has(e,t){return!!this.providers.has(e)||!0!==t&&this.parents.some((t=>t.has(e)))}getProvider(e){if(this.has(e)){if(this.providers.has(e))return this.providers.get(e);for(const t of this.parents){if(t instanceof wa)return t.getProvider(e);{const n=t;if(void 0!==(null==n?void 0:n.getProvider))return n.getProvider(e)}}}}generateRequired(e,t){if(void 0!==t)for(const n of Object.keys(t)){const t=this.resolveProvider(n);if(void 0===t)throw new Error(`Object attempted to be created without registered required provider ${String(n)}`);Object.defineProperty(e,n,t)}}generateOptional(e,t){var n;if(void 0!==t)for(const i of Object.keys(t)){const t=null!==(n=this.resolveProvider(i))&&void 0!==n?n:{get:async()=>{}};Object.defineProperty(e,i,t)}}resolveProvider(e){const t=this.providers.get(e);if(void 0!==t)return"function"==typeof t?{get(){if(t&&"function"==typeof t)return Promise.resolve(this.IFluidDependencySynthesizer).then((async e=>t(e))).then(()}}:{get(){if(t)return Promise.resolve(t).then(()}};for(const t of this.parents){const n=t.synthesize({[e]:e},{}),i=Object.getOwnPropertyDescriptor(n,e);if(void 0!==i)return i}}}async function Oa(e,t,n,i,r,s,o){let a=r;a=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ca;return class extends t{async request(t){const n=await super.request(t);return 404===n.status?e(t,this):n}}}((async(e,t)=>{var n;const i=await(null===(n=t.entryPoint)||void 0===n?void 0:n.get());return Object(he.a)(void 0!==i,1128),Object(he.a)(void 0!==(null==i?void 0:i.IFluidRouter),1129),null==i?void 0:i.IFluidRouter.request(e)}),a);const c=new a(t,n,s,(async e=>(Object(he.a)(void 0!==l,1130),await l.finishInitialization(!0),l))),l=new e({runtime:c,context:t,providers:new wa(t.scope.IFluidDependencySynthesizer).synthesize(i,{}),initProps:o});return s||await l.finishInitialization(s),{instance:l,runtime:c}}class Ia extends class{constructor(e,t,n,i,r){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:Ca;if(this.type=e,this.ctor=t,this.optionalProviders=i,this.runtimeClass=s,""===this.type)throw new Error("undefined type member");void 0!==r&&(this.registry=new qn(r)),this.sharedObjectRegistry=new Map(n.map(())}get IFluidDataStoreFactory(){return this}get IFluidDataStoreRegistry(){return this.registry}get registryEntry(){return[this.type,Promise.resolve(this)]}async instantiateDataStore(e,t){const{runtime:n}=await Oa(this.ctor,e,this.sharedObjectRegistry,this.optionalProviders,this.runtimeClass,t);return n}async createChildInstance(e,t){return this.createNonRootInstanceCore(e.containerRuntime,[...e.packagePath,this.type],t)}async createPeerInstancesync createInstance(e,t){return this.createNonRootInstanceCore(e,[this.type],t)}async createRootInstance(e,t,n){const i=t.createDetachedRootDataStore([this.type],e);return this.createInstanceCore(i,n)}async createNonRootInstanceCore(e,t,n){const i=e.createDetachedDataStore(t);return this.createInstanceCore(i,n)}async createInstanceCore(e,t){const{instance:n,runtime:i}=await Oa(this.ctor,e,this.sharedObjectRegistry,this.optionalProviders,this.runtimeClass,!1,t);return await e.attachRuntime(this,i),n}}{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=arguments.length>3?arguments[3]:void 0,r=arguments.length>4?arguments[4]:void 0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:Ca;const o=[...n];n.find((e=>e.type===Bs.Type))||o.push(Ls.getFactory()),n.find(()||o.push(to.getFactory()),super(e,t,o,i,r,s)}}var Na=n("oWt8");class Ta{constructor(e){this.request=e;const t=this.request.url.indexOf("?");this.query=t>=0?this.request.url.substring(t):""}static getPathParts(e){const t=e.indexOf("?");return e.substring(0,t<0?e.length:t).split("/").reduce(((e,t)=>(void 0!==t&&t.length>0&&e.push(decodeURIComponent(t)),e)),[])}et url(){return this.request.url}get headers(){return this.request.headers}get pathPartssLeaf(e){return""===this.query&&this.pathParts.length===e}createSubRequest(e){const t=this.pathParts.length;if(e<0||e>t)throw new Error("incorrect sub-request");if(e===t&&this.url.includes("?"))return{url:`/${this.query}`,headers:this.headers};const n=`/${this.pathParts.slice(e).join("/")}`;return{url:""===this.query?n:`${n}/${this.query}`,headers:this.headers}}}let Ea;function ka(){const e=new Error("<<generated stack>>");if(void 0===Ea&&(Ea=void 0!==e.stack),Ea)return e;try{throw e}catch(e){return e}}Error,new Ve.a((()=>Pa(Da())));const ja={getRawConfig:()=>{}},Pa=e=>null!=e?new xa(void 0,{getRawConfig:t=>{var n,i;try{return null===(i=Ma(null!==(n=e.getItem(t))&&void 0!==n?n:void 0))||void 0===i?void 0:i.raw}catch(e){}}}):ja;function _a(e){switch(e){case"boolean":case"number":case"string":return!0;default:return!1}}function Ma(e){let t,n=e;if("string"==typeof e)try{n=JSON.parse(e),t={raw:e,string:e}}catch(e){}if(void 0===n)return t;const i=typeof n;if(_a(i))return Object.assign(Object.assign({},t),{raw:e,[i]:n});if(Array.isArray(n)){const i=typeof n[0];if(!_a(i))return t;for(const e of n)if(typeof e!==i)return t;return Object.assign(Object.assign({},t),{raw:e,[`${i}[]`]:n})}return t}const Da=()=>{var e;try{return null!==(e=globalThis.sessionStorage)&&void 0!==e?e:void 0}catch(e){return}};class xa{constructor(e){this.logger=e,this.configCache=new Map,this.orderedBaseProviders=[];const t=new Set;for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];const s=[...i];for(;s.length>0;){const e=s.shift();void 0!==e&&Aa(e)&&!t.has(e)&&(t.add(e),e instanceof xa?s.push(...e.orderedBaseProviders):this.orderedBaseProviders.push(e))}}getBoolean(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.boolean}getNumber(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.number}getString(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.string}getBooleanArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["boolean[]"]}getNumberArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["number[]"]}getStringArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["string[]"]}getRawConfig(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.raw}getCacheEntry(e){var t;if(!this.configCache.has(e)){for(const n of this.orderedBaseProviders){const i=Ma(null==n?void 0:n.getRawConfig(e));if(void 0!==i)return this.configCache.set(e,i),null===(t=this.logger)||void 0===t||t.send({category:"generic",eventName:"ConfigRead",configName:{tag:Ra.CodeArtifact,value:e},configValue:{tag:Ra.CodeArtifact,value:JSON.stringify(i)}}),i}this.configCache.set(e,{raw:void 0})}return this.configCache.get(e)}}function Aa(e){return"function"==typeof(null==e?void 0:e.getRawConfig)}var Ra,Fa;!function(e){e.CodeArtifact="CodeArtifact",e.UserData="UserData"}(Ra||(Ra={}));class qa{constructor(e,t){this.namespace=e,this.properties=t}static formatTick(e){return Math.floor(e)}static numberFromString(e){if(null==e)return;const t=Number(e);return Number.isNaN(t)?e:t}static sanitizePkgName(e){return e.replace("@","").replace("/","-")}static prepareErrorObject(e,t,n){const{message:i,errorType:r,stack:s}=function(e,t){const n={message:"string"==typeof(null==e?void 0:e.message)?e.message:String(e)};if((e=>null!==e&&!Array.isArray(e)&&"object"==typeof e)(e)){const{errorType:t,stack:i,name:r}=e;"string"==typeof t&&(n.errorType=t),"string"==typeof i&&(n.stack=((e,t)=>{const n=e.split("\n");return n.shift(),void 0!==t&&n.unshift(t),n.join("\n")})(i,"string"==typeof r?r:void 0))}return n}(t);if(e.stack=s,e.error=i,e.errorType=r,(e=>"function"==typeof(null==e?void 0:e.getTelemetryProperties))(t)){const n=t.getTelemetryProperties();for(const t of Object.keys(n))void 0===e[t]&&(e[t]=n[t])}void 0===e.stack&&n&&(e.stack=function(){return ka().stack}())}sendTelemetryEvent(e,t){var n;this.sendTelemetryEventCore(Object.assign(Object.assign({},e),{category:null!==(n=e.category)&&void 0!==n?n:"generic"}),t)}sendTelemetryEventCore(e,t){const n=function(e){var{category:t,eventName:n}=e,i=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n}(e,["category","eventName"]);const r={category:t,eventName:n};for(const e of Object.keys(i))r[e]=za(i[e]);return r}(e);void 0!==t&&qa.prepareErrorObject(n,t,!1),"number"==typeof n.duration&&(n.duration=qa.formatTick(n.duration)),this.send(n)}sendErrorEvent(e,t){this.sendTelemetryEventCore(Object.assign(Object.assign({error:e.eventName},e),{category:"error"}),t)}sendPerformanceEvent(e,t){var n;const i=Object.assign(Object.assign({},e),{category:null!==(n=e.category)&&void 0!==n?n:"performance"});this.sendTelemetryEventCore(i,t)}prepareEvent(e){const t="error"===e.category||void 0!==e.error,n=Object.assign({},e);if(void 0!==this.namespace&&(n.eventName=`${this.namespace}${qa.eventNamespaceSeparator}${n.eventName}`),this.properties){const i=[];i.push(this.properties.all),t&&i.push(this.properties.error);for(const t of i)if(void 0!==t)for(const i of Object.keys(t)){if(void 0!==e[i])continue;const r=t[i],s="function"==typeof r?r():r;void 0!==s&&(n[i]=s)}}return n}}function za(e){return function(e){var t;return"string"==typeof(null===(t=e)||void 0===t?void 0:t.tag)}(e)?{value:Ba(e.value),tag:e.tag}:Ba(e)}function Ba(e){switch(typeof e){case"string":case"number":case"boolean":case"undefined":return e;case"object":return JSON.stringify(e);default:return console.error(`convertToBasePropertyTypeUntagged: INVALID PROPERTY (typed as ${typeof e})`),`INVALID PROPERTY (typed as ${typeof e})`}}qa.eventNamespaceSeparator=":";class La{ushHandler(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];void 0!==t&&this.handlers.push(...t)}async handleRequest(e,t){const n=Ta.create(e);for(const e of this.handlers){const i=await e(n,t);if(void 0!==i)return i}return(e=>function(e,t,n,i){var r;Object(he.a)(!0,411);const s=null===(r=n.url)||void 0===r?void 0:r.split("?")[0],o=ka();return{mimeType:"text/plain",status:404,value:void 0===s?t:`${t}: ${s}`,get stack(){return o.stack},headers:void 0}}(0,"not found",e))(e)}}function Va(){const e=new La;return e.pushHandler(...arguments),async(t,n)=>e.handleRequest(t,n)}!Fa||(Fa={}));var Ua=n("7EWA");class Ha extends me.a{mit(e){try{for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return super.emit(e,...n)}catch(t){return this.errorHandler(e,t),!0}}}const Ga=new Ve.a((),$a={getRawConfig:,Ka=e=>null!=e?new Xa(void 0,{getRawConfig:t=>{var n,i;try{return null===(i=Ja(null!==(n=e.getItem(t))&&void 0!==n?n:void 0))||void 0===i?void 0:i.raw}catch(e){}}}):$a;unction Ja(e){let t,n=e;if("string"==typeof e)try{n=JSON.parse(e),t={raw:e,string:e}}catch(e){}if(void 0===n)return t;const i=typeof n;if(Wa(i))return Object.assign(Object.assign({},t),{raw:e,[i]:n});if(Array.isArray(n)){const i=typeof n[0];if(!Wa(i))return t;for(const e of n)if(typeof e!==i)return t;return Object.assign(Object.assign({},t),{raw:e,[`${i}[]`]:n})}return t}const Qa=()=>{var e;try{return null!==(e=globalThis.sessionStorage)&&void 0!==e?e:void 0}catch(e){return}};class Xa{constructor(e){this.logger=e,this.configCache=new Map,this.orderedBaseProviders=[];const t=new Set;for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];const s=[...i];for(;s.length>0;){const e=s.shift();void 0!==e&&ec(e)&&!t.has(e)&&(t.add(e),e instanceof Xa?s.push(...e.orderedBaseProviders):this.orderedBaseProviders.push(e))}}getBoolean(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.boolean}getNumber(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.number}getString(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.string}getBooleanArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["boolean[]"]}getNumberArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["number[]"]}getStringArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["string[]"]}etCacheEntry(e){var t;if(!this.configCache.has(e)){for(const n of this.orderedBaseProviders){const i=Ja(null==n?void 0:n.getRawConfig(e));if(void 0!==i)return this.configCache.set(e,i),null===(t=this.logger)||void 0===t||t.send({category:"generic",eventName:"ConfigRead",configName:{tag:bc.CodeArtifact,value:e},configValue:{tag:bc.CodeArtifact,value:JSON.stringify(i)}}),i}this.configCache.set(e,{raw:void 0})}return this.configCache.get(e)}}function Za(e){const t=e;return ec(null==t?void 0:t.config)&&void 0!==(null==t?void 0:t.logger)}function Ya(e){if(Za(e))throw new Error("Logger is already a monitoring context");const t=e;for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];return t.config=new Xa(e,...i),t.logger=e,t}onst tc=e=>"function"==typeof(null==e?void 0:e.getTelemetryProperties)&&"function"==typeof(null==e?void 0:e.addTelemetryProperties),nc=e=>"string"==typeof(null==e?void 0:e.errorInstanceId);function ic(e){return"string"==typeof(null==e?void 0:e.errorType)&&"string"==typeof(null==e?void 0:e.message)&&nc(e)&&tc(e)}function rc(e){return"string"==typeof(null==e?void 0:e.errorType)&&"string"==typeof(null==e?void 0:e.message)&&tc(e)}function sc(e,t){const n={message:"string"==typeof(null==e?void 0:e.message)?e.message:String(e)};if((e=>null!==e&&!Array.isArray(e)&&"object"==typeof e)(e)){const{errorType:i,stack:r,name:s}=e;"string"==typeof i&&(n.errorType=i),"string"==typeof r&&(n.stack=((e,n)=>{if(!t)return e;const i=e.split("\n");return i.shift(),void 0!==n&&i.unshift(n),i.join("\n")})(r,"string"==typeof s?s:void 0))}return n}const oc=function ac(e){void 0===e.errorInstanceId&&(e.errorInstanceId=Object(ge.a)())}function cc(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var n;if(rc(e)&&ac(e),ic(e))return e.addTelemetryProperties(null!==(n=t.props)&&void 0!==n?n:{}),e;const{message:i,stack:r}=sc(e,!1),s=new yc({message:i,stack:r});if("object"==typeof e&&null!==e){const{canRetry:t,retryAfterSeconds:n}=e;Object.assign(cc,{canRetry:t,retryAfterSeconds:n})}"object"!=typeof e&&s.addTelemetryProperties({typeofError:typeof e});const o=fc.typeCheck(e)?e.getTelemetryProperties():{untrustedOrigin:1};return s.addTelemetryProperties(Object.assign(Object.assign({},o),t.props)),s}let lc;function dc(){const e=new Error("<<generated stack>>");if(void 0===lc&&(lc=void 0!==e.stack),lc)return e;try{throw e}catch(e){return e}}function uc(e,t){try{Object.assign(e,{stack:t})}catch(n){e.addTelemetryProperties({stack2:t})}}function hc(e){return fc.typeCheck(e)?e.errorType===vc&&1===e.getTelemetryProperties().untrustedOrigin:!rc(e)}function mc(e){var t;return"string"==typeof(null===(t=e)||void 0===t?void 0:t.tag)}function gc(e,t){return Array.isArray(e)&&e.every(()?JSON.stringify(e):pc(e)?e:(console.error(`UnSupported Format of Logging Error Property for key ${t}:`,e),"REDACTED (arbitrary object)")}function pc(e){switch(typeof e){case"string":case"number":case"boolean":case"undefined":return!0;default:return!1}}class fc extends Error{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Set;super(e),this.omitPropsFromLogging=n,this._errorInstanceId=Object(ge.a)(),this.fluidErrorCode="-",n.add("omitPropsFromLogging"),n.add("_errorInstanceId"),t&&this.addTelemetryProperties(t)}get errorInstanceId(){return this._errorInstanceId}tatic typeCheck(e){return"object"==typeof e&&null!==e&&"function"==typeof e.addTelemetryProperties&&"function"==typeof e.getTelemetryProperties&&"string"==typeof e.errorInstanceId}addTelemetryProperties(e){!function(e,t){for(const n of Object.keys(t))void 0===e[n]&&(e[n]=t[n])}(this,e)}getTelemetryProperties(){const e=function(e,t){const n={};for(const i of Object.keys(e)){if(t.has(i))continue;const r=e[i];n[i]=mc(r)?{value:gc(r.value,i),tag:r.tag}:gc(r,i)}return n}(this,this.omitPropsFromLogging);return Object.assign(Object.assign({},e),{stack:this.stack,message:this.message,errorInstanceId:this._errorInstanceId})}}const vc="genericError";class yc extends fc{constructor(e){super(e.message),this.errorType=vc,void 0!==e.stack&&uc(this,e.stack)}}var bc,Sc;!bc||(bc={}));class Cc{atic numberFromString(e){if(null==e)return;const t=Number(e);return Number.isNaN(t)?e:t}tatic prepareErrorObject(e,t,n){const{message:i,errorType:r,stack:s}=sc(t,!0);if(e.stack=s,e.error=i,e.errorType=r,oc(t)){const n=t.getTelemetryProperties();for(const t of Object.keys(n))void 0===e[t]&&(e[t]=n[t])}void 0===e.stack&&n&&(e.stack=))}sendTelemetryEvent(e,t){var n;this.sendTelemetryEventCore(Object.assign(Object.assign({},e),{category:null!==(n=e.category)&&void 0!==n?n:"generic"}),t)}sendTelemetryEventCore(e,t){const n=function(e){var{category:t,eventName:n}=e,i=e,["category","eventName"]);const r={category:t,eventName:n};for(const e of Object.keys(i))r[e]=Ic(i[e]);return r}(e);void 0!==t&&Cc.prepareErrorObject(n,t,!1),"number"==typeof n.duration&&(n.duration=Cc.formatTick(n.duration)),this.send(n)}sendErrorEvent(e,t){this.sendTelemetryEventCore(Object.assign(Object.assign({error:e.eventName},e),{category:"error"}),t)}sendPerformanceEvent(e,t){var n;const i=Object.assign(Object.assign({},e),{category:null!==(n=e.category)&&void 0!==n?n:"performance"});this.sendTelemetryEventCore(i,t)}prepareEvent(e){const t="error"===e.category||void 0!==e.error,n=Object.assign({},e);if(void 0!==this.namespace&&(n.eventName=`${this.namespace}${Cc.eventNamespaceSeparator}${n.eventName}`),this.properties){const i=[];i.push(this.properties.all),t&&i.push(this.properties.error);for(const t of i)if(void 0!==t)for(const i of Object.keys(t)){if(void 0!==e[i])continue;const r=t[i],s="function"==typeof r?r():r;void 0!==s&&(n[i]=s)}}return n}}Cc.eventNamespaceSeparator=":";class wc extends Cc{constructor(e,t,n){super(t,n),this.baseLogger=e,Za(e)&&Ya(this,new Xa(this,e.config))}static create(e,t,n){if(e instanceof wc){const i={};for(const t of[e.properties,n])void 0!==t&&(void 0!==t.all&&(i.all=Object.assign(Object.assign({},i.all),t.all)),void 0!==t.error&&(i.error=Object.assign(Object.assign({},i.error),t.error)));return new wc(e.baseLogger,void 0===e.namespace?t:void 0===t?e.namespace:`${e.namespace}${Cc.eventNamespaceSeparator}${t}`,i)}return new wc(e||new Oc,t,n)}unction Ic(e){return mc(e)?{value:Nc(e.value),tag:e.tag}:Nc(e)}function Nc(e){switch(typeof e){case"string":case"number":case"boolean":case"undefined":return e;case"object":return JSON.stringify(e);default:return console.error(`convertToBasePropertyTypeUntagged: INVALID PROPERTY (typed as ${typeof e})`),`INVALID PROPERTY (typed as ${typeof e})`}}class Tc{constructor(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new Map;this.eventBase=e,this.logger=t,this.sampleThreshold=n,this.includeAggregateMetrics=i,this.perBucketProperties=r,this.disposed=!1,this.measurementsMap=new Map}measure(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";var n,i,r;const s=Le.a.now(),o=e(),a=Le.a.now()-s;let c=this.measurementsMap.get(t);return void 0===c&&(c={count:0,duration:-1},this.measurementsMap.set(t,c)),c.count++,c.duration=a,this.includeAggregateMetrics&&(c.totalDuration=(null!==(n=c.totalDuration)&&void 0!==n?n:0)+a,c.minDuration=Math.min(null!==(i=c.minDuration)&&void 0!==i?i:a,a),c.maxDuration=Math.max(null!==(r=c.maxDuration)&&void 0!==r?r:0,a)),c.count>=this.sampleThreshold&&this.flushBucket(t),o}flushBucket(e){const t=this.measurementsMap.get(e);if(void 0!==t&&0!==t.count){const n=this.perBucketProperties.get(e),i=Object.assign(Object.assign(Object.assign({},this.eventBase),n),t);this.logger.sendPerformanceEvent(i),this.measurementsMap.delete(e)}}dispose(e){this.measurementsMap.forEach(((e,t)=>this.flushBucket(t)))}}!function(e){e.genericError="genericError",e.throttlingError="throttlingError",e.dataCorruptionError="dataCorruptionError",e.dataProcessingError="dataProcessingError",e.usageError="usageError",e.clientSessionExpiredError="clientSessionExpiredError"}(Sc||(Sc={}));class Ec extends fc{constructor(e){super(e),this.errorType=Sc.dataProcessingError,this.canRetry=!1}static create(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const r=Ec.wrapIfUnrecognized(e,t,n);return r.addTelemetryProperties(i),r}static wrapIfUnrecognized(e,t,n){const i=cc(e,{props:Object.assign({dataProcessingError:1,dataProcessingCodepath:t},void 0===n?void 0:kc(n))});if(hc(i)||i.errorType===vc){const e=function(e,t){const{message:n,stack:i}=sc(e,!1),r=(e=>new Ec(e))(n);return void 0!==i&&uc(r,i),hc(e)&&r.addTelemetryProperties({untrustedOrigin:1}),nc(e)&&(r.overwriteErrorInstanceId(e.errorInstanceId),r.addTelemetryProperties({innerErrorInstanceId:e.errorInstanceId})),oc(e)&&r.addTelemetryProperties(e.getTelemetryProperties()),r}(i);return e.addTelemetryProperties(i.getTelemetryProperties()),e}return i}}const kc=e=>({messageClientId:e.clientId,messageSequenceNumber:e.sequenceNumber,messageClientSequenceNumber:e.clientSequenceNumber,messageReferenceSequenceNumber:e.referenceSequenceNumber,messageMinimumSequenceNumber:e.minimumSequenceNumber,messageTimestamp:e.timestamp});function jc(e,t){if(""===e)return void 0===t?"":t.absolutePath;{let n=e.startsWith("/")?e.slice(1):e;return n=n.endsWith("/")?n.slice(0,-1):n,void 0===t?`/${n}`:`${"/"===t.absolutePath?"":t.absolutePath}/${n}`}}class Pc{constructor(e,t){this.absolutePath=e,this.routeContext=t,this.isAttached=!0,Object(he.a)(e.startsWith("/"),413)}get IFluidRouter(){return this}get IFluidHandleContext(){return this}get IFluidHandle(){return this}async get(){return void 0===this.objectP&&(this.objectP=this.routeContext.resolveHandle({url:this.absolutePath,headers:{[ds.viaHandle]:!0}}).then((e=>{if("fluid/object"===e.mimeType)return e.value;throw function(e,t){const n=e.value,i=dc();return{errorFromRequestFluidObject:!0,message:n,name:"Error",code:e.status,get stack(){var t;return null!==(t=e.stack)&&void 0!==t?t:i.stack},underlyingResponseHeaders:e.headers}}(e)}))),this.objectP}attachGraph(){}bind(e){e.attachGraph()}async request(e){try{const t=(await this.get()).IFluidRouter;return void 0!==t?t.request(e):(e=>function(e,t,n,i){var r;Object(he.a)(!0,411);const s=null===(r=n.url)||void 0===r?void 0:r.split("?")[0],o=dc();return{mimeType:"text/plain",status:404,value:void 0===s?t:`${t}: ${s}`,get stack(){return o.stack},headers:void 0}}(0,"not found",e))(e)}catch(e){return function(e){if(null!==e&&"object"==typeof e&&!0===e.errorFromRequestFluidObject){const t=e;return{mimeType:"text/plain",status:t.code,value:t.message,get stack(){return t.stack},headers:t.underlyingResponseHeaders}}const t=dc();return{mimeType:"text/plain",status:500,value:`${e}`,get stack(){var n;return null!==(n=null==e?void 0:e.stack)&&void 0!==n?n:t.stack}}}(e)}}}class _c{constructor(e,t){for(this.context=e,this.handleParsedCb=t,this.encodeValue=(e,t)=>{const n=null==e?void 0:e.IFluidHandle;return void 0!==n?this.serializeHandle(n,t):e},this.decodeValue=e=>{if((e=>"__fluid_handle__"===(null==e?void 0:e.type))(e)){const t=e.url.startsWith("/")?e.url:jc(e.url,this.context),n=new Pc(t,this.root);return this.handleParsedCb(n),n}return e},this.root=this.context;void 0!==this.root.routeContext;)this.root=this.root.routeContext}get IFluidSerializer(){return this}encode(e,t){return e&&"object"==typeof e?this.recursivelyReplace(e,this.encodeValue,t):e}decode(e){return e&&"object"==typeof e?this.recursivelyReplace(e,this.decodeValue):e}stringify(e,t){return JSON.stringify(e,((e,n)=>this.encodeValue(n,t)))}parse(e){return JSON.parse(e,((e,t)=>this.decodeValue(t)))}recursivelyReplace(e,t,n){const i=t(e,n);if(i!==e)return i;let r;for(const i of Object.keys(e)){const s=e[i];if(s&&"object"==typeof s){const o=this.recursivelyReplace(s,t,n);o!==s&&(r=null!=r?r:Array.isArray(e)?[...e]:Object.assign({},e),r[i]=o)}}return null!=r?r:e}serializeHandle(e,t){return t.bind(e),{type:"__fluid_handle__",url:e.absolutePath}}}class Mc extends class{constructor(e,t,n){this.value=e,this.path=t,this.routeContext=n,this.pendingHandlesToMakeVisible=new Set,this.locallyVisible=!1,this.absolutePath=jc(t,this.routeContext)}get IFluidHandle(){return this}get isAttached(){return this.routeContext.isAttached}get visible(){return this.isAttached||this.locallyVisible}async get(){return this.value}attachGraph(){this.visible||(this.locallyVisible=!0,this.pendingHandlesToMakeVisible.forEach((e=>{e.attachGraph()})),this.pendingHandlesToMakeVisible.clear(),this.routeContext.attachGraph())}bind(e){this.visible?e.attachGraph():this.pendingHandlesToMakeVisible.add(e)}}{constructor(e,t,n){super(e,t,n),this.value=e}get isAttached(){return this.value.isAttached()}attachGraph(){this.value.bindToContext(),super.attachGraph()}}class Dc extends _c{constructor(){super(...arguments),this.serializedRoutes=new Set}getSerializedRoutes(){return Array.from(this.serializedRoutes)}serializeHandle(e,t){return this.serializedRoutes.add(e.absolutePath),super.serializeHandle(e,t)}}class xc extends Ha{constructor(e,t,n){super(((e,t)=>this.eventListenerErrorHandler(e,t))),this.id=e,this.runtime=t,this.attributes=n,this._connected=!1,this._isBoundToContext=!1,Object(he.a)(!e.includes("/"),772),this.handle=new Mc(this,e,t.IFluidHandleContext),this.logger=wc.create(t.logger,void 0,{all:{sharedObjectId:Object(ge.a)(),ddsType:{value:this.attributes.type,tag:bc.CodeArtifact}}}),this.mc=function(e){return Za(e)?e:Ya(e,Ga.value)}(this.logger),[this.opProcessingHelper,this.callbacksHelper]=this.setUpSampledTelemetryHelpers(),this.attachListeners()}get IFluidLoadable(){return this}get connected(){return this._connected}setUpSampledTelemetryHelpers(){var e,t;Object(he.a)(void 0!==this.mc&&void 0!==this.logger,841);const n=new Tc({eventName:"ddsOpProcessing",category:"performance"},this.logger,null!==(e=this.mc.config.getNumber("Fluid.SharedObject.OpProcessingTelemetrySampling"))&&void 0!==e?e:1e3,!0,new Map([["local",{localOp:!0}],["remote",{localOp:!1}]])),i=new Tc({eventName:"ddsEventCallbacks",category:"performance"},this.logger,null!==(t=this.mc.config.getNumber("Fluid.SharedObject.DdsCallbacksTelemetrySampling"))&&void 0!==t?t:1e3,!0);return this.runtime.once("dispose",(()=>{this.callbacksHelper.dispose(),this.opProcessingHelper.dispose()})),[n,i]}closeWithError(e){void 0===this.closeError&&(this.closeError=e)}verifyNotClosed(){if(void 0!==this.closeError)throw this.closeError}eventListenerErrorHandler(e,t){const n=Ec.wrapIfUnrecognized(t,"SharedObjectEventListenerException");throw n.addTelemetryProperties({emittedEventName:String(e)}),this.closeWithError(n),n}attachListeners(){this.isAttached()||this.runtime.once("attaching",(()=>{this.didAttach()}))}async load(e){this.runtime.attachState!==Fa.Detached&&(this.services=e),await this.loadCore(e.objectStorage),this.runtime.attachState!==Fa.Detached&&this.attachDeltaHandler()}initializeLocal(){this.initializeLocalCore()}bindToContext(){this._isBoundToContext||(this._isBoundToContext=!0,this.runtime.bindChannel(this))}connect(e){this.services=e,this.attachDeltaHandler()}isAttached(){return void 0!==this.services&&this.runtime.attachState!==Fa.Detached}handleDecoded(e){var t,n,i;this.isAttached()&&(null===(i=null===(t=this.services)||void 0===t?void 0:(n=t.deltaConnection).addedGCOutboundReference)||void 0===i||i.call(n,this.handle,e))}initializeLocalCore(){}didAttach(){}submitLocalMessage(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;this.verifyNotClosed(),this.isAttached()&&this.services.deltaConnection.submit(e,t)}dirty(){this.isAttached()&&this.services.deltaConnection.dirty()}onConnect(){}reSubmitCore(e,t){this.submitLocalMessage(e,t)}async newAckBasedPromise(e){let t;return new Promise(((n,i)=>{t=()=>i(new Error("FluidDataStoreRuntime disposed while this ack-based Promise was pending")),this.runtime.disposed?t():(this.runtime.on("dispose",t),e(n,i))})).finally((()=>{this.runtime.off("dispose",t)}))}attachDeltaHandler(){Object(he.a)(void 0!==this.services,122),this._isBoundToContext=!0,this.didAttach(),this.services.deltaConnection.attach({process:(e,t,n)=>{this.process(e,t,n)},setConnectionState:e=>{this.setConnectionState(e)},reSubmit:(e,t)=>{this.reSubmit(e,t)},applyStashedOp:e=>this.applyStashedOp(e),rollback:(e,t)=>{this.rollback(e,t)}}),this.setConnectionState(this.services.deltaConnection.connected)}setConnectionState(e){this._connected!==e&&(this._connected=e,e?this.onConnect():this.onDisconnect())}process(e,t,n){this.verifyNotClosed(),this.emitInternal("pre-op",e,t,this),this.opProcessingHelper.measure((()=>{this.processCore(e,t,n)}),t?"local":"remote"),this.emitInternal("op",e,t,this)}reSubmit(e,t){this.reSubmitCore(e,t)}rollback(e,t){throw new Error("rollback not supported")}emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return this.callbacksHelper.measure((()=>this.runtime.ensureNoDataModelChanges((()=>super.emit(e,...n)))))}emitInternal(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return super.emit(e,...n)}}class Ac extends xc{constructor(e,t,n,i){super(e,t,n),this.telemetryContextPrefix=i,this._isGCing=!1,this._serializer=new _c(this.runtime.channelsRoutingContext,(e=>this.handleDecoded(e)))}get serializer(){return Object(he.a)(!this._isGCing,117),this._serializer}getAttachSummary(){let e=arguments.length>2?arguments[2]:void 0;const t=this.summarizeCore(this.serializer,e);return this.incrementTelemetryMetric(Ua.blobCountPropertyName,t.stats.blobNodeCount,e),this.incrementTelemetryMetric(Ua.totalBlobSizePropertyName,t.stats.totalBlobSize,e),t}async summarize(){let e=arguments.length>2?arguments[2]:void 0;const t=this.summarizeCore(this.serializer,e,arguments.length>3?arguments[3]:void 0);return this.incrementTelemetryMetric(Ua.blobCountPropertyName,t.stats.blobNodeCount,e),this.incrementTelemetryMetric(Ua.totalBlobSizePropertyName,t.stats.totalBlobSize,e),t}getGCData(){let e;Object(he.a)(!this._isGCing,120),this._isGCing=!0;try{const t=new Dc(this.runtime.channelsRoutingContext,(e=>this.handleDecoded(e)));this.processGCDataCore(t),e={gcNodes:{"/":t.getSerializedRoutes()}},Object(he.a)(this._isGCing,121)}finally{this._isGCing=!1}return e}processGCDataCore(e){this.summarizeCore(e)}incrementTelemetryMetric(e,t,n){var i;const r=null!==(i=null==n?void 0:n.get(this.telemetryContextPrefix,e))&&void 0!==i?i:0;null==n||n.set(this.telemetryContextPrefix,e,r+t)}}function Rc(){const e={treeNodeCount:0,blobNodeCount:0,handleNodeCount:0,totalBlobSize:0,unreferencedBlobSize:0};for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];for(const t of n)e.treeNodeCount+=t.treeNodeCount,e.blobNodeCount+=t.blobNodeCount,e.handleNodeCount+=t.handleNodeCount,e.totalBlobSize+=t.totalBlobSize,e.unreferencedBlobSize+=t.unreferencedBlobSize;return e}class Fc{constructor(){this.attachmentCounter=0,this.summaryTree={},this.summaryStats=Rc(),this.summaryStats.treeNodeCount++}get summary(){return{type:ln.a.Tree,tree:Object.assign({},this.summaryTree)}}get stats(){return Object.assign({},this.summaryStats)}addBlob(e,t){!function(e,t,n){e.summary.tree[t]={type:ln.a.Blob,content:n},e.stats.blobNodeCount++,e.stats.totalBlobSize+=function(e){return"string"==typeof e?function(e){let t=e.length;for(let n=e.length-1;n>=0;n--){const i=e.charCodeAt(n);i>127&&i<=2047?t++:i>2047&&i<=65535&&(t+=2),i>=56320&&i<=57343&&n--}return t}(e):e.byteLength}(n)}({summary:{type:ln.a.Tree,tree:this.summaryTree},stats:this.summaryStats},e,t)}addHandle(e,t,n){this.summaryTree[e]={type:ln.a.Handle,handleType:t,handle:n},this.summaryStats.handleNodeCount++}addWithStats(e,t){this.summaryTree[e]=t.summary,this.summaryStats=Rc(this.summaryStats,t.stats)}addAttachment(e){this.summaryTree[this.attachmentCounter++]={id:e,type:ln.a.Attachment}}getSummaryTree(){return{summary:this.summary,stats:this.stats}}}class qc{get type(){return qc.Type}get attributes(){return qc.Attributes}async load(e,t,n,i){const r=new Lc(t,e,i);return await r.load(n),r}create(e,t){const n=new Lc(t,e,qc.Attributes);return n.initializeLocal(),n}}var zc;qc.Type="https://graph.microsoft.com/types/consensus-register-collection",qc.Attributes={type:qc.Type,snapshotFormatVersion:"0.1",packageVersion:"2.0.0-internal.4.3.0"},function(e){e[e.Atomic=0]="Atomic",e[e.LWW=1]="LWW"}(zc||(zc={}));const Bc=(e,t)=>({sequenceNumber:e,value:{type:"Plain",value:t}});class Lc extends Ac{constructor(e,t,n){super(e,t,n,"fluid_consensusRegisterCollection_"),this.data=new Map}static create(e,t){return e.createChannel(t,qc.Type)}static getFactory(){return new qc}async write(e,t){const n=this.stringify(t,this.serializer);if(!this.isAttached())return this.processInboundWrite(e,this.parse(n,this.serializer),0,0,!0),!0;const i={key:e,type:"write",serializedValue:n,refSeq:this.runtime.deltaManager.lastSequenceNumber};return this.newAckBasedPromise(().catch(()}read(e){if((arguments.length>1&&void 0!==arguments[1]?arguments[1]:zc.Atomic)===zc.Atomic)return this.readAtomic(e);const t=this.readVersions(e);return void 0!==t?(Object(he.a)(t.length>0,108),t[t.length-1]):void 0}readVersions(e){const t=this.data.get(e);return null==t?void 0:t.versions.map(()}ummarizeCore(e){const t={};return this.data.forEach(((e,n)=>{t[n]=e})),function(e,t){const n=new Fc;return n.addBlob("header",t),n.getSummaryTree()}(0,this.stringify(t,e))}async loadCore(e){var t;const n=await e.readBlob("header"),i=Object(yn.c)(n,"utf8"),r=this.parse(i,this.serializer);for(const e of Object.keys(r))Object(he.a)("Shared"!==(null===(t=r[e].atomic)||void 0===t?void 0:t.value.type),109),this.data.set(e,r[e])}onDisconnect(){}processCore(e,t,n){if(e.type===qe.a.Operation){const i=e.contents;switch(i.type){case"write":{void 0===i.refSeq&&(i.refSeq=e.referenceSequenceNumber);const r=i.refSeq;Object(he.a)(r<=e.referenceSequenceNumber,110);const s=((i)?this.parse(i.serializedValue,this.serializer):i.value.value,o=this.processInboundWrite(i.key,s,r,e.sequenceNumber,t);t&&n(o);break}default:Object(dt.a)(i.type)}}}readAtomic(e){const t=this.data.get(e);return null==t?void 0:t.atomic.value.value}processInboundWrite(e,t,n,i,r){let s=this.data.get(e);const o=void 0===s||n>=s.atomic.sequenceNumber;if(o){const n=Bc(i,t);void 0===s?(s={atomic:n,versions:[]},this.data.set(e,s)):s.atomic=n}else Object(he.a)(!!s,111);for(;s.versions.length>0&&n>=s.versions[0].sequenceNumber;)s.versions.shift();const a=Bc(i,t);return this.isAttached()?s.versions.length>0&&Object(he.a)(i>s.versions[s.versions.length-1].sequenceNumber,113):Object(he.a)(0===n&&0===i,112),s.versions.push(a),o&&this.emit("atomicChanged",e,t,r),this.emit("versionChanged",e,t,r),o}r Vc,Uc=n("QjXU");!function(e){e.Detached="Detached",e.Attaching="Attaching",e.Attached="Attached"}(Vc||(Vc={}));var Hc=n("DDiJ");class Gc extends me.a{constructor(e){super(),this.errorHandler=e}emit(e){try{for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return super.emit(e,...n)}catch(t){return this.errorHandler(e,t),!0}}}const $c=new Ve.a((()=>Wc(Xc()))),Kc={getRawConfig:()=>{}},Wc=e=>null!=e?new Zc(void 0,{getRawConfig:t=>{var n,i;try{return null===(i=Qc(null!==(n=e.getItem(t))&&void 0!==n?n:void 0))||void 0===i?void 0:i.raw}catch(e){}}}):Kc;function Jc(e){switch(e){case"boolean":case"number":case"string":return!0;default:return!1}}function Qc(e){let t,n=e;if("string"==typeof e)try{n=JSON.parse(e),t={raw:e,string:e}}catch(e){}if(void 0===n)return t;const i=typeof n;if(Jc(i))return Object.assign(Object.assign({},t),{raw:e,[i]:n});if(Array.isArray(n)){const i=typeof n[0];if(!Jc(i))return t;for(const e of n)if(typeof e!==i)return t;return Object.assign(Object.assign({},t),{raw:e,[`${i}[]`]:n})}return t}const Xc=()=>{var e;try{return null!==(e=globalThis.sessionStorage)&&void 0!==e?e:void 0}catch(e){return}};class Zc{constructor(e){this.logger=e,this.configCache=new Map,this.orderedBaseProviders=[];const t=new Set;for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];const s=[...i];for(;s.length>0;){const e=s.shift();void 0!==e&&tl(e)&&!t.has(e)&&(t.add(e),e instanceof Zc?s.push(...e.orderedBaseProviders):this.orderedBaseProviders.push(e))}}getBoolean(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.boolean}getNumber(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.number}getString(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.string}getBooleanArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["boolean[]"]}getNumberArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["number[]"]}getStringArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["string[]"]}getRawConfig(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.raw}getCacheEntry(e){var t;if(!this.configCache.has(e)){for(const n of this.orderedBaseProviders){const i=Qc(null==n?void 0:n.getRawConfig(e));if(void 0!==i)return this.configCache.set(e,i),null===(t=this.logger)||void 0===t||t.send({category:"generic",eventName:"ConfigRead",configName:{tag:Sl.CodeArtifact,value:e},configValue:{tag:Sl.CodeArtifact,value:JSON.stringify(i)}}),i}this.configCache.set(e,{raw:void 0})}return this.configCache.get(e)}}function Yc(e){const t=e;return tl(null==t?void 0:t.config)&&void 0!==(null==t?void 0:t.logger)}function el(e){if(Yc(e))throw new Error("Logger is already a monitoring context");const t=e;for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];return t.config=new Zc(e,...i),t.logger=e,t}function tl(e){return"function"==typeof(null==e?void 0:e.getRawConfig)}const nl=e=>"function"==typeof(null==e?void 0:e.getTelemetryProperties)&&"function"==typeof(null==e?void 0:e.addTelemetryProperties),il=e=>"string"==typeof(null==e?void 0:e.errorInstanceId);function rl(e){return"string"==typeof(null==e?void 0:e.errorType)&&"string"==typeof(null==e?void 0:e.message)&&il(e)&&nl(e)}function sl(e){return"string"==typeof(null==e?void 0:e.errorType)&&"string"==typeof(null==e?void 0:e.message)&&nl(e)}function ol(e,t){const n={message:"string"==typeof(null==e?void 0:e.message)?e.message:String(e)};if((e=>null!==e&&!Array.isArray(e)&&"object"==typeof e)(e)){const{errorType:i,stack:r,name:s}=e;"string"==typeof i&&(n.errorType=i),"string"==typeof r&&(n.stack=((e,n)=>{if(!t)return e;const i=e.split("\n");return i.shift(),void 0!==n&&i.unshift(n),i.join("\n")})(r,"string"==typeof s?s:void 0))}return n}const al=e=>"function"==typeof(null==e?void 0:e.getTelemetryProperties);function cl(e){void 0===e.errorInstanceId&&(e.errorInstanceId=Object(ge.a)())}function ll(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var n;if(sl(e)&&cl(e),rl(e))return e.addTelemetryProperties(null!==(n=t.props)&&void 0!==n?n:{}),e;const{message:i,stack:r}=ol(e,!1),s=new bl({message:i,stack:r});if("object"==typeof e&&null!==e){const{canRetry:t,retryAfterSeconds:n}=e;Object.assign(ll,{canRetry:t,retryAfterSeconds:n})}"object"!=typeof e&&s.addTelemetryProperties({typeofError:typeof e});const o=vl.typeCheck(e)?e.getTelemetryProperties():{untrustedOrigin:1};return s.addTelemetryProperties(Object.assign(Object.assign({},o),t.props)),s}let dl;function ul(){const e=new Error("<<generated stack>>");if(void 0===dl&&(dl=void 0!==e.stack),dl)return e;try{throw e}catch(e){return e}}function hl(e,t){try{Object.assign(e,{stack:t})}catch(n){e.addTelemetryProperties({stack2:t})}}function ml(e){return vl.typeCheck(e)?e.errorType===yl&&1===e.getTelemetryProperties().untrustedOrigin:!sl(e)}function gl(e){var t;return"string"==typeof(null===(t=e)||void 0===t?void 0:t.tag)}function pl(e,t){return Array.isArray(e)&&e.every((e=>fl(e)))?JSON.stringify(e):fl(e)?e:(console.error(`UnSupported Format of Logging Error Property for key ${t}:`,e),"REDACTED (arbitrary object)")}function fl(e){switch(typeof e){case"string":case"number":case"boolean":case"undefined":return!0;default:return!1}}class vl extends Error{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Set;super(e),this.omitPropsFromLogging=n,this._errorInstanceId=Object(ge.a)(),this.fluidErrorCode="-",n.add("omitPropsFromLogging"),n.add("_errorInstanceId"),t&&this.addTelemetryProperties(t)}get errorInstanceId(){return this._errorInstanceId}overwriteErrorInstanceId(e){this._errorInstanceId=e}static typeCheck(e){return"object"==typeof e&&null!==e&&"function"==typeof e.addTelemetryProperties&&"function"==typeof e.getTelemetryProperties&&"string"==typeof e.errorInstanceId}addTelemetryProperties(e){!function(e,t){for(const n of Object.keys(t))void 0===e[n]&&(e[n]=t[n])}(this,e)}getTelemetryProperties(){const e=function(e,t){const n={};for(const i of Object.keys(e)){if(t.has(i))continue;const r=e[i];n[i]=gl(r)?{value:pl(r.value,i),tag:r.tag}:pl(r,i)}return n}(this,this.omitPropsFromLogging);return Object.assign(Object.assign({},e),{stack:this.stack,message:this.message,errorInstanceId:this._errorInstanceId})}}const yl="genericError";class bl extends vl{constructor(e){super(e.message),this.errorType=yl,void 0!==e.stack&&hl(this,e.stack)}}var Sl,Cl;!function(e){e.CodeArtifact="CodeArtifact",e.UserData="UserData"}(Sl||(Sl={}));class wl{constructor(e,t){this.namespace=e,this.properties=t}static formatTick(e){return Math.floor(e)}static numberFromString(e){if(null==e)return;const t=Number(e);return Number.isNaN(t)?e:t}static sanitizePkgName(e){return e.replace("@","").replace("/","-")}static prepareErrorObject(e,t,n){const{message:i,errorType:r,stack:s}=ol(t,!0);if(e.stack=s,e.error=i,e.errorType=r,al(t)){const n=t.getTelemetryProperties();for(const t of Object.keys(n))void 0===e[t]&&(e[t]=n[t])}void 0===e.stack&&n&&(e.stack=function(){return ul().stack}())}sendTelemetryEvent(e,t){var n;this.sendTelemetryEventCore(Object.assign(Object.assign({},e),{category:null!==(n=e.category)&&void 0!==n?n:"generic"}),t)}sendTelemetryEventCore(e,t){const n=function(e){var{category:t,eventName:n}=e,i=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n}(e,["category","eventName"]);const r={category:t,eventName:n};for(const e of Object.keys(i))r[e]=El(i[e]);return r}(e);void 0!==t&&wl.prepareErrorObject(n,t,!1),"number"==typeof n.duration&&(n.duration=wl.formatTick(n.duration)),this.send(n)}sendErrorEvent(e,t){this.sendTelemetryEventCore(Object.assign(Object.assign({error:e.eventName},e),{category:"error"}),t)}sendPerformanceEvent(e,t){var n;const i=Object.assign(Object.assign({},e),{category:null!==(n=e.category)&&void 0!==n?n:"performance"});this.sendTelemetryEventCore(i,t)}prepareEvent(e){const t="error"===e.category||void 0!==e.error,n=Object.assign({},e);if(void 0!==this.namespace&&(n.eventName=`${this.namespace}${wl.eventNamespaceSeparator}${n.eventName}`),this.properties){const i=[];i.push(this.properties.all),t&&i.push(this.properties.error);for(const t of i)if(void 0!==t)for(const i of Object.keys(t)){if(void 0!==e[i])continue;const r=t[i],s="function"==typeof r?r():r;void 0!==s&&(n[i]=s)}}return n}}wl.eventNamespaceSeparator=":";class Ol extends wl{constructor(e,t,n){super(t,n),this.baseLogger=e,Yc(e)&&el(this,new Zc(this,e.config))}static create(e,t,n){if(e instanceof Ol){const i={};for(const t of[e.properties,n])void 0!==t&&(void 0!==t.all&&(i.all=Object.assign(Object.assign({},i.all),t.all)),void 0!==t.error&&(i.error=Object.assign(Object.assign({},i.error),t.error)));return new Ol(e.baseLogger,void 0===e.namespace?t:void 0===t?e.namespace:`${e.namespace}${wl.eventNamespaceSeparator}${t}`,i)}return new Ol(e||new Nl,t,n)}send(e){this.baseLogger.send(this.prepareEvent(e))}}class Il{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{end:!0,cancel:"generic"};var i;this.logger=e,this.markers=n,this.startTime=Le.a.now(),this.event=Object.assign({},t),this.markers.start&&this.reportEvent("start"),"object"==typeof window&&null!=window&&(null===(i=window.performance)||void 0===i?void 0:i.mark)&&(this.startMark=`${t.eventName}-start`,window.performance.mark(this.startMark))}static start(e,t,n){return new Il(e,t,n)}static timedExec(e,t,n,i){const r=Il.start(e,t,i);try{const e=n(r);return r.autoEnd(),e}catch(e){throw r.cancel(void 0,e),e}}static async timedExecAsync(e,t,n,i){const r=Il.start(e,t,i);try{const e=await n(r);return r.autoEnd(),e}catch(e){throw r.cancel(void 0,e),e}}get duration(){return Le.a.now()-this.startTime}reportProgress(e){this.reportEvent(arguments.length>1&&void 0!==arguments[1]?arguments[1]:"update",e)}autoEnd(){this.event&&this.markers.end&&this.reportEvent("end"),this.performanceEndMark(),this.event=void 0}end(e){this.reportEvent("end",e),this.performanceEndMark(),this.event=void 0}performanceEndMark(){if(this.startMark&&this.event){const e=`${this.event.eventName}-end`;window.performance.mark(e),window.performance.measure(`${this.event.eventName}`,this.startMark,e),this.startMark=void 0}}cancel(e,t){void 0!==this.markers.cancel&&this.reportEvent("cancel",Object.assign({category:this.markers.cancel},e),t),this.event=void 0}reportEvent(e,t,n){if(!this.event)return;const i=Object.assign(Object.assign({},this.event),t);i.eventName=`${i.eventName}_${e}`,"start"!==e&&(i.duration=this.duration),this.logger.sendPerformanceEvent(i,n)}}class Nl{send(e){}}class Tl{send(e){}sendTelemetryEvent(e,t){}sendErrorEvent(e,t){}function El(e){return gl(e)?{value:kl(e.value),tag:e.tag}:kl(e)}function kl(e){switch(typeof e){case"string":case"number":case"boolean":case"undefined":return e;case"object":return JSON.stringify(e);default:return console.error(`convertToBasePropertyTypeUntagged: INVALID PROPERTY (typed as ${typeof e})`),`INVALID PROPERTY (typed as ${typeof e})`}}class jl{constructor(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new Map;this.eventBase=e,this.logger=t,this.sampleThreshold=n,this.includeAggregateMetrics=i,this.perBucketProperties=r,this.disposed=!1,this.measurementsMap=new Map}measure(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";var n,i,r;const s=Le.a.now(),o=e(),a=Le.a.now()-s;let c=this.measurementsMap.get(t);return void 0===c&&(c={count:0,duration:-1},this.measurementsMap.set(t,c)),c.count++,c.duration=a,this.includeAggregateMetrics&&(c.totalDuration=(null!==(n=c.totalDuration)&&void 0!==n?n:0)+a,c.minDuration=Math.min(null!==(i=c.minDuration)&&void 0!==i?i:a,a),c.maxDuration=Math.max(null!==(r=c.maxDuration)&&void 0!==r?r:0,a)),c.count>=this.sampleThreshold&&this.flushBucket(t),o}flushBucket(e){const t=this.measurementsMap.get(e);if(void 0!==t&&0!==t.count){const n=this.perBucketProperties.get(e),i=Object.assign(Object.assign(Object.assign({},this.eventBase),n),t);this.logger.sendPerformanceEvent(i),this.measurementsMap.delete(e)}}dispose(e){this.measurementsMap.forEach(((e,t)=>this.flushBucket(t)))}}!function(e){e.genericError="genericError",e.throttlingError="throttlingError",e.dataCorruptionError="dataCorruptionError",e.dataProcessingError="dataProcessingError",e.usageError="usageError",e.clientSessionExpiredError="clientSessionExpiredError"}(Cl||(Cl={}));class Pl extends vl{constructor(e){super(e),this.errorType=Cl.dataProcessingError,this.canRetry=!1}static create(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const r=Pl.wrapIfUnrecognized(e,t,n);return r.addTelemetryProperties(i),r}static wrapIfUnrecognized(e,t,n){const i=ll(e,{props:Object.assign({dataProcessingError:1,dataProcessingCodepath:t},void 0===n?void 0:_l(n))});if(ml(i)||i.errorType===yl){const e=function(e,t){const{message:n,stack:i}=ol(e,!1),r=((n);return void 0!==i&&hl(r,i),ml(e)&&r.addTelemetryProperties({untrustedOrigin:1}),il(e)&&(r.overwriteErrorInstanceId(e.errorInstanceId),r.addTelemetryProperties({innerErrorInstanceId:e.errorInstanceId})),al(e)&&r.addTelemetryProperties(e.getTelemetryProperties()),r}(i);return e.addTelemetryProperties(i.getTelemetryProperties()),e}return i}}const _l=function Ml(e,t){if(""===e)return void 0===t?"":t.absolutePath;{let n=e.startsWith("/")?e.slice(1):e;return n=n.endsWith("/")?n.slice(0,-1):n,void 0===t?`/${n}`:`${"/"===t.absolutePath?"":t.absolutePath}/${n}`}}class Dl{constructor(e,t){this.absolutePath=e,this.routeContext=t,this.isAttached=!0,Object(he.a)(e.startsWith("/"),413)}get IFluidRouter(){return this}get IFluidHandleContext(){return this}get IFluidHandle(){return this}async get(){return void 0===this.objectP&&(this.objectP=this.routeContext.resolveHandle({url:this.absolutePath,headers:{[ds.viaHandle]:!0}}).then((e=>{if("fluid/object"===e.mimeType)return e.value;throw function(e,t){const n=e.value,i=ul();return{errorFromRequestFluidObject:!0,message:n,name:"Error",code:e.status,get stack(){var t;return null!==(t=e.stack)&&void 0!==t?t:i.stack},underlyingResponseHeaders:e.headers}}(e)}))),this.objectP}attachGraph(){}bind(e){e.attachGraph()}async request(e){try{const t=(await this.get()).IFluidRouter;return void 0!==t?t.request(e):(e=>function(e,t,n,i){var r;Object(he.a)(!0,411);const s=null===(r=n.url)||void 0===r?void 0:r.split("?")[0],o=ul();return{mimeType:"text/plain",status:404,value:void 0===s?t:`${t}: ${s}`,get stack(){return o.stack},headers:void 0}}(0,"not found",e))(e)}catch(e){return function(e){if(null!==e&&"object"==typeof e&&!0===e.errorFromRequestFluidObject){const t=e;return{mimeType:"text/plain",status:t.code,value:t.message,get stack(){return t.stack},headers:t.underlyingResponseHeaders}}const t=ul();return{mimeType:"text/plain",status:500,value:`${e}`,get stack(){var n;return null!==(n=null==e?void 0:e.stack)&&void 0!==n?n:t.stack}}}(e)}}}class xl{constructor(e,t){for(this.context=e,this.handleParsedCb=t,this.encodeValue=(e,t)=>{const n=null==e?void 0:e.IFluidHandle;return void 0!==n?this.serializeHandle(n,t):e},this.decodeValue=e=>{if((e=>"__fluid_handle__"===(null==e?void 0:e.type))(e)){const t=e.url.startsWith("/")?e.url:Ml(e.url,this.context),n=new Dl(t,this.root);return this.handleParsedCb(n),n}return e},this.root=this.context;void 0!==this.root.routeContext;)this.root=this.root.routeContext}get IFluidSerializer(){return this}encode(e,t){return e&&"object"==typeof e?this.recursivelyReplace(e,this.encodeValue,t):e}decode(e){return e&&"object"==typeof e?this.recursivelyReplace(e,this.decodeValue):e}stringify(e,t){return JSON.stringify(e,((e,n)=>this.encodeValue(n,t)))}parse(e){return JSON.parse(e,((e,t)=>this.decodeValue(t)))}recursivelyReplace(e,t,n){const i=t(e,n);if(i!==e)return i;let r;for(const i of Object.keys(e)){const s=e[i];if(s&&"object"==typeof s){const o=this.recursivelyReplace(s,t,n);o!==s&&(r=null!=r?r:Array.isArray(e)?[...e]:Object.assign({},e),r[i]=o)}}return null!=r?r:e}serializeHandle(e,t){return t.bind(e),{type:"__fluid_handle__",url:e.absolutePath}}}class Al extends class{constructor(e,t,n){this.value=e,this.path=t,this.routeContext=n,this.pendingHandlesToMakeVisible=new Set,this.locallyVisible=!1,this.absolutePath=Ml(t,this.routeContext)}get IFluidHandle(){return this}get isAttached(){return this.routeContext.isAttached}get visible(){return this.isAttached||this.locallyVisible}async get(){return this.value}attachGraph(){this.visible||(this.locallyVisible=!0,this.pendingHandlesToMakeVisible.forEach((e=>{e.attachGraph()})),this.pendingHandlesToMakeVisible.clear(),this.routeContext.attachGraph())}bind(e){this.visible?e.attachGraph():this.pendingHandlesToMakeVisible.add(e)}}{constructor(e,t,n){super(e,t,n),this.value=e}get isAttached(){return this.value.isAttached()}attachGraph(){this.value.bindToContext(),super.attachGraph()}}class Rl extends xl{constructor(){super(...arguments),this.serializedRoutes=new Set}getSerializedRoutes(){return Array.from(this.serializedRoutes)}serializeHandle(e,t){return this.serializedRoutes.add(e.absolutePath),super.serializeHandle(e,t)}}class Fl extends Gc{constructor(e,t,n){super(((e,t)=>this.eventListenerErrorHandler(e,t))),this.id=e,this.runtime=t,this.attributes=n,this._connected=!1,this._isBoundToContext=!1,Object(he.a)(!e.includes("/"),772),this.handle=new Al(this,e,t.IFluidHandleContext),this.logger=Ol.create(t.logger,void 0,{all:{sharedObjectId:Object(ge.a)(),ddsType:{value:this.attributes.type,tag:Sl.CodeArtifact}}}),this.mc=function(e){return Yc(e)?e:el(e,$c.value)}(this.logger),[this.opProcessingHelper,this.callbacksHelper]=this.setUpSampledTelemetryHelpers(),this.attachListeners()}get IFluidLoadable(){return this}get connected(){return this._connected}setUpSampledTelemetryHelpers(){var e,t;Object(he.a)(void 0!==this.mc&&void 0!==this.logger,841);const n=new jl({eventName:"ddsOpProcessing",category:"performance"},this.logger,null!==(e=this.mc.config.getNumber("Fluid.SharedObject.OpProcessingTelemetrySampling"))&&void 0!==e?e:1e3,!0,new Map([["local",{localOp:!0}],["remote",{localOp:!1}]])),i=new jl({eventName:"ddsEventCallbacks",category:"performance"},this.logger,null!==(t=this.mc.config.getNumber("Fluid.SharedObject.DdsCallbacksTelemetrySampling"))&&void 0!==t?t:1e3,!0);return this.runtime.once("dispose",(()=>{this.callbacksHelper.dispose(),this.opProcessingHelper.dispose()})),[n,i]}closeWithError(e){void 0===this.closeError&&(this.closeError=e)}verifyNotClosed(){if(void 0!==this.closeError)throw this.closeError}eventListenerErrorHandler(e,t){const n=Pl.wrapIfUnrecognized(t,"SharedObjectEventListenerException");throw n.addTelemetryProperties({emittedEventName:String(e)}),this.closeWithError(n),n}attachListeners(){this.isAttached()||this.runtime.once("attaching",(()=>{this.didAttach()}))}async load(e){this.runtime.attachState!==Vc.Detached&&(this.services=e),await this.loadCore(e.objectStorage),this.runtime.attachState!==Vc.Detached&&this.attachDeltaHandler()}initializeLocal(){this.initializeLocalCore()}bindToContext(){this._isBoundToContext||(this._isBoundToContext=!0,this.runtime.bindChannel(this))}connect(e){this.services=e,this.attachDeltaHandler()}isAttached(){return void 0!==this.services&&this.runtime.attachState!==Vc.Detached}handleDecoded(e){var t,n,i;this.isAttached()&&(null===(i=null===(t=this.services)||void 0===t?void 0:(n=t.deltaConnection).addedGCOutboundReference)||void 0===i||i.call(n,this.handle,e))}initializeLocalCore(){}didAttach(){}submitLocalMessage(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;this.verifyNotClosed(),this.isAttached()&&this.services.deltaConnection.submit(e,t)}dirty(){this.isAttached()&&this.services.deltaConnection.dirty()}onConnect(){}reSubmitCore(e,t){this.submitLocalMessage(e,t)}async newAckBasedPromise(e){let t;return new Promise(((n,i)=>{t=()=>i(new Error("FluidDataStoreRuntime disposed while this ack-based Promise was pending")),this.runtime.disposed?t():(this.runtime.on("dispose",t),e(n,i))})).finally((()=>{this.runtime.off("dispose",t)}))}attachDeltaHandler(){Object(he.a)(void 0!==this.services,122),this._isBoundToContext=!0,this.didAttach(),this.services.deltaConnection.attach({process:(e,t,n)=>{this.process(e,t,n)},setConnectionState:e=>{this.setConnectionState(e)},reSubmit:(e,t)=>{this.reSubmit(e,t)},applyStashedOp:e=>this.applyStashedOp(e),rollback:(e,t)=>{this.rollback(e,t)}}),this.setConnectionState(this.services.deltaConnection.connected)}setConnectionState(e){this._connected!==e&&(this._connected=e,e?this.onConnect():this.onDisconnect())}process(e,t,n){this.verifyNotClosed(),this.emitInternal("pre-op",e,t,this),this.opProcessingHelper.measure((()=>{this.processCore(e,t,n)}),t?"local":"remote"),this.emitInternal("op",e,t,this)}reSubmit(e,t){this.reSubmitCore(e,t)}rollback(e,t){throw new Error("rollback not supported")}emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return this.callbacksHelper.measure((()=>this.runtime.ensureNoDataModelChanges((()=>super.emit(e,...n)))))}emitInternal(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return super.emit(e,...n)}}class ql extends Fl{constructor(e,t,n,i){super(e,t,n),this.telemetryContextPrefix=i,this._isGCing=!1,this._serializer=new xl(this.runtime.channelsRoutingContext,(e=>this.handleDecoded(e)))}get serializer(){return Object(he.a)(!this._isGCing,117),this._serializer}getAttachSummary(){let e=arguments.length>2?arguments[2]:void 0;const t=this.summarizeCore(this.serializer,e);return this.incrementTelemetryMetric(Hc.blobCountPropertyName,t.stats.blobNodeCount,e),this.incrementTelemetryMetric(Hc.totalBlobSizePropertyName,t.stats.totalBlobSize,e),t}async summarize(){let e=arguments.length>2?arguments[2]:void 0;const t=this.summarizeCore(this.serializer,e,arguments.length>3?arguments[3]:void 0);return this.incrementTelemetryMetric(Hc.blobCountPropertyName,t.stats.blobNodeCount,e),this.incrementTelemetryMetric(Hc.totalBlobSizePropertyName,t.stats.totalBlobSize,e),t}getGCData(){let e;Object(he.a)(!this._isGCing,120),this._isGCing=!0;try{const t=new Rl(this.runtime.channelsRoutingContext,(e=>this.handleDecoded(e)));this.processGCDataCore(t),e={gcNodes:{"/":t.getSerializedRoutes()}},Object(he.a)(this._isGCing,121)}finally{this._isGCing=!1}return e}processGCDataCore(e){this.summarizeCore(e)}incrementTelemetryMetric(e,t,n){var i;const r=null!==(i=null==n?void 0:n.get(this.telemetryContextPrefix,e))&&void 0!==i?i:0;null==n||n.set(this.telemetryContextPrefix,e,r+t)}}function zl(){const e={treeNodeCount:0,blobNodeCount:0,handleNodeCount:0,totalBlobSize:0,unreferencedBlobSize:0};for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];for(const t of n)e.treeNodeCount+=t.treeNodeCount,e.blobNodeCount+=t.blobNodeCount,e.handleNodeCount+=t.handleNodeCount,e.totalBlobSize+=t.totalBlobSize,e.unreferencedBlobSize+=t.unreferencedBlobSize;return e}class Bl{constructor(){this.attachmentCounter=0,this.summaryTree={},this.summaryStats=zl(),this.summaryStats.treeNodeCount++}get summary(){return{type:ln.a.Tree,tree:Object.assign({},this.summaryTree)}}get stats(){return Object.assign({},this.summaryStats)}addBlob(e,t){!function(e,t,n){e.summary.tree[t]={type:ln.a.Blob,content:n},e.stats.blobNodeCount++,e.stats.totalBlobSize+=function(e){return"string"==typeof e?function(e){let t=e.length;for(let n=e.length-1;n>=0;n--){const i=e.charCodeAt(n);i>127&&i<=2047?t++:i>2047&&i<=65535&&(t+=2),i>=56320&&i<=57343&&n--}return t}(e):e.byteLength}(n)}({summary:{type:ln.a.Tree,tree:this.summaryTree},stats:this.summaryStats},e,t)}addHandle(e,t,n){this.summaryTree[e]={type:ln.a.Handle,handleType:t,handle:n},this.summaryStats.handleNodeCount++}addWithStats(e,t){this.summaryTree[e]=t.summary,this.summaryStats=zl(this.summaryStats,t.stats)}addAttachment(e){this.summaryTree[this.attachmentCounter++]={id:e,type:ln.a.Attachment}}getSummaryTree(){return{summary:this.summary,stats:this.stats}}}class Ll extends Error{constructor(e){var t;super(e),this.errorType="SharedTreeAssertion",this.name="Assertion error",null===(t=Error.captureStackTrace)||void 0===t||t.call(Error,this)}}function Vl(e,t){return e-t}unction Hl(e,t){return e>t?1:e===t?0:-1}function Gl(e,t,n=!1){e||$l(t,n)}function $l(e="Assertion failed",t=!1){throw new Ll(t?"Assertion failed":e)}function Kl(e,t="value must not be undefined"){return Gl(void 0!==e,t),e}function Wl(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0}),n}function Jl(e,t,n=Object.is){if(e.size!==t.size)return!1;for(const[i,r]of e){const e=t.get(i);if(void 0===e||!n(r,e))return!1}return!0}function Ql(e,t,n){let i=e.get(t);return void 0===i&&(i=n(t),e.set(t,i)),i}function Xl(){}function Zl(e,t,n){const i=e[n];void 0!==i&&(t[n]=i)}r td;function nd(e){return 1===e.length&&Array.isArray(e[0])?e[0]:e}!function(e){function t(e){return{type:s.Ok,result:e}}unction i(e){return e.type===s.Ok}et s;e.ok=t,e.error=n,e.isOk=i,e.isError=r,e.mapOk=function(e,n){return i(e)?t(n(e.result)):e},e.mapError=function(e,t){return r(e)?n(t(e.error)):e},function(e){e[e.Ok=0]="Ok",e[e.Error=1]="Error"}(s=e.ResultType||(e.ResultType={}))}(td||(td={}));var id=n("QzZJ"),rd=n.n(id);const sd=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(e,t)=>Object.is(e,t);return e===t||e.length===t.length&&e.every(()};function od(e){const{editChunks:t}=e;let n=0;return t.forEach((({chunk:e})=>{Array.isArray(e)||n++})),n}class ad extends me.a{constructor(e={editIds:[],editChunks:[]},t,n=[],i=1/0,r=2*i,s=[]){super(),this.logger=t,this.targetLength=i,this.evictionFrequency=r,this.localEditSequence=0,this._minSequenceNumber=0,this.sequencedEdits=[],this.localEdits=[],this.allEditIds=new Map,this._earliestAvailableEditIndex=0,this._editAddedHandlers=new Set,this._editEvictionHandlers=new Set;const{editChunks:o,editIds:a}=e;for(const e of n)this.registerEditAddedHandler(e);if(i!==1/0){(i<0||r<0)&&$l("targetLength and evictionFrequency should not be negative"),this.sequenceNumberToIndex=new rd.a([[0,0]]);for(const e of s)this.registerEditEvictionHandler(e)}o.forEach((e=>{var t;const{startRevision:n,chunk:i}=e;if(Array.isArray(i))for(const[e,t]of i.entries()){const i=n+e,r=a[i];this.sequencedEdits.push(Object.assign({id:r},t));const s=this.allEditIds.get(r);Object(he.a)(void 0===s,1546),this.allEditIds.set(r,{isLocal:!1,index:i})}else null===(t=this.logger)||void 0===t||t.sendErrorEvent({eventName:"UnexpectedEditHandleInSummary"})}))}get earliestAvailableEditIndex(){return this._earliestAvailableEditIndex}get minSequenceNumber(){return this._minSequenceNumber}registerEditAddedHandler(e){return this._editAddedHandlers.add(e),()=>this._editAddedHandlers.delete(e)}get editAddedHandlers(){return Array.from(this._editAddedHandlers)}et editEvictedHandlers(){return Array.from(this._editEvictionHandlers)}et numberOfSequencedEdits(){return this.sequencedEdits.length}get numberOfLocalEdits(){return this.localEdits.length}get editIds(){return this.sequencedEdits.map((({id:e})=>e)).concat(this.localEdits.map((({id:e})=>e)))}isLocalEdit(e){var t;const n=this.allEditIds.get(e);return null!==(t=null==n?void 0:n.isLocal)&&void 0!==t&&t}isSequencedRevision(e){return e<=this.sequencedEdits.length}tryGetIndexOfId(e){var t;const n=this.allEditIds.get(e);if(void 0!==n){if(n.isLocal){const e=null!==(t=this.allEditIds.get(this.localEdits[0].id))&&void 0!==t?t:$l("edit not found");return Object(he.a)(e.isLocal,1547),this._earliestAvailableEditIndex+this.numberOfSequencedEdits+n.localSequence-e.localSequence}return n.index}}getOrderedEditId(e){var t;return null!==(t=this.allEditIds.get(e))&&void 0!==t?t:$l("All edits should exist in this map")}getIndexOfId(e){var t;return null!==(t=this.tryGetIndexOfId(e))&&void 0!==t?t:$l("edit not found")}getIdAtIndex(e){return this._earliestAvailableEditIndex+this.numberOfSequencedEdits<=e?this.localEdits[e-this.numberOfSequencedEdits].id:this.sequencedEdits[e-this._earliestAvailableEditIndex].id}tryGetEditAtIndex(e){return this._earliestAvailableEditIndex+this.numberOfSequencedEdits<=e?this.localEdits[e-this.numberOfSequencedEdits]:this.sequencedEdits[e-this._earliestAvailableEditIndex]}tryGetEditFromId(e){const t=this.tryGetIndexOfId(e);return void 0!==t?this.tryGetEditAtIndex(t):void 0}sequenceLocalEdits(){this.localEdits.slice().forEach((e=>this.addSequencedEditInternal(e)))}dSequencedEditInternal(e,t,n=0){var i,r,s;Object(he.a)(n>=this._minSequenceNumber,1548),this._minSequenceNumber=n;const{id:o}=e,a=this._earliestAvailableEditIndex+this.numberOfSequencedEdits,c=this.allEditIds.get(o);if(void 0!==c){Object(he.a)(c.isLocal,1549);const e=null!==(r=null===(i=this.localEdits.shift())||void 0===i?void 0:i.id)&&void 0!==r?r:$l("Local edit should exist");Object(he.a)(e===o,1550)}this.sequencedEdits.push(e),this.allEditIds.set(o,{index:a,isLocal:!1,sequenceInfo:t}),void 0!==t&&(null===(s=this.sequenceNumberToIndex)||void 0===s||s.set(t.sequenceNumber,a)),this.emitAdd(e,!1,void 0!==c),void 0!==this.sequenceNumberToIndex&&this.numberOfSequencedEdits>=this.evictionFrequency&&this.evictEdits()}addLocalEdit(e){this.localEdits.push(e);const t={localSequence:this.localEditSequence++,isLocal:!0};this.allEditIds.set(e.id,t),this.emitAdd(e,!0,!1)}emitAdd(e,t,n){for(const i of this._editAddedHandlers)i(e,t,n)}evictEdits(){var e,t;Object(he.a)(void 0!==this.sequenceNumberToIndex,1551);const n=(null!==(t=null===(e=this.sequenceNumberToIndex.getPairOrNextHigher(this._minSequenceNumber))||void 0===e?void 0:e[1])&&void 0!==t?t:$l("No index associated with that sequence number."))-this.earliestAvailableEditIndex;if(n>0){const e=Math.min(n,this.numberOfSequencedEdits-this.targetLength);for(const t of this._editEvictionHandlers)t(e);const t=this.sequencedEdits.splice(0,e);this._earliestAvailableEditIndex+=e,t.forEach((),this.sequenceNumberToIndex.deleteRange(0,this._minSequenceNumber,!1)}}etEditLogSummary(e){const t=this.sequencedEdits.map(();return void 0!==e?{editChunks:0===this.sequencedEdits.length?[]:[{startRevision:0,chunk:this.sequencedEdits.map((t=>e(t)))}],editIds:t}:{editChunks:0===this.sequencedEdits.length?[]:[{startRevision:0,chunk:this.sequencedEdits.map(()}],editIds:t}}async tryGetEdit(e){const t=this.tryGetIndexOfId(e);return void 0!==t?this.tryGetEditAtIndex(t):void 0}async getEditAtIndex(e){var t;return null!==(t=this.tryGetEditAtIndex(e))&&void 0!==t?t:$l("Edit not found")}getEditInSessionAtIndex(e){var t;return null!==(t=this.tryGetEditAtIndex(e))&&void 0!==t?t:$l("Edit not found")}}ar ld=n("Lrhb");const dd=Array.from("09afAF").map(();function ud(e){return e>=dd[0]&&e<=dd[1]||e>=dd[2]&&e<=dd[3]||e>=dd[4]&&e<=dd[5]}const hd=md(ld.a);function md(e){return Gl(function(e){for(let t=0;t<e.length;t++)switch(t){case 8:case 13:case 18:case 23:if("-"!==e.charAt(t))return!1;break;default:if(!ud(e.charCodeAt(t)))return!1}return!0}(e),`${e} is not an UuidString`),e}function gd(e){return Gl(pd(e),`${e} is not a StableId.`),e}function pd(e){if(36!==e.length)return!1;for(let t=0;t<e.length;t++)switch(t){case 8:case 13:case 18:case 23:if("-"!==e.charAt(t))return!1;break;case 14:if("4"!==e.charAt(t))return!1;break;case 19:{const n=e.charAt(t);if("8"!==n&&"9"!==n&&"a"!==n&&"b"!==n)return!1;break}default:if(!ud(e.charCodeAt(t)))return!1}return!0}class fd{nKey(){return this.elements[0]}maxKey(){return this.elements[this.elements.length-2]}rst(){const{elements:e}=this,{length:t}=e;if(0!==t)return[e[0],e[1]]}last(){const{elements:e}=this,{length:t}=e;if(0===t)return;const n=t-2;return[e[n],e[n+1]]}getAtIndex(e){const t=2*e,{elements:n}=this;if(!(t<0||t>n.length-1))return[n[t],n[t+1]]}*entries(){const{elements:e}=this;for(let t=0;t<e.length;t+=2)yield[e[t],e[t+1]]}*keys(){const{elements:e}=this;for(let t=0;t<e.length;t+=2)yield e[t]}*values(){const{elements:e}=this;for(let t=0;t<e.length;t+=2)yield e[t+1]}*entriesReversed(){const{elements:e}=this;for(let t=e.length-2;t>=0;t-=2)yield[e[t],e[t+1]]}append(e,t){const{elements:n}=this,{length:i}=n;0!==i&&this.comparator(e,this.maxKey())<=0&&$l("Inserted key must be > all others in the map."),n.push(e),n.push(t)}get(e){const t=fd.keyIndexOf(this.elements,e,this.comparator);if(!(t<0))return this.elements[t+1]}getPairOrNextLower(e){return this.getPairOrNextLowerBy(e,this.comparator)}getPairOrNextHigher(e){return this.getPairOrNextHigherBy(e,this.comparator)}equals(e,t){if(e===this)return!0;if(this.elements.length!==e.elements.length)return!1;for(let n=this.elements.length-2;n>=0;n-=2){const i=this.elements[n+1],r=e.elements[n+1];if(0!==this.comparator(this.elements[n],e.elements[n]))return!1;if(!t(i,r))return!1}return!0}assertValid(){let e;for(const t of this.entries())void 0!==e&&Object(he.a)(this.comparator(t[0],e[0])>0,1598),e=t}*getRange(e,t){const n=this.getKeyIndexOfOrNextHigher(e,this.comparator);if(void 0===n)return;const i=this.getKeyIndexOfOrNextLower(t,this.comparator);if(void 0!==i)for(let e=n;e<=i;e+=2)yield[this.elements[e],this.elements[e+1]]}getPairOrNextLowerBy(e,t){const n=this.getKeyIndexOfOrNextLower(e,t);if(void 0!==n)return[this.elements[n],this.elements[n+1]]}getKeyIndexOfOrNextLower(e,t){const{elements:n}=this;if(0===n.length)return;let i=fd.keyIndexOf(n,e,t);return i<0?(i^=fd.failureXor,i>0?i-2:void 0):i}getPairOrNextHigherBy(e,t){const n=this.getKeyIndexOfOrNextHigher(e,t);if(void 0!==n)return[this.elements[n],this.elements[n+1]]}getKeyIndexOfOrNextHigher(e,t){const{elements:n}=this,{length:i}=n;if(0===i)return;let r=fd.keyIndexOf(n,e,t);return r<0?(r^=fd.failureXor,r<i?r:void 0):r}static keyIndexOf(e,t,n){let i=0,r=e.length/2,s=r>>1;for(;i<r;){const o=2*s,a=n(t,e[o],e[o+1]);if(a>0)i=s+1;else if(a<0)r=s;else{if(0===a)return o;$l("Invalid comparator.")}s=i+r>>1}return 2*s^fd.failureXor}}fd.failureXor=-1;class vd extends fd{constructor(e,t,n){super(e),this.extractSearchValue=t,this.valueComparator=n,this.compareValues=(e,t,n)=>this.valueComparator(e,this.extractSearchValue(n))}append(e,t){0!==this.elements.length&&this.valueComparator(this.extractSearchValue(t),this.extractSearchValue(this.maxValue()))<=0&&$l("Inserted value must be > all others in the map."),super.append(e,t)}getByValue(e){var t;const n=fd.keyIndexOf(this.elements,e,this.compareValues);return null===(t=this.elements[n])||void 0===t?void 0:t[0]}getPairOrNextLowerByValue(e){return this.getPairOrNextLowerBy(e,this.compareValues)}ssertValid(){let e;super.assertValid();for(const t of this.entries())void 0!==e&&Object(he.a)(this.valueComparator(this.extractSearchValue(t[1]),this.extractSearchValue(e[1]))>0,1599),e=t}}const yd=2**52-1,bd=2**52;function Sd(e,t,n){const[i,r]=e,[s,o]=t;if(i===s){const e=r-o;return e>=0&&e<=n?e:void 0}let a=Number.parseInt(jd.Upper.parse(i),16)-Number.parseInt(jd.Upper.parse(s),16);if(Math.abs(a)>1)return;let c=jd.getNumericValue(jd.Variant.parse(i));const l=jd.getNumericValue(jd.Variant.parse(s));let d=r-o;d<0&&(c-=1,d+=bd);let u=c-l;if(u<0&&(a-=1,u+=jd.twentyThirdBit),0===a&&!(u>1)){const e=bd*u+d;return e>n?void 0:e}}const Cd=[];for(let e=0;e<13;e++)Cd.push("0".repeat(e));function wd(e,t){return e.length===t?e:Cd[t-e.length]+e}function Od(e,t=0){const n=e[1]+t;if(n<=yd){const t=wd(n.toString(16),13);return`${e[0]+t.slice(0,1)}-${t.slice(1)}`}return Od(kd(e,t))}function Id(e){const t=new Array(2);return t[0]=e.slice(0,22),t[1]=Number.parseInt(jd.Lower.parse(e),16),t}function Nd(){return xd())}onst Ed=2**48-1;function kd(e,t){let n;const i=e[1]+t;if(i<=yd)n=[e[0],i];else{const i=t-(yd-e[1])-1,r=e[0],[s,o]=jd.increment(r);if(o){const e=jd.Upper.parse(r),t=Number.parseInt(e,16);Gl(t<=Ed);const o=t+1;if(o>Ed)$l("Exceeded maximum numeric UUID");else{const e=wd(o.toString(16),12);n=[`${jd.Upper.hyphenate(e)}-4${jd.Variant.hyphenate(s)}`,i]}}else n=[`${jd.Upper.slice(r)}-4${jd.Variant.hyphenate(s)}`,i]}return n}var jd;!function(e){const t=4194303;let n,i,r;function s(e){const t=Number.parseInt(e,16);return((16773120&t)>>2)+(768&t)+(255&t)}e.twentyThirdBit=2**22,function(e){e.parse=function(e){return e.slice(0,8)+e.slice(9,13)},e.hyphenate=function(e){return`${e.slice(0,8)}-${e.slice(8)}`},e.slice=(n=e.Upper||(e.Upper={})),function(e){e.parse=function(e){return e.slice(15,18)+e.slice(19,22)},e.hyphenate=function(e){return`${e.slice(0,3)}-${e.slice(3)}`}}(i=e.Variant||(e.Variant={})),function(e){e.parse=function(e){return e.slice(22,23)+e.slice(24)},e.hyphenate=function(e){return`${e.slice(0,1)}-${e.slice(1)}`}}(r=e.Lower||(e.Lower={})),e.getNumericValue=s,e.increment=function(e){const n=i.parse(e),r=s(n);Gl(r<=t);const o=r+1;return[wd((((4193280&o)<<2)+(768&o|2048)+(255&o)).toString(16),n.length),o>t]}}(jd||(jd={}));const Pd="ffffffff-ffff-4fff-bf",_d=[...Pd].filter(().length,Md=["7","b","d","e"];unction xd(e){if(e.startsWith(Pd)){const t=Math.floor(Math.random()*_d);let n=0;for(let e=0;e<t&&!Dd(n);n+=1)Dd(n)&&e++;const i=Md[Math.floor(Math.random()*Md.length)];return e.slice(0,n)+i+e.slice(n+1)}return e}class Ad{constructor(e=!1){this.expensiveAsserts=e,this.nextLocalId=-1,this.idRanges=new vd(Ul,(([e,t])=>void 0!==t?qd(function(e){var t;return Rd(e)?e:(null!==(t=e.first())&&void 0!==t?t:$l("Map must be non-empty"))[1]}(t)):Number.POSITIVE_INFINITY),Vl)}getSessionSpaceId(e){const t=this.idRanges.getPairOrNextLowerByValue(e);if(void 0!==t){const[n,[i,r]]=t,s=zd(n,r,e);if(void 0!==s){const[t,[n,r]]=s;if(e<=r){const r=e-n;return r<=t-i?t-r:e}}}}getFinalId(e){var t;const n=null!==(t=this.idRanges.getPairOrNextLower(e))&&void 0!==t?t:$l("Local ID was never recorded with this normalizer."),[i,[r,s]]=n;e<r&&$l("Local ID was never recorded with this normalizer.");const o=Bd(i,s,e);if(void 0!==o){const[t,[n,i,r]]=o,s=t-e;if(s<=i-n)return[n+s,r]}}getCreationIndex(e){const t=this.idRanges.getPairOrNextLowerByValue(e);if(void 0!==t){const[n,[i,r]]=t,s=zd(n,r,e);if(void 0!==s){const[t,[n,i]]=s;if(e<=i)return-t-1+(e-n)}}}getIdByCreationIndex(e){var t;const n=-(e+1),i=this.idRanges.getPairOrNextLower(n);if(void 0===i)return;const[r,[s,o]]=i;if(n>=s)return n;const a=null!==(t=Bd(r,o,n))&&void 0!==t?t:$l("Final ranges not aligned with owning local range."),[c,[l,d]]=a,u=l+(c-n);return u<=d?u:void 0}static makeFinalRangesMapetLastFinalId(){const e=this.idRanges.size-1,t=Math.max(0,e-1);for(let n=e;n>=t;n--){const e=this.idRanges.getAtIndex(n);if(void 0!==e){const t=e[1][1];if(void 0!==t)return Fd(t)[1]}}}addLocalId(){const e=this.nextLocalId--,t=this.idRanges.last();if(void 0!==t&&e===t[1][0]-1)return t[1][0]=e,e;if(this.expensiveAsserts)if(void 0===t)Object(he.a)(-1===e,1623);else{const[n,[i,r]]=t;let s=0;for(const[e,[t,i]]of Ld(n,r))s+=i-t+1;Object(he.a)(e===n-s,1624)}return this.idRanges.append(e,[e,void 0]),e}addFinalIds(e,t,n){var i;Object(he.a)(t>=e,1625);const[r,s]=null!==(i=this.idRanges.last())&&void 0!==i?i:$l("Final IDs must be added to an existing local range."),[o,a]=s;let c;if(void 0===a)s[1]=[e,t,n],c=Math.min(this.nextLocalId,r-(t-e)-1);else{const[i,l,d,u]=this.getAlignmentOfLastRange(r,a);if(c=Math.min(this.nextLocalId,l-(t-e)-2),e===d+1)u[1]=t;else{const r=l-1;let c;Rd(a)?(c=Ad.makeFinalRangesMap(),c.append(i,u),s[1]=c):c=a,c.append(r,[e,t,n]),Object(he.a)(r>=o,1626)}this.expensiveAsserts&&this.idRanges.assertValid()}this.nextLocalId=c}registerFinalIdBlock(e,t,n){var i;Object(he.a)(t>=1,1627);const[r,[s,o]]=null!==(i=this.idRanges.last())&&void 0!==i?i:$l("Final ID block should not be registered before any locals.");let a;if(void 0===o)a=r-s+1;else{const[e,t]=this.getAlignmentOfLastRange(r,o);a=t-s}Object(he.a)(a>0,1628);const c=e+Math.min(a,t)-1;this.addFinalIds(e,c,n)}getAlignmentOfLastRange(e,t){var n;let i,r;Rd(t)?(r=e,i=t):[r,i]=null!==(n=t.last())&&void 0!==n?n:$l("Map should be non-empty.");const[s,o]=i;return[r,r-(o-s),o,i]}*[Symbol.iterator](){var e;for(const[t,[n,i]]of this.idRanges.entries()){for(let e=t;e>=n;e--)yield e;if(void 0!==i){let r,s;Rd(i)?(s=t,r=i):[s,r]=null!==(e=i.last())&&void 0!==e?e:$l("Map should be non-empty.");const[o,a]=r;for(let e=o+(s-n)+1;e<=a;e++)yield e}}}serialize(){const e={localRanges:[],nextLocalId:this.nextLocalId},t=e.localRanges;for(const[e,n]of this.idRanges.entries()){const[i,r]=n;if(void 0!==r){const n=[];for(const[t,[i,s]]of Ld(e,r))n.push([t,i,s]);t.push([e,i,n])}else t.push([e,i])}return e}static deserialize(e,t){const n=new Ad,{idRanges:i}=n;for(const[n,r,s]of e.localRanges){let e;if(void 0!==s)if(Object(he.a)(0!==s.length,1629),1===s.length){const[n,i,r]=s[0];e=[i,r,t(i)]}else{e=Ad.makeFinalRangesMap();for(const[n,i,r]of s)e.append(n,[i,r,t(i)])}i.append(n,[r,e])}return n.nextLocalId=e.nextLocalId,n}equals(e,t=((e,t)=>e===t)){return this.nextLocalId===e.nextLocalId&&this.idRanges.equals(e.idRanges,((e,n)=>{const[i,r]=e,[s,o]=n;if(void 0===r||void 0===o)return r===o;const a=(e,n)=>{const[i,r,s]=e,[o,a,c]=n;return i===o&&r===a&&t(s,c)};return Rd(r)||Rd(o)?!(!Rd(r)||!Rd(o))&&a(r,o):i===s&&r.equals(o,a)}))}}unction Fd(e){var t;return Rd(e)?e:(null!==(t=e.last())&&void 0!==t?t:$l("Map must be non-empty"))[1]}unction zd(e,t,n){if(void 0!==t){if(Rd(t)){if(n<t[0])return;return[e,t]}return t.getPairOrNextLowerByValue(n)}}function Bd(e,t,n){if(void 0!==t){if(Rd(t)){if(n>e)return;return[e,t]}return t.getPairOrNextLower(n)}}function*Ld(e,t){if(void 0!==t)if(Rd(t))yield[e,t];else for(const e of t.entries())yield e}const Vd=xd(gd("decaf40b-3c1a-47f8-a7a1-e8461ddb69ce")),Ud="24e26f0b-3c1a-47f8-a7a1-e8461ddb69ce6";ass $d{constructor(e,t,n,i){if(this.localSessionId=e,this.reservedIdCount=t,this.logger=i,this.newClusterCapacity=512,this.sessions=new Map,this.nextClusterBaseFinalId=0,this.localIdCount=0,this.localOverrides=new fd(Ul),this.sessionIdNormalizer=new Ad,this.clustersAndOverridesInversion=new rd.a(void 0,Hl),this.finalIdToCluster=new fd(Vl),Object(he.a)(t>=0,1602),void 0!==n&&md(n),this.localSession=this.createSession(e,n),t>0){const e=this.clusterCapacity;this.clusterCapacity=t,this.finalizeCreationRange({sessionId:Vd,ids:{last:-t,overrides:[[-1,Ud]]}}),this.clusterCapacity=e}}get clusterCapacity(){return this.newClusterCapacity}set clusterCapacity(e){Object(he.a)(e>0,1600),Object(he.a)(e<=$d.maxClusterSize,1601),this.newClusterCapacity=e}get attributionId(){return this.localSession.attributionId}createSession(e,t){Gl(!this.clustersAndOverridesInversion.has(e)),void 0!==this.sessions.get(e)&&$l("createSession must only be called once for each session ID.");const n={sessionUuid:Id(e),currentClusterDetails:void 0,lastFinalizedLocalId:void 0,attributionId:null!=t?t:e};return this.sessions.set(e,n),n}getReservedId(e){return(e<0||e>=this.reservedIdCount)&&$l("Reserved Id index out of bounds"),e}ttributeId(e){const t=this.normalizeToOpSpace(e);if(Gd(t))return this.attributionId;const n=this.getClusterForFinalId(t);if(void 0===n){if(void 0!==this.sessionIdNormalizer.getCreationIndex(t))return this.attributionId;$l("Cluster does not exist for final ID")}const[i,r]=n;return r.session.attributionId}takeNextCreationRange(){var e;const t=-this.localIdCount,n=null!==(e=this.lastTakenLocalId)&&void 0!==e?e:0;Gl(t<=n);const i=void 0===this.lastTakenLocalId;let r;if(t!==n){const e=n-1,i=[...this.localOverrides.getRange(n-1,t)];if(i)){Gl(i[0][0]<=e),Gl(i[i.length-1][0]>=t),r={overrides:i};const n=t===i[i.length-1][0]?void 0:t;Yl(e===i[0][0]?void 0:e,r,"first"),Yl(n,r,"last")}else r={first:e,last:t};this.lastTakenLocalId=t}const s={sessionId:this.localSessionId};return this.attributionId!==this.localSessionId&&i&&(s.attributionId=this.attributionId),void 0===r||(Object(he.a)(this.lastTakenLocalId===-this.localIdCount&&this.lastTakenLocalId!==n,1603),s.ids=r),s}finalizeCreationRange(e){var t,n,i,r,s,o,a,c,l,d,u,h;const{sessionId:m,attributionId:g}=e,p=m===this.localSessionId,f=null!==(t=this.sessions.get(m))&&void 0!==t?t:this.createSession(m,g);Object(he.a)(void 0===e.attributionId||e.attributionId===f.attributionId,1604);const v=function(e){const{ids:t}=e;if(void 0===t)return;let n=t.first,i=t.last;const r=t;return void 0!==r.overrides&&(null!=n||(n=r.overrides[0][0]),null!=i||(i=r.overrides[r.overrides.length-1][0])),Object(he.a)(void 0!==n&&void 0!==i,1622),{first:n,last:i,overrides:r.overrides}}(e);if(void 0===v)return;const{currentClusterDetails:y}=f,{cluster:b,clusterBase:S}=null!=y?y:{cluster:void 0,clusterBase:void 0},C=void 0!==b&&void 0!==S,w=null!==(n=f.lastFinalizedLocalId)&&void 0!==n?n:0,{first:O,last:I}=v;Object(he.a)(O===w-1,1605);const N=w-I;Object(he.a)(N>=1,1606);let T,E,k,j,P=0,_=0,M=N;if(C){if(p){const e=null!==(i=this.sessionIdNormalizer.getLastFinalId())&&void 0!==i?i:$l("Cluster exists but normalizer does not have an entry for it."),t=S+Math.min(b.count+N,b.capacity)-1;t>e&&this.sessionIdNormalizer.addFinalIds(e+1,t,b)}_=b.count;const e=b.capacity-_,t=M-e,n=t<=0;if(n||S===this.finalIdToCluster.maxKey()){if(b.count+=M,P=M,M=0,!n){const e=this.newClusterCapacity+t,n=b.capacity;if(b.capacity+=e,this.nextClusterBaseFinalId=this.nextClusterBaseFinalId+e,Object(he.a)(this.nextClusterBaseFinalId<Number.MAX_SAFE_INTEGER,1607),this.checkClusterForCollision(b),p){const i=S+b.count-1;Object(he.a)(void 0!==f.lastFinalizedLocalId,1608),this.sessionIdNormalizer.registerFinalIdBlock(i-t+1,e,b),null===(r=this.logger)||void 0===r||r.sendTelemetryEvent({eventName:"SharedTreeIdCompressor:ClusterExpansion",sessionId:this.localSessionId,previousCapacity:n,newCapacity:b.capacity,overflow:t})}}}else T=kd(b.baseUuid,b.capacity),b.count+=e,P=e,M-=e,null===(s=this.logger)||void 0===s||s.sendTelemetryEvent({eventName:"SharedTreeIdCompressor:OverfilledCluster",sessionId:this.localSessionId})}else T=f.sessionUuid,p&&(null===(o=this.logger)||void 0===o||o.sendTelemetryEvent({eventName:"SharedTreeIdCompressor:FirstCluster",sessionId:this.localSessionId}));if(void 0!==T){M<=0&&$l("Should not create an empty cluster."),void 0!==b&&b.capacity!==b.count&&$l("Cluster must be filled before another is allocated."),k=this.nextClusterBaseFinalId;const e=Math.max(this.newClusterCapacity,M);E={baseUuid:T,capacity:e,count:M,session:f},j=O-(N-M),p&&(null===(a=this.logger)||void 0===a||a.sendTelemetryEvent({eventName:"SharedTreeIdCompressor:NewCluster",sessionId:this.localSessionId,clusterCapacity:e,clusterCount:M}),this.sessionIdNormalizer.registerFinalIdBlock(k,E.capacity,E)),this.checkClusterForCollision(E),this.clustersAndOverridesInversion.set(Od(E.baseUuid),{clusterBase:k,cluster:E}),f.currentClusterDetails={cluster:E,clusterBase:k},this.nextClusterBaseFinalId=this.nextClusterBaseFinalId+E.capacity,Object(he.a)(this.nextClusterBaseFinalId<Number.MAX_SAFE_INTEGER,1609),this.finalIdToCluster.append(k,E)}const D=v.overrides;if(void 0!==D)for(let e=0;e<D.length;e++){const[t,n]=D[e];let i,r;Object(he.a)(0===e||t<D[e-1][0],1610),Object(he.a)(t<w,1611),Object(he.a)(t>=I,1612),void 0!==j&&t<=j?(Object(he.a)(void 0!==E&&void 0!==k,1613),i=E,r=k+(j-t)):(Object(he.a)(void 0!==b&&void 0!==S,1614),i=b,r=S+_+(w-t)-1),null!==(c=i.overrides)&&void 0!==c||(i.overrides=new Map);const s=$d.createInversionKey(n),o=this.getExistingIdsForNewOverride(s,!0);let a,l;if(void 0!==o){let e;"number"==typeof o?(e=o,Gd(e)&&(l=e)):[l,e]=o,Hd(e)?a=e:(Object(he.a)(!p||e===t,1615),a=n)}else a=n;if(Object(he.a)(!i.overrides.has(r),1616),"string"==typeof a)i.overrides.set(r,p||void 0===l?n:{override:n,originalOverridingFinal:r,associatedLocalId:l});else{const e={override:n,originalOverridingFinal:a};Yl(l,e,"associatedLocalId"),i.overrides.set(r,e)}const d={cluster:i,originalOverridingFinal:r};Yl(l,d,"associatedLocalId");const u=this.clustersAndOverridesInversion.get(s);(void 0===u||$d.isUnfinalizedOverride(u))&&this.clustersAndOverridesInversion.set(s,d)}p&&(null===(l=this.logger)||void 0===l||l.sendTelemetryEvent({eventName:"SharedTreeIdCompressor:IdCompressorStatus",eagerFinalIdCount:P-(null!==(d=null==D?void 0:D.length)&&void 0!==d?d:0),localIdCount:M+(null!==(u=null==D?void 0:D.length)&&void 0!==u?u:0),overridesCount:null!==(h=null==D?void 0:D.length)&&void 0!==h?h:0,sessionId:this.localSessionId})),f.lastFinalizedLocalId=I}checkClusterForCollision(e){const t=kd(e.baseUuid,e.capacity-1),n=Od(t),i=this.clustersAndOverridesInversion.getPairOrNextLower(n);if(void 0!==i){const[r,s]=i;!$d.isClusterInfo(s)&&pd(r)&&$d.uuidsMightCollide(r,n,e.capacity)&&void 0!==Sd(t,Id(r),e.capacity-1)&&$d.failWithCollidingOverride(r)}}static failWithCollidingOverride(e){$l(`Override '${e}' collides with another allocated UUID.`)}atic createInversionKey(e){return pd(e)?e:`${e}0)}getExistingIdsForNewOverride(e,t){var n;const i=this.clustersAndOverridesInversion.getPairOrNextLower(e,Qd);let r,s;if(void 0!==i){const[n,o]=i;if($d.isClusterInfo(o)){if($d.isStableInversionKey(e)){s=e;const i=o.cluster;if($d.uuidsMightCollide(e,n,i.capacity)){r=Id(s);const e=Sd(r,i.baseUuid,i.capacity-1);if(void 0!==e&&!t){if(e>=i.count)return;return this.normalizeToSessionSpace(o.clusterBase+e)}}}}else if(n===e){if($d.isUnfinalizedOverride(o))return o;const e=o;return void 0!==e.associatedLocalId?[e.associatedLocalId,e.originalOverridingFinal]:e.originalOverridingFinal}}const o=null!==(n=null!=r?r:s)&&void 0!==n?n:$d.isStableInversionKey(e)?e:void 0;if(void 0!==o){const e=this.getCompressedIdForStableId(o);if(void 0!==e)return e}}static uuidsMightCollide(e,t,n){const i=32-Math.ceil(Math.log2(n)/2);return!!e.startsWith(t.slice(0,i))}static tryGetOverride(e,t){var n;const i=null===(n=e.overrides)||void 0===n?void 0:n.get(t);if(void 0!==i)return"string"==typeof i?i:i.override}generateCompressedId(e){let t;if(void 0!==e){t=$d.createInversionKey(e);const n=this.getExistingIdsForNewOverride(t,!1);if(void 0!==n)return"number"==typeof n?n:n[0]}const n=-++this.localIdCount,{currentClusterDetails:i}=this.localSession,{sessionIdNormalizer:r}=this;let s,o;if(void 0!==i){o=i.cluster;const e=r.getLastFinalId();void 0!==e&&e-i.clusterBase+1<o.capacity&&(s=e+1)}if(void 0!==t){const i=r.addLocalId();Object(he.a)(i===n,1617),void 0!==s&&r.addFinalIds(s,s,null!=o?o:$l()),this.localOverrides.append(n,null!=e?e:$l()),this.clustersAndOverridesInversion.set(t,n)}else{if(void 0!==s)return r.addFinalIds(s,s,null!=o?o:$l()),s;{const e=r.addLocalId();Object(he.a)(e===n,1618)}}return n}decompress(e){var t;return null!==(t=this.tryDecompress(e))&&void 0!==t?t:$l("Compressed ID was not generated by this compressor")}tryDecompress(e){var t;if(Hd(e)){const t=this.getClusterForFinalId(e);if(void 0===t){const t=this.sessionIdNormalizer.getCreationIndex(e);return void 0!==t?Od(this.localSession.sessionUuid,t):void 0}{const[n,i]=t,r=$d.tryGetOverride(i,e);return void 0!==r?r:Od(i.baseUuid,e-n)}}{const n=-e;if(n>this.localIdCount)return;const i=null===(t=this.localOverrides)||void 0===t?void 0:t.get(e);return void 0!==i?i:Od(this.localSession.sessionUuid,n-1)}}recompress(e){var t;return null!==(t=this.tryRecompress(e))&&void 0!==t?t:$l("No such string has ever been compressee)}recompressInternal(e,t){var n,i;let r=t;const s=$d.createInversionKey(e),o=$d.isStableInversionKey(s),a=this.clustersAndOverridesInversion.getPairOrNextLower(s,Qd);if(void 0!==a){const[e,t]=a;if($d.isClusterInfo(t)){if(!o)return;const{clusterBase:e,cluster:n}=t;null!=r||(r=Id(s));const a=Sd(r,n.baseUuid,n.count-1);if(void 0!==a){let t=e+a;const r=null===(i=n.overrides)||void 0===i?void 0:i.get(t);if("object"==typeof r){if(void 0!==r.associatedLocalId)return r.associatedLocalId;t=r.originalOverridingFinal}return this.normalizeToSessionSpace(t)}}else if(e===s)return $d.isUnfinalizedOverride(t)?t:null!==(n=t.associatedLocalId)&&void 0!==n?n:t.originalOverridingFinal}if(o){const e=this.getCompressedIdForStableId(null!=r?r:s);if(void 0!==e)return e}}normalizeToOpSpace(e){var t,n,i;if(Hd(e))return e;-e>this.localIdCount&&$l("Supplied local ID was not created by this compressor.");const{lastFinalizedLocalId:r}=this.localSession;if(void 0===r||e<r){const i=this.localOverrides.get(e);if(void 0!==i){const n=$d.createInversionKey(i),r=null!==(t=this.clustersAndOverridesInversion.get(n))&&void 0!==t?t:$l("Bimap is malformed.");return $d.isClusterInfo(r)||$d.isUnfinalizedOverride(r)||r.associatedLocalId!==e?e:r.originalOverridingFinal}const r=this.sessionIdNormalizer.getFinalId(e);return null!==(n=null==r?void 0:r[0])&&void 0!==n?n:e}const[s,o]=null!==(i=this.sessionIdNormalizer.getFinalId(e))&&void 0!==i?i:$l("Locally created cluster should be added to the map when allocated");if(o.overrides){const e=o.overrides.get(s);if("object"==typeof e&&void 0!==e.originalOverridingFinal)return e.originalOverridingFinal}return s}normalizeToSessionSpace(e,t){var n,i,r,s;if(Gd(e)){if(void 0===t||t===this.localSessionId)return-e>this.localIdCount&&$l("Supplied local ID was not created by this compressor."),e;{const r=kd((null!==(n=this.sessions.get(t))&&void 0!==n?n:$l("No IDs have ever been finalized by the supplied session.")).sessionUuid,-e-1);return null!==(i=this.compressNumericUuid(r))&&void 0!==i?i:$l("ID is not known to this compressor.")}}const o=this.sessionIdNormalizer.getSessionSpaceId(e);if(void 0!==o)return o;const[a,c]=null!==(r=this.getClusterForFinalId(e))&&void 0!==r?r:$l("Supplied final ID was not finalized by this compressor."),l=null===(s=c.overrides)||void 0===s?void 0:s.get(e);return"object"==typeof l&&void 0!==l.associatedLocalId?l.associatedLocalId:e}compressNumericUuid(e){const t=Od(e),n=this.recompressInternal(t,e);if(void 0!==n)return n}getCompressedIdForStableId(e){const t=Sd("string"==typeof e?Id(e):e,this.localSession.sessionUuid,this.localIdCount-1);if(void 0!==t){const e=this.sessionIdNormalizer.getIdByCreationIndex(t);if(void 0!==e)return e}}getClusterForFinalId(e){const t=this.finalIdToCluster.getPairOrNextLower(e);if(void 0===t)return;const[n,i]=t;return e-n>=i.count?void 0:t}equals(e,t){if(t){if(this.localIdCount!==e.localIdCount||this.localSessionId!==e.localSessionId||this.lastTakenLocalId!==e.lastTakenLocalId||this.attributionId!==e.attributionId)return!1;if(!this.localOverrides.equals(e.localOverrid==t)))return!1;if(!Jl(this.sessions,e.sessions,((e,n)=>$d.sessionDataEqual(e,n,!0,t))))return!1;if(!this.sessionIdNormalizer.equals(e.sessionIdNormalizer,((e,n)=>$d.idClustersEqual(e,n,!1,t))))return!1}else{for(const[n,i]of this.sessions){const r=e.sessions.get(n);if(void 0===r){if(void 0!==i.lastFinalizedLocalId)return!1}else if(!$d.sessionDataEqual(i,r,!0,t))return!1}for(const[t,n]of e.sessions)if(void 0===this.sessions.get(t)&&void 0!==n.lastFinalizedLocalId)return!1}if(this.nextClusterBaseFinalId!==e.nextClusterBaseFinalId||this.newClusterCapacity!==e.newClusterCapacity)return!1;if(!this.finalIdToCluster.equals(e.finalIdToCluster,((e,n)=>$d.idClustersEqual(e,n,!0,t))))return!1;const n=(e,n)=>{if(t||!$d.isUnfinalizedOverride(n))return{break:!0}};return void 0===this.clustersAndOverridesInversion.diffAgainst(e.clustersAndOverridesInversion,n,n,((e,n,i)=>{if(!((e,n)=>{const i=$d.isUnfinalizedOverride(e),r=$d.isUnfinalizedOverride(n);if(i)return!!r&&e===n;if(r)return!1;if($d.isClusterInfo(e)){if(!$d.isClusterInfo(n)||e.clusterBase!==n.clusterBase)return!1}else if($d.isClusterInfo(n)||t&&e.associatedLocalId!==n.associatedLocalId||e.originalOverridingFinal!==n.originalOverridingFinal)return!1;return!!$d.idClustersEqual(e.cluster,n.cluster,!0,t)})(n,i))return{break:!0}}))}static sessionDataEqual(e,t,n=!0,i=!0){return!(e.attributionId!==t.attributionId||!Td(e.sessionUuid,t.sessionUuid)||e.lastFinalizedLocalId!==t.lastFinalizedLocalId||(void 0===e.currentClusterDetails||void 0===t.currentClusterDetails?e.currentClusterDetails!==t.currentClusterDetails:n&&!$d.idClustersEqual(e.currentClusterDetails.cluster,t.currentClusterDetails.cluster,!1,i)))}static idClustersEqual(e,t,n=!0,i=!0){return Td(e.baseUuid,t.baseUuid)&&e.capacity===t.capacity&&e.count===t.count&&(!n||$d.sessionDataEqual(e.session,t.session,!1,i))&&void 0===e.overrides==(void 0===t.overrides)&&(void 0===e.overrides||Jl(Kl(e.overrides),Kl(t.overrides),((e,t)=>i?"string"==typeof e||"string"==typeof t?e===t:e.override===t.override&&e.originalOverridingFinal===t.originalOverridingFinal&&(!i||e.associatedLocalId===t.associatedLocalId):("string"==typeof e||"string"==typeof t||e.originalOverridingFinal===t.originalOverridingFinal)&&("string"==typeof e?e:e.override)===("string"==typeof t?t:t.override))))}serialize(e){var t,n;const i=[],r=new Map,s=new Map;let o;for(const[t,n]of this.sessions){const a=t===this.localSessionId;if(t!==Vd&&(void 0!==n.lastFinalizedLocalId||a&&e)){const e=[t];n.attributionId!==t&&e.push(Ql(s,n.attributionId,(e=>(null!=o?o:o=[]).push(e)-1))),r.set(t,i.length),i.push(e)}}const a=[];for(const[e,n]of this.finalIdToCluster.entries()){const i=Od(n.session.sessionUuid);if(i!==Vd){const s=[null!==(t=r.get(i))&&void 0!==t?t:$l("Session object contains wrong session numeric UUID"),n.capacity];if(n.count!==n.capacity&&s.push(n.count),void 0!==n.overrides){const t=[];for(const[i,r]of n.overrides){const n=i-e;t.push("string"==typeof r?[n,r]:r.originalOverridingFinal===i?[n,r.override]:[n,r.override,r.originalOverridingFinal])}s.push(t)}a.push(s)}}Object(he.a)(i.length-this.sessions.size<=2,1619);const c={version:Kd,reservedIdCount:this.reservedIdCount,clusterCapacity:this.clusterCapacity,sessions:i,clusters:a};if(Yl(o,c,"attributionIds"),e){const e=c;return e.localSessionIndex=e.sessions.findIndex((([e])=>e===this.localSessionId)),this.localIdCount>0&&(e.localState={localIdCount:this.localIdCount,overrides:[...this.localOverrides.entries()].m.e])),lastTakenLocalId:this.lastTakenLocalId,sessionNormalizer:this.sessionIdNormalizer.serialize()}),e}return null===(n=this.logger)||void 0===n||n.sendTelemetryEvent({eventName:"SharedTreeIdCompressor:SerializedIdCompressorSize",size:JSON.stringify(c).length,clusterCount:c.clusters.length,sessionCount:c.sessions.length}),c}static deserialize(...e){const[t,n,i]=e,{clusterCapacity:r,reservedIdCount:s,sessions:o,clusters:a,attributionIds:c}=t;let l,d,u;if(void 0===n){const[t]=e,n=o[t.localSessionIndex];l=n[0];const i=n[1];void 0!==i&&(Gl(void 0!==c&&c.length>i),d=c[i]),u=t.localState}else l=n,d=i;const h=new $d(l,s,d);h.clusterCapacity=r;const m=new Map;if(void 0!==u&&(h.localIdCount=u.localIdCount,h.lastTakenLocalId=u.lastTakenLocalId,void 0!==u.overrides))for(const[e,t]of u.overrides)h.localOverrides.append(e,t),m.set(t,e),h.clustersAndOverridesInversion.set($d.createInversionKey(t),e);const g=[];for(const e of o){const[n,i]=e;if(n===l)Object(he.a)(Wd(t),1620),g.push({session:h.localSession,sessionId:n});else{let e;void 0!==i&&(Object(he.a)(void 0!==c&&c.length>i,1621),e=c[i]);const t=h.createSession(n,e);g.push({session:t,sessionId:n})}}for(const e of a){const{sessionIndex:t,capacity:n,count:i,overrides:r}=Jd(e),{session:s,sessionId:o}=g[t],{lastFinalizedLocalId:a,sessionUuid:c}=s,d={capacity:n,count:i,baseUuid:kd(c,void 0===a?0:-a),session:s},p=h.nextClusterBaseFinalId;if(s.lastFinalizedLocalId=(null!=a?a:0)-i,s.currentClusterDetails={clusterBase:p,cluster:d},h.nextClusterBaseFinalId=h.nextClusterBaseFinalId+n,h.finalIdToCluster.append(p,d),h.clustersAndOverridesInversion.set(Od(d.baseUuid),{clusterBase:p,cluster:d}),void 0!==r){d.overrides=new Map;for(const[e,t,n]of r){const i=p+e;if(void 0!==n){const e={override:t,originalOverridingFinal:n};void 0!==u&&Yl(m.get(t),e,"associatedLocalId"),d.overrides.set(i,e)}else{const e=m.get(t);d.overrides.set(i,void 0!==e&&o!==l?{override:t,originalOverridingFinal:i,associatedLocalId:e}:t);const n={cluster:d,originalOverridingFinal:i};void 0!==u&&Yl(e,n,"associatedLocalId"),h.clustersAndOverridesInversion.set($d.createInversionKey(t),n)}}}}return void 0!==u&&(h.sessionIdNormalizer=Ad.deserialize(u.sessionNormalizer,(e=>{var t;const[n,i]=null!==(t=h.finalIdToCluster.getPairOrNextLower(e))&&void 0!==t?t:$l("Final in serialized normalizer was never created.");return i}))),Gl(void 0===h.localSession.lastFinalizedLocalId||h.localIdCount>=-h.localSession.lastFinalizedLocalId),h}static convertToCurrentVersion(e,t){e.version!==Kd&&$l("Unknown SerializedIdCompressor version number");const n=e;if(t===Wd(n))return n}}$d.maxClusterSize=2**20;const Kd="0.0ex}function Jd(e){const[t,n,i,r]=e,s="number"==typeof i;return{sessionIndex:t,capacity:n,count:s?i:n,overrides:s?r:i}}const Qd=[],Xd={traits:{},definition:"51c58718-47b9-4fe4-ad46-56312f3b9e86",identifier:Ud};var Zd,Yd=n("nnHz"),eu=n.n(Yd),tu=n("naE4"),nu=n.n(tu);class iu{constructor(e,t,n){this.retentionWindowStart=t,this.sortedEntries=new rd.a(void 0,Vl),Object(he.a)(t>=0,1580),this.evictableRevisions=new nu.a({max:e,noDisposeOnSet:!0,dispose:e=>{e>=this.retentionWindowStart&&$l("Entries in retention window should never be evicted."),this.retainedRevision===e&&$l("Retained entries should not be evicted"),this.sortedEntries.delete(e)}}),void 0!==n&&this.cacheRetainedValue(n[0],n[rt}updateRetentionWindow(e){e<this.retentionWindowStart&&$l("retention window boundary must not move backwards");const t=this.retentionWindowStart;this.retentionWindowStart=e;const n=[];this.sortedEntries.forRange(t,this.retentionWindowStart,!1,((e,t)=>{this.retainedRevision!==e&&n.push([e,t])})),n.forEat)}))}getClosestEntry(e){var t;const n=this.evictableRevisions.get(e);return void 0!==n?[e,n]:null!==(t=this.sortedEntries.getPairOrNextLower(e))&&void 0!==t?t:void 0}cacheRetainedValue(e,t){void 0!==this.retainedRevision&&this.sortedEntries.delete(this.retainedRevision),this.retainedRevision=e,this.sortedEntries.set(e,t)}cacheValue(e,t){this.retainedRevision!==e&&(this.sortedEntries.set(e,t),e<this.retentionWindowStart&&this.evictableRevisions.set(e,t))}}function ru(e,t){const n=function(e,t){var n,i,r;const s=null!==(n=t.start.referenceTrait)&&void 0!==n?n:t.end.referenceTrait;if(s)return s;const o=null!==(r=null!==(i=t.start.referenceSibling)&&void 0!==i?i:t.end.referenceSibling)&&void 0!==r?r:$l("malformed range does not indicate trait");return e.getTraitLocation(o)}(e,t);return{start:su(t,Zd.Start,n),end:su(t,Zd.End,n)}}function su(e,t,n){const i=t===Zd.Start?e.start:e.end;return{trait:n,side:i.side,sibling:i.referenceSiblind"}(Zd||(Zd={}));const ou={build:(e,t)=>({destination:t,source:e,type:d.Build}),insert:(e,t)=>({destination:t,source:e,type:d.Insert}),detach:(e,t)=>({destination:t,source:e,type:d.Detach}),setPayload:(e,t)=>({nodeToModify:cu(e),payload:t,type:d.SetValue}),clearPayload:e=>({nodeToModify:cu(e),payload:null,type:d.SetValue}),constraint:(e,t,n,i,r,s,o)=>({toConstrain:e,effect:t,identityHash:n,length:i,contentHash:r,parentNode:s,label:o,type:d.Constraint}),delete:e=>ou.detach(e),insertTree:(e,t)=>{const n=ou.build(e,0);return[n,ou.insert(n.destination,t)]},move:(e,t)=>{const n=ou.detach(e,0);return[n,ou.insert(Kl(n.destination),t)]}},au="79590933-1c70-4fda-817a-adab57c20318";function cu(e){var t;return null!==(t=e.identifier)&&void 0!==t?t:e}function lu(e,t){return{normalizeToOpSpace:t=>e.normalizeToOpSpace(t),normalizeToSessionSpace:n=>e.normalizeToSessionSpace(n,null!=t?t:e.localSessionId)}}function du(e){return{normalizeToOpSpace:t=>{const n=e.normalizeToOpSpace(t);return Gl(Hd(n)),n},normalizeToSessionSpace:t=>{const n=e.normalizeToSessionSpace(t,e.localSessionId);return Gl(Hd(n)),n}}}function uu(e){return{generateNodeId:t=>e.generateCompressedId(t),convertToNodeId:t=>e.recompress(t),tryConvertToNodeId:t=>e.tryRecompress(t),convertToStableNodeId:t=>e.decompress(t),tryConvertToStableNodeId:t=>e.tryDecompress(t),normalizeToOpSpace:t=>e.normalizeToOpSpace(t),normalizeToSessionSp,n),localSessionId:e.localSession:e}var t"}(mu||(mu={}));const gu={build:(e,t)=>({destination:t,source:e,type:mu.Build}),insert:(e,t)=>({destination:t,source:e,type:mu.Insert}),detach:(e,t)=>({destination:t,source:e,type:mu.Detach}),setPayle}),clearPayload:e=>({nodeToModify:e,payload:null,type:mu.SetValue}),constraint:(e,t,n,i,r,s,o)=>({toConstrain:e,effect:t,identityHash:n,length:i,contentHash:r,parentNode:s,label:o,type:mu.Constraint}),del(e),insertTree:(e,t)=>{const n=gu.build(e,0);return[n,gu.insert(n.destination,t)]},move:(e,t)=>{const n=gu.detach(e,0);return[n,gu.insert(Kl(n.destination),t)]}},pu=e=>({side:o.Before,referenceSibling:hu(e)}))}),vu=e=>({side:o.After,referenceTrait:e}),yu=e=>({side:o.Before,referenceTrait:e}),bu=e=>({start:pu(e),end:fu(e)}))});function Cu(e,t){if(Object.is(e,t))return!0;if("object"!=typeof e||"object"!=typeof t)return!1;if(null===e||null===t)return!1;{const n=t;if(e.IFluidHandle===e)return n.IFluidHandle===t&&e.absolutePath===t.absolutePath}const n=Object.keys(e),i=Object.keys(t);if(n.length!==i.length)return!1;if(e instanceof Array!=t instanceof Array)return!1;if(e instanceof Array||(n.sort(),i.sort()),!sd(n,i))return!1;for(let r=0;r<n.length;r++){const s=e[n[r]],o=t[i[r]],a=Object.is(s,e);if(a!==Object.is(o,t))return!1;if(!a&&!Cu(s,o))return!1}return!0}function wu(e){const t=void 0!==e.parentId,n=void 0!==e.traitParent;return Object(he.a)(t===n,1552),t}class Ou{constructor(e){"object"==typeof e?(this.nodes=e.nodes,this.expensiveValidation=e.expensiveValidation):(this.nodes=new rd.a(void 0,Vl),this.expensiveValidation=null!=e&&e),this.expensiveValidation&&this.assertConsistent()}static create(e=!1){return new Ou(e)}get size(){return this.nodes.size}add(e){const t=[...e],n=this.nodes.clone(),i=new Map;for(const e of t){const{identifier:t}=e;for(const[r,s]of e.traits){Object(he.a)(s.length>0,1553);for(const e of s){const s=n.get(e);if(void 0!==s){Object(he.a)(!wu(s),1554);const i={definition:s.definition,identifier:s.identifier,traits:s.traits,parentId:t,traitParent:r};Zl(s,i,"payload"),n.set(e,i)}else i.set(e,{parentId:t,traitParent:r})}}}for(const e of t){const t=i.get(e.identifier);if(Object(he.a)(!n.has(e.identifier),1555),void 0!==t){const i=Object.assign({definition:e.definition,identifier:e.identifier,traits:e.traits},t);Zl(e,i,"payload"),n.set(e.identifier,i)}else n.set(e.identifier,e)}return new Ou({nodes:n,expensiveValidation:this.expensiveValidation})}attachRangeOfChildren(e,t,n,i){var r;Object(he.a)(n>=0,1556);const s=this.nodes.get(e);Object(he.a)(void 0!==s,1557);const o=this.nodes.clone(),a=new Map(s.traits),c=null!==(r=a.get(t))&&void 0!==r?r:[];if(Object(he.a)(n<=c.length,1558),0===i.length)return this;const l=[...c.slice(0,n),...i,...c.slice(n)];a.set(t,l),o.set(e,Object.assign(Object.assign({},s),{traits:a}));for(const n of i)o.editRange(n,n,!0,((n,i)=>(Object(he.a)(!wu(i),1559),{value:Object.assign(Object.assign({},i),{parentId:e,traitParent:t})})));return new Ou({nodes:o,expensiveValidation:this.expensiveValidation})}detachRangeOfChildren(e,t,n,i){var r;Object(he.a)(n>=0&&i>=n,1560);const s=this.nodes.get(e);if(Object(he.a)(void 0!==s,1561),n===i)return{forest:this,detached:[]};const o=this.nodes.clone(),a=new Map(s.traits),c=null!==(r=a.get(t))&&void 0!==r?r:[];Object(he.a)(i<=c.length,1562);const l=c.slice(n,i),d=[...c.slice(0,n),...c.slice(i)];0===d.length?a.delete(t):a.set(t,d),o.set(e,Object.assign(Object.assign({},s),{traits:a}));for(const e of l)o.editRange(e,e,!0,((e,t)=>{const n={value:{definition:t.definition,identifier:t.identifier,traits:t.traits}};return Zl(t,n.value,"payload"),n}));return{forest:new Ou({nodes:o,expensiveValidation:this.expensiveValidation}),detached:l}}setValue(e,t){const n=this.nodes.get(e);Object(he.a)(void 0!==n,1563);const i=this.nodes.clone(),r=Object.assign({},n);return null!==t?r.payload=t:delete r.payload,i.set(e,r),new Ou({nodes:i,expensiveValidation:this.expensiveValidation})}has(e){return this.nodes.has(e)}get(e){var t;return null!==(t=this.nodes.get(e))&&void 0!==t?t:$l("NodeId not found")}tryGet(e){return this.nodes.get(e)}delete(e,t){const n=this.nodes.clone();for(const i of e)this.deleteRecursive(n,i,t);return new Ou({nodes:n,expensiveValidation:this.expensiveValidation})}deleteRecursive(e,t,n){var i;const r=null!==(i=e.get(t))&&void 0!==i?i:$l("node to delete must exist");Object(he.a)(!wu(r),1564),e.delete(t);for(const t of r.traits.values())for(const i of t)e.editRange(i,i,!0,((e,t)=>{const n={value:{definition:t.definition,identifier:t.identifier,traits:t.traits}};return Zl(t,n.value,"payload"),n})),n&&this.deleteRecursive(e,i,n)}assertConsistent(){var e;const t=new Set([]);for(const[n,i]of this.nodes.entries(void 0,[])){if(wu(i)){const e=this.get(i.parentId).traits.get(i.traitParent);Object(he.a)(void 0!==e,1565),Object(he.a)(e.includes(i.identifier),1566)}for(const r of i.traits.values()){Object(he.a)(r.length>0,1567);for(const s of r){const r=this.nodes.get(s);Object(he.a)(void 0!==r,1568),Object(he.a)(wu(r),1569),Object(he.a)(r.parentId===i.identifier,1570),Object(he.a)(!t.has(s),1571),Object(he.a)((null!==(e=r.parentId)&&void 0!==e?e:$l("each node must have associated metadata"))===n,1572),t.add(s)}}}}getParent(e){const t=this.nodes.get(e);return void 0===t&&$l("NodeId not found"),Object(he.a)(wu(t),1573),{parentId:t.parentId,traitParent:t.traitParent}}tryGetParent(e){const t=this.nodes.get(e);if(void 0!==t&&wu(t))return{parentId:t.parentId,traitParent:t.traitParent}}equals(e){return this===e||this.nodes===e.nodes||e.size===this.size&&function(e,t,n){return void 0===e.diffAgainst(t,ed,ed,((e,t,i)=>{if(!n(t,i))return{break:!0}}))}(this.nodes,e.nodes,Iu)}delta(e){const t=[],n=[],i=[];return this.nodes.diffAgainst(e.nodes,(e=>{n.push(e)}),(e=>{i.push(e)}),((e,n,i)=>{Iu(n,i)||t.push(e)})),{changed:t,added:i,removed:n}}}function Iu(e,t){if(e===t)return!0;if(e.identifier!==t.identifier)return!1;if(e.definition!==t.definition)return!1;if(!Cu(e.payload,t.payload))return!1;if(e.traits.size!==t.traits.size)return!1;for(const n of e.traits){const[e,i]=n,r=t.traits.get(e);if(!r)return!1;if(i.length!==r.length)return!1;for(let e=0;e<i.length;e++)if(i[e]!==r[e])return!1}return!0}class Nu{constructor(e,t){this.root=e,this.forest=t,this.rootNode=this.getViewNode(e)}get size(){return this.forest.size}hasNode(e){return this.forest.has(e)}findIndexWithinTrait(e){return void 0===e.sibling?this.getIndexOfSide(e.side,e.tra+t}(e.side,this.getIndexInTrait(e.sibling))}getViewNode(e){var t;return null!==(t=this.tryGetViewNode(e))&&void 0!==t?t:$l("NodeId not found")}tryGetViewNode(e){const t=this.forest.tryGet(e);if(void 0!==t&&wu(t)){const e={definition:t.definition,identifier:t.identifier,traits:t.traits,parentage:{label:t.traitParent,parent:t.parentId}};return Zl(t,e,"payload"),e}returnt}tryGetTraitLabel(e){var t;return null===(t=this.forest.tryGetParent(e))||void 0===t?void 0:t.traitParent}getParentViewNode(e){const t=this.forest.getParent(e);return this.getViewNode(t.parentId)}tryGetParentViewNode(e){const t=this.forest.tryGetParent(e);if(void 0!==t)return this.getViewNode(t.parentt}}tryGetTraitLocation(e){const t=this.forest.tryGetParent(e);if(void 0!==t)return{parent:t.parentId,label:t.traitParent}}getIndexInTrait(e){const t=this.tryGetIndexInTrait(e);return null!=t?t:$l("ID does not exist in the forest.")}tryGetIndexInTrait(e){var t,n,i;const r=null===(t=this.traitIndicesCache)||void 0===t?void 0:t.get(e);if(void 0!==r)return r;const s=this.forest.tryGetParent(e);if(void 0===s)return;const o=this.forest.tryGet(s.parentId);if(void 0===o)return;const a=null!==(n=o.traits.get(s.traitParent))&&void 0!==n?n:$l("inconsistent forest: trait parent not found");let c;if(0===a.length)return c;null!==(i=this.traitIndicesCache)&&void 0!==i||(this.traitIndicesCache=new Map);for(let t=0;t<a.length;t++){const n=a[t],i=t;this.traitIndicesCache.set(n,i),n===e&&(c=i)}return c}getTrait(e){var t;return null!==(t=this.getViewNode(e.parent).traits.get(e.label))&&void 0!==t?t:[]}assertConsistent(){this.forest.assertConsistene)}hasEqualForest(e,t=!1){return this.root===e.root&&(t?this.forest===e.forest:this.forest.equals(e.forest))}*iterateNodeDescendants(e){yield e;for(const t of[...e.traits.keys()].sort()){const n=e.traits.get(t);for(const e of null!=n?n:$l("Expected trait with label")){const t=this.getViewNode(e);yield*this.iterateNodeDescendants(t)}}}getIndexOfSide(e,t){return e===o.After?0:this.getTrait(t).length}delta(e){return Object(he.a)(this.root===e.root,1597),this.forest.delta(e.forest)}}class Tu extends Nu{static fromTree(e,t,n=!1){if("object"==typeof t){const i=t.convertToNodeId(e.identifier),r=ku(e,(e=>{const n=t.convertToNodeId(e.identifier),i={definition:e.definition,identifier:n};return Zl(e,i,"payload"),i}));return new Tu(i,Ou.create(n).add(r))}return new Tu(e.identifier,Ou.create(n).add(ku(e,(e=>{const t={definition:e.definition,identifier:e.identifier};return Zl(e,t,"payload"),t}))))}openForTransaction(){return new Eu(this.root,this.forest)}equals(e){return e instanceof Tu&&this.hasEqualForest(e)}}class Eu extendst)}addN))}deleteNodes(e){return new Eu(this.root,this.forest.delete(e,!0))}attachRange(e,t){const{parent:n,label:i}=t.trait,r=this.findIndexWithinTrait(t);return new Eu(this.root,this.forest.attachRangeOfChildren(n,i,r,e))}detachRange(e){const{start:t,end:n}=e,{trait:i}=t,{parent:r,label:s}=i,o=this.findIndexWithinTrait(t),a=this.findIndexWithinTrait(n),{forest:c,detached:l}=this.forest.detachRangeOfChildren(r,s,o,a);return{view:new Eu(this.root,c),detached:l}}setNodeValue(e,t){return new Eu(this.root,this.forest.setValue(e,t))}eqe)}}function ku(e,t){var n,i,r;const s=t(e);if(void 0===s||void 0===e.traits)return;const o=e===s?{traits:e.traits}:e;s.traits=new Map;const a=[{childIterator:ju(o)[Symbol.iterator](),newNode:s}],c=[];for(;a.length>0;){const{childIterator:e,newNode:s}=null!==(n=a[a.length-1])&&void 0!==n?n:$l("Undefined node"),{value:o,done:l}=e.next();if(!0===l)c.push(null!==(r=null===(i=a.pop())||void 0===i?void 0:i.newNode)&&void 0!==r?r:$l("covertTreeNodesToViewNodes incorrectly coordinated parentage"));else{const[e,n]=o,i=t(n);if(void 0===i)return;if(void 0!==n.traits){const e=n===i?{traits:n.traits}:n;i.traits=new Map,a.push({childIterator:ju(e)[Symbol.iterator](),newNode:i})}const r=s.traits;let c=r.get(e);void 0===c&&(c=[],r.set(e,c)),c.push(i.identifier)}}return c}function*ju(e){if(void 0!==e.traits)for(const[t,n]of Object.entries(e.traits).sort())if(void 0!==n)if(Pu(n))for(const e of n)yield[t,e];else yield[t,n]}function Pu(e){return Array.isArrayt)}function Mu(e,t,n=!1){const i=e.getViewNode(t),r={definition:i.definition,identifier:i.identifier};return Zl(i,r,"payload"),Object.assign(Object.assign({},r),n?{get traits(){return Wl(this,"traits",Du(e,i.traits,n))}}:{traits:Du(e,i.traits,n)})}function Du(e,t,n=!1){const i={};for(const[r,s]of t.entries())Object.defineProperty(i,r,n?{get(){const t=s.map((t=>Mu(e,t,n)));return Wl(this,r,t)},configurable:!0,enumerable:!0}:{value:s.map((t=>Mu(e,t,n))),enumerable:!0});returt)}function Au(e,t,n){const i=e.getViewNode(t),r={definition:i.definition,identifier:n.convertToStableNodeId(i.identifier)};return Zl(i,r,"payload"),Object.assign(Object.assign({},r),{traits:Ru(e,i.traits,n)})}function Ru(e,t,n){const i={};for(const[r,s]of t.entries())Object.defineProperty(i,r,{value:s.map((t=>Au(e,t,n))),enumerable:!0});return i}function Fu(e){return{id:qu(),changes()}function zu(e,t,n){var i;if(Lu(e,n))return e;const r=t(e),s=e===r?{traits:e.traits}:e;r.traits={};const o=[{childIterator:ju(s)[Symbol.iterator](),newNode:r}];for(;o.length>0;){const{childIterator:e,newNode:r}=null!==(i=o[o.length-1])&&void 0!==i?i:$l("Undefined node"),{value:s,done:a}=e.next();if(!0===a)o.pop();else{const[e,i]=s;let a;Lu(i,n)?a=i:(a=t(i),void 0!==i.traits&&o.push({childIterator:ju(i===a?{traits:i.traits}:i)[Symbol.iterator](),newNode:a}),a.traits={});const c=r.traits;let l=c[e];void 0===l&&(l=[],c[e]=l),l.push(a)}}return r}function Bu(e,t,n){var i;const r="function"==typeof t?t:t.nodeVisitor,s="object"==typeof t?t.placeholderVisitor:void 0;if(Lu(e,n))return void(null==s||s(e));null==r||r(e);const o=[ju(e)[Symbol.iterator]()];for(;o.length>0;){const e=null!==(i=o[o.length-1])&&void 0!==i?i:$l("Undefined node"),{value:t,done:a}=e.next();if(!0===a)o.pop();else{const[e,i]=t;Lu(i,n)?null==s||s(i):(null==r||r(i),o.push(ju(i)[Symbol.iterator]()))}}}function Lu(e,t){var n;return null!==(n=null==t?void 0:t(e))&&void 0!==n&&n}function Vu(e,t,n=Uu){if(e===t)return!0;if(!n(e,t))return!1;const i=Object.entries(e.traits),r=Object.entries(t.traits);if(i.length!==r.length)return!1;for(const[e,n]of i){const i=t.traits[e];if(n.length!==i.length)return!1;if(!sd(n,i,((e,t)=>"number"==typeof e||"number"==typeof t?e===t:Vu(e,t))))return!1}return!0}function Uu(e,t){return e===t||e.identifier===t.identifier&&e.definition===t.definition&&!!Cu(e.payload,t.payload)}function Hu(e,t){const{referenceSibling:n,referenceTrait:i}=t;return void 0===n&&void 0===i||void 0!==n&&void 0!==i?{result:Gu.Malformed}:void 0!==n?e.hasNode(n)?void 0===e.tryGetTraitLabel(n)?{result:Gu.SiblingIsRootOrDetached}:{result:Gu.Valid,side:t.side,referenceSibling:n}:{result:Gu.MissingSibling}:void 0===i?{result:Gu.MissingParent}:e.hasNode(i.parent)?{result:Gu.Valid,side:t.side,referenceTrait:i}:{result:Gu.MissingParent}}var Gu,$u,Ku,Wu,Ju,Qu,Xu;function Zu(e,t){var n,i;const{start:r,end:s}=t,o=Hu(e,r);if(o.result!==Gu.Valid)return{result:{kind:$u.BadPlace,place:r,placeFailure:o.result}};const a=Hu(e,s);if(a.result!==Gu.Valid)return{result:{kind:$u.BadPlace,place:s,placeFailure:a.result}};nt}(null!==(n=o.referenceTrait)&&void 0!==n?n:e.getTraitLocation(o.referenceSibling),null!==(i=a.referenceTrait)&&void 0!==i?i:e.getTraitLocation(a.referenceSibling)))return{result:$u.PlacesInDifferentTraits};const{start:c,end:l}=ru(e,{start:o,end:a});return e.findIndexWithinTrait(c)>e.findIndexWithinTrait(l)?{result:$u.Inverted}:{result:$u.Valid,start:o,end:a}}function Yu(e){const t={side:e.side};return Zl(e,t,"referenceSibling"),Zl(e,t,"referenceTrait")}}function th(e,t){var n;const i={definition:e.definition,identifier:null!==(n=e.identifier)&&void 0!==n?n:t.generateNodeId()};return Zl(e,i,"payload"),i}!function(e){e.Valid="Valid",e.Malformed="Malformed",e.SiblingIsRootOrDetached="SiblingIsRootOrDetached",e.MissingSibling="MissingSibling",e.MissingParent="MissingParent"}(Gu||(Gu={})),function(e){e.Valid="Valid",e.BadPlace="BadPlace",e.PlacesInDifferentTraits="PlacesInDifferentTraits",e.Inverted="Inverted"}($u||($u={}));class nh{constructor(e,t){this.open=!0,this.before=e,this.policy=t,this.state={view:e.openForTransaction(),status:a.Applied,changes:[],steps:[]}}get isOpen(){return this.open}get view(){return this.state.view}get status(){return this.state.status}get changes(){return this.state.changes}get steps(){return this.state.steps}get failure(){return this.state.failure}close(){if(Object(he.a)(this.open,1592),this.open=!1,this.state.status===a.Applied){const e=this.policy.validateOnClose(this.state);return td.isOk(e)?(e.result!==this.view&&(this.state=Object.assign(Object.assign({},this.state),{view:e.result})),{status:a.Applied,steps:this.steps,changes:this.changes,before:this.before,after:this.view.close()}):(this.state=Object.assign(Object.assign({},this.state),e.error),Object.assign(Object.assign({},e.error),{steps:this.steps,changes:this.changes,before:this.before}))}return{status:this.state.status,failure:this.state.failure,steps:this.steps,changes:this.changes,before:this.before}}applyChanges(e,t=[]){const n=e[Symbol.iterator](),i=n.next().value;let r=n.next();if(!0===r.done){for(const n of e)if(this.applyChange(n,t).status!==a.Applied)return this;return this}if(this.applyChange(i,t).status!==a.Applied)return this;const s={0:this.steps[this.steps.length-1],before:this.view,after:this.view,length:1},o=new Proxy(t,{get:(e,t)=>"length"===t?e.length+1:t===String(e.length)?s:e[t]});for(;!0!==r.done;){if(this.applyChange(r.value,o).status!==a.Applied)return this;s[s.length]=this.steps[this.steps.length-1],s.length+=1,s.after=this.view,r=n.next()}return this}applyChange(e,t=[]){Object(he.a)(this.open,1593),this.state.status!==a.Applied&&$l("Cannot apply change to an edit unless all previous changes have applied");const n=this.policy.tryResolveChange(this.state,e,t);if(td.isError(n))return this.state=Object.assign(Object.assign({},this.state),n.error),this;const i=n.result,r=this.policy.dispatchChange(this.state,i);return this.state=td.isOk(r)?{status:a.Applied,view:r.result,changes:this.changes.concat(e),steps:this.steps.concat({resolvedChange:i,after:r.result})}:Object.assign(Object.assign({},this.state),r.error),this}}!function(e){e.factt)};class t{constructor(){this.detached=new Map}tryResolveChange(e,t){return td.ok(t)}validateOnClose(e){return 0!==this.detached.size?td.error({status:a.Malformed,failure:{kind:n.UnusedDetachedSequence,sequenceId:this.detached.keys().next().value}}):td.ok(e.view)}dispatchChange(e,t){switch(t.type){case d.Build:return this.applyBuild(e,t);case d.Insert:return this.applyInsert(e,t);case d.Detach:return this.applyDetach(e,t);case d.Constraint:return this.applyConstraint(e,t);case d.SetValue:return this.applySetValue(e,t);default:return $l("Attempted to apply unsupported change")}}applyBuild(e,t){if(this.detached.has(t.destination))return td.error({status:a.Malformed,failure:{kind:n.DetachedSequenceIdAlreadyInUse,change:t,sequenceId:t.destination}});let i,r,s;const o=new Map,c=this.createViewNodesForTree(t.source,((t,n)=>o.has(t)?(r=t,!0):e.view.hasNode(n.identifier)?(i=t,!0):(o.set(t,n),!1)),(e=>{s=e}));if(void 0!==i)return td.error({status:a.Invalid,failure:{kind:n.IdAlreadyInUse,change:t,id:i}});if(void 0!==r)return td.error({status:a.Malformed,failure:{kind:n.DuplicateIdInBuild,change:t,id:r}});if(void 0!==s)return td.error({status:a.Malformed,failure:{kind:n.DetachedSequenceNotFound,change:t,sequenceId:s}});const l=e.view.addNodes(o.values());return this.detached.set(t.destination,null!=c?c:$l("Unhandled failure case in Transaction.createViewNodesForTree")),td.ok(l)}applyInsert(e,t){const i=this.detached.get(t.source);if(void 0===i)return td.error({status:a.Malformed,failure:{kind:n.DetachedSequenceNotFound,change:t,sequenceId:t.source}});const r=Hu(e.view,t.destination);if(r.result!==Gu.Valid)return td.error({status:r.result===Gu.Malformed?a.Malformed:a.Invalid,failure:{kind:n.BadPlace,change:t,place:t.destination,placeFailure:r.result}});this.detached.delete(t.source);const s=function(e,t,n){return e.attachRange(t,function(e,t){const{side:n}=t;return void 0===t.referenceSibling?(Gl(void 0!==t.referenceTrait),{trait:t.referenceTrait,side:n}):{trait:e.getTraitLocation(t.referenceSibling),side:t.side,sibling:t.referenceSibling}}(e,n))}(e.view,i,r);return td.ok(s)}applyDetach(e,t){const i=Zu(e.view,t.source);if(i.result!==$u.Valid)return td.error({status:i.result===$u.PlacesInDifferentTraits||i.result===$u.Inverted||i.result.placeFailure!==Gu.Malformed?a.Invalid:a.Malformed,failure:{kind:n.BadRange,change:t,range:t.source,rangeFailure:i.result}});cons))}(e.view,i);let s=r.view;const{detached:o}=r;if(void 0!==t.destination){if(this.detached.has(t.destination))return td.error({status:a.Malformed,failure:{kind:n.DetachedSequenceIdAlreadyInUse,change:t,sequenceId:t.destination}});this.detached.set(t.destination,o)}else s=s.deleteNodes(o);return td.ok(s)}applyConstraint(e,t){Object(he.a)(void 0===t.identityHash,1594),Object(he.a)(void 0===t.contentHash,1595);const r=Zu(e.view,t.toConstrain);if(r.result!==$u.Valid)return r.result!==$u.PlacesInDifferentTraits&&r.result!==$u.Inverted&&r.result.placeFailure!==Gu.Malformed?t.effect===u.ValidRetry?td.ok(e.view):td.error({status:a.Invalid,failure:{kind:n.ConstraintViolation,constraint:t,violation:{kind:i.BadRange,rangeFailure:r.result}}}):td.error({status:a.Malformed,failure:{kind:n.ConstraintViolation,constraint:t,violation:{kind:i.BadRange,rangeFailure:r.result}}});const{start:s,end:o}=ru(e.view,r),c=e.view.findIndexWithinTrait(s),l=e.view.findIndexWithinTrait(o);return void 0!==t.length&&t.length!==l-c?td.error({status:a.Invalid,failure:{kind:n.ConstraintViolation,constraint:t,violation:{kind:i.BadLength,actual:l-c}}}):void 0!==t.parentNode&&t.parentNode!==o.trait.parent?td.error({status:a.Invalid,failure:{kind:n.ConstraintViolation,constraint:t,violation:{kind:i.BadParent,actual:t.parentNode}}}):void 0!==t.label&&t.label!==o.trait.label?td.error({status:a.Invalid,failure:{kind:n.ConstraintViolation,constraint:t,violation:{kind:i.BadLabel,actual:o.trait.label}}}):td.ok(e.view)}applySetValue(e,t){if(!e.view.hasNode(t.nodeToModify))return td.error({status:a.Invalid,failure:{kind:n.UnknownId,change:t,id:t.nodeToModify}});const i=e.view.setNodeValue(t.nodeToModify,t.payload);return td.ok(i)}createViewNodesForTree(e,t,n){const i=[],r=[];for(const t of e)if(cd(t)){const e=this.getDetachedNodeIds(t,n);if(void 0===e)return;i.push(...e)}else r.push(t),i.push(t.identifier);for(;r.length>0;){const e=r.pop();Gl(void 0!==e&&!cd(e));const i=new Map;for(const t in e.traits)if(Object.prototype.hasOwnProperty.call(e.traits,t)){const s=e.traits[t];if(s.length>0){const e=[];for(const t of s)if(cd(t)){const i=this.getDetachedNodeIds(t,n);if(void 0===i)return;e.push(...i)}else e.push(t.identifier),r.push(t);i.set(t,e)}}const s={identifier:e.identifier,definition:e.definition,traits:i};if(Zl(e,s,"payload"),t(e.identifier,s))return}return i}getDetachedNodeIds(e,t){const n=this.detached.get(e);if(void 0!==n)return this.detached.delete(e),n;t(e)}}let n,i;e.Policn"}(n=e.FailureKind||(e.FailureKind={})),function(e){e.BadRange="BadRange",e.BadLength="BadLength",e.BadParent="BadParent",e.BadLabel="BadLabel"}(i=e.ConstraintViolationKind||(e.ConstraintViolationKind={}))}(Ku||(Ku={})),function(e){e.RevisionRetained="revisionRetained"}(Wu||(Wu={}));class ih extends me.a{constructor(e,t,n,i=Xl,r=Xl,s=0){super(),this.localRevisionCache=new eu.a,this.unappliedSelfEdits=new eu.a,this.log=e,void 0!==n&&(Object(he.a)(Number.isInteger(n[0]),1576),Object(he.a)(this.log.isSequencedRevision(n[0]),1577)),this.sequencedRevisionCache=new iu(ih.sequencedCacheSizeMax,s,null!=n?n:[0,{view:t}]),this.processEditStatus=null!=i?i:Xl,this.processSequencedEditResult=null!=r?r:Xl,this.detachFromEditLog=this.log.registerEditAddedHandler(this.handleEditAdded.bind(this)),this.log.registerEditEvictionHandler(this.evictCachedRevisions.bind(this))}highestRevisionCached(){return void 0!==this.highestRevisionCacheEntry}handleEditAdded(e,t,n){if(this.highestRevisionCacheEntry=void 0,t)this.unappliedSelfEdits.push(e.id);else if(n){const t=this.localRevisionCache.shift();if(void 0!==t){const n=this.log.numberOfSequencedEdits,{view:i}=t;this.sequencedRevisionCache.cacheValue(n,t.status===a.Applied?{view:i,status:t.status,steps:t.steps}:{view:i,status:t.status,failure:t.failure}),this.handleSequencedEditResult(e,t,[])}}else this.localRevisionCache.clear()}getRevisionViewInMemory(e){return this.getEditResultInMemory(e).view}getEditResultInMemory(e){var t;Object(he.a)(e>=this.log.earliestAvailableEditIndex,1578);const n=this.getStartingPoint(e),{startRevision:i}=n;let r=n;for(let n=i;n<e&&n<this.log.length;n++){const e=null!==(t=this.log.tryGetEditAtIndex(n))&&void 0!==t?t:$l("edit not found");r=this.applyEdit(r.view,e,n)}return r}setMinimumSequenceNumber(e){this.sequencedRevisionCache.updateRetentionWindowt}}evictCachedRevisions(e){const t=this.log.earliestAvailableEditIndex+e,n=this.getEditResultInMemory(t);this.sequencedRevisionCache.cacheRetainedValue(t,n),this.emit(Wu.RevisionRetained,t)}getStartingPoint(e){var t,n,i;const r=Math.min(e,this.log.length);if(r===this.log.length&&void 0!==this.highestRevisionCacheEntry)return Object.assign(Object.assign({},this.highestRevisionCacheEntry),{startRevision:r});let s,o;const{numberOfSequencedEdits:a}=this.log;if(r>a&&!this.localRevisionCache.isEmpty()){const{length:e}=this.localRevisionCache,i=r-1-a;if(i<e){const e=null!==(t=this.localRevisionCache.peekAt(i))&&void 0!==t?t:$l("missing tail of localRevisionViewCache");return Object.assign(Object.assign({},e),{startRevision:r})}s=null!==(n=this.localRevisionCache.peekAt(e-1))&&void 0!==n?n:$l("missing tail of localRevisionViewCache"),o=a+e}else{const[e,t]=null!==(i=this.sequencedRevisionCache.getClosestEntry(r))&&void 0!==i?i:$l("No preceding revision view cached.");o=e,s=t}return Object.assign({startRevision:o},s)}applyEdit(e,t,n){let i,r,s=[];void 0!==this.cachedEditResult&&this.cachedEditResult.editId===t.id&&this.cachedEditResult.result.before===e?(i=this.cachedEditResult.result,r=!0):(s=this.reconciliationPathFromEdit(t.id),i=Ku.factory(e).applyChanges(t.changes,s).close(),r=!1);const o=n+1,c=i.status===a.Applied?i.after:e,l=i.status===a.Applied?{view:c,status:i.status,steps:i.steps}:{view:c,status:i.status,failure:i.failure};return this.log.isSequencedRevision(o)?(this.sequencedRevisionCache.cacheValue(o,l),this.handleSequencedEditResult(t,l,s)):(Object(he.a)(o===this.log.numberOfSequencedEdits+this.localRevisionCache.length+1,1579),this.localRevisionCache.push(l)),o>=this.log.length&&(this.highestRevisionCacheEntry=l),this.processEditStatus(i.status,this.log.getIdAtIndex(n),r),l}handleSequencedEditResult(e,t,n){let i=!1;this.unappliedSelfEdits.length>0&&e.id===this.unappliedSelfEdits.peekFront()&&(i=!0,this.unappliedSelfEdits.shift()),this.processSequencedEditResult({edit:e,wasLocal:i,result:t,reconciliationPath:n})}reconciliationPathFromEdit(e){const t=[];let n=!1;return new Proxy(t,{get:(i,r)=>{if(!n){n=!0;const i=this.log.getOrderedEditId(e);if(!1===i.isLocal&&void 0!==i.sequenceInfo){const n=this.earliestSequencedEditInMemory();if(void 0!==n){const r=Math.max(n.sequenceNumber,i.sequenceInfo.referenceSequenceNumber);if(r<i.sequenceInfo.sequenceNumber){const n=this.getEditResultFromSequenceNumber(r);if(void 0!==n){if(n.status===a.Applied){const e=this.log.getOrderedEditId(n.id);void 0!==e.sequenceInfo&&e.sequenceInfo.sequenceNumber>i.sequenceInfo.referenceSequenceNumber&&t.push(Object.assign(Object.assign({},n.steps),{before:n.before,after:n.view,length:n.steps.length}))}const r=this.log.getIndexOfId(n.id)+1,s=this.log.getIndexOfId(e)-1;for(let e=r;e<=s;++e){const n=this.getEditResultFromIndex(e);n.status===a.Applied&&t.push(Object.assign(Object.assign({},n.steps),{before:n.before,after:n.view,length:n.steps.length}))}}}}}}return i[r]}})}earliestSequencedEditInMemory(){const e=this.log.earliestAvailableEditIndex,t=this.log.numberOfSequencedEdits+e-1;for(let n=e;n<=t;++n){const e=this.log.tryGetEditAtIndex(n);if(void 0!==e){const t=this.log.getOrderedEditId(e.id);if(void 0!==t.sequenceInfo)return{edit:e,sequenceNumber:t.sequenceInfo.sequenceNumber}}}}getEditResultFromIndex(e){var t;const n=null!==(t=this.log.tryGetEditAtIndex(e))&&void 0!==t?t:$l("edit does not exist in memory"),i=this.getRevisionViewInMemory(e),r=this.getEditResultInMemory(e+1);return void 0===r.status&&$l("The status of every edit in memory should be known"),r.status===a.Applied?{id:n.id,status:a.Applied,before:i,changes:n.changes,view:r.view,steps:r.steps}:{id:n.id,status:r.status,failure:r.failure,before:i,view:r.view,changes:n.changes}}getEditResultFromSequenceNumber(e){const t=this.earliestSequencedEditInMemory();if(void 0!==t&&e>=t.sequenceNumber){const n=this.log.getIndexOfId(t.edit.id);for(let t=this.log.numberOfSequencedEdits-1;t>=n;--t){const n=this.log.tryGetEditAtIndex(t);if(void 0!==n){const i=this.log.getOrderedEditId(n.id);if(i.sequenceInfo&&i.sequenceInfo.sequenceNumber<=e){const e=this.getRevisionViewInMemory(t),i=this.getEditResultInMemory(t+1);return void 0===i.status&&$l("The status of every edit in session should be known"),i.status===a.Applied?{id:n.id,status:a.Applied,before:e,changes:n.changes,view:i.view,steps:i.steps}:{id:n.id,status:i.status,failure:i.failure,before:e,view:i.view,changes:n.changes}}}}}}async getEditResult(e){return this.getEditResultInMemory(e)}async getRevisionView(e){return this.getEditResultInMemory(e).view}getEditResultInSession(e){return this.getEditResultInMemoryew}}ih.sequencedCacheSizeMax=50,function(e){e.EditCommitted="committedEdit",e.SequencedEditApplied="sequencedEditApplied"}(Ju||(Ju={})),function(e){e.CatchUpBlobUploaded="uploadedCatchUpBlob",e.EditChunkUploaded="uploadedEditChunk",e.AppliedEdit="appliedEdit",e.DroppedInvalidEdit="droppedInvalidEdit",e.DroppedMalformedEdit="droppedMalformedEdit",e.UnexpectedHistoryChunk="unexpectedHistoryChunk",e.WriteVersionChanged="writeVersionChanged"}(Qu||(Qu={}));class rh{constructor(e=[]){this.stringToInternedIdMap=new Map,this.internedStrings=[];for(const t of e)this.getOrCreateInternedId(t)}getOrCreateInternedId(e){var t;return null!==(t=this.getInternedId(e))&&void 0!==t?t:this.createNewId(e)}getInternedId(e){return this.stringToInternedIdMap.get(e)}getString(e){var t;return null!==(t=this.internedStrings[e])&&void 0!==t?t:$l(`No string associated with ${e}.`)}getSerializable(){return this.internedStrings}createNewId(e){const t=this.stringToInternedIdMap.size;return this.stringToInternedIdMap.set(e,t),this.internedStrings.push(e),t}}class sh{compress(e,t,n){return this.previousId=void 0,this.compressI(e,t,n)}compressI(e,t,n){var i,r;if(cd(e))return e;const s=null!==(i=t.getInternedId(e.definition))&&void 0!==i?i:e.definition,o=n.normalizeToOpSpace(e.identifier),a=function(e,t){return void 0!==e&&(e<0?t===e-1:t===e+1)}(this.previousId,o)?void 0:o;this.previousId=o;const c=[],l=Object.entries(e.traits).sort();if(l.length>0||void 0!==e.payload)for(const[e,i]of l)c.push(null!==(r=t.getInternedId(e))&&void 0!==r?r:e,i.map((e=>this.compressI(e,t,n))));const d=void 0!==e.payload?[e.payload,...c]:c;return d.length>0?void 0!==a?[s,a,d]:[s,d]:void 0!==a?[s,a]:[s]}decompress(e,t,n){if(cd(e))return e;const i=e[1];return Object(he.a)("number"==typeof i,1596),this.previousId=i,this.decompressI(e,t,n)}decompressI(e,t,n){var i;if(cd(e))return e;let r,s,o;const[a,c,l]=e;void 0!==c&&("number"==typeof c?(r=c,void 0!==l&&(s=l)):s=c);const d="string"==typeof a?a:t.getString(a);let u;if(void 0!==r)u=r;else{const e=null!==(i=this.previousId)&&void 0!==i?i:$l();u=e<0?e-1:e+1}this.previousId=u;const h={};if(void 0!==s){let e;s.length%2==1?(e=1,o=s[0]):e=0;const i=s.length-e;for(let r=0;r<i;r+=2){const i=r+e,o=s[i],a=s[i+1].map((e=>this.decompressI(e,t,n)));h["string"==typeof o?o:t.getString(o)]=a}}const m={identifier:n.normalizeToSessionSpace(u),definition:d,traits:h};return void 0!==o&&(m.payload=o),m}}function oh(e,t){const n=e.changes.map((e=>{switch(e.type){case d.Build:return{type:d.Build,destination:e.destination,source:e.source.map((e=>zu(e,(e=>ah(e,t)),cd)))};case d.Insert:return{type:d.Insert,source:e.source,destination:lh(e.destination,t)};case d.Detach:{const n={type:d.Detach,source:ch(e.source,t)};return Zl(e,n,"destination"),n}case d.SetValue:return{type:d.SetValue,nodeToModify:t(e.nodeToModify),payload:e.payload};case d.Constraint:{const n={type:d.Constraint,effect:e.effect,toConstrain:ch(e.toConstrain,t)};return Zl(e,n,"identityHash"),Zl(e,n,"label"),Zl(e,n,"length"),Zl(e,n,"contentHash"),void 0!==e.parentNode&&(n.parentNode=t(e.parentNode)),n}default:$l("Unknown change type.")}})),i={id:e.id,changes:n};return Zl(e,i,"pastAttemptCount"),i}function ah(e,t){const n=t(e.identifier),i={definition:e.definition,identifier:n};return Zl(e,i,"payload"),i}function ch(e,t){return{start:lh(e.start,t),end:lh(e.end,t)}}function lh({side:e,referenceSibling:t,referenceTrait:n},i){const r={side:e};if(void 0!==t){const e=i(t);r.referenceSibling=e}if(void 0!==n){const e=i(n.parent);r.referenceTrait={label:n.label,parent:e}}return r}class dh{constructor(e){this.treeCompressor=e}compress(e,t,n){if(e.type===d.Build){const i=[];for(const r of e.source)i.push(this.treeCompressor.compress(r,t,n));return{destination:e.destination,source:i,type:d.CompressedBuild}}return uh(e,(e=>n.normalizeToOpSpace(e)))}decompress(e,t,n){if(e.type===d.CompressedBuild){const i=[];for(const r of e.source)i.push(this.treeCompressor.decompress(r,t,n));return{destination:e.destination,source:i,type:d.Build}}return uh(e,(e=>n.normalizeToSessionSpace(e)))}}function uh(e,t){switch(e.type){case d.Insert:return{source:e.source,destination:lh(e.destination,t),type:d.Insert};case d.Detach:{const n={source:ch(e.source,t),type:d.Detach};return Zl(e,n,"destination"),n}case d.SetValue:return{nodeToModify:t(e.nodeToModify),payload:e.payload,type:d.SetValue};case d.Constraint:{const n={effect:e.effect,toConstrain:ch(e.toConstrain,t),type:d.Constraint};return Zl(e,n,"contentHash"),Zl(e,n,"identityHash"),Zl(e,n,"label"),Zl(e,n,"length"),void 0!==e.parentNode&&(n.parentNode=t(e.parentNode)),n}default:$l("unexpected change type")}}function hh(e,t,n,i){return Object.assign(Object.assign({},i),{changes:i.changes.map((i=>e.compress(i,t,n)))})}function mh(e,t,n,i){return Object.assign(Object.assign({},i),{changes:i.changes.m,n)))})}classr)}encodeEditOp(e,t,n,i,r){const s=t(hh(this.changeCompressor,r,lu(i,n.sessionId),e));return{type:c.Edit,edit:s,version:l.v0_1_1,idRange:n}}decodeEditOp(e,t,n,i){const{edit:r}=e,s=t(r);return mh(this.changeCompressor,i,lu(n,e.idRange.sessionId),s)}encodeSummary(e,t,n,i,r,s){return this.summarizeHistory?this.fullHistorySummarizer(e,t,i,r,s):this.noHistorySummarizer(e,t,n,i,r,s)}decodeSummary({editHistory:e,currentTree:t,internedStrings:n,idCompressor:i,version:r},s){Gl(r===l.v0_1_1,`Invalid summary version to decode: ${r}, expected: 0.1.1`),Object(he.a)("object"==typeof e,1587);const o=Wd(i)?$d.deserialize(i):$d.deserialize(i,Nd(),s),a=new rh(n),c=du(uu(o)),d=void 0!==t?this.treeCompressor.decompress(t,a,c):void 0,{editChunks:u,editIds:h}=e;return Gl(void 0!==u,"Missing editChunks on 0.1.1 summary."),Object(he.a)(void 0!==h,1588),{currentTree:d,editHistory:{editIds:h,editChunks:u.map((({startRevision:e,chunk:t})=>({startRevision:e,chunk:fh(t)?{get:async()=>{const e=t,n=JSON.parse(yn.a.from(await e.get()).toString());return this.decodeEditChunk(n,c,a)},baseHandle:t}:t.map((e=>mh(this.changeCompressor,a,c,e)))})))},idCompressor:o,interner:a}}noHistorySummarizer(e,t,n,i,r,s){const a=_u(t),c=n.convertToNodeId(Xd.identifier),d=[];Object.entries(a.traits).forEach((([e,t])=>{d.push(ou.build(t,0),ou.inserte}))({parent:c,label:e})))})),void 0!==a.payload&&d.push(ou.setPayload(c,a.payload)),Object(he.a)(a.identifier===c&&a.definition===Xd.definition,1589);const u=Fu(d);return{editHistory:{editChunks:[{startRevision:0,chunk:[{changes:u.changes.map((e=>this.changeCompressor.compress(e,r,du(i))))}]}],editIds:[u.id]},version:l.v0_1_1,internedStrings:r.getSerializable(),idCompressor:s}}fullHistorySummarizer(e,t,n,i,r){const s=du(n);return{currentTree:this.treeCompressor.compress(_u(t),i,s),editHistory:e.getEditLogSummary((e=>hh(this.changeCompressor,i,s,e))),version:l.v0_1_1,internedStrings:i.getSerializable(),idCompressor:r}}encodeEditChunk(e,t,n){const i=e.map((e=>hh(this.changeCompressor,n,t,e)));return{version:l.v0_1_1,edits:i}}decodeEditChunk(e,t,n){return Gl(e.version===l.v0_1_1,`Invalid editChunk to decode: ${e.version}. Expected 0.1.1.`),e.edits.map((e=>mh(this.changeCompressor,n,t,e)))}}class ph{constructor(e){this.summarizeHistory=e}encodeEditOp(e,t,n){const i=t(oh(e,(e=>n.convertToStableNodeId(e))));return{type:c.Edit,edit:i,version:l.v0_0_2}}decodeEditOp(e,t,n){const{edit:i}=e;return oh(t(i),(e=>n.generateNodeId(e)))}encodeSummary(e,t,n){return this.summarizeHistory?this.fullHistorySummarizer(e,t,n):this.noHistorySummarizer(e,t,n)}decodeSummary({currentTree:e,sequencedEdits:t},n){Object(he.a)(void 0!==t,1590);const i=new $d(Nd(),10,n),r=uu(i),s=e=>r.generateNodeId(e),o=new ad;return t.forEach((e=>o.addSequencedEdit(oh(e,s),{sequenceNumber:1,referenceSequenceNumber:0}))),{currentTree:zu(e,(e=>ah(e,s))),idCompressor:i,interner:new rh,editHistory:o.getEditLogSummary()}}noHistorySummarizer(e,t,n){const i=xu(t,n),r=[];Object.entries(i.traits).forEach((([e,t])=>{r.push({type:d.Build,source:t,destination:0},{type:d.Insert,source:0,destination:{side:o.After,referenceTrait:{label:e,parent:Xd.identifier}}})})),void 0!==i.payload&&r.push({type:d.SetValue,nodeToModify:Xd.identifier,payload:i.payload}),Object(he.a)(i.identifier===Xd.identifier&&i.definition===Xd.definition,1591);const s=Fu(r);return{currentTree:i,sequencedEdits:[{id:s.id,changes:s.changes}],version:l.v0_0_2}}fullHistorySummarizer(e,t,n){const{editChunks:i,editIds:r}=e.getEditLogSummary(),s=[];let o=0;return i.forEach((({chunk:e})=>{fh(e)?$l("Cannot write handles to summary version 0.0.2"):e.forEach((({changes:e})=>{var t;s.push(oh({changes:e,id:null!==(t=r[o++])&&void 0!==t?t:$l("Number of edits should match number of edit IDs.")},(e=>n.convertToStableNodeId(e))))}))})),{currentTree:xu(t,n),sequencedEdits:s,version:l.v0_0_e)}function vh(e,t,n=!1){return ou.detach({start:{referenceSibling:t[0],side:o.Before},end:{referenceSibling:t[t.length-1],side:o.After}},n?e.source:void 0)}function yh(e,t){const n=Zu(t,e.source);if(n.result!==$u.Valid)return;const{start:i,end:r}=ru(t,n),{trait:s}=i,a=t.getTrait(s),c=t.findIndexWithinTrait(i),l=t.findIndexWithinTrait(r),d=a.slice(c,l),u=a.slice(0,c);let h;if(i.side===o.After)h=void 0===i.sibling?{side:o.After,referenceTrait:s}:{side:o.After,referenceSibling:i.sibling};else if(r.side===o.Before)h=void 0===r.sibling?{side:o.Before,referenceTrait:s}:{side:o.Before,referenceSibling:r.sibling};else{const e=u.pop();h={side:o.After,referenceSibling:e,referenceTrait:void 0===e?s:void 0}}return void 0!==e.destination?{invertedDetach:[ou.insert(e.destination,h)],detachedNodeIds:d}:{invertedDetach:[ou.build(d.map((e=>Mu(t,e))),0),ou.insert(0,h)],detachedNodeIds:d}}function bh(e,t){const{nodeToModify:n}=e,i=t.tryGetViewNode(n);if(void 0!==i)return null!==i.payload?[ou.setPayload(n,i.payload)]:[ou.clearPayload(n)]}!function(e){e.MalformedEdit="malformedEdit",e.MissingNodes="missingNodes"}(Xu||(Xu={}));class=e}get type(){return Sh.Type}get attributes(){return Sh.Attributes}async load(e,t,n,i){const r=this.createSharedTree(e,t);return await r.load(n),r}create(e,t){const n=this.createSharedTree(e,t);return n.initializeLocal(),n}createSharedTree(e,t){const[n]=this.args;switch(n){case l.v0_0_2:case l.v0_1_1:return new Oh(e,t,...this.args);default:$l("Unknown write format")}}}Sh.Type="SharedTree",Sh.Attributes={type:Sh.Type,snapshotFormatVersion:"0.1",packageVersion:"0.1"};const Ch=[l.v0_0_2,l.v0_1_1],wh={all:{isSharedTreeEvent:!0}};class Oh extends ql{constructor(e,t,n,i={}){super(t,e,Sh.Attributes,"fluid_sharedTree_"),this.writeFormat=n,this.idNormalizer={tree:this,get localSessionId(){return this.tree.idCompressor.localSessionId},normalizeToOpSpace:e=>this.idCompressor.normalizeToOpSpace(e),normalizeToSessionSp,t)},this.interner=new rh([Xd.definition]),this.processEditResult=(e,t)=>{this.emit(Oh.eventFromEditResult(e),t)},this.processSequencedEditResult=({edit:e,wasLocal:t,result:n,reconciliationPath:i})=>{this.emit(Ju.SequencedEditApplied,{edit:e,wasLocal:t,tree:this,logger:this.sequencedEditAppliedLogger,reconciliationPath:i,outcome:n})};const r=this.getHistoryPolicy(i);this.summarizeHistory=r.summarizeHistory,this.logger=Ol.create(e.logger,"SharedTree",wh),this.sequencedEditAppliedLogger=Ol.create(this.logger,"SequencedEditApplied",wh);const s=i.attributionId;this.idCompressor=new $d(Nd(),10,s,function(e,t){return Math.random()<.05?e:new Tl}(this.logger)),this.editLogSize=i.inMemoryHistorySize,this.editEvictionFrequency=i.inMemoryHistorySize;const{editLog:o,cachingLogViewer:a}=this.initializeNewEditLogFromSummary({editChunks:[],editIds:[]},void 0,this.idCompressor,this.processEditResult,this.processSequencedEditResult,l.v0_1_1);this.editLog=o,this.cachingLogViewer=a,this.encoder_0_0_2=new ph(this.summarizeHistory),this.encoder_0_1_1=new gh(this.summarizeHistory)}static create(e,t){return e.createChannel(t,Sh.Type)}static getFactory(...e){const[t,n]=e;return new Sh(null!=t?t:l.v0_1_1,n)}get attributionId(){switch(this.writeFormat){case l.v0_0_2:return hd;default:{const{attributionId:e}=this.idCompressor;return e===au?hd:e}}}get logViewer(){return this.cachingLogViewer}getHistoryPolicy(e){var t;return"object"==typeof e.summarizeHistory?{summarizeHistory:!0}:{summarizeHistory:null!==(t=e.summarizeHistory)&&void 0!==t&&t}}getWriteFormat(){return this.writeFormat}computeIsOldest(){if(this.runtime.attachState===Vc.Detached)return!0;if(!this.runtime.connected)return!1;Object(he.a)(void 0!==this.runtime.clientId,1581);const e=this.runtime.getQuorum(),t=e.getMember(this.runtime.clientId);if(void 0===t)return!1;const n=e.getMembers();for(const e of n.values())if(e.sequenceNumber<t.sequenceNumber)return!1;returY)}generateNodeId(e){return this.idCompressor.generateCompressedId(e)}convertToStableNodeId(e){var t;return null!==(t=this.idCompressor.tryDecompress(e))&&void 0!==t?t:$l("Node id is not known to this SharedTree")}tryConvertToStableNodeId(e){return this.idCompressor.tryDecompress(e)}convertToNodeId(e){var t;return null!==(t=this.idCompressor.tryRecompress(e))&&void 0!==t?t:$l("Stable node id is not known to this SharedTree")}tryConvertToNodeId(e){return this.idCompressor.tryRecompress(e)}attributeNodeId(e){switch(this.writeFormat){case l.v0_0_2:return hd;default:{const t=this.idCompressor.attributeId(e);return t===au?hd:t}}}get edits(){return this.editLog}summarizeCore(e){return function(e,t){const n=new Bl;return n.addBlob("header",t),n.getSummaryTree()}(0,this.saveSerializedSummary({serializer:e}))}saveSerializedSummary(e){const{serializer:t}=null!=e?e:{};return function(e,t,n){var i;return null!==(i=function(e,t,n){return void 0!==e?t.stringify(e,n):e}(e,t,n))&&void 0!==i?i:$l()}(this.saveSummary(),null!=t?t:this.serializer,this.handle)}loadSerializedSummary(e){const t=function(e,t){let n;try{n=t.parse(e)}catch(e){$l("Json syntax error in Summary")}"object"!=typeof n&&$l("Summary is not an object");const{version:i}=n;if(void 0!==i)return Object.assign({version:i},n);$l("Missing fields on summary")}(e,this.serializer);return this.loadSummary(t),function(e){const{version:t}=e;if(t===l.v0_1_1){const{editHistory:n}=e;if(void 0!==n){"object"!=typeof n&&$l("Edit history is not an object");const{editChunks:e,editIds:i}=n;if(void 0!==e&&void 0!==i)return{formatVersion:t,historySize:i.length,totalNumberOfChunks:e.length,uploadedChunks:od(n)};$l("Missing fields on edit log summary")}}else{if(t===l.v0_0_2){const{sequencedEdits:n}=e;return{formatVersion:t,historySize:n.length}}$l("Format version is not supported")}$l("Missing fields on summary")}(t)}saveSummary(){if(this.editLog.numberOfLocalEdits>0){if(Object(he.a)(this.runtime.attachState!==Vc.Attached,1582),this.writeFormat===l.v0_1_1){this.idCompressor.finalizeCreationRange(this.idCompressor.takeNextCreationRange());for(const e of this.editLog.getLocalEdits())this.internStringsFromEdit(e)}this.editLog.sequenceLocalEdits()}return Object(he.a)(0===this.editLog.numberOfLocalEdits,1583),this.generateSummary()}generateSummary(){var e;try{switch(this.writeFormat){case l.v0_0_2:return this.encoder_0_0_2.encodeSummary(this.editLog,this.currentView,this);case l.v0_1_1:return this.encoder_0_1_1.encodeSummary(this.editLog,this.currentView,this,this.idNormalizer,this.interner,this.idCompressor.serialize(!1));default:$l("Unknown version")}}catch(t){throw null===(e=this.logger)||void 0===e||e.sendErrorEvent({eventName:"UnsupportedSummaryWriteFormat",formatVersion:this.writeFormat}),t}}loadSummary(e){const{version:t}=e;let n;switch(Nh(t,this.writeFormat)&&(this.submitOp({type:c.Update,version:this.writeFormat}),this.logger.sendTelemetryEvent({eventName:"RequestVersionUpdate",versionFrom:t,versionTo:this.writeFormat})),0!==Ih(t,this.writeFormat)&&this.changeWriteFormat(t),Object(he.a)(!0===this.idCompressor.getAllIdsFromLocalSession().next().done,1584),t){case l.v0_0_2:n=this.encoder_0_0_2.decodeSummary(e,this.attributionId);break;case l.v0_1_1:{const t=void 0!==e.currentTree;t!==this.summarizeHistory&&(this.summarizeHistory=t,this.encoder_0_1_1=new gh(this.summarizeHistory)),n=this.encoder_0_1_1.decodeSummary(e,this.attributionId);break}default:$l("Unknown version")}const{editHistory:i,currentTree:r,idCompressor:s,interner:o}=n;if(this.interner=o,this.interner.getOrCreateInternedId(Xd.definition),Ih(t,l.v0_1_1)<0){const{editIds:e,editChunks:t}=i;this.logger.sendTelemetryEvent({eventName:"SummaryConversion",formatVersion:l.v0_1_1,historySize:e.length,totalNumberOfChunks:t.length})}this.initializeNewEditLogFromSummary(i,r,s,this.processEditResult,this.processSequencedEditResult,e.version)}static eventFromEditRet}}initializeNewEditLogFromSummary(e,t,n,i,r,s){var o,a;this.idCompressor=n,null===(o=this.cachingLogViewer)||void 0===o||o.detachFromEditLog();const c=new ad(e,this.logger,null===(a=this.editLog)||void 0===a?void 0:a.editAddedHandlers,this.editLogSize,this.editEvictionFrequency);let l;if(c.on(Qu.UnexpectedHistoryChuk)})),void 0!==t){const e=Tu.fromTree(t);l=[c.length,{view:e}]}const d=new ih(c,Tu.fromTree(Xd,this),l,i,r,0);return this.editLog=c,this.cachingLogViewer=d,{editLog:c,cachingLogViewer:d}}equals(e){return!!function(e,t,n,i){return!!Vu(xu(e,t),xu(n,i))}(this.currentView,this,e.currentView,e)&&this.editLog.equals(e.editLog)}async loadCore(e){const t=Il.start(this.logger,{eventName:"SummaryLoad"});try{const n=await e.readBlob("header"),i=Object(yn.c)(n,"utf8"),r=this.loadSerializedSummary(i);t.end(r)}catch(e){throw t.cancel({eventName:"SummaryLoadFailure"},e),e}}processCore(e,t){const n=e;this.cachingLogViewer.setMinimumSequenceNumber(n.minimumSequenceNumber);const i=n.contents;void 0===i.version&&(i.version=l.v0_0_2);const{type:r,version:s}=i;if(s===this.writeFormat){if(r===c.Handle)this.logger.sendErrorEvent({eventName:"UnexpectedHistoryChunk"});else if(r===c.Edit){i.version===l.v0_1_1&&this.idCompressor.finalizeCreationRange(i.idRange);const e=this.parseSequencedEdit(i);i.version===l.v0_1_1&&this.internStringsFromEdit(e),this.processSequencedEdit(e,n)}}else if(r===c.Update)this.processVersionUpdate(i.version);else if(1===Ih(s,this.writeFormat)){const e="Newer op version received by a client that has yet to be updated.";this.logger.sendErrorEvent({eventName:"UnexpectedNewerOpVersion"},e),$l(e)}}registerCore(){}onDisconnect(){}parseSequencedEdit(e){switch(e.version){case l.v0_0_2:return this.encoder_0_0_2.decodeEditOp(e,this.encodeSemiSerializedEdit.bind(this),this);case l.v0_1_1:return this.encoder_0_1_1.decodeEditOp(e,this.encodeSemiSerializedEdit.bind(this),this.idNormalizer,this.interner);default:$l("Unknown op version))}processSequencedEdit(e,t){const{id:n}=e,i=this.editLog.isLocalEdit(n);void 0!==this.editLog.tryGetIndexOfId(n)&&!i||(i?this.editLog.addSequencedEdit(e,t):this.applyEditLocally(e,t))}processVersionUpdate(e){Nh(this.writeFormat,e)&&Il.timedExec(this.logger,{eventName:"VersionUpdate",version:e},(()=>{if(!(Ih(e,l.v0_1_1)>=0))throw new Error(`Updating to version ${e} is not supported.`);this.upgradeFrom_0_0_2_to_0_1_1(),this.changeWriteFormat(e);for(const e of this.editLog.getLocalEdits())this.submitEditOp(e)}),{end:!0,cancel:"error"})}upgradeFrom_0_0_2_to_0_1_1(){var e;this.interner=new rh([Xd.definition]);const t=this.idCompressor,n=new $d(Nd(),10,this.attributionId,this.logger),i=uu(n);for(const e of t.getAllIdsFromLocalSession())n.generateCompressedId(t.decompress(e));const r=e=>{var t;for(let n=0;n<this.editLog.numberOfSequencedEdits;n++)oh(null!==(t=this.editLog.tryGetEditAtIndex(n))&&void 0!==t?t:$l("edit not foundt))))},s=new $d(au,10),o=uu(s);if(this.summarizeHistory){r(o);for(let t=0;t<this.editLog.numberOfSequencedEdits;t++)this.internStringsFromEdit(null!==(e=this.editLog.tryGetEditAtIndex(t))&&void 0!==e?e:$l("edit not found"))}else{for(const e of this.logViewer.getRevisionViewInMemory(this.editLog.numberOfSequencedEdits)){o.generateNodeId(this.convertToStableNodeId(e.identifier)),this.interner.getOrCreateInternedId(e.definition);for(const t of[...e.traits.keys()].sort())this.interner.getOrCreateInternedId(t)}r(i)}n.finalizeCreationRange(s.takeNextCreationRange()),this.idCompressor=n}applyEdit(...e){const t=nd(e),n={id:qu(),changes:t.map((e=>this.internalizeChange(e)))};return this.submitEditOp(n),this.applyEditLocally(n,void 0),n}mergeEditsFrom(e,t,n){const i=t=>{var i;const r=e.convertToStableNodeId(t),s=null!==(i=null==n?void 0:n(r))&&void 0!==i?i:r;return this.generateNodeId(s)};return Array.from(t,(e=>this.applyEditInternal(oh(e,(e=>i(e)))).id))}applyEditInternal(e){let t;return t=Array.isArray(e)?{id:qu(),changes:e}:e,this.submitEditOp(t),this.applyEditLocally(t,void 0),t}internalizeChange(e){switch(e.type){case mu.Insert:return{source:e.source,destination:Yu(e.destination),type:d.Insert};case mu.Detach:{const t={source:eh(e.source),type:d.Detach};return Zl(e,t,"destination"),t}case mu.Build:return function(e){return Array.isArray(e)}(e.source)?{source:e.source.map((e=>zu(e,(e=>th(e,this)),(e=>"number"==typeof e)))),destination:e.destination,type:d.Build}:{source:[zu(e.sourisf e))],destination:e.destination,type:d.Build};case mu.SetValue:return{nodeToModify:e.nodeToModify,payload:e.payload,type:d.SetValue};case mu.Constraint:{const t={effect:e.effect,toConstrain:e.toConstrain,type:d.Constraint};return Zl(e,t,"contentHash"),Zl(e,t,"identityHash"),Zl(e,t,"label"),Zl(e,t,"length"),Zl(e,t,"parentNode"),t}default:$l("unexpected change type")}}applyEditLocally(e,t){const n=void 0!==t;n?this.editLog.addSequencedEdit(e,t):this.editLog.addLocalEdit(e),this.emit(Ju.EditCommitted,{editId:e.id,local:!n,tree:this})}revert(e){var t;const n=this.edits.getIndexOfId(e),i=null!==(t=this.edits.tryGetEditAtIndex(n))&&void 0!==t?t:$l("edit not found"),r=this.logViewer.getRevisionViewInMemory(n),s=this.revertChanges(i.changes,r);if(void 0!==s)return this.applyEditInternal(s).id}revertChanges(e,t){return function(e,t,n,i){const r=[],s=new Map,o=new Map,c=Ku.factory(t);for(const t of e){switch(t.type){case d.Build:{const{destination:e,source:n}=t;Object(he.a)(!s.has(e),1574),Object(he.a)(!o.has(e),1575),s.set(e,n.reduce(((e,t)=>{var n;if(cd(t)){const i=null!==(n=s.get(t))&&void 0!==n?n:$l("detached sequence must have associated built nodes");e.push(...i)}else e.push(t.identifier);return e}),[]));break}case d.Insert:{const{source:a}=t,c=s.get(a),l=o.get(a);if(void 0!==c){if(0===c.length){s.delete(a),null==n||n.sendTelemetryEvent({eventName:"reverting insertion of empty traits"});continue}r.unshift(vh(t,c)),s.delete(a)}else{if(void 0===l)return void(void 0!==i&&i(Xu.MissingNodes,t,e));if(0===l.length){o.delete(a),null==n||n.sendTelemetryEvent({eventName:"reverting insertion of empty traits"});continue}r.unshift(vh(t,l,!0)),o.delete(a)}break}case d.Detach:{const{destination:a}=t,l=yh(t,c.view);if(void 0===l)return void(void 0!==i&&i(Xu.MissingNodes,t,e));const{invertedDetach:d,detachedNodeIds:u}=l;if(0===u.length){null==n||n.sendTelemetryEvent({eventName:"reverting detachment of empty traits"});continue}if(void 0!==a){if(s.has(a)||o.has(a))return void(void 0!==i&&i(Xu.MalformedEdit,t,e));o.set(a,u)}r.unshift(...d);break}case d.SetValue:{const n=bh(t,c.view);if(void 0===n)return void(void 0!==i&&i(Xu.MissingNodes,t,e));r.unshift(...n);break}case d.Constraint:$l("Revert currently does not support Constraints");default:$l("Revert does not support the change type.")}if(c.applyChange(t).status!==a.Applied)return}return c.close(),r}(e,t,this.logger,this.emit.bind(this))}submitEditOp(e){if(this.isAttached())switch(this.writeFormat){case l.v0_0_2:this.submitOp(this.encoder_0_0_2.encodeEditOp(e,this.serializeEdit.bind(this),this));break;case l.v0_1_1:this.submitOp(this.encoder_0_1_1.encodeEditOp(e,this.serializeEdit.bind(this),this.idCompressor.takeNextCreationRange(),this.idNormalizer,this.interner));break;default:$l("Unknown versione)}submitOp(e,t){Object(he.a)(0===Ih(e.version,this.writeFormat),1585),this.submitLocalMessage(e,t)}getRuntime(){return this.runtime}applyStashedOp(e){const t=e;switch(t.type){case c.Edit:{let e;switch(this.writeFormat){case l.v0_0_2:switch(t.version){case l.v0_0_2:e=this.parseSequencedEdit(t);break;case l.v0_1_1:$l("Received stashed op 0.1.1 before upgrade");default:$l("Unknown version")}break;case l.v0_1_1:switch(t.version){case l.v0_0_2:e=oh(t.edit,(e=>this.generateNodeId(e)));break;case l.v0_1_1:{Object(he.a)(null!==this.stashedIdCompressor,1586),void 0===this.stashedIdCompressor&&(this.stashedIdCompressor=$d.deserialize(this.idCompressor.serialize(!1),"8477b8d5-cf6c-4673-8345-8f076a8f9bc6",t.idRange.attributionId),this.runtime.on("connectell}))),this.stashedIdCompressor.finalizeCreationRange(t.idRange);const n=uu(this.stashedIdCompressor),i={localSessionId:this.idCompressor.localSessionId,normalizeToSessionSpace:(e,i)=>{const r=n.normalizeToSessionSpace(e,t.idRange.sessionId);return this.generateNodeId(n.convertToStableNodeId(r))},normalizeToOpSpace:e=>this.idNormalizer.normalizeToOpSpace(e)};e=this.encoder_0_1_1.decodeEditOp(t,this.encodeSemiSerializedEdit.bind(this),i,this.interner);break}default:$l("Unknown version")}break;default:$l("Unknown version")}return this.applyEditLocally(e,void 0),{transformedEdit:e}}case c.Handle:case c.Update:case c.NoOp:return{};default:$l("Unrecognized op")}}reSubmitCore(e,t){const n=e;switch(n.type){case c.Edit:if(Ih(n.version,this.writeFormat)>0)$l("Attempted to resubmit op of version newer than current version");else if(void 0!==(null==t?void 0:t.transformedEdit)&&(this.writeFormat!==l.v0_0_2||n.version!==l.v0_0_2))return void this.submitEditOp(t.transformedEdit)}super.reSubmitCore(n,t)}changeWriteFoe)}internStringsFromEdit(e){for(const t of e.changes)if(t.type===d.Build)for(const e of t.source)Bu(e,(e=>{this.interner.getOrCreateInternedId(e.definition);for(const t of Object.keys(e.traits))this.interner.getOrCreateInternedId(t)}),cd);else if(t.type===d.Insert){const{referenceTrait:e}=t.destination;void 0!==e&&this.interner.getOrCreateInternedId(e.label)}}}function Ih(e,t){const n=Ch.indexOf(e),i=Ch.indexOf(t);return-1!==n&&-1!==i||$l("Summary version being compared cannot be read."),n<i?-1:n>i?1:0}function Nh(e,t){return-1===Ch.indexOf(t)&&$l("New write version is invalid."),-1===Ih(e,t)}var Th;!function(e){e.ViewChange="viewChange"}(Th||(Th={}));class Eh extends me.a{constructor(e){super(),this.tree=e;const{currentView:t}=e;this.transaction=new nh(t,new Ku.Policy),this.startingView=t}get isOpen(){return this.transaction.isOpen&&this.status===a.Applied}get status(){return this.transaction.status}get currentView(){return this.transaction.view}apply(...e){if(this.isOpen){const t=nd(e);if(t.length>0){const e=this.currentView;this.transaction.applyChanges(t.map((e=>this.tree.internalizeChange(e)))),this.listenerCount(Th.ViewChange)>0&&!e.hasEqualForest(this.currentView)&&this.emit(Th.ViewChange,e,this.currentView)}}return this.status}closeAndCommit(){if(this.isOpen&&this.transaction.changes.length>0){const e=this.transaction.close(),t={id:qu(),changes:e.changes};this.tree.edits instanceof ih&&this.tree.edits.setKnownEditingResult(t,e),this.tree.applyEditInternal(t)}}}class kh extends os.a{constructor(e){super(),this._disposed=!1,this.runtime=e.runtime,this.context=e.context,this.providers=e.providers,this.initProps=e.initProps,Object(he.a)(void 0===this.runtime._dataObject,189),this.runtime._dataObject=this,this.runtime.once("dispos()}))}get disposed(){return this._disposed}get id(){return this.runtime.id}get IFluidRouter(){return this}get IFluidLoadable(){return this}get IFluidHandle(){return this.handle}get handle(){return Object(he.a)(void 0!==this.runtime.entryPoint,1131),this.runtime.entryPoint}static async getDataObject(e){var t;const n=await(null===(t=e.entryPoint)||void 0===t?void 0:t.get());return Object(he.a)(void 0!==n,188),n}async request(e){return function(e,t){return""===t.url||"/"===t.url||t.url.startsWith("/?")?{mimeType:"fluid/object",status:200,value:e}:$o(t)}(this,e)}async finishInitialization(e){return void 0!==this.initializeP||(this.initializeP=this.initializeInternal(e)),this.initializeP}async initializeInternal(e){var t;await this.preInitialize(),e?(Object(he.a)(void 0===this.initProps,190),await this.initializingFromExisting()):await this.initializingFirstTime(null!==(t=this.context.createProps)&&void 0!==t?t:this.initProps),await this.hasInitialized()}async getFluidObjectFromDirectory(e,t,n){const i=n?n(e,t):t.get(e),r=null==i?void 0:i.IFluidHandle;if(r)return r.get()}async preInitialize(){}async initializingFirstTime(e){}async initializingFromExisting(){}async hasInitialized()}}class jh extendst"}get root(){if(!this.internalRoot)throw new Error(this.getUninitializedErrorString("root"));return this.internalRoot}async initializeInternal(e){e?(this.internalRoot=await this.runtime.getChannel(this.rootDirectoryId),this.internalRoot.attributes.type===eo.Type&&this.runtime.logger.send({category:"generic",eventName:"MapDataObject",message:"Legacy document, SharedMap is masquerading as SharedDirectory in DataObject"})):(this.internalRoot=Ls.create(this.runtime,this.rootDirectoryId),this.internalRoot.bindToContext()),await super.initializeInternal,t}var _h="0123456789ABCDEFGHJKMNPQRSTVWXYZ",Mh=_h.length,Dh=Math.pow(2,48t)}var Ah=function(e){return e||(e=function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments[1];t||(t="undefined"!=typeof window?window:null);var i=t&&(t.crypto||t.msCrypto);if(i)ret55};try{var r=n("DGBo");ret55}}catch(e){}if(e){try{console.error("secure crypto unusable, falling back to insecure Math.random()!")}catch(e){}ret()}}throw Ph("secure crypto unusable, insecure Math.random not allowed")}()),function(t){return isNaN(t)&&(t=Date.now()),function(e,t){if(isNaN(e))throw new Error(e+" must be a number");if(e>Dh)throw Ph("cannot encode time greater than "+Dh);if(e<0)throw Ph("time must be positive");if(!1===Number.isInteger(e))throw Ph("time must be an integer");for(var n=void 0,i="";t>0;t--)i=_h.charAt(n=e%Mh)+i,e=(e-n)/Mh;return i}(t, n}(16,e)}}();const Rh=h.e.getInstance().getMfsLogger("client");function Fh(e){const t=e();if(!1===t.isOK)throw t.error}function qh(e){const t=e();if(!1===t.isOK)throw t.error;return L(void 0!==t.value),t.van)}function Bh(e,t,n,i){let{errorType:r,message:s,error:o}=n;Rh.logWarn(`${function(e){return`${e.charAt(0).toUpperCase()}${e.substring(1)}`}(e)}`,t,{errorType:r,message:s,error:o},es)}const Vh=Object(h.j)(Rh),Uh=Object(h.k)(Rh);function Hh(e,t){return Object.keys(e).some((e=>w(t,e)))}function Gh(e,t){for(const n in $)if(Z(n,e)&&!w(t,n))return s.fail(new Error(`Required property: ${n} is missing.`));return s.ok()}const $h=`#e.out.${i.TwoWay}`,Kh=`#e.in.${i.TwoWay}`,Wh=e=>({type:e.type,direction:"out"===e.direction?"in":"out",kind:e.kind,...e.attributes&&{attributes:e.attributes}}),Jh=new Map;function Qh(e,t){let n=Jh.get(e);return n||(n=Xh(e),Jh.set(e,n)),{...n,...t&&{attributes:t}}}function Xh(e){const t=e.split(".");return{direction:t[1],kind:t[2]==i.OneWay?i.OneWay:i.TwoWay,type:t[3]}}const Zh=new Error("Max 100 relatedItems are allowed per operation.");function Yh(e,t,n){const i=n.value;return i?(n.value=function(e,t,n){return tm(e,t,n),i.apply(this,[e,t,n])},n):n}function em(e,t,n){const i=n.value;return i?(n.value=function(e,t){for(var n=arguments.length,r=new Array(n>2?n-2:0),s=2;s<n;s++)r[s-2]=arguments[s];return tm(e,t,r),i.apply(this,[e,t,...r])},n):n}function tm(e,t,n){A("itemId",e),x("itemId",e),function(e,t){if(!N(t)||t.some((e=>I(e))))throw m.emptyValues("relatedItemId")}(0,n),x("relationship.type",t.type),x("relationship.direction",t.direction),function(e){if(e.length>100)throw Zh}(n),n.some((e=>{if(R(e))throw m.maxInputLengthExceeded("relatedItemId")}))}constt}`;class im{constructor(e){this.consensusRegistry=e}async track(e,t,n){zh("track",`claiming label, labelId for itemId: ${n}`);const i=await this.consensusRegistry.write(nm(e,t),n);if(zh("track",`claimed: ${i} label, labelId for itemId: ${n}`),!i)throw m.consensusError("claim",e,t,n,[...this.consensusRegistry.keys()])}async untrack(e,t){const n=this.getItemId(e,t);if(!n)return void zh("untrack","label, labelId are already not in use.");zh("untrack",`releasing labelId used by itemId: ${n}`);const i=await this.consensusRegistry.write(nm(e,t),k);if(zh("untrack",`released:${i} labelId used by itemId: ${n}`),!i)throw m.consensusError("release",e,t,n,[...this.consensusRegistry.keys()])}getItemId(e,t){const n=this.consensusRegistry.read(nm(e,t),zc.Atomic);return zh("getItemId",`Read atomic itemId: ${null!=n?n:"UNDEFINED"}`),n||void 0}async cleanUp(){this.consensusRegistry.removeAllListeners();const e=[];this.consensusRegistry.keys().forEa))})),await Promise.all(e),zh("cleanUp","consensus register collection was cleaned up")}}const rm=/^[0123456789ABCDEFGHJKMNPQRSTVWXYZ]{26}$/,sm="items",om="values",am="av",cm={kind:!0,label:!0,id:!0},lm=om==t,um=e=>dm(e,"i")ist,mm=e=>dm(e,"r")&&!!e.payload,gm=e=>dm(e,"e")&&!!e.payload,pm=e=>dm(e,"a"),fm=e=>dm(e,"x")&&!!e.payload,vm=(e,t)=>t.identifier===e.root&&t.definition===Xd.definition&&t.traits.has(sm);function ym(e,t){var n;const i=e.tryGetParentViewNode(t);if((null===(n=null==i?void 0:i.parentage)||void 0===n?void 0:n.parent)===t&&L(!1,m.circularReference),i&&!vm(e,i))return hm(i)?i:ym(e,i.identifier);zh("findParentCollection","Parent node undefined or node is root",{nodeId:t})}function bm(e,t,n){const i=e.tryGetParentViewNode(n);return!i||vm(e,i)?(zh("isAncestorOf","Parent node undefined or node is root",{descendantNodeId:n}),!1):i.identifier===t||bm(e,t,i.identifier)}class Sm{constructor(e,t){this.view=e,this.root=t}get(e){return zh("get","get on specified elementId position",{elementId:e}),this.validateElementId(e),this.view.getViewNode(e).payload}*getElements(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];zh("getElements","get elements",{parentId:e,isReverse:t});for(const n of this.getPositions(e,t))yield{elementValue:this.get(n),elementId:n,parentId:null!=e?e:this.root}}hasElement(e,t){zh("hasElement","check has element",{elementId:e,root:t});const n=ym(this.view,e);return(null==n?void 0:n.identifier)===(null!=t?t:this.root)}getPositions(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.validateElementId(e);const n=this.view.getTrait({parent:null!=e?e:this.root,label:lm});return t?n.slice().reverse():n}validateElementId(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2?arguments[2]:void 0;if(void 0===e)return!0;if(!this.view.hasNode(e)){if(zh("validateElementId",`elementId: ${e} does not exist.`),t)return!1;throw m.invalidPosition()}return L(this.hasElement(e,n),m.invalidPosition),!0}}class Cm extends=e}insert(e,t){switch(this.validate(e),zh("insert","inserting items",{position:e}),e.place){case"before":return this.insertItems(this.placeBefore(e.elementId),t);case"after":return this.insertItems(this.placeAfter(e.elementId),t);case"under":return this.insertItems(this.placeUnder(e.elementId),t);case"first":return this.insertItems(this.getFirstPlace(e.parentId),t);case"last":return this.insertItems(this.getLastPlace(e.parentId),t)}}move(e,t,n){const i=e.elementId;switch(zh("move","moving from source position to destination position",{from:e,to:t,destinationRoot:n}),this.validate(e),this.validate(t,n),t.place){case"before":return gu.move(bu(i),this.placeBefore(t.elementId));case"after":return gu.move(bu(i),this.placeAfter(t.elementId));case"under":return gu.move(bu(i),this.placeUnder(t.elementId));case"first":return gu.move(bu(i),this.getFirstPlace(t.parentId,n));case"last":return gu.move(bu(i),this.getLastPlace(t.parentId,n))}}remove(e){const t=this.validateElementId(e,!0);if(zh("remove","removing element at specified position",{position:e,exists:t}),t)return gu.delete(bu(e))}clear(e){return[gu.delete(Su({parent:null!=e?e:this.root,label:lm}))]}getFirstPlace(e,t){var n;const i=null!==(n=null!=e?e:t)&&void 0!==n?n:this.root;return vu({parent:i,label:lm})}getLastPlace(e,t){var n;const i=null!==(n=null!=e?e:t)&&void 0!==n?n:this.root;return yu({parent:i,label:lm})}placeBefore(e){return pu(this.view.getViewNode(e).identifier)}placeAfter(e){return fu(this.view.getViewNode(e).identifier)}placeUnder(e){return this.getFirstPlace(this.view.getViewNode(e).identifier)}insertItems(e,t){const n=[],i=t.map((e=>{const t=this.tree.generateNodeId();return n.push([e,t]),this.makePositionNode(e,t)}));return zh("insertItems","item ids currently being inserted",{itemNodeIds:n,place:e}),{changes:gu.insertTree(i,e),itemNodeIdst}}validate(e,t){"before"!==e.place&&"after"!==e.place&&"at"!==e.place||this.validateElementId(e.elementId,!1,t)}}function wm(e,t,n){return e.getTrait({parent:null!=n?n:e.root,label:t})}function Om(e,t,n){zh("getNodeTraits","Getting node traits",{sourceNodeId:t});const i=e.getViewNode(t),r=new Map;return i.traits.forEae)})),r}function Im(e,t,n){const i=e.getViewNode(t);return L(n(i)),i}function Nm(e,t,n){const i=t.getTrait({parent:t.root,label:n})[0];if(!i)return void zh("tryGetItemNodeId",`itemId: ${n} is not found in the index.`);const r=Im(t,i,fm).payload;let s;try{s=e.convertToNodeId(r)}catch(e){throw Lh("invalidStableNodeId","invalidStableNodeId",{invalidStableNodeId:r},"tryGetItemNodeId"),m.invalidStableNodeId(r)}return s&&L(t.hasNode(s)))),zh("tryGetItemNodeId",s?`resolved itemId: ${n} -> itemNodeId: ${s}`:`not found itemId: ${n}`),s}function Tm(e,t,n){const i=Nm(e,t,n);return L(!!i,(()=>m.itemNotFound(n))),i}function Em(e,t,n){return ,n)))}function km(e,t,n){return qh((()=>function(e,t,n){const i=jm(e,t,n);if(!1===i.isOK)return zh("tryGetCollectionNode","Failed to find collection node",{itemId:n}),i;const r=i.value;return hm(r)?s.ok(r):(zh("tryGetCollectionNode","Found node but was not a collection node",{itemId:n}),s.fail(m.notCollectionItem(n)))}(e,t,n)))}function jm(e,t,n){const i=Nm(e,t,n);if(!i)return zh("tryGetItemNode","Failed to find item node",{itemId:n}),s.fail(m.itemNotFound(n));const r=Im(t,i,um);return s.okn)}function _m(e,t){const n=e.getViewNode(t[0]);return Mm(e,n)}function Mm(e,t){var n;switch(t.definition){case"a":return(null!==(n=t.traits.get(am))&&void 0!==n?n:[]).moad));default:return t.payload}}function Dm(e,t,n){const i=Em(e,t,n),r=i.traits.get(b),s=r?_m(t,r):void 0;return{label:i.payload.label,labelId:s}}function xm(e,t,n,i){if(!N(t))return zh("getUniqueValues","Values are all undefined, nothing to process"),s.ok(t);const r=T(t);if(!i||"put"===n)return zh("getUniqueValues","Property does not exist or is being reset, nothing to process"),s.ok(r);const o=r.filter((t=>!function(e,n,i,r){return i.some((ad))(e.getViewNode(n))))}(e,0,i)));return N(o)?s.ok(o):(zh("getUniqueValues","Error, no new values to add"),s.fail(new Error("No new values to add")))}function Am(e,t,n,i,r){const s=Nm(e,t,n);if(s)return Rm(t,s,i,r)}function Rm(e,t,n,i){const r=Fm(e,t,i);return n(r,i)?r:void 0}function Fm(e,t,n){const i={},r=Im(e,t,um);i.id=r.payload.id,n&&!n.includes(y)||(i.label=r.payload.label),n&&!n.includes(g)||!r.payload.kind||(i.kind=r.payload.kind);for(const[t,s]of r.traits){if(t.startsWith("#e")){zh("readMfsItem","Related items are not included in the item, skipping");continue}if(t===om){zh("readMfsItem","Collection values are not included in the item, skipping");continue}cons,s);n&&!n.includes(t)||(i[t]=r())}return function(e,t){if(!ee(e,t))throw m.invalidItem()}(i,nm)}function zm(e,t,n,i){return Am(e,t,n,(e=>ee(e,i)),i)}function Bm(e,t,n){const{id:i,parentId:r}=ne(n)?{id:n,parentId:void 0}:n;return{collectionNodeId:km(e,t,i).identifier,collectionId:i,...r&&{parentId:n)}function*Vm(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i=Um(e,t.collectionNodeId);for(const e of i.getElements(t.parentId,n))yield{itemId:e.elementValue,elementId:e.elementId,...e.parentId!==t.collectionNodeId&&{parentId:e.parentIt)}function*Hm(e,t,n,i,r,s){var o;for(const a of Vm(t,n,r)){const c=zm(e,t,a.itemId,s);if(!c)continue;zh("getCollectionItemsWithoutPaging",`Getting collection item id: ${c.id}, kind:${null!==(o=c.kind)&&void 0!==o?o:"single item"}, collectionId: ${n.collectionId}${n.parentId?",parentId:":""} ${n.parentId?n.parentId:""}`);const l={item:c,elementId:a.elementId,...n.parentId&&{parentId:a.parentId}};if(i>1){const o=[],d=void 0===c.kind?Hm(e,t,{collectionNodeId:n.collectionNodeId,parentId:a.elementId,collectionId:n.collectionId},i-1,r,s):[];for(const e of d)o.push(e);o.length>0&&(l.children=o)}yield l}}function*Gm(e,t,n,i){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Number.MAX_SAFE_INTEGER;if(!n||Pm(e,t,n)){for(const o of Vm(t,i))if(s(o)&&(yield o),r>1)for(const a of Gm(e,t,n,{...i,parentId:o.elementId},r-1))s(a)&&(yield a)}else zh("getEntriesOf",`itemId: ${n} does not exist.`);function s(i){return!n&&Pm(e,t,i.itemId)||n===i.itemId}}function $m(e,t,n,i,r,o){const a=km(e,t,n),c=o?km(e,t,o):void 0;L(!o||!!c),Fh((()=>function(e,t,n){const i=t.elementId,r=(e=>"before"===e.place||"under"===e.place||"after"===e.place?e.elementId:(L("first"===e.place||"last"===e.place),e.parentId))(n);return r&&(i===r||bm(e,i,r))?s.fail(m.invalidMove()):s.ok()}(t,i,r)));const l=Lm(e,t,a.identifier);return zh("moveCollectionItem",`Moving ${JSON.stringify(i)}, to: ${JSON.stringify(r)}, collectionId:${n} ${o?", toCollectionId":""}${null!=o?o:""}`),l.move(i,r,null==c?void 0:c.identifier)}function Km(e){return M(e)?[Xm(e)]:[Qm(e,"sv")]}function Wm(e){return L(function(e){return!!e&&Array.isArray(e)&&!e.some((e=>!function(e){return!!e&&"string"==typeof e&&!I(e)}(e)))}(e),m.invalidCollectionValues),e.map((e=>Qm(e,"r"=g}conste}),Xm=e=>({definition:"a",traits:{[am]:e.map((e=>Qm(e,"mv")))}}),Zm=(e,t)=>function(e,t){return`${function(e){var t;return`#e.${e.direction}.${null!==(t=e.kind)&&void 0!==t?t:0}`}(t)}.${t.type}`}(0,t);function Ym(e,t,n,i,r,s){const o=Tm(e,t,n);return zh("addOneWayRelation","Adding one way relationship itemNodeId ",{itemNodeId:o,relationshipDirection:i.direction}),function(e,t,n,i,r,s){const o=Zm(0,r),a=ag(t,n,o),c=T(i);return a?function(e,t,n,i){const r=[];for(const s of n){const n=ng(i,s);eg(e,t,s,n)&&r.push(...sg(t.identifier,n))}return zh("putEdgeSet","Overriding existing edge set",{edgeSetNode:t,destinationIds:n,relationship:i}),r}(t,a,c,r):function(e,t,n,i,r){const s=e.generateNodeId(),o=gu.insertTree([rg(s)],vu({parent:t,label:n}));for(const e of i){const t=ng(r,e);o.push(...sg(s,t))}return zh("createEdgeSet","Creating edge set",{sourceNodeId:t,destinationNodeIds:i,relationship:r}),o}(e,n,o,c,r)}(e,t,o,r,i)}function eg(e,t,n,i){return!t.traits.has(n)||!Cu(function(e,t,n){var i;const r=(null!==(i=t.traits.get(n))&&void 0!==i?i:[])[0];return L(!!r),Im(e,r,gm)}(e,t,n).payload,i)}function tg(e,t,n,i,r,s,o){if("reverse"===o&&!Pm(e,t,n))return zh("removeLinks",`source itemId: ${n} not found`),[];const a=og(t,Tm(e,t,n),Zm(0,r));return a?i.map((e=>function(e,t){return gu.delete(Su({parent:e,label:t}))}(a,e))):(zh("removeLinks","No edges to remove with type"),[])}function ng(e,t){return{type:e.type,neighbor:t,dir:e.direction,...e.attributes&&{attributes:e.attribute}}function sg(e,t){const n={parent:e,label:t.neighbor};return[gu.delete(Su(n)),...gu.insertTree([ig(t)],vu(n))]}function og(e,t,n){const i=e.getTrait({parent:t,label:n});return 0===i.length?void 0:i[0]}function ag(e,t,n){const i=og(e,t,n);return i?e.getViewNode(i):void 0}function*cg(e,t,n,i){const r=Tm(e,t,n),s=Om(t,r,function(e){return t=>{")}(t))return!1;if(!e)return!0;const n=Xh(t);return(!e.matchDirection||e.matchDirection(n.direction))&&(!e.matchKind||e.matchKind(n.kind))&&(!e.matchType||e.matchType(n.type))}}(null==i?void 0:i.filter));for(const e of s.keys()){const n=ag(t,r,e);L(!!n);for(const[r,s]of n.traits){const n=Im(t,s[0],gm),o=null==i?void 0:i.filter,a=n.payload.attributes;if(!o||!o.matchAttributes||o.matchAttributes(a)){const t=Qh(e,a);yield{relatedItemId:r,relationship:t}}}}}function lg(e){return e.startsWith($h)?e.replace("#e.out","#e.in"):e.startsWith(Kh)?e.replace("#e.in","#e.out"):void L(!1,m.invalidEdgeLabel)}function dg(e,t){if(X(e)&&((e=>Z(e,8))(e)&&("set"===t||"delete"===t)||(e=>e in W)(e)&&"delete"===t))throw m.accessDenied(t,e);return e}const ug=e=>Z(e,512);function hg(e){var t,n;const i=e[ce],r=e[le];return{hasAdd:null!==(t=i&&N(i))&&void 0!==t&&t,hasRemove:null!==(n=r&&N(r))&&void 0!==n&&n}}function mg(e,t,n,i){const r={parent:t.identifier,label:n},o=function(e,t,n){const i=t.traits.get(n);if(!i)return void zh("getPropertyNode","Property traits does not exist",{itemNode:t});const r=e.getViewNode(i[0]);return L(pm(r)||(e=>dm(e,"sv")&&void 0!==e.payload)(r)),r}(e,t,n);if(void 0===i)return void 0===o?[]:[gg(r)];const a=function(e,t,n,i){var r;if((e=>null==e||"string"==typeof e||"number"==typeof e||"boolean"==typeof e||"object"==typeof e&&!_(e)&&!Array.isArray(e)||e instanceof Date)(t)||null==t)return s.ok(t);const o=function(e,t){return M(t)&&null!=t?function(e,t){if(t&&N(t)&&ug(e)){const e=T(t);return s.ok(e)}return s.ok(t)}(e,t):_(t)?function(e,t){const n=function(e){const t=e[le],n=e[ce];if(t&&N(t)){const e=T(t,Cu);if(n&&N(n)){const t=n.reduce(((t,n)=>{const i=e.findInd,e)));return i>-1?(t.remove.splice(i,1),t):((t.add||(t.add=[])).push(n),t)}),{add:[],remove:e});return de({addValues:t.add,removeValues:t.remove})}return de({addValues:n,removeValues:e})}return e}(t),{hasAdd:i,hasRemove:r}=hg(n);if(!i&&!r)return s.fail(new Error("nothing to update"));if(i&&ug(e)){const e=n[ce];L(void 0!==e);const t=T(e);return s.ok(de({addValues:t,removeValues:n[le]}))}return s.ok(n)}(e,t):s.fail(new Error(`failed to get values ${JSON.stringify(t)}`))}(n,t);if(!o.isOK)return o;const a=o.value;L(void 0!==a);const{hasAdd:c,hasRemove:l}=function(e){return _(e)?hg(e):{hasAdd:!0,hasRemove:!1}}(a);if(void 0===i)return c?l?s.ok(function(e){return _(e)?de({addValues:e[ce]}):e}(a)):o:s.fail(new Error(`${n} is a new property, ignoring removeValues}`));if(!Z(n,512))return s.ok(a);const d=null!==(r=i.traits.get(am))&&void 0!==r?r:[];if(M(a))return xm(e,a,"put",d);if(_(t)){if(c){const n=t[ce];L(!!n);const i=xm(e,n,"patch",d);return!0===i.isOK?s.ok({...t,[ce]:i.value}):t[le]?s.fail(new Error("Nothing to process")):s.ok({...t,[ce]:void 0})}return s.ok(a)}return s.ok(a)}(e,i,n,o);return!1===a.isOK?(zh("setProperty",`Skip setProperty , reason: ${a.error.message}`),[]):void 0===o?pg(a.value,r):_(a.value)?(L(pm(a"))),function(e,t,n){var i,r,s;const o=null!==(i=t[ce])&&void 0!==i?i:[],a=null!==(r=t[le])&&void 0!==r?r:[],c=[];if(N(o)&&!fg(e,n,o)&&c.push(...gu.insertTree(o.map((e=>Qm(e,"mv"))),yu({parent:n.identifier,label:am}))),N(a)){const t=function(e,t,n){return n.filter((n=>{const i=e.getViewNode(n);return t.so,e)))}))}(e,a,null!==(s=n.traits.get(am))&&void 0!==s?s:[]);c.push(...t.me)))))}return c}(e,a.value,o)):fg(e,o,a.value)?[]:function(e,t){return[gg(t),...pg(e,t)]}(a.value))}function pg(e,t){const n=e=>gu.insertTree(Km(e),vu(t));return _(e)?(zh("createProperty","Creating new property"),n(e[ce])):nn)}function vg(e,t,n){zh("deleteMfsItem","Deleting Mfs item",{root:t.root,itemId:n});const i=Em(e,t,n),r=function(e,t,n,i){const r=((e,t)=>Om(eKh))))(t,i),s=[];for(const[i,o]of r){const r=t.getViewNode(o[0]);for(const o of r.traits.keys()){const r=Em(e,t,o).traits.get(lg(i));r&&s.push(gu.delete(Su({parent:r[0],label:n})))}}return s}(e,t,n,i.identifier);return r.push(gu.delete(bu(i.identifier))),r.push(gu.delete(Su({parent:t.root,label:n}))),r}function yg(e,t){return t.reduce(((t,n)=>{var i;const r=e.getViewNode(n);return(t[i=r.definition]||(t[i]=[])).push(r),t}),{})}function bg(e,t,n){return{changed:yg(e,n.changed),added:yg(e,n.added),removed:yg(t,n.removed)}}function Sg(e,t,n){return t in e[n]}function Cg(e,t,n){return t in e[th}(e[n])}function wg(e,t){return 0===Object.keys(e[t]).length}function Og(e,t,n){var i;return null!==(i="add"===t?e.added[n]:"remove"===t?e.removed[n]:e.changed[n])&&void 0!==i?i:[]}function Ig(e,t,n,i){var r;const s=(null!==(r=t.changed[n])&&void 0!==r?r:[])[e];return s&&i(s)?Ng.ok(s):Ng.fail()}const Ng={fail:()=>({isOK:!1})e})};var Tg=n("6dK/"),Eg=n.n(n)}function jg(e,t,n){const i=function(e){var t,n,i,r;const s=null!==(n=null===(t=e.changed.i)||void 0===t?void 0:t.length)&&void 0!==n?n:0,o=null!==(r=null===(i=e.changed.r)||void 0===i?void 0:i.length)&&void 0!==r?r:0;return zh("getEitherCollectionOrParentNode","item and reference cound",{changedItemCount:s,changedReferenceCount:o}),s+o<=1?s>0?Ig(0,e,"i",hm):Ig(0,e,"r",mm):Ng.fail()}(t);if(!1===i.isOK)return zh("hasElementChanged","matchCollectionOrParent failed"),i;const{collectionNode:r,parentNode:s}=function(e,t){if(!mm(t))return{collectionNode:t};const n=t,i=ym(e,n.identifier);return L(!!i&&hm(i)),{collectionNode:i,parentNode:n}}(e,i.value);return zh("hasElementChanged","",{collectionId:r.payload.id,parentId:null==s?void 0:s.identifier,changeKind:n}),Ng.ok([{collectionId:r.payload.id,label:r.payload.label,kind:"collectionChanged",...s&&{parentId:s.identifier},changeKind:"add"===n?"addElement":_g(r)?"clear":"removeElement",elements:Pg(t,n)}])}function Pg(e,t){return Og(e,t,"r").map((e=>(L(mm(e)),{itemId:e.payload,elementId:e.identifier}m)}function Mg(e,t){const n=Og(e,t,"i")[0];return zh("hasItemsChange","node identifier",{nodeIdentifier:n.identifier,changeKind:t}),hm(n)?(zh("hasItemsChange","collection match",{collectionId:n.payload.id}),Ng.ok([{collectionId:n.payload.id,label:n.payload.label,kind:"collectionChanged",changeKind:t}])):um(n)?(zh("hasItemsChange","collection match",{itemId:n.payload.id}),Ng.ok([{itemId:n.payload.id,label:n.payload.label,kind:"itemsChanged",changeKind:t}])):(zh("hasItemsChange","match items failed",{nodeIdentifier:n.identifier,changeKind:t}),Ng.failth}function xg(e,t,n,i,r){var s;for(const o of null!==(s=Og(i,n,t))&&void 0!==s?s:[]){const{label:t}=r.getTraitLocation(o.identifier);e[t]="add"===n?"add":t in e?"update":"remove"}}function Ag(e,t,n,i){const r=[],s=Og(t,n,"e");for(const t of s){L(gm(t));const{itemNode:s,edgeLabel:o}=Rg(e,t);r.push({changeKind:null!=i?i:n,kind:"relationshipChanged",relatedItemId:t.payload.neighbor,relationship:Qh(o,t.payload.attributes),itemId:s.payload.id,label:s.payload.label})}return zh("hasRelationshipChange","changes length",{changesLength:r.length}),r.length>0?Ng.ok(r):Ng.fail()}function Rg(e,t){const n=e.tryGetParentViewNode(t.identifier);return L(!!s"))(n),(()=>m.nodeNotFound("es",n))),function(e,t){const{parent:n,label:i}=e.getTraitLocation(t.identifier),r=e.tryGetViewNode(n);return L(!!r&&um(,r))),{itemNode:r,edgeLabel:i}}(e,n)}const Fg={0:function(e,t,n){return Bh("onChange",h.g.ExpectationFailed,{message:"Failed to categorize changes delta"}),Ng.fail()},1:function(e,t,n){const i=!wg(n,"added"),r=!wg(n,"removed");return i&&!r?(zh("matchItemsChanged","match add hasItemsChanged"),Mg(n,"add")):r&&!i?(zh("matchItemsChanged","match add hasItemsChanged"),Mg(n,"remove")):(zh("matchCollectionChanged","match items failed"),Ng.fail())},2:function(e,t,n){const i=!wg(n,"added"),r=!wg(n,"removed");return i||r?i&&!r?(zh("matchCollectionChanged","add element match"),jg(e,n,"add")):r&&!i?(zh("matchCollectionChanged","remove element match"),jg(t,n,"remove")):(zh("matchCollectionChanged","match collection failed"),Ng.fail()):(zh("matchCollectionChanged","move element match"),function(e,t){const n=function(e,t){const n=function(e,t){var n,i;const r=e.delta(t),s=new Map;for(const o of r.changed){const r=e.getViewNode(o),a=t.getViewNode(o),c=new Set(r.traits.keys());a.traits.forEach(((e,t)=>c.add(t)));for(const e of c){const t=null!==(n=r.traits.get(e))&&void 0!==n?n:[],c=null!==(i=a.traits.get(e))&&void 0!==i?i:[];if(t!==c){const n=t.length,i=c.lengt[n];let a=0,l=0;const d=(n,i,r)=>{for(;a!==i;a+=1)kg(s,t[a],{}).source={parent:o,label:e};for(;l!==r;l+=1)kg(s,c[l],{}).destination={parent:o,label:e};a+=n,l+=n};Eg()(n,i,r,d),d(0,n,i)}}}return s}(t,e);if(1===n.size){const[[e,t]]=n.entries();if(t.source&&t.destination)return Ng.ok({movedId:e,previousParentId:t.source.parent,parentId:t.destination.parent})}return zh("getMovedNodeId","Unexpected deltaMap",{deltaMap:n}),Ng.fail()}(e,t);if(n.isOK){const{movedId:i,parentId:r,previousParentId:s}=n.value;zh("hasElementMoved","move nodeId result is Ok",{movedId:i,parentId:r,previousParentId:s});const o=ym(e,i),a=r===s?o:ym(t,i);L(!!o,(()=>m.parentCollectionNotFound(i,"Current"))),L(!s")));const c=a.identifier!==o.identifier;return zh("hasElementMoved","collections ids",{previousCollectionIdentifier:a.identifier,collectionIdentifier:o.identifier}),Ng.ok([{collectionId:o.payload.id,label:o.payload.label,kind:"collectionChanged",changeKind:"moveElement",...r!==o.identifier&&{parentId:r},...s!==a.identifier&&{previousParentId:s},...c&&{previousCollectionId:a.payload.id},...c&&{previousCollectionLabel:null==a?void 0:a.payload.label}}])}return zh("hasElementMoved","hasElementMoved match failed"),Ng.fail()}(e,t))},3:function(e,t,n){if(Cg(n,"a","changed"))return zh("matchPropertyChanged","NodeKind is array only, detecting change"),function(e,t){const n=t.changed.a[0];L(!!n&&pm(n));const{parent:i,label:r}=e.getTraitLocation(n.identifier),s=e.getViewNode(i);return L(um(s)),zh("hasDeltaPropertyChange","Creating delta property change match",{itemId:s.payload.id,itemNodeId:s.identifier}),Ng.ok([{itemId:s.payload.id,label:s.payload.label,kind:"propertyChanged",changedProperties:{[r]:"update"}}])}(e,n);L(Cg(n,"i","changed"));const i={};xg(i,"a","add",n,e),xg(i,"sv","add",n,e),xg(i,"sv","remove",n,t),xg(i,"a","remove",n,t);const r=n.changed.i[0];return L(!!r&&um(r)),zh("matchPropertyChanged","item ids",{itemNodeId:r.identifier,itemId:r.payload.id}),Ng.ok([{itemId:r.payload.id,label:r.payload.label,kind:"propertyChanged",changedProperties:i}])},4:function(e,t,n){const i=!wg(n,"added"),r=!wg(n,"removed"),s=!wg(n,"changed");return i&&!r?(zh("matchRelationshipChanged","add relationship match"),Ag(e,n,"add")):r&&!i?(zh("matchRelationshipChanged","remove relationship match"),Ag(t,n,"remove")):s&&i&&r?(zh("matchRelationshipChanged","update relationship match"),Ag(e,n,"add","update")):(zh("matchCollectionChanged","match collection failed"),Ng.fail())}};const qg="itemLabelsTracker",zg="itemsTree";class Bg extends jh{setHost(e){this.app=e}getHost(){return this.app}setId(e){this.podId=e}getId(){return this.podId}get view(){return this.items.currentView}async createItem(e){const[t,n]=this.createTransaction();Fh((()=>function(e){return g in e?s.fail(m.invalidCreationMethod()):s.ok()}(e)));const[i,r]=await this.createItemInternal(n,e,Ah());return zh("createItem","Creating item",{itemId:i.id}),this.commitChanges(r,t),i}async createCollection(e,t){const[n,i]=this.createTransaction(),r={...e,[re]:null!=t?t:[]},[s,o]=await this.createItemInternal(i,r,Ah());return zh("createCollection","Creating collection",{collectionId:s.id,kind:s.kind,itemIds:t}),this.commitChanges(o,n),function(e){const t=e;return delete t[re],L(te(t)),t}(s)}getMfsItem(e,t){return zh("getMfsItem","Getting mfs item",{itemId:e}),function(e,t,n,i){const r=Nm(e,t,n);if(!r)return;const s=Fm(t,r,i);return ee(s,i)?s:void 0}(this.items,this.view,e,t)}getItemsByLabel(e,t,n){return n?(zh("getItemsByLabel","Getting items by labelId"),this.getItemByLabelId(e,t,n)):(zh("getItemsByLabel","LabelId not specified, getting items by label"),this.getItems(e,{filter:e=>e.label===t&&(!n||e.labelId===n)}))}getItem(e,t,n){return zh("getItem","Getting item",{itemId:e}),Am(this.items,this.view,e,t,n)}getItems(e,t){H(t);let n=function*(e,t,n){for(const i of function(e,t){return"desc"===t?function*(e){const t=qm(e);for(let e=t.length-1;e>=0;e--)yield t[e]}(e):function(e){return qm(e).values()}(e)}(e,null==n?void 0:n.orderBy)){const r=(null==n?void 0:n.filter)?Rm(e,i,t):Rm(e,i,t,null==n?void 0:n.select);if(r&&(!n||!(null==n?void 0:n.filter)||n.filter(r))){const s=(null==n?void 0:n.select)?Rm(e,i,t,n.select):r;yield s}}}(this.view,e,t);return zh("getItems","Filtering result with the query",{top:null==t?void 0:t.top,skip:null==t?void 0:t.skip,orderBy:null==t?void 0:t.orderBy}),t?(t.skip&&(n=U(n,t.skip)),t.top&&(n=V(n,t.top)),n):(zh("getItems","Query not specified, returning results without paging"),n)}async deleteItem(e){const[t,n]=this.createTransaction();if(!Pm(this.items,n,e))return void Lg("deleteItem",e);zh("deleteItem","Deleting item",{itemId:e});const i=vg(this.items,n,e);await this.stopLabelTracking(n,e),this.commitChanges(i,t)}async deleteItemByLabelId(e,t){const n=this.labelTracker.getItemId(e,t);if(!n)return void zh("deleteItemByLabelId","ItemId not found on deleteItemByLabelId, skipping");await this.labelTracker.untrack(e,t),zh("deleteItemByLabelId","stopTracking ",{itemId:n});const i=this.getItem(n,ee);if(i){const[e,t]=this.createTransaction();zh("deleteItemByLabelId","Deleting item",{itemId:n});const r=vg(this.items,t,i.id);r&&(zh("deleteItemByLabelId","Commiting changes",{itemId:n}),this.commitChanges(r,e))}}deleteItems(){const[e,t]=this.createTransaction(),n=function(e){zh("deleteAllMfsItems","Deleting all Mfs items",{root:e.root});const t=e.getViewNode(e.root),n=[];for(const i of t.traits.keys())n.push(gu.delete(Su({parent:e.root,label:i})));return n}(t);return this.commitChanges(n,e),this.labelTracker.cleanUp()}async patchItem(e,t){var n;const i=this.getMfsItem(e),[r,s]=this.createTransaction(),o=function(e,t,n,i){zh("updateMfsItem","Updating Mfs item",{root:t.root,itemId:n});const r=[],s=Em(e,t,n);for(const[e,n]of Object.entries(i)){const i=dg(e,"set");r.push(...mg(t,s,i,n))}return r}(this.items,s,e,t);if(0!==o.length){zh("patchItem","Patching item",{itemId:e}),await this.restartLabelTracking(s,e,(e=>{if(!w(e,b))return;if(void 0===e.labelId)return k;const t=e.labelId;return L(C(t)&&j(t),m.invalidLabelId),t})(t));try{this.commitChanges(o,r)}catch(t){throw zh("patchItem","Error on commitChanges"),i&&await this.restartLabelTracking(s,e,null!==(n=i.labelId)&&void 0!==n?n:k),t}}else Lg("patchItem",e)}async setItemProperty(e,t,n){var i;const r=this.getMfsItem(e),[s,o]=this.createTransaction(),a=function(e,t,n,i,r){return mg(t,Em(e,t,n),dg(i,"set"),r)}(this.items,o,e,t,n);if(0!==a.length){zh("setItemProperty","Setting item property",{itemId:e}),await this.restartLabelTracking(o,e,((e,t)=>{if(e===b)return void 0===t?k:(L(C(t)&&j(t),m.invalidLabelId),t)})(t,n));try{this.commitChanges(a,s)}catch(t){throw zh("setItemProperty","Error on commitChanges"),r&&await this.restartLabelTracking(o,e,null!==(i=r.labelId)&&void 0!==i?i:k),t}}else Lg("setItemProperty",e)}async deleteItemProperty(e,t){const[n,i]=this.createTransaction(),r=function(e,t,n,i){const r=Em(e,t,n),s=dg(i,"delete");return r.traits.has(s)?gu.delete(Su({parent:r.identifier,label:s})):void zh("deleteMfsItemProperty",`deleteMfsItemProperty found no property with the specified key on itemId: ${n}`)}(this.items,i,e,t);r?(zh("deleteItemProperty","Deleting item property",{itemId:e}),await this.stopLabelTracking(i,e),this.commitChanges([r],n)):Lg("deleteItemProperty",e)}getItemProperty(e,t){return zh("getItemProperty","Getting item property",{itemId:e}),function(e,t,n,i){const r=Em(e,t,n);if(Y(i)){if("id"===i)return r.payload.id; cm)(i))return r.payload[i]}const)}(r,i);if(s)return _m(t,s);zh("tryGetItemProperty","No Property found",{itemId:n,propertyName:i})}(this.items,this.view,e,t)}addRelatedItem(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return this.addRelatedItems(e,t,i)}addRelatedItems(e,t,n){const[r,s]=this.createTransaction(),o=t.kind===i.TwoWay?function(e,t,n,i,r,s){const o=T(r),a=Ym(e,t,n,i,o),c=Wh(i);return a.push(...o.flatMap((i=>Ym(e,t,i,c,[n])))),zh("addTwoWayRelation","Adding two way relationship to itemNodeIds",{dedupedRelatedItemIds:o}),a}(this.items,s,e,t,n):Ym(this.items,s,e,t,n);zh("addRelatedItems","Adding related items",{itemId:e,relationship:{kind:t.kind,direction:t.direction},relatedItemIds:n}),this.commitChanges(o,r)}removeRelatedItem(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return this.removeRelatedItems(e,t,i)}removeRelatedItems(e,t,n){const[r,s]=this.createTransaction(),o=t.kind===i.TwoWay?function(e,t,n,i,r,s){const o=T(r),a=tg(e,t,n,o,i,0,"forward");if(0===a.length)return zh("removeTwoWayRelation","No relationship to remove",{itemId:n}),a;const c=Wh(i);return a.push(...o.flatMap((i=>tg(e,t,i,[n],c,0,"reverse")))),zh("removeTwoWayRelation","Removing two way relationship",{dedupedRelatedItemIds:o}),a}(this.items,s,e,t,n):function(e,t,n,i,r,s){return zh("removeOneWayRelation","Removing one way relationship from itemId",{itemId:n}),tg(e,t,n,r,i,0,"forward")}(this.items,s,e,t,n);zh("removeRelatedItems","removing related items",{itemId:e,relationship:{kind:t.kind,direction:t.direction},relatedItemIds:n}),this.commitChanges(o,r)}getRelatedItems(e,t){const n=this.view,{kind:i,direction:r}=t;return zh("getRelatedItems","getting related items",{itemId:e,relationship:{kind:i,direction:r}}),function*(e,t,n,i,r){const s=og(t,Tm(e,t,i),Zm(0,r));if(!s)return void zh("getRelatedItems","No related items found",{itemId:i});const o=t.getViewNode(s);for(const n of o.traits.keys()){const r=Am(e,t,n,ee);r?(zh("getRelatedItems",`Found relatedItem: ${r.id}`),yield r):zh("getRelatedItems",`Skipped relatedItem: ${i}.`)}}(this.items,n,0,e,t)}*getAllRelationships(e,t){const n=this.view;zh("getAllRelationships","getting all relationships",{itemId:e});for(const{relationship:i}of cg(this.items,n,e,t))yield i}*getAllRelatedItemsAndRelationships(e,t){const n=this.view;zh("getAllRelatedItemsAndRelationships","getting all related items and relationships",{itemId:e});for(const{relatedItemId:i,relationship:r}of cg(this.items,n,e,t)){const e=this.getItem(i,ee);e&&(yield{item:e,relationship:r})}}getCollectionItems(e,t){var n,i;!function(e){if(e){if(void 0!==e.depth&&!E(e.depth))throw m.invalidQueryDepth(e.depth);void 0===e.select&&void 0===e.skip&&void 0===e.top||H(e)}}(t);const r=this.view,s=Bm(this.items,r,e);zh("getCollectionItems","Filtering result with query",{collectionId:e,query:{top:null==t?void 0:t.top,skip:null==t?void 0:t.skip,depth:null==t?void 0:t.depth,reverse:null==t?void 0:t.reverse}});let o=Hm(this.items,r,s,null!==(n=null==t?void 0:t.depth)&&void 0!==n?n:1,null!==(i=null==t?void 0:t.reverse)&&void 0!==i&&i,null==t?void 0:t.select);return t?(t.skip&&(o=U(o,t.skip)),t.top&&(o=V(o,t.top)),o):o}getItemIdAt(e,t){const n=this.view,i=function(e,t,n,i){return Um(t,km(e,t,n).identifier).get(i.elementId)}(this.items,n,e,t);return zh("getItemIdAt","Getting item at collection position",{collectionId:e,position:t}),Pm(this.items,n,i)?i:void 0}insertItems(e,t,n){const[i,r]=this.createTransaction(),{changes:s,itemNodeIds:o}=function(e,t,n,i,r){return Lm(e,t,km(e,t,n).identifier).insert(null!=r?r:{place:"last"},i)}(this.items,r,e,t,n);return zh("insertItems","Inserting items on collection position",{collectionId:e,itemIds:t,position:n}),this.commitChanges(s,i),o}insertItem(e,t,n){return this.insertItems(e,[t],n)[0]}removeItemAt(e,t){const[n,i]=this.createTransaction(),r=function(e,t,n,i){const r=km(e,t,n),s=Lm(e,t,r.identifier).remove(i.elementId);return zh("removeFromCollection",`${s?"":"skip"} removing ${JSON.stringify(i)}, collectionId:${r.identifier}`),s}(this.items,i,e,t);zh("removeItemAt","removing items at a collection position",{collectionId:e,at:t}),r?this.commitChanges([r],n):Bh("removeItemAt",h.g.NotFound,{message:`not found, elementId:${t.elementId} in collectionId: ${e}`})}removeItemById(e,t){const[n,i]=this.createTransaction();if(zh("removeItemById","Removing item by id",{collectionId:e,itemId:t}),!t)return void Lg("removeItemById",t);const r=Bm(this.items,i,e),s=function(e,t,n,i){const r=Lm(e,t,n.collectionNodeId),s=[];for(const o of Gm(e,t,i,n)){zh("removeItemById",`Removing '${JSON.stringify(o)}' from collection ${JSON.stringify(n)}`);const e=r.remove(o.elementId);e&&s.push(e)}return s}(this.items,i,r,t);this.commitChanges(s,n)}removeAllItems(e){const[t,n]=this.createTransaction(),i=Bm(this.items,n,e),r=function(e,t,n){let{collectionNodeId:i,parentId:r}=n;const s=Lm(e,t,i);return zh("clearCollection",`Clearing ${r?"sub":""} collection id:${i} ${r?"parentId:":""}${r}`),s.clear(r)}(this.items,n,i);zh("removeAllItems","Removing all items from collection",{collectionId:e}),this.commitChanges(r,t)}moveItem(e,t,n,i){const[r,s]=this.createTransaction(),o=$m(this.items,s,e,t,n,i);zh("moveItem","Moving item",{collectionId:e,from:t,to:n,destinationCollectionId:i}),this.commitChanges(o,r)}getElementIdsOf(e,t,n){const i=this.view,r=Bm(this.items,i,e);return zh("getElementIdsOf","Getting elementIds",{collectionId:e,itemId:t,depth:n}),Gm(this.items,i,t,r,n)}getElementIds(e,t){const n=this.view,i=Bm(this.items,n,e);return zh("getElementIds","Getting elementIds",{collectionId:e,depth:t}),Gm(this.items,n,void 0,i,t)}hasElement(e,t,n){const i=this.view;if(zh("hasElement","Checking if collection has element",{collectionId:e,itemId:t,depth:n}),!Pm(this.items,i,t))return zh("hasElement",`Item ${t} does not exist in tree`,{collectionId:e,itemId:t}),!1;const r=Bm(this.items,i,e);return function(e,t,n,i){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Number.MAX_SAFE_INTEGER;const s=Gm(e,t,n,i,r).next();return zh("hasElement",`hasElement itemId: ${n}, depth: ${r}, first entry:${s.value}`),void 0!==s.value}(this.items,i,t,r e}setBootItem(e,t){!function(e,t,n){L(rm.test(e())),Fh((()=>function(e,t){if(e.has(t))return s.ok();let n=0;const i=[];for(const t of e.keys())if(t!==qg&&t!==zg&&(i.push(t),++n,10===n))return s.fail(m.maxBootKeys(10,i));return s.ok()}(e,t))),e.set(t,n),zh("setRootKey",`set boot item, value ${n}`)}(this.root,e,t)}getBootItem(e){return function(e,t){const n=e.get(t);return zh("getRootKey",`boot item ${void 0===n?"not found.":"found, value:"} ${null!=n?n:""}`),n}(this.root,e)}deleteBootItem(e){return function(e,t){e.has(t)?(e.delete(t),zh("deleteRootKey","deleted boot item")):zh("deleteRootKey","boot item not found")}(this.root,e)}async initializingFirstTime(){zh("initializingFirstTime","Initializing the data store for the first time"),this.createItemsTree(zg),this.createLabelsRegistry(qg)}async hasInitialized(){zh("hasInitialized","Running hasInitialized method"),await Promise.all([this.loadItemsTree(),this.loadLabelsRegistry()]),this.registerAudience(),this.registerTreeListeners(),this.registerRootListeners()}emitMfsEvent(e,t){zh("emitMfsEvent","Emitting",{event:e,arg:t}),this.emit(e,t)}createItemsTree(e){const t=Oh.create(this.runtime);this.root.set(e,t.handle),zh("createItemsTree","Created SharedTree",{key:e})}createLabelsRegistry(e){const t=Lc.create(this.runtime);this.root.set(e,t.handle),zh("createLabelsRegistry","Created ConsensusRegisterCollection",{key:e})}async loadItemsTree(){var e;const t=await(null===(e=this.root.get(zg))||void 0===e?void 0:e.get());L(!!t),this.items=t}async loadLabelsRegistry(){var e;const t=await(null===(e=this.root.get(qg))||void 0===e?void 0:e.get());L(!!t),this.labelTracker=new im(t)}registerAudience(){const e=this.runtime.getAudience();e.on("addMember",(e=>{this.emitMfsEvent("audienceChanged",{clientId:e,status:"add"})})),e.on("removeMember",(e=>{this.emitMfsEvent("audienceChanged",{clientId:e,status:"remove"})}))}registerTreeListeners(){this.items.on(Ju.EditCommitted,(e=>{let{editId:t,local:n,tree:i}=e;const r=i.edits.getIndexOfId(t),s=i.logViewer.getRevisionViewInSession(r),o=function(e,t){zh("getMfsChangeDelta","views root",{viewRoot:e.root,previousViewRoot:t.root});const n=function(e,t){const n=Dg(e),i=Dg(t),r=0===n&&1!=i;return zh("matchItemsCleared","check if change is clearing of root items",{viewItemCount:n,previousViewItemCount:i,isClearing:r}),r?Ng.ok([{kind:"itemsChanged",changeKind:"clear"}]):Ng.fail()}(e,t);if(!0===n.isOK)return zh("getMfsChangeDelta","root items cleared"),n;const i=t.delta(e);if(function(e){return 0===e.added.length&&0===e.removed.length&&0===e.changed.length}(i))return zh("getMfsChangeDelta","No actual diff, ignore changes"),Ng.ok([]);const{delta:r,category:s}=function(e,t,n){if(function(e,t){return 1===t.changed.length&&t.changed[0]===e.root}(e,n)){const{added:i,removed:r}=n;return{delta:bg(e,t,{changed:[],added:i,removed:r}),category:1}}const i=bg(e,t,n);return function(e){if(Sg(e,"i","changed")||Sg(e,"r","changed")){if(wg(e,"added")&&wg(e,"removed"))return!0;if(Sg(e,"r","added")||Sg(e,"r","removed"))return!0}return!1}(i)?{delta:i,category:2}:function(e){return!(!Cg(e,"i","changed")&&!Cg(e,"a","changed")||!(Sg(e,"sv","added")||Sg(e,"sv","removed")||Sg(e,"mv","added")||Sg(e,"mv","removed")||Sg(e,"a","added")||Sg(e,"a","removed")))}(i)?{delta:i,category:3}:function(e){return!(!Sg(e,"es","changed")&&!Sg(e,"i","changed")||!(Sg(e,"e","added")||Sg(e,"e","removed")||Sg(e,"es","added")||Sg(e,"es","removed")))}(i)?{delta:i,category:4}:{delta:i,category:0}}(e,t,i);return zh("getMfsChangeDelta","change category",{category:s}),Fg[s](e,t,r)}(i.currentView,s);if(!o.isOK)return Bh("unrecognizedChangeSequence",h.g.BadRequest,{error:m.unrecognizedChangeSequence(`editId: ${t}`)}),void this.emitMfsEvent("staleDataDetected",null);for(const e of o.value){const{kind:t,...i}=e;this.emitMfsEvent(t,{...i,isLocal:n})}}))}registerRootListeners(){this.root.on("valueChanged",((e,t,n)=>{let{key:i,previousValue:r}=e;const s=n.get(i);this.emitMfsEvent("bootItemsChanged",{isLocal:t,key:i,changeKind:void 0!==s?void 0===r?"add":"update":"remove",previousValue:r,currentValue:s})}))}createTransaction(){const e=new Eh(this.items);return[e,e.startingView]}commitChanges(e,t){if(0===e.length)return void zh("commitChanges","No changes to commit");const n=t.apply(e);if(zh("commitChanges",`edit status: ${n}`),n!==a.Applied)throw m.droppedEdit(n,e);zh("commitChanges","Commiting changes"),t.closeAndCommit(),zh("commitChanges","transaction committed")}async createItemInternal(e,t,n){Fh((()=>function(e,t,n){if(function(e){return Hh(K,e)}(e))return s.fail(m.systemPropertiesProvided());const i=Gh(20,e);if(!1===i.isOK)return i;if(void 0===e.label||!j(e.label))return s.fail(m.invalidLabel());if(void 0!==(null==e?void 0:e.labelId)){const i=P(n,e.label,e.labelId,t);if(!1===i.isOK)return ie)}(e)){const t=Gh(32,e);return!0===t.isOK&&te(e)?function(e){return e.kind!==r.OrderedList?s.fail(m.invalidCollectionKind()):s.ok()}(e):t}return s.ok()}(t,n,this.labelTracker)));const i={id:n,...t};return await this.startLabelTracking(i),zh("createItemInternal","Creating item",{itemId:i.id}),[i,function(e,t,n){const i=function(e,t){const n={};let i=0,r=0;for(const[t,s]of Object.entries(e))void 0!==s?Jm(t)?r++:n[t]={value:Km(s),enumerable:!0}:i++;if(zh("createMfsItemNode",`Skipped ${i} undefined and ${r} immutable property keys`),te(e)){zh("createMfsItemNode","Item is mfs collection");const t=function(e){L(te(e));const t=e[re];return L(!!t),t}(e);n.values={value:Wm(t),enumerable:!0}}return{identifier:t.generateNodeId(),definition:"i",traits:Object.defineProperties({},n),payload:{id:e.id,label:e.label,...e.kind&&{kind:e.kind}}}}(n,e),r=e.convertToStableNodeId(i.identifier);try{e.convertToNodeId(r)}catch(e){throw Lh("invalidStableNodeId","invalidStableNodeId",{compressedId:i.identifier,invalidStableNodeId:r},"insertMfsItem"),m.invalidStableNodeId(r,i.identifier.NodeId)}const s={definition:"x",payload:r};return[...gu.insertTree([i],yu({parent:t.root,label:sm})),...gu.insertTree([s],vu({parent:t.root,label:i.payload.id}))]}(this.items,e,i)]}startLabelTracking(e){const t=(e=>{if(function(e,t){return w(e,t)&&void 0!==e[t]}(e,b)&&w(e,y))return L(j(e.label),m.invalidLabel),L(j(e.labelId),m.invalidLabelId),{label:e.label,labelId:e.labelId}})(e);return zh("startLabelTracking","startTracking",{itemId:e.id}),t?this.labelTracker.track(t.label,t.labelId,e.id):Promise.resolve()}async restartLabelTracking(e,t,n){if(n||n===k){const{label:i,labelId:r}=Dm(this.items,e,t);if(zh("restartLabelTracking","restartTracking",{itemId:t}),n===r)return void zh("restartLabelTracking","newLabelId is equal to old labelId, skipping restartLabelTracking",{itemId:t});if(n!==k){const e=P(this.labelTracker,i,n,t);if(zh("restartLabelTracking","newLabelId is different from RESET_LABEL_ID",{itemId:t}),!1===e.isOK)throw e.error;e.value!==t?await this.labelTracker.track(i,n,t):Bh("restartLabelTracking",h.g.NotAllowed,{message:`newLabelId already claimed by current itemId: ${t}`})}r&&(zh("restartLabelTracking","LabelId exists, untracking",{itemId:t}),await this.labelTracker.untrack(i,r))}}async stopLabelTracking(e,t){const{label:n,labelId:i}=Dm(this.items,e,t);return zh("stopLabelTracking","starting stopTracking",{itemId:t}),i?(zh("stopLabelTracking","Untracking label",{itemId:t}),this.labelTracker.untrack(n,i)):(zh("stopLabelTracking","LabelId not found, skipping"),Promise.resolve())}*getItemByLabelId(e,t,n){const i=this.labelTracker.getItemId(t,n),r=i?this.getItem(i,e):void 0;r&&(yield r)}}Object(Uc.__decorate)([Vh(h.a.SINGLE),Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[Object]),Object(Uc.__metadata)("design:returntype",Promise)],Bg.prototype,"createItem",null),Object(Uc.__decorate)([Vh(h.a.SINGLE),Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[Object,Array]),Object(Uc.__metadata)("design:returntype",Promise)],Bg.prototype,"createCollection",null),Object(Uc.__decorate)([Vh(h.a.NONE),Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String,Array]),Object(Uc.__metadata)("design:returntype",Object)],Bg.prototype,"getMfsItem",null),Object(Uc.__decorate)([Vh(h.a.NONE),Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[Function,String,String]),Object(Uc.__metadata)("design:returntype",Object)],Bg.prototype,"getItemsByLabel",null),Object(Uc.__decorate)([Vh(h.a.NONE),Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String,Function,Array]),Object(Uc.__metadata)("design:returntype",Object)],Bg.prototype,"getItem",null),Object(Uc.__decorate)([Vh(h.a.NONE),Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[Function,Object]),Object(Uc.__metadata)("design:returntype",Object)],Bg.prototype,"getItems",null),Object(Uc.__decorate)([Vh(h.a.SINGLE),se,Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String]),Object(Uc.__metadata)("design:returntype",Promise)],Bg.prototype,"deleteItem",null),Object(Uc.__decorate)([Vh(h.a.SINGLE),se,Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String,String]),Object(Uc.__metadata)("design:returntype",Promise)],Bg.prototype,"deleteItemByLabelId",null),Object(Uc.__decorate)([Vh(h.a.SINGLE),Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[]),Object(Uc.__metadata)("design:returntype",Promise)],Bg.prototype,"deleteItems",null),Object(Uc.__decorate)([Vh(h.a.SINGLE),se,function(e,t,n){const i=n.value;return i?(n.value=function(e,t){return function(e){if(w(e,f)&&!z(null==e?void 0:e.displayText))throw m.invalidDisplayText()}(t),function(e){if(w(e,p)&&!B(null==e?void 0:e.secondaryLabels))throw m.invalidSecLabel()}(t),i.apply(this,[e,t])},n):n},Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String,Object]),Object(Uc.__metadata)("design:returntype",Promise)],Bg.prototype,"patchItem",null),Object(Uc.__decorate)([Vh(h.a.SINGLE),function(e,t,n){const i=n.value;return i?(n.value=function(e,t,n){return F("itemId",e),q(t),function(e,t){if(_(t)&&("labelId"===e||"displayText"===e))throw m.deltaNotAllowed(e)}(t,n),function(e,t){if(e===f&&!z(t))throw m.invalidDisplayText()}(t,n),function(e,t){if(e===p)if(_(t)){if(!(e=>{const t=e=>e.some((e=>!e||!C(e)||!j(e))),n=e[ce],i=e[le];return(n||i)&&(!n||!t(n))&&(!i||!t(i))})(t))throw m.invalidSecLabelsDelta()}else if(e===p&&!B(t))throw m.invalidSecLabel()}(t,n),i.apply(this,[e,t,n])},n):n},Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String,String,Object]),Object(Uc.__metadata)("design:returntype",Promise)],Bg.prototype,"setItemProperty",null),Object(Uc.__decorate)([Vh(h.a.SINGLE),oe,Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String,String]),Object(Uc.__metadata)("design:returntype",Promise)],Bg.prototype,"deleteItemProperty",null),Object(Uc.__decorate)([Vh(h.a.NONE),oe,Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String,String]),Object(Uc.__metadata)("design:returntype",Object)],Bg.prototype,"getItemProperty",null),Object(Uc.__decorate)([Vh(h.a.SINGLE),em,Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String,Object,String]),Object(Uc.__metadata)("design:returntype",void 0)],Bg.prototype,"addRelatedItem",null),Object(Uc.__decorate)([Vh(h.a.SINGLE),Yh,Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String,Object,Array]),Object(Uc.__metadata)("design:returntype",void 0)],Bg.prototype,"addRelatedItems",null),Object(Uc.__decorate)([Vh(h.a.SINGLE),em,Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String,Object,String]),Object(Uc.__metadata)("design:returntype",void 0)],Bg.prototype,"removeRelatedItem",null),Object(Uc.__decorate)([Vh(h.a.SINGLE),Yh,Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String,Object,Array]),Object(Uc.__metadata)("design:returntype",void 0)],Bg.prototype,"removeRelatedItems",null),Object(Uc.__decorate)([Vh(h.a.NONE),Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String,Object]),Object(Uc.__metadata)("design:returntype",Object)],Bg.prototype,"getRelatedItems",null),Object(Uc.__decorate)([Vh(h.a.NONE),Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String,Object]),Object(Uc.__metadata)("design:returntype",Object)],Bg.prototype,"getAllRelationships",null),Object(Uc.__decorate)([Uh(),se,Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String,Object]),Object(Uc.__metadata)("design:returntype",Object)],Bg.prototype,"getAllRelatedItemsAndRelationships",null),Object(Uc.__decorate)([Vh(h.a.NONE),Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[Object,Object]),Object(Uc.__metadata)("design:returntype",Object)],Bg.prototype,"getCollectionItems",null),Object(Uc.__decorate)([Vh(h.a.NONE),Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String,Object]),Object(Uc.__metadata)("design:returntype",Object)],Bg.prototype,"getItemIdAt",null),Object(Uc.__decorate)([Vh(h.a.SINGLE),function(e,t,n){const i=n.value;return i?(n.value=function(e,t,n){return G(e,t),i.apply(this,[e,t,n])},n):n},Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String,Array,Object]),Object(Uc.__metadata)("design:returntype",Array)],Bg.prototype,"insertItems",null),Object(Uc.__decorate)([Vh(h.a.SINGLE),function(e,t,n){const i=n.value;return i?(n.value=function(e,t,n){return G(e,[t]),i.apply(this,[e,t,n])},n):n},Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String,String,Object]),Object(Uc.__metadata)("design:returntype",Array)],Bg.prototype,"insertItem",null),Object(Uc.__decorate)([Vh(h.a.SINGLE),se,Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String,Object]),Object(Uc.__metadata)("design:returntype",void 0)],Bg.prototype,"removeItemAt",null),Object(Uc.__decorate)([Vh(h.a.SINGLE),function(e,t,n){const i=n.value;return i?(n.value=function(e){ne(e)?D("collectionId",e):(D("collectionId.id",e.id),D("collectionId.parentId",e.parentId));for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return i.apply(this,[e,...n])},n):n},Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[Object,String]),Object(Uc.__metadata)("design:returntype",void 0)],Bg.prototype,"removeItemById",null),Object(Uc.__decorate)([Vh(h.a.SINGLE),Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[Object]),Object(Uc.__metadata)("design:returntype",void 0)],Bg.prototype,"removeAllItems",null),Object(Uc.__decorate)([Vh(h.a.SINGLE),Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String,Object,Object,String]),Object(Uc.__metadata)("design:returntype",void 0)],Bg.prototype,"moveItem",null),Object(Uc.__decorate)([Vh(h.a.NONE),Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[Object,String,Number]),Object(Uc.__metadata)("design:returntype",Object)],Bg.prototype,"getElementIdsOf",null),Object(Uc.__decorate)([Vh(h.a.NONE),Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[Object,Number]),Object(Uc.__metadata)("design:returntype",Object)],Bg.prototype,"getElementIds",null),Object(Uc.__decorate)([Vh(h.a.NONE),Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[Object,String,Number]),Object(Uc.__metadata)("design:returntype",Boolean)],Bg.prototype,"hasElement",null),Object(Uc.__decorate)([Vh(h.a.NONE),Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String]),Object(Uc.__metadata)("design:returntype",String)],Bg.prototype,"getMfsItemKey",null),Object(Uc.__decorate)([Vh(h.a.SINGLE),Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String,String]),Object(Uc.__metadata)("design:returntype",void 0)],Bg.prototype,"setBootItem",null),Object(Uc.__decorate)([Vh(h.a.NONE),Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String]),Object(Uc.__metadata)("design:returntype",Object)],Bg.prototype,"getBootItem",null),Object(Uc.__decorate)([Vh(h.a.SINGLE),Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String]),Object(Uc.__metadata)("design:returntype",void 0)],Bg.prototype,"deleteBootItem",null);const Lg=(e,t)=>Bh(e,h.g.NotFound,{message:`skipped, no change itemId: ${t}.`}),Vg=async(e,t)=>{var n;const i=Ta.create(e),r=i.pathParts[0],s="boolean"==typeof(null===(n=e.headers)||void 0===n?void 0:n.wait)?e.headers.wait:void 0;let o;try{o=await t.getRootDataStore(r,s)}catch(e){return}try{return o.IFluidRouter.request(i.createSubRequest(1))}catch(e){return{status:500,mimeType:"fluid/object",value:e}}};var Ug;!function(e){e.Detached="Detached",e.Attaching="Attaching",e.Attached="Attached"}(Ug||(Ug={}));class Hg extends dr.EventEmitter{constructor(e,t,n){super(),this.appId=e,this.runtime=t,this.context=n,this.appId=e,this.pendingSignalsToSend=[],this.pendingReceivedSignals=[],this.lookingForOtherClients=!0,this.lookingForData=!0,this.selfClientId=this.runtime.clientId,this.listenToSignal(),this.listenToSavedDocumentEvent(),this.listenToOp(),this.isConnectedAndAttached()&&this.findClientsRequest(),this.runtime.on("connected",this.findClientsRequest.bind(this)),this.runtime.on("attached",this.findClientsRequest.bind(this))}isConnectedAndAttaed}sendSignalIfNotReadly}sendSetData(e){this.submitData(e,"setDataSigna")}findClientsReq")}findClientsResponse(){this.selfClientId||(this.selfClientId=this.runtime.clientId),this.selfClientId&&this.submitData({responderClientId:this.selfClientId},"findClientsResponse")}sendSessionDataReq")}sendSessionDataResponse(e){const t=Array.from(e.values()).m()))).redu(t)),[]);this.submitData({internalSessionDataArray:t},"getSessionDataResponse")}submitData(e,t){const n={senderAppId:this.appId,data:e,refSeqNumber:this.runtime.deltaManager.lastSequenceNumber};zh("submitData","submitting signal",{senderAppId:this.appId,signalType:t,refSeqNumber:n.refSeqNumber}),this.isConnectedAndAttached()&&!this.context.containerRuntime.isDirty&&this.sendSignalIfNotReadOnly(this.runtime.deltaManager.readOnlyInfo)?(zh("submitData","Signal submitted",{senderAppId:this.appId,signalType:t,refSeqNumber:n.refSeqNumber}),this.runtime.submitSignal(t,n)):(zh("submitData",`Signal submission is pending; signalType:${t}, appId: ${n.senderAppId}`),this.pendingSignalsToSend.push({signalType:t,data:e}))}listenToSignal(){this.runtime.on("signal",((e,t)=>{if(zh("listenToSignal","Received signal",{type:e.type,local:t}),t&&"setDataSignal"!==e.type&&"deleteDataSignal"!==e.type)return;if(!e.content||"number"!=typeof e.content.refSeqNumber)return;if(e.content.senderAppId!==this.appId)return;const n=e.content;if(L(op(n)Gg}(e.type)),n.refSeqNumber<=this.runtime.deltaManager.lastSequenceNumber){if("findClientsRequest"===e.type||"findClientsResponse"===e.type||"getSessionDataRequest"===e.type||"getSessionDataResponse"===e.type)return this.listenToCatchupSignals(e.type,n);this.emit("signalReceived",e.type,n.data,n.refSeqNumber)}else zh("listenToSignal",`Signal reception is pending; signalType:${e.type}, seqNum: ${n.refSeqNumber}, appId: ${n.senderAppId}`),this.pendingReceivedSignals.push({signalType:e.type,payload:n})}))}listenToCatchupSignals(e,t){if(zh("listenToCatchupSignals","listening catchup signals",{signalType:e}),"findClientsRequest"===e&&this.findClientsResponse(),"findClientsResponse"===e&&(this.lookingForOtherClients=!1,L(dp(t.data)),this.lookingForData&&this.sendSessionDataRequest(t.data.responderClientId)),"getSessionDataRequest"===e&&(L(up(t.data)),t.data.targetClientId===this.selfClientId&&this.emit("signalReceived",e,t.data,t.refSeqNumber)),"getSessionDataResponse"===e){if(!this.lookingForData)return;this.lookingForData=!1,this.emit("signalReceived",e,t.data,t.refSeqNumber)}}listenToSavedDocumentEvent(){this.context.containerRuntime.on("save()}))}resubmitSignal(e,t){return zh("resubmitSignal","Trying to send signal again",{signalType:e}),"setDataSignal"==e?(L(cp(t)),this.sendSetData(t)):"deleteDataSignal"==e?(L(lp(t)),this.sendDeleteData(t)):"findClientsRequest"===e?this.findClientsRequest():"findClientsResponse"===e?(L(dp(t)),this.submitData(t,"findClientsResponse")):"getSessionDataRequest"===e?(L(up(t)),this.submitData(t,"getSessionDataRequest")):"getSessionDataResponse"===e?(L(hp(t)),this.submitData(t,"getSessionDataResponse")):void 0}processPendingSignalsToSend(){const e=this.pendingSignalsToSend.length;zh("processPendingSignalsToSend","processing pending singals",{startingLength:e});for(let t=e-1;t>=0;t-=1){const e=this.pendingSignalsToSend[t];this.resubmitSignal(e.signalType,e.data)}this.pendingSignalsToSend.splice(0,e)}listenToOp(){this.runtime.deltaManager.inbound.on("op",(e=>{this.context.containerRuntime.isDirty||this.processPendingSignalsToSend();for(let e=this.pendingReceivedSignals.length-1;e>=0;e-=1){const t=this.pendingReceivedSignals[e];t.payload.refSeqNumber<=this.runtime.deltaManager.lastSequenceNumber&&(this.emit("signalReceived",t.signalType,t.payload.data,t.payload.refSeqNumber),this.pendingReceivedSignals.splice(e,1))}}))}}const Gg={setDataSignal:!0,deleteDataSignal:!0,findClientsRequest:!0,findClientsResponse:!0,getSessionDataRequest:!0,getSessionDataResponse:!0},$g=S("getMfsItem"),Kg=S("getData"),Wg=(S("initSession"),S("senderAppId")),Jg=S("data"),Qg=S("refSeqNumber"),Xg=S("dataSetId"),Zg=S("sessionDataId"),Yg=S("value"),ep=S("seqNum"),tp=S("dataSetId"),np=S("responderClientId"),ip=S("targetClientId"),rp=S("internalSessionDataArray")t}),op=e=>!!e&&"object"==typeof e&&Wg in e&&Jg in e&&Qg in e,ap=e=>!!e&&"object"==typeof e&&Xg in e&&Zg in e&&Yg in e,cp=e=>(e=>ap(e)&&ep in e)(e),lp=e=>!!e&&"object"==typeof e&&tp in e,dp=e=>!!e&&"object"==typeof e&&np in e,up=e=>!!e&&"object"==typeof e&&ip in e,hp=e=>!!e&&"object"==typeof e&&rp in e;function mp(e){return!!e&&$g i e}var pp,fp;class vp extends jh{constructor(){super(...arguments),pp.set(this,void 0),fp.set(this,void 0)}registerVolatileAudience(e){if(!e)return;const t=this.runtime.getAudience();t.on("addMember",(e=>{this.emitMfsVolatileSessionEvent("audienceChanged",{clientId:e,status:"add"})})),t.on("removeMember",(e=>{this.emitMfsVolatileSessionEvent("audienceChanged",{clientId:e,status:"remove"})}))}initSession(){this.sessionDataMap=new Map,this.signalManager=new Hg(Object(Uc.__classPrivateFieldGet)(this,pp,"f").id,this.runtime,this.context),this.signalManager.on("signalReceived",this.handleDataFromSignal.bind(this))}setHost(e){Object(Uc.__classPrivateFieldSet)(this,pp,e,"f")}getHost(){return Object(Uc.__classPrivateFieldGet)(this,pp,"f")}setId(e){Object(Uc.__classPrivateFieldSet)(this,fp,e,"f")}getId(){return Object(Uc.__classPrivateFieldGet)(this,fp,"f")}setData(e){zh("setData","Setting session data");const t=sp(e,this.runtime.deltaManager.lastSequenceNumber);this.setDataInMap(t,!1),this.signalManager.sendSetData(t)}getData(e,t){const n=this.sessionDataMap.get(e);if(!n)return;const i=n.get(t);if(!i)return;const{seqNum:r,...s}=i;return s}getDataSet(e){return this.getDataSetMapWithoutSeqNum(e)}getAllData(){const e=new Map;for(const t of this.sessionDataMap.keys()){const n=this.getDataSetMapWithoutSeqNum(t);n&&e.set(t,n)}return e}deleteData(e,t){const n=this.sessionDataMap.get(e);n&&n.has(t)&&(n.delete(t),this.signalManager.sendDeleteData({dataSetId:e,sessionDataId:t}))}deleteDataSet(e){this.sessionDataMap.has(e)&&(this.sessionDataMap.delete(e),this.signalManager.sendDeleteData({dataSetId:e}))}getParticip))}handleDataFromSignal(e,t,n){zh("handleDataFromSignal",`Received signal; signalType:${e}, seqNum: ${n}`),"setDataSignal"===e&&this.processSetDataSignal(t,n),"deleteDataSignal"===e&&this.processDeleteDataSignal(t,n),"getSessionDataRequest"===e&&this.processGetSessionDataRequest(),"getSessionDataResponse"===e&&this.processGetSessionDataResponse(t)}processSetDataSignal(e,t){L(ap(e));const n=sp(e,t);this.setDataInMap(n,!0)}processDeleteDataSignal(e,t){if(L(lp(e)),e.sessionDataId)this.processDeleteSessionData(e.dataSetId,e.sessionDataId,t);else{const n=this.sessionDataMap.get(e.dataSetId);Array.from(n?n.keys():(new Map).keys()).mt)}p)}processGetSessionDataResponse(e){L(hp(e)),e.internalSessionDataArray.m!0)))}processDeleteSessionData(e,t,n){const i=this.sessionDataMap.get(e),r=null==i?void 0:i.get(t);i&&r&&r.seqNum<=n&&(i.delete(t),this.processVolatileSessionEvent(e,t,"removed"))}setDataInMap(e,t){const n=e.dataSetId,i=e.sessionDataId,r=this.sessionDataMap.get(n);if(!r){const r=new Map;return r.set(i,e),this.sessionDataMap.set(n,r),void(t&&this.processVolatileSessionEvent(n,i,"set"))}const s=r.get(i);(!s||s.seqNum<=e.seqNum)&&(r.set(i,e),t&&this.processVolatileSessionEvent(n,i,"set})}getDataSetMapWithoutSeqNum(e){const t=this.sessionDataMap.get(e);if(!t)return;const n=new Map;for(const e of t.keys()){const i=t.get(e);if(i){const{seqNum:t,...r}=i;n.set(e,r)}}return n}emitMfsVolatileSessionEvent(e,t){zh("emitMfsVolatileSessionEvent","Emitting volatileSession event"),this.emit(e,t)}}pp=new WeakMap,fp=new WeakMap,Object(Uc.__decorate)([Vh(h.a.SINGLE),Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[Object]),Object(Uc.__metadata)("design:returntype",void 0)],vp.prototype,"setData",null),Object(Uc.__decorate)([Vh(h.a.SINGLE),Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String,String]),Object(Uc.__metadata)("design:returntype",void 0)],vp.prototype,"deleteData",null),Object(Uc.__decorate)([Vh(h.a.SINGLE),Object(Uc.__metadata)("design:type",Function),Object(Uc.__metadata)("design:paramtypes",[String]),Object(Uc.__metadata)("design:returntype",void 0)],vp.prototype,"deleteDataSet",null);const yp="appId",bp="dataStore",Sp="volatileSession",Cp=new Ia("@metaos/mfs-tree",Bg,[Oh.getFactory(l.v0_1_1,void 0),Lc.getFactory()],{},[]),wp=new Ia("@metaos/mfs-volatile-session",class extends)}},[],{},[]),Op=new Map([Cp.registryEntry,wp.registryEntry]),Ip=new class extends class extends clis}async instantiateRuntime(e,t){const n=await this.preInitialize(e,t);return await(t?this.instantiateFromExisting(n):this.instantiateFirstTime(n)),await this.hasInitialized(n),n}async instantiateFirstTime(e){}async instantiateFromExisting(e){}async hasInitial){}}{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=arguments.length>3?arguments[3]:void 0,r=arguments.length>4?arguments[4]:void 0;super(),this.registryEntries=e,this.dependencyContainer=t,this.requestHandlers=n,this.runtimeOptions=i,this.initializeEntryPoint=r,this.registry=new qnry}async instantiateFirstTime(e){await this.containerInitializingFirstTime(e),await this.containerHasInitializede)}async preInitialize(e,t){const n=e.scope,i=new wa(this.dependencyContainer,n.IFluidDependencySynthesizer);n.IFluidDependencySynthesizer=i;const r=await Ss.loadRuntime({context:e,requestHandler:Va(...this.requestHandlers),existing:t,runtimeOptions:this.runtimeOptions,registryEntries:this.registryEntries,containerScope:n,initializeEntryPoint:this.initializeEntryPoint});return i.register(Na.IContainerRuntime,r),r}async containerInitializingFirstTime(e){}async containerHasInitialized(e){}}{constructor(){super(Op,void 0,[Vg])}async containerInitializingFirstTime(e){const t=await e.createDataStore(Cp.type);await t.trySetAlias(bp);const n=await e.createDataStore(wp.type);await n.trySetAlias(Sp)}};class Np{constructor(e,t){Np.throwIfInvalidId(e),this.id=e.trim(),this.dataModelVersion=void 0===(null==t?void 0:t.dataModelVersion)?void 0:"v"+t.dataModelVersion.toString()}static throwIfInvalidId(e){if(I(e))throw m.invalidAppId()}}var Tp;!function(e){e.genericError="genericError",e.throttlingError="throttlingError",e.dataCorruptionError="dataCorruptionError",e.dataProcessingError="dataProcessingError",e.usageError="usageError",e.clientSessionExpiredError="clientSessionExpiredError"}(Tp||(Tp={}));class Ep extends dr.EventEmitter{emitMfsClientEvent(e,t){return zh("emitMfsClientEvent","Emitting",{event:e,arg:t}),this.emit(e,t)}attachEventListeners(e,t){this.attachConnectionStateListeners(e,t),this.attachErrorListeners(e),this.attachRuntimeListeners(e)}attachConnectionStateListeners(e,t){let n;e.on("connected",(e=>{n&&clearTimeout(n),this.emitMfsClientEvent("fluidConnected",{clientId:e})})),e.on("disconnected",(()=>{n=setTimeo")}),t)}))}attachErrorListeners(e){e.on("closed",(e=>{e?(function(e){return e.errorType===Tp.throttlingError}(e)&&this.emitMfsClientEvent("fluidThrottling",{message:e.message,retryAfterSeconds:e.retryAfterSecondor}(e)&&this.emitMfsClientEvent("error",{errorType:"fluidGenericError",error:e.error,message:`${e.errorType}:${e.message}or}(e)&&this.emitMfsClientEvent("error",{errorType:e.errorType===Tp.dataCorruptionError?"fluidDataCorruption":"fluidDataProcessing",message:e.message})):this.emitMfsClientEvent("error",{errorType:"exception",message:"Container was closed."})})),e.on("warning",(e=>{this.emitMfsClientEvent("error",{errorType:"fluidWarning",message:`${e.errorType}:${e.message}`})}))}attachRuntimeListeners(e){e.on("dirty",(e=>{this.emitMfsClientEvent("fluidDirty",{isDirty:e})})),e.on("saved",(e=>{this.emitMfsClientEvent("fluidSaved",{isDirty:e})})),e.on("readonl})}))}}const kp=5e3},nt}},naE4:function(e,t,n){"use strict";const i=n("u8gq"),r=Symbol("max"),s=Symbol("length"),o=Symbol("lengthCalculator"),a=Symbol("allowStale"),c=Symbol("maxAge"),l=Symbol("dispose"),d=Symbol("noDisposeOnSet"),u=Symbol("lruList"),h=Symbol("cache"),m=Symbol("updateAgeOnGet"=>e}c]n}0}}conse)};e.expo)}}},nnHz:function(e,t,n){"use strict";function i(e,t){t=t||{},this._head=0,this._tail=0,this._capacity=t.capacity,this._capacityMask=3,this._list=new Array(4),Array.isArray(e)&&this._fromArray(e)}i.prototype.peekAt=function(e){var t=e;if(t===(0|t)){var n=this.size();if(!(t>=n||t<-n))return t<0&&(t+=n),this._list[t=this._head+t&this._capacityMask]}},i.prototype.get=function(e){return this.peekAt(e)},i.prototype.pd]},i.prototype.peekFront=function(){return this.peek()},i.prototype.peekB1)},Object.defineProperty(i.prototype,"length",{get:function(){return this.size()}}),i.prototype.sl)},i.prototype.unshift=function(e){return void 0===e?this.size():(this._head=this._head-1+this._list.length&this._capacityMask,this._list[this._head]=e,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.pop(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail))},i.prototype.sht}},i.prototype.pl)},i.prototype.n}},i.prototype.removeOne=function(e){var t=e;if(t===(0|t)&&this._head!==this._tail){var n=this.size(),i=this._list.length;if(!(t>=n||t<-n)){t<0&&(t+=n);var r,s=this._list[t=this._head+t&this._capacityMask];if(e<n/2){for(r=e;r>0;r--)this._list[t]=this._list[t=t-1+i&this._capacityMask];this._list[t]=void 0,this._head=this._head+1+i&this._capacityMask}else{for(r=n-1-e;r>0;r--)this._list[t]=this._list[t=t+1+i&this._capacityMask];this._list[t]=void 0,this._tail=this._tail-1+i&this._capacityMask}return s}}},i.prototype.rem}}},i.prototype.spl}}},i.prototype.cl=0},i.prototype.isEmil},i.prototype.toAr1)},i.prototype._fromAr])},i.prototype._copyAr n},i.prototype._growAr|1},i.prototype._shrinkAr=1},e.exports=i},n)}},o})},"p4}}},pRW0:function(e,t,n){"use strict";n.d(t,"a",(function(){return ee}));var i=n("QjXU"),r=n("qDpI"),s=n("/6iw"),o=n("dkAV"),a=n("AVrd"),c=n("WS3M");function l(e,t,n){var i;return null===(i=e.getItemsByLabel((e=>!0),n,t).next())||void 0===i?void 0:i.value}function d(e,t,n){const i=l(e,t,n);if(!i)throw new c.a(`Unable to find target ${n} when it does not exist.`);return i}function u(e,t){return e.reduce(((e,n)=>(0!==e.length&&e[e.length-1].length!==t||e.push([]),e[e.length-1].push(n),e)),[])}const h="updatedAt",m="inUse";class g{constructor(e){this.dataStore=e}async refreshUpdatedAtTimeByIdSafe(e){const t=l(this.dataStore,e,o.e);if(t)return this.refreshUpdatedAtTimeSafe(t)}async refreshUpdatedAtTimeSafe(e){return this.updateMfsItemProperty(e,h,Date.now(),"refreshedUpdatedAtTime")}async updateTagInUseStatus(e,t){let n;try{n=this.dataStore.getItemProperty(e.id,m),a.c.logVerbose("updateTagInUseStatus","Tag inUse property value",{tagItemId:e.id,currentValue:n})}catch(t){a.c.logVerbose("updateTagInUseStatus","Encountered error when reading inUse property, skip and directly update instead.",{error:t,tagItemId:e.id})}if(!n||n!==t)return this.updateMfsItemProperty(e,m,t,"updateTagInUseStatus")}async updateMfsItemProperty(e,t,n,i){try{return a.c.logVerbose("updateMfsItemProperty","Updating property value.",{itemId:e.id,eventName:i}),this.dataStore.setItemProperty(e.id,t,n)}catch(r){Object(s.a)(`Failed to update the property for itemId ${e.id}. Retrying one more time: ${r}`,r,i);try{return this.dataStore.setItemProperty(e.id,t,n)}catch(t){Object(s.a)(`Failed to update the property for ${e.id}: ${t}`,t,i)4}}class f{constructor(e){this.clearCacheFunc=e}async clearCache(){return this.clearCacheFunc()}}var v=n("n3ZG"),y=n("ESz4");class b extends y.a{constructor(e){super(null!=e?e:"Argument exception error",!1,"ArgumentExceptionError",r.g.BadRequest)}}class S extends y.a{constructor(e,t){super(null!=e?e:"Assertion error",!1,null!=t?t:"AssertionError",r.g.NotAllowed)}}class C extends y.a{constructor(e){super(null!=e?e:"Validation error",!1,"ValidationError",r.g.BadRequest)}}const w={type:"contains",direction:"out",kind:v.k.TwoWay},O={...w,direction:"in"},I={type:"tagged",direction:"out",kind:v.k.TwoWay},N={...I,direction:"in"};class T extends c.a{constructor(e){super(null!=e?e:"Unable to find Tag","TagNotFound")}}const E=e=>e.label===o.g;function k(){return e=>e.label===o.e}function j(e){const{type:t,label:n,labelId:i,displayText:r,id:s,origin:o,secondaryLabels:a,kind:c,...l}=e;return{...l,uniqueId:s}}function P(e,t){return e.getItem(t,function(){return e=>e.label===o.g}n}function D(e,t){const n=[];for(const i of t.getRelatedItems(e,I))n.push(j(i));retur)}function R(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const{label:i,labelId:r,displayText:s,id:o,origin:a,secondaryLabels:c,kind:l,...d}=t,u=n?D(t.id,e):[],h={...d,tags:u,uniqueId:r};return h}function F(e,t){if(!e||!e.trim())throw new b(`The ${t} cannot be null, empty or whitespace`)}function q(e){const t=Object.keys(e);if(o.j.soe)))))throw new b(`${o.j.join(", ")} are reserved properties`)}class z{constructor(e,t){this.dataStore=e,this.cardPropertyUtils=t}async patchCard(e,t){q(t);const{uniqueId:n,...i}=t;if(n&&n!==e)throw new b("The unique id provided on the patch property does not match the original");const r=d(this.dataStore,e,o.e);try{return await this.dataStore.patchItem(r.id,i),a.c.logVerbose("patchCard","Patched Card",{itemId:r.id}),this.cardPropertyUtils.refreshUpdatedAtTimeSafe(r)}catch(e){return Promise.reject(Object(s.a)("Failed to patch Card due to unexpected error.",e))}}async addCard(e,t){F(e,"cardId"),F(t,"parentCardId");const n=d(this.dataStore,t,o.e),i=d(this.dataStore,e,o.e);if(this.dataStore.hasElement(n.id,i.id,1))throw new S(`Card ${i.id} is already a child of Parent ${n.id}.`);try{return this.dataStore.insertItem(n.id,i.id,{place:"last"}),this.dataStore.addRelatedItem(n.id,w,i.id),a.c.logVerbose("addCard","Added Card",{parentItemId:n.id,childItemId:i.id}),this.cardPropertyUtils.refreshUpdatedAtTimeSafe(i)}catch(e){return Promise.reject(Object(s.a)("Failed to add a Card due to unexpected error",e))}}removeFromParent(e,t){F(e,"cardId"),F(t,"parentCardId");const n=d(this.dataStore,t,o.e),i=d(this.dataStore,e,o.e);try{for(const e of this.dataStore.getElementIdsOf(n.id,i.id,1))this.dataStore.removeItemAt(n.id,{place:"at",elementId:e.elementId});return this.dataStore.removeRelatedItem(n.id,w,i.id),a.c.logVerbose("removeFromParent","Removed Card",{parentItemId:n.id,childItemId:i.id}),this.cardPropertyUtils.refreshUpdatedAtTimeSafe(i)}catch(e){throw Object(s.a)("Failed to remove Card due to unexpected error.",e)}}async createCard(e){const t=async e=>{const t=await this.dataStore.createCollection(e);return a.c.logVerbose("createCard","Created Card",{itemId:t.id}),this.cardPropertyUtils.refreshUpdatedAtTimeSafe(t)};if(this.validateCardInput(e),e.uniqueId===o.k)return Promise.reject(new C(`Unique Id cannot be equal to a reserved string ${e.uniqueId}.`));const n=this.toMfsCard(e);try{return await t(n)}catch(i){if(i instanceof r.f&&(i.statusCode===r.g.NotAllowed||i.statusCode===r.g.Consensus))try{return l(this.dataStore,e.uniqueId,o.e)?Promise.reject(new C("Failed to create the Card when target Card already exists.")):(a.c.logVerbose("createCard","Failed to create the card. Attemping to delete the existing locked card data before creating the card again."),await this.deleteCard(e.uniqueId),a.c.logVerbose("createCard","Finished attempting to delete the existing locked card data. Attempting to create the card again."),await t(n))}catch(e){return Promise.reject(Object(s.a)("Failed to create the Card due to unexpected error",i))}return Promise.reject(Object(s.a)("Failed to create the Card due to unexpected error",i))}}getCard(e){F(e,"cardId");try{const t=l(this.dataStore,e,o.e);if(!t)return void a.c.logVerbose("getCard","Card not found. Returning.");const n=R(this.dataStore,t);return a.c.logVerbose("getCard","Retrieved Card",{itemId:t.id}),n}catch(e){throw Object(s.a)("Failed to get Card due to unexpected error",e)}}*getCards(e){try{let t;((null==e?void 0:e.top)||(null==e?void 0:e.skip)||(null==e?void 0:e.filter))&&(t={top:e.top,skip:e.skip,filter:e.filter?t=>{const n=R(this.dataStore,t,!0);return e.filter(n)}:void 0});for(const e of this.dataStore.getItems(k(),t)){const t=R(this.dataStore,e,!0);yield t}}catch(e){throw Object(s.a)(`Failed to get Cards due to unexpected error: ${e}`,e,"GetCards")}}async deleteCard(e){F(e,"cardId");const t=l(this.dataStore,e,o.e);if(void 0===(null==t?void 0:t.labelId))try{return a.c.logVerbose("deleteCard","Card was not found. Attempting to clean up a potentially locked labelId."),await this.dataStore.deleteItemByLabelId(o.e,e),void a.c.logVerbose("deleteCard","deleteItemByLabelId has been completed.")}catch(e){throw Object(s.a)(`Failed to delete Card due to unexpected error: ${e}`,e,"DeleteCard")}try{a.c.logVerbose("deleteCard","Retrieved Card",{itemId:t.id});const e=Array.from(this.dataStore.getRelatedItems(t.id,w));if(e.length>0){const n=e.flatMap((e=>e.id));a.c.logVerbose("deleteCard","Card contains children. Attempting to remove all",{itemId:t.id,childItemIds:n}),this.dataStore.removeRelatedItems(t.id,w,n),a.c.logVerbose("deleteCard","Child cards have been unparented from target Card",{itemId:t.id,childItemIds:n})}else a.c.logVerbose("deleteCard","Card does not contain any children",{itemId:t.id});await this.dataStore.deleteItemByLabelId(t.label,t.labelId),a.c.logVerbose("deleteCard","Card has been deleted",{itemId:t.id})}catch(e){throw Object(s.a)(`Failed to delete Card due to unexpected error: ${e}`,e,"DeleteCard")}}validateCardInput(e){if(!e)throw new b("Provided CardInput value cannot be null or undefined");if(!(e=>!!e&&"name"in e&&"type"in e&&"uniqueId"in e&&"object"==typeof e.type&&"string"==typeof e.type.value)(e))throw new b("Provided value is not defined as valid CardInput.");q(e)}toMfsCard(e){const{uniqueId:t,...n}=e;return{...n,label:o.e,labelId:t,displayText:e.name,kind:v.g.OrderedList}}}class B extends c.a{constructor(e){super(null!=e?e:"Card not found","CardNotFound")}}var L=n("hBZP"),V=n.n(L);class U extends V.a{emitScopedFolderEvent(e,t,n){a.c.logVerbose("emitScopedFolderEvent","Emitting event",{eventName:n});const i={...t,subscribedUniqueId:e};this.emit(n,i)}emitUnscopedFolderEvent(e,t){a.c.logVerbose("emitUnscopedFolderEvent","Emitting event",{eventName:t}),this.emit(t,e)}}class H{constructor(e,t){this.datastore=e,this.cardClient=t,this.emitterRegistered=!1,this.collectionChangedCallback=e=>{try{if("add"===e.changeKind){if(e.label===o.e){const[,t]=this.getMfsCardAndCardOrThrow(e.collectionId);this.eventEmitter.emitUnscopedFolderEvent({card:t},"cardCreated")}}else"addElement"===e.changeKind?this.fireIfTagContainer(e,"tagCreated"):"removeElement"!==e.changeKind&&"clear"!==e.changeKind||this.fireIfTagContainer(e,"tagDeleted")}catch(e){return}},this.propertyChangedCallback=e=>{try{switch(e.label){case o.g:{const[,t]=this.getMfsTagAndTagOrThrow(e.itemId);this.eventEmitter.emitUnscopedFolderEvent({tag:t},"tagPatched");break}case o.e:{if(this.isUpdatedAtTimePropertyChange(e))break;const[,t]=this.getMfsCardAndCardOrThrow(e.itemId);this.emitToAllParents([e.itemId],{patchedCard:t},"cardPatched")}}}catch(e){return}},this.relationshipChangedCallback=e=>{try{if(e.relationship.kind===v.k.TwoWay&&"in"===e.relationship.direction)return;switch(e.relationship.type){case"tag contained":return void("add"===e.changeKind||"update"===e.changeKind?this.emitTagCreatedEvent(e):"remove"===e.changeKind&&this.emitTagDeletedEvent(e));case I.type:return void("add"===e.changeKind||"update"===e.changeKind?this.emitTaggedEvent(e):"remove"===e.changeKind&&this.emitUntaggedEvent(e));case w.type:return void("add"===e.changeKind||"update"===e.changeKind?this.emitCardAddedEvent(e):"remove"===e.changeKind&&this.emitCardRemovedEvent(e))}}catch(e){return}},this.staleDataDetectedCallb")},this.eventEmitter=new U}onScopedEvent(e,t,n){this.registerMfsEvents();cons,n);return this.eventEmitter.addListener(t,i),()=>{a.c.logVerbose("onScopedEvent","Removing listener for event",{eventType:t}),this.eventEmitter.removeListener(t,i)}}onUnscopedEvent(e,t){return this.registerMfsEvents(),this.eventEmitter.addListener(e,t),()=>{a.c.logVerbose("onUnscopedEvent","Removing listener for event",{eventType:e}),this.eventEmitter.removeListener(e,t)}}callbackWrapper(e,t,n){"subscribedUniqueId"in t&&t.subscribedUniqueId===e&&(a.c.logVerbose("callbackWrapper","Emitting event",{eventType:typeof t}),n(t))}isSubscrib>0}registerMfsEvents(){!0!==this.emitterRegistered?(a.c.logVerbose("registerMfsEvents","Registering Mfs events"),this.datastore.on("propertyChanged",this.propertyChangedCallback),this.datastore.on("collectionChanged",this.collectionChangedCallback),this.datastore.on("relationshipChanged",this.relationshipChangedCallback),this.datastore.on("staleDataDetected",this.staleDataDetectedCallback),this.emitterRegistered=!0):a.c.logVerbose("registerMfsEvents","Mfs event emitter already registered")}fireIfTagContainer(e,t){if(e.label===o.f&&(this.getMfsItemOrThrow(e.collectiono.k)),"elements"in e))for(const n of e.elements){const[,e]=this.getMfsTagAndTagOrThrow(n.itemId);this.eventEmitter.emitUnscopedFolderEvent({tag:e},t)}}emitTagCreatedEvent(e){const t="tagCreated";if(!this.isSubscribedTo(t))return;const[,n]=this.getMfsTagAndTagOrThrow(e.relatedItemId);this.eventEmitter.emitUnscopedFolderEvent({tag:n},t)}emitTagDeletedEvent(e){const t="tagDeleted";if(!this.isSubscribedTo(t))return;const[,n]=this.getMfsTagAndTagOrThrow(e.relatedItemId);this.eventEmitter.emitUnscopedFolderEvent({tag:n},t)}emitTaggedEvent(e){const t="tagged";if(!this.isSubscribedTo(t))return;const[n,i]=this.getMfsCardAndCardOrThrow(e.itemId),[,r]=this.getMfsTagAndTagOrThrow(e.relatedItemId),s={tag:r,taggedCard:i};this.eventEmitter.emitScopedFolderEvent(i.uniqueId,s,t),this.emitToAllParents([n.id],s,t)}emitUntaggedEvent(e){const t="untagged";if(!this.isSubscribedTo(t))return;const n=this.getMfsCardAndCardOrThrow(e.itemId),i={tag:this.getMfsTagAndTagOrThrow(e.relatedItemId)[1],untaggedCard:n[1]};this.eventEmitter.emitScopedFolderEvent(n[1].uniqueId,i,t),this.emitToAllParents([n[0].id],i,t)}emitCardAddedEvent(e){const t="cardAdded";if(!this.isSubscribedTo(t))return;const[n,i]=this.getMfsCardAndCardOrThrow(e.itemId),[,r]=this.getMfsCardAndCardOrThrow(e.relatedItemId),s={addedCard:r,parentCard:i};this.eventEmitter.emitScopedFolderEvent(r.uniqueId,s,t),this.eventEmitter.emitScopedFolderEvent(i.uniqueId,s,t),this.emitToAllParents([n.id],s,t)}emitCardRemovedEvent(e){const t="cardRemoved";if(!this.isSubscribedTo(t))return;const[n,i]=this.getMfsCardAndCardOrThrow(e.itemId),[,r]=this.getMfsCardAndCardOrThrow(e.relatedItemId),s={removedCard:r,parentCard:i};this.eventEmitter.emitScopedFolderEvent(r.uniqueId,s,t),this.eventEmitter.emitScopedFolderEvent(i.uniqueId,s,t),this.emitToAllParents([n.id],s,t)}getMfsCardAndCardOrThrow(e){const t=this.getMfsItemOrThrow(e,k());return[t,R(this.datastore,t)]}getMfsTagAndTagOrThrow(e){const t=this.getMfsItemOrThrow(e,E);return[t,j(t)]}getMfsItemOrThrow(e,t){const n=this.datastore.getItem(e,t);if(!n)throw new B(`CardId ${e} not found`);return a.c.logVerbose("getMfsItemOrThrow","Retrieved MfsItem",{itemId:n.id}),n}emitToAllParents(e,t,n){a.c.logVerbose("emitToAllParents","Emitting event to all parents of affected mfsItems.",{eventType:n,affectedItemIds:e});for(const i of function*(e,t){const n=new Set;t.forEach((e=>n.add(e)));const i=n.values();for(const t of i)for(const i of e.getRelatedItems(t,O))i.label===o.e&&i.labelId&&!n.has(i.id)&&(n.add(i.id),yield i.labelId)}(this.datastore,e))this.eventEmitter.emitScopedFolderEvent(i,t,n);a.c.logVerbose("emitToAllParents","Finished emitting event to all parents of affected mfsItems.",{eventType:n,affectedItemIds:e})}isUpdatedAtTimePropertyChange(e){return this.datastore.getMfsItemKey(h)in e.changedProperties}}Object(i.__decorate)([Object(a.b)()],H.prototype,"emitTagCreatedEvent",null),Object(i.__decorate)([Object(a.b)()],H.prototype,"emitTagDeletedEvent",null),Object(i.__decorate)([Object(a.b)()],H.prototype,"emitTaggedEvent",null),Object(i.__decorate)([Object(a.b)()],H.prototype,"emitUntaggedEvent",null),Object(i.__decorate)([Object(a.b)()],H.prototype,"emitCardAddedEvent",null),Object(i.__decorate)([Object(a.b)()],H.prototype,"emitCardRemovedEvent",null);class G extends S{constructor(e){super(null!=e?e:"Illegal State Exception","IllegalStateException")}}clas)}async internalInit(){if(this.dataStore.on("bootItemsChanged",(e=>{var t;e.key===o.k&&(a.c.logVerbose("bootItemsChanged","Boot item changed",{event:e}),this.tagContainerId=e.currentValue?null===(t=this.dataStore.getMfsItem(e.currentValue))||void 0===t?void 0:t.id:void 0)})),this.tagContainerId=this.dataStore.getBootItem(o.k),!this.tagContainerId){let e;try{a.c.logVerbose("internalInit","No Tag Container BootItem exists. Creating tag container"),e=(await this.dataStore.createCollection({label:o.f,displayText:o.f,labelId:o.k,kind:v.g.OrderedList})).id}catch(t){e=d(this.dataStore,o.k,o.f).id,a.c.logVerbose("internalInit","Tag Container BootItem did not exist, but found tag container item.",{itemId:e})}a.c.logVerbose("internalInit","Setting Tag Container BootItem.",{itemId:e}),this.dataStore.setBootItem(o.k,e)}}static async initialize(e,t,n){const i=new $(e,t,n);return await i.internalInit(),i}async tag(e,t){const n=this.validateAndEnumerateValues(e,"cardId"),i=this.validateAndEnumerateValues(t,"tagId").m,e))),r=u(i,o.d),s=[];let c=0;for(const e of n){const t=l(this.dataStore,e,o.e);if(!t){a.c.logVerbose("tag","Card does not exist. Continuing with batch."),c++;continue}let n=0;for(const e of r)try{const i=e.map((e=>e.id));this.dataStore.addRelatedItems(t.id,I,i),a.c.logVerbose("tag","Tagged Card",{cardItemId:t.id,tagItemIds:i}),n+=e.length}catch(e){s.push(t.id),c++}a.c.logCustomMetric("TagsPerCardCount","Tagged Card",{card:t.id,count:n},"tag"),await this.cardPropertyUtils.refreshUpdatedAtTimeSafe(t)}for(const e of i)Array.from(this.dataStore.getRelatedItems(e.id,N)).length>0&&await this.cardPropertyUtils.updateTagInUseStatus(e,!0);if(a.c.logCustomMetric("CardTaggedCount","Card Tagged Total",{taggedCount:Math.abs(n.length-c)},"tag"),c>0)throw new S(`Failed to tag ${c} Cards to due unexpectd error: ${s.length>0?`Cards ${s.join(", ")} could not be tagged`:"No valid Card found"}. The rest Cards were tagged successfully.`)}async untag(e,t){const n=this.validateAndEnumerateValues(e,"cardId"),i=this.validateAndEnumerateValues(t,"tagId"),r=[];if(i.forEach((e=>{const t=P(this.dataStore,e);t?r.push(t):a.c.logVerbose("untag","Skip untagging as target Tag does not exist",{tagItemId:e})})),0===r.length)return void a.c.logVerbose("untag","No valid Tags found. Skip untagging Cards and terminate the call.",{tagItemIds:i});const s=u(r,o.d),c=[];let d=0;for(const e of n){const t=l(this.dataStore,e,o.e);if(!t){a.c.logVerbose("untag","Card does not exist. Continuing with batch."),d++;continue}let n=0;for(const e of s){const i=e.map((e=>e.id));try{this.dataStore.removeRelatedItems(t.id,I,i),a.c.logVerbose("untag","Untagged Card",{cardItemId:t.id,tagItemIds:i}),n+=i.length}catch(e){const n=i.map((e=>{var n;return null===(n=this.findTagForCardId(t.id,e))||void 0===n?void 0:n.id})).filter((e=>void 0!==e));n.length>0&&(a.c.logVerbose("untag","Failed to untag Card",{cardItemId:t.id,attachedTagItemIds:n}),c.push(t.id))}}a.c.logCustomMetric("UntagsPerCardCount","Untagged Card",{card:t.id,count:n},"untag"),await this.cardPropertyUtils.refreshUpdatedAtTimeSafe(t)}for(const e of r)0===Array.from(this.dataStore.getRelatedItems(e.id,N)).length&&await this.cardPropertyUtils.updateTagInUseStatus(e,!1);if(a.c.logCustomMetric("CardsUntaggedCount","Cards Untagged Total",{untaggedCount:Math.abs(n.length-d)},"untag"),d>0)throw new S(`Failed to untag ${d} Cards to due unexpectd error: ${c.length>0?`Cards ${c.join(", ")} could not be tagged`:"No valid Card found"}. The rest Cards were untagged successfully.`)}async patchTag(e,t){F(e,"tagId"),q(t);try{const n=M(this.dataStore,e),i=this.preparePatch(e,n,t);if(!i)return void a.c.logVerbose("patchTag","No differences found for Tag. Returning with no actions.",{tagItemId:e});if(await this.dataStore.patchItem(n.id,i),"value"in i){const e=this.findPositionInCollection(i,!0),t=Array.from(this.dataStore.getElementIdsOf(this.tagContainerIdDefined,n.id))[0];e&&t?this.dataStore.moveItem(this.tagContainerIdDefined,{place:"at",elementId:t.elementId},e):a.c.logVerbose("patchTag","A new position or elementId could not be found for Tag.",{tagItemId:n.id})}for(const e of this.dataStore.getRelatedItems(n.id,N))await this.cardPropertyUtils.refreshUpdatedAtTimeSafe(e);a.c.logVerbose("patchTag","Patched tag",{tagItemId:n.id})}catch(t){return Promise.reject(t instanceof C||t instanceof b?t:Object(s.a)(`Failed to patch tag ${e} due to unexpected error.`,t))}}async deleteTag(e){F(e,"tagId");try{const t=P(this.dataStore,e);if(!t)return;return await this.removeRelationships(t.id,N),this.dataStore.removeItemById(this.tagContainerIdDefined,null==t?void 0:t.id),a.c.logVerbose("deleteTag","Deleting tag",{tagItemId:t.id}),this.dataStore.deleteItem(e)}catch(e){return Promise.reject(Object(s.a)("Failed to delete tag due to unexpected error",e))}}*getTags(e){for(const t of this.getAllMfsTags()){const n=j(t);e&&e.filter&&!e.filter(n)||(yield n)}}async createTag(e){if(this.validateTag(e),void 0!==_(this.dataStore,e.value))throw new C("Failed to create Tag when target Tag already exists.");try{const t=this.toMfsTag(e),n=await this.dataStore.createItem(t),i=this.findPositionInCollection(n,!1);return i&&this.dataStore.insertItem(this.tagContainerIdDefined,n.id,i),a.c.logVerbose("createTag","Created tag",{tagItemId:n.id}),n.id}catch(e){return Promise.reject(Object(s.a)("Failed to create tag due to unexpected error",e))}}getTag(e){F(e,"tagId");try{const t=P(this.dataStore,e);if(!t)return;return a.c.logVerbose("getTag","Retrieved tag",{tagItemId:t.id}),j(t)}catch(e){throw Object(s.a)("Failed to get tag due to unexpected error",e)}}getTagByValue(e){F(e,"tagValue");try{const t=_(this.dataStore,e);if(!t)return;return a.c.logVerbose("getTagByValue","Retrieved tag",{tagItemId:t.id}),j(t)}catch(e){throw Object(s.a)("Failed to get tag due to unexpected error",e)}}preparePatch(e,t,n){const{uniqueId:i,...r}=n,s={...r};if(!("value"in s))return s;const o=n.value;if(!o)throw new b("Failed to patch tag when the 'value' field is null or undefined.");this.validateTagValueLength(o);const c=x(o);if(c===t.value){const{value:t,...n}=s;return a.c.logVerbose("preparePatch","No update to value for Tag.",{tagItemId:e}),n}const l=_(this.dataStore,o);if(l&&l.id!==e)throw new C("The new Tag value provided already exists.");return{...s,labelId:A(o),displayText:c,value:c}}compareFunc})}findPositionInCollection(e,t,n){if(n||(n=this.compareFunction),!this.tagContainerId)throw new S("Tag Container undefined");let i,r=0;for(const t of this.dataStore.getCollectionItems(this.tagContainerId)){const s=t.item;if(e.displayText.toLocaleLowerCase()!==s.displayText.toLocaleLowerCase()){if(r++,!(n(e,s)>=0)){i={place:"before",elementId:t.elementId};break}i={place:"after",elementId:t.elementId}}}if(!t||0!==r)return i||(i={place:"last"}),i;a.c.logVerbose("findPositionInCollection","No position in Tag Collection found for Tag",{tagItemId:e.id})}async removeRelationships(e,t){const n=Array.from(this.dataStore.getRelatedItems(e,t));0!==n.length?(this.dataStore.removeRelatedItems(e,t,n.map((e=>e.id))),t.type===N.type&&n.forEach((async e=>{await this.cardPropertyUtils.refreshUpdatedAtTimeSafe(e)}))):a.c.logVerbose("removeRelationships","No related items found for mfsItem for the relationshipType",{itemId:e,relationshipType:t.type})}*getAllMfsTags(){for(const e of this.dataStore.getCollectionItems(this.tagContainerIdDefined))yield e.item}findTagForCardId(e,t){for(const n of this.dataStore.getRelatedItems(e,I))if(n.id===t)return a.c.logVerbose("findTagForCardId","Found Tag for Card.",{tagItemId:t,cardItemId:e}),n;a.c.logVerbose("findTagForCardId","Could not find Tag for Card.",{tagItemId:t,cardItemId:e})}validateAndEnumerateValues(e,t){const n=Array.isArray(e)?e:[e];if(0===n.length)throw new G(`No values for ${t} were passed in.`);const i=new Set;for(const e of n)F(e,t),i.add(e);return Array.from(i.values())}toMfsTag(e){const{uniqueId:t,...n}=e;return{...n,label:o.g,labelId:A(e.value),displayText:x(e.value),inUse:!1}}validateTag(e){if(!e)throw new b("Provided Tag value cannot be null or undefined.");if(!(e=>!!e&&"value"in e&&"string"==typeof e.value)(e))throw new b("Provided value is not defined as a valid Tag.");q(e),F(e.value,"tagValue"),this.validateTagValueLength(e.value)}validateTagValueLength(e){const t=this.configurationManager.getUserTagMaxLength();if(e.length>t)throw new C(`Tag value cannot exceed maximum allowed length of ${t} characters.`)}}function K(e,t,n){return e.sort(((e,i)=>n?n(t,e,i):Q(t,e,i:Q}Object(i.__decorate)([Object(a.b)()],$.prototype,"preparePatch",null),Object(i.__decorate)([Object(a.b)()],$.prototype,"findPositionInCollection",null),Object(i.__decorate)([Object(a.b)()],$.prototype,"removeRelationships",null),Object(i.__decorate)([Object(a.b)()],$.prototype,"getAllMfsTags",null),Object(i.__decorate)([Object(a.b)()],$,"initialize",null);const J=function(e,t,n){return e(t).toString().localeCompare(e(n).toString())},Q=function(e,t,n){return e(n).toString().localeCompare(e(t).toString())};class X{constructor(e){this.dataStore=e}retrieve(e){const t=l(this.dataStore,e.cardId,o.e);if(!t)return[].values();try{const n=[],i=[],r=new Set;for(i.push([t,0]),r.add(t.id);i.length>0;){const t=i.shift();if(!t)continue;const[s,a]=t;if(a<o.l)for(const{item:e}of this.dataStore.getCollectionItems(s.id))r.has(e.id)||(r.add(e.id),i.push([e,a+1]));const c=R(this.dataStore,s);e.query&&e.query.filter&&!e.query.filter(c)||n.push(c)}return K(n,(e=>{var t;return null!==(t=e.updatedAt)&&void 0!==t?t:0}),W(e.order)).values()}catch(e){throw Object(s.a)("An unexpected error has happened, please try again.",e)}}}Object(i.__decorate)([Object(a.a)(r.a.SINGLE,void 0,"viewByFull")],X.prototype,"retrieve",null);class Z{constructor(e){this.dataStore=e}retrieve(e){if(0===e.tagIds.length)return[].values();try{const t=[],n=new Set;return new Set(e.tagIds).forEach((i=>{var r;const s=P(this.dataStore,i);if(s&&(!e.query||!e.query.filter||(null===(r=e.query)||void 0===r?void 0:r.filter(j(s)))))for(const e of this.dataStore.getRelatedItems(s.id,N)){const i=R(this.dataStore,e,!0);n.has(i.uniqueId)||(n.add(i.uniqueId),t.push(i))}})),function*(e){for(const t of e)t.tags=K(t.tae()),J),yield t}(K:0}),W(e.order)))}catch(e){throw Object(s.a)("An unexpected error has happened, please try again.",e)}}}Object(i.__decorate)([Object(a.a)(r.a.SINGLE,void 0,"viewByTag")],Z.prototype,"retrieve",null);class Y{constructor(e){this.dataStore=e}viewBy(e,t){if(!t)throw new b("View criteria must be defined.");switch(function(e,t){t in e&&F(e.cardId,t)}(t,"cardId"),e){case"fullView":return new X(this.dataStore).retrieve(t);case"tagView":return new Z(this.dataStore).retrieve(t);default:throw new b(`Unable to determine ViewKind of ${e}`)}}}class ee{constru=e}static async initialize(e,t,n){const i=new ee(n);return i.cardPropertyUtils=new g(e),i.configurationManager=new p,i.cardClient=new z(e,i.cardPropertyUtils),i.eventClient=new H(e,i.cardClient),i.viewableClient=new Y(e),i.administrationClient=new f(t),i.tagClient=await $.initialize(e,i.cardPropertyUtils,i.configurationManager),i}viewBy(e,t){return this.viewableClient.viewBy(e,t)}onScopedEvent(e,t,n){return this.eventClient.onScopedEvent(e,t,n)}onUnscopedEvent(e,t){return this.eventClient.onUnscopedEvent(e,t)}async createCard(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];await this.cardClient.createCard(e),this.ensureAttachment(t)}ensureAttachment(e){e&&!this.isInitialized&&this.attachmentCallback&&(this.isInitialized=!0,this.attachmentCallback().th")})).catch((e=>{const t=Object(s.a)("Error occurred while trying to attach pod",e,"ensureAttachment");a.c.logError("attachmentError",t.mfsStatusCode,{error:t},t.eventName)})))}patchCard(e,t){return this.cardClient.patchCard(e,t)}getCard(e){return this.cardClient.getCard(e)}addCard(e,t){return this.cardClient.addCard(e,t)}getCards(e){return this.cardClient.getCards(e)}removeFromParent(e,t){return this.cardClient.removeFromParent(e,t)}deleteCard(e){return this.cardClient.deleteCard(e)}tag(e,t){return this.tagClient.tag(e,t)}untag(e,t){return this.tagClient.untag(e,t)}async createTag(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const n=await this.tagClient.createTag(e);return this.ensureAttachment(t),n}patchTag(e,t){return this.tagClient.patchTag(e,t)}getTag(e){return this.tagClient.getTag(e)}getTagByValue(e){return this.tagClient.getTagByValue(e)}getTags(e){return this.tagClient.getTags(e)}deleteTag(e){return this.tagClient.deleteTag(e)}clearCache(){return this.administrationClient.clearCache()}}Object(i.__decorate)([Object(a.a)(r.a.NONE)],ee.prototype,"onScopedEvent",null),Object(i.__decorate)([Object(a.a)(r.a.NONE)],ee.prototype,"onUnscopedEvent",null),Object(i.__decorate)([Object(a.a)(r.a.SINGLE)],ee.prototype,"createCard",null),Object(i.__decorate)([Object(a.a)(r.a.SINGLE)],ee.prototype,"patchCard",null),Object(i.__decorate)([Object(a.a)(r.a.SINGLE)],ee.prototype,"getCard",null),Object(i.__decorate)([Object(a.a)(r.a.SINGLE)],ee.prototype,"addCard",null),Object(i.__decorate)([Object(a.a)(r.a.SINGLE)],ee.prototype,"getCards",null),Object(i.__decorate)([Object(a.a)(r.a.SINGLE)],ee.prototype,"removeFromParent",null),Object(i.__decorate)([Object(a.a)(r.a.SINGLE)],ee.prototype,"deleteCard",null),Object(i.__decorate)([Object(a.a)(r.a.SINGLE)],ee.prototype,"tag",null),Object(i.__decorate)([Object(a.a)(r.a.SINGLE)],ee.prototype,"untag",null),Object(i.__decorate)([Object(a.a)(r.a.SINGLE)],ee.prototype,"createTag",null),Object(i.__decorate)([Object(a.a)(r.a.SINGLE)],ee.prototype,"patchTag",null),Object(i.__decorate)([Object(a.a)(r.a.SINGLE)],ee.prototype,"getTag",null),Object(i.__decorate)([Object(a.a)(r.a.SINGLE)],ee.prototype,"getTagByValue",null),Object(i.__decorate)([Object(a.a)(r.a.SINGLE)],ee.prototype,"getTags",null),Object(i.__decorate)([Object(a.a)(r.a.SINGLE)],ee.prototype,"deleteTag",null),Object(i.__decorate)([Object(a.a)(r.a.SINGLE)],ee.prototype,"clearCache",null)},pwCb:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IFluidDataStoreFactory=void 0,t.IFluidDataStoreFactory="IFluidDataStoreFactory"},"q+t}},qDpI:function(e,t,n){"use strict";n.d(t,"e",(function(){return k})),n.d(t,"a",(function(){return j.a})),n.d(t,"i",(function(){return C.a})),n.d(t,"h",(function(){return P})),n.d(t,"j",(function(){return x})),n.d(t,"k",(function(){return A})),n.d(t,"b",(function(){return M})),n.d(t,"c",(function(){return D})),n.d(t,"l",(function(){return R})),n.d(t,"m",(function(){return F})),n.d(t,"f",(function(){return q.a})),n.d(t,"g",(function(){return r.a})),n.d(t,"d",(function(){return z.a}));var i,r=n("9hJ/"),s=n("czZE"),o=n("7Ndq"),a=n.n(o),c=n("1Yvd"),l=n("QjXU");class d{constructor(e){i.set(this,void 0),this.add=e=>{Object(l.__classPrivateFieldGet)(this,i,"f").length>=1e3&&(this.hasOverflowed||(this.hasOverflowed=!0),Object(l.__classPrivateFieldGet)(this,i,"f").shift()),Object(l.__classPrivateFieldGet)(this,i,"f").push(e)},this.flush=()=>{Object(l.__classPrivateFieldGet)(this,i,"f").forEae())),Object(l.__classPrivateFieldSet)(this,i,[],"f"),this.hasOverflowed=!1},this.empty=()=>{Object(l.__classPrivateFieldSet)(this,i,[],"f"),this.hasOverflowed=!1},Object(l.__classPrivateFieldSet)(this,i,[],"f"),this.hasOverflowed=!1,this.bufferName=e}}i=new WeakMap;class u{constructor(){this.errorBuffer=new d("errorBuffer"),this.warnBuffer=new d("warnBuffer"),this.infoBuffer=new d("infoBuffer"),this.activityBuffer=new d("activityBuffer"),this.metricBuffer=new d("metricBuffer"),this.verboseBuffer=new a.a(100),this.eventStatsBuffer=new r]}getVerboseLogsToSend(){return[...this.verboseBuffer.isEmpty()?[]:this.verboseBuffer.peekN(this.verboseBuffer.size())]}}var h=n("Gstq"),m=n.n(h);const g=m()("mfs");function p(e,t,n,i){const r=g.extend(n);switch(e){case"error":r.log=console.error.bind(console);break;case"trace":r.log=console.log.bind(console);break;case"warn":r.log=console.warn.bind(console);break;default:r.log=console.info.bind(console)}i?r(t,i):r(t)}function f(e,t,n,i){if(!n)return;const r=g.extend(t);switch(e){case"warn":r.log=console.warn.bind(console);break;case"error":r.log=console.error.bind(console)}i?r(n.message,n.error,i):r(n.message,n.error)}var v=n("WAeH"),y=n("A3AF");let b=Object(y.a)(),S=0;var C=n("4KX}`}const O=["domain","podId","mfsServiceDomain","specifiedDomain","podName","podFileName","folderPath","driveId","odspUrl","error","label","labelId","changedProperties","previousCollectionLabel","type","attributes"];function I(e){return e?(O.forEa[t])),e):e}const N=m()("mfs");class T{constructor(e,t,n){this.bufferContainer=n,this.addToBufr(),this.component=e,this.telemetryProcessor=t}isConsoleLoggingEnabled(){const e=this.telemetryProcessor.getContext();return!!e&&e.serviceLoggingInfo.isConsoleLoggingEnabled}logCustomMetric(e,t,n,i,r,s){const o=I(r);this.isConsoleLoggingEnabled()&&p("metric",t,this.component,o);const a=null!=s?s:Date.now(),c=()=>{var r,s;(null===(r=this.telemetryProcessor)||void 0===r?void 0:r.loggerIsInitialized())?null===(s=this.telemetryProcessor)||void 0===s||s.sendCustomTelemetryEvent(e,"metric",i,this.component,t,n,o,a):this.addToBuffer()&&this.bufferContainer.metricBuffer.add(c)};c()}logInfo(e,t,n,i,r){const s=I(i);this.isConsoleLoggingEnabled()&&p("info",t,this.component,s);const o=null!=r?r:Date.now(),a=()=>{var i,r;(null===(i=this.telemetryProcessor)||void 0===i?void 0:i.loggerIsInitialized())?null===(r=this.telemetryProcessor)||void 0===r||r.sendTelemetryEvent(e,"info",n,this.component,t,s,o):this.addToBuffer()&&this.bufferContainer.infoBuffer.add(a)};a()}logVerbose(e,t,n,i){const r=I(n);this.isConsoleLoggingEnabled()&&p("verbose",t,this.component,r),this.bufferContainer.verboseBuffer.enq({op:e,msg:t,params:r,tm:new Date(null!=i?i:Date.now())})}logWarn(e,t,{errorType:n,message:i,error:r},s,o,a){const c=I(o),l=this.getLogErrorInfo({errorType:n,message:i,error:r});f("warn",this.component,l,c);const d=null!=a?a:Date.now(),u=()=>{var n,i;(null===(n=this.telemetryProcessor)||void 0===n?void 0:n.loggerIsInitialized())?null===(i=this.telemetryProcessor)||void 0===i||i.sendTelemetryErrorEvent(w(e),"warn",s,this.component,l,t,void 0,c,d):this.addToBuffer()&&this.bufferContainer.warnBuffer.add(u)};u()}logError(e,t,{errorType:n,message:i,error:r},s,o,a){const c=I(o),l=this.getLogErrorInfo({errorType:n,message:i,error:r});f("error",this.component,l,c);const d=this.bufferContainer.getVerboseLogsToSend(),u=null!=a?a:Date.now(),h=()=>{var n,i;(null===(n=this.telemetryProcessor)||void 0===n?void 0:n.loggerIsInitialized())?null===(i=this.telemetryProcessor)||void 0===i||i.sendTelemetryErrorEvent(w(e),"error",s,this.component,l,t,d,c,u):this.addToBuffer()&&this.bufferContainer.errorBuffer.ah()))};h()}startActivity(e,t,n,i,r){this.isConsoleLoggingEnabled()&&p("info",n,this.component,{activityName:e,operation:i,description:n,logParams:I(r)});const s=function(){S===Number.MAX_SAFE_INTEGER&&(b=Object(y.a)(),S=0);const e=`${S}_${b}`;return S++,e}(),o=Object(v.a)();return new P(e,t,o,i,this.component,s,n)}endActivitySuccess(e,t,n,i){const r=Object(v.a)();this.isConsoleLoggingEnabled()&&p("info","Activity succeeded: %O",this.component,{eventName:e.activityName,duration:r-e.startTime,result:"success",operationName:e.operationName,correlationId:e.correlationId});const s=null!=i?i:Date.now(),o=null!=n?n:r,a=()=>{var n,i;(null===(n=this.telemetryProcessor)||void 0===n?void 0:n.loggerIsInitialized())?null===(i=this.telemetryProcessor)||void 0===i||i.sendActivityEvent("success",e,t,void 0,void 0,o,s):this.addToBuffer()&&this.bufferContainer.activityBuffer.add(a)};a()}endActivityFailure(e,t,n,i){const r=t?{errorType:"exception",message:t.message,error:t}:void 0;r&&this.logActivityErrorToConsole(e,r);const s=this.bufferContainer.getVerboseLogsToSend(),o=null!=n?n:Object(v.a)(),a=null!=i?i:Date.now(),c=()=>{var t,n;(null===(t=this.telemetryProcessor)||void 0===t?void 0:t.loggerIsInitialized())?null===(n=this.telemetryProcessor)||void 0===n||n.sendActivityEvent("failure",e,C.a,r,s,o,a):this.addToBuffer()&&this.bufferContainer.activityBuffer.add(c)};c()}logActivityErrorToConsole(e,t){(null==t?void 0:t.errorType)&&"warning"!=(null==t?void 0:t.errorType)?"exception"==(null==t?void 0:t.errorType)?f("error",this.component,t):this.isConsoleLoggingEnabled()&&p("info","Activity failed: %O",this.component,{eventName:null==e?void 0:e.activityName,duration:Object(v.a)()-e.startTime,result:"failure",operationName:e.operationName,correlationId:e.correlationId}):f("warn",this.component,t)}getLogErrorInfo(e){var t,n;return{errorType:e.errorType,message:null!==(t=e.message)&&void 0!==t?t:null===(n=e.error)||void 0===n?void 0:n.message,error:e.error}}}var E=n("+BZq");class k{constructor(){this.flushAllBuffers=()=>{var e;const t=this.bufferContainer.flushableBuffers.filter((e=>e.hasOverflowed));if(t.length>0){const n={errorType:"TelemetryBufferOverflowError",message:"The following telemetry buffers have overflown: "+t.map((e=>e.bufferName)).join(", ")};null===(e=this.telemetryProcessor)||void 0===e||e.sendTelemetryErrorEvent("TelemetryBufferOverflow","error","flushAllBuffers","telemetry",n,r.a.DataCorruption,this.bufferContainer.getVerboseLogsToSend())}this.bufferContainer.flushableBuffers.forEah()))},this.bufferContainer=new u,this.telemetryProcese)}(this.bufferContainer),this.loggerArray=[],this.telemetryLogger=this.getMfsLogger("telemetrk)}getMfsLogger(e){const t=new T(e,this.telemetryProcessor,this.bufferContainer);return this.loggerArray.push(t),t}setContext(e,t){var n;N.extend("loader").enabled&&p("trace","Setting context: %O","loader",e),null===(n=this.telemetryProcessor)||void 0===n||n.setContext(e,this.telemetryLogger.logVerbose.bind(this.telemetryLogger),t),this.flushAllBuffers(),Object(E.a)((()=>this.flushAllBuffers()))}setPodLocationId(e){this.telemetryProcessor.setPodLocationId(e)}getContext(){return this.telemetryProcessor.getContext()}}var j=n("O7fF");n("8TGV");class P{constructor(e,t,n,i,r,s,o){this.activityName=e,this.activityEventType=t,this.startTime=n,this.operationName=i,this.component=r,this.activityCorrelationId=s,this.description=o,this.correlationId=s}}const _=e=>Boolean(e&&"function"==typeof e.then&&"function"==typeof e.catch),M="Begin",D="End";function x(e){function t(t,n,i){e.logVerbose(n,`${D}: ${t.activityName}`),e.endActivitySuccess(t,i)}function n(t,n,i){e.logVerbose(n,`${D}: ${t.activityName}`),e.endActivityFailure(t,i)}return function(i,s,o){return function(a,c,l){const d=o||c,u=l.value,h=s||C.b;return l.value=function(...s){const o=function(t,n,i,r){const s=`${M}: ${t}`;return e.logVerbose(i,s),e.startActivity(w(t),n,s,t,r)}(d,i,c,{args:s});try{const i=u.apply(this,s);return _(i)?i.catch((e=>{throw n(o,c,e),e})).th,e))):(i&&i.error&&function(t,n,i,r,s){e.logWarn(`${w(t)}`,i,r,n,void 0)}(d,c,r.a.ExpectationFailed,{message:"Failure in log activity result",error:i.error}),t(o,c,h),i)}catch(e){throw n(o,c,e),e}},l}}}function A(e){return function(){return function(t,n,i){const s=n,o=i.value;return i.value=function(...t){e.logVerbose(n,M);let i=!0;try{const a=o.apply(this,t);return _(a)?(i=!1,a.then((e=>e)).finalD)}))):(a&&a.error&&function(t,n,i,r,s){e.logWarn()}`)(t)}`,i,r,n,void 0)}(s,n,r.a.ExpectationFailed,{message:"Failure in log verbose result",error:a.error}),a)}finally{i&&e.logVerbose(n,D)}},i}}}function R(e,t,n){e.logVerbose(t,`${M}: ${t}`);try{return n()}finally{e.logVerbose(t,`${D}: ${t}`)}}async function F(e,t,n){return e.logVerbose(t,M),n().th=>e)).final,D)))}var q=n("ULPR"),z=n("I4it")},qQRf:function(e,t,n){"use strict";n.d(t,"b",(function(){return i})),n.d(t,"a",(function(){return r}));const i=e=>"fluid"===(null==e?void 0:e.type);function r(e){if(!i(e))throw new Error(`resolved is not a Fluid url. Type: ${null==e?void 0:e.type}`)}},rV0Y:function(e,t,n){var i=n("LSEb")(n("s3UK"),"Promise");e.exports=i},rrh1:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IFluidDataStoreRegistry=void 0,t.IFluidDataStoreRegistry="IFluidDataStoreRegistry"},rtkY:function(e,t,n){"use strict";n.d(t,"b",(function(){return a})),n.d(t,"c",(function(){return c})),n.d(t,"a",(function(){return l}));var i=n("hBZP"),r=n("NgDi"),s=n("he5i}}class a extends r.a{constructor(e){super(),this.isDisposed=!1,this.members=new Map(e),this.snapshotCache=e}get disposed(){return this.isDisposed}snapshot(){var e;return null!==(e=this.snapshotCache)&&void 0!==e||(this.snapshotCache=Array.from(this.members)),this.snapshotCache}addMember(e,t){Object(s.a)(!!e,1135),Object(s.a)(!this.members.has(e),462),this.members.set(e,t),this.emit("addMember",e,t),this.snapshotCache=void 0}removeMember(e){Object(s.a)(!!e,1136),Object(s.a)(this.members.has(e),463),this.members.delete(e),this.emit("removeMember",e),this.snapshotCache=vois)}getMember(e){return this.members.get(e)}dispose(){this.isDisposed=!0}}class c extends r.a{constructor(e,t){super(),this.sendProposal=t,this.isDisposed=!1,this.stateEvents=new i.EventEmitter,this.proposals=new Map(e.proposals.map((e=>{let[,t]=e;return[t.sequenceNumber,new o(t.sequenceNumber,t.key,t.value,!1)]}))),this.values=new Map(e.values),this.proposalsSnapshotCache=e.proposals,this.valuesSnapshotCache=e.values}get disposed(){return this.isDisposed}snapshot(){var e,t;return null!==(e=this.proposalsSnapshotCache)&&void 0!==e||(this.proposalsSnapshotCache=Array.from(this.proposals).map((e=>{let[t,n]=e;return[t,{sequenceNumber:t,key:n.key,value:n.value},[]]}))),null!==(t=this.valuesSnapshotCache)&&void 0!==t||(this.valuesSnapshotCache=Array.from(this.values)),{proposals:this.proposalsSnapshotCache,values:this.valuesSnapshotCache}}has(e){return this.values.hasue}getApprovalData(e){return this.values.get(e)}async propose(e,t){const n=this.sendProposal(e,t);if(n<0)throw this.emit("error",{eventName:"ProposalInDisconnectedState",key:e}),new Error("Can't propose in disconnected state");return new Promise(((e,t)=>{let i;const r=(e,t)=>{e===n&&(i=t,this.stateEvents.off("localProposalSequenced",r),this.stateEvents.off("disconnected",o),this.stateEvents.on("localProposalApproved",s))},s=t=>{t===i&&(e(),c())},o=()=>{void 0===i&&this.stateEvents.once("connected",(()=>{void 0===i&&(t(new Error("Client disconnected without successfully sending proposal")),c())}))},a=()=>{t(new Error("QuorumProposals was disposed")),c()a)};this.stateEvents.on("localProposalSequenced",r),this.stateEvents.on("disconnected",o),this.stateEvents.on("disposed",a)}))}addProposal(e,t,n,i,r){Object(s.a)(!this.proposals.has(n),464);const a=new o(n,e,t,i);this.proposals.set(n,a),this.emit("addProposal",a),i&&this.stateEvents.emit("localProposalSequenced",r,n),this.proposalsSnapshotCache=void 0}updateMinimumSequenceNumber(e){const t=e.minimumSequenceNumber,n=[];for(const[e,i]of this.proposals)e<=t&&n.push(i);n.sober));for(const t of n){const n={approvalSequenceNumber:e.sequenceNumber,commitSequenceNumber:-1,key:t.key,sequenceNumber:t.sequenceNumber,value:t.value};this.values.set(n.key,n),this.valuesSnapshotCache=void 0,this.emit("approveProposal",n.sequenceNumber,n.key,n.value,n.approvalSequenceNumber),this.proposals.delete(t.sequenceNumber),this.proposalsSnapshotCache=void 0,t.local&&this.stateEvents.emit("localProposalApproved",t.sequenceNumbe)}}class l extends r.a{constructor(e,t,n,i){super(),this.isDisposed=!1,this.quorumClients=new a(e),this.quorumClients.on("addMembet)})),this.quorumClients.on("removeMember",(e=>{this.emit("removeMember",e)})),this.quorumProposals=new c({proposals:t,values:n},i),this.quorumProposals.on("addProposae)})),this.quorumProposals.on("approveProposal",((e,t,n,i)=>{this.emit("approveProposal",e,t,n,i)}))}get disposed(){return this.isDisposed}close(){this.removeAllListeners()}snapshot(){const e=this.quorumClients.snapshot(),{proposals:t,values:n}=this.quorumProposals.snapshot();return{members:e,proposals:t,values:n}}has(e){return this.quorumProposals.has(e)}get(e){return this.quorumProposals.get(e)}getApprovalData(e){return this.quorumProposals.getApprovalData(e)}addMember(e,t){this.quorumClients.addMember(e,t)}removeMember(e){this.quorumClients.removeMember(e)}getMembers(){return this.quorumClients.getMembers()}getMember(e){return this.quorumClients.getMember)}updateMinimumSequenceNumber(e){this.quorumProposals.updateMinimumSequenceNumber)}}},s=s},s=S},sNwM:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IFluidDataStoreFactory=void 0,t.IFluidDataStoreFactory="IFluidDataStoreFactory"},sXgR:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.totalBlobSizePropertyName=t.CreateSummarizerNodeSource=t.channelsTreeName=t.blobCountPropertyName=t.gcTreeKey=t.gcTombstoneBlobKey=t.gcDeletedBlobKey=t.gcBlobPrefix=t.IFluidDataStoreRegistry=t.IFluidDataStoreFactory=t.VisibilityState=t.FlushModeExperimental=t.FlushMode=void 0;var i=n("EAG+");Object.defineProperty(t,"FlushMode",{enumerable:!0,get:function(){return i.FlushMode}}),Object.defineProperty(t,"FlushModeExperimental",{enumerable:!0,get:function(){return i.FlushModeExperimental}}),Object.defineProperty(t,"VisibilityState",{enumerable:!0,get:function(){return i.VisibilityState}});var r=n("xNzJ");Object.defineProperty(t,"IFluidDataStoreFactory",{enumerable:!0,get:function(){return r.IFluidDataStoreFactory}});var s=n("rrh1");Object.defineProperty(t,"IFluidDataStoreRegistry",{enumerable:!0,get:function(){return s.IFluidDataStoreRegistry}});var o=n("Jrlr");Object.defineProperty(t,"gcBlobPrefix",{enumerable:!0,get:function(){return o.gcBlobPrefix}}),Object.defineProperty(t,"gcDeletedBlobKey",{enumerable:!0,get:function(){return o.gcDeletedBlobKey}}),Object.defineProperty(t,"gcTombstoneBlobKey",{enumerable:!0,get:function(){return o.gcTombstoneBlobKey}}),Object.defineProperty(t,"gcTreeKey",{enumerable:!0,get:function(){return o.gcTreeKey}});var a=n("jjHt");Object.defineProperty(t,"blobCountPropertyName",{enumerable:!0,get:function(){return a.blobCountPropertyName}}),Object.defineProperty(t,"channelsTreeName",{enumerable:!0,get:function(){return a.channelsTreeName}}),Object.defineProperty(t,"CreateSummarizerNodeSource",{enumerable:!0,get:function(){return a.CreateSummarizerNodeSource}}),Object.defineProperty(t,"totalBlobSizePropertyName",{enumerable:!0,get:function(){return a.totalBlobSizePropertyName}})},"so)}},t5Lo:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IFluidDataStoreRegistry=void 0,t.IFluidDataStoreRegistry="IFluidDataStoreRegistry"},"tb:r},t))},u}}},u8gq:function(e,t,n){"use stri.exports=i,i.Node=a,i.create=i,i.prototype.removeN,t},i.prototype.unshiftNode=function(e){if(e!==this.head){e.list&&e.list.removeNode(e);var t=this.head;e.list=this,e.next=t,t&&(t.prev=e),this.head=e,this.tail||(this.tail=e),this.length++}},i.prototype.pushN+}},i.prototype.push=function(){for(var e=0,t=arguments.length;e<t;e++)s(this,arguments[e]);return this.length},i.prototype.unshth},i.prototype.pop=function(){if(this.tail){var e=this.tail.value;return this.tail=this.tail.prev,this.tail?this.tail.next=null:this.head=null,this.length--,e}},i.prototype.she}},i.prototype.forExt},i.prototype.forEachReveev},i.prototype.get=function(e){for(var t=0,n=this.head;null!==n&&t<e;t++)n=n.next;if(t===e&&null!==n)return n.value},i.prototype.getReveue},i.prototype.map=function(e,t){t=t||this;for(var n=new i,r=this.head;null!==r;)n.push(e.call(t,r.value,this)),r=r.next;return n},i.prototype.mapReve n},i.prototype.red n},i.prototype.reduceReve n},i.prototype.toArray=function(){for(var e=new Array(this.length),t=0,n=this.head;null!==n;t++)e[t]=n.value,n=n.next;return e},i.prototype.toArrayReve e},i.prototype.sl n},i.prototype.sliceReve n},i.prototype.spl o},i.prototype.reveis};try{n("p4Q/")(i)}catch(e){}},v)}},vr}},v=i},v)}},w5ta:function(e,t,n){var i=n("PYDc"),r=n("XXCu"),s=n("DZMJ"),o=n("i0JV"),a=n("xKNE");function c(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var i=e[t];this.set(i[0],i[1])}}c.prototype.clear=i,c.prototype.delete=r,c.prototype.get=s,c.prototype.has=o,c.prototype.set=a,e.exports=c},wVje:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.totalBlobSizePropertyName=t.blobCountPropertyName=t.channelsTreeName=t.CreateSummarizerNodeSource=voil"}(t.CreateSummarizerNodeSource||(t.CreateSummarizerNodeSource={})),t.channelsTreeName=".channels",t.blobCountPropertyName="BlobCount",t.totalBlobSizePropertyName="TotalBlobSize"},w}}},w)}},xAP2:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IFluidDataStoreFactory=void 0,t.IFluidDataStoreFactory="IFluidDataStoreFactory"},xs}},xy"},xs}},x=c},y0Qj:function(e,t){t.hashU32=function(e){return-1252372727^(e=(e=(e=374761393+(e=-949894596^(e=2127912214+(e|=0)+(e<<12)|0)^e>>>19)+(e<<5)|0)-744332180^e<<9)-42973499+(e<<3)|0)^e>>>16|0},t.readU64=function(e,t){var n=0;return n|=e[t++]<<0,n|=e[t++]<<8,n|=e[t++]<<16,n|=e[t++]<<24,n|=e[t++]<<32,n|=e[t++]<<40,(n|=e[t++]<<48)|e[t++]<<56},t.readU32=function(e,t){var n=0;return n|=e[t++]<<0,n|=e[t++]<<8,(n|=e[t++]<<16)|e[t++]<<24},t.writeU32=function(e,t,n){e[t++]=n>>0&255,e[t++]=n>>8&255,e[t++]=n>>16&255,e[t++]=n>>24&255},t.i|0}},y)}},y)}},ye}},y=r},zCUP:function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n("1bkS");function r(e,t,n){var r,s;const o=Object.assign({},t),a=n.online;if(o.online="string"==typeof a?a:i.g[Object(i.o)()],"object"==typeof navigator&&null!==navigator){const e=navigator,t=null!==(s=null!==(r=e.connection)&&void 0!==r?r:e.mozConnection)&&void 0!==s?s:e.webkitConnection;null!==t&&"object"==typeof t&&(o.connectionType=t.type)}o.category=Object(i.j)(n)?"generic":"error",e.sendTelemetryEvent(o,n)}},zn}},z)}},ze}},zp}},z)}}}]);
//# sourceMappingURL=99.3ff7af57d6ed153e5b81.chunk.v7.js.map