/*! For license information please see 679.d8913205d24d17b54d6b.chunk.v7.js.LICENSE.txt */
(window.officehome_webpackJsonp=window.officehome_webpackJsonp||[]).push([[679],{"+UOQ":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MoiraLambdaFactory=t.MoiraLambda=void 0;var n=r("EA0Q");Object.defineProperty(t,"MoiraLambda",{enumerable:!0,get:function(){return n.MoiraLambda}});var i=r("7WL8");Object.defineProperty(t,"MoiraLambdaFactory",{enumerable:!0,get:function(){return i.MoiraLambdaFactory}})},"+gGO":function(e,t,r){"use strict";(function(e){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Socket=void 0;const i=r("hBZP"),s=n(r("+lyA")),o=r("ki0U");class a extends i.EventEmitter{constructor(e){super(),this.socket=e,this.pending=[],this.sendScheduled=!1,this.socket.on("error",(t=>{(0,o.debug)(`ws error on connection to ${e.url}`,t),this.emit("error",t)})),this.socket.on("close",((t,r)=>{(0,o.debug)(`ws to ${e.url} close ${t} ${r}`),this.emit("close",t,r)})),this.socket.on("message",(e=>{const t=JSON.parse(e);for(const e of t)this.emit("message",e)}))}static async connect(e,t){const r=new s.default(`ws://${e}/${t}`);return await new Promise(((e,t)=>{const n=e=>t(e);r.on("error",n),r.on("open",(()=>{r.removeListener("error",n),e()}))})),new a(r)}send(t){this.pending.push(t),this.sendScheduled||(this.sendScheduled=!0,e((()=>{(0,o.debug)(`Sending ${this.pending.length} messages`),this.sendBuffers(this.pending),this.pending=[],this.sendScheduled=!1})))}on(e,t){return super.on(e,t),this}sendBuffers(e){this.socket.send(JSON.stringify(e))}}t.Socket=a}).call(this,r("oPUo").setImmediate)},"+gpN":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pkgVersion=t.pkgName=void 0,t.pkgName="@fluidframework/server-services-core",t.pkgVersion="0.1039.1000"},"+lyA":function(e,t,r){"use strict";e.exports=function(){throw new Error("ws does not work in the browser. Browser clients must use the native WebSocket object")}},"+svW":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestThrottlerHelper=t.TestThrottler=t.TestThrottleAndUsageStorageManager=t.TestTenantManager=t.TestTenant=t.TestTopic=t.TestPublisher=t.TestProducer=t.TestKafka=t.TestConsumer=t.TestHistorian=t.writeSummaryTree=t.TestDocumentStorage=t.TestContext=t.TestDbFactory=t.TestDb=t.TestCollection=t.TestClientManager=t.TestNotImplementedDocumentRepository=t.TestDeltaManager=t.TestCache=t.MessageFactory=t.KafkaMessageFactory=t.DebugLogger=void 0;var n=r("KndR");Object.defineProperty(t,"DebugLogger",{enumerable:!0,get:function(){return n.DebugLogger}});var i=r("iPMj");Object.defineProperty(t,"KafkaMessageFactory",{enumerable:!0,get:function(){return i.KafkaMessageFactory}}),Object.defineProperty(t,"MessageFactory",{enumerable:!0,get:function(){return i.MessageFactory}});var s=r("qIk9");Object.defineProperty(t,"TestCache",{enumerable:!0,get:function(){return s.TestCache}});var o=r("MrJ2");Object.defineProperty(t,"TestDeltaManager",{enumerable:!0,get:function(){return o.TestDeltaManager}});var a=r("0SVd");Object.defineProperty(t,"TestNotImplementedDocumentRepository",{enumerable:!0,get:function(){return a.TestNotImplementedDocumentRepository}});var c=r("voNW");Object.defineProperty(t,"TestClientManager",{enumerable:!0,get:function(){return c.TestClientManager}});var u=r("Fazr");Object.defineProperty(t,"TestCollection",{enumerable:!0,get:function(){return u.TestCollection}}),Object.defineProperty(t,"TestDb",{enumerable:!0,get:function(){return u.TestDb}}),Object.defineProperty(t,"TestDbFactory",{enumerable:!0,get:function(){return u.TestDbFactory}});var l=r("UyQ0");Object.defineProperty(t,"TestContext",{enumerable:!0,get:function(){return l.TestContext}});var h=r("am4Q");Object.defineProperty(t,"TestDocumentStorage",{enumerable:!0,get:function(){return h.TestDocumentStorage}}),Object.defineProperty(t,"writeSummaryTree",{enumerable:!0,get:function(){return h.writeSummaryTree}});var d=r("XbCS");Object.defineProperty(t,"TestHistorian",{enumerable:!0,get:function(){return d.TestHistorian}});var m=r("r4Zv");Object.defineProperty(t,"TestConsumer",{enumerable:!0,get:function(){return m.TestConsumer}}),Object.defineProperty(t,"TestKafka",{enumerable:!0,get:function(){return m.TestKafka}}),Object.defineProperty(t,"TestProducer",{enumerable:!0,get:function(){return m.TestProducer}});var p=r("cjJq");Object.defineProperty(t,"TestPublisher",{enumerable:!0,get:function(){return p.TestPublisher}}),Object.defineProperty(t,"TestTopic",{enumerable:!0,get:function(){return p.TestTopic}});var f=r("aKHJ");Object.defineProperty(t,"TestTenant",{enumerable:!0,get:function(){return f.TestTenant}}),Object.defineProperty(t,"TestTenantManager",{enumerable:!0,get:function(){return f.TestTenantManager}});var g=r("9FG3");Object.defineProperty(t,"TestThrottleAndUsageStorageManager",{enumerable:!0,get:function(){return g.TestThrottleAndUsageStorageManager}});var y=r("UkUW");Object.defineProperty(t,"TestThrottler",{enumerable:!0,get:function(){return y.TestThrottler}});var v=r("egDu");Object.defineProperty(t,"TestThrottlerHelper",{enumerable:!0,get:function(){return v.TestThrottlerHelper}})},"/3DN":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SummaryWriter=t.SummaryReader=t.ScribeLambdaFactory=t.ScribeLambda=t.CheckpointManager=void 0;var n=r("6F7b");Object.defineProperty(t,"CheckpointManager",{enumerable:!0,get:function(){return n.CheckpointManager}});var i=r("i1Dz");Object.defineProperty(t,"ScribeLambda",{enumerable:!0,get:function(){return i.ScribeLambda}});var s=r("SVYa");Object.defineProperty(t,"ScribeLambdaFactory",{enumerable:!0,get:function(){return s.ScribeLambdaFactory}});var o=r("UmFD");Object.defineProperty(t,"SummaryReader",{enumerable:!0,get:function(){return o.SummaryReader}});var a=r("dW4G");Object.defineProperty(t,"SummaryWriter",{enumerable:!0,get:function(){return a.SummaryWriter}})},"/3gw":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LocalOrdererConnection=void 0;const n=r("wWog"),i=r("y2M+"),s=r("yQiv");t.LocalOrdererConnection=class{constructor(e,t,r,n,i,s,o,a,c){this.socket=e,this.existing=t,this.producer=n,this.tenantId=i,this.documentId=s,this.clientId=o,this.client=a,this.serviceConfiguration=c,this.maxMessageSize=c.maxMessageSize}async connect(e){const t={clientSequenceNumber:-1,contents:null,data:JSON.stringify({clientId:this.clientId,detail:this.client}),referenceSequenceNumber:-1,traces:this.serviceConfiguration.enableTraces?[]:void 0,type:i.MessageType.ClientJoin,serverMetadata:e},r={clientId:null,documentId:this.documentId,operation:t,tenantId:this.tenantId,timestamp:Date.now(),type:s.RawOperationType};this.submitRawOperation([r])}async order(e){const t=e.map((e=>({clientId:this.clientId,documentId:this.documentId,operation:e,tenantId:this.tenantId,timestamp:Date.now(),type:s.RawOperationType})));this.submitRawOperation(t)}async disconnect(){const e={clientSequenceNumber:-1,contents:null,data:JSON.stringify(this.clientId),referenceSequenceNumber:-1,traces:this.serviceConfiguration.enableTraces?[]:void 0,type:i.MessageType.ClientLeave},t={clientId:null,documentId:this.documentId,operation:e,tenantId:this.tenantId,timestamp:Date.now(),type:s.RawOperationType};this.submitRawOperation([t])}once(e,t){this.producer.once(e,t)}submitRawOperation(e){this.serviceConfiguration.enableTraces&&e.forEach((e=>{var t;const r=e.operation;null===(t=null==r?void 0:r.traces)||void 0===t||t.push({action:"start",service:"alfred",timestamp:n.performance.now()})})),this.producer.send([{contents:e,documentId:this.documentId,tenantId:this.tenantId,type:s.BoxcarType}],this.tenantId,this.documentId)}}},"/UA3":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CopierLambda=void 0;const n=r("MPeK");t.CopierLambda=class{constructor(e,t){this.rawOpCollection=e,this.context=t,this.pendingJobs=new Map,this.currentJobs=new Map}handler(e){const t=(0,n.extractBoxcar)(e),r=`${t.tenantId}/${t.documentId}`,i={index:e.offset,documentId:t.documentId,tenantId:t.tenantId,contents:t.contents.map((e=>e))};let s=this.pendingJobs.get(r);s||(s=[],this.pendingJobs.set(r,s)),s.push(i),this.pendingOffset=e,this.sendPending()}close(){this.pendingJobs.clear(),this.currentJobs.clear()}sendPending(){if(this.currentJobs.size>0||0===this.pendingJobs.size)return;const e=this.currentJobs;this.currentJobs=this.pendingJobs,this.pendingJobs=e;const t=this.pendingOffset,r=[];for(const[,e]of this.currentJobs){const t=this.processMongoCore(e);r.push(t)}Promise.all(r).then((()=>{this.currentJobs.clear(),this.context.checkpoint(t),this.sendPending()}),(e=>{this.context.error(e,{restart:!0})}))}async processMongoCore(e){await this.rawOpCollection.insertMany(e,!1).catch((e=>{if(11e3!==e.code)return Promise.reject(e)}))}}},"0SVd":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestNotImplementedDocumentRepository=void 0;const n="Method not implemented. Provide your own mock.";t.TestNotImplementedDocumentRepository=class{async create(e){throw new Error(n)}async readOne(e){throw new Error(n)}async updateOne(e,t,r){throw new Error(n)}async findOneOrCreate(e,t,r){throw new Error(n)}async findOneAndUpdate(e,t,r){throw new Error(n)}async exists(e){throw new Error(n)}}},"0nFT":function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Lumber=void 0;const i=n(r("a0Z+")),s=r("Twpl"),o=r("wWog"),a=r("pKcq"),c=r("FY09");t.Lumber=class{constructor(e,t,r,n,i){this.eventName=e,this.type=t,this._engineList=r,this._schemaValidators=n,this._startTime=o.performance.now(),this._properties=new Map,this._completed=!1,this.timestamp=Date.now(),this.id=(0,s.v4)(),i&&this.setProperties(i)}get properties(){return this._properties}get durationInMs(){if(this.type!==c.LumberType.Log)return this._durationInMs}get successful(){if(this.type!==c.LumberType.Log)return this._successful}get message(){return this._message}get exception(){return this._exception}get logLevel(){return this._logLevel}setProperty(e,t){return this._properties.set(e,t),this}setProperties(e){return e instanceof Map?0===this._properties.size?this._properties=e:e.forEach(((e,t)=>{this.setProperty(t,e)})):Object.entries(e).forEach((e=>{const[t,r]=e;this.setProperty(t,r)})),this}success(e){this.emit(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:c.LogLevel.Info,!0,void 0)}error(e,t){this.emit(e,arguments.length>2&&void 0!==arguments[2]?arguments[2]:c.LogLevel.Error,!1,t)}isCompleted(){return this._completed}emit(e,t,r,n){if(this._completed)return void(0,c.handleError)(a.LumberEventName.LumberjackError,`Trying to complete a Lumber telemetry operation that has alredy been completed.                [eventName: ${this.eventName}][id: ${this.id}]`,this._engineList);if(this._schemaValidators)for(const e of this._schemaValidators){const t=e.validate(this.properties);t.validationPassed||(0,c.handleError)(a.LumberEventName.LumberjackSchemaValidationFailure,`Schema validation failed for props: ${t.validationFailedForProperties.toString()}.                        [eventName: ${this.eventName}][id: ${this.id}]`,this._engineList)}this._message=e,this._logLevel=t,this._successful=r,n instanceof Error?this._exception=n:void 0!==n&&(this._exception=new Error((0,i.default)(n)));const s=parseFloat(this.properties.get("durationInMs"));this._durationInMs=isNaN(s)?o.performance.now()-this._startTime:s,this._engineList.forEach((e=>e.emit(this))),this._completed=!0}}},"0xfR":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CheckpointReason=void 0,function(e){e[e.EveryMessage=0]="EveryMessage",e[e.IdleTime=1]="IdleTime",e[e.MaxTime=2]="MaxTime",e[e.MaxMessages=3]="MaxMessages",e[e.ClearCache=4]="ClearCache",e[e.NoClients=5]="NoClients"}(t.CheckpointReason||(t.CheckpointReason={}))},"139/":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReservationManager=t.WebSocketSubscriber=t.PubSub=t.NodeManager=t.LocalOrderManager=t.LocalOrderer=t.LocalNodeFactory=t.LocalLambdaController=t.LocalKafka=t.LocalContext=void 0;var n=r("cDE+");Object.defineProperty(t,"LocalContext",{enumerable:!0,get:function(){return n.LocalContext}});var i=r("Axqv");Object.defineProperty(t,"LocalKafka",{enumerable:!0,get:function(){return i.LocalKafka}});var s=r("DjzM");Object.defineProperty(t,"LocalLambdaController",{enumerable:!0,get:function(){return s.LocalLambdaController}});var o=r("SOuT");Object.defineProperty(t,"LocalNodeFactory",{enumerable:!0,get:function(){return o.LocalNodeFactory}});var a=r("3all");Object.defineProperty(t,"LocalOrderer",{enumerable:!0,get:function(){return a.LocalOrderer}});var c=r("uYhO");Object.defineProperty(t,"LocalOrderManager",{enumerable:!0,get:function(){return c.LocalOrderManager}});var u=r("4IaO");Object.defineProperty(t,"NodeManager",{enumerable:!0,get:function(){return u.NodeManager}});var l=r("BZv8");Object.defineProperty(t,"PubSub",{enumerable:!0,get:function(){return l.PubSub}}),Object.defineProperty(t,"WebSocketSubscriber",{enumerable:!0,get:function(){return l.WebSocketSubscriber}});var h=r("DcAE");Object.defineProperty(t,"ReservationManager",{enumerable:!0,get:function(){return h.ReservationManager}})},"1M/W":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NackMessagesType=t.ControlMessageType=t.SystemOperations=t.BoxcarType=t.SystemType=t.SignalOperationType=t.NackOperationType=t.SequencedOperationType=t.RawOperationType=void 0,t.RawOperationType="RawOperation",t.SequencedOperationType="SequencedOperation",t.NackOperationType="Nack",t.SignalOperationType="Signal",t.SystemType="System",t.BoxcarType="boxcar",function(e){e[e.Join=0]="Join",e[e.Leave=1]="Leave"}(t.SystemOperations||(t.SystemOperations={})),function(e){e.UpdateDSN="updateDSN",e.NackMessages="nackMessages",e.LambdaStartResult="lambdaStartResult",e.ExtendClient="extendClient"}(t.ControlMessageType||(t.ControlMessageType={})),function(e){e.SummaryMaxOps="summaryMaxOps"}(t.NackMessagesType||(t.NackMessagesType={}))},"2boo":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NoOpLambda=void 0,t.NoOpLambda=class{constructor(e){this.context=e}handler(e){this.context.checkpoint(e)}close(){}}},"2ozp":function(e,t,r){var n=r("wfEq"),i=r("KSsY"),s=r("pRMk").Buffer,o=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591],a=new Array(160);function c(){this.init(),this._w=a,i.call(this,128,112)}function u(e,t,r){return r^e&(t^r)}function l(e,t,r){return e&t|r&(e|t)}function h(e,t){return(e>>>28|t<<4)^(t>>>2|e<<30)^(t>>>7|e<<25)}function d(e,t){return(e>>>14|t<<18)^(e>>>18|t<<14)^(t>>>9|e<<23)}function m(e,t){return(e>>>1|t<<31)^(e>>>8|t<<24)^e>>>7}function p(e,t){return(e>>>1|t<<31)^(e>>>8|t<<24)^(e>>>7|t<<25)}function f(e,t){return(e>>>19|t<<13)^(t>>>29|e<<3)^e>>>6}function g(e,t){return(e>>>19|t<<13)^(t>>>29|e<<3)^(e>>>6|t<<26)}function y(e,t){return e>>>0<t>>>0?1:0}n(c,i),c.prototype.init=function(){return this._ah=1779033703,this._bh=3144134277,this._ch=1013904242,this._dh=2773480762,this._eh=1359893119,this._fh=2600822924,this._gh=528734635,this._hh=1541459225,this._al=4089235720,this._bl=2227873595,this._cl=4271175723,this._dl=1595750129,this._el=2917565137,this._fl=725511199,this._gl=4215389547,this._hl=327033209,this},c.prototype._update=function(e){for(var t=this._w,r=0|this._ah,n=0|this._bh,i=0|this._ch,s=0|this._dh,a=0|this._eh,c=0|this._fh,v=0|this._gh,b=0|this._hh,S=0|this._al,w=0|this._bl,C=0|this._cl,E=0|this._dl,I=0|this._el,T=0|this._fl,N=0|this._gl,P=0|this._hl,x=0;x<32;x+=2)t[x]=e.readInt32BE(4*x),t[x+1]=e.readInt32BE(4*x+4);for(;x<160;x+=2){var O=t[x-30],M=t[x-30+1],k=m(O,M),L=p(M,O),R=f(O=t[x-4],M=t[x-4+1]),D=g(M,O),F=t[x-32],A=t[x-32+1],j=L+t[x-14+1]|0,q=k+t[x-14]+y(j,L)|0;q=(q=q+R+y(j=j+D|0,D)|0)+F+y(j=j+A|0,A)|0,t[x]=q,t[x+1]=j}for(var B=0;B<160;B+=2){q=t[B],j=t[B+1];var _=l(r,n,i),H=l(S,w,C),V=h(r,S),$=h(S,r),U=d(a,I),K=d(I,a),W=o[B],J=o[B+1],G=u(a,c,v),z=u(I,T,N),Q=P+K|0,X=b+U+y(Q,P)|0;X=(X=(X=X+G+y(Q=Q+z|0,z)|0)+W+y(Q=Q+J|0,J)|0)+q+y(Q=Q+j|0,j)|0;var Z=$+H|0,Y=V+_+y(Z,$)|0;b=v,P=N,v=c,N=T,c=a,T=I,a=s+X+y(I=E+Q|0,E)|0,s=i,E=C,i=n,C=w,n=r,w=S,r=X+Y+y(S=Q+Z|0,Q)|0}this._al=this._al+S|0,this._bl=this._bl+w|0,this._cl=this._cl+C|0,this._dl=this._dl+E|0,this._el=this._el+I|0,this._fl=this._fl+T|0,this._gl=this._gl+N|0,this._hl=this._hl+P|0,this._ah=this._ah+r+y(this._al,S)|0,this._bh=this._bh+n+y(this._bl,w)|0,this._ch=this._ch+i+y(this._cl,C)|0,this._dh=this._dh+s+y(this._dl,E)|0,this._eh=this._eh+a+y(this._el,I)|0,this._fh=this._fh+c+y(this._fl,T)|0,this._gh=this._gh+v+y(this._gl,N)|0,this._hh=this._hh+b+y(this._hl,P)|0},c.prototype._hash=function(){var e=s.allocUnsafe(64);function t(t,r,n){e.writeInt32BE(t,n),e.writeInt32BE(r,n+4)}return t(this._ah,this._al,0),t(this._bh,this._bl,8),t(this._ch,this._cl,16),t(this._dh,this._dl,24),t(this._eh,this._el,32),t(this._fh,this._fl,40),t(this._gh,this._gl,48),t(this._hh,this._hl,56),e},e.exports=c},"3Fwg":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CombinedLambda=void 0,t.CombinedLambda=class{constructor(e){this.lambdas=e}handler(e){const t=[];for(const r of this.lambdas){const n=r.handler(e);void 0!==n&&t.push(n)}return t.length>0?Promise.all(t):void 0}close(e){for(const t of this.lambdas)t.close(e)}}},"3all":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LocalOrderer=void 0;const n=r("9va6"),i=r("iS6B"),s=r("d8Mq"),o=r("YkJt"),a=r("yQiv"),c=r("cDE+"),u=r("Axqv"),l=r("DjzM"),h=r("/3gw"),d=r("gTor"),m=r("BZv8"),p={lastClientSummaryHead:void 0,logOffset:-1,minimumSequenceNumber:-1,protocolState:void 0,sequenceNumber:-1,lastSummarySequenceNumber:0,validParentSummaries:void 0},f={clients:void 0,durableSequenceNumber:0,epoch:0,expHash1:o.defaultHash,logOffset:-1,sequenceNumber:0,signalClientConnectionNumber:0,term:1,lastSentMSN:0,nackMessages:void 0,successfullyStartedLambdas:[],checkpointTimestamp:void 0};class g{constructor(e){this.publisher=e}on(e,t){}to(e){var t=this;return{emit:function(r){for(var n=arguments.length,i=new Array(n>1?n-1:0),s=1;s<n;s++)i[s-1]=arguments[s];return t.publisher.publish(e,r,...i)}}}async close(){}}class y{constructor(e,t,r,n,i,s,o,a,c,u,l,h,d,m,p,f,y){this.setup=e,this.details=t,this.tenantId=r,this.documentId=n,this.taskMessageSender=i,this.tenantManager=s,this.gitManager=o,this.permission=a,this.foremanTokenGenrator=c,this.pubSub=u,this.broadcasterContext=l,this.scriptoriumContext=h,this.foremanContext=d,this.scribeContext=m,this.deliContext=p,this.moiraContext=f,this.serviceConfiguration=y,this.existing=t.existing,this.dbObject=this.getDeliState(),this.socketPublisher=new g(this.pubSub),this.setupKafkas(),this.setupLambdas(),this.startLambdas()}static async load(e,t,r,i,s,o,u,l,h,p,f){let g=arguments.length>11&&void 0!==arguments[11]?arguments[11]:new d.LocalOrdererSetup(r,i,e,t,p,f),v=arguments.length>12&&void 0!==arguments[12]?arguments[12]:new m.PubSub,b=arguments.length>13&&void 0!==arguments[13]?arguments[13]:new c.LocalContext(h),S=arguments.length>14&&void 0!==arguments[14]?arguments[14]:new c.LocalContext(h),w=arguments.length>15&&void 0!==arguments[15]?arguments[15]:new c.LocalContext(h),C=arguments.length>16&&void 0!==arguments[16]?arguments[16]:new c.LocalContext(h),E=arguments.length>17&&void 0!==arguments[17]?arguments[17]:new c.LocalContext(h),I=arguments.length>18&&void 0!==arguments[18]?arguments[18]:new c.LocalContext(h),T=arguments.length>19&&void 0!==arguments[19]?arguments[19]:{};const N=await g.documentP();return new y(g,N,r,i,s,o,f,u,l,v,b,S,w,C,E,I,(0,n.merge)({},a.DefaultServiceConfiguration,T))}async connect(e,t,r){const n=new m.WebSocketSubscriber(e);return this.connectInternal(n,t,r)}connectInternal(e,t,r){const n=new h.LocalOrdererConnection(e,this.existing,this.details.value,this.rawDeltasKafka,this.tenantId,this.documentId,t,r,this.serviceConfiguration);return this.existing=!0,n}async close(){await this.closeKafkas(),this.closeLambdas()}hasPendingWork(){var e;return!!(null===(e=this.broadcasterLambda)||void 0===e?void 0:e.lambda)&&this.broadcasterLambda.lambda.hasPendingWork()}setupKafkas(){const e=JSON.parse(this.dbObject.deli);this.rawDeltasKafka=new u.LocalKafka(e.logOffset+1),this.deltasKafka=new u.LocalKafka}setupLambdas(){this.scriptoriumLambda=new l.LocalLambdaController(this.deltasKafka,this.setup,this.scriptoriumContext,(async(e,t)=>{const r=await e.deltaCollectionP();return new s.ScriptoriumLambda(r,t,void 0)})),this.broadcasterLambda=new l.LocalLambdaController(this.deltasKafka,this.setup,this.broadcasterContext,(async(e,t)=>new s.BroadcasterLambda(this.socketPublisher,t,this.serviceConfiguration,void 0))),this.foremanLambda=new l.LocalLambdaController(this.deltasKafka,this.setup,this.foremanContext,(async(e,t)=>new s.ForemanLambda(this.taskMessageSender,this.tenantManager,this.foremanTokenGenrator,this.permission,t,this.tenantId,this.documentId))),this.gitManager&&(this.scribeLambda=new l.LocalLambdaController(this.deltasKafka,this.setup,this.scribeContext,((e,t)=>this.startScribeLambda(e,t)))),this.deliLambda=new l.LocalLambdaController(this.rawDeltasKafka,this.setup,this.deliContext,(async(e,t)=>{const r=await e.documentRepositoryP(),n=JSON.parse(this.dbObject.deli),i=(0,s.createDeliCheckpointManagerFromCollection)(this.tenantId,this.documentId,r);return new s.DeliLambda(t,this.tenantId,this.documentId,n,i,void 0,this.deltasKafka,void 0,this.rawDeltasKafka,this.serviceConfiguration,void 0,void 0)})),this.serviceConfiguration.moira.enable&&(this.moiraLambda=new l.LocalLambdaController(this.deltasKafka,this.setup,this.moiraContext,(async(e,t)=>new s.MoiraLambda(t,this.serviceConfiguration,this.tenantId,this.documentId))))}async startScribeLambda(e,t){const[r,n,o,a]=await Promise.all([e.documentRepositoryP(),e.scribeDeltaCollectionP(),e.protocolHeadP(),e.scribeMessagesP()]),c=this.getScribeState(),u=c.protocolState?c.protocolState:{members:[],proposals:[],values:[]},l=new i.ProtocolOpHandler(c.minimumSequenceNumber,c.sequenceNumber,1,u.members,u.proposals,u.values,(()=>-1)),h=new s.SummaryReader(this.tenantId,this.documentId,this.gitManager,!1),d=await h.readLastSummary(),m=new s.SummaryWriter(this.tenantId,this.documentId,this.gitManager,null,n,!1,d.messages,!1),p=new s.CheckpointManager(t,this.tenantId,this.documentId,r,n,null,!1);return new s.ScribeLambda(t,this.tenantId,this.documentId,m,h,void 0,p,c,this.serviceConfiguration,this.rawDeltasKafka,l,1,o,a.map((e=>e.operation)),void 0)}startLambdas(){this.deliLambda&&this.deliLambda.start(),this.scriptoriumLambda&&this.scriptoriumLambda.start(),this.foremanLambda&&this.foremanLambda.start(),this.scribeLambda&&this.scribeLambda.start(),this.broadcasterLambda&&this.broadcasterLambda.start(),this.moiraLambda&&this.moiraLambda.start()}async closeKafkas(){await Promise.all([this.rawDeltasKafka.close(),this.deltasKafka.close()])}closeLambdas(){this.deliLambda&&(this.deliLambda.close(),this.deliLambda=void 0),this.scriptoriumLambda&&(this.scriptoriumLambda.close(),this.scriptoriumLambda=void 0),this.foremanLambda&&(this.foremanLambda.close(),this.foremanLambda=void 0),this.scribeLambda&&(this.scribeLambda.close(),this.scribeLambda=void 0),this.broadcasterLambda&&(this.broadcasterLambda.close(),this.broadcasterLambda=void 0),this.moiraLambda&&(this.moiraLambda.close(),this.moiraLambda=void 0)}getDeliState(){const e=this.details.value;return null==e.deli&&(e.deli=JSON.stringify(f)),e}getScribeState(){return null==this.details.value.scribe?p:"string"==typeof this.details.value.scribe?JSON.parse(this.details.value.scribe):this.details.value.scribe}}t.LocalOrderer=y},"3fIs":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PendingBoxcar=t.MaxBatchSize=void 0;const n=r("wWog");t.MaxBatchSize=32,t.PendingBoxcar=class{constructor(e,t){this.tenantId=e,this.documentId=t,this.deferred=new n.Deferred,this.messages=[]}}},"4+3C":function(e,t,r){(function(e){var n=Object.getOwnPropertyDescriptors||function(e){for(var t=Object.keys(e),r={},n=0;n<t.length;n++)r[t[n]]=Object.getOwnPropertyDescriptor(e,t[n]);return r},i=/%[sdj%]/g;t.format=function(e){if(!y(e)){for(var t=[],r=0;r<arguments.length;r++)t.push(a(arguments[r]));return t.join(" ")}r=1;for(var n=arguments,s=n.length,o=String(e).replace(i,(function(e){if("%%"===e)return"%";if(r>=s)return e;switch(e){case"%s":return String(n[r++]);case"%d":return Number(n[r++]);case"%j":try{return JSON.stringify(n[r++])}catch(e){return"[Circular]"}default:return e}})),c=n[r];r<s;c=n[++r])f(c)||!S(c)?o+=" "+c:o+=" "+a(c);return o},t.deprecate=function(r,n){if(void 0!==e&&!0===e.noDeprecation)return r;if(void 0===e)return function(){return t.deprecate(r,n).apply(this,arguments)};var i=!1;return function(){if(!i){if(e.throwDeprecation)throw new Error(n);e.traceDeprecation?console.trace(n):console.error(n),i=!0}return r.apply(this,arguments)}};var s,o={};function a(e,r){var n={seen:[],stylize:u};return arguments.length>=3&&(n.depth=arguments[2]),arguments.length>=4&&(n.colors=arguments[3]),p(r)?n.showHidden=r:r&&t._extend(n,r),v(n.showHidden)&&(n.showHidden=!1),v(n.depth)&&(n.depth=2),v(n.colors)&&(n.colors=!1),v(n.customInspect)&&(n.customInspect=!0),n.colors&&(n.stylize=c),l(n,e,n.depth)}function c(e,t){var r=a.styles[t];return r?"["+a.colors[r][0]+"m"+e+"["+a.colors[r][1]+"m":e}function u(e,t){return e}function l(e,r,n){if(e.customInspect&&r&&E(r.inspect)&&r.inspect!==t.inspect&&(!r.constructor||r.constructor.prototype!==r)){var i=r.inspect(n,e);return y(i)||(i=l(e,i,n)),i}var s=function(e,t){if(v(t))return e.stylize("undefined","undefined");if(y(t)){var r="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(r,"string")}return g(t)?e.stylize(""+t,"number"):p(t)?e.stylize(""+t,"boolean"):f(t)?e.stylize("null","null"):void 0}(e,r);if(s)return s;var o=Object.keys(r),a=function(e){var t={};return e.forEach((function(e,r){t[e]=!0})),t}(o);if(e.showHidden&&(o=Object.getOwnPropertyNames(r)),C(r)&&(o.indexOf("message")>=0||o.indexOf("description")>=0))return h(r);if(0===o.length){if(E(r))return e.stylize("[Function"+(r.name?": "+r.name:"")+"]","special");if(b(r))return e.stylize(RegExp.prototype.toString.call(r),"regexp");if(w(r))return e.stylize(Date.prototype.toString.call(r),"date");if(C(r))return h(r)}var c,u="",S=!1,I=["{","}"];return m(r)&&(S=!0,I=["[","]"]),E(r)&&(u=" [Function"+(r.name?": "+r.name:"")+"]"),b(r)&&(u=" "+RegExp.prototype.toString.call(r)),w(r)&&(u=" "+Date.prototype.toUTCString.call(r)),C(r)&&(u=" "+h(r)),0!==o.length||S&&0!=r.length?n<0?b(r)?e.stylize(RegExp.prototype.toString.call(r),"regexp"):e.stylize("[Object]","special"):(e.seen.push(r),c=S?function(e,t,r,n,i){for(var s=[],o=0,a=t.length;o<a;++o)x(t,String(o))?s.push(d(e,t,r,n,String(o),!0)):s.push("");return i.forEach((function(i){i.match(/^\d+$/)||s.push(d(e,t,r,n,i,!0))})),s}(e,r,n,a,o):o.map((function(t){return d(e,r,n,a,t,S)})),e.seen.pop(),function(e,t,r){return e.reduce((function(e,t){return t.indexOf("\n"),e+t.replace(/\u001b\[\d\d?m/g,"").length+1}),0)>60?r[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+r[1]:r[0]+t+" "+e.join(", ")+" "+r[1]}(c,u,I)):I[0]+u+I[1]}function h(e){return"["+Error.prototype.toString.call(e)+"]"}function d(e,t,r,n,i,s){var o,a,c;if((c=Object.getOwnPropertyDescriptor(t,i)||{value:t[i]}).get?a=e.stylize(c.set?"[Getter/Setter]":"[Getter]","special"):c.set&&(a=e.stylize("[Setter]","special")),x(n,i)||(o="["+i+"]"),a||(e.seen.indexOf(c.value)<0?(a=f(r)?l(e,c.value,null):l(e,c.value,r-1)).indexOf("\n")>-1&&(a=s?a.split("\n").map((function(e){return"  "+e})).join("\n").substr(2):"\n"+a.split("\n").map((function(e){return"   "+e})).join("\n")):a=e.stylize("[Circular]","special")),v(o)){if(s&&i.match(/^\d+$/))return a;(o=JSON.stringify(""+i)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(o=o.substr(1,o.length-2),o=e.stylize(o,"name")):(o=o.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),o=e.stylize(o,"string"))}return o+": "+a}function m(e){return Array.isArray(e)}function p(e){return"boolean"==typeof e}function f(e){return null===e}function g(e){return"number"==typeof e}function y(e){return"string"==typeof e}function v(e){return void 0===e}function b(e){return S(e)&&"[object RegExp]"===I(e)}function S(e){return"object"==typeof e&&null!==e}function w(e){return S(e)&&"[object Date]"===I(e)}function C(e){return S(e)&&("[object Error]"===I(e)||e instanceof Error)}function E(e){return"function"==typeof e}function I(e){return Object.prototype.toString.call(e)}function T(e){return e<10?"0"+e.toString(10):e.toString(10)}t.debuglog=function(r){if(v(s)&&(s=e.env.NODE_DEBUG||""),r=r.toUpperCase(),!o[r])if(new RegExp("\\b"+r+"\\b","i").test(s)){var n=e.pid;o[r]=function(){var e=t.format.apply(t,arguments);console.error("%s %d: %s",r,n,e)}}else o[r]=function(){};return o[r]},t.inspect=a,a.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},a.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},t.isArray=m,t.isBoolean=p,t.isNull=f,t.isNullOrUndefined=function(e){return null==e},t.isNumber=g,t.isString=y,t.isSymbol=function(e){return"symbol"==typeof e},t.isUndefined=v,t.isRegExp=b,t.isObject=S,t.isDate=w,t.isError=C,t.isFunction=E,t.isPrimitive=function(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e},t.isBuffer=r("EwJK");var N=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function P(){var e=new Date,t=[T(e.getHours()),T(e.getMinutes()),T(e.getSeconds())].join(":");return[e.getDate(),N[e.getMonth()],t].join(" ")}function x(e,t){return Object.prototype.hasOwnProperty.call(e,t)}t.log=function(){console.log("%s - %s",P(),t.format.apply(t,arguments))},t.inherits=r("wfEq"),t._extend=function(e,t){if(!t||!S(t))return e;for(var r=Object.keys(t),n=r.length;n--;)e[r[n]]=t[r[n]];return e};var O="undefined"!=typeof Symbol?Symbol("util.promisify.custom"):void 0;function M(e,t){if(!e){var r=new Error("Promise was rejected with a falsy value");r.reason=e,e=r}return t(e)}t.promisify=function(e){if("function"!=typeof e)throw new TypeError('The "original" argument must be of type Function');if(O&&e[O]){var t;if("function"!=typeof(t=e[O]))throw new TypeError('The "util.promisify.custom" argument must be of type Function');return Object.defineProperty(t,O,{value:t,enumerable:!1,writable:!1,configurable:!0}),t}function t(){for(var t,r,n=new Promise((function(e,n){t=e,r=n})),i=[],s=0;s<arguments.length;s++)i.push(arguments[s]);i.push((function(e,n){e?r(e):t(n)}));try{e.apply(this,i)}catch(e){r(e)}return n}return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),O&&Object.defineProperty(t,O,{value:t,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(t,n(e))},t.promisify.custom=O,t.callbackify=function(t){if("function"!=typeof t)throw new TypeError('The "original" argument must be of type Function');function r(){for(var r=[],n=0;n<arguments.length;n++)r.push(arguments[n]);var i=r.pop();if("function"!=typeof i)throw new TypeError("The last argument must be of type Function");var s=this,o=function(){return i.apply(s,arguments)};t.apply(this,r).then((function(t){e.nextTick(o,null,t)}),(function(t){e.nextTick(M,t,o)}))}return Object.setPrototypeOf(r,Object.getPrototypeOf(t)),Object.defineProperties(r,n(t)),r}}).call(this,r("5IsQ"))},"46ZM":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestEngine2=t.TestEngine1=t.TestSchemaValidator=t.TestLumberjack=void 0;const n=r("d2TU");t.TestLumberjack=class extends n.Lumberjack{static reset(){n.Lumberjack._instance=void 0}},t.TestSchemaValidator=class{constructor(e){this.passResult=e}validate(e){return{validationPassed:this.passResult,validationFailedForProperties:[]}}},t.TestEngine1=class{emit(e){}},t.TestEngine2=class{emit(e){}}},"4IaO":function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.NodeManager=void 0;const i=n(r("ZERR")),s=r("hBZP"),o=r("UwdI");t.NodeManager=class extends s.EventEmitter{constructor(e,t){super(),this.mongoManager=e,this.nodeCollectionName=t,this.nodes=new Map,this.pendingNodes=new Map}registerLocal(e){(0,i.default)(!this.nodes.has(e.id)),(0,i.default)(!this.pendingNodes.has(e.id)),this.nodes.set(e.id,e)}loadRemote(e){if(this.nodes.has(e))return Promise.resolve(this.nodes.get(e));if(this.pendingNodes.has(e))return this.pendingNodes.get(e);const t=this.getNode(e);return this.pendingNodes.set(e,t),t}async getNode(e){const t=await o.RemoteNode.connect(e,this.mongoManager,this.nodeCollectionName);return this.nodes.set(e,t),t}}},"4Nzb":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isDocumentSessionValid=t.isDocumentValid=void 0,t.isDocumentValid=function(e){return!!e&&!e.scheduledDeletionTime},t.isDocumentSessionValid=function(e,t){return!t.externalOrdererUrl||!e.session||!!e.session.isSessionAlive&&e.session.ordererUrl===t.externalOrdererUrl}},"5XVS":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestEngine2=t.TestEngine1=t.TestSchemaValidator=t.TestLumberjack=void 0;const n=r("r+Vx");t.TestLumberjack=class extends n.Lumberjack{static reset(){n.Lumberjack._instance=void 0}},t.TestSchemaValidator=class{constructor(e){this.passResult=e}validate(e){return{validationPassed:this.passResult,validationFailedForProperties:[]}}},t.TestEngine1=class{emit(e){}},t.TestEngine2=class{emit(e){}}},"5gZq":function(e,t,r){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.getLumberBaseProperties=t.handleError=t.SessionState=t.ThrottlingTelemetryProperties=t.CommonProperties=t.HttpProperties=t.QueuedMessageProperties=t.BaseTelemetryProperties=t.LumberType=t.LogLevel=void 0;const n=r("O3lp"),i=r("Q/BS"),s="undefined"!=typeof window&&void 0!==window.document,o=void 0!==e&&null!=e.versions&&null!=e.versions.node;var a,c;!function(e){e[e.Error=0]="Error",e[e.Warning=1]="Warning",e[e.Info=2]="Info",e[e.Verbose=3]="Verbose",e[e.Debug=4]="Debug"}(t.LogLevel||(t.LogLevel={})),function(e){e[e.Metric=0]="Metric",e[e.Log=1]="Log"}(a=t.LumberType||(t.LumberType={})),function(e){e.tenantId="tenantId",e.documentId="documentId",e.correlationId="correlationId"}(c=t.BaseTelemetryProperties||(t.BaseTelemetryProperties={})),function(e){e.topic="topic",e.partition="partition",e.offset="offset",e.offsetStart="offsetStart",e.offsetEnd="offsetEnd"}(t.QueuedMessageProperties||(t.QueuedMessageProperties={})),function(e){e.driverVersion="driverVersion",e.method="method",e.pathCategory="pathCategory",e.requestContentLength="requestContentLength",e.responseContentLength="responseContentLength",e.responseTime="responseTime",e.status="status",e.url="url"}(t.HttpProperties||(t.HttpProperties={})),function(e){e.clientId="clientId",e.clientType="clientType",e.clientCount="clientCount",e.clientDriverVersion="clientDriverVersion",e.sessionState="sessionState",e.sessionEndReason="sessionEndReason",e.minSequenceNumber="minSequenceNumber",e.sequenceNumber="sequenceNumber",e.checkpointOffset="checkpointOffset",e.clientSummarySuccess="clientSummarySuccess",e.serviceSummarySuccess="serviceSummarySuccess",e.maxOpsSinceLastSummary="maxOpsSinceLastSummary",e.lastSummarySequenceNumber="lastSummarySequenceNumber",e.minLogtailSequenceNumber="minLogtailSequenceNumber",e.maxLogtailSequenceNumber="maxLogtailSequenceNumber",e.statusCode="statusCode",e.errorCode="errorCode",e.restart="restart",e.serviceName="serviceName",e.telemetryGroupName="telemetryGroupName",e.totalBatchSize="totalBatchSize"}(t.CommonProperties||(t.CommonProperties={})),function(e){e.key="key",e.reason="reason",e.retryAfterInSeconds="retryAfterInSeconds",e.weight="weight"}(t.ThrottlingTelemetryProperties||(t.ThrottlingTelemetryProperties={})),function(e){e.started="started",e.resumed="resumed",e.paused="paused",e.end="end",e.LambdaStartFailed="lambdaStartFailed"}(t.SessionState||(t.SessionState={})),t.handleError=function(t,r,c){var u;if(!s&&o&&(null===(u=null==e?void 0:e.env)||void 0===u?void 0:u.IS_FLUID_SERVER)){const e=new Error(r);0===c.length?console.error((0,n.serializeError)(e)):new i.Lumber(t,a.Metric,c).error(r,e)}},t.getLumberBaseProperties=(e,t)=>({[c.tenantId]:t,[c.documentId]:e})}).call(this,r("5IsQ"))},"61GN":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EmptyTaskMessageSender=void 0,t.EmptyTaskMessageSender=class{async initialize(){}sendTask(e,t){}on(e,t){return this}async close(){}}},"6Cdk":function(e,t,r){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.getLumberBaseProperties=t.handleError=t.SessionState=t.ThrottlingTelemetryProperties=t.CommonProperties=t.HttpProperties=t.QueuedMessageProperties=t.BaseTelemetryProperties=t.LumberType=t.LogLevel=void 0;const n=r("O3lp"),i=r("ngQy"),s="undefined"!=typeof window&&void 0!==window.document,o=void 0!==e&&null!=e.versions&&null!=e.versions.node;var a,c;!function(e){e[e.Error=0]="Error",e[e.Warning=1]="Warning",e[e.Info=2]="Info",e[e.Verbose=3]="Verbose",e[e.Debug=4]="Debug"}(t.LogLevel||(t.LogLevel={})),function(e){e[e.Metric=0]="Metric",e[e.Log=1]="Log"}(a=t.LumberType||(t.LumberType={})),function(e){e.tenantId="tenantId",e.documentId="documentId",e.correlationId="correlationId"}(c=t.BaseTelemetryProperties||(t.BaseTelemetryProperties={})),function(e){e.topic="topic",e.partition="partition",e.offset="offset",e.offsetStart="offsetStart",e.offsetEnd="offsetEnd"}(t.QueuedMessageProperties||(t.QueuedMessageProperties={})),function(e){e.driverVersion="driverVersion",e.method="method",e.pathCategory="pathCategory",e.requestContentLength="requestContentLength",e.responseContentLength="responseContentLength",e.responseTime="responseTime",e.status="status",e.url="url"}(t.HttpProperties||(t.HttpProperties={})),function(e){e.clientId="clientId",e.clientType="clientType",e.clientCount="clientCount",e.clientDriverVersion="clientDriverVersion",e.sessionState="sessionState",e.sessionEndReason="sessionEndReason",e.minSequenceNumber="minSequenceNumber",e.sequenceNumber="sequenceNumber",e.checkpointOffset="checkpointOffset",e.clientSummarySuccess="clientSummarySuccess",e.serviceSummarySuccess="serviceSummarySuccess",e.maxOpsSinceLastSummary="maxOpsSinceLastSummary",e.lastSummarySequenceNumber="lastSummarySequenceNumber",e.minLogtailSequenceNumber="minLogtailSequenceNumber",e.maxLogtailSequenceNumber="maxLogtailSequenceNumber",e.statusCode="statusCode",e.errorCode="errorCode",e.restart="restart",e.serviceName="serviceName",e.telemetryGroupName="telemetryGroupName",e.totalBatchSize="totalBatchSize"}(t.CommonProperties||(t.CommonProperties={})),function(e){e.key="key",e.reason="reason",e.retryAfterInSeconds="retryAfterInSeconds",e.weight="weight"}(t.ThrottlingTelemetryProperties||(t.ThrottlingTelemetryProperties={})),function(e){e.started="started",e.resumed="resumed",e.paused="paused",e.end="end",e.LambdaStartFailed="lambdaStartFailed"}(t.SessionState||(t.SessionState={})),t.handleError=function(t,r,c){var u;if(!s&&o&&(null===(u=null==e?void 0:e.env)||void 0===u?void 0:u.IS_FLUID_SERVER)){const e=new Error(r);0===c.length?console.error((0,n.serializeError)(e)):new i.Lumber(t,a.Metric,c).error(r,e)}},t.getLumberBaseProperties=(e,t)=>({[c.tenantId]:t,[c.documentId]:e})}).call(this,r("5IsQ"))},"6F7b":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CheckpointManager=void 0;const n=r("wWog"),i=r("MPeK"),s=r("tp/L");t.CheckpointManager=class{constructor(e,t,r,n,s,o,a){this.context=e,this.tenantId=t,this.documentId=r,this.documentRepository=n,this.opCollection=s,this.deltaService=o,this.getDeltasViaAlfred=a,this.clientFacadeRetryEnabled=(0,i.isRetryEnabled)(this.opCollection)}async write(e,t,r){if(this.getDeltasViaAlfred){if(r.length>0){const e=r[r.length-1].operation.sequenceNumber,t=await this.deltaService.getDeltas("",this.tenantId,this.documentId,e-1,e+1);if(0===t.length||t[0].sequenceNumber<e){const r=Object.assign(Object.assign({},(0,s.getLumberBaseProperties)(this.documentId,this.tenantId)),{expectedSequenceNumber:e,lastDelta:t.length>0?t[0].sequenceNumber:-1});s.Lumberjack.info("Pending ops were not been persisted to op storage. Retrying after delay",r),await(0,n.delay)(1500);const i=await this.deltaService.getDeltas("",this.tenantId,this.documentId,e-1,e+1);if(0===i.length||i[0].sequenceNumber<e){const e="Pending ops were not been persisted to op storage. Checkpointing failed";throw s.Lumberjack.error(e,r),new Error(e)}s.Lumberjack.info("Verified on retry that pending ops are persisted",(0,s.getLumberBaseProperties)(this.documentId,this.tenantId))}}await this.writeScribeCheckpointState(e)}else{const n=r.map((e=>Object.assign(Object.assign({},e),{mongoTimestamp:new Date(e.operation.timestamp)})));n.length>0&&await(0,i.runWithRetry)((async()=>this.opCollection.insertMany(n,!1)),"writeCheckpointScribe",3,1e3,(0,s.getLumberBaseProperties)(this.documentId,this.tenantId),(e=>11e3===e.code),(e=>!this.clientFacadeRetryEnabled)),await this.writeScribeCheckpointState(e),await this.opCollection.deleteMany({documentId:this.documentId,"operation.sequenceNumber":{$lte:t},tenantId:this.tenantId})}}async writeScribeCheckpointState(e){await this.documentRepository.updateOne({documentId:this.documentId,tenantId:this.tenantId},{scribe:JSON.stringify(e)},null)}async delete(e,t){await this.documentRepository.updateOne({documentId:this.documentId,tenantId:this.tenantId},{scribe:""},null),await this.opCollection.deleteMany({documentId:this.documentId,"operation.sequenceNumber":t?{$lte:e}:{$gte:e},tenantId:this.tenantId})}}},"7WL8":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MoiraLambdaFactory=void 0;const n=r("hBZP"),i=r("EA0Q");t.MoiraLambdaFactory=class extends n.EventEmitter{constructor(e,t){super(),this.mongoManager=e,this.serviceConfiguration=t}async create(e,t){return new i.MoiraLambda(t,this.serviceConfiguration,e.tenantId,e.documentId)}async dispose(){await this.mongoManager.close()}}},"7aOi":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestThrottleAndUsageStorageManager=void 0,t.TestThrottleAndUsageStorageManager=class{constructor(){this.throttlingCache={},this.usageCache={}}async setThrottlingMetric(e,t){this.throttlingCache[e]=t}async getThrottlingMetric(e){return this.throttlingCache[e]}async setThrottlingMetricAndUsageData(e,t,r,n){this.throttlingCache[e]=t,this.usageCache[r]=n}async setUsageData(e,t){this.usageCache[e]=t}async getUsageData(e){return this.usageCache[e]}}},"96zj":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.logCommonSessionEndMetrics=t.createSessionMetric=void 0;const n=r("yQiv"),i=r("fhs9");t.createSessionMetric=(e,t,r,n)=>{if(!n.enableLumberjack)return;const s=i.Lumberjack.newLumberMetric(r);return null==s||s.setProperties({[i.BaseTelemetryProperties.tenantId]:e,[i.BaseTelemetryProperties.documentId]:t}),s},t.logCommonSessionEndMetrics=(e,t,r,s,o,a)=>{if(!r)return;const c=e.getContextError();r.setProperties({[i.CommonProperties.sessionEndReason]:t}),r.setProperties({[i.CommonProperties.sessionState]:i.SessionState.end}),r.setProperties({[i.CommonProperties.sequenceNumber]:s}),r.setProperties({[i.CommonProperties.lastSummarySequenceNumber]:o}),c?r.error(`Session terminated due to ${c}`):t===n.LambdaCloseType.Error?r.error("Session terminated due to error"):t&&t!==n.LambdaCloseType.Stop&&t!==n.LambdaCloseType.Rebalance?t===n.LambdaCloseType.ActivityTimeout?(null==a?void 0:a.includes(n.NackMessagesType.SummaryMaxOps))?r.error("Session terminated due to inactivity while exceeding max ops since last summary"):r.success("Session terminated due to inactivity"):r.error("Unknown session end state"):(r.setProperties({[i.CommonProperties.sessionState]:i.SessionState.paused}),r.success("Session paused"))}},"9FG3":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestThrottleAndUsageStorageManager=void 0,t.TestThrottleAndUsageStorageManager=class{constructor(){this.throttlingCache={},this.usageCache={}}async setThrottlingMetric(e,t){this.throttlingCache[e]=t}async getThrottlingMetric(e){return this.throttlingCache[e]}async setThrottlingMetricAndUsageData(e,t,r,n){this.throttlingCache[e]=t,this.usageCache[r]=n}async setUsageData(e,t){this.usageCache[e]=t}async getUsageData(e){return this.usageCache[e]}}},"9Jrb":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ThrottlingError=void 0;const n=r("y2M+");t.ThrottlingError=class{constructor(e,t){this.message=e,this.retryAfter=t,this.code=429,this.type=n.NackErrorType.ThrottlingError}}},"9O2h":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateRetryIntervalForNetworkError=t.shouldRetryNetworkError=t.requestWithRetry=t.runWithRetry=void 0;const n=r("wWog"),i=r("tp/L");function s(e){if(e instanceof Error&&"NetworkError"===(null==e?void 0:e.name)){const t=e;return!t.isFatal&&!0===t.canRetry}return!1}function o(e,t,r){return e instanceof Error&&"NetworkError"===(null==e?void 0:e.name)&&e.retryAfterMs?e.retryAfterMs:r*2**t}t.runWithRetry=async function(e,t,r,s,o,a,c){let u,l,h,d=arguments.length>7&&void 0!==arguments[7]?arguments[7]:(e,t,r)=>r*2**t,m=arguments.length>8?arguments[8]:void 0,p=arguments.length>9&&void 0!==arguments[9]&&arguments[9],f=0,g=!1;p&&(l=i.Lumberjack.newLumberMetric(i.LumberEventName.RunWithRetry,o));try{do{try{u=await e(),g=!0,f>=1&&i.Lumberjack.info(`Succeeded in executing ${t} with ${f} retries`,o)}catch(e){if(void 0!==m&&m(e),h=e,i.Lumberjack.error(`Error running ${t}: retryCount ${f}`,o,e),void 0!==a&&!0===a(e)){i.Lumberjack.info(`Should ignore error for ${t}`,o);break}if(void 0!==c&&!1===c(e))return i.Lumberjack.error(`Should not retry ${t} for the current error, rejecting`,o,e),Promise.reject(e);if(-1!==r&&f>=r)return i.Lumberjack.error(`Error after retrying ${f} times, rejecting`,o,e),Promise.reject(e);const u=d(e,f,s);await(0,n.delay)(u),f++}}while(!g);return u}finally{p&&l&&(l.setProperty("retryCount",f),l.setProperty("callName",t),l.setProperty("maxRetries",r),l.setProperty("retryAfterMs",s),g?l.success("runWithRetry succeeded"):l.error("runWithRetry failed",h))}},t.requestWithRetry=async function(e,t,r){let a,c,u,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:s,h=arguments.length>4&&void 0!==arguments[4]?arguments[4]:-1,d=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1e3,m=arguments.length>6&&void 0!==arguments[6]?arguments[6]:o,p=arguments.length>7?arguments[7]:void 0,f=arguments.length>8&&void 0!==arguments[8]&&arguments[8],g=0,y=!1;f&&(c=i.Lumberjack.newLumberMetric(i.LumberEventName.RequestWithRetry,r));try{do{try{a=await e(),y=!0,g>=1&&i.Lumberjack.info(`Succeeded in executing ${t} with ${g} retries`,r)}catch(e){if(void 0!==p&&p(e),i.Lumberjack.error(`Error running ${t}: retryCount ${g}`,r,e),void 0!==l&&!1===l(e))return i.Lumberjack.error(`Should not retry ${t} for the current error, rejecting`,r,e),Promise.reject(e);if(-1!==h&&g>=h)return i.Lumberjack.error(`Error after retrying ${g} times, rejecting`,r,e),Promise.reject(e);const s=m(e,g,d);await(0,n.delay)(s),g++}}while(!y);return a}finally{f&&c&&(c.setProperty("retryCount",g),c.setProperty("callName",t),c.setProperty("maxRetries",h),c.setProperty("retryAfterMs",d),y?c.success("requestWithRetry succeeded"):c.error("requestWithRetry failed",u))}},t.shouldRetryNetworkError=s,t.calculateRetryIntervalForNetworkError=o},"A+TC":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ClientSequenceNumberManager=void 0;const n=r("wWog"),i={compare:(e,t)=>e.referenceSequenceNumber-t.referenceSequenceNumber,min:{canEvict:!0,clientId:void 0,clientSequenceNumber:0,lastUpdate:-1,nack:!1,referenceSequenceNumber:-1,scopes:[]}};t.ClientSequenceNumberManager=class{constructor(){this.clientNodeMap=new Map,this.clientSeqNumbers=new n.Heap(i)}has(e){return this.clientNodeMap.has(e)}get(e){const t=this.clientNodeMap.get(e);if(void 0!==t)return t.value}count(){return this.clientNodeMap.size}peek(){const e=this.clientSeqNumbers.peek();if(void 0!==e)return e.value}cloneValues(){const e=[];for(const[,t]of this.clientNodeMap)e.push(Object.assign({},t.value));return e}upsertClient(e,t,r,n,i){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:[],o=arguments.length>6&&void 0!==arguments[6]&&arguments[6],a=arguments.length>7&&void 0!==arguments[7]?arguments[7]:void 0;const c=this.clientNodeMap.get(e);if(c)return c.value.referenceSequenceNumber=r,c.value.clientSequenceNumber=t,c.value.lastUpdate=n,c.value.nack=o,a&&(c.value.serverMetadata=a),this.clientSeqNumbers.update(c),!1;const u=this.clientSeqNumbers.add({canEvict:i,clientId:e,clientSequenceNumber:t,lastUpdate:n,nack:o,referenceSequenceNumber:r,scopes:s,serverMetadata:a});return this.clientNodeMap.set(e,u),!0}removeClient(e){const t=this.clientNodeMap.get(e);return!!t&&(this.clientSeqNumbers.remove(t),this.clientNodeMap.delete(e),!0)}getMinimumSequenceNumber(){return this.clientSeqNumbers.count()>0?this.clientSeqNumbers.peek().value.referenceSequenceNumber:-1}}},AE9X:function(e,t,r){"use strict";r.d(t,"b",(function(){return s})),r.d(t,"a",(function(){return o}));var n=r("vuat"),i=r.n(n);function s(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"_",t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],[r,n]=i()().split(" ");return t||(r=r.toLowerCase(),n=n.toLowerCase()),`${r}${e}${n}`}const o=()=>s()},AK04:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createDeliCheckpointManagerFromCollection=void 0,t.createDeliCheckpointManagerFromCollection=function(e,t,r){return{writeCheckpoint:async n=>{await r.updateOne({tenantId:e,documentId:t},{deli:JSON.stringify(n)})},deleteCheckpoint:async()=>{await r.updateOne({tenantId:e,documentId:t},{deli:""})}}}},AN3h:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NoOpLambda=void 0,t.NoOpLambda=class{constructor(e){this.context=e}handler(e){this.context.checkpoint(e)}close(){}}},AYbU:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CheckpointReason=void 0,function(e){e[e.EveryMessage=0]="EveryMessage",e[e.IdleTime=1]="IdleTime",e[e.MaxTime=2]="MaxTime",e[e.MaxMessages=3]="MaxMessages",e[e.ClearCache=4]="ClearCache",e[e.NoClients=5]="NoClients"}(t.CheckpointReason||(t.CheckpointReason={}))},Axqv:function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LocalKafka=void 0;const i=n(r("3YFW")),s=r("rNX3");t.LocalKafka=class{constructor(){this.messageOffset=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,this.subscriptions=[],this.qeueue=new i.default,this.minimumQueueOffset=0}get length(){return this.qeueue.length}isConnected(){return!0}subscribe(e){const t=new s.LocalKafkaSubscription(e,this.qeueue);t.on("processed",(e=>{if(this.minimumQueueOffset>=e)return;for(const t of this.subscriptions)if(t.queueOffset<e)return;const t=e-this.minimumQueueOffset;this.minimumQueueOffset=e-1;for(let e=0;e<t;e++)this.qeueue.shift();for(const e of this.subscriptions)e.queueOffset-=t})),this.subscriptions.push(t)}async send(e,t){for(const r of e){const e={offset:this.messageOffset,partition:0,topic:t,value:JSON.stringify(r)};this.messageOffset++,this.qeueue.push(e)}for(const e of this.subscriptions)e.process()}async close(){this.qeueue.clear();for(const e of this.subscriptions)e.close();this.subscriptions.length=0}on(e,t){return this}once(e,t){return this}}},B6kT:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MessageFactory=t.KafkaMessageFactory=void 0;const n=r("y2M+"),i=r("dyph"),s=r("zcKR");t.KafkaMessageFactory=class{constructor(){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,t=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;this.topic=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"test",this.stringify=t,this.tenantId=r,this.documentId=n,this.offsets=[];for(let t=0;t<e;t++)this.offsets.push(0)}sequenceMessage(e,t){const r=this.getPartition(t);return{offset:this.offsets[r]++,partition:r,topic:this.topic,value:this.stringify?JSON.stringify(e):{contents:Array.isArray(e)?e:[e],documentId:this.documentId,tenantId:this.tenantId,type:i.BoxcarType}}}getHeadOffset(e){return this.offsets[this.getPartition(e)]-1}getPartition(e){return s(e)%this.offsets.length}},t.MessageFactory=class{constructor(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"test";this.documentId=e,this.clientId=t,this.tenantId=r,this.clientSequenceNumber=0,this.sequenceNumber=0}createDocumentMessage(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:n.MessageType.Operation,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return{clientSequenceNumber:++this.clientSequenceNumber,contents:null,metadata:void 0,referenceSequenceNumber:t,traces:[],type:e,compression:void 0}}create(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:n.MessageType.Operation,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Date.now();const i=this.createDocumentMessage(e,t);return this.createRawOperation(i,r,this.clientId)}createJoin(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Date.now(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;const r={clientSequenceNumber:-1,contents:null,data:JSON.stringify({clientId:this.clientId,detail:{mode:"write",permission:[],scopes:[n.ScopeType.DocRead,n.ScopeType.DocWrite,n.ScopeType.SummaryWrite],details:{capabilities:{interactive:!0}},user:null}}),referenceSequenceNumber:-1,traces:[],type:n.MessageType.ClientJoin,serverMetadata:t};return this.createRawOperation(r,e,null)}createLeave(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Date.now();const t={clientSequenceNumber:-1,contents:null,data:JSON.stringify(this.clientId),referenceSequenceNumber:-1,traces:[],type:n.MessageType.ClientLeave};return this.createRawOperation(t,e,null)}createRawOperation(e,t,r){return{clientId:r,documentId:this.documentId,operation:e,tenantId:this.tenantId,timestamp:t,type:i.RawOperationType}}createSequencedOperation(){const e=this.createDocumentMessage(n.MessageType.Operation,arguments.length>0&&void 0!==arguments[0]?arguments[0]:0),t={clientId:this.clientId,clientSequenceNumber:e.clientSequenceNumber,contents:e.contents,metadata:e.metadata,minimumSequenceNumber:0,origin:void 0,referenceSequenceNumber:e.referenceSequenceNumber,sequenceNumber:this.sequenceNumber++,term:1,timestamp:Date.now(),traces:[],type:e.type};return{documentId:this.documentId,operation:t,tenantId:this.tenantId,type:i.SequencedOperationType}}createSummarize(e,t){const r=this.createDocumentMessage(n.MessageType.Summarize,e),s={clientId:this.clientId,clientSequenceNumber:r.clientSequenceNumber,contents:`{"handle": "${t}" ,"head":null,"message":"","parents":[]}`,metadata:r.metadata,minimumSequenceNumber:0,origin:void 0,referenceSequenceNumber:r.referenceSequenceNumber,sequenceNumber:this.sequenceNumber++,term:1,timestamp:Date.now(),traces:[],type:r.type,additionalContent:""};return{documentId:this.documentId,operation:s,tenantId:this.tenantId,type:i.SequencedOperationType}}createNoClient(){const e=this.createDocumentMessage(n.MessageType.NoClient,arguments.length>0&&void 0!==arguments[0]?arguments[0]:0),t={clientId:this.clientId,clientSequenceNumber:e.clientSequenceNumber,contents:e.contents,metadata:e.metadata,minimumSequenceNumber:this.sequenceNumber,origin:void 0,referenceSequenceNumber:this.sequenceNumber,sequenceNumber:this.sequenceNumber++,term:1,timestamp:Date.now(),traces:[],type:e.type,additionalContent:""};return{documentId:this.documentId,operation:t,tenantId:this.tenantId,type:i.SequencedOperationType}}createSummaryAck(e){const t=this.createDocumentMessage(n.MessageType.SummaryAck,0),r={clientId:null,clientSequenceNumber:-1,contents:{handle:e,summaryProposal:{summarySequenceNumber:1}},metadata:t.metadata,minimumSequenceNumber:0,origin:void 0,referenceSequenceNumber:-1,sequenceNumber:this.sequenceNumber++,term:1,timestamp:Date.now(),traces:[],type:t.type,additionalContent:""};return{documentId:this.documentId,operation:r,tenantId:this.tenantId,type:i.SequencedOperationType}}}},BYTq:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CombinedContext=void 0,t.CombinedContext=class{constructor(e){this.context=e,this.checkpoints=[]}createContext(){const e=this.checkpoints.push(void 0)-1;return{log:this.context.log,checkpoint:t=>this.checkpoint(e,t),error:(t,r)=>this.error(e,t,r)}}checkpoint(e,t){this.checkpoints[e]=t;const r=this.getLowestMessage();void 0!==r&&(void 0===this.currentCheckpoint||this.currentCheckpoint.offset<r.offset)&&(this.currentCheckpoint=r,this.context.checkpoint(r))}error(e,t,r){this.context.error(t,r)}getLowestMessage(){let e;for(const t of this.checkpoints){if(void 0===t)return;(void 0===e||e.offset>t.offset)&&(e=t)}return e}}},BZv8:function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PubSub=t.WebSocketSubscriber=void 0;const i=n(r("ZERR"));t.WebSocketSubscriber=class{constructor(e){this.webSocket=e}get id(){return this.webSocket.id}send(e,t){for(var r=arguments.length,n=new Array(r>2?r-2:0),i=2;i<r;i++)n[i-2]=arguments[i];this.webSocket.emit(t,...n)}},t.PubSub=class{constructor(){this.topics=new Map}publish(e,t){const r=this.topics.get(e);if(r){for(var n=arguments.length,i=new Array(n>2?n-2:0),s=2;s<n;s++)i[s-2]=arguments[s];for(const[,n]of r)n.subscriber.send(e,t,...i)}}subscribe(e,t){this.topics.has(e)||this.topics.set(e,new Map);const r=this.topics.get(e);r.has(t.id)||r.set(t.id,{subscriber:t,count:0}),r.get(t.id).count++}unsubscribe(e,t){(0,i.default)(this.topics.has(e));const r=this.topics.get(e);(0,i.default)(r.has(t.id));const n=r.get(t.id);n.count--,0===n.count&&r.delete(t.id),0===r.size&&this.topics.delete(e)}}},C0H2:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateRetryIntervalForNetworkError=t.shouldRetryNetworkError=t.requestWithRetry=t.runWithRetry=void 0;const n=r("wWog"),i=r("s+HU");function s(e){if(e instanceof Error&&"NetworkError"===(null==e?void 0:e.name)){const t=e;return!t.isFatal&&!0===t.canRetry}return!1}function o(e,t,r){return e instanceof Error&&"NetworkError"===(null==e?void 0:e.name)&&e.retryAfterMs?e.retryAfterMs:r*2**t}t.runWithRetry=async function(e,t,r,s,o,a,c){let u,l,h,d=arguments.length>7&&void 0!==arguments[7]?arguments[7]:(e,t,r)=>r*2**t,m=arguments.length>8?arguments[8]:void 0,p=arguments.length>9&&void 0!==arguments[9]&&arguments[9],f=0,g=!1;p&&(l=i.Lumberjack.newLumberMetric(i.LumberEventName.RunWithRetry,o));try{do{try{u=await e(),g=!0,f>=1&&i.Lumberjack.info(`Succeeded in executing ${t} with ${f} retries`,o)}catch(e){if(void 0!==m&&m(e),h=e,i.Lumberjack.error(`Error running ${t}: retryCount ${f}`,o,e),void 0!==a&&!0===a(e)){i.Lumberjack.info(`Should ignore error for ${t}`,o);break}if(void 0!==c&&!1===c(e))return i.Lumberjack.error(`Should not retry ${t} for the current error, rejecting`,o,e),Promise.reject(e);if(-1!==r&&f>=r)return i.Lumberjack.error(`Error after retrying ${f} times, rejecting`,o,e),Promise.reject(e);const u=d(e,f,s);await(0,n.delay)(u),f++}}while(!g);return u}finally{p&&l&&(l.setProperty("retryCount",f),l.setProperty("callName",t),l.setProperty("maxRetries",r),l.setProperty("retryAfterMs",s),g?l.success("runWithRetry succeeded"):l.error("runWithRetry failed",h))}},t.requestWithRetry=async function(e,t,r){let a,c,u,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:s,h=arguments.length>4&&void 0!==arguments[4]?arguments[4]:-1,d=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1e3,m=arguments.length>6&&void 0!==arguments[6]?arguments[6]:o,p=arguments.length>7?arguments[7]:void 0,f=arguments.length>8&&void 0!==arguments[8]&&arguments[8],g=0,y=!1;f&&(c=i.Lumberjack.newLumberMetric(i.LumberEventName.RequestWithRetry,r));try{do{try{a=await e(),y=!0,g>=1&&i.Lumberjack.info(`Succeeded in executing ${t} with ${g} retries`,r)}catch(e){if(void 0!==p&&p(e),i.Lumberjack.error(`Error running ${t}: retryCount ${g}`,r,e),void 0!==l&&!1===l(e))return i.Lumberjack.error(`Should not retry ${t} for the current error, rejecting`,r,e),Promise.reject(e);if(-1!==h&&g>=h)return i.Lumberjack.error(`Error after retrying ${g} times, rejecting`,r,e),Promise.reject(e);const s=m(e,g,d);await(0,n.delay)(s),g++}}while(!y);return a}finally{f&&c&&(c.setProperty("retryCount",g),c.setProperty("callName",t),c.setProperty("maxRetries",h),c.setProperty("retryAfterMs",d),y?c.success("requestWithRetry succeeded"):c.error("requestWithRetry failed",u))}},t.shouldRetryNetworkError=s,t.calculateRetryIntervalForNetworkError=o},CKwV:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MongoDatabaseManager=void 0,t.MongoDatabaseManager=class{constructor(e,t,r,n,i,s,o){this.globalDbEnabled=e,this.operationsDbMongoManager=t,this.globalDbMongoManager=r,this.nodeCollectionName=n,this.documentsCollectionName=i,this.deltasCollectionName=s,this.scribeDeltasCollectionName=o}async getNodeCollection(){return this.getCollection(this.nodeCollectionName)}async getDocumentCollection(){return this.getCollection(this.documentsCollectionName)}async getDeltaCollection(e,t){return this.getCollection(this.deltasCollectionName)}async getScribeDeltaCollection(e,t){return this.getCollection(this.scribeDeltasCollectionName)}async getCollection(e){return(e===this.documentsCollectionName&&this.globalDbEnabled?await this.globalDbMongoManager.getDatabase():await this.operationsDbMongoManager.getDatabase()).collection(e)}}},CXFK:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.logCommonSessionEndMetrics=t.createSessionMetric=void 0;const n=r("MPeK"),i=r("tp/L");t.createSessionMetric=(e,t,r,n)=>{if(!n.enableLumberjack)return;const s=i.Lumberjack.newLumberMetric(r);return null==s||s.setProperties({[i.BaseTelemetryProperties.tenantId]:e,[i.BaseTelemetryProperties.documentId]:t}),s},t.logCommonSessionEndMetrics=(e,t,r,s,o,a)=>{if(!r)return;const c=e.getContextError();r.setProperties({[i.CommonProperties.sessionEndReason]:t}),r.setProperties({[i.CommonProperties.sessionState]:i.SessionState.end}),r.setProperties({[i.CommonProperties.sequenceNumber]:s}),r.setProperties({[i.CommonProperties.lastSummarySequenceNumber]:o}),c?r.error(`Session terminated due to ${c}`):t===n.LambdaCloseType.Error?r.error("Session terminated due to error"):t&&t!==n.LambdaCloseType.Stop&&t!==n.LambdaCloseType.Rebalance?t===n.LambdaCloseType.ActivityTimeout?(null==a?void 0:a.includes(n.NackMessagesType.SummaryMaxOps))?r.error("Session terminated due to inactivity while exceeding max ops since last summary"):r.success("Session terminated due to inactivity"):r.error("Unknown session end state"):(r.setProperties({[i.CommonProperties.sessionState]:i.SessionState.paused}),r.success("Session paused"))}},DKo5:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NackMessagesType=t.ControlMessageType=t.SystemOperations=t.BoxcarType=t.SystemType=t.SignalOperationType=t.NackOperationType=t.SequencedOperationType=t.RawOperationType=void 0,t.RawOperationType="RawOperation",t.SequencedOperationType="SequencedOperation",t.NackOperationType="Nack",t.SignalOperationType="Signal",t.SystemType="System",t.BoxcarType="boxcar",function(e){e[e.Join=0]="Join",e[e.Leave=1]="Leave"}(t.SystemOperations||(t.SystemOperations={})),function(e){e.UpdateDSN="updateDSN",e.NackMessages="nackMessages",e.LambdaStartResult="lambdaStartResult",e.ExtendClient="extendClient"}(t.ControlMessageType||(t.ControlMessageType={})),function(e){e.SummaryMaxOps="summaryMaxOps"}(t.NackMessagesType||(t.NackMessagesType={}))},DcAE:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReservationManager=void 0;const n=r("hBZP");t.ReservationManager=class extends n.EventEmitter{constructor(e,t,r){super(),this.nodeTracker=e,this.mongoManager=t,this.reservationColletionName=r}async getOrReserve(e,t){const r=await this.getReservationsCollection(),n=await r.findOne({_id:e});if(null===n)return await this.makeReservation(t,e,null,r),t;{const i=await this.nodeTracker.loadRemote(n.node);return i.valid?i:(await this.makeReservation(t,e,n,r),t)}}async makeReservation(e,t,r,n){const i={_id:t,node:e.id};await(r?n.update({_id:t,node:r.node},i,null):n.insertOne(i))}async getReservationsCollection(){return(await this.mongoManager.getDatabase()).collection(this.reservationColletionName)}}},DjzM:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LocalLambdaController=void 0;const n=r("hBZP"),i=r("yQiv");t.LocalLambdaController=class extends n.EventEmitter{constructor(e,t,r,n){super(),this.kafaka=e,this.setup=t,this.context=r,this.starter=n,this._state="created",this.kafaka.subscribe(this)}get state(){return this._state}async start(){if("closed"!==this._state)try{this.lambda=await this.starter(this.setup,this.context),"created"===this._state&&(this._state="started"),this.emit("started",this.lambda),"closed"===this._state&&this.close()}catch(e){this.context.error(e,{restart:!0}),this.startTimer=setTimeout((()=>{this.start()}),5e3)}}close(){this._state="closed",this.lambda&&(this.lambda.close(i.LambdaCloseType.Stop),this.lambda=void 0),void 0!==this.startTimer&&(clearTimeout(this.startTimer),this.startTimer=void 0),this.removeAllListeners()}process(e){if(!this.lambda)throw new Error("The lambda has not started yet");return this.lambda.handler(e)}}},E3fA:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MongoDocumentRepository=void 0,t.MongoDocumentRepository=class{constructor(e){this.collection=e}async readOne(e){return this.collection.findOne(e)}async updateOne(e,t,r){const n=void 0;await((null==r?void 0:r.upsert)?this.collection.upsert(e,t,n,r):this.collection.update(e,t,n,r))}async findOneOrCreate(e,t){return this.collection.findOrCreate(e,t,arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0)}async findOneAndUpdate(e,t){return this.collection.findAndUpdate(e,t,arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0)}async create(e){return this.collection.insertOne(e)}async exists(e){return this.collection.findOne(e,{projection:{_id:1}}).then((e=>!!e))}}},EA0Q:function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MoiraLambda=void 0;const i=r("MPeK"),s=r("tp/L"),o=n(r("thXI")),a=n(r("czhI"));t.MoiraLambda=class{constructor(e,t,r,n){this.context=e,this.serviceConfiguration=t,this.tenantId=r,this.documentId=n,this.pending=new Map,this.current=new Map}handler(e){const t=(0,i.extractBoxcar)(e);for(const e of t.contents)if(e.type===i.SequencedOperationType){const t=e;t.operation.traces=[];const r=`${t.tenantId}/${t.documentId}`;let n=this.pending.get(r);n||(n=[],this.pending.set(r,n)),n.push(t)}this.pendingOffset=e,this.sendPending()}close(){this.pending.clear(),this.current.clear()}sendPending(){if(this.current.size>0||0===this.pending.size)return;const e=this.current;this.current=this.pending,this.pending=e;const t=this.pendingOffset,r=[];for(const[,e]of this.current){const t=this.processMoiraCoreParallel(e);r.push(t)}Promise.all(r).then((()=>{this.current.clear(),this.context.checkpoint(t),this.sendPending()}),(e=>{this.context.error(e,{restart:!0})}))}createDerivedGuid(e,t){const r=(0,o.default)("sha1").update(`${e}:${t}`).digest("hex");return`${r.substr(0,8)}-${r.substr(8,4)}-${r.substr(12,4)}-${r.substr(16,4)}-${r.substr(20,12)}`}async processMoiraCoreParallel(e){var t,r,n,i;const s=new Map;for(const o of e)if("op"===(null===(t=null==o?void 0:o.operation)||void 0===t?void 0:t.type)){const e=JSON.parse(o.operation.contents),t=null===(i=null===(n=null===(r=e.contents)||void 0===r?void 0:r.contents)||void 0===n?void 0:n.content)||void 0===i?void 0:i.contents;if(t&&0===t.op&&void 0!==t.changeSet){const r=e.contents.contents.content.address,n=s.get(r);s.set(r,n?n.then((async()=>this.processMoiraCore(r,t,o))):this.processMoiraCore(r,t,o))}}return Promise.all(s.values())}async processMoiraCore(e,t,r){var n;const i=t.guid,o=`MH Commit: branch: ${e},\n        commit ${i},\n        changeSet:  ${JSON.stringify(t.changeSet,void 0,2)}`;null===(n=this.context.log)||void 0===n||n.info(o),this.serviceConfiguration.enableLumberjack&&s.Lumberjack.info(o,(0,s.getLumberBaseProperties)(this.documentId,this.tenantId));let a=t.referenceGuid;""===t.referenceGuid&&(a=await this.createBranch(e)),await this.createCommit(i,a,e,t,r)}async createBranch(e){var t,r;const n=this.createDerivedGuid(e,"root"),i=await a.default.post(`${this.serviceConfiguration.moira.endpoint}/branch`,{guid:e,rootCommitGuid:n,meta:{},created:0}),o=Object.assign(Object.assign({},(0,s.getLumberBaseProperties)(this.documentId,this.tenantId)),{[s.CommonProperties.statusCode]:i.status});if(200===i.status){const r=`Branch with guid: ${e} created`;null===(t=this.context.log)||void 0===t||t.info(r),this.serviceConfiguration.enableLumberjack&&s.Lumberjack.info(r,o)}else{const t=`Branch with guid ${e} failed`;null===(r=this.context.log)||void 0===r||r.error(t),this.serviceConfiguration.enableLumberjack&&s.Lumberjack.error(t,o)}return n}async createCommit(e,t,r,n,i){var o,c,u;try{const u={guid:e,branchGuid:r,parentGuid:t,meta:{remoteHeadGuid:n.remoteHeadGuid,localBranchStart:n.localBranchStart,sequenceNumber:i.operation.sequenceNumber,minimumSequenceNumber:i.operation.minimumSequenceNumber}},l=await a.default.post(`${this.serviceConfiguration.moira.endpoint}/branch/${r}/commit`,Object.assign(Object.assign({},u),{changeSet:JSON.stringify(n.changeSet),rebase:!0})),h=Object.assign(Object.assign({},(0,s.getLumberBaseProperties)(this.documentId,this.tenantId)),{[s.CommonProperties.statusCode]:l.status});if(200===l.status){const e=`Commit created ${JSON.stringify(u)}`;null===(o=this.context.log)||void 0===o||o.info(e),this.serviceConfiguration.enableLumberjack&&s.Lumberjack.info(e,h)}else{const e=`Commit failed ${JSON.stringify(u)}`;null===(c=this.context.log)||void 0===c||c.error(e),this.serviceConfiguration.enableLumberjack&&s.Lumberjack.error(e,h)}}catch(e){const t=`Commit failed. ${e.message}`;null===(u=this.context.log)||void 0===u||u.error(t),this.serviceConfiguration.enableLumberjack&&s.Lumberjack.error(t,(0,s.getLumberBaseProperties)(this.documentId,this.tenantId),e)}}}},ELGQ:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CopierLambdaFactory=t.CopierLambda=void 0;var n=r("oVfu");Object.defineProperty(t,"CopierLambda",{enumerable:!0,get:function(){return n.CopierLambda}});var i=r("zKO3");Object.defineProperty(t,"CopierLambdaFactory",{enumerable:!0,get:function(){return i.CopierLambdaFactory}})},EwJK:function(e,t){e.exports=function(e){return e&&"object"==typeof e&&"function"==typeof e.copy&&"function"==typeof e.fill&&"function"==typeof e.readUInt8}},EwxO:function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return i(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.ForemanLambda=void 0;const o=r("wWog"),a=r("y2M+"),c=s(r("yQiv")),u=r("fhs9");t.ForemanLambda=class{constructor(e,t,r,n,i,s,a){this.messageSender=e,this.tenantManager=t,this.tokenGenerator=r,this.permissions=n,this.context=i,this.tenantId=s,this.documentId=a,this.taskQueueMap=new Map,this.rateLimiter=new o.RateLimiter(15e3);for(const e in this.permissions)for(const t of this.permissions[e])this.taskQueueMap.set(t,e)}close(){}async handler(e){const t=c.extractBoxcar(e);for(const e of t.contents)if(e.type===c.SequencedOperationType){const t=e;if(t.operation.type===a.MessageType.RemoteHelp){const e=JSON.parse(t.operation.data),r=e.version?e.tasks.map((e=>`chain-${e}`)):e.tasks;await this.trackDocument(t.operation.clientId,t.tenantId,t.documentId,r)}}this.context.checkpoint(e)}async trackDocument(e,t,r,n){var i;const s=await this.tenantManager.getKey(t),o=this.generateQueueTasks(n);for(const n of o){const o=n[0],c=this.rateLimiter.filter(e,n[1]);if(c.length>0){const n={documentId:r,message:{tasks:c},tenantId:t,token:this.tokenGenerator(t,r,s,[a.ScopeType.DocRead,a.ScopeType.DocWrite,a.ScopeType.SummaryWrite])};this.messageSender.sendTask(o,{content:n,type:"tasks:start"}),null===(i=this.context.log)||void 0===i||i.info(`Request to ${o}: ${e}:${JSON.stringify(c)}`,{messageMetaData:{documentId:r,tenantId:t}}),u.Lumberjack.info(`Request to ${o}: ${e}:${JSON.stringify(c)}`,{[u.BaseTelemetryProperties.tenantId]:t,[u.BaseTelemetryProperties.documentId]:r})}}}generateQueueTasks(e){const t=new Map;for(const r of e){const e=this.taskQueueMap.get(r);if(e){let n=t.get(e);n||(n=[],t.set(e,n)),n.push(r)}}return t}}},FMpQ:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConnectionCountLogger=void 0;const n=r("tp/L");t.ConnectionCountLogger=class{constructor(){let e=arguments.length>1?arguments[1]:void 0;this.nodeName=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"nodeName",this.cache=e,this.perClusterKeyName="totalConnections",this.perNodeKeyName=`totalConnections_${this.nodeName}`}incrementConnectionCount(){const e=n.Lumberjack.newLumberMetric(n.LumberEventName.ConnectionCountPerNode),t=n.Lumberjack.newLumberMetric(n.LumberEventName.TotalConnectionCount);if(!this.cache||!this.cache.incr)return e.error("Redis Cache not found."),void t.error("Redis Cache not found.");this.cache.incr(this.perNodeKeyName).then((t=>{e.setProperty("TotalConnectionCount",t),e.success("Connection count incremented for node.")}),(t=>{e.error("Error while incrementing connection count for node.",t)})),this.cache.incr(this.perClusterKeyName).then((e=>{t.setProperty("TotalConnectionCount",e),t.success("Total connection count incremented.")}),(e=>{t.error("Error while incrementing total connection count for cluster.",e)}))}decrementConnectionCount(){const e=n.Lumberjack.newLumberMetric(n.LumberEventName.ConnectionCountPerNode),t=n.Lumberjack.newLumberMetric(n.LumberEventName.TotalConnectionCount);if(!this.cache||!this.cache.decr)return e.error("Redis Cache not found."),void t.error("Redis Cache not found.");this.cache.decr(this.perNodeKeyName).then((t=>{e.setProperty("TotalConnectionCount",t),e.success("Connection count decremented for node.")}),(t=>{e.error("Error while decrementing connection count for node",t)})),this.cache.decr(this.perClusterKeyName).then((e=>{t.setProperty("TotalConnectionCount",e),t.success("Total connection count decremented.")}),(e=>{t.error("Error while decrementing total connection count for cluster.",e)}))}}},FY09:function(e,t,r){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.getLumberBaseProperties=t.handleError=t.SessionState=t.ThrottlingTelemetryProperties=t.CommonProperties=t.HttpProperties=t.QueuedMessageProperties=t.BaseTelemetryProperties=t.LumberType=t.LogLevel=void 0;const n=r("O3lp"),i=r("0nFT"),s="undefined"!=typeof window&&void 0!==window.document,o=void 0!==e&&null!=e.versions&&null!=e.versions.node;var a,c;!function(e){e[e.Error=0]="Error",e[e.Warning=1]="Warning",e[e.Info=2]="Info",e[e.Verbose=3]="Verbose",e[e.Debug=4]="Debug"}(t.LogLevel||(t.LogLevel={})),function(e){e[e.Metric=0]="Metric",e[e.Log=1]="Log"}(a=t.LumberType||(t.LumberType={})),function(e){e.tenantId="tenantId",e.documentId="documentId",e.correlationId="correlationId"}(c=t.BaseTelemetryProperties||(t.BaseTelemetryProperties={})),function(e){e.topic="topic",e.partition="partition",e.offset="offset",e.offsetStart="offsetStart",e.offsetEnd="offsetEnd"}(t.QueuedMessageProperties||(t.QueuedMessageProperties={})),function(e){e.driverVersion="driverVersion",e.method="method",e.pathCategory="pathCategory",e.requestContentLength="requestContentLength",e.responseContentLength="responseContentLength",e.responseTime="responseTime",e.status="status",e.url="url"}(t.HttpProperties||(t.HttpProperties={})),function(e){e.clientId="clientId",e.clientType="clientType",e.clientCount="clientCount",e.clientDriverVersion="clientDriverVersion",e.sessionState="sessionState",e.sessionEndReason="sessionEndReason",e.minSequenceNumber="minSequenceNumber",e.sequenceNumber="sequenceNumber",e.checkpointOffset="checkpointOffset",e.clientSummarySuccess="clientSummarySuccess",e.serviceSummarySuccess="serviceSummarySuccess",e.maxOpsSinceLastSummary="maxOpsSinceLastSummary",e.lastSummarySequenceNumber="lastSummarySequenceNumber",e.minLogtailSequenceNumber="minLogtailSequenceNumber",e.maxLogtailSequenceNumber="maxLogtailSequenceNumber",e.statusCode="statusCode",e.errorCode="errorCode",e.restart="restart",e.serviceName="serviceName",e.telemetryGroupName="telemetryGroupName",e.totalBatchSize="totalBatchSize"}(t.CommonProperties||(t.CommonProperties={})),function(e){e.key="key",e.reason="reason",e.retryAfterInSeconds="retryAfterInSeconds",e.weight="weight"}(t.ThrottlingTelemetryProperties||(t.ThrottlingTelemetryProperties={})),function(e){e.started="started",e.resumed="resumed",e.paused="paused",e.end="end",e.LambdaStartFailed="lambdaStartFailed"}(t.SessionState||(t.SessionState={})),t.handleError=function(t,r,c){var u;if(!s&&o&&(null===(u=null==e?void 0:e.env)||void 0===u?void 0:u.IS_FLUID_SERVER)){const e=new Error(r);0===c.length?console.error((0,n.serializeError)(e)):new i.Lumber(t,a.Metric,c).error(r,e)}},t.getLumberBaseProperties=(e,t)=>({[c.tenantId]:t,[c.documentId]:e})}).call(this,r("5IsQ"))},Fazr:function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return i(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.TestDbFactory=t.TestDb=t.TestCollection=void 0;const o=r("hBZP"),a=s(r("9va6"));class c{constructor(e){this.collection=e}async aggregate(e,t){throw new Error("Method not implemented.")}async find(e,t){return this.findInternal(e,t)}async findAll(){return this.collection}async findOne(e){return this.findOneInternal(e)}async update(e,t,r){const n=this.findOneInternal(e);if(!n)return Promise.reject(new Error("Not found"));a.extend(n,t)}async updateMany(e,t,r){const n=this.findInternal(e);try{n.forEach((e=>{if(!e)throw new Error("Not found");a.extend(e,t)}))}catch(e){return Promise.reject(e)}}async upsert(e,t,r){const n=this.findOneInternal(e);n||this.collection.push(t),a.extend(n,t)}async insertOne(e){return null!==this.findOneInternal(e)?Promise.resolve("existing object"):this.insertOneInternal(e)}async findOrCreate(e,t){const r=this.findOneInternal(e);return r?{value:r,existing:!0}:{value:this.insertOneInternal(t),existing:!1}}async findAndUpdate(e,t){const r=this.findOneInternal(e);return r?(this.removeOneInternal(r),this.insertOneInternal(t),{value:r,existing:!0}):{value:r,existing:!1}}async insertMany(e,t){e.forEach((e=>{this.collection.push(e)}))}async deleteOne(e){const t=this.findOneInternal(e);return this.removeOneInternal(t),t}async deleteMany(e){const t=this.findInternal(e);return t.forEach((e=>{this.removeOneInternal(e)})),t}async distinct(e,t){throw new Error("Method not implemented.")}async createIndex(e,t){throw new Error("Method not implemented.")}insertOneInternal(e){return this.collection.push(e),e}removeOneInternal(e){const t=this.collection.indexOf(e);t>=0&&this.collection.splice(t,1)}findOneInternal(e){let t;return t=e._id?this.collection.find((t=>t._id===e._id)):this.findInternal(e)[0],void 0===t?null:t}findInternal(e,t){function r(e,t){const r=t.split(".");let n=e;return r.forEach((e=>{n=n[e]})),n}const n=Object.keys(e);let i=this.collection;return n.forEach((t=>{e[t]&&(e[t].$gt>0||e[t].$lt>0||e[t].$lte>0?(e[t].$gt>0&&(i=i.filter((n=>r(n,t)>e[t].$gt))),e[t].$lt>0&&(i=i.filter((n=>r(n,t)<e[t].$lt))),e[t].$lte>0&&(i=i.filter((n=>r(n,t)<=e[t].$lte)))):i=i.filter((n=>r(n,t)===e[t])))})),t&&1===Object.keys(t).length&&(i=i.sort((function(e,n){const i=Object.keys(t)[0];return 1===t[i]?r(e,i)-r(n,i):r(n,i)-r(e,i)}))),i}}t.TestCollection=c;class u{constructor(e){this.collections=e,this.emitter=new o.EventEmitter}async close(){}on(e,t){this.emitter.on(e,t)}collection(e){return e in this.collections||(this.collections[e]=[]),new c(this.collections[e])}async dropCollection(e){return!Object.prototype.hasOwnProperty.call(this.collections,e)||(delete this.collections[e],!0)}}t.TestDb=u,t.TestDbFactory=class{constructor(e){this.testDatabase=new u(e)}async connect(){return this.testDatabase}}},FkTQ:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ForemanLambdaFactory=void 0;const n=r("hBZP"),i=r("l8a6");t.ForemanLambdaFactory=class extends n.EventEmitter{constructor(e,t,r,n){super(),this.messageSender=e,this.tenantManager=t,this.tokenGenerator=r,this.permissions=n,this.messageSender.on("error",(e=>{this.emit("error",e)}))}async create(e,t){return new i.ForemanLambda(this.messageSender,this.tenantManager,this.tokenGenerator,this.permissions,t,e.tenantId,e.documentId)}async dispose(){await this.messageSender.close()}}},FpcY:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NackMessagesType=t.ControlMessageType=t.SystemOperations=t.BoxcarType=t.SystemType=t.SignalOperationType=t.NackOperationType=t.SequencedOperationType=t.RawOperationType=void 0,t.RawOperationType="RawOperation",t.SequencedOperationType="SequencedOperation",t.NackOperationType="Nack",t.SignalOperationType="Signal",t.SystemType="System",t.BoxcarType="boxcar",function(e){e[e.Join=0]="Join",e[e.Leave=1]="Leave"}(t.SystemOperations||(t.SystemOperations={})),function(e){e.UpdateDSN="updateDSN",e.NackMessages="nackMessages",e.LambdaStartResult="lambdaStartResult",e.ExtendClient="extendClient"}(t.ControlMessageType||(t.ControlMessageType={})),function(e){e.SummaryMaxOps="summaryMaxOps"}(t.NackMessagesType||(t.NackMessagesType={}))},FszL:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createCompositeTokenId=t.TokenRevocationError=void 0;const n=r("YkJt");t.TokenRevocationError=class extends n.NetworkError{constructor(e,t,r,n,i,s){super(t,r,n,i,s),this.requestId=e}get details(){return{message:this.message,requestId:this.requestId,canRetry:this.canRetry,isFatal:this.isFatal,retryAfter:this.retryAfter,retryAfterMs:this.retryAfterMs}}toJSON(){return Object.assign({requestId:this.requestId},super.toJSON())}},t.createCompositeTokenId=function(e,t,r){return`${e}/${t}/${r}`}},FyNQ:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CombinedProducer=void 0,t.CombinedProducer=class{constructor(e,t){this.producers=e,this.parallel=t}isConnected(){return this.producers.every((e=>e.isConnected()))}async send(e,t,r){if(this.parallel){const n=[];for(const i of this.producers)n.push(i.send(e,t,r));return Promise.all(n)}for(const n of this.producers)await n.send(e,t,r)}async close(){const e=[];for(const t of this.producers)e.push(t.close());await Promise.all(e)}on(e,t){return this}once(e,t){return this}}},G8Jv:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ThrottlingError=void 0;const n=r("y2M+");t.ThrottlingError=class{constructor(e,t){this.message=e,this.retryAfter=t,this.code=429,this.type=n.NackErrorType.ThrottlingError}}},G9Py:function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SummaryWriter=void 0;const i=r("wWog"),s=r("iS6B"),o=r("y2M+"),a=r("YkJt"),c=r("yQiv"),u=r("fhs9"),l=n(r("a0Z+"));t.SummaryWriter=class{constructor(e,t,r,n,i,s,o,a){let c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:6;this.tenantId=e,this.documentId=t,this.summaryStorage=r,this.deltaService=n,this.opStorage=i,this.enableWholeSummaryUpload=s,this.lastSummaryMessages=o,this.getDeltasViaAlfred=a,this.maxRetriesOnError=c,this.lumberProperties=(0,u.getLumberBaseProperties)(this.documentId,this.tenantId)}get isExternal(){return!1}async writeClientSummary(e,t,r,n){var i,a,h,d,m;const p=u.Lumberjack.newLumberMetric(u.LumberEventName.ClientSummary);this.setSummaryProperties(p,e);const f=JSON.parse(e.contents);try{const u=await(0,c.requestWithRetry)((async()=>this.summaryStorage.getRef(encodeURIComponent(this.documentId))),"writeClientSummary_getRef",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError);if(f.head){if(!(u&&(t===f.head||u.object.sha===f.head)||null!==(a=null===(i=r.validParentSummaries)||void 0===i?void 0:i.includes(f.head))&&void 0!==a&&a))return p.error("Proposed parent summary does not match actual parent summary"),{message:{message:`Proposed parent summary "${f.head}" does not match actual parent summary "${u?u.object.sha:"n/a"}" nor other valid parent summaries "[${null!==(d=null===(h=r.validParentSummaries)||void 0===h?void 0:h.join(","))&&void 0!==d?d:""}]".`,summaryProposal:{summarySequenceNumber:e.sequenceNumber}},status:!1}}else if(u)return p.error("Proposed parent summary does not match actual parent summary"),{message:{message:`Proposed parent summary "${f.head}" does not match actual parent summary "${u.object.sha}".`,summaryProposal:{summarySequenceNumber:e.sequenceNumber}},status:!1};if(!this.enableWholeSummaryUpload)try{await(0,c.requestWithRetry)((async()=>Promise.all(f.parents.map((async e=>this.summaryStorage.getCommit(e))))),"writeClientSummary_validateParentSummary",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError)}catch(t){return p.error("One or more parent summaries are invalid",t),{message:{message:"One or more parent summaries are invalid",summaryProposal:{summarySequenceNumber:e.sequenceNumber}},status:!1}}if(e.referenceSequenceNumber<r.protocolState.sequenceNumber)return p.error("Proposed summary reference sequence number less than current sequence number"),{message:{message:`Proposed summary reference sequence number ${e.referenceSequenceNumber} is less than current sequence number ${r.protocolState.sequenceNumber}`,summaryProposal:{summarySequenceNumber:e.sequenceNumber}},status:!1};const l=(0,s.getQuorumTreeEntries)(this.documentId,r.protocolState.minimumSequenceNumber,r.protocolState.sequenceNumber,null!==(m=e.term)&&void 0!==m?m:1,r.protocolState),g=await(0,c.requestWithRetry)((async()=>this.generateLogtailEntries(r.protocolState.sequenceNumber,e.sequenceNumber+1,n,this.lastSummaryMessages)),"writeClientSummary_generateLogtailEntries",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError),y=(0,s.generateServiceProtocolEntries)(e.additionalContent,JSON.stringify(r));let v="";if(this.enableWholeSummaryUpload)v=await(0,c.requestWithRetry)((async()=>{var e;return this.updateWholeSummary(f.head,f.handle,l,g,y,r.protocolState.sequenceNumber,null===(e=f.details)||void 0===e?void 0:e.includesProtocolTree)}),"writeClientSummary_updateWholeSummary",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError);else{const[e,t,r,n]=await Promise.all([(0,c.requestWithRetry)((async()=>this.summaryStorage.createTree({entries:g})),"writeClientSummary_createLogTailTree",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError),(0,c.requestWithRetry)((async()=>this.summaryStorage.createTree({entries:l})),"writeClientSummary_createProtocolTree",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError),(0,c.requestWithRetry)((async()=>this.summaryStorage.createTree({entries:y})),"writeClientSummary_createServiceProtocolTree",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError),(0,c.requestWithRetry)((async()=>this.summaryStorage.getTree(f.handle,!1)),"writeClientSummary_getAppSummaryTree",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError)]),i=(0,s.mergeAppAndProtocolTree)(n,t);i.push({mode:o.FileMode.Directory,path:".logTail",sha:e.sha,type:"tree"}),i.push({mode:o.FileMode.Directory,path:".serviceProtocol",sha:r.sha,type:"tree"});const a=await(0,c.requestWithRetry)((async()=>this.summaryStorage.createGitTree({tree:i})),"writeClientSummary_createGitTree",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError),h={author:{date:(new Date).toISOString(),email:"praguertdev@microsoft.com",name:"Routerlicious Service"},message:f.message,parents:f.parents,tree:a.sha},d=await(0,c.requestWithRetry)((async()=>this.summaryStorage.createCommit(h)),"writeClientSummary_createCommit",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError);v=d.sha,await(u?(0,c.requestWithRetry)((async()=>this.summaryStorage.upsertRef(this.documentId,v)),"writeClientSummary_upsertRef",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError):(0,c.requestWithRetry)((async()=>this.summaryStorage.createRef(this.documentId,v)),"writeClientSummary_createRef",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError))}return p.success("Client summary success"),{message:{handle:v,summaryProposal:{summarySequenceNumber:e.sequenceNumber}},status:!0}}catch(t){if(p.error("Client summary failed",t),t instanceof Error&&"NetworkError"===(null==t?void 0:t.name)){const r=t;if(!r.isFatal)return{message:{message:`A non-fatal error happened when trying to write client summary. Error: ${(0,l.default)(r.details)}`,summaryProposal:{summarySequenceNumber:e.sequenceNumber}},status:!1}}throw t}}async writeServiceSummary(e,t,r,n){const i=u.Lumberjack.newLumberMetric(u.LumberEventName.ServiceSummary);this.setSummaryProperties(i,e);try{const a=await(0,c.requestWithRetry)((async()=>this.summaryStorage.getRef(encodeURIComponent(this.documentId))),"writeServiceSummary_getRef",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError);if(!a)return i.error("No prior summaries found"),!1;if(!e.additionalContent)return i.error("Additional content is not defined"),!1;const u=await(0,c.requestWithRetry)((async()=>this.generateLogtailEntries(t,e.sequenceNumber+1,n,this.lastSummaryMessages)),"writeServiceSummary_generateLogtailEntries",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError),l=(0,s.generateServiceProtocolEntries)(e.additionalContent,JSON.stringify(r));let h;if(this.enableWholeSummaryUpload)h=await(0,c.requestWithRetry)((async()=>this.createWholeServiceSummary(a.object.sha,u,l,e.sequenceNumber)),"writeServiceSummary_createWholeServiceSummary",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError);else{const t=await(0,c.requestWithRetry)((async()=>this.summaryStorage.getCommit(a.object.sha)),"writeServiceSummary_getCommit",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError),[r,n,i]=await Promise.all([(0,c.requestWithRetry)((async()=>this.summaryStorage.createTree({entries:u})),"writeServiceSummary_createLogTailTree",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError),(0,c.requestWithRetry)((async()=>this.summaryStorage.createTree({entries:l})),"writeServiceSummary_createServiceProtocolTree",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError),(0,c.requestWithRetry)((async()=>this.summaryStorage.getTree(t.tree.sha,!1)),"writeServiceSummary_getLastSummaryTree",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError)]),s=i.tree.map((e=>({mode:e.mode,path:e.path,sha:e.sha,type:e.type})));s.push({mode:o.FileMode.Directory,path:".logTail",sha:r.sha,type:"tree"}),s.push({mode:o.FileMode.Directory,path:".serviceProtocol",sha:n.sha,type:"tree"});const d=await(0,c.requestWithRetry)((async()=>this.summaryStorage.createGitTree({tree:s})),"writeServiceSummary_createGitTree",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError),m={author:{date:(new Date).toISOString(),email:"praguertdev@microsoft.com",name:"Routerlicious Service"},message:`Service Summary @${e.sequenceNumber}`,parents:[t.sha],tree:d.sha},p=await(0,c.requestWithRetry)((async()=>this.summaryStorage.createCommit(m)),"writeServiceSummary_createCommit",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError);await(0,c.requestWithRetry)((async()=>this.summaryStorage.upsertRef(this.documentId,p.sha)),"writeServiceSummary_upsertRef",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError),h=p.sha}return i.success("Service summary success"),h}catch(e){if(i.error("Service summary failed",e),e instanceof Error&&"NetworkError"===(null==e?void 0:e.name)&&!e.isFatal)return!1;throw e}}setSummaryProperties(e,t){e.setProperties((0,u.getLumberBaseProperties)(this.documentId,this.tenantId)),e.setProperties({[u.CommonProperties.clientId]:t.clientId,[u.CommonProperties.sequenceNumber]:t.sequenceNumber,[u.CommonProperties.minSequenceNumber]:t.minimumSequenceNumber})}async generateLogtailEntries(e,t,r,n){const i=await this.getLogTail(e,t,r),s=await this.getMissingOpsFromLastSummaryLogtail(e,t,i,n),a=s?s.concat(i).sort(((e,t)=>e.sequenceNumber-t.sequenceNumber)):i;if(!(a&&a.length>0&&a.length===t-e-1&&e===a[0].sequenceNumber-1&&t===a[a.length-1].sequenceNumber+1)){const r=[],n=new Set;null==a||a.map((e=>n.add(e.sequenceNumber)));for(let i=e+1;i<t;i++)n.has(i)||r.push(i);u.Lumberjack.info(`FullLogTail missing ops from: ${e} exclusive, to: ${t} exclusive with sequence numbers: ${JSON.stringify(r)}`,this.lumberProperties)}const c=[{mode:o.FileMode.File,path:"logTail",type:o.TreeEntry.Blob,value:{contents:JSON.stringify(a),encoding:"utf-8"}}];return a.length>0&&u.Lumberjack.info(`FullLogTail of length ${a.length} generated from seq no ${a[0].sequenceNumber} to ${a[a.length-1].sequenceNumber}`,this.lumberProperties),c}async getMissingOpsFromLastSummaryLogtail(e,t,r,n){if(t-e<=1)return;const i=new Set;r.forEach((e=>i.add(e.sequenceNumber)));const s=null==n?void 0:n.filter((r=>!i.has(r.sequenceNumber)&&r.sequenceNumber>e&&r.sequenceNumber<t)),o=[];return null==s||s.forEach((e=>o.push(e.sequenceNumber))),o.length>0&&u.Lumberjack.info(`Fetched ops gt: ${e} exclusive, lt: ${t} exclusive of last summary logtail: ${JSON.stringify(o)}`,this.lumberProperties),s}async getLogTail(e,t,r){if(t-e<=1)return[];if(r.length>0){const n=r.filter((r=>r.operation.sequenceNumber>e&&r.operation.sequenceNumber<t)).map((e=>e.operation));if(n.length>0&&n[0].sequenceNumber===e+1&&n[n.length-1].sequenceNumber===t-1)return u.Lumberjack.info(`LogTail of length ${n.length} between ${e+1} and ${t-1} fetched from pending ops`,this.lumberProperties),n}let n=[];if(this.getDeltasViaAlfred)n=await this.deltaService.getDeltas("",this.tenantId,this.documentId,e,t);else{const r={documentId:this.documentId,tenantId:this.tenantId,"operation.sequenceNumber":{$gt:e,$lt:t}};n=(await this.opStorage.find(r,{"operation.sequenceNumber":1})).map((e=>e.operation))}if(u.Lumberjack.info(`LogTail of length ${n.length} fetched from seq no ${e} to ${t}`,this.lumberProperties),n.length!==t-e-1){const i=0===n.length?e:n[n.length-1].sequenceNumber+1;for(const e of r)e.operation.sequenceNumber>=i&&e.operation.sequenceNumber<t&&n.push(e.operation);u.Lumberjack.info(`Populated logtail gaps. nextSeq: ${i} LogtailLength: ${n.length}`,this.lumberProperties)}return n}async updateWholeSummary(e,t,r,n,i,s,c){const u={type:o.SummaryType.Tree,tree:{".protocol":this.createSummaryTreeFromEntry(r),".logTail":this.createSummaryTreeFromEntry(n),".serviceProtocol":this.createSummaryTreeFromEntry(i),".app":{type:o.SummaryType.Handle,handle:c?(0,a.buildTreePath)(t,".app"):t,handleType:o.SummaryType.Tree,embedded:!0}}},l=new a.WholeSummaryUploadManager(this.summaryStorage);return await l.writeSummaryTree(u,e,"container",s)}async createWholeServiceSummary(e,t,r,n){const i={type:o.SummaryType.Tree,tree:{".logTail":this.createSummaryTreeFromEntry(t),".serviceProtocol":this.createSummaryTreeFromEntry(r),".protocol":{type:o.SummaryType.Handle,handle:".protocol",handleType:o.SummaryType.Tree},".app":{type:o.SummaryType.Handle,handle:".app",handleType:o.SummaryType.Tree}}},s=new a.WholeSummaryUploadManager(this.summaryStorage);return await s.writeSummaryTree(i,e,"container",n)}createSummaryTreeFromEntry(e){return{tree:this.createSummaryTreeFromEntryCore(e),type:o.SummaryType.Tree}}createSummaryTreeFromEntryCore(e){const t={};for(const r of e){let e;switch(r.type){case o.TreeEntry.Attachment:e={type:o.SummaryType.Attachment,id:r.value.id};break;case o.TreeEntry.Blob:e={type:o.SummaryType.Blob,content:"base64"===r.value.encoding?(0,i.fromBase64ToUtf8)(r.value.contents):r.value.contents};break;case o.TreeEntry.Tree:e={type:o.SummaryType.Tree,unreferenced:r.value.unreferenced,tree:this.createSummaryTreeFromEntryCore(r.value.entries)};break;default:throw new Error("Unexpected TreeEntry type when converting ITreeEntry.")}t[r.path]=e}return t}}},GGiJ:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MongoManager=void 0;const n=r("s+HU"),i=r("GMi8");t.MongoManager=class{constructor(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3,n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.factory=e,this.shouldReconnect=t,this.reconnectDelayMs=r,this.global=n,this.databaseP=this.connect(this.global)}getDatabase(){return this.databaseP}async close(){return(0,i.debug)("Call close connection to Db"),n.Lumberjack.info("Call close connection to Db"),this.shouldReconnect=!1,(await this.databaseP).close()}connect(){const e=this.factory.connect(arguments.length>0&&void 0!==arguments[0]&&arguments[0]).then((e=>(e.on("error",(e=>{(0,i.debug)("DB Error",e),n.Lumberjack.error("DB Error",void 0,e),this.reconnect(this.reconnectDelayMs)})),e.on("close",(e=>{(0,i.debug)("DB Close"),n.Lumberjack.info("DB Close"),this.reconnect(this.reconnectDelayMs)})),e.on("reconnect",(e=>{(0,i.debug)("DB Reconnect"),n.Lumberjack.info("DB Reconnect")})),e.on("reconnectFailed",(e=>{(0,i.debug)("DB Reconnect failed"),n.Lumberjack.error("DB Reconnect failed",void 0,e)})),e)));return e.catch((e=>{(0,i.debug)("DB Connection Error",e),n.Lumberjack.error("DB Connection Error",void 0,e),this.reconnect(this.reconnectDelayMs)})),(0,i.debug)("Successfully connected"),n.Lumberjack.info("Successfully connected to Db"),e}reconnect(e){if(!this.shouldReconnect)return(0,i.debug)("Should not reconnect to Db"),void n.Lumberjack.info("Should not reconnect to Db");this.databaseP=new Promise((t=>{setTimeout((()=>{const e=this.connect();t(e)}),e)}))}}},GMi8:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.debug=void 0;const n=r("Gstq"),i=r("+gpN");t.debug=(0,n.debug)("fluid:core"),(0,t.debug)(`Package: ${i.pkgName} - Version: ${i.pkgVersion}`)},GkBk:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pkgVersion=t.pkgName=void 0,t.pkgName="@fluidframework/server-services-core",t.pkgVersion="0.1040.1000"},Gluk:function(e,t,r){"use strict";(function(e,n){Object.defineProperty(t,"__esModule",{value:!0}),t.BroadcasterLambda=void 0;const i=r("y2M+"),s=r("yQiv");let o,a;"function"==typeof e?(o=e,a=n):(o=setTimeout,a=clearTimeout),t.BroadcasterLambda=class{constructor(e,t,r,n){this.publisher=e,this.context=t,this.serviceConfiguration=r,this.clientManager=n,this.pending=new Map,this.current=new Map}async handler(e){var t;const r=(0,s.extractBoxcar)(e);for(const e of r.contents){let r,n;switch(e.type){case s.SequencedOperationType:n="op",r=`${e.tenantId}/${e.documentId}`;break;case s.NackOperationType:n="nack",r=`client#${e.clientId}`;break;case s.SignalOperationType:{n="signal";const t=e;if(r=`${t.tenantId}/${t.documentId}`,this.clientManager&&t.operation){const e=JSON.parse(t.operation.content);switch("string"==typeof e.type?e.type:void 0){case i.MessageType.ClientJoin:{const r=e.content;await this.clientManager.addClient(t.tenantId,t.documentId,r.clientId,r.client,t.operation);break}case i.MessageType.ClientLeave:await this.clientManager.removeClient(t.tenantId,t.documentId,e.content,t.operation)}}break}default:continue}const o=e;o.type===s.SequencedOperationType&&(null===(t=o.operation)||void 0===t?void 0:t.traces)&&o.operation.traces.length>0&&o.operation.traces.push({action:"start",service:"broadcaster",timestamp:Date.now()}),this.serviceConfiguration.broadcaster.includeEventInMessageBatchName&&(r+=n);let a=this.pending.get(r);a?a.messages.push(o.operation):(a={tenantId:o.tenantId,documentId:o.documentId,event:n,messages:[o.operation]},this.pending.set(r,a))}this.pendingOffset=e,this.sendPending()}close(){this.pending.clear(),this.current.clear(),this.pendingOffset=void 0,void 0!==this.messageSendingTimerId&&(a(this.messageSendingTimerId),this.messageSendingTimerId=void 0)}hasPendingWork(){return 0!==this.pending.size||0!==this.current.size}sendPending(){void 0===this.messageSendingTimerId&&(0!==this.pending.size?this.messageSendingTimerId=o((async()=>{const e=this.pendingOffset;if(this.current=this.pending,this.pending=new Map,this.pendingOffset=void 0,this.publisher.emitBatch){const e=[];for(const[t,r]of this.current)e.push(this.publisher.emitBatch(t,r));try{await Promise.all(e)}catch(e){return void this.context.error(e,{restart:!0})}}else if(this.publisher.emit){const e=[];for(const[t,r]of this.current)e.push(this.publisher.emit(t,r.event,r.documentId,r.messages));try{await Promise.all(e)}catch(e){return void this.context.error(e,{restart:!0})}}else for(const[e,t]of this.current)this.publisher.to(e).emit(t.event,t.documentId,t.messages);this.messageSendingTimerId=void 0,this.context.checkpoint(e),this.current.clear(),this.sendPending()})):this.pendingOffset&&(this.context.checkpoint(this.pendingOffset),this.pendingOffset=void 0))}}}).call(this,r("oPUo").setImmediate,r("oPUo").clearImmediate)},HCLa:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.clientConnectivityStorageId=t.signalUsageStorageId=void 0,t.signalUsageStorageId="signalUsage",t.clientConnectivityStorageId="clientConnectivityUsage"},HLui:function(e,t,r){var n=r("wfEq"),i=r("KSsY"),s=r("pRMk").Buffer,o=[1518500249,1859775393,-1894007588,-899497514],a=new Array(80);function c(){this.init(),this._w=a,i.call(this,64,56)}function u(e){return e<<1|e>>>31}function l(e){return e<<5|e>>>27}function h(e){return e<<30|e>>>2}function d(e,t,r,n){return 0===e?t&r|~t&n:2===e?t&r|t&n|r&n:t^r^n}n(c,i),c.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this},c.prototype._update=function(e){for(var t=this._w,r=0|this._a,n=0|this._b,i=0|this._c,s=0|this._d,a=0|this._e,c=0;c<16;++c)t[c]=e.readInt32BE(4*c);for(;c<80;++c)t[c]=u(t[c-3]^t[c-8]^t[c-14]^t[c-16]);for(var m=0;m<80;++m){var p=~~(m/20),f=l(r)+d(p,n,i,s)+a+t[m]+o[p]|0;a=s,s=i,i=h(n),n=r,r=f}this._a=r+this._a|0,this._b=n+this._b|0,this._c=i+this._c|0,this._d=s+this._d|0,this._e=a+this._e|0},c.prototype._hash=function(){var e=s.allocUnsafe(20);return e.writeInt32BE(0|this._a,0),e.writeInt32BE(0|this._b,4),e.writeInt32BE(0|this._c,8),e.writeInt32BE(0|this._d,12),e.writeInt32BE(0|this._e,16),e},e.exports=c},I0o8:function(e,t,r){"use strict";r.d(t,"c",(function(){return a})),r.d(t,"d",(function(){return c})),r.d(t,"a",(function(){return u})),r.d(t,"b",(function(){return l}));var n=r("jSVn"),i=r("UNwp"),s=r("A3AF"),o=r("ToCX");function a(e,t,r){if("string"!=typeof e)throw new o.a(403,"Token must be a string. Received: "+typeof e);const n=Object(i.a)(e);if(!n||n.documentId!==t||n.tenantId!==r)throw new o.a(403,"DocumentId and/or TenantId in token claims do not match requested resource");if(void 0===n.scopes||0===n.scopes.length)throw new o.a(403,"Missing scopes in token claims");return n}function c(e,t){if(!e.exp||!e.iat||e.exp-e.iat>t)throw new o.a(403,"Invalid token expiry");const r=1e3*e.exp-(new Date).getTime();if(r<0)throw new o.a(401,"Expired token");return r}function u(e,t,r,i,o){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:3600,c=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"1.0",u=o||l();""!==u.id&&void 0!==u.id||(u=l());const h=Math.round((new Date).getTime()/1e3),d={documentId:t,scopes:i,tenantId:e,user:u,iat:h,exp:h+a,ver:c,jti:Object(s.a)()},m={utf8:r};return n.KJUR.jws.JWS.sign(null,JSON.stringify({alg:"HS256",typ:"JWT"}),d,m)}function l(){return{id:Object(s.a)(),name:Object(s.a)()}}},"IJ/k":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ClientSequenceNumberManager=void 0;const n=r("wWog"),i={compare:(e,t)=>e.referenceSequenceNumber-t.referenceSequenceNumber,min:{canEvict:!0,clientId:void 0,clientSequenceNumber:0,lastUpdate:-1,nack:!1,referenceSequenceNumber:-1,scopes:[]}};t.ClientSequenceNumberManager=class{constructor(){this.clientNodeMap=new Map,this.clientSeqNumbers=new n.Heap(i)}has(e){return this.clientNodeMap.has(e)}get(e){const t=this.clientNodeMap.get(e);if(void 0!==t)return t.value}count(){return this.clientNodeMap.size}peek(){const e=this.clientSeqNumbers.peek();if(void 0!==e)return e.value}cloneValues(){const e=[];for(const[,t]of this.clientNodeMap)e.push(Object.assign({},t.value));return e}upsertClient(e,t,r,n,i){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:[],o=arguments.length>6&&void 0!==arguments[6]&&arguments[6],a=arguments.length>7&&void 0!==arguments[7]?arguments[7]:void 0;const c=this.clientNodeMap.get(e);if(c)return c.value.referenceSequenceNumber=r,c.value.clientSequenceNumber=t,c.value.lastUpdate=n,c.value.nack=o,a&&(c.value.serverMetadata=a),this.clientSeqNumbers.update(c),!1;const u=this.clientSeqNumbers.add({canEvict:i,clientId:e,clientSequenceNumber:t,lastUpdate:n,nack:o,referenceSequenceNumber:r,scopes:s,serverMetadata:a});return this.clientNodeMap.set(e,u),!0}removeClient(e){const t=this.clientNodeMap.get(e);return!!t&&(this.clientSeqNumbers.remove(t),this.clientNodeMap.delete(e),!0)}getMinimumSequenceNumber(){return this.clientSeqNumbers.count()>0?this.clientSeqNumbers.peek().value.referenceSequenceNumber:-1}}},JGNH:function(e,t,r){"use strict";r.d(t,"a",(function(){return i}));var n=r("Gstq");const i=Object(n.debug)("fluid:services-client");i("Package: @fluidframework/server-services-client - Version: 0.1039.1000")},JKLl:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ForemanLambdaFactory=t.ForemanLambda=void 0;var n=r("EwxO");Object.defineProperty(t,"ForemanLambda",{enumerable:!0,get:function(){return n.ForemanLambda}});var i=r("YczK");Object.defineProperty(t,"ForemanLambdaFactory",{enumerable:!0,get:function(){return i.ForemanLambdaFactory}})},JVlB:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NoOpLambda=t.logCommonSessionEndMetrics=t.isDocumentValid=t.isDocumentSessionValid=t.generateClientId=t.createSessionMetric=t.createRoomLeaveMessage=t.createRoomJoinMessage=t.createNackMessage=t.ScriptoriumLambdaFactory=t.ScriptoriumLambda=t.SummaryWriter=t.SummaryReader=t.ScribeLambdaFactory=t.ScribeLambda=t.CheckpointManager=t.MoiraLambdaFactory=t.MoiraLambda=t.ForemanLambdaFactory=t.ForemanLambda=t.OpEventType=t.DeliLambdaFactory=t.DeliLambda=t.createDeliCheckpointManagerFromCollection=t.CopierLambdaFactory=t.CopierLambda=t.BroadcasterLambdaFactory=t.BroadcasterLambda=t.configureWebSocketServices=void 0;var n=r("RJnL");Object.defineProperty(t,"configureWebSocketServices",{enumerable:!0,get:function(){return n.configureWebSocketServices}});var i=r("l3fm");Object.defineProperty(t,"BroadcasterLambda",{enumerable:!0,get:function(){return i.BroadcasterLambda}}),Object.defineProperty(t,"BroadcasterLambdaFactory",{enumerable:!0,get:function(){return i.BroadcasterLambdaFactory}});var s=r("QoBq");Object.defineProperty(t,"CopierLambda",{enumerable:!0,get:function(){return s.CopierLambda}}),Object.defineProperty(t,"CopierLambdaFactory",{enumerable:!0,get:function(){return s.CopierLambdaFactory}});var o=r("i1rq");Object.defineProperty(t,"createDeliCheckpointManagerFromCollection",{enumerable:!0,get:function(){return o.createDeliCheckpointManagerFromCollection}}),Object.defineProperty(t,"DeliLambda",{enumerable:!0,get:function(){return o.DeliLambda}}),Object.defineProperty(t,"DeliLambdaFactory",{enumerable:!0,get:function(){return o.DeliLambdaFactory}}),Object.defineProperty(t,"OpEventType",{enumerable:!0,get:function(){return o.OpEventType}});var a=r("ZjQw");Object.defineProperty(t,"ForemanLambda",{enumerable:!0,get:function(){return a.ForemanLambda}}),Object.defineProperty(t,"ForemanLambdaFactory",{enumerable:!0,get:function(){return a.ForemanLambdaFactory}});var c=r("+UOQ");Object.defineProperty(t,"MoiraLambda",{enumerable:!0,get:function(){return c.MoiraLambda}}),Object.defineProperty(t,"MoiraLambdaFactory",{enumerable:!0,get:function(){return c.MoiraLambdaFactory}});var u=r("/3DN");Object.defineProperty(t,"CheckpointManager",{enumerable:!0,get:function(){return u.CheckpointManager}}),Object.defineProperty(t,"ScribeLambda",{enumerable:!0,get:function(){return u.ScribeLambda}}),Object.defineProperty(t,"ScribeLambdaFactory",{enumerable:!0,get:function(){return u.ScribeLambdaFactory}}),Object.defineProperty(t,"SummaryReader",{enumerable:!0,get:function(){return u.SummaryReader}}),Object.defineProperty(t,"SummaryWriter",{enumerable:!0,get:function(){return u.SummaryWriter}});var l=r("MNj0");Object.defineProperty(t,"ScriptoriumLambda",{enumerable:!0,get:function(){return l.ScriptoriumLambda}}),Object.defineProperty(t,"ScriptoriumLambdaFactory",{enumerable:!0,get:function(){return l.ScriptoriumLambdaFactory}});var h=r("Txkb");Object.defineProperty(t,"createNackMessage",{enumerable:!0,get:function(){return h.createNackMessage}}),Object.defineProperty(t,"createRoomJoinMessage",{enumerable:!0,get:function(){return h.createRoomJoinMessage}}),Object.defineProperty(t,"createRoomLeaveMessage",{enumerable:!0,get:function(){return h.createRoomLeaveMessage}}),Object.defineProperty(t,"createSessionMetric",{enumerable:!0,get:function(){return h.createSessionMetric}}),Object.defineProperty(t,"generateClientId",{enumerable:!0,get:function(){return h.generateClientId}}),Object.defineProperty(t,"isDocumentSessionValid",{enumerable:!0,get:function(){return h.isDocumentSessionValid}}),Object.defineProperty(t,"isDocumentValid",{enumerable:!0,get:function(){return h.isDocumentValid}}),Object.defineProperty(t,"logCommonSessionEndMetrics",{enumerable:!0,get:function(){return h.logCommonSessionEndMetrics}}),Object.defineProperty(t,"NoOpLambda",{enumerable:!0,get:function(){return h.NoOpLambda}})},JtJg:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.KeyName=void 0,function(e){e.key1="key1",e.key2="key2"}(t.KeyName||(t.KeyName={}))},JyNL:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SummaryWriter=t.SummaryReader=t.ScribeLambdaFactory=t.ScribeLambda=t.CheckpointManager=void 0;var n=r("k7It");Object.defineProperty(t,"CheckpointManager",{enumerable:!0,get:function(){return n.CheckpointManager}});var i=r("Xo3u");Object.defineProperty(t,"ScribeLambda",{enumerable:!0,get:function(){return i.ScribeLambda}});var s=r("x4EH");Object.defineProperty(t,"ScribeLambdaFactory",{enumerable:!0,get:function(){return s.ScribeLambdaFactory}});var o=r("d6tz");Object.defineProperty(t,"SummaryReader",{enumerable:!0,get:function(){return o.SummaryReader}});var a=r("G9Py");Object.defineProperty(t,"SummaryWriter",{enumerable:!0,get:function(){return a.SummaryWriter}})},KCgx:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PendingMessageReader=void 0;const n=r("tp/L");t.PendingMessageReader=class{constructor(e,t,r){this.tenantId=e,this.documentId=t,this.deltaService=r}async readMessages(e,t){return n.Lumberjack.info(`Fetching pending messages from ${e} to ${t}`,(0,n.getLumberBaseProperties)(this.documentId,this.tenantId)),this.deltaService.getDeltas("",this.tenantId,this.documentId,e-1,t+1)}}},KMXR:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConnectionCountLogger=t.CheckpointReason=t.isDocumentValid=t.isDocumentSessionValid=t.logCommonSessionEndMetrics=t.createSessionMetric=t.NoOpLambda=t.createRoomLeaveMessage=t.createRoomJoinMessage=t.createNackMessage=t.generateClientId=void 0;var n=r("d53T");Object.defineProperty(t,"generateClientId",{enumerable:!0,get:function(){return n.generateClientId}});var i=r("r43a");Object.defineProperty(t,"createNackMessage",{enumerable:!0,get:function(){return i.createNackMessage}}),Object.defineProperty(t,"createRoomJoinMessage",{enumerable:!0,get:function(){return i.createRoomJoinMessage}}),Object.defineProperty(t,"createRoomLeaveMessage",{enumerable:!0,get:function(){return i.createRoomLeaveMessage}});var s=r("AN3h");Object.defineProperty(t,"NoOpLambda",{enumerable:!0,get:function(){return s.NoOpLambda}});var o=r("96zj");Object.defineProperty(t,"createSessionMetric",{enumerable:!0,get:function(){return o.createSessionMetric}}),Object.defineProperty(t,"logCommonSessionEndMetrics",{enumerable:!0,get:function(){return o.logCommonSessionEndMetrics}});var a=r("Us1W");Object.defineProperty(t,"isDocumentSessionValid",{enumerable:!0,get:function(){return a.isDocumentSessionValid}}),Object.defineProperty(t,"isDocumentValid",{enumerable:!0,get:function(){return a.isDocumentValid}});var c=r("AYbU");Object.defineProperty(t,"CheckpointReason",{enumerable:!0,get:function(){return c.CheckpointReason}});var u=r("wGlg");Object.defineProperty(t,"ConnectionCountLogger",{enumerable:!0,get:function(){return u.ConnectionCountLogger}})},KSsY:function(e,t,r){var n=r("pRMk").Buffer;function i(e,t){this._block=n.alloc(e),this._finalSize=t,this._blockSize=e,this._len=0}i.prototype.update=function(e,t){"string"==typeof e&&(e=n.from(e,t=t||"utf8"));for(var r=this._block,i=this._blockSize,s=e.length,o=this._len,a=0;a<s;){for(var c=o%i,u=Math.min(s-a,i-c),l=0;l<u;l++)r[c+l]=e[a+l];a+=u,(o+=u)%i==0&&this._update(r)}return this._len+=s,this},i.prototype.digest=function(e){var t=this._len%this._blockSize;this._block[t]=128,this._block.fill(0,t+1),t>=this._finalSize&&(this._update(this._block),this._block.fill(0));var r=8*this._len;if(r<=4294967295)this._block.writeUInt32BE(r,this._blockSize-4);else{var n=(4294967295&r)>>>0;this._block.writeUInt32BE((r-n)/4294967296,this._blockSize-8),this._block.writeUInt32BE(n,this._blockSize-4)}this._update(this._block);var i=this._hash();return e?i.toString(e):i},i.prototype._update=function(){throw new Error("_update must be implemented by subclass")},e.exports=i},KndR:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugLogger=void 0;const n=r("Gstq");class i{constructor(e,t,r){this.debugInfo=e,this.debugErr=t,this.debugWarn=r}static create(e){const t=(0,n.debug)(e),r=(0,n.debug)(e);r.log=console.warn.bind(console),r.enabled=!0;const s=(0,n.debug)(e);return s.log=console.error.bind(console),s.enabled=!0,new i(t,s,r)}info(e){this.debugInfo(e)}warn(e){this.debugWarn(e)}error(e){this.debugErr(e)}}t.DebugLogger=i},Ks48:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MongoManager=void 0;const n=r("tp/L"),i=r("zTUk");t.MongoManager=class{constructor(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3,n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.factory=e,this.shouldReconnect=t,this.reconnectDelayMs=r,this.global=n,this.databaseP=this.connect(this.global)}getDatabase(){return this.databaseP}async close(){return(0,i.debug)("Call close connection to Db"),n.Lumberjack.info("Call close connection to Db"),this.shouldReconnect=!1,(await this.databaseP).close()}connect(){const e=this.factory.connect(arguments.length>0&&void 0!==arguments[0]&&arguments[0]).then((e=>(e.on("error",(e=>{(0,i.debug)("DB Error",e),n.Lumberjack.error("DB Error",void 0,e),this.reconnect(this.reconnectDelayMs)})),e.on("close",(e=>{(0,i.debug)("DB Close"),n.Lumberjack.info("DB Close"),this.reconnect(this.reconnectDelayMs)})),e.on("reconnect",(e=>{(0,i.debug)("DB Reconnect"),n.Lumberjack.info("DB Reconnect")})),e.on("reconnectFailed",(e=>{(0,i.debug)("DB Reconnect failed"),n.Lumberjack.error("DB Reconnect failed",void 0,e)})),e)));return e.catch((e=>{(0,i.debug)("DB Connection Error",e),n.Lumberjack.error("DB Connection Error",void 0,e),this.reconnect(this.reconnectDelayMs)})),(0,i.debug)("Successfully connected"),n.Lumberjack.info("Successfully connected to Db"),e}reconnect(e){if(!this.shouldReconnect)return(0,i.debug)("Should not reconnect to Db"),void n.Lumberjack.info("Should not reconnect to Db");this.databaseP=new Promise((t=>{setTimeout((()=>{const e=this.connect();t(e)}),e)}))}}},LlaD:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DeliLambdaFactory=t.OpEventType=t.DeliLambda=t.createDeliCheckpointManagerFromCollection=void 0;var n=r("lMmm");Object.defineProperty(t,"createDeliCheckpointManagerFromCollection",{enumerable:!0,get:function(){return n.createDeliCheckpointManagerFromCollection}});var i=r("ODJF");Object.defineProperty(t,"DeliLambda",{enumerable:!0,get:function(){return i.DeliLambda}}),Object.defineProperty(t,"OpEventType",{enumerable:!0,get:function(){return i.OpEventType}});var s=r("MHv6");Object.defineProperty(t,"DeliLambdaFactory",{enumerable:!0,get:function(){return s.DeliLambdaFactory}})},LpAa:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.chooseCelaName=void 0;const n=["Elliot Woodward","Miguel Garcia","Robert Tolbert","Henry Brill","Cecil Folk","Isaac Fielder","Erik Nason","Tim Deboer","Mauricio August","Allan Munger","Kevin Sturgis","Carlos Slattery","Johnnie McConnell","Colin Ballinger","Kat Larsson","Katri Ahokas","Carole Poland","Wanda Howard","Amanda Brady","Ashley McCarthy","Lydia Bauer","Robin Counts","Charlotte Walton","Elvia Atkins","Daisy Phillips","Mona Kane","Kristin Patterson","Celeste Burton"];t.chooseCelaName=()=>n[Math.floor(Math.random()*n.length)]},Lvy3:function(e,t,r){"use strict";r.r(t),r.d(t,"generateToken",(function(){return n.a})),r.d(t,"generateUser",(function(){return n.b})),r.d(t,"validateTokenClaims",(function(){return n.c})),r.d(t,"validateTokenClaimsExpiration",(function(){return n.d})),r.d(t,"convertSortedNumberArrayToRanges",(function(){return i})),r.d(t,"CorrelationIdHeaderName",(function(){return s})),r.d(t,"DriverVersionHeaderName",(function(){return o})),r.d(t,"LatestSummaryId",(function(){return a})),r.d(t,"createFluidServiceNetworkError",(function(){return c.b})),r.d(t,"isNetworkError",(function(){return c.c})),r.d(t,"NetworkError",(function(){return c.a})),r.d(t,"throwFluidServiceNetworkError",(function(){return c.d})),r.d(t,"choose",(function(){return d})),r.d(t,"getRandomName",(function(){return h})),r.d(t,"GitManager",(function(){return m.a})),r.d(t,"getAuthorizationTokenFromCredentials",(function(){return T})),r.d(t,"Historian",(function(){return N})),r.d(t,"promiseTimeout",(function(){return P})),r.d(t,"RestLessClient",(function(){return M})),r.d(t,"RestLessFieldNames",(function(){return x})),r.d(t,"BasicRestWrapper",(function(){return E})),r.d(t,"RestWrapper",(function(){return C})),r.d(t,"defaultHash",(function(){return L})),r.d(t,"getNextHash",(function(){return D})),r.d(t,"canRead",(function(){return A})),r.d(t,"canSummarize",(function(){return q})),r.d(t,"canWrite",(function(){return j})),r.d(t,"canRevokeToken",(function(){return B})),r.d(t,"buildTreePath",(function(){return K})),r.d(t,"convertSummaryTreeToWholeSummaryTree",(function(){return W})),r.d(t,"convertWholeFlatSummaryToSnapshotTreeAndBlobs",(function(){return G})),r.d(t,"SummaryTreeUploadManager",(function(){return Q})),r.d(t,"getOrCreateRepository",(function(){return X})),r.d(t,"getRandomInt",(function(){return Z})),r.d(t,"WholeSummaryUploadManager",(function(){return Y}));var n=r("I0o8");function i(e){const t=[];if(!(null==e?void 0:e.length))return t;let r=e[0],n=e[0];for(let i=1;i<e.length;i++){const s=e[i];s-n!=1?(t.push([r,n]),r=s,n=s):n=s}return t.push([r,n]),t}const s="x-correlation-id",o="x-driver-version",a="latest";var c=r("ToCX"),u=r("vuat"),l=r.n(u);function h(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"_",t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],[r,n]=l()().split(" ");return t||(r=r.toLowerCase(),n=n.toLowerCase()),`${r}${e}${n}`}const d=()=>h();var m=r("QhLl"),p=r("nCVa"),f=r("UKnr"),g=r("a0Z+"),y=r.n(g),v=r("czhI"),b=r.n(v),S=r("A3AF"),w=r("e+Z5");class C{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1048576e3,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1048576e3;this.baseurl=e,this.defaultQueryString=t,this.maxBodyLength=r,this.maxContentLength=n}async get(e,t,r){const n={baseURL:this.baseurl,headers:r,maxBodyLength:this.maxBodyLength,maxContentLength:this.maxContentLength,method:"GET",url:`${e}${this.generateQueryString(t)}`};return this.request(n,200)}async post(e,t,r,n){const i={baseURL:this.baseurl,data:t,headers:n,maxBodyLength:this.maxBodyLength,maxContentLength:this.maxContentLength,method:"POST",url:`${e}${this.generateQueryString(r)}`};return this.request(i,201)}async delete(e,t,r){const n={baseURL:this.baseurl,headers:r,maxBodyLength:this.maxBodyLength,maxContentLength:this.maxContentLength,method:"DELETE",url:`${e}${this.generateQueryString(t)}`};return this.request(n,204)}async patch(e,t,r,n){const i={baseURL:this.baseurl,data:t,headers:n,maxBodyLength:this.maxBodyLength,maxContentLength:this.maxContentLength,method:"PATCH",url:`${e}${this.generateQueryString(r)}`};return this.request(i,200)}generateQueryString(e){if(this.defaultQueryString||e){const t=Object.assign(Object.assign({},this.defaultQueryString),e),r=f.stringify(t);if(""!==r)return`?${r}`}return""}}class E extends C{constructor(e){let t=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:b.a,n=arguments.length>6?arguments[6]:void 0,i=arguments.length>7?arguments[7]:void 0,s=arguments.length>8?arguments[8]:void 0;super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},arguments.length>2&&void 0!==arguments[2]?arguments[2]:1048576e3,arguments.length>3&&void 0!==arguments[3]?arguments[3]:1048576e3),this.defaultHeaders=t,this.axios=r,this.refreshDefaultQueryString=n,this.refreshDefaultHeaders=i,this.getCorrelationId=s}async request(e,t){let r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];var n,i;const o=Object.assign({},e);return o.headers=this.generateHeaders(o.headers,null!==(i=null===(n=this.getCorrelationId)||void 0===n?void 0:n.call(this))&&void 0!==i?i:Object(S.a)()),new Promise(((n,i)=>{this.axios.request(o).then((e=>{n(e.data)})).catch((a=>{var u,l,h,d,m,p,f,g,v,b,S,C,E,I;if((null===(u=null==a?void 0:a.response)||void 0===u?void 0:u.status)===t&&n(null===(l=null==a?void 0:a.response)||void 0===l?void 0:l.data),(null==a?void 0:a.config)?Object(w.a)(`[${a.config.method}] request to [${null!==(h=a.config.baseURL)&&void 0!==h?h:""}${null!==(d=a.config.url)&&void 0!==d?d:""}] failed with [${null===(m=a.response)||void 0===m?void 0:m.status}] [${y()(null===(p=a.response)||void 0===p?void 0:p.data,void 0,2)}]`):Object(w.a)(`request to ${o.url} failed ${a?a.message:""}`),429===(null===(f=null==a?void 0:a.response)||void 0===f?void 0:f.status)&&(null===(v=null===(g=null==a?void 0:a.response)||void 0===g?void 0:g.data)||void 0===v?void 0:v.retryAfter)>0&&r)setTimeout((()=>{this.request(o,t).then(n).catch(i)}),1e3*a.response.data.retryAfter);else if(401===(null===(b=null==a?void 0:a.response)||void 0===b?void 0:b.status)&&r&&this.refreshOnAuthError()){const r=Object.assign({},e);r.headers=this.generateHeaders(r.headers,o.headers[s]),this.request(r,t,!1).then(n).catch(i)}else if(null==a?void 0:a.response)i(Object(c.b)(null===(S=null==a?void 0:a.response)||void 0===S?void 0:S.status,null===(C=null==a?void 0:a.response)||void 0===C?void 0:C.data));else if(null==a?void 0:a.request)i(Object(c.b)(502,`Network Error: ${null!==(E=null==a?void 0:a.message)&&void 0!==E?E:"undefined"}`));else{const e={canRetry:!1,isFatal:!1,message:null!==(I=null==a?void 0:a.message)&&void 0!==I?I:"Unknown Error"};i(Object(c.b)(500,e))}}))}))}generateHeaders(e,t){let r=null!=e?e:{};return this.defaultHeaders&&(r=Object.assign(Object.assign({},this.defaultHeaders),e)),r[s]?r:Object.assign({[s]:t},r)}refreshOnAuthError(){return(void 0!==this.refreshDefaultQueryString||void 0!==this.refreshDefaultHeaders)&&(void 0!==this.refreshDefaultHeaders&&(this.defaultHeaders=this.refreshDefaultHeaders()),void 0!==this.refreshDefaultQueryString&&(this.defaultQueryString=this.refreshDefaultQueryString()),!0)}}function I(e,t){for(const r of t)if(e.endsWith(r))return!0;return!1}const T=e=>`Basic ${Object(p.b)(`${e.user}:${e.password}`)}`;class N{constructor(e,t,r,n){this.endpoint=e,this.historianApi=t,this.restWrapper=n,this.defaultQueryString={},r&&this.historianApi?(this.defaultQueryString.disableCache=r,this.cacheBust=!1):this.cacheBust=r,void 0===this.restWrapper&&(this.restWrapper=new E(this.endpoint))}async getHeader(e){return this.historianApi?this.restWrapper.get(`/headers/${encodeURIComponent(e)}`,this.getQueryString()):this.getHeaderDirect(e)}async getFullTree(e){return this.restWrapper.get(`/tree/${encodeURIComponent(e)}`,this.getQueryString())}async getBlob(e){return this.restWrapper.get(`/git/blobs/${encodeURIComponent(e)}`,this.getQueryString())}async createBlob(e){return this.restWrapper.post("/git/blobs",e,this.getQueryString())}async getContent(e,t){return this.restWrapper.get(`/contents/${e}`,this.getQueryString({ref:t}))}async getCommits(e,t){return this.restWrapper.get("/commits",this.getQueryString({count:t,sha:e})).catch((e=>400===e||404===e?[]:Promise.reject(e)))}async getCommit(e){return this.restWrapper.get(`/git/commits/${encodeURIComponent(e)}`,this.getQueryString())}async createCommit(e){return this.restWrapper.post("/git/commits",e,this.getQueryString())}async getRefs(){return this.restWrapper.get("/git/refs",this.getQueryString())}async getRef(e){return this.restWrapper.get(`/git/refs/${e}`,this.getQueryString())}async createRef(e){return this.restWrapper.post("/git/refs",e,this.getQueryString())}async updateRef(e,t){return this.restWrapper.patch(`/git/refs/${e}`,t,this.getQueryString())}async deleteRef(e){await this.restWrapper.delete(`/git/refs/${e}`,this.getQueryString())}async createTag(e){return this.restWrapper.post("/git/tags",e,this.getQueryString())}async getTag(e){return this.restWrapper.get(`/git/tags/${e}`,this.getQueryString())}async createTree(e){return this.restWrapper.post("/git/trees",e,this.getQueryString())}async getTree(e,t){return this.restWrapper.get(`/git/trees/${encodeURIComponent(e)}`,this.getQueryString({recursive:t?1:0}))}async createSummary(e,t){return this.restWrapper.post("/git/summaries",e,this.getQueryString(void 0!==t?{initial:t}:void 0))}async deleteSummary(e){const t={"Soft-Delete":e};return this.restWrapper.delete("/git/summaries",this.getQueryString(),t)}async getSummary(e){return this.restWrapper.get(`/git/summaries/${e}`,this.getQueryString())}async getHeaderDirect(e){const t=await this.getTree(e,!0),r=[".attributes",".blobs",".messages","header"],n=[];for(const e of t.tree)if("blob"===e.type&&I(e.path,r)){const t=this.getBlob(e.sha);n.push(t)}return{blobs:await Promise.all(n),tree:t}}getQueryString(e){return Object.assign(Object.assign(this.cacheBust?{cacheBust:Date.now()}:{},this.defaultQueryString),e)}}async function P(e,t){const r=new Promise(((t,r)=>{const n=setTimeout((()=>{clearTimeout(n),r(new Error(`Timed out in ${e} milliseconds.`))}),e)}));return Promise.race([t,r])}var x;!function(e){e.Method="method",e.Header="header",e.Body="body"}(x||(x={}));const O=(e,t)=>`${e}: ${t}`;class M{translate(e){var t,r;const n=Object.assign({},e),i=new URLSearchParams;if(i.append(x.Method,null!==(t=n.method)&&void 0!==t?t:"GET"),n.headers)for(const[e,t]of Object.entries(n.headers)){const r=O(e,t);i.append(x.Header,r)}if(n.data&&["post","put","patch"].includes(null===(r=n.method)||void 0===r?void 0:r.toLowerCase())){const e=JSON.stringify(n.data);i.append(x.Body,e)}return n.data=i.toString(),n.method="POST",n.headers={"Content-Type":"application/x-www-form-urlencoded;restless"},n}}var k=r("VlQw");const L="00000000",R=["clientId","sequenceNumber","minimumSequenceNumber","clientSequenceNumber","referenceSequenceNumber","type","timestamp","data"];function D(e,t){const r=JSON.stringify(e,R);return Object(k.str)(r,parseInt(t,16)).toString(16)}var F=r("XPga");const A=e=>e.includes(F.a.DocRead),j=e=>e.includes(F.a.DocWrite),q=e=>e.includes(F.a.SummaryWrite),B=e=>e.includes("token:revoke");var _=r("Xou4"),H=r("7/yF"),V=r("he5V"),$=r("jLPl"),U=r("HJ7Z");const K=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.map((e=>e.replace(/^\//,"").replace(/\/$/,""))).filter((e=>!!e)).join("/")};function W(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";const i={type:"tree",entries:[]},s=Object.keys(t.tree);for(const o of s){const s=t.tree[o];let a,c,u;const l=K(""===r?n:r,o);switch(s.type){case U.a.Tree:c=W(e,s,l,n),u=s.unreferenced||void 0;break;case U.a.Blob:c="string"==typeof s.content?{type:"blob",content:s.content,encoding:"utf-8"}:{type:"blob",content:Object(_.b)(s.content,"base64"),encoding:"base64"};break;case U.a.Handle:if(s.embedded)a=s.handle;else{if(!e)throw Error("Parent summary does not exist to reference by handle.");a=K(e,n,s.handle)}break;case U.a.Attachment:a=s.id;break;default:Object(H.a)(s,`Unknown type: ${s.type}`)}const h={path:encodeURIComponent(o),type:Object($.g)(s)};let d;if(c)Object(V.a)(void 0===a,173),d=Object.assign({value:c,unreferenced:u},h);else{if(!a)throw new Error(`Invalid tree entry for ${s.type}`);d=Object.assign(Object.assign({},h),{id:a})}i.entries.push(d)}return i}function J(e,t){const r={},n={id:e.id,blobs:{},trees:{}};r[""]=n;for(const n of e.entries){const e=n.path.replace(new RegExp(`^${t}/`),""),i=e.lastIndexOf("/"),s=e.slice(0,Math.max(0,i)),o=e.slice(i+1),a=r[s];if("tree"===n.type){const t={blobs:{},trees:{},unreferenced:n.unreferenced};a.trees[decodeURIComponent(o)]=t,r[e]=t}else{if("blob"!==n.type)throw new Error("Unknown entry type!!");a.blobs[decodeURIComponent(o)]=n.id}}return n}function G(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:".app";var r;const n=new Map;e.blobs&&e.blobs.forEach((e=>{var t;n.set(e.id,Object(_.e)(e.content,null!==(t=e.encoding)&&void 0!==t?t:"utf-8"))}));const i=null===(r=e.trees)||void 0===r?void 0:r[0],s=null==i?void 0:i.sequenceNumber,o=J(i,t);return{blobs:n,snapshotTree:o,sequenceNumber:s}}var z=r("5zuf");class Q{constructor(e,t,r){this.manager=e,this.blobsShaCache=t,this.getPreviousFullSnapshot=r}async writeSummaryTree(e,t,r,n,i){const s=await this.getPreviousFullSnapshot(t);return this.writeSummaryTreeCore(e,null!=s?s:void 0)}async writeSummaryTreeCore(e,t){const r=await Promise.all(Object.keys(e.tree).map((async r=>{const n=e.tree[r],i=await this.writeSummaryTreeObject(n,t);return{mode:Object($.f)(n),path:encodeURIComponent(r),sha:i,type:Object($.g)(n)}})));return(await this.manager.createGitTree({tree:r})).sha}async writeSummaryTreeObject(e,t){switch(e.type){case U.a.Blob:return this.writeSummaryBlob(e.content);case U.a.Handle:if(void 0===t)throw Error("Parent summary does not exist to reference by handle.");return this.getIdFromPath(e.handleType,e.handle,t);case U.a.Tree:return this.writeSummaryTreeCore(e,t);case U.a.Attachment:return e.id;default:Object(H.a)(e,`Unknown type: ${e.type}`)}}async writeSummaryBlob(e){const{parsedContent:t,encoding:r}="string"==typeof e?{parsedContent:e,encoding:"utf-8"}:{parsedContent:Object(_.b)(e,"base64"),encoding:"base64"},n=await Object(z.a)(_.a.from(t,r));if(!this.blobsShaCache.has(n)){this.blobsShaCache.set(n,"");const e=await this.manager.createBlob(t,r);Object(V.a)(n===e.sha,182)}return n}getIdFromPath(e,t,r){const n=t.split("/").map((e=>decodeURIComponent(e)));return""===n[0]&&n.shift(),0===n.length?r.id:this.getIdFromPathCore(e,n,r)}getIdFromPathCore(e,t,r){var n;Object(V.a)(t.length>0,179);const i=t[0];if(1===t.length)switch(e){case U.a.Blob:{const e=r.blobs[i];return Object(V.a)(!!e,180),e}case U.a.Tree:{const e=null===(n=r.trees[i])||void 0===n?void 0:n.id;return Object(V.a)(!!e,181),e}default:throw Error(`Unexpected handle summary object type: "${e}".`)}return this.getIdFromPathCore(e,t.slice(1),r.trees[i])}}async function X(e,t,r,n){console.log(`Get Repo: ${e}/${t}/${r}`);const i=await b.a.get(`${e}/repos/${t}/${r}`,{headers:n}).catch((e=>{if(e.response&&400===e.response.status)return null;throw e}));if(!i||400===i.status){console.log(`Create Repo: ${e}/${t}/${r}`);const i={name:r};await b.a.post(`${e}/${t}/repos`,i,{headers:n})}}const Z=e=>Math.floor(Math.random()*e);class Y{constructor(e){this.manager=e}async writeSummaryTree(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const s=await this.writeSummaryTreeCore(t,e,r,n,i);if(!s)throw new Error("Failed to write summary tree");return s}async writeSummaryTreeCore(e,t,r,n,i){const s=W(e,t,"","channel"===r?".app":"");return this.manager.createSummary({entries:s.entries,message:void 0,sequenceNumber:n,type:r},i).then((e=>e.id))}}},M5A3:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestKafka=t.TestProducer=t.TestConsumer=void 0;const n=r("ZERR"),i=r("hBZP"),s=r("tqCN");class o{constructor(e,t){this.groupId=e,this.topic=t,this.emitter=new i.EventEmitter,this.pausedQueue=null,this.failOnCommit=!1,this.context=new s.TestContext}setFailOnCommit(e){this.failOnCommit=e}isConnected(){return!0}getLatestMessageOffset(e){}async commitCheckpoint(e,t){return(0,n.strict)(0===e),this.failOnCommit?Promise.reject(new Error("TestConsumer set to fail on commit")):void this.context.checkpoint(t)}getOffset(){return this.context.offset}async waitForOffset(e){return this.context.waitForOffset(e)}on(e,t){return this.emitter.on(e,t),this}once(e,t){return this.emitter.once(e,t),this}async close(){}async pause(){this.pausedQueue||(this.pausedQueue=[])}async resume(){if(!this.pausedQueue)return;const e=this.pausedQueue;this.pausedQueue=null;for(const t of e)this.emit(t)}emitError(e){this.emitter.emit("error",e)}emit(e){this.pausedQueue?this.pausedQueue.push(e):this.emitter.emit("data",e)}rebalance(){this.emitter.emit("rebalancing"),this.emitter.emit("rebalanced",[{topic:this.topic,offset:0,partition:0}])}}t.TestConsumer=o;class a{constructor(e){this.kafka=e}isConnected(){return!0}async send(e,t){for(const r of e)this.kafka.addMessage(r,t)}async close(){}on(e,t){return this}once(e,t){return this}}t.TestProducer=a;class c{constructor(){this.messages=[],this.offset=0,this.consumers=[]}static createdQueuedMessage(e,t){return{topic:"topic",partition:0,offset:e,value:""}}createProducer(){return new a(this)}createConsumer(){const e=new o("test","test");return this.consumers.push(e),e}getRawMessages(){return this.messages}addMessage(e,t){const r=this.offset++,n=c.createdQueuedMessage(r);n.value=e,n.topic=t,this.messages.push(n);for(const e of this.consumers)e.emit(n)}getLastMessage(){return this.getMessage(this.messages.length-1)}getMessage(e){return this.messages[e].value}}t.TestKafka=c},MHv6:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DeliLambdaFactory=void 0;const n=r("hBZP"),i=r("4+3C"),s=r("wWog"),o=r("yQiv"),a=r("iS6B"),c=r("y2M+"),u=r("YkJt"),l=r("fhs9"),h=r("KMXR"),d=r("ODJF"),m=r("lMmm"),p=e=>({clients:void 0,durableSequenceNumber:0,epoch:e,expHash1:u.defaultHash,logOffset:-1,sequenceNumber:0,signalClientConnectionNumber:0,term:1,lastSentMSN:0,nackMessages:void 0,successfullyStartedLambdas:[],checkpointTimestamp:Date.now()});t.DeliLambdaFactory=class extends n.EventEmitter{constructor(e,t,r,n,i,s,o,a){super(),this.operationsDbMongoManager=e,this.documentRepository=t,this.tenantManager=r,this.clientManager=n,this.forwardProducer=i,this.signalProducer=s,this.reverseProducer=o,this.serviceConfiguration=a}async create(e,t){var r,n,s,a,c,u,f,g;const{documentId:y,tenantId:v,leaderEpoch:b}=e,S=(0,h.createSessionMetric)(v,y,l.LumberEventName.SessionResult,this.serviceConfiguration),w=(0,h.createSessionMetric)(v,y,l.LumberEventName.StartSessionResult,this.serviceConfiguration),C={documentId:y,tenantId:v};let E,I,T;try{if(I=await this.documentRepository.readOne({documentId:y,tenantId:v}),!(0,h.isDocumentValid)(I)){const e="Received attempt to connect to a missing/deleted document.";return null===(r=t.log)||void 0===r||r.error(e,{messageMetaData:C}),l.Lumberjack.error(e,(0,l.getLumberBaseProperties)(y,v)),new h.NoOpLambda(t)}if(!(0,h.isDocumentSessionValid)(I,this.serviceConfiguration)){const e=`Received attempt to connect to invalid session: ${JSON.stringify(I.session)}`;if(null===(n=t.log)||void 0===n||n.error(e,{messageMetaData:C}),l.Lumberjack.error(e,(0,l.getLumberBaseProperties)(y,v)),this.serviceConfiguration.enforceDiscoveryFlow)return new h.NoOpLambda(t)}E=await this.tenantManager.getTenantGitManager(v,y)}catch(e){const r="Deli lambda creation failed";throw null===(s=t.log)||void 0===s||s.error(`${r}. Exception: ${(0,i.inspect)(e)}`,{messageMetaData:C}),l.Lumberjack.error(r,(0,l.getLumberBaseProperties)(y,v),e),this.logSessionFailureMetrics(S,w,r),e}if(null==I.deli){const e="New document. Setting empty deli checkpoint";null===(a=t.log)||void 0===a||a.info(e,{messageMetaData:C}),l.Lumberjack.info(e,(0,l.getLumberBaseProperties)(y,v)),T=p(b)}else if(""===I.deli){const e="Existing document. Fetching checkpoint from summary";null===(c=t.log)||void 0===c||c.info(e,{messageMetaData:C}),l.Lumberjack.info(e,(0,l.getLumberBaseProperties)(y,v));const r=await this.loadStateFromSummary(v,y,E,t.log);if(void 0===r){const e="Could not load state from summary";null===(u=t.log)||void 0===u||u.error(e,{messageMetaData:C}),l.Lumberjack.error(e,(0,l.getLumberBaseProperties)(y,v)),this.logSessionFailureMetrics(S,w,e),T=p(b)}else{T=r,T.logOffset=-1,T.epoch=b;const e=`Deli checkpoint from summary: ${JSON.stringify(T)}`;null===(f=t.log)||void 0===f||f.info(e,{messageMetaData:C}),l.Lumberjack.info(e,(0,l.getLumberBaseProperties)(y,v))}}else T=JSON.parse(I.deli);null==T.checkpointTimestamp&&(T.checkpointTimestamp=Date.now()),void 0===T.epoch&&(T.epoch=b,T.term=1);const N=T,P=(0,m.createDeliCheckpointManagerFromCollection)(v,y,this.documentRepository),x=new d.DeliLambda(t,v,y,N,P,this.clientManager,this.forwardProducer,this.signalProducer,this.reverseProducer,this.serviceConfiguration,S,w);return x.on("close",(e=>{(async()=>{var r;if(e===o.LambdaCloseType.ActivityTimeout||e===o.LambdaCloseType.Error){const n={documentId:y,tenantId:v,session:{$exists:!0}},i={"session.isSessionAlive":!1,"session.isSessionActive":!1,lastAccessTime:Date.now()};await this.documentRepository.updateOne(n,i,void 0);const s=`Marked session alive and active as false for closeType:\n                        ${JSON.stringify(e)}`;null===(r=t.log)||void 0===r||r.info(s,{messageMetaData:C}),l.Lumberjack.info(s,(0,l.getLumberBaseProperties)(y,v))}})().catch((e=>{var r;const n=`Failed to handle session alive and active with exception ${e}`;null===(r=t.log)||void 0===r||r.error(n,{messageMetaData:C}),l.Lumberjack.error(n,(0,l.getLumberBaseProperties)(y,v),e)}))})),null===(g=t.log)||void 0===g||g.info("Deli Lambda is marking session as alive and active as true.",{messageMetaData:C}),this.documentRepository.updateOne({tenantId:v,documentId:y},{"session.isSessionAlive":!0,"session.isSessionActive":!0}).catch((e=>{var r;const n="Deli Lambda failed to mark session as active.";null===(r=t.log)||void 0===r||r.error(`${n} Exception: ${(0,i.inspect)(e)}`,{messageMetaData:C}),l.Lumberjack.error(`${n}`,(0,l.getLumberBaseProperties)(y,v),e)})),x}logSessionFailureMetrics(e,t,r){null==e||e.error(r),null==t||t.error(r)}async dispose(){var e;const t=this.operationsDbMongoManager.close(),r=this.forwardProducer.close(),n=null===(e=this.signalProducer)||void 0===e?void 0:e.close(),i=this.reverseProducer.close();await Promise.all([t,r,n,i])}async loadStateFromSummary(e,t,r,n){const i=await r.getRef(encodeURIComponent(t));if(i)try{const e=await r.getContent(i.object.sha,".serviceProtocol/deli");return JSON.parse((0,s.toUtf8)(e.content,e.encoding))}catch(r){const i={documentId:t,tenantId:e},s="Error fetching deli state from summary";return null==n||n.error(s,{messageMetaData:i}),null==n||n.error(JSON.stringify(r),{messageMetaData:i}),void l.Lumberjack.error(s,(0,l.getLumberBaseProperties)(t,e),r)}}async resetCheckpointOnEpochTick(e,t,r,n,i,s){let o=i;if(s!==o.epoch){const i=await this.loadStateFromSummary(e,t,r,n);if(void 0===i)o.epoch=s;else{const a=o.logOffset;o=i,o.epoch=s,++o.term,o.durableSequenceNumber=i.sequenceNumber,o.logOffset=a,await this.createSummaryWithLatestTerm(r,o,t);const c="Created a summary on epoch tick";null==n||n.info(c,{messageMetaData:{documentId:t,tenantId:e}}),l.Lumberjack.info(c,(0,l.getLumberBaseProperties)(t,e))}}return o}async createSummaryWithLatestTerm(e,t,r){const n=await e.getRef(encodeURIComponent(r)),[i,o]=await Promise.all([e.getCommit(n.object.sha),e.getContent(n.object.sha,".serviceProtocol/scribe")]),u=(0,s.toUtf8)(o.content,o.encoding),l=(0,a.generateServiceProtocolEntries)(JSON.stringify(t),u),[h,d]=await Promise.all([e.createTree({entries:l}),e.getTree(i.tree.sha,!1)]),m=d.tree.filter((e=>".serviceProtocol"!==e.path)).map((e=>({mode:e.mode,path:e.path,sha:e.sha,type:e.type})));m.push({mode:c.FileMode.Directory,path:".serviceProtocol",sha:h.sha,type:"tree"});const p=await e.createGitTree({tree:m}),f={author:{date:(new Date).toISOString(),email:"praguertdev@microsoft.com",name:"Routerlicious Service"},message:`Term Change Summary @T${t.term}S${t.sequenceNumber}`,parents:[i.sha],tree:p.sha},g=await e.createCommit(f);await e.upsertRef(r,g.sha)}}},MNj0:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScriptoriumLambdaFactory=t.ScriptoriumLambda=void 0;var n=r("pfo9");Object.defineProperty(t,"ScriptoriumLambda",{enumerable:!0,get:function(){return n.ScriptoriumLambda}});var i=r("dhlH");Object.defineProperty(t,"ScriptoriumLambdaFactory",{enumerable:!0,get:function(){return i.ScriptoriumLambdaFactory}})},MPeK:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createCompositeTokenId=t.TokenRevocationError=t.signalUsageStorageId=t.clientConnectivityStorageId=t.ThrottlingError=t.KeyName=t.shouldRetryNetworkError=t.runWithRetry=t.requestWithRetry=t.calculateRetryIntervalForNetworkError=t.PendingBoxcar=t.MaxBatchSize=t.MongoDocumentRepository=t.MongoDatabaseManager=t.MongoManager=t.DefaultMetricClient=t.SystemType=t.SystemOperations=t.SignalOperationType=t.SequencedOperationType=t.RawOperationType=t.NackOperationType=t.NackMessagesType=t.ControlMessageType=t.BoxcarType=t.LambdaName=t.LambdaCloseType=t.extractBoxcar=t.EmptyTaskMessageSender=t.isRetryEnabled=t.DefaultServiceConfiguration=t.CombinedProducer=t.CombinedLambda=t.CombinedContext=t.chooseCelaName=void 0;var n=r("jLKw");Object.defineProperty(t,"chooseCelaName",{enumerable:!0,get:function(){return n.chooseCelaName}});var i=r("BYTq");Object.defineProperty(t,"CombinedContext",{enumerable:!0,get:function(){return i.CombinedContext}});var s=r("USNV");Object.defineProperty(t,"CombinedLambda",{enumerable:!0,get:function(){return s.CombinedLambda}});var o=r("mt0w");Object.defineProperty(t,"CombinedProducer",{enumerable:!0,get:function(){return o.CombinedProducer}});var a=r("ezbL");Object.defineProperty(t,"DefaultServiceConfiguration",{enumerable:!0,get:function(){return a.DefaultServiceConfiguration}});var c=r("sx1J");Object.defineProperty(t,"isRetryEnabled",{enumerable:!0,get:function(){return c.isRetryEnabled}});var u=r("61GN");Object.defineProperty(t,"EmptyTaskMessageSender",{enumerable:!0,get:function(){return u.EmptyTaskMessageSender}});var l=r("mFHa");Object.defineProperty(t,"extractBoxcar",{enumerable:!0,get:function(){return l.extractBoxcar}}),Object.defineProperty(t,"LambdaCloseType",{enumerable:!0,get:function(){return l.LambdaCloseType}}),Object.defineProperty(t,"LambdaName",{enumerable:!0,get:function(){return l.LambdaName}});var h=r("FpcY");Object.defineProperty(t,"BoxcarType",{enumerable:!0,get:function(){return h.BoxcarType}}),Object.defineProperty(t,"ControlMessageType",{enumerable:!0,get:function(){return h.ControlMessageType}}),Object.defineProperty(t,"NackMessagesType",{enumerable:!0,get:function(){return h.NackMessagesType}}),Object.defineProperty(t,"NackOperationType",{enumerable:!0,get:function(){return h.NackOperationType}}),Object.defineProperty(t,"RawOperationType",{enumerable:!0,get:function(){return h.RawOperationType}}),Object.defineProperty(t,"SequencedOperationType",{enumerable:!0,get:function(){return h.SequencedOperationType}}),Object.defineProperty(t,"SignalOperationType",{enumerable:!0,get:function(){return h.SignalOperationType}}),Object.defineProperty(t,"SystemOperations",{enumerable:!0,get:function(){return h.SystemOperations}}),Object.defineProperty(t,"SystemType",{enumerable:!0,get:function(){return h.SystemType}});var d=r("gLf6");Object.defineProperty(t,"DefaultMetricClient",{enumerable:!0,get:function(){return d.DefaultMetricClient}});var m=r("Ks48");Object.defineProperty(t,"MongoManager",{enumerable:!0,get:function(){return m.MongoManager}});var p=r("CKwV");Object.defineProperty(t,"MongoDatabaseManager",{enumerable:!0,get:function(){return p.MongoDatabaseManager}});var f=r("OMb1");Object.defineProperty(t,"MongoDocumentRepository",{enumerable:!0,get:function(){return f.MongoDocumentRepository}});var g=r("3fIs");Object.defineProperty(t,"MaxBatchSize",{enumerable:!0,get:function(){return g.MaxBatchSize}}),Object.defineProperty(t,"PendingBoxcar",{enumerable:!0,get:function(){return g.PendingBoxcar}});var y=r("9O2h");Object.defineProperty(t,"calculateRetryIntervalForNetworkError",{enumerable:!0,get:function(){return y.calculateRetryIntervalForNetworkError}}),Object.defineProperty(t,"requestWithRetry",{enumerable:!0,get:function(){return y.requestWithRetry}}),Object.defineProperty(t,"runWithRetry",{enumerable:!0,get:function(){return y.runWithRetry}}),Object.defineProperty(t,"shouldRetryNetworkError",{enumerable:!0,get:function(){return y.shouldRetryNetworkError}});var v=r("JtJg");Object.defineProperty(t,"KeyName",{enumerable:!0,get:function(){return v.KeyName}});var b=r("9Jrb");Object.defineProperty(t,"ThrottlingError",{enumerable:!0,get:function(){return b.ThrottlingError}});var S=r("HCLa");Object.defineProperty(t,"clientConnectivityStorageId",{enumerable:!0,get:function(){return S.clientConnectivityStorageId}}),Object.defineProperty(t,"signalUsageStorageId",{enumerable:!0,get:function(){return S.signalUsageStorageId}});var w=r("csBV");Object.defineProperty(t,"TokenRevocationError",{enumerable:!0,get:function(){return w.TokenRevocationError}}),Object.defineProperty(t,"createCompositeTokenId",{enumerable:!0,get:function(){return w.createCompositeTokenId}})},MTg9:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MongoDatabaseManager=void 0,t.MongoDatabaseManager=class{constructor(e,t,r,n,i,s,o){this.globalDbEnabled=e,this.operationsDbMongoManager=t,this.globalDbMongoManager=r,this.nodeCollectionName=n,this.documentsCollectionName=i,this.deltasCollectionName=s,this.scribeDeltasCollectionName=o}async getNodeCollection(){return this.getCollection(this.nodeCollectionName)}async getDocumentCollection(){return this.getCollection(this.documentsCollectionName)}async getDeltaCollection(e,t){return this.getCollection(this.deltasCollectionName)}async getScribeDeltaCollection(e,t){return this.getCollection(this.scribeDeltasCollectionName)}async getCollection(e){return(e===this.documentsCollectionName&&this.globalDbEnabled?await this.globalDbMongoManager.getDatabase():await this.operationsDbMongoManager.getDatabase()).collection(e)}}},Mecl:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestPublisher=t.TestTopic=void 0;const n=r("hBZP");class i{constructor(){this.events=new Map}emit(e){this.events.has(e)||this.events.set(e,[]);for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];this.events.get(e).push({args:r,event:e})}getEvents(e){return this.events.get(e)}}t.TestTopic=i,t.TestPublisher=class{constructor(){this.events=new n.EventEmitter,this.topics={}}on(e,t){this.events.on(e,t)}to(e){return e in this.topics||(this.topics[e]=new i),this.topics[e]}async close(){}}},MrJ2:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestDeltaManager=void 0,t.TestDeltaManager=class{async getDeltas(e,t,r,n,i){return[]}async getDeltasFromStorage(e,t,r,n,i,s,o){return[]}async getDeltasFromSummaryAndStorage(e,t,r,n,i){return[]}}},N482:function(e,t,r){"use strict";r.d(t,"a",(function(){return i})),r.d(t,"b",(function(){return o}));var n=r("VlQw");const i="00000000",s=["clientId","sequenceNumber","minimumSequenceNumber","clientSequenceNumber","referenceSequenceNumber","type","timestamp","data"];function o(e,t){const r=JSON.stringify(e,s);return Object(n.str)(r,parseInt(t,16)).toString(16)}},N7Hg:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isRetryEnabled=void 0,t.isRetryEnabled=function(e){return!0===e.retryEnabled}},Nf13:function(e,t,r){(function(r){var n;t=e.exports=d,n="object"==typeof r&&r.env&&r.env.NODE_DEBUG&&/\bsemver\b/i.test(r.env.NODE_DEBUG)?function(){var e=Array.prototype.slice.call(arguments,0);e.unshift("SEMVER"),console.log.apply(console,e)}:function(){},t.SEMVER_SPEC_VERSION="2.0.0";var i=Number.MAX_SAFE_INTEGER||9007199254740991,s=t.re=[],o=t.src=[],a=t.tokens={},c=0;function u(e){a[e]=c++}u("NUMERICIDENTIFIER"),o[a.NUMERICIDENTIFIER]="0|[1-9]\\d*",u("NUMERICIDENTIFIERLOOSE"),o[a.NUMERICIDENTIFIERLOOSE]="[0-9]+",u("NONNUMERICIDENTIFIER"),o[a.NONNUMERICIDENTIFIER]="\\d*[a-zA-Z-][a-zA-Z0-9-]*",u("MAINVERSION"),o[a.MAINVERSION]="("+o[a.NUMERICIDENTIFIER]+")\\.("+o[a.NUMERICIDENTIFIER]+")\\.("+o[a.NUMERICIDENTIFIER]+")",u("MAINVERSIONLOOSE"),o[a.MAINVERSIONLOOSE]="("+o[a.NUMERICIDENTIFIERLOOSE]+")\\.("+o[a.NUMERICIDENTIFIERLOOSE]+")\\.("+o[a.NUMERICIDENTIFIERLOOSE]+")",u("PRERELEASEIDENTIFIER"),o[a.PRERELEASEIDENTIFIER]="(?:"+o[a.NUMERICIDENTIFIER]+"|"+o[a.NONNUMERICIDENTIFIER]+")",u("PRERELEASEIDENTIFIERLOOSE"),o[a.PRERELEASEIDENTIFIERLOOSE]="(?:"+o[a.NUMERICIDENTIFIERLOOSE]+"|"+o[a.NONNUMERICIDENTIFIER]+")",u("PRERELEASE"),o[a.PRERELEASE]="(?:-("+o[a.PRERELEASEIDENTIFIER]+"(?:\\."+o[a.PRERELEASEIDENTIFIER]+")*))",u("PRERELEASELOOSE"),o[a.PRERELEASELOOSE]="(?:-?("+o[a.PRERELEASEIDENTIFIERLOOSE]+"(?:\\."+o[a.PRERELEASEIDENTIFIERLOOSE]+")*))",u("BUILDIDENTIFIER"),o[a.BUILDIDENTIFIER]="[0-9A-Za-z-]+",u("BUILD"),o[a.BUILD]="(?:\\+("+o[a.BUILDIDENTIFIER]+"(?:\\."+o[a.BUILDIDENTIFIER]+")*))",u("FULL"),u("FULLPLAIN"),o[a.FULLPLAIN]="v?"+o[a.MAINVERSION]+o[a.PRERELEASE]+"?"+o[a.BUILD]+"?",o[a.FULL]="^"+o[a.FULLPLAIN]+"$",u("LOOSEPLAIN"),o[a.LOOSEPLAIN]="[v=\\s]*"+o[a.MAINVERSIONLOOSE]+o[a.PRERELEASELOOSE]+"?"+o[a.BUILD]+"?",u("LOOSE"),o[a.LOOSE]="^"+o[a.LOOSEPLAIN]+"$",u("GTLT"),o[a.GTLT]="((?:<|>)?=?)",u("XRANGEIDENTIFIERLOOSE"),o[a.XRANGEIDENTIFIERLOOSE]=o[a.NUMERICIDENTIFIERLOOSE]+"|x|X|\\*",u("XRANGEIDENTIFIER"),o[a.XRANGEIDENTIFIER]=o[a.NUMERICIDENTIFIER]+"|x|X|\\*",u("XRANGEPLAIN"),o[a.XRANGEPLAIN]="[v=\\s]*("+o[a.XRANGEIDENTIFIER]+")(?:\\.("+o[a.XRANGEIDENTIFIER]+")(?:\\.("+o[a.XRANGEIDENTIFIER]+")(?:"+o[a.PRERELEASE]+")?"+o[a.BUILD]+"?)?)?",u("XRANGEPLAINLOOSE"),o[a.XRANGEPLAINLOOSE]="[v=\\s]*("+o[a.XRANGEIDENTIFIERLOOSE]+")(?:\\.("+o[a.XRANGEIDENTIFIERLOOSE]+")(?:\\.("+o[a.XRANGEIDENTIFIERLOOSE]+")(?:"+o[a.PRERELEASELOOSE]+")?"+o[a.BUILD]+"?)?)?",u("XRANGE"),o[a.XRANGE]="^"+o[a.GTLT]+"\\s*"+o[a.XRANGEPLAIN]+"$",u("XRANGELOOSE"),o[a.XRANGELOOSE]="^"+o[a.GTLT]+"\\s*"+o[a.XRANGEPLAINLOOSE]+"$",u("COERCE"),o[a.COERCE]="(^|[^\\d])(\\d{1,16})(?:\\.(\\d{1,16}))?(?:\\.(\\d{1,16}))?(?:$|[^\\d])",u("COERCERTL"),s[a.COERCERTL]=new RegExp(o[a.COERCE],"g"),u("LONETILDE"),o[a.LONETILDE]="(?:~>?)",u("TILDETRIM"),o[a.TILDETRIM]="(\\s*)"+o[a.LONETILDE]+"\\s+",s[a.TILDETRIM]=new RegExp(o[a.TILDETRIM],"g"),u("TILDE"),o[a.TILDE]="^"+o[a.LONETILDE]+o[a.XRANGEPLAIN]+"$",u("TILDELOOSE"),o[a.TILDELOOSE]="^"+o[a.LONETILDE]+o[a.XRANGEPLAINLOOSE]+"$",u("LONECARET"),o[a.LONECARET]="(?:\\^)",u("CARETTRIM"),o[a.CARETTRIM]="(\\s*)"+o[a.LONECARET]+"\\s+",s[a.CARETTRIM]=new RegExp(o[a.CARETTRIM],"g"),u("CARET"),o[a.CARET]="^"+o[a.LONECARET]+o[a.XRANGEPLAIN]+"$",u("CARETLOOSE"),o[a.CARETLOOSE]="^"+o[a.LONECARET]+o[a.XRANGEPLAINLOOSE]+"$",u("COMPARATORLOOSE"),o[a.COMPARATORLOOSE]="^"+o[a.GTLT]+"\\s*("+o[a.LOOSEPLAIN]+")$|^$",u("COMPARATOR"),o[a.COMPARATOR]="^"+o[a.GTLT]+"\\s*("+o[a.FULLPLAIN]+")$|^$",u("COMPARATORTRIM"),o[a.COMPARATORTRIM]="(\\s*)"+o[a.GTLT]+"\\s*("+o[a.LOOSEPLAIN]+"|"+o[a.XRANGEPLAIN]+")",s[a.COMPARATORTRIM]=new RegExp(o[a.COMPARATORTRIM],"g"),u("HYPHENRANGE"),o[a.HYPHENRANGE]="^\\s*("+o[a.XRANGEPLAIN]+")\\s+-\\s+("+o[a.XRANGEPLAIN]+")\\s*$",u("HYPHENRANGELOOSE"),o[a.HYPHENRANGELOOSE]="^\\s*("+o[a.XRANGEPLAINLOOSE]+")\\s+-\\s+("+o[a.XRANGEPLAINLOOSE]+")\\s*$",u("STAR"),o[a.STAR]="(<|>)?=?\\s*\\*";for(var l=0;l<c;l++)n(l,o[l]),s[l]||(s[l]=new RegExp(o[l]));function h(e,t){if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),e instanceof d)return e;if("string"!=typeof e)return null;if(e.length>256)return null;if(!(t.loose?s[a.LOOSE]:s[a.FULL]).test(e))return null;try{return new d(e,t)}catch(e){return null}}function d(e,t){if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),e instanceof d){if(e.loose===t.loose)return e;e=e.version}else if("string"!=typeof e)throw new TypeError("Invalid Version: "+e);if(e.length>256)throw new TypeError("version is longer than 256 characters");if(!(this instanceof d))return new d(e,t);n("SemVer",e,t),this.options=t,this.loose=!!t.loose;var r=e.trim().match(t.loose?s[a.LOOSE]:s[a.FULL]);if(!r)throw new TypeError("Invalid Version: "+e);if(this.raw=e,this.major=+r[1],this.minor=+r[2],this.patch=+r[3],this.major>i||this.major<0)throw new TypeError("Invalid major version");if(this.minor>i||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>i||this.patch<0)throw new TypeError("Invalid patch version");this.prerelease=r[4]?r[4].split(".").map((function(e){if(/^[0-9]+$/.test(e)){var t=+e;if(t>=0&&t<i)return t}return e})):[],this.build=r[5]?r[5].split("."):[],this.format()}t.parse=h,t.valid=function(e,t){var r=h(e,t);return r?r.version:null},t.clean=function(e,t){var r=h(e.trim().replace(/^[=v]+/,""),t);return r?r.version:null},t.SemVer=d,d.prototype.format=function(){return this.version=this.major+"."+this.minor+"."+this.patch,this.prerelease.length&&(this.version+="-"+this.prerelease.join(".")),this.version},d.prototype.toString=function(){return this.version},d.prototype.compare=function(e){return n("SemVer.compare",this.version,this.options,e),e instanceof d||(e=new d(e,this.options)),this.compareMain(e)||this.comparePre(e)},d.prototype.compareMain=function(e){return e instanceof d||(e=new d(e,this.options)),p(this.major,e.major)||p(this.minor,e.minor)||p(this.patch,e.patch)},d.prototype.comparePre=function(e){if(e instanceof d||(e=new d(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;var t=0;do{var r=this.prerelease[t],i=e.prerelease[t];if(n("prerelease compare",t,r,i),void 0===r&&void 0===i)return 0;if(void 0===i)return 1;if(void 0===r)return-1;if(r!==i)return p(r,i)}while(++t)},d.prototype.compareBuild=function(e){e instanceof d||(e=new d(e,this.options));var t=0;do{var r=this.build[t],i=e.build[t];if(n("prerelease compare",t,r,i),void 0===r&&void 0===i)return 0;if(void 0===i)return 1;if(void 0===r)return-1;if(r!==i)return p(r,i)}while(++t)},d.prototype.inc=function(e,t){switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t),this.inc("pre",t);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",t),this.inc("pre",t);break;case"major":0===this.minor&&0===this.patch&&0!==this.prerelease.length||this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":0===this.patch&&0!==this.prerelease.length||this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":if(0===this.prerelease.length)this.prerelease=[0];else{for(var r=this.prerelease.length;--r>=0;)"number"==typeof this.prerelease[r]&&(this.prerelease[r]++,r=-2);-1===r&&this.prerelease.push(0)}t&&(this.prerelease[0]===t?isNaN(this.prerelease[1])&&(this.prerelease=[t,0]):this.prerelease=[t,0]);break;default:throw new Error("invalid increment argument: "+e)}return this.format(),this.raw=this.version,this},t.inc=function(e,t,r,n){"string"==typeof r&&(n=r,r=void 0);try{return new d(e,r).inc(t,n).version}catch(e){return null}},t.diff=function(e,t){if(v(e,t))return null;var r=h(e),n=h(t),i="";if(r.prerelease.length||n.prerelease.length){i="pre";var s="prerelease"}for(var o in r)if(("major"===o||"minor"===o||"patch"===o)&&r[o]!==n[o])return i+o;return s},t.compareIdentifiers=p;var m=/^[0-9]+$/;function p(e,t){var r=m.test(e),n=m.test(t);return r&&n&&(e=+e,t=+t),e===t?0:r&&!n?-1:n&&!r?1:e<t?-1:1}function f(e,t,r){return new d(e,r).compare(new d(t,r))}function g(e,t,r){return f(e,t,r)>0}function y(e,t,r){return f(e,t,r)<0}function v(e,t,r){return 0===f(e,t,r)}function b(e,t,r){return 0!==f(e,t,r)}function S(e,t,r){return f(e,t,r)>=0}function w(e,t,r){return f(e,t,r)<=0}function C(e,t,r,n){switch(t){case"===":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e===r;case"!==":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e!==r;case"":case"=":case"==":return v(e,r,n);case"!=":return b(e,r,n);case">":return g(e,r,n);case">=":return S(e,r,n);case"<":return y(e,r,n);case"<=":return w(e,r,n);default:throw new TypeError("Invalid operator: "+t)}}function E(e,t){if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),e instanceof E){if(e.loose===!!t.loose)return e;e=e.value}if(!(this instanceof E))return new E(e,t);n("comparator",e,t),this.options=t,this.loose=!!t.loose,this.parse(e),this.value=this.semver===I?"":this.operator+this.semver.version,n("comp",this)}t.rcompareIdentifiers=function(e,t){return p(t,e)},t.major=function(e,t){return new d(e,t).major},t.minor=function(e,t){return new d(e,t).minor},t.patch=function(e,t){return new d(e,t).patch},t.compare=f,t.compareLoose=function(e,t){return f(e,t,!0)},t.compareBuild=function(e,t,r){var n=new d(e,r),i=new d(t,r);return n.compare(i)||n.compareBuild(i)},t.rcompare=function(e,t,r){return f(t,e,r)},t.sort=function(e,r){return e.sort((function(e,n){return t.compareBuild(e,n,r)}))},t.rsort=function(e,r){return e.sort((function(e,n){return t.compareBuild(n,e,r)}))},t.gt=g,t.lt=y,t.eq=v,t.neq=b,t.gte=S,t.lte=w,t.cmp=C,t.Comparator=E;var I={};function T(e,t){if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),e instanceof T)return e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease?e:new T(e.raw,t);if(e instanceof E)return new T(e.value,t);if(!(this instanceof T))return new T(e,t);if(this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease,this.raw=e,this.set=e.split(/\s*\|\|\s*/).map((function(e){return this.parseRange(e.trim())}),this).filter((function(e){return e.length})),!this.set.length)throw new TypeError("Invalid SemVer Range: "+e);this.format()}function N(e,t){for(var r=!0,n=e.slice(),i=n.pop();r&&n.length;)r=n.every((function(e){return i.intersects(e,t)})),i=n.pop();return r}function P(e){return!e||"x"===e.toLowerCase()||"*"===e}function x(e,t,r,n,i,s,o,a,c,u,l,h,d){return((t=P(r)?"":P(n)?">="+r+".0.0":P(i)?">="+r+"."+n+".0":">="+t)+" "+(a=P(c)?"":P(u)?"<"+(+c+1)+".0.0":P(l)?"<"+c+"."+(+u+1)+".0":h?"<="+c+"."+u+"."+l+"-"+h:"<="+a)).trim()}function O(e,t,r){for(var i=0;i<e.length;i++)if(!e[i].test(t))return!1;if(t.prerelease.length&&!r.includePrerelease){for(i=0;i<e.length;i++)if(n(e[i].semver),e[i].semver!==I&&e[i].semver.prerelease.length>0){var s=e[i].semver;if(s.major===t.major&&s.minor===t.minor&&s.patch===t.patch)return!0}return!1}return!0}function M(e,t,r){try{t=new T(t,r)}catch(e){return!1}return t.test(e)}function k(e,t,r,n){var i,s,o,a,c;switch(e=new d(e,n),t=new T(t,n),r){case">":i=g,s=w,o=y,a=">",c=">=";break;case"<":i=y,s=S,o=g,a="<",c="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(M(e,t,n))return!1;for(var u=0;u<t.set.length;++u){var l=null,h=null;if(t.set[u].forEach((function(e){e.semver===I&&(e=new E(">=0.0.0")),h=h||e,i(e.semver,(l=l||e).semver,n)?l=e:o(e.semver,h.semver,n)&&(h=e)})),l.operator===a||l.operator===c)return!1;if((!h.operator||h.operator===a)&&s(e,h.semver))return!1;if(h.operator===c&&o(e,h.semver))return!1}return!0}E.prototype.parse=function(e){var t=e.match(this.options.loose?s[a.COMPARATORLOOSE]:s[a.COMPARATOR]);if(!t)throw new TypeError("Invalid comparator: "+e);this.operator=void 0!==t[1]?t[1]:"","="===this.operator&&(this.operator=""),this.semver=t[2]?new d(t[2],this.options.loose):I},E.prototype.toString=function(){return this.value},E.prototype.test=function(e){if(n("Comparator.test",e,this.options.loose),this.semver===I||e===I)return!0;if("string"==typeof e)try{e=new d(e,this.options)}catch(e){return!1}return C(e,this.operator,this.semver,this.options)},E.prototype.intersects=function(e,t){if(!(e instanceof E))throw new TypeError("a Comparator is required");var r;if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),""===this.operator)return""===this.value||(r=new T(e.value,t),M(this.value,r,t));if(""===e.operator)return""===e.value||(r=new T(this.value,t),M(e.semver,r,t));var n=!(">="!==this.operator&&">"!==this.operator||">="!==e.operator&&">"!==e.operator),i=!("<="!==this.operator&&"<"!==this.operator||"<="!==e.operator&&"<"!==e.operator),s=this.semver.version===e.semver.version,o=!(">="!==this.operator&&"<="!==this.operator||">="!==e.operator&&"<="!==e.operator),a=C(this.semver,"<",e.semver,t)&&(">="===this.operator||">"===this.operator)&&("<="===e.operator||"<"===e.operator),c=C(this.semver,">",e.semver,t)&&("<="===this.operator||"<"===this.operator)&&(">="===e.operator||">"===e.operator);return n||i||s&&o||a||c},t.Range=T,T.prototype.format=function(){return this.range=this.set.map((function(e){return e.join(" ").trim()})).join("||").trim(),this.range},T.prototype.toString=function(){return this.range},T.prototype.parseRange=function(e){var t=this.options.loose;e=(e=e.trim()).replace(t?s[a.HYPHENRANGELOOSE]:s[a.HYPHENRANGE],x),n("hyphen replace",e),e=e.replace(s[a.COMPARATORTRIM],"$1$2$3"),n("comparator trim",e,s[a.COMPARATORTRIM]),e=(e=(e=e.replace(s[a.TILDETRIM],"$1~")).replace(s[a.CARETTRIM],"$1^")).split(/\s+/).join(" ");var r=t?s[a.COMPARATORLOOSE]:s[a.COMPARATOR],i=e.split(" ").map((function(e){return function(e,t){return n("comp",e,t),e=function(e,t){return e.trim().split(/\s+/).map((function(e){return function(e,t){return n("caret",e,t),e.replace(t.loose?s[a.CARETLOOSE]:s[a.CARET],(function(t,r,i,s,o){var a;return n("caret",e,t,r,i,s,o),P(r)?a="":P(i)?a=">="+r+".0.0 <"+(+r+1)+".0.0":P(s)?a="0"===r?">="+r+"."+i+".0 <"+r+"."+(+i+1)+".0":">="+r+"."+i+".0 <"+(+r+1)+".0.0":o?(n("replaceCaret pr",o),a="0"===r?"0"===i?">="+r+"."+i+"."+s+"-"+o+" <"+r+"."+i+"."+(+s+1):">="+r+"."+i+"."+s+"-"+o+" <"+r+"."+(+i+1)+".0":">="+r+"."+i+"."+s+"-"+o+" <"+(+r+1)+".0.0"):(n("no pr"),a="0"===r?"0"===i?">="+r+"."+i+"."+s+" <"+r+"."+i+"."+(+s+1):">="+r+"."+i+"."+s+" <"+r+"."+(+i+1)+".0":">="+r+"."+i+"."+s+" <"+(+r+1)+".0.0"),n("caret return",a),a}))}(e,t)})).join(" ")}(e,t),n("caret",e),e=function(e,t){return e.trim().split(/\s+/).map((function(e){return function(e,t){return e.replace(t.loose?s[a.TILDELOOSE]:s[a.TILDE],(function(t,r,i,s,o){var a;return n("tilde",e,t,r,i,s,o),P(r)?a="":P(i)?a=">="+r+".0.0 <"+(+r+1)+".0.0":P(s)?a=">="+r+"."+i+".0 <"+r+"."+(+i+1)+".0":o?(n("replaceTilde pr",o),a=">="+r+"."+i+"."+s+"-"+o+" <"+r+"."+(+i+1)+".0"):a=">="+r+"."+i+"."+s+" <"+r+"."+(+i+1)+".0",n("tilde return",a),a}))}(e,t)})).join(" ")}(e,t),n("tildes",e),e=function(e,t){return n("replaceXRanges",e,t),e.split(/\s+/).map((function(e){return function(e,t){return(e=e.trim()).replace(t.loose?s[a.XRANGELOOSE]:s[a.XRANGE],(function(r,i,s,o,a,c){n("xRange",e,r,i,s,o,a,c);var u=P(s),l=u||P(o),h=l||P(a);return"="===i&&h&&(i=""),c=t.includePrerelease?"-0":"",u?r=">"===i||"<"===i?"<0.0.0-0":"*":i&&h?(l&&(o=0),a=0,">"===i?(i=">=",l?(s=+s+1,o=0,a=0):(o=+o+1,a=0)):"<="===i&&(i="<",l?s=+s+1:o=+o+1),r=i+s+"."+o+"."+a+c):l?r=">="+s+".0.0"+c+" <"+(+s+1)+".0.0"+c:h&&(r=">="+s+"."+o+".0"+c+" <"+s+"."+(+o+1)+".0"+c),n("xRange return",r),r}))}(e,t)})).join(" ")}(e,t),n("xrange",e),e=function(e,t){return n("replaceStars",e,t),e.trim().replace(s[a.STAR],"")}(e,t),n("stars",e),e}(e,this.options)}),this).join(" ").split(/\s+/);return this.options.loose&&(i=i.filter((function(e){return!!e.match(r)}))),i.map((function(e){return new E(e,this.options)}),this)},T.prototype.intersects=function(e,t){if(!(e instanceof T))throw new TypeError("a Range is required");return this.set.some((function(r){return N(r,t)&&e.set.some((function(e){return N(e,t)&&r.every((function(r){return e.every((function(e){return r.intersects(e,t)}))}))}))}))},t.toComparators=function(e,t){return new T(e,t).set.map((function(e){return e.map((function(e){return e.value})).join(" ").trim().split(" ")}))},T.prototype.test=function(e){if(!e)return!1;if("string"==typeof e)try{e=new d(e,this.options)}catch(e){return!1}for(var t=0;t<this.set.length;t++)if(O(this.set[t],e,this.options))return!0;return!1},t.satisfies=M,t.maxSatisfying=function(e,t,r){var n=null,i=null;try{var s=new T(t,r)}catch(e){return null}return e.forEach((function(e){s.test(e)&&(n&&-1!==i.compare(e)||(i=new d(n=e,r)))})),n},t.minSatisfying=function(e,t,r){var n=null,i=null;try{var s=new T(t,r)}catch(e){return null}return e.forEach((function(e){s.test(e)&&(n&&1!==i.compare(e)||(i=new d(n=e,r)))})),n},t.minVersion=function(e,t){e=new T(e,t);var r=new d("0.0.0");if(e.test(r))return r;if(r=new d("0.0.0-0"),e.test(r))return r;r=null;for(var n=0;n<e.set.length;++n)e.set[n].forEach((function(e){var t=new d(e.semver.version);switch(e.operator){case">":0===t.prerelease.length?t.patch++:t.prerelease.push(0),t.raw=t.format();case"":case">=":r&&!g(r,t)||(r=t);break;case"<":case"<=":break;default:throw new Error("Unexpected operation: "+e.operator)}}));return r&&e.test(r)?r:null},t.validRange=function(e,t){try{return new T(e,t).range||"*"}catch(e){return null}},t.ltr=function(e,t,r){return k(e,t,"<",r)},t.gtr=function(e,t,r){return k(e,t,">",r)},t.outside=k,t.prerelease=function(e,t){var r=h(e,t);return r&&r.prerelease.length?r.prerelease:null},t.intersects=function(e,t,r){return e=new T(e,r),t=new T(t,r),e.intersects(t)},t.coerce=function(e,t){if(e instanceof d)return e;if("number"==typeof e&&(e=String(e)),"string"!=typeof e)return null;var r=null;if((t=t||{}).rtl){for(var n;(n=s[a.COERCERTL].exec(e))&&(!r||r.index+r[0].length!==e.length);)r&&n.index+n[0].length===r.index+r[0].length||(r=n),s[a.COERCERTL].lastIndex=n.index+n[1].length+n[2].length;s[a.COERCERTL].lastIndex=-1}else r=e.match(s[a.COERCE]);return null===r?null:h(r[2]+"."+(r[3]||"0")+"."+(r[4]||"0"),t)}}).call(this,r("5IsQ"))},NlbK:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CombinedContext=void 0,t.CombinedContext=class{constructor(e){this.context=e,this.checkpoints=[]}createContext(){const e=this.checkpoints.push(void 0)-1;return{log:this.context.log,checkpoint:t=>this.checkpoint(e,t),error:(t,r)=>this.error(e,t,r)}}checkpoint(e,t){this.checkpoints[e]=t;const r=this.getLowestMessage();void 0!==r&&(void 0===this.currentCheckpoint||this.currentCheckpoint.offset<r.offset)&&(this.currentCheckpoint=r,this.context.checkpoint(r))}error(e,t,r){this.context.error(t,r)}getLowestMessage(){let e;for(const t of this.checkpoints){if(void 0===t)return;(void 0===e||e.offset>t.offset)&&(e=t)}return e}}},"O/xt":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BroadcasterLambdaFactory=t.BroadcasterLambda=void 0;var n=r("Gluk");Object.defineProperty(t,"BroadcasterLambda",{enumerable:!0,get:function(){return n.BroadcasterLambda}});var i=r("wiRw");Object.defineProperty(t,"BroadcasterLambdaFactory",{enumerable:!0,get:function(){return i.BroadcasterLambdaFactory}})},O3lp:function(e,t,r){"use strict";(function(t){class r extends Error{constructor(e){super(r._prepareSuperMessage(e)),Object.defineProperty(this,"name",{value:"NonError",configurable:!0,writable:!0}),Error.captureStackTrace&&Error.captureStackTrace(this,r)}static _prepareSuperMessage(e){try{return JSON.stringify(e)}catch{return String(e)}}}const n=[{property:"name",enumerable:!1},{property:"message",enumerable:!1},{property:"stack",enumerable:!1},{property:"code",enumerable:!0}],i=Symbol(".toJSON called"),s=({from:e,seen:r,to_:o,forceEnumerable:a,maxDepth:c,depth:u})=>{const l=o||(Array.isArray(e)?[]:{});if(r.push(e),u>=c)return l;if("function"==typeof e.toJSON&&!0!==e[i])return(e=>{e[i]=!0;const t=e.toJSON();return delete e[i],t})(e);for(const[n,i]of Object.entries(e))"function"==typeof t&&t.isBuffer(i)?l[n]="[object Buffer]":"function"!=typeof i&&(i&&"object"==typeof i?r.includes(e[n])?l[n]="[Circular]":(u++,l[n]=s({from:e[n],seen:r.slice(),forceEnumerable:a,maxDepth:c,depth:u})):l[n]=i);for(const{property:t,enumerable:r}of n)"string"==typeof e[t]&&Object.defineProperty(l,t,{value:e[t],enumerable:!!a||r,configurable:!0,writable:!0});return l};e.exports={serializeError:(e,t={})=>{const{maxDepth:r=Number.POSITIVE_INFINITY}=t;return"object"==typeof e&&null!==e?s({from:e,seen:[],forceEnumerable:!0,maxDepth:r,depth:0}):"function"==typeof e?`[Function: ${e.name||"anonymous"}]`:e},deserializeError:(e,t={})=>{const{maxDepth:n=Number.POSITIVE_INFINITY}=t;if(e instanceof Error)return e;if("object"==typeof e&&null!==e&&!Array.isArray(e)){const t=new Error;return s({from:e,seen:[],to_:t,maxDepth:n,depth:0}),t}return new r(e)}}}).call(this,r("zkTx").Buffer)},O4c1:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultMetricClient=void 0,t.DefaultMetricClient=class{writeLatencyMetric(e,t){return Promise.resolve()}}},ODJF:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DeliLambda=t.OpEventType=void 0;const n=r("iS6B"),i=r("y2M+"),s=r("YkJt"),o=r("yQiv"),a=r("fhs9"),c=r("wWog"),u=r("KMXR"),l=r("n5Ot"),h=r("A+TC");var d,m,p,f,g;!function(e){e[e.Duplicate=0]="Duplicate",e[e.Gap=1]="Gap",e[e.ConsecutiveOrSystem=2]="ConsecutiveOrSystem"}(d||(d={})),function(e){e[e.Immediate=0]="Immediate",e[e.Later=1]="Later",e[e.Never=2]="Never"}(m||(m={})),function(e){e[e.ClearCache=0]="ClearCache",e[e.NoOp=1]="NoOp"}(p||(p={})),function(e){e[e.Sequenced=0]="Sequenced",e[e.Nack=1]="Nack",e[e.Signal=2]="Signal"}(f||(f={})),function(e){e[e.Idle=0]="Idle",e[e.MaxOps=1]="MaxOps",e[e.MaxTime=2]="MaxTime",e[e.UpdatedDurableSequenceNumber=3]="UpdatedDurableSequenceNumber"}(g=t.OpEventType||(t.OpEventType={})),t.DeliLambda=class extends c.TypedEventEmitter{constructor(e,t,r,n,i,a,c,u,d,m,f,g){let y=arguments.length>12&&void 0!==arguments[12]?arguments[12]:new Map;var v,b,S,w;if(super(),this.context=e,this.tenantId=t,this.documentId=r,this.lastCheckpoint=n,this.clientManager=a,this.deltasProducer=c,this.signalsProducer=u,this.rawDeltasProducer=d,this.serviceConfiguration=m,this.sessionMetric=f,this.sessionStartMetric=g,this.sequencedSignalClients=y,this.clientSeqManager=new h.ClientSequenceNumberManager,this.minimumSequenceNumber=0,this.lastSendP=Promise.resolve(),this.lastNoClientP=Promise.resolve(),this.lastSentMSN=0,this.lastInstruction=p.NoOp,this.opEvent={sequencedMessagesSinceLastOpEvent:0},this.checkpointInfo={lastCheckpointTime:Date.now(),rawMessagesSinceCheckpoint:0},this.closed=!1,this.serviceSummaryGenerated=!1,this.isNewDocument=!1,this.successfullyStartedLambdas=[],this.expectedSuccessfullyStartedLambdas=[o.LambdaName.Scribe],n.clients)for(const e of n.clients)e.clientId&&this.clientSeqManager.upsertClient(e.clientId,e.clientSequenceNumber,e.referenceSequenceNumber,e.lastUpdate,e.canEvict,e.scopes,e.nack,e.serverMetadata);if(this.sequenceNumber=n.sequenceNumber,this.signalClientConnectionNumber=null!==(v=n.signalClientConnectionNumber)&&void 0!==v?v:0,this.lastHash=null!==(b=n.expHash1)&&void 0!==b?b:s.defaultHash,this.term=n.term,this.epoch=n.epoch,this.durableSequenceNumber=n.durableSequenceNumber,this.lastSentMSN=null!==(S=n.lastSentMSN)&&void 0!==S?S:0,this.logOffset=n.logOffset,n.nackMessages)if(Array.isArray(n.nackMessages))this.nackMessages=new Map(n.nackMessages);else{this.nackMessages=new Map;const e=n.nackMessages.identifier;void 0!==e&&this.nackMessages.set(e,n.nackMessages)}else this.nackMessages=new Map;this.successfullyStartedLambdas=null!==(w=n.successfullyStartedLambdas)&&void 0!==w?w:[];const C=this.clientSeqManager.getMinimumSequenceNumber();this.noActiveClients=-1===C,this.minimumSequenceNumber=this.noActiveClients?this.sequenceNumber:C,this.serviceConfiguration.deli.summaryNackMessages.checkOnStartup&&this.checkNackMessagesState(),this.checkpointContext=new l.CheckpointContext(this.tenantId,this.documentId,i,e),this.setActivityIdleTimer(),this.setReadClientIdleTimer(),this.serviceConfiguration.deli.opEvent.enable&&(this.updateOpMaxTimeTimer(),this.sequenceNumber>this.durableSequenceNumber&&(this.opEvent.sequencedMessagesSinceLastOpEvent=this.sequenceNumber-this.durableSequenceNumber)),this.isNewDocument=0===this.sequenceNumber,m.enableLumberjack&&this.logSessionStartMetrics(),this.serviceConfiguration.deli.checkForIdleClientsOnStartup&&this.checkIdleWriteClients(Date.now())}handler(e){if(e.offset<=this.logOffset)return a.Lumberjack.info(`rawMessage.offset: ${e.offset} <= this.logOffset: ${this.logOffset}`,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId)),this.updateCheckpointMessages(e),void(this.checkpointInfo.currentKafkaCheckpointMessage&&this.context.checkpoint(this.checkpointInfo.currentKafkaCheckpointMessage));this.logOffset=e.offset;let t=0;const r=[],n=(0,o.extractBoxcar)(e);for(const e of n.contents){const n=this.ticket(e,this.serviceConfiguration.enableTraces?this.createTrace("start"):void 0);if(n)switch(this.lastInstruction=n.instruction,n.ticketType){case f.Sequenced:{if(n.type!==i.MessageType.ClientLeave&&this.checkIdleWriteClients(n.timestamp),n.type!==i.MessageType.NoClient&&n.type!==i.MessageType.Control&&this.noActiveClients&&!this.serviceConfiguration.deli.disableNoClientMessage&&(this.lastNoClientP=this.sendToRawDeltas(this.createOpMessage(i.MessageType.NoClient)).catch((e=>{var t;const r="Could not send no client message";null===(t=this.context.log)||void 0===t||t.error(`${r}: ${JSON.stringify(e)}`,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),a.Lumberjack.error(r,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId),e),this.context.error(e,{restart:!0,tenantId:this.tenantId,documentId:this.documentId})}))),n.send===m.Never)continue;if(this.clearNoopConsolidationTimer(),n.send===m.Later){this.setNoopConsolidationTimer();continue}const c=n.message;this.serviceConfiguration.deli.enableOpHashing&&(this.lastHash=(0,s.getNextHash)(c,this.lastHash),c.expHash1=this.lastHash),c.type===i.MessageType.Summarize&&this.emit("summarizeMessage",c);const u={type:o.SequencedOperationType,tenantId:this.tenantId,documentId:this.documentId,operation:c};if(this.serviceConfiguration.deli.maintainBatches?r.push(u):this.produceMessage(this.deltasProducer,u),t++,this.lastSentMSN=n.msn,this.signalsProducer&&(c.type===i.MessageType.ClientJoin||c.type===i.MessageType.ClientLeave)&&(this.serviceConfiguration.deli.enableWriteClientSignals||c.serverMetadata&&"object"==typeof c.serverMetadata&&c.serverMetadata.createSignal)){const t=this.extractDataContent(e),r=this.createSignalMessage(e,c.sequenceNumber-1,t);c.type===i.MessageType.ClientJoin?this.addSequencedSignalClient(t,r):this.sequencedSignalClients.delete(t),this.produceMessage(this.signalsProducer,r.message)}break}case f.Nack:this.serviceConfiguration.deli.maintainBatches?r.push(n.message):this.produceMessage(this.deltasProducer,n.message);break;case f.Signal:this.signalsProducer&&this.produceMessage(this.signalsProducer,n.message)}}r.length>0&&this.produceMessages(this.deltasProducer,r,e),this.checkpointInfo.rawMessagesSinceCheckpoint++,this.updateCheckpointMessages(e);const c=this.getCheckpointReason();if(void 0!==c?this.checkpoint(c):this.updateCheckpointIdleTimer(),this.clearActivityIdleTimer(),this.setActivityIdleTimer(),t>0&&(this.serviceConfiguration.deli.summaryNackMessages.enable&&!this.nackMessages.has(o.NackMessagesType.SummaryMaxOps)&&this.sequenceNumber-this.durableSequenceNumber>this.serviceConfiguration.deli.summaryNackMessages.maxOps&&this.updateNackMessages(o.NackMessagesType.SummaryMaxOps,{identifier:o.NackMessagesType.SummaryMaxOps,content:this.serviceConfiguration.deli.summaryNackMessages.nackContent,allowSystemMessages:!0,allowedScopes:[i.ScopeType.SummaryWrite]}),this.serviceConfiguration.deli.opEvent.enable)){this.updateOpIdleTimer();const e=this.serviceConfiguration.deli.opEvent.maxOps;void 0!==e&&(this.opEvent.sequencedMessagesSinceLastOpEvent+=t,this.opEvent.sequencedMessagesSinceLastOpEvent>e&&this.emitOpEvent(g.MaxOps))}}close(e){this.closed=!0,this.checkpointContext.close(),this.clearActivityIdleTimer(),this.clearReadClientIdleTimer(),this.clearNoopConsolidationTimer(),this.clearCheckpointIdleTimer(),this.clearOpIdleTimer(),this.clearOpMaxTimeTimer(),this.emit("close",e),this.removeAllListeners(),this.serviceConfiguration.enableLumberjack&&this.logSessionEndMetrics(e)}produceMessage(e,t){this.lastSendP=e.send([t],t.tenantId,t.documentId).catch((e=>{var t;if(this.closed)return;const r="Could not send message to producer";null===(t=this.context.log)||void 0===t||t.error(`${r}: ${JSON.stringify(e)}`,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),a.Lumberjack.error(r,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId),e),this.context.error(e,{restart:!0,tenantId:this.tenantId,documentId:this.documentId})}))}produceMessages(e,t,r){this.lastSendP=e.send(t,this.tenantId,this.documentId).catch((e=>{var n;if(this.closed)return;const i=`Could not send ${t.length} messages to producer. offset: ${r.offset}`;null===(n=this.context.log)||void 0===n||n.error(`${i}: ${JSON.stringify(e)}`,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),a.Lumberjack.error(i,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId),e);let o=!0,c=!1;(0,s.isNetworkError)(e)&&413===e.code&&(o=!1,c=!0),this.context.error(e,{restart:o,markAsCorrupt:c?r:void 0,tenantId:this.tenantId,documentId:this.documentId})}))}logSessionStartMetrics(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];var t,r,n,i,s,o,c,l;if((null===(t=this.sessionStartMetric)||void 0===t?void 0:t.isCompleted())&&(this.sessionStartMetric=(0,u.createSessionMetric)(this.tenantId,this.documentId,a.LumberEventName.StartSessionResult,this.serviceConfiguration)),e)return null===(r=this.sessionStartMetric)||void 0===r||r.setProperties({[a.CommonProperties.sessionState]:a.SessionState.LambdaStartFailed}),void(null===(n=this.sessionStartMetric)||void 0===n||n.error("Lambda start failed"));if(this.verifyRequiredLambdaStarted())this.isNewDocument?(null===(i=this.sessionStartMetric)||void 0===i||i.setProperties({[a.CommonProperties.sessionState]:a.SessionState.started}),null===(s=this.sessionStartMetric)||void 0===s||s.success("Session started successfully")):(null===(o=this.sessionStartMetric)||void 0===o||o.setProperties({[a.CommonProperties.sessionState]:a.SessionState.resumed}),null===(c=this.sessionStartMetric)||void 0===c||c.success("Session resumed successfully"));else{const e="Not all required lambdas started";null===(l=this.context.log)||void 0===l||l.info(e),a.Lumberjack.info(e,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId))}}verifyRequiredLambdaStarted(){return this.expectedSuccessfullyStartedLambdas.every((e=>this.successfullyStartedLambdas.includes(e)))}logSessionEndMetrics(e){var t,r;(null===(t=this.sessionMetric)||void 0===t?void 0:t.isCompleted())&&(a.Lumberjack.info("Session metric already completed. Creating a new one.",(0,a.getLumberBaseProperties)(this.documentId,this.tenantId)),this.sessionMetric=(0,u.createSessionMetric)(this.tenantId,this.documentId,a.LumberEventName.SessionResult,this.serviceConfiguration)),null===(r=this.sessionMetric)||void 0===r||r.setProperties({[a.CommonProperties.serviceSummarySuccess]:this.serviceSummaryGenerated}),(0,u.logCommonSessionEndMetrics)(this.context,e,this.sessionMetric,this.sequenceNumber,this.durableSequenceNumber,Array.from(this.nackMessages.keys()))}ticket(e,t){var r,c,u,l,h,g;if(e.type!==o.RawOperationType)return;const y=e,v=this.extractDataContent(y);if(this.nackMessages.size>0&&this.serviceConfiguration.deli.enableNackMessages)for(const e of this.nackMessages.values()){let t=!0;if(!e.allowSystemMessages||!(0,n.isServiceMessageType)(y.operation.type)&&y.clientId){if(e.allowedScopes){const r=y.clientId;if(r){const n=this.clientSeqManager.get(r);if(n)for(const r of e.allowedScopes)if(n.scopes.includes(r)){t=!1;break}}}}else t=!1;if(t)return this.createNackMessage(y,e.content.code,e.content.type,e.content.message,e.content.retryAfter)}const b=this.checkOrder(y);if(b===d.Duplicate)return;if(b===d.Gap)return this.createNackMessage(y,400,i.NackErrorType.BadRequestError,"Gap detected in incoming op");if(this.isInvalidMessage(y))return this.createNackMessage(y,400,i.NackErrorType.BadRequestError,"Op not allowed");if(y.clientId){const e=this.clientSeqManager.get(y.clientId);if(!e||e.nack)return this.createNackMessage(y,400,i.NackErrorType.BadRequestError,"Nonexistent client");if(y.clientId&&-1!==y.operation.referenceSequenceNumber&&y.operation.referenceSequenceNumber<this.minimumSequenceNumber)return this.clientSeqManager.upsertClient(y.clientId,y.operation.clientSequenceNumber,this.minimumSequenceNumber,y.timestamp,!0,[],!0),this.createNackMessage(y,400,i.NackErrorType.BadRequestError,`Refseq ${y.operation.referenceSequenceNumber} < ${this.minimumSequenceNumber}`);if(y.operation.type===i.MessageType.Summarize&&!(0,s.canSummarize)(e.scopes))return this.createNackMessage(y,403,i.NackErrorType.InvalidScopeError,`Client ${y.clientId} does not have summary permission`)}else if(y.operation.type===i.MessageType.ClientLeave){if(!this.clientSeqManager.removeClient(v))return this.sequencedSignalClients.get(v)?(this.sequencedSignalClients.delete(v),this.createSignalMessage(y,this.sequenceNumber,v)):void 0;this.serviceConfiguration.deli.enableLeaveOpNoClientServerMetadata&&0===this.clientSeqManager.count()&&((null!==(r=(g=y.operation).serverMetadata)&&void 0!==r?r:g.serverMetadata={}).noClient=!0)}else if(y.operation.type===i.MessageType.ClientJoin){const e=v;if("read"===e.detail.mode){if(this.sequencedSignalClients.has(e.clientId))return;const t=this.createSignalMessage(y,this.sequenceNumber,v);return this.addSequencedSignalClient(e,t),t}if(!this.clientSeqManager.upsertClient(e.clientId,0,this.minimumSequenceNumber,y.timestamp,!0,e.detail.scopes,!1,y.operation.serverMetadata))return}let S=this.sequenceNumber;y.clientId?(y.operation.type!==i.MessageType.NoOp&&(S=this.revSequenceNumber()),-1===y.operation.referenceSequenceNumber&&(y.operation.referenceSequenceNumber=S),this.clientSeqManager.upsertClient(y.clientId,y.operation.clientSequenceNumber,y.operation.referenceSequenceNumber,y.timestamp,!0)):y.operation.type!==i.MessageType.NoOp&&y.operation.type!==i.MessageType.NoClient&&y.operation.type!==i.MessageType.Control&&(S=this.revSequenceNumber());const w=this.clientSeqManager.getMinimumSequenceNumber();-1===w?(this.minimumSequenceNumber=S,this.noActiveClients=!0):(this.minimumSequenceNumber=w,this.noActiveClients=!1);let C=m.Immediate,E=p.NoOp;switch(y.operation.type){case i.MessageType.NoOp:y.clientId?null===y.operation.contents||this.minimumSequenceNumber<=this.lastSentMSN?C=m.Later:S=this.revSequenceNumber():this.minimumSequenceNumber<=this.lastSentMSN?C=m.Never:S=this.revSequenceNumber();break;case i.MessageType.NoClient:this.noActiveClients?(S=this.revSequenceNumber(),y.operation.referenceSequenceNumber=S,this.minimumSequenceNumber=S):C=m.Never;break;case i.MessageType.Control:{C=m.Never;const e=v;switch(e.type){case o.ControlMessageType.UpdateDSN:{const t=`Update DSN: ${JSON.stringify(e)}`;null===(c=this.context.log)||void 0===c||c.info(t,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),a.Lumberjack.info(t,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId));const r=e.contents;this.serviceSummaryGenerated=!r.isClientSummary;const n=r.durableSequenceNumber;if(n>=this.durableSequenceNumber){if(r.clearCache&&this.noActiveClients){E=p.ClearCache;const e="Deli cache will be cleared";null===(u=this.context.log)||void 0===u||u.info(e,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),a.Lumberjack.info(e,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId))}this.updateDurableSequenceNumber(n)}break}case o.ControlMessageType.NackMessages:{const t=e.contents;this.updateNackMessages(t.identifier,void 0!==t.content?t:void 0);break}case o.ControlMessageType.LambdaStartResult:{const t=e.contents;t.success&&this.successfullyStartedLambdas.push(t.lambdaName),this.logSessionStartMetrics(!t.success);break}case o.ControlMessageType.ExtendClient:{const t=e.contents,r=new Map,n=null!==(l=t.clientIds)&&void 0!==l?l:t.clientId?[t.clientId]:[];for(const e of n){const t=this.sequencedSignalClients.get(e);t&&r.set(e,t)}if(r.size>0)if(this.clientManager)this.clientManager.extendSequencedClients(this.tenantId,this.documentId,r,this.serviceConfiguration.deli.clientTimeout).catch((e=>{var t;const r="Could not extend clients";null===(t=this.context.log)||void 0===t||t.error(`${r}: ${JSON.stringify(e)}`,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),a.Lumberjack.error(r,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId),e)}));else{const e="Could not extend clients. Missing client manager";null===(h=this.context.log)||void 0===h||h.error(`${e}`,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),a.Lumberjack.error(e,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId))}break}default:this.emit("controlMessage",e)}break}case i.MessageType.SummaryAck:if(this.serviceConfiguration.deli.enableAutoDSNUpdate){const e=v.summaryProposal.summarySequenceNumber;e>=this.durableSequenceNumber&&this.updateDurableSequenceNumber(e)}}t&&y.operation.traces&&y.operation.traces.length>1&&(y.operation.traces.push(t),y.operation.traces.push(this.createTrace("end")));const I=this.createOutputMessage(y,void 0,S,v);return{ticketType:f.Sequenced,instruction:E,message:I,msn:this.minimumSequenceNumber,send:C,timestamp:y.timestamp,type:y.operation.type}}extractDataContent(e){if(e.operation.type===i.MessageType.ClientJoin||e.operation.type===i.MessageType.ClientLeave||e.operation.type===i.MessageType.SummaryAck||e.operation.type===i.MessageType.SummaryNack||e.operation.type===i.MessageType.Control){const t=e.operation;if(t.data)return JSON.parse(t.data)}}isInvalidMessage(e){return!!e.clientId&&(0,n.isServiceMessageType)(e.operation.type)}createOutputMessage(e,t,r,n){var s;const o={clientId:e.clientId,clientSequenceNumber:e.operation.clientSequenceNumber,contents:e.operation.contents,metadata:e.operation.metadata,serverMetadata:e.operation.serverMetadata,minimumSequenceNumber:this.minimumSequenceNumber,origin:t,referenceSequenceNumber:e.operation.referenceSequenceNumber,sequenceNumber:r,term:this.term,timestamp:e.timestamp,traces:e.operation.traces,type:e.operation.type,compression:e.operation.compression};if(e.operation.type===i.MessageType.Summarize||e.operation.type===i.MessageType.NoClient){const t=o;let r=!1;if(this.serviceConfiguration.scribe.generateServiceSummary?r=!0:e.operation.type===i.MessageType.Summarize&&(this.serviceConfiguration.deli.skipSummarizeAugmentationForSingleCommmit&&(null===(s=JSON.parse(e.operation.contents).details)||void 0===s?void 0:s.includesProtocolTree)||(r=!0)),r){const e=JSON.stringify(this.generateDeliCheckpoint());t.additionalContent=e}return t}if(void 0!==n){const e=o;return e.data=JSON.stringify(n),e}return o}checkOrder(e){var t,r;if(!e.clientId)return d.ConsecutiveOrSystem;const n=e.clientId,i=e.operation.clientSequenceNumber,s=this.clientSeqManager.get(n);if(!s)return d.ConsecutiveOrSystem;const o={documentId:this.documentId,tenantId:this.tenantId},c=s.clientSequenceNumber+1;if(i===c)return d.ConsecutiveOrSystem;if(i>c){const e=`Gap ${n}:${c} > ${i}`;return null===(t=this.context.log)||void 0===t||t.info(e,{messageMetaData:o}),a.Lumberjack.info(e,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId)),d.Gap}{const e=`Duplicate ${n}:${c} < ${i}`;return null===(r=this.context.log)||void 0===r||r.info(e,{messageMetaData:o}),a.Lumberjack.info(e,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId)),d.Duplicate}}async sendToRawDeltas(e){var t;try{await this.rawDeltasProducer.send([e],e.tenantId,e.documentId)}catch(e){if(this.closed)return;const r="Could not send message to alfred";null===(t=this.context.log)||void 0===t||t.error(`${r}: ${JSON.stringify(e)}`,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),a.Lumberjack.error(r,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId),e),this.context.error(e,{restart:!0,tenantId:this.tenantId,documentId:this.documentId})}}checkIdleWriteClients(e){const t=this.getIdleClient(e);if(null==t?void 0:t.clientId){const e=this.createLeaveMessage(t.clientId,t.serverMetadata);this.sendToRawDeltas(e)}}checkIdleReadClients(){const e=Date.now();for(const[t,{client:r,exp:n}]of this.sequencedSignalClients)if("read"===r.mode&&n<e){const e=this.createLeaveMessage(t);this.sendToRawDeltas(e)}}createLeaveMessage(e,t){const r={clientSequenceNumber:-1,contents:null,data:JSON.stringify(e),referenceSequenceNumber:-1,traces:this.serviceConfiguration.enableTraces?[]:void 0,type:i.MessageType.ClientLeave,serverMetadata:t};return this.createRawOperationMessage(r)}createNackMessage(e,t,r,n,i){const s=e.clientId;if(!s)return;const a={clientId:s,documentId:this.documentId,operation:{content:{code:t,type:r,message:n,retryAfter:i},operation:e.operation,sequenceNumber:this.minimumSequenceNumber},tenantId:this.tenantId,timestamp:Date.now(),type:o.NackOperationType};return{ticketType:f.Nack,message:a}}createSignalMessage(e,t,r){let n;switch(e.operation.type){case i.MessageType.ClientJoin:n=(0,u.createRoomJoinMessage)(r.clientId,r.detail);break;case i.MessageType.ClientLeave:n=(0,u.createRoomLeaveMessage)("string"==typeof r?r:r.clientId);break;case i.MessageType.Control:n={clientId:null,content:JSON.stringify({type:i.MessageType.Control,content:r})};break;default:throw new Error(`Cannot create signal message for type ${e.operation.type}`)}return n.referenceSequenceNumber=t,n.clientConnectionNumber=++this.signalClientConnectionNumber,{ticketType:f.Signal,message:{type:o.SignalOperationType,tenantId:this.tenantId,documentId:this.documentId,operation:n,timestamp:Date.now()}}}createOpMessage(e){return this.createRawOperationMessage({clientSequenceNumber:-1,contents:null,referenceSequenceNumber:-1,traces:this.serviceConfiguration.enableTraces?[]:void 0,type:e})}createRawOperationMessage(e){return{clientId:null,documentId:this.documentId,operation:e,tenantId:this.tenantId,timestamp:Date.now(),type:o.RawOperationType}}createTrace(e){return{action:e,service:"deli",timestamp:Date.now()}}updateCheckpointMessages(e){if(this.checkpointInfo.currentCheckpointMessage=e,this.noActiveClients)this.checkpointInfo.nextKafkaCheckpointMessage=void 0,this.checkpointInfo.currentKafkaCheckpointMessage=e;else{const t=this.checkpointInfo.nextKafkaCheckpointMessage;this.checkpointInfo.nextKafkaCheckpointMessage=e,this.checkpointInfo.currentKafkaCheckpointMessage=t}}generateCheckpoint(e){return{reason:e,deliState:this.generateDeliCheckpoint(),deliCheckpointMessage:this.checkpointInfo.currentCheckpointMessage,kafkaCheckpointMessage:this.checkpointInfo.currentKafkaCheckpointMessage}}generateDeliCheckpoint(){return{clients:this.clientSeqManager.cloneValues(),durableSequenceNumber:this.durableSequenceNumber,epoch:this.epoch,expHash1:this.lastHash,logOffset:this.logOffset,sequenceNumber:this.sequenceNumber,signalClientConnectionNumber:this.signalClientConnectionNumber,term:this.term,lastSentMSN:this.lastSentMSN,nackMessages:Array.from(this.nackMessages),successfullyStartedLambdas:this.successfullyStartedLambdas,checkpointTimestamp:Date.now()}}revSequenceNumber(){return++this.sequenceNumber}getIdleClient(e){const t=this.clientSeqManager.peek();if((null==t?void 0:t.canEvict)&&e-t.lastUpdate>this.serviceConfiguration.deli.clientTimeout)return t}setActivityIdleTimer(){this.noActiveClients||(this.activityIdleTimer=setTimeout((()=>{if(!this.noActiveClients){const e=this.createOpMessage(i.MessageType.NoOp);this.sendToRawDeltas(e)}}),this.serviceConfiguration.deli.activityTimeout))}clearActivityIdleTimer(){void 0!==this.activityIdleTimer&&(clearTimeout(this.activityIdleTimer),this.activityIdleTimer=void 0)}setReadClientIdleTimer(){this.clearReadClientIdleTimer(),this.readClientIdleTimer=setInterval((()=>{this.checkIdleReadClients()}),this.serviceConfiguration.deli.readClientIdleTimer)}clearReadClientIdleTimer(){void 0!==this.readClientIdleTimer&&(clearInterval(this.readClientIdleTimer),this.readClientIdleTimer=void 0)}setNoopConsolidationTimer(){this.noActiveClients||(this.noopEvent=setTimeout((()=>{if(!this.noActiveClients){const e=this.createOpMessage(i.MessageType.NoOp);this.sendToRawDeltas(e)}}),this.serviceConfiguration.deli.noOpConsolidationTimeout))}clearNoopConsolidationTimer(){void 0!==this.noopEvent&&(clearTimeout(this.noopEvent),this.noopEvent=void 0)}updateOpIdleTimer(){const e=this.serviceConfiguration.deli.opEvent.idleTime;void 0!==e&&(this.clearOpIdleTimer(),this.opEvent.idleTimer=setTimeout((()=>{this.emitOpEvent(g.Idle)}),e))}clearOpIdleTimer(){void 0!==this.opEvent.idleTimer&&(clearTimeout(this.opEvent.idleTimer),this.opEvent.idleTimer=void 0)}updateOpMaxTimeTimer(){const e=this.serviceConfiguration.deli.opEvent.maxTime;void 0!==e&&(this.clearOpMaxTimeTimer(),this.opEvent.maxTimer=setTimeout((()=>{this.emitOpEvent(g.MaxTime)}),e))}clearOpMaxTimeTimer(){void 0!==this.opEvent.maxTimer&&(clearTimeout(this.opEvent.maxTimer),this.opEvent.maxTimer=void 0)}emitOpEvent(e,t){(t||0!==this.opEvent.sequencedMessagesSinceLastOpEvent)&&(this.emit("opEvent",e,this.sequenceNumber,this.opEvent.sequencedMessagesSinceLastOpEvent),this.opEvent.sequencedMessagesSinceLastOpEvent=0,this.updateOpMaxTimeTimer())}checkNackMessagesState(){this.serviceConfiguration.deli.summaryNackMessages.enable&&this.nackMessages.has(o.NackMessagesType.SummaryMaxOps)&&this.sequenceNumber-this.durableSequenceNumber<=this.serviceConfiguration.deli.summaryNackMessages.maxOps&&this.updateNackMessages(o.NackMessagesType.SummaryMaxOps,void 0)}getCheckpointReason(){const e=this.serviceConfiguration.deli.checkpointHeuristics;return e.enable?this.checkpointInfo.rawMessagesSinceCheckpoint>=e.maxMessages?u.CheckpointReason.MaxMessages:Date.now()-this.checkpointInfo.lastCheckpointTime>=e.maxTime?u.CheckpointReason.MaxTime:this.lastInstruction===p.ClearCache?u.CheckpointReason.ClearCache:void 0:u.CheckpointReason.EveryMessage}checkpoint(e){this.clearCheckpointIdleTimer(),this.checkpointInfo.lastCheckpointTime=Date.now(),this.checkpointInfo.rawMessagesSinceCheckpoint=0;const t=this.generateCheckpoint(e);Promise.all([this.lastSendP,this.lastNoClientP]).then((()=>{var r,n;e===u.CheckpointReason.ClearCache&&(t.clear=!0),this.checkpointContext.checkpoint(t);const i=u.CheckpointReason[t.reason],s=`Writing checkpoint. Reason: ${i}`,o=Object.assign(Object.assign({},(0,a.getLumberBaseProperties)(this.documentId,this.tenantId)),{checkpointReason:i,lastOffset:this.logOffset,deliCheckpointOffset:t.deliCheckpointMessage.offset,deliCheckpointPartition:t.deliCheckpointMessage.partition,kafkaCheckpointOffset:null===(r=t.kafkaCheckpointMessage)||void 0===r?void 0:r.offset,kafkaCheckpointPartition:null===(n=t.kafkaCheckpointMessage)||void 0===n?void 0:n.partition});a.Lumberjack.info(s,o)}),(e=>{var t;const r="Could not send message to scriptorium";null===(t=this.context.log)||void 0===t||t.error(`${r}: ${JSON.stringify(e)}`,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),a.Lumberjack.error(r,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId),e),this.context.error(e,{restart:!0,tenantId:this.tenantId,documentId:this.documentId})}))}updateCheckpointIdleTimer(){this.clearCheckpointIdleTimer();const e=this.checkpointInfo.currentCheckpointMessage;this.checkpointInfo.idleTimer=setTimeout((()=>{this.checkpointInfo.idleTimer=void 0,e===this.checkpointInfo.currentCheckpointMessage&&this.checkpoint(u.CheckpointReason.IdleTime)}),this.serviceConfiguration.deli.checkpointHeuristics.idleTime)}clearCheckpointIdleTimer(){void 0!==this.checkpointInfo.idleTimer&&(clearTimeout(this.checkpointInfo.idleTimer),this.checkpointInfo.idleTimer=void 0)}updateDurableSequenceNumber(e){this.durableSequenceNumber=e,this.checkNackMessagesState(),this.emit("updatedDurableSequenceNumber",e),this.serviceConfiguration.deli.opEvent.enable&&this.emitOpEvent(g.UpdatedDurableSequenceNumber,!0)}updateNackMessages(e,t){void 0!==t?this.nackMessages.set(e,t):this.nackMessages.delete(e),this.emit("updatedNackMessages",e,t)}addSequencedSignalClient(e,t){const r={client:e.detail,referenceSequenceNumber:t.message.operation.referenceSequenceNumber,clientConnectionNumber:t.message.operation.clientConnectionNumber,exp:Date.now()+this.serviceConfiguration.deli.clientTimeout};this.sequencedSignalClients.set(e.clientId,r)}}},OHrY:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EmptyTaskMessageSender=void 0,t.EmptyTaskMessageSender=class{async initialize(){}sendTask(e,t){}on(e,t){return this}async close(){}}},OMb1:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MongoDocumentRepository=void 0,t.MongoDocumentRepository=class{constructor(e){this.collection=e}async readOne(e){return this.collection.findOne(e)}async updateOne(e,t,r){const n=void 0;await((null==r?void 0:r.upsert)?this.collection.upsert(e,t,n,r):this.collection.update(e,t,n,r))}async findOneOrCreate(e,t){return this.collection.findOrCreate(e,t,arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0)}async findOneAndUpdate(e,t){return this.collection.findAndUpdate(e,t,arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0)}async create(e){return this.collection.insertOne(e)}async exists(e){return this.collection.findOne(e,{projection:{_id:1}}).then((e=>!!e))}}},OQvf:function(e,t,r){"use strict";r.r(t),r.d(t,"FoldersLocalClientBuilder",(function(){return de}));var n=r("n3ZG"),i=r("EX4G"),s=r("KGtu");class o{constructor(e,t,r){this.tenantId=e,this.id=t,this.databaseManager=r}fetchMessages(e,t,r,n){return Object(s.d)(this.getCore(e,t))}async getCore(e,t){const r={documentId:this.id,tenantId:this.tenantId,"operation.sequenceNumber":{}};r["operation.sequenceNumber"].$gt=e-1,r["operation.sequenceNumber"].$lt=null!=t?t:Number.MAX_SAFE_INTEGER;const n=await this.databaseManager.getDeltaCollection(this.tenantId,this.id);return(await n.find(r,{"operation.sequenceNumber":1})).map((e=>e.operation))}}var a=r("j9A4"),c=r("f79D");r("rK/e"),new(r("O9x+").a)((()=>l(m())));const u={getRawConfig:()=>{}},l=e=>null!=e?new p(void 0,{getRawConfig:t=>{var r,n;try{return null===(n=d(null!==(r=e.getItem(t))&&void 0!==r?r:void 0))||void 0===n?void 0:n.raw}catch(e){}}}):u;function h(e){switch(e){case"boolean":case"number":case"string":return!0;default:return!1}}function d(e){let t,r=e;if("string"==typeof e)try{r=JSON.parse(e),t={raw:e,string:e}}catch(e){}if(void 0===r)return t;const n=typeof r;if(h(n))return Object.assign(Object.assign({},t),{raw:e,[n]:r});if(Array.isArray(r)){const n=typeof r[0];if(!h(n))return t;for(const e of r)if(typeof e!==n)return t;return Object.assign(Object.assign({},t),{raw:e,[`${n}[]`]:r})}return t}const m=()=>{var e;try{return null!==(e=globalThis.sessionStorage)&&void 0!==e?e:void 0}catch(e){return}};class p{constructor(e){this.logger=e,this.configCache=new Map,this.orderedBaseProviders=[];const t=new Set;for(var r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];const s=[...n];for(;s.length>0;){const e=s.shift();void 0!==e&&f(e)&&!t.has(e)&&(t.add(e),e instanceof p?s.push(...e.orderedBaseProviders):this.orderedBaseProviders.push(e))}}getBoolean(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.boolean}getNumber(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.number}getString(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.string}getBooleanArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["boolean[]"]}getNumberArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["number[]"]}getStringArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["string[]"]}getRawConfig(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.raw}getCacheEntry(e){var t;if(!this.configCache.has(e)){for(const r of this.orderedBaseProviders){const n=d(null==r?void 0:r.getRawConfig(e));if(void 0!==n)return this.configCache.set(e,n),null===(t=this.logger)||void 0===t||t.send({category:"generic",eventName:"ConfigRead",configName:{tag:v.CodeArtifact,value:e},configValue:{tag:v.CodeArtifact,value:JSON.stringify(n)}}),n}this.configCache.set(e,{raw:void 0})}return this.configCache.get(e)}}function f(e){return"function"==typeof(null==e?void 0:e.getRawConfig)}var g=r("A3AF");let y;var v;Error,function(e){e.CodeArtifact="CodeArtifact",e.UserData="UserData"}(v||(v={}));class b{constructor(e,t){this.namespace=e,this.properties=t}static formatTick(e){return Math.floor(e)}static numberFromString(e){if(null==e)return;const t=Number(e);return Number.isNaN(t)?e:t}static sanitizePkgName(e){return e.replace("@","").replace("/","-")}static prepareErrorObject(e,t,r){const{message:n,errorType:i,stack:s}=function(e,t){const r={message:"string"==typeof(null==e?void 0:e.message)?e.message:String(e)};if((e=>null!==e&&!Array.isArray(e)&&"object"==typeof e)(e)){const{errorType:t,stack:n,name:i}=e;"string"==typeof t&&(r.errorType=t),"string"==typeof n&&(r.stack=((e,t)=>{const r=e.split("\n");return r.shift(),void 0!==t&&r.unshift(t),r.join("\n")})(n,"string"==typeof i?i:void 0))}return r}(t);if(e.stack=s,e.error=n,e.errorType=i,(e=>"function"==typeof(null==e?void 0:e.getTelemetryProperties))(t)){const r=t.getTelemetryProperties();for(const t of Object.keys(r))void 0===e[t]&&(e[t]=r[t])}void 0===e.stack&&r&&(e.stack=function(){return function(){const e=new Error("<<generated stack>>");if(void 0===y&&(y=void 0!==e.stack),y)return e;try{throw e}catch(e){return e}}().stack}())}sendTelemetryEvent(e,t){var r;this.sendTelemetryEventCore(Object.assign(Object.assign({},e),{category:null!==(r=e.category)&&void 0!==r?r:"generic"}),t)}sendTelemetryEventCore(e,t){const r=function(e){var{category:t,eventName:r}=e,n=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]])}return r}(e,["category","eventName"]);const i={category:t,eventName:r};for(const e of Object.keys(n))i[e]=w(n[e]);return i}(e);void 0!==t&&b.prepareErrorObject(r,t,!1),"number"==typeof r.duration&&(r.duration=b.formatTick(r.duration)),this.send(r)}sendErrorEvent(e,t){this.sendTelemetryEventCore(Object.assign(Object.assign({error:e.eventName},e),{category:"error"}),t)}sendPerformanceEvent(e,t){var r;const n=Object.assign(Object.assign({},e),{category:null!==(r=e.category)&&void 0!==r?r:"performance"});this.sendTelemetryEventCore(n,t)}prepareEvent(e){const t="error"===e.category||void 0!==e.error,r=Object.assign({},e);if(void 0!==this.namespace&&(r.eventName=`${this.namespace}${b.eventNamespaceSeparator}${r.eventName}`),this.properties){const n=[];n.push(this.properties.all),t&&n.push(this.properties.error);for(const t of n)if(void 0!==t)for(const n of Object.keys(t)){if(void 0!==e[n])continue;const i=t[n],s="function"==typeof i?i():i;void 0!==s&&(r[n]=s)}}return r}}b.eventNamespaceSeparator=":";class S{send(e){}sendTelemetryEvent(e,t){}sendErrorEvent(e,t){}sendPerformanceEvent(e,t){}}function w(e){return function(e){var t;return"string"==typeof(null===(t=e)||void 0===t?void 0:t.tag)}(e)?{value:C(e.value),tag:e.tag}:C(e)}function C(e){switch(typeof e){case"string":case"number":case"boolean":case"undefined":return e;case"object":return JSON.stringify(e);default:return console.error(`convertToBasePropertyTypeUntagged: INVALID PROPERTY (typed as ${typeof e})`),`INVALID PROPERTY (typed as ${typeof e})`}}const E=["^0.3.0","^0.2.0","^0.1.0"];class I extends a.a{static async create(e,t,r,n,i){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:6e4;const o=i.createConnection(),a=new I(o,t),c={client:n,id:t,mode:n.mode,tenantId:e,token:r,versions:E};return await a.initialize(c,s),a}constructor(e,t){super(e,t,new S)}submit(e){Promise.resolve().then((()=>{this.emitMessages("submitOp",[e])}))}submitSignal(e){this.emitMessages("submitSignal",[[e]])}disconnectClient(e){this.socket.emit("disconnect",e)}nackClient(){this.socket.emit("nack","",[{operation:void 0,sequenceNumber:-1,content:{code:arguments.length>0&&void 0!==arguments[0]?arguments[0]:400,type:arguments.length>1&&void 0!==arguments[1]?arguments[1]:c.b.ThrottlingError,message:arguments.length>2?arguments[2]:void 0}}])}}var T=r("sx7D"),N=r("XumM"),P=r("Xou4"),x=r("Ls0c"),O=r("xDkc"),M=r("qQRf"),k=r("DLbW"),L=r("N482");async function R(e,t,r){var n,i,s;const o=new URL(t.url).pathname.split("/"),a=o[o.length-2],c=o[o.length-1],u=e.documentStorage;if(!Object(k.d)(r))throw new Error("Protocol and App Summary required in the full summary");const l=r.tree[".protocol"],h=r.tree[".app"],d=Object(k.b)(l),m=Object(k.c)(l),p=d.sequenceNumber;await u.createDocument(a,c,h,p,1,L.a,null!==(n=t.endpoints.ordererUrl)&&void 0!==n?n:"",null!==(i=t.endpoints.storageUrl)&&void 0!==i?i:"",null!==(s=t.endpoints.deltaStorageUrl)&&void 0!==s?s:"",m,!1)}class D{constructor(e,t,r,n,i){this.id=e,this.manager=t,this.policies=r,this.localDeltaConnectionServer=n,this.resolvedUrl=i,this.blobsShaCache=new Map,this.summaryTreeUploadManager=new O.a(t,this.blobsShaCache,this.getPreviousFullSnapshot.bind(this))}get repositoryUrl(){return""}async getVersions(e,t){const r=e||this.id;return(await this.manager.getCommits(r,t)).map((e=>({date:e.commit.author.date,id:e.sha,treeId:e.commit.tree.sha})))}async getSnapshotTree(e){let t=e;if(!t){const e=await this.getVersions(this.id,1);if(0===e.length)return null;t=e[0]}const r=await this.manager.getTree(t.treeId);return Object(x.e)(r,this.blobsShaCache,!0)}async readBlob(e){const t=await this.manager.getBlob(e);return this.blobsShaCache.set(t.sha,""),Object(P.e)(t.content,t.encoding)}async uploadSummaryWithContext(e,t){var r;if(0===t.referenceSequenceNumber){if(void 0===this.localDeltaConnectionServer||void 0===this.resolvedUrl)throw new Error("Insufficient constructor parameters. An ILocalDeltaConnectionServer and IResolvedUrl required");return Object(M.a)(this.resolvedUrl),await R(this.localDeltaConnectionServer,this.resolvedUrl,e),(await this.getVersions(this.id,1))[0].id}return this.summaryTreeUploadManager.writeSummaryTree(e,null!==(r=t.ackHandle)&&void 0!==r?r:"","channel")}async createBlob(e){const t=new Uint8Array(e);return this.manager.createBlob(Object(P.b)(t,"base64"),"base64").then((e=>({id:e.sha,url:e.url,minTTLInSeconds:86400})))}async downloadSummary(e){throw new Error("NOT IMPLEMENTED!")}async getPreviousFullSnapshot(e){return e?this.getVersions(e,1).then((async e=>(this.blobsShaCache.clear(),this.getSnapshotTree(e[0])))):void 0}}class F{constructor(e,t,r,n,i,s){let o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{},a=arguments.length>7?arguments[7]:void 0;this.resolvedUrl=e,this.localDeltaConnectionServer=t,this.tokenProvider=r,this.tenantId=n,this.documentId=i,this.documentDeltaConnectionsMap=s,this.policies=o,this.innerDocumentService=a}dispose(){}async connectToStorage(){return new D(this.documentId,new T.a(new N.TestHistorian(this.localDeltaConnectionServer.testDbFactory.testDatabase)),{minBlobSize:2048,maximumCacheDurationMs:432e6},this.localDeltaConnectionServer,this.resolvedUrl)}async connectToDeltaStorage(){return this.innerDocumentService?this.innerDocumentService.connectToDeltaStorage():new o(this.tenantId,this.documentId,this.localDeltaConnectionServer.databaseManager)}async connectToDeltaStream(e){if(!0===this.policies.storageOnly)throw new Error("can't connect to delta stream in storage-only mode");if(this.innerDocumentService)return this.innerDocumentService.connectToDeltaStream(e);const t=await this.tokenProvider.fetchOrdererToken(this.tenantId,this.documentId),r=await I.create(this.tenantId,this.documentId,t.jwt,e,this.localDeltaConnectionServer.webSocketServer),n=r.clientId;return this.documentDeltaConnectionsMap.set(n,r),r.on("disconnect",(()=>{this.documentDeltaConnectionsMap.delete(n)})),r}}var A=r("so/P");class j{constructor(e){this.jwt=e}async fetchOrdererToken(){return{fromCache:!0,jwt:this.jwt}}async fetchStorageToken(){return{fromCache:!0,jwt:this.jwt}}}class q{constructor(e,t,r){this.localDeltaConnectionServer=e,this.policies=t,this.innerDocumentService=r,this.documentDeltaConnectionsMap=new Map}async createContainer(e,t,r,n){if(!this.localDeltaConnectionServer)throw new Error("Provide the localDeltaConnectionServer!!");return void 0!==e&&(Object(M.a)(t),await R(this.localDeltaConnectionServer,t,e)),this.createDocumentService(t,r,n)}async createDocumentService(e,t,r){Object(M.a)(e);const n=Object(A.parse)(e.url),[,i,s]=n.path?n.path.split("/"):[];if(!s||!i)throw new Error(`Couldn't parse resolved url. [documentId:${s}][tenantId:${i}]`);const o=e.tokens.jwt;if(!o)throw new Error("Token was not provided.");const a=new j(o);return function(e,t,r,n,i,s,o,a){return new F(e,t,r,n,i,s,o,a)}(e,this.localDeltaConnectionServer,a,i,s,this.documentDeltaConnectionsMap,this.policies,this.innerDocumentService)}disconnectClient(e,t){const r=this.documentDeltaConnectionsMap.get(e);if(void 0===r)throw new Error(`No client with the id: ${e}`);r.disconnectClient(t)}nackClient(e,t,r,n){const i=this.documentDeltaConnectionsMap.get(e);if(void 0===i)throw new Error(`No client with the id: ${e}`);i.nackClient(t,r,n)}}var B,_=r("he5V");!function(e){e.summarizingClient="fluid-client-summarizer",e.createNew="createNew"}(B||(B={}));var H=r("XPga"),V=r("jSVn"),$=r("AE9X");function U(e,t,r,n,i){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:3600,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"1.0",a=i||K();""!==a.id&&void 0!==a.id||(a=K());const c=Math.round((new Date).getTime()/1e3),u={documentId:t,scopes:n,tenantId:e,user:a,iat:c,exp:c+s,ver:o},l={utf8:r};return V.KJUR.jws.JWS.sign(null,JSON.stringify({alg:"HS256",typ:"JWT"}),u,l)}function K(){return{id:Object(g.a)(),name:Object($.b)(" ",!0)}}class W{constructor(){this.tenantId="tenantId",this.tokenKey="tokenKey"}async resolve(e){const t=new URL(e.url),r=`${t.pathname.substr(1)}${t.search}`,n=r.split("/")[0];return{endpoints:{deltaStorageUrl:`http://localhost:3000/deltas/${this.tenantId}/${n}`,ordererUrl:"http://localhost:3000",storageUrl:`http://localhost:3000/repos/${this.tenantId}`},id:n,tokens:{jwt:U(this.tenantId,n,this.tokenKey,[H.a.DocRead,H.a.DocWrite,H.a.SummaryWrite])},type:"fluid",url:`fluid-test://localhost:3000/${this.tenantId}/${r}`}}async getAbsoluteUrl(e,t){let r=t;r.startsWith("/")&&(r=r.substr(1));const n=e,i=Object(A.parse)(n.url);if(null===i.pathname)throw new Error("Url should contain tenant and docId!!");const[,,s]=i.pathname.split("/");return Object(_.a)(!!s,154),`http://localhost:3000/${s}/${r}`}createCreateNewRequest(e){return function(e){return{url:`http://localhost:3000/${e}`,headers:{[B.createNew]:!0}}}(e)}}var J=r("hBZP"),G=r("JVlB"),z=r("139/"),Q=r("I0o8"),X=r("MPeK"),Z=r("tp/L"),Y=r("+svW"),ee=r("QhLl");class te{constructor(e,t,r,n,i,s,o,a,c,u,l){this.storage=e,this.databaseManager=t,this.tenantManager=r,this.taskMessageSender=n,this.permission=i,this.tokenGenerator=s,this.createHistorian=o,this.logger=a,this.serviceConfiguration=c,this.pubsub=u,this.documentRepository=l,this.ordererMap=new Map}async close(){await Promise.all(Array.from(this.ordererMap.values()).map((async e=>(await e).close()))),this.ordererMap.clear()}async hasPendingWork(){return Promise.all(this.ordererMap.values()).then((e=>{for(const t of e)if(t.hasPendingWork())return!0;return!1}))}async getOrderer(e,t){const r=`${e}/${t}`;let n=this.ordererMap.get(r);return void 0===n&&(n=this.createLocalOrderer(e,t),this.ordererMap.set(r,n)),n}async createLocalOrderer(e,t){var r;const n=await this.createHistorian(e),i=new ee.a(n),s=null!==(r=this.documentRepository)&&void 0!==r?r:new X.MongoDocumentRepository(await this.databaseManager.getDocumentCollection()),o=await z.LocalOrderer.load(this.storage,this.databaseManager,e,t,this.taskMessageSender,this.tenantManager,this.permission,this.tokenGenerator,this.logger,s,i,void 0,this.pubsub,void 0,void 0,void 0,void 0,void 0,void 0,this.serviceConfiguration),a=[o.broadcasterLambda,o.deliLambda,o.foremanLambda,o.scribeLambda,o.scriptoriumLambda];return await Promise.all(a.map((async e=>{if(void 0===e)throw new Error("We expect lambdas to be defined by now.");if("created"===e.state)return new Promise((t=>e.once("started",(()=>t()))))}))),o}}class re{constructor(e,t){this.id=e,this.server=t,this.events=new J.EventEmitter,this.rooms=new Set,this._connected=!0,this.subscriber=new z.WebSocketSubscriber(this)}get connected(){return this._connected}on(e,t){this.events.on(e,t)}async join(e){this.server.pubsub.subscribe(e,this.subscriber),this.rooms.add(e)}send(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];this.events.emit(e,...r)}emit(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];JSON.stringify(r).length>1e6?this.disconnect():this.events.emit(e,...r)}emitToRoom(e,t){for(var r=arguments.length,n=new Array(r>2?r-2:0),i=2;i<r;i++)n[i-2]=arguments[i];this.server.pubsub.publish(e,t,...n)}removeListener(e,t){this.events.removeListener(e,t)}off(e,t){return this.removeListener(e,t),this}disconnect(e){for(const e of this.rooms)this.server.pubsub.unsubscribe(e,this.subscriber);this._connected=!1,this.emit("disconnect")}}class ne{constructor(e){this.pubsub=e,this.events=new J.EventEmitter}on(e,t){this.events.on(e,t)}async close(){this.events.removeAllListeners()}createConnection(){const e=new re(Object(g.a)(),this);return this.events.emit("connection",e,{url:"TestWebSocket"}),e}}class ie{constructor(e,t,r,n,i,s){this.webSocketServer=e,this.databaseManager=t,this.ordererManager=r,this.testDbFactory=n,this.documentStorage=i,this.logger=s}static create(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Y.TestDbFactory({}),t=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0;Z.Lumberjack.isSetupCompleted()||Z.Lumberjack.setup([new Z.TestEngine1]);const n=new z.PubSub,i=new ne(n),s=new X.MongoManager(e),o=new Y.TestTenantManager(void 0,void 0,e.testDatabase),a=new X.MongoDatabaseManager(!1,s,s,"nodes","documents","deltas","scribeDeltas"),c=new Y.TestDocumentStorage(a,o),u=Y.DebugLogger.create("fluid-server:LocalDeltaConnectionServer"),l=new te(c,a,o,new X.EmptyTaskMessageSender,{},Q.a,(async()=>new Y.TestHistorian(e.testDatabase)),u,t,n,r);return Object(G.configureWebSocketServices)(i,l,o,c,new Y.TestClientManager,new X.DefaultMetricClient,u),new ie(i,a,l,e,c,u)}async close(){await this.webSocketServer.close(),await this.ordererManager.close()}async hasPendingWork(){return this.ordererManager.hasPendingWork()}connectWebSocket(e,t,r,n,i){const s=this.webSocketServer.createConnection(),o={client:n,id:t,mode:n.mode,tenantId:e,token:r,versions:i},a=new Promise(((e,t)=>{const r=[],n=[],i=(e,t)=>{this.logger.info(`Queued early ops: ${t.length}`),Z.Lumberjack.info(`Queued early ops: ${t.length}`),r.push(...t)};s.on("op",i);const a=e=>{this.logger.info("Queued early signals"),Z.Lumberjack.info("Queued early signals"),n.push(e)};s.on("signal",a),s.on("connect_error",(e=>{t(e)})),s.on("connect_document_success",(t=>{s.removeListener("op",i),s.removeListener("signal",a),r.length>0&&(t.initialMessages.push(...r),t.initialMessages.sort(((e,t)=>e.sequenceNumber-t.sequenceNumber))),n.length>0&&t.initialSignals.push(...n),e(t)})),s.on("connect_document_error",t),s.emit("connect_document",o)}));return[s,a]}}var se=r("UPAM");async function oe(e,t,r,n,i){!function(){const e={detail:void 0,duration:0,entryType:".",name:"",startTime:0,toJSON:()=>""};void 0===performance.mark&&(performance.mark=()=>e,performance.clearMarks=()=>{}),void 0===performance.measure&&(performance.measure=()=>e,performance.clearMeasures=()=>{})}();const s={load:async()=>({module:{fluidExport:r},details:{package:"no-dynamic-package",config:{}}})},o=new se.a({urlResolver:new W,documentServiceFactory:e,codeLoader:s});let a;return i&&i.add(o),n?(a=await o.createDetachedContainer({package:"no-dynamic-package",config:{}}),await a.attach({url:t})):a=await o.resolve({url:t}),a}const ae=e=>`https://localhost/${e}`,ce="volatileSession";class ue{async load(e,t,r,n="dataStore",s,o,a,c){const u=new q(c||ie.create()),l=await oe(u,ae(e),t,r,a),h=await Object(i.a)(n,l);return r&&o&&await o(h),s(),h}async loadWithContext(e,t,r,n="dataStore",s,o,a,c){const u=new q(c||ie.create()),l=await oe(u,ae(e),t,r,a),h=await Object(i.a)(n,l);return r&&o&&await o(h),s(),[h,l]}async loadVolatileSession(e,t,r,n,i,s,o){return this.load(e,t,r,ce,n,i,s,o)}async loadVolatileSessionWithContext(e,t,r,n,i,s,o){return this.loadWithContext(e,t,r,ce,n,i,s,o)}}var le=r("pRW0"),he=r("/6iw");class de{constructor(e){this.config=e,this.mfsClient=new ue}async build(){var e;const t=await this.mfsClient.load(null!==(e=this.config.podId)&&void 0!==e?e:this.config.appId,n.h,void 0===this.config.podId,void 0,Object(he.b)((()=>{})));t.setHost(new n.i(this.config.appId));const r=await le.a.initialize(t,(()=>Promise.resolve()),(()=>Promise.resolve()));return Object(he.b)(this.config.completedCallback)(),r}}},OagO:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createRoomLeaveMessage=t.createRoomJoinMessage=t.createNackMessage=void 0;const n=r("y2M+");t.createNackMessage=(e,t,r,n)=>({operation:void 0,sequenceNumber:-1,content:{code:e,type:t,message:r,retryAfter:n}}),t.createRoomJoinMessage=function(e,t){return{clientId:null,content:JSON.stringify({type:n.MessageType.ClientJoin,content:{clientId:e,client:t}})}},t.createRoomLeaveMessage=e=>({clientId:null,content:JSON.stringify({type:n.MessageType.ClientLeave,content:e})})},"Of2+":function(e,t,r){"use strict";(function(e){var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return i(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.configureWebSocketServices=void 0;const a=r("y2M+"),c=r("YkJt"),u=o(r("a0Z+")),l=s(r("wytm")),h=s(r("yQiv")),d=r("fhs9"),m=r("KMXR"),p="summarizer";function f(e){return`${e.tenantId}/${e.documentId}`}const g=(e,t)=>({documentId:e,tenantId:t}),y=async(e,t,r,n)=>{throw e.error(t,{messageMetaData:g(r,n)}),d.Lumberjack.error(t,(0,d.getLumberBaseProperties)(r,n)),new c.NetworkError(500,"Failed to connect client to document.")},v=e=>`${e}_OpenSocketConn`,b=(e,t)=>`${e}_${t}_SubmitOp`,S=(e,t)=>`${e}_${t}_SubmitSignal`;function w(e){return{clientSequenceNumber:e.clientSequenceNumber,contents:e.contents,metadata:e.metadata,referenceSequenceNumber:e.referenceSequenceNumber,traces:e.traces,type:e.type,compression:e.compression}}const C=["^0.4.0","^0.3.0","^0.2.0","^0.1.0"];function E(e){for(const t of e)for(const e of C)if(l.intersects(e,t))return e}function I(e){if(!e)return{};const t={},r=e.split(";").map((e=>e.split(":")));for(const[e,n]of r)t[e]=n;return t}async function T(e,t,r,n,i){try{const s=Date.now(),o=h.clientConnectivityStorageId,a={value:(s-n)/6e4,tenantId:r,documentId:t,clientId:e,startTime:n,endTime:s};await i.setUsageData(o,a)}catch(n){d.Lumberjack.error("ClientConnectivity data storage failed",{[d.CommonProperties.clientId]:e,[d.BaseTelemetryProperties.tenantId]:r,[d.BaseTelemetryProperties.documentId]:t},n)}}function N(e,t,r,n,i,s){let o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1;if(e)try{e.incrementCount(t,o,i,s)}catch(e){if(e instanceof h.ThrottlingError)return e;null==n||n.error(`Throttle increment failed: ${(0,u.default)(e,void 0,2)}`,{messageMetaData:{key:t,eventName:"throttling"}}),d.Lumberjack.error("Throttle increment failed",{[d.CommonProperties.telemetryGroupName]:"throttling",[d.BaseTelemetryProperties.tenantId]:r},e)}}function P(e,t,r,n,i){return e&&h.DefaultServiceConfiguration.enableTraces&&x(t)&&(void 0===e.traces&&(e.traces=[]),e.traces.push({action:"start",service:"alfred",timestamp:Date.now()}),d.Lumberjack.info("Message received by Alfred.",{[d.BaseTelemetryProperties.tenantId]:n,[d.BaseTelemetryProperties.documentId]:i,clientId:r,clientSequenceNumber:e.clientSequenceNumber,traces:e.traces,opType:e.type})),e}function x(e){return 0===(0,c.getRandomInt)(e)}t.configureWebSocketServices=function(t,r,n,i,s,o,l){let O=arguments.length>7&&void 0!==arguments[7]?arguments[7]:1e6,M=arguments.length>8&&void 0!==arguments[8]?arguments[8]:100,k=arguments.length>9&&void 0!==arguments[9]?arguments[9]:3600,L=arguments.length>10&&void 0!==arguments[10]&&arguments[10],R=arguments.length>11&&void 0!==arguments[11]&&arguments[11],D=arguments.length>12&&void 0!==arguments[12]&&arguments[12],F=arguments.length>13?arguments[13]:void 0,A=arguments.length>14?arguments[14]:void 0,j=arguments.length>15?arguments[15]:void 0,q=arguments.length>16?arguments[16]:void 0,B=arguments.length>17?arguments[17]:void 0,_=arguments.length>18?arguments[18]:void 0,H=arguments.length>19?arguments[19]:void 0,V=arguments.length>20?arguments[20]:void 0;t.on("connection",(t=>{const i=new Map,o=new Map,$=new Map,U=new Map;let K;const W=new m.ConnectionCountLogger(e.env.NODE_NAME,F),J=e=>(0,c.canWrite)(e)||(0,c.canSummarize)(e);function G(){void 0!==K&&(clearTimeout(K),K=void 0)}t.on("connect_document",(async e=>{const b=I(e.relayUserAgent).driverVersion,S=d.Lumberjack.newLumberMetric(d.LumberEventName.ConnectDocument);S.setProperties(Object.assign(Object.assign({},(0,d.getLumberBaseProperties)(e.id,e.tenantId)),{[d.CommonProperties.clientDriverVersion]:b})),async function(e){var b;const S=Date.now(),w=N(j,v("connectDoc"),e.tenantId,l);if(w)return Promise.reject(w);const I=N(A,v(e.tenantId),e.tenantId,l);if(I)return Promise.reject(I);if(!e.token)throw new c.NetworkError(403,"Must provide an authorization token");const T=e.token,P=(0,c.validateTokenClaims)(T,e.id,e.tenantId);try{await n.verifyToken(P.tenantId,T)}catch(e){if((0,c.isNetworkError)(e))throw e;const t=`Could not verify connect document token. Error: ${(0,u.default)(e,void 0,2)}`;return y(l,t,P.documentId,P.tenantId)}const R=(0,m.generateClientId)(),D={tenantId:P.tenantId,documentId:P.documentId};try{await Promise.all([t.join(f(D)),t.join(`client#${R}`)])}catch(e){const t=`Could not subscribe to channels. Error: ${(0,u.default)(e,void 0,2)}`;return y(l,t,P.documentId,P.tenantId)}const F=Date.now(),q=e.client?e.client:{},B=(null===(b=q.details)||void 0===b?void 0:b.type)===p;q.user=P.user,q.scopes=P.scopes,B||(q.scopes=P.scopes.filter((e=>e!==a.ScopeType.SummaryWrite)),U.set(R,F)),q.timestamp=F,$.set(R,q.scopes),o.set(R,D),B||W.incrementConnectionCount();const _=e.versions?e.versions:["^0.1.0"],H=E(_);if(!H)throw new c.NetworkError(400,`Unsupported client protocol. Server: ${C}. Client: ${JSON.stringify(_)}`);const z=(0,d.getLumberBaseProperties)(P.documentId,P.tenantId),Q=d.Lumberjack.newLumberMetric(d.LumberEventName.ConnectDocumentGetClients,z),X=await s.getClients(P.tenantId,P.documentId).then((e=>(Q.success("Successfully got clients from client manager"),e))).catch((async e=>{const t=`Failed to get clients. Error: ${(0,u.default)(e,void 0,2)}`;return Q.error("Failed to get clients during connectDocument",e),y(l,t,P.documentId,P.tenantId)}));if(X.length>O)throw new c.NetworkError(429,"Too Many Clients Connected to Document",!0,!1,3e5);const Z=d.Lumberjack.newLumberMetric(d.LumberEventName.ConnectDocumentAddClient,z);try{await s.addClient(P.tenantId,P.documentId,R,q),Z.success("Successfully added client")}catch(e){const t=`Could not add client. Error: ${(0,u.default)(e,void 0,2)}`;return Z.error("Error adding client during connectDocument",e),y(l,t,P.documentId,P.tenantId)}let Y;if(L&&function(e){G(),K=setTimeout((()=>{t.disconnect(!0)}),e)}((0,c.validateTokenClaimsExpiration)(P,k)),function(e,t){return!!J(e)&&"write"===t}(q.scopes,e.mode)){const e=d.Lumberjack.newLumberMetric(d.LumberEventName.ConnectDocumentOrdererConnection,z),n=await r.getOrderer(P.tenantId,P.documentId).catch((async t=>{const r=`Failed to get orderer manager. Error: ${(0,u.default)(t,void 0,2)}`;return e.error("Failed to get orderer manager",t),y(l,r,P.documentId,P.tenantId)})),s=await n.connect(t,R,q).catch((async t=>{const r=`Failed to connect to orderer. Error: ${(0,u.default)(t,void 0,2)}`;return e.error("Failed to connect to orderer",t),y(l,r,P.documentId,P.tenantId)}));let o;s.once("error",(e=>{const r=g(s.documentId,s.tenantId);l.error(`Disconnecting socket on connection error: ${(0,u.default)(e,void 0,2)}`,{messageMetaData:r}),d.Lumberjack.error("Disconnecting socket on connection error",(0,d.getLumberBaseProperties)(s.documentId,s.tenantId),e),G(),t.disconnect(!0)})),h.DefaultServiceConfiguration.enableTraces&&x(M)&&(o={connectDocumentStartTime:S}),s.connect(o).catch((async t=>{const r=`Failed to connect to the orderer connection. Error: ${(0,u.default)(t,void 0,2)}`;return e.error("Failed to establish orderer connection",t),y(l,r,P.documentId,P.tenantId)})),i.set(R,s),i.size>1&&d.Lumberjack.info(`Same socket is having multiple connections, connection number=${i.size}`,(0,d.getLumberBaseProperties)(s.documentId,s.tenantId)),e.success("Successfully established orderer connection"),Y={claims:P,clientId:R,existing:!0,maxMessageSize:s.maxMessageSize,mode:"write",serviceConfiguration:{blockSize:s.serviceConfiguration.blockSize,maxMessageSize:s.serviceConfiguration.maxMessageSize},initialClients:X,initialMessages:[],initialSignals:[],supportedVersions:C,version:H}}else Y={claims:P,clientId:R,existing:!0,maxMessageSize:1024,mode:"read",serviceConfiguration:{blockSize:h.DefaultServiceConfiguration.blockSize,maxMessageSize:h.DefaultServiceConfiguration.maxMessageSize},initialClients:X,initialMessages:[],initialSignals:[],supportedVersions:C,version:H};return Y.timestamp=F,V&&P.jti&&V.addSocketForToken(h.createCompositeTokenId(e.tenantId,e.id,P.jti),t),{connection:Y,connectVersions:_,details:q}}(e).then((e=>{var r;t.emit("connect_document_success",e.connection);const n=o.get(e.connection.clientId);n&&t.emitToRoom(f(n),"signal",(0,m.createRoomJoinMessage)(e.connection.clientId,e.details)),S.setProperties({[d.CommonProperties.clientId]:e.connection.clientId,[d.CommonProperties.clientCount]:e.connection.initialClients.length+1,[d.CommonProperties.clientType]:null===(r=e.details.details)||void 0===r?void 0:r.type}),S.success("Connect document successful")}),(e=>{t.emit("connect_document_error",e),void 0!==(null==e?void 0:e.code)&&S.setProperty(d.CommonProperties.errorCode,e.code),S.error("Connect document failed",e)}))})),t.on("submitOp",((e,r)=>{const n=i.get(e);if(n){let i=0;for(const e of r)i+=Array.isArray(e)?e.length:1;const s=N(q,b(e,n.tenantId),n.tenantId,l,void 0,void 0,i);if(s){const e=(0,m.createNackMessage)(s.code,a.NackErrorType.ThrottlingError,s.message,s.retryAfter);return void t.emit("nack","",[e])}const o=Object.assign({[d.CommonProperties.clientId]:e},(0,d.getLumberBaseProperties)(n.documentId,n.tenantId)),u=e=>{if((0,c.isNetworkError)(e)&&413===e.code)return d.Lumberjack.info("Rejected too large operation(s)",o),void t.emit("nack","",[(0,m.createNackMessage)(e.code,a.NackErrorType.BadRequestError,e.message)]);d.Lumberjack.error("Error processing submitted op(s)",o,e)};r.forEach((e=>{const t=Array.isArray(e)?e:[e];try{const e=t.map((e=>{if(!0===H&&JSON.stringify(e.contents).length>n.serviceConfiguration.maxMessageSize)throw new c.NetworkError(413,"Op size too large");return P(w(e),M,n.clientId,n.tenantId,n.documentId)}));e.length>0&&n.order(e).catch(u)}catch(e){u(e)}}))}else{let r;const n=$.get(e);r=n&&J(n)?(0,m.createNackMessage)(400,a.NackErrorType.BadRequestError,"Readonly client"):o.has(e)?(0,m.createNackMessage)(403,a.NackErrorType.InvalidScopeError,"Invalid scope"):(0,m.createNackMessage)(400,a.NackErrorType.BadRequestError,"Nonexistent client"),t.emit("nack","",[r])}})),t.on("submitSignal",((e,r)=>{const n=o.get(e);if(n){let i=0;for(const e of r)i+=Array.isArray(e)?e.length:1;const s={value:0,tenantId:n.tenantId,documentId:n.documentId,clientId:e},o=N(B,S(e,n.tenantId),n.tenantId,l,D?h.signalUsageStorageId:void 0,D?s:void 0,i);if(o){const e=(0,m.createNackMessage)(o.code,a.NackErrorType.ThrottlingError,o.message,o.retryAfter);return void t.emit("nack","",[e])}r.forEach((r=>{const i=Array.isArray(r)?r:[r];for(const r of i){const i={clientId:e,content:r};t.emitToRoom(f(n),"signal",i)}}))}else{const e=(0,m.createNackMessage)(400,a.NackErrorType.BadRequestError,"Nonexistent client");t.emit("nack","",[e])}})),t.on("disconnect",(async()=>{G();const e=[];for(const[t,r]of i){const n=g(r.documentId,r.tenantId);if(l.info(`Disconnect of ${t}`,{messageMetaData:n}),d.Lumberjack.info(`Disconnect of ${t}`,(0,d.getLumberBaseProperties)(r.documentId,r.tenantId)),r.disconnect(),R&&_){const n=U.get(t);n&&e.push(T(t,r.documentId,r.tenantId,n,_))}}for(const[r,n]of o){const i=g(n.documentId,n.tenantId);U.has(r)&&W.decrementConnectionCount(),l.info(`Disconnect of ${r} from room`,{messageMetaData:i}),d.Lumberjack.info(`Disconnect of ${r} from room`,(0,d.getLumberBaseProperties)(n.documentId,n.tenantId)),e.push(s.removeClient(n.tenantId,n.documentId,r)),t.emitToRoom(f(n),"signal",(0,m.createRoomLeaveMessage)(r))}V&&V.removeSocket(t.id),await Promise.all(e)}))}))}}).call(this,r("5IsQ"))},PmJK:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CombinedContext=void 0,t.CombinedContext=class{constructor(e){this.context=e,this.checkpoints=[]}createContext(){const e=this.checkpoints.push(void 0)-1;return{log:this.context.log,checkpoint:t=>this.checkpoint(e,t),error:(t,r)=>this.error(e,t,r)}}checkpoint(e,t){this.checkpoints[e]=t;const r=this.getLowestMessage();void 0!==r&&(void 0===this.currentCheckpoint||this.currentCheckpoint.offset<r.offset)&&(this.currentCheckpoint=r,this.context.checkpoint(r))}error(e,t,r){this.context.error(t,r)}getLowestMessage(){let e;for(const t of this.checkpoints){if(void 0===t)return;(void 0===e||e.offset>t.offset)&&(e=t)}return e}}},Pp5o:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestThrottlerHelper=void 0,t.TestThrottlerHelper=class{constructor(e){this.opsPerMs=e,this.throttleStorage={}}async updateCount(e,t){const r=Date.now(),n=this.throttleStorage[e]||{count:this.opsPerMs,lastCoolDownAt:r,throttleStatus:!1,throttleReason:void 0,retryAfterInMs:0};if(n.count+=Math.floor((r-n.lastCoolDownAt)*this.opsPerMs),n.lastCoolDownAt=r,n.count-=t,n.count<0){const e=Math.abs(n.count);n.throttleStatus=!0,n.retryAfterInMs=e/this.opsPerMs,n.throttleReason=`Count exceeded by ${e} at ${r}`}else n.throttleStatus=!1,n.retryAfterInMs=0,n.throttleReason=void 0;return this.throttleStorage[e]=n,this.getThrottlerResponseFromThrottlingMetrics(n)}async getThrottleStatus(e){const t=this.throttleStorage[e];if(t)return this.getThrottlerResponseFromThrottlingMetrics(t)}getThrottlerResponseFromThrottlingMetrics(e){return{throttleStatus:e.throttleStatus,throttleReason:e.throttleReason,retryAfterInMs:e.retryAfterInMs}}}},"Q+H3":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.debug=void 0;const n=r("Gstq"),i=r("pckk");t.debug=(0,n.debug)("fluid:core"),(0,t.debug)(`Package: ${i.pkgName} - Version: ${i.pkgVersion}`)},"Q/BS":function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Lumber=void 0;const i=n(r("a0Z+")),s=r("Twpl"),o=r("wWog"),a=r("dAzj"),c=r("5gZq");t.Lumber=class{constructor(e,t,r,n,i){this.eventName=e,this.type=t,this._engineList=r,this._schemaValidators=n,this._startTime=o.performance.now(),this._properties=new Map,this._completed=!1,this.timestamp=Date.now(),this.id=(0,s.v4)(),i&&this.setProperties(i)}get properties(){return this._properties}get durationInMs(){if(this.type!==c.LumberType.Log)return this._durationInMs}get successful(){if(this.type!==c.LumberType.Log)return this._successful}get message(){return this._message}get exception(){return this._exception}get logLevel(){return this._logLevel}setProperty(e,t){return this._properties.set(e,t),this}setProperties(e){return e instanceof Map?0===this._properties.size?this._properties=e:e.forEach(((e,t)=>{this.setProperty(t,e)})):Object.entries(e).forEach((e=>{const[t,r]=e;this.setProperty(t,r)})),this}success(e){this.emit(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:c.LogLevel.Info,!0,void 0)}error(e,t){this.emit(e,arguments.length>2&&void 0!==arguments[2]?arguments[2]:c.LogLevel.Error,!1,t)}isCompleted(){return this._completed}emit(e,t,r,n){if(this._completed)return void(0,c.handleError)(a.LumberEventName.LumberjackError,`Trying to complete a Lumber telemetry operation that has alredy been completed.                [eventName: ${this.eventName}][id: ${this.id}]`,this._engineList);if(this._schemaValidators)for(const e of this._schemaValidators){const t=e.validate(this.properties);t.validationPassed||(0,c.handleError)(a.LumberEventName.LumberjackSchemaValidationFailure,`Schema validation failed for props: ${t.validationFailedForProperties.toString()}.                        [eventName: ${this.eventName}][id: ${this.id}]`,this._engineList)}this._message=e,this._logLevel=t,this._successful=r,n instanceof Error?this._exception=n:void 0!==n&&(this._exception=new Error((0,i.default)(n)));const s=parseFloat(this.properties.get("durationInMs"));this._durationInMs=isNaN(s)?o.performance.now()-this._startTime:s,this._engineList.forEach((e=>e.emit(this))),this._completed=!0}}},QhLl:function(e,t,r){"use strict";r.d(t,"a",(function(){return a}));var n=r("he5V"),i=r("jLPl"),s=r("l4ds"),o=r("e+Z5");class a{constructor(e){this.historian=e,this.blobCache=new Map,this.commitCache=new Map,this.treeCache=new Map,this.refCache=new Map}async getHeader(e,t){const r=await this.historian.getHeader(t);for(const e of r.blobs)this.blobCache.set(e.sha,e);return Object(i.e)(r.tree)}async getFullTree(e){return this.historian.getFullTree(e)}async getCommit(e){return this.commitCache.has(e)?(Object(o.a)(`Cache hit on ${e}`),this.commitCache.get(e)):this.historian.getCommit(e)}async getCommits(e,t){let r=e;if(this.refCache.has(e)&&(Object(o.a)(`Commit cache hit on ${e}`),r=this.refCache.get(e),this.refCache.delete(e),!r))return[];if(this.commitCache.has(r)){const e=this.commitCache.get(r);return[{commit:{author:e.author,committer:e.committer,message:e.message,tree:e.tree,url:e.url},parents:e.parents,sha:e.sha,url:e.url}]}return this.historian.getCommits(r,t)}async getTree(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this.treeCache.has(e)?(Object(o.a)(`Tree cache hit on ${e}`),this.treeCache.get(e)):this.historian.getTree(e,t)}async getBlob(e){return this.blobCache.has(e)?(Object(o.a)(`Blob cache hit on ${e}`),this.blobCache.get(e)):this.historian.getBlob(e)}getRawUrl(e){return`${this.historian.endpoint}/git/blobs/raw/${e}`}async getContent(e,t){return this.historian.getContent(t,e)}async createBlob(e,t){return this.historian.createBlob({content:e,encoding:t})}async createGitTree(e){return this.historian.createTree(e)}async createTree(e){return this.createTreeCore(e,0)}async createCommit(e){return this.historian.createCommit(e)}async createSummary(e){return this.historian.createSummary(e,arguments.length>1&&void 0!==arguments[1]&&arguments[1])}async deleteSummary(e){return this.historian.deleteSummary(e)}async getSummary(e){return this.historian.getSummary(e)}async getRef(e){return this.historian.getRef(`heads/${e}`).catch((e=>{if(400===e||404===e)return null;throw e}))}async createRef(e,t){return this.historian.createRef({ref:`refs/heads/${e}`,sha:t,config:{enabled:!0}})}async upsertRef(e,t){return this.historian.updateRef(`heads/${e}`,{force:!0,sha:t,config:{enabled:!0}})}addRef(e,t){this.refCache.set(e,t)}addCommit(e){this.commitCache.set(e.sha,e)}addTree(e){this.treeCache.set(e.sha,e)}addBlob(e){this.blobCache.set(e.sha,e)}async write(e,t,r,n){const i=await this.createTree(t),s={author:{date:(new Date).toISOString(),email:"kurtb@microsoft.com",name:"Kurt Berglund"},message:n,parents:r,tree:i.sha},o=await this.historian.createCommit(s),a=await this.getRef(e);return await(a?this.upsertRef(e,o.sha):this.createRef(e,o.sha)),o}async createTreeCore(e,t){if(e.id)return this.getTree(e.id);const r=[];for(const n of e.entries)switch(s.b[n.type]){case s.b.Blob:{const e=n.value;n.mode===s.a.Symlink&&(e.contents=this.translateSymlink(e.contents,t));const i=this.createBlob(e.contents,e.encoding);r.push(i);break}case s.b.Tree:{const e=this.createTreeCore(n.value,t+1);r.push(e);break}default:throw new Error("Unknown entry type")}const i=await Promise.all(r),o=[];Object(n.a)(i.length===e.entries.length,"File entries length is not correct");for(let t=0;t<e.entries.length;t++)o.push({mode:e.entries[t].mode,path:e.entries[t].path,sha:i[t].sha,type:e.entries[t].type===s.b.Tree?"tree":e.entries[t].type===s.b.Blob?"blob":"commit"});return this.historian.createTree({tree:o})}translateSymlink(e,t){let r="";for(let e=0;e<=t;e++)r+="../";return`${r}${e}`}}},QoBq:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CopierLambdaFactory=t.CopierLambda=void 0;var n=r("/UA3");Object.defineProperty(t,"CopierLambda",{enumerable:!0,get:function(){return n.CopierLambda}});var i=r("hnLz");Object.defineProperty(t,"CopierLambdaFactory",{enumerable:!0,get:function(){return i.CopierLambdaFactory}})},QoYi:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Lumberjack=void 0;const n=r("pKcq"),i=r("0nFT"),s=r("FY09");class o{constructor(){this._engineList=[],this._isSetupCompleted=!1}static get instance(){return o._instance||(o._instance=new o),o._instance}static createInstance(e,t){const r=new o;return r.setup(e,t),r}static setup(e,t){this.instance.setup(e,t)}static newLumberMetric(e,t){return this.instance.newLumberMetric(e,t)}static log(e,t,r,n){this.instance.log(e,t,r,n)}static debug(e,t){this.instance.log(e,s.LogLevel.Debug,t)}static verbose(e,t){this.instance.log(e,s.LogLevel.Verbose,t)}static info(e,t){this.instance.log(e,s.LogLevel.Info,t)}static warning(e,t,r){this.instance.log(e,s.LogLevel.Warning,t,r)}static error(e,t,r){this.instance.log(e,s.LogLevel.Error,t,r)}setup(e,t){this._isSetupCompleted?(0,s.handleError)(n.LumberEventName.LumberjackError,"This Lumberjack was already setup with a list of engines and optional schema validator.",this._engineList):0!==e.length?(this._engineList.push(...e),this._schemaValidators=t,this._isSetupCompleted=!0):(0,s.handleError)(n.LumberEventName.LumberjackError,"The provided engine list is empty. Please provide at list one LumberjackEngine.",this._engineList)}newLumberMetric(e,t){return this.errorOnIncompleteSetup(),new i.Lumber(e,s.LumberType.Metric,this._engineList,this._schemaValidators,t)}static isSetupCompleted(){return this.instance._isSetupCompleted}log(e,t,r,n){this.errorOnIncompleteSetup();const a=new i.Lumber(o.LogMessageEventName,s.LumberType.Log,this._engineList,this._schemaValidators,r);t===s.LogLevel.Warning||t===s.LogLevel.Error?a.error(e,n,t):a.success(e,t)}debug(e,t){this.log(e,s.LogLevel.Debug,t)}verbose(e,t){this.log(e,s.LogLevel.Verbose,t)}info(e,t){this.log(e,s.LogLevel.Info,t)}warning(e,t,r){this.log(e,s.LogLevel.Warning,t,r)}error(e,t,r){this.log(e,s.LogLevel.Error,t,r)}errorOnIncompleteSetup(){this._isSetupCompleted||(0,s.handleError)(n.LumberEventName.LumberjackError,"Lumberjack has not been setup yet. It requires an engine list and an optional schema validator.",this._engineList)}}t.Lumberjack=o,o.LogMessageEventName="LogMessage"},REGm:function(e,t,r){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.extractBoxcar=t.LambdaName=t.LambdaCloseType=void 0;const n=r("wWog"),i=r("1M/W");!function(e){e.Stop="Stop",e.ActivityTimeout="ActivityTimeout",e.Rebalance="Rebalance",e.Error="Error"}(t.LambdaCloseType||(t.LambdaCloseType={})),function(e){e.Scribe="Scribe"}(t.LambdaName||(t.LambdaName={})),t.extractBoxcar=function(t){if("string"!=typeof t.value&&!e.isBuffer(t.value))return t.value;const r=t.value.toString(),s=(0,n.safelyParseJSON)(r),o=s;if(!o)return{contents:[],documentId:null,tenantId:null,type:i.BoxcarType};if(o.type===i.BoxcarType){const e=o;return{contents:e.contents.length>0&&"string"==typeof e.contents[0]?e.contents.map((e=>JSON.parse(e))):e.contents,documentId:e.documentId,tenantId:e.tenantId,type:e.type}}return{contents:[o],documentId:s.documentId,tenantId:s.tenantId,type:i.BoxcarType}}}).call(this,r("zkTx").Buffer)},RJnL:function(e,t,r){"use strict";(function(e){var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return i(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.configureWebSocketServices=void 0;const a=r("y2M+"),c=r("Lvy3"),u=o(r("a0Z+")),l=s(r("Nf13")),h=s(r("MPeK")),d=r("tp/L"),m=r("Txkb"),p="summarizer";function f(e){return`${e.tenantId}/${e.documentId}`}const g=(e,t)=>({documentId:e,tenantId:t}),y=async(e,t,r,n)=>{throw e.error(t,{messageMetaData:g(r,n)}),d.Lumberjack.error(t,(0,d.getLumberBaseProperties)(r,n)),new c.NetworkError(500,"Failed to connect client to document.")},v=e=>`${e}_OpenSocketConn`,b=(e,t)=>`${e}_${t}_SubmitOp`,S=(e,t)=>`${e}_${t}_SubmitSignal`;function w(e){return{clientSequenceNumber:e.clientSequenceNumber,contents:e.contents,metadata:e.metadata,referenceSequenceNumber:e.referenceSequenceNumber,traces:e.traces,type:e.type,compression:e.compression}}const C=["^0.4.0","^0.3.0","^0.2.0","^0.1.0"];function E(e){for(const t of e)for(const e of C)if(l.intersects(e,t))return e}function I(e){if(!e)return{};const t={},r=e.split(";").map((e=>e.split(":")));for(const[e,n]of r)t[e]=n;return t}async function T(e,t,r,n,i){try{const s=Date.now(),o=h.clientConnectivityStorageId,a={value:(s-n)/6e4,tenantId:r,documentId:t,clientId:e,startTime:n,endTime:s};await i.setUsageData(o,a)}catch(n){d.Lumberjack.error("ClientConnectivity data storage failed",{[d.CommonProperties.clientId]:e,[d.BaseTelemetryProperties.tenantId]:r,[d.BaseTelemetryProperties.documentId]:t},n)}}function N(e,t,r,n,i,s){let o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1;if(e)try{e.incrementCount(t,o,i,s)}catch(e){if(e instanceof h.ThrottlingError)return e;null==n||n.error(`Throttle increment failed: ${(0,u.default)(e,void 0,2)}`,{messageMetaData:{key:t,eventName:"throttling"}}),d.Lumberjack.error("Throttle increment failed",{[d.CommonProperties.telemetryGroupName]:"throttling",[d.BaseTelemetryProperties.tenantId]:r},e)}}function P(e,t,r,n,i){return e&&h.DefaultServiceConfiguration.enableTraces&&x(t)&&(void 0===e.traces&&(e.traces=[]),e.traces.push({action:"start",service:"alfred",timestamp:Date.now()}),d.Lumberjack.info("Message received by Alfred.",{[d.BaseTelemetryProperties.tenantId]:n,[d.BaseTelemetryProperties.documentId]:i,clientId:r,clientSequenceNumber:e.clientSequenceNumber,traces:e.traces,opType:e.type})),e}function x(e){return 0===(0,c.getRandomInt)(e)}t.configureWebSocketServices=function(t,r,n,i,s,o,l){let O=arguments.length>7&&void 0!==arguments[7]?arguments[7]:1e6,M=arguments.length>8&&void 0!==arguments[8]?arguments[8]:100,k=arguments.length>9&&void 0!==arguments[9]?arguments[9]:3600,L=arguments.length>10&&void 0!==arguments[10]&&arguments[10],R=arguments.length>11&&void 0!==arguments[11]&&arguments[11],D=arguments.length>12&&void 0!==arguments[12]&&arguments[12],F=arguments.length>13?arguments[13]:void 0,A=arguments.length>14?arguments[14]:void 0,j=arguments.length>15?arguments[15]:void 0,q=arguments.length>16?arguments[16]:void 0,B=arguments.length>17?arguments[17]:void 0,_=arguments.length>18?arguments[18]:void 0,H=arguments.length>19?arguments[19]:void 0,V=arguments.length>20?arguments[20]:void 0;t.on("connection",(t=>{const i=new Map,o=new Map,$=new Map,U=new Map;let K;const W=new m.ConnectionCountLogger(e.env.NODE_NAME,F),J=e=>(0,c.canWrite)(e)||(0,c.canSummarize)(e);function G(){void 0!==K&&(clearTimeout(K),K=void 0)}t.on("connect_document",(async e=>{const b=I(e.relayUserAgent).driverVersion,S=d.Lumberjack.newLumberMetric(d.LumberEventName.ConnectDocument);S.setProperties(Object.assign(Object.assign({},(0,d.getLumberBaseProperties)(e.id,e.tenantId)),{[d.CommonProperties.clientDriverVersion]:b})),async function(e){var b;const S=Date.now(),w=N(j,v("connectDoc"),e.tenantId,l);if(w)return Promise.reject(w);const I=N(A,v(e.tenantId),e.tenantId,l);if(I)return Promise.reject(I);if(!e.token)throw new c.NetworkError(403,"Must provide an authorization token");const T=e.token,P=(0,c.validateTokenClaims)(T,e.id,e.tenantId);try{await n.verifyToken(P.tenantId,T)}catch(e){if((0,c.isNetworkError)(e))throw e;const t=`Could not verify connect document token. Error: ${(0,u.default)(e,void 0,2)}`;return y(l,t,P.documentId,P.tenantId)}const R=(0,m.generateClientId)(),D={tenantId:P.tenantId,documentId:P.documentId};try{await Promise.all([t.join(f(D)),t.join(`client#${R}`)])}catch(e){const t=`Could not subscribe to channels. Error: ${(0,u.default)(e,void 0,2)}`;return y(l,t,P.documentId,P.tenantId)}const F=Date.now(),q=e.client?e.client:{},B=(null===(b=q.details)||void 0===b?void 0:b.type)===p;q.user=P.user,q.scopes=P.scopes,B||(q.scopes=P.scopes.filter((e=>e!==a.ScopeType.SummaryWrite)),U.set(R,F)),q.timestamp=F,$.set(R,q.scopes),o.set(R,D),B||W.incrementConnectionCount();const _=e.versions?e.versions:["^0.1.0"],H=E(_);if(!H)throw new c.NetworkError(400,`Unsupported client protocol. Server: ${C}. Client: ${JSON.stringify(_)}`);const z=(0,d.getLumberBaseProperties)(P.documentId,P.tenantId),Q=d.Lumberjack.newLumberMetric(d.LumberEventName.ConnectDocumentGetClients,z),X=await s.getClients(P.tenantId,P.documentId).then((e=>(Q.success("Successfully got clients from client manager"),e))).catch((async e=>{const t=`Failed to get clients. Error: ${(0,u.default)(e,void 0,2)}`;return Q.error("Failed to get clients during connectDocument",e),y(l,t,P.documentId,P.tenantId)}));if(X.length>O)throw new c.NetworkError(429,"Too Many Clients Connected to Document",!0,!1,3e5);const Z=d.Lumberjack.newLumberMetric(d.LumberEventName.ConnectDocumentAddClient,z);try{await s.addClient(P.tenantId,P.documentId,R,q),Z.success("Successfully added client")}catch(e){const t=`Could not add client. Error: ${(0,u.default)(e,void 0,2)}`;return Z.error("Error adding client during connectDocument",e),y(l,t,P.documentId,P.tenantId)}let Y;if(L&&function(e){G(),K=setTimeout((()=>{t.disconnect(!0)}),e)}((0,c.validateTokenClaimsExpiration)(P,k)),function(e,t){return!!J(e)&&"write"===t}(q.scopes,e.mode)){const e=d.Lumberjack.newLumberMetric(d.LumberEventName.ConnectDocumentOrdererConnection,z),n=await r.getOrderer(P.tenantId,P.documentId).catch((async t=>{const r=`Failed to get orderer manager. Error: ${(0,u.default)(t,void 0,2)}`;return e.error("Failed to get orderer manager",t),y(l,r,P.documentId,P.tenantId)})),s=await n.connect(t,R,q).catch((async t=>{const r=`Failed to connect to orderer. Error: ${(0,u.default)(t,void 0,2)}`;return e.error("Failed to connect to orderer",t),y(l,r,P.documentId,P.tenantId)}));let o;s.once("error",(e=>{const r=g(s.documentId,s.tenantId);l.error(`Disconnecting socket on connection error: ${(0,u.default)(e,void 0,2)}`,{messageMetaData:r}),d.Lumberjack.error("Disconnecting socket on connection error",(0,d.getLumberBaseProperties)(s.documentId,s.tenantId),e),G(),t.disconnect(!0)})),h.DefaultServiceConfiguration.enableTraces&&x(M)&&(o={connectDocumentStartTime:S}),s.connect(o).catch((async t=>{const r=`Failed to connect to the orderer connection. Error: ${(0,u.default)(t,void 0,2)}`;return e.error("Failed to establish orderer connection",t),y(l,r,P.documentId,P.tenantId)})),i.set(R,s),i.size>1&&d.Lumberjack.info(`Same socket is having multiple connections, connection number=${i.size}`,(0,d.getLumberBaseProperties)(s.documentId,s.tenantId)),e.success("Successfully established orderer connection"),Y={claims:P,clientId:R,existing:!0,maxMessageSize:s.maxMessageSize,mode:"write",serviceConfiguration:{blockSize:s.serviceConfiguration.blockSize,maxMessageSize:s.serviceConfiguration.maxMessageSize},initialClients:X,initialMessages:[],initialSignals:[],supportedVersions:C,version:H}}else Y={claims:P,clientId:R,existing:!0,maxMessageSize:1024,mode:"read",serviceConfiguration:{blockSize:h.DefaultServiceConfiguration.blockSize,maxMessageSize:h.DefaultServiceConfiguration.maxMessageSize},initialClients:X,initialMessages:[],initialSignals:[],supportedVersions:C,version:H};return Y.timestamp=F,V&&P.jti&&V.addSocketForToken(h.createCompositeTokenId(e.tenantId,e.id,P.jti),t),{connection:Y,connectVersions:_,details:q}}(e).then((e=>{var r;t.emit("connect_document_success",e.connection);const n=o.get(e.connection.clientId);n&&t.emitToRoom(f(n),"signal",(0,m.createRoomJoinMessage)(e.connection.clientId,e.details)),S.setProperties({[d.CommonProperties.clientId]:e.connection.clientId,[d.CommonProperties.clientCount]:e.connection.initialClients.length+1,[d.CommonProperties.clientType]:null===(r=e.details.details)||void 0===r?void 0:r.type}),S.success("Connect document successful")}),(e=>{t.emit("connect_document_error",e),void 0!==(null==e?void 0:e.code)&&S.setProperty(d.CommonProperties.errorCode,e.code),S.error("Connect document failed",e)}))})),t.on("submitOp",((e,r)=>{const n=i.get(e);if(n){let i=0;for(const e of r)i+=Array.isArray(e)?e.length:1;const s=N(q,b(e,n.tenantId),n.tenantId,l,void 0,void 0,i);if(s){const e=(0,m.createNackMessage)(s.code,a.NackErrorType.ThrottlingError,s.message,s.retryAfter);return void t.emit("nack","",[e])}const o=Object.assign({[d.CommonProperties.clientId]:e},(0,d.getLumberBaseProperties)(n.documentId,n.tenantId)),u=e=>{if((0,c.isNetworkError)(e)&&413===e.code)return d.Lumberjack.info("Rejected too large operation(s)",o),void t.emit("nack","",[(0,m.createNackMessage)(e.code,a.NackErrorType.BadRequestError,e.message)]);d.Lumberjack.error("Error processing submitted op(s)",o,e)};r.forEach((e=>{const t=Array.isArray(e)?e:[e];try{const e=t.map((e=>{if(!0===H&&JSON.stringify(e.contents).length>n.serviceConfiguration.maxMessageSize)throw new c.NetworkError(413,"Op size too large");return P(w(e),M,n.clientId,n.tenantId,n.documentId)}));e.length>0&&n.order(e).catch(u)}catch(e){u(e)}}))}else{let r;const n=$.get(e);r=n&&J(n)?(0,m.createNackMessage)(400,a.NackErrorType.BadRequestError,"Readonly client"):o.has(e)?(0,m.createNackMessage)(403,a.NackErrorType.InvalidScopeError,"Invalid scope"):(0,m.createNackMessage)(400,a.NackErrorType.BadRequestError,"Nonexistent client"),t.emit("nack","",[r])}})),t.on("submitSignal",((e,r)=>{const n=o.get(e);if(n){let i=0;for(const e of r)i+=Array.isArray(e)?e.length:1;const s={value:0,tenantId:n.tenantId,documentId:n.documentId,clientId:e},o=N(B,S(e,n.tenantId),n.tenantId,l,D?h.signalUsageStorageId:void 0,D?s:void 0,i);if(o){const e=(0,m.createNackMessage)(o.code,a.NackErrorType.ThrottlingError,o.message,o.retryAfter);return void t.emit("nack","",[e])}r.forEach((r=>{const i=Array.isArray(r)?r:[r];for(const r of i){const i={clientId:e,content:r};t.emitToRoom(f(n),"signal",i)}}))}else{const e=(0,m.createNackMessage)(400,a.NackErrorType.BadRequestError,"Nonexistent client");t.emit("nack","",[e])}})),t.on("disconnect",(async()=>{G();const e=[];for(const[t,r]of i){const n=g(r.documentId,r.tenantId);if(l.info(`Disconnect of ${t}`,{messageMetaData:n}),d.Lumberjack.info(`Disconnect of ${t}`,(0,d.getLumberBaseProperties)(r.documentId,r.tenantId)),r.disconnect(),R&&_){const n=U.get(t);n&&e.push(T(t,r.documentId,r.tenantId,n,_))}}for(const[r,n]of o){const i=g(n.documentId,n.tenantId);U.has(r)&&W.decrementConnectionCount(),l.info(`Disconnect of ${r} from room`,{messageMetaData:i}),d.Lumberjack.info(`Disconnect of ${r} from room`,(0,d.getLumberBaseProperties)(n.documentId,n.tenantId)),e.push(s.removeClient(n.tenantId,n.documentId,r)),t.emitToRoom(f(n),"signal",(0,m.createRoomLeaveMessage)(r))}V&&V.removeSocket(t.id),await Promise.all(e)}))}))}}).call(this,r("5IsQ"))},"RN+g":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.KeyName=void 0,function(e){e.key1="key1",e.key2="key2"}(t.KeyName||(t.KeyName={}))},Ra6H:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestTenantManager=t.TestTenant=void 0;const n=r("iYGh"),i=r("hVFe"),s=r("tRAo");class o{constructor(e,t,r){this.url=e,this.historianUrl=t,this.owner="test",this.repository="test";const s=new i.TestHistorian(r);this.manager=new n.GitManager(s)}get gitManager(){return this.manager}get storage(){return{historianUrl:this.historianUrl,internalHistorianUrl:this.historianUrl,credentials:null,owner:this.owner,repository:this.repository,url:this.url}}get orderer(){return{type:"kafka",url:this.url}}}t.TestTenant=o,t.TestTenantManager=class{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"http://test",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"http://historian",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new s.TestDb({});this.tenant=new o(e,t,r)}async createTenant(e){return{id:"test-tenant",storage:this.tenant.storage,orderer:this.tenant.orderer,key:"test-tenant-key",customData:{}}}async verifyToken(e){}async getTenant(e){return this.tenant}async getTenantGitManager(e,t){return this.tenant.gitManager}async getKey(e){return"test"}}},RmbP:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestEngine2=t.TestEngine1=t.TestSchemaValidator=t.TestLumberjack=void 0;const n=r("QoYi");t.TestLumberjack=class extends n.Lumberjack{static reset(){n.Lumberjack._instance=void 0}},t.TestSchemaValidator=class{constructor(e){this.passResult=e}validate(e){return{validationPassed:this.passResult,validationFailedForProperties:[]}}},t.TestEngine1=class{emit(e){}},t.TestEngine2=class{emit(e){}}},SOuT:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LocalNodeFactory=void 0;const n=r("Twpl"),i=r("mqfF");t.LocalNodeFactory=class{constructor(e,t,r,n,i,s,o,a,c,u,l,h,d){this.hostname=e,this.address=t,this.storage=r,this.databaseManager=n,this.documentRepository=i,this.timeoutLength=s,this.webSocketServerFactory=o,this.taskMessageSender=a,this.tenantManager=c,this.permission=u,this.maxMessageSize=l,this.tokenGenerator=h,this.logger=d}async create(){return i.LocalNode.connect(`${this.hostname}-${(0,n.v4)()}`,this.address,this.storage,this.databaseManager,this.documentRepository,this.timeoutLength,this.webSocketServerFactory,this.taskMessageSender,this.tenantManager,this.permission,this.maxMessageSize,this.tokenGenerator,this.logger)}}},SVYa:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScribeLambdaFactory=void 0;const n=r("hBZP"),i=r("4+3C"),s=r("MPeK"),o=r("y2M+"),a=r("tp/L"),c=r("Txkb"),u=r("6F7b"),l=r("i1Dz"),h=r("UmFD"),d=r("dW4G"),m=r("jKCC"),p=r("KCgx"),f={lastClientSummaryHead:void 0,logOffset:-1,minimumSequenceNumber:0,protocolState:{members:[],minimumSequenceNumber:0,proposals:[],sequenceNumber:0,values:[]},sequenceNumber:0,lastSummarySequenceNumber:0,validParentSummaries:void 0};t.ScribeLambdaFactory=class extends n.EventEmitter{constructor(e,t,r,n,i,s,o,a,c){super(),this.mongoManager=e,this.documentRepository=t,this.messageCollection=r,this.producer=n,this.deltaManager=i,this.tenantManager=s,this.serviceConfiguration=o,this.enableWholeSummaryUpload=a,this.getDeltasViaAlfred=c}async create(e,t){var r,n,o,g,y,v,b;let S,w,C,E,I,T=[];const{tenantId:N,documentId:P}=e,x={documentId:P,tenantId:N},O=(0,c.createSessionMetric)(N,P,a.LumberEventName.ScribeSessionResult,this.serviceConfiguration);try{if(S=await this.documentRepository.readOne({documentId:P,tenantId:N}),!(0,c.isDocumentValid)(S)){const e="Received attempt to connect to a missing/deleted document.";return null===(r=t.log)||void 0===r||r.error(e,{messageMetaData:x}),a.Lumberjack.error(e,(0,a.getLumberBaseProperties)(P,N)),new c.NoOpLambda(t)}if(!(0,c.isDocumentSessionValid)(S,this.serviceConfiguration)){const e=`Received attempt to connect to invalid session: ${JSON.stringify(S.session)}`;if(null===(n=t.log)||void 0===n||n.error(e,{messageMetaData:x}),a.Lumberjack.error(e,(0,a.getLumberBaseProperties)(P,N)),this.serviceConfiguration.enforceDiscoveryFlow)return new c.NoOpLambda(t)}w=await this.tenantManager.getTenantGitManager(N,P),E=new h.SummaryReader(N,P,w,this.enableWholeSummaryUpload),I=await E.readLastSummary()}catch(e){const r="Scribe lambda creation failed.";throw null===(o=t.log)||void 0===o||o.error(`${r} Exception: ${(0,i.inspect)(e)}`,{messageMetaData:x}),a.Lumberjack.error(r,(0,a.getLumberBaseProperties)(P,N),e),await this.sendLambdaStartResult(N,P,{lambdaName:s.LambdaName.Scribe,success:!1}),null==O||O.error("Scribe lambda creation failed",e),e}if(null==S.scribe){const e="New document. Setting empty scribe checkpoint";null===(g=t.log)||void 0===g||g.info(e,{messageMetaData:x}),a.Lumberjack.info(e,(0,a.getLumberBaseProperties)(P,N)),C=f}else if(""===S.scribe){const e="Existing document. Fetching checkpoint from summary";if(null===(y=t.log)||void 0===y||y.info(e,{messageMetaData:x}),a.Lumberjack.info(e,(0,a.getLumberBaseProperties)(P,N)),I.fromSummary){C=JSON.parse(I.scribe),T=I.messages,C.logOffset=-1;const e=`Restoring checkpoint from latest summary. Seq number: ${C.sequenceNumber}`;null===(b=t.log)||void 0===b||b.info(e,{messageMetaData:x}),a.Lumberjack.info(e,(0,a.getLumberBaseProperties)(P,N))}else null===(v=t.log)||void 0===v||v.error("Summary can't be fetched",{messageMetaData:x}),a.Lumberjack.error("Summary can't be fetched",(0,a.getLumberBaseProperties)(P,N)),C=f}else{C=JSON.parse(S.scribe);const e=Object.assign(Object.assign({},(0,a.getLumberBaseProperties)(P,N)),{lastCheckpointSeqNo:C.sequenceNumber,logOffset:C.logOffset,LastCheckpointProtocolSeqNo:C.protocolState.sequenceNumber});a.Lumberjack.info("Restoring checkpoint from db",e),this.getDeltasViaAlfred?-1!==C.logOffset&&(T=await this.deltaManager.getDeltas("",N,P,C.protocolState.sequenceNumber)):T=(await this.messageCollection.find({documentId:P,tenantId:N},{"operation.sequenceNumber":1})).map((e=>e.operation))}const M=T.filter((e=>e.sequenceNumber>C.protocolState.sequenceNumber));let k=C.protocolState.sequenceNumber+1;for(const e of M){if(e.sequenceNumber!==k){const t=new Error(`Invalid message sequence from checkpoint/summary.Current message @${e.sequenceNumber}.Expected message @${k}`);throw null==O||O.error("Invalid message sequence from checkpoint/summary",t),await this.sendLambdaStartResult(N,P,{lambdaName:s.LambdaName.Scribe,success:!1}),t}++k}const L=(0,m.initializeProtocol)(C.protocolState,I.term),R=new d.SummaryWriter(N,P,w,this.deltaManager,this.messageCollection,this.enableWholeSummaryUpload,I.messages,this.getDeltasViaAlfred),D=new u.CheckpointManager(t,N,P,this.documentRepository,this.messageCollection,this.deltaManager,this.getDeltasViaAlfred),F=new p.PendingMessageReader(N,P,this.deltaManager),A=Object.assign(Object.assign({},(0,a.getLumberBaseProperties)(P,N)),{lastCheckpointSeqNo:C.sequenceNumber,logOffset:C.logOffset,protocolHead:I.protocolHead,numOpsSinceLastSummary:M.length,LastCheckpointProtocolSeqNo:C.protocolState.sequenceNumber});a.Lumberjack.info("Creating scribe lambda",A);const j=new l.ScribeLambda(t,S.tenantId,S.documentId,R,E,F,D,C,this.serviceConfiguration,this.producer,L,I.term,I.protocolHead,M,O);return await this.sendLambdaStartResult(N,P,{lambdaName:s.LambdaName.Scribe,success:!0}),j}async dispose(){await this.mongoManager.close()}async sendLambdaStartResult(e,t,r){const n={clientSequenceNumber:-1,contents:null,data:JSON.stringify({type:s.ControlMessageType.LambdaStartResult,contents:r}),referenceSequenceNumber:-1,traces:this.serviceConfiguration.enableTraces?[]:void 0,type:o.MessageType.Control};return(0,m.sendToDeli)(e,t,this.producer,n)}}},SzwC:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScriptoriumLambdaFactory=void 0;const n=r("hBZP"),i=r("o5Rw");t.ScriptoriumLambdaFactory=class extends n.EventEmitter{constructor(e,t,r){super(),this.mongoManager=e,this.opCollection=t,this.providerConfig=r}async create(e,t){return new i.ScriptoriumLambda(this.opCollection,t,this.providerConfig)}async dispose(){await this.mongoManager.close()}}},"T+1T":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestClientManager=void 0,t.TestClientManager=class{constructor(){this.clients=new Map}async addClient(e,t,r,n){this.clients.has(e)||this.clients.set(e,new Map),this.clients.get(e).has(t)||this.clients.get(e).set(t,new Map),this.clients.get(e).get(t).set(r,n)}async removeClient(e,t,r){this.clients.has(e)&&this.clients.get(e).has(t)&&this.clients.get(e).get(t).delete(r)}async getClients(e,t){const r=[];if(this.clients.has(e)&&this.clients.get(e).has(t))for(const[n,i]of this.clients.get(e).get(t))r.push({clientId:n,client:i});return r}async getSequencedClients(e,t){throw new Error("Not implemented")}async extendSequencedClients(e,t,r,n){throw new Error("Not implemented")}}},Tmfz:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateRetryIntervalForNetworkError=t.shouldRetryNetworkError=t.requestWithRetry=t.runWithRetry=void 0;const n=r("wWog"),i=r("fhs9");function s(e){if(e instanceof Error&&"NetworkError"===(null==e?void 0:e.name)){const t=e;return!t.isFatal&&!0===t.canRetry}return!1}function o(e,t,r){return e instanceof Error&&"NetworkError"===(null==e?void 0:e.name)&&e.retryAfterMs?e.retryAfterMs:r*2**t}t.runWithRetry=async function(e,t,r,s,o,a,c){let u,l,h,d=arguments.length>7&&void 0!==arguments[7]?arguments[7]:(e,t,r)=>r*2**t,m=arguments.length>8?arguments[8]:void 0,p=arguments.length>9&&void 0!==arguments[9]&&arguments[9],f=0,g=!1;p&&(l=i.Lumberjack.newLumberMetric(i.LumberEventName.RunWithRetry,o));try{do{try{u=await e(),g=!0,f>=1&&i.Lumberjack.info(`Succeeded in executing ${t} with ${f} retries`,o)}catch(e){if(void 0!==m&&m(e),h=e,i.Lumberjack.error(`Error running ${t}: retryCount ${f}`,o,e),void 0!==a&&!0===a(e)){i.Lumberjack.info(`Should ignore error for ${t}`,o);break}if(void 0!==c&&!1===c(e))return i.Lumberjack.error(`Should not retry ${t} for the current error, rejecting`,o,e),Promise.reject(e);if(-1!==r&&f>=r)return i.Lumberjack.error(`Error after retrying ${f} times, rejecting`,o,e),Promise.reject(e);const u=d(e,f,s);await(0,n.delay)(u),f++}}while(!g);return u}finally{p&&l&&(l.setProperty("retryCount",f),l.setProperty("callName",t),l.setProperty("maxRetries",r),l.setProperty("retryAfterMs",s),g?l.success("runWithRetry succeeded"):l.error("runWithRetry failed",h))}},t.requestWithRetry=async function(e,t,r){let a,c,u,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:s,h=arguments.length>4&&void 0!==arguments[4]?arguments[4]:-1,d=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1e3,m=arguments.length>6&&void 0!==arguments[6]?arguments[6]:o,p=arguments.length>7?arguments[7]:void 0,f=arguments.length>8&&void 0!==arguments[8]&&arguments[8],g=0,y=!1;f&&(c=i.Lumberjack.newLumberMetric(i.LumberEventName.RequestWithRetry,r));try{do{try{a=await e(),y=!0,g>=1&&i.Lumberjack.info(`Succeeded in executing ${t} with ${g} retries`,r)}catch(e){if(void 0!==p&&p(e),i.Lumberjack.error(`Error running ${t}: retryCount ${g}`,r,e),void 0!==l&&!1===l(e))return i.Lumberjack.error(`Should not retry ${t} for the current error, rejecting`,r,e),Promise.reject(e);if(-1!==h&&g>=h)return i.Lumberjack.error(`Error after retrying ${g} times, rejecting`,r,e),Promise.reject(e);const s=m(e,g,d);await(0,n.delay)(s),g++}}while(!y);return a}finally{f&&c&&(c.setProperty("retryCount",g),c.setProperty("callName",t),c.setProperty("maxRetries",h),c.setProperty("retryAfterMs",d),y?c.success("requestWithRetry succeeded"):c.error("requestWithRetry failed",u))}},t.shouldRetryNetworkError=s,t.calculateRetryIntervalForNetworkError=o},TnPO:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LambdaSchemaValidator=t.BasePropertiesValidator=t.BaseLumberjackSchemaValidator=void 0;const n=r("FY09");class i{constructor(){this.validators=new Map,this.stringValidation=e=>this.isUndefined(e)||this.isString(e)&&e.length>0,this.numberValidation=e=>this.isUndefined(e)||this.isNumber(e),this.positiveNumberValidation=e=>this.isUndefined(e)||this.isNumber(e)&&e>=-1}validate(e){const t=[];return this.validators.forEach(((r,n)=>{e.has(n)&&r(e.get(n))||t.push(n)})),{validationPassed:0===t.length,validationFailedForProperties:t}}isUndefined(e){return void 0===e}isNumber(e){return"number"==typeof e}isString(e){return"string"==typeof e}}t.BaseLumberjackSchemaValidator=i;class s extends i{constructor(){super(),this.validators.set(n.BaseTelemetryProperties.tenantId,this.stringValidation),this.validators.set(n.BaseTelemetryProperties.documentId,this.stringValidation)}validate(e){return super.validate(e)}}t.BasePropertiesValidator=s,t.LambdaSchemaValidator=class extends s{constructor(){super(),this.validators.set(n.QueuedMessageProperties.topic,this.stringValidation),this.validators.set(n.QueuedMessageProperties.partition,this.positiveNumberValidation),this.validators.set(n.QueuedMessageProperties.offset,this.numberValidation)}validate(e){return super.validate(e)}}},ToCX:function(e,t,r){"use strict";r.d(t,"a",(function(){return n})),r.d(t,"c",(function(){return i})),r.d(t,"b",(function(){return s})),r.d(t,"d",(function(){return o}));class n extends Error{constructor(e,t,r,n,i){super(t),this.code=e,this.canRetry=r,this.isFatal=n,this.retryAfterMs=i,this.name="NetworkError",this.retryAfter=void 0!==i?i/1e3:void 0}get details(){return void 0===this.canRetry&&void 0===this.isFatal&&void 0===this.retryAfterMs?this.message:{message:this.message,canRetry:this.canRetry,isFatal:this.isFatal,retryAfter:this.retryAfter,retryAfterMs:this.retryAfterMs}}toJSON(){return{code:this.code,message:this.message,canRetry:this.canRetry,isFatal:this.isFatal,retryAfterMs:this.retryAfterMs,retryAfter:this.retryAfter}}}function i(e){return"NetworkError"===e.name&&"number"==typeof e.code&&"string"==typeof e.message}function s(e,t){var r;let i,s,o,a;switch(t&&"object"==typeof t?(i=null!==(r=t.message)&&void 0!==r?r:"Unknown Error",s=t.canRetry,o=t.isFatal,a=t.retryAfter):i=t&&"string"==typeof t?t:"Unknown Error",e){case 401:case 403:case 404:return new n(e,i,!1,!1);case 413:case 422:return new n(e,i,null!=s&&s,null!=o&&o,s?a:void 0);case 429:return new n(e,i,!0,!1,a);case 500:return new n(e,i,null==s||s,null!=o&&o,s?a:void 0);case 502:case 503:case 504:return new n(e,i,!0,!1,a);default:return new n(e,i,!1,!0)}}function o(e,t){throw s(e,t)}},TrU0:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BroadcasterLambdaFactory=void 0;const n=r("hBZP"),i=r("tY1o");t.BroadcasterLambdaFactory=class extends n.EventEmitter{constructor(e,t,r){super(),this.publisher=e,this.serviceConfiguration=t,this.clientManager=r,this.publisher.on("error",(e=>{this.emit("error",e)}))}async create(e,t){return new i.BroadcasterLambda(this.publisher,t,this.serviceConfiguration,this.clientManager)}async dispose(){await this.publisher.close()}}},Twpl:function(e,t,r){"use strict";r.r(t),r.d(t,"v1",(function(){return u})),r.d(t,"v3",(function(){return S})),r.d(t,"v4",(function(){return w.a})),r.d(t,"v5",(function(){return I})),r.d(t,"NIL",(function(){return T.a})),r.d(t,"version",(function(){return N})),r.d(t,"validate",(function(){return l.a})),r.d(t,"stringify",(function(){return o.a})),r.d(t,"parse",(function(){return h}));var n,i,s=r("M/ko"),o=r("nVLW"),a=0,c=0,u=function(e,t,r){var u=t&&r||0,l=t||new Array(16),h=(e=e||{}).node||n,d=void 0!==e.clockseq?e.clockseq:i;if(null==h||null==d){var m=e.random||(e.rng||s.a)();null==h&&(h=n=[1|m[0],m[1],m[2],m[3],m[4],m[5]]),null==d&&(d=i=16383&(m[6]<<8|m[7]))}var p=void 0!==e.msecs?e.msecs:Date.now(),f=void 0!==e.nsecs?e.nsecs:c+1,g=p-a+(f-c)/1e4;if(g<0&&void 0===e.clockseq&&(d=d+1&16383),(g<0||p>a)&&void 0===e.nsecs&&(f=0),f>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");a=p,c=f,i=d;var y=(1e4*(268435455&(p+=122192928e5))+f)%4294967296;l[u++]=y>>>24&255,l[u++]=y>>>16&255,l[u++]=y>>>8&255,l[u++]=255&y;var v=p/4294967296*1e4&268435455;l[u++]=v>>>8&255,l[u++]=255&v,l[u++]=v>>>24&15|16,l[u++]=v>>>16&255,l[u++]=d>>>8|128,l[u++]=255&d;for(var b=0;b<6;++b)l[u+b]=h[b];return t||Object(o.a)(l)},l=r("due6"),h=function(e){if(!Object(l.a)(e))throw TypeError("Invalid UUID");var t,r=new Uint8Array(16);return r[0]=(t=parseInt(e.slice(0,8),16))>>>24,r[1]=t>>>16&255,r[2]=t>>>8&255,r[3]=255&t,r[4]=(t=parseInt(e.slice(9,13),16))>>>8,r[5]=255&t,r[6]=(t=parseInt(e.slice(14,18),16))>>>8,r[7]=255&t,r[8]=(t=parseInt(e.slice(19,23),16))>>>8,r[9]=255&t,r[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,r[11]=t/4294967296&255,r[12]=t>>>24&255,r[13]=t>>>16&255,r[14]=t>>>8&255,r[15]=255&t,r},d=function(e,t,r){function n(e,n,i,s){if("string"==typeof e&&(e=function(e){e=unescape(encodeURIComponent(e));for(var t=[],r=0;r<e.length;++r)t.push(e.charCodeAt(r));return t}(e)),"string"==typeof n&&(n=h(n)),16!==n.length)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var a=new Uint8Array(16+e.length);if(a.set(n),a.set(e,n.length),(a=r(a))[6]=15&a[6]|t,a[8]=63&a[8]|128,i){s=s||0;for(var c=0;c<16;++c)i[s+c]=a[c];return i}return Object(o.a)(a)}try{n.name=e}catch(e){}return n.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",n.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8",n};function m(e){return 14+(e+64>>>9<<4)+1}function p(e,t){var r=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(r>>16)<<16|65535&r}function f(e,t,r,n,i,s){return p(function(e,t){return e<<t|e>>>32-t}(p(p(t,e),p(n,s)),i),r)}function g(e,t,r,n,i,s,o){return f(t&r|~t&n,e,t,i,s,o)}function y(e,t,r,n,i,s,o){return f(t&n|r&~n,e,t,i,s,o)}function v(e,t,r,n,i,s,o){return f(t^r^n,e,t,i,s,o)}function b(e,t,r,n,i,s,o){return f(r^(t|~n),e,t,i,s,o)}var S=d("v3",48,(function(e){if("string"==typeof e){var t=unescape(encodeURIComponent(e));e=new Uint8Array(t.length);for(var r=0;r<t.length;++r)e[r]=t.charCodeAt(r)}return function(e){for(var t=[],r=32*e.length,n="0123456789abcdef",i=0;i<r;i+=8){var s=e[i>>5]>>>i%32&255,o=parseInt(n.charAt(s>>>4&15)+n.charAt(15&s),16);t.push(o)}return t}(function(e,t){e[t>>5]|=128<<t%32,e[m(t)-1]=t;for(var r=1732584193,n=-271733879,i=-1732584194,s=271733878,o=0;o<e.length;o+=16){var a=r,c=n,u=i,l=s;r=g(r,n,i,s,e[o],7,-680876936),s=g(s,r,n,i,e[o+1],12,-389564586),i=g(i,s,r,n,e[o+2],17,606105819),n=g(n,i,s,r,e[o+3],22,-1044525330),r=g(r,n,i,s,e[o+4],7,-176418897),s=g(s,r,n,i,e[o+5],12,1200080426),i=g(i,s,r,n,e[o+6],17,-1473231341),n=g(n,i,s,r,e[o+7],22,-45705983),r=g(r,n,i,s,e[o+8],7,1770035416),s=g(s,r,n,i,e[o+9],12,-1958414417),i=g(i,s,r,n,e[o+10],17,-42063),n=g(n,i,s,r,e[o+11],22,-1990404162),r=g(r,n,i,s,e[o+12],7,1804603682),s=g(s,r,n,i,e[o+13],12,-40341101),i=g(i,s,r,n,e[o+14],17,-1502002290),r=y(r,n=g(n,i,s,r,e[o+15],22,1236535329),i,s,e[o+1],5,-165796510),s=y(s,r,n,i,e[o+6],9,-1069501632),i=y(i,s,r,n,e[o+11],14,643717713),n=y(n,i,s,r,e[o],20,-373897302),r=y(r,n,i,s,e[o+5],5,-701558691),s=y(s,r,n,i,e[o+10],9,38016083),i=y(i,s,r,n,e[o+15],14,-660478335),n=y(n,i,s,r,e[o+4],20,-405537848),r=y(r,n,i,s,e[o+9],5,568446438),s=y(s,r,n,i,e[o+14],9,-1019803690),i=y(i,s,r,n,e[o+3],14,-187363961),n=y(n,i,s,r,e[o+8],20,1163531501),r=y(r,n,i,s,e[o+13],5,-1444681467),s=y(s,r,n,i,e[o+2],9,-51403784),i=y(i,s,r,n,e[o+7],14,1735328473),r=v(r,n=y(n,i,s,r,e[o+12],20,-1926607734),i,s,e[o+5],4,-378558),s=v(s,r,n,i,e[o+8],11,-2022574463),i=v(i,s,r,n,e[o+11],16,1839030562),n=v(n,i,s,r,e[o+14],23,-35309556),r=v(r,n,i,s,e[o+1],4,-1530992060),s=v(s,r,n,i,e[o+4],11,1272893353),i=v(i,s,r,n,e[o+7],16,-155497632),n=v(n,i,s,r,e[o+10],23,-1094730640),r=v(r,n,i,s,e[o+13],4,681279174),s=v(s,r,n,i,e[o],11,-358537222),i=v(i,s,r,n,e[o+3],16,-722521979),n=v(n,i,s,r,e[o+6],23,76029189),r=v(r,n,i,s,e[o+9],4,-640364487),s=v(s,r,n,i,e[o+12],11,-421815835),i=v(i,s,r,n,e[o+15],16,530742520),r=b(r,n=v(n,i,s,r,e[o+2],23,-995338651),i,s,e[o],6,-198630844),s=b(s,r,n,i,e[o+7],10,1126891415),i=b(i,s,r,n,e[o+14],15,-1416354905),n=b(n,i,s,r,e[o+5],21,-57434055),r=b(r,n,i,s,e[o+12],6,1700485571),s=b(s,r,n,i,e[o+3],10,-1894986606),i=b(i,s,r,n,e[o+10],15,-1051523),n=b(n,i,s,r,e[o+1],21,-2054922799),r=b(r,n,i,s,e[o+8],6,1873313359),s=b(s,r,n,i,e[o+15],10,-30611744),i=b(i,s,r,n,e[o+6],15,-1560198380),n=b(n,i,s,r,e[o+13],21,1309151649),r=b(r,n,i,s,e[o+4],6,-145523070),s=b(s,r,n,i,e[o+11],10,-1120210379),i=b(i,s,r,n,e[o+2],15,718787259),n=b(n,i,s,r,e[o+9],21,-343485551),r=p(r,a),n=p(n,c),i=p(i,u),s=p(s,l)}return[r,n,i,s]}(function(e){if(0===e.length)return[];for(var t=8*e.length,r=new Uint32Array(m(t)),n=0;n<t;n+=8)r[n>>5]|=(255&e[n/8])<<n%32;return r}(e),8*e.length))})),w=r("A3AF");function C(e,t,r,n){switch(e){case 0:return t&r^~t&n;case 1:return t^r^n;case 2:return t&r^t&n^r&n;case 3:return t^r^n}}function E(e,t){return e<<t|e>>>32-t}var I=d("v5",80,(function(e){var t=[1518500249,1859775393,2400959708,3395469782],r=[1732584193,4023233417,2562383102,271733878,3285377520];if("string"==typeof e){var n=unescape(encodeURIComponent(e));e=[];for(var i=0;i<n.length;++i)e.push(n.charCodeAt(i))}else Array.isArray(e)||(e=Array.prototype.slice.call(e));e.push(128);for(var s=Math.ceil((e.length/4+2)/16),o=new Array(s),a=0;a<s;++a){for(var c=new Uint32Array(16),u=0;u<16;++u)c[u]=e[64*a+4*u]<<24|e[64*a+4*u+1]<<16|e[64*a+4*u+2]<<8|e[64*a+4*u+3];o[a]=c}o[s-1][14]=8*(e.length-1)/Math.pow(2,32),o[s-1][14]=Math.floor(o[s-1][14]),o[s-1][15]=8*(e.length-1)&4294967295;for(var l=0;l<s;++l){for(var h=new Uint32Array(80),d=0;d<16;++d)h[d]=o[l][d];for(var m=16;m<80;++m)h[m]=E(h[m-3]^h[m-8]^h[m-14]^h[m-16],1);for(var p=r[0],f=r[1],g=r[2],y=r[3],v=r[4],b=0;b<80;++b){var S=Math.floor(b/20),w=E(p,5)+C(S,f,g,y)+v+t[S]+h[b]>>>0;v=y,y=g,g=E(f,30)>>>0,f=p,p=w}r[0]=r[0]+p>>>0,r[1]=r[1]+f>>>0,r[2]=r[2]+g>>>0,r[3]=r[3]+y>>>0,r[4]=r[4]+v>>>0}return[r[0]>>24&255,r[0]>>16&255,r[0]>>8&255,255&r[0],r[1]>>24&255,r[1]>>16&255,r[1]>>8&255,255&r[1],r[2]>>24&255,r[2]>>16&255,r[2]>>8&255,255&r[2],r[3]>>24&255,r[3]>>16&255,r[3]>>8&255,255&r[3],r[4]>>24&255,r[4]>>16&255,r[4]>>8&255,255&r[4]]})),T=r("Lrhb"),N=function(e){if(!Object(l.a)(e))throw TypeError("Invalid UUID");return parseInt(e.substr(14,1),16)}},Txkb:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConnectionCountLogger=t.CheckpointReason=t.isDocumentValid=t.isDocumentSessionValid=t.logCommonSessionEndMetrics=t.createSessionMetric=t.NoOpLambda=t.createRoomLeaveMessage=t.createRoomJoinMessage=t.createNackMessage=t.generateClientId=void 0;var n=r("YO7/");Object.defineProperty(t,"generateClientId",{enumerable:!0,get:function(){return n.generateClientId}});var i=r("OagO");Object.defineProperty(t,"createNackMessage",{enumerable:!0,get:function(){return i.createNackMessage}}),Object.defineProperty(t,"createRoomJoinMessage",{enumerable:!0,get:function(){return i.createRoomJoinMessage}}),Object.defineProperty(t,"createRoomLeaveMessage",{enumerable:!0,get:function(){return i.createRoomLeaveMessage}});var s=r("2boo");Object.defineProperty(t,"NoOpLambda",{enumerable:!0,get:function(){return s.NoOpLambda}});var o=r("CXFK");Object.defineProperty(t,"createSessionMetric",{enumerable:!0,get:function(){return o.createSessionMetric}}),Object.defineProperty(t,"logCommonSessionEndMetrics",{enumerable:!0,get:function(){return o.logCommonSessionEndMetrics}});var a=r("4Nzb");Object.defineProperty(t,"isDocumentSessionValid",{enumerable:!0,get:function(){return a.isDocumentSessionValid}}),Object.defineProperty(t,"isDocumentValid",{enumerable:!0,get:function(){return a.isDocumentValid}});var c=r("0xfR");Object.defineProperty(t,"CheckpointReason",{enumerable:!0,get:function(){return c.CheckpointReason}});var u=r("FMpQ");Object.defineProperty(t,"ConnectionCountLogger",{enumerable:!0,get:function(){return u.ConnectionCountLogger}})},UNwp:function(e,t,r){"use strict";function n(e){this.message=e}(n.prototype=new Error).name="InvalidCharacterError";var i="undefined"!=typeof window&&window.atob&&window.atob.bind(window)||function(e){var t=String(e).replace(/=+$/,"");if(t.length%4==1)throw new n("'atob' failed: The string to be decoded is not correctly encoded.");for(var r,i,s=0,o=0,a="";i=t.charAt(o++);~i&&(r=s%4?64*r+i:i,s++%4)?a+=String.fromCharCode(255&r>>(-2*s&6)):0)i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(i);return a};function s(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}try{return function(e){return decodeURIComponent(i(e).replace(/(.)/g,(function(e,t){var r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r})))}(t)}catch(e){return i(t)}}function o(e){this.message=e}(o.prototype=new Error).name="InvalidTokenError",t.a=function(e,t){if("string"!=typeof e)throw new o("Invalid token specified");var r=!0===(t=t||{}).header?0:1;try{return JSON.parse(s(e.split(".")[r]))}catch(e){throw new o("Invalid token specified: "+e.message)}}},USNV:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CombinedLambda=void 0,t.CombinedLambda=class{constructor(e){this.lambdas=e}handler(e){const t=[];for(const r of this.lambdas){const n=r.handler(e);void 0!==n&&t.push(n)}return t.length>0?Promise.all(t):void 0}close(e){for(const t of this.lambdas)t.close(e)}}},UZN4:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.chooseCelaName=void 0;const n=["Elliot Woodward","Miguel Garcia","Robert Tolbert","Henry Brill","Cecil Folk","Isaac Fielder","Erik Nason","Tim Deboer","Mauricio August","Allan Munger","Kevin Sturgis","Carlos Slattery","Johnnie McConnell","Colin Ballinger","Kat Larsson","Katri Ahokas","Carole Poland","Wanda Howard","Amanda Brady","Ashley McCarthy","Lydia Bauer","Robin Counts","Charlotte Walton","Elvia Atkins","Daisy Phillips","Mona Kane","Kristin Patterson","Celeste Burton"];t.chooseCelaName=()=>n[Math.floor(Math.random()*n.length)]},UkUW:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestThrottler=void 0;const n=r("MPeK");t.TestThrottler=class{constructor(e){this.limit=e,this.throttleCounts=new Map}incrementCount(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const r=this.throttleCounts.get(e)||0;this.checkThrottled(r);const n=r+t;this.throttleCounts.set(e,n),this.checkThrottled(n)}decrementCount(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const r=(this.throttleCounts.get(e)||0)-t;this.throttleCounts.set(e,r)}checkThrottled(e){if(this.limit&&e>this.limit)throw new n.ThrottlingError("throttled",e-this.limit)}}},UmFD:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SummaryReader=void 0;const n=r("wWog"),i=r("Lvy3"),s=r("MPeK"),o=r("tp/L");t.SummaryReader=class{constructor(e,t,r,n){let i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:6;this.tenantId=e,this.documentId=t,this.summaryStorage=r,this.enableWholeSummaryUpload=n,this.maxRetriesOnError=i,this.lumberProperties=(0,o.getLumberBaseProperties)(this.documentId,this.tenantId)}async readLastSummary(){var e,t,r,a,c,u,l,h,d,m;const p=o.Lumberjack.newLumberMetric(o.LumberEventName.SummaryReader);if(p.setProperties(this.lumberProperties),this.enableWholeSummaryUpload)try{let m;try{m=await(0,s.requestWithRetry)((async()=>this.summaryStorage.getSummary(i.LatestSummaryId)),"readWholeSummary_getSummary",this.lumberProperties,s.shouldRetryNetworkError,this.maxRetriesOnError)}catch(e){o.Lumberjack.warning(`Error fetching summary with ID ${i.LatestSummaryId}. Will try with explicit ref.`,this.lumberProperties,e),m=void 0}if(!m){const e=await(0,s.requestWithRetry)((async()=>this.summaryStorage.getRef(encodeURIComponent(this.documentId))),"readWholeSummary_getRef",this.lumberProperties,s.shouldRetryNetworkError,this.maxRetriesOnError);m=await(0,s.requestWithRetry)((async()=>this.summaryStorage.getSummary(e.object.sha)),"readWholeSummary_getSummary",this.lumberProperties,s.shouldRetryNetworkError,this.maxRetriesOnError)}const f=(0,i.convertWholeFlatSummaryToSnapshotTreeAndBlobs)(m),g=null===(t=null===(e=f.snapshotTree.trees[".protocol"])||void 0===e?void 0:e.blobs)||void 0===t?void 0:t.attributes,y=null===(a=null===(r=f.snapshotTree.trees[".serviceProtocol"])||void 0===r?void 0:r.blobs)||void 0===a?void 0:a.scribe,v=null===(u=null===(c=f.snapshotTree.trees[".serviceProtocol"])||void 0===c?void 0:c.blobs)||void 0===u?void 0:u.deli,b=null===(h=null===(l=f.snapshotTree.trees[".logTail"])||void 0===l?void 0:l.blobs)||void 0===h?void 0:h.logTail,S=g?f.blobs.get(g):void 0,w=y?f.blobs.get(y):void 0,C=v?f.blobs.get(v):void 0,E=b?f.blobs.get(b):void 0,I=S?JSON.parse((0,n.bufferToString)(S,"utf8")):this.getDefaultAttributes(),T=w?(0,n.bufferToString)(w,"utf8"):this.getDefaultScribe(),N=C?JSON.parse((0,n.bufferToString)(C,"utf8")):this.getDefaultDeli(),P=N.term,x=E?JSON.parse((0,n.bufferToString)(E,"utf8")):this.getDefaultMesages();return p.setProperties({[o.CommonProperties.minLogtailSequenceNumber]:Math.min(...x.map((e=>e.sequenceNumber))),[o.CommonProperties.maxLogtailSequenceNumber]:Math.max(...x.map((e=>e.sequenceNumber))),[o.CommonProperties.lastSummarySequenceNumber]:N.sequenceNumber,[o.CommonProperties.clientCount]:null===(d=N.clients)||void 0===d?void 0:d.length}),p.success("Successfully read whole summary"),{term:P,protocolHead:I.sequenceNumber,scribe:T,messages:x,fromSummary:!0}}catch(e){return p.error("Returning default summary due to error when reading whole summary",e),this.getDefaultSummaryState()}else try{const e=await(0,s.requestWithRetry)((async()=>this.summaryStorage.getRef(encodeURIComponent(this.documentId))),"readSummary_getRef",this.lumberProperties,s.shouldRetryNetworkError,this.maxRetriesOnError),[t,r,i,a]=await Promise.all([(0,s.requestWithRetry)((async()=>this.summaryStorage.getContent(e.object.sha,".protocol/attributes")),"readSummary_getProtocolAttributesContent",this.lumberProperties,s.shouldRetryNetworkError,this.maxRetriesOnError).catch((()=>{})),(0,s.requestWithRetry)((async()=>this.summaryStorage.getContent(e.object.sha,".serviceProtocol/scribe")),"readSummary_getServiceProtocolScribeContent",this.lumberProperties,s.shouldRetryNetworkError,this.maxRetriesOnError).catch((()=>{})),(0,s.requestWithRetry)((async()=>this.summaryStorage.getContent(e.object.sha,".serviceProtocol/deli")),"readSummary_getServiceProtocolDeliContent",this.lumberProperties,s.shouldRetryNetworkError,this.maxRetriesOnError).catch((()=>{})),(0,s.requestWithRetry)((async()=>this.summaryStorage.getContent(e.object.sha,".logTail/logTail")),"readSummary_getLogTailContent",this.lumberProperties,s.shouldRetryNetworkError,this.maxRetriesOnError).catch((()=>{}))]),c=t?JSON.parse((0,n.toUtf8)(t.content,t.encoding)):this.getDefaultAttributes(),u=r?(0,n.toUtf8)(r.content,r.encoding):this.getDefaultScribe(),l=i?JSON.parse((0,n.toUtf8)(i.content,i.encoding)):this.getDefaultDeli(),h=l.term,d=a?JSON.parse((0,n.toUtf8)(a.content,a.encoding)):this.getDefaultMesages();return p.setProperties({[o.CommonProperties.minLogtailSequenceNumber]:Math.min(...d.map((e=>e.sequenceNumber))),[o.CommonProperties.maxLogtailSequenceNumber]:Math.max(...d.map((e=>e.sequenceNumber))),[o.CommonProperties.lastSummarySequenceNumber]:l.sequenceNumber,[o.CommonProperties.clientCount]:null===(m=l.clients)||void 0===m?void 0:m.length}),p.success("Successfully read summary"),{term:h,protocolHead:c.sequenceNumber,scribe:u,messages:d,fromSummary:!0}}catch(e){return p.error("Returning default summary due to error when reading summary",e),this.getDefaultSummaryState()}}getDefaultSummaryState(){return{term:1,protocolHead:0,scribe:"",messages:[],fromSummary:!1}}getDefaultAttributes(){return o.Lumberjack.info("Using default attributes when reading summary.",this.lumberProperties),{sequenceNumber:0,minimumSequenceNumber:0,term:void 0}}getDefaultScribe(){return o.Lumberjack.info("Using default scribe when reading summary.",this.lumberProperties),""}getDefaultDeli(){return o.Lumberjack.info("Using default deli state when reading summary.",this.lumberProperties),{clients:void 0,durableSequenceNumber:0,logOffset:0,sequenceNumber:0,signalClientConnectionNumber:0,expHash1:"",epoch:0,term:1,lastSentMSN:void 0,nackMessages:void 0,successfullyStartedLambdas:[],checkpointTimestamp:void 0}}getDefaultMesages(){return o.Lumberjack.info("Using default messages when reading summary.",this.lumberProperties),[]}}},Us1W:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isDocumentSessionValid=t.isDocumentValid=void 0,t.isDocumentValid=function(e){return!!e&&!e.scheduledDeletionTime},t.isDocumentSessionValid=function(e,t){return!t.externalOrdererUrl||!e.session||!!e.session.isSessionAlive&&e.session.ordererUrl===t.externalOrdererUrl}},UwdI:function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RemoteNode=void 0;const i=n(r("ZERR")),s=r("hBZP"),o=r("wWog"),a=r("fhs9"),c=r("ki0U"),u=r("qiG6"),l=r("+gGO");class h{constructor(e,t,r,n,i,s){this.tenantId=e,this.documentId=t,this.socket=r,this.node=n,this.cid=i,this.details=s}get clientId(){return this.details.clientId}get existing(){return this.details.existing}get maxMessageSize(){return this.details.maxMessageSize}get serviceConfiguration(){return this.details.serviceConfiguration}async connect(){}async order(e){this.node.send(this.cid,"order",e)}async disconnect(){this.node.send(this.cid,"disconnect",null)}emit(e,t){for(var r=arguments.length,n=new Array(r>2?r-2:0),i=2;i<r;i++)n[i-2]=arguments[i];this.socket.emit(e,t,...n)}once(e,t){}}class d{constructor(e,t,r){this.node=e,this.tenantId=t,this.documentId=r}async connect(e,t){return this.node.connect(e,this.tenantId,this.documentId,t)}}class m extends s.EventEmitter{constructor(e,t){super(),this._id=e,this.socket=t,this.connectMap=new Map,this.orderers=new Map,this.topicMap=new Map,this.cid=0,this.socket.on("message",(e=>{switch(e.type){case"op":this.route(e.payload);break;case"connected":const t=this.connectMap.get(e.cid);(0,i.default)(t),this.connectMap.delete(e.cid);const r=new h(t.tenantId,t.documentId,t.socket,this,e.cid,e.payload);this.topicMap.set(`client#${r.clientId}`,[r]);const n=`${t.tenantId}/${t.documentId}`;this.topicMap.has(n)||this.topicMap.set(n,[]),this.topicMap.get(n).push(r),t.deferred.resolve(r)}}))}static async connect(e,t,r){const n=(await t.getDatabase()).collection(r),i=await n.findOne({_id:e}),s=i.expiration>=Date.now()?await l.Socket.connect(i.address,e):null;return new m(e,s)}get id(){return this._id}get valid(){return null!==this.socket}async connectOrderer(e,t){const r=`${e}/${t}`;(0,i.default)(!this.orderers.has(r)),(0,c.debug)(`Connecting to ${r}:${this.id}`),a.Lumberjack.debug(`Connecting to ${r}:${this.id}`);const n=new u.ProxyOrderer(new d(this,e,t));return this.orderers.set(r,n),n}send(e,t,r){this.socket.send({cid:e,payload:r,type:t})}async connect(e,t,r,n){const i=this.getNextCid(),s={client:n,documentId:r,tenantId:t},a=new o.Deferred;return this.connectMap.set(i,{socket:e,deferred:a,tenantId:t,documentId:r}),this.send(i,"connect",s),a.promise}route(e){const t=this.topicMap.get(e.topic);for(const r of t)r.emit(e.op,e.data[0],...e.data.slice(1))}getNextCid(){return this.cid++}}t.RemoteNode=m},UyQ0:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestContext=void 0;const n=r("ZERR"),i=r("hBZP"),s=r("wWog"),o=r("tp/L"),a=r("KndR");t.TestContext=class extends i.EventEmitter{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:a.DebugLogger.create("fluid-server:TestContext");super(),this.log=e,this.offset=-1,this.waits=[];const t=new o.TestEngine1;o.Lumberjack.isSetupCompleted()||o.Lumberjack.setup([t])}checkpoint(e){(0,n.strict)(e.offset>this.offset,`${e.offset} > ${this.offset}`),this.offset=e.offset,this.waits=this.waits.filter((t=>!(t.value<=e.offset&&(t.deferred.resolve(),1))))}error(e,t){this.emit("error",e,t)}async waitForOffset(e){if(e<=this.offset)return;const t=new s.Deferred;return this.waits.push({deferred:t,value:e}),t.promise}getContextError(){}}},VIQa:function(e,t,r){"use strict";r.r(t),r.d(t,"addBlobToTree",(function(){return n.d})),r.d(t,"AttachmentTreeEntry",(function(){return n.a})),r.d(t,"BlobTreeEntry",(function(){return n.b})),r.d(t,"buildHierarchy",(function(){return n.e})),r.d(t,"getGitMode",(function(){return n.f})),r.d(t,"getGitType",(function(){return n.g})),r.d(t,"TreeTreeEntry",(function(){return n.c})),r.d(t,"isSystemMessage",(function(){return d})),r.d(t,"ProtocolOpHandler",(function(){return m})),r.d(t,"Quorum",(function(){return h})),r.d(t,"QuorumClients",(function(){return u})),r.d(t,"QuorumProposals",(function(){return l})),r.d(t,"generateServiceProtocolEntries",(function(){return y})),r.d(t,"getQuorumTreeEntries",(function(){return f})),r.d(t,"mergeAppAndProtocolTree",(function(){return g})),r.d(t,"isServiceMessageType",(function(){return b}));var n=r("jLPl"),i=r("f79D"),s=r("hBZP"),o=r("NgDi"),a=r("he5V");class c{constructor(e,t,r,n){this.sequenceNumber=e,this.key=t,this.value=r,this.local=n}}class u extends o.a{constructor(e){super(),this.isDisposed=!1,this.members=new Map(e),this.snapshotCache=e}get disposed(){return this.isDisposed}snapshot(){var e;return null!==(e=this.snapshotCache)&&void 0!==e||(this.snapshotCache=Array.from(this.members)),this.snapshotCache}addMember(e,t){Object(a.a)(!!e,1135),Object(a.a)(!this.members.has(e),462),this.members.set(e,t),this.emit("addMember",e,t),this.snapshotCache=void 0}removeMember(e){Object(a.a)(!!e,1136),Object(a.a)(this.members.has(e),463),this.members.delete(e),this.emit("removeMember",e),this.snapshotCache=void 0}getMembers(){return new Map(this.members)}getMember(e){return this.members.get(e)}dispose(){this.isDisposed=!0}}class l extends o.a{constructor(e,t){super(),this.sendProposal=t,this.isDisposed=!1,this.stateEvents=new s.EventEmitter,this.proposals=new Map(e.proposals.map((e=>{let[,t]=e;return[t.sequenceNumber,new c(t.sequenceNumber,t.key,t.value,!1)]}))),this.values=new Map(e.values),this.proposalsSnapshotCache=e.proposals,this.valuesSnapshotCache=e.values}get disposed(){return this.isDisposed}snapshot(){var e,t;return null!==(e=this.proposalsSnapshotCache)&&void 0!==e||(this.proposalsSnapshotCache=Array.from(this.proposals).map((e=>{let[t,r]=e;return[t,{sequenceNumber:t,key:r.key,value:r.value},[]]}))),null!==(t=this.valuesSnapshotCache)&&void 0!==t||(this.valuesSnapshotCache=Array.from(this.values)),{proposals:this.proposalsSnapshotCache,values:this.valuesSnapshotCache}}has(e){return this.values.has(e)}get(e){var t;return null===(t=this.values.get(e))||void 0===t?void 0:t.value}getApprovalData(e){return this.values.get(e)}async propose(e,t){const r=this.sendProposal(e,t);if(r<0)throw this.emit("error",{eventName:"ProposalInDisconnectedState",key:e}),new Error("Can't propose in disconnected state");return new Promise(((e,t)=>{let n;const i=(e,t)=>{e===r&&(n=t,this.stateEvents.off("localProposalSequenced",i),this.stateEvents.off("disconnected",o),this.stateEvents.on("localProposalApproved",s))},s=t=>{t===n&&(e(),c())},o=()=>{void 0===n&&this.stateEvents.once("connected",(()=>{void 0===n&&(t(new Error("Client disconnected without successfully sending proposal")),c())}))},a=()=>{t(new Error("QuorumProposals was disposed")),c()},c=()=>{this.stateEvents.off("localProposalSequenced",i),this.stateEvents.off("localProposalApproved",s),this.stateEvents.off("disconnected",o),this.stateEvents.off("disposed",a)};this.stateEvents.on("localProposalSequenced",i),this.stateEvents.on("disconnected",o),this.stateEvents.on("disposed",a)}))}addProposal(e,t,r,n,i){Object(a.a)(!this.proposals.has(r),464);const s=new c(r,e,t,n);this.proposals.set(r,s),this.emit("addProposal",s),n&&this.stateEvents.emit("localProposalSequenced",i,r),this.proposalsSnapshotCache=void 0}updateMinimumSequenceNumber(e){const t=e.minimumSequenceNumber,r=[];for(const[e,n]of this.proposals)e<=t&&r.push(n);r.sort(((e,t)=>e.sequenceNumber-t.sequenceNumber));for(const t of r){const r={approvalSequenceNumber:e.sequenceNumber,commitSequenceNumber:-1,key:t.key,sequenceNumber:t.sequenceNumber,value:t.value};this.values.set(r.key,r),this.valuesSnapshotCache=void 0,this.emit("approveProposal",r.sequenceNumber,r.key,r.value,r.approvalSequenceNumber),this.proposals.delete(t.sequenceNumber),this.proposalsSnapshotCache=void 0,t.local&&this.stateEvents.emit("localProposalApproved",t.sequenceNumber)}}setConnectionState(e){this.stateEvents.emit(e?"connected":"disconnected")}dispose(){this.isDisposed=!0,this.stateEvents.emit("disposed")}}class h extends o.a{constructor(e,t,r,n){super(),this.isDisposed=!1,this.quorumClients=new u(e),this.quorumClients.on("addMember",((e,t)=>{this.emit("addMember",e,t)})),this.quorumClients.on("removeMember",(e=>{this.emit("removeMember",e)})),this.quorumProposals=new l({proposals:t,values:r},n),this.quorumProposals.on("addProposal",(e=>{this.emit("addProposal",e)})),this.quorumProposals.on("approveProposal",((e,t,r,n)=>{this.emit("approveProposal",e,t,r,n)}))}get disposed(){return this.isDisposed}close(){this.removeAllListeners()}snapshot(){const e=this.quorumClients.snapshot(),{proposals:t,values:r}=this.quorumProposals.snapshot();return{members:e,proposals:t,values:r}}has(e){return this.quorumProposals.has(e)}get(e){return this.quorumProposals.get(e)}getApprovalData(e){return this.quorumProposals.getApprovalData(e)}addMember(e,t){this.quorumClients.addMember(e,t)}removeMember(e){this.quorumClients.removeMember(e)}getMembers(){return this.quorumClients.getMembers()}getMember(e){return this.quorumClients.getMember(e)}async propose(e,t){return this.quorumProposals.propose(e,t)}addProposal(e,t,r,n,i){return this.quorumProposals.addProposal(e,t,r,n,i)}updateMinimumSequenceNumber(e){this.quorumProposals.updateMinimumSequenceNumber(e)}setConnectionState(e,t){this.quorumProposals.setConnectionState(e)}dispose(){throw new Error("Not implemented.")}}function d(e){switch(e.type){case i.a.ClientJoin:case i.a.ClientLeave:case i.a.Propose:case i.a.Reject:case i.a.NoOp:case i.a.NoClient:case i.a.Summarize:case i.a.SummaryAck:case i.a.SummaryNack:return!0;default:return!1}}class m{constructor(e,t,r,n,i,s,o){this.minimumSequenceNumber=e,this.sequenceNumber=t,this.term=null!=r?r:1,this._quorum=new h(n,i,s,o)}get quorum(){return this._quorum}get attributes(){return{minimumSequenceNumber:this.minimumSequenceNumber,sequenceNumber:this.sequenceNumber,term:this.term}}setConnectionState(e,t){this._quorum.setConnectionState(e,t)}snapshot(){return this._quorum.snapshot()}close(){this._quorum.close()}processMessage(e,t){if(e.sequenceNumber!==this.sequenceNumber+1)throw new Error(`Protocol state is not moving sequentially. Current is ${this.sequenceNumber}. Next is ${e.sequenceNumber}`);this.sequenceNumber=e.sequenceNumber,this.minimumSequenceNumber=e.minimumSequenceNumber;let r=!1;switch(e.type){case i.a.ClientJoin:const n=e,s=JSON.parse(n.data);this._quorum.addMember(s.clientId,{client:s.detail,sequenceNumber:n.sequenceNumber});break;case i.a.ClientLeave:const o=JSON.parse(e.data);this._quorum.removeMember(o);break;case i.a.Propose:"string"==typeof e.contents&&(e.contents=JSON.parse(e.contents));const a=e.contents;this._quorum.addProposal(a.key,a.value,e.sequenceNumber,t,e.clientSequenceNumber),r=!0}return this._quorum.updateMinimumSequenceNumber(e),{immediateNoOp:r}}getProtocolState(){return Object.assign({sequenceNumber:this.sequenceNumber,minimumSequenceNumber:this.minimumSequenceNumber},this._quorum.snapshot())}}var p=r("l4ds");function f(e,t,r,n,i){const s={minimumSequenceNumber:t,sequenceNumber:r,term:n};return[{mode:p.a.File,path:"quorumMembers",type:p.b.Blob,value:{contents:JSON.stringify(i.members),encoding:"utf-8"}},{mode:p.a.File,path:"quorumProposals",type:p.b.Blob,value:{contents:JSON.stringify(i.proposals),encoding:"utf-8"}},{mode:p.a.File,path:"quorumValues",type:p.b.Blob,value:{contents:JSON.stringify(i.values),encoding:"utf-8"}},{mode:p.a.File,path:"attributes",type:p.b.Blob,value:{contents:JSON.stringify(s),encoding:"utf-8"}}]}function g(e,t){const r=e.tree.filter((e=>!v(e.path))).map((e=>({mode:e.mode,path:e.path,sha:e.sha,type:e.type})));return r.push({mode:p.a.Directory,path:".protocol",sha:t.sha,type:"tree"}),r}function y(e,t){const r=[{mode:p.a.File,path:"deli",type:p.b.Blob,value:{contents:e,encoding:"utf-8"}}];return r.push({mode:p.a.File,path:"scribe",type:p.b.Blob,value:{contents:t,encoding:"utf-8"}}),r}const v=e=>".protocol"===e||".logTail"===e||".serviceProtocol"===e,b=e=>e===i.a.ClientJoin||e===i.a.ClientLeave||e===i.a.Control||e===i.a.NoClient||e===i.a.SummaryAck||e===i.a.SummaryNack},VlQw:function(e,t,r){!function(e){"undefined"==typeof DO_NOT_EXPORT_CRC?e(t):e({})}((function(e){e.version="1.2.0";var t=function(){for(var e=0,t=new Array(256),r=0;256!=r;++r)t[r]=e=1&(e=1&(e=1&(e=1&(e=1&(e=1&(e=1&(e=1&(e=r)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1;return"undefined"!=typeof Int32Array?new Int32Array(t):t}();e.table=t,e.bstr=function(e,r){for(var n=-1^r,i=e.length-1,s=0;s<i;)n=(n=n>>>8^t[255&(n^e.charCodeAt(s++))])>>>8^t[255&(n^e.charCodeAt(s++))];return s===i&&(n=n>>>8^t[255&(n^e.charCodeAt(s))]),-1^n},e.buf=function(e,r){if(e.length>1e4)return function(e,r){for(var n=-1^r,i=e.length-7,s=0;s<i;)n=(n=(n=(n=(n=(n=(n=(n=n>>>8^t[255&(n^e[s++])])>>>8^t[255&(n^e[s++])])>>>8^t[255&(n^e[s++])])>>>8^t[255&(n^e[s++])])>>>8^t[255&(n^e[s++])])>>>8^t[255&(n^e[s++])])>>>8^t[255&(n^e[s++])])>>>8^t[255&(n^e[s++])];for(;s<i+7;)n=n>>>8^t[255&(n^e[s++])];return-1^n}(e,r);for(var n=-1^r,i=e.length-3,s=0;s<i;)n=(n=(n=(n=n>>>8^t[255&(n^e[s++])])>>>8^t[255&(n^e[s++])])>>>8^t[255&(n^e[s++])])>>>8^t[255&(n^e[s++])];for(;s<i+3;)n=n>>>8^t[255&(n^e[s++])];return-1^n},e.str=function(e,r){for(var n,i,s=-1^r,o=0,a=e.length;o<a;)(n=e.charCodeAt(o++))<128?s=s>>>8^t[255&(s^n)]:n<2048?s=(s=s>>>8^t[255&(s^(192|n>>6&31))])>>>8^t[255&(s^(128|63&n))]:n>=55296&&n<57344?(n=64+(1023&n),i=1023&e.charCodeAt(o++),s=(s=(s=(s=s>>>8^t[255&(s^(240|n>>8&7))])>>>8^t[255&(s^(128|n>>2&63))])>>>8^t[255&(s^(128|i>>6&15|(3&n)<<4))])>>>8^t[255&(s^(128|63&i))]):s=(s=(s=s>>>8^t[255&(s^(224|n>>12&15))])>>>8^t[255&(s^(128|n>>6&63))])>>>8^t[255&(s^(128|63&n))];return-1^s}}))},"X+R8":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestDeltaManager=void 0,t.TestDeltaManager=class{async getDeltas(e,t,r,n,i){return[]}async getDeltasFromStorage(e,t,r,n,i,s,o){return[]}async getDeltasFromSummaryAndStorage(e,t,r,n,i){return[]}}},XX9r:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MongoManager=void 0;const n=r("fhs9"),i=r("Q+H3");t.MongoManager=class{constructor(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3,n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.factory=e,this.shouldReconnect=t,this.reconnectDelayMs=r,this.global=n,this.databaseP=this.connect(this.global)}getDatabase(){return this.databaseP}async close(){return(0,i.debug)("Call close connection to Db"),n.Lumberjack.info("Call close connection to Db"),this.shouldReconnect=!1,(await this.databaseP).close()}connect(){const e=this.factory.connect(arguments.length>0&&void 0!==arguments[0]&&arguments[0]).then((e=>(e.on("error",(e=>{(0,i.debug)("DB Error",e),n.Lumberjack.error("DB Error",void 0,e),this.reconnect(this.reconnectDelayMs)})),e.on("close",(e=>{(0,i.debug)("DB Close"),n.Lumberjack.info("DB Close"),this.reconnect(this.reconnectDelayMs)})),e.on("reconnect",(e=>{(0,i.debug)("DB Reconnect"),n.Lumberjack.info("DB Reconnect")})),e.on("reconnectFailed",(e=>{(0,i.debug)("DB Reconnect failed"),n.Lumberjack.error("DB Reconnect failed",void 0,e)})),e)));return e.catch((e=>{(0,i.debug)("DB Connection Error",e),n.Lumberjack.error("DB Connection Error",void 0,e),this.reconnect(this.reconnectDelayMs)})),(0,i.debug)("Successfully connected"),n.Lumberjack.info("Successfully connected to Db"),e}reconnect(e){if(!this.shouldReconnect)return(0,i.debug)("Should not reconnect to Db"),void n.Lumberjack.info("Should not reconnect to Db");this.databaseP=new Promise((t=>{setTimeout((()=>{const e=this.connect();t(e)}),e)}))}}},XbCS:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestHistorian=void 0;const n=r("wWog"),i=r("Twpl"),s=r("Fazr");t.TestHistorian=class{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new s.TestDb({});this.endpoint="",this.blobs=e.collection("blobs"),this.commits=e.collection("commits"),this.trees=e.collection("trees"),this.refs=e.collection("refs")}async getHeader(e){const t=await this.getTree(e,!0),r=[".attributes",".blobs",".messages","header"],n=[];for(const e of t.tree)if("blob"===e.type&&r.reduce(((t,r)=>t||e.path.endsWith(r)),!1)){const t=this.getBlob(e.sha);n.push(t)}return{blobs:await Promise.all(n),tree:t}}async getFullTree(e){throw new Error("Not Supported")}async getBlob(e){var t,r,i,s,o;const a=await this.blobs.findOne({_id:e});return{content:n.IsoBuffer.from(null!==(t=a.content)&&void 0!==t?t:null===(r=a.value)||void 0===r?void 0:r.content,null!==(i=a.encoding)&&void 0!==i?i:null===(s=a.value)||void 0===s?void 0:s.encoding).toString("base64"),encoding:"base64",sha:a._id,size:void 0!==a.content?a.content.length:null===(o=a.value)||void 0===o?void 0:o.content.length,url:""}}async createBlob(e){const t=await(0,n.gitHashFile)(n.IsoBuffer.from(e.content,e.encoding));return await this.blobs.findOrCreate({_id:t},Object.assign(Object.assign({_id:t},e),{value:e})),{sha:t,url:""}}async getContent(e,t){const r=await this.getTree(t,!0);for(const t of r.tree)if(t.path===e)return this.getBlob(t.sha)}async getCommits(e,t){const r=await this.getCommit(e);return r?[{commit:{author:r.author,committer:r.committer,message:r.message,tree:r.tree,url:r.url},parents:r.parents,sha:r.sha,url:r.url}]:[]}async getCommit(e){var t,r,n,i,s;let o=await this.commits.findOne({_id:e});if(!o){const t=await this.getRef(`refs/heads/${e}`);void 0!==t&&(o=await this.commits.findOne({_id:t.object.sha}))}if(o)return{author:{},committer:{},message:null!==(t=o.message)&&void 0!==t?t:null===(r=o.value)||void 0===r?void 0:r.message,parents:void 0!==o.parents?o.parents.map((e=>({sha:e,url:""}))):null===(n=o.value)||void 0===n?void 0:n.parents.map((e=>({sha:e,url:""}))),sha:o._id,tree:{sha:null!==(i=o.tree)&&void 0!==i?i:null===(s=o.value)||void 0===s?void 0:s.tree,url:""},url:""}}async createCommit(e){const t=e.tree;return await this.commits.insertOne(Object.assign(Object.assign({_id:t},e),{value:e})),this.getCommit(t)}async createSummary(e){throw new Error("Not Supported")}async deleteSummary(e){throw new Error("Not Supported")}async getSummary(e){throw new Error("Not Supported")}async getRefs(){throw new Error("Not Supported")}async getRef(e){var t,r,n,i;const s=e.startsWith("refs/")?e.substr(5):e,o=await this.refs.findOne({_id:s});if(o)return{ref:null!==(t=o.ref)&&void 0!==t?t:null===(r=o.value)||void 0===r?void 0:r.ref,url:"",object:{sha:null!==(n=o.sha)&&void 0!==n?n:null===(i=o.value)||void 0===i?void 0:i.sha,url:"",type:""}}}async createRef(e){const t=e.ref.startsWith("refs/")?e.ref.substr(5):e.ref;return await this.refs.insertOne(Object.assign(Object.assign({_id:t},e),{value:e})),this.getRef(e.ref)}async updateRef(e,t){const r=e.startsWith("refs/")?e.substr(5):e;return await(t.force?this.refs.upsert({_id:r},{sha:t.sha,ref:e},{}):this.refs.update({_id:r},{sha:t.sha,ref:e},{})),this.getRef(e)}async deleteRef(e){throw new Error("Not Supported")}async createTag(e){throw new Error("Not Supported")}async getTag(e){throw new Error("Not Supported")}async createTree(e){const t=(0,i.v4)();return await this.trees.insertOne(Object.assign(Object.assign({_id:t},e),{value:e})),this.getTree(t,!1)}async getTree(e,t){return this.getTreeHelper(e,t)}async getTreeHelper(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";var n,i,s;const o=await this.trees.findOne({_id:e});if(o){const e={sha:o._id,url:"",tree:[]};for(const a of null!==(s=null!==(n=o.tree)&&void 0!==n?n:null===(i=o.value)||void 0===i?void 0:i.tree)&&void 0!==s?s:[]){const n=""===r?a.path:`${r}/${a.path}`;if(e.tree.push({mode:a.mode,path:n,sha:a.sha,size:0,type:a.type,url:""}),"tree"===a.type&&t){const r=await this.getTreeHelper(a.sha,t,n);r&&(e.tree=e.tree.concat(r.tree))}}return e}}}},XmJ0:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CombinedProducer=void 0,t.CombinedProducer=class{constructor(e,t){this.producers=e,this.parallel=t}isConnected(){return this.producers.every((e=>e.isConnected()))}async send(e,t,r){if(this.parallel){const n=[];for(const i of this.producers)n.push(i.send(e,t,r));return Promise.all(n)}for(const n of this.producers)await n.send(e,t,r)}async close(){const e=[];for(const t of this.producers)e.push(t.close());await Promise.all(e)}on(e,t){return this}once(e,t){return this}}},Xo3u:function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return i(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ScribeLambda=void 0;const a=o(r("ZERR")),c=r("4+3C"),u=r("y2M+"),l=r("yQiv"),h=r("fhs9"),d=o(r("3YFW")),m=s(r("9va6")),p=r("KMXR"),f=r("pJ2M");t.ScribeLambda=class{constructor(e,t,r,n,i,s,o,a,c,u,l,h,m,p,f){this.context=e,this.tenantId=t,this.documentId=r,this.summaryWriter=n,this.summaryReader=i,this.pendingMessageReader=s,this.checkpointManager=o,this.serviceConfiguration=c,this.producer=u,this.protocolHandler=l,this.term=h,this.protocolHead=m,this.scribeSessionMetric=f,this.pendingCheckpointMessages=new d.default,this.sequenceNumber=0,this.minSequenceNumber=0,this.clearCache=!1,this.closed=!1,this.checkpointInfo={lastCheckpointTime:Date.now(),rawMessagesSinceCheckpoint:0},this.noActiveClients=!1,this.lastOffset=a.logOffset,this.setStateFromCheckpoint(a),this.pendingMessages=new d.default(p)}async handler(e){var t,r,n,i,s,o,m,g;if(e.offset<=this.lastOffset)return this.updateCheckpointMessages(e),void this.context.checkpoint(e);const y=(0,l.extractBoxcar)(e);for(const e of y.contents)if(e.type===l.SequencedOperationType){const l=e;if(this.term&&l.operation.term){if(l.operation.term<this.term)continue;if(l.operation.term>this.term){const e=await this.summaryReader.readLastSummary();if(!e.fromSummary)throw Error("Required summary can't be fetched");this.term=e.term;const t=JSON.parse(e.scribe);this.updateProtocolHead(e.protocolHead),this.protocolHandler=(0,f.initializeProtocol)(t.protocolState,this.term),this.setStateFromCheckpoint(t),this.pendingMessages=new d.default(e.messages.filter((e=>e.sequenceNumber>t.protocolState.sequenceNumber))),this.pendingP=void 0,this.pendingCheckpointScribe=void 0,this.pendingCheckpointOffset=void 0,await this.checkpointManager.delete(t.sequenceNumber+1,!1)}}if(l.operation.sequenceNumber<=this.sequenceNumber)continue;const p=null!==(r=null===(t=this.pendingMessages.peekBack())||void 0===t?void 0:t.sequenceNumber)&&void 0!==r?r:this.protocolHandler.sequenceNumber;if(l.operation.sequenceNumber<=p)continue;if(l.operation.sequenceNumber!==p+1){if(void 0===this.pendingMessageReader)throw new Error(`Invalid message sequence number.Current message @${l.operation.sequenceNumber}.ProtocolHandler @${p}`);{const e=p+1,t=l.operation.sequenceNumber-1,r=await this.pendingMessageReader.readMessages(e,t);for(const e of r)this.pendingMessages.push(e)}}this.pendingMessages.push(l.operation),this.serviceConfiguration.scribe.enablePendingCheckpointMessages&&this.pendingCheckpointMessages.push(l);const y=this.minSequenceNumber!==l.operation.minimumSequenceNumber;if(this.sequenceNumber=l.operation.sequenceNumber,this.minSequenceNumber=l.operation.minimumSequenceNumber,y&&this.processFromPending(this.minSequenceNumber),this.clearCache=!1,l.operation.type!==u.MessageType.Summarize||(null===(n=l.operation.serverMetadata)||void 0===n?void 0:n.deliAcked)){if(l.operation.type===u.MessageType.NoClient){if((0,a.default)(l.operation.referenceSequenceNumber===l.operation.sequenceNumber,`${l.operation.referenceSequenceNumber} != ${l.operation.sequenceNumber}`),(0,a.default)(l.operation.minimumSequenceNumber===l.operation.sequenceNumber,`${l.operation.minimumSequenceNumber} != ${l.operation.sequenceNumber}`),this.noActiveClients=!0,this.serviceConfiguration.scribe.generateServiceSummary){const e=l.operation,t=this.generateScribeCheckpoint(this.lastOffset);try{const r=await this.summaryWriter.writeServiceSummary(e,this.protocolHead,t,this.pendingCheckpointMessages.toArray());if(r){this.serviceConfiguration.scribe.clearCacheAfterServiceSummary&&(this.clearCache=!0),await this.sendSummaryConfirmationMessage(e.sequenceNumber,!1,this.serviceConfiguration.scribe.clearCacheAfterServiceSummary),this.updateLastSummarySequenceNumber(e.sequenceNumber),this.updateValidParentSummaries(r);const t=`Service summary success @${e.sequenceNumber}`;null===(m=this.context.log)||void 0===m||m.info(t,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),h.Lumberjack.info(t,(0,h.getLumberBaseProperties)(this.documentId,this.tenantId))}}catch(t){const r=`Service summary failure @${e.sequenceNumber}`;if(!this.serviceConfiguration.scribe.ignoreStorageException)throw t;null===(g=this.context.log)||void 0===g||g.error(r,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),h.Lumberjack.error(r,(0,h.getLumberBaseProperties)(this.documentId,this.tenantId),t)}}}else if(l.operation.type===u.MessageType.SummaryAck){const e=l.operation,t=e.data?JSON.parse(e.data):e.contents;this.lastClientSummaryHead=t.handle,this.validParentSummaries=void 0,this.summaryWriter.isExternal&&(this.updateProtocolHead(t.summaryProposal.summarySequenceNumber),this.updateLastSummarySequenceNumber(t.summaryProposal.summarySequenceNumber))}}else if(!this.summaryWriter.isExternal||l.operation.referenceSequenceNumber>=this.protocolHandler.sequenceNumber){const e={protocolState:this.protocolHandler.getProtocolState(),pendingOps:this.pendingMessages.toArray()};if(this.processFromPending(l.operation.referenceSequenceNumber),this.protocolHead<this.protocolHandler.sequenceNumber)try{const t=this.generateScribeCheckpoint(this.lastOffset),r=l.operation,n=await this.summaryWriter.writeClientSummary(r,this.lastClientSummaryHead,t,this.pendingCheckpointMessages.toArray());if(!this.summaryWriter.isExternal)if(n.status){await this.sendSummaryAck(n.message),await this.sendSummaryConfirmationMessage(r.sequenceNumber,!0,!1),this.updateProtocolHead(this.protocolHandler.sequenceNumber),this.updateLastSummarySequenceNumber(this.protocolHandler.sequenceNumber);const e=`Client summary success @${l.operation.sequenceNumber}`;null===(i=this.context.log)||void 0===i||i.info(e,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),h.Lumberjack.info(e,(0,h.getLumberBaseProperties)(this.documentId,this.tenantId))}else{const t=n.message;await this.sendSummaryNack(t);const r=`Client summary failure @${l.operation.sequenceNumber}. Error: ${t.message}`;null===(s=this.context.log)||void 0===s||s.error(r,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),h.Lumberjack.error(r,(0,h.getLumberBaseProperties)(this.documentId,this.tenantId)),this.revertProtocolState(e.protocolState,e.pendingOps)}}catch(t){const r=`Client summary failure @${l.operation.sequenceNumber}`;if(null===(o=this.context.log)||void 0===o||o.error(`${r} Exception: ${(0,c.inspect)(t)}`),h.Lumberjack.error(r,(0,h.getLumberBaseProperties)(this.documentId,this.tenantId),t),this.revertProtocolState(e.protocolState,e.pendingOps),!this.serviceConfiguration.scribe.ignoreStorageException)throw t;await this.sendSummaryNack({message:"Failed to summarize the document.",summaryProposal:{summarySequenceNumber:l.operation.sequenceNumber}})}}}if(this.updateCheckpointMessages(e),this.checkpointInfo.rawMessagesSinceCheckpoint++,this.noActiveClients)this.prepareCheckpoint(e,p.CheckpointReason.NoClients),this.noActiveClients=!1;else{const t=this.getCheckpointReason();void 0!==t?this.prepareCheckpoint(e,t):this.updateCheckpointIdleTimer()}}prepareCheckpoint(e,t){var r,n,i,s;const o=this.generateScribeCheckpoint(e.offset);this.updateCheckpointMessages(e),this.checkpoint(t),this.checkpointCore(o,e,this.clearCache),this.lastOffset=e.offset;const a=p.CheckpointReason[t],c=`Writing checkpoint. Reason: ${a}`,u=Object.assign(Object.assign({},(0,h.getLumberBaseProperties)(this.documentId,this.tenantId)),{checkpointReason:a,lastOffset:this.lastOffset,scribeCheckpointOffset:null===(r=this.checkpointInfo.currentCheckpointMessage)||void 0===r?void 0:r.offset,scribeCheckpointPartition:null===(n=this.checkpointInfo.currentCheckpointMessage)||void 0===n?void 0:n.partition,kafkaCheckpointOffset:null===(i=this.checkpointInfo.currentKafkaCheckpointMessage)||void 0===i?void 0:i.offset,kafkaCheckpointPartition:null===(s=this.checkpointInfo.currentKafkaCheckpointMessage)||void 0===s?void 0:s.partition});h.Lumberjack.info(c,u)}close(e){this.logScribeSessionMetrics(e),this.closed=!0,this.protocolHandler.close()}logScribeSessionMetrics(e){var t;(null===(t=this.scribeSessionMetric)||void 0===t?void 0:t.isCompleted())&&(h.Lumberjack.info("Scribe session metric already completed. Creating a new one.",(0,h.getLumberBaseProperties)(this.documentId,this.tenantId)),this.scribeSessionMetric=(0,p.createSessionMetric)(this.tenantId,this.documentId,h.LumberEventName.ScribeSessionResult,this.serviceConfiguration)),(0,p.logCommonSessionEndMetrics)(this.context,e,this.scribeSessionMetric,this.sequenceNumber,this.protocolHead,void 0)}processFromPending(e){for(var t;this.pendingMessages.length>0&&this.pendingMessages.peekFront().sequenceNumber<=e;){const e=this.pendingMessages.shift();try{if(e.contents&&"string"==typeof e.contents&&e.type!==u.MessageType.ClientLeave){const t=m.cloneDeep(e);t.contents=JSON.parse(t.contents),this.protocolHandler.processMessage(t,!1)}else this.protocolHandler.processMessage(e,!1)}catch(e){throw null===(t=this.context.log)||void 0===t||t.error(`Protocol error ${e}`,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),h.Lumberjack.error("Protocol error",(0,h.getLumberBaseProperties)(this.documentId,this.tenantId),e),new Error(`Protocol error ${e} for ${this.documentId} ${this.tenantId}`)}}}revertProtocolState(e,t){this.protocolHandler=(0,f.initializeProtocol)(e,this.term),this.pendingMessages=new d.default(t)}generateScribeCheckpoint(e){const t=this.protocolHandler.getProtocolState();return{lastSummarySequenceNumber:this.lastSummarySequenceNumber,lastClientSummaryHead:this.lastClientSummaryHead,logOffset:e,minimumSequenceNumber:this.minSequenceNumber,protocolState:t,sequenceNumber:this.sequenceNumber,validParentSummaries:this.validParentSummaries}}checkpointCore(e,t,r){if(!this.closed){if(this.pendingP)return this.pendingCheckpointScribe=e,void(this.pendingCheckpointOffset=t);this.pendingP=r?this.checkpointManager.delete(this.protocolHead,!0):this.writeCheckpoint(e),this.pendingP.then((()=>{this.pendingP=void 0,this.context.checkpoint(t);const e=this.pendingCheckpointScribe,n=this.pendingCheckpointOffset;e&&n&&(this.pendingCheckpointScribe=void 0,this.pendingCheckpointOffset=void 0,this.checkpointCore(e,n,r))}),(e=>{h.Lumberjack.error("Checkpoint error",(0,h.getLumberBaseProperties)(this.documentId,this.tenantId),e)}))}}async writeCheckpoint(e){const t=this.pendingCheckpointMessages.toArray();if(await this.checkpointManager.write(e,this.protocolHead,t),t.length>0){const e=t[t.length-1].operation.sequenceNumber;for(;this.pendingCheckpointMessages.length>0&&this.pendingCheckpointMessages.peekFront().operation.sequenceNumber<=e;)this.pendingCheckpointMessages.removeFront()}}updateProtocolHead(e){this.protocolHead=e}updateLastSummarySequenceNumber(e){this.lastSummarySequenceNumber=e}updateValidParentSummaries(e){void 0===this.validParentSummaries&&(this.validParentSummaries=[]),this.validParentSummaries.push(e)}async sendSummaryAck(e){const t={clientSequenceNumber:-1,contents:e,data:JSON.stringify(e),referenceSequenceNumber:-1,traces:this.serviceConfiguration.enableTraces?[]:void 0,type:u.MessageType.SummaryAck};return(0,f.sendToDeli)(this.tenantId,this.documentId,this.producer,t)}async sendSummaryNack(e){const t={clientSequenceNumber:-1,contents:e,data:JSON.stringify(e),referenceSequenceNumber:-1,traces:this.serviceConfiguration.enableTraces?[]:void 0,type:u.MessageType.SummaryNack};return(0,f.sendToDeli)(this.tenantId,this.documentId,this.producer,t)}async sendSummaryConfirmationMessage(e,t,r){const n={clientSequenceNumber:-1,contents:null,data:JSON.stringify({type:l.ControlMessageType.UpdateDSN,contents:{durableSequenceNumber:e,isClientSummary:t,clearCache:r}}),referenceSequenceNumber:-1,traces:this.serviceConfiguration.enableTraces?[]:void 0,type:u.MessageType.Control};return(0,f.sendToDeli)(this.tenantId,this.documentId,this.producer,n)}setStateFromCheckpoint(e){this.sequenceNumber=e.sequenceNumber,this.minSequenceNumber=e.minimumSequenceNumber,this.lastClientSummaryHead=e.lastClientSummaryHead,this.lastSummarySequenceNumber=e.lastSummarySequenceNumber,this.validParentSummaries=e.validParentSummaries}updateCheckpointMessages(e){if(this.checkpointInfo.currentCheckpointMessage=e,this.noActiveClients)this.checkpointInfo.nextKafkaCheckpointMessage=void 0,this.checkpointInfo.currentKafkaCheckpointMessage=e;else{const t=this.checkpointInfo.nextKafkaCheckpointMessage;this.checkpointInfo.nextKafkaCheckpointMessage=e,this.checkpointInfo.currentKafkaCheckpointMessage=t}}getCheckpointReason(){const e=this.serviceConfiguration.scribe.checkpointHeuristics;return e.enable?this.checkpointInfo.rawMessagesSinceCheckpoint>=e.maxMessages?p.CheckpointReason.MaxMessages:Date.now()-this.checkpointInfo.lastCheckpointTime>=e.maxTime?p.CheckpointReason.MaxTime:void 0:p.CheckpointReason.EveryMessage}clearCheckpointIdleTimer(){void 0!==this.checkpointInfo.idleTimer&&(clearTimeout(this.checkpointInfo.idleTimer),this.checkpointInfo.idleTimer=void 0)}checkpoint(e){this.clearCheckpointIdleTimer(),this.checkpointInfo.lastCheckpointTime=Date.now(),this.checkpointInfo.rawMessagesSinceCheckpoint=0}updateCheckpointIdleTimer(){this.clearCheckpointIdleTimer();const e=this.checkpointInfo.currentCheckpointMessage;this.checkpointInfo.idleTimer=setTimeout((()=>{var t,r,n,i;if(this.checkpointInfo.idleTimer=void 0,e===this.checkpointInfo.currentCheckpointMessage&&(this.checkpoint(p.CheckpointReason.IdleTime),e)){this.checkpointCore(this.generateScribeCheckpoint(e.offset),e,this.clearCache);const s="Writing checkpoint. Reason: IdleTime",o=Object.assign(Object.assign({},(0,h.getLumberBaseProperties)(this.documentId,this.tenantId)),{checkpointReason:"IdleTime",lastOffset:e.offset,deliCheckpointOffset:null===(t=this.checkpointInfo.currentCheckpointMessage)||void 0===t?void 0:t.offset,deliCheckpointPartition:null===(r=this.checkpointInfo.currentCheckpointMessage)||void 0===r?void 0:r.partition,kafkaCheckpointOffset:null===(n=this.checkpointInfo.currentKafkaCheckpointMessage)||void 0===n?void 0:n.offset,kafkaCheckpointPartition:null===(i=this.checkpointInfo.currentKafkaCheckpointMessage)||void 0===i?void 0:i.partition});h.Lumberjack.info(s,o)}}),this.serviceConfiguration.scribe.checkpointHeuristics.idleTime)}}},XumM:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestThrottlerHelper=t.TestThrottler=t.TestThrottleAndUsageStorageManager=t.TestTenantManager=t.TestTenant=t.TestTopic=t.TestPublisher=t.TestProducer=t.TestKafka=t.TestConsumer=t.TestHistorian=t.writeSummaryTree=t.TestDocumentStorage=t.TestContext=t.TestDbFactory=t.TestDb=t.TestCollection=t.TestClientManager=t.TestDeltaManager=t.TestCache=t.MessageFactory=t.KafkaMessageFactory=t.DebugLogger=void 0;var n=r("irTb");Object.defineProperty(t,"DebugLogger",{enumerable:!0,get:function(){return n.DebugLogger}});var i=r("B6kT");Object.defineProperty(t,"KafkaMessageFactory",{enumerable:!0,get:function(){return i.KafkaMessageFactory}}),Object.defineProperty(t,"MessageFactory",{enumerable:!0,get:function(){return i.MessageFactory}});var s=r("sM4d");Object.defineProperty(t,"TestCache",{enumerable:!0,get:function(){return s.TestCache}});var o=r("X+R8");Object.defineProperty(t,"TestDeltaManager",{enumerable:!0,get:function(){return o.TestDeltaManager}});var a=r("T+1T");Object.defineProperty(t,"TestClientManager",{enumerable:!0,get:function(){return a.TestClientManager}});var c=r("tRAo");Object.defineProperty(t,"TestCollection",{enumerable:!0,get:function(){return c.TestCollection}}),Object.defineProperty(t,"TestDb",{enumerable:!0,get:function(){return c.TestDb}}),Object.defineProperty(t,"TestDbFactory",{enumerable:!0,get:function(){return c.TestDbFactory}});var u=r("tqCN");Object.defineProperty(t,"TestContext",{enumerable:!0,get:function(){return u.TestContext}});var l=r("urMS");Object.defineProperty(t,"TestDocumentStorage",{enumerable:!0,get:function(){return l.TestDocumentStorage}}),Object.defineProperty(t,"writeSummaryTree",{enumerable:!0,get:function(){return l.writeSummaryTree}});var h=r("hVFe");Object.defineProperty(t,"TestHistorian",{enumerable:!0,get:function(){return h.TestHistorian}});var d=r("M5A3");Object.defineProperty(t,"TestConsumer",{enumerable:!0,get:function(){return d.TestConsumer}}),Object.defineProperty(t,"TestKafka",{enumerable:!0,get:function(){return d.TestKafka}}),Object.defineProperty(t,"TestProducer",{enumerable:!0,get:function(){return d.TestProducer}});var m=r("Mecl");Object.defineProperty(t,"TestPublisher",{enumerable:!0,get:function(){return m.TestPublisher}}),Object.defineProperty(t,"TestTopic",{enumerable:!0,get:function(){return m.TestTopic}});var p=r("Ra6H");Object.defineProperty(t,"TestTenant",{enumerable:!0,get:function(){return p.TestTenant}}),Object.defineProperty(t,"TestTenantManager",{enumerable:!0,get:function(){return p.TestTenantManager}});var f=r("7aOi");Object.defineProperty(t,"TestThrottleAndUsageStorageManager",{enumerable:!0,get:function(){return f.TestThrottleAndUsageStorageManager}});var g=r("gF/g");Object.defineProperty(t,"TestThrottler",{enumerable:!0,get:function(){return g.TestThrottler}});var y=r("Pp5o");Object.defineProperty(t,"TestThrottlerHelper",{enumerable:!0,get:function(){return y.TestThrottlerHelper}})},Y9G6:function(e,t,r){var n=r("wfEq"),i=r("2ozp"),s=r("KSsY"),o=r("pRMk").Buffer,a=new Array(160);function c(){this.init(),this._w=a,s.call(this,128,112)}n(c,i),c.prototype.init=function(){return this._ah=3418070365,this._bh=1654270250,this._ch=2438529370,this._dh=355462360,this._eh=1731405415,this._fh=2394180231,this._gh=3675008525,this._hh=1203062813,this._al=3238371032,this._bl=914150663,this._cl=812702999,this._dl=4144912697,this._el=4290775857,this._fl=1750603025,this._gl=1694076839,this._hl=3204075428,this},c.prototype._hash=function(){var e=o.allocUnsafe(48);function t(t,r,n){e.writeInt32BE(t,n),e.writeInt32BE(r,n+4)}return t(this._ah,this._al,0),t(this._bh,this._bl,8),t(this._ch,this._cl,16),t(this._dh,this._dl,24),t(this._eh,this._el,32),t(this._fh,this._fl,40),e},e.exports=c},"YO7/":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.generateClientId=void 0;const n=r("Twpl");t.generateClientId=()=>(0,n.v4)()},YczK:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ForemanLambdaFactory=void 0;const n=r("hBZP"),i=r("EwxO");t.ForemanLambdaFactory=class extends n.EventEmitter{constructor(e,t,r,n){super(),this.messageSender=e,this.tenantManager=t,this.tokenGenerator=r,this.permissions=n,this.messageSender.on("error",(e=>{this.emit("error",e)}))}async create(e,t){return new i.ForemanLambda(this.messageSender,this.tenantManager,this.tokenGenerator,this.permissions,t,e.tenantId,e.documentId)}async dispose(){await this.messageSender.close()}}},YkJt:function(e,t,r){"use strict";r.r(t),r.d(t,"generateToken",(function(){return d})),r.d(t,"generateUser",(function(){return m})),r.d(t,"validateTokenClaims",(function(){return l})),r.d(t,"validateTokenClaimsExpiration",(function(){return h})),r.d(t,"convertSortedNumberArrayToRanges",(function(){return p})),r.d(t,"CorrelationIdHeaderName",(function(){return f})),r.d(t,"DriverVersionHeaderName",(function(){return g})),r.d(t,"LatestSummaryId",(function(){return y})),r.d(t,"createFluidServiceNetworkError",(function(){return c})),r.d(t,"isNetworkError",(function(){return a})),r.d(t,"NetworkError",(function(){return o})),r.d(t,"throwFluidServiceNetworkError",(function(){return u})),r.d(t,"choose",(function(){return w})),r.d(t,"getRandomName",(function(){return S})),r.d(t,"GitManager",(function(){return P})),r.d(t,"getAuthorizationTokenFromCredentials",(function(){return j})),r.d(t,"Historian",(function(){return q})),r.d(t,"promiseTimeout",(function(){return B})),r.d(t,"RestLessClient",(function(){return V})),r.d(t,"RestLessFieldNames",(function(){return _})),r.d(t,"BasicRestWrapper",(function(){return F})),r.d(t,"RestWrapper",(function(){return D})),r.d(t,"defaultHash",(function(){return U})),r.d(t,"getNextHash",(function(){return W})),r.d(t,"canRead",(function(){return G})),r.d(t,"canSummarize",(function(){return Q})),r.d(t,"canWrite",(function(){return z})),r.d(t,"canRevokeToken",(function(){return X})),r.d(t,"buildTreePath",(function(){return te})),r.d(t,"convertSummaryTreeToWholeSummaryTree",(function(){return re})),r.d(t,"convertWholeFlatSummaryToSnapshotTreeAndBlobs",(function(){return ie})),r.d(t,"SummaryTreeUploadManager",(function(){return oe})),r.d(t,"getOrCreateRepository",(function(){return ae})),r.d(t,"getRandomInt",(function(){return ce})),r.d(t,"WholeSummaryUploadManager",(function(){return ue}));var n=r("jSVn"),i=r("UNwp"),s=r("A3AF");class o extends Error{constructor(e,t,r,n,i){super(t),this.code=e,this.canRetry=r,this.isFatal=n,this.retryAfterMs=i,this.name="NetworkError",this.retryAfter=void 0!==i?i/1e3:void 0}get details(){return void 0===this.canRetry&&void 0===this.isFatal&&void 0===this.retryAfterMs?this.message:{message:this.message,canRetry:this.canRetry,isFatal:this.isFatal,retryAfter:this.retryAfter,retryAfterMs:this.retryAfterMs}}toJSON(){return{code:this.code,message:this.message,canRetry:this.canRetry,isFatal:this.isFatal,retryAfterMs:this.retryAfterMs,retryAfter:this.retryAfter}}}function a(e){return"NetworkError"===e.name&&"number"==typeof e.code&&"string"==typeof e.message}function c(e,t){var r;let n,i,s,a;switch(t&&"object"==typeof t?(n=null!==(r=t.message)&&void 0!==r?r:"Unknown Error",i=t.canRetry,s=t.isFatal,a=t.retryAfter):n=t&&"string"==typeof t?t:"Unknown Error",e){case 401:case 403:case 404:return new o(e,n,!1,!1);case 413:case 422:return new o(e,n,null!=i&&i,null!=s&&s,i?a:void 0);case 429:return new o(e,n,!0,!1,a);case 500:return new o(e,n,null==i||i,null!=s&&s,i?a:void 0);case 502:case 503:case 504:return new o(e,n,!0,!1,a);default:return new o(e,n,!1,!0)}}function u(e,t){throw c(e,t)}function l(e,t,r){if("string"!=typeof e)throw new o(403,"Token must be a string. Received: "+typeof e);const n=Object(i.a)(e);if(!n||n.documentId!==t||n.tenantId!==r)throw new o(403,"DocumentId and/or TenantId in token claims do not match requested resource");if(void 0===n.scopes||0===n.scopes.length)throw new o(403,"Missing scopes in token claims");return n}function h(e,t){if(!e.exp||!e.iat||e.exp-e.iat>t)throw new o(403,"Invalid token expiry");const r=1e3*e.exp-(new Date).getTime();if(r<0)throw new o(401,"Expired token");return r}function d(e,t,r,i,o){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:3600,c=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"1.0",u=o||m();""!==u.id&&void 0!==u.id||(u=m());const l=Math.round((new Date).getTime()/1e3),h={documentId:t,scopes:i,tenantId:e,user:u,iat:l,exp:l+a,ver:c,jti:Object(s.a)()},d={utf8:r};return n.KJUR.jws.JWS.sign(null,JSON.stringify({alg:"HS256",typ:"JWT"}),h,d)}function m(){return{id:Object(s.a)(),name:Object(s.a)()}}function p(e){const t=[];if(!(null==e?void 0:e.length))return t;let r=e[0],n=e[0];for(let i=1;i<e.length;i++){const s=e[i];s-n!=1?(t.push([r,n]),r=s,n=s):n=s}return t.push([r,n]),t}const f="x-correlation-id",g="x-driver-version",y="latest";var v=r("vuat"),b=r.n(v);function S(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"_",t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],[r,n]=b()().split(" ");return t||(r=r.toLowerCase(),n=n.toLowerCase()),`${r}${e}${n}`}const w=()=>S();var C=r("he5V"),E=r("oEwc"),I=r("l4ds"),T=r("Gstq");const N=Object(T.debug)("fluid:services-client");N("Package: @fluidframework/server-services-client - Version: 0.1040.1000");class P{constructor(e){this.historian=e,this.blobCache=new Map,this.commitCache=new Map,this.treeCache=new Map,this.refCache=new Map}async getHeader(e,t){const r=await this.historian.getHeader(t);for(const e of r.blobs)this.blobCache.set(e.sha,e);return Object(E.e)(r.tree)}async getFullTree(e){return this.historian.getFullTree(e)}async getCommit(e){return this.commitCache.has(e)?(N(`Cache hit on ${e}`),this.commitCache.get(e)):this.historian.getCommit(e)}async getCommits(e,t){let r=e;if(this.refCache.has(e)&&(N(`Commit cache hit on ${e}`),r=this.refCache.get(e),this.refCache.delete(e),!r))return[];if(this.commitCache.has(r)){const e=this.commitCache.get(r);return[{commit:{author:e.author,committer:e.committer,message:e.message,tree:e.tree,url:e.url},parents:e.parents,sha:e.sha,url:e.url}]}return this.historian.getCommits(r,t)}async getTree(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this.treeCache.has(e)?(N(`Tree cache hit on ${e}`),this.treeCache.get(e)):this.historian.getTree(e,t)}async getBlob(e){return this.blobCache.has(e)?(N(`Blob cache hit on ${e}`),this.blobCache.get(e)):this.historian.getBlob(e)}getRawUrl(e){return`${this.historian.endpoint}/git/blobs/raw/${e}`}async getContent(e,t){return this.historian.getContent(t,e)}async createBlob(e,t){return this.historian.createBlob({content:e,encoding:t})}async createGitTree(e){return this.historian.createTree(e)}async createTree(e){return this.createTreeCore(e,0)}async createCommit(e){return this.historian.createCommit(e)}async createSummary(e){return this.historian.createSummary(e,arguments.length>1&&void 0!==arguments[1]&&arguments[1])}async deleteSummary(e){return this.historian.deleteSummary(e)}async getSummary(e){return this.historian.getSummary(e)}async getRef(e){return this.historian.getRef(`heads/${e}`).catch((e=>{if(400===e||404===e)return null;throw e}))}async createRef(e,t){return this.historian.createRef({ref:`refs/heads/${e}`,sha:t,config:{enabled:!0}})}async upsertRef(e,t){return this.historian.updateRef(`heads/${e}`,{force:!0,sha:t,config:{enabled:!0}})}addRef(e,t){this.refCache.set(e,t)}addCommit(e){this.commitCache.set(e.sha,e)}addTree(e){this.treeCache.set(e.sha,e)}addBlob(e){this.blobCache.set(e.sha,e)}async write(e,t,r,n){const i=await this.createTree(t),s={author:{date:(new Date).toISOString(),email:"kurtb@microsoft.com",name:"Kurt Berglund"},message:n,parents:r,tree:i.sha},o=await this.historian.createCommit(s),a=await this.getRef(e);return await(a?this.upsertRef(e,o.sha):this.createRef(e,o.sha)),o}async createTreeCore(e,t){if(e.id)return this.getTree(e.id);const r=[];for(const n of e.entries)switch(I.b[n.type]){case I.b.Blob:{const e=n.value;n.mode===I.a.Symlink&&(e.contents=this.translateSymlink(e.contents,t));const i=this.createBlob(e.contents,e.encoding);r.push(i);break}case I.b.Tree:{const e=this.createTreeCore(n.value,t+1);r.push(e);break}default:throw new Error("Unknown entry type")}const n=await Promise.all(r),i=[];Object(C.a)(n.length===e.entries.length,"File entries length is not correct");for(let t=0;t<e.entries.length;t++)i.push({mode:e.entries[t].mode,path:e.entries[t].path,sha:n[t].sha,type:e.entries[t].type===I.b.Tree?"tree":e.entries[t].type===I.b.Blob?"blob":"commit"});return this.historian.createTree({tree:i})}translateSymlink(e,t){let r="";for(let e=0;e<=t;e++)r+="../";return`${r}${e}`}}var x=r("nCVa"),O=r("UKnr"),M=r("a0Z+"),k=r.n(M),L=r("czhI"),R=r.n(L);class D{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1048576e3,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1048576e3;this.baseurl=e,this.defaultQueryString=t,this.maxBodyLength=r,this.maxContentLength=n}async get(e,t,r){const n={baseURL:this.baseurl,headers:r,maxBodyLength:this.maxBodyLength,maxContentLength:this.maxContentLength,method:"GET",url:`${e}${this.generateQueryString(t)}`};return this.request(n,200)}async post(e,t,r,n){const i={baseURL:this.baseurl,data:t,headers:n,maxBodyLength:this.maxBodyLength,maxContentLength:this.maxContentLength,method:"POST",url:`${e}${this.generateQueryString(r)}`};return this.request(i,201)}async delete(e,t,r){const n={baseURL:this.baseurl,headers:r,maxBodyLength:this.maxBodyLength,maxContentLength:this.maxContentLength,method:"DELETE",url:`${e}${this.generateQueryString(t)}`};return this.request(n,204)}async patch(e,t,r,n){const i={baseURL:this.baseurl,data:t,headers:n,maxBodyLength:this.maxBodyLength,maxContentLength:this.maxContentLength,method:"PATCH",url:`${e}${this.generateQueryString(r)}`};return this.request(i,200)}generateQueryString(e){if(this.defaultQueryString||e){const t=Object.assign(Object.assign({},this.defaultQueryString),e),r=O.stringify(t);if(""!==r)return`?${r}`}return""}}class F extends D{constructor(e){let t=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:R.a,n=arguments.length>6?arguments[6]:void 0,i=arguments.length>7?arguments[7]:void 0,s=arguments.length>8?arguments[8]:void 0;super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},arguments.length>2&&void 0!==arguments[2]?arguments[2]:1048576e3,arguments.length>3&&void 0!==arguments[3]?arguments[3]:1048576e3),this.defaultHeaders=t,this.axios=r,this.refreshDefaultQueryString=n,this.refreshDefaultHeaders=i,this.getCorrelationId=s}async request(e,t){let r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];var n,i;const o=Object.assign({},e);return o.headers=this.generateHeaders(o.headers,null!==(i=null===(n=this.getCorrelationId)||void 0===n?void 0:n.call(this))&&void 0!==i?i:Object(s.a)()),new Promise(((n,i)=>{this.axios.request(o).then((e=>{n(e.data)})).catch((s=>{var a,u,l,h,d,m,p,g,y,v,b,S,w,C;if((null===(a=null==s?void 0:s.response)||void 0===a?void 0:a.status)===t&&n(null===(u=null==s?void 0:s.response)||void 0===u?void 0:u.data),N((null==s?void 0:s.config)?`[${s.config.method}] request to [${null!==(l=s.config.baseURL)&&void 0!==l?l:""}${null!==(h=s.config.url)&&void 0!==h?h:""}] failed with [${null===(d=s.response)||void 0===d?void 0:d.status}] [${k()(null===(m=s.response)||void 0===m?void 0:m.data,void 0,2)}]`:`request to ${o.url} failed ${s?s.message:""}`),429===(null===(p=null==s?void 0:s.response)||void 0===p?void 0:p.status)&&(null===(y=null===(g=null==s?void 0:s.response)||void 0===g?void 0:g.data)||void 0===y?void 0:y.retryAfter)>0&&r)setTimeout((()=>{this.request(o,t).then(n).catch(i)}),1e3*s.response.data.retryAfter);else if(401===(null===(v=null==s?void 0:s.response)||void 0===v?void 0:v.status)&&r&&this.refreshOnAuthError()){const r=Object.assign({},e);r.headers=this.generateHeaders(r.headers,o.headers[f]),this.request(r,t,!1).then(n).catch(i)}else if(null==s?void 0:s.response)i(c(null===(b=null==s?void 0:s.response)||void 0===b?void 0:b.status,null===(S=null==s?void 0:s.response)||void 0===S?void 0:S.data));else if(null==s?void 0:s.request)i(c(502,`Network Error: ${null!==(w=null==s?void 0:s.message)&&void 0!==w?w:"undefined"}`));else{const e={canRetry:!1,isFatal:!1,message:null!==(C=null==s?void 0:s.message)&&void 0!==C?C:"Unknown Error"};i(c(500,e))}}))}))}generateHeaders(e,t){let r=null!=e?e:{};return this.defaultHeaders&&(r=Object.assign(Object.assign({},this.defaultHeaders),e)),r[f]?r:Object.assign({[f]:t},r)}refreshOnAuthError(){return(void 0!==this.refreshDefaultQueryString||void 0!==this.refreshDefaultHeaders)&&(void 0!==this.refreshDefaultHeaders&&(this.defaultHeaders=this.refreshDefaultHeaders()),void 0!==this.refreshDefaultQueryString&&(this.defaultQueryString=this.refreshDefaultQueryString()),!0)}}function A(e,t){for(const r of t)if(e.endsWith(r))return!0;return!1}const j=e=>`Basic ${Object(x.b)(`${e.user}:${e.password}`)}`;class q{constructor(e,t,r,n){this.endpoint=e,this.historianApi=t,this.restWrapper=n,this.defaultQueryString={},r&&this.historianApi?(this.defaultQueryString.disableCache=r,this.cacheBust=!1):this.cacheBust=r,void 0===this.restWrapper&&(this.restWrapper=new F(this.endpoint))}async getHeader(e){return this.historianApi?this.restWrapper.get(`/headers/${encodeURIComponent(e)}`,this.getQueryString()):this.getHeaderDirect(e)}async getFullTree(e){return this.restWrapper.get(`/tree/${encodeURIComponent(e)}`,this.getQueryString())}async getBlob(e){return this.restWrapper.get(`/git/blobs/${encodeURIComponent(e)}`,this.getQueryString())}async createBlob(e){return this.restWrapper.post("/git/blobs",e,this.getQueryString())}async getContent(e,t){return this.restWrapper.get(`/contents/${e}`,this.getQueryString({ref:t}))}async getCommits(e,t){return this.restWrapper.get("/commits",this.getQueryString({count:t,sha:e})).catch((e=>400===e||404===e?[]:Promise.reject(e)))}async getCommit(e){return this.restWrapper.get(`/git/commits/${encodeURIComponent(e)}`,this.getQueryString())}async createCommit(e){return this.restWrapper.post("/git/commits",e,this.getQueryString())}async getRefs(){return this.restWrapper.get("/git/refs",this.getQueryString())}async getRef(e){return this.restWrapper.get(`/git/refs/${e}`,this.getQueryString())}async createRef(e){return this.restWrapper.post("/git/refs",e,this.getQueryString())}async updateRef(e,t){return this.restWrapper.patch(`/git/refs/${e}`,t,this.getQueryString())}async deleteRef(e){await this.restWrapper.delete(`/git/refs/${e}`,this.getQueryString())}async createTag(e){return this.restWrapper.post("/git/tags",e,this.getQueryString())}async getTag(e){return this.restWrapper.get(`/git/tags/${e}`,this.getQueryString())}async createTree(e){return this.restWrapper.post("/git/trees",e,this.getQueryString())}async getTree(e,t){return this.restWrapper.get(`/git/trees/${encodeURIComponent(e)}`,this.getQueryString({recursive:t?1:0}))}async createSummary(e,t){return this.restWrapper.post("/git/summaries",e,this.getQueryString(void 0!==t?{initial:t}:void 0))}async deleteSummary(e){const t={"Soft-Delete":e};return this.restWrapper.delete("/git/summaries",this.getQueryString(),t)}async getSummary(e){return this.restWrapper.get(`/git/summaries/${e}`,this.getQueryString())}async getHeaderDirect(e){const t=await this.getTree(e,!0),r=[".attributes",".blobs",".messages","header"],n=[];for(const e of t.tree)if("blob"===e.type&&A(e.path,r)){const t=this.getBlob(e.sha);n.push(t)}return{blobs:await Promise.all(n),tree:t}}getQueryString(e){return Object.assign(Object.assign(this.cacheBust?{cacheBust:Date.now()}:{},this.defaultQueryString),e)}}async function B(e,t){const r=new Promise(((t,r)=>{const n=setTimeout((()=>{clearTimeout(n),r(new Error(`Timed out in ${e} milliseconds.`))}),e)}));return Promise.race([t,r])}var _;!function(e){e.Method="method",e.Header="header",e.Body="body"}(_||(_={}));const H=(e,t)=>`${e}: ${t}`;class V{translate(e){var t,r;const n=Object.assign({},e),i=new URLSearchParams;if(i.append(_.Method,null!==(t=n.method)&&void 0!==t?t:"GET"),n.headers)for(const[e,t]of Object.entries(n.headers)){const r=H(e,t);i.append(_.Header,r)}if(n.data&&["post","put","patch"].includes(null===(r=n.method)||void 0===r?void 0:r.toLowerCase())){const e=JSON.stringify(n.data);i.append(_.Body,e)}return n.data=i.toString(),n.method="POST",n.headers={"Content-Type":"application/x-www-form-urlencoded;restless"},n}}var $=r("VlQw");const U="00000000",K=["clientId","sequenceNumber","minimumSequenceNumber","clientSequenceNumber","referenceSequenceNumber","type","timestamp","data"];function W(e,t){const r=JSON.stringify(e,K);return Object($.str)(r,parseInt(t,16)).toString(16)}var J=r("XPga");const G=e=>e.includes(J.a.DocRead),z=e=>e.includes(J.a.DocWrite),Q=e=>e.includes(J.a.SummaryWrite),X=e=>e.includes("token:revoke");var Z=r("Xou4"),Y=r("7/yF"),ee=r("HJ7Z");const te=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.map((e=>e.replace(/^\//,"").replace(/\/$/,""))).filter((e=>!!e)).join("/")};function re(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";const i={type:"tree",entries:[]},s=Object.keys(t.tree);for(const o of s){const s=t.tree[o];let a,c,u;const l=te(""===r?n:r,o);switch(s.type){case ee.a.Tree:c=re(e,s,l,n),u=s.unreferenced||void 0;break;case ee.a.Blob:c="string"==typeof s.content?{type:"blob",content:s.content,encoding:"utf-8"}:{type:"blob",content:Object(Z.b)(s.content,"base64"),encoding:"base64"};break;case ee.a.Handle:if(s.embedded)a=s.handle;else{if(!e)throw Error("Parent summary does not exist to reference by handle.");a=te(e,n,s.handle)}break;case ee.a.Attachment:a=s.id;break;default:Object(Y.a)(s,`Unknown type: ${s.type}`)}const h={path:encodeURIComponent(o),type:Object(E.g)(s)};let d;if(c)Object(C.a)(void 0===a,173),d=Object.assign({value:c,unreferenced:u},h);else{if(!a)throw new Error(`Invalid tree entry for ${s.type}`);d=Object.assign(Object.assign({},h),{id:a})}i.entries.push(d)}return i}function ne(e,t){const r={},n={id:e.id,blobs:{},trees:{}};r[""]=n;for(const n of e.entries){const e=n.path.replace(new RegExp(`^${t}/`),""),i=e.lastIndexOf("/"),s=e.slice(0,Math.max(0,i)),o=e.slice(i+1),a=r[s];if("tree"===n.type){const t={blobs:{},trees:{},unreferenced:n.unreferenced};a.trees[decodeURIComponent(o)]=t,r[e]=t}else{if("blob"!==n.type)throw new Error("Unknown entry type!!");a.blobs[decodeURIComponent(o)]=n.id}}return n}function ie(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:".app";var r;const n=new Map;e.blobs&&e.blobs.forEach((e=>{var t;n.set(e.id,Object(Z.e)(e.content,null!==(t=e.encoding)&&void 0!==t?t:"utf-8"))}));const i=null===(r=e.trees)||void 0===r?void 0:r[0],s=null==i?void 0:i.sequenceNumber,o=ne(i,t);return{blobs:n,snapshotTree:o,sequenceNumber:s}}var se=r("5zuf");class oe{constructor(e,t,r){this.manager=e,this.blobsShaCache=t,this.getPreviousFullSnapshot=r}async writeSummaryTree(e,t,r,n,i){const s=await this.getPreviousFullSnapshot(t);return this.writeSummaryTreeCore(e,null!=s?s:void 0)}async writeSummaryTreeCore(e,t){const r=await Promise.all(Object.keys(e.tree).map((async r=>{const n=e.tree[r],i=await this.writeSummaryTreeObject(n,t);return{mode:Object(E.f)(n),path:encodeURIComponent(r),sha:i,type:Object(E.g)(n)}})));return(await this.manager.createGitTree({tree:r})).sha}async writeSummaryTreeObject(e,t){switch(e.type){case ee.a.Blob:return this.writeSummaryBlob(e.content);case ee.a.Handle:if(void 0===t)throw Error("Parent summary does not exist to reference by handle.");return this.getIdFromPath(e.handleType,e.handle,t);case ee.a.Tree:return this.writeSummaryTreeCore(e,t);case ee.a.Attachment:return e.id;default:Object(Y.a)(e,`Unknown type: ${e.type}`)}}async writeSummaryBlob(e){const{parsedContent:t,encoding:r}="string"==typeof e?{parsedContent:e,encoding:"utf-8"}:{parsedContent:Object(Z.b)(e,"base64"),encoding:"base64"},n=await Object(se.a)(Z.a.from(t,r));if(!this.blobsShaCache.has(n)){this.blobsShaCache.set(n,"");const e=await this.manager.createBlob(t,r);Object(C.a)(n===e.sha,182)}return n}getIdFromPath(e,t,r){const n=t.split("/").map((e=>decodeURIComponent(e)));return""===n[0]&&n.shift(),0===n.length?r.id:this.getIdFromPathCore(e,n,r)}getIdFromPathCore(e,t,r){var n;Object(C.a)(t.length>0,179);const i=t[0];if(1===t.length)switch(e){case ee.a.Blob:{const e=r.blobs[i];return Object(C.a)(!!e,180),e}case ee.a.Tree:{const e=null===(n=r.trees[i])||void 0===n?void 0:n.id;return Object(C.a)(!!e,181),e}default:throw Error(`Unexpected handle summary object type: "${e}".`)}return this.getIdFromPathCore(e,t.slice(1),r.trees[i])}}async function ae(e,t,r,n){console.log(`Get Repo: ${e}/${t}/${r}`);const i=await R.a.get(`${e}/repos/${t}/${r}`,{headers:n}).catch((e=>{if(e.response&&400===e.response.status)return null;throw e}));if(!i||400===i.status){console.log(`Create Repo: ${e}/${t}/${r}`);const i={name:r};await R.a.post(`${e}/${t}/repos`,i,{headers:n})}}const ce=e=>Math.floor(Math.random()*e);class ue{constructor(e){this.manager=e}async writeSummaryTree(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const s=await this.writeSummaryTreeCore(t,e,r,n,i);if(!s)throw new Error("Failed to write summary tree");return s}async writeSummaryTreeCore(e,t,r,n,i){const s=re(e,t,"","channel"===r?".app":"");return this.manager.createSummary({entries:s.entries,message:void 0,sequenceNumber:n,type:r},i).then((e=>e.id))}}},ZERR:function(e,t,r){"use strict";(function(t){var n=r("IL7q");function i(e,t){if(e===t)return 0;for(var r=e.length,n=t.length,i=0,s=Math.min(r,n);i<s;++i)if(e[i]!==t[i]){r=e[i],n=t[i];break}return r<n?-1:n<r?1:0}function s(e){return t.Buffer&&"function"==typeof t.Buffer.isBuffer?t.Buffer.isBuffer(e):!(null==e||!e._isBuffer)}var o=r("4+3C"),a=Object.prototype.hasOwnProperty,c=Array.prototype.slice,u=function(){return"foo"===function(){}.name}();function l(e){return Object.prototype.toString.call(e)}function h(e){return!s(e)&&"function"==typeof t.ArrayBuffer&&("function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(e):!!e&&(e instanceof DataView||!!(e.buffer&&e.buffer instanceof ArrayBuffer)))}var d=e.exports=v,m=/\s*function\s+([^\(\s]*)\s*/;function p(e){if(o.isFunction(e)){if(u)return e.name;var t=e.toString().match(m);return t&&t[1]}}function f(e,t){return"string"==typeof e?e.length<t?e:e.slice(0,t):e}function g(e){if(u||!o.isFunction(e))return o.inspect(e);var t=p(e);return"[Function"+(t?": "+t:"")+"]"}function y(e,t,r,n,i){throw new d.AssertionError({message:r,actual:e,expected:t,operator:n,stackStartFunction:i})}function v(e,t){e||y(e,!0,t,"==",d.ok)}function b(e,t,r,n){if(e===t)return!0;if(s(e)&&s(t))return 0===i(e,t);if(o.isDate(e)&&o.isDate(t))return e.getTime()===t.getTime();if(o.isRegExp(e)&&o.isRegExp(t))return e.source===t.source&&e.global===t.global&&e.multiline===t.multiline&&e.lastIndex===t.lastIndex&&e.ignoreCase===t.ignoreCase;if(null!==e&&"object"==typeof e||null!==t&&"object"==typeof t){if(h(e)&&h(t)&&l(e)===l(t)&&!(e instanceof Float32Array||e instanceof Float64Array))return 0===i(new Uint8Array(e.buffer),new Uint8Array(t.buffer));if(s(e)!==s(t))return!1;var a=(n=n||{actual:[],expected:[]}).actual.indexOf(e);return-1!==a&&a===n.expected.indexOf(t)||(n.actual.push(e),n.expected.push(t),function(e,t,r,n){if(null==e||null==t)return!1;if(o.isPrimitive(e)||o.isPrimitive(t))return e===t;if(r&&Object.getPrototypeOf(e)!==Object.getPrototypeOf(t))return!1;var i=S(e),s=S(t);if(i&&!s||!i&&s)return!1;if(i)return b(e=c.call(e),t=c.call(t),r);var a,u,l=E(e),h=E(t);if(l.length!==h.length)return!1;for(l.sort(),h.sort(),u=l.length-1;u>=0;u--)if(l[u]!==h[u])return!1;for(u=l.length-1;u>=0;u--)if(!b(e[a=l[u]],t[a],r,n))return!1;return!0}(e,t,r,n))}return r?e===t:e==t}function S(e){return"[object Arguments]"==Object.prototype.toString.call(e)}function w(e,t){if(!e||!t)return!1;if("[object RegExp]"==Object.prototype.toString.call(t))return t.test(e);try{if(e instanceof t)return!0}catch(e){}return!Error.isPrototypeOf(t)&&!0===t.call({},e)}function C(e,t,r,n){var i;if("function"!=typeof t)throw new TypeError('"block" argument must be a function');"string"==typeof r&&(n=r,r=null),i=function(e){var t;try{e()}catch(e){t=e}return t}(t),n=(r&&r.name?" ("+r.name+").":".")+(n?" "+n:"."),e&&!i&&y(i,r,"Missing expected exception"+n);var s="string"==typeof n,a=!e&&i&&!r;if((!e&&o.isError(i)&&s&&w(i,r)||a)&&y(i,r,"Got unwanted exception"+n),e&&i&&r&&!w(i,r)||!e&&i)throw i}d.AssertionError=function(e){this.name="AssertionError",this.actual=e.actual,this.expected=e.expected,this.operator=e.operator,e.message?(this.message=e.message,this.generatedMessage=!1):(this.message=function(e){return f(g(e.actual),128)+" "+e.operator+" "+f(g(e.expected),128)}(this),this.generatedMessage=!0);var t=e.stackStartFunction||y;if(Error.captureStackTrace)Error.captureStackTrace(this,t);else{var r=new Error;if(r.stack){var n=r.stack,i=p(t),s=n.indexOf("\n"+i);if(s>=0){var o=n.indexOf("\n",s+1);n=n.substring(o+1)}this.stack=n}}},o.inherits(d.AssertionError,Error),d.fail=y,d.ok=v,d.equal=function(e,t,r){e!=t&&y(e,t,r,"==",d.equal)},d.notEqual=function(e,t,r){e==t&&y(e,t,r,"!=",d.notEqual)},d.deepEqual=function(e,t,r){b(e,t,!1)||y(e,t,r,"deepEqual",d.deepEqual)},d.deepStrictEqual=function(e,t,r){b(e,t,!0)||y(e,t,r,"deepStrictEqual",d.deepStrictEqual)},d.notDeepEqual=function(e,t,r){b(e,t,!1)&&y(e,t,r,"notDeepEqual",d.notDeepEqual)},d.notDeepStrictEqual=function e(t,r,n){b(t,r,!0)&&y(t,r,n,"notDeepStrictEqual",e)},d.strictEqual=function(e,t,r){e!==t&&y(e,t,r,"===",d.strictEqual)},d.notStrictEqual=function(e,t,r){e===t&&y(e,t,r,"!==",d.notStrictEqual)},d.throws=function(e,t,r){C(!0,e,t,r)},d.doesNotThrow=function(e,t,r){C(!1,e,t,r)},d.ifError=function(e){if(e)throw e},d.strict=n((function e(t,r){t||y(t,!0,r,"==",e)}),d,{equal:d.strictEqual,deepEqual:d.deepStrictEqual,notEqual:d.notStrictEqual,notDeepEqual:d.notDeepStrictEqual}),d.strict.strict=d.strict;var E=Object.keys||function(e){var t=[];for(var r in e)a.call(e,r)&&t.push(r);return t}}).call(this,r("pCvA"))},ZjQw:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ForemanLambdaFactory=t.ForemanLambda=void 0;var n=r("l8a6");Object.defineProperty(t,"ForemanLambda",{enumerable:!0,get:function(){return n.ForemanLambda}});var i=r("FkTQ");Object.defineProperty(t,"ForemanLambdaFactory",{enumerable:!0,get:function(){return i.ForemanLambdaFactory}})},"a0Z+":function(e,t){function r(e,t){var r=[],n=[];return null==t&&(t=function(e,t){return r[0]===t?"[Circular ~]":"[Circular ~."+n.slice(0,r.indexOf(t)).join(".")+"]"}),function(i,s){if(r.length>0){var o=r.indexOf(this);~o?r.splice(o+1):r.push(this),~o?n.splice(o,1/0,i):n.push(i),~r.indexOf(s)&&(s=t.call(this,i,s))}else r.push(s);return null==e?s:e.call(this,i,s)}}(e.exports=function(e,t,n,i){return JSON.stringify(e,r(t,i),n)}).getSerialize=r},aKHJ:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestTenantManager=t.TestTenant=void 0;const n=r("Lvy3"),i=r("XbCS"),s=r("Fazr");class o{constructor(e,t,r){this.url=e,this.historianUrl=t,this.owner="test",this.repository="test";const s=new i.TestHistorian(r);this.manager=new n.GitManager(s)}get gitManager(){return this.manager}get storage(){return{historianUrl:this.historianUrl,internalHistorianUrl:this.historianUrl,credentials:null,owner:this.owner,repository:this.repository,url:this.url}}get orderer(){return{type:"kafka",url:this.url}}}t.TestTenant=o,t.TestTenantManager=class{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"http://test",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"http://historian",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new s.TestDb({});this.tenant=new o(e,t,r)}async createTenant(e){return{id:"test-tenant",storage:this.tenant.storage,orderer:this.tenant.orderer,key:"test-tenant-key",customData:{}}}async verifyToken(e){}async getTenant(e){return this.tenant}async getTenantGitManager(e,t){return this.tenant.gitManager}async getKey(e){return"test"}}},am4Q:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.writeSummaryTree=t.TestDocumentStorage=void 0;const n=r("y2M+"),i=r("VIQa"),s=r("wWog");async function o(e,t,r,c){const u=await Promise.all(Object.keys(t.tree).map((async u=>{const l=t.tree[u],h=await async function(e,t,r,i,c){switch(i.type){case n.SummaryType.Blob:return async function(e,t,r){const{parsedContent:n,encoding:i}="string"==typeof e?{parsedContent:e,encoding:"utf-8"}:{parsedContent:(0,s.Uint8ArrayToString)(e,"base64"),encoding:"base64"},o=await(0,s.gitHashFile)(s.IsoBuffer.from(n,i));if(!t.has(o)){const e=await r.createBlob(n,i);t.add(e.sha)}return o}(i.content,t,e);case n.SummaryType.Handle:if(void 0===c)throw Error("Parent summary does not exist to reference by handle.");return function(e,t,r){const n=t.split("/").map((e=>decodeURIComponent(e)));return""===n[0]&&n.shift(),a(e,n,r)}(i.handleType,i.handle,c);case n.SummaryType.Tree:return o(e,i,t,null==c?void 0:c.trees[r]);case n.SummaryType.Attachment:return i.id;default:throw Error("Unreachable case")}}(e,r,u,l,c);return{mode:(0,i.getGitMode)(l),path:encodeURIComponent(u),sha:h,type:(0,i.getGitType)(l)}})));return(await e.createGitTree({tree:u})).sha}function a(e,t,r){var i;const s=t[0];if(1===t.length)switch(e){case n.SummaryType.Blob:return r.blobs[s];case n.SummaryType.Tree:return null===(i=r.trees[s])||void 0===i?void 0:i.id;default:throw Error(`Unexpected handle summary object type: "${e}".`)}return a(e,t.slice(1),r)}t.TestDocumentStorage=class{constructor(e,t){this.databaseManager=e,this.tenantManager=t}async getDocument(e,t){return(await this.databaseManager.getDocumentCollection()).findOne({documentId:t,tenantId:e})}async getOrCreateDocument(e,t){return this.getOrCreateObject(e,t)}async createDocument(e,t,r,n,s,a,c,u,l,h){const d=await this.tenantManager.getTenantGitManager(e,t),m=new Set,p=await o(d,r,m,void 0),f=(0,i.getQuorumTreeEntries)(t,n,n,s,{members:[],proposals:[],values:h}),[g,y]=await Promise.all([d.createTree({entries:f}),d.getTree(p,!1)]),v=(0,i.mergeAppAndProtocolTree)(y,g),b=await d.createGitTree({tree:v}),S={author:{date:(new Date).toISOString(),email:"dummy@microsoft.com",name:"Routerlicious Service"},message:"New document",parents:[],tree:b.sha},w=await d.createCommit(S);await d.createRef(t,w.sha);const C={clients:void 0,durableSequenceNumber:n,expHash1:a,logOffset:-1,sequenceNumber:n,signalClientConnectionNumber:0,epoch:void 0,term:1,lastSentMSN:0,nackMessages:void 0,successfullyStartedLambdas:[],checkpointTimestamp:Date.now()},E={logOffset:-1,minimumSequenceNumber:n,protocolState:{members:[],minimumSequenceNumber:n,proposals:[],sequenceNumber:n,values:h},sequenceNumber:n,lastClientSummaryHead:void 0,lastSummarySequenceNumber:0,validParentSummaries:void 0},I=await this.databaseManager.getDocumentCollection(),T={ordererUrl:c,historianUrl:u,deltaStreamUrl:l,isSessionAlive:!0,isSessionActive:!0};return await I.findOrCreate({documentId:t,tenantId:e},{createTime:Date.now(),deli:JSON.stringify(C),documentId:t,session:T,scribe:JSON.stringify(E),tenantId:e,version:"0.1"})}async getLatestVersion(e,t){const r=await this.getVersions(e,t,1);if(!r.length)return null;const n=r[0];return{author:n.commit.author,committer:n.commit.committer,message:n.commit.message,parents:n.parents,sha:n.sha,tree:n.commit.tree,url:n.url}}async getVersions(e,t,r){return(await this.tenantManager.getTenantGitManager(e,t)).getCommits(t,r)}async getVersion(e,t,r){return(await this.tenantManager.getTenantGitManager(e,t)).getCommit(r)}async getFullTree(e,t){throw new Error("Method not implemented.")}async getOrCreateObject(e,t){const r=await this.databaseManager.getDocumentCollection();return await r.findOrCreate({documentId:t,tenantId:e},{createTime:Date.now(),deli:void 0,documentId:t,session:void 0,scribe:void 0,tenantId:e,version:"0.1"})}},t.writeSummaryTree=o},ashG:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultServiceConfiguration=void 0;const n=r("y2M+");t.DefaultServiceConfiguration={blockSize:64436,maxMessageSize:16384,enableTraces:!0,enableLumberjack:!0,deli:{enableNackMessages:!0,enableOpHashing:!0,enableAutoDSNUpdate:!1,checkForIdleClientsOnStartup:!1,maintainBatches:!1,enableWriteClientSignals:!1,clientTimeout:3e5,activityTimeout:3e4,readClientIdleTimer:6e4,noOpConsolidationTimeout:250,checkpointHeuristics:{enable:!1,idleTime:1e4,maxTime:6e4,maxMessages:500},opEvent:{enable:!1,idleTime:15e3,maxTime:3e5,maxOps:1500},summaryNackMessages:{enable:!1,checkOnStartup:!1,maxOps:5e3,nackContent:{code:429,type:n.NackErrorType.ThrottlingError,retryAfter:10,message:"Submit a summary before inserting additional operations"}},skipSummarizeAugmentationForSingleCommmit:!1,disableNoClientMessage:!1,enableLeaveOpNoClientServerMetadata:!1},broadcaster:{includeEventInMessageBatchName:!1},scribe:{generateServiceSummary:!0,enablePendingCheckpointMessages:!0,clearCacheAfterServiceSummary:!1,ignoreStorageException:!1,checkpointHeuristics:{enable:!1,idleTime:1e4,maxTime:6e4,maxMessages:500}},moira:{enable:!1,endpoint:""},documentLambda:{partitionActivityTimeout:6e5,partitionActivityCheckInterval:6e4}}},bRtlv:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ThrottlingError=void 0;const n=r("y2M+");t.ThrottlingError=class{constructor(e,t){this.message=e,this.retryAfter=t,this.code=429,this.type=n.NackErrorType.ThrottlingError}}},bbhS:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MongoDatabaseManager=void 0,t.MongoDatabaseManager=class{constructor(e,t,r,n,i,s,o){this.globalDbEnabled=e,this.operationsDbMongoManager=t,this.globalDbMongoManager=r,this.nodeCollectionName=n,this.documentsCollectionName=i,this.deltasCollectionName=s,this.scribeDeltasCollectionName=o}async getNodeCollection(){return this.getCollection(this.nodeCollectionName)}async getDocumentCollection(){return this.getCollection(this.documentsCollectionName)}async getDeltaCollection(e,t){return this.getCollection(this.deltasCollectionName)}async getScribeDeltaCollection(e,t){return this.getCollection(this.scribeDeltasCollectionName)}async getCollection(e){return(e===this.documentsCollectionName&&this.globalDbEnabled?await this.globalDbMongoManager.getDatabase():await this.operationsDbMongoManager.getDatabase()).collection(e)}}},c87J:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PendingBoxcar=t.MaxBatchSize=void 0;const n=r("wWog");t.MaxBatchSize=32,t.PendingBoxcar=class{constructor(e,t){this.tenantId=e,this.documentId=t,this.deferred=new n.Deferred,this.messages=[]}}},"cDE+":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LocalContext=void 0,t.LocalContext=class{constructor(e){this.log=e}checkpoint(e){}error(e,t){}}},cjJq:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestPublisher=t.TestTopic=void 0;const n=r("hBZP");class i{constructor(){this.events=new Map}emit(e){this.events.has(e)||this.events.set(e,[]);for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];this.events.get(e).push({args:r,event:e})}getEvents(e){return this.events.get(e)}}t.TestTopic=i,t.TestPublisher=class{constructor(){this.events=new n.EventEmitter,this.topics={}}on(e,t){this.events.on(e,t)}to(e){return e in this.topics||(this.topics[e]=new i),this.topics[e]}async close(){}}},csBV:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createCompositeTokenId=t.TokenRevocationError=void 0;const n=r("Lvy3");t.TokenRevocationError=class extends n.NetworkError{constructor(e,t,r,n,i,s){super(t,r,n,i,s),this.requestId=e}get details(){return{message:this.message,requestId:this.requestId,canRetry:this.canRetry,isFatal:this.isFatal,retryAfter:this.retryAfter,retryAfterMs:this.retryAfterMs}}toJSON(){return Object.assign({requestId:this.requestId},super.toJSON())}},t.createCompositeTokenId=function(e,t,r){return`${e}/${t}/${r}`}},d2TU:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Lumberjack=void 0;const n=r("dAzj"),i=r("Q/BS"),s=r("5gZq");class o{constructor(){this._engineList=[],this._isSetupCompleted=!1}static get instance(){return o._instance||(o._instance=new o),o._instance}static createInstance(e,t){const r=new o;return r.setup(e,t),r}static setup(e,t){this.instance.setup(e,t)}static newLumberMetric(e,t){return this.instance.newLumberMetric(e,t)}static log(e,t,r,n){this.instance.log(e,t,r,n)}static debug(e,t){this.instance.log(e,s.LogLevel.Debug,t)}static verbose(e,t){this.instance.log(e,s.LogLevel.Verbose,t)}static info(e,t){this.instance.log(e,s.LogLevel.Info,t)}static warning(e,t,r){this.instance.log(e,s.LogLevel.Warning,t,r)}static error(e,t,r){this.instance.log(e,s.LogLevel.Error,t,r)}setup(e,t){this._isSetupCompleted?(0,s.handleError)(n.LumberEventName.LumberjackError,"This Lumberjack was already setup with a list of engines and optional schema validator.",this._engineList):0!==e.length?(this._engineList.push(...e),this._schemaValidators=t,this._isSetupCompleted=!0):(0,s.handleError)(n.LumberEventName.LumberjackError,"The provided engine list is empty. Please provide at list one LumberjackEngine.",this._engineList)}newLumberMetric(e,t){return this.errorOnIncompleteSetup(),new i.Lumber(e,s.LumberType.Metric,this._engineList,this._schemaValidators,t)}static isSetupCompleted(){return this.instance._isSetupCompleted}log(e,t,r,n){this.errorOnIncompleteSetup();const a=new i.Lumber(o.LogMessageEventName,s.LumberType.Log,this._engineList,this._schemaValidators,r);t===s.LogLevel.Warning||t===s.LogLevel.Error?a.error(e,n,t):a.success(e,t)}debug(e,t){this.log(e,s.LogLevel.Debug,t)}verbose(e,t){this.log(e,s.LogLevel.Verbose,t)}info(e,t){this.log(e,s.LogLevel.Info,t)}warning(e,t,r){this.log(e,s.LogLevel.Warning,t,r)}error(e,t,r){this.log(e,s.LogLevel.Error,t,r)}errorOnIncompleteSetup(){this._isSetupCompleted||(0,s.handleError)(n.LumberEventName.LumberjackError,"Lumberjack has not been setup yet. It requires an engine list and an optional schema validator.",this._engineList)}}t.Lumberjack=o,o.LogMessageEventName="LogMessage"},d53T:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.generateClientId=void 0;const n=r("Twpl");t.generateClientId=()=>(0,n.v4)()},d6tz:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SummaryReader=void 0;const n=r("wWog"),i=r("YkJt"),s=r("yQiv"),o=r("fhs9");t.SummaryReader=class{constructor(e,t,r,n){let i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:6;this.tenantId=e,this.documentId=t,this.summaryStorage=r,this.enableWholeSummaryUpload=n,this.maxRetriesOnError=i,this.lumberProperties=(0,o.getLumberBaseProperties)(this.documentId,this.tenantId)}async readLastSummary(){var e,t,r,a,c,u,l,h,d,m;const p=o.Lumberjack.newLumberMetric(o.LumberEventName.SummaryReader);if(p.setProperties(this.lumberProperties),this.enableWholeSummaryUpload)try{let m;try{m=await(0,s.requestWithRetry)((async()=>this.summaryStorage.getSummary(i.LatestSummaryId)),"readWholeSummary_getSummary",this.lumberProperties,s.shouldRetryNetworkError,this.maxRetriesOnError)}catch(e){o.Lumberjack.warning(`Error fetching summary with ID ${i.LatestSummaryId}. Will try with explicit ref.`,this.lumberProperties,e),m=void 0}if(!m){const e=await(0,s.requestWithRetry)((async()=>this.summaryStorage.getRef(encodeURIComponent(this.documentId))),"readWholeSummary_getRef",this.lumberProperties,s.shouldRetryNetworkError,this.maxRetriesOnError);m=await(0,s.requestWithRetry)((async()=>this.summaryStorage.getSummary(e.object.sha)),"readWholeSummary_getSummary",this.lumberProperties,s.shouldRetryNetworkError,this.maxRetriesOnError)}const f=(0,i.convertWholeFlatSummaryToSnapshotTreeAndBlobs)(m),g=null===(t=null===(e=f.snapshotTree.trees[".protocol"])||void 0===e?void 0:e.blobs)||void 0===t?void 0:t.attributes,y=null===(a=null===(r=f.snapshotTree.trees[".serviceProtocol"])||void 0===r?void 0:r.blobs)||void 0===a?void 0:a.scribe,v=null===(u=null===(c=f.snapshotTree.trees[".serviceProtocol"])||void 0===c?void 0:c.blobs)||void 0===u?void 0:u.deli,b=null===(h=null===(l=f.snapshotTree.trees[".logTail"])||void 0===l?void 0:l.blobs)||void 0===h?void 0:h.logTail,S=g?f.blobs.get(g):void 0,w=y?f.blobs.get(y):void 0,C=v?f.blobs.get(v):void 0,E=b?f.blobs.get(b):void 0,I=S?JSON.parse((0,n.bufferToString)(S,"utf8")):this.getDefaultAttributes(),T=w?(0,n.bufferToString)(w,"utf8"):this.getDefaultScribe(),N=C?JSON.parse((0,n.bufferToString)(C,"utf8")):this.getDefaultDeli(),P=N.term,x=E?JSON.parse((0,n.bufferToString)(E,"utf8")):this.getDefaultMesages();return p.setProperties({[o.CommonProperties.minLogtailSequenceNumber]:Math.min(...x.map((e=>e.sequenceNumber))),[o.CommonProperties.maxLogtailSequenceNumber]:Math.max(...x.map((e=>e.sequenceNumber))),[o.CommonProperties.lastSummarySequenceNumber]:N.sequenceNumber,[o.CommonProperties.clientCount]:null===(d=N.clients)||void 0===d?void 0:d.length}),p.success("Successfully read whole summary"),{term:P,protocolHead:I.sequenceNumber,scribe:T,messages:x,fromSummary:!0}}catch(e){return p.error("Returning default summary due to error when reading whole summary",e),this.getDefaultSummaryState()}else try{const e=await(0,s.requestWithRetry)((async()=>this.summaryStorage.getRef(encodeURIComponent(this.documentId))),"readSummary_getRef",this.lumberProperties,s.shouldRetryNetworkError,this.maxRetriesOnError),[t,r,i,a]=await Promise.all([(0,s.requestWithRetry)((async()=>this.summaryStorage.getContent(e.object.sha,".protocol/attributes")),"readSummary_getProtocolAttributesContent",this.lumberProperties,s.shouldRetryNetworkError,this.maxRetriesOnError).catch((()=>{})),(0,s.requestWithRetry)((async()=>this.summaryStorage.getContent(e.object.sha,".serviceProtocol/scribe")),"readSummary_getServiceProtocolScribeContent",this.lumberProperties,s.shouldRetryNetworkError,this.maxRetriesOnError).catch((()=>{})),(0,s.requestWithRetry)((async()=>this.summaryStorage.getContent(e.object.sha,".serviceProtocol/deli")),"readSummary_getServiceProtocolDeliContent",this.lumberProperties,s.shouldRetryNetworkError,this.maxRetriesOnError).catch((()=>{})),(0,s.requestWithRetry)((async()=>this.summaryStorage.getContent(e.object.sha,".logTail/logTail")),"readSummary_getLogTailContent",this.lumberProperties,s.shouldRetryNetworkError,this.maxRetriesOnError).catch((()=>{}))]),c=t?JSON.parse((0,n.toUtf8)(t.content,t.encoding)):this.getDefaultAttributes(),u=r?(0,n.toUtf8)(r.content,r.encoding):this.getDefaultScribe(),l=i?JSON.parse((0,n.toUtf8)(i.content,i.encoding)):this.getDefaultDeli(),h=l.term,d=a?JSON.parse((0,n.toUtf8)(a.content,a.encoding)):this.getDefaultMesages();return p.setProperties({[o.CommonProperties.minLogtailSequenceNumber]:Math.min(...d.map((e=>e.sequenceNumber))),[o.CommonProperties.maxLogtailSequenceNumber]:Math.max(...d.map((e=>e.sequenceNumber))),[o.CommonProperties.lastSummarySequenceNumber]:l.sequenceNumber,[o.CommonProperties.clientCount]:null===(m=l.clients)||void 0===m?void 0:m.length}),p.success("Successfully read summary"),{term:h,protocolHead:c.sequenceNumber,scribe:u,messages:d,fromSummary:!0}}catch(e){return p.error("Returning default summary due to error when reading summary",e),this.getDefaultSummaryState()}}getDefaultSummaryState(){return{term:1,protocolHead:0,scribe:"",messages:[],fromSummary:!1}}getDefaultAttributes(){return o.Lumberjack.info("Using default attributes when reading summary.",this.lumberProperties),{sequenceNumber:0,minimumSequenceNumber:0,term:void 0}}getDefaultScribe(){return o.Lumberjack.info("Using default scribe when reading summary.",this.lumberProperties),""}getDefaultDeli(){return o.Lumberjack.info("Using default deli state when reading summary.",this.lumberProperties),{clients:void 0,durableSequenceNumber:0,logOffset:0,sequenceNumber:0,signalClientConnectionNumber:0,expHash1:"",epoch:0,term:1,lastSentMSN:void 0,nackMessages:void 0,successfullyStartedLambdas:[],checkpointTimestamp:void 0}}getDefaultMesages(){return o.Lumberjack.info("Using default messages when reading summary.",this.lumberProperties),[]}}},d8Mq:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NoOpLambda=t.logCommonSessionEndMetrics=t.isDocumentValid=t.isDocumentSessionValid=t.generateClientId=t.createSessionMetric=t.createRoomLeaveMessage=t.createRoomJoinMessage=t.createNackMessage=t.ScriptoriumLambdaFactory=t.ScriptoriumLambda=t.SummaryWriter=t.SummaryReader=t.ScribeLambdaFactory=t.ScribeLambda=t.CheckpointManager=t.MoiraLambdaFactory=t.MoiraLambda=t.ForemanLambdaFactory=t.ForemanLambda=t.OpEventType=t.DeliLambdaFactory=t.DeliLambda=t.createDeliCheckpointManagerFromCollection=t.CopierLambdaFactory=t.CopierLambda=t.BroadcasterLambdaFactory=t.BroadcasterLambda=t.configureWebSocketServices=void 0;var n=r("Of2+");Object.defineProperty(t,"configureWebSocketServices",{enumerable:!0,get:function(){return n.configureWebSocketServices}});var i=r("O/xt");Object.defineProperty(t,"BroadcasterLambda",{enumerable:!0,get:function(){return i.BroadcasterLambda}}),Object.defineProperty(t,"BroadcasterLambdaFactory",{enumerable:!0,get:function(){return i.BroadcasterLambdaFactory}});var s=r("ELGQ");Object.defineProperty(t,"CopierLambda",{enumerable:!0,get:function(){return s.CopierLambda}}),Object.defineProperty(t,"CopierLambdaFactory",{enumerable:!0,get:function(){return s.CopierLambdaFactory}});var o=r("LlaD");Object.defineProperty(t,"createDeliCheckpointManagerFromCollection",{enumerable:!0,get:function(){return o.createDeliCheckpointManagerFromCollection}}),Object.defineProperty(t,"DeliLambda",{enumerable:!0,get:function(){return o.DeliLambda}}),Object.defineProperty(t,"DeliLambdaFactory",{enumerable:!0,get:function(){return o.DeliLambdaFactory}}),Object.defineProperty(t,"OpEventType",{enumerable:!0,get:function(){return o.OpEventType}});var a=r("JKLl");Object.defineProperty(t,"ForemanLambda",{enumerable:!0,get:function(){return a.ForemanLambda}}),Object.defineProperty(t,"ForemanLambdaFactory",{enumerable:!0,get:function(){return a.ForemanLambdaFactory}});var c=r("dTvY");Object.defineProperty(t,"MoiraLambda",{enumerable:!0,get:function(){return c.MoiraLambda}}),Object.defineProperty(t,"MoiraLambdaFactory",{enumerable:!0,get:function(){return c.MoiraLambdaFactory}});var u=r("JyNL");Object.defineProperty(t,"CheckpointManager",{enumerable:!0,get:function(){return u.CheckpointManager}}),Object.defineProperty(t,"ScribeLambda",{enumerable:!0,get:function(){return u.ScribeLambda}}),Object.defineProperty(t,"ScribeLambdaFactory",{enumerable:!0,get:function(){return u.ScribeLambdaFactory}}),Object.defineProperty(t,"SummaryReader",{enumerable:!0,get:function(){return u.SummaryReader}}),Object.defineProperty(t,"SummaryWriter",{enumerable:!0,get:function(){return u.SummaryWriter}});var l=r("qymq");Object.defineProperty(t,"ScriptoriumLambda",{enumerable:!0,get:function(){return l.ScriptoriumLambda}}),Object.defineProperty(t,"ScriptoriumLambdaFactory",{enumerable:!0,get:function(){return l.ScriptoriumLambdaFactory}});var h=r("KMXR");Object.defineProperty(t,"createNackMessage",{enumerable:!0,get:function(){return h.createNackMessage}}),Object.defineProperty(t,"createRoomJoinMessage",{enumerable:!0,get:function(){return h.createRoomJoinMessage}}),Object.defineProperty(t,"createRoomLeaveMessage",{enumerable:!0,get:function(){return h.createRoomLeaveMessage}}),Object.defineProperty(t,"createSessionMetric",{enumerable:!0,get:function(){return h.createSessionMetric}}),Object.defineProperty(t,"generateClientId",{enumerable:!0,get:function(){return h.generateClientId}}),Object.defineProperty(t,"isDocumentSessionValid",{enumerable:!0,get:function(){return h.isDocumentSessionValid}}),Object.defineProperty(t,"isDocumentValid",{enumerable:!0,get:function(){return h.isDocumentValid}}),Object.defineProperty(t,"logCommonSessionEndMetrics",{enumerable:!0,get:function(){return h.logCommonSessionEndMetrics}}),Object.defineProperty(t,"NoOpLambda",{enumerable:!0,get:function(){return h.NoOpLambda}})},dAzj:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LumberEventName=void 0,function(e){e.LumberjackError="LumberjackError",e.LumberjackSchemaValidationFailure="LumberjackSchemaValidationFailure",e.RunService="RunService",e.UnitTestEvent="UnitTestEvent",e.ClientSummary="ClientSummary",e.DeliHandler="DeliHandler",e.KafkaRunner="KafkaRunner",e.ScribeHandler="ScribeHandler",e.ServiceSummary="ServiceSummary",e.SummaryReader="SummaryReader",e.ScriptoriumProcessBatch="ScriptoriumProcessBatch",e.RunWithRetry="RunWithRetry",e.RequestWithRetry="RequestWithRetry",e.SessionResult="SessionResult",e.StartSessionResult="StartSessionResult",e.ScribeSessionResult="ScribeSessionResult",e.ConnectDocument="ConnectDocument",e.ConnectDocumentAddClient="ConnectDocumentAddClient",e.ConnectDocumentGetClients="ConnectDocumentGetClients",e.ConnectDocumentOrdererConnection="ConnectDocumentOrdererConnection",e.CreateDocumentUpdateDocumentCollection="CreateDocumentUpdateDocumentCollection",e.CreateDocInitialSummaryWrite="CreateDocInitialSummaryWrite",e.RiddlerFetchTenantKey="RiddlerFetchTenantKey",e.HttpRequest="HttpRequest",e.TotalConnectionCount="TotalConnectionCount",e.ConnectionCountPerNode="ConnectionCountPerNode"}(t.LumberEventName||(t.LumberEventName={}))},dTvY:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MoiraLambdaFactory=t.MoiraLambda=void 0;var n=r("ndW6");Object.defineProperty(t,"MoiraLambda",{enumerable:!0,get:function(){return n.MoiraLambda}});var i=r("j7kB");Object.defineProperty(t,"MoiraLambdaFactory",{enumerable:!0,get:function(){return i.MoiraLambdaFactory}})},dW4G:function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SummaryWriter=void 0;const i=r("wWog"),s=r("VIQa"),o=r("y2M+"),a=r("Lvy3"),c=r("MPeK"),u=r("tp/L"),l=n(r("a0Z+"));t.SummaryWriter=class{constructor(e,t,r,n,i,s,o,a){let c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:6;this.tenantId=e,this.documentId=t,this.summaryStorage=r,this.deltaService=n,this.opStorage=i,this.enableWholeSummaryUpload=s,this.lastSummaryMessages=o,this.getDeltasViaAlfred=a,this.maxRetriesOnError=c,this.lumberProperties=(0,u.getLumberBaseProperties)(this.documentId,this.tenantId)}get isExternal(){return!1}async writeClientSummary(e,t,r,n){var i,a,h,d,m;const p=u.Lumberjack.newLumberMetric(u.LumberEventName.ClientSummary);this.setSummaryProperties(p,e);const f=JSON.parse(e.contents);try{const u=await(0,c.requestWithRetry)((async()=>this.summaryStorage.getRef(encodeURIComponent(this.documentId))),"writeClientSummary_getRef",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError);if(f.head){if(!(u&&(t===f.head||u.object.sha===f.head)||null!==(a=null===(i=r.validParentSummaries)||void 0===i?void 0:i.includes(f.head))&&void 0!==a&&a))return p.error("Proposed parent summary does not match actual parent summary"),{message:{message:`Proposed parent summary "${f.head}" does not match actual parent summary "${u?u.object.sha:"n/a"}" nor other valid parent summaries "[${null!==(d=null===(h=r.validParentSummaries)||void 0===h?void 0:h.join(","))&&void 0!==d?d:""}]".`,summaryProposal:{summarySequenceNumber:e.sequenceNumber}},status:!1}}else if(u)return p.error("Proposed parent summary does not match actual parent summary"),{message:{message:`Proposed parent summary "${f.head}" does not match actual parent summary "${u.object.sha}".`,summaryProposal:{summarySequenceNumber:e.sequenceNumber}},status:!1};if(!this.enableWholeSummaryUpload)try{await(0,c.requestWithRetry)((async()=>Promise.all(f.parents.map((async e=>this.summaryStorage.getCommit(e))))),"writeClientSummary_validateParentSummary",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError)}catch(t){return p.error("One or more parent summaries are invalid",t),{message:{message:"One or more parent summaries are invalid",summaryProposal:{summarySequenceNumber:e.sequenceNumber}},status:!1}}if(e.referenceSequenceNumber<r.protocolState.sequenceNumber)return p.error("Proposed summary reference sequence number less than current sequence number"),{message:{message:`Proposed summary reference sequence number ${e.referenceSequenceNumber} is less than current sequence number ${r.protocolState.sequenceNumber}`,summaryProposal:{summarySequenceNumber:e.sequenceNumber}},status:!1};const l=(0,s.getQuorumTreeEntries)(this.documentId,r.protocolState.minimumSequenceNumber,r.protocolState.sequenceNumber,null!==(m=e.term)&&void 0!==m?m:1,r.protocolState),g=await(0,c.requestWithRetry)((async()=>this.generateLogtailEntries(r.protocolState.sequenceNumber,e.sequenceNumber+1,n,this.lastSummaryMessages)),"writeClientSummary_generateLogtailEntries",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError),y=(0,s.generateServiceProtocolEntries)(e.additionalContent,JSON.stringify(r));let v="";if(this.enableWholeSummaryUpload)v=await(0,c.requestWithRetry)((async()=>{var e;return this.updateWholeSummary(f.head,f.handle,l,g,y,r.protocolState.sequenceNumber,null===(e=f.details)||void 0===e?void 0:e.includesProtocolTree)}),"writeClientSummary_updateWholeSummary",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError);else{const[e,t,r,n]=await Promise.all([(0,c.requestWithRetry)((async()=>this.summaryStorage.createTree({entries:g})),"writeClientSummary_createLogTailTree",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError),(0,c.requestWithRetry)((async()=>this.summaryStorage.createTree({entries:l})),"writeClientSummary_createProtocolTree",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError),(0,c.requestWithRetry)((async()=>this.summaryStorage.createTree({entries:y})),"writeClientSummary_createServiceProtocolTree",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError),(0,c.requestWithRetry)((async()=>this.summaryStorage.getTree(f.handle,!1)),"writeClientSummary_getAppSummaryTree",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError)]),i=(0,s.mergeAppAndProtocolTree)(n,t);i.push({mode:o.FileMode.Directory,path:".logTail",sha:e.sha,type:"tree"}),i.push({mode:o.FileMode.Directory,path:".serviceProtocol",sha:r.sha,type:"tree"});const a=await(0,c.requestWithRetry)((async()=>this.summaryStorage.createGitTree({tree:i})),"writeClientSummary_createGitTree",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError),h={author:{date:(new Date).toISOString(),email:"praguertdev@microsoft.com",name:"Routerlicious Service"},message:f.message,parents:f.parents,tree:a.sha},d=await(0,c.requestWithRetry)((async()=>this.summaryStorage.createCommit(h)),"writeClientSummary_createCommit",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError);v=d.sha,await(u?(0,c.requestWithRetry)((async()=>this.summaryStorage.upsertRef(this.documentId,v)),"writeClientSummary_upsertRef",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError):(0,c.requestWithRetry)((async()=>this.summaryStorage.createRef(this.documentId,v)),"writeClientSummary_createRef",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError))}return p.success("Client summary success"),{message:{handle:v,summaryProposal:{summarySequenceNumber:e.sequenceNumber}},status:!0}}catch(t){if(p.error("Client summary failed",t),t instanceof Error&&"NetworkError"===(null==t?void 0:t.name)){const r=t;if(!r.isFatal)return{message:{message:`A non-fatal error happened when trying to write client summary. Error: ${(0,l.default)(r.details)}`,summaryProposal:{summarySequenceNumber:e.sequenceNumber}},status:!1}}throw t}}async writeServiceSummary(e,t,r,n){const i=u.Lumberjack.newLumberMetric(u.LumberEventName.ServiceSummary);this.setSummaryProperties(i,e);try{const a=await(0,c.requestWithRetry)((async()=>this.summaryStorage.getRef(encodeURIComponent(this.documentId))),"writeServiceSummary_getRef",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError);if(!a)return i.error("No prior summaries found"),!1;if(!e.additionalContent)return i.error("Additional content is not defined"),!1;const u=await(0,c.requestWithRetry)((async()=>this.generateLogtailEntries(t,e.sequenceNumber+1,n,this.lastSummaryMessages)),"writeServiceSummary_generateLogtailEntries",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError),l=(0,s.generateServiceProtocolEntries)(e.additionalContent,JSON.stringify(r));let h;if(this.enableWholeSummaryUpload)h=await(0,c.requestWithRetry)((async()=>this.createWholeServiceSummary(a.object.sha,u,l,e.sequenceNumber)),"writeServiceSummary_createWholeServiceSummary",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError);else{const t=await(0,c.requestWithRetry)((async()=>this.summaryStorage.getCommit(a.object.sha)),"writeServiceSummary_getCommit",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError),[r,n,i]=await Promise.all([(0,c.requestWithRetry)((async()=>this.summaryStorage.createTree({entries:u})),"writeServiceSummary_createLogTailTree",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError),(0,c.requestWithRetry)((async()=>this.summaryStorage.createTree({entries:l})),"writeServiceSummary_createServiceProtocolTree",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError),(0,c.requestWithRetry)((async()=>this.summaryStorage.getTree(t.tree.sha,!1)),"writeServiceSummary_getLastSummaryTree",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError)]),s=i.tree.map((e=>({mode:e.mode,path:e.path,sha:e.sha,type:e.type})));s.push({mode:o.FileMode.Directory,path:".logTail",sha:r.sha,type:"tree"}),s.push({mode:o.FileMode.Directory,path:".serviceProtocol",sha:n.sha,type:"tree"});const d=await(0,c.requestWithRetry)((async()=>this.summaryStorage.createGitTree({tree:s})),"writeServiceSummary_createGitTree",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError),m={author:{date:(new Date).toISOString(),email:"praguertdev@microsoft.com",name:"Routerlicious Service"},message:`Service Summary @${e.sequenceNumber}`,parents:[t.sha],tree:d.sha},p=await(0,c.requestWithRetry)((async()=>this.summaryStorage.createCommit(m)),"writeServiceSummary_createCommit",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError);await(0,c.requestWithRetry)((async()=>this.summaryStorage.upsertRef(this.documentId,p.sha)),"writeServiceSummary_upsertRef",this.lumberProperties,c.shouldRetryNetworkError,this.maxRetriesOnError),h=p.sha}return i.success("Service summary success"),h}catch(e){if(i.error("Service summary failed",e),e instanceof Error&&"NetworkError"===(null==e?void 0:e.name)&&!e.isFatal)return!1;throw e}}setSummaryProperties(e,t){e.setProperties((0,u.getLumberBaseProperties)(this.documentId,this.tenantId)),e.setProperties({[u.CommonProperties.clientId]:t.clientId,[u.CommonProperties.sequenceNumber]:t.sequenceNumber,[u.CommonProperties.minSequenceNumber]:t.minimumSequenceNumber})}async generateLogtailEntries(e,t,r,n){const i=await this.getLogTail(e,t,r),s=await this.getMissingOpsFromLastSummaryLogtail(e,t,i,n),a=s?s.concat(i).sort(((e,t)=>e.sequenceNumber-t.sequenceNumber)):i;if(!(a&&a.length>0&&a.length===t-e-1&&e===a[0].sequenceNumber-1&&t===a[a.length-1].sequenceNumber+1)){const r=[],n=new Set;null==a||a.map((e=>n.add(e.sequenceNumber)));for(let i=e+1;i<t;i++)n.has(i)||r.push(i);u.Lumberjack.info(`FullLogTail missing ops from: ${e} exclusive, to: ${t} exclusive with sequence numbers: ${JSON.stringify(r)}`,this.lumberProperties)}const c=[{mode:o.FileMode.File,path:"logTail",type:o.TreeEntry.Blob,value:{contents:JSON.stringify(a),encoding:"utf-8"}}];return a.length>0&&u.Lumberjack.info(`FullLogTail of length ${a.length} generated from seq no ${a[0].sequenceNumber} to ${a[a.length-1].sequenceNumber}`,this.lumberProperties),c}async getMissingOpsFromLastSummaryLogtail(e,t,r,n){if(t-e<=1)return;const i=new Set;r.forEach((e=>i.add(e.sequenceNumber)));const s=null==n?void 0:n.filter((r=>!i.has(r.sequenceNumber)&&r.sequenceNumber>e&&r.sequenceNumber<t)),o=[];return null==s||s.forEach((e=>o.push(e.sequenceNumber))),o.length>0&&u.Lumberjack.info(`Fetched ops gt: ${e} exclusive, lt: ${t} exclusive of last summary logtail: ${JSON.stringify(o)}`,this.lumberProperties),s}async getLogTail(e,t,r){if(t-e<=1)return[];if(r.length>0){const n=r.filter((r=>r.operation.sequenceNumber>e&&r.operation.sequenceNumber<t)).map((e=>e.operation));if(n.length>0&&n[0].sequenceNumber===e+1&&n[n.length-1].sequenceNumber===t-1)return u.Lumberjack.info(`LogTail of length ${n.length} between ${e+1} and ${t-1} fetched from pending ops`,this.lumberProperties),n}let n=[];if(this.getDeltasViaAlfred)n=await this.deltaService.getDeltas("",this.tenantId,this.documentId,e,t);else{const r={documentId:this.documentId,tenantId:this.tenantId,"operation.sequenceNumber":{$gt:e,$lt:t}};n=(await this.opStorage.find(r,{"operation.sequenceNumber":1})).map((e=>e.operation))}if(u.Lumberjack.info(`LogTail of length ${n.length} fetched from seq no ${e} to ${t}`,this.lumberProperties),n.length!==t-e-1){const i=0===n.length?e:n[n.length-1].sequenceNumber+1;for(const e of r)e.operation.sequenceNumber>=i&&e.operation.sequenceNumber<t&&n.push(e.operation);u.Lumberjack.info(`Populated logtail gaps. nextSeq: ${i} LogtailLength: ${n.length}`,this.lumberProperties)}return n}async updateWholeSummary(e,t,r,n,i,s,c){const u={type:o.SummaryType.Tree,tree:{".protocol":this.createSummaryTreeFromEntry(r),".logTail":this.createSummaryTreeFromEntry(n),".serviceProtocol":this.createSummaryTreeFromEntry(i),".app":{type:o.SummaryType.Handle,handle:c?(0,a.buildTreePath)(t,".app"):t,handleType:o.SummaryType.Tree,embedded:!0}}},l=new a.WholeSummaryUploadManager(this.summaryStorage);return await l.writeSummaryTree(u,e,"container",s)}async createWholeServiceSummary(e,t,r,n){const i={type:o.SummaryType.Tree,tree:{".logTail":this.createSummaryTreeFromEntry(t),".serviceProtocol":this.createSummaryTreeFromEntry(r),".protocol":{type:o.SummaryType.Handle,handle:".protocol",handleType:o.SummaryType.Tree},".app":{type:o.SummaryType.Handle,handle:".app",handleType:o.SummaryType.Tree}}},s=new a.WholeSummaryUploadManager(this.summaryStorage);return await s.writeSummaryTree(i,e,"container",n)}createSummaryTreeFromEntry(e){return{tree:this.createSummaryTreeFromEntryCore(e),type:o.SummaryType.Tree}}createSummaryTreeFromEntryCore(e){const t={};for(const r of e){let e;switch(r.type){case o.TreeEntry.Attachment:e={type:o.SummaryType.Attachment,id:r.value.id};break;case o.TreeEntry.Blob:e={type:o.SummaryType.Blob,content:"base64"===r.value.encoding?(0,i.fromBase64ToUtf8)(r.value.contents):r.value.contents};break;case o.TreeEntry.Tree:e={type:o.SummaryType.Tree,unreferenced:r.value.unreferenced,tree:this.createSummaryTreeFromEntryCore(r.value.entries)};break;default:throw new Error("Unexpected TreeEntry type when converting ITreeEntry.")}t[r.path]=e}return t}}},dhlH:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScriptoriumLambdaFactory=void 0;const n=r("hBZP"),i=r("pfo9");t.ScriptoriumLambdaFactory=class extends n.EventEmitter{constructor(e,t,r){super(),this.mongoManager=e,this.opCollection=t,this.providerConfig=r}async create(e,t){return new i.ScriptoriumLambda(this.opCollection,t,this.providerConfig)}async dispose(){await this.mongoManager.close()}}},dyph:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.signalUsageStorageId=t.clientConnectivityStorageId=t.ThrottlingError=t.KeyName=t.shouldRetryNetworkError=t.runWithRetry=t.requestWithRetry=t.calculateRetryIntervalForNetworkError=t.PendingBoxcar=t.MaxBatchSize=t.MongoDatabaseManager=t.MongoManager=t.DefaultMetricClient=t.SystemType=t.SystemOperations=t.SignalOperationType=t.SequencedOperationType=t.RawOperationType=t.NackOperationType=t.NackMessagesType=t.ControlMessageType=t.BoxcarType=t.LambdaName=t.LambdaCloseType=t.extractBoxcar=t.EmptyTaskMessageSender=t.isRetryEnabled=t.DefaultServiceConfiguration=t.CombinedProducer=t.CombinedLambda=t.CombinedContext=t.chooseCelaName=void 0;var n=r("LpAa");Object.defineProperty(t,"chooseCelaName",{enumerable:!0,get:function(){return n.chooseCelaName}});var i=r("PmJK");Object.defineProperty(t,"CombinedContext",{enumerable:!0,get:function(){return i.CombinedContext}});var s=r("3Fwg");Object.defineProperty(t,"CombinedLambda",{enumerable:!0,get:function(){return s.CombinedLambda}});var o=r("XmJ0");Object.defineProperty(t,"CombinedProducer",{enumerable:!0,get:function(){return o.CombinedProducer}});var a=r("ashG");Object.defineProperty(t,"DefaultServiceConfiguration",{enumerable:!0,get:function(){return a.DefaultServiceConfiguration}});var c=r("kOqW");Object.defineProperty(t,"isRetryEnabled",{enumerable:!0,get:function(){return c.isRetryEnabled}});var u=r("rT4n");Object.defineProperty(t,"EmptyTaskMessageSender",{enumerable:!0,get:function(){return u.EmptyTaskMessageSender}});var l=r("REGm");Object.defineProperty(t,"extractBoxcar",{enumerable:!0,get:function(){return l.extractBoxcar}}),Object.defineProperty(t,"LambdaCloseType",{enumerable:!0,get:function(){return l.LambdaCloseType}}),Object.defineProperty(t,"LambdaName",{enumerable:!0,get:function(){return l.LambdaName}});var h=r("1M/W");Object.defineProperty(t,"BoxcarType",{enumerable:!0,get:function(){return h.BoxcarType}}),Object.defineProperty(t,"ControlMessageType",{enumerable:!0,get:function(){return h.ControlMessageType}}),Object.defineProperty(t,"NackMessagesType",{enumerable:!0,get:function(){return h.NackMessagesType}}),Object.defineProperty(t,"NackOperationType",{enumerable:!0,get:function(){return h.NackOperationType}}),Object.defineProperty(t,"RawOperationType",{enumerable:!0,get:function(){return h.RawOperationType}}),Object.defineProperty(t,"SequencedOperationType",{enumerable:!0,get:function(){return h.SequencedOperationType}}),Object.defineProperty(t,"SignalOperationType",{enumerable:!0,get:function(){return h.SignalOperationType}}),Object.defineProperty(t,"SystemOperations",{enumerable:!0,get:function(){return h.SystemOperations}}),Object.defineProperty(t,"SystemType",{enumerable:!0,get:function(){return h.SystemType}});var d=r("O4c1");Object.defineProperty(t,"DefaultMetricClient",{enumerable:!0,get:function(){return d.DefaultMetricClient}});var m=r("GGiJ");Object.defineProperty(t,"MongoManager",{enumerable:!0,get:function(){return m.MongoManager}});var p=r("bbhS");Object.defineProperty(t,"MongoDatabaseManager",{enumerable:!0,get:function(){return p.MongoDatabaseManager}});var f=r("c87J");Object.defineProperty(t,"MaxBatchSize",{enumerable:!0,get:function(){return f.MaxBatchSize}}),Object.defineProperty(t,"PendingBoxcar",{enumerable:!0,get:function(){return f.PendingBoxcar}});var g=r("C0H2");Object.defineProperty(t,"calculateRetryIntervalForNetworkError",{enumerable:!0,get:function(){return g.calculateRetryIntervalForNetworkError}}),Object.defineProperty(t,"requestWithRetry",{enumerable:!0,get:function(){return g.requestWithRetry}}),Object.defineProperty(t,"runWithRetry",{enumerable:!0,get:function(){return g.runWithRetry}}),Object.defineProperty(t,"shouldRetryNetworkError",{enumerable:!0,get:function(){return g.shouldRetryNetworkError}});var y=r("RN+g");Object.defineProperty(t,"KeyName",{enumerable:!0,get:function(){return y.KeyName}});var v=r("G8Jv");Object.defineProperty(t,"ThrottlingError",{enumerable:!0,get:function(){return v.ThrottlingError}});var b=r("tXmR");Object.defineProperty(t,"clientConnectivityStorageId",{enumerable:!0,get:function(){return b.clientConnectivityStorageId}}),Object.defineProperty(t,"signalUsageStorageId",{enumerable:!0,get:function(){return b.signalUsageStorageId}})},"e+Z5":function(e,t,r){"use strict";r.d(t,"a",(function(){return i}));var n=r("Gstq");const i=Object(n.debug)("fluid:services-client");i("Package: @fluidframework/server-services-client - Version: 0.1040.1000")},egDu:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestThrottlerHelper=void 0,t.TestThrottlerHelper=class{constructor(e){this.opsPerMs=e,this.throttleStorage={}}async updateCount(e,t){const r=Date.now(),n=this.throttleStorage[e]||{count:this.opsPerMs,lastCoolDownAt:r,throttleStatus:!1,throttleReason:void 0,retryAfterInMs:0};if(n.count+=Math.floor((r-n.lastCoolDownAt)*this.opsPerMs),n.lastCoolDownAt=r,n.count-=t,n.count<0){const e=Math.abs(n.count);n.throttleStatus=!0,n.retryAfterInMs=e/this.opsPerMs,n.throttleReason=`Count exceeded by ${e} at ${r}`}else n.throttleStatus=!1,n.retryAfterInMs=0,n.throttleReason=void 0;return this.throttleStorage[e]=n,this.getThrottlerResponseFromThrottlingMetrics(n)}async getThrottleStatus(e){const t=this.throttleStorage[e];if(t)return this.getThrottlerResponseFromThrottlingMetrics(t)}getThrottlerResponseFromThrottlingMetrics(e){return{throttleStatus:e.throttleStatus,throttleReason:e.throttleReason,retryAfterInMs:e.retryAfterInMs}}}},ezbL:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultServiceConfiguration=void 0;const n=r("y2M+");t.DefaultServiceConfiguration={blockSize:64436,maxMessageSize:16384,enableTraces:!0,enableLumberjack:!0,deli:{enableNackMessages:!0,enableOpHashing:!0,enableAutoDSNUpdate:!1,checkForIdleClientsOnStartup:!1,maintainBatches:!1,enableWriteClientSignals:!1,clientTimeout:3e5,activityTimeout:3e4,readClientIdleTimer:6e4,noOpConsolidationTimeout:250,checkpointHeuristics:{enable:!1,idleTime:1e4,maxTime:6e4,maxMessages:500},opEvent:{enable:!1,idleTime:15e3,maxTime:3e5,maxOps:1500},summaryNackMessages:{enable:!1,checkOnStartup:!1,maxOps:5e3,nackContent:{code:429,type:n.NackErrorType.ThrottlingError,retryAfter:10,message:"Submit a summary before inserting additional operations"}},skipSummarizeAugmentationForSingleCommmit:!1,disableNoClientMessage:!1,enableLeaveOpNoClientServerMetadata:!1},broadcaster:{includeEventInMessageBatchName:!1},scribe:{generateServiceSummary:!0,enablePendingCheckpointMessages:!0,clearCacheAfterServiceSummary:!1,ignoreStorageException:!1,checkpointHeuristics:{enable:!1,idleTime:1e4,maxTime:6e4,maxMessages:500}},moira:{enable:!1,endpoint:""},documentLambda:{partitionActivityTimeout:6e5,partitionActivityCheckInterval:6e4}}},fhs9:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LambdaSchemaValidator=t.BasePropertiesValidator=t.BaseLumberjackSchemaValidator=t.ThrottlingTelemetryProperties=t.SessionState=t.QueuedMessageProperties=t.LumberType=t.LogLevel=t.HttpProperties=t.handleError=t.getLumberBaseProperties=t.CommonProperties=t.BaseTelemetryProperties=t.TestSchemaValidator=t.TestLumberjack=t.TestEngine2=t.TestEngine1=t.Lumberjack=t.LumberEventName=t.Lumber=void 0;var n=r("0nFT");Object.defineProperty(t,"Lumber",{enumerable:!0,get:function(){return n.Lumber}});var i=r("pKcq");Object.defineProperty(t,"LumberEventName",{enumerable:!0,get:function(){return i.LumberEventName}});var s=r("QoYi");Object.defineProperty(t,"Lumberjack",{enumerable:!0,get:function(){return s.Lumberjack}});var o=r("RmbP");Object.defineProperty(t,"TestEngine1",{enumerable:!0,get:function(){return o.TestEngine1}}),Object.defineProperty(t,"TestEngine2",{enumerable:!0,get:function(){return o.TestEngine2}}),Object.defineProperty(t,"TestLumberjack",{enumerable:!0,get:function(){return o.TestLumberjack}}),Object.defineProperty(t,"TestSchemaValidator",{enumerable:!0,get:function(){return o.TestSchemaValidator}});var a=r("FY09");Object.defineProperty(t,"BaseTelemetryProperties",{enumerable:!0,get:function(){return a.BaseTelemetryProperties}}),Object.defineProperty(t,"CommonProperties",{enumerable:!0,get:function(){return a.CommonProperties}}),Object.defineProperty(t,"getLumberBaseProperties",{enumerable:!0,get:function(){return a.getLumberBaseProperties}}),Object.defineProperty(t,"handleError",{enumerable:!0,get:function(){return a.handleError}}),Object.defineProperty(t,"HttpProperties",{enumerable:!0,get:function(){return a.HttpProperties}}),Object.defineProperty(t,"LogLevel",{enumerable:!0,get:function(){return a.LogLevel}}),Object.defineProperty(t,"LumberType",{enumerable:!0,get:function(){return a.LumberType}}),Object.defineProperty(t,"QueuedMessageProperties",{enumerable:!0,get:function(){return a.QueuedMessageProperties}}),Object.defineProperty(t,"SessionState",{enumerable:!0,get:function(){return a.SessionState}}),Object.defineProperty(t,"ThrottlingTelemetryProperties",{enumerable:!0,get:function(){return a.ThrottlingTelemetryProperties}});var c=r("TnPO");Object.defineProperty(t,"BaseLumberjackSchemaValidator",{enumerable:!0,get:function(){return c.BaseLumberjackSchemaValidator}}),Object.defineProperty(t,"BasePropertiesValidator",{enumerable:!0,get:function(){return c.BasePropertiesValidator}}),Object.defineProperty(t,"LambdaSchemaValidator",{enumerable:!0,get:function(){return c.LambdaSchemaValidator}})},fna4:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pkgVersion=t.pkgName=void 0,t.pkgName="@fluidframework/server-memory-orderer",t.pkgVersion="0.1040.1000"},"gF/g":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestThrottler=void 0;const n=r("dyph");t.TestThrottler=class{constructor(e){this.limit=e,this.throttleCounts=new Map}incrementCount(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const r=this.throttleCounts.get(e)||0;this.checkThrottled(r);const n=r+t;this.throttleCounts.set(e,n),this.checkThrottled(n)}decrementCount(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const r=(this.throttleCounts.get(e)||0)-t;this.throttleCounts.set(e,r)}checkThrottled(e){if(this.limit&&e>this.limit)throw new n.ThrottlingError("throttled",e-this.limit)}}},gLf6:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultMetricClient=void 0,t.DefaultMetricClient=class{writeLatencyMetric(e,t){return Promise.resolve()}}},gTor:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LocalOrdererSetup=void 0;const n=r("wWog"),i=r("fhs9");t.LocalOrdererSetup=class{constructor(e,t,r,n,i,s){this.tenantId=e,this.documentId=t,this.storage=r,this.databaseManager=n,this.documentRepository=i,this.gitManager=s}documentP(){return this.storage.getOrCreateDocument(this.tenantId,this.documentId)}documentCollectionP(){return i.Lumberjack.error("documentCollectionP() is deprecated but still used."),this.databaseManager.getDocumentCollection()}async documentRepositoryP(){return this.documentRepository}deltaCollectionP(){return this.databaseManager.getDeltaCollection(this.tenantId,this.documentId)}scribeDeltaCollectionP(){return this.databaseManager.getScribeDeltaCollection(this.tenantId,this.documentId)}async protocolHeadP(){if(!this.gitManager)return 0;const e=await this.gitManager.getRef(encodeURIComponent(this.documentId));if(!e)return-1;const t=await this.gitManager.getContent(e.object.sha,".protocol/attributes");return JSON.parse((0,n.fromBase64ToUtf8)(t.content)).sequenceNumber}async scribeMessagesP(){return(await this.scribeDeltaCollectionP()).find({documentId:this.documentId,tenantId:this.tenantId},{"operation.sequenceNumber":1})}}},h6re:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.KeyName=void 0,function(e){e.key1="key1",e.key2="key2"}(t.KeyName||(t.KeyName={}))},hVFe:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestHistorian=void 0;const n=r("wWog"),i=r("Twpl"),s=r("tRAo");t.TestHistorian=class{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new s.TestDb({});this.endpoint="",this.blobs=e.collection("blobs"),this.commits=e.collection("commits"),this.trees=e.collection("trees"),this.refs=e.collection("refs")}async getHeader(e){const t=await this.getTree(e,!0),r=[".attributes",".blobs",".messages","header"],n=[];for(const e of t.tree)if("blob"===e.type&&r.reduce(((t,r)=>t||e.path.endsWith(r)),!1)){const t=this.getBlob(e.sha);n.push(t)}return{blobs:await Promise.all(n),tree:t}}async getFullTree(e){throw new Error("Not Supported")}async getBlob(e){var t,r,i,s,o;const a=await this.blobs.findOne({_id:e});return{content:n.IsoBuffer.from(null!==(t=a.content)&&void 0!==t?t:null===(r=a.value)||void 0===r?void 0:r.content,null!==(i=a.encoding)&&void 0!==i?i:null===(s=a.value)||void 0===s?void 0:s.encoding).toString("base64"),encoding:"base64",sha:a._id,size:void 0!==a.content?a.content.length:null===(o=a.value)||void 0===o?void 0:o.content.length,url:""}}async createBlob(e){const t=await(0,n.gitHashFile)(n.IsoBuffer.from(e.content,e.encoding));return await this.blobs.findOrCreate({_id:t},Object.assign(Object.assign({_id:t},e),{value:e})),{sha:t,url:""}}async getContent(e,t){const r=await this.getTree(t,!0);for(const t of r.tree)if(t.path===e)return this.getBlob(t.sha)}async getCommits(e,t){const r=await this.getCommit(e);return r?[{commit:{author:r.author,committer:r.committer,message:r.message,tree:r.tree,url:r.url},parents:r.parents,sha:r.sha,url:r.url}]:[]}async getCommit(e){var t,r,n,i,s;let o=await this.commits.findOne({_id:e});if(!o){const t=await this.getRef(`refs/heads/${e}`);void 0!==t&&(o=await this.commits.findOne({_id:t.object.sha}))}if(o)return{author:{},committer:{},message:null!==(t=o.message)&&void 0!==t?t:null===(r=o.value)||void 0===r?void 0:r.message,parents:void 0!==o.parents?o.parents.map((e=>({sha:e,url:""}))):null===(n=o.value)||void 0===n?void 0:n.parents.map((e=>({sha:e,url:""}))),sha:o._id,tree:{sha:null!==(i=o.tree)&&void 0!==i?i:null===(s=o.value)||void 0===s?void 0:s.tree,url:""},url:""}}async createCommit(e){const t=e.tree;return await this.commits.insertOne(Object.assign(Object.assign({_id:t},e),{value:e})),this.getCommit(t)}async createSummary(e){throw new Error("Not Supported")}async deleteSummary(e){throw new Error("Not Supported")}async getSummary(e){throw new Error("Not Supported")}async getRefs(){throw new Error("Not Supported")}async getRef(e){var t,r,n,i;const s=e.startsWith("refs/")?e.substr(5):e,o=await this.refs.findOne({_id:s});if(o)return{ref:null!==(t=o.ref)&&void 0!==t?t:null===(r=o.value)||void 0===r?void 0:r.ref,url:"",object:{sha:null!==(n=o.sha)&&void 0!==n?n:null===(i=o.value)||void 0===i?void 0:i.sha,url:"",type:""}}}async createRef(e){const t=e.ref.startsWith("refs/")?e.ref.substr(5):e.ref;return await this.refs.insertOne(Object.assign(Object.assign({_id:t},e),{value:e})),this.getRef(e.ref)}async updateRef(e,t){const r=e.startsWith("refs/")?e.substr(5):e;return await(t.force?this.refs.upsert({_id:r},{sha:t.sha,ref:e},{}):this.refs.update({_id:r},{sha:t.sha,ref:e},{})),this.getRef(e)}async deleteRef(e){throw new Error("Not Supported")}async createTag(e){throw new Error("Not Supported")}async getTag(e){throw new Error("Not Supported")}async createTree(e){const t=(0,i.v4)();return await this.trees.insertOne(Object.assign(Object.assign({_id:t},e),{value:e})),this.getTree(t,!1)}async getTree(e,t){return this.getTreeHelper(e,t)}async getTreeHelper(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";var n,i,s;const o=await this.trees.findOne({_id:e});if(o){const e={sha:o._id,url:"",tree:[]};for(const a of null!==(s=null!==(n=o.tree)&&void 0!==n?n:null===(i=o.value)||void 0===i?void 0:i.tree)&&void 0!==s?s:[]){const n=""===r?a.path:`${r}/${a.path}`;if(e.tree.push({mode:a.mode,path:n,sha:a.sha,size:0,type:a.type,url:""}),"tree"===a.type&&t){const r=await this.getTreeHelper(a.sha,t,n);r&&(e.tree=e.tree.concat(r.tree))}}return e}}}},heVN:function(e,t,r){(function(e,t){!function(e,r){"use strict";if(!e.setImmediate){var n,i=1,s={},o=!1,a=e.document,c=Object.getPrototypeOf&&Object.getPrototypeOf(e);c=c&&c.setTimeout?c:e,"[object process]"==={}.toString.call(e.process)?function(){n=function(e){t.nextTick((function(){l(e)}))}}():function(){if(e.postMessage&&!e.importScripts){var t=!0,r=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=r,t}}()?function(){var t="setImmediate$"+Math.random()+"$",r=function(r){r.source===e&&"string"==typeof r.data&&0===r.data.indexOf(t)&&l(+r.data.slice(t.length))};e.addEventListener?e.addEventListener("message",r,!1):e.attachEvent("onmessage",r),n=function(r){e.postMessage(t+r,"*")}}():e.MessageChannel?function(){var e=new MessageChannel;e.port1.onmessage=function(e){l(e.data)},n=function(t){e.port2.postMessage(t)}}():a&&"onreadystatechange"in a.createElement("script")?function(){var e=a.documentElement;n=function(t){var r=a.createElement("script");r.onreadystatechange=function(){l(t),r.onreadystatechange=null,e.removeChild(r),r=null},e.appendChild(r)}}():function(){n=function(e){setTimeout(l,0,e)}}(),c.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),r=0;r<t.length;r++)t[r]=arguments[r+1];var o={callback:e,args:t};return s[i]=o,n(i),i++},c.clearImmediate=u}function u(e){delete s[e]}function l(e){if(o)setTimeout(l,0,e);else{var t=s[e];if(t){o=!0;try{!function(e){var t=e.callback,r=e.args;switch(r.length){case 0:t();break;case 1:t(r[0]);break;case 2:t(r[0],r[1]);break;case 3:t(r[0],r[1],r[2]);break;default:t.apply(void 0,r)}}(t)}finally{u(e),o=!1}}}}}("undefined"==typeof self?void 0===e?this:e:self)}).call(this,r("pCvA"),r("5IsQ"))},hnLz:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CopierLambdaFactory=void 0;const n=r("hBZP"),i=r("/UA3");t.CopierLambdaFactory=class extends n.EventEmitter{constructor(e,t){super(),this.mongoManager=e,this.rawOpCollection=t}async create(e,t){return new i.CopierLambda(this.rawOpCollection,t)}async dispose(){await this.mongoManager.close()}}},hsA5:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PendingBoxcar=t.MaxBatchSize=void 0;const n=r("wWog");t.MaxBatchSize=32,t.PendingBoxcar=class{constructor(e,t){this.tenantId=e,this.documentId=t,this.deferred=new n.Deferred,this.messages=[]}}},i1Dz:function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return i(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ScribeLambda=void 0;const a=o(r("ZERR")),c=r("4+3C"),u=r("y2M+"),l=r("MPeK"),h=r("tp/L"),d=o(r("3YFW")),m=s(r("9va6")),p=r("Txkb"),f=r("jKCC");t.ScribeLambda=class{constructor(e,t,r,n,i,s,o,a,c,u,l,h,m,p,f){this.context=e,this.tenantId=t,this.documentId=r,this.summaryWriter=n,this.summaryReader=i,this.pendingMessageReader=s,this.checkpointManager=o,this.serviceConfiguration=c,this.producer=u,this.protocolHandler=l,this.term=h,this.protocolHead=m,this.scribeSessionMetric=f,this.pendingCheckpointMessages=new d.default,this.sequenceNumber=0,this.minSequenceNumber=0,this.clearCache=!1,this.closed=!1,this.checkpointInfo={lastCheckpointTime:Date.now(),rawMessagesSinceCheckpoint:0},this.noActiveClients=!1,this.lastOffset=a.logOffset,this.setStateFromCheckpoint(a),this.pendingMessages=new d.default(p)}async handler(e){var t,r,n,i,s,o,m,g;if(e.offset<=this.lastOffset)return this.updateCheckpointMessages(e),void this.context.checkpoint(e);const y=(0,l.extractBoxcar)(e);for(const e of y.contents)if(e.type===l.SequencedOperationType){const l=e;if(this.term&&l.operation.term){if(l.operation.term<this.term)continue;if(l.operation.term>this.term){const e=await this.summaryReader.readLastSummary();if(!e.fromSummary)throw Error("Required summary can't be fetched");this.term=e.term;const t=JSON.parse(e.scribe);this.updateProtocolHead(e.protocolHead),this.protocolHandler=(0,f.initializeProtocol)(t.protocolState,this.term),this.setStateFromCheckpoint(t),this.pendingMessages=new d.default(e.messages.filter((e=>e.sequenceNumber>t.protocolState.sequenceNumber))),this.pendingP=void 0,this.pendingCheckpointScribe=void 0,this.pendingCheckpointOffset=void 0,await this.checkpointManager.delete(t.sequenceNumber+1,!1)}}if(l.operation.sequenceNumber<=this.sequenceNumber)continue;const p=null!==(r=null===(t=this.pendingMessages.peekBack())||void 0===t?void 0:t.sequenceNumber)&&void 0!==r?r:this.protocolHandler.sequenceNumber;if(l.operation.sequenceNumber<=p)continue;if(l.operation.sequenceNumber!==p+1){if(void 0===this.pendingMessageReader)throw new Error(`Invalid message sequence number.Current message @${l.operation.sequenceNumber}.ProtocolHandler @${p}`);{const e=p+1,t=l.operation.sequenceNumber-1,r=await this.pendingMessageReader.readMessages(e,t);for(const e of r)this.pendingMessages.push(e)}}this.pendingMessages.push(l.operation),this.serviceConfiguration.scribe.enablePendingCheckpointMessages&&this.pendingCheckpointMessages.push(l);const y=this.minSequenceNumber!==l.operation.minimumSequenceNumber;if(this.sequenceNumber=l.operation.sequenceNumber,this.minSequenceNumber=l.operation.minimumSequenceNumber,y&&this.processFromPending(this.minSequenceNumber),this.clearCache=!1,l.operation.type!==u.MessageType.Summarize||(null===(n=l.operation.serverMetadata)||void 0===n?void 0:n.deliAcked)){if(l.operation.type===u.MessageType.NoClient){if((0,a.default)(l.operation.referenceSequenceNumber===l.operation.sequenceNumber,`${l.operation.referenceSequenceNumber} != ${l.operation.sequenceNumber}`),(0,a.default)(l.operation.minimumSequenceNumber===l.operation.sequenceNumber,`${l.operation.minimumSequenceNumber} != ${l.operation.sequenceNumber}`),this.noActiveClients=!0,this.serviceConfiguration.scribe.generateServiceSummary){const e=l.operation,t=this.generateScribeCheckpoint(this.lastOffset);try{const r=await this.summaryWriter.writeServiceSummary(e,this.protocolHead,t,this.pendingCheckpointMessages.toArray());if(r){this.serviceConfiguration.scribe.clearCacheAfterServiceSummary&&(this.clearCache=!0),await this.sendSummaryConfirmationMessage(e.sequenceNumber,!1,this.serviceConfiguration.scribe.clearCacheAfterServiceSummary),this.updateLastSummarySequenceNumber(e.sequenceNumber),this.updateValidParentSummaries(r);const t=`Service summary success @${e.sequenceNumber}`;null===(m=this.context.log)||void 0===m||m.info(t,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),h.Lumberjack.info(t,(0,h.getLumberBaseProperties)(this.documentId,this.tenantId))}}catch(t){const r=`Service summary failure @${e.sequenceNumber}`;if(!this.serviceConfiguration.scribe.ignoreStorageException)throw t;null===(g=this.context.log)||void 0===g||g.error(r,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),h.Lumberjack.error(r,(0,h.getLumberBaseProperties)(this.documentId,this.tenantId),t)}}}else if(l.operation.type===u.MessageType.SummaryAck){const e=l.operation,t=e.data?JSON.parse(e.data):e.contents;this.lastClientSummaryHead=t.handle,this.validParentSummaries=void 0,this.summaryWriter.isExternal&&(this.updateProtocolHead(t.summaryProposal.summarySequenceNumber),this.updateLastSummarySequenceNumber(t.summaryProposal.summarySequenceNumber))}}else if(!this.summaryWriter.isExternal||l.operation.referenceSequenceNumber>=this.protocolHandler.sequenceNumber){const e={protocolState:this.protocolHandler.getProtocolState(),pendingOps:this.pendingMessages.toArray()};if(this.processFromPending(l.operation.referenceSequenceNumber),this.protocolHead<this.protocolHandler.sequenceNumber)try{const t=this.generateScribeCheckpoint(this.lastOffset),r=l.operation,n=await this.summaryWriter.writeClientSummary(r,this.lastClientSummaryHead,t,this.pendingCheckpointMessages.toArray());if(!this.summaryWriter.isExternal)if(n.status){await this.sendSummaryAck(n.message),await this.sendSummaryConfirmationMessage(r.sequenceNumber,!0,!1),this.updateProtocolHead(this.protocolHandler.sequenceNumber),this.updateLastSummarySequenceNumber(this.protocolHandler.sequenceNumber);const e=`Client summary success @${l.operation.sequenceNumber}`;null===(i=this.context.log)||void 0===i||i.info(e,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),h.Lumberjack.info(e,(0,h.getLumberBaseProperties)(this.documentId,this.tenantId))}else{const t=n.message;await this.sendSummaryNack(t);const r=`Client summary failure @${l.operation.sequenceNumber}. Error: ${t.message}`;null===(s=this.context.log)||void 0===s||s.error(r,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),h.Lumberjack.error(r,(0,h.getLumberBaseProperties)(this.documentId,this.tenantId)),this.revertProtocolState(e.protocolState,e.pendingOps)}}catch(t){const r=`Client summary failure @${l.operation.sequenceNumber}`;if(null===(o=this.context.log)||void 0===o||o.error(`${r} Exception: ${(0,c.inspect)(t)}`),h.Lumberjack.error(r,(0,h.getLumberBaseProperties)(this.documentId,this.tenantId),t),this.revertProtocolState(e.protocolState,e.pendingOps),!this.serviceConfiguration.scribe.ignoreStorageException)throw t;await this.sendSummaryNack({message:"Failed to summarize the document.",summaryProposal:{summarySequenceNumber:l.operation.sequenceNumber}})}}}if(this.updateCheckpointMessages(e),this.checkpointInfo.rawMessagesSinceCheckpoint++,this.noActiveClients)this.prepareCheckpoint(e,p.CheckpointReason.NoClients),this.noActiveClients=!1;else{const t=this.getCheckpointReason();void 0!==t?this.prepareCheckpoint(e,t):this.updateCheckpointIdleTimer()}}prepareCheckpoint(e,t){var r,n,i,s;const o=this.generateScribeCheckpoint(e.offset);this.updateCheckpointMessages(e),this.checkpoint(t),this.checkpointCore(o,e,this.clearCache),this.lastOffset=e.offset;const a=p.CheckpointReason[t],c=`Writing checkpoint. Reason: ${a}`,u=Object.assign(Object.assign({},(0,h.getLumberBaseProperties)(this.documentId,this.tenantId)),{checkpointReason:a,lastOffset:this.lastOffset,scribeCheckpointOffset:null===(r=this.checkpointInfo.currentCheckpointMessage)||void 0===r?void 0:r.offset,scribeCheckpointPartition:null===(n=this.checkpointInfo.currentCheckpointMessage)||void 0===n?void 0:n.partition,kafkaCheckpointOffset:null===(i=this.checkpointInfo.currentKafkaCheckpointMessage)||void 0===i?void 0:i.offset,kafkaCheckpointPartition:null===(s=this.checkpointInfo.currentKafkaCheckpointMessage)||void 0===s?void 0:s.partition});h.Lumberjack.info(c,u)}close(e){this.logScribeSessionMetrics(e),this.closed=!0,this.protocolHandler.close()}logScribeSessionMetrics(e){var t;(null===(t=this.scribeSessionMetric)||void 0===t?void 0:t.isCompleted())&&(h.Lumberjack.info("Scribe session metric already completed. Creating a new one.",(0,h.getLumberBaseProperties)(this.documentId,this.tenantId)),this.scribeSessionMetric=(0,p.createSessionMetric)(this.tenantId,this.documentId,h.LumberEventName.ScribeSessionResult,this.serviceConfiguration)),(0,p.logCommonSessionEndMetrics)(this.context,e,this.scribeSessionMetric,this.sequenceNumber,this.protocolHead,void 0)}processFromPending(e){for(var t;this.pendingMessages.length>0&&this.pendingMessages.peekFront().sequenceNumber<=e;){const e=this.pendingMessages.shift();try{if(e.contents&&"string"==typeof e.contents&&e.type!==u.MessageType.ClientLeave){const t=m.cloneDeep(e);t.contents=JSON.parse(t.contents),this.protocolHandler.processMessage(t,!1)}else this.protocolHandler.processMessage(e,!1)}catch(e){throw null===(t=this.context.log)||void 0===t||t.error(`Protocol error ${e}`,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),h.Lumberjack.error("Protocol error",(0,h.getLumberBaseProperties)(this.documentId,this.tenantId),e),new Error(`Protocol error ${e} for ${this.documentId} ${this.tenantId}`)}}}revertProtocolState(e,t){this.protocolHandler=(0,f.initializeProtocol)(e,this.term),this.pendingMessages=new d.default(t)}generateScribeCheckpoint(e){const t=this.protocolHandler.getProtocolState();return{lastSummarySequenceNumber:this.lastSummarySequenceNumber,lastClientSummaryHead:this.lastClientSummaryHead,logOffset:e,minimumSequenceNumber:this.minSequenceNumber,protocolState:t,sequenceNumber:this.sequenceNumber,validParentSummaries:this.validParentSummaries}}checkpointCore(e,t,r){if(!this.closed){if(this.pendingP)return this.pendingCheckpointScribe=e,void(this.pendingCheckpointOffset=t);this.pendingP=r?this.checkpointManager.delete(this.protocolHead,!0):this.writeCheckpoint(e),this.pendingP.then((()=>{this.pendingP=void 0,this.context.checkpoint(t);const e=this.pendingCheckpointScribe,n=this.pendingCheckpointOffset;e&&n&&(this.pendingCheckpointScribe=void 0,this.pendingCheckpointOffset=void 0,this.checkpointCore(e,n,r))}),(e=>{h.Lumberjack.error("Checkpoint error",(0,h.getLumberBaseProperties)(this.documentId,this.tenantId),e)}))}}async writeCheckpoint(e){const t=this.pendingCheckpointMessages.toArray();if(await this.checkpointManager.write(e,this.protocolHead,t),t.length>0){const e=t[t.length-1].operation.sequenceNumber;for(;this.pendingCheckpointMessages.length>0&&this.pendingCheckpointMessages.peekFront().operation.sequenceNumber<=e;)this.pendingCheckpointMessages.removeFront()}}updateProtocolHead(e){this.protocolHead=e}updateLastSummarySequenceNumber(e){this.lastSummarySequenceNumber=e}updateValidParentSummaries(e){void 0===this.validParentSummaries&&(this.validParentSummaries=[]),this.validParentSummaries.push(e)}async sendSummaryAck(e){const t={clientSequenceNumber:-1,contents:e,data:JSON.stringify(e),referenceSequenceNumber:-1,traces:this.serviceConfiguration.enableTraces?[]:void 0,type:u.MessageType.SummaryAck};return(0,f.sendToDeli)(this.tenantId,this.documentId,this.producer,t)}async sendSummaryNack(e){const t={clientSequenceNumber:-1,contents:e,data:JSON.stringify(e),referenceSequenceNumber:-1,traces:this.serviceConfiguration.enableTraces?[]:void 0,type:u.MessageType.SummaryNack};return(0,f.sendToDeli)(this.tenantId,this.documentId,this.producer,t)}async sendSummaryConfirmationMessage(e,t,r){const n={clientSequenceNumber:-1,contents:null,data:JSON.stringify({type:l.ControlMessageType.UpdateDSN,contents:{durableSequenceNumber:e,isClientSummary:t,clearCache:r}}),referenceSequenceNumber:-1,traces:this.serviceConfiguration.enableTraces?[]:void 0,type:u.MessageType.Control};return(0,f.sendToDeli)(this.tenantId,this.documentId,this.producer,n)}setStateFromCheckpoint(e){this.sequenceNumber=e.sequenceNumber,this.minSequenceNumber=e.minimumSequenceNumber,this.lastClientSummaryHead=e.lastClientSummaryHead,this.lastSummarySequenceNumber=e.lastSummarySequenceNumber,this.validParentSummaries=e.validParentSummaries}updateCheckpointMessages(e){if(this.checkpointInfo.currentCheckpointMessage=e,this.noActiveClients)this.checkpointInfo.nextKafkaCheckpointMessage=void 0,this.checkpointInfo.currentKafkaCheckpointMessage=e;else{const t=this.checkpointInfo.nextKafkaCheckpointMessage;this.checkpointInfo.nextKafkaCheckpointMessage=e,this.checkpointInfo.currentKafkaCheckpointMessage=t}}getCheckpointReason(){const e=this.serviceConfiguration.scribe.checkpointHeuristics;return e.enable?this.checkpointInfo.rawMessagesSinceCheckpoint>=e.maxMessages?p.CheckpointReason.MaxMessages:Date.now()-this.checkpointInfo.lastCheckpointTime>=e.maxTime?p.CheckpointReason.MaxTime:void 0:p.CheckpointReason.EveryMessage}clearCheckpointIdleTimer(){void 0!==this.checkpointInfo.idleTimer&&(clearTimeout(this.checkpointInfo.idleTimer),this.checkpointInfo.idleTimer=void 0)}checkpoint(e){this.clearCheckpointIdleTimer(),this.checkpointInfo.lastCheckpointTime=Date.now(),this.checkpointInfo.rawMessagesSinceCheckpoint=0}updateCheckpointIdleTimer(){this.clearCheckpointIdleTimer();const e=this.checkpointInfo.currentCheckpointMessage;this.checkpointInfo.idleTimer=setTimeout((()=>{var t,r,n,i;if(this.checkpointInfo.idleTimer=void 0,e===this.checkpointInfo.currentCheckpointMessage&&(this.checkpoint(p.CheckpointReason.IdleTime),e)){this.checkpointCore(this.generateScribeCheckpoint(e.offset),e,this.clearCache);const s="Writing checkpoint. Reason: IdleTime",o=Object.assign(Object.assign({},(0,h.getLumberBaseProperties)(this.documentId,this.tenantId)),{checkpointReason:"IdleTime",lastOffset:e.offset,deliCheckpointOffset:null===(t=this.checkpointInfo.currentCheckpointMessage)||void 0===t?void 0:t.offset,deliCheckpointPartition:null===(r=this.checkpointInfo.currentCheckpointMessage)||void 0===r?void 0:r.partition,kafkaCheckpointOffset:null===(n=this.checkpointInfo.currentKafkaCheckpointMessage)||void 0===n?void 0:n.offset,kafkaCheckpointPartition:null===(i=this.checkpointInfo.currentKafkaCheckpointMessage)||void 0===i?void 0:i.partition});h.Lumberjack.info(s,o)}}),this.serviceConfiguration.scribe.checkpointHeuristics.idleTime)}}},i1rq:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DeliLambdaFactory=t.OpEventType=t.DeliLambda=t.createDeliCheckpointManagerFromCollection=void 0;var n=r("AK04");Object.defineProperty(t,"createDeliCheckpointManagerFromCollection",{enumerable:!0,get:function(){return n.createDeliCheckpointManagerFromCollection}});var i=r("xkYN");Object.defineProperty(t,"DeliLambda",{enumerable:!0,get:function(){return i.DeliLambda}}),Object.defineProperty(t,"OpEventType",{enumerable:!0,get:function(){return i.OpEventType}});var s=r("xiYf");Object.defineProperty(t,"DeliLambdaFactory",{enumerable:!0,get:function(){return s.DeliLambdaFactory}})},iPMj:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MessageFactory=t.KafkaMessageFactory=void 0;const n=r("y2M+"),i=r("MPeK"),s=r("zcKR");t.KafkaMessageFactory=class{constructor(){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,t=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;this.topic=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"test",this.stringify=t,this.tenantId=r,this.documentId=n,this.offsets=[];for(let t=0;t<e;t++)this.offsets.push(0)}sequenceMessage(e,t){const r=this.getPartition(t);return{offset:this.offsets[r]++,partition:r,topic:this.topic,value:this.stringify?JSON.stringify(e):{contents:Array.isArray(e)?e:[e],documentId:this.documentId,tenantId:this.tenantId,type:i.BoxcarType}}}getHeadOffset(e){return this.offsets[this.getPartition(e)]-1}getPartition(e){return s(e)%this.offsets.length}},t.MessageFactory=class{constructor(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"test";this.documentId=e,this.clientId=t,this.tenantId=r,this.clientSequenceNumber=0,this.sequenceNumber=0}createDocumentMessage(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:n.MessageType.Operation,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return{clientSequenceNumber:++this.clientSequenceNumber,contents:null,metadata:void 0,referenceSequenceNumber:t,traces:[],type:e,compression:void 0}}create(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:n.MessageType.Operation,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Date.now();const i=this.createDocumentMessage(e,t);return this.createRawOperation(i,r,this.clientId)}createJoin(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Date.now(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;const r={clientSequenceNumber:-1,contents:null,data:JSON.stringify({clientId:this.clientId,detail:{mode:"write",permission:[],scopes:[n.ScopeType.DocRead,n.ScopeType.DocWrite,n.ScopeType.SummaryWrite],details:{capabilities:{interactive:!0}},user:null}}),referenceSequenceNumber:-1,traces:[],type:n.MessageType.ClientJoin,serverMetadata:t};return this.createRawOperation(r,e,null)}createLeave(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Date.now();const t={clientSequenceNumber:-1,contents:null,data:JSON.stringify(this.clientId),referenceSequenceNumber:-1,traces:[],type:n.MessageType.ClientLeave};return this.createRawOperation(t,e,null)}createRawOperation(e,t,r){return{clientId:r,documentId:this.documentId,operation:e,tenantId:this.tenantId,timestamp:t,type:i.RawOperationType}}createSequencedOperation(){const e=this.createDocumentMessage(n.MessageType.Operation,arguments.length>0&&void 0!==arguments[0]?arguments[0]:0),t={clientId:this.clientId,clientSequenceNumber:e.clientSequenceNumber,contents:e.contents,metadata:e.metadata,minimumSequenceNumber:0,origin:void 0,referenceSequenceNumber:e.referenceSequenceNumber,sequenceNumber:this.sequenceNumber++,term:1,timestamp:Date.now(),traces:[],type:e.type};return{documentId:this.documentId,operation:t,tenantId:this.tenantId,type:i.SequencedOperationType}}createSummarize(e,t){const r=this.createDocumentMessage(n.MessageType.Summarize,e),s={clientId:this.clientId,clientSequenceNumber:r.clientSequenceNumber,contents:`{"handle": "${t}" ,"head":null,"message":"","parents":[]}`,metadata:r.metadata,minimumSequenceNumber:0,origin:void 0,referenceSequenceNumber:r.referenceSequenceNumber,sequenceNumber:this.sequenceNumber++,term:1,timestamp:Date.now(),traces:[],type:r.type,additionalContent:""};return{documentId:this.documentId,operation:s,tenantId:this.tenantId,type:i.SequencedOperationType}}createNoClient(){const e=this.createDocumentMessage(n.MessageType.NoClient,arguments.length>0&&void 0!==arguments[0]?arguments[0]:0),t={clientId:this.clientId,clientSequenceNumber:e.clientSequenceNumber,contents:e.contents,metadata:e.metadata,minimumSequenceNumber:this.sequenceNumber,origin:void 0,referenceSequenceNumber:this.sequenceNumber,sequenceNumber:this.sequenceNumber++,term:1,timestamp:Date.now(),traces:[],type:e.type,additionalContent:""};return{documentId:this.documentId,operation:t,tenantId:this.tenantId,type:i.SequencedOperationType}}createSummaryAck(e){const t=this.createDocumentMessage(n.MessageType.SummaryAck,0),r={clientId:null,clientSequenceNumber:-1,contents:{handle:e,summaryProposal:{summarySequenceNumber:1}},metadata:t.metadata,minimumSequenceNumber:0,origin:void 0,referenceSequenceNumber:-1,sequenceNumber:this.sequenceNumber++,term:1,timestamp:Date.now(),traces:[],type:t.type,additionalContent:""};return{documentId:this.documentId,operation:r,tenantId:this.tenantId,type:i.SequencedOperationType}}}},iS6B:function(e,t,r){"use strict";r.r(t),r.d(t,"addBlobToTree",(function(){return n.d})),r.d(t,"AttachmentTreeEntry",(function(){return n.a})),r.d(t,"BlobTreeEntry",(function(){return n.b})),r.d(t,"buildHierarchy",(function(){return n.e})),r.d(t,"getGitMode",(function(){return n.f})),r.d(t,"getGitType",(function(){return n.g})),r.d(t,"TreeTreeEntry",(function(){return n.c})),r.d(t,"isSystemMessage",(function(){return d})),r.d(t,"ProtocolOpHandler",(function(){return m})),r.d(t,"Quorum",(function(){return h})),r.d(t,"QuorumClients",(function(){return u})),r.d(t,"QuorumProposals",(function(){return l})),r.d(t,"generateServiceProtocolEntries",(function(){return y})),r.d(t,"getQuorumTreeEntries",(function(){return f})),r.d(t,"mergeAppAndProtocolTree",(function(){return g})),r.d(t,"isServiceMessageType",(function(){return b}));var n=r("oEwc"),i=r("f79D"),s=r("hBZP"),o=r("NgDi"),a=r("he5V");class c{constructor(e,t,r,n){this.sequenceNumber=e,this.key=t,this.value=r,this.local=n}}class u extends o.a{constructor(e){super(),this.isDisposed=!1,this.members=new Map(e),this.snapshotCache=e}get disposed(){return this.isDisposed}snapshot(){var e;return null!==(e=this.snapshotCache)&&void 0!==e||(this.snapshotCache=Array.from(this.members)),this.snapshotCache}addMember(e,t){Object(a.a)(!!e,1135),Object(a.a)(!this.members.has(e),462),this.members.set(e,t),this.emit("addMember",e,t),this.snapshotCache=void 0}removeMember(e){Object(a.a)(!!e,1136),Object(a.a)(this.members.has(e),463),this.members.delete(e),this.emit("removeMember",e),this.snapshotCache=void 0}getMembers(){return new Map(this.members)}getMember(e){return this.members.get(e)}dispose(){this.isDisposed=!0}}class l extends o.a{constructor(e,t){super(),this.sendProposal=t,this.isDisposed=!1,this.stateEvents=new s.EventEmitter,this.proposals=new Map(e.proposals.map((e=>{let[,t]=e;return[t.sequenceNumber,new c(t.sequenceNumber,t.key,t.value,!1)]}))),this.values=new Map(e.values),this.proposalsSnapshotCache=e.proposals,this.valuesSnapshotCache=e.values}get disposed(){return this.isDisposed}snapshot(){var e,t;return null!==(e=this.proposalsSnapshotCache)&&void 0!==e||(this.proposalsSnapshotCache=Array.from(this.proposals).map((e=>{let[t,r]=e;return[t,{sequenceNumber:t,key:r.key,value:r.value},[]]}))),null!==(t=this.valuesSnapshotCache)&&void 0!==t||(this.valuesSnapshotCache=Array.from(this.values)),{proposals:this.proposalsSnapshotCache,values:this.valuesSnapshotCache}}has(e){return this.values.has(e)}get(e){var t;return null===(t=this.values.get(e))||void 0===t?void 0:t.value}getApprovalData(e){return this.values.get(e)}async propose(e,t){const r=this.sendProposal(e,t);if(r<0)throw this.emit("error",{eventName:"ProposalInDisconnectedState",key:e}),new Error("Can't propose in disconnected state");return new Promise(((e,t)=>{let n;const i=(e,t)=>{e===r&&(n=t,this.stateEvents.off("localProposalSequenced",i),this.stateEvents.off("disconnected",o),this.stateEvents.on("localProposalApproved",s))},s=t=>{t===n&&(e(),c())},o=()=>{void 0===n&&this.stateEvents.once("connected",(()=>{void 0===n&&(t(new Error("Client disconnected without successfully sending proposal")),c())}))},a=()=>{t(new Error("QuorumProposals was disposed")),c()},c=()=>{this.stateEvents.off("localProposalSequenced",i),this.stateEvents.off("localProposalApproved",s),this.stateEvents.off("disconnected",o),this.stateEvents.off("disposed",a)};this.stateEvents.on("localProposalSequenced",i),this.stateEvents.on("disconnected",o),this.stateEvents.on("disposed",a)}))}addProposal(e,t,r,n,i){Object(a.a)(!this.proposals.has(r),464);const s=new c(r,e,t,n);this.proposals.set(r,s),this.emit("addProposal",s),n&&this.stateEvents.emit("localProposalSequenced",i,r),this.proposalsSnapshotCache=void 0}updateMinimumSequenceNumber(e){const t=e.minimumSequenceNumber,r=[];for(const[e,n]of this.proposals)e<=t&&r.push(n);r.sort(((e,t)=>e.sequenceNumber-t.sequenceNumber));for(const t of r){const r={approvalSequenceNumber:e.sequenceNumber,commitSequenceNumber:-1,key:t.key,sequenceNumber:t.sequenceNumber,value:t.value};this.values.set(r.key,r),this.valuesSnapshotCache=void 0,this.emit("approveProposal",r.sequenceNumber,r.key,r.value,r.approvalSequenceNumber),this.proposals.delete(t.sequenceNumber),this.proposalsSnapshotCache=void 0,t.local&&this.stateEvents.emit("localProposalApproved",t.sequenceNumber)}}setConnectionState(e){this.stateEvents.emit(e?"connected":"disconnected")}dispose(){this.isDisposed=!0,this.stateEvents.emit("disposed")}}class h extends o.a{constructor(e,t,r,n){super(),this.isDisposed=!1,this.quorumClients=new u(e),this.quorumClients.on("addMember",((e,t)=>{this.emit("addMember",e,t)})),this.quorumClients.on("removeMember",(e=>{this.emit("removeMember",e)})),this.quorumProposals=new l({proposals:t,values:r},n),this.quorumProposals.on("addProposal",(e=>{this.emit("addProposal",e)})),this.quorumProposals.on("approveProposal",((e,t,r,n)=>{this.emit("approveProposal",e,t,r,n)}))}get disposed(){return this.isDisposed}close(){this.removeAllListeners()}snapshot(){const e=this.quorumClients.snapshot(),{proposals:t,values:r}=this.quorumProposals.snapshot();return{members:e,proposals:t,values:r}}has(e){return this.quorumProposals.has(e)}get(e){return this.quorumProposals.get(e)}getApprovalData(e){return this.quorumProposals.getApprovalData(e)}addMember(e,t){this.quorumClients.addMember(e,t)}removeMember(e){this.quorumClients.removeMember(e)}getMembers(){return this.quorumClients.getMembers()}getMember(e){return this.quorumClients.getMember(e)}async propose(e,t){return this.quorumProposals.propose(e,t)}addProposal(e,t,r,n,i){return this.quorumProposals.addProposal(e,t,r,n,i)}updateMinimumSequenceNumber(e){this.quorumProposals.updateMinimumSequenceNumber(e)}setConnectionState(e,t){this.quorumProposals.setConnectionState(e)}dispose(){throw new Error("Not implemented.")}}function d(e){switch(e.type){case i.a.ClientJoin:case i.a.ClientLeave:case i.a.Propose:case i.a.Reject:case i.a.NoOp:case i.a.NoClient:case i.a.Summarize:case i.a.SummaryAck:case i.a.SummaryNack:return!0;default:return!1}}class m{constructor(e,t,r,n,i,s,o){this.minimumSequenceNumber=e,this.sequenceNumber=t,this.term=null!=r?r:1,this._quorum=new h(n,i,s,o)}get quorum(){return this._quorum}get attributes(){return{minimumSequenceNumber:this.minimumSequenceNumber,sequenceNumber:this.sequenceNumber,term:this.term}}setConnectionState(e,t){this._quorum.setConnectionState(e,t)}snapshot(){return this._quorum.snapshot()}close(){this._quorum.close()}processMessage(e,t){if(e.sequenceNumber!==this.sequenceNumber+1)throw new Error(`Protocol state is not moving sequentially. Current is ${this.sequenceNumber}. Next is ${e.sequenceNumber}`);this.sequenceNumber=e.sequenceNumber,this.minimumSequenceNumber=e.minimumSequenceNumber;let r=!1;switch(e.type){case i.a.ClientJoin:const n=e,s=JSON.parse(n.data);this._quorum.addMember(s.clientId,{client:s.detail,sequenceNumber:n.sequenceNumber});break;case i.a.ClientLeave:const o=JSON.parse(e.data);this._quorum.removeMember(o);break;case i.a.Propose:"string"==typeof e.contents&&(e.contents=JSON.parse(e.contents));const a=e.contents;this._quorum.addProposal(a.key,a.value,e.sequenceNumber,t,e.clientSequenceNumber),r=!0}return this._quorum.updateMinimumSequenceNumber(e),{immediateNoOp:r}}getProtocolState(){return Object.assign({sequenceNumber:this.sequenceNumber,minimumSequenceNumber:this.minimumSequenceNumber},this._quorum.snapshot())}}var p=r("l4ds");function f(e,t,r,n,i){const s={minimumSequenceNumber:t,sequenceNumber:r,term:n};return[{mode:p.a.File,path:"quorumMembers",type:p.b.Blob,value:{contents:JSON.stringify(i.members),encoding:"utf-8"}},{mode:p.a.File,path:"quorumProposals",type:p.b.Blob,value:{contents:JSON.stringify(i.proposals),encoding:"utf-8"}},{mode:p.a.File,path:"quorumValues",type:p.b.Blob,value:{contents:JSON.stringify(i.values),encoding:"utf-8"}},{mode:p.a.File,path:"attributes",type:p.b.Blob,value:{contents:JSON.stringify(s),encoding:"utf-8"}}]}function g(e,t){const r=e.tree.filter((e=>!v(e.path))).map((e=>({mode:e.mode,path:e.path,sha:e.sha,type:e.type})));return r.push({mode:p.a.Directory,path:".protocol",sha:t.sha,type:"tree"}),r}function y(e,t){const r=[{mode:p.a.File,path:"deli",type:p.b.Blob,value:{contents:e,encoding:"utf-8"}}];return r.push({mode:p.a.File,path:"scribe",type:p.b.Blob,value:{contents:t,encoding:"utf-8"}}),r}const v=e=>".protocol"===e||".logTail"===e||".serviceProtocol"===e,b=e=>e===i.a.ClientJoin||e===i.a.ClientLeave||e===i.a.Control||e===i.a.NoClient||e===i.a.SummaryAck||e===i.a.SummaryNack},iYGh:function(e,t,r){"use strict";r.r(t),r.d(t,"generateToken",(function(){return d})),r.d(t,"generateUser",(function(){return m})),r.d(t,"validateTokenClaims",(function(){return l})),r.d(t,"validateTokenClaimsExpiration",(function(){return h})),r.d(t,"convertSortedNumberArrayToRanges",(function(){return p})),r.d(t,"CorrelationIdHeaderName",(function(){return f})),r.d(t,"DriverVersionHeaderName",(function(){return g})),r.d(t,"LatestSummaryId",(function(){return y})),r.d(t,"createFluidServiceNetworkError",(function(){return c})),r.d(t,"isNetworkError",(function(){return a})),r.d(t,"NetworkError",(function(){return o})),r.d(t,"throwFluidServiceNetworkError",(function(){return u})),r.d(t,"choose",(function(){return v.a})),r.d(t,"getRandomName",(function(){return v.b})),r.d(t,"GitManager",(function(){return b.a})),r.d(t,"getAuthorizationTokenFromCredentials",(function(){return M})),r.d(t,"Historian",(function(){return k})),r.d(t,"promiseTimeout",(function(){return L})),r.d(t,"RestLessClient",(function(){return F})),r.d(t,"RestLessFieldNames",(function(){return R})),r.d(t,"BasicRestWrapper",(function(){return x})),r.d(t,"RestWrapper",(function(){return P})),r.d(t,"defaultHash",(function(){return A.a})),r.d(t,"getNextHash",(function(){return A.b})),r.d(t,"canRead",(function(){return q})),r.d(t,"canSummarize",(function(){return _})),r.d(t,"canWrite",(function(){return B})),r.d(t,"canRevokeToken",(function(){return H})),r.d(t,"buildTreePath",(function(){return J})),r.d(t,"convertSummaryTreeToWholeSummaryTree",(function(){return G})),r.d(t,"convertWholeFlatSummaryToSnapshotTreeAndBlobs",(function(){return Q})),r.d(t,"SummaryTreeUploadManager",(function(){return X.a})),r.d(t,"getOrCreateRepository",(function(){return Z})),r.d(t,"WholeSummaryUploadManager",(function(){return Y}));var n=r("jSVn"),i=r("UNwp"),s=r("A3AF");class o extends Error{constructor(e,t,r,n,i){super(t),this.code=e,this.canRetry=r,this.isFatal=n,this.retryAfterMs=i,this.name="NetworkError",this.retryAfter=void 0!==i?i/1e3:void 0}get details(){return void 0===this.canRetry&&void 0===this.isFatal&&void 0===this.retryAfterMs?this.message:{message:this.message,canRetry:this.canRetry,isFatal:this.isFatal,retryAfter:this.retryAfter,retryAfterMs:this.retryAfterMs}}toJSON(){return{code:this.code,message:this.message,canRetry:this.canRetry,isFatal:this.isFatal,retryAfterMs:this.retryAfterMs,retryAfter:this.retryAfter}}}function a(e){return"NetworkError"===e.name&&"number"==typeof e.code&&"string"==typeof e.message}function c(e,t){var r;let n,i,s,a;switch(t&&"object"==typeof t?(n=null!==(r=t.message)&&void 0!==r?r:"Unknown Error",i=t.canRetry,s=t.isFatal,a=t.retryAfter):n=t&&"string"==typeof t?t:"Unknown Error",e){case 401:case 403:case 404:return new o(e,n,!1,!1);case 413:case 422:return new o(e,n,null!=i&&i,null!=s&&s,i?a:void 0);case 429:return new o(e,n,!0,!1,a);case 500:return new o(e,n,null==i||i,null!=s&&s,i?a:void 0);case 502:case 503:case 504:return new o(e,n,!0,!1,a);default:return new o(e,n,!1,!0)}}function u(e,t){throw c(e,t)}function l(e,t,r){if("string"!=typeof e)throw new o(403,"Token must be a string. Received: "+typeof e);const n=Object(i.a)(e);if(!n||n.documentId!==t||n.tenantId!==r)throw new o(403,"DocumentId and/or TenantId in token claims do not match requested resource");if(void 0===n.scopes||0===n.scopes.length)throw new o(403,"Missing scopes in token claims");return n}function h(e,t){if(!e.exp||!e.iat||e.exp-e.iat>t)throw new o(403,"Invalid token expiry");const r=1e3*e.exp-(new Date).getTime();if(r<0)throw new o(401,"Expired token");return r}function d(e,t,r,i,o){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:3600,c=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"1.0",u=o||m();""!==u.id&&void 0!==u.id||(u=m());const l=Math.round((new Date).getTime()/1e3),h={documentId:t,scopes:i,tenantId:e,user:u,iat:l,exp:l+a,ver:c,jti:Object(s.a)()},d={utf8:r};return n.KJUR.jws.JWS.sign(null,JSON.stringify({alg:"HS256",typ:"JWT"}),h,d)}function m(){return{id:Object(s.a)(),name:Object(s.a)()}}function p(e){const t=[];if(!(null==e?void 0:e.length))return t;let r=e[0],n=e[0];for(let i=1;i<e.length;i++){const s=e[i];s-n!=1?(t.push([r,n]),r=s,n=s):n=s}return t.push([r,n]),t}const f="x-correlation-id",g="x-driver-version",y="latest";var v=r("AE9X"),b=r("sx7D"),S=r("nCVa"),w=r("UKnr"),C=r("a0Z+"),E=r.n(C),I=r("czhI"),T=r.n(I),N=r("JGNH");class P{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1048576e3,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1048576e3;this.baseurl=e,this.defaultQueryString=t,this.maxBodyLength=r,this.maxContentLength=n}async get(e,t,r){const n={baseURL:this.baseurl,headers:r,maxBodyLength:this.maxBodyLength,maxContentLength:this.maxContentLength,method:"GET",url:`${e}${this.generateQueryString(t)}`};return this.request(n,200)}async post(e,t,r,n){const i={baseURL:this.baseurl,data:t,headers:n,maxBodyLength:this.maxBodyLength,maxContentLength:this.maxContentLength,method:"POST",url:`${e}${this.generateQueryString(r)}`};return this.request(i,201)}async delete(e,t,r){const n={baseURL:this.baseurl,headers:r,maxBodyLength:this.maxBodyLength,maxContentLength:this.maxContentLength,method:"DELETE",url:`${e}${this.generateQueryString(t)}`};return this.request(n,204)}async patch(e,t,r,n){const i={baseURL:this.baseurl,data:t,headers:n,maxBodyLength:this.maxBodyLength,maxContentLength:this.maxContentLength,method:"PATCH",url:`${e}${this.generateQueryString(r)}`};return this.request(i,200)}generateQueryString(e){if(this.defaultQueryString||e){const t=Object.assign(Object.assign({},this.defaultQueryString),e),r=w.stringify(t);if(""!==r)return`?${r}`}return""}}class x extends P{constructor(e){let t=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:T.a,n=arguments.length>6?arguments[6]:void 0,i=arguments.length>7?arguments[7]:void 0,s=arguments.length>8?arguments[8]:void 0;super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},arguments.length>2&&void 0!==arguments[2]?arguments[2]:1048576e3,arguments.length>3&&void 0!==arguments[3]?arguments[3]:1048576e3),this.defaultHeaders=t,this.axios=r,this.refreshDefaultQueryString=n,this.refreshDefaultHeaders=i,this.getCorrelationId=s}async request(e,t){let r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];var n,i;const o=Object.assign({},e);return o.headers=this.generateHeaders(o.headers,null!==(i=null===(n=this.getCorrelationId)||void 0===n?void 0:n.call(this))&&void 0!==i?i:Object(s.a)()),new Promise(((n,i)=>{this.axios.request(o).then((e=>{n(e.data)})).catch((s=>{var a,u,l,h,d,m,p,g,y,v,b,S,w,C;if((null===(a=null==s?void 0:s.response)||void 0===a?void 0:a.status)===t&&n(null===(u=null==s?void 0:s.response)||void 0===u?void 0:u.data),(null==s?void 0:s.config)?Object(N.a)(`[${s.config.method}] request to [${null!==(l=s.config.baseURL)&&void 0!==l?l:""}${null!==(h=s.config.url)&&void 0!==h?h:""}] failed with [${null===(d=s.response)||void 0===d?void 0:d.status}] [${E()(null===(m=s.response)||void 0===m?void 0:m.data,void 0,2)}]`):Object(N.a)(`request to ${o.url} failed ${s?s.message:""}`),429===(null===(p=null==s?void 0:s.response)||void 0===p?void 0:p.status)&&(null===(y=null===(g=null==s?void 0:s.response)||void 0===g?void 0:g.data)||void 0===y?void 0:y.retryAfter)>0&&r)setTimeout((()=>{this.request(o,t).then(n).catch(i)}),1e3*s.response.data.retryAfter);else if(401===(null===(v=null==s?void 0:s.response)||void 0===v?void 0:v.status)&&r&&this.refreshOnAuthError()){const r=Object.assign({},e);r.headers=this.generateHeaders(r.headers,o.headers[f]),this.request(r,t,!1).then(n).catch(i)}else if(null==s?void 0:s.response)i(c(null===(b=null==s?void 0:s.response)||void 0===b?void 0:b.status,null===(S=null==s?void 0:s.response)||void 0===S?void 0:S.data));else if(null==s?void 0:s.request)i(c(502,`Network Error: ${null!==(w=null==s?void 0:s.message)&&void 0!==w?w:"undefined"}`));else{const e={canRetry:!1,isFatal:!1,message:null!==(C=null==s?void 0:s.message)&&void 0!==C?C:"Unknown Error"};i(c(500,e))}}))}))}generateHeaders(e,t){let r=null!=e?e:{};return this.defaultHeaders&&(r=Object.assign(Object.assign({},this.defaultHeaders),e)),r[f]?r:Object.assign({[f]:t},r)}refreshOnAuthError(){return(void 0!==this.refreshDefaultQueryString||void 0!==this.refreshDefaultHeaders)&&(void 0!==this.refreshDefaultHeaders&&(this.defaultHeaders=this.refreshDefaultHeaders()),void 0!==this.refreshDefaultQueryString&&(this.defaultQueryString=this.refreshDefaultQueryString()),!0)}}function O(e,t){for(const r of t)if(e.endsWith(r))return!0;return!1}const M=e=>`Basic ${Object(S.b)(`${e.user}:${e.password}`)}`;class k{constructor(e,t,r,n){this.endpoint=e,this.historianApi=t,this.restWrapper=n,this.defaultQueryString={},r&&this.historianApi?(this.defaultQueryString.disableCache=r,this.cacheBust=!1):this.cacheBust=r,void 0===this.restWrapper&&(this.restWrapper=new x(this.endpoint))}async getHeader(e){return this.historianApi?this.restWrapper.get(`/headers/${encodeURIComponent(e)}`,this.getQueryString()):this.getHeaderDirect(e)}async getFullTree(e){return this.restWrapper.get(`/tree/${encodeURIComponent(e)}`,this.getQueryString())}async getBlob(e){return this.restWrapper.get(`/git/blobs/${encodeURIComponent(e)}`,this.getQueryString())}async createBlob(e){return this.restWrapper.post("/git/blobs",e,this.getQueryString())}async getContent(e,t){return this.restWrapper.get(`/contents/${e}`,this.getQueryString({ref:t}))}async getCommits(e,t){return this.restWrapper.get("/commits",this.getQueryString({count:t,sha:e})).catch((e=>400===e||404===e?[]:Promise.reject(e)))}async getCommit(e){return this.restWrapper.get(`/git/commits/${encodeURIComponent(e)}`,this.getQueryString())}async createCommit(e){return this.restWrapper.post("/git/commits",e,this.getQueryString())}async getRefs(){return this.restWrapper.get("/git/refs",this.getQueryString())}async getRef(e){return this.restWrapper.get(`/git/refs/${e}`,this.getQueryString())}async createRef(e){return this.restWrapper.post("/git/refs",e,this.getQueryString())}async updateRef(e,t){return this.restWrapper.patch(`/git/refs/${e}`,t,this.getQueryString())}async deleteRef(e){await this.restWrapper.delete(`/git/refs/${e}`,this.getQueryString())}async createTag(e){return this.restWrapper.post("/git/tags",e,this.getQueryString())}async getTag(e){return this.restWrapper.get(`/git/tags/${e}`,this.getQueryString())}async createTree(e){return this.restWrapper.post("/git/trees",e,this.getQueryString())}async getTree(e,t){return this.restWrapper.get(`/git/trees/${encodeURIComponent(e)}`,this.getQueryString({recursive:t?1:0}))}async createSummary(e,t){return this.restWrapper.post("/git/summaries",e,this.getQueryString(void 0!==t?{initial:t}:void 0))}async deleteSummary(e){const t={"Soft-Delete":e};return this.restWrapper.delete("/git/summaries",this.getQueryString(),t)}async getSummary(e){return this.restWrapper.get(`/git/summaries/${e}`,this.getQueryString())}async getHeaderDirect(e){const t=await this.getTree(e,!0),r=[".attributes",".blobs",".messages","header"],n=[];for(const e of t.tree)if("blob"===e.type&&O(e.path,r)){const t=this.getBlob(e.sha);n.push(t)}return{blobs:await Promise.all(n),tree:t}}getQueryString(e){return Object.assign(Object.assign(this.cacheBust?{cacheBust:Date.now()}:{},this.defaultQueryString),e)}}async function L(e,t){const r=new Promise(((t,r)=>{const n=setTimeout((()=>{clearTimeout(n),r(new Error(`Timed out in ${e} milliseconds.`))}),e)}));return Promise.race([t,r])}var R;!function(e){e.Method="method",e.Header="header",e.Body="body"}(R||(R={}));const D=(e,t)=>`${e}: ${t}`;class F{translate(e){var t,r;const n=Object.assign({},e),i=new URLSearchParams;if(i.append(R.Method,null!==(t=n.method)&&void 0!==t?t:"GET"),n.headers)for(const[e,t]of Object.entries(n.headers)){const r=D(e,t);i.append(R.Header,r)}if(n.data&&["post","put","patch"].includes(null===(r=n.method)||void 0===r?void 0:r.toLowerCase())){const e=JSON.stringify(n.data);i.append(R.Body,e)}return n.data=i.toString(),n.method="POST",n.headers={"Content-Type":"application/x-www-form-urlencoded;restless"},n}}var A=r("N482"),j=r("XPga");const q=e=>e.includes(j.a.DocRead),B=e=>e.includes(j.a.DocWrite),_=e=>e.includes(j.a.SummaryWrite),H=e=>e.includes("token:revoke");var V=r("Xou4"),$=r("7/yF"),U=r("he5V"),K=r("Ls0c"),W=r("HJ7Z");const J=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.map((e=>e.replace(/^\//,"").replace(/\/$/,""))).filter((e=>!!e)).join("/")};function G(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";const i={type:"tree",entries:[]},s=Object.keys(t.tree);for(const o of s){const s=t.tree[o];let a,c,u;const l=J(""===r?n:r,o);switch(s.type){case W.a.Tree:c=G(e,s,l,n),u=s.unreferenced||void 0;break;case W.a.Blob:c="string"==typeof s.content?{type:"blob",content:s.content,encoding:"utf-8"}:{type:"blob",content:Object(V.b)(s.content,"base64"),encoding:"base64"};break;case W.a.Handle:if(s.embedded)a=s.handle;else{if(!e)throw Error("Parent summary does not exist to reference by handle.");a=J(e,n,s.handle)}break;case W.a.Attachment:a=s.id;break;default:Object($.a)(s,`Unknown type: ${s.type}`)}const h={path:encodeURIComponent(o),type:Object(K.g)(s)};let d;if(c)Object(U.a)(void 0===a,173),d=Object.assign({value:c,unreferenced:u},h);else{if(!a)throw new Error(`Invalid tree entry for ${s.type}`);d=Object.assign(Object.assign({},h),{id:a})}i.entries.push(d)}return i}function z(e,t){const r={},n={id:e.id,blobs:{},trees:{}};r[""]=n;for(const n of e.entries){const e=n.path.replace(new RegExp(`^${t}/`),""),i=e.lastIndexOf("/"),s=e.slice(0,Math.max(0,i)),o=e.slice(i+1),a=r[s];if("tree"===n.type){const t={blobs:{},trees:{},unreferenced:n.unreferenced};a.trees[decodeURIComponent(o)]=t,r[e]=t}else{if("blob"!==n.type)throw new Error("Unknown entry type!!");a.blobs[decodeURIComponent(o)]=n.id}}return n}function Q(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:".app";var r;const n=new Map;e.blobs&&e.blobs.forEach((e=>{var t;n.set(e.id,Object(V.e)(e.content,null!==(t=e.encoding)&&void 0!==t?t:"utf-8"))}));const i=null===(r=e.trees)||void 0===r?void 0:r[0],s=null==i?void 0:i.sequenceNumber,o=z(i,t);return{blobs:n,snapshotTree:o,sequenceNumber:s}}var X=r("xDkc");async function Z(e,t,r,n){console.log(`Get Repo: ${e}/${t}/${r}`);const i=await T.a.get(`${e}/repos/${t}/${r}`,{headers:n}).catch((e=>{if(e.response&&400===e.response.status)return null;throw e}));if(!i||400===i.status){console.log(`Create Repo: ${e}/${t}/${r}`);const i={name:r};await T.a.post(`${e}/${t}/repos`,i,{headers:n})}}class Y{constructor(e){this.manager=e}async writeSummaryTree(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const s=await this.writeSummaryTreeCore(t,e,r,n,i);if(!s)throw new Error("Failed to write summary tree");return s}async writeSummaryTreeCore(e,t,r,n,i){const s=G(e,t,"","channel"===r?".app":"");return this.manager.createSummary({entries:s.entries,message:void 0,sequenceNumber:n,type:r},i).then((e=>e.id))}}},irTb:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugLogger=void 0;const n=r("Gstq");class i{constructor(e,t,r){this.debugInfo=e,this.debugErr=t,this.debugWarn=r}static create(e){const t=(0,n.debug)(e),r=(0,n.debug)(e);r.log=console.warn.bind(console),r.enabled=!0;const s=(0,n.debug)(e);return s.log=console.error.bind(console),s.enabled=!0,new i(t,s,r)}info(e){this.debugInfo(e)}warn(e){this.debugWarn(e)}error(e){this.debugErr(e)}}t.DebugLogger=i},j7kB:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MoiraLambdaFactory=void 0;const n=r("hBZP"),i=r("ndW6");t.MoiraLambdaFactory=class extends n.EventEmitter{constructor(e,t){super(),this.mongoManager=e,this.serviceConfiguration=t}async create(e,t){return new i.MoiraLambda(t,this.serviceConfiguration,e.tenantId,e.documentId)}async dispose(){await this.mongoManager.close()}}},jDN0:function(e,t,r){var n=r("wfEq"),i=r("KSsY"),s=r("pRMk").Buffer,o=[1518500249,1859775393,-1894007588,-899497514],a=new Array(80);function c(){this.init(),this._w=a,i.call(this,64,56)}function u(e){return e<<5|e>>>27}function l(e){return e<<30|e>>>2}function h(e,t,r,n){return 0===e?t&r|~t&n:2===e?t&r|t&n|r&n:t^r^n}n(c,i),c.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this},c.prototype._update=function(e){for(var t=this._w,r=0|this._a,n=0|this._b,i=0|this._c,s=0|this._d,a=0|this._e,c=0;c<16;++c)t[c]=e.readInt32BE(4*c);for(;c<80;++c)t[c]=t[c-3]^t[c-8]^t[c-14]^t[c-16];for(var d=0;d<80;++d){var m=~~(d/20),p=u(r)+h(m,n,i,s)+a+t[d]+o[m]|0;a=s,s=i,i=l(n),n=r,r=p}this._a=r+this._a|0,this._b=n+this._b|0,this._c=i+this._c|0,this._d=s+this._d|0,this._e=a+this._e|0},c.prototype._hash=function(){var e=s.allocUnsafe(20);return e.writeInt32BE(0|this._a,0),e.writeInt32BE(0|this._b,4),e.writeInt32BE(0|this._c,8),e.writeInt32BE(0|this._d,12),e.writeInt32BE(0|this._e,16),e},e.exports=c},jKCC:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sendToDeli=t.initializeProtocol=void 0;const n=r("VIQa"),i=r("MPeK");t.initializeProtocol=(e,t)=>new n.ProtocolOpHandler(e.minimumSequenceNumber,e.sequenceNumber,t,e.members,e.proposals,e.values,(()=>-1)),t.sendToDeli=(e,t,r,n)=>{if(!r)throw new Error("Invalid producer");const s={clientId:null,documentId:t,operation:n,tenantId:e,timestamp:Date.now(),type:i.RawOperationType};return r.send([s],e,t)}},jLKw:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.chooseCelaName=void 0;const n=["Elliot Woodward","Miguel Garcia","Robert Tolbert","Henry Brill","Cecil Folk","Isaac Fielder","Erik Nason","Tim Deboer","Mauricio August","Allan Munger","Kevin Sturgis","Carlos Slattery","Johnnie McConnell","Colin Ballinger","Kat Larsson","Katri Ahokas","Carole Poland","Wanda Howard","Amanda Brady","Ashley McCarthy","Lydia Bauer","Robin Counts","Charlotte Walton","Elvia Atkins","Daisy Phillips","Mona Kane","Kristin Patterson","Celeste Burton"];t.chooseCelaName=()=>n[Math.floor(Math.random()*n.length)]},jLPl:function(e,t,r){"use strict";r.d(t,"f",(function(){return o})),r.d(t,"g",(function(){return a})),r.d(t,"e",(function(){return c})),r.d(t,"b",(function(){return u})),r.d(t,"c",(function(){return l})),r.d(t,"a",(function(){return h})),r.d(t,"d",(function(){return d}));var n=r("HJ7Z"),i=r("l4ds"),s=r("7/yF");function o(e){const t=e.type===n.a.Handle?e.handleType:e.type;switch(t){case n.a.Blob:case n.a.Attachment:return i.a.File;case n.a.Tree:return i.a.Directory;default:Object(s.a)(t,`Unknown type: ${t}`)}}function a(e){const t=e.type===n.a.Handle?e.handleType:e.type;switch(t){case n.a.Blob:case n.a.Attachment:return"blob";case n.a.Tree:return"tree";default:Object(s.a)(t,`Unknown type: ${t}`)}}function c(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Map,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const n={},i={id:e.sha,blobs:{},trees:{}};n[""]=i;for(const i of e.tree){const e=r?i.path.replace(/^\.app\//,""):i.path,s=e.lastIndexOf("/"),o=e.slice(0,Math.max(0,s)),a=e.slice(s+1),c=n[o];if("tree"===i.type){const t={id:i.sha,blobs:{},commits:{},trees:{}};c.trees[decodeURIComponent(a)]=t,n[e]=t}else{if("blob"!==i.type)throw new Error("Unknown entry type!!");c.blobs[decodeURIComponent(a)]=i.sha,t.set(i.sha,`/${e}`)}}return i}class u{constructor(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"utf-8";this.path=e,this.mode=i.a.File,this.type=i.b.Blob,this.value={contents:t,encoding:r}}}class l{constructor(e,t){this.path=e,this.value=t,this.mode=i.a.Directory,this.type=i.b.Tree}}class h{constructor(e,t){this.path=e,this.id=t,this.mode=i.a.File,this.type=i.b.Attachment,this.value={id:t}}}function d(e,t,r){e.entries.push({mode:i.a.File,path:t,type:i.b.Blob,value:{contents:JSON.stringify(r),encoding:"utf-8"}})}},jSVn:function(e,t,r){(function(e){var r={userAgent:!1},n={},i=i||function(e,t){var r={},n=r.lib={},i=n.Base=function(){function e(){}return{extend:function(t){e.prototype=this;var r=new e;return t&&r.mixIn(t),r.hasOwnProperty("init")||(r.init=function(){r.$super.init.apply(this,arguments)}),r.init.prototype=r,r.$super=this,r},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),s=n.WordArray=i.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length},toString:function(e){return(e||a).stringify(this)},concat:function(e){var t=this.words,r=e.words,n=this.sigBytes,i=e.sigBytes;if(this.clamp(),n%4)for(var s=0;s<i;s++)t[n+s>>>2]|=(r[s>>>2]>>>24-s%4*8&255)<<24-(n+s)%4*8;else for(s=0;s<i;s+=4)t[n+s>>>2]=r[s>>>2];return this.sigBytes+=i,this},clamp:function(){var t=this.words,r=this.sigBytes;t[r>>>2]&=4294967295<<32-r%4*8,t.length=e.ceil(r/4)},clone:function(){var e=i.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var r=[],n=0;n<t;n+=4)r.push(4294967296*e.random()|0);return new s.init(r,t)}}),o=r.enc={},a=o.Hex={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],i=0;i<r;i++){var s=t[i>>>2]>>>24-i%4*8&255;n.push((s>>>4).toString(16)),n.push((15&s).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n+=2)r[n>>>3]|=parseInt(e.substr(n,2),16)<<24-n%8*4;return new s.init(r,t/2)}},c=o.Latin1={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],i=0;i<r;i++)n.push(String.fromCharCode(t[i>>>2]>>>24-i%4*8&255));return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n++)r[n>>>2]|=(255&e.charCodeAt(n))<<24-n%4*8;return new s.init(r,t)}},u=o.Utf8={stringify:function(e){try{return decodeURIComponent(escape(c.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return c.parse(unescape(encodeURIComponent(e)))}},l=n.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=new s.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=u.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var r=this._data,n=r.words,i=r.sigBytes,o=this.blockSize,a=i/(4*o),c=(a=t?e.ceil(a):e.max((0|a)-this._minBufferSize,0))*o,u=e.min(4*c,i);if(c){for(var l=0;l<c;l+=o)this._doProcessBlock(n,l);var h=n.splice(0,c);r.sigBytes-=u}return new s.init(h,u)},clone:function(){var e=i.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0}),h=(n.Hasher=l.extend({cfg:i.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){l.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,r){return new e.init(r).finalize(t)}},_createHmacHelper:function(e){return function(t,r){return new h.HMAC.init(e,r).finalize(t)}}}),r.algo={});return r}(Math);!function(e){var t,r=(t=i).lib,n=r.Base,s=r.WordArray;(t=t.x64={}).Word=n.extend({init:function(e,t){this.high=e,this.low=t}}),t.WordArray=n.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:8*e.length},toX32:function(){for(var e=this.words,t=e.length,r=[],n=0;n<t;n++){var i=e[n];r.push(i.high),r.push(i.low)}return s.create(r,this.sigBytes)},clone:function(){for(var e=n.clone.call(this),t=e.words=this.words.slice(0),r=t.length,i=0;i<r;i++)t[i]=t[i].clone();return e}})}(),i.lib.Cipher||function(e){var t=(p=i).lib,r=t.Base,n=t.WordArray,s=t.BufferedBlockAlgorithm,o=p.enc.Base64,a=p.algo.EvpKDF,c=t.Cipher=s.extend({cfg:r.extend(),createEncryptor:function(e,t){return this.create(this._ENC_XFORM_MODE,e,t)},createDecryptor:function(e,t){return this.create(this._DEC_XFORM_MODE,e,t)},init:function(e,t,r){this.cfg=this.cfg.extend(r),this._xformMode=e,this._key=t,this.reset()},reset:function(){s.reset.call(this),this._doReset()},process:function(e){return this._append(e),this._process()},finalize:function(e){return e&&this._append(e),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(e){return{encrypt:function(t,r,n){return("string"==typeof r?f:m).encrypt(e,t,r,n)},decrypt:function(t,r,n){return("string"==typeof r?f:m).decrypt(e,t,r,n)}}}});t.StreamCipher=c.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var u=p.mode={},l=function(e,t,r){var n=this._iv;n?this._iv=void 0:n=this._prevBlock;for(var i=0;i<r;i++)e[t+i]^=n[i]},h=(t.BlockCipherMode=r.extend({createEncryptor:function(e,t){return this.Encryptor.create(e,t)},createDecryptor:function(e,t){return this.Decryptor.create(e,t)},init:function(e,t){this._cipher=e,this._iv=t}})).extend();h.Encryptor=h.extend({processBlock:function(e,t){var r=this._cipher,n=r.blockSize;l.call(this,e,t,n),r.encryptBlock(e,t),this._prevBlock=e.slice(t,t+n)}}),h.Decryptor=h.extend({processBlock:function(e,t){var r=this._cipher,n=r.blockSize,i=e.slice(t,t+n);r.decryptBlock(e,t),l.call(this,e,t,n),this._prevBlock=i}}),u=u.CBC=h,h=(p.pad={}).Pkcs7={pad:function(e,t){for(var r,i=(r=(r=4*t)-e.sigBytes%r)<<24|r<<16|r<<8|r,s=[],o=0;o<r;o+=4)s.push(i);r=n.create(s,r),e.concat(r)},unpad:function(e){e.sigBytes-=255&e.words[e.sigBytes-1>>>2]}},t.BlockCipher=c.extend({cfg:c.cfg.extend({mode:u,padding:h}),reset:function(){c.reset.call(this);var e=(t=this.cfg).iv,t=t.mode;if(this._xformMode==this._ENC_XFORM_MODE)var r=t.createEncryptor;else r=t.createDecryptor,this._minBufferSize=1;this._mode=r.call(t,this,e&&e.words)},_doProcessBlock:function(e,t){this._mode.processBlock(e,t)},_doFinalize:function(){var e=this.cfg.padding;if(this._xformMode==this._ENC_XFORM_MODE){e.pad(this._data,this.blockSize);var t=this._process(!0)}else t=this._process(!0),e.unpad(t);return t},blockSize:4});var d=t.CipherParams=r.extend({init:function(e){this.mixIn(e)},toString:function(e){return(e||this.formatter).stringify(this)}}),m=(u=(p.format={}).OpenSSL={stringify:function(e){var t=e.ciphertext;return((e=e.salt)?n.create([1398893684,1701076831]).concat(e).concat(t):t).toString(o)},parse:function(e){var t=(e=o.parse(e)).words;if(1398893684==t[0]&&1701076831==t[1]){var r=n.create(t.slice(2,4));t.splice(0,4),e.sigBytes-=16}return d.create({ciphertext:e,salt:r})}},t.SerializableCipher=r.extend({cfg:r.extend({format:u}),encrypt:function(e,t,r,n){n=this.cfg.extend(n);var i=e.createEncryptor(r,n);return t=i.finalize(t),d.create({ciphertext:t,key:r,iv:(i=i.cfg).iv,algorithm:e,mode:i.mode,padding:i.padding,blockSize:e.blockSize,formatter:n.format})},decrypt:function(e,t,r,n){return n=this.cfg.extend(n),t=this._parse(t,n.format),e.createDecryptor(r,n).finalize(t.ciphertext)},_parse:function(e,t){return"string"==typeof e?t.parse(e,this):e}})),p=(p.kdf={}).OpenSSL={execute:function(e,t,r,i){return i||(i=n.random(8)),e=a.create({keySize:t+r}).compute(e,i),r=n.create(e.words.slice(t),4*r),e.sigBytes=4*t,d.create({key:e,iv:r,salt:i})}},f=t.PasswordBasedCipher=m.extend({cfg:m.cfg.extend({kdf:p}),encrypt:function(e,t,r,n){return r=(n=this.cfg.extend(n)).kdf.execute(r,e.keySize,e.ivSize),n.iv=r.iv,(e=m.encrypt.call(this,e,t,r.key,n)).mixIn(r),e},decrypt:function(e,t,r,n){return n=this.cfg.extend(n),t=this._parse(t,n.format),r=n.kdf.execute(r,e.keySize,e.ivSize,t.salt),n.iv=r.iv,m.decrypt.call(this,e,t,r.key,n)}})}(),function(){for(var e=i,t=e.lib.BlockCipher,r=e.algo,n=[],s=[],o=[],a=[],c=[],u=[],l=[],h=[],d=[],m=[],p=[],f=0;256>f;f++)p[f]=128>f?f<<1:f<<1^283;var g=0,y=0;for(f=0;256>f;f++){var v;n[g]=v=(v=y^y<<1^y<<2^y<<3^y<<4)>>>8^255&v^99,s[v]=g;var b=p[g],S=p[b],w=p[S],C=257*p[v]^16843008*v;o[g]=C<<24|C>>>8,a[g]=C<<16|C>>>16,c[g]=C<<8|C>>>24,u[g]=C,l[v]=(C=16843009*w^65537*S^257*b^16843008*g)<<24|C>>>8,h[v]=C<<16|C>>>16,d[v]=C<<8|C>>>24,m[v]=C,g?(g=b^p[p[p[w^b]]],y^=p[p[y]]):g=y=1}var E=[0,1,2,4,8,16,32,64,128,27,54];r=r.AES=t.extend({_doReset:function(){for(var e=(r=this._key).words,t=r.sigBytes/4,r=4*((this._nRounds=t+6)+1),i=this._keySchedule=[],s=0;s<r;s++)if(s<t)i[s]=e[s];else{var o=i[s-1];s%t?6<t&&4==s%t&&(o=n[o>>>24]<<24|n[o>>>16&255]<<16|n[o>>>8&255]<<8|n[255&o]):(o=n[(o=o<<8|o>>>24)>>>24]<<24|n[o>>>16&255]<<16|n[o>>>8&255]<<8|n[255&o],o^=E[s/t|0]<<24),i[s]=i[s-t]^o}for(e=this._invKeySchedule=[],t=0;t<r;t++)s=r-t,o=t%4?i[s]:i[s-4],e[t]=4>t||4>=s?o:l[n[o>>>24]]^h[n[o>>>16&255]]^d[n[o>>>8&255]]^m[n[255&o]]},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._keySchedule,o,a,c,u,n)},decryptBlock:function(e,t){var r=e[t+1];e[t+1]=e[t+3],e[t+3]=r,this._doCryptBlock(e,t,this._invKeySchedule,l,h,d,m,s),r=e[t+1],e[t+1]=e[t+3],e[t+3]=r},_doCryptBlock:function(e,t,r,n,i,s,o,a){for(var c=this._nRounds,u=e[t]^r[0],l=e[t+1]^r[1],h=e[t+2]^r[2],d=e[t+3]^r[3],m=4,p=1;p<c;p++){var f=n[u>>>24]^i[l>>>16&255]^s[h>>>8&255]^o[255&d]^r[m++],g=n[l>>>24]^i[h>>>16&255]^s[d>>>8&255]^o[255&u]^r[m++],y=n[h>>>24]^i[d>>>16&255]^s[u>>>8&255]^o[255&l]^r[m++];d=n[d>>>24]^i[u>>>16&255]^s[l>>>8&255]^o[255&h]^r[m++],u=f,l=g,h=y}f=(a[u>>>24]<<24|a[l>>>16&255]<<16|a[h>>>8&255]<<8|a[255&d])^r[m++],g=(a[l>>>24]<<24|a[h>>>16&255]<<16|a[d>>>8&255]<<8|a[255&u])^r[m++],y=(a[h>>>24]<<24|a[d>>>16&255]<<16|a[u>>>8&255]<<8|a[255&l])^r[m++],d=(a[d>>>24]<<24|a[u>>>16&255]<<16|a[l>>>8&255]<<8|a[255&h])^r[m++],e[t]=f,e[t+1]=g,e[t+2]=y,e[t+3]=d},keySize:8}),e.AES=t._createHelper(r)}(),function(){function e(e,t){var r=(this._lBlock>>>e^this._rBlock)&t;this._rBlock^=r,this._lBlock^=r<<e}function t(e,t){var r=(this._rBlock>>>e^this._lBlock)&t;this._lBlock^=r,this._rBlock^=r<<e}var r,n=i,s=(r=n.lib).WordArray,o=n.algo,a=[57,49,41,33,25,17,9,1,58,50,42,34,26,18,10,2,59,51,43,35,27,19,11,3,60,52,44,36,63,55,47,39,31,23,15,7,62,54,46,38,30,22,14,6,61,53,45,37,29,21,13,5,28,20,12,4],c=[14,17,11,24,1,5,3,28,15,6,21,10,23,19,12,4,26,8,16,7,27,20,13,2,41,52,31,37,47,55,30,40,51,45,33,48,44,49,39,56,34,53,46,42,50,36,29,32],u=[1,2,4,6,8,10,12,14,15,17,19,21,23,25,27,28],l=[{0:8421888,268435456:32768,536870912:8421378,805306368:2,1073741824:512,1342177280:8421890,1610612736:8389122,1879048192:8388608,2147483648:514,2415919104:8389120,2684354560:33280,2952790016:8421376,3221225472:32770,3489660928:8388610,3758096384:0,4026531840:33282,134217728:0,402653184:8421890,671088640:33282,939524096:32768,1207959552:8421888,1476395008:512,1744830464:8421378,2013265920:2,2281701376:8389120,2550136832:33280,2818572288:8421376,3087007744:8389122,3355443200:8388610,3623878656:32770,3892314112:514,4160749568:8388608,1:32768,268435457:2,536870913:8421888,805306369:8388608,1073741825:8421378,1342177281:33280,1610612737:512,1879048193:8389122,2147483649:8421890,2415919105:8421376,2684354561:8388610,2952790017:33282,3221225473:514,3489660929:8389120,3758096385:32770,4026531841:0,134217729:8421890,402653185:8421376,671088641:8388608,939524097:512,1207959553:32768,1476395009:8388610,1744830465:2,2013265921:33282,2281701377:32770,2550136833:8389122,2818572289:514,3087007745:8421888,3355443201:8389120,3623878657:0,3892314113:33280,4160749569:8421378},{0:1074282512,16777216:16384,33554432:524288,50331648:1074266128,67108864:1073741840,83886080:1074282496,100663296:1073758208,117440512:16,134217728:540672,150994944:1073758224,167772160:1073741824,184549376:540688,201326592:524304,218103808:0,234881024:16400,251658240:1074266112,8388608:1073758208,25165824:540688,41943040:16,58720256:1073758224,75497472:1074282512,92274688:1073741824,109051904:524288,125829120:1074266128,142606336:524304,159383552:0,176160768:16384,192937984:1074266112,209715200:1073741840,226492416:540672,243269632:1074282496,260046848:16400,268435456:0,285212672:1074266128,301989888:1073758224,318767104:1074282496,335544320:1074266112,352321536:16,369098752:540688,385875968:16384,402653184:16400,419430400:524288,436207616:524304,452984832:1073741840,469762048:540672,486539264:1073758208,503316480:1073741824,520093696:1074282512,276824064:540688,293601280:524288,310378496:1074266112,327155712:16384,343932928:1073758208,360710144:1074282512,377487360:16,394264576:1073741824,411041792:1074282496,427819008:1073741840,444596224:1073758224,461373440:524304,478150656:0,494927872:16400,511705088:1074266128,528482304:540672},{0:260,1048576:0,2097152:67109120,3145728:65796,4194304:65540,5242880:67108868,6291456:67174660,7340032:67174400,8388608:67108864,9437184:67174656,10485760:65792,11534336:67174404,12582912:67109124,13631488:65536,14680064:4,15728640:256,524288:67174656,1572864:67174404,2621440:0,3670016:67109120,4718592:67108868,5767168:65536,6815744:65540,7864320:260,8912896:4,9961472:256,11010048:67174400,12058624:65796,13107200:65792,14155776:67109124,15204352:67174660,16252928:67108864,16777216:67174656,17825792:65540,18874368:65536,19922944:67109120,20971520:256,22020096:67174660,23068672:67108868,24117248:0,25165824:67109124,26214400:67108864,27262976:4,28311552:65792,29360128:67174400,30408704:260,31457280:65796,32505856:67174404,17301504:67108864,18350080:260,19398656:67174656,20447232:0,21495808:65540,22544384:67109120,23592960:256,24641536:67174404,25690112:65536,26738688:67174660,27787264:65796,28835840:67108868,29884416:67109124,30932992:67174400,31981568:4,33030144:65792},{0:2151682048,65536:2147487808,131072:4198464,196608:2151677952,262144:0,327680:4198400,393216:2147483712,458752:4194368,524288:2147483648,589824:4194304,655360:64,720896:2147487744,786432:2151678016,851968:4160,917504:4096,983040:2151682112,32768:2147487808,98304:64,163840:2151678016,229376:2147487744,294912:4198400,360448:2151682112,425984:0,491520:2151677952,557056:4096,622592:2151682048,688128:4194304,753664:4160,819200:2147483648,884736:4194368,950272:4198464,1015808:2147483712,1048576:4194368,1114112:4198400,1179648:2147483712,1245184:0,1310720:4160,1376256:2151678016,1441792:2151682048,1507328:2147487808,1572864:2151682112,1638400:2147483648,1703936:2151677952,1769472:4198464,1835008:2147487744,1900544:4194304,1966080:64,2031616:4096,1081344:2151677952,1146880:2151682112,1212416:0,1277952:4198400,1343488:4194368,1409024:2147483648,1474560:2147487808,1540096:64,1605632:2147483712,1671168:4096,1736704:2147487744,1802240:2151678016,1867776:4160,1933312:2151682048,1998848:4194304,2064384:4198464},{0:128,4096:17039360,8192:262144,12288:536870912,16384:537133184,20480:16777344,24576:553648256,28672:262272,32768:16777216,36864:537133056,40960:536871040,45056:553910400,49152:553910272,53248:0,57344:17039488,61440:553648128,2048:17039488,6144:553648256,10240:128,14336:17039360,18432:262144,22528:537133184,26624:553910272,30720:536870912,34816:537133056,38912:0,43008:553910400,47104:16777344,51200:536871040,55296:553648128,59392:16777216,63488:262272,65536:262144,69632:128,73728:536870912,77824:553648256,81920:16777344,86016:553910272,90112:537133184,94208:16777216,98304:553910400,102400:553648128,106496:17039360,110592:537133056,114688:262272,118784:536871040,122880:0,126976:17039488,67584:553648256,71680:16777216,75776:17039360,79872:537133184,83968:536870912,88064:17039488,92160:128,96256:553910272,100352:262272,104448:553910400,108544:0,112640:553648128,116736:16777344,120832:262144,124928:537133056,129024:536871040},{0:268435464,256:8192,512:270532608,768:270540808,1024:268443648,1280:2097152,1536:2097160,1792:268435456,2048:0,2304:268443656,2560:2105344,2816:8,3072:270532616,3328:2105352,3584:8200,3840:270540800,128:270532608,384:270540808,640:8,896:2097152,1152:2105352,1408:268435464,1664:268443648,1920:8200,2176:2097160,2432:8192,2688:268443656,2944:270532616,3200:0,3456:270540800,3712:2105344,3968:268435456,4096:268443648,4352:270532616,4608:270540808,4864:8200,5120:2097152,5376:268435456,5632:268435464,5888:2105344,6144:2105352,6400:0,6656:8,6912:270532608,7168:8192,7424:268443656,7680:270540800,7936:2097160,4224:8,4480:2105344,4736:2097152,4992:268435464,5248:268443648,5504:8200,5760:270540808,6016:270532608,6272:270540800,6528:270532616,6784:8192,7040:2105352,7296:2097160,7552:0,7808:268435456,8064:268443656},{0:1048576,16:33555457,32:1024,48:1049601,64:34604033,80:0,96:1,112:34603009,128:33555456,144:1048577,160:33554433,176:34604032,192:34603008,208:1025,224:1049600,240:33554432,8:34603009,24:0,40:33555457,56:34604032,72:1048576,88:33554433,104:33554432,120:1025,136:1049601,152:33555456,168:34603008,184:1048577,200:1024,216:34604033,232:1,248:1049600,256:33554432,272:1048576,288:33555457,304:34603009,320:1048577,336:33555456,352:34604032,368:1049601,384:1025,400:34604033,416:1049600,432:1,448:0,464:34603008,480:33554433,496:1024,264:1049600,280:33555457,296:34603009,312:1,328:33554432,344:1048576,360:1025,376:34604032,392:33554433,408:34603008,424:0,440:34604033,456:1049601,472:1024,488:33555456,504:1048577},{0:134219808,1:131072,2:134217728,3:32,4:131104,5:134350880,6:134350848,7:2048,8:134348800,9:134219776,10:133120,11:134348832,12:2080,13:0,14:134217760,15:133152,2147483648:2048,2147483649:134350880,2147483650:134219808,2147483651:134217728,2147483652:134348800,2147483653:133120,2147483654:133152,2147483655:32,2147483656:134217760,2147483657:2080,2147483658:131104,2147483659:134350848,2147483660:0,2147483661:134348832,2147483662:134219776,2147483663:131072,16:133152,17:134350848,18:32,19:2048,20:134219776,21:134217760,22:134348832,23:131072,24:0,25:131104,26:134348800,27:134219808,28:134350880,29:133120,30:2080,31:134217728,2147483664:131072,2147483665:2048,2147483666:134348832,2147483667:133152,2147483668:32,2147483669:134348800,2147483670:134217728,2147483671:134219808,2147483672:134350880,2147483673:134217760,2147483674:134219776,2147483675:0,2147483676:133120,2147483677:2080,2147483678:131104,2147483679:134350848}],h=[4160749569,528482304,33030144,2064384,129024,8064,504,2147483679],d=o.DES=(r=r.BlockCipher).extend({_doReset:function(){for(var e=this._key.words,t=[],r=0;56>r;r++){var n=a[r]-1;t[r]=e[n>>>5]>>>31-n%32&1}for(e=this._subKeys=[],n=0;16>n;n++){var i=e[n]=[],s=u[n];for(r=0;24>r;r++)i[r/6|0]|=t[(c[r]-1+s)%28]<<31-r%6,i[4+(r/6|0)]|=t[28+(c[r+24]-1+s)%28]<<31-r%6;for(i[0]=i[0]<<1|i[0]>>>31,r=1;7>r;r++)i[r]>>>=4*(r-1)+3;i[7]=i[7]<<5|i[7]>>>27}for(t=this._invSubKeys=[],r=0;16>r;r++)t[r]=e[15-r]},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._subKeys)},decryptBlock:function(e,t){this._doCryptBlock(e,t,this._invSubKeys)},_doCryptBlock:function(r,n,i){this._lBlock=r[n],this._rBlock=r[n+1],e.call(this,4,252645135),e.call(this,16,65535),t.call(this,2,858993459),t.call(this,8,16711935),e.call(this,1,1431655765);for(var s=0;16>s;s++){for(var o=i[s],a=this._lBlock,c=this._rBlock,u=0,d=0;8>d;d++)u|=l[d][((c^o[d])&h[d])>>>0];this._lBlock=c,this._rBlock=a^u}i=this._lBlock,this._lBlock=this._rBlock,this._rBlock=i,e.call(this,1,1431655765),t.call(this,8,16711935),t.call(this,2,858993459),e.call(this,16,65535),e.call(this,4,252645135),r[n]=this._lBlock,r[n+1]=this._rBlock},keySize:2,ivSize:2,blockSize:2});n.DES=r._createHelper(d),o=o.TripleDES=r.extend({_doReset:function(){var e=this._key.words;this._des1=d.createEncryptor(s.create(e.slice(0,2))),this._des2=d.createEncryptor(s.create(e.slice(2,4))),this._des3=d.createEncryptor(s.create(e.slice(4,6)))},encryptBlock:function(e,t){this._des1.encryptBlock(e,t),this._des2.decryptBlock(e,t),this._des3.encryptBlock(e,t)},decryptBlock:function(e,t){this._des3.decryptBlock(e,t),this._des2.encryptBlock(e,t),this._des1.decryptBlock(e,t)},keySize:6,ivSize:2,blockSize:2}),n.TripleDES=r._createHelper(o)}(),function(){var e=i.lib.WordArray;i.enc.Base64={stringify:function(e){var t=e.words,r=e.sigBytes,n=this._map;e.clamp(),e=[];for(var i=0;i<r;i+=3)for(var s=(t[i>>>2]>>>24-i%4*8&255)<<16|(t[i+1>>>2]>>>24-(i+1)%4*8&255)<<8|t[i+2>>>2]>>>24-(i+2)%4*8&255,o=0;4>o&&i+.75*o<r;o++)e.push(n.charAt(s>>>6*(3-o)&63));if(t=n.charAt(64))for(;e.length%4;)e.push(t);return e.join("")},parse:function(t){var r=t.length,n=this._map;(i=n.charAt(64))&&-1!=(i=t.indexOf(i))&&(r=i);for(var i=[],s=0,o=0;o<r;o++)if(o%4){var a=n.indexOf(t.charAt(o-1))<<o%4*2,c=n.indexOf(t.charAt(o))>>>6-o%4*2;i[s>>>2]|=(a|c)<<24-s%4*8,s++}return e.create(i,s)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),function(e){function t(e,t,r,n,i,s,o){return((e=e+(t&r|~t&n)+i+o)<<s|e>>>32-s)+t}function r(e,t,r,n,i,s,o){return((e=e+(t&n|r&~n)+i+o)<<s|e>>>32-s)+t}function n(e,t,r,n,i,s,o){return((e=e+(t^r^n)+i+o)<<s|e>>>32-s)+t}function s(e,t,r,n,i,s,o){return((e=e+(r^(t|~n))+i+o)<<s|e>>>32-s)+t}for(var o=i,a=(u=o.lib).WordArray,c=u.Hasher,u=o.algo,l=[],h=0;64>h;h++)l[h]=4294967296*e.abs(e.sin(h+1))|0;u=u.MD5=c.extend({_doReset:function(){this._hash=new a.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(e,i){for(var o=0;16>o;o++)e[a=i+o]=16711935&((c=e[a])<<8|c>>>24)|4278255360&(c<<24|c>>>8);var a,c=e[i+1],u=e[i+2],h=e[i+3],d=e[i+4],m=e[i+5],p=e[i+6],f=e[i+7],g=e[i+8],y=e[i+9],v=e[i+10],b=e[i+11],S=e[i+12],w=e[i+13],C=e[i+14],E=e[i+15],I=t(I=(o=this._hash.words)[0],P=o[1],N=o[2],T=o[3],a=e[i+0],7,l[0]),T=t(T,I,P,N,c,12,l[1]),N=t(N,T,I,P,u,17,l[2]),P=t(P,N,T,I,h,22,l[3]);I=t(I,P,N,T,d,7,l[4]),T=t(T,I,P,N,m,12,l[5]),N=t(N,T,I,P,p,17,l[6]),P=t(P,N,T,I,f,22,l[7]),I=t(I,P,N,T,g,7,l[8]),T=t(T,I,P,N,y,12,l[9]),N=t(N,T,I,P,v,17,l[10]),P=t(P,N,T,I,b,22,l[11]),I=t(I,P,N,T,S,7,l[12]),T=t(T,I,P,N,w,12,l[13]),N=t(N,T,I,P,C,17,l[14]),I=r(I,P=t(P,N,T,I,E,22,l[15]),N,T,c,5,l[16]),T=r(T,I,P,N,p,9,l[17]),N=r(N,T,I,P,b,14,l[18]),P=r(P,N,T,I,a,20,l[19]),I=r(I,P,N,T,m,5,l[20]),T=r(T,I,P,N,v,9,l[21]),N=r(N,T,I,P,E,14,l[22]),P=r(P,N,T,I,d,20,l[23]),I=r(I,P,N,T,y,5,l[24]),T=r(T,I,P,N,C,9,l[25]),N=r(N,T,I,P,h,14,l[26]),P=r(P,N,T,I,g,20,l[27]),I=r(I,P,N,T,w,5,l[28]),T=r(T,I,P,N,u,9,l[29]),N=r(N,T,I,P,f,14,l[30]),I=n(I,P=r(P,N,T,I,S,20,l[31]),N,T,m,4,l[32]),T=n(T,I,P,N,g,11,l[33]),N=n(N,T,I,P,b,16,l[34]),P=n(P,N,T,I,C,23,l[35]),I=n(I,P,N,T,c,4,l[36]),T=n(T,I,P,N,d,11,l[37]),N=n(N,T,I,P,f,16,l[38]),P=n(P,N,T,I,v,23,l[39]),I=n(I,P,N,T,w,4,l[40]),T=n(T,I,P,N,a,11,l[41]),N=n(N,T,I,P,h,16,l[42]),P=n(P,N,T,I,p,23,l[43]),I=n(I,P,N,T,y,4,l[44]),T=n(T,I,P,N,S,11,l[45]),N=n(N,T,I,P,E,16,l[46]),I=s(I,P=n(P,N,T,I,u,23,l[47]),N,T,a,6,l[48]),T=s(T,I,P,N,f,10,l[49]),N=s(N,T,I,P,C,15,l[50]),P=s(P,N,T,I,m,21,l[51]),I=s(I,P,N,T,S,6,l[52]),T=s(T,I,P,N,h,10,l[53]),N=s(N,T,I,P,v,15,l[54]),P=s(P,N,T,I,c,21,l[55]),I=s(I,P,N,T,g,6,l[56]),T=s(T,I,P,N,E,10,l[57]),N=s(N,T,I,P,p,15,l[58]),P=s(P,N,T,I,w,21,l[59]),I=s(I,P,N,T,d,6,l[60]),T=s(T,I,P,N,b,10,l[61]),N=s(N,T,I,P,u,15,l[62]),P=s(P,N,T,I,y,21,l[63]),o[0]=o[0]+I|0,o[1]=o[1]+P|0,o[2]=o[2]+N|0,o[3]=o[3]+T|0},_doFinalize:function(){var t=this._data,r=t.words,n=8*this._nDataBytes,i=8*t.sigBytes;r[i>>>5]|=128<<24-i%32;var s=e.floor(n/4294967296);for(r[15+(i+64>>>9<<4)]=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8),r[14+(i+64>>>9<<4)]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8),t.sigBytes=4*(r.length+1),this._process(),r=(t=this._hash).words,n=0;4>n;n++)r[n]=16711935&((i=r[n])<<8|i>>>24)|4278255360&(i<<24|i>>>8);return t},clone:function(){var e=c.clone.call(this);return e._hash=this._hash.clone(),e}}),o.MD5=c._createHelper(u),o.HmacMD5=c._createHmacHelper(u)}(Math),function(){var e=i,t=(s=e.lib).WordArray,r=s.Hasher,n=[],s=e.algo.SHA1=r.extend({_doReset:function(){this._hash=new t.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var r=this._hash.words,i=r[0],s=r[1],o=r[2],a=r[3],c=r[4],u=0;80>u;u++){if(16>u)n[u]=0|e[t+u];else{var l=n[u-3]^n[u-8]^n[u-14]^n[u-16];n[u]=l<<1|l>>>31}l=(i<<5|i>>>27)+c+n[u],l=20>u?l+(1518500249+(s&o|~s&a)):40>u?l+(1859775393+(s^o^a)):60>u?l+((s&o|s&a|o&a)-1894007588):l+((s^o^a)-899497514),c=a,a=o,o=s<<30|s>>>2,s=i,i=l}r[0]=r[0]+i|0,r[1]=r[1]+s|0,r[2]=r[2]+o|0,r[3]=r[3]+a|0,r[4]=r[4]+c|0},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,n=8*e.sigBytes;return t[n>>>5]|=128<<24-n%32,t[14+(n+64>>>9<<4)]=Math.floor(r/4294967296),t[15+(n+64>>>9<<4)]=r,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=r.clone.call(this);return e._hash=this._hash.clone(),e}});e.SHA1=r._createHelper(s),e.HmacSHA1=r._createHmacHelper(s)}(),function(e){for(var t=i,r=(s=t.lib).WordArray,n=s.Hasher,s=t.algo,o=[],a=[],c=function(e){return 4294967296*(e-(0|e))|0},u=2,l=0;64>l;){var h;e:{for(var d=e.sqrt(h=u),m=2;m<=d;m++)if(!(h%m)){h=!1;break e}h=!0}h&&(8>l&&(o[l]=c(e.pow(u,.5))),a[l]=c(e.pow(u,1/3)),l++),u++}var p=[];s=s.SHA256=n.extend({_doReset:function(){this._hash=new r.init(o.slice(0))},_doProcessBlock:function(e,t){for(var r=this._hash.words,n=r[0],i=r[1],s=r[2],o=r[3],c=r[4],u=r[5],l=r[6],h=r[7],d=0;64>d;d++){if(16>d)p[d]=0|e[t+d];else{var m=p[d-15],f=p[d-2];p[d]=((m<<25|m>>>7)^(m<<14|m>>>18)^m>>>3)+p[d-7]+((f<<15|f>>>17)^(f<<13|f>>>19)^f>>>10)+p[d-16]}m=h+((c<<26|c>>>6)^(c<<21|c>>>11)^(c<<7|c>>>25))+(c&u^~c&l)+a[d]+p[d],f=((n<<30|n>>>2)^(n<<19|n>>>13)^(n<<10|n>>>22))+(n&i^n&s^i&s),h=l,l=u,u=c,c=o+m|0,o=s,s=i,i=n,n=m+f|0}r[0]=r[0]+n|0,r[1]=r[1]+i|0,r[2]=r[2]+s|0,r[3]=r[3]+o|0,r[4]=r[4]+c|0,r[5]=r[5]+u|0,r[6]=r[6]+l|0,r[7]=r[7]+h|0},_doFinalize:function(){var t=this._data,r=t.words,n=8*this._nDataBytes,i=8*t.sigBytes;return r[i>>>5]|=128<<24-i%32,r[14+(i+64>>>9<<4)]=e.floor(n/4294967296),r[15+(i+64>>>9<<4)]=n,t.sigBytes=4*r.length,this._process(),this._hash},clone:function(){var e=n.clone.call(this);return e._hash=this._hash.clone(),e}}),t.SHA256=n._createHelper(s),t.HmacSHA256=n._createHmacHelper(s)}(Math),function(){var e=i,t=e.lib.WordArray,r=(n=e.algo).SHA256,n=n.SHA224=r.extend({_doReset:function(){this._hash=new t.init([3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428])},_doFinalize:function(){var e=r._doFinalize.call(this);return e.sigBytes-=4,e}});e.SHA224=r._createHelper(n),e.HmacSHA224=r._createHmacHelper(n)}(),function(){function e(){return n.create.apply(n,arguments)}for(var t=i,r=t.lib.Hasher,n=(o=t.x64).Word,s=o.WordArray,o=t.algo,a=[e(1116352408,3609767458),e(1899447441,602891725),e(3049323471,3964484399),e(3921009573,2173295548),e(961987163,4081628472),e(1508970993,3053834265),e(2453635748,2937671579),e(2870763221,3664609560),e(3624381080,2734883394),e(310598401,1164996542),e(607225278,1323610764),e(1426881987,3590304994),e(1925078388,4068182383),e(2162078206,991336113),e(2614888103,633803317),e(3248222580,3479774868),e(3835390401,2666613458),e(4022224774,944711139),e(264347078,2341262773),e(604807628,2007800933),e(770255983,1495990901),e(1249150122,1856431235),e(1555081692,3175218132),e(1996064986,2198950837),e(2554220882,3999719339),e(2821834349,766784016),e(2952996808,2566594879),e(3210313671,3203337956),e(3336571891,1034457026),e(3584528711,2466948901),e(113926993,3758326383),e(338241895,168717936),e(666307205,1188179964),e(773529912,1546045734),e(1294757372,1522805485),e(1396182291,2643833823),e(1695183700,2343527390),e(1986661051,1014477480),e(2177026350,1206759142),e(2456956037,344077627),e(2730485921,1290863460),e(2820302411,3158454273),e(3259730800,3505952657),e(3345764771,106217008),e(3516065817,3606008344),e(3600352804,1432725776),e(4094571909,1467031594),e(275423344,851169720),e(430227734,3100823752),e(506948616,1363258195),e(659060556,3750685593),e(883997877,3785050280),e(958139571,3318307427),e(1322822218,3812723403),e(1537002063,2003034995),e(1747873779,3602036899),e(1955562222,1575990012),e(2024104815,1125592928),e(2227730452,2716904306),e(2361852424,442776044),e(2428436474,593698344),e(2756734187,3733110249),e(3204031479,2999351573),e(3329325298,3815920427),e(3391569614,3928383900),e(3515267271,566280711),e(3940187606,3454069534),e(4118630271,4000239992),e(116418474,1914138554),e(174292421,2731055270),e(289380356,3203993006),e(460393269,320620315),e(685471733,587496836),e(852142971,1086792851),e(1017036298,365543100),e(1126000580,2618297676),e(1288033470,3409855158),e(1501505948,4234509866),e(1607167915,987167468),e(1816402316,1246189591)],c=[],u=0;80>u;u++)c[u]=e();o=o.SHA512=r.extend({_doReset:function(){this._hash=new s.init([new n.init(1779033703,4089235720),new n.init(3144134277,2227873595),new n.init(1013904242,4271175723),new n.init(2773480762,1595750129),new n.init(1359893119,2917565137),new n.init(2600822924,725511199),new n.init(528734635,4215389547),new n.init(1541459225,327033209)])},_doProcessBlock:function(e,t){for(var r,n=(r=this._hash.words)[0],i=r[1],s=r[2],o=r[3],u=r[4],l=r[5],h=r[6],d=n.high,m=n.low,p=i.high,f=i.low,g=s.high,y=s.low,v=o.high,b=o.low,S=u.high,w=u.low,C=l.high,E=l.low,I=h.high,T=h.low,N=(r=r[7]).high,P=r.low,x=d,O=m,M=p,k=f,L=g,R=y,D=v,F=b,A=S,j=w,q=C,B=E,_=I,H=T,V=N,$=P,U=0;80>U;U++){var K=c[U];if(16>U)var W=K.high=0|e[t+2*U],J=K.low=0|e[t+2*U+1];else{W=((J=(W=c[U-15]).high)>>>1|(G=W.low)<<31)^(J>>>8|G<<24)^J>>>7;var G=(G>>>1|J<<31)^(G>>>8|J<<24)^(G>>>7|J<<25),z=((J=(z=c[U-2]).high)>>>19|(Q=z.low)<<13)^(J<<3|Q>>>29)^J>>>6,Q=(Q>>>19|J<<13)^(Q<<3|J>>>29)^(Q>>>6|J<<26);K.high=W=(W=(W=W+(X=(J=c[U-7]).high)+((J=G+J.low)>>>0<G>>>0?1:0))+z+((J+=Q)>>>0<Q>>>0?1:0))+(re=(Z=c[U-16]).high)+((J+=Z=Z.low)>>>0<Z>>>0?1:0),K.low=J}var X=A&q^~A&_,Z=j&B^~j&H,Y=(K=x&M^x&L^M&L,O&k^O&R^k&R),ee=(Q=a[U]).high,te=Q.low,re=V+((A>>>14|j<<18)^(A>>>18|j<<14)^(A<<23|j>>>9))+((Q=$+((j>>>14|A<<18)^(j>>>18|A<<14)^(j<<23|A>>>9)))>>>0<$>>>0?1:0);V=_,$=H,_=q,H=B,q=A,B=j,A=D+(re=(re=(re=re+X+((Q+=Z)>>>0<Z>>>0?1:0))+ee+((Q+=te)>>>0<te>>>0?1:0))+W+((Q+=J)>>>0<J>>>0?1:0))+((j=F+Q|0)>>>0<F>>>0?1:0)|0,D=L,F=R,L=M,R=k,M=x,k=O,x=re+(K=(G=(x>>>28|O<<4)^(x<<30|O>>>2)^(x<<25|O>>>7))+K+((J=(z=(O>>>28|x<<4)^(O<<30|x>>>2)^(O<<25|x>>>7))+Y)>>>0<z>>>0?1:0))+((O=Q+J|0)>>>0<Q>>>0?1:0)|0}m=n.low=m+O,n.high=d+x+(m>>>0<O>>>0?1:0),f=i.low=f+k,i.high=p+M+(f>>>0<k>>>0?1:0),y=s.low=y+R,s.high=g+L+(y>>>0<R>>>0?1:0),b=o.low=b+F,o.high=v+D+(b>>>0<F>>>0?1:0),w=u.low=w+j,u.high=S+A+(w>>>0<j>>>0?1:0),E=l.low=E+B,l.high=C+q+(E>>>0<B>>>0?1:0),T=h.low=T+H,h.high=I+_+(T>>>0<H>>>0?1:0),P=r.low=P+$,r.high=N+V+(P>>>0<$>>>0?1:0)},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,n=8*e.sigBytes;return t[n>>>5]|=128<<24-n%32,t[30+(n+128>>>10<<5)]=Math.floor(r/4294967296),t[31+(n+128>>>10<<5)]=r,e.sigBytes=4*t.length,this._process(),this._hash.toX32()},clone:function(){var e=r.clone.call(this);return e._hash=this._hash.clone(),e},blockSize:32}),t.SHA512=r._createHelper(o),t.HmacSHA512=r._createHmacHelper(o)}(),function(){var e=i,t=(s=e.x64).Word,r=s.WordArray,n=(s=e.algo).SHA512,s=s.SHA384=n.extend({_doReset:function(){this._hash=new r.init([new t.init(3418070365,3238371032),new t.init(1654270250,914150663),new t.init(2438529370,812702999),new t.init(355462360,4144912697),new t.init(1731405415,4290775857),new t.init(2394180231,1750603025),new t.init(3675008525,1694076839),new t.init(1203062813,3204075428)])},_doFinalize:function(){var e=n._doFinalize.call(this);return e.sigBytes-=16,e}});e.SHA384=n._createHelper(s),e.HmacSHA384=n._createHmacHelper(s)}(),function(){var e=i,t=(n=e.lib).WordArray,r=n.Hasher,n=e.algo,s=t.create([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13]),o=t.create([5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11]),a=t.create([11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6]),c=t.create([8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11]),u=t.create([0,1518500249,1859775393,2400959708,2840853838]),l=t.create([1352829926,1548603684,1836072691,2053994217,0]);n=n.RIPEMD160=r.extend({_doReset:function(){this._hash=t.create([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var r=0;16>r;r++)e[n=t+r]=16711935&((w=e[n])<<8|w>>>24)|4278255360&(w<<24|w>>>8);var n,i,h,d,m,p,f,g,y,v,b,S,w=u.words,C=l.words,E=s.words,I=o.words,T=a.words,N=c.words;for(f=i=(n=this._hash.words)[0],g=h=n[1],y=d=n[2],v=m=n[3],b=p=n[4],r=0;80>r;r+=1)S=i+e[t+E[r]]|0,S=16>r?S+((h^d^m)+w[0]):32>r?S+((h&d|~h&m)+w[1]):48>r?S+(((h|~d)^m)+w[2]):64>r?S+((h&m|d&~m)+w[3]):S+((h^(d|~m))+w[4]),S=(S=(S|=0)<<T[r]|S>>>32-T[r])+p|0,i=p,p=m,m=d<<10|d>>>22,d=h,h=S,S=f+e[t+I[r]]|0,S=16>r?S+((g^(y|~v))+C[0]):32>r?S+((g&v|y&~v)+C[1]):48>r?S+(((g|~y)^v)+C[2]):64>r?S+((g&y|~g&v)+C[3]):S+((g^y^v)+C[4]),S=(S=(S|=0)<<N[r]|S>>>32-N[r])+b|0,f=b,b=v,v=y<<10|y>>>22,y=g,g=S;S=n[1]+d+v|0,n[1]=n[2]+m+b|0,n[2]=n[3]+p+f|0,n[3]=n[4]+i+g|0,n[4]=n[0]+h+y|0,n[0]=S},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,n=8*e.sigBytes;for(t[n>>>5]|=128<<24-n%32,t[14+(n+64>>>9<<4)]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8),e.sigBytes=4*(t.length+1),this._process(),t=(e=this._hash).words,r=0;5>r;r++)t[r]=16711935&((n=t[r])<<8|n>>>24)|4278255360&(n<<24|n>>>8);return e},clone:function(){var e=r.clone.call(this);return e._hash=this._hash.clone(),e}}),e.RIPEMD160=r._createHelper(n),e.HmacRIPEMD160=r._createHmacHelper(n)}(Math),function(){var e=i.enc.Utf8;i.algo.HMAC=i.lib.Base.extend({init:function(t,r){t=this._hasher=new t.init,"string"==typeof r&&(r=e.parse(r));var n=t.blockSize,i=4*n;r.sigBytes>i&&(r=t.finalize(r)),r.clamp();for(var s=this._oKey=r.clone(),o=this._iKey=r.clone(),a=s.words,c=o.words,u=0;u<n;u++)a[u]^=1549556828,c[u]^=909522486;s.sigBytes=o.sigBytes=i,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher;return e=t.finalize(e),t.reset(),t.finalize(this._oKey.clone().concat(e))}})}(),function(){var e,t=i,r=(e=t.lib).Base,n=e.WordArray,s=(e=t.algo).HMAC,o=e.PBKDF2=r.extend({cfg:r.extend({keySize:4,hasher:e.SHA1,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e)},compute:function(e,t){for(var r=s.create((l=this.cfg).hasher,e),i=n.create(),o=n.create([1]),a=i.words,c=o.words,u=l.keySize,l=l.iterations;a.length<u;){var h=r.update(t).finalize(o);r.reset();for(var d=h.words,m=d.length,p=h,f=1;f<l;f++){p=r.finalize(p),r.reset();for(var g=p.words,y=0;y<m;y++)d[y]^=g[y]}i.concat(h),c[0]++}return i.sigBytes=4*u,i}});t.PBKDF2=function(e,t,r){return o.create(r).compute(e,t)}}();var s,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function a(e){var t,r,n="";for(t=0;t+3<=e.length;t+=3)r=parseInt(e.substring(t,t+3),16),n+=o.charAt(r>>6)+o.charAt(63&r);for(t+1==e.length?(r=parseInt(e.substring(t,t+1),16),n+=o.charAt(r<<2)):t+2==e.length&&(r=parseInt(e.substring(t,t+2),16),n+=o.charAt(r>>2)+o.charAt((3&r)<<4));(3&n.length)>0;)n+="=";return n}function c(e){var t,r,n,i="",s=0;for(t=0;t<e.length&&"="!=e.charAt(t);++t)(n=o.indexOf(e.charAt(t)))<0||(0==s?(i+=f(n>>2),r=3&n,s=1):1==s?(i+=f(r<<2|n>>4),r=15&n,s=2):2==s?(i+=f(r),i+=f(n>>2),r=3&n,s=3):(i+=f(r<<2|n>>4),i+=f(15&n),s=0));return 1==s&&(i+=f(r<<2)),i}function u(e){var t,r=c(e),n=new Array;for(t=0;2*t<r.length;++t)n[t]=parseInt(r.substring(2*t,2*t+2),16);return n}function l(e,t,r){null!=e&&("number"==typeof e?this.fromNumber(e,t,r):this.fromString(e,null==t&&"string"!=typeof e?256:t))}function h(){return new l(null)}"Microsoft Internet Explorer"==r.appName?(l.prototype.am=function(e,t,r,n,i,s){for(var o=32767&t,a=t>>15;--s>=0;){var c=32767&this[e],u=this[e++]>>15,l=a*c+u*o;i=((c=o*c+((32767&l)<<15)+r[n]+(1073741823&i))>>>30)+(l>>>15)+a*u+(i>>>30),r[n++]=1073741823&c}return i},s=30):"Netscape"!=r.appName?(l.prototype.am=function(e,t,r,n,i,s){for(;--s>=0;){var o=t*this[e++]+r[n]+i;i=Math.floor(o/67108864),r[n++]=67108863&o}return i},s=26):(l.prototype.am=function(e,t,r,n,i,s){for(var o=16383&t,a=t>>14;--s>=0;){var c=16383&this[e],u=this[e++]>>14,l=a*c+u*o;i=((c=o*c+((16383&l)<<14)+r[n]+i)>>28)+(l>>14)+a*u,r[n++]=268435455&c}return i},s=28),l.prototype.DB=s,l.prototype.DM=(1<<s)-1,l.prototype.DV=1<<s,l.prototype.FV=Math.pow(2,52),l.prototype.F1=52-s,l.prototype.F2=2*s-52;var d,m,p=new Array;for(d="0".charCodeAt(0),m=0;m<=9;++m)p[d++]=m;for(d="a".charCodeAt(0),m=10;m<36;++m)p[d++]=m;for(d="A".charCodeAt(0),m=10;m<36;++m)p[d++]=m;function f(e){return"0123456789abcdefghijklmnopqrstuvwxyz".charAt(e)}function g(e,t){var r=p[e.charCodeAt(t)];return null==r?-1:r}function y(e){var t=h();return t.fromInt(e),t}function v(e){var t,r=1;return 0!=(t=e>>>16)&&(e=t,r+=16),0!=(t=e>>8)&&(e=t,r+=8),0!=(t=e>>4)&&(e=t,r+=4),0!=(t=e>>2)&&(e=t,r+=2),0!=(t=e>>1)&&(e=t,r+=1),r}function b(e){this.m=e}function S(e){this.m=e,this.mp=e.invDigit(),this.mpl=32767&this.mp,this.mph=this.mp>>15,this.um=(1<<e.DB-15)-1,this.mt2=2*e.t}function w(e,t){return e&t}function C(e,t){return e|t}function E(e,t){return e^t}function I(e,t){return e&~t}function T(e){if(0==e)return-1;var t=0;return 0==(65535&e)&&(e>>=16,t+=16),0==(255&e)&&(e>>=8,t+=8),0==(15&e)&&(e>>=4,t+=4),0==(3&e)&&(e>>=2,t+=2),0==(1&e)&&++t,t}function N(e){for(var t=0;0!=e;)e&=e-1,++t;return t}function P(){}function x(e){return e}function O(e){this.r2=h(),this.q3=h(),l.ONE.dlShiftTo(2*e.t,this.r2),this.mu=this.r2.divide(e),this.m=e}b.prototype.convert=function(e){return e.s<0||e.compareTo(this.m)>=0?e.mod(this.m):e},b.prototype.revert=function(e){return e},b.prototype.reduce=function(e){e.divRemTo(this.m,null,e)},b.prototype.mulTo=function(e,t,r){e.multiplyTo(t,r),this.reduce(r)},b.prototype.sqrTo=function(e,t){e.squareTo(t),this.reduce(t)},S.prototype.convert=function(e){var t=h();return e.abs().dlShiftTo(this.m.t,t),t.divRemTo(this.m,null,t),e.s<0&&t.compareTo(l.ZERO)>0&&this.m.subTo(t,t),t},S.prototype.revert=function(e){var t=h();return e.copyTo(t),this.reduce(t),t},S.prototype.reduce=function(e){for(;e.t<=this.mt2;)e[e.t++]=0;for(var t=0;t<this.m.t;++t){var r=32767&e[t],n=r*this.mpl+((r*this.mph+(e[t]>>15)*this.mpl&this.um)<<15)&e.DM;for(e[r=t+this.m.t]+=this.m.am(0,n,e,t,0,this.m.t);e[r]>=e.DV;)e[r]-=e.DV,e[++r]++}e.clamp(),e.drShiftTo(this.m.t,e),e.compareTo(this.m)>=0&&e.subTo(this.m,e)},S.prototype.mulTo=function(e,t,r){e.multiplyTo(t,r),this.reduce(r)},S.prototype.sqrTo=function(e,t){e.squareTo(t),this.reduce(t)},l.prototype.copyTo=function(e){for(var t=this.t-1;t>=0;--t)e[t]=this[t];e.t=this.t,e.s=this.s},l.prototype.fromInt=function(e){this.t=1,this.s=e<0?-1:0,e>0?this[0]=e:e<-1?this[0]=e+this.DV:this.t=0},l.prototype.fromString=function(e,t){var r;if(16==t)r=4;else if(8==t)r=3;else if(256==t)r=8;else if(2==t)r=1;else if(32==t)r=5;else{if(4!=t)return void this.fromRadix(e,t);r=2}this.t=0,this.s=0;for(var n=e.length,i=!1,s=0;--n>=0;){var o=8==r?255&e[n]:g(e,n);o<0?"-"==e.charAt(n)&&(i=!0):(i=!1,0==s?this[this.t++]=o:s+r>this.DB?(this[this.t-1]|=(o&(1<<this.DB-s)-1)<<s,this[this.t++]=o>>this.DB-s):this[this.t-1]|=o<<s,(s+=r)>=this.DB&&(s-=this.DB))}8==r&&0!=(128&e[0])&&(this.s=-1,s>0&&(this[this.t-1]|=(1<<this.DB-s)-1<<s)),this.clamp(),i&&l.ZERO.subTo(this,this)},l.prototype.clamp=function(){for(var e=this.s&this.DM;this.t>0&&this[this.t-1]==e;)--this.t},l.prototype.dlShiftTo=function(e,t){var r;for(r=this.t-1;r>=0;--r)t[r+e]=this[r];for(r=e-1;r>=0;--r)t[r]=0;t.t=this.t+e,t.s=this.s},l.prototype.drShiftTo=function(e,t){for(var r=e;r<this.t;++r)t[r-e]=this[r];t.t=Math.max(this.t-e,0),t.s=this.s},l.prototype.lShiftTo=function(e,t){var r,n=e%this.DB,i=this.DB-n,s=(1<<i)-1,o=Math.floor(e/this.DB),a=this.s<<n&this.DM;for(r=this.t-1;r>=0;--r)t[r+o+1]=this[r]>>i|a,a=(this[r]&s)<<n;for(r=o-1;r>=0;--r)t[r]=0;t[o]=a,t.t=this.t+o+1,t.s=this.s,t.clamp()},l.prototype.rShiftTo=function(e,t){t.s=this.s;var r=Math.floor(e/this.DB);if(r>=this.t)t.t=0;else{var n=e%this.DB,i=this.DB-n,s=(1<<n)-1;t[0]=this[r]>>n;for(var o=r+1;o<this.t;++o)t[o-r-1]|=(this[o]&s)<<i,t[o-r]=this[o]>>n;n>0&&(t[this.t-r-1]|=(this.s&s)<<i),t.t=this.t-r,t.clamp()}},l.prototype.subTo=function(e,t){for(var r=0,n=0,i=Math.min(e.t,this.t);r<i;)n+=this[r]-e[r],t[r++]=n&this.DM,n>>=this.DB;if(e.t<this.t){for(n-=e.s;r<this.t;)n+=this[r],t[r++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;r<e.t;)n-=e[r],t[r++]=n&this.DM,n>>=this.DB;n-=e.s}t.s=n<0?-1:0,n<-1?t[r++]=this.DV+n:n>0&&(t[r++]=n),t.t=r,t.clamp()},l.prototype.multiplyTo=function(e,t){var r=this.abs(),n=e.abs(),i=r.t;for(t.t=i+n.t;--i>=0;)t[i]=0;for(i=0;i<n.t;++i)t[i+r.t]=r.am(0,n[i],t,i,0,r.t);t.s=0,t.clamp(),this.s!=e.s&&l.ZERO.subTo(t,t)},l.prototype.squareTo=function(e){for(var t=this.abs(),r=e.t=2*t.t;--r>=0;)e[r]=0;for(r=0;r<t.t-1;++r){var n=t.am(r,t[r],e,2*r,0,1);(e[r+t.t]+=t.am(r+1,2*t[r],e,2*r+1,n,t.t-r-1))>=t.DV&&(e[r+t.t]-=t.DV,e[r+t.t+1]=1)}e.t>0&&(e[e.t-1]+=t.am(r,t[r],e,2*r,0,1)),e.s=0,e.clamp()},l.prototype.divRemTo=function(e,t,r){var n=e.abs();if(!(n.t<=0)){var i=this.abs();if(i.t<n.t)return null!=t&&t.fromInt(0),void(null!=r&&this.copyTo(r));null==r&&(r=h());var s=h(),o=this.s,a=e.s,c=this.DB-v(n[n.t-1]);c>0?(n.lShiftTo(c,s),i.lShiftTo(c,r)):(n.copyTo(s),i.copyTo(r));var u=s.t,d=s[u-1];if(0!=d){var m=d*(1<<this.F1)+(u>1?s[u-2]>>this.F2:0),p=this.FV/m,f=(1<<this.F1)/m,g=1<<this.F2,y=r.t,b=y-u,S=null==t?h():t;for(s.dlShiftTo(b,S),r.compareTo(S)>=0&&(r[r.t++]=1,r.subTo(S,r)),l.ONE.dlShiftTo(u,S),S.subTo(s,s);s.t<u;)s[s.t++]=0;for(;--b>=0;){var w=r[--y]==d?this.DM:Math.floor(r[y]*p+(r[y-1]+g)*f);if((r[y]+=s.am(0,w,r,b,0,u))<w)for(s.dlShiftTo(b,S),r.subTo(S,r);r[y]<--w;)r.subTo(S,r)}null!=t&&(r.drShiftTo(u,t),o!=a&&l.ZERO.subTo(t,t)),r.t=u,r.clamp(),c>0&&r.rShiftTo(c,r),o<0&&l.ZERO.subTo(r,r)}}},l.prototype.invDigit=function(){if(this.t<1)return 0;var e=this[0];if(0==(1&e))return 0;var t=3&e;return(t=(t=(t=(t=t*(2-(15&e)*t)&15)*(2-(255&e)*t)&255)*(2-((65535&e)*t&65535))&65535)*(2-e*t%this.DV)%this.DV)>0?this.DV-t:-t},l.prototype.isEven=function(){return 0==(this.t>0?1&this[0]:this.s)},l.prototype.exp=function(e,t){if(e>4294967295||e<1)return l.ONE;var r=h(),n=h(),i=t.convert(this),s=v(e)-1;for(i.copyTo(r);--s>=0;)if(t.sqrTo(r,n),(e&1<<s)>0)t.mulTo(n,i,r);else{var o=r;r=n,n=o}return t.revert(r)},l.prototype.toString=function(e){if(this.s<0)return"-"+this.negate().toString(e);var t;if(16==e)t=4;else if(8==e)t=3;else if(2==e)t=1;else if(32==e)t=5;else{if(4!=e)return this.toRadix(e);t=2}var r,n=(1<<t)-1,i=!1,s="",o=this.t,a=this.DB-o*this.DB%t;if(o-- >0)for(a<this.DB&&(r=this[o]>>a)>0&&(i=!0,s=f(r));o>=0;)a<t?(r=(this[o]&(1<<a)-1)<<t-a,r|=this[--o]>>(a+=this.DB-t)):(r=this[o]>>(a-=t)&n,a<=0&&(a+=this.DB,--o)),r>0&&(i=!0),i&&(s+=f(r));return i?s:"0"},l.prototype.negate=function(){var e=h();return l.ZERO.subTo(this,e),e},l.prototype.abs=function(){return this.s<0?this.negate():this},l.prototype.compareTo=function(e){var t=this.s-e.s;if(0!=t)return t;var r=this.t;if(0!=(t=r-e.t))return this.s<0?-t:t;for(;--r>=0;)if(0!=(t=this[r]-e[r]))return t;return 0},l.prototype.bitLength=function(){return this.t<=0?0:this.DB*(this.t-1)+v(this[this.t-1]^this.s&this.DM)},l.prototype.mod=function(e){var t=h();return this.abs().divRemTo(e,null,t),this.s<0&&t.compareTo(l.ZERO)>0&&e.subTo(t,t),t},l.prototype.modPowInt=function(e,t){var r;return r=e<256||t.isEven()?new b(t):new S(t),this.exp(e,r)},l.ZERO=y(0),l.ONE=y(1),P.prototype.convert=x,P.prototype.revert=x,P.prototype.mulTo=function(e,t,r){e.multiplyTo(t,r)},P.prototype.sqrTo=function(e,t){e.squareTo(t)},O.prototype.convert=function(e){if(e.s<0||e.t>2*this.m.t)return e.mod(this.m);if(e.compareTo(this.m)<0)return e;var t=h();return e.copyTo(t),this.reduce(t),t},O.prototype.revert=function(e){return e},O.prototype.reduce=function(e){for(e.drShiftTo(this.m.t-1,this.r2),e.t>this.m.t+1&&(e.t=this.m.t+1,e.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);e.compareTo(this.r2)<0;)e.dAddOffset(1,this.m.t+1);for(e.subTo(this.r2,e);e.compareTo(this.m)>=0;)e.subTo(this.m,e)},O.prototype.mulTo=function(e,t,r){e.multiplyTo(t,r),this.reduce(r)},O.prototype.sqrTo=function(e,t){e.squareTo(t),this.reduce(t)};var M,k,L,R=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],D=(1<<26)/R[R.length-1];function F(){this.i=0,this.j=0,this.S=new Array}function A(){!function(e){k[L++]^=255&e,k[L++]^=e>>8&255,k[L++]^=e>>16&255,k[L++]^=e>>24&255,L>=256&&(L-=256)}((new Date).getTime())}if(l.prototype.chunkSize=function(e){return Math.floor(Math.LN2*this.DB/Math.log(e))},l.prototype.toRadix=function(e){if(null==e&&(e=10),0==this.signum()||e<2||e>36)return"0";var t=this.chunkSize(e),r=Math.pow(e,t),n=y(r),i=h(),s=h(),o="";for(this.divRemTo(n,i,s);i.signum()>0;)o=(r+s.intValue()).toString(e).substr(1)+o,i.divRemTo(n,i,s);return s.intValue().toString(e)+o},l.prototype.fromRadix=function(e,t){this.fromInt(0),null==t&&(t=10);for(var r=this.chunkSize(t),n=Math.pow(t,r),i=!1,s=0,o=0,a=0;a<e.length;++a){var c=g(e,a);c<0?"-"==e.charAt(a)&&0==this.signum()&&(i=!0):(o=t*o+c,++s>=r&&(this.dMultiply(n),this.dAddOffset(o,0),s=0,o=0))}s>0&&(this.dMultiply(Math.pow(t,s)),this.dAddOffset(o,0)),i&&l.ZERO.subTo(this,this)},l.prototype.fromNumber=function(e,t,r){if("number"==typeof t)if(e<2)this.fromInt(1);else for(this.fromNumber(e,r),this.testBit(e-1)||this.bitwiseTo(l.ONE.shiftLeft(e-1),C,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(t);)this.dAddOffset(2,0),this.bitLength()>e&&this.subTo(l.ONE.shiftLeft(e-1),this);else{var n=new Array,i=7&e;n.length=1+(e>>3),t.nextBytes(n),i>0?n[0]&=(1<<i)-1:n[0]=0,this.fromString(n,256)}},l.prototype.bitwiseTo=function(e,t,r){var n,i,s=Math.min(e.t,this.t);for(n=0;n<s;++n)r[n]=t(this[n],e[n]);if(e.t<this.t){for(i=e.s&this.DM,n=s;n<this.t;++n)r[n]=t(this[n],i);r.t=this.t}else{for(i=this.s&this.DM,n=s;n<e.t;++n)r[n]=t(i,e[n]);r.t=e.t}r.s=t(this.s,e.s),r.clamp()},l.prototype.changeBit=function(e,t){var r=l.ONE.shiftLeft(e);return this.bitwiseTo(r,t,r),r},l.prototype.addTo=function(e,t){for(var r=0,n=0,i=Math.min(e.t,this.t);r<i;)n+=this[r]+e[r],t[r++]=n&this.DM,n>>=this.DB;if(e.t<this.t){for(n+=e.s;r<this.t;)n+=this[r],t[r++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;r<e.t;)n+=e[r],t[r++]=n&this.DM,n>>=this.DB;n+=e.s}t.s=n<0?-1:0,n>0?t[r++]=n:n<-1&&(t[r++]=this.DV+n),t.t=r,t.clamp()},l.prototype.dMultiply=function(e){this[this.t]=this.am(0,e-1,this,0,0,this.t),++this.t,this.clamp()},l.prototype.dAddOffset=function(e,t){if(0!=e){for(;this.t<=t;)this[this.t++]=0;for(this[t]+=e;this[t]>=this.DV;)this[t]-=this.DV,++t>=this.t&&(this[this.t++]=0),++this[t]}},l.prototype.multiplyLowerTo=function(e,t,r){var n,i=Math.min(this.t+e.t,t);for(r.s=0,r.t=i;i>0;)r[--i]=0;for(n=r.t-this.t;i<n;++i)r[i+this.t]=this.am(0,e[i],r,i,0,this.t);for(n=Math.min(e.t,t);i<n;++i)this.am(0,e[i],r,i,0,t-i);r.clamp()},l.prototype.multiplyUpperTo=function(e,t,r){--t;var n=r.t=this.t+e.t-t;for(r.s=0;--n>=0;)r[n]=0;for(n=Math.max(t-this.t,0);n<e.t;++n)r[this.t+n-t]=this.am(t-n,e[n],r,0,0,this.t+n-t);r.clamp(),r.drShiftTo(1,r)},l.prototype.modInt=function(e){if(e<=0)return 0;var t=this.DV%e,r=this.s<0?e-1:0;if(this.t>0)if(0==t)r=this[0]%e;else for(var n=this.t-1;n>=0;--n)r=(t*r+this[n])%e;return r},l.prototype.millerRabin=function(e){var t=this.subtract(l.ONE),r=t.getLowestSetBit();if(r<=0)return!1;var n=t.shiftRight(r);(e=e+1>>1)>R.length&&(e=R.length);for(var i=h(),s=0;s<e;++s){i.fromInt(R[Math.floor(Math.random()*R.length)]);var o=i.modPow(n,this);if(0!=o.compareTo(l.ONE)&&0!=o.compareTo(t)){for(var a=1;a++<r&&0!=o.compareTo(t);)if(0==(o=o.modPowInt(2,this)).compareTo(l.ONE))return!1;if(0!=o.compareTo(t))return!1}}return!0},l.prototype.clone=function(){var e=h();return this.copyTo(e),e},l.prototype.intValue=function(){if(this.s<0){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]},l.prototype.byteValue=function(){return 0==this.t?this.s:this[0]<<24>>24},l.prototype.shortValue=function(){return 0==this.t?this.s:this[0]<<16>>16},l.prototype.signum=function(){return this.s<0?-1:this.t<=0||1==this.t&&this[0]<=0?0:1},l.prototype.toByteArray=function(){var e=this.t,t=new Array;t[0]=this.s;var r,n=this.DB-e*this.DB%8,i=0;if(e-- >0)for(n<this.DB&&(r=this[e]>>n)!=(this.s&this.DM)>>n&&(t[i++]=r|this.s<<this.DB-n);e>=0;)n<8?(r=(this[e]&(1<<n)-1)<<8-n,r|=this[--e]>>(n+=this.DB-8)):(r=this[e]>>(n-=8)&255,n<=0&&(n+=this.DB,--e)),0!=(128&r)&&(r|=-256),0==i&&(128&this.s)!=(128&r)&&++i,(i>0||r!=this.s)&&(t[i++]=r);return t},l.prototype.equals=function(e){return 0==this.compareTo(e)},l.prototype.min=function(e){return this.compareTo(e)<0?this:e},l.prototype.max=function(e){return this.compareTo(e)>0?this:e},l.prototype.and=function(e){var t=h();return this.bitwiseTo(e,w,t),t},l.prototype.or=function(e){var t=h();return this.bitwiseTo(e,C,t),t},l.prototype.xor=function(e){var t=h();return this.bitwiseTo(e,E,t),t},l.prototype.andNot=function(e){var t=h();return this.bitwiseTo(e,I,t),t},l.prototype.not=function(){for(var e=h(),t=0;t<this.t;++t)e[t]=this.DM&~this[t];return e.t=this.t,e.s=~this.s,e},l.prototype.shiftLeft=function(e){var t=h();return e<0?this.rShiftTo(-e,t):this.lShiftTo(e,t),t},l.prototype.shiftRight=function(e){var t=h();return e<0?this.lShiftTo(-e,t):this.rShiftTo(e,t),t},l.prototype.getLowestSetBit=function(){for(var e=0;e<this.t;++e)if(0!=this[e])return e*this.DB+T(this[e]);return this.s<0?this.t*this.DB:-1},l.prototype.bitCount=function(){for(var e=0,t=this.s&this.DM,r=0;r<this.t;++r)e+=N(this[r]^t);return e},l.prototype.testBit=function(e){var t=Math.floor(e/this.DB);return t>=this.t?0!=this.s:0!=(this[t]&1<<e%this.DB)},l.prototype.setBit=function(e){return this.changeBit(e,C)},l.prototype.clearBit=function(e){return this.changeBit(e,I)},l.prototype.flipBit=function(e){return this.changeBit(e,E)},l.prototype.add=function(e){var t=h();return this.addTo(e,t),t},l.prototype.subtract=function(e){var t=h();return this.subTo(e,t),t},l.prototype.multiply=function(e){var t=h();return this.multiplyTo(e,t),t},l.prototype.divide=function(e){var t=h();return this.divRemTo(e,t,null),t},l.prototype.remainder=function(e){var t=h();return this.divRemTo(e,null,t),t},l.prototype.divideAndRemainder=function(e){var t=h(),r=h();return this.divRemTo(e,t,r),new Array(t,r)},l.prototype.modPow=function(e,t){var r,n,i=e.bitLength(),s=y(1);if(i<=0)return s;r=i<18?1:i<48?3:i<144?4:i<768?5:6,n=i<8?new b(t):t.isEven()?new O(t):new S(t);var o=new Array,a=3,c=r-1,u=(1<<r)-1;if(o[1]=n.convert(this),r>1){var l=h();for(n.sqrTo(o[1],l);a<=u;)o[a]=h(),n.mulTo(l,o[a-2],o[a]),a+=2}var d,m,p=e.t-1,f=!0,g=h();for(i=v(e[p])-1;p>=0;){for(i>=c?d=e[p]>>i-c&u:(d=(e[p]&(1<<i+1)-1)<<c-i,p>0&&(d|=e[p-1]>>this.DB+i-c)),a=r;0==(1&d);)d>>=1,--a;if((i-=a)<0&&(i+=this.DB,--p),f)o[d].copyTo(s),f=!1;else{for(;a>1;)n.sqrTo(s,g),n.sqrTo(g,s),a-=2;a>0?n.sqrTo(s,g):(m=s,s=g,g=m),n.mulTo(g,o[d],s)}for(;p>=0&&0==(e[p]&1<<i);)n.sqrTo(s,g),m=s,s=g,g=m,--i<0&&(i=this.DB-1,--p)}return n.revert(s)},l.prototype.modInverse=function(e){var t=e.isEven();if(this.isEven()&&t||0==e.signum())return l.ZERO;for(var r=e.clone(),n=this.clone(),i=y(1),s=y(0),o=y(0),a=y(1);0!=r.signum();){for(;r.isEven();)r.rShiftTo(1,r),t?(i.isEven()&&s.isEven()||(i.addTo(this,i),s.subTo(e,s)),i.rShiftTo(1,i)):s.isEven()||s.subTo(e,s),s.rShiftTo(1,s);for(;n.isEven();)n.rShiftTo(1,n),t?(o.isEven()&&a.isEven()||(o.addTo(this,o),a.subTo(e,a)),o.rShiftTo(1,o)):a.isEven()||a.subTo(e,a),a.rShiftTo(1,a);r.compareTo(n)>=0?(r.subTo(n,r),t&&i.subTo(o,i),s.subTo(a,s)):(n.subTo(r,n),t&&o.subTo(i,o),a.subTo(s,a))}return 0!=n.compareTo(l.ONE)?l.ZERO:a.compareTo(e)>=0?a.subtract(e):a.signum()<0?(a.addTo(e,a),a.signum()<0?a.add(e):a):a},l.prototype.pow=function(e){return this.exp(e,new P)},l.prototype.gcd=function(e){var t=this.s<0?this.negate():this.clone(),r=e.s<0?e.negate():e.clone();if(t.compareTo(r)<0){var n=t;t=r,r=n}var i=t.getLowestSetBit(),s=r.getLowestSetBit();if(s<0)return t;for(i<s&&(s=i),s>0&&(t.rShiftTo(s,t),r.rShiftTo(s,r));t.signum()>0;)(i=t.getLowestSetBit())>0&&t.rShiftTo(i,t),(i=r.getLowestSetBit())>0&&r.rShiftTo(i,r),t.compareTo(r)>=0?(t.subTo(r,t),t.rShiftTo(1,t)):(r.subTo(t,r),r.rShiftTo(1,r));return s>0&&r.lShiftTo(s,r),r},l.prototype.isProbablePrime=function(e){var t,r=this.abs();if(1==r.t&&r[0]<=R[R.length-1]){for(t=0;t<R.length;++t)if(r[0]==R[t])return!0;return!1}if(r.isEven())return!1;for(t=1;t<R.length;){for(var n=R[t],i=t+1;i<R.length&&n<D;)n*=R[i++];for(n=r.modInt(n);t<i;)if(n%R[t++]==0)return!1}return r.millerRabin(e)},l.prototype.square=function(){var e=h();return this.squareTo(e),e},F.prototype.init=function(e){var t,r,n;for(t=0;t<256;++t)this.S[t]=t;for(r=0,t=0;t<256;++t)n=this.S[t],this.S[t]=this.S[r=r+this.S[t]+e[t%e.length]&255],this.S[r]=n;this.i=0,this.j=0},F.prototype.next=function(){var e;return this.i=this.i+1&255,this.j=this.j+this.S[this.i]&255,e=this.S[this.i],this.S[this.i]=this.S[this.j],this.S[this.j]=e,this.S[e+this.S[this.i]&255]},null==k){var j;if(k=new Array,L=0,void 0!==n&&(void 0!==n.crypto||void 0!==n.msCrypto)){var q=n.crypto||n.msCrypto;if(q.getRandomValues){var B=new Uint8Array(32);for(q.getRandomValues(B),j=0;j<32;++j)k[L++]=B[j]}else if("Netscape"==r.appName&&r.appVersion<"5"){var _=n.crypto.random(32);for(j=0;j<_.length;++j)k[L++]=255&_.charCodeAt(j)}}for(;L<256;)j=Math.floor(65536*Math.random()),k[L++]=j>>>8,k[L++]=255&j;L=0,A()}function H(){if(null==M){for(A(),(M=function(){return new F}()).init(k),L=0;L<k.length;++L)k[L]=0;L=0}return M.next()}function V(){}function $(e,t){return new l(e,t)}function U(e,t,r){for(var n="",i=0;n.length<t;)n+=r(String.fromCharCode.apply(String,e.concat([(4278190080&i)>>24,(16711680&i)>>16,(65280&i)>>8,255&i]))),i+=1;return n}function K(){this.n=null,this.e=0,this.d=null,this.p=null,this.q=null,this.dmp1=null,this.dmq1=null,this.coeff=null}function W(e,t,r){for(var n="",i=0;n.length<t;)n+=r(e+String.fromCharCode.apply(String,[(4278190080&i)>>24,(16711680&i)>>16,(65280&i)>>8,255&i])),i+=1;return n}function J(e,t){this.x=t,this.q=e}function G(e,t,r,n){this.curve=e,this.x=t,this.y=r,this.z=null==n?l.ONE:n,this.zinv=null}function z(e,t,r){this.q=e,this.a=this.fromBigInteger(t),this.b=this.fromBigInteger(r),this.infinity=new G(this,null,null)}V.prototype.nextBytes=function(e){var t;for(t=0;t<e.length;++t)e[t]=H()},K.prototype.doPublic=function(e){return e.modPowInt(this.e,this.n)},K.prototype.setPublic=function(e,t){if(this.isPublic=!0,this.isPrivate=!1,"string"!=typeof e)this.n=e,this.e=t;else{if(!(null!=e&&null!=t&&e.length>0&&t.length>0))throw"Invalid RSA public key";this.n=$(e,16),this.e=parseInt(t,16)}},K.prototype.encrypt=function(e){var t=function(e,t){if(t<e.length+11)throw"Message too long for RSA";for(var r=new Array,n=e.length-1;n>=0&&t>0;){var i=e.charCodeAt(n--);i<128?r[--t]=i:i>127&&i<2048?(r[--t]=63&i|128,r[--t]=i>>6|192):(r[--t]=63&i|128,r[--t]=i>>6&63|128,r[--t]=i>>12|224)}r[--t]=0;for(var s=new V,o=new Array;t>2;){for(o[0]=0;0==o[0];)s.nextBytes(o);r[--t]=o[0]}return r[--t]=2,r[--t]=0,new l(r)}(e,this.n.bitLength()+7>>3);if(null==t)return null;var r=this.doPublic(t);if(null==r)return null;var n=r.toString(16);return 0==(1&n.length)?n:"0"+n},K.prototype.encryptOAEP=function(e,t,r){var n=function(e,t,r,n){var i=X.crypto.MessageDigest,s=X.crypto.Util,o=null;if(r||(r="sha1"),"string"==typeof r&&(o=i.getCanonicalAlgName(r),n=i.getHashLength(o),r=function(e){return de(s.hashHex(me(e),o))}),e.length+2*n+2>t)throw"Message too long for RSA";var a,c="";for(a=0;a<t-e.length-2*n-2;a+=1)c+="\0";var u=r("")+c+""+e,h=new Array(n);(new V).nextBytes(h);var d=U(h,u.length,r),m=[];for(a=0;a<u.length;a+=1)m[a]=u.charCodeAt(a)^d.charCodeAt(a);var p=U(m,h.length,r),f=[0];for(a=0;a<h.length;a+=1)f[a+1]=h[a]^p.charCodeAt(a);return new l(f.concat(m))}(e,this.n.bitLength()+7>>3,t,r);if(null==n)return null;var i=this.doPublic(n);if(null==i)return null;var s=i.toString(16);return 0==(1&s.length)?s:"0"+s},K.prototype.type="RSA",K.prototype.doPrivate=function(e){if(null==this.p||null==this.q)return e.modPow(this.d,this.n);for(var t=e.mod(this.p).modPow(this.dmp1,this.p),r=e.mod(this.q).modPow(this.dmq1,this.q);t.compareTo(r)<0;)t=t.add(this.p);return t.subtract(r).multiply(this.coeff).mod(this.p).multiply(this.q).add(r)},K.prototype.setPrivate=function(e,t,r){if(this.isPrivate=!0,"string"!=typeof e)this.n=e,this.e=t,this.d=r;else{if(!(null!=e&&null!=t&&e.length>0&&t.length>0))throw"Invalid RSA private key";this.n=$(e,16),this.e=parseInt(t,16),this.d=$(r,16)}},K.prototype.setPrivateEx=function(e,t,r,n,i,s,o,a){if(this.isPrivate=!0,this.isPublic=!1,null==e)throw"RSASetPrivateEx N == null";if(null==t)throw"RSASetPrivateEx E == null";if(0==e.length)throw"RSASetPrivateEx N.length == 0";if(0==t.length)throw"RSASetPrivateEx E.length == 0";if(!(null!=e&&null!=t&&e.length>0&&t.length>0))throw"Invalid RSA private key in RSASetPrivateEx";this.n=$(e,16),this.e=parseInt(t,16),this.d=$(r,16),this.p=$(n,16),this.q=$(i,16),this.dmp1=$(s,16),this.dmq1=$(o,16),this.coeff=$(a,16)},K.prototype.generate=function(e,t){var r=new V,n=e>>1;this.e=parseInt(t,16);for(var i=new l(t,16),s=e/2-100,o=l.ONE.shiftLeft(s);;){for(;this.p=new l(e-n,1,r),0!=this.p.subtract(l.ONE).gcd(i).compareTo(l.ONE)||!this.p.isProbablePrime(10););for(;this.q=new l(n,1,r),0!=this.q.subtract(l.ONE).gcd(i).compareTo(l.ONE)||!this.q.isProbablePrime(10););if(this.p.compareTo(this.q)<=0){var a=this.p;this.p=this.q,this.q=a}var c=this.q.subtract(this.p).abs();if(!(c.bitLength()<s||c.compareTo(o)<=0)){var u=this.p.subtract(l.ONE),h=this.q.subtract(l.ONE),d=u.multiply(h);if(0==d.gcd(i).compareTo(l.ONE)&&(this.n=this.p.multiply(this.q),this.n.bitLength()==e)){this.d=i.modInverse(d),this.dmp1=this.d.mod(u),this.dmq1=this.d.mod(h),this.coeff=this.q.modInverse(this.p);break}}}this.isPrivate=!0},K.prototype.decrypt=function(e){if(e.length!=Math.ceil(this.n.bitLength()/4))throw new Error("wrong ctext length");var t=$(e,16),r=this.doPrivate(t);return null==r?null:function(e,t){for(var r=e.toByteArray(),n=0;n<r.length&&0==r[n];)++n;if(r.length-n!=t-1||2!=r[n])return null;for(++n;0!=r[n];)if(++n>=r.length)return null;for(var i="";++n<r.length;){var s=255&r[n];s<128?i+=String.fromCharCode(s):s>191&&s<224?(i+=String.fromCharCode((31&s)<<6|63&r[n+1]),++n):(i+=String.fromCharCode((15&s)<<12|(63&r[n+1])<<6|63&r[n+2]),n+=2)}return i}(r,this.n.bitLength()+7>>3)},K.prototype.decryptOAEP=function(e,t,r){if(e.length!=Math.ceil(this.n.bitLength()/4))throw new Error("wrong ctext length");var n=$(e,16),i=this.doPrivate(n);return null==i?null:function(e,t,r,n){var i=X.crypto.MessageDigest,s=X.crypto.Util,o=null;for(r||(r="sha1"),"string"==typeof r&&(o=i.getCanonicalAlgName(r),n=i.getHashLength(o),r=function(e){return de(s.hashHex(me(e),o))}),e=e.toByteArray(),a=0;a<e.length;a+=1)e[a]&=255;for(;e.length<t;)e.unshift(0);if((e=String.fromCharCode.apply(String,e)).length<2*n+2)throw"Cipher too short";var a,c=e.substr(1,n),u=e.substr(n+1),l=W(u,n,r),h=[];for(a=0;a<c.length;a+=1)h[a]=c.charCodeAt(a)^l.charCodeAt(a);var d=W(String.fromCharCode.apply(String,h),e.length-n,r),m=[];for(a=0;a<u.length;a+=1)m[a]=u.charCodeAt(a)^d.charCodeAt(a);if((m=String.fromCharCode.apply(String,m)).substr(0,n)!==r(""))throw"Hash mismatch";var p=(m=m.substr(n)).indexOf("");if((-1!=p?m.substr(0,p).lastIndexOf("\0"):-1)+1!=p)throw"Malformed data";return m.substr(p+1)}(i,this.n.bitLength()+7>>3,t,r)},J.prototype.equals=function(e){return e==this||this.q.equals(e.q)&&this.x.equals(e.x)},J.prototype.toBigInteger=function(){return this.x},J.prototype.negate=function(){return new J(this.q,this.x.negate().mod(this.q))},J.prototype.add=function(e){return new J(this.q,this.x.add(e.toBigInteger()).mod(this.q))},J.prototype.subtract=function(e){return new J(this.q,this.x.subtract(e.toBigInteger()).mod(this.q))},J.prototype.multiply=function(e){return new J(this.q,this.x.multiply(e.toBigInteger()).mod(this.q))},J.prototype.square=function(){return new J(this.q,this.x.square().mod(this.q))},J.prototype.divide=function(e){return new J(this.q,this.x.multiply(e.toBigInteger().modInverse(this.q)).mod(this.q))},J.prototype.sqrt=function(){return new J(this.q,this.x.sqrt().mod(this.q))},G.prototype.getX=function(){return null==this.zinv&&(this.zinv=this.z.modInverse(this.curve.q)),this.curve.fromBigInteger(this.x.toBigInteger().multiply(this.zinv).mod(this.curve.q))},G.prototype.getY=function(){return null==this.zinv&&(this.zinv=this.z.modInverse(this.curve.q)),this.curve.fromBigInteger(this.y.toBigInteger().multiply(this.zinv).mod(this.curve.q))},G.prototype.equals=function(e){return e==this||(this.isInfinity()?e.isInfinity():e.isInfinity()?this.isInfinity():!!e.y.toBigInteger().multiply(this.z).subtract(this.y.toBigInteger().multiply(e.z)).mod(this.curve.q).equals(l.ZERO)&&e.x.toBigInteger().multiply(this.z).subtract(this.x.toBigInteger().multiply(e.z)).mod(this.curve.q).equals(l.ZERO))},G.prototype.isInfinity=function(){return null==this.x&&null==this.y||this.z.equals(l.ZERO)&&!this.y.toBigInteger().equals(l.ZERO)},G.prototype.negate=function(){return new G(this.curve,this.x,this.y.negate(),this.z)},G.prototype.add=function(e){if(this.isInfinity())return e;if(e.isInfinity())return this;var t=e.y.toBigInteger().multiply(this.z).subtract(this.y.toBigInteger().multiply(e.z)).mod(this.curve.q),r=e.x.toBigInteger().multiply(this.z).subtract(this.x.toBigInteger().multiply(e.z)).mod(this.curve.q);if(l.ZERO.equals(r))return l.ZERO.equals(t)?this.twice():this.curve.getInfinity();var n=new l("3"),i=this.x.toBigInteger(),s=this.y.toBigInteger(),o=(e.x.toBigInteger(),e.y.toBigInteger(),r.square()),a=o.multiply(r),c=i.multiply(o),u=t.square().multiply(this.z),h=u.subtract(c.shiftLeft(1)).multiply(e.z).subtract(a).multiply(r).mod(this.curve.q),d=c.multiply(n).multiply(t).subtract(s.multiply(a)).subtract(u.multiply(t)).multiply(e.z).add(t.multiply(a)).mod(this.curve.q),m=a.multiply(this.z).multiply(e.z).mod(this.curve.q);return new G(this.curve,this.curve.fromBigInteger(h),this.curve.fromBigInteger(d),m)},G.prototype.twice=function(){if(this.isInfinity())return this;if(0==this.y.toBigInteger().signum())return this.curve.getInfinity();var e=new l("3"),t=this.x.toBigInteger(),r=this.y.toBigInteger(),n=r.multiply(this.z),i=n.multiply(r).mod(this.curve.q),s=this.curve.a.toBigInteger(),o=t.square().multiply(e);l.ZERO.equals(s)||(o=o.add(this.z.square().multiply(s)));var a=(o=o.mod(this.curve.q)).square().subtract(t.shiftLeft(3).multiply(i)).shiftLeft(1).multiply(n).mod(this.curve.q),c=o.multiply(e).multiply(t).subtract(i.shiftLeft(1)).shiftLeft(2).multiply(i).subtract(o.square().multiply(o)).mod(this.curve.q),u=n.square().multiply(n).shiftLeft(3).mod(this.curve.q);return new G(this.curve,this.curve.fromBigInteger(a),this.curve.fromBigInteger(c),u)},G.prototype.multiply=function(e){if(this.isInfinity())return this;if(0==e.signum())return this.curve.getInfinity();var t,r=e,n=r.multiply(new l("3")),i=this.negate(),s=this,o=this.curve.q.subtract(e),a=o.multiply(new l("3")),c=new G(this.curve,this.x,this.y),u=c.negate();for(t=n.bitLength()-2;t>0;--t){s=s.twice();var h=n.testBit(t);h!=r.testBit(t)&&(s=s.add(h?this:i))}for(t=a.bitLength()-2;t>0;--t){c=c.twice();var d=a.testBit(t);d!=o.testBit(t)&&(c=c.add(d?c:u))}return s},G.prototype.multiplyTwo=function(e,t,r){var n;n=e.bitLength()>r.bitLength()?e.bitLength()-1:r.bitLength()-1;for(var i=this.curve.getInfinity(),s=this.add(t);n>=0;)i=i.twice(),e.testBit(n)?i=r.testBit(n)?i.add(s):i.add(this):r.testBit(n)&&(i=i.add(t)),--n;return i},z.prototype.getQ=function(){return this.q},z.prototype.getA=function(){return this.a},z.prototype.getB=function(){return this.b},z.prototype.equals=function(e){return e==this||this.q.equals(e.q)&&this.a.equals(e.a)&&this.b.equals(e.b)},z.prototype.getInfinity=function(){return this.infinity},z.prototype.fromBigInteger=function(e){return new J(this.q,e)},z.prototype.decodePointHex=function(e){switch(parseInt(e.substr(0,2),16)){case 0:return this.infinity;case 2:case 3:var t=e.substr(0,2),r=(e.substr(2),this.fromBigInteger(new l(a,16))),n=this.getA(),i=this.getB(),s=r.square().add(n).multiply(r).add(i).sqrt();return"03"==t&&(s=s.negate()),new G(this,r,s);case 4:case 6:case 7:var o=(e.length-2)/2,a=e.substr(2,o),c=e.substr(o+2,o);return new G(this,this.fromBigInteger(new l(a,16)),this.fromBigInteger(new l(c,16)));default:return null}},J.prototype.getByteLength=function(){return Math.floor((this.toBigInteger().bitLength()+7)/8)},G.prototype.getEncoded=function(e){var t=function(e,t){var r=e.toByteArrayUnsigned();if(t<r.length)r=r.slice(r.length-t);else for(;t>r.length;)r.unshift(0);return r},r=this.getX().toBigInteger(),n=this.getY().toBigInteger(),i=t(r,32);return e?n.isEven()?i.unshift(2):i.unshift(3):(i.unshift(4),i=i.concat(t(n,32))),i},G.decodeFrom=function(e,t){var r=t.length-1,n=t.slice(1,1+r/2),i=t.slice(1+r/2,1+r);n.unshift(0),i.unshift(0);var s=new l(n),o=new l(i);return new G(e,e.fromBigInteger(s),e.fromBigInteger(o))},G.decodeFromHex=function(e,t){t.substr(0,2);var r=t.length-2,n=t.substr(2,r/2),i=t.substr(2+r/2,r/2),s=new l(n,16),o=new l(i,16);return new G(e,e.fromBigInteger(s),e.fromBigInteger(o))},G.prototype.add2D=function(e){if(this.isInfinity())return e;if(e.isInfinity())return this;if(this.x.equals(e.x))return this.y.equals(e.y)?this.twice():this.curve.getInfinity();var t=e.x.subtract(this.x),r=e.y.subtract(this.y).divide(t),n=r.square().subtract(this.x).subtract(e.x),i=r.multiply(this.x.subtract(n)).subtract(this.y);return new G(this.curve,n,i)},G.prototype.twice2D=function(){if(this.isInfinity())return this;if(0==this.y.toBigInteger().signum())return this.curve.getInfinity();var e=this.curve.fromBigInteger(l.valueOf(2)),t=this.curve.fromBigInteger(l.valueOf(3)),r=this.x.square().multiply(t).add(this.curve.a).divide(this.y.multiply(e)),n=r.square().subtract(this.x.multiply(e)),i=r.multiply(this.x.subtract(n)).subtract(this.y);return new G(this.curve,n,i)},G.prototype.multiply2D=function(e){if(this.isInfinity())return this;if(0==e.signum())return this.curve.getInfinity();var t,r=e,n=r.multiply(new l("3")),i=this.negate(),s=this;for(t=n.bitLength()-2;t>0;--t){s=s.twice();var o=n.testBit(t);o!=r.testBit(t)&&(s=s.add2D(o?this:i))}return s},G.prototype.isOnCurve=function(){var e=this.getX().toBigInteger(),t=this.getY().toBigInteger(),r=this.curve.getA().toBigInteger(),n=this.curve.getB().toBigInteger(),i=this.curve.getQ(),s=t.multiply(t).mod(i),o=e.multiply(e).multiply(e).add(r.multiply(e)).add(n).mod(i);return s.equals(o)},G.prototype.toString=function(){return"("+this.getX().toBigInteger().toString()+","+this.getY().toBigInteger().toString()+")"},G.prototype.validate=function(){var e=this.curve.getQ();if(this.isInfinity())throw new Error("Point is at infinity.");var t=this.getX().toBigInteger(),r=this.getY().toBigInteger();if(t.compareTo(l.ONE)<0||t.compareTo(e.subtract(l.ONE))>0)throw new Error("x coordinate out of bounds");if(r.compareTo(l.ONE)<0||r.compareTo(e.subtract(l.ONE))>0)throw new Error("y coordinate out of bounds");if(!this.isOnCurve())throw new Error("Point is not on the curve.");if(this.multiply(e).isInfinity())throw new Error("Point is not a scalar multiple of G.");return!0};var Q=function(){var e=new RegExp('(?:false|true|null|[\\{\\}\\[\\]]|(?:-?\\b(?:0|[1-9][0-9]*)(?:\\.[0-9]+)?(?:[eE][+-]?[0-9]+)?\\b)|(?:"(?:[^\\0-\\x08\\x0a-\\x1f"\\\\]|\\\\(?:["/\\\\bfnrt]|u[0-9A-Fa-f]{4}))*"))',"g"),t=new RegExp("\\\\(?:([^u])|u(.{4}))","g"),r={'"':'"',"/":"/","\\":"\\",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"};function n(e,t,n){return t?r[t]:String.fromCharCode(parseInt(n,16))}var i=new String(""),s=Object.hasOwnProperty;return function(r,o){var a,c,u=r.match(e),l=u[0],h=!1;"{"===l?a={}:"["===l?a=[]:(a=[],h=!0);for(var d=[a],m=1-h,p=u.length;m<p;++m){var f;switch((l=u[m]).charCodeAt(0)){default:(f=d[0])[c||f.length]=+l,c=void 0;break;case 34:if(-1!==(l=l.substring(1,l.length-1)).indexOf("\\")&&(l=l.replace(t,n)),f=d[0],!c){if(!(f instanceof Array)){c=l||i;break}c=f.length}f[c]=l,c=void 0;break;case 91:d.unshift((f=d[0])[c||f.length]=[]),c=void 0;break;case 93:d.shift();break;case 102:(f=d[0])[c||f.length]=!1,c=void 0;break;case 110:(f=d[0])[c||f.length]=null,c=void 0;break;case 116:(f=d[0])[c||f.length]=!0,c=void 0;break;case 123:d.unshift((f=d[0])[c||f.length]={}),c=void 0;break;case 125:d.shift()}}if(h){if(1!==d.length)throw new Error;a=a[0]}else if(d.length)throw new Error;if(o){var g=function(e,t){var r=e[t];if(r&&"object"==typeof r){var n=null;for(var i in r)if(s.call(r,i)&&r!==e){var a=g(r,i);void 0!==a?r[i]=a:(n||(n=[]),n.push(i))}if(n)for(var c=n.length;--c>=0;)delete r[n[c]]}return o.call(e,t,r)};a=g({"":a},"")}return a}}();void 0!==X&&X||(X={}),void 0!==X.asn1&&X.asn1||(X.asn1={}),X.asn1.ASN1Util=new function(){this.integerToByteHex=function(e){var t=e.toString(16);return t.length%2==1&&(t="0"+t),t},this.bigIntToMinTwosComplementsHex=function(e){var t=e.toString(16);if("-"!=t.substr(0,1))t.length%2==1?t="0"+t:t.match(/^[0-7]/)||(t="00"+t);else{var r=t.substr(1).length;r%2==1?r+=1:t.match(/^[0-7]/)||(r+=2);for(var n="",i=0;i<r;i++)n+="f";t=new l(n,16).xor(e).add(l.ONE).toString(16).replace(/^-/,"")}return t},this.getPEMStringFromHex=function(e,t){return ye(e,t)},this.newObject=function(e){var t=X.asn1,r=t.ASN1Object,n=t.DERBoolean,i=t.DERInteger,s=t.DERBitString,o=t.DEROctetString,a=t.DERNull,c=t.DERObjectIdentifier,u=t.DEREnumerated,l=t.DERUTF8String,h=t.DERNumericString,d=t.DERPrintableString,m=t.DERTeletexString,p=t.DERIA5String,f=t.DERUTCTime,g=t.DERGeneralizedTime,y=t.DERVisibleString,v=t.DERBMPString,b=t.DERSequence,S=t.DERSet,w=t.DERTaggedObject,C=t.ASN1Util.newObject;if(e instanceof t.ASN1Object)return e;var E=Object.keys(e);if(1!=E.length)throw new Error("key of param shall be only one.");var I=E[0];if(-1==":asn1:bool:int:bitstr:octstr:null:oid:enum:utf8str:numstr:prnstr:telstr:ia5str:utctime:gentime:visstr:bmpstr:seq:set:tag:".indexOf(":"+I+":"))throw new Error("undefined key: "+I);if("bool"==I)return new n(e[I]);if("int"==I)return new i(e[I]);if("bitstr"==I)return new s(e[I]);if("octstr"==I)return new o(e[I]);if("null"==I)return new a(e[I]);if("oid"==I)return new c(e[I]);if("enum"==I)return new u(e[I]);if("utf8str"==I)return new l(e[I]);if("numstr"==I)return new h(e[I]);if("prnstr"==I)return new d(e[I]);if("telstr"==I)return new m(e[I]);if("ia5str"==I)return new p(e[I]);if("utctime"==I)return new f(e[I]);if("gentime"==I)return new g(e[I]);if("visstr"==I)return new y(e[I]);if("bmpstr"==I)return new v(e[I]);if("asn1"==I)return new r(e[I]);if("seq"==I){for(var T=e[I],N=[],P=0;P<T.length;P++){var x=C(T[P]);N.push(x)}return new b({array:N})}if("set"==I){for(T=e[I],N=[],P=0;P<T.length;P++)x=C(T[P]),N.push(x);return new S({array:N})}if("tag"==I){var O=e[I];if("[object Array]"===Object.prototype.toString.call(O)&&3==O.length){var M=C(O[2]);return new w({tag:O[0],explicit:O[1],obj:M})}return new w(O)}},this.jsonToASN1HEX=function(e){return this.newObject(e).tohex()}},X.asn1.ASN1Util.oidHexToInt=function(e){for(var t="",r=parseInt(e.substr(0,2),16),n=(t=Math.floor(r/40)+"."+r%40,""),i=2;i<e.length;i+=2){var s=("00000000"+parseInt(e.substr(i,2),16).toString(2)).slice(-8);n+=s.substr(1,7),"0"==s.substr(0,1)&&(t=t+"."+new l(n,2).toString(10),n="")}return t},X.asn1.ASN1Util.oidIntToHex=function(e){var t=function(e){var t=e.toString(16);return 1==t.length&&(t="0"+t),t},r=function(e){var r="",n=new l(e,10).toString(2),i=7-n.length%7;7==i&&(i=0);for(var s="",o=0;o<i;o++)s+="0";for(n=s+n,o=0;o<n.length-1;o+=7){var a=n.substr(o,7);o!=n.length-7&&(a="1"+a),r+=t(parseInt(a,2))}return r};if(!e.match(/^[0-9.]+$/))throw"malformed oid string: "+e;var n="",i=e.split("."),s=40*parseInt(i[0])+parseInt(i[1]);n+=t(s),i.splice(0,2);for(var o=0;o<i.length;o++)n+=r(i[o]);return n},X.asn1.ASN1Object=function(e){this.params=null,this.getLengthHexFromValue=function(){if(void 0===this.hV||null==this.hV)throw new Error("this.hV is null or undefined");if(this.hV.length%2==1)throw new Error("value hex must be even length: n="+"".length+",v="+this.hV);var e=this.hV.length/2,t=e.toString(16);if(t.length%2==1&&(t="0"+t),e<128)return t;var r=t.length/2;if(r>15)throw new Error("ASN.1 length too long to represent by 8x: n = "+e.toString(16));return(128+r).toString(16)+t},this.tohex=function(){return(null==this.hTLV||this.isModified)&&(this.hV=this.getFreshValueHex(),this.hL=this.getLengthHexFromValue(),this.hTLV=this.hT+this.hL+this.hV,this.isModified=!1),this.hTLV},this.getEncodedHex=function(){return this.tohex()},this.getValueHex=function(){return this.tohex(),this.hV},this.getFreshValueHex=function(){return""},this.setByParam=function(e){this.params=e},null!=e&&null!=e.tlv&&(this.hTLV=e.tlv,this.isModified=!1)},X.asn1.DERAbstractString=function(e){X.asn1.DERAbstractString.superclass.constructor.call(this),this.getString=function(){return this.s},this.setString=function(e){this.hTLV=null,this.isModified=!0,this.s=e,this.hV=ue(this.s).toLowerCase()},this.setStringHex=function(e){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=e},this.getFreshValueHex=function(){return this.hV},void 0!==e&&("string"==typeof e?this.setString(e):void 0!==e.str?this.setString(e.str):void 0!==e.hex&&this.setStringHex(e.hex))},He(X.asn1.DERAbstractString,X.asn1.ASN1Object),X.asn1.DERAbstractTime=function(e){X.asn1.DERAbstractTime.superclass.constructor.call(this),this.localDateToUTC=function(e){var t=e.getTime()+6e4*e.getTimezoneOffset();return new Date(t)},this.formatDate=function(e,t,r){var n=this.zeroPadding,i=this.localDateToUTC(e),s=String(i.getFullYear());"utc"==t&&(s=s.substr(2,2));var o=s+n(String(i.getMonth()+1),2)+n(String(i.getDate()),2)+n(String(i.getHours()),2)+n(String(i.getMinutes()),2)+n(String(i.getSeconds()),2);if(!0===r){var a=i.getMilliseconds();if(0!=a){var c=n(String(a),3);o=o+"."+(c=c.replace(/[0]+$/,""))}}return o+"Z"},this.zeroPadding=function(e,t){return e.length>=t?e:new Array(t-e.length+1).join("0")+e},this.setByParam=function(e){this.hV=null,this.hTLV=null,this.params=e},this.getString=function(){},this.setString=function(e){this.hTLV=null,this.isModified=!0,null==this.params&&(this.params={}),this.params.str=e},this.setByDate=function(e){this.hTLV=null,this.isModified=!0,null==this.params&&(this.params={}),this.params.date=e},this.setByDateValue=function(e,t,r,n,i,s){var o=new Date(Date.UTC(e,t-1,r,n,i,s,0));this.setByDate(o)},this.getFreshValueHex=function(){return this.hV}},He(X.asn1.DERAbstractTime,X.asn1.ASN1Object),X.asn1.DERAbstractStructured=function(e){X.asn1.DERAbstractString.superclass.constructor.call(this),this.setByASN1ObjectArray=function(e){this.hTLV=null,this.isModified=!0,this.asn1Array=e},this.appendASN1Object=function(e){this.hTLV=null,this.isModified=!0,this.asn1Array.push(e)},this.asn1Array=new Array,void 0!==e&&void 0!==e.array&&(this.asn1Array=e.array)},He(X.asn1.DERAbstractStructured,X.asn1.ASN1Object),X.asn1.DERBoolean=function(e){X.asn1.DERBoolean.superclass.constructor.call(this),this.hT="01",this.hTLV=0==e?"010100":"0101ff"},He(X.asn1.DERBoolean,X.asn1.ASN1Object),X.asn1.DERInteger=function(e){X.asn1.DERInteger.superclass.constructor.call(this),this.hT="02",this.setByBigInteger=function(e){this.hTLV=null,this.isModified=!0,this.hV=X.asn1.ASN1Util.bigIntToMinTwosComplementsHex(e)},this.setByInteger=function(e){var t=new l(String(e),10);this.setByBigInteger(t)},this.setValueHex=function(e){this.hV=e},this.getFreshValueHex=function(){return this.hV},void 0!==e&&(void 0!==e.bigint?this.setByBigInteger(e.bigint):void 0!==e.int?this.setByInteger(e.int):"number"==typeof e?this.setByInteger(e):void 0!==e.hex&&this.setValueHex(e.hex))},He(X.asn1.DERInteger,X.asn1.ASN1Object),X.asn1.DERBitString=function(e){if(void 0!==e&&void 0!==e.obj){var t=X.asn1.ASN1Util.newObject(e.obj);e.hex="00"+t.tohex()}X.asn1.DERBitString.superclass.constructor.call(this),this.hT="03",this.setHexValueIncludingUnusedBits=function(e){this.hTLV=null,this.isModified=!0,this.hV=e},this.setUnusedBitsAndHexValue=function(e,t){if(e<0||7<e)throw"unused bits shall be from 0 to 7: u = "+e;var r="0"+e;this.hTLV=null,this.isModified=!0,this.hV=r+t},this.setByBinaryString=function(e){var t=8-(e=e.replace(/0+$/,"")).length%8;8==t&&(t=0),e+="0000000".substr(0,t);for(var r="",n=0;n<e.length-1;n+=8){var i=e.substr(n,8),s=parseInt(i,2).toString(16);1==s.length&&(s="0"+s),r+=s}this.hTLV=null,this.isModified=!0,this.hV="0"+t+r},this.setByBooleanArray=function(e){for(var t="",r=0;r<e.length;r++)t+=1==e[r]?"1":"0";this.setByBinaryString(t)},this.newFalseArray=function(e){for(var t=new Array(e),r=0;r<e;r++)t[r]=!1;return t},this.getFreshValueHex=function(){return this.hV},void 0!==e&&("string"==typeof e&&e.toLowerCase().match(/^[0-9a-f]+$/)?this.setHexValueIncludingUnusedBits(e):void 0!==e.hex?this.setHexValueIncludingUnusedBits(e.hex):void 0!==e.bin?this.setByBinaryString(e.bin):void 0!==e.array&&this.setByBooleanArray(e.array))},He(X.asn1.DERBitString,X.asn1.ASN1Object),X.asn1.DEROctetString=function(e){if(void 0!==e&&void 0!==e.obj){var t=X.asn1.ASN1Util.newObject(e.obj);e.hex=t.tohex()}X.asn1.DEROctetString.superclass.constructor.call(this,e),this.hT="04"},He(X.asn1.DEROctetString,X.asn1.DERAbstractString),X.asn1.DERNull=function(){X.asn1.DERNull.superclass.constructor.call(this),this.hT="05",this.hTLV="0500"},He(X.asn1.DERNull,X.asn1.ASN1Object),X.asn1.DERObjectIdentifier=function(e){X.asn1.DERObjectIdentifier.superclass.constructor.call(this),this.hT="06",this.setValueHex=function(e){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=e},this.setValueOidString=function(e){var t=De(e);if(null==t)throw new Error("malformed oid string: "+e);this.hTLV=null,this.isModified=!0,this.s=null,this.hV=t},this.setValueName=function(e){var t=X.asn1.x509.OID.name2oid(e);if(""===t)throw new Error("DERObjectIdentifier oidName undefined: "+e);this.setValueOidString(t)},this.setValueNameOrOid=function(e){e.match(/^[0-2].[0-9.]+$/)?this.setValueOidString(e):this.setValueName(e)},this.getFreshValueHex=function(){return this.hV},this.setByParam=function(e){"string"==typeof e?this.setValueNameOrOid(e):void 0!==e.oid?this.setValueNameOrOid(e.oid):void 0!==e.name?this.setValueNameOrOid(e.name):void 0!==e.hex&&this.setValueHex(e.hex)},void 0!==e&&this.setByParam(e)},He(X.asn1.DERObjectIdentifier,X.asn1.ASN1Object),X.asn1.DEREnumerated=function(e){X.asn1.DEREnumerated.superclass.constructor.call(this),this.hT="0a",this.setByBigInteger=function(e){this.hTLV=null,this.isModified=!0,this.hV=X.asn1.ASN1Util.bigIntToMinTwosComplementsHex(e)},this.setByInteger=function(e){var t=new l(String(e),10);this.setByBigInteger(t)},this.setValueHex=function(e){this.hV=e},this.getFreshValueHex=function(){return this.hV},void 0!==e&&(void 0!==e.int?this.setByInteger(e.int):"number"==typeof e?this.setByInteger(e):void 0!==e.hex&&this.setValueHex(e.hex))},He(X.asn1.DEREnumerated,X.asn1.ASN1Object),X.asn1.DERUTF8String=function(e){X.asn1.DERUTF8String.superclass.constructor.call(this,e),this.hT="0c"},He(X.asn1.DERUTF8String,X.asn1.DERAbstractString),X.asn1.DERNumericString=function(e){X.asn1.DERNumericString.superclass.constructor.call(this,e),this.hT="12"},He(X.asn1.DERNumericString,X.asn1.DERAbstractString),X.asn1.DERPrintableString=function(e){X.asn1.DERPrintableString.superclass.constructor.call(this,e),this.hT="13"},He(X.asn1.DERPrintableString,X.asn1.DERAbstractString),X.asn1.DERTeletexString=function(e){X.asn1.DERTeletexString.superclass.constructor.call(this,e),this.hT="14"},He(X.asn1.DERTeletexString,X.asn1.DERAbstractString),X.asn1.DERIA5String=function(e){X.asn1.DERIA5String.superclass.constructor.call(this,e),this.hT="16"},He(X.asn1.DERIA5String,X.asn1.DERAbstractString),X.asn1.DERVisibleString=function(e){X.asn1.DERIA5String.superclass.constructor.call(this,e),this.hT="1a"},He(X.asn1.DERVisibleString,X.asn1.DERAbstractString),X.asn1.DERBMPString=function(e){X.asn1.DERBMPString.superclass.constructor.call(this,e),this.hT="1e"},He(X.asn1.DERBMPString,X.asn1.DERAbstractString),X.asn1.DERUTCTime=function(e){X.asn1.DERUTCTime.superclass.constructor.call(this,e),this.hT="17",this.params=void 0,this.getFreshValueHex=function(){var e=this.params;if(null==this.params&&(e={date:new Date}),"string"==typeof e){if(!e.match(/^[0-9]{12}Z$/)&&!e.match(/^[0-9]{12}\.[0-9]+Z$/))throw new Error("malformed string for UTCTime: "+e);this.hV=ie(e)}else if(null!=e.str)this.hV=ie(e.str);else if(null==e.date&&1==e.millis){var t=new Date;this.hV=ie(this.formatDate(t,"utc",!0))}else null!=e.date&&e.date instanceof Date?this.hV=ie(this.formatDate(e.date,"utc",!0===e.millis)):e instanceof Date&&(this.hV=ie(this.formatDate(e,"utc")));if(null==this.hV)throw new Error("parameter not specified properly for UTCTime");return this.hV},null!=e&&this.setByParam(e)},He(X.asn1.DERUTCTime,X.asn1.DERAbstractTime),X.asn1.DERGeneralizedTime=function(e){X.asn1.DERGeneralizedTime.superclass.constructor.call(this,e),this.hT="18",this.params=e,this.getFreshValueHex=function(){var e=this.params;if(null==this.params&&(e={date:new Date}),"string"==typeof e){if(!e.match(/^[0-9]{14}Z$/)&&!e.match(/^[0-9]{14}\.[0-9]+Z$/))throw new Error("malformed string for GeneralizedTime: "+e);this.hV=ie(e)}else if(null!=e.str)this.hV=ie(e.str);else if(null==e.date&&1==e.millis){var t=new Date;this.hV=ie(this.formatDate(t,"gen",!0))}else null!=e.date&&e.date instanceof Date?this.hV=ie(this.formatDate(e.date,"gen",!0===e.millis)):e instanceof Date&&(this.hV=ie(this.formatDate(e,"gen")));if(null==this.hV)throw new Error("parameter not specified properly for GeneralizedTime");return this.hV},null!=e&&this.setByParam(e)},He(X.asn1.DERGeneralizedTime,X.asn1.DERAbstractTime),X.asn1.DERSequence=function(e){X.asn1.DERSequence.superclass.constructor.call(this,e),this.hT="30",this.getFreshValueHex=function(){for(var e="",t=0;t<this.asn1Array.length;t++)e+=this.asn1Array[t].tohex();return this.hV=e,this.hV}},He(X.asn1.DERSequence,X.asn1.DERAbstractStructured),X.asn1.DERSet=function(e){X.asn1.DERSet.superclass.constructor.call(this,e),this.hT="31",this.sortFlag=!0,this.getFreshValueHex=function(){for(var e=new Array,t=0;t<this.asn1Array.length;t++)e.push(this.asn1Array[t].tohex());return 1==this.sortFlag&&e.sort(),this.hV=e.join(""),this.hV},void 0!==e&&void 0!==e.sortflag&&0==e.sortflag&&(this.sortFlag=!1)},He(X.asn1.DERSet,X.asn1.DERAbstractStructured),X.asn1.DERTaggedObject=function(e){X.asn1.DERTaggedObject.superclass.constructor.call(this);var t=X.asn1,r=ee.getV,n=t.ASN1Util.newObject;this.hT="a0",this.hV="",this.isExplicit=!0,this.asn1Object=null,this.params={tag:"a0",explicit:!0},this.setASN1Object=function(e,t,r){this.params={tag:t,explicit:e,obj:r}},this.getFreshValueHex=function(){var e=this.params;if(null==e.explicit&&(e.explicit=!0),null!=e.tage&&(e.tag=e.tage,e.explicit=!0),null!=e.tagi&&(e.tag=e.tagi,e.explicit=!1),null!=e.str)this.hV=ue(e.str);else if(null!=e.hex)this.hV=e.hex;else{if(null==e.obj)throw new Error("str, hex nor obj not specified");var i;e.obj instanceof t.ASN1Object?i=e.obj.tohex():"object"==typeof e.obj&&(i=n(e.obj).tohex()),this.hV=e.explicit?i:r(i,0)}return null==e.tag&&(e.tag="a0"),this.hT=e.tag,this.hTLV=null,this.isModified=!0,this.hV},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},He(X.asn1.DERTaggedObject,X.asn1.ASN1Object);var X,Z,Y,ee=new function(){};function te(e){for(var t=new Array,r=0;r<e.length;r++)t[r]=e.charCodeAt(r);return t}function re(e){for(var t="",r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return t}function ne(e){for(var t="",r=0;r<e.length;r++){var n=e[r].toString(16);1==n.length&&(n="0"+n),t+=n}return t}function ie(e){return ne(te(e))}function se(e){return(e=(e=e.replace(/\=/g,"")).replace(/\+/g,"-")).replace(/\//g,"_")}function oe(e){return e.length%4==2?e+="==":e.length%4==3&&(e+="="),(e=e.replace(/-/g,"+")).replace(/_/g,"/")}function ae(e){return e.length%2==1&&(e="0"+e),se(a(e))}function ce(e){return c(oe(e))}function ue(e){return we(Me(e)).toLowerCase()}function le(e){try{return decodeURIComponent(Ce(e))}catch(e){return null}}function he(e){return le(function(e){for(var t=e.match(/.{1,2}/g),r=[],n=0;n<t.length;n++){var i=parseInt(t[n],16);161<=i&&i<=191?(r.push("c2"),r.push(t[n])):192<=i&&i<=255?(r.push("c3"),r.push((i-64).toString(16))):r.push(t[n])}return r.join("")}(e))}function de(e){for(var t="",r=0;r<e.length-1;r+=2)t+=String.fromCharCode(parseInt(e.substr(r,2),16));return t}function me(e){for(var t="",r=0;r<e.length;r++)t+=("0"+e.charCodeAt(r).toString(16)).slice(-2);return t}function pe(e){return a(e)}function fe(e){return pe(e).replace(/(.{64})/g,"$1\r\n").replace(/\r\n$/,"")}function ge(e){return c(e.replace(/[^0-9A-Za-z\/+=]*/g,""))}function ye(e,t){return"-----BEGIN "+t+"-----\r\n"+fe(e)+"\r\n-----END "+t+"-----\r\n"}function ve(e,t){if(-1==e.indexOf("-----BEGIN "))throw"can't find PEM header: "+t;return ge(e=void 0!==t?(e=e.replace(new RegExp("^[^]*-----BEGIN "+t+"-----"),"")).replace(new RegExp("-----END "+t+"-----[^]*$"),""):(e=e.replace(/^[^]*-----BEGIN [^-]+-----/,"")).replace(/-----END [^-]+-----[^]*$/,""))}function be(e){var t,r,n,i,s,o,a,c,u,l,h;if(h=e.match(/^(\d{2}|\d{4})(\d\d)(\d\d)(\d\d)(\d\d)(\d\d)(|\.\d+)Z$/))return c=h[1],t=parseInt(c),2===c.length&&(50<=t&&t<100?t=1900+t:0<=t&&t<50&&(t=2e3+t)),r=parseInt(h[2])-1,n=parseInt(h[3]),i=parseInt(h[4]),s=parseInt(h[5]),o=parseInt(h[6]),a=0,""!==(u=h[7])&&(l=(u.substr(1)+"00").substr(0,3),a=parseInt(l)),Date.UTC(t,r,n,i,s,o,a);throw new Error("unsupported zulu format: "+e)}function Se(e){return Math.round(be(e)/1e3)}function we(e){return e.replace(/%/g,"")}function Ce(e){return e.replace(/(..)/g,"%$1")}function Ee(e){var t="malformed IPv6 address";if(!e.match(/^[0-9A-Fa-f:]+$/))throw t;var r=(e=e.toLowerCase()).split(":").length-1;if(r<2)throw t;var n=":".repeat(7-r+2),i=(e=e.replace("::",n)).split(":");if(8!=i.length)throw t;for(var s=0;s<8;s++)i[s]=("0000"+i[s]).slice(-4);return i.join("")}function Ie(e){if(!e.match(/^[0-9A-Fa-f]{32}$/))throw new Error("malformed IPv6 address: "+e);var t=(e=e.toLowerCase()).match(/.{1,4}/g),r=(e=":"+(t=(t=t.map((function(e){return e.replace(/^0+/,"")}))).map((function(e){return""==e?"0":e}))).join(":")+":").match(/:(0:){2,}/g);if(null==r)return e.slice(1,-1);var n=r.sort().slice(-1)[0];return"::"!=(e=e.replace(n.substr(0,n.length-1),":")).substr(0,2)&&(e=e.substr(1)),"::"!=e.substr(-2,2)&&(e=e.substr(0,e.length-1)),e}function Te(e){var t=new Error("malformed hex value");if(!e.match(/^([0-9A-Fa-f][0-9A-Fa-f]){1,}$/))throw t;if(8==e.length)try{return parseInt(e.substr(0,2),16)+"."+parseInt(e.substr(2,2),16)+"."+parseInt(e.substr(4,2),16)+"."+parseInt(e.substr(6,2),16)}catch(e){throw t}else{if(16!=e.length){if(32==e.length)return Ie(e);if(64==e.length){try{return Ie(e.substr(0,32))+"/"+Ne(e.substr(32))}catch(e){throw t}return}return e}try{return Te(e.substr(0,8))+"/"+Ne(e.substr(8))}catch(e){throw t}}}function Ne(e){var t,r=new Error("malformed mask");try{t=new l(e,16).toString(2)}catch(e){throw r}if(!t.match(/^1*0*$/))throw r;return t.replace(/0+$/,"").length}function Pe(e){var t=new Error("malformed IP address");if(!(e=e.toLowerCase(e)).match(/^[0-9a-f.:/]+$/))throw t;if(!e.match(/^[0-9.]+$/)){var r;if(e.match(/^[0-9.]+\/[0-9]+$/))return Pe((r=e.split("/"))[0])+xe(parseInt(r[1]),32);if(e.match(/^[0-9a-f:]+$/)&&-1!==e.indexOf(":"))return Ee(e);if(e.match(/^[0-9a-f:]+\/[0-9]+$/)&&-1!==e.indexOf(":"))return Ee((r=e.split("/"))[0])+xe(parseInt(r[1]),128);throw t}var n=e.split(".");if(4!==n.length)throw t;var i="";try{for(var s=0;s<4;s++)i+=("0"+parseInt(n[s]).toString(16)).slice(-2);return i}catch(e){throw t}}function xe(e,t){return 32==t&&0==e?"00000000":128==t&&0==e?"00000000000000000000000000000000":new l(Array(e+1).join("1")+Array(t-e+1).join("0"),2).toString(16)}function Oe(e){return e.match(/.{4}/g).map((function(e){var t=parseInt(e.substr(0,2),16),r=parseInt(e.substr(2),16);if(0==t&r<128)return String.fromCharCode(r);if(t<8){var n=128|63&r;return le((192|(7&t)<<3|(192&r)>>6).toString(16)+n.toString(16))}n=128|(15&t)<<2|(192&r)>>6;var i=128|63&r;return le((224|(240&t)>>4).toString(16)+n.toString(16)+i.toString(16))})).join("")}function Me(e){for(var t=encodeURIComponent(e),r="",n=0;n<t.length;n++)"%"==t[n]?(r+=t.substr(n,3),n+=2):r=r+"%"+ie(t[n]);return r}function ke(e){return!(e.length%2!=0||!e.match(/^[0-9a-f]+$/)&&!e.match(/^[0-9A-F]+$/))}function Le(e){return!!e.match(/^[0-9A-Za-z-_.]+$/)}function Re(e){return e.length%2==1?"0"+e:e.substr(0,1)>"7"?"00"+e:e}function De(e){var t=function(e){var t=e.toString(16);return 1==t.length&&(t="0"+t),t},r=function(e){var r="",n=parseInt(e,10).toString(2),i=7-n.length%7;7==i&&(i=0);for(var s="",o=0;o<i;o++)s+="0";for(n=s+n,o=0;o<n.length-1;o+=7){var a=n.substr(o,7);o!=n.length-7&&(a="1"+a),r+=t(parseInt(a,2))}return r};try{if(!e.match(/^[0-9.]+$/))return null;var n="",i=e.split("."),s=40*parseInt(i[0],10)+parseInt(i[1],10);n+=t(s),i.splice(0,2);for(var o=0;o<i.length;o++)n+=r(i[o]);return n}catch(e){return null}}function Fe(e){if(!ke(e))return null;try{var t=[],r=e.substr(0,2),n=parseInt(r,16);t[0]=new String(Math.floor(n/40)),t[1]=new String(n%40);for(var i=e.substr(2),s=[],o=0;o<i.length/2;o++)s.push(parseInt(i.substr(2*o,2),16));var a=[],c="";for(o=0;o<s.length;o++)128&s[o]?c+=Ae((127&s[o]).toString(2),7):(c+=Ae((127&s[o]).toString(2),7),a.push(new String(parseInt(c,2))),c="");var u=t.join(".");return a.length>0&&(u=u+"."+a.join(".")),u}catch(e){return null}}ee.getLblen=function(e,t){if("8"!=e.substr(t+2,1))return 1;var r=parseInt(e.substr(t+3,1));return 0==r?-1:0<r&&r<10?r+1:-2},ee.getL=function(e,t){var r=ee.getLblen(e,t);return r<1?"":e.substr(t+2,2*r)},ee.getVblen=function(e,t){var r;return""==(r=ee.getL(e,t))?-1:("8"===r.substr(0,1)?new l(r.substr(2),16):new l(r,16)).intValue()},ee.getVidx=function(e,t){var r=ee.getLblen(e,t);return r<0?r:t+2*(r+1)},ee.getV=function(e,t){var r=ee.getVidx(e,t),n=ee.getVblen(e,t);return e.substr(r,2*n)},ee.getTLV=function(e,t){return e.substr(t,2)+ee.getL(e,t)+ee.getV(e,t)},ee.getTLVblen=function(e,t){return 2+2*ee.getLblen(e,t)+2*ee.getVblen(e,t)},ee.getNextSiblingIdx=function(e,t){return ee.getVidx(e,t)+2*ee.getVblen(e,t)},ee.getChildIdx=function(e,t){var r,n,i,s=ee,o=[];r=s.getVidx(e,t),n=2*s.getVblen(e,t),"03"==e.substr(t,2)&&(r+=2,n-=2),i=0;for(var a=r;i<=n;){var c=s.getTLVblen(e,a);if((i+=c)<=n&&o.push(a),a+=c,i>=n)break}return o},ee.getNthChildIdx=function(e,t,r){return ee.getChildIdx(e,t)[r]},ee.getIdxbyList=function(e,t,r,n){var i,s,o=ee;return 0==r.length?void 0!==n&&e.substr(t,2)!==n?-1:t:(i=r.shift())>=(s=o.getChildIdx(e,t)).length?-1:o.getIdxbyList(e,s[i],r,n)},ee.getIdxbyListEx=function(e,t,r,n){var i,s,o=ee;if(0==r.length)return void 0!==n&&e.substr(t,2)!==n?-1:t;i=r.shift(),s=o.getChildIdx(e,t);for(var a=0,c=0;c<s.length;c++){var u=e.substr(s[c],2);if("number"==typeof i&&!o.isContextTag(u)&&a==i||"string"==typeof i&&o.isContextTag(u,i))return o.getIdxbyListEx(e,s[c],r,n);o.isContextTag(u)||a++}return-1},ee.getTLVbyList=function(e,t,r,n){var i=ee,s=i.getIdxbyList(e,t,r,n);return-1==s||s>=e.length?null:i.getTLV(e,s)},ee.getTLVbyListEx=function(e,t,r,n){var i=ee,s=i.getIdxbyListEx(e,t,r,n);return-1==s?null:i.getTLV(e,s)},ee.getVbyList=function(e,t,r,n,i){var s,o,a=ee;return-1==(s=a.getIdxbyList(e,t,r,n))||s>=e.length?null:(o=a.getV(e,s),!0===i&&(o=o.substr(2)),o)},ee.getVbyListEx=function(e,t,r,n,i){var s,o,a=ee;return-1==(s=a.getIdxbyListEx(e,t,r,n))?null:(o=a.getV(e,s),"03"==e.substr(s,2)&&!1!==i&&(o=o.substr(2)),o)},ee.getInt=function(e,t,r){null==r&&(r=-1);try{var n=e.substr(t,2);if("02"!=n&&"03"!=n)return r;var i=ee.getV(e,t);return"02"==n?parseInt(i,16):je(i)}catch(e){return r}},ee.getOID=function(e,t,r){null==r&&(r=null);try{return"06"!=e.substr(t,2)?r:Fe(ee.getV(e,t))}catch(e){return r}},ee.getOIDName=function(e,t,r){null==r&&(r=null);try{var n=ee.getOID(e,t,r);if(n==r)return r;var i=X.asn1.x509.OID.oid2name(n);return""==i?n:i}catch(e){return r}},ee.getString=function(e,t,r){null==r&&(r=null);try{return de(ee.getV(e,t))}catch(e){return r}},ee.hextooidstr=function(e){var t=function(e,t){return e.length>=t?e:new Array(t-e.length+1).join("0")+e},r=[],n=e.substr(0,2),i=parseInt(n,16);r[0]=new String(Math.floor(i/40)),r[1]=new String(i%40);for(var s=e.substr(2),o=[],a=0;a<s.length/2;a++)o.push(parseInt(s.substr(2*a,2),16));var c=[],u="";for(a=0;a<o.length;a++)128&o[a]?u+=t((127&o[a]).toString(2),7):(u+=t((127&o[a]).toString(2),7),c.push(new String(parseInt(u,2))),u="");var l=r.join(".");return c.length>0&&(l=l+"."+c.join(".")),l},ee.dump=function(e,t,r,n){var i=ee,s=i.getV,o=i.dump,a=i.getChildIdx,c=e;e instanceof X.asn1.ASN1Object&&(c=e.tohex());var u=function(e,t){return e.length<=2*t?e:e.substr(0,t)+"..(total "+e.length/2+"bytes).."+e.substr(e.length-t,t)};void 0===t&&(t={ommit_long_octet:32}),void 0===r&&(r=0),void 0===n&&(n="");var l,h=t.ommit_long_octet;if("01"==(l=c.substr(r,2)))return"00"==(d=s(c,r))?n+"BOOLEAN FALSE\n":n+"BOOLEAN TRUE\n";if("02"==l)return n+"INTEGER "+u(d=s(c,r),h)+"\n";if("03"==l){var d=s(c,r);return i.isASN1HEX(d.substr(2))?(w=n+"BITSTRING, encapsulates\n")+o(d.substr(2),t,0,n+"  "):n+"BITSTRING "+u(d,h)+"\n"}if("04"==l)return d=s(c,r),i.isASN1HEX(d)?(w=n+"OCTETSTRING, encapsulates\n")+o(d,t,0,n+"  "):n+"OCTETSTRING "+u(d,h)+"\n";if("05"==l)return n+"NULL\n";if("06"==l){var m=s(c,r),p=X.asn1.ASN1Util.oidHexToInt(m),f=X.asn1.x509.OID.oid2name(p),g=p.replace(/\./g," ");return""!=f?n+"ObjectIdentifier "+f+" ("+g+")\n":n+"ObjectIdentifier ("+g+")\n"}if("0a"==l)return n+"ENUMERATED "+parseInt(s(c,r))+"\n";if("0c"==l)return n+"UTF8String '"+le(s(c,r))+"'\n";if("13"==l)return n+"PrintableString '"+le(s(c,r))+"'\n";if("14"==l)return n+"TeletexString '"+le(s(c,r))+"'\n";if("16"==l)return n+"IA5String '"+le(s(c,r))+"'\n";if("17"==l)return n+"UTCTime "+le(s(c,r))+"\n";if("18"==l)return n+"GeneralizedTime "+le(s(c,r))+"\n";if("1a"==l)return n+"VisualString '"+le(s(c,r))+"'\n";if("1e"==l)return n+"BMPString '"+Oe(s(c,r))+"'\n";if("30"==l){if("3000"==c.substr(r,4))return n+"SEQUENCE {}\n";w=n+"SEQUENCE\n";var y=t;if((2==(S=a(c,r)).length||3==S.length)&&"06"==c.substr(S[0],2)&&"04"==c.substr(S[S.length-1],2)){f=i.oidname(s(c,S[0]));var v=JSON.parse(JSON.stringify(t));v.x509ExtName=f,y=v}for(var b=0;b<S.length;b++)w+=o(c,y,S[b],n+"  ");return w}if("31"==l){w=n+"SET\n";var S=a(c,r);for(b=0;b<S.length;b++)w+=o(c,t,S[b],n+"  ");return w}if(0!=(128&(l=parseInt(l,16)))){var w,C=31&l;if(0!=(32&l)){for(w=n+"["+C+"]\n",S=a(c,r),b=0;b<S.length;b++)w+=o(c,t,S[b],n+"  ");return w}return d=s(c,r),ee.isASN1HEX(d)?(w=n+"["+C+"]\n")+o(d,t,0,n+"  "):(("68747470"==d.substr(0,8)||"subjectAltName"===t.x509ExtName&&2==C)&&(d=le(d)),n+"["+C+"] "+d+"\n")}return n+"UNKNOWN("+l+") "+s(c,r)+"\n"},ee.parse=function(e){var t=ee.parse,r=ee.isASN1HEX,n=ee.getV,i=ee.getTLV,s=ee.getChildIdx,o=X.asn1,a=o.ASN1Util.oidHexToInt,c=o.x509.OID.oid2name,u=le,l=Oe,h=he,d={"0c":"utf8str",12:"numstr",13:"prnstr",14:"telstr",16:"ia5str",17:"utctime",18:"gentime","1a":"visstr","1e":"bmpstr",30:"seq",31:"set"},m=e.substr(0,2),p={},f=n(e,0);if("01"==m)return"0101ff"==e?{bool:!0}:{bool:!1};if("02"==m)return{int:{hex:f}};if("03"==m)try{if("00"!=f.substr(0,2))throw"not encap";var g=f.substr(2);if(!r(g))throw"not encap";return{bitstr:{obj:t(g)}}}catch(e){var y=null;return f.length<=10&&(y=Be(f)),null==y?{bitstr:{hex:f}}:{bitstr:{bin:y}}}else if("04"==m)try{if(!r(f))throw"not encap";return{octstr:{obj:t(f)}}}catch(e){return{octstr:{hex:f}}}else{if("05"==m)return{null:""};if("06"==m){var v=a(f),b=c(v);return""==b?{oid:v}:{oid:b}}if("0a"==m)return f.length>4?{enum:{hex:f}}:{enum:parseInt(f,16)};if("30"==m||"31"==m)return p[d[m]]=function(e){for(var r=[],n=s(e,0),o=0;o<n.length;o++){var a=i(e,n[o]),c=t(a);r.push(c)}return r}(e),p;if("14"==m){var S=h(f);return p[d[m]]={str:S},p}if("1e"==m)return S=l(f),p[d[m]]={str:S},p;if(-1!=":0c:12:13:16:17:18:1a:".indexOf(m))return S=u(f),p[d[m]]={str:S},p;if(m.match(/^8[0-9]$/))return null==(S=u(f))|""==S||null!=S.match(/[\x00-\x1F\x7F-\x9F]/)||null!=S.match(/[\u0000-\u001F\u0080–\u009F]/)?{tag:{tag:m,explicit:!1,hex:f}}:{tag:{tag:m,explicit:!1,str:S}};if(!m.match(/^a[0-9]$/)){var w=new X.asn1.ASN1Object;return w.hV=f,{asn1:{tlv:m+w.getLengthHexFromValue()+f}}}try{if(!r(f))throw new Error("not encap");return{tag:{tag:m,explicit:!0,obj:t(f)}}}catch(e){return{tag:{tag:m,explicit:!0,hex:f}}}}},ee.isContextTag=function(e,t){var r,n;e=e.toLowerCase();try{r=parseInt(e,16)}catch(e){return-1}if(void 0===t)return 128==(192&r);try{return null!=t.match(/^\[[0-9]+\]$/)&&!((n=parseInt(t.substr(1,t.length-1),10))>31)&&128==(192&r)&&(31&r)==n}catch(e){return!1}},ee.isASN1HEX=function(e){var t=ee;if(e.length%2==1)return!1;var r=t.getVblen(e,0),n=e.substr(0,2),i=t.getL(e,0);return e.length-n.length-i.length==2*r},ee.checkStrictDER=function(e,t,r,n,i){var s=ee;if(void 0===r){if("string"!=typeof e)throw new Error("not hex string");if(e=e.toLowerCase(),!X.lang.String.isHex(e))throw new Error("not hex string");r=e.length,i=(n=e.length/2)<128?1:Math.ceil(n.toString(16))+1}if(s.getL(e,t).length>2*i)throw new Error("L of TLV too long: idx="+t);var o=s.getVblen(e,t);if(o>n)throw new Error("value of L too long than hex: idx="+t);var a=s.getTLV(e,t),c=a.length-2-s.getL(e,t).length;if(c!==2*o)throw new Error("V string length and L's value not the same:"+c+"/"+2*o);if(0===t&&e.length!=a.length)throw new Error("total length and TLV length unmatch:"+e.length+"!="+a.length);var u=e.substr(t,2);if("02"===u){var l=s.getVidx(e,t);if("00"==e.substr(l,2)&&e.charCodeAt(l+2)<56)throw new Error("not least zeros for DER INTEGER")}if(32&parseInt(u,16)){for(var h=s.getVblen(e,t),d=0,m=s.getChildIdx(e,t),p=0;p<m.length;p++)d+=s.getTLV(e,m[p]).length,s.checkStrictDER(e,m[p],r,n,i);if(2*h!=d)throw new Error("sum of children's TLV length and L unmatch: "+2*h+"!="+d)}},ee.oidname=function(e){var t=X.asn1;X.lang.String.isHex(e)&&(e=t.ASN1Util.oidHexToInt(e));var r=t.x509.OID.oid2name(e);return""===r&&(r=e),r},void 0!==X&&X||(X={}),void 0!==X.asn1&&X.asn1||(X.asn1={}),void 0!==X.asn1.x509&&X.asn1.x509||(X.asn1.x509={}),X.asn1.x509.Certificate=function(e){X.asn1.x509.Certificate.superclass.constructor.call(this);var t=X.asn1,r=t.DERBitString,n=t.DERSequence,i=t.x509,s=i.TBSCertificate,o=i.AlgorithmIdentifier;this.params=void 0,this.setByParam=function(e){this.params=e},this.sign=function(){var e=this.params,t=e.sigalg;null!=e.sigalg.name&&(t=e.sigalg.name);var r=e.tbsobj.tohex(),n=new X.crypto.Signature({alg:t});n.init(e.cakey),n.updateHex(r),e.sighex=n.sign()},this.getPEM=function(){return ye(this.tohex(),"CERTIFICATE")},this.tohex=function(){var e=this.params;if(null!=e.tbsobj&&null!=e.tbsobj||(e.tbsobj=new s(e)),null==e.sighex&&null!=e.cakey&&this.sign(),null==e.sighex)throw new Error("sighex or cakey parameter not defined");var t=[];return t.push(e.tbsobj),t.push(new o({name:e.sigalg})),t.push(new r({hex:"00"+e.sighex})),new n({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&(this.params=e)},He(X.asn1.x509.Certificate,X.asn1.ASN1Object),X.asn1.x509.TBSCertificate=function(e){X.asn1.x509.TBSCertificate.superclass.constructor.call(this);var t=X.asn1,r=t.x509,n=t.DERTaggedObject,i=t.DERInteger,s=t.DERSequence,o=r.AlgorithmIdentifier,a=r.Time,c=r.X500Name,u=r.Extensions,l=r.SubjectPublicKeyInfo;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=[],t=this.params;if(null!=t.version||1!=t.version){var r=2;null!=t.version&&(r=t.version-1);var h=new n({obj:new i({int:r})});e.push(h)}return e.push(new i(t.serial)),e.push(new o({name:t.sigalg})),e.push(new c(t.issuer)),e.push(new s({array:[new a(t.notbefore),new a(t.notafter)]})),e.push(new c(t.subject)),e.push(new l(Ve.getKey(t.sbjpubkey))),void 0!==t.ext&&t.ext.length>0&&e.push(new n({tag:"a3",obj:new u(t.ext)})),new X.asn1.DERSequence({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},He(X.asn1.x509.TBSCertificate,X.asn1.ASN1Object),X.asn1.x509.Extensions=function(e){X.asn1.x509.Extensions.superclass.constructor.call(this);var t=X.asn1,r=t.DERSequence,n=t.x509;this.aParam=[],this.setByParam=function(e){this.aParam=e},this.tohex=function(){for(var e=[],t=0;t<this.aParam.length;t++){var i=this.aParam[t],s=i.extname,o=null;if(null!=i.extn)o=new n.PrivateExtension(i);else if("subjectKeyIdentifier"==s)o=new n.SubjectKeyIdentifier(i);else if("keyUsage"==s)o=new n.KeyUsage(i);else if("subjectAltName"==s)o=new n.SubjectAltName(i);else if("issuerAltName"==s)o=new n.IssuerAltName(i);else if("basicConstraints"==s)o=new n.BasicConstraints(i);else if("nameConstraints"==s)o=new n.NameConstraints(i);else if("cRLDistributionPoints"==s)o=new n.CRLDistributionPoints(i);else if("certificatePolicies"==s)o=new n.CertificatePolicies(i);else if("authorityKeyIdentifier"==s)o=new n.AuthorityKeyIdentifier(i);else if("extKeyUsage"==s)o=new n.ExtKeyUsage(i);else if("authorityInfoAccess"==s)o=new n.AuthorityInfoAccess(i);else if("cRLNumber"==s)o=new n.CRLNumber(i);else if("cRLReason"==s)o=new n.CRLReason(i);else if("ocspNonce"==s)o=new n.OCSPNonce(i);else if("ocspNoCheck"==s)o=new n.OCSPNoCheck(i);else if("adobeTimeStamp"==s)o=new n.AdobeTimeStamp(i);else{if("subjectDirectoryAttributes"!=s)throw new Error("extension not supported:"+JSON.stringify(i));o=new n.SubjectDirectoryAttributes(i)}null!=o&&e.push(o)}return new r({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},He(X.asn1.x509.Extensions,X.asn1.ASN1Object),X.asn1.x509.Extension=function(e){X.asn1.x509.Extension.superclass.constructor.call(this);var t=X.asn1,r=t.DERObjectIdentifier,n=t.DEROctetString,i=t.DERBoolean,s=t.DERSequence;this.tohex=function(){var e=new r({oid:this.oid}),t=new n({hex:this.getExtnValueHex()}),o=new Array;return o.push(e),this.critical&&o.push(new i),o.push(t),new s({array:o}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.critical=!1,void 0!==e&&void 0!==e.critical&&(this.critical=e.critical)},He(X.asn1.x509.Extension,X.asn1.ASN1Object),X.asn1.x509.KeyUsage=function(e){X.asn1.x509.KeyUsage.superclass.constructor.call(this,e);var t=Error,r={digitalSignature:0,nonRepudiation:1,keyEncipherment:2,dataEncipherment:3,keyAgreement:4,keyCertSign:5,cRLSign:6,encipherOnly:7,decipherOnly:8};this.getExtnValueHex=function(){var e=this.getBinValue();return this.asn1ExtnValue=new X.asn1.DERBitString({bin:e}),this.asn1ExtnValue.tohex()},this.getBinValue=function(){var e=this.params;if("object"!=typeof e||"object"!=typeof e.names&&"string"!=typeof e.bin)throw new t("parameter not yet set");if(null!=e.names)return _e(e.names,r);if(null!=e.bin)return e.bin;throw new t("parameter not set properly")},this.oid="2.5.29.15",void 0!==e&&(this.params=e)},He(X.asn1.x509.KeyUsage,X.asn1.x509.Extension),X.asn1.x509.BasicConstraints=function(e){X.asn1.x509.BasicConstraints.superclass.constructor.call(this,e);var t=X.asn1,r=t.DERBoolean,n=t.DERInteger,i=t.DERSequence;this.getExtnValueHex=function(){var e=new Array;this.cA&&e.push(new r),this.pathLen>-1&&e.push(new n({int:this.pathLen}));var t=new i({array:e});return this.asn1ExtnValue=t,this.asn1ExtnValue.tohex()},this.oid="2.5.29.19",this.cA=!1,this.pathLen=-1,void 0!==e&&(void 0!==e.cA&&(this.cA=e.cA),void 0!==e.pathLen&&(this.pathLen=e.pathLen))},He(X.asn1.x509.BasicConstraints,X.asn1.x509.Extension),X.asn1.x509.CRLDistributionPoints=function(e){X.asn1.x509.CRLDistributionPoints.superclass.constructor.call(this,e);var t=X.asn1,r=t.x509;this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.setByDPArray=function(e){for(var n=[],i=0;i<e.length;i++)if(e[i]instanceof X.asn1.ASN1Object)n.push(e[i]);else{var s=new r.DistributionPoint(e[i]);n.push(s)}this.asn1ExtnValue=new t.DERSequence({array:n})},this.setByOneURI=function(e){var t=new r.DistributionPoint({fulluri:e});this.setByDPArray([t])},this.oid="2.5.29.31",void 0!==e&&(void 0!==e.array?this.setByDPArray(e.array):void 0!==e.uri&&this.setByOneURI(e.uri))},He(X.asn1.x509.CRLDistributionPoints,X.asn1.x509.Extension),X.asn1.x509.DistributionPoint=function(e){X.asn1.x509.DistributionPoint.superclass.constructor.call(this);var t=X.asn1,r=t.x509.DistributionPointName;this.tohex=function(){var e=new t.DERSequence;if(null!=this.asn1DP){var r=new t.DERTaggedObject({explicit:!0,tag:"a0",obj:this.asn1DP});e.appendASN1Object(r)}return this.hTLV=e.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(void 0!==e.dpobj?this.asn1DP=e.dpobj:void 0!==e.dpname?this.asn1DP=new r(e.dpname):void 0!==e.fulluri&&(this.asn1DP=new r({full:[{uri:e.fulluri}]})))},He(X.asn1.x509.DistributionPoint,X.asn1.ASN1Object),X.asn1.x509.DistributionPointName=function(e){X.asn1.x509.DistributionPointName.superclass.constructor.call(this);var t=X.asn1,r=t.DERTaggedObject;if(this.tohex=function(){if("full"!=this.type)throw new Error("currently type shall be 'full': "+this.type);return this.asn1Obj=new r({explicit:!1,tag:this.tag,obj:this.asn1V}),this.hTLV=this.asn1Obj.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e)if(t.x509.GeneralNames.prototype.isPrototypeOf(e))this.type="full",this.tag="a0",this.asn1V=e;else{if(void 0===e.full)throw new Error("This class supports GeneralNames only as argument");this.type="full",this.tag="a0",this.asn1V=new t.x509.GeneralNames(e.full)}},He(X.asn1.x509.DistributionPointName,X.asn1.ASN1Object),X.asn1.x509.CertificatePolicies=function(e){X.asn1.x509.CertificatePolicies.superclass.constructor.call(this,e);var t=X.asn1,r=t.DERSequence,n=t.x509.PolicyInformation;this.params=null,this.getExtnValueHex=function(){for(var e=[],t=0;t<this.params.array.length;t++)e.push(new n(this.params.array[t]));var i=new r({array:e});return this.asn1ExtnValue=i,this.asn1ExtnValue.tohex()},this.oid="2.5.29.32",void 0!==e&&(this.params=e)},He(X.asn1.x509.CertificatePolicies,X.asn1.x509.Extension),X.asn1.x509.PolicyInformation=function(e){X.asn1.x509.PolicyInformation.superclass.constructor.call(this,e);var t=X.asn1,r=t.DERSequence,n=t.DERObjectIdentifier,i=t.x509.PolicyQualifierInfo;this.params=null,this.tohex=function(){if(void 0===this.params.policyoid&&void 0===this.params.array)throw new Error("parameter oid and array missing");var e=[new n(this.params.policyoid)];if(void 0!==this.params.array){for(var t=[],s=0;s<this.params.array.length;s++)t.push(new i(this.params.array[s]));t.length>0&&e.push(new r({array:t}))}return new r({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},He(X.asn1.x509.PolicyInformation,X.asn1.ASN1Object),X.asn1.x509.PolicyQualifierInfo=function(e){X.asn1.x509.PolicyQualifierInfo.superclass.constructor.call(this,e);var t=X.asn1,r=t.DERSequence,n=t.DERIA5String,i=t.DERObjectIdentifier,s=t.x509.UserNotice;this.params=null,this.tohex=function(){return void 0!==this.params.cps?new r({array:[new i({oid:"1.3.6.1.5.5.7.2.1"}),new n({str:this.params.cps})]}).tohex():null!=this.params.unotice?new r({array:[new i({oid:"1.3.6.1.5.5.7.2.2"}),new s(this.params.unotice)]}).tohex():void 0},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},He(X.asn1.x509.PolicyQualifierInfo,X.asn1.ASN1Object),X.asn1.x509.UserNotice=function(e){X.asn1.x509.UserNotice.superclass.constructor.call(this,e);var t=X.asn1.DERSequence,r=X.asn1.x509.DisplayText,n=X.asn1.x509.NoticeReference;this.params=null,this.tohex=function(){var e=[];return void 0!==this.params.noticeref&&e.push(new n(this.params.noticeref)),void 0!==this.params.exptext&&e.push(new r(this.params.exptext)),new t({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},He(X.asn1.x509.UserNotice,X.asn1.ASN1Object),X.asn1.x509.NoticeReference=function(e){X.asn1.x509.NoticeReference.superclass.constructor.call(this,e);var t=X.asn1.DERSequence,r=X.asn1.DERInteger,n=X.asn1.x509.DisplayText;this.params=null,this.tohex=function(){var e=[];if(void 0!==this.params.org&&e.push(new n(this.params.org)),void 0!==this.params.noticenum){for(var i=[],s=this.params.noticenum,o=0;o<s.length;o++)i.push(new r(s[o]));e.push(new t({array:i}))}if(0==e.length)throw new Error("parameter is empty");return new t({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},He(X.asn1.x509.NoticeReference,X.asn1.ASN1Object),X.asn1.x509.DisplayText=function(e){X.asn1.x509.DisplayText.superclass.constructor.call(this,e),this.hT="0c",void 0!==e&&("ia5"===e.type?this.hT="16":"vis"===e.type?this.hT="1a":"bmp"===e.type&&(this.hT="1e"))},He(X.asn1.x509.DisplayText,X.asn1.DERAbstractString),X.asn1.x509.NameConstraints=function(e){X.asn1.x509.NameConstraints.superclass.constructor.call(this,e);var t=X.asn1,r=t.ASN1Util.newObject,n=t.x509.GeneralSubtree;this.params=null,this.getExtnValueHex=function(){var e=this.params,t=[];if(null!=e.permit&&null!=e.permit.length){for(var i=[],s=0;s<e.permit.length;s++)i.push(new n(e.permit[s]));t.push({tag:{tagi:"a0",obj:{seq:i}}})}if(null!=e.exclude&&null!=e.exclude.length){var o=[];for(s=0;s<e.exclude.length;s++)o.push(new n(e.exclude[s]));t.push({tag:{tagi:"a1",obj:{seq:o}}})}return this.asn1ExtnValue=r({seq:t}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.30",void 0!==e&&(this.params=e)},He(X.asn1.x509.NameConstraints,X.asn1.x509.Extension),X.asn1.x509.GeneralSubtree=function(e){X.asn1.x509.GeneralSubtree.superclass.constructor.call(this);var t=X.asn1,r=t.x509.GeneralName,n=t.ASN1Util.newObject;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params,t=[new r(e)];return null!=e.min&&t.push({tag:{tagi:"80",obj:{int:e.min}}}),null!=e.max&&t.push({tag:{tagi:"81",obj:{int:e.max}}}),n({seq:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},He(X.asn1.x509.GeneralSubtree,X.asn1.ASN1Object),X.asn1.x509.ExtKeyUsage=function(e){X.asn1.x509.ExtKeyUsage.superclass.constructor.call(this,e);var t=X.asn1;this.setPurposeArray=function(e){this.asn1ExtnValue=new t.DERSequence;for(var r=0;r<e.length;r++){var n=new t.DERObjectIdentifier(e[r]);this.asn1ExtnValue.appendASN1Object(n)}},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="2.5.29.37",void 0!==e&&void 0!==e.array&&this.setPurposeArray(e.array)},He(X.asn1.x509.ExtKeyUsage,X.asn1.x509.Extension),X.asn1.x509.AuthorityKeyIdentifier=function(e){X.asn1.x509.AuthorityKeyIdentifier.superclass.constructor.call(this,e);var t=X.asn1,r=t.DERTaggedObject,n=t.x509.GeneralNames;this.asn1KID=null,this.asn1CertIssuer=null,this.asn1CertSN=null,this.getExtnValueHex=function(){var e=new Array;this.asn1KID&&e.push(new r({explicit:!1,tag:"80",obj:this.asn1KID})),this.asn1CertIssuer&&e.push(new r({explicit:!1,tag:"a1",obj:new n([{dn:this.asn1CertIssuer}])})),this.asn1CertSN&&e.push(new r({explicit:!1,tag:"82",obj:this.asn1CertSN}));var i=new t.DERSequence({array:e});return this.asn1ExtnValue=i,this.asn1ExtnValue.tohex()},this.setKIDByParam=function(e){if(void 0!==e.str||void 0!==e.hex)this.asn1KID=new X.asn1.DEROctetString(e);else if("object"==typeof e&&X.crypto.Util.isKey(e)||"string"==typeof e&&-1!=e.indexOf("BEGIN ")){var t=e;"string"==typeof e&&(t=Ve.getKey(e));var r=Ve.getKeyID(t);this.asn1KID=new X.asn1.DEROctetString({hex:r})}},this.setCertIssuerByParam=function(e){void 0!==e.str||void 0!==e.ldapstr||void 0!==e.hex||void 0!==e.certsubject||void 0!==e.certissuer?this.asn1CertIssuer=new X.asn1.x509.X500Name(e):"string"==typeof e&&-1!=e.indexOf("BEGIN ")&&-1!=e.indexOf("CERTIFICATE")&&(this.asn1CertIssuer=new X.asn1.x509.X500Name({certissuer:e}))},this.setCertSNByParam=function(e){if(void 0!==e.str||void 0!==e.bigint||void 0!==e.hex)this.asn1CertSN=new X.asn1.DERInteger(e);else if("string"==typeof e&&-1!=e.indexOf("BEGIN ")&&e.indexOf("CERTIFICATE")){var t=new We;t.readCertPEM(e);var r=t.getSerialNumberHex();this.asn1CertSN=new X.asn1.DERInteger({hex:r})}},this.oid="2.5.29.35",void 0!==e&&(void 0!==e.kid&&this.setKIDByParam(e.kid),void 0!==e.issuer&&this.setCertIssuerByParam(e.issuer),void 0!==e.sn&&this.setCertSNByParam(e.sn),void 0!==e.issuersn&&"string"==typeof e.issuersn&&-1!=e.issuersn.indexOf("BEGIN ")&&e.issuersn.indexOf("CERTIFICATE")&&(this.setCertSNByParam(e.issuersn),this.setCertIssuerByParam(e.issuersn)))},He(X.asn1.x509.AuthorityKeyIdentifier,X.asn1.x509.Extension),X.asn1.x509.SubjectKeyIdentifier=function(e){X.asn1.x509.SubjectKeyIdentifier.superclass.constructor.call(this,e);var t=X.asn1.DEROctetString;this.asn1KID=null,this.getExtnValueHex=function(){return this.asn1ExtnValue=this.asn1KID,this.asn1ExtnValue.tohex()},this.setKIDByParam=function(e){if(void 0!==e.str||void 0!==e.hex)this.asn1KID=new t(e);else if("object"==typeof e&&X.crypto.Util.isKey(e)||"string"==typeof e&&-1!=e.indexOf("BEGIN")){var r=e;"string"==typeof e&&(r=Ve.getKey(e));var n=Ve.getKeyID(r);this.asn1KID=new X.asn1.DEROctetString({hex:n})}},this.oid="2.5.29.14",void 0!==e&&void 0!==e.kid&&this.setKIDByParam(e.kid)},He(X.asn1.x509.SubjectKeyIdentifier,X.asn1.x509.Extension),X.asn1.x509.AuthorityInfoAccess=function(e){X.asn1.x509.AuthorityInfoAccess.superclass.constructor.call(this,e),this.setAccessDescriptionArray=function(e){for(var t=new Array,r=X.asn1,n=r.DERSequence,i=r.DERObjectIdentifier,s=r.x509.GeneralName,o=0;o<e.length;o++){var a,c=e[o];if(void 0!==c.ocsp)a=new n({array:[new i({oid:"1.3.6.1.5.5.7.48.1"}),new s({uri:c.ocsp})]});else{if(void 0===c.caissuer)throw new Error("unknown AccessMethod parameter: "+JSON.stringify(c));a=new n({array:[new i({oid:"1.3.6.1.5.5.7.48.2"}),new s({uri:c.caissuer})]})}t.push(a)}this.asn1ExtnValue=new n({array:t})},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="1.3.6.1.5.5.7.1.1",void 0!==e&&void 0!==e.array&&this.setAccessDescriptionArray(e.array)},He(X.asn1.x509.AuthorityInfoAccess,X.asn1.x509.Extension),X.asn1.x509.SubjectAltName=function(e){X.asn1.x509.SubjectAltName.superclass.constructor.call(this,e),this.setNameArray=function(e){this.asn1ExtnValue=new X.asn1.x509.GeneralNames(e)},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="2.5.29.17",void 0!==e&&void 0!==e.array&&this.setNameArray(e.array)},He(X.asn1.x509.SubjectAltName,X.asn1.x509.Extension),X.asn1.x509.IssuerAltName=function(e){X.asn1.x509.IssuerAltName.superclass.constructor.call(this,e),this.setNameArray=function(e){this.asn1ExtnValue=new X.asn1.x509.GeneralNames(e)},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="2.5.29.18",void 0!==e&&void 0!==e.array&&this.setNameArray(e.array)},He(X.asn1.x509.IssuerAltName,X.asn1.x509.Extension),X.asn1.x509.SubjectDirectoryAttributes=function(e){X.asn1.x509.SubjectDirectoryAttributes.superclass.constructor.call(this,e);var t=X.asn1,r=t.DERSequence,n=t.ASN1Util.newObject,i=t.x509.OID.name2oid;this.params=null,this.getExtnValueHex=function(){for(var e=[],t=0;t<this.params.array.length;t++){var s=this.params.array[t],o={seq:[{oid:"1.2.3.4"},{set:[{utf8str:"DE"}]}]};if("dateOfBirth"==s.attr)o.seq[0].oid=i(s.attr),o.seq[1].set[0]={gentime:s.str};else if("placeOfBirth"==s.attr)o.seq[0].oid=i(s.attr),o.seq[1].set[0]={utf8str:s.str};else if("gender"==s.attr)o.seq[0].oid=i(s.attr),o.seq[1].set[0]={prnstr:s.str};else if("countryOfCitizenship"==s.attr)o.seq[0].oid=i(s.attr),o.seq[1].set[0]={prnstr:s.str};else{if("countryOfResidence"!=s.attr)throw new Error("unsupported attribute: "+s.attr);o.seq[0].oid=i(s.attr),o.seq[1].set[0]={prnstr:s.str}}e.push(new n(o))}var a=new r({array:e});return this.asn1ExtnValue=a,this.asn1ExtnValue.tohex()},this.oid="2.5.29.9",void 0!==e&&(this.params=e)},He(X.asn1.x509.SubjectDirectoryAttributes,X.asn1.x509.Extension),X.asn1.x509.PrivateExtension=function(e){X.asn1.x509.PrivateExtension.superclass.constructor.call(this,e);var t=X.lang.String.isHex,r=X.asn1,n=r.x509.OID.name2oid,i=r.ASN1Util.newObject;this.params=null,this.setByParam=function(e){this.oid=n(e.extname),this.params=e},this.getExtnValueHex=function(){if(null==this.params.extname||null==this.params.extn)throw new Error("extname or extnhex not specified");var e=this.params.extn;if("string"==typeof e&&t(e))return e;if("object"==typeof e)try{return i(e).tohex()}catch(e){}throw new Error("unsupported extn value")},null!=e&&this.setByParam(e)},He(X.asn1.x509.PrivateExtension,X.asn1.x509.Extension),X.asn1.x509.CRL=function(e){X.asn1.x509.CRL.superclass.constructor.call(this);var t=X.asn1,r=t.DERSequence,n=t.DERBitString,i=t.x509,s=i.AlgorithmIdentifier,o=i.TBSCertList;this.params=void 0,this.setByParam=function(e){this.params=e},this.sign=function(){var e=new o(this.params).tohex(),t=new X.crypto.Signature({alg:this.params.sigalg});t.init(this.params.cakey),t.updateHex(e);var r=t.sign();this.params.sighex=r},this.getPEM=function(){return ye(this.tohex(),"X509 CRL")},this.tohex=function(){var e=this.params;if(null==e.tbsobj&&(e.tbsobj=new o(e)),null==e.sighex&&null!=e.cakey&&this.sign(),null==e.sighex)throw new Error("sighex or cakey parameter not defined");var t=[];return t.push(e.tbsobj),t.push(new s({name:e.sigalg})),t.push(new n({hex:"00"+e.sighex})),new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&(this.params=e)},He(X.asn1.x509.CRL,X.asn1.ASN1Object),X.asn1.x509.TBSCertList=function(e){X.asn1.x509.TBSCertList.superclass.constructor.call(this);var t=X.asn1,r=t.DERInteger,n=t.DERSequence,i=t.DERTaggedObject,s=t.x509,o=s.AlgorithmIdentifier,a=s.Time,c=s.Extensions,u=s.X500Name;this.params=null,this.setByParam=function(e){this.params=e},this.getRevCertSequence=function(){for(var e=[],t=this.params.revcert,i=0;i<t.length;i++){var s=[new r(t[i].sn),new a(t[i].date)];null!=t[i].ext&&s.push(new c(t[i].ext)),e.push(new n({array:s}))}return new n({array:e})},this.tohex=function(){var e=[],t=this.params;if(null!=t.version){var s=new r({int:t.version-1});e.push(s)}if(e.push(new o({name:t.sigalg})),e.push(new u(t.issuer)),e.push(new a(t.thisupdate)),null!=t.nextupdate&&e.push(new a(t.nextupdate)),null!=t.revcert&&e.push(this.getRevCertSequence()),null!=t.ext){var l=new c(t.ext);e.push(new i({tag:"a0",explicit:!0,obj:l}))}return new n({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},He(X.asn1.x509.TBSCertList,X.asn1.ASN1Object),X.asn1.x509.CRLEntry=function(e){X.asn1.x509.CRLEntry.superclass.constructor.call(this);var t=X.asn1;this.setCertSerial=function(e){this.sn=new t.DERInteger(e)},this.setRevocationDate=function(e){this.time=new t.x509.Time(e)},this.tohex=function(){var e=new t.DERSequence({array:[this.sn,this.time]});return this.TLV=e.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(void 0!==e.time&&this.setRevocationDate(e.time),void 0!==e.sn&&this.setCertSerial(e.sn))},He(X.asn1.x509.CRLEntry,X.asn1.ASN1Object),X.asn1.x509.CRLNumber=function(e){X.asn1.x509.CRLNumber.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new X.asn1.DERInteger(this.params.num),this.asn1ExtnValue.tohex()},this.oid="2.5.29.20",null!=e&&(this.params=e)},He(X.asn1.x509.CRLNumber,X.asn1.x509.Extension),X.asn1.x509.CRLReason=function(e){X.asn1.x509.CRLReason.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new X.asn1.DEREnumerated(this.params.code),this.asn1ExtnValue.tohex()},this.oid="2.5.29.21",null!=e&&(this.params=e)},He(X.asn1.x509.CRLReason,X.asn1.x509.Extension),X.asn1.x509.OCSPNonce=function(e){X.asn1.x509.OCSPNonce.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new X.asn1.DEROctetString(this.params),this.asn1ExtnValue.tohex()},this.oid="1.3.6.1.5.5.7.48.1.2",null!=e&&(this.params=e)},He(X.asn1.x509.OCSPNonce,X.asn1.x509.Extension),X.asn1.x509.OCSPNoCheck=function(e){X.asn1.x509.OCSPNoCheck.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new X.asn1.DERNull,this.asn1ExtnValue.tohex()},this.oid="1.3.6.1.5.5.7.48.1.5",null!=e&&(this.params=e)},He(X.asn1.x509.OCSPNoCheck,X.asn1.x509.Extension),X.asn1.x509.AdobeTimeStamp=function(e){X.asn1.x509.AdobeTimeStamp.superclass.constructor.call(this,e);var t=X.asn1,r=t.DERInteger,n=t.DERBoolean,i=t.DERSequence,s=t.x509.GeneralName;this.params=null,this.getExtnValueHex=function(){var e=this.params,t=[new r(1)];return t.push(new s({uri:e.uri})),null!=e.reqauth&&t.push(new n(e.reqauth)),this.asn1ExtnValue=new i({array:t}),this.asn1ExtnValue.tohex()},this.oid="1.2.840.113583.1.1.9.1",void 0!==e&&this.setByParam(e)},He(X.asn1.x509.AdobeTimeStamp,X.asn1.x509.Extension),X.asn1.x509.X500Name=function(e){X.asn1.x509.X500Name.superclass.constructor.call(this),this.asn1Array=[],this.paramArray=[],this.sRule="utf8";var t=X.asn1,r=t.x509,n=r.RDN;this.setByString=function(e,t){void 0!==t&&(this.sRule=t);var r=e.split("/");r.shift();for(var i=[],s=0;s<r.length;s++)if(r[s].match(/^[^=]+=.+$/))i.push(r[s]);else{var o=i.length-1;i[o]=i[o]+"/"+r[s]}for(s=0;s<i.length;s++)this.asn1Array.push(new n({str:i[s],rule:this.sRule}))},this.setByLdapString=function(e,t){void 0!==t&&(this.sRule=t);var n=r.X500Name.ldapToCompat(e);this.setByString(n,t)},this.setByObject=function(e,t){for(var r in void 0!==t&&(this.sRule=t),e)if(e.hasOwnProperty(r)){var i=new n({str:r+"="+e[r],rule:this.sRule});this.asn1Array?this.asn1Array.push(i):this.asn1Array=[i]}},this.setByParam=function(e){var t;void 0!==e.rule&&(this.sRule=e.rule),void 0!==e.array?this.paramArray=e.array:void 0!==e.str?this.setByString(e.str):void 0!==e.ldapstr?this.setByLdapString(e.ldapstr):void 0!==e.hex?this.hTLV=e.hex:void 0!==e.certissuer?((t=new We).readCertPEM(e.certissuer),this.hTLV=t.getIssuerHex()):void 0!==e.certsubject?((t=new We).readCertPEM(e.certsubject),this.hTLV=t.getSubjectHex()):"object"==typeof e&&void 0===e.certsubject&&void 0===e.certissuer&&this.setByObject(e)},this.tohex=function(){if("string"==typeof this.hTLV)return this.hTLV;if(0==this.asn1Array.length&&this.paramArray.length>0)for(var e=0;e<this.paramArray.length;e++){var r={array:this.paramArray[e]};"utf8"!=this.sRule&&(r.rule=this.sRule);var i=new n(r);this.asn1Array.push(i)}var s=new t.DERSequence({array:this.asn1Array});return this.hTLV=s.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},He(X.asn1.x509.X500Name,X.asn1.ASN1Object),X.asn1.x509.X500Name.compatToLDAP=function(e){if("/"!==e.substr(0,1))throw"malformed input";var t=(e=e.substr(1)).split("/");return t.reverse(),(t=t.map((function(e){return e.replace(/,/,"\\,")}))).join(",")},X.asn1.x509.X500Name.onelineToLDAP=function(e){return X.asn1.x509.X500Name.compatToLDAP(e)},X.asn1.x509.X500Name.ldapToCompat=function(e){for(var t=e.split(","),r=!1,n=[],i=0;t.length>0;i++){var s=t.shift();if(!0===r){var o=(n.pop()+","+s).replace(/\\,/g,",");n.push(o),r=!1}else n.push(s);"\\"===s.substr(-1,1)&&(r=!0)}return(n=n.map((function(e){return e.replace("/","\\/")}))).reverse(),"/"+n.join("/")},X.asn1.x509.X500Name.ldapToOneline=function(e){return X.asn1.x509.X500Name.ldapToCompat(e)},X.asn1.x509.RDN=function(e){X.asn1.x509.RDN.superclass.constructor.call(this),this.asn1Array=[],this.paramArray=[],this.sRule="utf8";var t=X.asn1.x509.AttributeTypeAndValue;this.setByParam=function(e){void 0!==e.rule&&(this.sRule=e.rule),void 0!==e.str&&this.addByMultiValuedString(e.str),void 0!==e.array&&(this.paramArray=e.array)},this.addByString=function(e){this.asn1Array.push(new X.asn1.x509.AttributeTypeAndValue({str:e,rule:this.sRule}))},this.addByMultiValuedString=function(e){for(var t=X.asn1.x509.RDN.parseString(e),r=0;r<t.length;r++)this.addByString(t[r])},this.tohex=function(){if(0==this.asn1Array.length&&this.paramArray.length>0)for(var e=0;e<this.paramArray.length;e++){var r=this.paramArray[e];void 0!==r.rule&&"utf8"!=this.sRule&&(r.rule=this.sRule);var n=new t(r);this.asn1Array.push(n)}var i=new X.asn1.DERSet({array:this.asn1Array});return this.TLV=i.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},He(X.asn1.x509.RDN,X.asn1.ASN1Object),X.asn1.x509.RDN.parseString=function(e){for(var t=e.split(/\+/),r=!1,n=[],i=0;t.length>0;i++){var s=t.shift();if(!0===r){var o=(n.pop()+"+"+s).replace(/\\\+/g,"+");n.push(o),r=!1}else n.push(s);"\\"===s.substr(-1,1)&&(r=!0)}var a=!1,c=[];for(i=0;n.length>0;i++){if(s=n.shift(),!0===a){var u=c.pop();s.match(/"$/)?(o=(u+"+"+s).replace(/^([^=]+)="(.*)"$/,"$1=$2"),c.push(o),a=!1):c.push(u+"+"+s)}else c.push(s);s.match(/^[^=]+="/)&&(a=!0)}return c},X.asn1.x509.AttributeTypeAndValue=function(e){X.asn1.x509.AttributeTypeAndValue.superclass.constructor.call(this),this.sRule="utf8",this.sType=null,this.sValue=null,this.dsType=null;var t=X.asn1,r=t.DERSequence,n=t.DERUTF8String,i=t.DERPrintableString,s=t.DERTeletexString,o=t.DERIA5String,a=t.DERVisibleString,c=t.DERBMPString,u=X.lang.String.isMail,l=X.lang.String.isPrintable;this.setByParam=function(e){if(void 0!==e.rule&&(this.sRule=e.rule),void 0!==e.ds&&(this.dsType=e.ds),void 0===e.value&&void 0!==e.str){var t=e.str.match(/^([^=]+)=(.+)$/);if(!t)throw new Error("malformed attrTypeAndValueStr: "+attrTypeAndValueStr);this.sType=t[1],this.sValue=t[2]}else this.sType=e.type,this.sValue=e.value},this.setByString=function(e,t){void 0!==t&&(this.sRule=t);var r=e.match(/^([^=]+)=(.+)$/);if(!r)throw new Error("malformed attrTypeAndValueStr: "+attrTypeAndValueStr);this.setByAttrTypeAndValueStr(r[1],r[2])},this._getDsType=function(){var e=this.sType,t=this.sValue,r=this.sRule;return"prn"===r?"CN"==e&&u(t)?"ia5":l(t)?"prn":"utf8":"utf8"===r?"CN"==e&&u(t)?"ia5":"C"==e?"prn":"utf8":"utf8"},this.setByAttrTypeAndValueStr=function(e,t,r){void 0!==r&&(this.sRule=r),this.sType=e,this.sValue=t},this.getValueObj=function(e,t){if("utf8"==e)return new n({str:t});if("prn"==e)return new i({str:t});if("tel"==e)return new s({str:t});if("ia5"==e)return new o({str:t});if("vis"==e)return new a({str:t});if("bmp"==e)return new c({str:t});throw new Error("unsupported directory string type: type="+e+" value="+t)},this.tohex=function(){null==this.dsType&&(this.dsType=this._getDsType());var e=X.asn1.x509.OID.atype2obj(this.sType),t=this.getValueObj(this.dsType,this.sValue),n=new r({array:[e,t]});return this.TLV=n.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},He(X.asn1.x509.AttributeTypeAndValue,X.asn1.ASN1Object),X.asn1.x509.SubjectPublicKeyInfo=function(e){X.asn1.x509.SubjectPublicKeyInfo.superclass.constructor.call(this);var t=X.asn1,r=t.DERInteger,n=t.DERBitString,i=t.DERObjectIdentifier,s=t.DERSequence,o=t.ASN1Util.newObject,a=t.x509.AlgorithmIdentifier;this.getASN1Object=function(){if(null==this.asn1AlgId||null==this.asn1SubjPKey)throw"algId and/or subjPubKey not set";return new s({array:[this.asn1AlgId,this.asn1SubjPKey]})},this.tohex=function(){var e=this.getASN1Object();return this.hTLV=e.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},this.setPubKey=function(e){try{if(e instanceof K){var t=o({seq:[{int:{bigint:e.n}},{int:{int:e.e}}]}).tohex();this.asn1AlgId=new a({name:"rsaEncryption"}),this.asn1SubjPKey=new n({hex:"00"+t})}}catch(e){}try{if(e instanceof X.crypto.ECDSA){var s=new i({name:e.curveName});this.asn1AlgId=new a({name:"ecPublicKey",asn1params:s}),this.asn1SubjPKey=new n({hex:"00"+e.pubKeyHex})}}catch(e){}try{if(e instanceof X.crypto.DSA){s=new o({seq:[{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.g}}]}),this.asn1AlgId=new a({name:"dsa",asn1params:s});var c=new r({bigint:e.y});this.asn1SubjPKey=new n({hex:"00"+c.tohex()})}}catch(e){}},void 0!==e&&this.setPubKey(e)},He(X.asn1.x509.SubjectPublicKeyInfo,X.asn1.ASN1Object),X.asn1.x509.Time=function(e){X.asn1.x509.Time.superclass.constructor.call(this);var t=X.asn1,r=t.DERUTCTime,n=t.DERGeneralizedTime;this.params=null,this.type=null,this.setTimeParams=function(e){this.timeParams=e},this.setByParam=function(e){this.params=e},this.getType=function(e){return e.match(/^[0-9]{12}Z$/)?"utc":e.match(/^[0-9]{14}Z$/)?"gen":e.match(/^[0-9]{12}\.[0-9]+Z$/)?"utc":e.match(/^[0-9]{14}\.[0-9]+Z$/)?"gen":null},this.tohex=function(){var e=this.params,t=null;if("string"==typeof e&&(e={str:e}),null==e||!e.str||null!=e.type&&null!=e.type||(e.type=this.getType(e.str)),null!=e&&e.str?("utc"==e.type&&(t=new r(e.str)),"gen"==e.type&&(t=new n(e.str))):t="gen"==this.type?new n:new r,null==t)throw new Error("wrong setting for Time");return this.TLV=t.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},X.asn1.x509.Time_bak=function(e){X.asn1.x509.Time_bak.superclass.constructor.call(this);var t=X.asn1,r=t.DERUTCTime,n=t.DERGeneralizedTime;this.setTimeParams=function(e){this.timeParams=e},this.tohex=function(){var e=null;return e=null!=this.timeParams?"utc"==this.type?new r(this.timeParams):new n(this.timeParams):"utc"==this.type?new r:new n,this.TLV=e.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},this.type="utc",void 0!==e&&(void 0!==e.type?this.type=e.type:void 0!==e.str&&(e.str.match(/^[0-9]{12}Z$/)&&(this.type="utc"),e.str.match(/^[0-9]{14}Z$/)&&(this.type="gen")),this.timeParams=e)},He(X.asn1.x509.Time,X.asn1.ASN1Object),X.asn1.x509.AlgorithmIdentifier=function(e){X.asn1.x509.AlgorithmIdentifier.superclass.constructor.call(this),this.nameAlg=null,this.asn1Alg=null,this.asn1Params=null,this.paramEmpty=!1;var t=X.asn1,r=t.x509.AlgorithmIdentifier.PSSNAME2ASN1TLV;if(this.tohex=function(){if(null===this.nameAlg&&null===this.asn1Alg)throw new Error("algorithm not specified");if(null!==this.nameAlg){var e=null;for(var n in r)n===this.nameAlg&&(e=r[n]);if(null!==e)return this.hTLV=e,this.hTLV}null!==this.nameAlg&&null===this.asn1Alg&&(this.asn1Alg=t.x509.OID.name2obj(this.nameAlg));var i=[this.asn1Alg];null!==this.asn1Params&&i.push(this.asn1Params);var s=new t.DERSequence({array:i});return this.hTLV=s.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(void 0!==e.name&&(this.nameAlg=e.name),void 0!==e.asn1params&&(this.asn1Params=e.asn1params),void 0!==e.paramempty&&(this.paramEmpty=e.paramempty)),null===this.asn1Params&&!1===this.paramEmpty&&null!==this.nameAlg){void 0!==this.nameAlg.name&&(this.nameAlg=this.nameAlg.name);var n=this.nameAlg.toLowerCase();"withdsa"!==n.substr(-7,7)&&"withecdsa"!==n.substr(-9,9)&&(this.asn1Params=new t.DERNull)}},He(X.asn1.x509.AlgorithmIdentifier,X.asn1.ASN1Object),X.asn1.x509.AlgorithmIdentifier.PSSNAME2ASN1TLV={SHAwithRSAandMGF1:"300d06092a864886f70d01010a3000",SHA256withRSAandMGF1:"303d06092a864886f70d01010a3030a00d300b0609608648016503040201a11a301806092a864886f70d010108300b0609608648016503040201a203020120",SHA384withRSAandMGF1:"303d06092a864886f70d01010a3030a00d300b0609608648016503040202a11a301806092a864886f70d010108300b0609608648016503040202a203020130",SHA512withRSAandMGF1:"303d06092a864886f70d01010a3030a00d300b0609608648016503040203a11a301806092a864886f70d010108300b0609608648016503040203a203020140"},X.asn1.x509.GeneralName=function(e){X.asn1.x509.GeneralName.superclass.constructor.call(this);var t=X.asn1,r=t.x509,n=r.X500Name,i=r.OtherName,s=t.DERIA5String,o=t.DEROctetString,a=t.DERTaggedObject,c=t.ASN1Object,u=Error;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e,t,r=this.params,l=!1;if(void 0!==r.other)e="a0",t=new i(r.other);else if(void 0!==r.rfc822)e="81",t=new s({str:r.rfc822});else if(void 0!==r.dns)e="82",t=new s({str:r.dns});else if(void 0!==r.dn)e="a4",l=!0,t="string"==typeof r.dn?new n({str:r.dn}):r.dn instanceof X.asn1.x509.X500Name?r.dn:new n(r.dn);else if(void 0!==r.ldapdn)e="a4",l=!0,t=new n({ldapstr:r.ldapdn});else if(void 0!==r.certissuer||void 0!==r.certsubj){var h,d;e="a4",l=!0;var m=null;if(void 0!==r.certsubj?(h=!1,d=r.certsubj):(h=!0,d=r.certissuer),d.match(/^[0-9A-Fa-f]+$/),-1!=d.indexOf("-----BEGIN ")&&(m=ve(d)),null==m)throw new Error("certsubj/certissuer not cert");var p,f=new We;f.hex=m,p=h?f.getIssuerHex():f.getSubjectHex(),(t=new c).hTLV=p}else if(void 0!==r.uri)e="86",t=new s({str:r.uri});else{if(void 0===r.ip)throw new u("improper params");var g;e="87";var y=r.ip;try{if(y.match(/^[0-9a-f]+$/)){var v=y.length;if(8!=v&&16!=v&&32!=v&&64!=v)throw"err";g=y}else g=Pe(y)}catch(e){throw new u("malformed IP address: "+r.ip+":"+e.message)}t=new o({hex:g})}return new a({tag:e,explicit:l,obj:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},He(X.asn1.x509.GeneralName,X.asn1.ASN1Object),X.asn1.x509.GeneralNames=function(e){X.asn1.x509.GeneralNames.superclass.constructor.call(this);var t=X.asn1;this.setByParamArray=function(e){for(var r=0;r<e.length;r++){var n=new t.x509.GeneralName(e[r]);this.asn1Array.push(n)}},this.tohex=function(){return new t.DERSequence({array:this.asn1Array}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.asn1Array=new Array,void 0!==e&&this.setByParamArray(e)},He(X.asn1.x509.GeneralNames,X.asn1.ASN1Object),X.asn1.x509.OtherName=function(e){X.asn1.x509.OtherName.superclass.constructor.call(this);var t=X.asn1,r=t.DERObjectIdentifier,n=t.DERSequence,i=t.ASN1Util.newObject;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params;if(null==e.oid||null==e.value)throw new Error("oid or value not specified");var t=new r({oid:e.oid}),s=i({tag:{tag:"a0",explicit:!0,obj:e.value}});return new n({array:[t,s]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},He(X.asn1.x509.OtherName,X.asn1.ASN1Object),X.asn1.x509.OID=new function(){var e=X.asn1.DERObjectIdentifier;this.name2oidList={sha1:"1.3.14.3.2.26",sha256:"2.16.840.1.101.3.4.2.1",sha384:"2.16.840.1.101.3.4.2.2",sha512:"2.16.840.1.101.3.4.2.3",sha224:"2.16.840.1.101.3.4.2.4",md5:"1.2.840.113549.2.5",md2:"1.3.14.7.2.2.1",ripemd160:"1.3.36.3.2.1",MD2withRSA:"1.2.840.113549.1.1.2",MD4withRSA:"1.2.840.113549.1.1.3",MD5withRSA:"1.2.840.113549.1.1.4",SHA1withRSA:"1.2.840.113549.1.1.5","pkcs1-MGF":"1.2.840.113549.1.1.8",rsaPSS:"1.2.840.113549.1.1.10",SHA224withRSA:"1.2.840.113549.1.1.14",SHA256withRSA:"1.2.840.113549.1.1.11",SHA384withRSA:"1.2.840.113549.1.1.12",SHA512withRSA:"1.2.840.113549.1.1.13",SHA1withECDSA:"1.2.840.10045.4.1",SHA224withECDSA:"1.2.840.10045.4.3.1",SHA256withECDSA:"1.2.840.10045.4.3.2",SHA384withECDSA:"1.2.840.10045.4.3.3",SHA512withECDSA:"1.2.840.10045.4.3.4",dsa:"1.2.840.10040.4.1",SHA1withDSA:"1.2.840.10040.4.3",SHA224withDSA:"2.16.840.1.101.3.4.3.1",SHA256withDSA:"2.16.840.1.101.3.4.3.2",rsaEncryption:"1.2.840.113549.1.1.1",commonName:"2.5.4.3",countryName:"2.5.4.6",localityName:"2.5.4.7",stateOrProvinceName:"2.5.4.8",streetAddress:"2.5.4.9",organizationName:"2.5.4.10",organizationalUnitName:"2.5.4.11",domainComponent:"0.9.2342.19200300.100.1.25",userId:"0.9.2342.19200300.100.1.1",surname:"2.5.4.4",givenName:"2.5.4.42",title:"2.5.4.12",distinguishedName:"2.5.4.49",emailAddress:"1.2.840.113549.1.9.1",description:"2.5.4.13",businessCategory:"2.5.4.15",postalCode:"2.5.4.17",uniqueIdentifier:"2.5.4.45",organizationIdentifier:"2.5.4.97",jurisdictionOfIncorporationL:"1.3.6.1.4.1.311.60.2.1.1",jurisdictionOfIncorporationSP:"1.3.6.1.4.1.311.60.2.1.2",jurisdictionOfIncorporationC:"1.3.6.1.4.1.311.60.2.1.3",subjectDirectoryAttributes:"2.5.29.9",subjectKeyIdentifier:"2.5.29.14",keyUsage:"2.5.29.15",subjectAltName:"2.5.29.17",issuerAltName:"2.5.29.18",basicConstraints:"2.5.29.19",cRLNumber:"2.5.29.20",cRLReason:"2.5.29.21",nameConstraints:"2.5.29.30",cRLDistributionPoints:"2.5.29.31",certificatePolicies:"2.5.29.32",anyPolicy:"2.5.29.32.0",authorityKeyIdentifier:"2.5.29.35",policyConstraints:"2.5.29.36",extKeyUsage:"2.5.29.37",authorityInfoAccess:"1.3.6.1.5.5.7.1.1",ocsp:"1.3.6.1.5.5.7.48.1",ocspBasic:"1.3.6.1.5.5.7.48.1.1",ocspNonce:"1.3.6.1.5.5.7.48.1.2",ocspNoCheck:"1.3.6.1.5.5.7.48.1.5",caIssuers:"1.3.6.1.5.5.7.48.2",anyExtendedKeyUsage:"2.5.29.37.0",serverAuth:"1.3.6.1.5.5.7.3.1",clientAuth:"1.3.6.1.5.5.7.3.2",codeSigning:"1.3.6.1.5.5.7.3.3",emailProtection:"1.3.6.1.5.5.7.3.4",timeStamping:"1.3.6.1.5.5.7.3.8",ocspSigning:"1.3.6.1.5.5.7.3.9",dateOfBirth:"1.3.6.1.5.5.7.9.1",placeOfBirth:"1.3.6.1.5.5.7.9.2",gender:"1.3.6.1.5.5.7.9.3",countryOfCitizenship:"1.3.6.1.5.5.7.9.4",countryOfResidence:"1.3.6.1.5.5.7.9.5",ecPublicKey:"1.2.840.10045.2.1","P-256":"1.2.840.10045.3.1.7",secp256r1:"1.2.840.10045.3.1.7",secp256k1:"1.3.132.0.10",secp384r1:"1.3.132.0.34",secp521r1:"1.3.132.0.35",pkcs5PBES2:"1.2.840.113549.1.5.13",pkcs5PBKDF2:"1.2.840.113549.1.5.12","des-EDE3-CBC":"1.2.840.113549.3.7",data:"1.2.840.113549.1.7.1","signed-data":"1.2.840.113549.1.7.2","enveloped-data":"1.2.840.113549.1.7.3","digested-data":"1.2.840.113549.1.7.5","encrypted-data":"1.2.840.113549.1.7.6","authenticated-data":"1.2.840.113549.1.9.16.1.2",tstinfo:"1.2.840.113549.1.9.16.1.4",signingCertificate:"1.2.840.113549.1.9.16.2.12",timeStampToken:"1.2.840.113549.1.9.16.2.14",signaturePolicyIdentifier:"1.2.840.113549.1.9.16.2.15",etsArchiveTimeStamp:"1.2.840.113549.1.9.16.2.27",signingCertificateV2:"1.2.840.113549.1.9.16.2.47",etsArchiveTimeStampV2:"1.2.840.113549.1.9.16.2.48",extensionRequest:"1.2.840.113549.1.9.14",contentType:"1.2.840.113549.1.9.3",messageDigest:"1.2.840.113549.1.9.4",signingTime:"1.2.840.113549.1.9.5",counterSignature:"1.2.840.113549.1.9.6",archiveTimeStampV3:"0.4.0.1733.2.4",pdfRevocationInfoArchival:"1.2.840.113583.1.1.8",adobeTimeStamp:"1.2.840.113583.1.1.9.1"},this.atype2oidList={CN:"2.5.4.3",L:"2.5.4.7",ST:"2.5.4.8",O:"2.5.4.10",OU:"2.5.4.11",C:"2.5.4.6",STREET:"2.5.4.9",DC:"0.9.2342.19200300.100.1.25",UID:"0.9.2342.19200300.100.1.1",SN:"2.5.4.4",T:"2.5.4.12",DN:"2.5.4.49",E:"1.2.840.113549.1.9.1",description:"2.5.4.13",businessCategory:"2.5.4.15",postalCode:"2.5.4.17",serialNumber:"2.5.4.5",uniqueIdentifier:"2.5.4.45",organizationIdentifier:"2.5.4.97",jurisdictionOfIncorporationL:"1.3.6.1.4.1.311.60.2.1.1",jurisdictionOfIncorporationSP:"1.3.6.1.4.1.311.60.2.1.2",jurisdictionOfIncorporationC:"1.3.6.1.4.1.311.60.2.1.3"},this.objCache={},this.name2obj=function(t){if(void 0!==this.objCache[t])return this.objCache[t];if(void 0===this.name2oidList[t])throw"Name of ObjectIdentifier not defined: "+t;var r=new e({oid:this.name2oidList[t]});return this.objCache[t]=r,r},this.atype2obj=function(t){if(void 0!==this.objCache[t])return this.objCache[t];var r;if(t.match(/^\d+\.\d+\.[0-9.]+$/))r=t;else if(void 0!==this.atype2oidList[t])r=this.atype2oidList[t];else{if(void 0===this.name2oidList[t])throw new Error("AttributeType name undefined: "+t);r=this.name2oidList[t]}var n=new e({oid:r});return this.objCache[t]=n,n},this.registerOIDs=function(e){if(this.checkOIDs(e))for(var t in e)this.name2oidList[t]=e[t]},this.checkOIDs=function(e){try{var t=Object.keys(e);return 0!=t.length&&(t.map((function(e,t,r){if(!this[e].match(/^[0-2]\.[0-9.]+$/))throw new Error("value is not OID")}),e),!0)}catch(e){return!1}}},X.asn1.x509.OID.oid2name=function(e){var t=X.asn1.x509.OID.name2oidList;for(var r in t)if(t[r]==e)return r;return""},X.asn1.x509.OID.oid2atype=function(e){var t=X.asn1.x509.OID.atype2oidList;for(var r in t)if(t[r]==e)return r;return e},X.asn1.x509.OID.name2oid=function(e){if(e.match(/^[0-9.]+$/))return e;var t=X.asn1.x509.OID.name2oidList;return void 0===t[e]?"":t[e]},X.asn1.x509.X509Util={},X.asn1.x509.X509Util.newCertPEM=function(e){return new(0,X.asn1.x509.Certificate)(e).getPEM()},void 0!==X&&X||(X={}),void 0!==X.asn1&&X.asn1||(X.asn1={}),void 0!==X.asn1.cms&&X.asn1.cms||(X.asn1.cms={}),X.asn1.cms.Attribute=function(e){var t=Error,r=X.asn1,n=r.DERSequence,i=r.DERSet,s=r.DERObjectIdentifier;this.params=null,this.typeOid=null,this.setByParam=function(e){this.params=e},this.getValueArray=function(){throw new t("not yet implemented abstract")},this.tohex=function(){var e=new s({oid:this.typeOid}),t=new i({array:this.getValueArray()});return new n({array:[e,t]}).tohex()},this.getEncodedHex=function(){return this.tohex()}},He(X.asn1.cms.Attribute,X.asn1.ASN1Object),X.asn1.cms.ContentType=function(e){var t=X.asn1;t.cms.ContentType.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.3",this.getValueArray=function(){return[new t.DERObjectIdentifier(this.params.type)]},null!=e&&this.setByParam(e)},He(X.asn1.cms.ContentType,X.asn1.cms.Attribute),X.asn1.cms.MessageDigest=function(e){var t=X.asn1,r=t.DEROctetString;t.cms.MessageDigest.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.4",this.getValueArray=function(){return[new r(this.params)]},null!=e&&this.setByParam(e)},He(X.asn1.cms.MessageDigest,X.asn1.cms.Attribute),X.asn1.cms.SigningTime=function(e){var t=X.asn1;t.cms.SigningTime.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.5",this.getValueArray=function(){return[new t.x509.Time(this.params)]},null!=e&&this.setByParam(e)},He(X.asn1.cms.SigningTime,X.asn1.cms.Attribute),X.asn1.cms.SigningCertificate=function(e){var t=Error,r=X.asn1,n=r.DERSequence,i=r.cms,s=i.ESSCertID;i.SigningCertificate.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.12",this.getValueArray=function(){if(null==this.params||null==this.params||null==this.params.array)throw new t("parameter 'array' not specified");for(var r=this.params.array,i=[],o=0;o<r.length;o++){var a=r[o];0!=e.hasis||"string"!=typeof a||-1==a.indexOf("-----BEGIN")&&!ee.isASN1HEX(a)||(a={cert:a}),0!=a.hasis&&0==e.hasis&&(a.hasis=!1),i.push(new s(a))}var c=new n({array:i});return[new n({array:[c]})]},null!=e&&this.setByParam(e)},He(X.asn1.cms.SigningCertificate,X.asn1.cms.Attribute),X.asn1.cms.ESSCertID=function(e){X.asn1.cms.ESSCertID.superclass.constructor.call(this);var t=Error,r=X,n=r.asn1,i=n.DEROctetString,s=n.DERSequence,o=n.cms.IssuerSerial;this.params=null,this.getCertHash=function(e,n){if(null!=e.hash)return e.hash;if("string"==typeof e&&-1==e.indexOf("-----BEGIN")&&!ee.isASN1HEX(e))return e;var i,s,o;if("string"==typeof e)i=e;else{if(null==e.cert)throw new t("hash nor cert unspecified");i=e.cert}if(s=-1!=i.indexOf("-----BEGIN")?ve(i):i,"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?s=ve(e):ee.isASN1HEX(e)&&(s=e)),null!=e.alg)o=e.alg;else{if(null==n)throw new t("hash alg unspecified");o=n}return r.crypto.Util.hashHex(s,o)},this.tohex=function(){var e=this.params,t=this.getCertHash(e,"sha1"),r=[];return r.push(new i({hex:t})),("string"==typeof e&&-1!=e.indexOf("-----BEGIN")||null!=e.cert&&0!=e.hasis||null!=e.issuer&&null!=e.serial)&&r.push(new o(e)),new s({array:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},He(X.asn1.cms.ESSCertID,X.asn1.ASN1Object),X.asn1.cms.SigningCertificateV2=function(e){var t=Error,r=X.asn1,n=r.DERSequence,i=r.cms,s=i.ESSCertIDv2;i.SigningCertificateV2.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.47",this.getValueArray=function(){if(null==this.params||null==this.params||null==this.params.array)throw new t("parameter 'array' not specified");for(var r=this.params.array,i=[],o=0;o<r.length;o++){var a=r[o];null==e.alg&&0!=e.hasis||"string"!=typeof a||-1==a.indexOf("-----BEGIN")&&!ee.isASN1HEX(a)||(a={cert:a}),null==a.alg&&null!=e.alg&&(a.alg=e.alg),0!=a.hasis&&0==e.hasis&&(a.hasis=!1),i.push(new s(a))}var c=new n({array:i});return[new n({array:[c]})]},null!=e&&this.setByParam(e)},He(X.asn1.cms.SigningCertificateV2,X.asn1.cms.Attribute),X.asn1.cms.ESSCertIDv2=function(e){X.asn1.cms.ESSCertIDv2.superclass.constructor.call(this),Error;var t=X.asn1,r=t.DEROctetString,n=t.DERSequence,i=t.cms.IssuerSerial,s=t.x509.AlgorithmIdentifier;this.params=null,this.tohex=function(){var e=this.params,t=this.getCertHash(e,"sha256"),o=[];return null!=e.alg&&"sha256"!=e.alg&&o.push(new s({name:e.alg})),o.push(new r({hex:t})),("string"==typeof e&&-1!=e.indexOf("-----BEGIN")||null!=e.cert&&0!=e.hasis||null!=e.issuer&&null!=e.serial)&&o.push(new i(e)),new n({array:o}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},He(X.asn1.cms.ESSCertIDv2,X.asn1.cms.ESSCertID),X.asn1.cms.IssuerSerial=function(e){var t=Error,r=X.asn1,n=r.DERInteger,i=r.DERSequence,s=r.x509.GeneralNames,o=We;r.cms.IssuerSerial.superclass.constructor.call(this),this.setByParam=function(e){this.params=e},this.tohex=function(){var e,r,a=this.params;if("string"==typeof a&&-1!=a.indexOf("-----BEGIN")||null!=a.cert){var c;c=null!=a.cert?a.cert:a;var u=new o;u.readCertPEM(c),e=u.getIssuer(),r={hex:u.getSerialNumberHex()}}else{if(null==a.issuer||!a.serial)throw new t("cert or issuer and serial parameter not specified");e=a.issuer,r=a.serial}var l=new s([{dn:e}]),h=new n(r);return new i({array:[l,h]}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},He(X.asn1.cms.IssuerSerial,X.asn1.ASN1Object),X.asn1.cms.SignerIdentifier=function(e){var t=X.asn1.cms,r=t.IssuerAndSerialNumber,n=t.SubjectKeyIdentifier;Error,t.SignerIdentifier.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if("isssn"==e.type)return new r(e).tohex();if("skid"==e.type)return new n(e).tohex();throw new Error("wrong property for isssn or skid")},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},He(X.asn1.cms.SignerIdentifier,X.asn1.ASN1Object),X.asn1.cms.IssuerAndSerialNumber=function(e){var t=X.asn1,r=t.DERInteger,n=t.DERSequence,i=t.x509.X500Name,s=We,o=Error;t.cms.IssuerAndSerialNumber.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e,t,a=this.params;if("string"==typeof a&&-1!=a.indexOf("-----BEGIN")||null!=a.cert){var c;c=null!=a.cert?a.cert:a;var u=new s;u.readCertPEM(c),e=u.getIssuer(),t={hex:u.getSerialNumberHex()}}else{if(null==a.issuer||!a.serial)throw new o("cert or issuer and serial parameter not specified");e=a.issuer,t=a.serial}var l=new i(e),h=new r(t);return new n({array:[l,h]}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},null!=e&&this.setByParam(e)},He(X.asn1.cms.IssuerAndSerialNumber,X.asn1.ASN1Object),X.asn1.cms.SubjectKeyIdentifier=function(e){var t=X.asn1,r=t.ASN1Util.newObject,n=We,i=Error;t.cms.SubjectKeyIdentifier.superclass.constructor.call(this),this.tohex=function(){var e,t=this.params;if(null==t.cert&&null==t.skid)throw new i("property cert nor skid undefined");return null!=t.cert?e=new n(t.cert).getExtSubjectKeyIdentifier().kid.hex:null!=t.skid&&(e=t.skid),r({tag:{tage:"a0",obj:{octstr:{hex:e}}}}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},He(X.asn1.cms.SubjectKeyIdentifier,X.asn1.ASN1Object),X.asn1.cms.AttributeList=function(e){var t=Error,r=X.asn1,n=r.DERSet,i=r.cms;i.AttributeList.superclass.constructor.call(this),this.params=null,this.hTLV=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params;if(null!=this.hTLV)return this.hTLV;var r=!0;null!=e.sortflag&&(r=e.sortflag);for(var s=e.array,o=[],a=0;a<s.length;a++){var c=s[a],u=c.attr;if("contentType"==u)o.push(new i.ContentType(c));else if("messageDigest"==u)o.push(new i.MessageDigest(c));else if("signingTime"==u)o.push(new i.SigningTime(c));else if("signingCertificate"==u)o.push(new i.SigningCertificate(c));else if("signingCertificateV2"==u)o.push(new i.SigningCertificateV2(c));else if("signaturePolicyIdentifier"==u)o.push(new X.asn1.cades.SignaturePolicyIdentifier(c));else{if("signatureTimeStamp"!=u&&"timeStampToken"!=u)throw new t("unknown attr: "+u);o.push(new X.asn1.cades.SignatureTimeStamp(c))}}var l=new n({array:o,sortflag:r});return this.hTLV=l.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},He(X.asn1.cms.AttributeList,X.asn1.ASN1Object),X.asn1.cms.SignerInfo=function(e){var t=Error,r=X.asn1,n=r.DERInteger,i=r.DEROctetString,s=r.DERSequence,o=r.DERTaggedObject,a=r.cms,c=a.SignerIdentifier,u=a.AttributeList,l=r.x509.AlgorithmIdentifier,h=X.crypto,d=Ve;a.SignerInfo.superclass.constructor.call(this),this.params=null,this.sign=function(){var e=this.params,t=e.sigalg,r=new u(e.sattrs).tohex(),n=d.getKey(e.signkey),i=new h.Signature({alg:t});i.init(n),i.updateHex(r);var s=i.sign();e.sighex=s},this.tohex=function(){var e=this.params,r=[];if(r.push(new n({int:e.version})),r.push(new c(e.id)),r.push(new l({name:e.hashalg})),null!=e.sattrs){var a=new u(e.sattrs);try{r.push(new o({tag:"a0",explicit:!1,obj:a}))}catch(e){throw new t("si sattr error: "+e)}}if(r.push(new l(null!=e.sigalgfield?{name:e.sigalgfield}:{name:e.sigalg})),null==e.sighex&&null!=e.signkey&&this.sign(),r.push(new i({hex:e.sighex})),null!=e.uattrs){a=new u(e.uattrs);try{r.push(new o({tag:"a1",explicit:!1,obj:a}))}catch(e){throw new t("si uattr error: "+e)}}return new s({array:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},He(X.asn1.cms.SignerInfo,X.asn1.ASN1Object),X.asn1.cms.EncapsulatedContentInfo=function(e){var t=X.asn1,r=t.DERTaggedObject,n=t.DERSequence,i=t.DERObjectIdentifier,s=t.DEROctetString;t.cms.EncapsulatedContentInfo.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];if(t.push(new i(e.type)),null!=e.content&&(null!=e.content.hex||null!=e.content.str)&&1!=e.isDetached){var o=new s(e.content),a=new r({tag:"a0",explicit:!0,obj:o});t.push(a)}return new n({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},null!=e&&this.setByParam(e)},He(X.asn1.cms.EncapsulatedContentInfo,X.asn1.ASN1Object),X.asn1.cms.ContentInfo=function(e){var t=X.asn1,r=t.DERTaggedObject,n=t.DERSequence,i=t.DERObjectIdentifier;X.asn1.cms.ContentInfo.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];t.push(new i(e.type));var s=new r({tag:"a0",explicit:!0,obj:e.obj});return t.push(s),new n({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},null!=e&&this.setByParam(e)},He(X.asn1.cms.ContentInfo,X.asn1.ASN1Object),X.asn1.cms.SignedData=function(e){Error;var t=X.asn1,r=t.DERInteger,n=t.DERSet,i=t.DERSequence,s=t.cms,o=s.EncapsulatedContentInfo,a=s.SignerInfo,c=s.ContentInfo,u=s.CertificateSet,l=s.RevocationInfoChoices,h=t.x509.AlgorithmIdentifier;X.asn1.cms.SignedData.superclass.constructor.call(this),this.params=null,this.checkAndFixParam=function(){var e=this.params;this._setDigestAlgs(e),this._setContentTypeByEContent(e),this._setMessageDigestByEContent(e),this._setSignerInfoVersion(e),this._setSignedDataVersion(e)},this._setDigestAlgs=function(e){for(var t={},r=e.sinfos,n=0;n<r.length;n++)t[r[n].hashalg]=1;e.hashalgs=Object.keys(t).sort()},this._setContentTypeByEContent=function(e){for(var t=e.econtent.type,r=e.sinfos,n=0;n<r.length;n++)this._getAttrParamByName(r[n],"contentType").type=t},this._setMessageDigestByEContent=function(e){var t=e.econtent,r=t.content.hex;null==r&&"data"==t.type&&null!=t.content.str&&(r=me(t.content.str));for(var n=e.sinfos,i=0;i<n.length;i++){var s=n[i],o=s.hashalg,a=this._getAttrParamByName(s,"messageDigest"),c=X.crypto.Util.hashHex(r,o);a.hex=c}},this._getAttrParamByName=function(e,t){for(var r=e.sattrs.array,n=0;n<r.length;n++)if(r[n].attr==t)return r[n]},this._setSignerInfoVersion=function(e){for(var t=e.sinfos,r=0;r<t.length;r++){var n=t[r],i=1;"skid"==n.id.type&&(i=3),n.version=i}},this._setSignedDataVersion=function(e){var t=this._getSignedDataVersion(e);e.version=t},this._getSignedDataVersion=function(e){if(null!=e.revinfos)for(var t=e.revinfos,r=0;r<t.length;r++)if(null!=t[r].ocsp)return 5;var n=e.sinfos;for(r=0;r<n.length;r++)if(3==e.sinfos[r].version)return 3;return"data"!=e.econtent.type?3:1},this.tohex=function(){var e=this.params;null!=this.getEncodedHexPrepare&&this.getEncodedHexPrepare(),1!=e.fixed&&this.checkAndFixParam();var t=[];t.push(new r({int:e.version}));for(var s=[],c=0;c<e.hashalgs.length;c++)s.push(new h({name:e.hashalgs[c]}));t.push(new n({array:s})),t.push(new o(e.econtent)),null!=e.certs&&t.push(new u(e.certs)),null!=e.revinfos&&t.push(new l(e.revinfos));var d=[];for(c=0;c<e.sinfos.length;c++)d.push(new a(e.sinfos[c]));return t.push(new n({array:d})),new i({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.getContentInfo=function(){return new c({type:"signed-data",obj:this})},this.getContentInfoEncodedHex=function(){return this.getContentInfo().tohex()},null!=e&&this.setByParam(e)},He(X.asn1.cms.SignedData,X.asn1.ASN1Object),X.asn1.cms.CertificateSet=function(e){X.asn1.cms.CertificateSet.superclass.constructor.call(this);var t=Error,r=X.asn1,n=r.DERTaggedObject,i=r.DERSet,s=r.ASN1Object;this.params=null,this.tohex=function(){var e,r=this.params,o=[];if(r instanceof Array)e=r;else{if(null==r.array)throw new t("cert array not specified");e=r.array}for(var a=0;a<e.length;a++){var c=ve(e[a]),u=new s;u.hTLV=c,o.push(u)}var l={array:o};0==r.sortflag&&(l.sortflag=!1);var h=new i(l);return new n({tag:"a0",explicit:!1,obj:h}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},He(X.asn1.cms.CertificateSet,X.asn1.ASN1Object),X.asn1.cms.RevocationInfoChoices=function(e){X.asn1.cms.RevocationInfoChoices.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(!e instanceof Array)throw new Error("params is not array");for(var t=[],r=0;r<e.length;r++)t.push(new X.asn1.cms.RevocationInfoChoice(e[r]));return X.asn1.ASN1Util.newObject({tag:{tagi:"a1",obj:{set:t}}}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},He(X.asn1.cms.RevocationInfoChoices,X.asn1.ASN1Object),X.asn1.cms.RevocationInfoChoice=function(e){X.asn1.cms.RevocationInfoChoice.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(null!=e.crl&&"string"==typeof e.crl){var t=e.crl;return-1!=e.crl.indexOf("-----BEGIN")&&(t=ve(e.crl)),t}if(null!=e.ocsp)return X.asn1.ASN1Util.newObject({tag:{tagi:"a1",obj:new X.asn1.cms.OtherRevocationFormat(e)}}).tohex();throw new Error("property crl or ocsp undefined")},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},He(X.asn1.cms.RevocationInfoChoice,X.asn1.ASN1Object),X.asn1.cms.OtherRevocationFormat=function(e){X.asn1.cms.OtherRevocationFormat.superclass.constructor.call(this);var t=Error,r=X.asn1.ASN1Util.newObject,n=X.lang.String.isHex;this.params=null,this.tohex=function(){var e=this.params;if(null==e.ocsp)throw new t("property ocsp not specified");if(!n(e.ocsp)||!ee.isASN1HEX(e.ocsp))throw new t("ocsp value not ASN.1 hex string");return r({seq:[{oid:"1.3.6.1.5.5.7.16.2"},{asn1:{tlv:e.ocsp}}]}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},He(X.asn1.cms.OtherRevocationFormat,X.asn1.ASN1Object),X.asn1.cms.CMSUtil=new function(){},X.asn1.cms.CMSUtil.newSignedData=function(e){return new X.asn1.cms.SignedData(e)},X.asn1.cms.CMSUtil.verifySignedData=function(e){var t=ee.getVbyList,r=ee.getTLVbyList,n=ee.getIdxbyList,i=ee.getChildIdx,s=ee.getTLV,o=ee.oidname,a=X.crypto.Util.hashHex;void 0===e.cms&&(0,X.lang.String.isHex)(e.cms);var c=e.cms,u=function(e,s){var a=s.idx;s.signerid_issuer1=r(e,a,[1,0],"30"),s.signerid_serial1=t(e,a,[1,1],"02"),s.hashalg=o(t(e,a,[2,0],"06"));var c=n(e,a,[3],"a0");s.idxSignedAttrs=c,l(e,s,c);var u=i(e,a).length;if(u<6)throw"malformed SignerInfo";s.sigalg=o(t(e,a,[u-2,0],"06")),s.sigval=t(e,a,[u-1],"04")},l=function(e,r,n){var s=i(e,n);r.signedAttrIdxList=s;for(var o=0;o<s.length;o++){var a,c=s[o],u=t(e,c,[0],"06");"2a864886f70d010905"===u?(a=le(t(e,c,[1,0])),r.saSigningTime=a):"2a864886f70d010904"===u&&(a=t(e,c,[1,0],"04"),r.saMessageDigest=a)}},h=function(e,t,r,n){r.verifyDetail={};var o=r.verifyDetail,c=t.parse.econtent,u=r.hashalg,l=r.saMessageDigest;o.validMessageDigest=!1,a(c,u)===l&&(o.validMessageDigest=!0),function(e,t,r,n){var o,a=t.parse.certsIdx;if(void 0===t.certs){o=[],t.certkeys=[];for(var c=i(e,a),u=0;u<c.length;u++){var l=s(e,c[u]),h=new We;h.readCertHex(l),o[u]=h,t.certkeys[u]=h.getPublicKey()}t.certs=o}else o=t.certs;for(t.cccc=o.length,t.cccci=c.length,u=0;u<o.length;u++){var d=h.getIssuerHex(),m=h.getSerialNumberHex();r.signerid_issuer1===d&&r.signerid_serial1===m&&(r.certkey_idx=u)}}(e,t,r),o.validSignatureValue=!1;var h=r.sigalg,d="31"+s(e,r.idxSignedAttrs).substr(2);r.signedattrshex=d;var m=t.certs[r.certkey_idx].getPublicKey(),p=new X.crypto.Signature({alg:h});p.init(m),p.updateHex(d);var f=p.verify(r.sigval);o.validSignatureValue_isValid=f,!0===f&&(o.validSignatureValue=!0),r.isValid=!1,o.validMessageDigest&&o.validSignatureValue&&(r.isValid=!0)},d={isValid:!1,parse:{}};return function(e,r){if("2a864886f70d010702"!==t(e,0,[0],"06"))return r;r.cmsType="signedData",r.econtent=t(e,0,[1,0,2,1,0]),function(e,t){for(var r,i=3;i<6;i++)if(void 0!==(r=n(e,0,[1,0,i]))){var s=e.substr(r,2);"a0"===s&&(t.certsIdx=r),"a1"===s&&(t.revinfosIdx=r),"31"===s&&(t.signerinfosIdx=r)}}(e,r),r.signerInfos=[],function(e,t){var r=t.signerinfosIdx;if(void 0!==r){var n=i(e,r);t.signerInfoIdxList=n;for(var s=0;s<n.length;s++){var o={idx:n[s]};u(e,o),t.signerInfos.push(o)}}}(e,r)}(c,d.parse),function(e,t){for(var r=t.parse.signerInfos,n=r.length,i=!0,s=0;s<n;s++){var o=r[s];h(e,t,o),o.isValid||(i=!1)}t.isValid=i}(c,d),d},X.asn1.cms.CMSParser=function(){var e=Error,t=We,r=new t,n=ee,i=n.getV,s=n.getTLV,o=n.getTLVbyList,a=n.getTLVbyListEx,c=n.getVbyList,u=n.getVbyListEx,l=n.getChildIdx;this.getCMSSignedData=function(e){var t=o(e,0,[1,0]);return this.getSignedData(t)},this.getSignedData=function(e){var t=l(e,0),r={},n=i(e,t[0]),o=parseInt(n,16);r.version=o;var c=s(e,t[1]);r.hashalgs=this.getHashAlgArray(c);var u=s(e,t[2]);r.econtent=this.getEContent(u);var h=a(e,0,["[0]"]);null!=h&&(r.certs=this.getCertificateSet(h)),a(e,0,["[1]"]);var d=a(e,0,[3]);return r.sinfos=this.getSignerInfos(d),r},this.getHashAlgArray=function(e){for(var r=l(e,0),n=new t,i=[],o=0;o<r.length;o++){var a=s(e,r[o]),c=n.getAlgorithmIdentifierName(a);i.push(c)}return i},this.getEContent=function(e){var t={},r=c(e,0,[0]),n=c(e,0,[1,0]);return t.type=X.asn1.x509.OID.oid2name(ee.hextooidstr(r)),t.content={hex:n},t},this.getSignerInfos=function(e){for(var t=[],r=l(e,0),n=0;n<r.length;n++){var i=s(e,r[n]),o=this.getSignerInfo(i);t.push(o)}return t},this.getSignerInfo=function(e){var t={},i=l(e,0),o=n.getInt(e,i[0],-1);-1!=o&&(t.version=o);var c=s(e,i[1]),h=this.getIssuerAndSerialNumber(c);t.id=h;var d=s(e,i[2]),m=r.getAlgorithmIdentifierName(d);t.hashalg=m;var p=a(e,0,["[0]"]);if(null!=p){var f=this.getAttributeList(p);t.sattrs=f}var g=a(e,0,[3]),y=r.getAlgorithmIdentifierName(g);t.sigalg=y;var v=u(e,0,[4]);t.sighex=v;var b=a(e,0,["[1]"]);if(null!=b){var S=this.getAttributeList(b);t.uattrs=S}return t},this.getSignerIdentifier=function(e){if("30"==e.substr(0,2))return this.getIssuerAndSerialNumber(e);throw new Error("SKID of signerIdentifier not supported")},this.getIssuerAndSerialNumber=function(e){var t={type:"isssn"},n=l(e,0),o=s(e,n[0]);t.issuer=r.getX500Name(o);var a=i(e,n[1]);return t.serial={hex:a},t},this.getAttributeList=function(e){for(var t=[],r=l(e,0),n=0;n<r.length;n++){var i=s(e,r[n]),o=this.getAttribute(i);t.push(o)}return{array:t}},this.getAttribute=function(e){var t={},r=l(e,0),i=n.getOID(e,r[0]),o=X.asn1.x509.OID.oid2name(i);t.attr=o;var a=s(e,r[1]),c=l(a,0);if(1==c.length)t.valhex=s(a,c[0]);else{for(var u=[],h=0;h<c.length;h++)u.push(s(a,c[h]));t.valhex=u}return"contentType"==o?this.setContentType(t):"messageDigest"==o?this.setMessageDigest(t):"signingTime"==o?this.setSigningTime(t):"signingCertificate"==o?this.setSigningCertificate(t):"signingCertificateV2"==o?this.setSigningCertificateV2(t):"signaturePolicyIdentifier"==o&&this.setSignaturePolicyIdentifier(t),t},this.setContentType=function(e){var t=n.getOIDName(e.valhex,0,null);null!=t&&(e.type=t,delete e.valhex)},this.setSigningTime=function(e){var t=le(i(e.valhex,0));e.str=t,delete e.valhex},this.setMessageDigest=function(e){var t=i(e.valhex,0);e.hex=t,delete e.valhex},this.setSigningCertificate=function(e){var t=l(e.valhex,0);if(t.length>0){for(var r=s(e.valhex,t[0]),n=l(r,0),i=[],o=0;o<n.length;o++){var a=s(r,n[o]),c=this.getESSCertID(a);i.push(c)}e.array=i}if(t.length>1){var u=s(e.valhex,t[1]);e.polhex=u}delete e.valhex},this.setSignaturePolicyIdentifier=function(e){var r=l(e.valhex,0);if(r.length>0){var o=n.getOID(e.valhex,r[0]);e.oid=o}if(r.length>1){var a=new t,c=l(e.valhex,r[1]),u=s(e.valhex,c[0]),h=a.getAlgorithmIdentifierName(u);e.alg=h;var d=i(e.valhex,c[1]);e.hash=d}delete e.valhex},this.setSigningCertificateV2=function(e){var t=l(e.valhex,0);if(t.length>0){for(var r=s(e.valhex,t[0]),n=l(r,0),i=[],o=0;o<n.length;o++){var a=s(r,n[o]),c=this.getESSCertIDv2(a);i.push(c)}e.array=i}if(t.length>1){var u=s(e.valhex,t[1]);e.polhex=u}delete e.valhex},this.getESSCertID=function(e){var t={},r=l(e,0);if(r.length>0){var n=i(e,r[0]);t.hash=n}if(r.length>1){var o=s(e,r[1]),a=this.getIssuerSerial(o);null!=a.serial&&(t.serial=a.serial),null!=a.issuer&&(t.issuer=a.issuer)}return t},this.getESSCertIDv2=function(t){var n={},o=l(t,0);if(o.length<1||3<o.length)throw new e("wrong number of elements");var a=0;if("30"==t.substr(o[0],2)){var c=s(t,o[0]);n.alg=r.getAlgorithmIdentifierName(c),a++}else n.alg="sha256";var u=i(t,o[a]);if(n.hash=u,o.length>a+1){var h=s(t,o[a+1]),d=this.getIssuerSerial(h);n.issuer=d.issuer,n.serial=d.serial}return n},this.getIssuerSerial=function(e){var t={},n=l(e,0),o=s(e,n[0]),a=r.getGeneralNames(o);t.issuer=a[0].dn;var c=i(e,n[1]);return t.serial={hex:c},t},this.getCertificateSet=function(e){for(var t=l(e,0),r=[],n=0;n<t.length;n++){var i=s(e,t[n]);if("30"==i.substr(0,2)){var o=ye(i,"CERTIFICATE");r.push(o)}}return{array:r,sortflag:!1}}},void 0!==X&&X||(X={}),void 0!==X.asn1&&X.asn1||(X.asn1={}),void 0!==X.asn1.tsp&&X.asn1.tsp||(X.asn1.tsp={}),X.asn1.tsp.TimeStampToken=function(e){var t=X.asn1.tsp;t.TimeStampToken.superclass.constructor.call(this),this.params=null,this.getEncodedHexPrepare=function(){var e=new t.TSTInfo(this.params.econtent.content);this.params.econtent.content.hex=e.tohex()},null!=e&&this.setByParam(e)},He(X.asn1.tsp.TimeStampToken,X.asn1.cms.SignedData),X.asn1.tsp.TSTInfo=function(e){Error;var t=X.asn1,r=t.DERSequence,n=t.DERInteger,i=t.DERBoolean,s=t.DERGeneralizedTime,o=t.DERObjectIdentifier,a=t.DERTaggedObject,c=t.tsp,u=c.MessageImprint,l=c.Accuracy,h=t.x509.GeneralName;if(c.TSTInfo.superclass.constructor.call(this),this.dVersion=new n({int:1}),this.dPolicy=null,this.dMessageImprint=null,this.dSerial=null,this.dGenTime=null,this.dAccuracy=null,this.dOrdering=null,this.dNonce=null,this.dTsa=null,this.tohex=function(){var e=[this.dVersion];if(null==this.dPolicy)throw new Error("policy shall be specified.");if(e.push(this.dPolicy),null==this.dMessageImprint)throw new Error("messageImprint shall be specified.");if(e.push(this.dMessageImprint),null==this.dSerial)throw new Error("serialNumber shall be specified.");if(e.push(this.dSerial),null==this.dGenTime)throw new Error("genTime shall be specified.");e.push(this.dGenTime),null!=this.dAccuracy&&e.push(this.dAccuracy),null!=this.dOrdering&&e.push(this.dOrdering),null!=this.dNonce&&e.push(this.dNonce),null!=this.dTsa&&e.push(this.dTsa);var t=new r({array:e});return this.hTLV=t.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e){if("string"==typeof e.policy){if(!e.policy.match(/^[0-9.]+$/))throw"policy shall be oid like 0.1.4.134";this.dPolicy=new o({oid:e.policy})}void 0!==e.messageImprint&&(this.dMessageImprint=new u(e.messageImprint)),void 0!==e.serial&&(this.dSerial=new n(e.serial)),void 0!==e.genTime&&(this.dGenTime=new s(e.genTime)),void 0!==e.accuracy&&(this.dAccuracy=new l(e.accuracy)),void 0!==e.ordering&&1==e.ordering&&(this.dOrdering=new i),void 0!==e.nonce&&(this.dNonce=new n(e.nonce)),void 0!==e.tsa&&(this.dTsa=new a({tag:"a0",explicit:!0,obj:new h({dn:e.tsa})}))}},He(X.asn1.tsp.TSTInfo,X.asn1.ASN1Object),X.asn1.tsp.Accuracy=function(e){var t=X.asn1,r=t.ASN1Util.newObject;t.tsp.Accuracy.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];return null!=e.seconds&&"number"==typeof e.seconds&&t.push({int:e.seconds}),null!=e.millis&&"number"==typeof e.millis&&t.push({tag:{tagi:"80",obj:{int:e.millis}}}),null!=e.micros&&"number"==typeof e.micros&&t.push({tag:{tagi:"81",obj:{int:e.micros}}}),r({seq:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},He(X.asn1.tsp.Accuracy,X.asn1.ASN1Object),X.asn1.tsp.MessageImprint=function(e){var t=X.asn1,r=t.DERSequence,n=t.DEROctetString,i=t.x509.AlgorithmIdentifier;t.tsp.MessageImprint.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=new i({name:e.alg}),s=new n({hex:e.hash});return new r({array:[t,s]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},He(X.asn1.tsp.MessageImprint,X.asn1.ASN1Object),X.asn1.tsp.TimeStampReq=function(e){var t=X.asn1,r=t.DERSequence,n=t.DERInteger,i=t.DERBoolean,s=t.DERObjectIdentifier,o=t.tsp,a=o.MessageImprint;o.TimeStampReq.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];return t.push(new n({int:1})),t.push(e.messageImprint instanceof X.asn1.ASN1Object?e.messageImprint:new a(e.messageImprint)),null!=e.policy&&t.push(new s(e.policy)),null!=e.nonce&&t.push(new n(e.nonce)),1==e.certreq&&t.push(new i),new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},He(X.asn1.tsp.TimeStampReq,X.asn1.ASN1Object),X.asn1.tsp.TimeStampResp=function(e){var t=X.asn1,r=t.DERSequence,n=t.tsp,i=n.PKIStatusInfo;n.TimeStampResp.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,s=[];if(null!=e.econtent||null!=e.tst)if(s.push(new i(null!=e.statusinfo?e.statusinfo:"granted")),null!=e.econtent)s.push(new n.TimeStampToken(e).getContentInfo());else{if(!(e.tst instanceof t.ASN1Object))throw new Error("improper member tst value");s.push(e.tst)}else{if(null==e.statusinfo)throw new Error("parameter for token nor statusinfo not specified");s.push(new i(e.statusinfo))}return new r({array:s}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},He(X.asn1.tsp.TimeStampResp,X.asn1.ASN1Object),X.asn1.tsp.PKIStatusInfo=function(e){var t=Error,r=X.asn1,n=r.DERSequence,i=r.tsp,s=i.PKIStatus,o=i.PKIFreeText,a=i.PKIFailureInfo;i.PKIStatusInfo.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,r=[];if("string"==typeof e)r.push(new s(e));else{if(null==e.status)throw new t("property 'status' unspecified");r.push(new s(e.status)),null!=e.statusstr&&r.push(new o(e.statusstr)),null!=e.failinfo&&r.push(new a(e.failinfo))}return new n({array:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},He(X.asn1.tsp.PKIStatusInfo,X.asn1.ASN1Object),X.asn1.tsp.PKIStatus=function(e){var t=Error,r=X.asn1,n=r.DERInteger;r.tsp.PKIStatus.superclass.constructor.call(this);var i={granted:0,grantedWithMods:1,rejection:2,waiting:3,revocationWarning:4,revocationNotification:5};this.params=null,this.tohex=function(){var e,r=this.params;if("string"==typeof r)try{e=i[r]}catch(e){throw new t("undefined name: "+r)}else{if("number"!=typeof r)throw new t("unsupported params");e=r}return new n({int:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},He(X.asn1.tsp.PKIStatus,X.asn1.ASN1Object),X.asn1.tsp.PKIFreeText=function(e){var t=Error,r=X.asn1,n=r.DERSequence,i=r.DERUTF8String;r.tsp.PKIFreeText.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(!e instanceof Array)throw new t("wrong params: not array");for(var r=[],s=0;s<e.length;s++)r.push(new i({str:e[s]}));return new n({array:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},He(X.asn1.tsp.PKIFreeText,X.asn1.ASN1Object),X.asn1.tsp.PKIFailureInfo=function(e){var t=Error,r=X.asn1,n=r.DERBitString,i={badAlg:0,badRequest:2,badDataFormat:5,timeNotAvailable:14,unacceptedPolicy:15,unacceptedExtension:16,addInfoNotAvailable:17,systemFailure:25};r.tsp.PKIFailureInfo.superclass.constructor.call(this),this.params=null,this.getBinValue=function(){var e=this.params,r=0;if("number"==typeof e&&0<=e&&e<=25){for(var n=(r|=1<<e).toString(2),s="",o=n.length-1;o>=0;o--)s+=n[o];return s}if("string"==typeof e&&null!=i[e])return _e([e],i);if("object"==typeof e&&null!=e.length)return _e(e,i);throw new t("wrong params")},this.tohex=function(){var e=this.getBinValue();return new n({bin:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},He(X.asn1.tsp.PKIFailureInfo,X.asn1.ASN1Object),X.asn1.tsp.AbstractTSAAdapter=function(e){this.getTSTHex=function(e,t){throw"not implemented yet"}},X.asn1.tsp.SimpleTSAAdapter=function(e){var t=X.asn1.tsp,r=X.crypto.Util.hashHex;t.SimpleTSAAdapter.superclass.constructor.call(this),this.params=null,this.serial=0,this.getTSTHex=function(e,n){var i=r(e,n);this.params.econtent.content.messageImprint={alg:n,hash:i},this.params.econtent.content.serial={int:this.serial++};var s=Math.floor(1e9*Math.random());return this.params.econtent.content.nonce={int:s},new t.TimeStampToken(this.params).getContentInfoEncodedHex()},void 0!==e&&(this.params=e)},He(X.asn1.tsp.SimpleTSAAdapter,X.asn1.tsp.AbstractTSAAdapter),X.asn1.tsp.FixedTSAAdapter=function(e){var t=X.asn1.tsp,r=X.crypto.Util.hashHex;t.FixedTSAAdapter.superclass.constructor.call(this),this.params=null,this.getTSTHex=function(e,n){var i=r(e,n);return this.params.econtent.content.messageImprint={alg:n,hash:i},new t.TimeStampToken(this.params).getContentInfoEncodedHex()},void 0!==e&&(this.params=e)},He(X.asn1.tsp.FixedTSAAdapter,X.asn1.tsp.AbstractTSAAdapter),X.asn1.tsp.TSPUtil=new function(){},X.asn1.tsp.TSPUtil.newTimeStampToken=function(e){return new X.asn1.tsp.TimeStampToken(e)},X.asn1.tsp.TSPUtil.parseTimeStampReq=function(e){return(new X.asn1.tsp.TSPParser).getTimeStampReq(e)},X.asn1.tsp.TSPUtil.parseMessageImprint=function(e){return(new X.asn1.tsp.TSPParser).getMessageImprint(e)},X.asn1.tsp.TSPParser=function(){Error;var e=new We,t=ee,r=t.getV,n=t.getTLV,i=t.getIdxbyList,s=t.getChildIdx,o=["granted","grantedWithMods","rejection","waiting","revocationWarning","revocationNotification"],a={0:"badAlg",2:"badRequest",5:"badDataFormat",14:"timeNotAvailable",15:"unacceptedPolicy",16:"unacceptedExtension",17:"addInfoNotAvailable",25:"systemFailure"};this.getResponse=function(e){var t=s(e,0);if(1==t.length)return this.getPKIStatusInfo(n(e,t[0]));if(t.length>1){var r=this.getPKIStatusInfo(n(e,t[0])),i=n(e,t[1]),o=this.getToken(i);return o.statusinfo=r,o}},this.getToken=function(e){var t=(new X.asn1.cms.CMSParser).getCMSSignedData(e);return this.setTSTInfo(t),t},this.setTSTInfo=function(e){var t=e.econtent;if("tstinfo"==t.type){var r=this.getTSTInfo(t.content.hex);t.content=r}},this.getTSTInfo=function(t){var i={},o=s(t,0),a=r(t,o[1]);i.policy=Fe(a);var c=n(t,o[2]);i.messageImprint=this.getMessageImprint(c);var u=r(t,o[3]);i.serial={hex:u};var l=r(t,o[4]);i.genTime={str:le(l)};var h=0;if(o.length>5&&"30"==t.substr(o[5],2)){var d=n(t,o[5]);i.accuracy=this.getAccuracy(d),h++}if(o.length>5+h&&"01"==t.substr(o[5+h],2)&&("ff"==r(t,o[5+h])&&(i.ordering=!0),h++),o.length>5+h&&"02"==t.substr(o[5+h],2)){var m=r(t,o[5+h]);i.nonce={hex:m},h++}if(o.length>5+h&&"a0"==t.substr(o[5+h],2)){var p=n(t,o[5+h]);p="30"+p.substr(2),pGeneralNames=e.getGeneralNames(p);var f=pGeneralNames[0].dn;i.tsa=f,h++}if(o.length>5+h&&"a1"==t.substr(o[5+h],2)){var g=n(t,o[5+h]);g="30"+g.substr(2);var y=e.getExtParamArray(g);i.ext=y,h++}return i},this.getAccuracy=function(e){for(var t={},n=s(e,0),i=0;i<n.length;i++){var o=e.substr(n[i],2),a=r(e,n[i]),c=parseInt(a,16);"02"==o?t.seconds=c:"80"==o?t.millis=c:"81"==o&&(t.micros=c)}return t},this.getMessageImprint=function(e){if("30"!=e.substr(0,2))throw new Error("head of messageImprint hex shall be x30");var n={},o=(s(e,0),i(e,0,[0,0])),a=r(e,o),c=t.hextooidstr(a),u=X.asn1.x509.OID.oid2name(c);if(""==u)throw new Error("hashAlg name undefined: "+c);var l=u,h=i(e,0,[1]);return n.alg=l,n.hash=r(e,h),n},this.getPKIStatusInfo=function(e){var t={},i=s(e,0),a=0;try{var c=r(e,i[0]),u=parseInt(c,16);t.status=o[u]}catch(e){}if(i.length>1&&"30"==e.substr(i[1],2)){var l=n(e,i[1]);t.statusstr=this.getPKIFreeText(l),a++}if(i.length>a&&"03"==e.substr(i[1+a],2)){var h=n(e,i[1+a]);t.failinfo=this.getPKIFailureInfo(h)}return t},this.getPKIFreeText=function(e){for(var r=[],n=s(e,0),i=0;i<n.length;i++)r.push(t.getString(e,n[i]));return r},this.getPKIFailureInfo=function(e){var r=t.getInt(e,0);return null!=a[r]?a[r]:r},this.getTimeStampReq=function(e){var i={certreq:!1},o=s(e,0);if(o.length<2)throw new Error("TimeStampReq must have at least 2 items");var a=n(e,o[1]);i.messageImprint=X.asn1.tsp.TSPUtil.parseMessageImprint(a);for(var c=2;c<o.length;c++){var u=o[c],l=e.substr(u,2);if("06"==l){var h=r(e,u);i.policy=t.hextooidstr(h)}"02"==l&&(i.nonce=r(e,u)),"01"==l&&(i.certreq=!0)}return i}},void 0!==X&&X||(X={}),void 0!==X.asn1&&X.asn1||(X.asn1={}),void 0!==X.asn1.cades&&X.asn1.cades||(X.asn1.cades={}),X.asn1.cades.SignaturePolicyIdentifier=function(e){var t=X.asn1.cades,r=t.SignaturePolicyId;t.SignaturePolicyIdentifier.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.15",this.params=null,this.getValueArray=function(){return[new r(this.params)]},this.setByParam=function(e){this.params=e},null!=e&&this.setByParam(e)},He(X.asn1.cades.SignaturePolicyIdentifier,X.asn1.cms.Attribute),X.asn1.cades.SignaturePolicyId=function(e){var t=X.asn1,r=t.DERSequence,n=t.DERObjectIdentifier,i=t.cades,s=i.OtherHashAlgAndValue;i.SignaturePolicyId.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];return t.push(new n(e.oid)),t.push(new s(e)),new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},null!=e&&this.setByParam(e)},He(X.asn1.cades.SignaturePolicyId,X.asn1.ASN1Object),X.asn1.cades.OtherHashAlgAndValue=function(e){var t=Error,r=X.asn1,n=r.DERSequence,i=r.DEROctetString,s=r.x509.AlgorithmIdentifier;r.cades.OtherHashAlgAndValue.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(null==e.alg)throw new t("property 'alg' not specified");if(null==e.hash&&null==e.cert)throw new t("property 'hash' nor 'cert' not specified");var r=null;if(null!=e.hash)r=e.hash;else if(null!=e.cert){if("string"!=typeof e.cert)throw new t("cert not string");var o=e.cert;-1!=e.cert.indexOf("-----BEGIN")&&(o=ve(e.cert)),r=X.crypto.Util.hashHex(o,e.alg)}var a=[];return a.push(new s({name:e.alg})),a.push(new i({hex:r})),new n({array:a}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},He(X.asn1.cades.OtherHashAlgAndValue,X.asn1.ASN1Object),X.asn1.cades.OtherHashValue=function(e){X.asn1.cades.OtherHashValue.superclass.constructor.call(this);var t=Error,r=X.asn1.DEROctetString;this.params=null,this.tohex=function(){var e=this.params;if(null==e.hash&&null==e.cert)throw new t("hash or cert not specified");var n=null;if(null!=e.hash)n=e.hash;else if(null!=e.cert){if("string"!=typeof e.cert)throw new t("cert not string");var i=e.cert;-1!=e.cert.indexOf("-----BEGIN")&&(i=ve(e.cert)),n=X.crypto.Util.hashHex(i,"sha1")}return new r({hex:n}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},He(X.asn1.cades.OtherHashValue,X.asn1.ASN1Object),X.asn1.cades.SignatureTimeStamp=function(e){var t=Error,r=X.lang.String.isHex,n=X.asn1,i=n.ASN1Object;n.cades.SignatureTimeStamp.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.14",this.params=null,this.getValueArray=function(){var e=this.params;if(null!=e.tst){if(r(e.tst))return(n=new i).hTLV=e.tst,[n];if(e.tst instanceof i)return[e.tst];throw new t("params.tst has wrong value")}if(null!=e.res){var n,s=e.res;if(s instanceof i&&(s=s.tohex()),"string"!=typeof s||!r(s))throw new t("params.res has wrong value");return ee.getTLVbyList(s,0,[1]),(n=new i).hTLV=e.tst,[n]}},null!=e&&this.setByParam(e)},He(X.asn1.cades.SignatureTimeStamp,X.asn1.cms.Attribute),X.asn1.cades.CompleteCertificateRefs=function(e){var t=Error,r=X.asn1,n=r.DERSequence,i=r.cades,s=i.OtherCertID,o=X.lang.String.isHex;i.CompleteCertificateRefs.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.21",this.params=null,this.getValueArray=function(){for(var e=this.params,r=[],i=0;i<e.array.length;i++){var a=e.array[i];if("string"==typeof a)if(-1!=a.indexOf("-----BEGIN"))a={cert:a};else{if(!o(a))throw new t("unsupported value: "+a);a={hash:a}}null!=e.alg&&null==a.alg&&(a.alg=e.alg),null!=e.hasis&&null==a.hasis&&(a.hasis=e.hasis);var c=new s(a);r.push(c)}return[new n({array:r})]},null!=e&&this.setByParam(e)},He(X.asn1.cades.CompleteCertificateRefs,X.asn1.cms.Attribute),X.asn1.cades.OtherCertID=function(e){var t=X.asn1,r=t.DERSequence,n=t.cms.IssuerSerial,i=t.cades,s=i.OtherHashValue,o=i.OtherHashAlgAndValue;i.OtherCertID.superclass.constructor.call(this),this.params=e,this.tohex=function(){var e=this.params;"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?e={cert:e}:_isHex(e)&&(e={hash:e}));var t,i=[];if(t=null!=e.alg?new o(e):new s(e),i.push(t),null!=e.cert&&1==e.hasis||null!=e.issuer&&null!=e.serial){var a=new n(e);i.push(a)}return new r({array:i}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},He(X.asn1.cades.OtherCertID,X.asn1.ASN1Object),X.asn1.cades.OtherHash=function(e){Error;var t=X.asn1.cades,r=t.OtherHashAlgAndValue,n=t.OtherHashValue,i=X.lang.String.isHex;t.OtherHash.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;return"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?e={cert:e}:i(e)&&(e={hash:e})),(null!=e.alg?new r(e):new n(e)).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},He(X.asn1.cades.OtherHash,X.asn1.ASN1Object),X.asn1.cades.CAdESUtil=new function(){},X.asn1.cades.CAdESUtil.parseSignedDataForAddingUnsigned=function(e){return(new X.asn1.cms.CMSParser).getCMSSignedData(e)},X.asn1.cades.CAdESUtil.parseSignerInfoForAddingUnsigned=function(e,t,r){var n=ee.getTLV,i=ee.getV,s=X.asn1,o=s.ASN1Object,a=s.cms,c=a.AttributeList,u=a.SignerInfo,l={},h=(0,ee.getChildIdx)(e,t);if(6!=h.length)throw"not supported items for SignerInfo (!=6)";var d=h.shift();l.version=n(e,d);var m=h.shift();l.si=n(e,m);var p=h.shift();l.digalg=n(e,p);var f=h.shift();l.sattrs=n(e,f);var g=h.shift();l.sigalg=n(e,g);var y=h.shift();l.sig=n(e,y),l.sigval=i(e,y);var v=null;return l.obj=new u,(v=new o).hTLV=l.version,l.obj.dCMSVersion=v,(v=new o).hTLV=l.si,l.obj.dSignerIdentifier=v,(v=new o).hTLV=l.digalg,l.obj.dDigestAlgorithm=v,(v=new o).hTLV=l.sattrs,l.obj.dSignedAttrs=v,(v=new o).hTLV=l.sigalg,l.obj.dSigAlg=v,(v=new o).hTLV=l.sig,l.obj.dSig=v,l.obj.dUnsignedAttrs=new c,l},void 0!==X.asn1.csr&&X.asn1.csr||(X.asn1.csr={}),X.asn1.csr.CertificationRequest=function(e){var t=X.asn1,r=t.DERBitString,n=t.DERSequence,i=t.csr,s=i.CertificationRequestInfo;i.CertificationRequest.superclass.constructor.call(this),this.setByParam=function(e){this.params=e},this.sign=function(){var e=new s(this.params).tohex(),t=new X.crypto.Signature({alg:this.params.sigalg});t.init(this.params.sbjprvkey),t.updateHex(e);var r=t.sign();this.params.sighex=r},this.getPEM=function(){return ye(this.tohex(),"CERTIFICATE REQUEST")},this.tohex=function(){var e=this.params,t=new X.asn1.csr.CertificationRequestInfo(this.params),i=new X.asn1.x509.AlgorithmIdentifier({name:e.sigalg});if(null==e.sighex&&null!=e.sbjprvkey&&this.sign(),null==e.sighex)throw new Error("sighex or sbjprvkey parameter not defined");var s=new r({hex:"00"+e.sighex});return new n({array:[t,i,s]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},He(X.asn1.csr.CertificationRequest,X.asn1.ASN1Object),X.asn1.csr.CertificationRequestInfo=function(e){var t=X.asn1,r=t.DERSequence,n=t.DERInteger,i=t.DERUTF8String,s=t.DERTaggedObject,o=t.ASN1Util.newObject,a=t.x509,c=a.X500Name,u=a.Extensions,l=a.SubjectPublicKeyInfo;t.csr.CertificationRequestInfo.superclass.constructor.call(this),this.params=null,this.setByParam=function(e){null!=e&&(this.params=e)},this.tohex=function(){var e=this.params,t=[];if(t.push(new n({int:0})),t.push(new c(e.subject)),t.push(new l(Ve.getKey(e.sbjpubkey))),null!=e.extreq){var a=new u(e.extreq),h=o({tag:{tag:"a0",explict:!0,obj:{seq:[{oid:"1.2.840.113549.1.9.14"},{set:[a]}]}}});t.push(h)}else t.push(new s({tag:"a0",explicit:!1,obj:new i({str:""})}));return new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},He(X.asn1.csr.CertificationRequestInfo,X.asn1.ASN1Object),X.asn1.csr.CSRUtil=new function(){},X.asn1.csr.CSRUtil.newCSRPEM=function(e){return new X.asn1.csr.CertificationRequest(e).getPEM()},X.asn1.csr.CSRUtil.getParam=function(e,t){var r=ee.getV,n=ee.getIdxbyList,i=ee.getTLVbyList,s=ee.getTLVbyListEx,o=ee.getVbyListEx,a={};if(-1==e.indexOf("-----BEGIN CERTIFICATE REQUEST"))throw new Error("argument is not PEM file");var c=ve(e,"CERTIFICATE REQUEST");t&&(a.tbs=i(c,0,[0]));try{var u=s(c,0,[0,1]);if("3000"==u)a.subject={};else{var l=new We;a.subject=l.getX500Name(u)}}catch(e){}var h=s(c,0,[0,2]),d=Ve.getKey(h,null,"pkcs8pub");a.sbjpubkey=Ve.getPEM(d,"PKCS8PUB");var m=function(e){var t=n(e,0,[0,3,0,0],"06");return"2a864886f70d01090e"!=r(e,t)?null:i(e,0,[0,3,0,1,0],"30")}(c);l=new We,null!=m&&(a.extreq=l.getExtParamArray(m));try{var p=s(c,0,[1],"30");l=new We,a.sigalg=l.getAlgorithmIdentifierName(p)}catch(e){}try{var f=o(c,0,[2]);a.sighex=f}catch(e){}return a},X.asn1.csr.CSRUtil.verifySignature=function(e){try{var t=null;if("string"==typeof e&&-1!=e.indexOf("-----BEGIN CERTIFICATE REQUEST")?t=X.asn1.csr.CSRUtil.getParam(e,!0):"object"==typeof e&&null!=e.sbjpubkey&&null!=e.sigalg&&null!=e.sighex&&null!=e.tbs&&(t=e),null==t)return!1;var r=new X.crypto.Signature({alg:t.sigalg});return r.init(t.sbjpubkey),r.updateHex(t.tbs),r.verify(t.sighex)}catch(e){return alert(e),!1}},void 0!==X&&X||(X={}),void 0!==X.asn1&&X.asn1||(X.asn1={}),void 0!==X.asn1.ocsp&&X.asn1.ocsp||(X.asn1.ocsp={}),X.asn1.ocsp.DEFAULT_HASH="sha1",X.asn1.ocsp.OCSPResponse=function(e){X.asn1.ocsp.OCSPResponse.superclass.constructor.call(this);var t=X.asn1.ASN1Util.newObject,r=X.asn1.ocsp.ResponseBytes,n=["successful","malformedRequest","internalError","tryLater","_not_used_","sigRequired","unauthorized"];this.params=null,this._getStatusCode=function(){var e=this.params.resstatus;return"number"==typeof e?e:"string"!=typeof e?-1:n.indexOf(e)},this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params,n=this._getStatusCode();if(-1==n)throw new Error("responseStatus not supported: "+e.resstatus);if(0!=n)return t({seq:[{enum:{int:n}}]}).tohex();var i=new r(e);return t({seq:[{enum:{int:0}},{tag:{tag:"a0",explicit:!0,obj:i}}]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},He(X.asn1.ocsp.OCSPResponse,X.asn1.ASN1Object),X.asn1.ocsp.ResponseBytes=function(e){X.asn1.ocsp.ResponseBytes.superclass.constructor.call(this);var t=X.asn1,r=t.DERSequence,n=t.DERObjectIdentifier,i=t.DEROctetString,s=t.ocsp.BasicOCSPResponse;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params;if("ocspBasic"!=e.restype)throw new Error("not supported responseType: "+e.restype);var t=new s(e),o=[];return o.push(new n({name:"ocspBasic"})),o.push(new i({hex:t.tohex()})),new r({array:o}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},He(X.asn1.ocsp.ResponseBytes,X.asn1.ASN1Object),X.asn1.ocsp.BasicOCSPResponse=function(e){X.asn1.ocsp.BasicOCSPResponse.superclass.constructor.call(this);var t=Error,r=X.asn1,n=r.ASN1Object,i=r.DERSequence,s=r.DERTaggedObject,o=r.DERBitString,a=r.x509.AlgorithmIdentifier,c=r.ocsp;_SingleResponseList=c.SingleResponseList,_ResponseData=c.ResponseData,this.params=null,this.setByParam=function(e){this.params=e},this.sign=function(){var e=this.params,t=e.tbsresp.tohex(),r=new X.crypto.Signature({alg:e.sigalg});r.init(e.reskey),r.updateHex(t),e.sighex=r.sign()},this.tohex=function(){var e=this.params;null==e.tbsresp&&(e.tbsresp=new _ResponseData(e)),null==e.sighex&&null!=e.reskey&&this.sign();var r=[];if(r.push(e.tbsresp),r.push(new a({name:e.sigalg})),r.push(new o({hex:"00"+e.sighex})),null!=e.certs&&null!=e.certs.length){for(var c=[],u=0;u<e.certs.length;u++){var l=e.certs[u],h=null;if(ee.isASN1HEX(l))h=l;else{if(!l.match(/-----BEGIN/))throw new t("certs["+u+"] not hex or PEM");h=ve(l)}c.push(new n({tlv:h}))}var d=new i({array:c});r.push(new s({tag:"a0",explicit:!0,obj:d}))}return new i({array:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},He(X.asn1.ocsp.BasicOCSPResponse,X.asn1.ASN1Object),X.asn1.ocsp.ResponseData=function(e){X.asn1.ocsp.ResponseData.superclass.constructor.call(this);var t=Error,r=X.asn1,n=r.DERSequence,i=r.DERGeneralizedTime,s=r.DERTaggedObject,o=r.x509.Extensions,a=r.ocsp,c=a.ResponderID;_SingleResponseList=a.SingleResponseList,this.params=null,this.tohex=function(){var e=this.params;null!=e.respid&&new t("respid not specified"),null!=e.prodat&&new t("prodat not specified"),null!=e.array&&new t("array not specified");var r=[];if(r.push(new c(e.respid)),r.push(new i(e.prodat)),r.push(new _SingleResponseList(e.array)),null!=e.ext){var a=new o(e.ext);r.push(new s({tag:"a1",explicit:!0,obj:a}))}return new n({array:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},He(X.asn1.ocsp.ResponseData,X.asn1.ASN1Object),X.asn1.ocsp.ResponderID=function(e){X.asn1.ocsp.ResponderID.superclass.constructor.call(this);var t=X.asn1,r=t.ASN1Util.newObject,n=t.x509.X500Name,i=X.lang.String.isHex,s=Error;this.params=null,this.tohex=function(){var e=this.params;if(null!=e.key){var t,o=null;if("string"==typeof e.key?(i(e.key)&&(o=e.key),e.key.match(/-----BEGIN CERTIFICATE/)&&null!=(t=new We(e.key).getExtSubjectKeyIdentifier())&&(o=t.kid.hex)):e.key instanceof We&&null!=(t=e.key.getExtSubjectKeyIdentifier())&&(o=t.kid.hex),null==o)throw new s("wrong key member value");return r({tag:{tag:"a2",explicit:!0,obj:{octstr:{hex:o}}}}).tohex()}if(null!=e.name){var a=null;if("string"==typeof e.name&&e.name.match(/-----BEGIN CERTIFICATE/)?a=new We(e.name).getSubject():e.name instanceof We?a=e.name.getSubject():"object"!=typeof e.name||null==e.name.array&&null==e.name.str||(a=e.name),null==a)throw new s("wrong name member value");return r({tag:{tag:"a1",explicit:!0,obj:new n(a)}}).tohex()}throw new s("key or name not specified")},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},He(X.asn1.ocsp.ResponderID,X.asn1.ASN1Object),X.asn1.ocsp.SingleResponseList=function(e){X.asn1.ocsp.SingleResponseList.superclass.constructor.call(this);var t=X.asn1,r=t.DERSequence,n=t.ocsp.SingleResponse;this.params=null,this.tohex=function(){var e=this.params;if("object"!=typeof e||null==e.length)throw new Error("params not specified properly");for(var t=[],i=0;i<e.length;i++)t.push(new n(e[i]));return new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},He(X.asn1.ocsp.SingleResponseList,X.asn1.ASN1Object),X.asn1.ocsp.SingleResponse=function(e){var t=Error,r=X.asn1,n=r.DERSequence,i=r.DERGeneralizedTime,s=r.DERTaggedObject,o=r.ocsp,a=o.CertID,c=o.CertStatus,u=r.x509.Extensions;o.SingleResponse.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,r=[];if(null==e.certid)throw new t("certid unspecified");if(null==e.status)throw new t("status unspecified");if(null==e.thisupdate)throw new t("thisupdate unspecified");if(r.push(new a(e.certid)),r.push(new c(e.status)),r.push(new i(e.thisupdate)),null!=e.nextupdate){var o=new i(e.nextupdate);r.push(new s({tag:"a0",explicit:!0,obj:o}))}if(null!=e.ext){var l=new u(e.ext);r.push(new s({tag:"a1",explicit:!0,obj:l}))}return new n({array:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},He(X.asn1.ocsp.SingleResponse,X.asn1.ASN1Object),X.asn1.ocsp.CertID=function(e){var t=X.asn1,r=t.DEROctetString,n=t.DERInteger,i=t.DERSequence,s=t.x509.AlgorithmIdentifier,o=X.crypto.Util.hashHex,a=We,c=ee.getVbyList;t.ocsp.CertID.superclass.constructor.call(this),this.DEFAULT_HASH="sha1",this.params=null,this.setByValue=function(e,t,r,n){null==n&&(n=this.DEFAULT_HASH),this.params={alg:n,issname:e,isskey:t,sbjsn:r}},this.setByCert=function(e,t,r){null==r&&(r=this.DEFAULT_HASH),this.params={alg:r,issuerCert:e,subjectCert:t}},this.getParamByCerts=function(e,t,r){null==r&&(r=this.DEFAULT_HASH);var n=new a(e),i=new a(t),s=o(n.getSubjectHex(),r),u=n.getPublicKeyHex();return{alg:r,issname:s,isskey:o(c(u,0,[1],"03",!0),r),sbjsn:i.getSerialNumberHex()}},this.tohex=function(){if("object"!=typeof this.params)throw new Error("params not set");var e,t,o,a,c=this.params;if(a=null==c.alg?this.DEFAULT_HASH:c.alg,null!=c.issuerCert&&null!=c.subjectCert){var u=this.getParamByCerts(c.issuerCert,c.subjectCert,a);e=u.issname,t=u.isskey,o=u.sbjsn}else{if(null==c.issname||null==c.isskey||null==c.sbjsn)throw new Error("required param members not defined");e=c.issname,t=c.isskey,o=c.sbjsn}var l=new s({name:a}),h=new r({hex:e}),d=new r({hex:t}),m=new n({hex:o}),p=new i({array:[l,h,d,m]});return this.hTLV=p.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},He(X.asn1.ocsp.CertID,X.asn1.ASN1Object),X.asn1.ocsp.CertStatus=function(e){X.asn1.ocsp.CertStatus.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if("good"==e.status)return"8000";if("unknown"==e.status)return"8200";if("revoked"==e.status){var t=[{gentime:{str:e.time}}];return null!=e.reason&&t.push({tag:{tag:"a0",explicit:!0,obj:{enum:{int:e.reason}}}}),X.asn1.ASN1Util.newObject({tag:{tag:"a1",explicit:!1,obj:{seq:t}}}).tohex()}throw new Error("bad status")},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},He(X.asn1.ocsp.CertStatus,X.asn1.ASN1Object),X.asn1.ocsp.Request=function(e){var t=X.asn1,r=t.DERSequence,n=t.ocsp;if(n.Request.superclass.constructor.call(this),this.dReqCert=null,this.dExt=null,this.tohex=function(){var e=[];if(null===this.dReqCert)throw"reqCert not set";e.push(this.dReqCert);var t=new r({array:e});return this.hTLV=t.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e){var i=new n.CertID(e);this.dReqCert=i}},He(X.asn1.ocsp.Request,X.asn1.ASN1Object),X.asn1.ocsp.TBSRequest=function(e){var t=X.asn1,r=t.DERSequence,n=t.ocsp;n.TBSRequest.superclass.constructor.call(this),this.version=0,this.dRequestorName=null,this.dRequestList=[],this.dRequestExt=null,this.setRequestListByParam=function(e){for(var t=[],r=0;r<e.length;r++){var i=new n.Request(e[0]);t.push(i)}this.dRequestList=t},this.tohex=function(){var e=[];if(0!==this.version)throw"not supported version: "+this.version;if(null!==this.dRequestorName)throw"requestorName not supported";var t=new r({array:this.dRequestList});if(e.push(t),null!==this.dRequestExt)throw"requestExtensions not supported";var n=new r({array:e});return this.hTLV=n.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&void 0!==e.reqList&&this.setRequestListByParam(e.reqList)},He(X.asn1.ocsp.TBSRequest,X.asn1.ASN1Object),X.asn1.ocsp.OCSPRequest=function(e){var t=X.asn1,r=t.DERSequence,n=t.ocsp;if(n.OCSPRequest.superclass.constructor.call(this),this.dTbsRequest=null,this.dOptionalSignature=null,this.tohex=function(){var e=[];if(null===this.dTbsRequest)throw"tbsRequest not set";if(e.push(this.dTbsRequest),null!==this.dOptionalSignature)throw"optionalSignature not supported";var t=new r({array:e});return this.hTLV=t.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&void 0!==e.reqList){var i=new n.TBSRequest(e);this.dTbsRequest=i}},He(X.asn1.ocsp.OCSPRequest,X.asn1.ASN1Object),X.asn1.ocsp.OCSPUtil={},X.asn1.ocsp.OCSPUtil.getRequestHex=function(e,t,r){var n=X.asn1.ocsp;return void 0===r&&(r=n.DEFAULT_HASH),new n.OCSPRequest({reqList:[{alg:r,issuerCert:e,subjectCert:t}]}).tohex()},X.asn1.ocsp.OCSPUtil.getOCSPResponseInfo=function(e){var t=ee.getVbyList,r=ee.getVbyListEx,n=ee.getIdxbyList,i=ee.getV,s={};try{var o=r(e,0,[0],"0a");s.responseStatus=parseInt(o,16)}catch(e){}if(0!==s.responseStatus)return s;try{var a=n(e,0,[1,0,1,0,0,2,0,1]);"80"===e.substr(a,2)?s.certStatus="good":"a1"===e.substr(a,2)?(s.certStatus="revoked",s.revocationTime=le(t(e,a,[0]))):"82"===e.substr(a,2)&&(s.certStatus="unknown")}catch(e){}try{var c=n(e,0,[1,0,1,0,0,2,0,2]);s.thisUpdate=le(i(e,c))}catch(e){}try{var u=n(e,0,[1,0,1,0,0,2,0,3]);"a0"===e.substr(u,2)&&(s.nextUpdate=le(t(e,u,[0])))}catch(e){}return s},X.asn1.ocsp.OCSPParser=function(){var e=Error,t=We,r=new t,n=ee.getV,i=ee.getTLV,s=ee.getIdxbyList,o=ee.getVbyList,a=ee.getTLVbyList,c=ee.getVbyListEx,u=ee.getTLVbyListEx,l=ee.getChildIdx;this.getOCSPRequest=function(t){var r=l(t,0);if(1!=r.length&&2!=r.length)throw new e("wrong number elements: "+r.length);return this.getTBSRequest(i(t,r[0]))},this.getTBSRequest=function(e){var t={},n=u(e,0,[0],"30");t.array=this.getRequestList(n);var i=u(e,0,["[2]",0],"30");return null!=i&&(t.ext=r.getExtParamArray(i)),t},this.getRequestList=function(e){for(var t=[],r=l(e,0),n=0;n<r.length;n++)e=i(e,r[n]),t.push(this.getRequest(e));return t},this.getRequest=function(t){var n=l(t,0);if(1!=n.length&&2!=n.length)throw new e("wrong number elements: "+n.length);var o=this.getCertID(i(t,n[0]));if(2==n.length){var a=s(t,0,[1,0]);o.ext=r.getExtParamArray(i(t,a))}return o},this.getCertID=function(r){var s=l(r,0);if(4!=s.length)throw new e("wrong number elements: "+s.length);var o=new t,a={};return a.alg=o.getAlgorithmIdentifierName(i(r,s[0])),a.issname=n(r,s[1]),a.isskey=n(r,s[2]),a.sbjsn=n(r,s[3]),a},this.getOCSPResponse=function(e){var t,r=l(e,0),i=n(e,r[0]),s=parseInt(i);if(1==r.length)return{resstatus:s};var o=a(e,0,[1,0]);return(t=this.getResponseBytes(o)).resstatus=s,t},this.getResponseBytes=function(e){var t,r=l(e,0),i=a(e,0,[1,0]);t=this.getBasicOCSPResponse(i);var s=n(e,r[0]);return t.restype=X.asn1.x509.OID.oid2name(Fe(s)),t},this.getBasicOCSPResponse=function(e){var t,r=l(e,0);t=this.getResponseData(i(e,r[0]));var s=new We;t.alg=s.getAlgorithmIdentifierName(i(e,r[1]));var o=n(e,r[2]);t.sighex=o.substr(2);var a=c(e,0,["[0]"]);if(null!=a){for(var u=l(a,0),h=[],d=0;d<u.length;d++){var m=i(a,u[d]);h.push(m)}t.certs=h}return t},this.getResponseData=function(e){var t=l(e,0),r=t.length,s={},o=0;"a0"==e.substr(t[0],2)&&o++,s.respid=this.getResponderID(i(e,t[o++]));var c=n(e,t[o++]);if(s.prodat=le(c),s.array=this.getSingleResponseList(i(e,t[o++])),"a1"==e.substr(t[r-1],2)){var u=a(e,t[r-1],[0]),h=new We;s.ext=h.getExtParamArray(u)}return s},this.getResponderID=function(e){var t={};if("a2"==e.substr(0,2)){var r=o(e,0,[0]);t.key=r}if("a1"==e.substr(0,2)){var n=a(e,0,[0]),i=new We;t.name=i.getX500Name(n)}return t},this.getSingleResponseList=function(e){for(var t=l(e,0),r=[],n=0;n<t.length;n++){var s=this.getSingleResponse(i(e,t[n]));r.push(s)}return r},this.getSingleResponse=function(e){var t=l(e,0),r={},s=this.getCertID(i(e,t[0]));r.certid=s;var c=this.getCertStatus(i(e,t[1]));if(r.status=c,"18"==e.substr(t[2],2)){var u=n(e,t[2]);r.thisupdate=le(u)}for(var h=3;h<t.length;h++){if("a0"==e.substr(t[h],2)){var d=o(e,t[h],[0],"18");r.nextupdate=le(d)}if("a1"==e.substr(t[h],2)){var m=new We,p=a(e,0,[h,0]);r.ext=m.getExtParamArray(p)}}return r},this.getCertStatus=function(e){var t={};if("8000"==e)return{status:"good"};if("8200"==e)return{status:"unknown"};if("a1"==e.substr(0,2)){t.status="revoked";var r=le(o(e,0,[0]));t.time=r}return t}},void 0!==X&&X||(X={}),void 0!==X.lang&&X.lang||(X.lang={}),X.lang.String=function(){},"function"==typeof e?(Z=function(t){return se(e.from(t,"utf8").toString("base64"))},Y=function(t){return e.from(oe(t),"base64").toString("utf8")}):(Z=function(e){return ae(we(Me(e)))},Y=function(e){return decodeURIComponent(Ce(ce(e)))}),X.lang.String.isInteger=function(e){return!!e.match(/^[0-9]+$/)||!!e.match(/^-[0-9]+$/)},X.lang.String.isHex=function(e){return ke(e)},X.lang.String.isBase64=function(e){return!(!(e=e.replace(/\s+/g,"")).match(/^[0-9A-Za-z+\/]+={0,3}$/)||e.length%4!=0)},X.lang.String.isBase64URL=function(e){return!e.match(/[+/=]/)&&(e=oe(e),X.lang.String.isBase64(e))},X.lang.String.isIntegerArray=function(e){return!!(e=e.replace(/\s+/g,"")).match(/^\[[0-9,]+\]$/)},X.lang.String.isPrintable=function(e){return null!==e.match(/^[0-9A-Za-z '()+,-./:=?]*$/)},X.lang.String.isIA5=function(e){return null!==e.match(/^[\x20-\x21\x23-\x7f]*$/)},X.lang.String.isMail=function(e){return null!==e.match(/^[A-Za-z0-9]{1}[A-Za-z0-9_.-]*@{1}[A-Za-z0-9_.-]{1,}\.[A-Za-z0-9]{1,}$/)};var Ae=function(e,t,r){return null==r&&(r="0"),e.length>=t?e:new Array(t-e.length+1).join(r)+e};function je(e){if(e.length%2!=0)return-1;if(null==(e=e.toLowerCase()).match(/^[0-9a-f]+$/))return-1;try{var t=e.substr(0,2);if("00"==t)return parseInt(e.substr(2),16);var r=parseInt(t,16);if(r>7)return-1;var n=e.substr(2),i=parseInt(n,16).toString(2);"0"==i&&(i="00000000"),i=i.slice(0,0-r);var s=parseInt(i,2);return NaN==s?-1:s}catch(e){return-1}}function qe(e){if("number"!=typeof e)return null;if(e<0)return null;var t=Number(e).toString(2),r=8-t.length%8;8==r&&(r=0),t+=Ae("",r,"0");var n=parseInt(t,2).toString(16);return n.length%2==1&&(n="0"+n),"0"+r+n}function Be(e){if("string"!=typeof e)return null;if(e.length%2!=0)return null;if(!e.match(/^[0-9a-f]+$/))return null;try{var t=parseInt(e.substr(0,2),16);if(t<0||7<t)return null;for(var r=e.substr(2),n="",i=0;i<r.length;i+=2){var s=r.substr(i,2),o=parseInt(s,16).toString(2);n+=o=("0000000"+o).slice(-8)}return n.substr(0,n.length-t)}catch(e){return null}}function _e(e,t){for(var r=0,n=0;n<e.length;n++)r|=1<<t[e[n]];var i=r.toString(2),s="";for(n=i.length-1;n>=0;n--)s+=i[n];return s}function He(e,t){var r=function(){};r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e,e.superclass=t.prototype,t.prototype.constructor==Object.prototype.constructor&&(t.prototype.constructor=t)}void 0!==X&&X||(X={}),void 0!==X.crypto&&X.crypto||(X.crypto={}),X.crypto.Util=new function(){this.DIGESTINFOHEAD={sha1:"3021300906052b0e03021a05000414",sha224:"302d300d06096086480165030402040500041c",sha256:"3031300d060960864801650304020105000420",sha384:"3041300d060960864801650304020205000430",sha512:"3051300d060960864801650304020305000440",md2:"3020300c06082a864886f70d020205000410",md5:"3020300c06082a864886f70d020505000410",ripemd160:"3021300906052b2403020105000414"},this.DEFAULTPROVIDER={md5:"cryptojs",sha1:"cryptojs",sha224:"cryptojs",sha256:"cryptojs",sha384:"cryptojs",sha512:"cryptojs",ripemd160:"cryptojs",hmacmd5:"cryptojs",hmacsha1:"cryptojs",hmacsha224:"cryptojs",hmacsha256:"cryptojs",hmacsha384:"cryptojs",hmacsha512:"cryptojs",hmacripemd160:"cryptojs",MD5withRSA:"cryptojs/jsrsa",SHA1withRSA:"cryptojs/jsrsa",SHA224withRSA:"cryptojs/jsrsa",SHA256withRSA:"cryptojs/jsrsa",SHA384withRSA:"cryptojs/jsrsa",SHA512withRSA:"cryptojs/jsrsa",RIPEMD160withRSA:"cryptojs/jsrsa",MD5withECDSA:"cryptojs/jsrsa",SHA1withECDSA:"cryptojs/jsrsa",SHA224withECDSA:"cryptojs/jsrsa",SHA256withECDSA:"cryptojs/jsrsa",SHA384withECDSA:"cryptojs/jsrsa",SHA512withECDSA:"cryptojs/jsrsa",RIPEMD160withECDSA:"cryptojs/jsrsa",SHA1withDSA:"cryptojs/jsrsa",SHA224withDSA:"cryptojs/jsrsa",SHA256withDSA:"cryptojs/jsrsa",MD5withRSAandMGF1:"cryptojs/jsrsa",SHAwithRSAandMGF1:"cryptojs/jsrsa",SHA1withRSAandMGF1:"cryptojs/jsrsa",SHA224withRSAandMGF1:"cryptojs/jsrsa",SHA256withRSAandMGF1:"cryptojs/jsrsa",SHA384withRSAandMGF1:"cryptojs/jsrsa",SHA512withRSAandMGF1:"cryptojs/jsrsa",RIPEMD160withRSAandMGF1:"cryptojs/jsrsa"},this.CRYPTOJSMESSAGEDIGESTNAME={md5:i.algo.MD5,sha1:i.algo.SHA1,sha224:i.algo.SHA224,sha256:i.algo.SHA256,sha384:i.algo.SHA384,sha512:i.algo.SHA512,ripemd160:i.algo.RIPEMD160},this.getDigestInfoHex=function(e,t){if(void 0===this.DIGESTINFOHEAD[t])throw"alg not supported in Util.DIGESTINFOHEAD: "+t;return this.DIGESTINFOHEAD[t]+e},this.getPaddedDigestInfoHex=function(e,t,r){var n=this.getDigestInfoHex(e,t),i=r/4;if(n.length+22>i)throw"key is too short for SigAlg: keylen="+r+","+t;for(var s="0001",o="00"+n,a="",c=i-s.length-o.length,u=0;u<c;u+=2)a+="ff";return s+a+o},this.hashString=function(e,t){return new X.crypto.MessageDigest({alg:t}).digestString(e)},this.hashHex=function(e,t){return new X.crypto.MessageDigest({alg:t}).digestHex(e)},this.sha1=function(e){return this.hashString(e,"sha1")},this.sha256=function(e){return this.hashString(e,"sha256")},this.sha256Hex=function(e){return this.hashHex(e,"sha256")},this.sha512=function(e){return this.hashString(e,"sha512")},this.sha512Hex=function(e){return this.hashHex(e,"sha512")},this.isKey=function(e){return e instanceof K||e instanceof X.crypto.DSA||e instanceof X.crypto.ECDSA}},X.crypto.Util.md5=function(e){return new X.crypto.MessageDigest({alg:"md5",prov:"cryptojs"}).digestString(e)},X.crypto.Util.ripemd160=function(e){return new X.crypto.MessageDigest({alg:"ripemd160",prov:"cryptojs"}).digestString(e)},X.crypto.Util.SECURERANDOMGEN=new V,X.crypto.Util.getRandomHexOfNbytes=function(e){var t=new Array(e);return X.crypto.Util.SECURERANDOMGEN.nextBytes(t),ne(t)},X.crypto.Util.getRandomBigIntegerOfNbytes=function(e){return new l(X.crypto.Util.getRandomHexOfNbytes(e),16)},X.crypto.Util.getRandomHexOfNbits=function(e){var t=e%8,r=new Array((e-t)/8+1);return X.crypto.Util.SECURERANDOMGEN.nextBytes(r),r[0]=(255<<t&255^255)&r[0],ne(r)},X.crypto.Util.getRandomBigIntegerOfNbits=function(e){return new l(X.crypto.Util.getRandomHexOfNbits(e),16)},X.crypto.Util.getRandomBigIntegerZeroToMax=function(e){for(var t=e.bitLength();;){var r=X.crypto.Util.getRandomBigIntegerOfNbits(t);if(-1!=e.compareTo(r))return r}},X.crypto.Util.getRandomBigIntegerMinToMax=function(e,t){var r=e.compareTo(t);if(1==r)throw"biMin is greater than biMax";if(0==r)return e;var n=t.subtract(e);return X.crypto.Util.getRandomBigIntegerZeroToMax(n).add(e)},X.crypto.MessageDigest=function(e){this.setAlgAndProvider=function(e,t){if(null!==(e=X.crypto.MessageDigest.getCanonicalAlgName(e))&&void 0===t&&(t=X.crypto.Util.DEFAULTPROVIDER[e]),-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(e)&&"cryptojs"==t){try{this.md=X.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[e].create()}catch(t){throw"setAlgAndProvider hash alg set fail alg="+e+"/"+t}this.updateString=function(e){this.md.update(e)},this.updateHex=function(e){var t=i.enc.Hex.parse(e);this.md.update(t)},this.digest=function(){return this.md.finalize().toString(i.enc.Hex)},this.digestString=function(e){return this.updateString(e),this.digest()},this.digestHex=function(e){return this.updateHex(e),this.digest()}}if(-1!=":sha256:".indexOf(e)&&"sjcl"==t){try{this.md=new sjcl.hash.sha256}catch(t){throw"setAlgAndProvider hash alg set fail alg="+e+"/"+t}this.updateString=function(e){this.md.update(e)},this.updateHex=function(e){var t=sjcl.codec.hex.toBits(e);this.md.update(t)},this.digest=function(){var e=this.md.finalize();return sjcl.codec.hex.fromBits(e)},this.digestString=function(e){return this.updateString(e),this.digest()},this.digestHex=function(e){return this.updateHex(e),this.digest()}}},this.updateString=function(e){throw"updateString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.updateHex=function(e){throw"updateHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digest=function(){throw"digest() not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digestString=function(e){throw"digestString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digestHex=function(e){throw"digestHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName},void 0!==e&&void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov&&(this.provName=X.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName))},X.crypto.MessageDigest.getCanonicalAlgName=function(e){return"string"==typeof e&&(e=(e=e.toLowerCase()).replace(/-/,"")),e},X.crypto.MessageDigest.getHashLength=function(e){var t=X.crypto.MessageDigest,r=t.getCanonicalAlgName(e);if(void 0===t.HASHLENGTH[r])throw"not supported algorithm: "+e;return t.HASHLENGTH[r]},X.crypto.MessageDigest.HASHLENGTH={md5:16,sha1:20,sha224:28,sha256:32,sha384:48,sha512:64,ripemd160:20},X.crypto.Mac=function(e){this.setAlgAndProvider=function(e,t){if(null==(e=e.toLowerCase())&&(e="hmacsha1"),"hmac"!=(e=e.toLowerCase()).substr(0,4))throw"setAlgAndProvider unsupported HMAC alg: "+e;void 0===t&&(t=X.crypto.Util.DEFAULTPROVIDER[e]),this.algProv=e+"/"+t;var r=e.substr(4);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(r)&&"cryptojs"==t){try{this.mac=i.algo.HMAC.create(X.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[r],this.pass)}catch(e){throw"setAlgAndProvider hash alg set fail hashAlg="+r+"/"+e}this.updateString=function(e){this.mac.update(e)},this.updateHex=function(e){var t=i.enc.Hex.parse(e);this.mac.update(t)},this.doFinal=function(){return this.mac.finalize().toString(i.enc.Hex)},this.doFinalString=function(e){return this.updateString(e),this.doFinal()},this.doFinalHex=function(e){return this.updateHex(e),this.doFinal()}}},this.updateString=function(e){throw"updateString(str) not supported for this alg/prov: "+this.algProv},this.updateHex=function(e){throw"updateHex(hex) not supported for this alg/prov: "+this.algProv},this.doFinal=function(){throw"digest() not supported for this alg/prov: "+this.algProv},this.doFinalString=function(e){throw"digestString(str) not supported for this alg/prov: "+this.algProv},this.doFinalHex=function(e){throw"digestHex(hex) not supported for this alg/prov: "+this.algProv},this.setPassword=function(e){if("string"==typeof e){var t=e;return e.length%2!=1&&e.match(/^[0-9A-Fa-f]+$/)||(t=me(e)),void(this.pass=i.enc.Hex.parse(t))}if("object"!=typeof e)throw"KJUR.crypto.Mac unsupported password type: "+e;if(t=null,void 0!==e.hex){if(e.hex.length%2!=0||!e.hex.match(/^[0-9A-Fa-f]+$/))throw"Mac: wrong hex password: "+e.hex;t=e.hex}if(void 0!==e.utf8&&(t=ue(e.utf8)),void 0!==e.rstr&&(t=me(e.rstr)),void 0!==e.b64&&(t=c(e.b64)),void 0!==e.b64u&&(t=ce(e.b64u)),null==t)throw"KJUR.crypto.Mac unsupported password type: "+e;this.pass=i.enc.Hex.parse(t)},void 0!==e&&(void 0!==e.pass&&this.setPassword(e.pass),void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov&&(this.provName=X.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName)))},X.crypto.Signature=function(e){var t=null;if(this._setAlgNames=function(){var e=this.algName.match(/^(.+)with(.+)$/);e&&(this.mdAlgName=e[1].toLowerCase(),this.pubkeyAlgName=e[2].toLowerCase(),"rsaandmgf1"==this.pubkeyAlgName&&"sha"==this.mdAlgName&&(this.mdAlgName="sha1"))},this._zeroPaddingOfSignature=function(e,t){for(var r="",n=t/4-e.length,i=0;i<n;i++)r+="0";return r+e},this.setAlgAndProvider=function(e,t){if(this._setAlgNames(),"cryptojs/jsrsa"!=t)throw new Error("provider not supported: "+t);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(this.mdAlgName)){try{this.md=new X.crypto.MessageDigest({alg:this.mdAlgName})}catch(e){throw new Error("setAlgAndProvider hash alg set fail alg="+this.mdAlgName+"/"+e)}this.init=function(e,t){var r=null;try{r=void 0===t?Ve.getKey(e):Ve.getKey(e,t)}catch(e){throw"init failed:"+e}if(!0===r.isPrivate)this.prvKey=r,this.state="SIGN";else{if(!0!==r.isPublic)throw"init failed.:"+r;this.pubKey=r,this.state="VERIFY"}},this.updateString=function(e){this.md.updateString(e)},this.updateHex=function(e){this.md.updateHex(e)},this.sign=function(){if(this.sHashHex=this.md.digest(),void 0===this.prvKey&&void 0!==this.ecprvhex&&void 0!==this.eccurvename&&void 0!==X.crypto.ECDSA&&(this.prvKey=new X.crypto.ECDSA({curve:this.eccurvename,prv:this.ecprvhex})),this.prvKey instanceof K&&"rsaandmgf1"===this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHashPSS(this.sHashHex,this.mdAlgName,this.pssSaltLen);else if(this.prvKey instanceof K&&"rsa"===this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex,this.mdAlgName);else if(this.prvKey instanceof X.crypto.ECDSA)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex);else{if(!(this.prvKey instanceof X.crypto.DSA))throw"Signature: unsupported private key alg: "+this.pubkeyAlgName;this.hSign=this.prvKey.signWithMessageHash(this.sHashHex)}return this.hSign},this.signString=function(e){return this.updateString(e),this.sign()},this.signHex=function(e){return this.updateHex(e),this.sign()},this.verify=function(e){if(this.sHashHex=this.md.digest(),void 0===this.pubKey&&void 0!==this.ecpubhex&&void 0!==this.eccurvename&&void 0!==X.crypto.ECDSA&&(this.pubKey=new X.crypto.ECDSA({curve:this.eccurvename,pub:this.ecpubhex})),this.pubKey instanceof K&&"rsaandmgf1"===this.pubkeyAlgName)return this.pubKey.verifyWithMessageHashPSS(this.sHashHex,e,this.mdAlgName,this.pssSaltLen);if(this.pubKey instanceof K&&"rsa"===this.pubkeyAlgName)return this.pubKey.verifyWithMessageHash(this.sHashHex,e);if(void 0!==X.crypto.ECDSA&&this.pubKey instanceof X.crypto.ECDSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,e);if(void 0!==X.crypto.DSA&&this.pubKey instanceof X.crypto.DSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,e);throw"Signature: unsupported public key alg: "+this.pubkeyAlgName}}},this.init=function(e,t){throw"init(key, pass) not supported for this alg:prov="+this.algProvName},this.updateString=function(e){throw"updateString(str) not supported for this alg:prov="+this.algProvName},this.updateHex=function(e){throw"updateHex(hex) not supported for this alg:prov="+this.algProvName},this.sign=function(){throw"sign() not supported for this alg:prov="+this.algProvName},this.signString=function(e){throw"digestString(str) not supported for this alg:prov="+this.algProvName},this.signHex=function(e){throw"digestHex(hex) not supported for this alg:prov="+this.algProvName},this.verify=function(e){throw"verify(hSigVal) not supported for this alg:prov="+this.algProvName},this.initParams=e,void 0!==e&&(void 0!==e.alg&&(this.algName=e.alg,this.provName=void 0===e.prov?X.crypto.Util.DEFAULTPROVIDER[this.algName]:e.prov,this.algProvName=this.algName+":"+this.provName,this.setAlgAndProvider(this.algName,this.provName),this._setAlgNames()),void 0!==e.psssaltlen&&(this.pssSaltLen=e.psssaltlen),void 0!==e.prvkeypem)){if(void 0!==e.prvkeypas)throw"both prvkeypem and prvkeypas parameters not supported";try{t=Ve.getKey(e.prvkeypem),this.init(t)}catch(e){throw"fatal error to load pem private key: "+e}}},X.crypto.Cipher=function(e){},X.crypto.Cipher.encrypt=function(e,t,r){if(t instanceof K&&t.isPublic){var n=X.crypto.Cipher.getAlgByKeyAndName(t,r);if("RSA"===n)return t.encrypt(e);if("RSAOAEP"===n)return t.encryptOAEP(e,"sha1");var i=n.match(/^RSAOAEP(\d+)$/);if(null!==i)return t.encryptOAEP(e,"sha"+i[1]);throw"Cipher.encrypt: unsupported algorithm for RSAKey: "+r}throw"Cipher.encrypt: unsupported key or algorithm"},X.crypto.Cipher.decrypt=function(e,t,r){if(t instanceof K&&t.isPrivate){var n=X.crypto.Cipher.getAlgByKeyAndName(t,r);if("RSA"===n)return t.decrypt(e);if("RSAOAEP"===n)return t.decryptOAEP(e,"sha1");var i=n.match(/^RSAOAEP(\d+)$/);if(null!==i)return t.decryptOAEP(e,"sha"+i[1]);throw"Cipher.decrypt: unsupported algorithm for RSAKey: "+r}throw"Cipher.decrypt: unsupported key or algorithm"},X.crypto.Cipher.getAlgByKeyAndName=function(e,t){if(e instanceof K){if(-1!=":RSA:RSAOAEP:RSAOAEP224:RSAOAEP256:RSAOAEP384:RSAOAEP512:".indexOf(t))return t;if(null==t)return"RSA";throw"getAlgByKeyAndName: not supported algorithm name for RSAKey: "+t}throw"getAlgByKeyAndName: not supported algorithm name: "+t},X.crypto.OID=new function(){this.oidhex2name={"2a864886f70d010101":"rsaEncryption","2a8648ce3d0201":"ecPublicKey","2a8648ce380401":"dsa","2a8648ce3d030107":"secp256r1","2b8104001f":"secp192k1","2b81040021":"secp224r1","2b8104000a":"secp256k1","2b81040022":"secp384r1","2b81040023":"secp521r1","2a8648ce380403":"SHA1withDSA","608648016503040301":"SHA224withDSA","608648016503040302":"SHA256withDSA"}},void 0!==X&&X||(X={}),void 0!==X.crypto&&X.crypto||(X.crypto={}),X.crypto.ECDSA=function(e){var t=Error,r=l,n=G,i=X.crypto.ECDSA,s=X.crypto.ECParameterDB,o=i.getName,a=ee.getVbyListEx,c=ee.isASN1HEX,u=new V;this.type="EC",this.isPrivate=!1,this.isPublic=!1,this.getBigRandom=function(e){return new r(e.bitLength(),u).mod(e.subtract(r.ONE)).add(r.ONE)},this.setNamedCurve=function(e){this.ecparams=s.getByName(e),this.prvKeyHex=null,this.pubKeyHex=null,this.curveName=e},this.setPrivateKeyHex=function(e){this.isPrivate=!0,this.prvKeyHex=e},this.setPublicKeyHex=function(e){this.isPublic=!0,this.pubKeyHex=e},this.getPublicKeyXYHex=function(){var e=this.pubKeyHex;if("04"!==e.substr(0,2))throw"this method supports uncompressed format(04) only";var t=this.ecparams.keycharlen;if(e.length!==2+2*t)throw"malformed public key hex length";var r={};return r.x=e.substr(2,t),r.y=e.substr(2+t),r},this.getShortNISTPCurveName=function(){var e=this.curveName;return"secp256r1"===e||"NIST P-256"===e||"P-256"===e||"prime256v1"===e?"P-256":"secp384r1"===e||"NIST P-384"===e||"P-384"===e?"P-384":"secp521r1"===e||"NIST P-521"===e||"P-521"===e?"P-521":null},this.generateKeyPairHex=function(){var e=this.getBigRandom(this.ecparams.n),t=this.ecparams.keycharlen,r=("0000000000"+e.toString(16)).slice(-t);return this.setPrivateKeyHex(r),{ecprvhex:r,ecpubhex:this.generatePublicKeyHex()}},this.generatePublicKeyHex=function(){var e=new r(this.prvKeyHex,16),t=this.ecparams.G.multiply(e),n=t.getX().toBigInteger(),i=t.getY().toBigInteger(),s=this.ecparams.keycharlen,o="04"+("0000000000"+n.toString(16)).slice(-s)+("0000000000"+i.toString(16)).slice(-s);return this.setPublicKeyHex(o),o},this.signWithMessageHash=function(e){return this.signHex(e,this.prvKeyHex)},this.signHex=function(e,t){var n=new r(t,16),s=this.ecparams.n,o=new r(e.substring(0,this.ecparams.keycharlen),16);do{var a=this.getBigRandom(s),c=this.ecparams.G.multiply(a).getX().toBigInteger().mod(s)}while(c.compareTo(r.ZERO)<=0);var u=a.modInverse(s).multiply(o.add(n.multiply(c))).mod(s);return i.biRSSigToASN1Sig(c,u)},this.sign=function(e,t){var n=t,i=this.ecparams.n,s=r.fromByteArrayUnsigned(e);do{var o=this.getBigRandom(i),a=this.ecparams.G.multiply(o).getX().toBigInteger().mod(i)}while(a.compareTo(l.ZERO)<=0);var c=o.modInverse(i).multiply(s.add(n.multiply(a))).mod(i);return this.serializeSig(a,c)},this.verifyWithMessageHash=function(e,t){return this.verifyHex(e,t,this.pubKeyHex)},this.verifyHex=function(e,t,s){try{var o,a,c=i.parseSigHex(t);o=c.r,a=c.s;var u=n.decodeFromHex(this.ecparams.curve,s),l=new r(e.substring(0,this.ecparams.keycharlen),16);return this.verifyRaw(l,o,a,u)}catch(e){return!1}},this.verify=function(e,t,i){var s,o,a;if(Bitcoin.Util.isArray(t)){var c=this.parseSig(t);s=c.r,o=c.s}else{if("object"!=typeof t||!t.r||!t.s)throw"Invalid value for signature";s=t.r,o=t.s}if(i instanceof G)a=i;else{if(!Bitcoin.Util.isArray(i))throw"Invalid format for pubkey value, must be byte array or ECPointFp";a=n.decodeFrom(this.ecparams.curve,i)}var u=r.fromByteArrayUnsigned(e);return this.verifyRaw(u,s,o,a)},this.verifyRaw=function(e,t,n,i){var s=this.ecparams.n,o=this.ecparams.G;if(t.compareTo(r.ONE)<0||t.compareTo(s)>=0)return!1;if(n.compareTo(r.ONE)<0||n.compareTo(s)>=0)return!1;var a=n.modInverse(s),c=e.multiply(a).mod(s),u=t.multiply(a).mod(s);return o.multiply(c).add(i.multiply(u)).getX().toBigInteger().mod(s).equals(t)},this.serializeSig=function(e,t){var r=e.toByteArraySigned(),n=t.toByteArraySigned(),i=[];return i.push(2),i.push(r.length),(i=i.concat(r)).push(2),i.push(n.length),(i=i.concat(n)).unshift(i.length),i.unshift(48),i},this.parseSig=function(e){var t;if(48!=e[0])throw new Error("Signature not a valid DERSequence");if(2!=e[t=2])throw new Error("First element in signature must be a DERInteger");var n=e.slice(t+2,t+2+e[t+1]);if(2!=e[t+=2+e[t+1]])throw new Error("Second element in signature must be a DERInteger");var i=e.slice(t+2,t+2+e[t+1]);return t+=2+e[t+1],{r:r.fromByteArrayUnsigned(n),s:r.fromByteArrayUnsigned(i)}},this.parseSigCompact=function(e){if(65!==e.length)throw"Signature has the wrong length";var t=e[0]-27;if(t<0||t>7)throw"Invalid signature type";var n=this.ecparams.n;return{r:r.fromByteArrayUnsigned(e.slice(1,33)).mod(n),s:r.fromByteArrayUnsigned(e.slice(33,65)).mod(n),i:t}},this.readPKCS5PrvKeyHex=function(e){if(!1===c(e))throw new Error("not ASN.1 hex string");var t,r,n;try{t=a(e,0,["[0]",0],"06"),r=a(e,0,[1],"04");try{n=a(e,0,["[1]",0],"03")}catch(e){}}catch(e){throw new Error("malformed PKCS#1/5 plain ECC private key")}if(this.curveName=o(t),void 0===this.curveName)throw"unsupported curve name";this.setNamedCurve(this.curveName),this.setPublicKeyHex(n),this.setPrivateKeyHex(r),this.isPublic=!1},this.readPKCS8PrvKeyHex=function(e){if(!1===c(e))throw new t("not ASN.1 hex string");var r,n,i;try{a(e,0,[1,0],"06"),r=a(e,0,[1,1],"06"),n=a(e,0,[2,0,1],"04");try{i=a(e,0,[2,0,"[1]",0],"03")}catch(e){}}catch(e){throw new t("malformed PKCS#8 plain ECC private key")}if(this.curveName=o(r),void 0===this.curveName)throw new t("unsupported curve name");this.setNamedCurve(this.curveName),this.setPublicKeyHex(i),this.setPrivateKeyHex(n),this.isPublic=!1},this.readPKCS8PubKeyHex=function(e){if(!1===c(e))throw new t("not ASN.1 hex string");var r,n;try{a(e,0,[0,0],"06"),r=a(e,0,[0,1],"06"),n=a(e,0,[1],"03")}catch(e){throw new t("malformed PKCS#8 ECC public key")}if(this.curveName=o(r),null===this.curveName)throw new t("unsupported curve name");this.setNamedCurve(this.curveName),this.setPublicKeyHex(n)},this.readCertPubKeyHex=function(e,r){if(!1===c(e))throw new t("not ASN.1 hex string");var n,i;try{n=a(e,0,[0,5,0,1],"06"),i=a(e,0,[0,5,1],"03")}catch(e){throw new t("malformed X.509 certificate ECC public key")}if(this.curveName=o(n),null===this.curveName)throw new t("unsupported curve name");this.setNamedCurve(this.curveName),this.setPublicKeyHex(i)},void 0!==e&&void 0!==e.curve&&(this.curveName=e.curve),void 0===this.curveName&&(this.curveName="secp256r1"),this.setNamedCurve(this.curveName),void 0!==e&&(void 0!==e.prv&&this.setPrivateKeyHex(e.prv),void 0!==e.pub&&this.setPublicKeyHex(e.pub))},X.crypto.ECDSA.parseSigHex=function(e){var t=X.crypto.ECDSA.parseSigHexInHexRS(e);return{r:new l(t.r,16),s:new l(t.s,16)}},X.crypto.ECDSA.parseSigHexInHexRS=function(e){var t=ee.getChildIdx,r=ee.getV;if(ee.checkStrictDER(e,0),"30"!=e.substr(0,2))throw new Error("signature is not a ASN.1 sequence");var n=t(e,0);if(2!=n.length)throw new Error("signature shall have two elements");var i=n[0],s=n[1];if("02"!=e.substr(i,2))throw new Error("1st item not ASN.1 integer");if("02"!=e.substr(s,2))throw new Error("2nd item not ASN.1 integer");return{r:r(e,i),s:r(e,s)}},X.crypto.ECDSA.asn1SigToConcatSig=function(e){var t=X.crypto.ECDSA.parseSigHexInHexRS(e),r=t.r,n=t.s;if(r.length>=130&&r.length<=134){if(r.length%2!=0)throw Error("unknown ECDSA sig r length error");if(n.length%2!=0)throw Error("unknown ECDSA sig s length error");"00"==r.substr(0,2)&&(r=r.substr(2)),"00"==n.substr(0,2)&&(n=n.substr(2));var i=Math.max(r.length,n.length);return(r=("000000"+r).slice(-i))+("000000"+n).slice(-i)}if("00"==r.substr(0,2)&&r.length%32==2&&(r=r.substr(2)),"00"==n.substr(0,2)&&n.length%32==2&&(n=n.substr(2)),r.length%32==30&&(r="00"+r),n.length%32==30&&(n="00"+n),r.length%32!=0)throw Error("unknown ECDSA sig r length error");if(n.length%32!=0)throw Error("unknown ECDSA sig s length error");return r+n},X.crypto.ECDSA.concatSigToASN1Sig=function(e){if(e.length%4!=0)throw Error("unknown ECDSA concatinated r-s sig length error");var t=e.substr(0,e.length/2),r=e.substr(e.length/2);return X.crypto.ECDSA.hexRSSigToASN1Sig(t,r)},X.crypto.ECDSA.hexRSSigToASN1Sig=function(e,t){var r=new l(e,16),n=new l(t,16);return X.crypto.ECDSA.biRSSigToASN1Sig(r,n)},X.crypto.ECDSA.biRSSigToASN1Sig=function(e,t){var r=X.asn1,n=new r.DERInteger({bigint:e}),i=new r.DERInteger({bigint:t});return new r.DERSequence({array:[n,i]}).tohex()},X.crypto.ECDSA.getName=function(e){return"2b8104001f"===e?"secp192k1":"2a8648ce3d030107"===e?"secp256r1":"2b8104000a"===e?"secp256k1":"2b81040021"===e?"secp224r1":"2b81040022"===e?"secp384r1":"2b81040023"===e?"secp521r1":-1!=="|secp256r1|NIST P-256|P-256|prime256v1|".indexOf(e)?"secp256r1":-1!=="|secp256k1|".indexOf(e)?"secp256k1":-1!=="|secp224r1|NIST P-224|P-224|".indexOf(e)?"secp224r1":-1!=="|secp384r1|NIST P-384|P-384|".indexOf(e)?"secp384r1":-1!=="|secp521r1|NIST P-521|P-521|".indexOf(e)?"secp521r1":null},void 0!==X&&X||(X={}),void 0!==X.crypto&&X.crypto||(X.crypto={}),X.crypto.ECParameterDB=new function(){var e={},t={};function r(e){return new l(e,16)}this.getByName=function(r){var n=r;if(void 0!==t[n]&&(n=t[r]),void 0!==e[n])return e[n];throw"unregistered EC curve name: "+n},this.regist=function(n,i,s,o,a,c,u,l,h,d,m,p){e[n]={};var f=r(s),g=r(o),y=r(a),v=r(c),b=r(u),S=new z(f,g,y),w=S.decodePointHex("04"+l+h);e[n].name=n,e[n].keylen=i,e[n].keycharlen=2*Math.ceil(i/8),e[n].curve=S,e[n].G=w,e[n].n=v,e[n].h=b,e[n].oid=m,e[n].info=p;for(var C=0;C<d.length;C++)t[d[C]]=n}},X.crypto.ECParameterDB.regist("secp128r1",128,"FFFFFFFDFFFFFFFFFFFFFFFFFFFFFFFF","FFFFFFFDFFFFFFFFFFFFFFFFFFFFFFFC","E87579C11079F43DD824993C2CEE5ED3","FFFFFFFE0000000075A30D1B9038A115","1","161FF7528B899B2D0C28607CA52C5B86","CF5AC8395BAFEB13C02DA292DDED7A83",[],"","secp128r1 : SECG curve over a 128 bit prime field"),X.crypto.ECParameterDB.regist("secp160k1",160,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFAC73","0","7","0100000000000000000001B8FA16DFAB9ACA16B6B3","1","3B4C382CE37AA192A4019E763036F4F5DD4D7EBB","938CF935318FDCED6BC28286531733C3F03C4FEE",[],"","secp160k1 : SECG curve over a 160 bit prime field"),X.crypto.ECParameterDB.regist("secp160r1",160,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF7FFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF7FFFFFFC","1C97BEFC54BD7A8B65ACF89F81D4D4ADC565FA45","0100000000000000000001F4C8F927AED3CA752257","1","4A96B5688EF573284664698968C38BB913CBFC82","23A628553168947D59DCC912042351377AC5FB32",[],"","secp160r1 : SECG curve over a 160 bit prime field"),X.crypto.ECParameterDB.regist("secp192k1",192,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFEE37","0","3","FFFFFFFFFFFFFFFFFFFFFFFE26F2FC170F69466A74DEFD8D","1","DB4FF10EC057E9AE26B07D0280B7F4341DA5D1B1EAE06C7D","9B2F2F6D9C5628A7844163D015BE86344082AA88D95E2F9D",[]),X.crypto.ECParameterDB.regist("secp192r1",192,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFC","64210519E59C80E70FA7E9AB72243049FEB8DEECC146B9B1","FFFFFFFFFFFFFFFFFFFFFFFF99DEF836146BC9B1B4D22831","1","188DA80EB03090F67CBF20EB43A18800F4FF0AFD82FF1012","07192B95FFC8DA78631011ED6B24CDD573F977A11E794811",[]),X.crypto.ECParameterDB.regist("secp224r1",224,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000001","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFE","B4050A850C04B3ABF54132565044B0B7D7BFD8BA270B39432355FFB4","FFFFFFFFFFFFFFFFFFFFFFFFFFFF16A2E0B8F03E13DD29455C5C2A3D","1","B70E0CBD6BB4BF7F321390B94A03C1D356C21122343280D6115C1D21","BD376388B5F723FB4C22DFE6CD4375A05A07476444D5819985007E34",[]),X.crypto.ECParameterDB.regist("secp256k1",256,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFC2F","0","7","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141","1","79BE667EF9DCBBAC55A06295CE870B07029BFCDB2DCE28D959F2815B16F81798","483ADA7726A3C4655DA4FBFC0E1108A8FD17B448A68554199C47D08FFB10D4B8",[]),X.crypto.ECParameterDB.regist("secp256r1",256,"FFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF","FFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFC","5AC635D8AA3A93E7B3EBBD55769886BC651D06B0CC53B0F63BCE3C3E27D2604B","FFFFFFFF00000000FFFFFFFFFFFFFFFFBCE6FAADA7179E84F3B9CAC2FC632551","1","6B17D1F2E12C4247F8BCE6E563A440F277037D812DEB33A0F4A13945D898C296","4FE342E2FE1A7F9B8EE7EB4A7C0F9E162BCE33576B315ECECBB6406837BF51F5",["NIST P-256","P-256","prime256v1"]),X.crypto.ECParameterDB.regist("secp384r1",384,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFF0000000000000000FFFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFF0000000000000000FFFFFFFC","B3312FA7E23EE7E4988E056BE3F82D19181D9C6EFE8141120314088F5013875AC656398D8A2ED19D2A85C8EDD3EC2AEF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFC7634D81F4372DDF581A0DB248B0A77AECEC196ACCC52973","1","AA87CA22BE8B05378EB1C71EF320AD746E1D3B628BA79B9859F741E082542A385502F25DBF55296C3A545E3872760AB7","3617de4a96262c6f5d9e98bf9292dc29f8f41dbd289a147ce9da3113b5f0b8c00a60b1ce1d7e819d7a431d7c90ea0e5f",["NIST P-384","P-384"]),X.crypto.ECParameterDB.regist("secp521r1",521,"1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF","1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFC","051953EB9618E1C9A1F929A21A0B68540EEA2DA725B99B315F3B8B489918EF109E156193951EC7E937B1652C0BD3BB1BF073573DF883D2C34F1EF451FD46B503F00","1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFA51868783BF2F966B7FCC0148F709A5D03BB5C9B8899C47AEBB6FB71E91386409","1","00C6858E06B70404E9CD9E3ECB662395B4429C648139053FB521F828AF606B4D3DBAA14B5E77EFE75928FE1DC127A2FFA8DE3348B3C1856A429BF97E7E31C2E5BD66","011839296a789a3bc0045c8a5fb42c7d1bd998f54449579b446817afbd17273e662c97ee72995ef42640c550b9013fad0761353c7086a272c24088be94769fd16650",["NIST P-521","P-521"]),void 0!==X&&X||(X={}),void 0!==X.crypto&&X.crypto||(X.crypto={}),X.crypto.DSA=function(){var e=ee.getVbyListEx,t=ee.isASN1HEX,r=l;this.p=null,this.q=null,this.g=null,this.y=null,this.x=null,this.type="DSA",this.isPrivate=!1,this.isPublic=!1,this.setPrivate=function(e,t,r,n,i){this.isPrivate=!0,this.p=e,this.q=t,this.g=r,this.y=n,this.x=i},this.setPrivateHex=function(e,t,r,n,i){var s,o,a,c,u;s=new l(e,16),o=new l(t,16),a=new l(r,16),c="string"==typeof n&&n.length>1?new l(n,16):null,u=new l(i,16),this.setPrivate(s,o,a,c,u)},this.setPublic=function(e,t,r,n){this.isPublic=!0,this.p=e,this.q=t,this.g=r,this.y=n,this.x=null},this.setPublicHex=function(e,t,r,n){var i,s,o,a;i=new l(e,16),s=new l(t,16),o=new l(r,16),a=new l(n,16),this.setPublic(i,s,o,a)},this.signWithMessageHash=function(e){var t=this.p,r=this.q,n=this.g,i=this.x,s=X.crypto.Util.getRandomBigIntegerMinToMax(l.ONE.add(l.ONE),r.subtract(l.ONE)),o=new l(e.substr(0,r.bitLength()/4),16),a=n.modPow(s,t).mod(r),c=s.modInverse(r).multiply(o.add(i.multiply(a))).mod(r);return X.asn1.ASN1Util.jsonToASN1HEX({seq:[{int:{bigint:a}},{int:{bigint:c}}]})},this.verifyWithMessageHash=function(e,t){var r=this.p,n=this.q,i=this.g,s=this.y,o=this.parseASN1Signature(t),a=o[0],c=o[1],u=new l(e.substr(0,n.bitLength()/4),16);if(l.ZERO.compareTo(a)>0||a.compareTo(n)>0)throw"invalid DSA signature";if(l.ZERO.compareTo(c)>=0||c.compareTo(n)>0)throw"invalid DSA signature";var h=c.modInverse(n),d=u.multiply(h).mod(n),m=a.multiply(h).mod(n);return 0==i.modPow(d,r).multiply(s.modPow(m,r)).mod(r).mod(n).compareTo(a)},this.parseASN1Signature=function(t){try{return[new r(e(t,0,[0],"02"),16),new r(e(t,0,[1],"02"),16)]}catch(e){throw new Error("malformed ASN.1 DSA signature")}},this.readPKCS5PrvKeyHex=function(r){var n,i,s,o,a;if(!1===t(r))throw new Error("not ASN.1 hex string");try{n=e(r,0,[1],"02"),i=e(r,0,[2],"02"),s=e(r,0,[3],"02"),o=e(r,0,[4],"02"),a=e(r,0,[5],"02")}catch(e){throw new Error("malformed PKCS#1/5 plain DSA private key")}this.setPrivateHex(n,i,s,o,a)},this.readPKCS8PrvKeyHex=function(r){var n,i,s,o;if(!1===t(r))throw new Error("not ASN.1 hex string");try{n=e(r,0,[1,1,0],"02"),i=e(r,0,[1,1,1],"02"),s=e(r,0,[1,1,2],"02"),o=e(r,0,[2,0],"02")}catch(e){throw new Error("malformed PKCS#8 plain DSA private key")}this.setPrivateHex(n,i,s,null,o)},this.readPKCS8PubKeyHex=function(r){var n,i,s,o;if(!1===t(r))throw new Error("not ASN.1 hex string");try{n=e(r,0,[0,1,0],"02"),i=e(r,0,[0,1,1],"02"),s=e(r,0,[0,1,2],"02"),o=e(r,0,[1,0],"02")}catch(e){throw new Error("malformed PKCS#8 DSA public key")}this.setPublicHex(n,i,s,o)},this.readCertPubKeyHex=function(r,n){var i,s,o,a;if(!1===t(r))throw new Error("not ASN.1 hex string");try{i=e(r,0,[0,5,0,1,0],"02"),s=e(r,0,[0,5,0,1,1],"02"),o=e(r,0,[0,5,0,1,2],"02"),a=e(r,0,[0,5,1,0],"02")}catch(e){throw new Error("malformed X.509 certificate DSA public key")}this.setPublicHex(i,s,o,a)}};var Ve=function(){var e=function(e,r,n){return t(i.AES,e,r,n)},t=function(e,t,r,n){var s=i.enc.Hex.parse(t),o=i.enc.Hex.parse(r),a=i.enc.Hex.parse(n),c={};c.key=o,c.iv=a,c.ciphertext=s;var u=e.decrypt(c,o,{iv:a});return i.enc.Hex.stringify(u)},r=function(e,t,r){return n(i.AES,e,t,r)},n=function(e,t,r,n){var s=i.enc.Hex.parse(t),o=i.enc.Hex.parse(r),a=i.enc.Hex.parse(n),c=e.encrypt(s,o,{iv:a}),u=i.enc.Hex.parse(c.toString());return i.enc.Base64.stringify(u)},s={"AES-256-CBC":{proc:e,eproc:r,keylen:32,ivlen:16},"AES-192-CBC":{proc:e,eproc:r,keylen:24,ivlen:16},"AES-128-CBC":{proc:e,eproc:r,keylen:16,ivlen:16},"DES-EDE3-CBC":{proc:function(e,r,n){return t(i.TripleDES,e,r,n)},eproc:function(e,t,r){return n(i.TripleDES,e,t,r)},keylen:24,ivlen:8},"DES-CBC":{proc:function(e,r,n){return t(i.DES,e,r,n)},eproc:function(e,t,r){return n(i.DES,e,t,r)},keylen:8,ivlen:8}},o=function(e){var t={},r=e.match(new RegExp("DEK-Info: ([^,]+),([0-9A-Fa-f]+)","m"));r&&(t.cipher=r[1],t.ivsalt=r[2]);var n=e.match(new RegExp("-----BEGIN ([A-Z]+) PRIVATE KEY-----"));n&&(t.type=n[1]);var i=-1,s=0;-1!=e.indexOf("\r\n\r\n")&&(i=e.indexOf("\r\n\r\n"),s=2),-1!=e.indexOf("\n\n")&&(i=e.indexOf("\n\n"),s=1);var o=e.indexOf("-----END");if(-1!=i&&-1!=o){var a=e.substring(i+2*s,o-s);a=a.replace(/\s+/g,""),t.data=a}return t},a=function(e,t,r){for(var n=r.substring(0,16),o=i.enc.Hex.parse(n),a=i.enc.Utf8.parse(t),c=s[e].keylen+s[e].ivlen,u="",l=null;;){var h=i.algo.MD5.create();if(null!=l&&h.update(l),h.update(a),h.update(o),l=h.finalize(),(u+=i.enc.Hex.stringify(l)).length>=2*c)break}var d={};return d.keyhex=u.substr(0,2*s[e].keylen),d.ivhex=u.substr(2*s[e].keylen,2*s[e].ivlen),d},c=function(e,t,r,n){var o=i.enc.Base64.parse(e),a=i.enc.Hex.stringify(o);return(0,s[t].proc)(a,r,n)};return{version:"1.0.0",parsePKCS5PEM:function(e){return o(e)},getKeyAndUnusedIvByPasscodeAndIvsalt:function(e,t,r){return a(e,t,r)},decryptKeyB64:function(e,t,r,n){return c(e,t,r,n)},getDecryptedKeyHex:function(e,t){var r=o(e),n=r.cipher,i=r.ivsalt,s=r.data,u=a(n,t,i);return c(s,n,u.keyhex,i)},getEncryptedPKCS5PEMFromPrvKeyHex:function(e,t,r,n,o){var c="";if(void 0!==n&&null!=n||(n="AES-256-CBC"),void 0===s[n])throw new Error("KEYUTIL unsupported algorithm: "+n);void 0!==o&&null!=o||(o=function(e){var t=i.lib.WordArray.random(e);return i.enc.Hex.stringify(t)}(s[n].ivlen).toUpperCase());var u=function(e,t,r,n){return(0,s[t].eproc)(e,r,n)}(t,n,a(n,r,o).keyhex,o);return c="-----BEGIN "+e+" PRIVATE KEY-----\r\n",c+="Proc-Type: 4,ENCRYPTED\r\n",c+="DEK-Info: "+n+","+o+"\r\n",c+="\r\n",(c+=u.replace(/(.{64})/g,"$1\r\n"))+"\r\n-----END "+e+" PRIVATE KEY-----\r\n"},parseHexOfEncryptedPKCS8:function(e){var t=ee.getChildIdx,r=ee.getV,n={},i=t(e,0);if(2!=i.length)throw new Error("malformed format: SEQUENCE(0).items != 2: "+i.length);n.ciphertext=r(e,i[1]);var s=t(e,i[0]);if(2!=s.length)throw new Error("malformed format: SEQUENCE(0.0).items != 2: "+s.length);if("2a864886f70d01050d"!=r(e,s[0]))throw new Error("this only supports pkcs5PBES2");var o=t(e,s[1]);if(2!=s.length)throw new Error("malformed format: SEQUENCE(0.0.1).items != 2: "+o.length);var a=t(e,o[1]);if(2!=a.length)throw new Error("malformed format: SEQUENCE(0.0.1.1).items != 2: "+a.length);if("2a864886f70d0307"!=r(e,a[0]))throw"this only supports TripleDES";n.encryptionSchemeAlg="TripleDES",n.encryptionSchemeIV=r(e,a[1]);var c=t(e,o[0]);if(2!=c.length)throw new Error("malformed format: SEQUENCE(0.0.1.0).items != 2: "+c.length);if("2a864886f70d01050c"!=r(e,c[0]))throw new Error("this only supports pkcs5PBKDF2");var u=t(e,c[1]);if(u.length<2)throw new Error("malformed format: SEQUENCE(0.0.1.0.1).items < 2: "+u.length);n.pbkdf2Salt=r(e,u[0]);var l=r(e,u[1]);try{n.pbkdf2Iter=parseInt(l,16)}catch(e){throw new Error("malformed format pbkdf2Iter: "+l)}return n},getPBKDF2KeyHexFromParam:function(e,t){var r=i.enc.Hex.parse(e.pbkdf2Salt),n=i.PBKDF2(t,r,{keySize:6,iterations:e.pbkdf2Iter});return i.enc.Hex.stringify(n)},_getPlainPKCS8HexFromEncryptedPKCS8PEM:function(e,t){var r=ve(e,"ENCRYPTED PRIVATE KEY"),n=this.parseHexOfEncryptedPKCS8(r),s=Ve.getPBKDF2KeyHexFromParam(n,t),o={};o.ciphertext=i.enc.Hex.parse(n.ciphertext);var a=i.enc.Hex.parse(s),c=i.enc.Hex.parse(n.encryptionSchemeIV),u=i.TripleDES.decrypt(o,a,{iv:c});return i.enc.Hex.stringify(u)},getKeyFromEncryptedPKCS8PEM:function(e,t){var r=this._getPlainPKCS8HexFromEncryptedPKCS8PEM(e,t);return this.getKeyFromPlainPrivatePKCS8Hex(r)},parsePlainPrivatePKCS8Hex:function(e){var t=ee,r=t.getChildIdx,n=t.getV,i={algparam:null};if("30"!=e.substr(0,2))throw new Error("malformed plain PKCS8 private key(code:001)");var s=r(e,0);if(s.length<3)throw new Error("malformed plain PKCS8 private key(code:002)");if("30"!=e.substr(s[1],2))throw new Error("malformed PKCS8 private key(code:003)");var o=r(e,s[1]);if(2!=o.length)throw new Error("malformed PKCS8 private key(code:004)");if("06"!=e.substr(o[0],2))throw new Error("malformed PKCS8 private key(code:005)");if(i.algoid=n(e,o[0]),"06"==e.substr(o[1],2)&&(i.algparam=n(e,o[1])),"04"!=e.substr(s[2],2))throw new Error("malformed PKCS8 private key(code:006)");return i.keyidx=t.getVidx(e,s[2]),i},getKeyFromPlainPrivatePKCS8PEM:function(e){var t=ve(e,"PRIVATE KEY");return this.getKeyFromPlainPrivatePKCS8Hex(t)},getKeyFromPlainPrivatePKCS8Hex:function(e){var t,r=this.parsePlainPrivatePKCS8Hex(e);if("2a864886f70d010101"==r.algoid)t=new K;else if("2a8648ce380401"==r.algoid)t=new X.crypto.DSA;else{if("2a8648ce3d0201"!=r.algoid)throw new Error("unsupported private key algorithm");t=new X.crypto.ECDSA}return t.readPKCS8PrvKeyHex(e),t},_getKeyFromPublicPKCS8Hex:function(e){var t,r=ee.getVbyList(e,0,[0,0],"06");if("2a864886f70d010101"===r)t=new K;else if("2a8648ce380401"===r)t=new X.crypto.DSA;else{if("2a8648ce3d0201"!==r)throw new Error("unsupported PKCS#8 public key hex");t=new X.crypto.ECDSA}return t.readPKCS8PubKeyHex(e),t},parsePublicRawRSAKeyHex:function(e){var t=ee.getChildIdx,r=ee.getV,n={};if("30"!=e.substr(0,2))throw new Error("malformed RSA key(code:001)");var i=t(e,0);if(2!=i.length)throw new Error("malformed RSA key(code:002)");if("02"!=e.substr(i[0],2))throw new Error("malformed RSA key(code:003)");if(n.n=r(e,i[0]),"02"!=e.substr(i[1],2))throw new Error("malformed RSA key(code:004)");return n.e=r(e,i[1]),n},parsePublicPKCS8Hex:function(e){var t=ee,r=t.getChildIdx,n=t.getV,i={algparam:null},s=r(e,0);if(2!=s.length)throw new Error("outer DERSequence shall have 2 elements: "+s.length);var o=s[0];if("30"!=e.substr(o,2))throw new Error("malformed PKCS8 public key(code:001)");var a=r(e,o);if(2!=a.length)throw new Error("malformed PKCS8 public key(code:002)");if("06"!=e.substr(a[0],2))throw new Error("malformed PKCS8 public key(code:003)");if(i.algoid=n(e,a[0]),"06"==e.substr(a[1],2)?i.algparam=n(e,a[1]):"30"==e.substr(a[1],2)&&(i.algparam={},i.algparam.p=t.getVbyList(e,a[1],[0],"02"),i.algparam.q=t.getVbyList(e,a[1],[1],"02"),i.algparam.g=t.getVbyList(e,a[1],[2],"02")),"03"!=e.substr(s[1],2))throw new Error("malformed PKCS8 public key(code:004)");return i.key=n(e,s[1]).substr(2),i}}}();function $e(e,t){for(var r="",n=t/4-e.length,i=0;i<n;i++)r+="0";return r+e}function Ue(e,t,r){for(var n="",i=0;n.length<t;)n+=de(r(me(e+String.fromCharCode.apply(String,[(4278190080&i)>>24,(16711680&i)>>16,(65280&i)>>8,255&i])))),i+=1;return n}function Ke(e){for(var t in X.crypto.Util.DIGESTINFOHEAD){var r=X.crypto.Util.DIGESTINFOHEAD[t],n=r.length;if(e.substring(0,n)==r)return[t,e.substring(n)]}return[]}function We(e){var t,r=ee,n=r.getChildIdx,i=r.getV,s=r.parse,o=r.getTLV,a=r.getVbyList,c=r.getVbyListEx,u=r.getTLVbyList,l=r.getTLVbyListEx,h=r.getIdxbyList,d=r.getIdxbyListEx,m=r.getVidx,p=r.getInt,f=r.oidname,g=r.hextooidstr,y=ve;try{t=X.asn1.x509.AlgorithmIdentifier.PSSNAME2ASN1TLV}catch(e){}this.HEX2STAG={"0c":"utf8",13:"prn",16:"ia5","1a":"vis","1e":"bmp"},this.hex=null,this.version=0,this.foffset=0,this.aExtInfo=null,this.getVersion=function(){if(null===this.hex||0!==this.version)return this.version;var e=u(this.hex,0,[0,0]);if("a0"==e.substr(0,2)){var t=u(e,0,[0]),r=p(t,0);if(r<0||2<r)throw new Error("malformed version field");return this.version=r+1,this.version}return this.version=1,this.foffset=-1,1},this.getSerialNumberHex=function(){return c(this.hex,0,[0,0],"02")},this.getSignatureAlgorithmField=function(){var e=l(this.hex,0,[0,1]);return this.getAlgorithmIdentifierName(e)},this.getAlgorithmIdentifierName=function(e){for(var r in t)if(e===t[r])return r;return f(c(e,0,[0],"06"))},this.getIssuer=function(){return this.getX500Name(this.getIssuerHex())},this.getIssuerHex=function(){return u(this.hex,0,[0,3+this.foffset],"30")},this.getIssuerString=function(){return this.getIssuer().str},this.getSubject=function(){return this.getX500Name(this.getSubjectHex())},this.getSubjectHex=function(){return u(this.hex,0,[0,5+this.foffset],"30")},this.getSubjectString=function(){return this.getSubject().str},this.getNotBefore=function(){var e=a(this.hex,0,[0,4+this.foffset,0]);return e=e.replace(/(..)/g,"%$1"),decodeURIComponent(e)},this.getNotAfter=function(){var e=a(this.hex,0,[0,4+this.foffset,1]);return e=e.replace(/(..)/g,"%$1"),decodeURIComponent(e)},this.getPublicKeyHex=function(){return this.getSPKI()},this.getSPKI=function(){return u(this.hex,0,[0,6+this.foffset],"30")},this.getSPKIValue=function(){var e=this.getSPKI();return null==e?null:a(e,0,[1],"03",!0)},this.getPublicKeyIdx=function(){return h(this.hex,0,[0,6+this.foffset],"30")},this.getPublicKeyContentIdx=function(){var e=this.getPublicKeyIdx();return h(this.hex,e,[1,0],"30")},this.getPublicKey=function(){return Ve.getKey(this.getPublicKeyHex(),null,"pkcs8pub")},this.getSignatureAlgorithmName=function(){var e=u(this.hex,0,[1],"30");return this.getAlgorithmIdentifierName(e)},this.getSignatureValueHex=function(){return a(this.hex,0,[2],"03",!0)},this.verifySignature=function(e){var t=this.getSignatureAlgorithmField(),r=this.getSignatureValueHex(),n=u(this.hex,0,[0],"30"),i=new X.crypto.Signature({alg:t});return i.init(e),i.updateHex(n),i.verify(r)},this.parseExt=function(e){var t,s,o;if(void 0===e){if(3!==this.version)return-1;t=h(o=this.hex,0,[0,7,0],"30"),s=n(o,t)}else{o=ve(e);var c=h(o,0,[0,3,0,0],"06");if("2a864886f70d01090e"!=i(o,c))return void(this.aExtInfo=new Array);t=h(o,0,[0,3,0,1,0],"30"),s=n(o,t),this.hex=o}this.aExtInfo=new Array;for(var u=0;u<s.length;u++){var l={critical:!1},d=0;3===n(o,s[u]).length&&(l.critical=!0,d=1),l.oid=r.hextooidstr(a(o,s[u],[0],"06"));var p=h(o,s[u],[1+d]);l.vidx=m(o,p),this.aExtInfo.push(l)}},this.getExtInfo=function(e){var t=this.aExtInfo,r=e;if(e.match(/^[0-9.]+$/)||(r=X.asn1.x509.OID.name2oid(e)),""!==r)for(var n=0;n<t.length;n++)if(t[n].oid===r)return t[n]},this.getExtBasicConstraints=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("basicConstraints");if(void 0===r)return;e=o(this.hex,r.vidx),t=r.critical}var n={extname:"basicConstraints"};if(t&&(n.critical=!0),"3000"===e)return n;if("30030101ff"===e)return n.cA=!0,n;if("30060101ff02"===e.substr(0,12)){var s=i(e,10),a=parseInt(s,16);return n.cA=!0,n.pathLen=a,n}throw new Error("hExtV parse error: "+e)},this.getExtNameConstraints=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("nameConstraints");if(void 0===r)return;e=o(this.hex,r.vidx),t=r.critical}var i={extname:"nameConstraints"};t&&(i.critical=!0);for(var s=n(e,0),a=0;a<s.length;a++){for(var c=[],u=n(e,s[a]),l=0;l<u.length;l++){var h=o(e,u[l]),d=this.getGeneralSubtree(h);c.push(d)}var m=e.substr(s[a],2);"a0"==m?i.permit=c:"a1"==m&&(i.exclude=c)}return i},this.getGeneralSubtree=function(e){var t=n(e,0),r=t.length;if(r<1||2<r)throw new Error("wrong num elements");for(var s=this.getGeneralName(o(e,t[0])),a=1;a<r;a++){var c=e.substr(t[a],2),u=i(e,t[a]),l=parseInt(u,16);"80"==c&&(s.min=l),"81"==c&&(s.max=l)}return s},this.getExtKeyUsage=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("keyUsage");if(void 0===r)return;e=o(this.hex,r.vidx),t=r.critical}var n={extname:"keyUsage"};return t&&(n.critical=!0),n.names=this.getExtKeyUsageString(e).split(","),n},this.getExtKeyUsageBin=function(e){if(void 0===e){var t=this.getExtInfo("keyUsage");if(void 0===t)return"";e=o(this.hex,t.vidx)}if(8!=e.length&&10!=e.length)throw new Error("malformed key usage value: "+e);var r="000000000000000"+parseInt(e.substr(6),16).toString(2);return 8==e.length&&(r=r.slice(-8)),10==e.length&&(r=r.slice(-16)),""==(r=r.replace(/0+$/,""))&&(r="0"),r},this.getExtKeyUsageString=function(e){for(var t=this.getExtKeyUsageBin(e),r=new Array,n=0;n<t.length;n++)"1"==t.substr(n,1)&&r.push(We.KEYUSAGE_NAME[n]);return r.join(",")},this.getExtSubjectKeyIdentifier=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("subjectKeyIdentifier");if(void 0===r)return;e=o(this.hex,r.vidx),t=r.critical}var n={extname:"subjectKeyIdentifier"};t&&(n.critical=!0);var s=i(e,0);return n.kid={hex:s},n},this.getExtAuthorityKeyIdentifier=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("authorityKeyIdentifier");if(void 0===r)return;e=o(this.hex,r.vidx),t=r.critical}var s={extname:"authorityKeyIdentifier"};t&&(s.critical=!0);for(var a=n(e,0),c=0;c<a.length;c++){var u=e.substr(a[c],2);if("80"===u&&(s.kid={hex:i(e,a[c])}),"a1"===u){var l=o(e,a[c]),h=this.getGeneralNames(l);s.issuer=h[0].dn}"82"===u&&(s.sn={hex:i(e,a[c])})}return s},this.getExtExtKeyUsage=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("extKeyUsage");if(void 0===r)return;e=o(this.hex,r.vidx),t=r.critical}var s={extname:"extKeyUsage",array:[]};t&&(s.critical=!0);for(var a=n(e,0),c=0;c<a.length;c++)s.array.push(f(i(e,a[c])));return s},this.getExtExtKeyUsageName=function(){var e=this.getExtInfo("extKeyUsage");if(void 0===e)return e;var t=new Array,r=o(this.hex,e.vidx);if(""===r)return t;for(var s=n(r,0),a=0;a<s.length;a++)t.push(f(i(r,s[a])));return t},this.getExtSubjectAltName=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("subjectAltName");if(void 0===r)return;e=o(this.hex,r.vidx),t=r.critical}var n={extname:"subjectAltName",array:[]};return t&&(n.critical=!0),n.array=this.getGeneralNames(e),n},this.getExtIssuerAltName=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("issuerAltName");if(void 0===r)return;e=o(this.hex,r.vidx),t=r.critical}var n={extname:"issuerAltName",array:[]};return t&&(n.critical=!0),n.array=this.getGeneralNames(e),n},this.getGeneralNames=function(e){for(var t=n(e,0),r=[],i=0;i<t.length;i++){var s=this.getGeneralName(o(e,t[i]));void 0!==s&&r.push(s)}return r},this.getGeneralName=function(e){var t=e.substr(0,2),r=i(e,0),n=de(r);return"81"==t?{rfc822:n}:"82"==t?{dns:n}:"86"==t?{uri:n}:"87"==t?{ip:Te(r)}:"a4"==t?{dn:this.getX500Name(r)}:"a0"==t?{other:this.getOtherName(e)}:void 0},this.getExtSubjectAltName2=function(){var e,t,r,s=this.getExtInfo("subjectAltName");if(void 0===s)return s;for(var a=new Array,c=o(this.hex,s.vidx),u=n(c,0),l=0;l<u.length;l++)r=c.substr(u[l],2),e=i(c,u[l]),"81"===r&&(t=le(e),a.push(["MAIL",t])),"82"===r&&(t=le(e),a.push(["DNS",t])),"84"===r&&(t=We.hex2dn(e,0),a.push(["DN",t])),"86"===r&&(t=le(e),a.push(["URI",t])),"87"===r&&(t=Te(e),a.push(["IP",t]));return a},this.getExtCRLDistributionPoints=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("cRLDistributionPoints");if(void 0===r)return;e=o(this.hex,r.vidx),t=r.critical}var i={extname:"cRLDistributionPoints",array:[]};t&&(i.critical=!0);for(var s=n(e,0),a=0;a<s.length;a++){var c=o(e,s[a]);i.array.push(this.getDistributionPoint(c))}return i},this.getDistributionPoint=function(e){for(var t={},r=n(e,0),i=0;i<r.length;i++){var s=e.substr(r[i],2),a=o(e,r[i]);"a0"==s&&(t.dpname=this.getDistributionPointName(a))}return t},this.getDistributionPointName=function(e){for(var t={},r=n(e,0),i=0;i<r.length;i++){var s=e.substr(r[i],2),a=o(e,r[i]);"a0"==s&&(t.full=this.getGeneralNames(a))}return t},this.getExtCRLDistributionPointsURI=function(){var e=this.getExtCRLDistributionPoints();if(null==e)return e;for(var t=e.array,r=[],n=0;n<t.length;n++)try{null!=t[n].dpname.full[0].uri&&r.push(t[n].dpname.full[0].uri)}catch(e){}return r},this.getExtAIAInfo=function(){var e=this.getExtInfo("authorityInfoAccess");if(void 0===e)return e;for(var t={ocsp:[],caissuer:[]},r=n(this.hex,e.vidx),i=0;i<r.length;i++){var s=a(this.hex,r[i],[0],"06"),o=a(this.hex,r[i],[1],"86");"2b06010505073001"===s&&t.ocsp.push(le(o)),"2b06010505073002"===s&&t.caissuer.push(le(o))}return t},this.getExtAuthorityInfoAccess=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("authorityInfoAccess");if(void 0===r)return;e=o(this.hex,r.vidx),t=r.critical}var i={extname:"authorityInfoAccess",array:[]};t&&(i.critical=!0);for(var s=n(e,0),u=0;u<s.length;u++){var l=c(e,s[u],[0],"06"),h=le(a(e,s[u],[1],"86"));if("2b06010505073001"==l)i.array.push({ocsp:h});else{if("2b06010505073002"!=l)throw new Error("unknown method: "+l);i.array.push({caissuer:h})}}return i},this.getExtCertificatePolicies=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("certificatePolicies");if(void 0===r)return;e=o(this.hex,r.vidx),t=r.critical}var i={extname:"certificatePolicies",array:[]};t&&(i.critical=!0);for(var s=n(e,0),a=0;a<s.length;a++){var c=o(e,s[a]),u=this.getPolicyInformation(c);i.array.push(u)}return i},this.getPolicyInformation=function(e){var t={},r=a(e,0,[0],"06");t.policyoid=f(r);var i=d(e,0,[1],"30");if(-1!=i){t.array=[];for(var s=n(e,i),c=0;c<s.length;c++){var u=o(e,s[c]),l=this.getPolicyQualifierInfo(u);t.array.push(l)}}return t},this.getOtherName=function(e){var t={},r=n(e,0),i=a(e,r[0],[],"06"),o=a(e,r[1],[]);return t.oid=X.asn1.ASN1Util.oidHexToInt(i),t.obj=s(o),t},this.getPolicyQualifierInfo=function(e){var t={},r=a(e,0,[0],"06");if("2b06010505070201"===r){var n=c(e,0,[1],"16");t.cps=de(n)}else if("2b06010505070202"===r){var i=u(e,0,[1],"30");t.unotice=this.getUserNotice(i)}return t},this.getUserNotice=function(e){for(var t={},r=n(e,0),i=0;i<r.length;i++){var s=o(e,r[i]);"30"!=s.substr(0,2)&&(t.exptext=this.getDisplayText(s))}return t},this.getDisplayText=function(e){var t={};return t.type={"0c":"utf8",16:"ia5","1a":"vis","1e":"bmp"}[e.substr(0,2)],t.str=de(i(e,0)),t},this.getExtCRLNumber=function(e,t){var r={extname:"cRLNumber"};if(t&&(r.critical=!0),"02"==e.substr(0,2))return r.num={hex:i(e,0)},r;throw new Error("hExtV parse error: "+e)},this.getExtCRLReason=function(e,t){var r={extname:"cRLReason"};if(t&&(r.critical=!0),"0a"==e.substr(0,2))return r.code=parseInt(i(e,0),16),r;throw new Error("hExtV parse error: "+e)},this.getExtOcspNonce=function(e,t){var r={extname:"ocspNonce"};t&&(r.critical=!0);var n=i(e,0);return r.hex=n,r},this.getExtOcspNoCheck=function(e,t){var r={extname:"ocspNoCheck"};return t&&(r.critical=!0),r},this.getExtAdobeTimeStamp=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("adobeTimeStamp");if(void 0===r)return;e=o(this.hex,r.vidx),t=r.critical}var i={extname:"adobeTimeStamp"};t&&(i.critical=!0);var s=n(e,0);if(s.length>1){var a=o(e,s[1]),c=this.getGeneralName(a);null!=c.uri&&(i.uri=c.uri)}if(s.length>2){var u=o(e,s[2]);"0101ff"==u&&(i.reqauth=!0),"010100"==u&&(i.reqauth=!1)}return i};var v=function(e){var t={};try{var r=X.asn1.x509.OID.name2oid(e.seq[0].oid);t.type=X.asn1.x509.OID.oid2atype(r);var n=e.seq[1];if(null!=n.utf8str)t.ds="utf8",t.value=n.utf8str.str;else if(null!=n.numstr)t.ds="num",t.value=n.numstr.str;else if(null!=n.telstr)t.ds="tel",t.value=n.telstr.str;else if(null!=n.prnstr)t.ds="prn",t.value=n.prnstr.str;else if(null!=n.ia5str)t.ds="ia5",t.value=n.ia5str.str;else if(null!=n.visstr)t.ds="vis",t.value=n.visstr.str;else{if(null==n.bmpstr)throw"error";t.ds="bmp",t.value=n.bmpstr.str}return t}catch(e){throw new Erorr("improper ASN.1 parsed AttrTypeAndValue")}},b=function(e){try{return e.set.map((function(e){return v(e)}))}catch(e){throw new Error("improper ASN.1 parsed RDN: "+e)}};this.getX500NameRule=function(e){for(var t=null,r=[],n=0;n<e.length;n++)for(var i=e[n],s=0;s<i.length;s++)r.push(i[s]);for(n=0;n<r.length;n++){var o=r[n],a=o.ds,c=o.type;if("prn"!=a&&"utf8"!=a&&"ia5"!=a)return"mixed";if("ia5"==a){if("CN"!=c)return"mixed";if(X.lang.String.isMail(o.value))continue;return"mixed"}if("C"==c){if("prn"==a)continue;return"mixed"}if(null==t)t=a;else if(t!==a)return"mixed"}return null==t?"prn":t},this.getAttrTypeAndValue=function(e){var t=s(e);return v(t)},this.getRDN=function(e){var t=s(e);return b(t)},this.getX500NameArray=function(e){return function(e){try{return e.seq.map((function(e){return b(e)}))}catch(e){throw new Error("improper ASN.1 parsed X500Name: "+e)}}(s(e))},this.getX500Name=function(e){var t=this.getX500NameArray(e);return{array:t,str:this.dnarraytostr(t)}},this.readCertPEM=function(e){this.readCertHex(y(e))},this.readCertHex=function(e){this.hex=e,this.getVersion();try{h(this.hex,0,[0,7],"a3"),this.parseExt()}catch(e){}},this.getParam=function(e){var t={};return t.version=this.getVersion(),t.serial={hex:this.getSerialNumberHex()},t.sigalg=this.getSignatureAlgorithmField(),t.issuer=this.getIssuer(),t.notbefore=this.getNotBefore(),t.notafter=this.getNotAfter(),t.subject=this.getSubject(),t.sbjpubkey=ye(this.getPublicKeyHex(),"PUBLIC KEY"),null!=this.aExtInfo&&this.aExtInfo.length>0&&(t.ext=this.getExtParamArray()),t.sighex=this.getSignatureValueHex(),"object"==typeof e&&(1==e.tbshex&&(t.tbshex=u(this.hex,0,[0])),1==e.nodnarray&&(delete t.issuer.array,delete t.subject.array)),t},this.getExtParamArray=function(e){null==e&&-1!=d(this.hex,0,[0,"[3]"])&&(e=l(this.hex,0,[0,"[3]",0],"30"));for(var t=[],r=n(e,0),i=0;i<r.length;i++){var s=o(e,r[i]),a=this.getExtParam(s);null!=a&&t.push(a)}return t},this.getExtParam=function(e){var t=n(e,0).length;if(2!=t&&3!=t)throw new Error("wrong number elements in Extension: "+t+" "+e);var r=g(a(e,0,[0],"06")),i=!1;3==t&&"0101ff"==u(e,0,[1])&&(i=!0);var s=u(e,0,[t-1,0]),o=void 0;if("2.5.29.14"==r?o=this.getExtSubjectKeyIdentifier(s,i):"2.5.29.15"==r?o=this.getExtKeyUsage(s,i):"2.5.29.17"==r?o=this.getExtSubjectAltName(s,i):"2.5.29.18"==r?o=this.getExtIssuerAltName(s,i):"2.5.29.19"==r?o=this.getExtBasicConstraints(s,i):"2.5.29.30"==r?o=this.getExtNameConstraints(s,i):"2.5.29.31"==r?o=this.getExtCRLDistributionPoints(s,i):"2.5.29.32"==r?o=this.getExtCertificatePolicies(s,i):"2.5.29.35"==r?o=this.getExtAuthorityKeyIdentifier(s,i):"2.5.29.37"==r?o=this.getExtExtKeyUsage(s,i):"1.3.6.1.5.5.7.1.1"==r?o=this.getExtAuthorityInfoAccess(s,i):"2.5.29.20"==r?o=this.getExtCRLNumber(s,i):"2.5.29.21"==r?o=this.getExtCRLReason(s,i):"1.3.6.1.5.5.7.48.1.2"==r?o=this.getExtOcspNonce(s,i):"1.3.6.1.5.5.7.48.1.5"==r?o=this.getExtOcspNoCheck(s,i):"1.2.840.113583.1.1.9.1"==r&&(o=this.getExtAdobeTimeStamp(s,i)),null!=o)return o;var c={extname:r,extn:s};return i&&(c.critical=!0),c},this.findExt=function(e,t){for(var r=0;r<e.length;r++)if(e[r].extname==t)return e[r];return null},this.updateExtCDPFullURI=function(e,t){var r=this.findExt(e,"cRLDistributionPoints");if(null!=r&&null!=r.array)for(var n=r.array,i=0;i<n.length;i++)if(null!=n[i].dpname&&null!=n[i].dpname.full)for(var s=n[i].dpname.full,o=0;o<s.length;o++){var a=s[i];null!=a.uri&&(a.uri=t)}},this.updateExtAIAOCSP=function(e,t){var r=this.findExt(e,"authorityInfoAccess");if(null!=r&&null!=r.array)for(var n=r.array,i=0;i<n.length;i++)null!=n[i].ocsp&&(n[i].ocsp=t)},this.updateExtAIACAIssuer=function(e,t){var r=this.findExt(e,"authorityInfoAccess");if(null!=r&&null!=r.array)for(var n=r.array,i=0;i<n.length;i++)null!=n[i].caissuer&&(n[i].caissuer=t)},this.dnarraytostr=function(e){return"/"+e.map((function(e){return function(e){return e.map((function(e){return function(e){return e.type+"="+e.value}(e).replace(/\+/,"\\+")})).join("+")}(e).replace(/\//,"\\/")})).join("/")},this.getInfo=function(){var e,t,r,n=function(e){return JSON.stringify(e.array).replace(/[\[\]\{\}\"]/g,"")},i=function(e){for(var t="",r=e.array,n=0;n<r.length;n++){var i=r[n];if(t+="    policy oid: "+i.policyoid+"\n",void 0!==i.array)for(var s=0;s<i.array.length;s++){var o=i.array[s];void 0!==o.cps&&(t+="    cps: "+o.cps+"\n")}}return t},s=function(e){for(var t="",r=e.array,n=0;n<r.length;n++){var i=r[n];try{void 0!==i.dpname.full[0].uri&&(t+="    "+i.dpname.full[0].uri+"\n")}catch(e){}try{void 0!==i.dname.full[0].dn.hex&&(t+="    "+We.hex2dn(i.dpname.full[0].dn.hex)+"\n")}catch(e){}}return t},o=function(e){for(var t="",r=e.array,n=0;n<r.length;n++){var i=r[n];void 0!==i.caissuer&&(t+="    caissuer: "+i.caissuer+"\n"),void 0!==i.ocsp&&(t+="    ocsp: "+i.ocsp+"\n")}return t};if(e="Basic Fields\n",e+="  serial number: "+this.getSerialNumberHex()+"\n",e+="  signature algorithm: "+this.getSignatureAlgorithmField()+"\n",e+="  issuer: "+this.getIssuerString()+"\n",e+="  notBefore: "+this.getNotBefore()+"\n",e+="  notAfter: "+this.getNotAfter()+"\n",e+="  subject: "+this.getSubjectString()+"\n",e+="  subject public key info: \n",e+="    key algorithm: "+(t=this.getPublicKey()).type+"\n","RSA"===t.type&&(e+="    n="+Re(t.n.toString(16)).substr(0,16)+"...\n",e+="    e="+Re(t.e.toString(16))+"\n"),null!=(r=this.aExtInfo)){e+="X509v3 Extensions:\n";for(var a=0;a<r.length;a++){var c=r[a],u=X.asn1.x509.OID.oid2name(c.oid);""===u&&(u=c.oid);var l="";if(!0===c.critical&&(l="CRITICAL"),e+="  "+u+" "+l+":\n","basicConstraints"===u){var h=this.getExtBasicConstraints();void 0===h.cA?e+="    {}\n":(e+="    cA=true",void 0!==h.pathLen&&(e+=", pathLen="+h.pathLen),e+="\n")}else if("keyUsage"===u)e+="    "+this.getExtKeyUsageString()+"\n";else if("subjectKeyIdentifier"===u)e+="    "+this.getExtSubjectKeyIdentifier().kid.hex+"\n";else if("authorityKeyIdentifier"===u){var d=this.getExtAuthorityKeyIdentifier();void 0!==d.kid&&(e+="    kid="+d.kid.hex+"\n")}else"extKeyUsage"===u?e+="    "+this.getExtExtKeyUsage().array.join(", ")+"\n":"subjectAltName"===u?e+="    "+n(this.getExtSubjectAltName())+"\n":"cRLDistributionPoints"===u?e+=s(this.getExtCRLDistributionPoints()):"authorityInfoAccess"===u?e+=o(this.getExtAuthorityInfoAccess()):"certificatePolicies"===u&&(e+=i(this.getExtCertificatePolicies()))}}return(e+="signature algorithm: "+this.getSignatureAlgorithmName()+"\n")+"signature: "+this.getSignatureValueHex().substr(0,16)+"...\n"},"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?this.readCertPEM(e):X.lang.String.isHex(e)&&this.readCertHex(e))}Ve.getKey=function(e,t,r){var n,i=(S=ee).getChildIdx,s=S.getVbyList,o=X.crypto,a=o.ECDSA,c=o.DSA,u=K,h=ve,d=Ve;if(void 0!==u&&e instanceof u)return e;if(void 0!==a&&e instanceof a)return e;if(void 0!==c&&e instanceof c)return e;if(void 0!==e.curve&&void 0!==e.xy&&void 0===e.d)return new a({pub:e.xy,curve:e.curve});if(void 0!==e.curve&&void 0!==e.d)return new a({prv:e.d,curve:e.curve});if(void 0===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0===e.d)return(k=new u).setPublic(e.n,e.e),k;if(void 0===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d&&void 0!==e.p&&void 0!==e.q&&void 0!==e.dp&&void 0!==e.dq&&void 0!==e.co&&void 0===e.qi)return(k=new u).setPrivateEx(e.n,e.e,e.d,e.p,e.q,e.dp,e.dq,e.co),k;if(void 0===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d&&void 0===e.p)return(k=new u).setPrivate(e.n,e.e,e.d),k;if(void 0!==e.p&&void 0!==e.q&&void 0!==e.g&&void 0!==e.y&&void 0===e.x)return(k=new c).setPublic(e.p,e.q,e.g,e.y),k;if(void 0!==e.p&&void 0!==e.q&&void 0!==e.g&&void 0!==e.y&&void 0!==e.x)return(k=new c).setPrivate(e.p,e.q,e.g,e.y,e.x),k;if("RSA"===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0===e.d)return(k=new u).setPublic(ce(e.n),ce(e.e)),k;if("RSA"===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d&&void 0!==e.p&&void 0!==e.q&&void 0!==e.dp&&void 0!==e.dq&&void 0!==e.qi)return(k=new u).setPrivateEx(ce(e.n),ce(e.e),ce(e.d),ce(e.p),ce(e.q),ce(e.dp),ce(e.dq),ce(e.qi)),k;if("RSA"===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d)return(k=new u).setPrivate(ce(e.n),ce(e.e),ce(e.d)),k;if("EC"===e.kty&&void 0!==e.crv&&void 0!==e.x&&void 0!==e.y&&void 0===e.d){var m=(M=new a({curve:e.crv})).ecparams.keycharlen,p=("0000000000"+ce(e.x)).slice(-m),f=("0000000000"+ce(e.y)).slice(-m);return M.setPublicKeyHex(g="04"+p+f),M}if("EC"===e.kty&&void 0!==e.crv&&void 0!==e.x&&void 0!==e.y&&void 0!==e.d){m=(M=new a({curve:e.crv})).ecparams.keycharlen;var g="04"+(p=("0000000000"+ce(e.x)).slice(-m))+(f=("0000000000"+ce(e.y)).slice(-m)),y=("0000000000"+ce(e.d)).slice(-m);return M.setPublicKeyHex(g),M.setPrivateKeyHex(y),M}if("pkcs5prv"===r){var v,b=e,S=ee;if(9===(v=i(b,0)).length)(k=new u).readPKCS5PrvKeyHex(b);else if(6===v.length)(k=new c).readPKCS5PrvKeyHex(b);else{if(!(v.length>2&&"04"===b.substr(v[1],2)))throw new Error("unsupported PKCS#1/5 hexadecimal key");(k=new a).readPKCS5PrvKeyHex(b)}return k}if("pkcs8prv"===r)return d.getKeyFromPlainPrivatePKCS8Hex(e);if("pkcs8pub"===r)return d._getKeyFromPublicPKCS8Hex(e);if("x509pub"===r)return We.getPublicKeyFromCertHex(e);if(-1!=e.indexOf("-END CERTIFICATE-",0)||-1!=e.indexOf("-END X509 CERTIFICATE-",0)||-1!=e.indexOf("-END TRUSTED CERTIFICATE-",0))return We.getPublicKeyFromCertPEM(e);if(-1!=e.indexOf("-END PUBLIC KEY-")){var w=ve(e,"PUBLIC KEY");return d._getKeyFromPublicPKCS8Hex(w)}if(-1!=e.indexOf("-END RSA PRIVATE KEY-")&&-1==e.indexOf("4,ENCRYPTED")){var C=h(e,"RSA PRIVATE KEY");return d.getKey(C,null,"pkcs5prv")}if(-1!=e.indexOf("-END DSA PRIVATE KEY-")&&-1==e.indexOf("4,ENCRYPTED")){var E=s(n=h(e,"DSA PRIVATE KEY"),0,[1],"02"),I=s(n,0,[2],"02"),T=s(n,0,[3],"02"),N=s(n,0,[4],"02"),P=s(n,0,[5],"02");return(k=new c).setPrivate(new l(E,16),new l(I,16),new l(T,16),new l(N,16),new l(P,16)),k}if(-1!=e.indexOf("-END EC PRIVATE KEY-")&&-1==e.indexOf("4,ENCRYPTED"))return C=h(e,"EC PRIVATE KEY"),d.getKey(C,null,"pkcs5prv");if(-1!=e.indexOf("-END PRIVATE KEY-"))return d.getKeyFromPlainPrivatePKCS8PEM(e);if(-1!=e.indexOf("-END RSA PRIVATE KEY-")&&-1!=e.indexOf("4,ENCRYPTED")){var x=d.getDecryptedKeyHex(e,t),O=new K;return O.readPKCS5PrvKeyHex(x),O}if(-1!=e.indexOf("-END EC PRIVATE KEY-")&&-1!=e.indexOf("4,ENCRYPTED")){var M,k=s(n=d.getDecryptedKeyHex(e,t),0,[1],"04"),L=s(n,0,[2,0],"06"),R=s(n,0,[3,0],"03").substr(2);if(void 0===X.crypto.OID.oidhex2name[L])throw new Error("undefined OID(hex) in KJUR.crypto.OID: "+L);return(M=new a({curve:X.crypto.OID.oidhex2name[L]})).setPublicKeyHex(R),M.setPrivateKeyHex(k),M.isPublic=!1,M}if(-1!=e.indexOf("-END DSA PRIVATE KEY-")&&-1!=e.indexOf("4,ENCRYPTED"))return E=s(n=d.getDecryptedKeyHex(e,t),0,[1],"02"),I=s(n,0,[2],"02"),T=s(n,0,[3],"02"),N=s(n,0,[4],"02"),P=s(n,0,[5],"02"),(k=new c).setPrivate(new l(E,16),new l(I,16),new l(T,16),new l(N,16),new l(P,16)),k;if(-1!=e.indexOf("-END ENCRYPTED PRIVATE KEY-"))return d.getKeyFromEncryptedPKCS8PEM(e,t);throw new Error("not supported argument")},Ve.generateKeypair=function(e,t){if("RSA"==e){var r=t;(o=new K).generate(r,"10001"),o.isPrivate=!0,o.isPublic=!0;var n=new K,i=o.n.toString(16),s=o.e.toString(16);return n.setPublic(i,s),n.isPrivate=!1,n.isPublic=!0,(a={}).prvKeyObj=o,a.pubKeyObj=n,a}if("EC"==e){var o,a,c=t,u=new X.crypto.ECDSA({curve:c}).generateKeyPairHex();return(o=new X.crypto.ECDSA({curve:c})).setPublicKeyHex(u.ecpubhex),o.setPrivateKeyHex(u.ecprvhex),o.isPrivate=!0,o.isPublic=!1,(n=new X.crypto.ECDSA({curve:c})).setPublicKeyHex(u.ecpubhex),n.isPrivate=!1,n.isPublic=!0,(a={}).prvKeyObj=o,a.pubKeyObj=n,a}throw new Error("unknown algorithm: "+e)},Ve.getPEM=function(e,t,r,n,s,o){var a=X.asn1,c=a.DERObjectIdentifier,u=a.DERInteger,l=a.ASN1Util.newObject,h=X.crypto,d=h.DSA,m=h.ECDSA,p=K;function f(e){return l({seq:[{int:0},{int:{bigint:e.n}},{int:e.e},{int:{bigint:e.d}},{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.dmp1}},{int:{bigint:e.dmq1}},{int:{bigint:e.coeff}}]})}function g(e){return l({seq:[{int:1},{octstr:{hex:e.prvKeyHex}},{tag:["a0",!0,{oid:{name:e.curveName}}]},{tag:["a1",!0,{bitstr:{hex:"00"+e.pubKeyHex}}]}]})}function y(e){return l({seq:[{int:0},{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.g}},{int:{bigint:e.y}},{int:{bigint:e.x}}]})}if((void 0!==p&&e instanceof p||void 0!==d&&e instanceof d||void 0!==m&&e instanceof m)&&1==e.isPublic&&(void 0===t||"PKCS8PUB"==t))return ye(w=new(0,a.x509.SubjectPublicKeyInfo)(e).tohex(),"PUBLIC KEY");if("PKCS1PRV"==t&&void 0!==p&&e instanceof p&&(void 0===r||null==r)&&1==e.isPrivate)return ye(w=f(e).tohex(),"RSA PRIVATE KEY");if("PKCS1PRV"==t&&void 0!==m&&e instanceof m&&(void 0===r||null==r)&&1==e.isPrivate){var v=new c({name:e.curveName}).tohex(),b=g(e).tohex(),S="";return(S+=ye(v,"EC PARAMETERS"))+ye(b,"EC PRIVATE KEY")}if("PKCS1PRV"==t&&void 0!==d&&e instanceof d&&(void 0===r||null==r)&&1==e.isPrivate)return ye(w=y(e).tohex(),"DSA PRIVATE KEY");if("PKCS5PRV"==t&&void 0!==p&&e instanceof p&&void 0!==r&&null!=r&&1==e.isPrivate){var w=f(e).tohex();return void 0===n&&(n="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("RSA",w,r,n,o)}if("PKCS5PRV"==t&&void 0!==m&&e instanceof m&&void 0!==r&&null!=r&&1==e.isPrivate)return w=g(e).tohex(),void 0===n&&(n="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("EC",w,r,n,o);if("PKCS5PRV"==t&&void 0!==d&&e instanceof d&&void 0!==r&&null!=r&&1==e.isPrivate)return w=y(e).tohex(),void 0===n&&(n="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("DSA",w,r,n,o);var C=function(e,t){var r=E(e,t);return new l({seq:[{seq:[{oid:{name:"pkcs5PBES2"}},{seq:[{seq:[{oid:{name:"pkcs5PBKDF2"}},{seq:[{octstr:{hex:r.pbkdf2Salt}},{int:r.pbkdf2Iter}]}]},{seq:[{oid:{name:"des-EDE3-CBC"}},{octstr:{hex:r.encryptionSchemeIV}}]}]}]},{octstr:{hex:r.ciphertext}}]}).tohex()},E=function(e,t){var r=i.lib.WordArray.random(8),n=i.lib.WordArray.random(8),s=i.PBKDF2(t,r,{keySize:6,iterations:100}),o=i.enc.Hex.parse(e),a=i.TripleDES.encrypt(o,s,{iv:n})+"",c={};return c.ciphertext=a,c.pbkdf2Salt=i.enc.Hex.stringify(r),c.pbkdf2Iter=100,c.encryptionSchemeAlg="DES-EDE3-CBC",c.encryptionSchemeIV=i.enc.Hex.stringify(n),c};if("PKCS8PRV"==t&&null!=p&&e instanceof p&&1==e.isPrivate){var I=f(e).tohex();return w=l({seq:[{int:0},{seq:[{oid:{name:"rsaEncryption"}},{null:!0}]},{octstr:{hex:I}}]}).tohex(),void 0===r||null==r?ye(w,"PRIVATE KEY"):ye(b=C(w,r),"ENCRYPTED PRIVATE KEY")}if("PKCS8PRV"==t&&void 0!==m&&e instanceof m&&1==e.isPrivate){var T={seq:[{int:1},{octstr:{hex:e.prvKeyHex}}]};return"string"==typeof e.pubKeyHex&&T.seq.push({tag:["a1",!0,{bitstr:{hex:"00"+e.pubKeyHex}}]}),I=new l(T).tohex(),w=l({seq:[{int:0},{seq:[{oid:{name:"ecPublicKey"}},{oid:{name:e.curveName}}]},{octstr:{hex:I}}]}).tohex(),void 0===r||null==r?ye(w,"PRIVATE KEY"):ye(b=C(w,r),"ENCRYPTED PRIVATE KEY")}if("PKCS8PRV"==t&&void 0!==d&&e instanceof d&&1==e.isPrivate)return I=new u({bigint:e.x}).tohex(),w=l({seq:[{int:0},{seq:[{oid:{name:"dsa"}},{seq:[{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.g}}]}]},{octstr:{hex:I}}]}).tohex(),void 0===r||null==r?ye(w,"PRIVATE KEY"):ye(b=C(w,r),"ENCRYPTED PRIVATE KEY");throw new Error("unsupported object nor format")},Ve.getKeyFromCSRPEM=function(e){var t=ve(e,"CERTIFICATE REQUEST");return Ve.getKeyFromCSRHex(t)},Ve.getKeyFromCSRHex=function(e){var t=Ve.parseCSRHex(e);return Ve.getKey(t.p8pubkeyhex,null,"pkcs8pub")},Ve.parseCSRHex=function(e){var t=ee.getChildIdx,r=ee.getTLV,n={},i=e;if("30"!=i.substr(0,2))throw new Error("malformed CSR(code:001)");var s=t(i,0);if(s.length<1)throw new Error("malformed CSR(code:002)");if("30"!=i.substr(s[0],2))throw new Error("malformed CSR(code:003)");var o=t(i,s[0]);if(o.length<3)throw new Error("malformed CSR(code:004)");return n.p8pubkeyhex=r(i,o[2]),n},Ve.getKeyID=function(e){var t=Ve,r=ee;"string"==typeof e&&-1!=e.indexOf("BEGIN ")&&(e=t.getKey(e));var n=ve(t.getPEM(e)),i=r.getIdxbyList(n,0,[1]),s=r.getV(n,i).substring(2);return X.crypto.Util.hashHex(s,"sha1")},Ve.getJWK=function(e,t,r,n,i){var s,o,c={},u=X.crypto.Util.hashHex;if("string"==typeof e)s=Ve.getKey(e),-1!=e.indexOf("CERTIFICATE")&&(o=ve(e));else{if("object"!=typeof e)throw new Error("unsupported keyinfo type");e instanceof We?(s=e.getPublicKey(),o=e.hex):s=e}if(s instanceof K&&s.isPrivate)c.kty="RSA",c.n=ae(s.n.toString(16)),c.e=ae(s.e.toString(16)),c.d=ae(s.d.toString(16)),c.p=ae(s.p.toString(16)),c.q=ae(s.q.toString(16)),c.dp=ae(s.dmp1.toString(16)),c.dq=ae(s.dmq1.toString(16)),c.qi=ae(s.coeff.toString(16));else if(s instanceof K&&s.isPublic)c.kty="RSA",c.n=ae(s.n.toString(16)),c.e=ae(s.e.toString(16));else if(s instanceof X.crypto.ECDSA&&s.isPrivate){if("P-256"!==(h=s.getShortNISTPCurveName())&&"P-384"!==h&&"P-521"!==h)throw new Error("unsupported curve name for JWT: "+h);var l=s.getPublicKeyXYHex();c.kty="EC",c.crv=h,c.x=ae(l.x),c.y=ae(l.y),c.d=ae(s.prvKeyHex)}else if(s instanceof X.crypto.ECDSA&&s.isPublic){var h;if("P-256"!==(h=s.getShortNISTPCurveName())&&"P-384"!==h&&"P-521"!==h)throw new Error("unsupported curve name for JWT: "+h);l=s.getPublicKeyXYHex(),c.kty="EC",c.crv=h,c.x=ae(l.x),c.y=ae(l.y)}if(null==c.kty)throw new Error("unsupported keyinfo");return s.isPrivate||1==t||(c.kid=X.jws.JWS.getJWKthumbprint(c)),null!=o&&1!=r&&(c.x5c=[a(o)]),null!=o&&1!=n&&(c.x5t=se(a(u(o,"sha1")))),null!=o&&1!=i&&(c["x5t#S256"]=se(a(u(o,"sha256")))),c},Ve.getJWKFromKey=function(e){return Ve.getJWK(e,!0,!0,!0,!0)},K.getPosArrayOfChildrenFromHex=function(e){return ee.getChildIdx(e,0)},K.getHexValueArrayOfChildrenFromHex=function(e){var t,r=ee.getV,n=r(e,(t=K.getPosArrayOfChildrenFromHex(e))[0]),i=r(e,t[1]),s=r(e,t[2]),o=r(e,t[3]),a=r(e,t[4]),c=r(e,t[5]),u=r(e,t[6]),l=r(e,t[7]),h=r(e,t[8]);return(t=new Array).push(n,i,s,o,a,c,u,l,h),t},K.prototype.readPrivateKeyFromPEMString=function(e){var t=ve(e),r=K.getHexValueArrayOfChildrenFromHex(t);this.setPrivateEx(r[1],r[2],r[3],r[4],r[5],r[6],r[7],r[8])},K.prototype.readPKCS5PrvKeyHex=function(e){var t=K.getHexValueArrayOfChildrenFromHex(e);this.setPrivateEx(t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])},K.prototype.readPKCS8PrvKeyHex=function(e){var t,r,n,i,s,o,a,c,u=ee.getVbyListEx;if(!1===ee.isASN1HEX(e))throw new Error("not ASN.1 hex string");try{t=u(e,0,[2,0,1],"02"),r=u(e,0,[2,0,2],"02"),n=u(e,0,[2,0,3],"02"),i=u(e,0,[2,0,4],"02"),s=u(e,0,[2,0,5],"02"),o=u(e,0,[2,0,6],"02"),a=u(e,0,[2,0,7],"02"),c=u(e,0,[2,0,8],"02")}catch(e){throw new Error("malformed PKCS#8 plain RSA private key")}this.setPrivateEx(t,r,n,i,s,o,a,c)},K.prototype.readPKCS5PubKeyHex=function(e){var t=ee,r=t.getV;if(!1===t.isASN1HEX(e))throw new Error("keyHex is not ASN.1 hex string");var n=t.getChildIdx(e,0);if(2!==n.length||"02"!==e.substr(n[0],2)||"02"!==e.substr(n[1],2))throw new Error("wrong hex for PKCS#5 public key");var i=r(e,n[0]),s=r(e,n[1]);this.setPublic(i,s)},K.prototype.readPKCS8PubKeyHex=function(e){var t=ee;if(!1===t.isASN1HEX(e))throw new Error("not ASN.1 hex string");if("06092a864886f70d010101"!==t.getTLVbyListEx(e,0,[0,0]))throw new Error("not PKCS8 RSA public key");var r=t.getTLVbyListEx(e,0,[1,0]);this.readPKCS5PubKeyHex(r)},K.prototype.readCertPubKeyHex=function(e,t){var r,n;(r=new We).readCertHex(e),n=r.getPublicKeyHex(),this.readPKCS8PubKeyHex(n)},new RegExp("[^0-9a-f]","gi"),K.prototype.sign=function(e,t){var r=function(e){return X.crypto.Util.hashString(e,t)}(e);return this.signWithMessageHash(r,t)},K.prototype.signWithMessageHash=function(e,t){var r=$(X.crypto.Util.getPaddedDigestInfoHex(e,t,this.n.bitLength()),16);return $e(this.doPrivate(r).toString(16),this.n.bitLength())},K.prototype.signPSS=function(e,t,r){var n=function(e){return X.crypto.Util.hashHex(e,t)}(me(e));return void 0===r&&(r=-1),this.signWithMessageHashPSS(n,t,r)},K.prototype.signWithMessageHashPSS=function(e,t,r){var n,i=de(e),s=i.length,o=this.n.bitLength()-1,a=Math.ceil(o/8),c=function(e){return X.crypto.Util.hashHex(e,t)};if(-1===r||void 0===r)r=s;else if(-2===r)r=a-s-2;else if(r<-2)throw new Error("invalid salt length");if(a<s+r+2)throw new Error("data too long");var u="";r>0&&(u=new Array(r),(new V).nextBytes(u),u=String.fromCharCode.apply(String,u));var h=de(c(me("\0\0\0\0\0\0\0\0"+i+u))),d=[];for(n=0;n<a-r-s-2;n+=1)d[n]=0;var m=String.fromCharCode.apply(String,d)+""+u,p=Ue(h,m.length,c),f=[];for(n=0;n<m.length;n+=1)f[n]=m.charCodeAt(n)^p.charCodeAt(n);for(f[0]&=~(65280>>8*a-o&255),n=0;n<s;n++)f.push(h.charCodeAt(n));return f.push(188),$e(this.doPrivate(new l(f)).toString(16),this.n.bitLength())},K.prototype.verify=function(e,t){if(null==(t=t.toLowerCase()).match(/^[0-9a-f]+$/))return!1;var r=$(t,16),n=this.n.bitLength();if(r.bitLength()>n)return!1;var i=this.doPublic(r).toString(16);if(i.length+3!=n/4)return!1;var s=Ke(i.replace(/^1f+00/,""));if(0==s.length)return!1;var o=s[0];return s[1]==function(e){return X.crypto.Util.hashString(e,o)}(e)},K.prototype.verifyWithMessageHash=function(e,t){if(t.length!=Math.ceil(this.n.bitLength()/4))return!1;var r=$(t,16);if(r.bitLength()>this.n.bitLength())return 0;var n=Ke(this.doPublic(r).toString(16).replace(/^1f+00/,""));return 0!=n.length&&n[1]==e},K.prototype.verifyPSS=function(e,t,r,n){var i=function(e){return X.crypto.Util.hashHex(e,r)}(me(e));return void 0===n&&(n=-1),this.verifyWithMessageHashPSS(i,t,r,n)},K.prototype.verifyWithMessageHashPSS=function(e,t,r,n){if(t.length!=Math.ceil(this.n.bitLength()/4))return!1;var i,s=new l(t,16),o=function(e){return X.crypto.Util.hashHex(e,r)},a=de(e),c=a.length,u=this.n.bitLength()-1,h=Math.ceil(u/8);if(-1===n||void 0===n)n=c;else if(-2===n)n=h-c-2;else if(n<-2)throw new Error("invalid salt length");if(h<c+n+2)throw new Error("data too long");var d=this.doPublic(s).toByteArray();for(i=0;i<d.length;i+=1)d[i]&=255;for(;d.length<h;)d.unshift(0);if(188!==d[h-1])throw new Error("encoded message does not end in 0xbc");var m=(d=String.fromCharCode.apply(String,d)).substr(0,h-c-1),p=d.substr(m.length,c),f=65280>>8*h-u&255;if(0!=(m.charCodeAt(0)&f))throw new Error("bits beyond keysize not zero");var g=Ue(p,m.length,o),y=[];for(i=0;i<m.length;i+=1)y[i]=m.charCodeAt(i)^g.charCodeAt(i);y[0]&=~f;var v=h-c-n-2;for(i=0;i<v;i+=1)if(0!==y[i])throw new Error("leftmost octets not zero");if(1!==y[v])throw new Error("0x01 marker not found");return p===de(o(me("\0\0\0\0\0\0\0\0"+a+String.fromCharCode.apply(String,y.slice(-n)))))},K.SALT_LEN_HLEN=-1,K.SALT_LEN_MAX=-2,K.SALT_LEN_RECOVER=-2,We.hex2dn=function(e,t){void 0===t&&(t=0);var r=new We;return ee.getTLV(e,t),r.getX500Name(e).str},We.hex2rdn=function(e,t){if(void 0===t&&(t=0),"31"!==e.substr(t,2))throw new Error("malformed RDN");for(var r=new Array,n=ee.getChildIdx(e,t),i=0;i<n.length;i++)r.push(We.hex2attrTypeValue(e,n[i]));return(r=r.map((function(e){return e.replace("+","\\+")}))).join("+")},We.hex2attrTypeValue=function(e,t){var r=ee,n=r.getV;if(void 0===t&&(t=0),"30"!==e.substr(t,2))throw new Error("malformed attribute type and value");var i=r.getChildIdx(e,t);2!==i.length||e.substr(i[0],2);var s=n(e,i[0]),o=X.asn1.ASN1Util.oidHexToInt(s);return X.asn1.x509.OID.oid2atype(o)+"="+de(n(e,i[1]))},We.getPublicKeyFromCertHex=function(e){var t=new We;return t.readCertHex(e),t.getPublicKey()},We.getPublicKeyFromCertPEM=function(e){var t=new We;return t.readCertPEM(e),t.getPublicKey()},We.getPublicKeyInfoPropOfCertPEM=function(e){var t,r,n=ee.getVbyList,i={algparam:null};return(t=new We).readCertPEM(e),r=t.getPublicKeyHex(),i.keyhex=n(r,0,[1],"03").substr(2),i.algoid=n(r,0,[0,0],"06"),"2a8648ce3d0201"===i.algoid&&(i.algparam=n(r,0,[0,1],"06")),i},We.KEYUSAGE_NAME=["digitalSignature","nonRepudiation","keyEncipherment","dataEncipherment","keyAgreement","keyCertSign","cRLSign","encipherOnly","decipherOnly"],void 0!==X&&X||(X={}),void 0!==X.jws&&X.jws||(X.jws={}),X.jws.JWS=function(){var e=X.jws.JWS.isSafeJSONString;this.parseJWS=function(t,r){if(void 0===this.parsedJWS||!r&&void 0===this.parsedJWS.sigvalH){var n=t.match(/^([^.]+)\.([^.]+)\.([^.]+)$/);if(null==n)throw"JWS signature is not a form of 'Head.Payload.SigValue'.";var i=n[1],s=n[2],o=n[3],a=i+"."+s;if(this.parsedJWS={},this.parsedJWS.headB64U=i,this.parsedJWS.payloadB64U=s,this.parsedJWS.sigvalB64U=o,this.parsedJWS.si=a,!r){var c=ce(o),u=$(c,16);this.parsedJWS.sigvalH=c,this.parsedJWS.sigvalBI=u}var l=Y(i),h=Y(s);if(this.parsedJWS.headS=l,this.parsedJWS.payloadS=h,!e(l,this.parsedJWS,"headP"))throw"malformed JSON string for JWS Head: "+l}}},X.jws.JWS.sign=function(e,t,r,n,i){var s,o,a,c=X.jws.JWS,u=c.readSafeJSONString,l=c.isSafeJSONString,h=X.crypto,d=h.Mac,m=h.Signature,p=JSON;if("string"!=typeof t&&"object"!=typeof t)throw"spHeader must be JSON string or object: "+t;if("object"==typeof t&&(s=p.stringify(o=t)),"string"==typeof t){if(!l(s=t))throw"JWS Head is not safe JSON string: "+s;o=u(s)}if(a=r,"object"==typeof r&&(a=p.stringify(r)),""!=e&&null!=e||void 0===o.alg||(e=o.alg),""!=e&&null!=e&&void 0===o.alg&&(o.alg=e,s=p.stringify(o)),e!==o.alg)throw"alg and sHeader.alg doesn't match: "+e+"!="+o.alg;var f=null;if(void 0===c.jwsalg2sigalg[e])throw"unsupported alg name: "+e;f=c.jwsalg2sigalg[e];var g=Z(s)+"."+Z(a),y="";if("Hmac"==f.substr(0,4)){if(void 0===n)throw"mac key shall be specified for HS* alg";var v=new d({alg:f,prov:"cryptojs",pass:n});v.updateString(g),y=v.doFinal()}else if(-1!=f.indexOf("withECDSA")){(S=new m({alg:f})).init(n,i),S.updateString(g);var b=S.sign();y=X.crypto.ECDSA.asn1SigToConcatSig(b)}else{var S;"none"!=f&&((S=new m({alg:f})).init(n,i),S.updateString(g),y=S.sign())}return g+"."+ae(y)},X.jws.JWS.verify=function(e,t,r){var n,i=X.jws.JWS,s=i.readSafeJSONString,o=X.crypto,a=o.ECDSA,c=o.Mac,u=o.Signature;if(n=K,!Le(e))return!1;var l=e.split(".");if(3!==l.length)return!1;var h,d=l[0]+"."+l[1],m=ce(l[2]),p=s(Y(l[0])),f=null;if(void 0===p.alg)throw"algorithm not specified in header";if(h=(f=p.alg).substr(0,2),null!=r&&"[object Array]"===Object.prototype.toString.call(r)&&r.length>0&&-1==(":"+r.join(":")+":").indexOf(":"+f+":"))throw"algorithm '"+f+"' not accepted in the list";if("none"!=f&&null===t)throw"key shall be specified to verify.";if("string"==typeof t&&-1!=t.indexOf("-----BEGIN ")&&(t=Ve.getKey(t)),!("RS"!=h&&"PS"!=h||t instanceof n))throw"key shall be a RSAKey obj for RS* and PS* algs";if("ES"==h&&!(t instanceof a))throw"key shall be a ECDSA obj for ES* algs";var g=null;if(void 0===i.jwsalg2sigalg[p.alg])throw"unsupported alg name: "+f;if("none"==(g=i.jwsalg2sigalg[f]))throw"not supported";if("Hmac"==g.substr(0,4)){if(void 0===t)throw"hexadecimal key shall be specified for HMAC";var y=new c({alg:g,pass:t});return y.updateString(d),m==y.doFinal()}if(-1!=g.indexOf("withECDSA")){var v,b=null;try{b=a.concatSigToASN1Sig(m)}catch(e){return!1}return(v=new u({alg:g})).init(t),v.updateString(d),v.verify(b)}return(v=new u({alg:g})).init(t),v.updateString(d),v.verify(m)},X.jws.JWS.parse=function(e){var t,r,n=e.split("."),i={};if(2!=n.length&&3!=n.length)throw"malformed sJWS: wrong number of '.' splitted elements";return t=n[1],3==n.length&&(r=n[2]),i.headerObj=X.jws.JWS.readSafeJSONString(Y(n[0])),i.payloadObj=X.jws.JWS.readSafeJSONString(Y(t)),i.headerPP=JSON.stringify(i.headerObj,null,"  "),i.payloadPP=null==i.payloadObj?Y(t):JSON.stringify(i.payloadObj,null,"  "),void 0!==r&&(i.sigHex=ce(r)),i},X.jws.JWS.verifyJWT=function(e,t,r){var n=X.jws,i=n.JWS,s=i.readSafeJSONString,o=i.inArray,a=i.includedArray;if(!Le(e))return!1;var c=e.split(".");if(3!=c.length)return!1;var u=c[0],l=c[1],h=(ce(c[2]),s(Y(u))),d=s(Y(l));if(void 0===h.alg)return!1;if(void 0===r.alg)throw"acceptField.alg shall be specified";if(!o(h.alg,r.alg))return!1;if(void 0!==d.iss&&"object"==typeof r.iss&&!o(d.iss,r.iss))return!1;if(void 0!==d.sub&&"object"==typeof r.sub&&!o(d.sub,r.sub))return!1;if(void 0!==d.aud&&"object"==typeof r.aud)if("string"==typeof d.aud){if(!o(d.aud,r.aud))return!1}else if("object"==typeof d.aud&&!a(d.aud,r.aud))return!1;var m=n.IntDate.getNow();return void 0!==r.verifyAt&&"number"==typeof r.verifyAt&&(m=r.verifyAt),void 0!==r.gracePeriod&&"number"==typeof r.gracePeriod||(r.gracePeriod=0),!(void 0!==d.exp&&"number"==typeof d.exp&&d.exp+r.gracePeriod<m||void 0!==d.nbf&&"number"==typeof d.nbf&&m<d.nbf-r.gracePeriod||void 0!==d.iat&&"number"==typeof d.iat&&m<d.iat-r.gracePeriod||void 0!==d.jti&&void 0!==r.jti&&d.jti!==r.jti||!i.verify(e,t,r.alg))},X.jws.JWS.includedArray=function(e,t){var r=X.jws.JWS.inArray;if(null===e)return!1;if("object"!=typeof e)return!1;if("number"!=typeof e.length)return!1;for(var n=0;n<e.length;n++)if(!r(e[n],t))return!1;return!0},X.jws.JWS.inArray=function(e,t){if(null===t)return!1;if("object"!=typeof t)return!1;if("number"!=typeof t.length)return!1;for(var r=0;r<t.length;r++)if(t[r]==e)return!0;return!1},X.jws.JWS.jwsalg2sigalg={HS256:"HmacSHA256",HS384:"HmacSHA384",HS512:"HmacSHA512",RS256:"SHA256withRSA",RS384:"SHA384withRSA",RS512:"SHA512withRSA",ES256:"SHA256withECDSA",ES384:"SHA384withECDSA",ES512:"SHA512withECDSA",PS256:"SHA256withRSAandMGF1",PS384:"SHA384withRSAandMGF1",PS512:"SHA512withRSAandMGF1",none:"none"},X.jws.JWS.isSafeJSONString=function(e,t,r){var n=null;try{return"object"!=typeof(n=Q(e))||n.constructor===Array?0:(t&&(t[r]=n),1)}catch(e){return 0}},X.jws.JWS.readSafeJSONString=function(e){var t=null;try{return"object"!=typeof(t=Q(e))||t.constructor===Array?null:t}catch(e){return null}},X.jws.JWS.getEncodedSignatureValueFromJWS=function(e){var t=e.match(/^[^.]+\.[^.]+\.([^.]+)$/);if(null==t)throw"JWS signature is not a form of 'Head.Payload.SigValue'.";return t[1]},X.jws.JWS.getJWKthumbprint=function(e){if("RSA"!==e.kty&&"EC"!==e.kty&&"oct"!==e.kty)throw"unsupported algorithm for JWK Thumprint";var t="{";if("RSA"===e.kty){if("string"!=typeof e.n||"string"!=typeof e.e)throw"wrong n and e value for RSA key";t+='"e":"'+e.e+'",',t+='"kty":"'+e.kty+'",',t+='"n":"'+e.n+'"}'}else if("EC"===e.kty){if("string"!=typeof e.crv||"string"!=typeof e.x||"string"!=typeof e.y)throw"wrong crv, x and y value for EC key";t+='"crv":"'+e.crv+'",',t+='"kty":"'+e.kty+'",',t+='"x":"'+e.x+'",',t+='"y":"'+e.y+'"}'}else if("oct"===e.kty){if("string"!=typeof e.k)throw"wrong k value for oct(symmetric) key";t+='"kty":"'+e.kty+'",',t+='"k":"'+e.k+'"}'}var r=me(t);return ae(X.crypto.Util.hashHex(r,"sha256"))},X.jws.IntDate={},X.jws.IntDate.get=function(e){var t=X.jws.IntDate,r=t.getNow,n=t.getZulu;if("now"==e)return r();if("now + 1hour"==e)return r()+3600;if("now + 1day"==e)return r()+86400;if("now + 1month"==e)return r()+2592e3;if("now + 1year"==e)return r()+31536e3;if(e.match(/Z$/))return n(e);if(e.match(/^[0-9]+$/))return parseInt(e);throw"unsupported format: "+e},X.jws.IntDate.getZulu=function(e){return Se(e)},X.jws.IntDate.getNow=function(){return~~(new Date/1e3)},X.jws.IntDate.intDate2UTCString=function(e){return new Date(1e3*e).toUTCString()},X.jws.IntDate.intDate2Zulu=function(e){var t=new Date(1e3*e);return("0000"+t.getUTCFullYear()).slice(-4)+("00"+(t.getUTCMonth()+1)).slice(-2)+("00"+t.getUTCDate()).slice(-2)+("00"+t.getUTCHours()).slice(-2)+("00"+t.getUTCMinutes()).slice(-2)+("00"+t.getUTCSeconds()).slice(-2)+"Z"},void 0!==X&&X||(X={}),void 0!==X.jws&&X.jws||(X.jws={}),X.jws.JWSJS=function(){var e=X.jws.JWS,t=e.readSafeJSONString;this.aHeader=[],this.sPayload="",this.aSignature=[],this.init=function(){this.aHeader=[],this.sPayload=void 0,this.aSignature=[]},this.initWithJWS=function(e){this.init();var t=e.split(".");if(3!=t.length)throw"malformed input JWS";this.aHeader.push(t[0]),this.sPayload=t[1],this.aSignature.push(t[2])},this.addSignature=function(e,t,r,n){if(null==this.sPayload)throw"there's no JSON-JS signature to add.";var i=this.aHeader.length;if(this.aHeader.length!=this.aSignature.length)throw"aHeader.length != aSignature.length";try{var s=X.jws.JWS.sign(e,t,this.sPayload,r,n).split(".");this.aHeader.push(s[0]),this.aSignature.push(s[2])}catch(e){throw this.aHeader.length>i&&this.aHeader.pop(),this.aSignature.length>i&&this.aSignature.pop(),"addSignature failed: "+e}},this.verifyAll=function(e){if(this.aHeader.length!==e.length||this.aSignature.length!==e.length)return!1;for(var t=0;t<e.length;t++){var r=e[t];if(2!==r.length)return!1;if(!1===this.verifyNth(t,r[0],r[1]))return!1}return!0},this.verifyNth=function(t,r,n){if(this.aHeader.length<=t||this.aSignature.length<=t)return!1;var i=this.aHeader[t]+"."+this.sPayload+"."+this.aSignature[t],s=!1;try{s=e.verify(i,r,n)}catch(e){return!1}return s},this.readJWSJS=function(e){if("string"==typeof e){var r=t(e);if(null==r)throw"argument is not safe JSON object string";this.aHeader=r.headers,this.sPayload=r.payload,this.aSignature=r.signatures}else try{if(!(e.headers.length>0))throw"malformed header";if(this.aHeader=e.headers,"string"!=typeof e.payload)throw"malformed signatures";if(this.sPayload=e.payload,!(e.signatures.length>0))throw"malformed signatures";this.aSignature=e.signatures}catch(e){throw"malformed JWS-JS JSON object: "+e}},this.getJSON=function(){return{headers:this.aHeader,payload:this.sPayload,signatures:this.aSignature}},this.isEmpty=function(){return 0==this.aHeader.length?1:0}},t.SecureRandom=V,t.rng_seed_time=A,t.BigInteger=l,t.RSAKey=K,t.ECDSA=X.crypto.ECDSA,t.DSA=X.crypto.DSA,t.Signature=X.crypto.Signature,t.MessageDigest=X.crypto.MessageDigest,t.Mac=X.crypto.Mac,t.Cipher=X.crypto.Cipher,t.KEYUTIL=Ve,t.ASN1HEX=ee,t.X509=We,t.X509CRL=function(e){var t=X.lang.String.isHex,r=ee.getV,n=ee.getTLV,i=ee.getVbyList,s=ee.getTLVbyList,o=ee.getTLVbyListEx,a=ee.getIdxbyList,c=ee.getIdxbyListEx,u=ee.getChildIdx,l=new We;this.hex=null,this.posSigAlg=null,this.posRevCert=null,this.parsed=null,this._setPos=function(){var e=a(this.hex,0,[0,0]),t=this.hex.substr(e,2);if("02"==t)this.posSigAlg=1;else{if("30"!=t)throw new Error("malformed 1st item of TBSCertList: "+t);this.posSigAlg=0}var r,n=a(this.hex,0,[0,this.posSigAlg+3]),i=this.hex.substr(n,2);if("17"==i||"18"==i)r=a(this.hex,0,[0,this.posSigAlg+4]),this.posRevCert=null,-1!=r&&"30"==this.hex.substr(r,2)&&(this.posRevCert=this.posSigAlg+4);else if("30"==i)this.posRevCert=this.posSigAlg+3;else{if("a0"!=i)throw new Error("malformed nextUpdate or revCert tag: "+i);this.posRevCert=null}},this.getVersion=function(){return 0==this.posSigAlg?null:parseInt(i(this.hex,0,[0,0],"02"),16)+1},this.getSignatureAlgorithmField=function(){var e=s(this.hex,0,[0,this.posSigAlg],"30");return l.getAlgorithmIdentifierName(e)},this.getIssuer=function(){return l.getX500Name(this.getIssuerHex())},this.getIssuerHex=function(){return s(this.hex,0,[0,this.posSigAlg+1],"30")},this.getThisUpdate=function(){var e=i(this.hex,0,[0,this.posSigAlg+2]);return result=de(e)},this.getNextUpdate=function(){var e=a(this.hex,0,[0,this.posSigAlg+3]),t=this.hex.substr(e,2);return"17"!=t&&"18"!=t?null:de(r(this.hex,e))},this.getRevCertArray=function(){if(null==this.posRevCert)return null;for(var e=[],t=a(this.hex,0,[0,this.posRevCert]),r=u(this.hex,t),i=0;i<r.length;i++){var s=n(this.hex,r[i]);e.push(this.getRevCert(s))}return e},this.getRevCert=function(e){var t={},r=u(e,0);return t.sn={hex:i(e,0,[0],"02")},t.date=de(i(e,0,[1])),3==r.length&&(t.ext=l.getExtParamArray(s(e,0,[2]))),t},this.findRevCert=function(e){var t=new We(e).getSerialNumberHex();return this.findRevCertBySN(t)},this.findRevCertBySN=function(e){if(null==this.parsed&&this.getParam(),null==this.parsed.revcert)return null;for(var t=this.parsed.revcert,r=0;r<t.length;r++)if(e==t[r].sn.hex)return t[r];return null},this.getSignatureValueHex=function(){return i(this.hex,0,[2],"03",!0)},this.verifySignature=function(e){var t=this.getSignatureAlgorithmField(),r=this.getSignatureValueHex(),n=s(this.hex,0,[0],"30"),i=new X.crypto.Signature({alg:t});return i.init(e),i.updateHex(n),i.verify(r)},this.getParam=function(e){var t={},r=this.getVersion();null!=r&&(t.version=r),t.sigalg=this.getSignatureAlgorithmField(),t.issuer=this.getIssuer(),t.thisupdate=this.getThisUpdate();var n=this.getNextUpdate();null!=n&&(t.nextupdate=n);var i=this.getRevCertArray();if(null!=i&&(t.revcert=i),-1!=c(this.hex,0,[0,"[0]"])){var a=o(this.hex,0,[0,"[0]",0]);t.ext=l.getExtParamArray(a)}return t.sighex=this.getSignatureValueHex(),this.parsed=t,"object"==typeof e&&(1==e.tbshex&&(t.tbshex=s(this.hex,0,[0])),1==e.nodnarray&&delete t.issuer.array),t},"string"==typeof e&&(t(e)?this.hex=e:e.match(/-----BEGIN X509 CRL/)&&(this.hex=ve(e)),this._setPos())},t.CryptoJS=i,t.b64tohex=c,t.b64toBA=u,t.ECFieldElementFp=J,t.ECPointFp=G,t.ECCurveFp=z,t.stoBA=te,t.BAtos=re,t.BAtohex=ne,t.stohex=ie,t.stob64=function(e){return a(ie(e))},t.stob64u=function(e){return se(a(ie(e)))},t.b64utos=function(e){return re(u(oe(e)))},t.b64tob64u=se,t.b64utob64=oe,t.hex2b64=a,t.hextob64u=ae,t.b64utohex=ce,t.utf8tob64u=Z,t.b64utoutf8=Y,t.utf8tob64=function(e){return a(we(Me(e)))},t.b64toutf8=function(e){return decodeURIComponent(Ce(c(e)))},t.utf8tohex=ue,t.hextoutf8=le,t.hextorstr=de,t.rstrtohex=me,t.hextob64=pe,t.hextob64nl=fe,t.b64nltohex=ge,t.hextopem=ye,t.pemtohex=ve,t.hextoArrayBuffer=function(e){if(e.length%2!=0)throw"input is not even length";if(null==e.match(/^[0-9A-Fa-f]+$/))throw"input is not hexadecimal";for(var t=new ArrayBuffer(e.length/2),r=new DataView(t),n=0;n<e.length/2;n++)r.setUint8(n,parseInt(e.substr(2*n,2),16));return t},t.ArrayBuffertohex=function(e){for(var t="",r=new DataView(e),n=0;n<e.byteLength;n++)t+=("00"+r.getUint8(n).toString(16)).slice(-2);return t},t.zulutomsec=be,t.zulutosec=Se,t.zulutodate=function(e){return new Date(be(e))},t.datetozulu=function(e,t,r){var n,i=e.getUTCFullYear();if(t){if(i<1950||2049<i)throw"not proper year for UTCTime: "+i;n=(""+i).slice(-2)}else n=("000"+i).slice(-4);if(n+=("0"+(e.getUTCMonth()+1)).slice(-2),n+=("0"+e.getUTCDate()).slice(-2),n+=("0"+e.getUTCHours()).slice(-2),n+=("0"+e.getUTCMinutes()).slice(-2),n+=("0"+e.getUTCSeconds()).slice(-2),r){var s=e.getUTCMilliseconds();0!==s&&(n+="."+(s=(s=("00"+s).slice(-3)).replace(/0+$/g,"")))}return n+"Z"},t.uricmptohex=we,t.hextouricmp=Ce,t.ipv6tohex=Ee,t.hextoipv6=Ie,t.hextoip=Te,t.iptohex=Pe,t.ucs2hextoutf8=Oe,t.encodeURIComponentAll=Me,t.newline_toUnix=function(e){return e.replace(/\r\n/gm,"\n")},t.newline_toDos=function(e){return(e=e.replace(/\r\n/gm,"\n")).replace(/\n/gm,"\r\n")},t.hextoposhex=Re,t.intarystrtohex=function(e){e=(e=(e=e.replace(/^\s*\[\s*/,"")).replace(/\s*\]\s*$/,"")).replace(/\s*/g,"");try{return e.split(/,/).map((function(e,t,r){var n=parseInt(e);if(n<0||255<n)throw"integer not in range 0-255";return("00"+n.toString(16)).slice(-2)})).join("")}catch(e){throw"malformed integer array string: "+e}},t.strdiffidx=function(e,t){var r=e.length;e.length>t.length&&(r=t.length);for(var n=0;n<r;n++)if(e.charCodeAt(n)!=t.charCodeAt(n))return n;return e.length!=t.length?r:-1},t.oidtohex=De,t.hextooid=Fe,t.strpad=Ae,t.bitstrtoint=je,t.inttobitstr=qe,t.bitstrtobinstr=Be,t.binstrtobitstr=function(e){if("string"!=typeof e)return null;if(null==e.match(/^[01]+$/))return null;try{return qe(parseInt(e,2))}catch(e){return null}},t.isBase64URLDot=Le,t.namearraytobinstr=_e,t.extendClass=He,t.KJUR=X,t.crypto=X.crypto,t.asn1=X.asn1,t.jws=X.jws,t.lang=X.lang}).call(this,r("zkTx").Buffer)},k7It:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CheckpointManager=void 0;const n=r("wWog"),i=r("yQiv"),s=r("fhs9");t.CheckpointManager=class{constructor(e,t,r,n,s,o,a){this.context=e,this.tenantId=t,this.documentId=r,this.documentRepository=n,this.opCollection=s,this.deltaService=o,this.getDeltasViaAlfred=a,this.clientFacadeRetryEnabled=(0,i.isRetryEnabled)(this.opCollection)}async write(e,t,r){if(this.getDeltasViaAlfred){if(r.length>0){const e=r[r.length-1].operation.sequenceNumber,t=await this.deltaService.getDeltas("",this.tenantId,this.documentId,e-1,e+1);if(0===t.length||t[0].sequenceNumber<e){const r=Object.assign(Object.assign({},(0,s.getLumberBaseProperties)(this.documentId,this.tenantId)),{expectedSequenceNumber:e,lastDelta:t.length>0?t[0].sequenceNumber:-1});s.Lumberjack.info("Pending ops were not been persisted to op storage. Retrying after delay",r),await(0,n.delay)(1500);const i=await this.deltaService.getDeltas("",this.tenantId,this.documentId,e-1,e+1);if(0===i.length||i[0].sequenceNumber<e){const e="Pending ops were not been persisted to op storage. Checkpointing failed";throw s.Lumberjack.error(e,r),new Error(e)}s.Lumberjack.info("Verified on retry that pending ops are persisted",(0,s.getLumberBaseProperties)(this.documentId,this.tenantId))}}await this.writeScribeCheckpointState(e)}else{const n=r.map((e=>Object.assign(Object.assign({},e),{mongoTimestamp:new Date(e.operation.timestamp)})));n.length>0&&await(0,i.runWithRetry)((async()=>this.opCollection.insertMany(n,!1)),"writeCheckpointScribe",3,1e3,(0,s.getLumberBaseProperties)(this.documentId,this.tenantId),(e=>11e3===e.code),(e=>!this.clientFacadeRetryEnabled)),await this.writeScribeCheckpointState(e),await this.opCollection.deleteMany({documentId:this.documentId,"operation.sequenceNumber":{$lte:t},tenantId:this.tenantId})}}async writeScribeCheckpointState(e){await this.documentRepository.updateOne({documentId:this.documentId,tenantId:this.tenantId},{scribe:JSON.stringify(e)},null)}async delete(e,t){await this.documentRepository.updateOne({documentId:this.documentId,tenantId:this.tenantId},{scribe:""},null),await this.opCollection.deleteMany({documentId:this.documentId,"operation.sequenceNumber":t?{$lte:e}:{$gte:e},tenantId:this.tenantId})}}},kOqW:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isRetryEnabled=void 0,t.isRetryEnabled=function(e){return!0===e.retryEnabled}},kYaE:function(e,t,r){"use strict";var n=r("Xou4");r.d(t,"c",(function(){return n.c})),r.d(t,"f",(function(){return n.d})),r.d(t,"a",(function(){return n.a})),r.d(t,"h",(function(){return n.e})),r.d(t,"b",(function(){return n.b}));var i=r("5zuf");r.d(t,"d",(function(){return i.a})),r.d(t,"e",(function(){return i.b}));var s=r("rK/e");r.d(t,"g",(function(){return s.a}))},kcMb:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultServiceConfiguration=void 0;const n=r("y2M+");t.DefaultServiceConfiguration={blockSize:64436,maxMessageSize:16384,enableTraces:!0,enableLumberjack:!0,deli:{enableNackMessages:!0,enableOpHashing:!0,enableAutoDSNUpdate:!1,checkForIdleClientsOnStartup:!1,maintainBatches:!1,enableWriteClientSignals:!1,clientTimeout:3e5,activityTimeout:3e4,readClientIdleTimer:6e4,noOpConsolidationTimeout:250,checkpointHeuristics:{enable:!1,idleTime:1e4,maxTime:6e4,maxMessages:500},opEvent:{enable:!1,idleTime:15e3,maxTime:3e5,maxOps:1500},summaryNackMessages:{enable:!1,checkOnStartup:!1,maxOps:5e3,nackContent:{code:429,type:n.NackErrorType.ThrottlingError,retryAfter:10,message:"Submit a summary before inserting additional operations"}},skipSummarizeAugmentationForSingleCommmit:!1,disableNoClientMessage:!1,enableLeaveOpNoClientServerMetadata:!1},broadcaster:{includeEventInMessageBatchName:!1},scribe:{generateServiceSummary:!0,enablePendingCheckpointMessages:!0,clearCacheAfterServiceSummary:!1,ignoreStorageException:!1,checkpointHeuristics:{enable:!1,idleTime:1e4,maxTime:6e4,maxMessages:500}},moira:{enable:!1,endpoint:""},documentLambda:{partitionActivityTimeout:6e5,partitionActivityCheckInterval:6e4}}},ki0U:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.debug=void 0;const n=r("Gstq"),i=r("fna4");t.debug=(0,n.debug)("fluid:memory-orderer"),(0,t.debug)(`Package: ${i.pkgName} - Version: ${i.pkgVersion}`)},l3fm:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BroadcasterLambdaFactory=t.BroadcasterLambda=void 0;var n=r("tY1o");Object.defineProperty(t,"BroadcasterLambda",{enumerable:!0,get:function(){return n.BroadcasterLambda}});var i=r("TrU0");Object.defineProperty(t,"BroadcasterLambdaFactory",{enumerable:!0,get:function(){return i.BroadcasterLambdaFactory}})},l8a6:function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return i(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.ForemanLambda=void 0;const o=r("wWog"),a=r("y2M+"),c=s(r("MPeK")),u=r("tp/L");t.ForemanLambda=class{constructor(e,t,r,n,i,s,a){this.messageSender=e,this.tenantManager=t,this.tokenGenerator=r,this.permissions=n,this.context=i,this.tenantId=s,this.documentId=a,this.taskQueueMap=new Map,this.rateLimiter=new o.RateLimiter(15e3);for(const e in this.permissions)for(const t of this.permissions[e])this.taskQueueMap.set(t,e)}close(){}async handler(e){const t=c.extractBoxcar(e);for(const e of t.contents)if(e.type===c.SequencedOperationType){const t=e;if(t.operation.type===a.MessageType.RemoteHelp){const e=JSON.parse(t.operation.data),r=e.version?e.tasks.map((e=>`chain-${e}`)):e.tasks;await this.trackDocument(t.operation.clientId,t.tenantId,t.documentId,r)}}this.context.checkpoint(e)}async trackDocument(e,t,r,n){var i;const s=await this.tenantManager.getKey(t),o=this.generateQueueTasks(n);for(const n of o){const o=n[0],c=this.rateLimiter.filter(e,n[1]);if(c.length>0){const n={documentId:r,message:{tasks:c},tenantId:t,token:this.tokenGenerator(t,r,s,[a.ScopeType.DocRead,a.ScopeType.DocWrite,a.ScopeType.SummaryWrite])};this.messageSender.sendTask(o,{content:n,type:"tasks:start"}),null===(i=this.context.log)||void 0===i||i.info(`Request to ${o}: ${e}:${JSON.stringify(c)}`,{messageMetaData:{documentId:r,tenantId:t}}),u.Lumberjack.info(`Request to ${o}: ${e}:${JSON.stringify(c)}`,{[u.BaseTelemetryProperties.tenantId]:t,[u.BaseTelemetryProperties.documentId]:r})}}}generateQueueTasks(e){const t=new Map;for(const r of e){const e=this.taskQueueMap.get(r);if(e){let n=t.get(e);n||(n=[],t.set(e,n)),n.push(r)}}return t}}},lMmm:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createDeliCheckpointManagerFromCollection=void 0,t.createDeliCheckpointManagerFromCollection=function(e,t,r){return{writeCheckpoint:async n=>{await r.updateOne({tenantId:e,documentId:t},{deli:JSON.stringify(n)})},deleteCheckpoint:async()=>{await r.updateOne({tenantId:e,documentId:t},{deli:""})}}}},mFHa:function(e,t,r){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.extractBoxcar=t.LambdaName=t.LambdaCloseType=void 0;const n=r("wWog"),i=r("FpcY");!function(e){e.Stop="Stop",e.ActivityTimeout="ActivityTimeout",e.Rebalance="Rebalance",e.Error="Error"}(t.LambdaCloseType||(t.LambdaCloseType={})),function(e){e.Scribe="Scribe"}(t.LambdaName||(t.LambdaName={})),t.extractBoxcar=function(t){if("string"!=typeof t.value&&!e.isBuffer(t.value))return t.value;const r=t.value.toString(),s=(0,n.safelyParseJSON)(r),o=s;if(!o)return{contents:[],documentId:null,tenantId:null,type:i.BoxcarType};if(o.type===i.BoxcarType){const e=o;return{contents:e.contents.length>0&&"string"==typeof e.contents[0]?e.contents.map((e=>JSON.parse(e))):e.contents,documentId:e.documentId,tenantId:e.tenantId,type:e.type}}return{contents:[o],documentId:s.documentId,tenantId:s.tenantId,type:i.BoxcarType}}}).call(this,r("zkTx").Buffer)},mktj:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PendingMessageReader=void 0;const n=r("fhs9");t.PendingMessageReader=class{constructor(e,t,r){this.tenantId=e,this.documentId=t,this.deltaService=r}async readMessages(e,t){return n.Lumberjack.info(`Fetching pending messages from ${e} to ${t}`,(0,n.getLumberBaseProperties)(this.documentId,this.tenantId)),this.deltaService.getDeltas("",this.tenantId,this.documentId,e-1,t+1)}}},mqfF:function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return i(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LocalNode=void 0;const a=o(r("ZERR")),c=r("hBZP"),u=r("fhs9"),l=r("yQiv"),h=s(r("9va6")),d=o(r("vuat")),m=r("Twpl"),p=r("ki0U"),f=r("3all"),g=r("+gGO");class y{constructor(e){this.socket=e,this.id=(0,m.v4)()}send(e,t){for(var r=arguments.length,n=new Array(r>2?r-2:0),i=2;i<r;i++)n[i-2]=arguments[i];this.socket.send({cid:-1,payload:{data:n,op:t,topic:e},type:"op"})}}class v extends c.EventEmitter{constructor(e,t,r,n,i,s,o,c,h,m,f,v){super(),this.webSocketServerFactory=e,this.node=t,this.storage=r,this.databaseManager=n,this.documentRepository=i,this.timeoutLength=s,this.taskMessageSender=o,this.tenantManager=c,this.permission=h,this.maxMessageSize=m,this.tokenGenerator=f,this.logger=v,this.orderMap=new Map,this.connectionMap=new Map,this.scheduleHeartbeat(),this.webSocketServer=this.webSocketServerFactory(),this.webSocketServer.on("connection",((e,t)=>{(0,p.debug)(`New inbound web socket connection ${t.url}`),u.Lumberjack.debug(`New inbound web socket connection ${t.url}`);const r=new g.Socket(e),n=new y(r);r.on("message",(e=>{switch(e.type){case"connect":{const t=e.payload,i=this.orderMap.get(`${t.tenantId}/${t.documentId}`);(0,a.default)(i);const s=i.connectInternal(n,(0,d.default)().toLowerCase().split(" ").join("-"),t.client);s.connect(),this.connectionMap.set(e.cid,s),r.send({cid:e.cid,type:"connected",payload:{clientId:s.clientId,existing:!0,maxMessageSize:this.maxMessageSize,serviceConfiguration:l.DefaultServiceConfiguration}});break}case"disconnect":{const t=this.connectionMap.get(e.cid);(0,a.default)(t),t.disconnect(),this.connectionMap.delete(e.cid);break}case"order":{const t=e.payload,r=this.connectionMap.get(e.cid);(0,a.default)(r),r.order([t]);break}}}))})),this.webSocketServer.on("error",(e=>{(0,p.debug)("wss error",e),u.Lumberjack.error("wss error",void 0,e)}))}static async connect(e,t,r,n,i,s,o,a,c,u,l,h,d){const m=await v.create(e,t,n,s);return new v(o,m,r,n,i,s,a,c,u,l,h,d)}static async create(e,t,r,n){(0,p.debug)("Creating node",e),u.Lumberjack.debug(`Creating node: ${e}`);const i=await r.getNodeCollection(),s={_id:e,address:t,expiration:Date.now()+n};return await i.insertOne(s),s}static async updateExpiration(e,t,r){const n=await t.getNodeCollection(),i=Date.now()+r;await n.update({_id:e._id,expiration:e.expiration},{expiration:i},null);const s=h.clone(e);return s.expiration=i,s}get id(){return this.node._id}get valid(){return!0}async connectOrderer(e,t){const r=`${e}/${t}`;(0,p.debug)(`${this.id} Becoming leader for ${r}`),u.Lumberjack.debug(`${this.id} Becoming leader for ${r}`);const n=await f.LocalOrderer.load(this.storage,this.databaseManager,e,t,this.taskMessageSender,this.tenantManager,this.permission,this.tokenGenerator,this.logger,this.documentRepository);return(0,a.default)(!this.orderMap.has(r)),this.orderMap.set(r,n),n}scheduleHeartbeat(){if(Date.now()>this.node.expiration)(0,p.debug)(`${this.node._id} did not renew before expiration`),u.Lumberjack.debug(`${this.node._id} did not renew before expiration`),this.emit("expired");else{const e=Math.max(0,this.node.expiration-this.timeoutLength/2-Date.now());setTimeout((()=>{v.updateExpiration(this.node,this.databaseManager,this.timeoutLength).then((e=>{this.node=e,this.scheduleHeartbeat()}),(e=>{(0,p.debug)(`Failed to renew expiration for ${this.node._id}`,e),u.Lumberjack.error(`Failed to renew expiration for ${this.node._id}`,void 0,e),this.scheduleHeartbeat()}))}),e)}}}t.LocalNode=v},mt0w:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CombinedProducer=void 0,t.CombinedProducer=class{constructor(e,t){this.producers=e,this.parallel=t}isConnected(){return this.producers.every((e=>e.isConnected()))}async send(e,t,r){if(this.parallel){const n=[];for(const i of this.producers)n.push(i.send(e,t,r));return Promise.all(n)}for(const n of this.producers)await n.send(e,t,r)}async close(){const e=[];for(const t of this.producers)e.push(t.close());await Promise.all(e)}on(e,t){return this}once(e,t){return this}}},n5Ot:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CheckpointContext=void 0;const n=r("fhs9");t.CheckpointContext=class{constructor(e,t,r,n){this.tenantId=e,this.id=t,this.checkpointManager=r,this.context=n,this.closed=!1}async checkpoint(e){var t,r;if(!this.closed)if(this.pendingUpdateP)this.pendingCheckpoint=e;else{try{this.pendingUpdateP=this.checkpointCore(e),await this.pendingUpdateP}catch(e){return null===(t=this.context.log)||void 0===t||t.error(`Error writing checkpoint to the database: ${JSON.stringify(e)}`,{messageMetaData:{documentId:this.id,tenantId:this.tenantId}}),void n.Lumberjack.error("Error writing checkpoint to the database",(0,n.getLumberBaseProperties)(this.id,this.tenantId),e)}try{const t=e.kafkaCheckpointMessage;t&&(void 0===this.lastKafkaCheckpointOffset||t.offset>this.lastKafkaCheckpointOffset)&&(this.lastKafkaCheckpointOffset=t.offset,this.context.checkpoint(t))}catch(e){null===(r=this.context.log)||void 0===r||r.error(`Error writing checkpoint to kafka: ${JSON.stringify(e)}`,{messageMetaData:{documentId:this.id,tenantId:this.tenantId}}),n.Lumberjack.error("Error writing checkpoint to the kafka",(0,n.getLumberBaseProperties)(this.id,this.tenantId),e)}if(this.pendingUpdateP=void 0,this.pendingCheckpoint){const e=this.pendingCheckpoint;this.pendingCheckpoint=void 0,this.checkpoint(e)}}}close(){this.closed=!0}checkpointCore(e){if(this.closed)return;let t;if(e.clear)t=this.checkpointManager.deleteCheckpoint(e);else{const r=Object.assign({},e.deliState);t=this.checkpointManager.writeCheckpoint(r,e.reason)}return t.catch((t=>{var r;return null===(r=this.context.log)||void 0===r||r.error(`Error writing checkpoint to MongoDB: ${JSON.stringify(t)}`,{messageMetaData:{documentId:this.id,tenantId:this.tenantId}}),n.Lumberjack.error("Error writing checkpoint to MongoDB",(0,n.getLumberBaseProperties)(this.id,this.tenantId),t),new Promise(((t,r)=>{t(this.checkpointCore(e))}))}))}}},nWOd:function(e,t,r){var n=r("wfEq"),i=r("yD7y"),s=r("KSsY"),o=r("pRMk").Buffer,a=new Array(64);function c(){this.init(),this._w=a,s.call(this,64,56)}n(c,i),c.prototype.init=function(){return this._a=3238371032,this._b=914150663,this._c=812702999,this._d=4144912697,this._e=4290775857,this._f=1750603025,this._g=1694076839,this._h=3204075428,this},c.prototype._hash=function(){var e=o.allocUnsafe(28);return e.writeInt32BE(this._a,0),e.writeInt32BE(this._b,4),e.writeInt32BE(this._c,8),e.writeInt32BE(this._d,12),e.writeInt32BE(this._e,16),e.writeInt32BE(this._f,20),e.writeInt32BE(this._g,24),e},e.exports=c},nazn:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LambdaSchemaValidator=t.BasePropertiesValidator=t.BaseLumberjackSchemaValidator=void 0;const n=r("6Cdk");class i{constructor(){this.validators=new Map,this.stringValidation=e=>this.isUndefined(e)||this.isString(e)&&e.length>0,this.numberValidation=e=>this.isUndefined(e)||this.isNumber(e),this.positiveNumberValidation=e=>this.isUndefined(e)||this.isNumber(e)&&e>=-1}validate(e){const t=[];return this.validators.forEach(((r,n)=>{e.has(n)&&r(e.get(n))||t.push(n)})),{validationPassed:0===t.length,validationFailedForProperties:t}}isUndefined(e){return void 0===e}isNumber(e){return"number"==typeof e}isString(e){return"string"==typeof e}}t.BaseLumberjackSchemaValidator=i;class s extends i{constructor(){super(),this.validators.set(n.BaseTelemetryProperties.tenantId,this.stringValidation),this.validators.set(n.BaseTelemetryProperties.documentId,this.stringValidation)}validate(e){return super.validate(e)}}t.BasePropertiesValidator=s,t.LambdaSchemaValidator=class extends s{constructor(){super(),this.validators.set(n.QueuedMessageProperties.topic,this.stringValidation),this.validators.set(n.QueuedMessageProperties.partition,this.positiveNumberValidation),this.validators.set(n.QueuedMessageProperties.offset,this.numberValidation)}validate(e){return super.validate(e)}}},ndW6:function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MoiraLambda=void 0;const i=r("yQiv"),s=r("fhs9"),o=n(r("thXI")),a=n(r("czhI"));t.MoiraLambda=class{constructor(e,t,r,n){this.context=e,this.serviceConfiguration=t,this.tenantId=r,this.documentId=n,this.pending=new Map,this.current=new Map}handler(e){const t=(0,i.extractBoxcar)(e);for(const e of t.contents)if(e.type===i.SequencedOperationType){const t=e;t.operation.traces=[];const r=`${t.tenantId}/${t.documentId}`;let n=this.pending.get(r);n||(n=[],this.pending.set(r,n)),n.push(t)}this.pendingOffset=e,this.sendPending()}close(){this.pending.clear(),this.current.clear()}sendPending(){if(this.current.size>0||0===this.pending.size)return;const e=this.current;this.current=this.pending,this.pending=e;const t=this.pendingOffset,r=[];for(const[,e]of this.current){const t=this.processMoiraCoreParallel(e);r.push(t)}Promise.all(r).then((()=>{this.current.clear(),this.context.checkpoint(t),this.sendPending()}),(e=>{this.context.error(e,{restart:!0})}))}createDerivedGuid(e,t){const r=(0,o.default)("sha1").update(`${e}:${t}`).digest("hex");return`${r.substr(0,8)}-${r.substr(8,4)}-${r.substr(12,4)}-${r.substr(16,4)}-${r.substr(20,12)}`}async processMoiraCoreParallel(e){var t,r,n,i;const s=new Map;for(const o of e)if("op"===(null===(t=null==o?void 0:o.operation)||void 0===t?void 0:t.type)){const e=JSON.parse(o.operation.contents),t=null===(i=null===(n=null===(r=e.contents)||void 0===r?void 0:r.contents)||void 0===n?void 0:n.content)||void 0===i?void 0:i.contents;if(t&&0===t.op&&void 0!==t.changeSet){const r=e.contents.contents.content.address,n=s.get(r);s.set(r,n?n.then((async()=>this.processMoiraCore(r,t,o))):this.processMoiraCore(r,t,o))}}return Promise.all(s.values())}async processMoiraCore(e,t,r){var n;const i=t.guid,o=`MH Commit: branch: ${e},\n        commit ${i},\n        changeSet:  ${JSON.stringify(t.changeSet,void 0,2)}`;null===(n=this.context.log)||void 0===n||n.info(o),this.serviceConfiguration.enableLumberjack&&s.Lumberjack.info(o,(0,s.getLumberBaseProperties)(this.documentId,this.tenantId));let a=t.referenceGuid;""===t.referenceGuid&&(a=await this.createBranch(e)),await this.createCommit(i,a,e,t,r)}async createBranch(e){var t,r;const n=this.createDerivedGuid(e,"root"),i=await a.default.post(`${this.serviceConfiguration.moira.endpoint}/branch`,{guid:e,rootCommitGuid:n,meta:{},created:0}),o=Object.assign(Object.assign({},(0,s.getLumberBaseProperties)(this.documentId,this.tenantId)),{[s.CommonProperties.statusCode]:i.status});if(200===i.status){const r=`Branch with guid: ${e} created`;null===(t=this.context.log)||void 0===t||t.info(r),this.serviceConfiguration.enableLumberjack&&s.Lumberjack.info(r,o)}else{const t=`Branch with guid ${e} failed`;null===(r=this.context.log)||void 0===r||r.error(t),this.serviceConfiguration.enableLumberjack&&s.Lumberjack.error(t,o)}return n}async createCommit(e,t,r,n,i){var o,c,u;try{const u={guid:e,branchGuid:r,parentGuid:t,meta:{remoteHeadGuid:n.remoteHeadGuid,localBranchStart:n.localBranchStart,sequenceNumber:i.operation.sequenceNumber,minimumSequenceNumber:i.operation.minimumSequenceNumber}},l=await a.default.post(`${this.serviceConfiguration.moira.endpoint}/branch/${r}/commit`,Object.assign(Object.assign({},u),{changeSet:JSON.stringify(n.changeSet),rebase:!0})),h=Object.assign(Object.assign({},(0,s.getLumberBaseProperties)(this.documentId,this.tenantId)),{[s.CommonProperties.statusCode]:l.status});if(200===l.status){const e=`Commit created ${JSON.stringify(u)}`;null===(o=this.context.log)||void 0===o||o.info(e),this.serviceConfiguration.enableLumberjack&&s.Lumberjack.info(e,h)}else{const e=`Commit failed ${JSON.stringify(u)}`;null===(c=this.context.log)||void 0===c||c.error(e),this.serviceConfiguration.enableLumberjack&&s.Lumberjack.error(e,h)}}catch(e){const t=`Commit failed. ${e.message}`;null===(u=this.context.log)||void 0===u||u.error(t),this.serviceConfiguration.enableLumberjack&&s.Lumberjack.error(t,(0,s.getLumberBaseProperties)(this.documentId,this.tenantId),e)}}}},ngQy:function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Lumber=void 0;const i=n(r("a0Z+")),s=r("Twpl"),o=r("wWog"),a=r("yxQQ"),c=r("6Cdk");t.Lumber=class{constructor(e,t,r,n,i){this.eventName=e,this.type=t,this._engineList=r,this._schemaValidators=n,this._startTime=o.performance.now(),this._properties=new Map,this._completed=!1,this.timestamp=Date.now(),this.id=(0,s.v4)(),i&&this.setProperties(i)}get properties(){return this._properties}get durationInMs(){if(this.type!==c.LumberType.Log)return this._durationInMs}get successful(){if(this.type!==c.LumberType.Log)return this._successful}get message(){return this._message}get exception(){return this._exception}get logLevel(){return this._logLevel}setProperty(e,t){return this._properties.set(e,t),this}setProperties(e){return e instanceof Map?0===this._properties.size?this._properties=e:e.forEach(((e,t)=>{this.setProperty(t,e)})):Object.entries(e).forEach((e=>{const[t,r]=e;this.setProperty(t,r)})),this}success(e){this.emit(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:c.LogLevel.Info,!0,void 0)}error(e,t){this.emit(e,arguments.length>2&&void 0!==arguments[2]?arguments[2]:c.LogLevel.Error,!1,t)}isCompleted(){return this._completed}emit(e,t,r,n){if(this._completed)return void(0,c.handleError)(a.LumberEventName.LumberjackError,`Trying to complete a Lumber telemetry operation that has alredy been completed.                [eventName: ${this.eventName}][id: ${this.id}]`,this._engineList);if(this._schemaValidators)for(const e of this._schemaValidators){const t=e.validate(this.properties);t.validationPassed||(0,c.handleError)(a.LumberEventName.LumberjackSchemaValidationFailure,`Schema validation failed for props: ${t.validationFailedForProperties.toString()}.                        [eventName: ${this.eventName}][id: ${this.id}]`,this._engineList)}this._message=e,this._logLevel=t,this._successful=r,n instanceof Error?this._exception=n:void 0!==n&&(this._exception=new Error((0,i.default)(n)));const s=parseFloat(this.properties.get("durationInMs"));this._durationInMs=isNaN(s)?o.performance.now()-this._startTime:s,this._engineList.forEach((e=>e.emit(this))),this._completed=!0}}},o5Rw:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScriptoriumLambda=void 0;const n=r("yQiv"),i=r("fhs9"),s=r("YkJt");var o;!function(e){e.Processing="Processing",e.ProcessingComplete="ProcessingComplete",e.CheckpointComplete="CheckpointComplete",e.ProcessingFailed="ProcessingFailed",e.CheckpointFailed="CheckpointFailed"}(o||(o={})),t.ScriptoriumLambda=class{constructor(e,t,r){var i,s,o;this.opCollection=e,this.context=t,this.providerConfig=r,this.pending=new Map,this.current=new Map,this.clientFacadeRetryEnabled=(0,n.isRetryEnabled)(this.opCollection),this.telemetryEnabled=null===(i=this.providerConfig)||void 0===i?void 0:i.enableTelemetry,this.maxDbBatchSize=null!==(o=null===(s=this.providerConfig)||void 0===s?void 0:s.maxDbBatchSize)&&void 0!==o?o:1e3}handler(e){var t,r,s,o;const a=(0,n.extractBoxcar)(e);for(const e of a.contents)if(e.type===n.SequencedOperationType){const t=e;t.operation.traces=[];const r=`${t.tenantId}/${t.documentId}`;let n=this.pending.get(r);n||(n=[],this.pending.set(r,n)),n.push(t)}if(this.pendingOffset=e,this.telemetryEnabled)if(void 0===this.pendingMetric)this.pendingMetric=i.Lumberjack.newLumberMetric(i.LumberEventName.ScriptoriumProcessBatch,{timestampQueuedMessage:e.timestamp?new Date(e.timestamp).toISOString():null,timestampReadyToProcess:(new Date).toISOString(),[i.QueuedMessageProperties.partition]:null===(t=this.pendingOffset)||void 0===t?void 0:t.partition,[i.QueuedMessageProperties.offsetStart]:null===(r=this.pendingOffset)||void 0===r?void 0:r.offset,[i.QueuedMessageProperties.offsetEnd]:null===(s=this.pendingOffset)||void 0===s?void 0:s.offset,[i.CommonProperties.totalBatchSize]:a.contents.length});else{this.pendingMetric.setProperty(i.QueuedMessageProperties.offsetEnd,null===(o=this.pendingOffset)||void 0===o?void 0:o.offset);const e=a.contents.length,t=Number(this.pendingMetric.properties.get(i.CommonProperties.totalBatchSize));this.pendingMetric.setProperty(i.CommonProperties.totalBatchSize,t+e)}this.sendPending()}close(){this.pending.clear(),this.current.clear()}sendPending(){if(this.current.size>0||0===this.pending.size)return;let e;this.telemetryEnabled&&this.pendingMetric&&(e=this.pendingMetric,this.pendingMetric=void 0,e.setProperty("timestampProcessingStart",(new Date).toISOString()));let t=o.Processing;const r=this.current;this.current=this.pending,this.pending=r;const n=this.pendingOffset,i=[];for(const[,t]of this.current)if(this.maxDbBatchSize>0&&t.length>this.maxDbBatchSize){let r=0;for(;r<t.length;){const n=r+this.maxDbBatchSize,s=t.slice(r,n);r=n;const o=this.processMongoCore(s,null==e?void 0:e.id);i.push(o)}}else{const r=this.processMongoCore(t,null==e?void 0:e.id);i.push(r)}Promise.all(i).then((()=>{this.current.clear(),t=o.ProcessingComplete,null==e||e.setProperty("timestampProcessingComplete",(new Date).toISOString());try{this.context.checkpoint(n),t=o.CheckpointComplete,null==e||e.setProperty("timestampCheckpointComplete",(new Date).toISOString())}catch(r){throw t=o.CheckpointFailed,null==e||e.setProperty("timestampCheckpointFailed",(new Date).toISOString()),this.logErrorTelemetry("Scriptorium failed to checkpoint batch",r,t,null==n?void 0:n.offset,e),r}null==e||e.setProperty("status",t),null==e||e.success("Scriptorium completed processing and checkpointing of batch"),this.sendPending()}),(r=>{t=o.ProcessingFailed,null==e||e.setProperty("timestampProcessingFailed",(new Date).toISOString()),this.logErrorTelemetry("Scriptorium failed to process batch, going to restart",r,t,null==n?void 0:n.offset,e),this.context.error(r,{restart:!0})}))}logErrorTelemetry(e,t,r,n,s){this.telemetryEnabled&&s?(s.setProperty("status",r),s.error(e,t)):i.Lumberjack.error(e,{batchOffset:n,status:r},t)}async processMongoCore(e,t){return this.insertOp(e,t)}async insertOp(e,t){var r,o,a,c;const u=e.map((e=>Object.assign(Object.assign({},e),{mongoTimestamp:new Date(e.operation.timestamp)}))),l=null!==(o=null===(r=e[0])||void 0===r?void 0:r.documentId)&&void 0!==o?o:"",h=null!==(c=null===(a=e[0])||void 0===a?void 0:a.tenantId)&&void 0!==c?c:"",d=e.map((e=>e.operation.sequenceNumber)),m=(0,s.convertSortedNumberArrayToRanges)(d),p=u.length;return(0,n.runWithRetry)((async()=>this.opCollection.insertMany(u,!1)),"insertOpScriptorium",3,1e3,Object.assign(Object.assign({},(0,i.getLumberBaseProperties)(l,h)),{sequenceNumberRanges:m,insertBatchSize:p,scriptoriumMetricId:t}),(e=>11e3===e.code),(e=>!this.clientFacadeRetryEnabled),void 0,void 0,this.telemetryEnabled)}}},oEwc:function(e,t,r){"use strict";r.d(t,"f",(function(){return o})),r.d(t,"g",(function(){return a})),r.d(t,"e",(function(){return c})),r.d(t,"b",(function(){return u})),r.d(t,"c",(function(){return l})),r.d(t,"a",(function(){return h})),r.d(t,"d",(function(){return d}));var n=r("HJ7Z"),i=r("l4ds"),s=r("7/yF");function o(e){const t=e.type===n.a.Handle?e.handleType:e.type;switch(t){case n.a.Blob:case n.a.Attachment:return i.a.File;case n.a.Tree:return i.a.Directory;default:Object(s.a)(t,`Unknown type: ${t}`)}}function a(e){const t=e.type===n.a.Handle?e.handleType:e.type;switch(t){case n.a.Blob:case n.a.Attachment:return"blob";case n.a.Tree:return"tree";default:Object(s.a)(t,`Unknown type: ${t}`)}}function c(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Map,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const n={},i={id:e.sha,blobs:{},trees:{}};n[""]=i;for(const i of e.tree){const e=r?i.path.replace(/^\.app\//,""):i.path,s=e.lastIndexOf("/"),o=e.slice(0,Math.max(0,s)),a=e.slice(s+1),c=n[o];if("tree"===i.type){const t={id:i.sha,blobs:{},commits:{},trees:{}};c.trees[decodeURIComponent(a)]=t,n[e]=t}else{if("blob"!==i.type)throw new Error("Unknown entry type!!");c.blobs[decodeURIComponent(a)]=i.sha,t.set(i.sha,`/${e}`)}}return i}class u{constructor(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"utf-8";this.path=e,this.mode=i.a.File,this.type=i.b.Blob,this.value={contents:t,encoding:r}}}class l{constructor(e,t){this.path=e,this.value=t,this.mode=i.a.Directory,this.type=i.b.Tree}}class h{constructor(e,t){this.path=e,this.id=t,this.mode=i.a.File,this.type=i.b.Attachment,this.value={id:t}}}function d(e,t,r){e.entries.push({mode:i.a.File,path:t,type:i.b.Blob,value:{contents:JSON.stringify(r),encoding:"utf-8"}})}},oPUo:function(e,t,r){(function(e){var n=void 0!==e&&e||"undefined"!=typeof self&&self||window,i=Function.prototype.apply;function s(e,t){this._id=e,this._clearFn=t}t.setTimeout=function(){return new s(i.call(setTimeout,n,arguments),clearTimeout)},t.setInterval=function(){return new s(i.call(setInterval,n,arguments),clearInterval)},t.clearTimeout=t.clearInterval=function(e){e&&e.close()},s.prototype.unref=s.prototype.ref=function(){},s.prototype.close=function(){this._clearFn.call(n,this._id)},t.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},t.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},t._unrefActive=t.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout((function(){e._onTimeout&&e._onTimeout()}),t))},r("heVN"),t.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==e&&e.setImmediate||this&&this.setImmediate,t.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==e&&e.clearImmediate||this&&this.clearImmediate}).call(this,r("pCvA"))},oVfu:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CopierLambda=void 0;const n=r("yQiv");t.CopierLambda=class{constructor(e,t){this.rawOpCollection=e,this.context=t,this.pendingJobs=new Map,this.currentJobs=new Map}handler(e){const t=(0,n.extractBoxcar)(e),r=`${t.tenantId}/${t.documentId}`,i={index:e.offset,documentId:t.documentId,tenantId:t.tenantId,contents:t.contents.map((e=>e))};let s=this.pendingJobs.get(r);s||(s=[],this.pendingJobs.set(r,s)),s.push(i),this.pendingOffset=e,this.sendPending()}close(){this.pendingJobs.clear(),this.currentJobs.clear()}sendPending(){if(this.currentJobs.size>0||0===this.pendingJobs.size)return;const e=this.currentJobs;this.currentJobs=this.pendingJobs,this.pendingJobs=e;const t=this.pendingOffset,r=[];for(const[,e]of this.currentJobs){const t=this.processMongoCore(e);r.push(t)}Promise.all(r).then((()=>{this.currentJobs.clear(),this.context.checkpoint(t),this.sendPending()}),(e=>{this.context.error(e,{restart:!0})}))}async processMongoCore(e){await this.rawOpCollection.insertMany(e,!1).catch((e=>{if(11e3!==e.code)return Promise.reject(e)}))}}},or3g:function(e,t,r){"use strict";r.r(t),r.d(t,"addBlobToTree",(function(){return n.d})),r.d(t,"AttachmentTreeEntry",(function(){return n.a})),r.d(t,"BlobTreeEntry",(function(){return n.b})),r.d(t,"buildHierarchy",(function(){return n.e})),r.d(t,"getGitMode",(function(){return n.f})),r.d(t,"getGitType",(function(){return n.g})),r.d(t,"TreeTreeEntry",(function(){return n.c})),r.d(t,"isSystemMessage",(function(){return i.b})),r.d(t,"ProtocolOpHandler",(function(){return i.a})),r.d(t,"Quorum",(function(){return s.a})),r.d(t,"QuorumClients",(function(){return s.b})),r.d(t,"QuorumProposals",(function(){return s.c})),r.d(t,"generateServiceProtocolEntries",(function(){return u})),r.d(t,"getQuorumTreeEntries",(function(){return a})),r.d(t,"mergeAppAndProtocolTree",(function(){return c})),r.d(t,"isServiceMessageType",(function(){return d}));var n=r("Ls0c"),i=r("RLzy"),s=r("rtkY"),o=r("l4ds");function a(e,t,r,n,i){const s={minimumSequenceNumber:t,sequenceNumber:r,term:n};return[{mode:o.a.File,path:"quorumMembers",type:o.b.Blob,value:{contents:JSON.stringify(i.members),encoding:"utf-8"}},{mode:o.a.File,path:"quorumProposals",type:o.b.Blob,value:{contents:JSON.stringify(i.proposals),encoding:"utf-8"}},{mode:o.a.File,path:"quorumValues",type:o.b.Blob,value:{contents:JSON.stringify(i.values),encoding:"utf-8"}},{mode:o.a.File,path:"attributes",type:o.b.Blob,value:{contents:JSON.stringify(s),encoding:"utf-8"}}]}function c(e,t){const r=e.tree.filter((e=>!l(e.path))).map((e=>({mode:e.mode,path:e.path,sha:e.sha,type:e.type})));return r.push({mode:o.a.Directory,path:".protocol",sha:t.sha,type:"tree"}),r}function u(e,t){const r=[{mode:o.a.File,path:"deli",type:o.b.Blob,value:{contents:e,encoding:"utf-8"}}];return r.push({mode:o.a.File,path:"scribe",type:o.b.Blob,value:{contents:t,encoding:"utf-8"}}),r}const l=e=>".protocol"===e||".logTail"===e||".serviceProtocol"===e;var h=r("f79D");const d=e=>e===h.a.ClientJoin||e===h.a.ClientLeave||e===h.a.Control||e===h.a.NoClient||e===h.a.SummaryAck||e===h.a.SummaryNack},pJ2M:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sendToDeli=t.initializeProtocol=void 0;const n=r("iS6B"),i=r("yQiv");t.initializeProtocol=(e,t)=>new n.ProtocolOpHandler(e.minimumSequenceNumber,e.sequenceNumber,t,e.members,e.proposals,e.values,(()=>-1)),t.sendToDeli=(e,t,r,n)=>{if(!r)throw new Error("Invalid producer");const s={clientId:null,documentId:t,operation:n,tenantId:e,timestamp:Date.now(),type:i.RawOperationType};return r.send([s],e,t)}},pKcq:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LumberEventName=void 0,function(e){e.LumberjackError="LumberjackError",e.LumberjackSchemaValidationFailure="LumberjackSchemaValidationFailure",e.RunService="RunService",e.UnitTestEvent="UnitTestEvent",e.ClientSummary="ClientSummary",e.DeliHandler="DeliHandler",e.KafkaRunner="KafkaRunner",e.ScribeHandler="ScribeHandler",e.ServiceSummary="ServiceSummary",e.SummaryReader="SummaryReader",e.ScriptoriumProcessBatch="ScriptoriumProcessBatch",e.RunWithRetry="RunWithRetry",e.RequestWithRetry="RequestWithRetry",e.SessionResult="SessionResult",e.StartSessionResult="StartSessionResult",e.ScribeSessionResult="ScribeSessionResult",e.ConnectDocument="ConnectDocument",e.ConnectDocumentAddClient="ConnectDocumentAddClient",e.ConnectDocumentGetClients="ConnectDocumentGetClients",e.ConnectDocumentOrdererConnection="ConnectDocumentOrdererConnection",e.CreateDocumentUpdateDocumentCollection="CreateDocumentUpdateDocumentCollection",e.CreateDocInitialSummaryWrite="CreateDocInitialSummaryWrite",e.RiddlerFetchTenantKey="RiddlerFetchTenantKey",e.HttpRequest="HttpRequest",e.TotalConnectionCount="TotalConnectionCount",e.ConnectionCountPerNode="ConnectionCountPerNode"}(t.LumberEventName||(t.LumberEventName={}))},pRMk:function(e,t,r){var n=r("zkTx"),i=n.Buffer;function s(e,t){for(var r in e)t[r]=e[r]}function o(e,t,r){return i(e,t,r)}i.from&&i.alloc&&i.allocUnsafe&&i.allocUnsafeSlow?e.exports=n:(s(n,t),t.Buffer=o),o.prototype=Object.create(i.prototype),s(i,o),o.from=function(e,t,r){if("number"==typeof e)throw new TypeError("Argument must not be a number");return i(e,t,r)},o.alloc=function(e,t,r){if("number"!=typeof e)throw new TypeError("Argument must be a number");var n=i(e);return void 0!==t?"string"==typeof r?n.fill(t,r):n.fill(t):n.fill(0),n},o.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return i(e)},o.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return n.SlowBuffer(e)}},pRkM:function(e,t,r){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.extractBoxcar=t.LambdaName=t.LambdaCloseType=void 0;const n=r("wWog"),i=r("DKo5");!function(e){e.Stop="Stop",e.ActivityTimeout="ActivityTimeout",e.Rebalance="Rebalance",e.Error="Error"}(t.LambdaCloseType||(t.LambdaCloseType={})),function(e){e.Scribe="Scribe"}(t.LambdaName||(t.LambdaName={})),t.extractBoxcar=function(t){if("string"!=typeof t.value&&!e.isBuffer(t.value))return t.value;const r=t.value.toString(),s=(0,n.safelyParseJSON)(r),o=s;if(!o)return{contents:[],documentId:null,tenantId:null,type:i.BoxcarType};if(o.type===i.BoxcarType){const e=o;return{contents:e.contents.length>0&&"string"==typeof e.contents[0]?e.contents.map((e=>JSON.parse(e))):e.contents,documentId:e.documentId,tenantId:e.tenantId,type:e.type}}return{contents:[o],documentId:s.documentId,tenantId:s.tenantId,type:i.BoxcarType}}}).call(this,r("zkTx").Buffer)},pckk:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pkgVersion=t.pkgName=void 0,t.pkgName="@fluidframework/server-services-core",t.pkgVersion="0.1040.1000"},pfo9:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScriptoriumLambda=void 0;const n=r("MPeK"),i=r("tp/L"),s=r("Lvy3");var o;!function(e){e.Processing="Processing",e.ProcessingComplete="ProcessingComplete",e.CheckpointComplete="CheckpointComplete",e.ProcessingFailed="ProcessingFailed",e.CheckpointFailed="CheckpointFailed"}(o||(o={})),t.ScriptoriumLambda=class{constructor(e,t,r){var i,s,o;this.opCollection=e,this.context=t,this.providerConfig=r,this.pending=new Map,this.current=new Map,this.clientFacadeRetryEnabled=(0,n.isRetryEnabled)(this.opCollection),this.telemetryEnabled=null===(i=this.providerConfig)||void 0===i?void 0:i.enableTelemetry,this.maxDbBatchSize=null!==(o=null===(s=this.providerConfig)||void 0===s?void 0:s.maxDbBatchSize)&&void 0!==o?o:1e3}handler(e){var t,r,s,o;const a=(0,n.extractBoxcar)(e);for(const e of a.contents)if(e.type===n.SequencedOperationType){const t=e;t.operation.traces=[];const r=`${t.tenantId}/${t.documentId}`;let n=this.pending.get(r);n||(n=[],this.pending.set(r,n)),n.push(t)}if(this.pendingOffset=e,this.telemetryEnabled)if(void 0===this.pendingMetric)this.pendingMetric=i.Lumberjack.newLumberMetric(i.LumberEventName.ScriptoriumProcessBatch,{timestampQueuedMessage:e.timestamp?new Date(e.timestamp).toISOString():null,timestampReadyToProcess:(new Date).toISOString(),[i.QueuedMessageProperties.partition]:null===(t=this.pendingOffset)||void 0===t?void 0:t.partition,[i.QueuedMessageProperties.offsetStart]:null===(r=this.pendingOffset)||void 0===r?void 0:r.offset,[i.QueuedMessageProperties.offsetEnd]:null===(s=this.pendingOffset)||void 0===s?void 0:s.offset,[i.CommonProperties.totalBatchSize]:a.contents.length});else{this.pendingMetric.setProperty(i.QueuedMessageProperties.offsetEnd,null===(o=this.pendingOffset)||void 0===o?void 0:o.offset);const e=a.contents.length,t=Number(this.pendingMetric.properties.get(i.CommonProperties.totalBatchSize));this.pendingMetric.setProperty(i.CommonProperties.totalBatchSize,t+e)}this.sendPending()}close(){this.pending.clear(),this.current.clear()}sendPending(){if(this.current.size>0||0===this.pending.size)return;let e;this.telemetryEnabled&&this.pendingMetric&&(e=this.pendingMetric,this.pendingMetric=void 0,e.setProperty("timestampProcessingStart",(new Date).toISOString()));let t=o.Processing;const r=this.current;this.current=this.pending,this.pending=r;const n=this.pendingOffset,i=[];for(const[,t]of this.current)if(this.maxDbBatchSize>0&&t.length>this.maxDbBatchSize){let r=0;for(;r<t.length;){const n=r+this.maxDbBatchSize,s=t.slice(r,n);r=n;const o=this.processMongoCore(s,null==e?void 0:e.id);i.push(o)}}else{const r=this.processMongoCore(t,null==e?void 0:e.id);i.push(r)}Promise.all(i).then((()=>{this.current.clear(),t=o.ProcessingComplete,null==e||e.setProperty("timestampProcessingComplete",(new Date).toISOString());try{this.context.checkpoint(n),t=o.CheckpointComplete,null==e||e.setProperty("timestampCheckpointComplete",(new Date).toISOString())}catch(r){throw t=o.CheckpointFailed,null==e||e.setProperty("timestampCheckpointFailed",(new Date).toISOString()),this.logErrorTelemetry("Scriptorium failed to checkpoint batch",r,t,null==n?void 0:n.offset,e),r}null==e||e.setProperty("status",t),null==e||e.success("Scriptorium completed processing and checkpointing of batch"),this.sendPending()}),(r=>{t=o.ProcessingFailed,null==e||e.setProperty("timestampProcessingFailed",(new Date).toISOString()),this.logErrorTelemetry("Scriptorium failed to process batch, going to restart",r,t,null==n?void 0:n.offset,e),this.context.error(r,{restart:!0})}))}logErrorTelemetry(e,t,r,n,s){this.telemetryEnabled&&s?(s.setProperty("status",r),s.error(e,t)):i.Lumberjack.error(e,{batchOffset:n,status:r},t)}async processMongoCore(e,t){return this.insertOp(e,t)}async insertOp(e,t){var r,o,a,c;const u=e.map((e=>Object.assign(Object.assign({},e),{mongoTimestamp:new Date(e.operation.timestamp)}))),l=null!==(o=null===(r=e[0])||void 0===r?void 0:r.documentId)&&void 0!==o?o:"",h=null!==(c=null===(a=e[0])||void 0===a?void 0:a.tenantId)&&void 0!==c?c:"",d=e.map((e=>e.operation.sequenceNumber)),m=(0,s.convertSortedNumberArrayToRanges)(d),p=u.length;return(0,n.runWithRetry)((async()=>this.opCollection.insertMany(u,!1)),"insertOpScriptorium",3,1e3,Object.assign(Object.assign({},(0,i.getLumberBaseProperties)(l,h)),{sequenceNumberRanges:m,insertBatchSize:p,scriptoriumMetricId:t}),(e=>11e3===e.code),(e=>!this.clientFacadeRetryEnabled),void 0,void 0,this.telemetryEnabled)}}},qIk9:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestCache=void 0,t.TestCache=class{constructor(){this.map=new Map}async get(e){var t;return null!==(t=this.map.get(e))&&void 0!==t?t:""}async set(e,t){this.map.set(e,t)}async delete(e){return this.map.delete(e)}async incr(e){var t;let r=null!==(t=parseInt(this.map.get(e),10))&&void 0!==t?t:0;return r+=1,this.map.set(e,r.toString()),r}async decr(e){var t;let r=null!==(t=parseInt(this.map.get(e),10))&&void 0!==t?t:0;return r-=1,this.map.set(e,r.toString()),r}}},qeYL:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CheckpointContext=void 0;const n=r("tp/L");t.CheckpointContext=class{constructor(e,t,r,n){this.tenantId=e,this.id=t,this.checkpointManager=r,this.context=n,this.closed=!1}async checkpoint(e){var t,r;if(!this.closed)if(this.pendingUpdateP)this.pendingCheckpoint=e;else{try{this.pendingUpdateP=this.checkpointCore(e),await this.pendingUpdateP}catch(e){return null===(t=this.context.log)||void 0===t||t.error(`Error writing checkpoint to the database: ${JSON.stringify(e)}`,{messageMetaData:{documentId:this.id,tenantId:this.tenantId}}),void n.Lumberjack.error("Error writing checkpoint to the database",(0,n.getLumberBaseProperties)(this.id,this.tenantId),e)}try{const t=e.kafkaCheckpointMessage;t&&(void 0===this.lastKafkaCheckpointOffset||t.offset>this.lastKafkaCheckpointOffset)&&(this.lastKafkaCheckpointOffset=t.offset,this.context.checkpoint(t))}catch(e){null===(r=this.context.log)||void 0===r||r.error(`Error writing checkpoint to kafka: ${JSON.stringify(e)}`,{messageMetaData:{documentId:this.id,tenantId:this.tenantId}}),n.Lumberjack.error("Error writing checkpoint to the kafka",(0,n.getLumberBaseProperties)(this.id,this.tenantId),e)}if(this.pendingUpdateP=void 0,this.pendingCheckpoint){const e=this.pendingCheckpoint;this.pendingCheckpoint=void 0,this.checkpoint(e)}}}close(){this.closed=!0}checkpointCore(e){if(this.closed)return;let t;if(e.clear)t=this.checkpointManager.deleteCheckpoint(e);else{const r=Object.assign({},e.deliState);t=this.checkpointManager.writeCheckpoint(r,e.reason)}return t.catch((t=>{var r;return null===(r=this.context.log)||void 0===r||r.error(`Error writing checkpoint to MongoDB: ${JSON.stringify(t)}`,{messageMetaData:{documentId:this.id,tenantId:this.tenantId}}),n.Lumberjack.error("Error writing checkpoint to MongoDB",(0,n.getLumberBaseProperties)(this.id,this.tenantId),t),new Promise(((t,r)=>{t(this.checkpointCore(e))}))}))}}},"qg/C":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultMetricClient=void 0,t.DefaultMetricClient=class{writeLatencyMetric(e,t){return Promise.resolve()}}},qiG6:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ProxyOrderer=void 0,t.ProxyOrderer=class{constructor(e){this.factory=e}async connect(e,t,r){return await this.factory.connect(e,r)}close(){return Promise.resolve()}}},qymq:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScriptoriumLambdaFactory=t.ScriptoriumLambda=void 0;var n=r("o5Rw");Object.defineProperty(t,"ScriptoriumLambda",{enumerable:!0,get:function(){return n.ScriptoriumLambda}});var i=r("SzwC");Object.defineProperty(t,"ScriptoriumLambdaFactory",{enumerable:!0,get:function(){return i.ScriptoriumLambdaFactory}})},"r+Vx":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Lumberjack=void 0;const n=r("yxQQ"),i=r("ngQy"),s=r("6Cdk");class o{constructor(){this._engineList=[],this._isSetupCompleted=!1}static get instance(){return o._instance||(o._instance=new o),o._instance}static createInstance(e,t){const r=new o;return r.setup(e,t),r}static setup(e,t){this.instance.setup(e,t)}static newLumberMetric(e,t){return this.instance.newLumberMetric(e,t)}static log(e,t,r,n){this.instance.log(e,t,r,n)}static debug(e,t){this.instance.log(e,s.LogLevel.Debug,t)}static verbose(e,t){this.instance.log(e,s.LogLevel.Verbose,t)}static info(e,t){this.instance.log(e,s.LogLevel.Info,t)}static warning(e,t,r){this.instance.log(e,s.LogLevel.Warning,t,r)}static error(e,t,r){this.instance.log(e,s.LogLevel.Error,t,r)}setup(e,t){this._isSetupCompleted?(0,s.handleError)(n.LumberEventName.LumberjackError,"This Lumberjack was already setup with a list of engines and optional schema validator.",this._engineList):0!==e.length?(this._engineList.push(...e),this._schemaValidators=t,this._isSetupCompleted=!0):(0,s.handleError)(n.LumberEventName.LumberjackError,"The provided engine list is empty. Please provide at list one LumberjackEngine.",this._engineList)}newLumberMetric(e,t){return this.errorOnIncompleteSetup(),new i.Lumber(e,s.LumberType.Metric,this._engineList,this._schemaValidators,t)}static isSetupCompleted(){return this.instance._isSetupCompleted}log(e,t,r,n){this.errorOnIncompleteSetup();const a=new i.Lumber(o.LogMessageEventName,s.LumberType.Log,this._engineList,this._schemaValidators,r);t===s.LogLevel.Warning||t===s.LogLevel.Error?a.error(e,n,t):a.success(e,t)}debug(e,t){this.log(e,s.LogLevel.Debug,t)}verbose(e,t){this.log(e,s.LogLevel.Verbose,t)}info(e,t){this.log(e,s.LogLevel.Info,t)}warning(e,t,r){this.log(e,s.LogLevel.Warning,t,r)}error(e,t,r){this.log(e,s.LogLevel.Error,t,r)}errorOnIncompleteSetup(){this._isSetupCompleted||(0,s.handleError)(n.LumberEventName.LumberjackError,"Lumberjack has not been setup yet. It requires an engine list and an optional schema validator.",this._engineList)}}t.Lumberjack=o,o.LogMessageEventName="LogMessage"},r43a:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createRoomLeaveMessage=t.createRoomJoinMessage=t.createNackMessage=void 0;const n=r("y2M+");t.createNackMessage=(e,t,r,n)=>({operation:void 0,sequenceNumber:-1,content:{code:e,type:t,message:r,retryAfter:n}}),t.createRoomJoinMessage=function(e,t){return{clientId:null,content:JSON.stringify({type:n.MessageType.ClientJoin,content:{clientId:e,client:t}})}},t.createRoomLeaveMessage=e=>({clientId:null,content:JSON.stringify({type:n.MessageType.ClientLeave,content:e})})},r4Zv:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestKafka=t.TestProducer=t.TestConsumer=void 0;const n=r("ZERR"),i=r("hBZP"),s=r("UyQ0");class o{constructor(e,t){this.groupId=e,this.topic=t,this.emitter=new i.EventEmitter,this.pausedQueue=null,this.failOnCommit=!1,this.context=new s.TestContext}setFailOnCommit(e){this.failOnCommit=e}isConnected(){return!0}getLatestMessageOffset(e){}async commitCheckpoint(e,t){return(0,n.strict)(0===e),this.failOnCommit?Promise.reject(new Error("TestConsumer set to fail on commit")):void this.context.checkpoint(t)}getOffset(){return this.context.offset}async waitForOffset(e){return this.context.waitForOffset(e)}on(e,t){return this.emitter.on(e,t),this}once(e,t){return this.emitter.once(e,t),this}async close(){}async pause(){this.pausedQueue||(this.pausedQueue=[])}async resume(){if(!this.pausedQueue)return;const e=this.pausedQueue;this.pausedQueue=null;for(const t of e)this.emit(t)}emitError(e){this.emitter.emit("error",e)}emit(e){this.pausedQueue?this.pausedQueue.push(e):this.emitter.emit("data",e)}rebalance(){this.emitter.emit("rebalancing"),this.emitter.emit("rebalanced",[{topic:this.topic,offset:0,partition:0}])}}t.TestConsumer=o;class a{constructor(e){this.kafka=e}isConnected(){return!0}async send(e,t){for(const r of e)this.kafka.addMessage(r,t)}async close(){}on(e,t){return this}once(e,t){return this}}t.TestProducer=a;class c{constructor(){this.messages=[],this.offset=0,this.consumers=[]}static createdQueuedMessage(e,t){return{topic:"topic",partition:0,offset:e,value:""}}createProducer(){return new a(this)}createConsumer(){const e=new o("test","test");return this.consumers.push(e),e}getRawMessages(){return this.messages}addMessage(e,t){const r=this.offset++,n=c.createdQueuedMessage(r);n.value=e,n.topic=t,this.messages.push(n);for(const e of this.consumers)e.emit(n)}getLastMessage(){return this.getMessage(this.messages.length-1)}getMessage(e){return this.messages[e].value}}t.TestKafka=c},rNX3:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LocalKafkaSubscription=void 0;const n=r("hBZP");t.LocalKafkaSubscription=class extends n.EventEmitter{constructor(e,t){super(),this.subscriber=e,this.queue=t,this.queueOffset=0,this.closed=!1,this.processing=!1}close(){this.closed=!0,this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=void 0),this.removeAllListeners()}async process(){if(this.queue.length<=this.queueOffset||this.processing||void 0!==this.retryTimer||this.closed)return;const e=this.queue.get(this.queueOffset);try{this.processing=!0;const t=this.subscriber.process(e);void 0!==t&&await t,this.queueOffset++,this.emit("processed",this.queueOffset)}catch(e){return this.subscriber.context.error(e,{restart:!1}),void(this.retryTimer=setTimeout((()=>{this.retryTimer=void 0,this.process()}),500))}finally{this.processing=!1}this.process()}}},rT4n:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EmptyTaskMessageSender=void 0,t.EmptyTaskMessageSender=class{async initialize(){}sendTask(e,t){}on(e,t){return this}async close(){}}},"s+HU":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LambdaSchemaValidator=t.BasePropertiesValidator=t.BaseLumberjackSchemaValidator=t.ThrottlingTelemetryProperties=t.SessionState=t.QueuedMessageProperties=t.LumberType=t.LogLevel=t.HttpProperties=t.handleError=t.getLumberBaseProperties=t.CommonProperties=t.BaseTelemetryProperties=t.TestSchemaValidator=t.TestLumberjack=t.TestEngine2=t.TestEngine1=t.Lumberjack=t.LumberEventName=t.Lumber=void 0;var n=r("ngQy");Object.defineProperty(t,"Lumber",{enumerable:!0,get:function(){return n.Lumber}});var i=r("yxQQ");Object.defineProperty(t,"LumberEventName",{enumerable:!0,get:function(){return i.LumberEventName}});var s=r("r+Vx");Object.defineProperty(t,"Lumberjack",{enumerable:!0,get:function(){return s.Lumberjack}});var o=r("5XVS");Object.defineProperty(t,"TestEngine1",{enumerable:!0,get:function(){return o.TestEngine1}}),Object.defineProperty(t,"TestEngine2",{enumerable:!0,get:function(){return o.TestEngine2}}),Object.defineProperty(t,"TestLumberjack",{enumerable:!0,get:function(){return o.TestLumberjack}}),Object.defineProperty(t,"TestSchemaValidator",{enumerable:!0,get:function(){return o.TestSchemaValidator}});var a=r("6Cdk");Object.defineProperty(t,"BaseTelemetryProperties",{enumerable:!0,get:function(){return a.BaseTelemetryProperties}}),Object.defineProperty(t,"CommonProperties",{enumerable:!0,get:function(){return a.CommonProperties}}),Object.defineProperty(t,"getLumberBaseProperties",{enumerable:!0,get:function(){return a.getLumberBaseProperties}}),Object.defineProperty(t,"handleError",{enumerable:!0,get:function(){return a.handleError}}),Object.defineProperty(t,"HttpProperties",{enumerable:!0,get:function(){return a.HttpProperties}}),Object.defineProperty(t,"LogLevel",{enumerable:!0,get:function(){return a.LogLevel}}),Object.defineProperty(t,"LumberType",{enumerable:!0,get:function(){return a.LumberType}}),Object.defineProperty(t,"QueuedMessageProperties",{enumerable:!0,get:function(){return a.QueuedMessageProperties}}),Object.defineProperty(t,"SessionState",{enumerable:!0,get:function(){return a.SessionState}}),Object.defineProperty(t,"ThrottlingTelemetryProperties",{enumerable:!0,get:function(){return a.ThrottlingTelemetryProperties}});var c=r("nazn");Object.defineProperty(t,"BaseLumberjackSchemaValidator",{enumerable:!0,get:function(){return c.BaseLumberjackSchemaValidator}}),Object.defineProperty(t,"BasePropertiesValidator",{enumerable:!0,get:function(){return c.BasePropertiesValidator}}),Object.defineProperty(t,"LambdaSchemaValidator",{enumerable:!0,get:function(){return c.LambdaSchemaValidator}})},sM4d:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestCache=void 0,t.TestCache=class{constructor(){this.map=new Map}async get(e){var t;return null!==(t=this.map.get(e))&&void 0!==t?t:""}async set(e,t){this.map.set(e,t)}async delete(e){return this.map.delete(e)}async incr(e){var t;let r=null!==(t=parseInt(this.map.get(e),10))&&void 0!==t?t:0;return r+=1,this.map.set(e,r.toString()),r}async decr(e){var t;let r=null!==(t=parseInt(this.map.get(e),10))&&void 0!==t?t:0;return r-=1,this.map.set(e,r.toString()),r}}},sx1J:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isRetryEnabled=void 0,t.isRetryEnabled=function(e){return!0===e.retryEnabled}},sx7D:function(e,t,r){"use strict";r.d(t,"a",(function(){return a}));var n=r("he5V"),i=r("Ls0c"),s=r("l4ds"),o=r("JGNH");class a{constructor(e){this.historian=e,this.blobCache=new Map,this.commitCache=new Map,this.treeCache=new Map,this.refCache=new Map}async getHeader(e,t){const r=await this.historian.getHeader(t);for(const e of r.blobs)this.blobCache.set(e.sha,e);return Object(i.e)(r.tree)}async getFullTree(e){return this.historian.getFullTree(e)}async getCommit(e){return this.commitCache.has(e)?(Object(o.a)(`Cache hit on ${e}`),this.commitCache.get(e)):this.historian.getCommit(e)}async getCommits(e,t){let r=e;if(this.refCache.has(e)&&(Object(o.a)(`Commit cache hit on ${e}`),r=this.refCache.get(e),this.refCache.delete(e),!r))return[];if(this.commitCache.has(r)){const e=this.commitCache.get(r);return[{commit:{author:e.author,committer:e.committer,message:e.message,tree:e.tree,url:e.url},parents:e.parents,sha:e.sha,url:e.url}]}return this.historian.getCommits(r,t)}async getTree(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this.treeCache.has(e)?(Object(o.a)(`Tree cache hit on ${e}`),this.treeCache.get(e)):this.historian.getTree(e,t)}async getBlob(e){return this.blobCache.has(e)?(Object(o.a)(`Blob cache hit on ${e}`),this.blobCache.get(e)):this.historian.getBlob(e)}getRawUrl(e){return`${this.historian.endpoint}/git/blobs/raw/${e}`}async getContent(e,t){return this.historian.getContent(t,e)}async createBlob(e,t){return this.historian.createBlob({content:e,encoding:t})}async createGitTree(e){return this.historian.createTree(e)}async createTree(e){return this.createTreeCore(e,0)}async createCommit(e){return this.historian.createCommit(e)}async createSummary(e){return this.historian.createSummary(e,arguments.length>1&&void 0!==arguments[1]&&arguments[1])}async deleteSummary(e){return this.historian.deleteSummary(e)}async getSummary(e){return this.historian.getSummary(e)}async getRef(e){return this.historian.getRef(`heads/${e}`).catch((e=>{if(400===e||404===e)return null;throw e}))}async createRef(e,t){return this.historian.createRef({ref:`refs/heads/${e}`,sha:t,config:{enabled:!0}})}async upsertRef(e,t){return this.historian.updateRef(`heads/${e}`,{force:!0,sha:t,config:{enabled:!0}})}addRef(e,t){this.refCache.set(e,t)}addCommit(e){this.commitCache.set(e.sha,e)}addTree(e){this.treeCache.set(e.sha,e)}addBlob(e){this.blobCache.set(e.sha,e)}async write(e,t,r,n){const i=await this.createTree(t),s={author:{date:(new Date).toISOString(),email:"kurtb@microsoft.com",name:"Kurt Berglund"},message:n,parents:r,tree:i.sha},o=await this.historian.createCommit(s),a=await this.getRef(e);return await(a?this.upsertRef(e,o.sha):this.createRef(e,o.sha)),o}async createTreeCore(e,t){if(e.id)return this.getTree(e.id);const r=[];for(const n of e.entries)switch(s.b[n.type]){case s.b.Blob:{const e=n.value;n.mode===s.a.Symlink&&(e.contents=this.translateSymlink(e.contents,t));const i=this.createBlob(e.contents,e.encoding);r.push(i);break}case s.b.Tree:{const e=this.createTreeCore(n.value,t+1);r.push(e);break}default:throw new Error("Unknown entry type")}const i=await Promise.all(r),o=[];Object(n.a)(i.length===e.entries.length,"File entries length is not correct");for(let t=0;t<e.entries.length;t++)o.push({mode:e.entries[t].mode,path:e.entries[t].path,sha:i[t].sha,type:e.entries[t].type===s.b.Tree?"tree":e.entries[t].type===s.b.Blob?"blob":"commit"});return this.historian.createTree({tree:o})}translateSymlink(e,t){let r="";for(let e=0;e<=t;e++)r+="../";return`${r}${e}`}}},tRAo:function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return i(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.TestDbFactory=t.TestDb=t.TestCollection=void 0;const o=r("hBZP"),a=s(r("9va6"));class c{constructor(e){this.collection=e}async aggregate(e,t){throw new Error("Method not implemented.")}async find(e,t){return this.findInternal(e,t)}async findAll(){return this.collection}async findOne(e){return this.findOneInternal(e)}async update(e,t,r){const n=this.findOneInternal(e);if(!n)return Promise.reject(new Error("Not found"));a.extend(n,t)}async updateMany(e,t,r){const n=this.findInternal(e);try{n.forEach((e=>{if(!e)throw new Error("Not found");a.extend(e,t)}))}catch(e){return Promise.reject(e)}}async upsert(e,t,r){const n=this.findOneInternal(e);n||this.collection.push(t),a.extend(n,t)}async insertOne(e){return null!==this.findOneInternal(e)?Promise.resolve("existing object"):this.insertOneInternal(e)}async findOrCreate(e,t){const r=this.findOneInternal(e);return r?{value:r,existing:!0}:{value:this.insertOneInternal(t),existing:!1}}async findAndUpdate(e,t){const r=this.findOneInternal(e);return r?(this.removeOneInternal(r),this.insertOneInternal(t),{value:r,existing:!0}):{value:r,existing:!1}}async insertMany(e,t){e.forEach((e=>{this.collection.push(e)}))}async deleteOne(e){const t=this.findOneInternal(e);return this.removeOneInternal(t),t}async deleteMany(e){const t=this.findInternal(e);return t.forEach((e=>{this.removeOneInternal(e)})),t}async distinct(e,t){throw new Error("Method not implemented.")}async createIndex(e,t){throw new Error("Method not implemented.")}insertOneInternal(e){return this.collection.push(e),e}removeOneInternal(e){const t=this.collection.indexOf(e);t>=0&&this.collection.splice(t,1)}findOneInternal(e){let t;return t=e._id?this.collection.find((t=>t._id===e._id)):this.findInternal(e)[0],void 0===t?null:t}findInternal(e,t){function r(e,t){const r=t.split(".");let n=e;return r.forEach((e=>{n=n[e]})),n}const n=Object.keys(e);let i=this.collection;return n.forEach((t=>{e[t]&&(e[t].$gt>0||e[t].$lt>0||e[t].$lte>0?(e[t].$gt>0&&(i=i.filter((n=>r(n,t)>e[t].$gt))),e[t].$lt>0&&(i=i.filter((n=>r(n,t)<e[t].$lt))),e[t].$lte>0&&(i=i.filter((n=>r(n,t)<=e[t].$lte)))):i=i.filter((n=>r(n,t)===e[t])))})),t&&1===Object.keys(t).length&&(i=i.sort((function(e,n){const i=Object.keys(t)[0];return 1===t[i]?r(e,i)-r(n,i):r(n,i)-r(e,i)}))),i}}t.TestCollection=c;class u{constructor(e){this.collections=e,this.emitter=new o.EventEmitter}async close(){}on(e,t){this.emitter.on(e,t)}collection(e){return e in this.collections||(this.collections[e]=[]),new c(this.collections[e])}async dropCollection(e){return!Object.prototype.hasOwnProperty.call(this.collections,e)||(delete this.collections[e],!0)}}t.TestDb=u,t.TestDbFactory=class{constructor(e){this.testDatabase=new u(e)}async connect(){return this.testDatabase}}},tXmR:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.clientConnectivityStorageId=t.signalUsageStorageId=void 0,t.signalUsageStorageId="signalUsage",t.clientConnectivityStorageId="clientConnectivityUsage"},tY1o:function(e,t,r){"use strict";(function(e,n){Object.defineProperty(t,"__esModule",{value:!0}),t.BroadcasterLambda=void 0;const i=r("y2M+"),s=r("MPeK");let o,a;"function"==typeof e?(o=e,a=n):(o=setTimeout,a=clearTimeout),t.BroadcasterLambda=class{constructor(e,t,r,n){this.publisher=e,this.context=t,this.serviceConfiguration=r,this.clientManager=n,this.pending=new Map,this.current=new Map}async handler(e){var t;const r=(0,s.extractBoxcar)(e);for(const e of r.contents){let r,n;switch(e.type){case s.SequencedOperationType:n="op",r=`${e.tenantId}/${e.documentId}`;break;case s.NackOperationType:n="nack",r=`client#${e.clientId}`;break;case s.SignalOperationType:{n="signal";const t=e;if(r=`${t.tenantId}/${t.documentId}`,this.clientManager&&t.operation){const e=JSON.parse(t.operation.content);switch("string"==typeof e.type?e.type:void 0){case i.MessageType.ClientJoin:{const r=e.content;await this.clientManager.addClient(t.tenantId,t.documentId,r.clientId,r.client,t.operation);break}case i.MessageType.ClientLeave:await this.clientManager.removeClient(t.tenantId,t.documentId,e.content,t.operation)}}break}default:continue}const o=e;o.type===s.SequencedOperationType&&(null===(t=o.operation)||void 0===t?void 0:t.traces)&&o.operation.traces.length>0&&o.operation.traces.push({action:"start",service:"broadcaster",timestamp:Date.now()}),this.serviceConfiguration.broadcaster.includeEventInMessageBatchName&&(r+=n);let a=this.pending.get(r);a?a.messages.push(o.operation):(a={tenantId:o.tenantId,documentId:o.documentId,event:n,messages:[o.operation]},this.pending.set(r,a))}this.pendingOffset=e,this.sendPending()}close(){this.pending.clear(),this.current.clear(),this.pendingOffset=void 0,void 0!==this.messageSendingTimerId&&(a(this.messageSendingTimerId),this.messageSendingTimerId=void 0)}hasPendingWork(){return 0!==this.pending.size||0!==this.current.size}sendPending(){void 0===this.messageSendingTimerId&&(0!==this.pending.size?this.messageSendingTimerId=o((async()=>{const e=this.pendingOffset;if(this.current=this.pending,this.pending=new Map,this.pendingOffset=void 0,this.publisher.emitBatch){const e=[];for(const[t,r]of this.current)e.push(this.publisher.emitBatch(t,r));try{await Promise.all(e)}catch(e){return void this.context.error(e,{restart:!0})}}else if(this.publisher.emit){const e=[];for(const[t,r]of this.current)e.push(this.publisher.emit(t,r.event,r.documentId,r.messages));try{await Promise.all(e)}catch(e){return void this.context.error(e,{restart:!0})}}else for(const[e,t]of this.current)this.publisher.to(e).emit(t.event,t.documentId,t.messages);this.messageSendingTimerId=void 0,this.context.checkpoint(e),this.current.clear(),this.sendPending()})):this.pendingOffset&&(this.context.checkpoint(this.pendingOffset),this.pendingOffset=void 0))}}}).call(this,r("oPUo").setImmediate,r("oPUo").clearImmediate)},thXI:function(e,t,r){(t=e.exports=function(e){e=e.toLowerCase();var r=t[e];if(!r)throw new Error(e+" is not supported (we accept pull requests)");return new r}).sha=r("jDN0"),t.sha1=r("HLui"),t.sha224=r("nWOd"),t.sha256=r("yD7y"),t.sha384=r("Y9G6"),t.sha512=r("2ozp")},"tp/L":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LambdaSchemaValidator=t.BasePropertiesValidator=t.BaseLumberjackSchemaValidator=t.ThrottlingTelemetryProperties=t.SessionState=t.QueuedMessageProperties=t.LumberType=t.LogLevel=t.HttpProperties=t.handleError=t.getLumberBaseProperties=t.CommonProperties=t.BaseTelemetryProperties=t.TestSchemaValidator=t.TestLumberjack=t.TestEngine2=t.TestEngine1=t.Lumberjack=t.LumberEventName=t.Lumber=void 0;var n=r("Q/BS");Object.defineProperty(t,"Lumber",{enumerable:!0,get:function(){return n.Lumber}});var i=r("dAzj");Object.defineProperty(t,"LumberEventName",{enumerable:!0,get:function(){return i.LumberEventName}});var s=r("d2TU");Object.defineProperty(t,"Lumberjack",{enumerable:!0,get:function(){return s.Lumberjack}});var o=r("46ZM");Object.defineProperty(t,"TestEngine1",{enumerable:!0,get:function(){return o.TestEngine1}}),Object.defineProperty(t,"TestEngine2",{enumerable:!0,get:function(){return o.TestEngine2}}),Object.defineProperty(t,"TestLumberjack",{enumerable:!0,get:function(){return o.TestLumberjack}}),Object.defineProperty(t,"TestSchemaValidator",{enumerable:!0,get:function(){return o.TestSchemaValidator}});var a=r("5gZq");Object.defineProperty(t,"BaseTelemetryProperties",{enumerable:!0,get:function(){return a.BaseTelemetryProperties}}),Object.defineProperty(t,"CommonProperties",{enumerable:!0,get:function(){return a.CommonProperties}}),Object.defineProperty(t,"getLumberBaseProperties",{enumerable:!0,get:function(){return a.getLumberBaseProperties}}),Object.defineProperty(t,"handleError",{enumerable:!0,get:function(){return a.handleError}}),Object.defineProperty(t,"HttpProperties",{enumerable:!0,get:function(){return a.HttpProperties}}),Object.defineProperty(t,"LogLevel",{enumerable:!0,get:function(){return a.LogLevel}}),Object.defineProperty(t,"LumberType",{enumerable:!0,get:function(){return a.LumberType}}),Object.defineProperty(t,"QueuedMessageProperties",{enumerable:!0,get:function(){return a.QueuedMessageProperties}}),Object.defineProperty(t,"SessionState",{enumerable:!0,get:function(){return a.SessionState}}),Object.defineProperty(t,"ThrottlingTelemetryProperties",{enumerable:!0,get:function(){return a.ThrottlingTelemetryProperties}});var c=r("zxJG");Object.defineProperty(t,"BaseLumberjackSchemaValidator",{enumerable:!0,get:function(){return c.BaseLumberjackSchemaValidator}}),Object.defineProperty(t,"BasePropertiesValidator",{enumerable:!0,get:function(){return c.BasePropertiesValidator}}),Object.defineProperty(t,"LambdaSchemaValidator",{enumerable:!0,get:function(){return c.LambdaSchemaValidator}})},tqCN:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestContext=void 0;const n=r("ZERR"),i=r("hBZP"),s=r("wWog"),o=r("s+HU"),a=r("irTb");t.TestContext=class extends i.EventEmitter{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:a.DebugLogger.create("fluid-server:TestContext");super(),this.log=e,this.offset=-1,this.waits=[];const t=new o.TestEngine1;o.Lumberjack.isSetupCompleted()||o.Lumberjack.setup([t])}checkpoint(e){(0,n.strict)(e.offset>this.offset,`${e.offset} > ${this.offset}`),this.offset=e.offset,this.waits=this.waits.filter((t=>!(t.value<=e.offset&&(t.deferred.resolve(),1))))}error(e,t){this.emit("error",e,t)}async waitForOffset(e){if(e<=this.offset)return;const t=new s.Deferred;return this.waits.push({deferred:t,value:e}),t.promise}getContextError(){}}},uYhO:function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LocalOrderManager=void 0;const i=n(r("ZERR"));t.LocalOrderManager=class{constructor(e,t){this.nodeFactory=e,this.reservationManager=t,this.localOrderers=new Map,this.createLocalNode()}async get(e,t){const r=this.getKey(e,t);let n=this.localOrderers.get(r);return n||(n=this.getCore(e,t),this.localOrderers.set(r,n)),n}async remove(e,t){const r=this.getKey(e,t),n=this.localOrderers.get(r);if(n){this.localOrderers.delete(r);const e=await n;await e.close()}}async getCore(e,t){const r=await this.localNodeP,n=this.getKey(e,t),s=await this.reservationManager.getOrReserve(n,r);return(0,i.default)(s.valid),await s.connectOrderer(e,t)}createLocalNode(){this.localNodeP=this.nodeFactory.create(),this.localNodeP.then((e=>{e.on("error",(e=>{}))}),(e=>{}))}getKey(e,t){return`${e}/${t}`}}},urMS:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.writeSummaryTree=t.TestDocumentStorage=void 0;const n=r("y2M+"),i=r("or3g"),s=r("wWog");async function o(e,t,r,c){const u=await Promise.all(Object.keys(t.tree).map((async u=>{const l=t.tree[u],h=await async function(e,t,r,i,c){switch(i.type){case n.SummaryType.Blob:return async function(e,t,r){const{parsedContent:n,encoding:i}="string"==typeof e?{parsedContent:e,encoding:"utf-8"}:{parsedContent:(0,s.Uint8ArrayToString)(e,"base64"),encoding:"base64"},o=await(0,s.gitHashFile)(s.IsoBuffer.from(n,i));if(!t.has(o)){const e=await r.createBlob(n,i);t.add(e.sha)}return o}(i.content,t,e);case n.SummaryType.Handle:if(void 0===c)throw Error("Parent summary does not exist to reference by handle.");return function(e,t,r){const n=t.split("/").map((e=>decodeURIComponent(e)));return""===n[0]&&n.shift(),a(e,n,r)}(i.handleType,i.handle,c);case n.SummaryType.Tree:return o(e,i,t,null==c?void 0:c.trees[r]);case n.SummaryType.Attachment:return i.id;default:throw Error("Unreachable case")}}(e,r,u,l,c);return{mode:(0,i.getGitMode)(l),path:encodeURIComponent(u),sha:h,type:(0,i.getGitType)(l)}})));return(await e.createGitTree({tree:u})).sha}function a(e,t,r){var i;const s=t[0];if(1===t.length)switch(e){case n.SummaryType.Blob:return r.blobs[s];case n.SummaryType.Tree:return null===(i=r.trees[s])||void 0===i?void 0:i.id;default:throw Error(`Unexpected handle summary object type: "${e}".`)}return a(e,t.slice(1),r)}t.TestDocumentStorage=class{constructor(e,t){this.databaseManager=e,this.tenantManager=t}async getDocument(e,t){return(await this.databaseManager.getDocumentCollection()).findOne({documentId:t,tenantId:e})}async getOrCreateDocument(e,t){return this.getOrCreateObject(e,t)}async createDocument(e,t,r,n,s,a,c,u,l,h){const d=await this.tenantManager.getTenantGitManager(e,t),m=new Set,p=await o(d,r,m,void 0),f=(0,i.getQuorumTreeEntries)(t,n,n,s,{members:[],proposals:[],values:h}),[g,y]=await Promise.all([d.createTree({entries:f}),d.getTree(p,!1)]),v=(0,i.mergeAppAndProtocolTree)(y,g),b=await d.createGitTree({tree:v}),S={author:{date:(new Date).toISOString(),email:"dummy@microsoft.com",name:"Routerlicious Service"},message:"New document",parents:[],tree:b.sha},w=await d.createCommit(S);await d.createRef(t,w.sha);const C={clients:void 0,durableSequenceNumber:n,expHash1:a,logOffset:-1,sequenceNumber:n,signalClientConnectionNumber:0,epoch:void 0,term:1,lastSentMSN:0,nackMessages:void 0,successfullyStartedLambdas:[],checkpointTimestamp:Date.now()},E={logOffset:-1,minimumSequenceNumber:n,protocolState:{members:[],minimumSequenceNumber:n,proposals:[],sequenceNumber:n,values:h},sequenceNumber:n,lastClientSummaryHead:void 0,lastSummarySequenceNumber:0,validParentSummaries:void 0},I=await this.databaseManager.getDocumentCollection(),T={ordererUrl:c,historianUrl:u,deltaStreamUrl:l,isSessionAlive:!0,isSessionActive:!0};return await I.findOrCreate({documentId:t,tenantId:e},{createTime:Date.now(),deli:JSON.stringify(C),documentId:t,session:T,scribe:JSON.stringify(E),tenantId:e,version:"0.1"})}async getLatestVersion(e,t){const r=await this.getVersions(e,t,1);if(!r.length)return null;const n=r[0];return{author:n.commit.author,committer:n.commit.committer,message:n.commit.message,parents:n.parents,sha:n.sha,tree:n.commit.tree,url:n.url}}async getVersions(e,t,r){return(await this.tenantManager.getTenantGitManager(e,t)).getCommits(t,r)}async getVersion(e,t,r){return(await this.tenantManager.getTenantGitManager(e,t)).getCommit(r)}async getFullTree(e,t){throw new Error("Method not implemented.")}async getOrCreateObject(e,t){const r=await this.databaseManager.getDocumentCollection();return await r.findOrCreate({documentId:t,tenantId:e},{createTime:Date.now(),deli:void 0,documentId:t,session:void 0,scribe:void 0,tenantId:e,version:"0.1"})}},t.writeSummaryTree=o},voNW:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestClientManager=void 0,t.TestClientManager=class{constructor(){this.clients=new Map}async addClient(e,t,r,n){this.clients.has(e)||this.clients.set(e,new Map),this.clients.get(e).has(t)||this.clients.get(e).set(t,new Map),this.clients.get(e).get(t).set(r,n)}async removeClient(e,t,r){this.clients.has(e)&&this.clients.get(e).has(t)&&this.clients.get(e).get(t).delete(r)}async getClients(e,t){const r=[];if(this.clients.has(e)&&this.clients.get(e).has(t))for(const[n,i]of this.clients.get(e).get(t))r.push({clientId:n,client:i});return r}async getSequencedClients(e,t){throw new Error("Not implemented")}async extendSequencedClients(e,t,r,n){throw new Error("Not implemented")}}},vuat:function(e,t){var r=["Black","White","Gray","Brown","Red","Pink","Crimson","Carnelian","Orange","Yellow","Ivory","Cream","Green","Viridian","Aquamarine","Cyan","Blue","Cerulean","Azure","Indigo","Navy","Violet","Purple","Lavender","Magenta","Rainbow","Iridescent","Spectrum","Prism","Bold","Vivid","Pale","Clear","Glass","Translucent","Misty","Dark","Light","Gold","Silver","Copper","Bronze","Steel","Iron","Brass","Mercury","Zinc","Chrome","Platinum","Titanium","Nickel","Lead","Pewter","Rust","Metal","Stone","Quartz","Granite","Marble","Alabaster","Agate","Jasper","Pebble","Pyrite","Crystal","Geode","Obsidian","Mica","Flint","Sand","Gravel","Boulder","Basalt","Ruby","Beryl","Scarlet","Citrine","Sulpher","Topaz","Amber","Emerald","Malachite","Jade","Abalone","Lapis","Sapphire","Diamond","Peridot","Gem","Jewel","Bevel","Coral","Jet","Ebony","Wood","Tree","Cherry","Maple","Cedar","Branch","Bramble","Rowan","Ash","Fir","Pine","Cactus","Alder","Grove","Forest","Jungle","Palm","Bush","Mulberry","Juniper","Vine","Ivy","Rose","Lily","Tulip","Daffodil","Honeysuckle","Fuschia","Hazel","Walnut","Almond","Lime","Lemon","Apple","Blossom","Bloom","Crocus","Rose","Buttercup","Dandelion","Iris","Carnation","Fern","Root","Branch","Leaf","Seed","Flower","Petal","Pollen","Orchid","Mangrove","Cypress","Sequoia","Sage","Heather","Snapdragon","Daisy","Mountain","Hill","Alpine","Chestnut","Valley","Glacier","Forest","Grove","Glen","Tree","Thorn","Stump","Desert","Canyon","Dune","Oasis","Mirage","Well","Spring","Meadow","Field","Prairie","Grass","Tundra","Island","Shore","Sand","Shell","Surf","Wave","Foam","Tide","Lake","River","Brook","Stream","Pool","Pond","Sun","Sprinkle","Shade","Shadow","Rain","Cloud","Storm","Hail","Snow","Sleet","Thunder","Lightning","Wind","Hurricane","Typhoon","Dawn","Sunrise","Morning","Noon","Twilight","Evening","Sunset","Midnight","Night","Sky","Star","Stellar","Comet","Nebula","Quasar","Solar","Lunar","Planet","Meteor","Sprout","Pear","Plum","Kiwi","Berry","Apricot","Peach","Mango","Pineapple","Coconut","Olive","Ginger","Root","Plain","Fancy","Stripe","Spot","Speckle","Spangle","Ring","Band","Blaze","Paint","Pinto","Shade","Tabby","Brindle","Patch","Calico","Checker","Dot","Pattern","Glitter","Glimmer","Shimmer","Dull","Dust","Dirt","Glaze","Scratch","Quick","Swift","Fast","Slow","Clever","Fire","Flicker","Flash","Spark","Ember","Coal","Flame","Chocolate","Vanilla","Sugar","Spice","Cake","Pie","Cookie","Candy","Caramel","Spiral","Round","Jelly","Square","Narrow","Long","Short","Small","Tiny","Big","Giant","Great","Atom","Peppermint","Mint","Butter","Fringe","Rag","Quilt","Truth","Lie","Holy","Curse","Noble","Sly","Brave","Shy","Lava","Foul","Leather","Fantasy","Keen","Luminous","Feather","Sticky","Gossamer","Cotton","Rattle","Silk","Satin","Cord","Denim","Flannel","Plaid","Wool","Linen","Silent","Flax","Weak","Valiant","Fierce","Gentle","Rhinestone","Splash","North","South","East","West","Summer","Winter","Autumn","Spring","Season","Equinox","Solstice","Paper","Motley","Torch","Ballistic","Rampant","Shag","Freckle","Wild","Free","Chain","Sheer","Crazy","Mad","Candle","Ribbon","Lace","Notch","Wax","Shine","Shallow","Deep","Bubble","Harvest","Fluff","Venom","Boom","Slash","Rune","Cold","Quill","Love","Hate","Garnet","Zircon","Power","Bone","Void","Horn","Glory","Cyber","Nova","Hot","Helix","Cosmic","Quark","Quiver","Holly","Clover","Polar","Regal","Ripple","Ebony","Wheat","Phantom","Dew","Chisel","Crack","Chatter","Laser","Foil","Tin","Clever","Treasure","Maze","Twisty","Curly","Fortune","Fate","Destiny","Cute","Slime","Ink","Disco","Plume","Time","Psychadelic","Relic","Fossil","Water","Savage","Ancient","Rapid","Road","Trail","Stitch","Button","Bow","Nimble","Zest","Sour","Bitter","Phase","Fan","Frill","Plump","Pickle","Mud","Puddle","Pond","River","Spring","Stream","Battle","Arrow","Plume","Roan","Pitch","Tar","Cat","Dog","Horse","Lizard","Bird","Fish","Saber","Scythe","Sharp","Soft","Razor","Neon","Dandy","Weed","Swamp","Marsh","Bog","Peat","Moor","Muck","Mire","Grave","Fair","Just","Brick","Puzzle","Skitter","Prong","Fork","Dent","Dour","Warp","Luck","Coffee","Split","Chip","Hollow","Heavy","Legend","Hickory","Mesquite","Nettle","Rogue","Charm","Prickle","Bead","Sponge","Whip","Bald","Frost","Fog","Oil","Veil","Cliff","Volcano","Rift","Maze","Proud","Dew","Mirror","Shard","Salt","Pepper","Honey","Thread","Bristle","Ripple","Glow","Zenith"],n=["head","crest","crown","tooth","fang","horn","frill","skull","bone","tongue","throat","voice","nose","snout","chin","eye","sight","seer","speaker","singer","song","chanter","howler","chatter","shrieker","shriek","jaw","bite","biter","neck","shoulder","fin","wing","arm","lifter","grasp","grabber","hand","paw","foot","finger","toe","thumb","talon","palm","touch","racer","runner","hoof","fly","flier","swoop","roar","hiss","hisser","snarl","dive","diver","rib","chest","back","ridge","leg","legs","tail","beak","walker","lasher","swisher","carver","kicker","roarer","crusher","spike","shaker","charger","hunter","weaver","crafter","binder","scribe","muse","snap","snapper","slayer","stalker","track","tracker","scar","scarer","fright","killer","death","doom","healer","saver","friend","foe","guardian","thunder","lightning","cloud","storm","forger","scale","hair","braid","nape","belly","thief","stealer","reaper","giver","taker","dancer","player","gambler","twister","turner","painter","dart","drifter","sting","stinger","venom","spur","ripper","swallow","devourer","knight","lady","lord","queen","king","master","mistress","prince","princess","duke","dutchess","samurai","ninja","knave","slave","servant","sage","wizard","witch","warlock","warrior","jester","paladin","bard","trader","sword","shield","knife","dagger","arrow","bow","fighter","bane","follower","leader","scourge","watcher","cat","panther","tiger","cougar","puma","jaguar","ocelot","lynx","lion","leopard","ferret","weasel","wolverine","bear","raccoon","dog","wolf","kitten","puppy","cub","fox","hound","terrier","coyote","hyena","jackal","pig","horse","donkey","stallion","mare","zebra","antelope","gazelle","deer","buffalo","bison","boar","elk","whale","dolphin","shark","fish","minnow","salmon","ray","fisher","otter","gull","duck","goose","crow","raven","bird","eagle","raptor","hawk","falcon","moose","heron","owl","stork","crane","sparrow","robin","parrot","cockatoo","carp","lizard","gecko","iguana","snake","python","viper","boa","condor","vulture","spider","fly","scorpion","heron","oriole","toucan","bee","wasp","hornet","rabbit","bunny","hare","brow","mustang","ox","piper","soarer","flasher","moth","mask","hide","hero","antler","chill","chiller","gem","ogre","myth","elf","fairy","pixie","dragon","griffin","unicorn","pegasus","sprite","fancier","chopper","slicer","skinner","butterfly","legend","wanderer","rover","raver","loon","lancer","glass","glazer","flame","crystal","lantern","lighter","cloak","bell","ringer","keeper","centaur","bolt","catcher","whimsey","quester","rat","mouse","serpent","wyrm","gargoyle","thorn","whip","rider","spirit","sentry","bat","beetle","burn","cowl","stone","gem","collar","mark","grin","scowl","spear","razor","edge","seeker","jay","ape","monkey","gorilla","koala","kangaroo","yak","sloth","ant","roach","weed","seed","eater","razor","shirt","face","goat","mind","shift","rider","face","mole","vole","pirate","llama","stag","bug","cap","boot","drop","hugger","sargent","snagglefoot","carpet","curtain"];function i(e){return e=e||Math.random,n[Math.floor(e()*n.length)]}function s(e){return e=e||Math.random,r[Math.floor(e()*r.length)]}e.exports=function(e){var t=i(e),r=i(e);return r=r.substr(0,1).toUpperCase()+r.substr(1),s(e)+t+" "+r},e.exports.randomNoun=i,e.exports.randomAdjective=s},wGlg:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConnectionCountLogger=void 0;const n=r("fhs9");t.ConnectionCountLogger=class{constructor(){let e=arguments.length>1?arguments[1]:void 0;this.nodeName=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"nodeName",this.cache=e,this.perClusterKeyName="totalConnections",this.perNodeKeyName=`totalConnections_${this.nodeName}`}incrementConnectionCount(){const e=n.Lumberjack.newLumberMetric(n.LumberEventName.ConnectionCountPerNode),t=n.Lumberjack.newLumberMetric(n.LumberEventName.TotalConnectionCount);if(!this.cache||!this.cache.incr)return e.error("Redis Cache not found."),void t.error("Redis Cache not found.");this.cache.incr(this.perNodeKeyName).then((t=>{e.setProperty("TotalConnectionCount",t),e.success("Connection count incremented for node.")}),(t=>{e.error("Error while incrementing connection count for node.",t)})),this.cache.incr(this.perClusterKeyName).then((e=>{t.setProperty("TotalConnectionCount",e),t.success("Total connection count incremented.")}),(e=>{t.error("Error while incrementing total connection count for cluster.",e)}))}decrementConnectionCount(){const e=n.Lumberjack.newLumberMetric(n.LumberEventName.ConnectionCountPerNode),t=n.Lumberjack.newLumberMetric(n.LumberEventName.TotalConnectionCount);if(!this.cache||!this.cache.decr)return e.error("Redis Cache not found."),void t.error("Redis Cache not found.");this.cache.decr(this.perNodeKeyName).then((t=>{e.setProperty("TotalConnectionCount",t),e.success("Connection count decremented for node.")}),(t=>{e.error("Error while decrementing connection count for node",t)})),this.cache.decr(this.perClusterKeyName).then((e=>{t.setProperty("TotalConnectionCount",e),t.success("Total connection count decremented.")}),(e=>{t.error("Error while decrementing total connection count for cluster.",e)}))}}},wWog:function(e,t,r){"use strict";r.r(t),r.d(t,"assert",(function(){return n.a})),r.d(t,"fromBase64ToUtf8",(function(){return i.a})),r.d(t,"fromUtf8ToBase64",(function(){return i.b})),r.d(t,"toUtf8",(function(){return i.c})),r.d(t,"Uint8ArrayToArrayBuffer",(function(){return s.a})),r.d(t,"delay",(function(){return o.a})),r.d(t,"doIfNotDisposed",(function(){return a.a})),r.d(t,"EventForwarder",(function(){return c.a})),r.d(t,"Heap",(function(){return l})),r.d(t,"NumberComparer",(function(){return u})),r.d(t,"bufferToString",(function(){return h.c})),r.d(t,"isArrayBuffer",(function(){return h.f})),r.d(t,"IsoBuffer",(function(){return h.a})),r.d(t,"stringToBuffer",(function(){return h.h})),r.d(t,"Uint8ArrayToString",(function(){return h.b})),r.d(t,"gitHashFile",(function(){return h.d})),r.d(t,"hashFile",(function(){return h.e})),r.d(t,"performance",(function(){return h.g})),r.d(t,"Lazy",(function(){return d.a})),r.d(t,"BaseTelemetryNullLogger",(function(){return m})),r.d(t,"TelemetryNullLogger",(function(){return p})),r.d(t,"PromiseCache",(function(){return f.a})),r.d(t,"Deferred",(function(){return g.a})),r.d(t,"LazyPromise",(function(){return g.b})),r.d(t,"RangeTracker",(function(){return b})),r.d(t,"RateLimiter",(function(){return S})),r.d(t,"safelyParseJSON",(function(){return w})),r.d(t,"PromiseTimer",(function(){return C.a})),r.d(t,"setLongTimeout",(function(){return C.c})),r.d(t,"Timer",(function(){return C.b})),r.d(t,"Trace",(function(){return E.a})),r.d(t,"TypedEventEmitter",(function(){return I.a})),r.d(t,"unreachableCase",(function(){return T.a}));var n=r("he5V"),i=r("nCVa"),s=r("cGWa"),o=r("gaGA"),a=r("9JcD"),c=r("+Ega");const u={compare:(e,t)=>e-t,min:Number.MIN_VALUE};class l{constructor(e){this.comp=e,this.L=[{value:e.min,position:0}]}peek(){return this.L[1]}get(){this.swap(1,this.count());const e=this.L.pop();return this.fixdown(1),e.value}add(e){const t={value:e,position:this.L.length};return this.L.push(t),this.fixup(this.count()),t}update(e){const t=e.position;this.isGreaterThanParent(t)?this.fixup(t):this.fixdown(t)}remove(e){const t=e.position;this.swap(e.position,this.L.length-1),this.L.splice(this.L.length-1),t!==this.L.length&&this.update(this.L[t])}count(){return this.L.length-1}fixup(e){let t=e;for(;this.isGreaterThanParent(t);){const e=t>>1;this.swap(t,e),t=e}}isGreaterThanParent(e){return e>1&&this.comp.compare(this.L[e>>1].value,this.L[e].value)>0}fixdown(e){let t=e;for(;t<<1<=this.count();){let e=t<<1;if(e<this.count()&&this.comp.compare(this.L[e].value,this.L[e+1].value)>0&&e++,this.comp.compare(this.L[t].value,this.L[e].value)<=0)break;this.swap(t,e),t=e}}swap(e,t){const r=this.L[e];this.L[e]=this.L[t],this.L[e].position=e,this.L[t]=r,this.L[t].position=t}}var h=r("kYaE"),d=r("O9x+");class m{send(e){}}class p{send(e){}sendTelemetryEvent(e,t){}sendErrorEvent(e,t){}sendPerformanceEvent(e,t){}}var f=r("+DV+"),g=r("NsUA"),y=r("yEOx"),v=r.n(y);class b{constructor(e,t){"number"==typeof e?(this.ranges=[{length:0,primary:e,secondary:t}],this.lastPrimary=e,this.lastSecondary=t):(this.ranges=v()(e.ranges),this.lastPrimary=e.lastPrimary,this.lastSecondary=e.lastSecondary)}get base(){return this.ranges[0].primary}get primaryHead(){return this.lastPrimary}get secondaryHead(){return this.lastSecondary}serialize(){return{lastPrimary:this.lastPrimary,lastSecondary:this.lastSecondary,ranges:v()(this.ranges)}}add(e,t){Object(n.a)(e>=this.lastPrimary,3),void 0!==this.lastSecondary&&Object(n.a)(t>=this.lastSecondary,4),this.lastPrimary=e,this.lastSecondary=t;const r=this.ranges[this.ranges.length-1],i=r.primary+r.length,s=r.secondary+r.length;t!==s&&(e===i?0===r.length?r.secondary=t:(r.length--,this.ranges.push({length:0,primary:e,secondary:t})):i+1===e&&s+1===t?r.length++:this.ranges.push({length:0,primary:e,secondary:t}))}get(e){Object(n.a)(e>=this.ranges[0].primary,5);let t=1;for(;t<this.ranges.length&&!(e<this.ranges[t].primary);t++);Object(n.a)(e>=this.ranges[t-1].primary,6);const r=this.ranges[t-1];return Math.min(e-r.primary,r.length)+r.secondary}updateBase(e){Object(n.a)(e>=this.ranges[0].primary,7);let t=1;for(;t<this.ranges.length&&!(e<this.ranges[t].primary);t++);Object(n.a)(e>=this.ranges[t-1].primary,8);const r=this.ranges[t-1],i=e-r.primary;r.secondary=r.secondary+Math.min(i,r.length),r.length=Math.max(r.length-i,0),r.primary=e,this.ranges=t-1>0?this.ranges.slice(t-1):this.ranges,Object(n.a)(e===this.ranges[0].primary,9)}}class S{constructor(e){this.windowMSec=e,this.requestMap=new Map}filter(e,t){const r=[],n=Date.now();for(const i of t){const t=`${e}/${i}`;if(this.requestMap.has(t)){if(this.requestMap.get(t)+this.windowMSec>n)continue;this.requestMap.set(t,n),r.push(i)}else this.requestMap.set(t,n),r.push(i)}return r}}function w(e){let t;try{t=JSON.parse(e)}catch(e){return}return t}var C=r("XxIN"),E=r("3/00"),I=r("NgDi"),T=r("7/yF")},wfEq:function(e,t){e.exports="function"==typeof Object.create?function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:function(e,t){if(t){e.super_=t;var r=function(){};r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e}}},wiRw:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BroadcasterLambdaFactory=void 0;const n=r("hBZP"),i=r("Gluk");t.BroadcasterLambdaFactory=class extends n.EventEmitter{constructor(e,t,r){super(),this.publisher=e,this.serviceConfiguration=t,this.clientManager=r,this.publisher.on("error",(e=>{this.emit("error",e)}))}async create(e,t){return new i.BroadcasterLambda(this.publisher,t,this.serviceConfiguration,this.clientManager)}async dispose(){await this.publisher.close()}}},wytm:function(e,t,r){(function(r){var n;t=e.exports=d,n="object"==typeof r&&r.env&&r.env.NODE_DEBUG&&/\bsemver\b/i.test(r.env.NODE_DEBUG)?function(){var e=Array.prototype.slice.call(arguments,0);e.unshift("SEMVER"),console.log.apply(console,e)}:function(){},t.SEMVER_SPEC_VERSION="2.0.0";var i=Number.MAX_SAFE_INTEGER||9007199254740991,s=t.re=[],o=t.src=[],a=t.tokens={},c=0;function u(e){a[e]=c++}u("NUMERICIDENTIFIER"),o[a.NUMERICIDENTIFIER]="0|[1-9]\\d*",u("NUMERICIDENTIFIERLOOSE"),o[a.NUMERICIDENTIFIERLOOSE]="[0-9]+",u("NONNUMERICIDENTIFIER"),o[a.NONNUMERICIDENTIFIER]="\\d*[a-zA-Z-][a-zA-Z0-9-]*",u("MAINVERSION"),o[a.MAINVERSION]="("+o[a.NUMERICIDENTIFIER]+")\\.("+o[a.NUMERICIDENTIFIER]+")\\.("+o[a.NUMERICIDENTIFIER]+")",u("MAINVERSIONLOOSE"),o[a.MAINVERSIONLOOSE]="("+o[a.NUMERICIDENTIFIERLOOSE]+")\\.("+o[a.NUMERICIDENTIFIERLOOSE]+")\\.("+o[a.NUMERICIDENTIFIERLOOSE]+")",u("PRERELEASEIDENTIFIER"),o[a.PRERELEASEIDENTIFIER]="(?:"+o[a.NUMERICIDENTIFIER]+"|"+o[a.NONNUMERICIDENTIFIER]+")",u("PRERELEASEIDENTIFIERLOOSE"),o[a.PRERELEASEIDENTIFIERLOOSE]="(?:"+o[a.NUMERICIDENTIFIERLOOSE]+"|"+o[a.NONNUMERICIDENTIFIER]+")",u("PRERELEASE"),o[a.PRERELEASE]="(?:-("+o[a.PRERELEASEIDENTIFIER]+"(?:\\."+o[a.PRERELEASEIDENTIFIER]+")*))",u("PRERELEASELOOSE"),o[a.PRERELEASELOOSE]="(?:-?("+o[a.PRERELEASEIDENTIFIERLOOSE]+"(?:\\."+o[a.PRERELEASEIDENTIFIERLOOSE]+")*))",u("BUILDIDENTIFIER"),o[a.BUILDIDENTIFIER]="[0-9A-Za-z-]+",u("BUILD"),o[a.BUILD]="(?:\\+("+o[a.BUILDIDENTIFIER]+"(?:\\."+o[a.BUILDIDENTIFIER]+")*))",u("FULL"),u("FULLPLAIN"),o[a.FULLPLAIN]="v?"+o[a.MAINVERSION]+o[a.PRERELEASE]+"?"+o[a.BUILD]+"?",o[a.FULL]="^"+o[a.FULLPLAIN]+"$",u("LOOSEPLAIN"),o[a.LOOSEPLAIN]="[v=\\s]*"+o[a.MAINVERSIONLOOSE]+o[a.PRERELEASELOOSE]+"?"+o[a.BUILD]+"?",u("LOOSE"),o[a.LOOSE]="^"+o[a.LOOSEPLAIN]+"$",u("GTLT"),o[a.GTLT]="((?:<|>)?=?)",u("XRANGEIDENTIFIERLOOSE"),o[a.XRANGEIDENTIFIERLOOSE]=o[a.NUMERICIDENTIFIERLOOSE]+"|x|X|\\*",u("XRANGEIDENTIFIER"),o[a.XRANGEIDENTIFIER]=o[a.NUMERICIDENTIFIER]+"|x|X|\\*",u("XRANGEPLAIN"),o[a.XRANGEPLAIN]="[v=\\s]*("+o[a.XRANGEIDENTIFIER]+")(?:\\.("+o[a.XRANGEIDENTIFIER]+")(?:\\.("+o[a.XRANGEIDENTIFIER]+")(?:"+o[a.PRERELEASE]+")?"+o[a.BUILD]+"?)?)?",u("XRANGEPLAINLOOSE"),o[a.XRANGEPLAINLOOSE]="[v=\\s]*("+o[a.XRANGEIDENTIFIERLOOSE]+")(?:\\.("+o[a.XRANGEIDENTIFIERLOOSE]+")(?:\\.("+o[a.XRANGEIDENTIFIERLOOSE]+")(?:"+o[a.PRERELEASELOOSE]+")?"+o[a.BUILD]+"?)?)?",u("XRANGE"),o[a.XRANGE]="^"+o[a.GTLT]+"\\s*"+o[a.XRANGEPLAIN]+"$",u("XRANGELOOSE"),o[a.XRANGELOOSE]="^"+o[a.GTLT]+"\\s*"+o[a.XRANGEPLAINLOOSE]+"$",u("COERCE"),o[a.COERCE]="(^|[^\\d])(\\d{1,16})(?:\\.(\\d{1,16}))?(?:\\.(\\d{1,16}))?(?:$|[^\\d])",u("COERCERTL"),s[a.COERCERTL]=new RegExp(o[a.COERCE],"g"),u("LONETILDE"),o[a.LONETILDE]="(?:~>?)",u("TILDETRIM"),o[a.TILDETRIM]="(\\s*)"+o[a.LONETILDE]+"\\s+",s[a.TILDETRIM]=new RegExp(o[a.TILDETRIM],"g"),u("TILDE"),o[a.TILDE]="^"+o[a.LONETILDE]+o[a.XRANGEPLAIN]+"$",u("TILDELOOSE"),o[a.TILDELOOSE]="^"+o[a.LONETILDE]+o[a.XRANGEPLAINLOOSE]+"$",u("LONECARET"),o[a.LONECARET]="(?:\\^)",u("CARETTRIM"),o[a.CARETTRIM]="(\\s*)"+o[a.LONECARET]+"\\s+",s[a.CARETTRIM]=new RegExp(o[a.CARETTRIM],"g"),u("CARET"),o[a.CARET]="^"+o[a.LONECARET]+o[a.XRANGEPLAIN]+"$",u("CARETLOOSE"),o[a.CARETLOOSE]="^"+o[a.LONECARET]+o[a.XRANGEPLAINLOOSE]+"$",u("COMPARATORLOOSE"),o[a.COMPARATORLOOSE]="^"+o[a.GTLT]+"\\s*("+o[a.LOOSEPLAIN]+")$|^$",u("COMPARATOR"),o[a.COMPARATOR]="^"+o[a.GTLT]+"\\s*("+o[a.FULLPLAIN]+")$|^$",u("COMPARATORTRIM"),o[a.COMPARATORTRIM]="(\\s*)"+o[a.GTLT]+"\\s*("+o[a.LOOSEPLAIN]+"|"+o[a.XRANGEPLAIN]+")",s[a.COMPARATORTRIM]=new RegExp(o[a.COMPARATORTRIM],"g"),u("HYPHENRANGE"),o[a.HYPHENRANGE]="^\\s*("+o[a.XRANGEPLAIN]+")\\s+-\\s+("+o[a.XRANGEPLAIN]+")\\s*$",u("HYPHENRANGELOOSE"),o[a.HYPHENRANGELOOSE]="^\\s*("+o[a.XRANGEPLAINLOOSE]+")\\s+-\\s+("+o[a.XRANGEPLAINLOOSE]+")\\s*$",u("STAR"),o[a.STAR]="(<|>)?=?\\s*\\*";for(var l=0;l<c;l++)n(l,o[l]),s[l]||(s[l]=new RegExp(o[l]));function h(e,t){if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),e instanceof d)return e;if("string"!=typeof e)return null;if(e.length>256)return null;if(!(t.loose?s[a.LOOSE]:s[a.FULL]).test(e))return null;try{return new d(e,t)}catch(e){return null}}function d(e,t){if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),e instanceof d){if(e.loose===t.loose)return e;e=e.version}else if("string"!=typeof e)throw new TypeError("Invalid Version: "+e);if(e.length>256)throw new TypeError("version is longer than 256 characters");if(!(this instanceof d))return new d(e,t);n("SemVer",e,t),this.options=t,this.loose=!!t.loose;var r=e.trim().match(t.loose?s[a.LOOSE]:s[a.FULL]);if(!r)throw new TypeError("Invalid Version: "+e);if(this.raw=e,this.major=+r[1],this.minor=+r[2],this.patch=+r[3],this.major>i||this.major<0)throw new TypeError("Invalid major version");if(this.minor>i||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>i||this.patch<0)throw new TypeError("Invalid patch version");this.prerelease=r[4]?r[4].split(".").map((function(e){if(/^[0-9]+$/.test(e)){var t=+e;if(t>=0&&t<i)return t}return e})):[],this.build=r[5]?r[5].split("."):[],this.format()}t.parse=h,t.valid=function(e,t){var r=h(e,t);return r?r.version:null},t.clean=function(e,t){var r=h(e.trim().replace(/^[=v]+/,""),t);return r?r.version:null},t.SemVer=d,d.prototype.format=function(){return this.version=this.major+"."+this.minor+"."+this.patch,this.prerelease.length&&(this.version+="-"+this.prerelease.join(".")),this.version},d.prototype.toString=function(){return this.version},d.prototype.compare=function(e){return n("SemVer.compare",this.version,this.options,e),e instanceof d||(e=new d(e,this.options)),this.compareMain(e)||this.comparePre(e)},d.prototype.compareMain=function(e){return e instanceof d||(e=new d(e,this.options)),p(this.major,e.major)||p(this.minor,e.minor)||p(this.patch,e.patch)},d.prototype.comparePre=function(e){if(e instanceof d||(e=new d(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;var t=0;do{var r=this.prerelease[t],i=e.prerelease[t];if(n("prerelease compare",t,r,i),void 0===r&&void 0===i)return 0;if(void 0===i)return 1;if(void 0===r)return-1;if(r!==i)return p(r,i)}while(++t)},d.prototype.compareBuild=function(e){e instanceof d||(e=new d(e,this.options));var t=0;do{var r=this.build[t],i=e.build[t];if(n("prerelease compare",t,r,i),void 0===r&&void 0===i)return 0;if(void 0===i)return 1;if(void 0===r)return-1;if(r!==i)return p(r,i)}while(++t)},d.prototype.inc=function(e,t){switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t),this.inc("pre",t);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",t),this.inc("pre",t);break;case"major":0===this.minor&&0===this.patch&&0!==this.prerelease.length||this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":0===this.patch&&0!==this.prerelease.length||this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":if(0===this.prerelease.length)this.prerelease=[0];else{for(var r=this.prerelease.length;--r>=0;)"number"==typeof this.prerelease[r]&&(this.prerelease[r]++,r=-2);-1===r&&this.prerelease.push(0)}t&&(this.prerelease[0]===t?isNaN(this.prerelease[1])&&(this.prerelease=[t,0]):this.prerelease=[t,0]);break;default:throw new Error("invalid increment argument: "+e)}return this.format(),this.raw=this.version,this},t.inc=function(e,t,r,n){"string"==typeof r&&(n=r,r=void 0);try{return new d(e,r).inc(t,n).version}catch(e){return null}},t.diff=function(e,t){if(v(e,t))return null;var r=h(e),n=h(t),i="";if(r.prerelease.length||n.prerelease.length){i="pre";var s="prerelease"}for(var o in r)if(("major"===o||"minor"===o||"patch"===o)&&r[o]!==n[o])return i+o;return s},t.compareIdentifiers=p;var m=/^[0-9]+$/;function p(e,t){var r=m.test(e),n=m.test(t);return r&&n&&(e=+e,t=+t),e===t?0:r&&!n?-1:n&&!r?1:e<t?-1:1}function f(e,t,r){return new d(e,r).compare(new d(t,r))}function g(e,t,r){return f(e,t,r)>0}function y(e,t,r){return f(e,t,r)<0}function v(e,t,r){return 0===f(e,t,r)}function b(e,t,r){return 0!==f(e,t,r)}function S(e,t,r){return f(e,t,r)>=0}function w(e,t,r){return f(e,t,r)<=0}function C(e,t,r,n){switch(t){case"===":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e===r;case"!==":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e!==r;case"":case"=":case"==":return v(e,r,n);case"!=":return b(e,r,n);case">":return g(e,r,n);case">=":return S(e,r,n);case"<":return y(e,r,n);case"<=":return w(e,r,n);default:throw new TypeError("Invalid operator: "+t)}}function E(e,t){if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),e instanceof E){if(e.loose===!!t.loose)return e;e=e.value}if(!(this instanceof E))return new E(e,t);n("comparator",e,t),this.options=t,this.loose=!!t.loose,this.parse(e),this.value=this.semver===I?"":this.operator+this.semver.version,n("comp",this)}t.rcompareIdentifiers=function(e,t){return p(t,e)},t.major=function(e,t){return new d(e,t).major},t.minor=function(e,t){return new d(e,t).minor},t.patch=function(e,t){return new d(e,t).patch},t.compare=f,t.compareLoose=function(e,t){return f(e,t,!0)},t.compareBuild=function(e,t,r){var n=new d(e,r),i=new d(t,r);return n.compare(i)||n.compareBuild(i)},t.rcompare=function(e,t,r){return f(t,e,r)},t.sort=function(e,r){return e.sort((function(e,n){return t.compareBuild(e,n,r)}))},t.rsort=function(e,r){return e.sort((function(e,n){return t.compareBuild(n,e,r)}))},t.gt=g,t.lt=y,t.eq=v,t.neq=b,t.gte=S,t.lte=w,t.cmp=C,t.Comparator=E;var I={};function T(e,t){if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),e instanceof T)return e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease?e:new T(e.raw,t);if(e instanceof E)return new T(e.value,t);if(!(this instanceof T))return new T(e,t);if(this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease,this.raw=e,this.set=e.split(/\s*\|\|\s*/).map((function(e){return this.parseRange(e.trim())}),this).filter((function(e){return e.length})),!this.set.length)throw new TypeError("Invalid SemVer Range: "+e);this.format()}function N(e,t){for(var r=!0,n=e.slice(),i=n.pop();r&&n.length;)r=n.every((function(e){return i.intersects(e,t)})),i=n.pop();return r}function P(e){return!e||"x"===e.toLowerCase()||"*"===e}function x(e,t,r,n,i,s,o,a,c,u,l,h,d){return((t=P(r)?"":P(n)?">="+r+".0.0":P(i)?">="+r+"."+n+".0":">="+t)+" "+(a=P(c)?"":P(u)?"<"+(+c+1)+".0.0":P(l)?"<"+c+"."+(+u+1)+".0":h?"<="+c+"."+u+"."+l+"-"+h:"<="+a)).trim()}function O(e,t,r){for(var i=0;i<e.length;i++)if(!e[i].test(t))return!1;if(t.prerelease.length&&!r.includePrerelease){for(i=0;i<e.length;i++)if(n(e[i].semver),e[i].semver!==I&&e[i].semver.prerelease.length>0){var s=e[i].semver;if(s.major===t.major&&s.minor===t.minor&&s.patch===t.patch)return!0}return!1}return!0}function M(e,t,r){try{t=new T(t,r)}catch(e){return!1}return t.test(e)}function k(e,t,r,n){var i,s,o,a,c;switch(e=new d(e,n),t=new T(t,n),r){case">":i=g,s=w,o=y,a=">",c=">=";break;case"<":i=y,s=S,o=g,a="<",c="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(M(e,t,n))return!1;for(var u=0;u<t.set.length;++u){var l=null,h=null;if(t.set[u].forEach((function(e){e.semver===I&&(e=new E(">=0.0.0")),h=h||e,i(e.semver,(l=l||e).semver,n)?l=e:o(e.semver,h.semver,n)&&(h=e)})),l.operator===a||l.operator===c)return!1;if((!h.operator||h.operator===a)&&s(e,h.semver))return!1;if(h.operator===c&&o(e,h.semver))return!1}return!0}E.prototype.parse=function(e){var t=e.match(this.options.loose?s[a.COMPARATORLOOSE]:s[a.COMPARATOR]);if(!t)throw new TypeError("Invalid comparator: "+e);this.operator=void 0!==t[1]?t[1]:"","="===this.operator&&(this.operator=""),this.semver=t[2]?new d(t[2],this.options.loose):I},E.prototype.toString=function(){return this.value},E.prototype.test=function(e){if(n("Comparator.test",e,this.options.loose),this.semver===I||e===I)return!0;if("string"==typeof e)try{e=new d(e,this.options)}catch(e){return!1}return C(e,this.operator,this.semver,this.options)},E.prototype.intersects=function(e,t){if(!(e instanceof E))throw new TypeError("a Comparator is required");var r;if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),""===this.operator)return""===this.value||(r=new T(e.value,t),M(this.value,r,t));if(""===e.operator)return""===e.value||(r=new T(this.value,t),M(e.semver,r,t));var n=!(">="!==this.operator&&">"!==this.operator||">="!==e.operator&&">"!==e.operator),i=!("<="!==this.operator&&"<"!==this.operator||"<="!==e.operator&&"<"!==e.operator),s=this.semver.version===e.semver.version,o=!(">="!==this.operator&&"<="!==this.operator||">="!==e.operator&&"<="!==e.operator),a=C(this.semver,"<",e.semver,t)&&(">="===this.operator||">"===this.operator)&&("<="===e.operator||"<"===e.operator),c=C(this.semver,">",e.semver,t)&&("<="===this.operator||"<"===this.operator)&&(">="===e.operator||">"===e.operator);return n||i||s&&o||a||c},t.Range=T,T.prototype.format=function(){return this.range=this.set.map((function(e){return e.join(" ").trim()})).join("||").trim(),this.range},T.prototype.toString=function(){return this.range},T.prototype.parseRange=function(e){var t=this.options.loose;e=(e=e.trim()).replace(t?s[a.HYPHENRANGELOOSE]:s[a.HYPHENRANGE],x),n("hyphen replace",e),e=e.replace(s[a.COMPARATORTRIM],"$1$2$3"),n("comparator trim",e,s[a.COMPARATORTRIM]),e=(e=(e=e.replace(s[a.TILDETRIM],"$1~")).replace(s[a.CARETTRIM],"$1^")).split(/\s+/).join(" ");var r=t?s[a.COMPARATORLOOSE]:s[a.COMPARATOR],i=e.split(" ").map((function(e){return function(e,t){return n("comp",e,t),e=function(e,t){return e.trim().split(/\s+/).map((function(e){return function(e,t){return n("caret",e,t),e.replace(t.loose?s[a.CARETLOOSE]:s[a.CARET],(function(t,r,i,s,o){var a;return n("caret",e,t,r,i,s,o),P(r)?a="":P(i)?a=">="+r+".0.0 <"+(+r+1)+".0.0":P(s)?a="0"===r?">="+r+"."+i+".0 <"+r+"."+(+i+1)+".0":">="+r+"."+i+".0 <"+(+r+1)+".0.0":o?(n("replaceCaret pr",o),a="0"===r?"0"===i?">="+r+"."+i+"."+s+"-"+o+" <"+r+"."+i+"."+(+s+1):">="+r+"."+i+"."+s+"-"+o+" <"+r+"."+(+i+1)+".0":">="+r+"."+i+"."+s+"-"+o+" <"+(+r+1)+".0.0"):(n("no pr"),a="0"===r?"0"===i?">="+r+"."+i+"."+s+" <"+r+"."+i+"."+(+s+1):">="+r+"."+i+"."+s+" <"+r+"."+(+i+1)+".0":">="+r+"."+i+"."+s+" <"+(+r+1)+".0.0"),n("caret return",a),a}))}(e,t)})).join(" ")}(e,t),n("caret",e),e=function(e,t){return e.trim().split(/\s+/).map((function(e){return function(e,t){return e.replace(t.loose?s[a.TILDELOOSE]:s[a.TILDE],(function(t,r,i,s,o){var a;return n("tilde",e,t,r,i,s,o),P(r)?a="":P(i)?a=">="+r+".0.0 <"+(+r+1)+".0.0":P(s)?a=">="+r+"."+i+".0 <"+r+"."+(+i+1)+".0":o?(n("replaceTilde pr",o),a=">="+r+"."+i+"."+s+"-"+o+" <"+r+"."+(+i+1)+".0"):a=">="+r+"."+i+"."+s+" <"+r+"."+(+i+1)+".0",n("tilde return",a),a}))}(e,t)})).join(" ")}(e,t),n("tildes",e),e=function(e,t){return n("replaceXRanges",e,t),e.split(/\s+/).map((function(e){return function(e,t){return(e=e.trim()).replace(t.loose?s[a.XRANGELOOSE]:s[a.XRANGE],(function(r,i,s,o,a,c){n("xRange",e,r,i,s,o,a,c);var u=P(s),l=u||P(o),h=l||P(a);return"="===i&&h&&(i=""),c=t.includePrerelease?"-0":"",u?r=">"===i||"<"===i?"<0.0.0-0":"*":i&&h?(l&&(o=0),a=0,">"===i?(i=">=",l?(s=+s+1,o=0,a=0):(o=+o+1,a=0)):"<="===i&&(i="<",l?s=+s+1:o=+o+1),r=i+s+"."+o+"."+a+c):l?r=">="+s+".0.0"+c+" <"+(+s+1)+".0.0"+c:h&&(r=">="+s+"."+o+".0"+c+" <"+s+"."+(+o+1)+".0"+c),n("xRange return",r),r}))}(e,t)})).join(" ")}(e,t),n("xrange",e),e=function(e,t){return n("replaceStars",e,t),e.trim().replace(s[a.STAR],"")}(e,t),n("stars",e),e}(e,this.options)}),this).join(" ").split(/\s+/);return this.options.loose&&(i=i.filter((function(e){return!!e.match(r)}))),i.map((function(e){return new E(e,this.options)}),this)},T.prototype.intersects=function(e,t){if(!(e instanceof T))throw new TypeError("a Range is required");return this.set.some((function(r){return N(r,t)&&e.set.some((function(e){return N(e,t)&&r.every((function(r){return e.every((function(e){return r.intersects(e,t)}))}))}))}))},t.toComparators=function(e,t){return new T(e,t).set.map((function(e){return e.map((function(e){return e.value})).join(" ").trim().split(" ")}))},T.prototype.test=function(e){if(!e)return!1;if("string"==typeof e)try{e=new d(e,this.options)}catch(e){return!1}for(var t=0;t<this.set.length;t++)if(O(this.set[t],e,this.options))return!0;return!1},t.satisfies=M,t.maxSatisfying=function(e,t,r){var n=null,i=null;try{var s=new T(t,r)}catch(e){return null}return e.forEach((function(e){s.test(e)&&(n&&-1!==i.compare(e)||(i=new d(n=e,r)))})),n},t.minSatisfying=function(e,t,r){var n=null,i=null;try{var s=new T(t,r)}catch(e){return null}return e.forEach((function(e){s.test(e)&&(n&&1!==i.compare(e)||(i=new d(n=e,r)))})),n},t.minVersion=function(e,t){e=new T(e,t);var r=new d("0.0.0");if(e.test(r))return r;if(r=new d("0.0.0-0"),e.test(r))return r;r=null;for(var n=0;n<e.set.length;++n)e.set[n].forEach((function(e){var t=new d(e.semver.version);switch(e.operator){case">":0===t.prerelease.length?t.patch++:t.prerelease.push(0),t.raw=t.format();case"":case">=":r&&!g(r,t)||(r=t);break;case"<":case"<=":break;default:throw new Error("Unexpected operation: "+e.operator)}}));return r&&e.test(r)?r:null},t.validRange=function(e,t){try{return new T(e,t).range||"*"}catch(e){return null}},t.ltr=function(e,t,r){return k(e,t,"<",r)},t.gtr=function(e,t,r){return k(e,t,">",r)},t.outside=k,t.prerelease=function(e,t){var r=h(e,t);return r&&r.prerelease.length?r.prerelease:null},t.intersects=function(e,t,r){return e=new T(e,r),t=new T(t,r),e.intersects(t)},t.coerce=function(e,t){if(e instanceof d)return e;if("number"==typeof e&&(e=String(e)),"string"!=typeof e)return null;var r=null;if((t=t||{}).rtl){for(var n;(n=s[a.COERCERTL].exec(e))&&(!r||r.index+r[0].length!==e.length);)r&&n.index+n[0].length===r.index+r[0].length||(r=n),s[a.COERCERTL].lastIndex=n.index+n[1].length+n[2].length;s[a.COERCERTL].lastIndex=-1}else r=e.match(s[a.COERCE]);return null===r?null:h(r[2]+"."+(r[3]||"0")+"."+(r[4]||"0"),t)}}).call(this,r("5IsQ"))},x4EH:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScribeLambdaFactory=void 0;const n=r("hBZP"),i=r("4+3C"),s=r("yQiv"),o=r("y2M+"),a=r("fhs9"),c=r("KMXR"),u=r("k7It"),l=r("Xo3u"),h=r("d6tz"),d=r("G9Py"),m=r("pJ2M"),p=r("mktj"),f={lastClientSummaryHead:void 0,logOffset:-1,minimumSequenceNumber:0,protocolState:{members:[],minimumSequenceNumber:0,proposals:[],sequenceNumber:0,values:[]},sequenceNumber:0,lastSummarySequenceNumber:0,validParentSummaries:void 0};t.ScribeLambdaFactory=class extends n.EventEmitter{constructor(e,t,r,n,i,s,o,a,c){super(),this.mongoManager=e,this.documentRepository=t,this.messageCollection=r,this.producer=n,this.deltaManager=i,this.tenantManager=s,this.serviceConfiguration=o,this.enableWholeSummaryUpload=a,this.getDeltasViaAlfred=c}async create(e,t){var r,n,o,g,y,v,b;let S,w,C,E,I,T=[];const{tenantId:N,documentId:P}=e,x={documentId:P,tenantId:N},O=(0,c.createSessionMetric)(N,P,a.LumberEventName.ScribeSessionResult,this.serviceConfiguration);try{if(S=await this.documentRepository.readOne({documentId:P,tenantId:N}),!(0,c.isDocumentValid)(S)){const e="Received attempt to connect to a missing/deleted document.";return null===(r=t.log)||void 0===r||r.error(e,{messageMetaData:x}),a.Lumberjack.error(e,(0,a.getLumberBaseProperties)(P,N)),new c.NoOpLambda(t)}if(!(0,c.isDocumentSessionValid)(S,this.serviceConfiguration)){const e=`Received attempt to connect to invalid session: ${JSON.stringify(S.session)}`;if(null===(n=t.log)||void 0===n||n.error(e,{messageMetaData:x}),a.Lumberjack.error(e,(0,a.getLumberBaseProperties)(P,N)),this.serviceConfiguration.enforceDiscoveryFlow)return new c.NoOpLambda(t)}w=await this.tenantManager.getTenantGitManager(N,P),E=new h.SummaryReader(N,P,w,this.enableWholeSummaryUpload),I=await E.readLastSummary()}catch(e){const r="Scribe lambda creation failed.";throw null===(o=t.log)||void 0===o||o.error(`${r} Exception: ${(0,i.inspect)(e)}`,{messageMetaData:x}),a.Lumberjack.error(r,(0,a.getLumberBaseProperties)(P,N),e),await this.sendLambdaStartResult(N,P,{lambdaName:s.LambdaName.Scribe,success:!1}),null==O||O.error("Scribe lambda creation failed",e),e}if(null==S.scribe){const e="New document. Setting empty scribe checkpoint";null===(g=t.log)||void 0===g||g.info(e,{messageMetaData:x}),a.Lumberjack.info(e,(0,a.getLumberBaseProperties)(P,N)),C=f}else if(""===S.scribe){const e="Existing document. Fetching checkpoint from summary";if(null===(y=t.log)||void 0===y||y.info(e,{messageMetaData:x}),a.Lumberjack.info(e,(0,a.getLumberBaseProperties)(P,N)),I.fromSummary){C=JSON.parse(I.scribe),T=I.messages,C.logOffset=-1;const e=`Restoring checkpoint from latest summary. Seq number: ${C.sequenceNumber}`;null===(b=t.log)||void 0===b||b.info(e,{messageMetaData:x}),a.Lumberjack.info(e,(0,a.getLumberBaseProperties)(P,N))}else null===(v=t.log)||void 0===v||v.error("Summary can't be fetched",{messageMetaData:x}),a.Lumberjack.error("Summary can't be fetched",(0,a.getLumberBaseProperties)(P,N)),C=f}else{C=JSON.parse(S.scribe);const e=Object.assign(Object.assign({},(0,a.getLumberBaseProperties)(P,N)),{lastCheckpointSeqNo:C.sequenceNumber,logOffset:C.logOffset,LastCheckpointProtocolSeqNo:C.protocolState.sequenceNumber});a.Lumberjack.info("Restoring checkpoint from db",e),this.getDeltasViaAlfred?-1!==C.logOffset&&(T=await this.deltaManager.getDeltas("",N,P,C.protocolState.sequenceNumber)):T=(await this.messageCollection.find({documentId:P,tenantId:N},{"operation.sequenceNumber":1})).map((e=>e.operation))}const M=T.filter((e=>e.sequenceNumber>C.protocolState.sequenceNumber));let k=C.protocolState.sequenceNumber+1;for(const e of M){if(e.sequenceNumber!==k){const t=new Error(`Invalid message sequence from checkpoint/summary.Current message @${e.sequenceNumber}.Expected message @${k}`);throw null==O||O.error("Invalid message sequence from checkpoint/summary",t),await this.sendLambdaStartResult(N,P,{lambdaName:s.LambdaName.Scribe,success:!1}),t}++k}const L=(0,m.initializeProtocol)(C.protocolState,I.term),R=new d.SummaryWriter(N,P,w,this.deltaManager,this.messageCollection,this.enableWholeSummaryUpload,I.messages,this.getDeltasViaAlfred),D=new u.CheckpointManager(t,N,P,this.documentRepository,this.messageCollection,this.deltaManager,this.getDeltasViaAlfred),F=new p.PendingMessageReader(N,P,this.deltaManager),A=Object.assign(Object.assign({},(0,a.getLumberBaseProperties)(P,N)),{lastCheckpointSeqNo:C.sequenceNumber,logOffset:C.logOffset,protocolHead:I.protocolHead,numOpsSinceLastSummary:M.length,LastCheckpointProtocolSeqNo:C.protocolState.sequenceNumber});a.Lumberjack.info("Creating scribe lambda",A);const j=new l.ScribeLambda(t,S.tenantId,S.documentId,R,E,F,D,C,this.serviceConfiguration,this.producer,L,I.term,I.protocolHead,M,O);return await this.sendLambdaStartResult(N,P,{lambdaName:s.LambdaName.Scribe,success:!0}),j}async dispose(){await this.mongoManager.close()}async sendLambdaStartResult(e,t,r){const n={clientSequenceNumber:-1,contents:null,data:JSON.stringify({type:s.ControlMessageType.LambdaStartResult,contents:r}),referenceSequenceNumber:-1,traces:this.serviceConfiguration.enableTraces?[]:void 0,type:o.MessageType.Control};return(0,m.sendToDeli)(e,t,this.producer,n)}}},xDkc:function(e,t,r){"use strict";r.d(t,"a",(function(){return u}));var n=r("7/yF"),i=r("Xou4"),s=r("5zuf"),o=r("he5V"),a=r("Ls0c"),c=r("HJ7Z");class u{constructor(e,t,r){this.manager=e,this.blobsShaCache=t,this.getPreviousFullSnapshot=r}async writeSummaryTree(e,t,r,n,i){const s=await this.getPreviousFullSnapshot(t);return this.writeSummaryTreeCore(e,null!=s?s:void 0)}async writeSummaryTreeCore(e,t){const r=await Promise.all(Object.keys(e.tree).map((async r=>{const n=e.tree[r],i=await this.writeSummaryTreeObject(n,t);return{mode:Object(a.f)(n),path:encodeURIComponent(r),sha:i,type:Object(a.g)(n)}})));return(await this.manager.createGitTree({tree:r})).sha}async writeSummaryTreeObject(e,t){switch(e.type){case c.a.Blob:return this.writeSummaryBlob(e.content);case c.a.Handle:if(void 0===t)throw Error("Parent summary does not exist to reference by handle.");return this.getIdFromPath(e.handleType,e.handle,t);case c.a.Tree:return this.writeSummaryTreeCore(e,t);case c.a.Attachment:return e.id;default:Object(n.a)(e,`Unknown type: ${e.type}`)}}async writeSummaryBlob(e){const{parsedContent:t,encoding:r}="string"==typeof e?{parsedContent:e,encoding:"utf-8"}:{parsedContent:Object(i.b)(e,"base64"),encoding:"base64"},n=await Object(s.a)(i.a.from(t,r));if(!this.blobsShaCache.has(n)){this.blobsShaCache.set(n,"");const e=await this.manager.createBlob(t,r);Object(o.a)(n===e.sha,182)}return n}getIdFromPath(e,t,r){const n=t.split("/").map((e=>decodeURIComponent(e)));return""===n[0]&&n.shift(),0===n.length?r.id:this.getIdFromPathCore(e,n,r)}getIdFromPathCore(e,t,r){var n;Object(o.a)(t.length>0,179);const i=t[0];if(1===t.length)switch(e){case c.a.Blob:{const e=r.blobs[i];return Object(o.a)(!!e,180),e}case c.a.Tree:{const e=null===(n=r.trees[i])||void 0===n?void 0:n.id;return Object(o.a)(!!e,181),e}default:throw Error(`Unexpected handle summary object type: "${e}".`)}return this.getIdFromPathCore(e,t.slice(1),r.trees[i])}}},xcV2:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.clientConnectivityStorageId=t.signalUsageStorageId=void 0,t.signalUsageStorageId="signalUsage",t.clientConnectivityStorageId="clientConnectivityUsage"},xiYf:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DeliLambdaFactory=void 0;const n=r("hBZP"),i=r("4+3C"),s=r("wWog"),o=r("MPeK"),a=r("VIQa"),c=r("y2M+"),u=r("Lvy3"),l=r("tp/L"),h=r("Txkb"),d=r("xkYN"),m=r("AK04"),p=e=>({clients:void 0,durableSequenceNumber:0,epoch:e,expHash1:u.defaultHash,logOffset:-1,sequenceNumber:0,signalClientConnectionNumber:0,term:1,lastSentMSN:0,nackMessages:void 0,successfullyStartedLambdas:[],checkpointTimestamp:Date.now()});t.DeliLambdaFactory=class extends n.EventEmitter{constructor(e,t,r,n,i,s,o,a){super(),this.operationsDbMongoManager=e,this.documentRepository=t,this.tenantManager=r,this.clientManager=n,this.forwardProducer=i,this.signalProducer=s,this.reverseProducer=o,this.serviceConfiguration=a}async create(e,t){var r,n,s,a,c,u,f,g;const{documentId:y,tenantId:v,leaderEpoch:b}=e,S=(0,h.createSessionMetric)(v,y,l.LumberEventName.SessionResult,this.serviceConfiguration),w=(0,h.createSessionMetric)(v,y,l.LumberEventName.StartSessionResult,this.serviceConfiguration),C={documentId:y,tenantId:v};let E,I,T;try{if(I=await this.documentRepository.readOne({documentId:y,tenantId:v}),!(0,h.isDocumentValid)(I)){const e="Received attempt to connect to a missing/deleted document.";return null===(r=t.log)||void 0===r||r.error(e,{messageMetaData:C}),l.Lumberjack.error(e,(0,l.getLumberBaseProperties)(y,v)),new h.NoOpLambda(t)}if(!(0,h.isDocumentSessionValid)(I,this.serviceConfiguration)){const e=`Received attempt to connect to invalid session: ${JSON.stringify(I.session)}`;if(null===(n=t.log)||void 0===n||n.error(e,{messageMetaData:C}),l.Lumberjack.error(e,(0,l.getLumberBaseProperties)(y,v)),this.serviceConfiguration.enforceDiscoveryFlow)return new h.NoOpLambda(t)}E=await this.tenantManager.getTenantGitManager(v,y)}catch(e){const r="Deli lambda creation failed";throw null===(s=t.log)||void 0===s||s.error(`${r}. Exception: ${(0,i.inspect)(e)}`,{messageMetaData:C}),l.Lumberjack.error(r,(0,l.getLumberBaseProperties)(y,v),e),this.logSessionFailureMetrics(S,w,r),e}if(null==I.deli){const e="New document. Setting empty deli checkpoint";null===(a=t.log)||void 0===a||a.info(e,{messageMetaData:C}),l.Lumberjack.info(e,(0,l.getLumberBaseProperties)(y,v)),T=p(b)}else if(""===I.deli){const e="Existing document. Fetching checkpoint from summary";null===(c=t.log)||void 0===c||c.info(e,{messageMetaData:C}),l.Lumberjack.info(e,(0,l.getLumberBaseProperties)(y,v));const r=await this.loadStateFromSummary(v,y,E,t.log);if(void 0===r){const e="Could not load state from summary";null===(u=t.log)||void 0===u||u.error(e,{messageMetaData:C}),l.Lumberjack.error(e,(0,l.getLumberBaseProperties)(y,v)),this.logSessionFailureMetrics(S,w,e),T=p(b)}else{T=r,T.logOffset=-1,T.epoch=b;const e=`Deli checkpoint from summary: ${JSON.stringify(T)}`;null===(f=t.log)||void 0===f||f.info(e,{messageMetaData:C}),l.Lumberjack.info(e,(0,l.getLumberBaseProperties)(y,v))}}else T=JSON.parse(I.deli);null==T.checkpointTimestamp&&(T.checkpointTimestamp=Date.now()),void 0===T.epoch&&(T.epoch=b,T.term=1);const N=T,P=(0,m.createDeliCheckpointManagerFromCollection)(v,y,this.documentRepository),x=new d.DeliLambda(t,v,y,N,P,this.clientManager,this.forwardProducer,this.signalProducer,this.reverseProducer,this.serviceConfiguration,S,w);return x.on("close",(e=>{(async()=>{var r;if(e===o.LambdaCloseType.ActivityTimeout||e===o.LambdaCloseType.Error){const n={documentId:y,tenantId:v,session:{$exists:!0}},i={"session.isSessionAlive":!1,"session.isSessionActive":!1,lastAccessTime:Date.now()};await this.documentRepository.updateOne(n,i,void 0);const s=`Marked session alive and active as false for closeType:\n                        ${JSON.stringify(e)}`;null===(r=t.log)||void 0===r||r.info(s,{messageMetaData:C}),l.Lumberjack.info(s,(0,l.getLumberBaseProperties)(y,v))}})().catch((e=>{var r;const n=`Failed to handle session alive and active with exception ${e}`;null===(r=t.log)||void 0===r||r.error(n,{messageMetaData:C}),l.Lumberjack.error(n,(0,l.getLumberBaseProperties)(y,v),e)}))})),null===(g=t.log)||void 0===g||g.info("Deli Lambda is marking session as alive and active as true.",{messageMetaData:C}),this.documentRepository.updateOne({tenantId:v,documentId:y},{"session.isSessionAlive":!0,"session.isSessionActive":!0}).catch((e=>{var r;const n="Deli Lambda failed to mark session as active.";null===(r=t.log)||void 0===r||r.error(`${n} Exception: ${(0,i.inspect)(e)}`,{messageMetaData:C}),l.Lumberjack.error(`${n}`,(0,l.getLumberBaseProperties)(y,v),e)})),x}logSessionFailureMetrics(e,t,r){null==e||e.error(r),null==t||t.error(r)}async dispose(){var e;const t=this.operationsDbMongoManager.close(),r=this.forwardProducer.close(),n=null===(e=this.signalProducer)||void 0===e?void 0:e.close(),i=this.reverseProducer.close();await Promise.all([t,r,n,i])}async loadStateFromSummary(e,t,r,n){const i=await r.getRef(encodeURIComponent(t));if(i)try{const e=await r.getContent(i.object.sha,".serviceProtocol/deli");return JSON.parse((0,s.toUtf8)(e.content,e.encoding))}catch(r){const i={documentId:t,tenantId:e},s="Error fetching deli state from summary";return null==n||n.error(s,{messageMetaData:i}),null==n||n.error(JSON.stringify(r),{messageMetaData:i}),void l.Lumberjack.error(s,(0,l.getLumberBaseProperties)(t,e),r)}}async resetCheckpointOnEpochTick(e,t,r,n,i,s){let o=i;if(s!==o.epoch){const i=await this.loadStateFromSummary(e,t,r,n);if(void 0===i)o.epoch=s;else{const a=o.logOffset;o=i,o.epoch=s,++o.term,o.durableSequenceNumber=i.sequenceNumber,o.logOffset=a,await this.createSummaryWithLatestTerm(r,o,t);const c="Created a summary on epoch tick";null==n||n.info(c,{messageMetaData:{documentId:t,tenantId:e}}),l.Lumberjack.info(c,(0,l.getLumberBaseProperties)(t,e))}}return o}async createSummaryWithLatestTerm(e,t,r){const n=await e.getRef(encodeURIComponent(r)),[i,o]=await Promise.all([e.getCommit(n.object.sha),e.getContent(n.object.sha,".serviceProtocol/scribe")]),u=(0,s.toUtf8)(o.content,o.encoding),l=(0,a.generateServiceProtocolEntries)(JSON.stringify(t),u),[h,d]=await Promise.all([e.createTree({entries:l}),e.getTree(i.tree.sha,!1)]),m=d.tree.filter((e=>".serviceProtocol"!==e.path)).map((e=>({mode:e.mode,path:e.path,sha:e.sha,type:e.type})));m.push({mode:c.FileMode.Directory,path:".serviceProtocol",sha:h.sha,type:"tree"});const p=await e.createGitTree({tree:m}),f={author:{date:(new Date).toISOString(),email:"praguertdev@microsoft.com",name:"Routerlicious Service"},message:`Term Change Summary @T${t.term}S${t.sequenceNumber}`,parents:[i.sha],tree:p.sha},g=await e.createCommit(f);await e.upsertRef(r,g.sha)}}},xkYN:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DeliLambda=t.OpEventType=void 0;const n=r("VIQa"),i=r("y2M+"),s=r("Lvy3"),o=r("MPeK"),a=r("tp/L"),c=r("wWog"),u=r("Txkb"),l=r("qeYL"),h=r("IJ/k");var d,m,p,f,g;!function(e){e[e.Duplicate=0]="Duplicate",e[e.Gap=1]="Gap",e[e.ConsecutiveOrSystem=2]="ConsecutiveOrSystem"}(d||(d={})),function(e){e[e.Immediate=0]="Immediate",e[e.Later=1]="Later",e[e.Never=2]="Never"}(m||(m={})),function(e){e[e.ClearCache=0]="ClearCache",e[e.NoOp=1]="NoOp"}(p||(p={})),function(e){e[e.Sequenced=0]="Sequenced",e[e.Nack=1]="Nack",e[e.Signal=2]="Signal"}(f||(f={})),function(e){e[e.Idle=0]="Idle",e[e.MaxOps=1]="MaxOps",e[e.MaxTime=2]="MaxTime",e[e.UpdatedDurableSequenceNumber=3]="UpdatedDurableSequenceNumber"}(g=t.OpEventType||(t.OpEventType={})),t.DeliLambda=class extends c.TypedEventEmitter{constructor(e,t,r,n,i,a,c,u,d,m,f,g){let y=arguments.length>12&&void 0!==arguments[12]?arguments[12]:new Map;var v,b,S,w;if(super(),this.context=e,this.tenantId=t,this.documentId=r,this.lastCheckpoint=n,this.clientManager=a,this.deltasProducer=c,this.signalsProducer=u,this.rawDeltasProducer=d,this.serviceConfiguration=m,this.sessionMetric=f,this.sessionStartMetric=g,this.sequencedSignalClients=y,this.clientSeqManager=new h.ClientSequenceNumberManager,this.minimumSequenceNumber=0,this.lastSendP=Promise.resolve(),this.lastNoClientP=Promise.resolve(),this.lastSentMSN=0,this.lastInstruction=p.NoOp,this.opEvent={sequencedMessagesSinceLastOpEvent:0},this.checkpointInfo={lastCheckpointTime:Date.now(),rawMessagesSinceCheckpoint:0},this.closed=!1,this.serviceSummaryGenerated=!1,this.isNewDocument=!1,this.successfullyStartedLambdas=[],this.expectedSuccessfullyStartedLambdas=[o.LambdaName.Scribe],n.clients)for(const e of n.clients)e.clientId&&this.clientSeqManager.upsertClient(e.clientId,e.clientSequenceNumber,e.referenceSequenceNumber,e.lastUpdate,e.canEvict,e.scopes,e.nack,e.serverMetadata);if(this.sequenceNumber=n.sequenceNumber,this.signalClientConnectionNumber=null!==(v=n.signalClientConnectionNumber)&&void 0!==v?v:0,this.lastHash=null!==(b=n.expHash1)&&void 0!==b?b:s.defaultHash,this.term=n.term,this.epoch=n.epoch,this.durableSequenceNumber=n.durableSequenceNumber,this.lastSentMSN=null!==(S=n.lastSentMSN)&&void 0!==S?S:0,this.logOffset=n.logOffset,n.nackMessages)if(Array.isArray(n.nackMessages))this.nackMessages=new Map(n.nackMessages);else{this.nackMessages=new Map;const e=n.nackMessages.identifier;void 0!==e&&this.nackMessages.set(e,n.nackMessages)}else this.nackMessages=new Map;this.successfullyStartedLambdas=null!==(w=n.successfullyStartedLambdas)&&void 0!==w?w:[];const C=this.clientSeqManager.getMinimumSequenceNumber();this.noActiveClients=-1===C,this.minimumSequenceNumber=this.noActiveClients?this.sequenceNumber:C,this.serviceConfiguration.deli.summaryNackMessages.checkOnStartup&&this.checkNackMessagesState(),this.checkpointContext=new l.CheckpointContext(this.tenantId,this.documentId,i,e),this.setActivityIdleTimer(),this.setReadClientIdleTimer(),this.serviceConfiguration.deli.opEvent.enable&&(this.updateOpMaxTimeTimer(),this.sequenceNumber>this.durableSequenceNumber&&(this.opEvent.sequencedMessagesSinceLastOpEvent=this.sequenceNumber-this.durableSequenceNumber)),this.isNewDocument=0===this.sequenceNumber,m.enableLumberjack&&this.logSessionStartMetrics(),this.serviceConfiguration.deli.checkForIdleClientsOnStartup&&this.checkIdleWriteClients(Date.now())}handler(e){if(e.offset<=this.logOffset)return a.Lumberjack.info(`rawMessage.offset: ${e.offset} <= this.logOffset: ${this.logOffset}`,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId)),this.updateCheckpointMessages(e),void(this.checkpointInfo.currentKafkaCheckpointMessage&&this.context.checkpoint(this.checkpointInfo.currentKafkaCheckpointMessage));this.logOffset=e.offset;let t=0;const r=[],n=(0,o.extractBoxcar)(e);for(const e of n.contents){const n=this.ticket(e,this.serviceConfiguration.enableTraces?this.createTrace("start"):void 0);if(n)switch(this.lastInstruction=n.instruction,n.ticketType){case f.Sequenced:{if(n.type!==i.MessageType.ClientLeave&&this.checkIdleWriteClients(n.timestamp),n.type!==i.MessageType.NoClient&&n.type!==i.MessageType.Control&&this.noActiveClients&&!this.serviceConfiguration.deli.disableNoClientMessage&&(this.lastNoClientP=this.sendToRawDeltas(this.createOpMessage(i.MessageType.NoClient)).catch((e=>{var t;const r="Could not send no client message";null===(t=this.context.log)||void 0===t||t.error(`${r}: ${JSON.stringify(e)}`,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),a.Lumberjack.error(r,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId),e),this.context.error(e,{restart:!0,tenantId:this.tenantId,documentId:this.documentId})}))),n.send===m.Never)continue;if(this.clearNoopConsolidationTimer(),n.send===m.Later){this.setNoopConsolidationTimer();continue}const c=n.message;this.serviceConfiguration.deli.enableOpHashing&&(this.lastHash=(0,s.getNextHash)(c,this.lastHash),c.expHash1=this.lastHash),c.type===i.MessageType.Summarize&&this.emit("summarizeMessage",c);const u={type:o.SequencedOperationType,tenantId:this.tenantId,documentId:this.documentId,operation:c};if(this.serviceConfiguration.deli.maintainBatches?r.push(u):this.produceMessage(this.deltasProducer,u),t++,this.lastSentMSN=n.msn,this.signalsProducer&&(c.type===i.MessageType.ClientJoin||c.type===i.MessageType.ClientLeave)&&(this.serviceConfiguration.deli.enableWriteClientSignals||c.serverMetadata&&"object"==typeof c.serverMetadata&&c.serverMetadata.createSignal)){const t=this.extractDataContent(e),r=this.createSignalMessage(e,c.sequenceNumber-1,t);c.type===i.MessageType.ClientJoin?this.addSequencedSignalClient(t,r):this.sequencedSignalClients.delete(t),this.produceMessage(this.signalsProducer,r.message)}break}case f.Nack:this.serviceConfiguration.deli.maintainBatches?r.push(n.message):this.produceMessage(this.deltasProducer,n.message);break;case f.Signal:this.signalsProducer&&this.produceMessage(this.signalsProducer,n.message)}}r.length>0&&this.produceMessages(this.deltasProducer,r,e),this.checkpointInfo.rawMessagesSinceCheckpoint++,this.updateCheckpointMessages(e);const c=this.getCheckpointReason();if(void 0!==c?this.checkpoint(c):this.updateCheckpointIdleTimer(),this.clearActivityIdleTimer(),this.setActivityIdleTimer(),t>0&&(this.serviceConfiguration.deli.summaryNackMessages.enable&&!this.nackMessages.has(o.NackMessagesType.SummaryMaxOps)&&this.sequenceNumber-this.durableSequenceNumber>this.serviceConfiguration.deli.summaryNackMessages.maxOps&&this.updateNackMessages(o.NackMessagesType.SummaryMaxOps,{identifier:o.NackMessagesType.SummaryMaxOps,content:this.serviceConfiguration.deli.summaryNackMessages.nackContent,allowSystemMessages:!0,allowedScopes:[i.ScopeType.SummaryWrite]}),this.serviceConfiguration.deli.opEvent.enable)){this.updateOpIdleTimer();const e=this.serviceConfiguration.deli.opEvent.maxOps;void 0!==e&&(this.opEvent.sequencedMessagesSinceLastOpEvent+=t,this.opEvent.sequencedMessagesSinceLastOpEvent>e&&this.emitOpEvent(g.MaxOps))}}close(e){this.closed=!0,this.checkpointContext.close(),this.clearActivityIdleTimer(),this.clearReadClientIdleTimer(),this.clearNoopConsolidationTimer(),this.clearCheckpointIdleTimer(),this.clearOpIdleTimer(),this.clearOpMaxTimeTimer(),this.emit("close",e),this.removeAllListeners(),this.serviceConfiguration.enableLumberjack&&this.logSessionEndMetrics(e)}produceMessage(e,t){this.lastSendP=e.send([t],t.tenantId,t.documentId).catch((e=>{var t;if(this.closed)return;const r="Could not send message to producer";null===(t=this.context.log)||void 0===t||t.error(`${r}: ${JSON.stringify(e)}`,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),a.Lumberjack.error(r,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId),e),this.context.error(e,{restart:!0,tenantId:this.tenantId,documentId:this.documentId})}))}produceMessages(e,t,r){this.lastSendP=e.send(t,this.tenantId,this.documentId).catch((e=>{var n;if(this.closed)return;const i=`Could not send ${t.length} messages to producer. offset: ${r.offset}`;null===(n=this.context.log)||void 0===n||n.error(`${i}: ${JSON.stringify(e)}`,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),a.Lumberjack.error(i,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId),e);let o=!0,c=!1;(0,s.isNetworkError)(e)&&413===e.code&&(o=!1,c=!0),this.context.error(e,{restart:o,markAsCorrupt:c?r:void 0,tenantId:this.tenantId,documentId:this.documentId})}))}logSessionStartMetrics(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];var t,r,n,i,s,o,c,l;if((null===(t=this.sessionStartMetric)||void 0===t?void 0:t.isCompleted())&&(this.sessionStartMetric=(0,u.createSessionMetric)(this.tenantId,this.documentId,a.LumberEventName.StartSessionResult,this.serviceConfiguration)),e)return null===(r=this.sessionStartMetric)||void 0===r||r.setProperties({[a.CommonProperties.sessionState]:a.SessionState.LambdaStartFailed}),void(null===(n=this.sessionStartMetric)||void 0===n||n.error("Lambda start failed"));if(this.verifyRequiredLambdaStarted())this.isNewDocument?(null===(i=this.sessionStartMetric)||void 0===i||i.setProperties({[a.CommonProperties.sessionState]:a.SessionState.started}),null===(s=this.sessionStartMetric)||void 0===s||s.success("Session started successfully")):(null===(o=this.sessionStartMetric)||void 0===o||o.setProperties({[a.CommonProperties.sessionState]:a.SessionState.resumed}),null===(c=this.sessionStartMetric)||void 0===c||c.success("Session resumed successfully"));else{const e="Not all required lambdas started";null===(l=this.context.log)||void 0===l||l.info(e),a.Lumberjack.info(e,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId))}}verifyRequiredLambdaStarted(){return this.expectedSuccessfullyStartedLambdas.every((e=>this.successfullyStartedLambdas.includes(e)))}logSessionEndMetrics(e){var t,r;(null===(t=this.sessionMetric)||void 0===t?void 0:t.isCompleted())&&(a.Lumberjack.info("Session metric already completed. Creating a new one.",(0,a.getLumberBaseProperties)(this.documentId,this.tenantId)),this.sessionMetric=(0,u.createSessionMetric)(this.tenantId,this.documentId,a.LumberEventName.SessionResult,this.serviceConfiguration)),null===(r=this.sessionMetric)||void 0===r||r.setProperties({[a.CommonProperties.serviceSummarySuccess]:this.serviceSummaryGenerated}),(0,u.logCommonSessionEndMetrics)(this.context,e,this.sessionMetric,this.sequenceNumber,this.durableSequenceNumber,Array.from(this.nackMessages.keys()))}ticket(e,t){var r,c,u,l,h,g;if(e.type!==o.RawOperationType)return;const y=e,v=this.extractDataContent(y);if(this.nackMessages.size>0&&this.serviceConfiguration.deli.enableNackMessages)for(const e of this.nackMessages.values()){let t=!0;if(!e.allowSystemMessages||!(0,n.isServiceMessageType)(y.operation.type)&&y.clientId){if(e.allowedScopes){const r=y.clientId;if(r){const n=this.clientSeqManager.get(r);if(n)for(const r of e.allowedScopes)if(n.scopes.includes(r)){t=!1;break}}}}else t=!1;if(t)return this.createNackMessage(y,e.content.code,e.content.type,e.content.message,e.content.retryAfter)}const b=this.checkOrder(y);if(b===d.Duplicate)return;if(b===d.Gap)return this.createNackMessage(y,400,i.NackErrorType.BadRequestError,"Gap detected in incoming op");if(this.isInvalidMessage(y))return this.createNackMessage(y,400,i.NackErrorType.BadRequestError,"Op not allowed");if(y.clientId){const e=this.clientSeqManager.get(y.clientId);if(!e||e.nack)return this.createNackMessage(y,400,i.NackErrorType.BadRequestError,"Nonexistent client");if(y.clientId&&-1!==y.operation.referenceSequenceNumber&&y.operation.referenceSequenceNumber<this.minimumSequenceNumber)return this.clientSeqManager.upsertClient(y.clientId,y.operation.clientSequenceNumber,this.minimumSequenceNumber,y.timestamp,!0,[],!0),this.createNackMessage(y,400,i.NackErrorType.BadRequestError,`Refseq ${y.operation.referenceSequenceNumber} < ${this.minimumSequenceNumber}`);if(y.operation.type===i.MessageType.Summarize&&!(0,s.canSummarize)(e.scopes))return this.createNackMessage(y,403,i.NackErrorType.InvalidScopeError,`Client ${y.clientId} does not have summary permission`)}else if(y.operation.type===i.MessageType.ClientLeave){if(!this.clientSeqManager.removeClient(v))return this.sequencedSignalClients.get(v)?(this.sequencedSignalClients.delete(v),this.createSignalMessage(y,this.sequenceNumber,v)):void 0;this.serviceConfiguration.deli.enableLeaveOpNoClientServerMetadata&&0===this.clientSeqManager.count()&&((null!==(r=(g=y.operation).serverMetadata)&&void 0!==r?r:g.serverMetadata={}).noClient=!0)}else if(y.operation.type===i.MessageType.ClientJoin){const e=v;if("read"===e.detail.mode){if(this.sequencedSignalClients.has(e.clientId))return;const t=this.createSignalMessage(y,this.sequenceNumber,v);return this.addSequencedSignalClient(e,t),t}if(!this.clientSeqManager.upsertClient(e.clientId,0,this.minimumSequenceNumber,y.timestamp,!0,e.detail.scopes,!1,y.operation.serverMetadata))return}let S=this.sequenceNumber;y.clientId?(y.operation.type!==i.MessageType.NoOp&&(S=this.revSequenceNumber()),-1===y.operation.referenceSequenceNumber&&(y.operation.referenceSequenceNumber=S),this.clientSeqManager.upsertClient(y.clientId,y.operation.clientSequenceNumber,y.operation.referenceSequenceNumber,y.timestamp,!0)):y.operation.type!==i.MessageType.NoOp&&y.operation.type!==i.MessageType.NoClient&&y.operation.type!==i.MessageType.Control&&(S=this.revSequenceNumber());const w=this.clientSeqManager.getMinimumSequenceNumber();-1===w?(this.minimumSequenceNumber=S,this.noActiveClients=!0):(this.minimumSequenceNumber=w,this.noActiveClients=!1);let C=m.Immediate,E=p.NoOp;switch(y.operation.type){case i.MessageType.NoOp:y.clientId?null===y.operation.contents||this.minimumSequenceNumber<=this.lastSentMSN?C=m.Later:S=this.revSequenceNumber():this.minimumSequenceNumber<=this.lastSentMSN?C=m.Never:S=this.revSequenceNumber();break;case i.MessageType.NoClient:this.noActiveClients?(S=this.revSequenceNumber(),y.operation.referenceSequenceNumber=S,this.minimumSequenceNumber=S):C=m.Never;break;case i.MessageType.Control:{C=m.Never;const e=v;switch(e.type){case o.ControlMessageType.UpdateDSN:{const t=`Update DSN: ${JSON.stringify(e)}`;null===(c=this.context.log)||void 0===c||c.info(t,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),a.Lumberjack.info(t,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId));const r=e.contents;this.serviceSummaryGenerated=!r.isClientSummary;const n=r.durableSequenceNumber;if(n>=this.durableSequenceNumber){if(r.clearCache&&this.noActiveClients){E=p.ClearCache;const e="Deli cache will be cleared";null===(u=this.context.log)||void 0===u||u.info(e,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),a.Lumberjack.info(e,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId))}this.updateDurableSequenceNumber(n)}break}case o.ControlMessageType.NackMessages:{const t=e.contents;this.updateNackMessages(t.identifier,void 0!==t.content?t:void 0);break}case o.ControlMessageType.LambdaStartResult:{const t=e.contents;t.success&&this.successfullyStartedLambdas.push(t.lambdaName),this.logSessionStartMetrics(!t.success);break}case o.ControlMessageType.ExtendClient:{const t=e.contents,r=new Map,n=null!==(l=t.clientIds)&&void 0!==l?l:t.clientId?[t.clientId]:[];for(const e of n){const t=this.sequencedSignalClients.get(e);t&&r.set(e,t)}if(r.size>0)if(this.clientManager)this.clientManager.extendSequencedClients(this.tenantId,this.documentId,r,this.serviceConfiguration.deli.clientTimeout).catch((e=>{var t;const r="Could not extend clients";null===(t=this.context.log)||void 0===t||t.error(`${r}: ${JSON.stringify(e)}`,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),a.Lumberjack.error(r,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId),e)}));else{const e="Could not extend clients. Missing client manager";null===(h=this.context.log)||void 0===h||h.error(`${e}`,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),a.Lumberjack.error(e,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId))}break}default:this.emit("controlMessage",e)}break}case i.MessageType.SummaryAck:if(this.serviceConfiguration.deli.enableAutoDSNUpdate){const e=v.summaryProposal.summarySequenceNumber;e>=this.durableSequenceNumber&&this.updateDurableSequenceNumber(e)}}t&&y.operation.traces&&y.operation.traces.length>1&&(y.operation.traces.push(t),y.operation.traces.push(this.createTrace("end")));const I=this.createOutputMessage(y,void 0,S,v);return{ticketType:f.Sequenced,instruction:E,message:I,msn:this.minimumSequenceNumber,send:C,timestamp:y.timestamp,type:y.operation.type}}extractDataContent(e){if(e.operation.type===i.MessageType.ClientJoin||e.operation.type===i.MessageType.ClientLeave||e.operation.type===i.MessageType.SummaryAck||e.operation.type===i.MessageType.SummaryNack||e.operation.type===i.MessageType.Control){const t=e.operation;if(t.data)return JSON.parse(t.data)}}isInvalidMessage(e){return!!e.clientId&&(0,n.isServiceMessageType)(e.operation.type)}createOutputMessage(e,t,r,n){var s;const o={clientId:e.clientId,clientSequenceNumber:e.operation.clientSequenceNumber,contents:e.operation.contents,metadata:e.operation.metadata,serverMetadata:e.operation.serverMetadata,minimumSequenceNumber:this.minimumSequenceNumber,origin:t,referenceSequenceNumber:e.operation.referenceSequenceNumber,sequenceNumber:r,term:this.term,timestamp:e.timestamp,traces:e.operation.traces,type:e.operation.type,compression:e.operation.compression};if(e.operation.type===i.MessageType.Summarize||e.operation.type===i.MessageType.NoClient){const t=o;let r=!1;if(this.serviceConfiguration.scribe.generateServiceSummary?r=!0:e.operation.type===i.MessageType.Summarize&&(this.serviceConfiguration.deli.skipSummarizeAugmentationForSingleCommmit&&(null===(s=JSON.parse(e.operation.contents).details)||void 0===s?void 0:s.includesProtocolTree)||(r=!0)),r){const e=JSON.stringify(this.generateDeliCheckpoint());t.additionalContent=e}return t}if(void 0!==n){const e=o;return e.data=JSON.stringify(n),e}return o}checkOrder(e){var t,r;if(!e.clientId)return d.ConsecutiveOrSystem;const n=e.clientId,i=e.operation.clientSequenceNumber,s=this.clientSeqManager.get(n);if(!s)return d.ConsecutiveOrSystem;const o={documentId:this.documentId,tenantId:this.tenantId},c=s.clientSequenceNumber+1;if(i===c)return d.ConsecutiveOrSystem;if(i>c){const e=`Gap ${n}:${c} > ${i}`;return null===(t=this.context.log)||void 0===t||t.info(e,{messageMetaData:o}),a.Lumberjack.info(e,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId)),d.Gap}{const e=`Duplicate ${n}:${c} < ${i}`;return null===(r=this.context.log)||void 0===r||r.info(e,{messageMetaData:o}),a.Lumberjack.info(e,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId)),d.Duplicate}}async sendToRawDeltas(e){var t;try{await this.rawDeltasProducer.send([e],e.tenantId,e.documentId)}catch(e){if(this.closed)return;const r="Could not send message to alfred";null===(t=this.context.log)||void 0===t||t.error(`${r}: ${JSON.stringify(e)}`,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),a.Lumberjack.error(r,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId),e),this.context.error(e,{restart:!0,tenantId:this.tenantId,documentId:this.documentId})}}checkIdleWriteClients(e){const t=this.getIdleClient(e);if(null==t?void 0:t.clientId){const e=this.createLeaveMessage(t.clientId,t.serverMetadata);this.sendToRawDeltas(e)}}checkIdleReadClients(){const e=Date.now();for(const[t,{client:r,exp:n}]of this.sequencedSignalClients)if("read"===r.mode&&n<e){const e=this.createLeaveMessage(t);this.sendToRawDeltas(e)}}createLeaveMessage(e,t){const r={clientSequenceNumber:-1,contents:null,data:JSON.stringify(e),referenceSequenceNumber:-1,traces:this.serviceConfiguration.enableTraces?[]:void 0,type:i.MessageType.ClientLeave,serverMetadata:t};return this.createRawOperationMessage(r)}createNackMessage(e,t,r,n,i){const s=e.clientId;if(!s)return;const a={clientId:s,documentId:this.documentId,operation:{content:{code:t,type:r,message:n,retryAfter:i},operation:e.operation,sequenceNumber:this.minimumSequenceNumber},tenantId:this.tenantId,timestamp:Date.now(),type:o.NackOperationType};return{ticketType:f.Nack,message:a}}createSignalMessage(e,t,r){let n;switch(e.operation.type){case i.MessageType.ClientJoin:n=(0,u.createRoomJoinMessage)(r.clientId,r.detail);break;case i.MessageType.ClientLeave:n=(0,u.createRoomLeaveMessage)("string"==typeof r?r:r.clientId);break;case i.MessageType.Control:n={clientId:null,content:JSON.stringify({type:i.MessageType.Control,content:r})};break;default:throw new Error(`Cannot create signal message for type ${e.operation.type}`)}return n.referenceSequenceNumber=t,n.clientConnectionNumber=++this.signalClientConnectionNumber,{ticketType:f.Signal,message:{type:o.SignalOperationType,tenantId:this.tenantId,documentId:this.documentId,operation:n,timestamp:Date.now()}}}createOpMessage(e){return this.createRawOperationMessage({clientSequenceNumber:-1,contents:null,referenceSequenceNumber:-1,traces:this.serviceConfiguration.enableTraces?[]:void 0,type:e})}createRawOperationMessage(e){return{clientId:null,documentId:this.documentId,operation:e,tenantId:this.tenantId,timestamp:Date.now(),type:o.RawOperationType}}createTrace(e){return{action:e,service:"deli",timestamp:Date.now()}}updateCheckpointMessages(e){if(this.checkpointInfo.currentCheckpointMessage=e,this.noActiveClients)this.checkpointInfo.nextKafkaCheckpointMessage=void 0,this.checkpointInfo.currentKafkaCheckpointMessage=e;else{const t=this.checkpointInfo.nextKafkaCheckpointMessage;this.checkpointInfo.nextKafkaCheckpointMessage=e,this.checkpointInfo.currentKafkaCheckpointMessage=t}}generateCheckpoint(e){return{reason:e,deliState:this.generateDeliCheckpoint(),deliCheckpointMessage:this.checkpointInfo.currentCheckpointMessage,kafkaCheckpointMessage:this.checkpointInfo.currentKafkaCheckpointMessage}}generateDeliCheckpoint(){return{clients:this.clientSeqManager.cloneValues(),durableSequenceNumber:this.durableSequenceNumber,epoch:this.epoch,expHash1:this.lastHash,logOffset:this.logOffset,sequenceNumber:this.sequenceNumber,signalClientConnectionNumber:this.signalClientConnectionNumber,term:this.term,lastSentMSN:this.lastSentMSN,nackMessages:Array.from(this.nackMessages),successfullyStartedLambdas:this.successfullyStartedLambdas,checkpointTimestamp:Date.now()}}revSequenceNumber(){return++this.sequenceNumber}getIdleClient(e){const t=this.clientSeqManager.peek();if((null==t?void 0:t.canEvict)&&e-t.lastUpdate>this.serviceConfiguration.deli.clientTimeout)return t}setActivityIdleTimer(){this.noActiveClients||(this.activityIdleTimer=setTimeout((()=>{if(!this.noActiveClients){const e=this.createOpMessage(i.MessageType.NoOp);this.sendToRawDeltas(e)}}),this.serviceConfiguration.deli.activityTimeout))}clearActivityIdleTimer(){void 0!==this.activityIdleTimer&&(clearTimeout(this.activityIdleTimer),this.activityIdleTimer=void 0)}setReadClientIdleTimer(){this.clearReadClientIdleTimer(),this.readClientIdleTimer=setInterval((()=>{this.checkIdleReadClients()}),this.serviceConfiguration.deli.readClientIdleTimer)}clearReadClientIdleTimer(){void 0!==this.readClientIdleTimer&&(clearInterval(this.readClientIdleTimer),this.readClientIdleTimer=void 0)}setNoopConsolidationTimer(){this.noActiveClients||(this.noopEvent=setTimeout((()=>{if(!this.noActiveClients){const e=this.createOpMessage(i.MessageType.NoOp);this.sendToRawDeltas(e)}}),this.serviceConfiguration.deli.noOpConsolidationTimeout))}clearNoopConsolidationTimer(){void 0!==this.noopEvent&&(clearTimeout(this.noopEvent),this.noopEvent=void 0)}updateOpIdleTimer(){const e=this.serviceConfiguration.deli.opEvent.idleTime;void 0!==e&&(this.clearOpIdleTimer(),this.opEvent.idleTimer=setTimeout((()=>{this.emitOpEvent(g.Idle)}),e))}clearOpIdleTimer(){void 0!==this.opEvent.idleTimer&&(clearTimeout(this.opEvent.idleTimer),this.opEvent.idleTimer=void 0)}updateOpMaxTimeTimer(){const e=this.serviceConfiguration.deli.opEvent.maxTime;void 0!==e&&(this.clearOpMaxTimeTimer(),this.opEvent.maxTimer=setTimeout((()=>{this.emitOpEvent(g.MaxTime)}),e))}clearOpMaxTimeTimer(){void 0!==this.opEvent.maxTimer&&(clearTimeout(this.opEvent.maxTimer),this.opEvent.maxTimer=void 0)}emitOpEvent(e,t){(t||0!==this.opEvent.sequencedMessagesSinceLastOpEvent)&&(this.emit("opEvent",e,this.sequenceNumber,this.opEvent.sequencedMessagesSinceLastOpEvent),this.opEvent.sequencedMessagesSinceLastOpEvent=0,this.updateOpMaxTimeTimer())}checkNackMessagesState(){this.serviceConfiguration.deli.summaryNackMessages.enable&&this.nackMessages.has(o.NackMessagesType.SummaryMaxOps)&&this.sequenceNumber-this.durableSequenceNumber<=this.serviceConfiguration.deli.summaryNackMessages.maxOps&&this.updateNackMessages(o.NackMessagesType.SummaryMaxOps,void 0)}getCheckpointReason(){const e=this.serviceConfiguration.deli.checkpointHeuristics;return e.enable?this.checkpointInfo.rawMessagesSinceCheckpoint>=e.maxMessages?u.CheckpointReason.MaxMessages:Date.now()-this.checkpointInfo.lastCheckpointTime>=e.maxTime?u.CheckpointReason.MaxTime:this.lastInstruction===p.ClearCache?u.CheckpointReason.ClearCache:void 0:u.CheckpointReason.EveryMessage}checkpoint(e){this.clearCheckpointIdleTimer(),this.checkpointInfo.lastCheckpointTime=Date.now(),this.checkpointInfo.rawMessagesSinceCheckpoint=0;const t=this.generateCheckpoint(e);Promise.all([this.lastSendP,this.lastNoClientP]).then((()=>{var r,n;e===u.CheckpointReason.ClearCache&&(t.clear=!0),this.checkpointContext.checkpoint(t);const i=u.CheckpointReason[t.reason],s=`Writing checkpoint. Reason: ${i}`,o=Object.assign(Object.assign({},(0,a.getLumberBaseProperties)(this.documentId,this.tenantId)),{checkpointReason:i,lastOffset:this.logOffset,deliCheckpointOffset:t.deliCheckpointMessage.offset,deliCheckpointPartition:t.deliCheckpointMessage.partition,kafkaCheckpointOffset:null===(r=t.kafkaCheckpointMessage)||void 0===r?void 0:r.offset,kafkaCheckpointPartition:null===(n=t.kafkaCheckpointMessage)||void 0===n?void 0:n.partition});a.Lumberjack.info(s,o)}),(e=>{var t;const r="Could not send message to scriptorium";null===(t=this.context.log)||void 0===t||t.error(`${r}: ${JSON.stringify(e)}`,{messageMetaData:{documentId:this.documentId,tenantId:this.tenantId}}),a.Lumberjack.error(r,(0,a.getLumberBaseProperties)(this.documentId,this.tenantId),e),this.context.error(e,{restart:!0,tenantId:this.tenantId,documentId:this.documentId})}))}updateCheckpointIdleTimer(){this.clearCheckpointIdleTimer();const e=this.checkpointInfo.currentCheckpointMessage;this.checkpointInfo.idleTimer=setTimeout((()=>{this.checkpointInfo.idleTimer=void 0,e===this.checkpointInfo.currentCheckpointMessage&&this.checkpoint(u.CheckpointReason.IdleTime)}),this.serviceConfiguration.deli.checkpointHeuristics.idleTime)}clearCheckpointIdleTimer(){void 0!==this.checkpointInfo.idleTimer&&(clearTimeout(this.checkpointInfo.idleTimer),this.checkpointInfo.idleTimer=void 0)}updateDurableSequenceNumber(e){this.durableSequenceNumber=e,this.checkNackMessagesState(),this.emit("updatedDurableSequenceNumber",e),this.serviceConfiguration.deli.opEvent.enable&&this.emitOpEvent(g.UpdatedDurableSequenceNumber,!0)}updateNackMessages(e,t){void 0!==t?this.nackMessages.set(e,t):this.nackMessages.delete(e),this.emit("updatedNackMessages",e,t)}addSequencedSignalClient(e,t){const r={client:e.detail,referenceSequenceNumber:t.message.operation.referenceSequenceNumber,clientConnectionNumber:t.message.operation.clientConnectionNumber,exp:Date.now()+this.serviceConfiguration.deli.clientTimeout};this.sequencedSignalClients.set(e.clientId,r)}}},"y2M+":function(e,t,r){"use strict";r.r(t);var n=r("f79D");r.d(t,"MessageType",(function(){return n.a})),r.d(t,"NackErrorType",(function(){return n.b})),r.d(t,"SignalType",(function(){return n.c}));var i=r("XPga");r.d(t,"ScopeType",(function(){return i.a}));var s=r("l4ds");r.d(t,"FileMode",(function(){return s.a})),r.d(t,"TreeEntry",(function(){return s.b}));var o=r("HJ7Z");r.d(t,"SummaryType",(function(){return o.a}))},yD7y:function(e,t,r){var n=r("wfEq"),i=r("KSsY"),s=r("pRMk").Buffer,o=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],a=new Array(64);function c(){this.init(),this._w=a,i.call(this,64,56)}function u(e,t,r){return r^e&(t^r)}function l(e,t,r){return e&t|r&(e|t)}function h(e){return(e>>>2|e<<30)^(e>>>13|e<<19)^(e>>>22|e<<10)}function d(e){return(e>>>6|e<<26)^(e>>>11|e<<21)^(e>>>25|e<<7)}function m(e){return(e>>>7|e<<25)^(e>>>18|e<<14)^e>>>3}function p(e){return(e>>>17|e<<15)^(e>>>19|e<<13)^e>>>10}n(c,i),c.prototype.init=function(){return this._a=1779033703,this._b=3144134277,this._c=1013904242,this._d=2773480762,this._e=1359893119,this._f=2600822924,this._g=528734635,this._h=1541459225,this},c.prototype._update=function(e){for(var t=this._w,r=0|this._a,n=0|this._b,i=0|this._c,s=0|this._d,a=0|this._e,c=0|this._f,f=0|this._g,g=0|this._h,y=0;y<16;++y)t[y]=e.readInt32BE(4*y);for(;y<64;++y)t[y]=p(t[y-2])+t[y-7]+m(t[y-15])+t[y-16]|0;for(var v=0;v<64;++v){var b=g+d(a)+u(a,c,f)+o[v]+t[v]|0,S=h(r)+l(r,n,i)|0;g=f,f=c,c=a,a=s+b|0,s=i,i=n,n=r,r=b+S|0}this._a=r+this._a|0,this._b=n+this._b|0,this._c=i+this._c|0,this._d=s+this._d|0,this._e=a+this._e|0,this._f=c+this._f|0,this._g=f+this._g|0,this._h=g+this._h|0},c.prototype._hash=function(){var e=s.allocUnsafe(32);return e.writeInt32BE(this._a,0),e.writeInt32BE(this._b,4),e.writeInt32BE(this._c,8),e.writeInt32BE(this._d,12),e.writeInt32BE(this._e,16),e.writeInt32BE(this._f,20),e.writeInt32BE(this._g,24),e.writeInt32BE(this._h,28),e},e.exports=c},yQiv:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createCompositeTokenId=t.TokenRevocationError=t.signalUsageStorageId=t.clientConnectivityStorageId=t.ThrottlingError=t.KeyName=t.shouldRetryNetworkError=t.runWithRetry=t.requestWithRetry=t.calculateRetryIntervalForNetworkError=t.PendingBoxcar=t.MaxBatchSize=t.MongoDocumentRepository=t.MongoDatabaseManager=t.MongoManager=t.DefaultMetricClient=t.SystemType=t.SystemOperations=t.SignalOperationType=t.SequencedOperationType=t.RawOperationType=t.NackOperationType=t.NackMessagesType=t.ControlMessageType=t.BoxcarType=t.LambdaName=t.LambdaCloseType=t.extractBoxcar=t.EmptyTaskMessageSender=t.isRetryEnabled=t.DefaultServiceConfiguration=t.CombinedProducer=t.CombinedLambda=t.CombinedContext=t.chooseCelaName=void 0;var n=r("UZN4");Object.defineProperty(t,"chooseCelaName",{enumerable:!0,get:function(){return n.chooseCelaName}});var i=r("NlbK");Object.defineProperty(t,"CombinedContext",{enumerable:!0,get:function(){return i.CombinedContext}});var s=r("z0HA");Object.defineProperty(t,"CombinedLambda",{enumerable:!0,get:function(){return s.CombinedLambda}});var o=r("FyNQ");Object.defineProperty(t,"CombinedProducer",{enumerable:!0,get:function(){return o.CombinedProducer}});var a=r("kcMb");Object.defineProperty(t,"DefaultServiceConfiguration",{enumerable:!0,get:function(){return a.DefaultServiceConfiguration}});var c=r("N7Hg");Object.defineProperty(t,"isRetryEnabled",{enumerable:!0,get:function(){return c.isRetryEnabled}});var u=r("OHrY");Object.defineProperty(t,"EmptyTaskMessageSender",{enumerable:!0,get:function(){return u.EmptyTaskMessageSender}});var l=r("pRkM");Object.defineProperty(t,"extractBoxcar",{enumerable:!0,get:function(){return l.extractBoxcar}}),Object.defineProperty(t,"LambdaCloseType",{enumerable:!0,get:function(){return l.LambdaCloseType}}),Object.defineProperty(t,"LambdaName",{enumerable:!0,get:function(){return l.LambdaName}});var h=r("DKo5");Object.defineProperty(t,"BoxcarType",{enumerable:!0,get:function(){return h.BoxcarType}}),Object.defineProperty(t,"ControlMessageType",{enumerable:!0,get:function(){return h.ControlMessageType}}),Object.defineProperty(t,"NackMessagesType",{enumerable:!0,get:function(){return h.NackMessagesType}}),Object.defineProperty(t,"NackOperationType",{enumerable:!0,get:function(){return h.NackOperationType}}),Object.defineProperty(t,"RawOperationType",{enumerable:!0,get:function(){return h.RawOperationType}}),Object.defineProperty(t,"SequencedOperationType",{enumerable:!0,get:function(){return h.SequencedOperationType}}),Object.defineProperty(t,"SignalOperationType",{enumerable:!0,get:function(){return h.SignalOperationType}}),Object.defineProperty(t,"SystemOperations",{enumerable:!0,get:function(){return h.SystemOperations}}),Object.defineProperty(t,"SystemType",{enumerable:!0,get:function(){return h.SystemType}});var d=r("qg/C");Object.defineProperty(t,"DefaultMetricClient",{enumerable:!0,get:function(){return d.DefaultMetricClient}});var m=r("XX9r");Object.defineProperty(t,"MongoManager",{enumerable:!0,get:function(){return m.MongoManager}});var p=r("MTg9");Object.defineProperty(t,"MongoDatabaseManager",{enumerable:!0,get:function(){return p.MongoDatabaseManager}});var f=r("E3fA");Object.defineProperty(t,"MongoDocumentRepository",{enumerable:!0,get:function(){return f.MongoDocumentRepository}});var g=r("hsA5");Object.defineProperty(t,"MaxBatchSize",{enumerable:!0,get:function(){return g.MaxBatchSize}}),Object.defineProperty(t,"PendingBoxcar",{enumerable:!0,get:function(){return g.PendingBoxcar}});var y=r("Tmfz");Object.defineProperty(t,"calculateRetryIntervalForNetworkError",{enumerable:!0,get:function(){return y.calculateRetryIntervalForNetworkError}}),Object.defineProperty(t,"requestWithRetry",{enumerable:!0,get:function(){return y.requestWithRetry}}),Object.defineProperty(t,"runWithRetry",{enumerable:!0,get:function(){return y.runWithRetry}}),Object.defineProperty(t,"shouldRetryNetworkError",{enumerable:!0,get:function(){return y.shouldRetryNetworkError}});var v=r("h6re");Object.defineProperty(t,"KeyName",{enumerable:!0,get:function(){return v.KeyName}});var b=r("bRtlv");Object.defineProperty(t,"ThrottlingError",{enumerable:!0,get:function(){return b.ThrottlingError}});var S=r("xcV2");Object.defineProperty(t,"clientConnectivityStorageId",{enumerable:!0,get:function(){return S.clientConnectivityStorageId}}),Object.defineProperty(t,"signalUsageStorageId",{enumerable:!0,get:function(){return S.signalUsageStorageId}});var w=r("FszL");Object.defineProperty(t,"TokenRevocationError",{enumerable:!0,get:function(){return w.TokenRevocationError}}),Object.defineProperty(t,"createCompositeTokenId",{enumerable:!0,get:function(){return w.createCompositeTokenId}})},yxQQ:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LumberEventName=void 0,function(e){e.LumberjackError="LumberjackError",e.LumberjackSchemaValidationFailure="LumberjackSchemaValidationFailure",e.RunService="RunService",e.UnitTestEvent="UnitTestEvent",e.ClientSummary="ClientSummary",e.DeliHandler="DeliHandler",e.KafkaRunner="KafkaRunner",e.ScribeHandler="ScribeHandler",e.ServiceSummary="ServiceSummary",e.SummaryReader="SummaryReader",e.ScriptoriumProcessBatch="ScriptoriumProcessBatch",e.RunWithRetry="RunWithRetry",e.RequestWithRetry="RequestWithRetry",e.SessionResult="SessionResult",e.StartSessionResult="StartSessionResult",e.ScribeSessionResult="ScribeSessionResult",e.ConnectDocument="ConnectDocument",e.ConnectDocumentAddClient="ConnectDocumentAddClient",e.ConnectDocumentGetClients="ConnectDocumentGetClients",e.ConnectDocumentOrdererConnection="ConnectDocumentOrdererConnection",e.CreateDocumentUpdateDocumentCollection="CreateDocumentUpdateDocumentCollection",e.CreateDocInitialSummaryWrite="CreateDocInitialSummaryWrite",e.RiddlerFetchTenantKey="RiddlerFetchTenantKey",e.HttpRequest="HttpRequest",e.TotalConnectionCount="TotalConnectionCount",e.ConnectionCountPerNode="ConnectionCountPerNode"}(t.LumberEventName||(t.LumberEventName={}))},z0HA:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CombinedLambda=void 0,t.CombinedLambda=class{constructor(e){this.lambdas=e}handler(e){const t=[];for(const r of this.lambdas){const n=r.handler(e);void 0!==n&&t.push(n)}return t.length>0?Promise.all(t):void 0}close(e){for(const t of this.lambdas)t.close(e)}}},zKO3:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CopierLambdaFactory=void 0;const n=r("hBZP"),i=r("oVfu");t.CopierLambdaFactory=class extends n.EventEmitter{constructor(e,t){super(),this.mongoManager=e,this.rawOpCollection=t}async create(e,t){return new i.CopierLambda(this.rawOpCollection,t)}async dispose(){await this.mongoManager.close()}}},zTUk:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.debug=void 0;const n=r("Gstq"),i=r("GkBk");t.debug=(0,n.debug)("fluid:core"),(0,t.debug)(`Package: ${i.pkgName} - Version: ${i.pkgVersion}`)},zcKR:function(e,t,r){"use strict";e.exports=function(e){for(var t=5381,r=e.length;r;)t=33*t^e.charCodeAt(--r);return t>>>0}},zxJG:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LambdaSchemaValidator=t.BasePropertiesValidator=t.BaseLumberjackSchemaValidator=void 0;const n=r("5gZq");class i{constructor(){this.validators=new Map,this.stringValidation=e=>this.isUndefined(e)||this.isString(e)&&e.length>0,this.numberValidation=e=>this.isUndefined(e)||this.isNumber(e),this.positiveNumberValidation=e=>this.isUndefined(e)||this.isNumber(e)&&e>=-1}validate(e){const t=[];return this.validators.forEach(((r,n)=>{e.has(n)&&r(e.get(n))||t.push(n)})),{validationPassed:0===t.length,validationFailedForProperties:t}}isUndefined(e){return void 0===e}isNumber(e){return"number"==typeof e}isString(e){return"string"==typeof e}}t.BaseLumberjackSchemaValidator=i;class s extends i{constructor(){super(),this.validators.set(n.BaseTelemetryProperties.tenantId,this.stringValidation),this.validators.set(n.BaseTelemetryProperties.documentId,this.stringValidation)}validate(e){return super.validate(e)}}t.BasePropertiesValidator=s,t.LambdaSchemaValidator=class extends s{constructor(){super(),this.validators.set(n.QueuedMessageProperties.topic,this.stringValidation),this.validators.set(n.QueuedMessageProperties.partition,this.positiveNumberValidation),this.validators.set(n.QueuedMessageProperties.offset,this.numberValidation)}validate(e){return super.validate(e)}}}}]);
//# sourceMappingURL=679.d8913205d24d17b54d6b.chunk.v7.js.map