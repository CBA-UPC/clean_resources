import{l as ie,r as H,a3 as ce,c as y,w as He,q as ue,aa as Ae,G as p,H as z,I as c,z as e,P as T,F as A,Y as i,a6 as a,$ as ne,x as C,a7 as u,Q as q,a as oe,N as xe,a8 as $e,an as de,ao as ve,a4 as Fe}from"./graphql.5cf3693b.js";import{ax as me,ay as Ve,at as Be,ai as fe,aa as _,bR as Le,bd as Ee,aA as S,aD as qe,dx as Ue,az as je,aB as ze,l as Re,as as ke,aC as Oe,dy as Qe}from"./itinerary-entities.5f897bcd.js";import{u as Ge}from"./entry.a7cea746.js";import{B as Je}from"./BoxRadio.942f0b7e.js";import{d as L,M as E}from"./mixins.c083cc34.js";import{bQ as N}from"./service-client.4862e840.js";const X=v=>(de("data-v-9f2ad0ff"),v=v(),ve(),v),Ye={class:"buttons-container"},Ke={class:"title"},We={class:"total-row"},Xe={class:"total-row"},Ze={key:0,class:"alert"},et={class:"content"},tt={class:"alert-text"},at={class:"title"},st={class:"buttons-container"},lt={key:0,class:"check-info"},rt={key:1},nt={class:"card-container"},ot=["placeholder"],it={class:"buttons-container"},ct=X(()=>i("p",{class:"check-info"}," لطفاً اطلاعات زیر را جهت واریز وجوه به دقت بررسی کرده و اقدام لازم را انجام دهید. ",-1)),ut={class:"card-info"},dt={class:"row"},vt=X(()=>i("p",null,"شماره کارت",-1)),mt={class:"row"},ft=X(()=>i("p",null,"صاحب حساب",-1)),Rt={class:"buttons-container"},kt=ie({__name:"CancelReserveModal",props:{reserve:{default:null}},emits:["close"],setup(v,{emit:M}){const I=me(),{refundExpirationTime:t,refundHandlers:g,penalties:F,penaltyLoadingStatus:O,cardNo:x,cardHolderName:R,creditCardInfo:P}=Ve(I),{day:U}=Re(),j=H(null),Q=Be(),{handleException:V}=Ge(),G=ce(),d=fe(),J=y(()=>{if(h.value)return"";switch(m.value){case 1:return d.t("CancelReserveModal.selectPassengers");case 2:return d.t("CancelReserveModal.refundMethod");case 3:return"افزودن اطلاعات بانکی";case 4:return"تأیید اطلاعات حساب";default:return""}}),Y=y(()=>h.value?!1:m.value===2&&!B.value?!0:!!(m.value&&m.value>2)),o=H({}),m=H(null),k=H(null),s=H(""),h=H(!1),K=H(["","","",""]),B=y(()=>{var r;return((r=v.reserve)==null?void 0:r.ReserveType)==="Hotel"}),pe=y(()=>U.gregory(t.value||void 0).format("HH:mm")),he=y(()=>U.js(t.value||void 0).format("D MMMM")),$=y(()=>{var r;return B.value?F.value||[]:((r=F.value)==null?void 0:r.filter(l=>{var f;return o.value[((f=l.Ticket)==null?void 0:f.Id)||0]}))||[]}),Ce=y(()=>{var r,l,f,D;return(r=k.value)!=null&&r.RequiresPreApplyStep?((l=x.value)==null?void 0:l.length)===16:((f=x.value)==null?void 0:f.length)===16&&!!((D=R.value)!=null&&D.trim())}),De=y(()=>L([{key:"title",title:B.value?d.t("CancelReserveModal.title"):d.t("CancelReserveModal.nameAndFamily")},{key:"PenaltyAmount",title:d.t("CancelReserveModal.penaltyAmount")},{key:"RefundAmount",title:d.t("CancelReserveModal.refundAmount")}])),Te=y(()=>$.value.map(r=>{var l,f,D,w,n,b;return{...r,title:B.value?((f=(l=v.reserve)==null?void 0:l.Itineraries)==null?void 0:f[0].RoomType)||"":`${((D=r.Ticket)==null?void 0:D.FirstName)||((w=r.Ticket)==null?void 0:w.PersianFirstName)} ${((n=r.Ticket)==null?void 0:n.LastName)||((b=r.Ticket)==null?void 0:b.PersianLastName)}`}})),_e=y(()=>_($.value.reduce((r,l)=>r+(l.PenaltyAmount||0),0))),Me=y(()=>_($.value.reduce((r,l)=>r+(l.RefundAmount||0),0))),ge=y(()=>{var l;if(!g)return[];const r=/(\d{6})([*]{4})(\d{4})/;return((l=g.value)==null?void 0:l.map(f=>{var D;return{label:f.Title||"",subtitle:"",value:f,description:((D=f.Description)==null?void 0:D.replace(r,""))||"",important:!!f.IsImportant}}))||[]}),be=r=>{var D,w,n;const l=((D=j.value)==null?void 0:D.map(b=>b.input))||[],f=l[r];(f==null?void 0:f.value.length)===0?(w=l[r-1])==null||w.focus():(f==null?void 0:f.value.length)===4&&((n=l[r+1])==null||n.focus())},Ie=()=>{m.value&&m.value--},Z=()=>{I.selectedPenalties=$.value,m.value=2},Pe=()=>{k.value&&(I.selectedMethodId=k.value.Id||0,k.value.RequiresCardInfo?m.value=3:W())},Se=()=>{var r;(r=k.value)!=null&&r.RequiresPreApplyStep?we():W()},we=async()=>{h.value=!0;try{await I.getCardDetails(v.reserve),m.value=4}catch(r){V(r)}finally{h.value=!1}},W=async()=>{h.value=!0;try{s.value=await I.performCancellation(v.reserve),M("close"),await Q({title:d.t("CancelReserveModal.refundOk"),text:s.value,icon:"success",confirmButtonText:d.t("CancelReserveModal.gotIt")}),h.value=!1,G.back()}catch(r){const l=r;h.value=!1,M("close"),l.response.data&&(l.response.data.Message=s.value=d.t("CancelReserveModal.errorCallCustomer",{message:l.response.data.Message})),V(l)}};return He(K,r=>{x.value=r.join("")}),ue(async()=>{try{await I.loadPenalty(v.reserve),B.value?Z():m.value=1}catch(r){V(r,{defaultMessage:"خطایی رخ داد! لطفا با پشتیبانی تماس بگیرید."}),M("close")}k.value=null}),Ae(()=>I.init()),(r,l)=>(p(),z(ze,{title:e(J),width:"430px","has-back":e(Y),"onClick:back":Ie,onClose:l[6]||(l[6]=f=>M("close"))},{default:c(()=>{var f,D,w;return[e(O)==="loading"?(p(),z(Le,{key:0})):(p(),T(A,{key:1},[e(m)===1?(p(),T(A,{key:0},[i("p",null,a(e(d).t("CancelReserveModal.selectCancelPassenger")),1),(p(!0),T(A,null,ne(e(F),n=>{var b,ee,te,ae,se,le;return p(),z(Ee,{key:(b=n.Ticket)==null?void 0:b.Id,modelValue:e(o)[((ee=n.Ticket)==null?void 0:ee.Id)||0],"onUpdate:modelValue":Ne=>{var re;return e(o)[((re=n.Ticket)==null?void 0:re.Id)||0]=Ne},label:`${((te=n.Ticket)==null?void 0:te.FirstName)||((ae=n.Ticket)==null?void 0:ae.PersianFirstName)||""} ${((se=n.Ticket)==null?void 0:se.LastName)||((le=n.Ticket)==null?void 0:le.PersianLastName)||""}`},null,8,["modelValue","onUpdate:modelValue","label"])}),128)),i("div",Ye,[C(S,{type:"bordered","full-width":"",onClick:l[0]||(l[0]=n=>M("close"))},{default:c(()=>[u(a(e(d).t("CancelReserveModal.cancel")),1)]),_:1}),C(S,{disabled:!e($)||!e($).length,"full-width":"",onClick:Z},{default:c(()=>[u(a(e(d).t("CancelReserveModal.ok")),1)]),_:1},8,["disabled"])])],64)):e(m)===2?(p(),T(A,{key:1},[i("h2",Ke,a(e(d).t("CancelReserveModal.calculateRefund")),1),C(E,{headers:e(De),items:e(Te)},{"item.RefundAmount":c(({value:n})=>[u(a(e(_)(n)),1)]),"item.PenaltyAmount":c(({value:n})=>[u(a(e(_)(n)),1)]),_:1},8,["headers","items"]),i("div",We,[i("div",null,a(e(d).t("CancelReserveModal.penaltyTotal")),1),i("div",null,a(e(_e)),1)]),i("div",Xe,[i("div",null,a(e(d).t("CancelReserveModal.refundTotal")),1),i("div",null,a(e(Me)),1)]),e(t)?(p(),T("div",Ze,[i("div",et,[C(qe,{class:"alert-icon",icon:e(Ue)},null,8,["icon"]),i("span",tt,a(e(d).t("CancelReserveModal.expirationAlert",{formattedExpirationTime:e(pe),formattedExpirationDate:e(he)})),1)])])):q("",!0),i("h2",at,a(e(d).t("CancelReserveModal.refundMethod")),1),C(Je,{modelValue:e(k),"onUpdate:modelValue":l[1]||(l[1]=n=>oe(k)?k.value=n:null),options:e(ge),column:"","wrap-label":""},null,8,["modelValue","options"]),i("div",st,[C(S,{type:"bordered","full-width":"",onClick:l[2]||(l[2]=n=>M("close"))},{default:c(()=>[u(a(e(d).t("CancelReserveModal.cancel")),1)]),_:1}),C(S,{disabled:!e(k)||e(h),loading:e(h),"full-width":"",onClick:Pe},{default:c(()=>[u(a(e(d).t("CancelReserveModal.okRecord")),1)]),_:1},8,["disabled","loading"])])],64)):e(m)===3?(p(),T(A,{key:2},[(f=e(k))!=null&&f.RequiresPreApplyStep?(p(),T("p",lt," لطفاً شماره کارت خود را جهت استرداد وارد نمایید. ")):(p(),T("p",rt,a(e(d).t("CancelReserveModal.bankInfo")),1)),i("div",nt,[(p(),T(A,null,ne(4,n=>C(je,{key:n,ref_for:!0,ref_key:"cardRef",ref:j,modelValue:e(K)[n],"onUpdate:modelValue":[b=>e(K)[n]=b,b=>be(n-1)],"data-id":"cardNumber","max-length":4,type:"card",class:"refund-input",dir:"ltr","convert-persian-digit":"","custom-class":"card-input-inner"},null,8,["modelValue","onUpdate:modelValue"])),64))]),(D=e(k))!=null&&D.RequiresPreApplyStep?q("",!0):xe((p(),T("input",{key:2,"onUpdate:modelValue":l[3]||(l[3]=n=>oe(R)?R.value=n:null),class:"form-control",placeholder:e(d).t("CancelReserveModal.nameAccountOwner")},null,8,ot)),[[$e,e(R)]]),i("div",it,[C(S,{type:"bordered","full-width":"",onClick:l[4]||(l[4]=n=>M("close"))},{default:c(()=>[u(a(e(d).t("CancelReserveModal.cancel")),1)]),_:1}),C(S,{disabled:!e(Ce),loading:e(h),"full-width":"",onClick:Se},{default:c(()=>{var n;return[u(a(e(d).t((n=e(k))!=null&&n.RequiresPreApplyStep?"ادامه":"CancelReserveModal.refundPrice")),1)]}),_:1},8,["disabled","loading"])])],64)):e(m)===4?(p(),T(A,{key:3},[ct,i("div",ut,[i("div",dt,[vt,i("p",null,a(e(x)),1)]),i("div",mt,[ft,i("p",null,a((w=e(P))==null?void 0:w.CardHolderName),1)])]),i("div",Rt,[C(S,{type:"bordered","full-width":"",onClick:l[5]||(l[5]=n=>M("close"))},{default:c(()=>[u(a(e(d).t("CancelReserveModal.cancel")),1)]),_:1}),C(S,{"full-width":"",onClick:W},{default:c(()=>[u(" تأیید ")]),_:1})])],64)):q("",!0)],64))]}),_:1},8,["title","has-back"]))}});const yt=ke(kt,[["__scopeId","data-v-9f2ad0ff"]]),ye=v=>(de("data-v-fa547a68"),v=v(),ve(),v),pt={class:"container"},ht={class:"box"},Ct={key:0,class:"box"},Dt={class:"box"},Tt=ye(()=>i("br",null,null,-1)),_t={class:"btn-container"},Mt=ye(()=>i("div",{class:"clear"},null,-1)),gt=ie({__name:"ReserveDetails",props:{currentReserve:{},currentBill:{}},setup(v){const M=ce(),I=me(),t=fe(),{day:g}=Re(),F=Fe(),{open:O,close:x}=Oe({component:yt,attrs:{reserve:v.currentReserve}}),R=y(()=>{var o;return((o=v.currentReserve)==null?void 0:o.ReserveType)==="Hotel"}),P=y(()=>{var o;return((o=v.currentReserve)==null?void 0:o.ReserveType)==="SuggestedService"}),U=y(()=>R.value?t.t("ReserveDetails.hotelReserveInfo"):t.t("ReserveDetails.tripInfo")),j=L([{key:"Mobile",title:t.t("ReserveDetails.mobile")},{key:"Phone",title:t.t("ReserveDetails.phone")},{key:"Email",title:t.t("ReserveDetails.email")}]),Q=y(()=>{var o,m,k;if((m=(o=v.currentReserve)==null?void 0:o.Refunds)!=null&&m.length)return t.t("ReserveDetails.refunded");switch((k=v.currentReserve)==null?void 0:k.ReserveStatus){case N.Canceled:return t.t("Ticket.canceled");case N.Finalized:return t.t("Ticket.issued");case N.InProgress:return t.t("Ticket.issuing");case N.None:default:return t.t("Ticket.none")}}),V=y(()=>{var o,m;return L([{key:"FullName",title:t.t("ReserveDetails.firstAndLastName")},{key:"Id",title:t.t("ReserveDetails.reference")},{key:"ReserveStatus",title:t.t("ReserveDetails.status"),condition:!R.value},{key:"ReserveId",title:t.t("ReserveDetails.number"),condition:!R.value},{key:"TotalFare",title:t.t("ReserveDetails.price"),condition:!R.value},{key:"DiscountPrice",title:t.t("ReserveDetails.discount"),condition:!R.value},{key:"Payable",title:t.t("ReserveDetails.paid"),condition:!R.value},{key:"Penalty",title:t.t("ReserveDetails.penaltyAmount"),condition:!R.value&&!!((o=v.currentReserve)!=null&&o.Canceled)},{key:"RefundAmount",title:t.t("ReserveDetails.refundAmount"),condition:!R.value&&!!((m=v.currentReserve)!=null&&m.Canceled)}])}),G=o=>{switch(o){case N.Canceled:return t.t("Ticket.canceled");case N.Finalized:return t.t("Ticket.issued");case N.InProgress:return t.t("Ticket.issuing");case N.None:return t.t("Ticket.none");default:return null}},d=()=>{O()},J=y(()=>{var o,m;return L([{key:"HotelName",title:t.t("ReserveDetails.name"),condition:R.value},{key:"ReserveTitle",title:t.t("ReserveDetails.serviceTitle"),condition:P.value},{key:"Origin",title:t.t("ReserveDetails.origin"),condition:!R.value&&!P.value},{key:"Destination",title:P.value?t.t("ReserveDetails.serviceCity"):t.t("ReserveDetails.destination")},{key:"CheckIn",title:t.t("ReserveDetails.checkin"),condition:R.value},{key:"Checkout",title:t.t("ReserveDetails.checkout"),condition:R.value},{key:"Nights",title:t.t("ReserveDetails.accommodationTime"),condition:R.value},{key:"DepartureDate",title:P.value?t.t("ReserveDetails.reserveDate"):t.t("ReserveDetails.date")},{key:"DepartureTime",title:P.value?t.t("ReserveDetails.reserveTime"):t.t("ReserveDetails.departureTime")},{key:"ArrivalTime",title:t.t("ReserveDetails.arrivalTime"),condition:!R.value&&!P.value&&((m=(o=v.currentReserve)==null?void 0:o.Itineraries)==null?void 0:m.some(k=>k.ArrivalTime))},{key:"Carrier",title:t.t("ReserveDetails.corporation"),condition:!R.value&&!P.value}])}),Y=y(()=>{var o;return L([{key:"RoomType",title:t.t("ReserveDetails.room")},{key:"ReferenceCode",title:t.t("ReserveDetails.roomReference")},{key:"roomStatus",title:t.t("ReserveDetails.status")},{key:"Id",title:t.t("ReserveDetails.number")},{key:"TotalPrice",title:t.t("ReserveDetails.paid")},{key:"TotalPenalty",title:t.t("ReserveDetails.penaltyAmount"),condition:!!((o=v.currentReserve)!=null&&o.Canceled)}])});return ue(()=>{I.init(),v.currentReserve?F.query.canceling&&!v.currentReserve.Canceled&&d():M.back()}),Qe(()=>x()),(o,m)=>{var k;return p(),T("div",pt,[i("div",ht,[i("h2",null,a(e(U)),1),C(E,{headers:e(J),items:o.currentReserve.Itineraries||[]},{"item.HotelName":c(({value:s})=>[u(a(e(t).t("ReserveDetails.hotel",{name:s})),1)]),"item.CheckIn":c(({value:s})=>[u(a(e(g).js(s).format("dddd DD MMMM HH:mm")),1)]),"item.Checkout":c(({value:s})=>[u(a(e(g).js(s).format("dddd DD MMMM HH:mm")),1)]),"item.Nights":c(({item:s})=>[u(a(e(t).t("ReserveDetails.nights",{count:Math.ceil(e(g).gregory(s.Checkout).diff(e(g).gregory(s.CheckIn),"hours")/24)})),1)]),"item.DepartureDate":c(({item:s})=>[u(a(e(g).js(s.DepartureTime).format("D MMMM")),1)]),"item.DepartureTime":c(({value:s})=>[u(a(e(g).gregory(s).format("HH:mm")),1)]),"item.ArrivalTime":c(({value:s})=>[u(a(e(g).gregory(s).format("HH:mm")),1)]),_:1},8,["headers","items"])]),e(R)?(p(),T("div",Ct,[i("h2",null,a(e(t).t("ReserveDetails.roomInfo")),1),C(E,{headers:e(Y),items:[o.currentReserve]},{"item.RoomType":c(({item:s})=>{var h;return[u(a((h=s.Itineraries)==null?void 0:h[0].RoomType),1)]}),"item.roomStatus":c(()=>[u(a(e(Q)),1)]),"item.TotalPrice":c(({value:s})=>[u(a(e(_)(s)),1)]),"item.TotalPenalty":c(({value:s})=>[u(a(e(_)(s)),1)]),_:1},8,["headers","items"])])):q("",!0),i("div",Dt,[i("h2",null,a(e(t).t("ReserveDetails.passengers")),1),C(E,{headers:e(V),items:((k=o.currentReserve)==null?void 0:k.Tickets)??[]},{"item.FullName":c(({item:s})=>[u(a(s.FirstName||s.PersianFirstName)+" "+a(s.LastName||s.PersianLastName),1)]),"item.ReserveStatus":c(()=>[u(a(G(o.currentReserve.ReserveStatus||"")),1)]),"item.ReserveId":c(()=>[u(a(o.currentReserve.Id),1)]),"item.TotalFare":c(({value:s})=>[u(a(e(_)(s)),1)]),"item.DiscountPrice":c(({value:s})=>[u(a(e(_)(s)),1)]),"item.Payable":c(({item:s})=>[u(a(e(_)((s.TotalFare||0)-(s.DiscountPrice||0))),1)]),"item.Penalty":c(({item:s,value:h})=>[u(a(s.PenaltyUnit==="Percent"?`${h}٪`:e(_)(h)),1)]),"item.RefundAmount":c(({value:s})=>[u(a(e(_)(s)),1)]),_:1},8,["headers","items"]),Tt,C(E,{headers:e(j),items:o.currentBill?[o.currentBill]:[]},null,8,["headers","items"])]),i("div",_t,[o.currentReserve.IsCancellable?(p(),z(S,{key:0,class:"ticket-btn",type:"bordered",onClick:d},{default:c(()=>[u(a(e(t).t("ReserveDetails.doCancel")),1)]),_:1})):q("",!0)]),Mt])}}});const Ht=ke(gt,[["__scopeId","data-v-fa547a68"]]);export{Ht as R};
